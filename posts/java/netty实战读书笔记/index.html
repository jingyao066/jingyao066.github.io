<!DOCTYPE html>
<html lang="en" dir="auto">

<head>
    
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://009965.xyz/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://009965.xyz/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://009965.xyz/">Home</a>&nbsp;Â»&nbsp;<a href="https://009965.xyz/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      ã€ŠNettyå®æˆ˜ã€‹è¯»ä¹¦ç¬”è®°
    </h1>
    <div class="post-meta"><span title='2021-01-14 09:28:13 +0000 UTC'>2021-01-14</span>&nbsp;Â·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%ac%ac%e4%b8%80%e4%b8%aanetty%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="ç¬¬ä¸€ä¸ªNettyåº”ç”¨ç¨‹åº">ç¬¬ä¸€ä¸ªNettyåº”ç”¨ç¨‹åº</a><ul>
                        
                <li>
                    <a href="#%e7%bc%96%e5%86%99-echo-%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="ç¼–å†™ Echo æœåŠ¡å™¨">ç¼–å†™ Echo æœåŠ¡å™¨</a><ul>
                        
                <li>
                    <a href="#%e9%80%9a%e8%bf%87channelhandler%e5%ae%9e%e7%8e%b0%e6%9c%8d%e5%8a%a1%e7%ab%af" aria-label="é€šè¿‡channelHandlerå®ç°æœåŠ¡ç«¯">é€šè¿‡channelHandlerå®ç°æœåŠ¡ç«¯</a></li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99%e5%bc%95%e5%af%bc%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="ç¼–å†™å¼•å¯¼æœåŠ¡å™¨">ç¼–å†™å¼•å¯¼æœåŠ¡å™¨</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99echo%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="ç¼–å†™echoå®¢æˆ·ç«¯">ç¼–å†™echoå®¢æˆ·ç«¯</a><ul>
                        
                <li>
                    <a href="#%e9%80%9a%e8%bf%87-channelhandler-%e5%ae%9e%e7%8e%b0%e5%ae%a2%e6%88%b7%e7%ab%af%e9%80%bb%e8%be%91" aria-label="é€šè¿‡ ChannelHandler å®ç°å®¢æˆ·ç«¯é€»è¾‘">é€šè¿‡ ChannelHandler å®ç°å®¢æˆ·ç«¯é€»è¾‘</a></li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99%e5%bc%95%e5%af%bc%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="ç¼–å†™å¼•å¯¼å®¢æˆ·ç«¯">ç¼–å†™å¼•å¯¼å®¢æˆ·ç«¯</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#netty%e7%9a%84%e7%bb%84%e4%bb%b6%e5%92%8c%e8%ae%be%e8%ae%a1" aria-label="Nettyçš„ç»„ä»¶å’Œè®¾è®¡">Nettyçš„ç»„ä»¶å’Œè®¾è®¡</a><ul>
                        
                <li>
                    <a href="#channel%e6%8e%a5%e5%8f%a3" aria-label="Channelæ¥å£">Channelæ¥å£</a></li>
                <li>
                    <a href="#eventloop%e6%8e%a5%e5%8f%a3" aria-label="EventLoopæ¥å£">EventLoopæ¥å£</a></li>
                <li>
                    <a href="#channelfuture%e6%8e%a5%e5%8f%a3" aria-label="ChannelFutureæ¥å£">ChannelFutureæ¥å£</a></li>
                <li>
                    <a href="#channelhandler%e6%8e%a5%e5%8f%a3" aria-label="ChannelHandleræ¥å£">ChannelHandleræ¥å£</a></li>
                <li>
                    <a href="#channelpipeline%e6%8e%a5%e5%8f%a3" aria-label="ChannelPipelineæ¥å£">ChannelPipelineæ¥å£</a></li>
                <li>
                    <a href="#%e6%9b%b4%e5%8a%a0%e6%b7%b1%e5%85%a5%e5%9c%b0%e4%ba%86%e8%a7%a3-channelhandler" aria-label="æ›´åŠ æ·±å…¥åœ°äº†è§£ ChannelHandler">æ›´åŠ æ·±å…¥åœ°äº†è§£ ChannelHandler</a></li>
                <li>
                    <a href="#%e7%bc%96%e7%a0%81%e5%99%a8%e5%92%8c%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="ç¼–ç å™¨å’Œè§£ç å™¨">ç¼–ç å™¨å’Œè§£ç å™¨</a></li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-simplechannelinboundhandler" aria-label="æŠ½è±¡ç±» SimpleChannelInboundHandler">æŠ½è±¡ç±» SimpleChannelInboundHandler</a></li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc%e7%b1%bb" aria-label="å¼•å¯¼ç±»">å¼•å¯¼ç±»</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bc%a0%e8%be%93" aria-label="ä¼ è¾“">ä¼ è¾“</a><ul>
                        
                <li>
                    <a href="#%e6%a1%88%e4%be%8b%e7%a0%94%e7%a9%b6" aria-label="æ¡ˆä¾‹ç ”ç©¶">æ¡ˆä¾‹ç ”ç©¶</a><ul>
                        
                <li>
                    <a href="#%e4%b8%8d%e9%80%9a%e8%bf%87-netty-%e4%bd%bf%e7%94%a8-oio-%e5%92%8c-nio" aria-label="ä¸é€šè¿‡ Netty ä½¿ç”¨ OIO å’Œ NIO">ä¸é€šè¿‡ Netty ä½¿ç”¨ OIO å’Œ NIO</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87-netty-%e4%bd%bf%e7%94%a8-oio-%e5%92%8c-nio" aria-label="é€šè¿‡ Netty ä½¿ç”¨ OIO å’Œ NIO">é€šè¿‡ Netty ä½¿ç”¨ OIO å’Œ NIO</a></li>
                <li>
                    <a href="#%e9%9d%9e%e9%98%bb%e5%a1%9e%e7%9a%84-netty-%e7%89%88%e6%9c%ac" aria-label="éé˜»å¡çš„ Netty ç‰ˆæœ¬">éé˜»å¡çš„ Netty ç‰ˆæœ¬</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bc%a0%e8%be%93api" aria-label="ä¼ è¾“API">ä¼ è¾“API</a></li>
                <li>
                    <a href="#%e5%86%85%e7%bd%ae%e7%9a%84%e4%bc%a0%e8%be%93" aria-label="å†…ç½®çš„ä¼ è¾“">å†…ç½®çš„ä¼ è¾“</a><ul>
                        
                <li>
                    <a href="#nio%e9%9d%9e%e9%98%bb%e5%a1%9e-io" aria-label="NIOâ€”â€”éé˜»å¡ I/O">NIOâ€”â€”éé˜»å¡ I/O</a></li>
                <li>
                    <a href="#epoll%e7%94%a8%e4%ba%8e-linux-%e7%9a%84%e6%9c%ac%e5%9c%b0%e9%9d%9e%e9%98%bb%e5%a1%9e%e4%bc%a0%e8%be%93" aria-label="Epollâ€”ç”¨äº Linux çš„æœ¬åœ°éé˜»å¡ä¼ è¾“">Epollâ€”ç”¨äº Linux çš„æœ¬åœ°éé˜»å¡ä¼ è¾“</a></li>
                <li>
                    <a href="#oio%e6%97%a7%e7%9a%84%e9%98%bb%e5%a1%9e-io" aria-label="OIOâ€”æ—§çš„é˜»å¡ I/O">OIOâ€”æ—§çš„é˜»å¡ I/O</a></li>
                <li>
                    <a href="#%e7%94%a8%e4%ba%8e-jvm-%e5%86%85%e9%83%a8%e9%80%9a%e4%bf%a1%e7%9a%84-local-%e4%bc%a0%e8%be%93" aria-label="ç”¨äº JVM å†…éƒ¨é€šä¿¡çš„ Local ä¼ è¾“">ç”¨äº JVM å†…éƒ¨é€šä¿¡çš„ Local ä¼ è¾“</a></li>
                <li>
                    <a href="#embedded-%e4%bc%a0%e8%be%93" aria-label="Embedded ä¼ è¾“">Embedded ä¼ è¾“</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%80%89%e6%8b%a9%e5%93%aa%e4%b8%80%e7%a7%8d%e4%bc%a0%e8%be%93" aria-label="é€‰æ‹©å“ªä¸€ç§ä¼ è¾“">é€‰æ‹©å“ªä¸€ç§ä¼ è¾“</a><ul>
                        
                <li>
                    <a href="#%e9%9d%9e%e9%98%bb%e5%a1%9e%e4%bb%a3%e7%a0%81%e5%ba%93" aria-label="éé˜»å¡ä»£ç åº“">éé˜»å¡ä»£ç åº“</a></li>
                <li>
                    <a href="#%e9%98%bb%e5%a1%9e%e4%bb%a3%e7%a0%81%e5%ba%93" aria-label="é˜»å¡ä»£ç åº“">é˜»å¡ä»£ç åº“</a></li>
                <li>
                    <a href="#%e5%9c%a8%e5%90%8c%e4%b8%80%e4%b8%aa-jvm-%e5%86%85%e9%83%a8%e7%9a%84%e9%80%9a%e4%bf%a1" aria-label="åœ¨åŒä¸€ä¸ª JVM å†…éƒ¨çš„é€šä¿¡">åœ¨åŒä¸€ä¸ª JVM å†…éƒ¨çš„é€šä¿¡</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e4%bd%a0%e7%9a%84-channelhandler-%e5%ae%9e%e7%8e%b0" aria-label="æµ‹è¯•ä½ çš„ ChannelHandler å®ç°">æµ‹è¯•ä½ çš„ ChannelHandler å®ç°</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#bytebuf" aria-label="ByteBuf">ByteBuf</a><ul>
                        
                <li>
                    <a href="#bytebuf-%e7%9a%84-api" aria-label="ByteBuf çš„ API">ByteBuf çš„ API</a></li>
                <li>
                    <a href="#bytebuf-%e7%b1%bbnetty-%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ae%b9%e5%99%a8" aria-label="ByteBuf ç±»â€”â€”Netty çš„æ•°æ®å®¹å™¨">ByteBuf ç±»â€”â€”Netty çš„æ•°æ®å®¹å™¨</a><ul>
                        
                <li>
                    <a href="#bytebuf%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c" aria-label="bytebufå¦‚ä½•å·¥ä½œ">bytebufå¦‚ä½•å·¥ä½œ</a></li>
                <li>
                    <a href="#bytebuf-%e7%9a%84%e4%bd%bf%e7%94%a8%e6%a8%a1%e5%bc%8f" aria-label="ByteBuf çš„ä½¿ç”¨æ¨¡å¼">ByteBuf çš„ä½¿ç”¨æ¨¡å¼</a><ul>
                        
                <li>
                    <a href="#%e5%a0%86%e7%bc%93%e5%86%b2%e5%8c%ba" aria-label="å †ç¼“å†²åŒº">å †ç¼“å†²åŒº</a></li>
                <li>
                    <a href="#%e7%9b%b4%e6%8e%a5%e7%bc%93%e5%86%b2%e5%8c%ba" aria-label="ç›´æ¥ç¼“å†²åŒº">ç›´æ¥ç¼“å†²åŒº</a></li>
                <li>
                    <a href="#%e5%a4%8d%e5%90%88%e7%bc%93%e5%86%b2%e5%8c%ba" aria-label="å¤åˆç¼“å†²åŒº">å¤åˆç¼“å†²åŒº</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#byebuf%e5%ad%97%e8%8a%82%e7%ba%a7%e6%93%8d%e4%bd%9c" aria-label="ByeBufå­—èŠ‚çº§æ“ä½œ">ByeBufå­—èŠ‚çº§æ“ä½œ</a><ul>
                        
                <li>
                    <a href="#%e9%9a%8f%e6%9c%ba%e8%ae%bf%e9%97%ae%e7%b4%a2%e5%bc%95" aria-label="éšæœºè®¿é—®ç´¢å¼•">éšæœºè®¿é—®ç´¢å¼•</a></li>
                <li>
                    <a href="#%e9%a1%ba%e5%ba%8f%e8%ae%bf%e9%97%ae%e7%b4%a2%e5%bc%95" aria-label="é¡ºåºè®¿é—®ç´¢å¼•">é¡ºåºè®¿é—®ç´¢å¼•</a></li>
                <li>
                    <a href="#%e5%8f%af%e4%b8%a2%e5%bc%83%e5%ad%97%e8%8a%82" aria-label="å¯ä¸¢å¼ƒå­—èŠ‚">å¯ä¸¢å¼ƒå­—èŠ‚</a></li>
                <li>
                    <a href="#%e5%8f%af%e8%af%bb%e5%ad%97%e8%8a%82" aria-label="å¯è¯»å­—èŠ‚">å¯è¯»å­—èŠ‚</a></li>
                <li>
                    <a href="#%e5%8f%af%e5%86%99%e5%ad%97%e8%8a%82" aria-label="å¯å†™å­—èŠ‚">å¯å†™å­—èŠ‚</a></li>
                <li>
                    <a href="#%e7%b4%a2%e5%bc%95%e7%ae%a1%e7%90%86" aria-label="ç´¢å¼•ç®¡ç†">ç´¢å¼•ç®¡ç†</a></li>
                <li>
                    <a href="#%e6%9f%a5%e6%89%be%e6%93%8d%e4%bd%9c" aria-label="æŸ¥æ‰¾æ“ä½œ">æŸ¥æ‰¾æ“ä½œ</a></li>
                <li>
                    <a href="#%e6%b4%be%e7%94%9f%e7%bc%93%e5%86%b2%e5%8c%ba" aria-label="æ´¾ç”Ÿç¼“å†²åŒº">æ´¾ç”Ÿç¼“å†²åŒº</a></li>
                <li>
                    <a href="#%e8%af%bb%e5%86%99%e6%93%8d%e4%bd%9c" aria-label="è¯»/å†™æ“ä½œ">è¯»/å†™æ“ä½œ</a></li>
                <li>
                    <a href="#bytebuf%e5%85%b6%e4%bb%96%e6%93%8d%e4%bd%9c" aria-label="byteBufå…¶ä»–æ“ä½œ">byteBufå…¶ä»–æ“ä½œ</a></li></ul>
                </li>
                <li>
                    <a href="#bytebufholder-%e6%8e%a5%e5%8f%a3" aria-label="ByteBufHolder æ¥å£">ByteBufHolder æ¥å£</a></li>
                <li>
                    <a href="#bytebuf%e5%88%86%e9%85%8d%e7%ae%a1%e7%90%86" aria-label="ByteBufåˆ†é…(ç®¡ç†)">ByteBufåˆ†é…(ç®¡ç†)</a><ul>
                        
                <li>
                    <a href="#%e6%8c%89%e9%9c%80%e5%88%86%e9%85%8dbytebufallocator-%e6%8e%a5%e5%8f%a3" aria-label="æŒ‰éœ€åˆ†é…ï¼šByteBufAllocator æ¥å£">æŒ‰éœ€åˆ†é…ï¼šByteBufAllocator æ¥å£</a></li>
                <li>
                    <a href="#unpooled-%e7%bc%93%e5%86%b2%e5%8c%ba" aria-label="Unpooled ç¼“å†²åŒº">Unpooled ç¼“å†²åŒº</a></li>
                <li>
                    <a href="#bytebufutil-%e7%b1%bb" aria-label="ByteBufUtil ç±»">ByteBufUtil ç±»</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%95%e7%94%a8%e8%ae%a1%e6%95%b0%e6%b3%95" aria-label="å¼•ç”¨è®¡æ•°æ³•">å¼•ç”¨è®¡æ•°æ³•</a></li></ul>
                </li>
                <li>
                    <a href="#channelhandler%e5%92%8cchannelpipeline" aria-label="ChannelHandlerå’ŒChannelPipeline">ChannelHandlerå’ŒChannelPipeline</a><ul>
                        
                <li>
                    <a href="#channelhandler%e5%ae%b6%e6%97%8f" aria-label="ChannelHandlerå®¶æ—">ChannelHandlerå®¶æ—</a><ul>
                        
                <li>
                    <a href="#channel%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="Channelçš„ç”Ÿå‘½å‘¨æœŸ">Channelçš„ç”Ÿå‘½å‘¨æœŸ</a></li>
                <li>
                    <a href="#channelhandler%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="ChannelHandlerçš„ç”Ÿå‘½å‘¨æœŸ">ChannelHandlerçš„ç”Ÿå‘½å‘¨æœŸ</a></li>
                <li>
                    <a href="#channelinboundhandler-%e6%8e%a5%e5%8f%a3" aria-label="ChannelInboundHandler æ¥å£">ChannelInboundHandler æ¥å£</a></li>
                <li>
                    <a href="#channeloutboundhandler-%e6%8e%a5%e5%8f%a3" aria-label="ChannelOutboundHandler æ¥å£">ChannelOutboundHandler æ¥å£</a></li>
                <li>
                    <a href="#channelhandler-%e9%80%82%e9%85%8d%e5%99%a8" aria-label="ChannelHandler é€‚é…å™¨">ChannelHandler é€‚é…å™¨</a></li>
                <li>
                    <a href="#%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86" aria-label="èµ„æºç®¡ç†">èµ„æºç®¡ç†</a></li></ul>
                </li>
                <li>
                    <a href="#channelpipeline-%e6%8e%a5%e5%8f%a3" aria-label="ChannelPipeline æ¥å£">ChannelPipeline æ¥å£</a><ul>
                        
                <li>
                    <a href="#%e4%bf%ae%e6%94%b9-channelpipeline" aria-label="ä¿®æ”¹ ChannelPipeline">ä¿®æ”¹ ChannelPipeline</a></li>
                <li>
                    <a href="#%e8%a7%a6%e5%8f%91%e4%ba%8b%e4%bb%b6" aria-label="è§¦å‘äº‹ä»¶">è§¦å‘äº‹ä»¶</a></li></ul>
                </li>
                <li>
                    <a href="#channelhandlercontext-%e6%8e%a5%e5%8f%a3" aria-label="ChannelHandlerContext æ¥å£">ChannelHandlerContext æ¥å£</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-channelhandlercontext" aria-label="ä½¿ç”¨ ChannelHandlerContext">ä½¿ç”¨ ChannelHandlerContext</a></li>
                <li>
                    <a href="#channelhandler-%e5%92%8c-channelhandlercontext-%e7%9a%84%e9%ab%98%e7%ba%a7%e7%94%a8%e6%b3%95" aria-label="ChannelHandler å’Œ ChannelHandlerContext çš„é«˜çº§ç”¨æ³•">ChannelHandler å’Œ ChannelHandlerContext çš„é«˜çº§ç”¨æ³•</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86" aria-label="å¼‚å¸¸å¤„ç†">å¼‚å¸¸å¤„ç†</a><ul>
                        
                <li>
                    <a href="#%e5%85%a5%e7%ab%99%e5%bc%82%e5%b8%b8" aria-label="å…¥ç«™å¼‚å¸¸">å…¥ç«™å¼‚å¸¸</a></li>
                <li>
                    <a href="#%e5%87%ba%e7%ab%99%e5%bc%82%e5%b8%b8" aria-label="å‡ºç«™å¼‚å¸¸">å‡ºç«™å¼‚å¸¸</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#eventloop%e5%92%8c%e7%ba%bf%e7%a8%8b%e6%a8%a1%e5%9e%8b" aria-label="EventLoopå’Œçº¿ç¨‹æ¨¡å‹">EventLoopå’Œçº¿ç¨‹æ¨¡å‹</a><ul>
                        
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e6%a8%a1%e5%9e%8b%e6%a6%82%e8%bf%b0" aria-label="çº¿ç¨‹æ¨¡å‹æ¦‚è¿°">çº¿ç¨‹æ¨¡å‹æ¦‚è¿°</a></li>
                <li>
                    <a href="#eventloop%e6%8e%a5%e5%8f%a3-1" aria-label="EventLoopæ¥å£">EventLoopæ¥å£</a><ul>
                        
                <li>
                    <a href="#netty-4-%e4%b8%ad%e7%9a%84-io-%e5%92%8c%e4%ba%8b%e4%bb%b6%e5%a4%84%e7%90%86" aria-label="Netty 4 ä¸­çš„ I/O å’Œäº‹ä»¶å¤„ç†">Netty 4 ä¸­çš„ I/O å’Œäº‹ä»¶å¤„ç†</a></li>
                <li>
                    <a href="#netty-3-%e4%b8%ad%e7%9a%84-io-%e6%93%8d%e4%bd%9c" aria-label="Netty 3 ä¸­çš„ I/O æ“ä½œ">Netty 3 ä¸­çš„ I/O æ“ä½œ</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bb%bb%e5%8a%a1%e8%b0%83%e5%ba%a6" aria-label="ä»»åŠ¡è°ƒåº¦">ä»»åŠ¡è°ƒåº¦</a><ul>
                        
                <li>
                    <a href="#jdk-%e7%9a%84%e4%bb%bb%e5%8a%a1%e8%b0%83%e5%ba%a6-api" aria-label="JDK çš„ä»»åŠ¡è°ƒåº¦ API">JDK çš„ä»»åŠ¡è°ƒåº¦ API</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-eventloop-%e8%b0%83%e5%ba%a6%e4%bb%bb%e5%8a%a1" aria-label="ä½¿ç”¨ EventLoop è°ƒåº¦ä»»åŠ¡">ä½¿ç”¨ EventLoop è°ƒåº¦ä»»åŠ¡</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e7%bb%86%e8%8a%82" aria-label="å®ç°ç»†èŠ‚">å®ç°ç»†èŠ‚</a><ul>
                        
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e7%ae%a1%e7%90%86" aria-label="çº¿ç¨‹ç®¡ç†">çº¿ç¨‹ç®¡ç†</a></li>
                <li>
                    <a href="#eventloop%e7%ba%bf%e7%a8%8b%e7%9a%84%e5%88%86%e9%85%8d" aria-label="EventLoop/çº¿ç¨‹çš„åˆ†é…">EventLoop/çº¿ç¨‹çš„åˆ†é…</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93" aria-label="å°ç»“">å°ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc" aria-label="å¼•å¯¼">å¼•å¯¼</a><ul>
                        
                <li>
                    <a href="#bootstrap%e7%b1%bb" aria-label="Bootstrapç±»">Bootstrapç±»</a></li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc%e5%ae%a2%e6%88%b7%e7%ab%af%e5%92%8c%e6%97%a0%e8%bf%9e%e6%8e%a5%e5%8d%8f%e8%ae%ae" aria-label="å¼•å¯¼å®¢æˆ·ç«¯å’Œæ— è¿æ¥åè®®">å¼•å¯¼å®¢æˆ·ç«¯å’Œæ— è¿æ¥åè®®</a><ul>
                        
                <li>
                    <a href="#%e5%bc%95%e5%af%bc%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="å¼•å¯¼å®¢æˆ·ç«¯">å¼•å¯¼å®¢æˆ·ç«¯</a></li>
                <li>
                    <a href="#channel-%e5%92%8c-eventloopgroup-%e7%9a%84%e5%85%bc%e5%ae%b9%e6%80%a7" aria-label="Channel å’Œ EventLoopGroup çš„å…¼å®¹æ€§">Channel å’Œ EventLoopGroup çš„å…¼å®¹æ€§</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="å¼•å¯¼æœåŠ¡å™¨">å¼•å¯¼æœåŠ¡å™¨</a><ul>
                        
                <li>
                    <a href="#serverbootstrap-%e7%b1%bb" aria-label="ServerBootstrap ç±»">ServerBootstrap ç±»</a></li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc%e6%9c%8d%e5%8a%a1%e5%99%a8-1" aria-label="å¼•å¯¼æœåŠ¡å™¨">å¼•å¯¼æœåŠ¡å™¨</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bb%8e-channel-%e5%bc%95%e5%af%bc%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="ä» Channel å¼•å¯¼å®¢æˆ·ç«¯">ä» Channel å¼•å¯¼å®¢æˆ·ç«¯</a></li>
                <li>
                    <a href="#%e5%9c%a8%e5%bc%95%e5%af%bc%e8%bf%87%e7%a8%8b%e4%b8%ad%e6%b7%bb%e5%8a%a0%e5%a4%9a%e4%b8%aa-channelhandler" aria-label="åœ¨å¼•å¯¼è¿‡ç¨‹ä¸­æ·»åŠ å¤šä¸ª ChannelHandler">åœ¨å¼•å¯¼è¿‡ç¨‹ä¸­æ·»åŠ å¤šä¸ª ChannelHandler</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-netty-%e7%9a%84-channeloption-%e5%92%8c%e5%b1%9e%e6%80%a7" aria-label="ä½¿ç”¨ Netty çš„ ChannelOption å’Œå±æ€§">ä½¿ç”¨ Netty çš„ ChannelOption å’Œå±æ€§</a></li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc-datagramchannel" aria-label="å¼•å¯¼ DatagramChannel">å¼•å¯¼ DatagramChannel</a></li>
                <li>
                    <a href="#%e5%85%b3%e9%97%ad%e7%a8%8b%e5%ba%8f" aria-label="å…³é—­ç¨‹åº">å…³é—­ç¨‹åº</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93-1" aria-label="å°ç»“">å°ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95" aria-label="å•å…ƒæµ‹è¯•">å•å…ƒæµ‹è¯•</a><ul>
                        
                <li>
                    <a href="#embeddedchannel-%e6%a6%82%e8%bf%b0" aria-label="EmbeddedChannel æ¦‚è¿°">EmbeddedChannel æ¦‚è¿°</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-embeddedchannel-%e6%b5%8b%e8%af%95-channelhandler" aria-label="ä½¿ç”¨ EmbeddedChannel æµ‹è¯• ChannelHandler">ä½¿ç”¨ EmbeddedChannel æµ‹è¯• ChannelHandler</a><ul>
                        
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e5%85%a5%e7%ab%99%e6%b6%88%e6%81%af" aria-label="æµ‹è¯•å…¥ç«™æ¶ˆæ¯">æµ‹è¯•å…¥ç«™æ¶ˆæ¯</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e5%87%ba%e7%ab%99%e6%b6%88%e6%81%af" aria-label="æµ‹è¯•å‡ºç«™æ¶ˆæ¯">æµ‹è¯•å‡ºç«™æ¶ˆæ¯</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86" aria-label="æµ‹è¯•å¼‚å¸¸å¤„ç†">æµ‹è¯•å¼‚å¸¸å¤„ç†</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93-2" aria-label="å°ç»“">å°ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bc%96%e8%a7%a3%e7%a0%81%e5%99%a8%e6%a1%86%e6%9e%b6" aria-label="ç¼–è§£ç å™¨æ¡†æ¶">ç¼–è§£ç å™¨æ¡†æ¶</a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e7%bc%96%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="ä»€ä¹ˆæ˜¯ç¼–è§£ç å™¨">ä»€ä¹ˆæ˜¯ç¼–è§£ç å™¨</a></li>
                <li>
                    <a href="#%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="è§£ç å™¨">è§£ç å™¨</a><ul>
                        
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-bytetomessagedecoder" aria-label="æŠ½è±¡ç±» ByteToMessageDecoder">æŠ½è±¡ç±» ByteToMessageDecoder</a></li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-replayingdecoder" aria-label="æŠ½è±¡ç±» ReplayingDecoder">æŠ½è±¡ç±» ReplayingDecoder</a></li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-messagetomessagedecoder" aria-label="æŠ½è±¡ç±» MessageToMessageDecoder">æŠ½è±¡ç±» MessageToMessageDecoder</a></li>
                <li>
                    <a href="#toolongframeexception-%e7%b1%bb" aria-label="TooLongFrameException ç±»">TooLongFrameException ç±»</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bc%96%e7%a0%81%e5%99%a8" aria-label="ç¼–ç å™¨">ç¼–ç å™¨</a><ul>
                        
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-messagetobyteencoder" aria-label="æŠ½è±¡ç±» MessageToByteEncoder">æŠ½è±¡ç±» MessageToByteEncoder</a></li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-messagetomessageencoder" aria-label="æŠ½è±¡ç±» MessageToMessageEncoder">æŠ½è±¡ç±» MessageToMessageEncoder</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%9a%84%e7%bc%96%e8%a7%a3%e7%a0%81%e5%99%a8%e7%b1%bb" aria-label="æŠ½è±¡çš„ç¼–è§£ç å™¨ç±»">æŠ½è±¡çš„ç¼–è§£ç å™¨ç±»</a><ul>
                        
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-bytetomessagecodec" aria-label="æŠ½è±¡ç±» ByteToMessageCodec">æŠ½è±¡ç±» ByteToMessageCodec</a></li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-messagetomessagecodec" aria-label="æŠ½è±¡ç±» MessageToMessageCodec">æŠ½è±¡ç±» MessageToMessageCodec</a></li>
                <li>
                    <a href="#combinedchannelduplexhandler-%e7%b1%bb" aria-label="CombinedChannelDuplexHandler ç±»">CombinedChannelDuplexHandler ç±»</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93-3" aria-label="å°ç»“">å°ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%a2%84%e7%bd%ae%e7%9a%84channelhandler%e5%92%8c%e7%bc%96%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="é¢„ç½®çš„ChannelHandlerå’Œç¼–è§£ç å™¨">é¢„ç½®çš„ChannelHandlerå’Œç¼–è§£ç å™¨</a><ul>
                        
                <li>
                    <a href="#%e9%80%9a%e8%bf%87-ssltls-%e4%bf%9d%e6%8a%a4-netty-%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="é€šè¿‡ SSL/TLS ä¿æŠ¤ Netty åº”ç”¨ç¨‹åº">é€šè¿‡ SSL/TLS ä¿æŠ¤ Netty åº”ç”¨ç¨‹åº</a></li>
                <li>
                    <a href="#%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8e-netty-%e7%9a%84-httphttps-%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="æ„å»ºåŸºäº Netty çš„ HTTP/HTTPS åº”ç”¨ç¨‹åº">æ„å»ºåŸºäº Netty çš„ HTTP/HTTPS åº”ç”¨ç¨‹åº</a><ul>
                        
                <li>
                    <a href="#http-%e8%a7%a3%e7%a0%81%e5%99%a8%e7%bc%96%e7%a0%81%e5%99%a8%e5%92%8c%e7%bc%96%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="HTTP è§£ç å™¨ã€ç¼–ç å™¨å’Œç¼–è§£ç å™¨">HTTP è§£ç å™¨ã€ç¼–ç å™¨å’Œç¼–è§£ç å™¨</a></li>
                <li>
                    <a href="#%e8%81%9a%e5%90%88-http-%e6%b6%88%e6%81%af" aria-label="èšåˆ HTTP æ¶ˆæ¯">èšåˆ HTTP æ¶ˆæ¯</a></li>
                <li>
                    <a href="#http-%e5%8e%8b%e7%bc%a9" aria-label="HTTP å‹ç¼©">HTTP å‹ç¼©</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-https" aria-label="ä½¿ç”¨ HTTPS">ä½¿ç”¨ HTTPS</a></li>
                <li>
                    <a href="#websocket" aria-label="WebSocket">WebSocket</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%a9%ba%e9%97%b2%e7%9a%84%e8%bf%9e%e6%8e%a5%e5%92%8c%e8%b6%85%e6%97%b6" aria-label="ç©ºé—²çš„è¿æ¥å’Œè¶…æ—¶">ç©ºé—²çš„è¿æ¥å’Œè¶…æ—¶</a></li>
                <li>
                    <a href="#%e8%a7%a3%e7%a0%81%e5%9f%ba%e4%ba%8e%e5%88%86%e9%9a%94%e7%ac%a6%e7%9a%84%e5%8d%8f%e8%ae%ae%e5%92%8c%e5%9f%ba%e4%ba%8e%e9%95%bf%e5%ba%a6%e7%9a%84%e5%8d%8f%e8%ae%ae" aria-label="è§£ç åŸºäºåˆ†éš”ç¬¦çš„åè®®å’ŒåŸºäºé•¿åº¦çš„åè®®">è§£ç åŸºäºåˆ†éš”ç¬¦çš„åè®®å’ŒåŸºäºé•¿åº¦çš„åè®®</a><ul>
                        
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e5%88%86%e9%9a%94%e7%ac%a6%e7%9a%84%e5%8d%8f%e8%ae%ae" aria-label="åŸºäºåˆ†éš”ç¬¦çš„åè®®">åŸºäºåˆ†éš”ç¬¦çš„åè®®</a></li>
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e9%95%bf%e5%ba%a6%e7%9a%84%e5%8d%8f%e8%ae%ae" aria-label="åŸºäºé•¿åº¦çš„åè®®">åŸºäºé•¿åº¦çš„åè®®</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%86%99%e5%a4%a7%e5%9e%8b%e6%95%b0%e6%8d%ae" aria-label="å†™å¤§å‹æ•°æ®">å†™å¤§å‹æ•°æ®</a></li>
                <li>
                    <a href="#%e5%ba%8f%e5%88%97%e5%8c%96%e6%95%b0%e6%8d%ae" aria-label="åºåˆ—åŒ–æ•°æ®">åºåˆ—åŒ–æ•°æ®</a><ul>
                        
                <li>
                    <a href="#jdk-%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="JDK åºåˆ—åŒ–">JDK åºåˆ—åŒ–</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-jboss-marshalling-%e8%bf%9b%e8%a1%8c%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="ä½¿ç”¨ JBoss Marshalling è¿›è¡Œåºåˆ—åŒ–">ä½¿ç”¨ JBoss Marshalling è¿›è¡Œåºåˆ—åŒ–</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87-protocol-buffers-%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="é€šè¿‡ Protocol Buffers åºåˆ—åŒ–">é€šè¿‡ Protocol Buffers åºåˆ—åŒ–</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93-4" aria-label="å°ç»“">å°ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#websocket-1" aria-label="WebSocket">WebSocket</a><ul>
                        
                <li>
                    <a href="#websocket-%e7%ae%80%e4%bb%8b" aria-label="WebSocket ç®€ä»‹">WebSocket ç®€ä»‹</a></li>
                <li>
                    <a href="#%e6%88%91%e4%bb%ac%e7%9a%84-websocket-%e7%a4%ba%e4%be%8b%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="æˆ‘ä»¬çš„ WebSocket ç¤ºä¾‹åº”ç”¨ç¨‹åº">æˆ‘ä»¬çš„ WebSocket ç¤ºä¾‹åº”ç”¨ç¨‹åº</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0-websocket-%e6%94%af%e6%8c%81" aria-label="æ·»åŠ  WebSocket æ”¯æŒ">æ·»åŠ  WebSocket æ”¯æŒ</a><ul>
                        
                <li>
                    <a href="#%e5%a4%84%e7%90%86-http-%e8%af%b7%e6%b1%82" aria-label="å¤„ç† HTTP è¯·æ±‚">å¤„ç† HTTP è¯·æ±‚</a></li>
                <li>
                    <a href="#%e5%a4%84%e7%90%86-websocket-%e5%b8%a7" aria-label="å¤„ç† WebSocket å¸§">å¤„ç† WebSocket å¸§</a></li>
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96-channelpipeline" aria-label="åˆå§‹åŒ– ChannelPipeline">åˆå§‹åŒ– ChannelPipeline</a></li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc-1" aria-label="å¼•å¯¼">å¼•å¯¼</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e8%af%a5%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="æµ‹è¯•è¯¥åº”ç”¨ç¨‹åº">æµ‹è¯•è¯¥åº”ç”¨ç¨‹åº</a><ul>
                        
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e8%bf%9b%e8%a1%8c%e5%8a%a0%e5%af%86" aria-label="å¦‚ä½•è¿›è¡ŒåŠ å¯†">å¦‚ä½•è¿›è¡ŒåŠ å¯†</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8dup%e5%b9%bf%e6%92%ad%e4%ba%8b%e4%bb%b6" aria-label="ä½¿ç”¨DUPå¹¿æ’­äº‹ä»¶">ä½¿ç”¨DUPå¹¿æ’­äº‹ä»¶</a><ul>
                        
                <li>
                    <a href="#dup%e5%9f%ba%e7%a1%80" aria-label="DUPåŸºç¡€">DUPåŸºç¡€</a></li>
                <li>
                    <a href="#dup%e5%b9%bf%e6%92%ad" aria-label="DUPå¹¿æ’­">DUPå¹¿æ’­</a></li>
                <li>
                    <a href="#udp-%e7%a4%ba%e4%be%8b%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="UDP ç¤ºä¾‹åº”ç”¨ç¨‹åº">UDP ç¤ºä¾‹åº”ç”¨ç¨‹åº</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af-pojo-logeventc" aria-label="æ¶ˆæ¯ POJO: LogEventc">æ¶ˆæ¯ POJO: LogEventc</a></li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99%e5%b9%bf%e6%92%ad%e8%80%85" aria-label="ç¼–å†™å¹¿æ’­è€…">ç¼–å†™å¹¿æ’­è€…</a></li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99%e7%9b%91%e8%a7%86%e5%99%a8" aria-label="ç¼–å†™ç›‘è§†å™¨">ç¼–å†™ç›‘è§†å™¨</a></li>
                <li>
                    <a href="#%e8%bf%90%e8%a1%8c-logeventbroadcaster-%e5%92%8c-logeventmonitor" aria-label="è¿è¡Œ LogEventBroadcaster å’Œ LogEventMonitor">è¿è¡Œ LogEventBroadcaster å’Œ LogEventMonitor</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%a1%88%e4%be%8b%e7%a0%94%e7%a9%b6-1" aria-label="æ¡ˆä¾‹ç ”ç©¶">æ¡ˆä¾‹ç ”ç©¶</a></li>
                <li>
                    <a href="#%e5%8d%95%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%e5%8a%9f%e8%83%bd" aria-label="å•ç”¨æˆ·ç™»å½•åŠŸèƒ½">å•ç”¨æˆ·ç™»å½•åŠŸèƒ½</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="ç¬¬ä¸€ä¸ªnettyåº”ç”¨ç¨‹åº">ç¬¬ä¸€ä¸ªNettyåº”ç”¨ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#ç¬¬ä¸€ä¸ªnettyåº”ç”¨ç¨‹åº">#</a></h1>
<p>Netty å®¢æˆ·ç«¯/æœåŠ¡å™¨æ¦‚è§ˆ
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/27.png">
Echo å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’æ˜¯éå¸¸ç®€å•çš„ï¼›åœ¨å®¢æˆ·ç«¯å»ºç«‹ä¸€ä¸ªè¿æ¥ä¹‹åï¼Œå®ƒä¼šå‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆæ¯ï¼Œåè¿‡æ¥ï¼ŒæœåŠ¡å™¨åˆä¼šå°†æ¯ä¸ªæ¶ˆæ¯å›é€ç»™å®¢æˆ·ç«¯ã€‚è™½ç„¶å®ƒæœ¬èº«çœ‹èµ·æ¥å¥½åƒç”¨å¤„ä¸å¤§ï¼Œä½†å®ƒå……åˆ†åœ°ä½“ç°äº†å®¢æˆ·ç«¯/æœåŠ¡å™¨ç³»ç»Ÿä¸­å…¸å‹çš„è¯·æ±‚-å“åº”äº¤äº’æ¨¡å¼ã€‚</p>
<!-- more -->
<h2 id="ç¼–å†™-echo-æœåŠ¡å™¨">ç¼–å†™ Echo æœåŠ¡å™¨<a hidden class="anchor" aria-hidden="true" href="#ç¼–å†™-echo-æœåŠ¡å™¨">#</a></h2>
<p>æ‰€æœ‰çš„ Netty æœåŠ¡å™¨éƒ½éœ€è¦ä»¥ä¸‹ä¸¤éƒ¨åˆ†ã€‚</p>
<ul>
<li>è‡³å°‘ä¸€ä¸ª ChannelHandlerï¼šå¤„ç†å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„æ•°æ®ï¼Œå®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li>å¯åŠ¨å¼•å¯¼ï¼šç»‘å®šç«¯å£å’Œå¯åŠ¨æœåŠ¡ã€‚</li>
</ul>
<h3 id="é€šè¿‡channelhandlerå®ç°æœåŠ¡ç«¯">é€šè¿‡channelHandlerå®ç°æœåŠ¡ç«¯<a hidden class="anchor" aria-hidden="true" href="#é€šè¿‡channelhandlerå®ç°æœåŠ¡ç«¯">#</a></h3>
<p>å› ä¸ºä½ çš„ Echo æœåŠ¡å™¨ä¼šå“åº”ä¼ å…¥çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥å®ƒéœ€è¦å®ç° ChannelInboundHandler æ¥å£ï¼Œç”¨æ¥å®šä¹‰å“åº”å…¥ç«™äº‹ä»¶çš„æ–¹æ³•ã€‚è¿™ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºåªéœ€è¦ç”¨åˆ°å°‘é‡çš„è¿™äº›æ–¹æ³•ï¼Œæ‰€ä»¥ç»§æ‰¿ ChannelInboundHandlerAdapter ç±»ä¹Ÿå°±è¶³å¤Ÿäº†ï¼Œå®ƒæä¾›äº† ChannelInboundHandler çš„é»˜è®¤å®ç°ã€‚</p>
<p>channelRead()ï¼šæ¯ä¸ªä¼ å…¥çš„æ¶ˆæ¯éƒ½è¦è°ƒç”¨è¯¥æ–¹æ³•ã€‚
channelReadComplete()ï¼šé€šçŸ¥ChannelInboundHandleræœ€åä¸€æ¬¡å¯¹channelRead()çš„è°ƒç”¨æ˜¯å½“å‰æ‰¹é‡è¯»å–ä¸­çš„æœ€åä¸€æ¡æ¶ˆæ¯ã€‚
exceptionCaught()ï¼šåœ¨è¯»å–æ“ä½œæœŸé—´ï¼Œæœ‰å¼‚å¸¸æŠ›å‡ºæ—¶ä¼šè°ƒç”¨ã€‚</p>
<p>ä»£ç å¦‚ä¸‹</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> nia.chapter2.echoserver;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.buffer.ByteBuf;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.buffer.Unpooled;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelFutureListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelHandler.Sharable;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelHandlerContext;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelInboundHandlerAdapter;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.util.CharsetUtil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 2-1 EchoServerHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ ‡ç¤ºä¸€ä¸ªChannelHandlerå¯ä»¥è¢«å¤šä¸ª Channel å®‰å…¨åœ°å…±äº«</span>
</span></span><span style="display:flex;"><span>@Sharable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EchoServerHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead(ChannelHandlerContext ctx, Object msg) {
</span></span><span style="display:flex;"><span>        ByteBuf in = (ByteBuf) msg;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†æ¶ˆæ¯è®°å½•åˆ°æ§åˆ¶å°</span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;Server received: &#34;</span> + in.<span style="color:#007f7f">toString</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯å†™ç»™å‘é€è€…ï¼Œè€Œä¸å†²åˆ·å‡ºç«™æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">write</span>(in);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelReadComplete(ChannelHandlerContext ctx) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†æœªå†³æ¶ˆæ¯å†²åˆ·åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼Œå¹¶ä¸”å…³é—­è¯¥ Channel</span>
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">writeAndFlush</span>(Unpooled.<span style="color:#007f7f">EMPTY_BUFFER</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">addListener</span>(ChannelFutureListener.<span style="color:#007f7f">CLOSE</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> exceptionCaught(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        Throwable cause) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ‰“å°å¼‚å¸¸æ ˆè·Ÿè¸ª</span>
</span></span><span style="display:flex;"><span>        cause.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å…³é—­è¯¥Channel</span>
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ChannelInboundHandlerAdapter æœ‰ä¸€ä¸ªç›´è§‚çš„ APIï¼Œå¹¶ä¸”å®ƒçš„æ¯ä¸ªæ–¹æ³•éƒ½å¯ä»¥è¢«é‡å†™ä»¥æŒ‚é’©åˆ°äº‹ä»¶ç”Ÿå‘½å‘¨æœŸçš„æ°å½“ç‚¹ä¸Šã€‚å› ä¸ºéœ€è¦å¤„ç†æ‰€æœ‰æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œæ‰€ä»¥ä½ é‡å†™äº† channelRead()æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæœåŠ¡å™¨åº”ç”¨ç¨‹åºä¸­ï¼Œä½ å°†æ•°æ®ç®€å•åœ°å›é€ç»™äº†è¿œç¨‹èŠ‚ç‚¹ã€‚é‡å†™ exceptionCaught()æ–¹æ³•å…è®¸ä½ å¯¹ Throwable çš„ä»»ä½•å­ç±»å‹åšå‡ºååº”ï¼Œåœ¨è¿™é‡Œä½ è®°å½•äº†å¼‚å¸¸å¹¶å…³é—­äº†è¿æ¥ã€‚è™½ç„¶ä¸€ä¸ªæ›´åŠ å®Œå–„çš„åº”ç”¨ç¨‹åºä¹Ÿè®¸ä¼šå°è¯•ä»å¼‚å¸¸ä¸­æ¢å¤ï¼Œä½†åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œåªæ˜¯é€šè¿‡ç®€å•åœ°å…³é—­è¿æ¥æ¥é€šçŸ¥è¿œç¨‹èŠ‚ç‚¹å‘ç”Ÿäº†é”™è¯¯ã€‚</p>
<p>å¦‚æœä¸æ•è·å¼‚å¸¸ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæ¯ä¸ª Channel éƒ½æ‹¥æœ‰ä¸€ä¸ªä¸ä¹‹ç›¸å…³è”çš„ ChannelPipelineï¼Œå…¶æŒæœ‰ä¸€ä¸ª ChannelHandler çš„å®ä¾‹é“¾ã€‚åœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼ŒChannelHandler ä¼šæŠŠå¯¹å®ƒçš„æ–¹æ³•çš„è°ƒç”¨è½¬å‘ç»™é“¾ä¸­çš„ä¸‹ä¸€ä¸ª ChannelHandlerã€‚å› æ­¤ï¼Œå¦‚æœ exceptionCaught()æ–¹æ³•æ²¡æœ‰è¢«è¯¥é“¾ä¸­çš„æŸå¤„å®ç°ï¼Œé‚£ä¹ˆæ‰€æ¥æ”¶çš„å¼‚å¸¸å°†ä¼šè¢«ä¼ é€’åˆ° ChannelPipeline çš„å°¾ç«¯å¹¶è¢«è®°å½•ã€‚ä¸ºæ­¤ï¼Œä½ çš„åº”ç”¨ç¨‹åºåº”è¯¥æä¾›è‡³å°‘æœ‰ä¸€ä¸ªå®ç°äº†exceptionCaught()æ–¹æ³•çš„ ChannelHandlerã€‚</p>
<p>é™¤äº† ChannelInboundHandlerAdapter ä¹‹å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šéœ€è¦å­¦ä¹ çš„ ChannelHandler çš„
å­ç±»å‹å’Œå®ç°ï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬ 6 ç« å’Œç¬¬ 7 ç« ä¸­å¯¹å®ƒä»¬è¿›è¡Œè¯¦ç»†çš„é˜è¿°ã€‚ç›®å‰ï¼Œè¯·è®°ä½ä¸‹é¢è¿™äº›å…³é”®ç‚¹ï¼š</p>
<ul>
<li>é’ˆå¯¹ä¸åŒç±»å‹çš„äº‹ä»¶æ¥è°ƒç”¨ ChannelHandlerï¼›</li>
<li>åº”ç”¨ç¨‹åºé€šè¿‡å®ç°æˆ–è€…æ‰©å±• ChannelHandler æ¥æŒ‚é’©åˆ°äº‹ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ä¸”æä¾›è‡ªå®šä¹‰çš„åº”ç”¨ç¨‹åºé€»è¾‘ï¼›</li>
<li>åœ¨æ¶æ„ä¸Šï¼ŒChannelHandler æœ‰åŠ©äºä¿æŒä¸šåŠ¡é€»è¾‘ä¸ç½‘ç»œå¤„ç†ä»£ç çš„åˆ†ç¦»ã€‚è¿™ç®€åŒ–äº†å¼€å‘è¿‡ç¨‹ï¼Œå› ä¸ºä»£ç å¿…é¡»ä¸æ–­åœ°æ¼”åŒ–ä»¥å“åº”ä¸æ–­å˜åŒ–çš„éœ€æ±‚ã€‚</li>
</ul>
<h3 id="ç¼–å†™å¼•å¯¼æœåŠ¡å™¨">ç¼–å†™å¼•å¯¼æœåŠ¡å™¨<a hidden class="anchor" aria-hidden="true" href="#ç¼–å†™å¼•å¯¼æœåŠ¡å™¨">#</a></h3>
<ul>
<li>å°†ç«¯å£ç»‘å®šåˆ°æœåŠ¡å™¨ä¸Š</li>
<li>é…ç½® Channelï¼Œä»¥å°†æœ‰å…³çš„å…¥ç«™æ¶ˆæ¯é€šçŸ¥ç»™ EchoServerHandler å®ä¾‹ã€‚</li>
</ul>
<p>ä»£ç å¦‚ä¸‹</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> nia.chapter2.echoserver;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.bootstrap.ServerBootstrap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelFuture;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelInitializer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.EventLoopGroup;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.nio.NioEventLoopGroup;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.socket.SocketChannel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.net.InetSocketAddress;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 2-2 EchoServer ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EchoServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> port;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> EchoServer(<span style="color:#fff;font-weight:bold">int</span> port) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">port</span> = port;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è°ƒç”¨æœåŠ¡å™¨çš„ start()æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">new</span> EchoServer(8888).<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> start() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> EchoServerHandler serverHandler = <span style="color:#fff;font-weight:bold">new</span> EchoServerHandler();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//(1) åˆ›å»ºEventLoopGroup</span>
</span></span><span style="display:flex;"><span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(2) åˆ›å»ºServerBootstrap</span>
</span></span><span style="display:flex;"><span>            ServerBootstrap b = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>            b.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//(3) æŒ‡å®šæ‰€ä½¿ç”¨çš„ NIO ä¼ è¾“ Channel</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//(4) ä½¿ç”¨æŒ‡å®šçš„ç«¯å£è®¾ç½®å¥—æ¥å­—åœ°å€</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">localAddress</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port))
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//(5) æ·»åŠ ä¸€ä¸ªEchoServerHandleråˆ°äºChannelçš„ ChannelPipeline</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">childHandler</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelInitializer&lt;SocketChannel&gt;() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(SocketChannel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//EchoServerHandler è¢«æ ‡æ³¨ä¸º@Shareableï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ€»æ˜¯ä½¿ç”¨åŒæ ·çš„å®ä¾‹</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//è¿™é‡Œå¯¹äºæ‰€æœ‰çš„å®¢æˆ·ç«¯è¿æ¥æ¥è¯´ï¼Œéƒ½ä¼šä½¿ç”¨åŒä¸€ä¸ª EchoServerHandlerï¼Œå› ä¸ºå…¶è¢«æ ‡æ³¨ä¸º@Sharableï¼Œ</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//è¿™å°†åœ¨åé¢çš„ç« èŠ‚ä¸­è®²åˆ°ã€‚</span>
</span></span><span style="display:flex;"><span>                        ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addLast</span>(serverHandler);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(6) å¼‚æ­¥åœ°ç»‘å®šæœåŠ¡å™¨ï¼›è°ƒç”¨ sync()æ–¹æ³•é˜»å¡ç­‰å¾…ç›´åˆ°ç»‘å®šå®Œæˆ</span>
</span></span><span style="display:flex;"><span>            ChannelFuture f = b.<span style="color:#007f7f">bind</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(EchoServer.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getName</span>() +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34; started and listening for connections on &#34;</span> + f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">localAddress</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(7) è·å– Channel çš„CloseFutureï¼Œå¹¶ä¸”é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°å®ƒå®Œæˆ</span>
</span></span><span style="display:flex;"><span>            f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(8) å…³é—­ EventLoopGroupï¼Œé‡Šæ”¾æ‰€æœ‰çš„èµ„æº</span>
</span></span><span style="display:flex;"><span>            group.<span style="color:#007f7f">shutdownGracefully</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨(2)å¤„ï¼Œä½ åˆ›å»ºäº†ä¸€ä¸ª ServerBootstrap å®ä¾‹ã€‚å› ä¸ºä½ æ­£åœ¨ä½¿ç”¨çš„æ˜¯ NIO ä¼ è¾“ï¼Œæ‰€ä»¥ä½ æŒ‡å®šäº†
(1)NioEventLoopGroup æ¥æ¥å—å’Œå¤„ç†æ–°çš„è¿æ¥ï¼Œå¹¶ä¸”å°† Channel çš„ç±»å‹æŒ‡å®šä¸º NioServerSocketChannel(3)ã€‚
åœ¨æ­¤ä¹‹åï¼Œä½ å°†æœ¬åœ°åœ°å€è®¾ç½®ä¸ºä¸€ä¸ªå…·æœ‰é€‰å®šç«¯å£çš„ InetSocketAddress(4) ã€‚
æœåŠ¡å™¨å°†ç»‘å®šåˆ°è¿™ä¸ªåœ°å€ä»¥ç›‘å¬æ–°çš„è¿æ¥è¯·æ±‚ã€‚</p>
<p>åœ¨(5)å¤„ï¼Œä½ ä½¿ç”¨äº†ä¸€ä¸ªç‰¹æ®Šçš„ç±»:ChannelInitializerã€‚è¿™æ˜¯å…³é”®ã€‚å½“ä¸€ä¸ªæ–°çš„è¿æ¥è¢«æ¥å—æ—¶ï¼Œä¸€ä¸ªæ–°çš„å­Channel å°†ä¼šè¢«åˆ›å»ºï¼Œè€Œ ChannelInitializer å°†ä¼šæŠŠä¸€ä¸ªä½ çš„EchoServerHandler çš„å®ä¾‹æ·»åŠ åˆ°è¯¥ Channelçš„ ChannelPipeline ä¸­ã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€è§£é‡Šçš„ï¼Œè¿™ä¸ª ChannelHandler å°†ä¼šæ”¶åˆ°æœ‰å…³å…¥ç«™æ¶ˆæ¯çš„é€šçŸ¥ã€‚</p>
<p>è™½ç„¶ NIO æ˜¯å¯ä¼¸ç¼©çš„ï¼Œä½†æ˜¯å…¶é€‚å½“çš„å°¤å…¶æ˜¯å…³äºå¤šçº¿ç¨‹å¤„ç†çš„é…ç½®å¹¶ä¸ç®€å•ã€‚Netty çš„è®¾è®¡å°è£…äº†å¤§éƒ¨åˆ†çš„å¤æ‚æ€§ï¼Œè€Œä¸”æˆ‘ä»¬å°†åœ¨ç¬¬ 3 ç« ä¸­å¯¹ç›¸å…³çš„æŠ½è±¡ï¼ˆEventLoopGroupã€SocketChannel å’Œ ChannelInitializerï¼‰è¿›è¡Œè¯¦ç»†çš„è®¨è®ºã€‚</p>
<p>æ¥ä¸‹æ¥ä½ ç»‘å®šäº†æœåŠ¡å™¨(6)ï¼Œå¹¶ç­‰å¾…ç»‘å®šå®Œæˆã€‚ï¼ˆå¯¹ sync()æ–¹æ³•çš„è°ƒç”¨å°†å¯¼è‡´å½“å‰ Threadé˜»å¡ï¼Œä¸€ç›´åˆ°ç»‘å®šæ“ä½œå®Œæˆä¸ºæ­¢ï¼‰ã€‚åœ¨(7)å¤„ï¼Œè¯¥åº”ç”¨ç¨‹åºå°†ä¼šé˜»å¡ç­‰å¾…ç›´åˆ°æœåŠ¡å™¨çš„ Channelå…³é—­ï¼ˆå› ä¸ºä½ åœ¨ Channel çš„CloseFuture ä¸Šè°ƒç”¨äº† sync()æ–¹æ³•ï¼‰ã€‚ç„¶åï¼Œä½ å°†å¯ä»¥å…³é—­EventLoopGroupï¼Œå¹¶é‡Šæ”¾æ‰€æœ‰çš„èµ„æºï¼ŒåŒ…æ‹¬æ‰€æœ‰è¢«åˆ›å»ºçš„çº¿ç¨‹(8)ã€‚</p>
<p>ä¸æ­¤åŒæ—¶ï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä½ åˆšå®Œæˆçš„æœåŠ¡å™¨å®ç°ä¸­çš„é‡è¦æ­¥éª¤ã€‚ä¸‹é¢è¿™äº›æ˜¯æœåŠ¡å™¨çš„ä¸»è¦ä»£ç ç»„ä»¶ï¼š</p>
<ul>
<li>EchoServerHandler å®ç°äº†ä¸šåŠ¡é€»è¾‘ï¼›</li>
<li>main()æ–¹æ³•å¼•å¯¼äº†æœåŠ¡å™¨ï¼›
å¼•å¯¼è¿‡ç¨‹ä¸­æ‰€éœ€è¦çš„æ­¥éª¤å¦‚ä¸‹ï¼š
<ul>
<li>åˆ›å»ºä¸€ä¸ª ServerBootstrap çš„å®ä¾‹ä»¥å¼•å¯¼å’Œç»‘å®šæœåŠ¡å™¨ï¼›</li>
<li>åˆ›å»ºå¹¶åˆ†é…ä¸€ä¸ª NioEventLoopGroup å®ä¾‹ä»¥è¿›è¡Œäº‹ä»¶çš„å¤„ç†ï¼Œå¦‚æ¥å—æ–°è¿æ¥ä»¥åŠè¯»/å†™æ•°æ®ï¼›</li>
<li>æŒ‡å®šæœåŠ¡å™¨ç»‘å®šçš„æœ¬åœ°çš„ InetSocketAddressï¼›</li>
<li>ä½¿ç”¨ä¸€ä¸ª EchoServerHandler çš„å®ä¾‹åˆå§‹åŒ–æ¯ä¸€ä¸ªæ–°çš„ Channelï¼›</li>
<li>è°ƒç”¨ ServerBootstrap.bind()æ–¹æ³•ä»¥ç»‘å®šæœåŠ¡å™¨ã€‚</li>
</ul>
</li>
</ul>
<p>åœ¨è¿™ä¸ªæ—¶å€™ï¼ŒæœåŠ¡å™¨å·²ç»åˆå§‹åŒ–ï¼Œå¹¶ä¸”å·²ç»å°±ç»ªèƒ½è¢«ä½¿ç”¨äº†ã€‚ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†æ¢è®¨å¯¹åº”çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºçš„ä»£ç ã€‚</p>
<h2 id="ç¼–å†™echoå®¢æˆ·ç«¯">ç¼–å†™echoå®¢æˆ·ç«¯<a hidden class="anchor" aria-hidden="true" href="#ç¼–å†™echoå®¢æˆ·ç«¯">#</a></h2>
<p>Echo å®¢æˆ·ç«¯å°†ä¼šï¼š
ï¼ˆ1ï¼‰è¿æ¥åˆ°æœåŠ¡å™¨ï¼›
ï¼ˆ2ï¼‰å‘é€ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ¶ˆæ¯ï¼›
ï¼ˆ3ï¼‰å¯¹äºæ¯ä¸ªæ¶ˆæ¯ï¼Œç­‰å¾…å¹¶æ¥æ”¶ä»æœåŠ¡å™¨å‘å›çš„ç›¸åŒçš„æ¶ˆæ¯ï¼›
ï¼ˆ4ï¼‰å…³é—­è¿æ¥ã€‚
ç¼–å†™å®¢æˆ·ç«¯æ‰€æ¶‰åŠçš„ä¸¤ä¸ªä¸»è¦ä»£ç éƒ¨åˆ†ä¹Ÿæ˜¯ä¸šåŠ¡é€»è¾‘å’Œå¼•å¯¼ï¼Œå’Œä½ åœ¨æœåŠ¡å™¨ä¸­çœ‹åˆ°çš„ä¸€æ ·ã€‚</p>
<h3 id="é€šè¿‡-channelhandler-å®ç°å®¢æˆ·ç«¯é€»è¾‘">é€šè¿‡ ChannelHandler å®ç°å®¢æˆ·ç«¯é€»è¾‘<a hidden class="anchor" aria-hidden="true" href="#é€šè¿‡-channelhandler-å®ç°å®¢æˆ·ç«¯é€»è¾‘">#</a></h3>
<p>å¦‚åŒæœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å°†æ‹¥æœ‰ä¸€ä¸ªç”¨æ¥å¤„ç†æ•°æ®çš„ ChannelInboundHandlerã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œä½ å°†æ‰©å±•SimpleChannelInboundHandler ç±»ä»¥å¤„ç†æ‰€æœ‰å¿…é¡»çš„ä»»åŠ¡ã€‚æˆ‘ä»¬éœ€è¦é‡å†™å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<p>channelActive()ï¼šåœ¨åˆ°æœåŠ¡å™¨çš„è¿æ¥å·²ç»å»ºç«‹ä¹‹åå°†è¢«è°ƒç”¨ï¼›
channelRead0()ï¼šå½“ä»æœåŠ¡å™¨æ¥æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯æ—¶è¢«è°ƒç”¨ï¼›
exceptionCaught()ï¼šåœ¨å¤„ç†è¿‡ç¨‹ä¸­å¼•å‘å¼‚å¸¸æ—¶è¢«è°ƒç”¨ã€‚</p>
<p>å®¢æˆ·ç«¯çš„channelHandler</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> nia.chapter2.echoclient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.buffer.ByteBuf;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.buffer.Unpooled;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelHandler.Sharable;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelHandlerContext;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.SimpleChannelInboundHandler;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.util.CharsetUtil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 2-3 å®¢æˆ·ç«¯çš„ ChannelHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@Sharable
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ ‡è®°è¯¥ç±»çš„å®ä¾‹å¯ä»¥è¢«å¤šä¸ª Channel å…±äº«</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EchoClientHandler <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;ByteBuf&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(ChannelHandlerContext ctx) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å½“è¢«é€šçŸ¥ Channelæ˜¯æ´»è·ƒçš„æ—¶å€™ï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">writeAndFlush</span>(Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Netty rocks!&#34;</span>, CharsetUtil.<span style="color:#007f7f">UTF_8</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, ByteBuf in) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®°å½•å·²æ¥æ”¶æ¶ˆæ¯çš„è½¬å‚¨</span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Client received: &#34;</span> + in.<span style="color:#007f7f">toString</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè®°å½•é”™è¯¯å¹¶å…³é—­Channel</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> exceptionCaught(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        Throwable cause) {
</span></span><span style="display:flex;"><span>        cause.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é‡å†™äº† channelActive()æ–¹æ³•ï¼Œå…¶å°†åœ¨ä¸€ä¸ªè¿æ¥å»ºç«‹æ—¶è¢«è°ƒç”¨ï¼Œç¡®ä¿æ•°æ®å°†ä¼šè¢«å°½å¯èƒ½å¿«åœ°å†™å…¥æœåŠ¡å™¨ã€‚å†…å®¹æ˜¯ä¸€ä¸ªç¼–ç äº†å­—ç¬¦ä¸²&quot;Netty rocks!&ldquo;çš„å­—èŠ‚ç¼“å†²åŒºã€‚</p>
<p>é‡å†™äº† channelRead0()æ–¹æ³•ï¼Œæ¯å½“æ¥æ”¶æ•°æ®æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯å¯èƒ½ä¼šè¢«åˆ†å—æ¥æ”¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæœåŠ¡å™¨å‘é€äº† 5 å­—èŠ‚ï¼Œé‚£ä¹ˆä¸èƒ½ä¿è¯è¿™ 5 å­—èŠ‚ä¼šè¢«ä¸€æ¬¡æ€§æ¥æ”¶ã€‚å³ä½¿æ˜¯å¯¹äºè¿™ä¹ˆå°‘é‡çš„æ•°æ®ï¼ŒchannelRead0()æ–¹æ³•ä¹Ÿå¯èƒ½ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨ä¸€ä¸ªæŒæœ‰ 3 å­—èŠ‚çš„ ByteBufï¼ˆNetty çš„å­—èŠ‚å®¹å™¨ï¼‰ï¼Œç¬¬äºŒæ¬¡ä½¿ç”¨ä¸€ä¸ªæŒæœ‰ 2 å­—èŠ‚çš„ ByteBufã€‚ä½œä¸ºä¸€ä¸ªé¢å‘æµçš„åè®®ï¼ŒTCP ä¿è¯äº†å­—èŠ‚æ•°ç»„å°†ä¼šæŒ‰ç…§æœåŠ¡å™¨å‘é€å®ƒä»¬çš„é¡ºåºè¢«æ¥æ”¶ã€‚</p>
<p>é‡å†™äº† exceptionCaught()ã€‚ç”¨äºè®°å½• Throwableï¼Œå…³é—­ Channelã€‚</p>
<p>SimpleChannelInboundHandler ä¸ ChannelInboundHandler
ä½ å¯èƒ½ä¼šæƒ³ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯ä½¿ç”¨çš„æ˜¯ SimpleChannelInboundHandlerï¼Œ
è€Œä¸æ˜¯åœ¨ EchoServerHandler ä¸­æ‰€ä½¿ç”¨çš„ ChannelInboundHandlerAdapter å‘¢ï¼Ÿ
è¿™å’Œä¸¤ä¸ªå› ç´ çš„ç›¸äº’ä½œç”¨æœ‰å…³ï¼šä¸šåŠ¡é€»è¾‘å¦‚ä½•å¤„ç†æ¶ˆæ¯ä»¥åŠ Netty å¦‚ä½•ç®¡ç†èµ„æºã€‚</p>
<p>åœ¨å®¢æˆ·ç«¯ï¼Œå½“ channelRead0()æ–¹æ³•å®Œæˆæ—¶ï¼Œä½ å·²ç»æœ‰äº†ä¼ å…¥æ¶ˆæ¯ï¼Œå¹¶ä¸”å·²ç»å¤„ç†å®Œå®ƒäº†ã€‚å½“è¯¥æ–¹æ³•è¿”å›æ—¶ï¼ŒSimpleChannelInboundHandler è´Ÿè´£é‡Šæ”¾æŒ‡å‘ä¿å­˜è¯¥æ¶ˆæ¯çš„ ByteBuf çš„å†…å­˜å¼•ç”¨ã€‚
åœ¨ EchoServerHandler ä¸­ï¼Œä½ ä»ç„¶éœ€è¦å°†ä¼ å…¥æ¶ˆæ¯å›é€ç»™å‘é€è€…ï¼Œè€Œ write()æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œç›´
åˆ° channelRead()æ–¹æ³•è¿”å›åå¯èƒ½ä»ç„¶æ²¡æœ‰å®Œæˆï¼ˆå¦‚ä»£ç æ¸…å• 2-1 æ‰€ç¤ºï¼‰ã€‚ä¸ºæ­¤ï¼ŒEchoServerHandleræ‰©å±•äº† ChannelInboundHandlerAdapterï¼Œå…¶åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šä¸ä¼šé‡Šæ”¾æ¶ˆæ¯ã€‚
æ¶ˆæ¯åœ¨ EchoServerHandler çš„ channelReadComplete()æ–¹æ³•ä¸­ï¼Œå½“ writeAndFlush()æ–¹
æ³•è¢«è°ƒç”¨æ—¶è¢«é‡Šæ”¾ï¼ˆè§ä»£ç æ¸…å• 2-1ï¼‰ã€‚ç¬¬ 5 ç« å’Œç¬¬ 6 ç« å°†å¯¹æ¶ˆæ¯çš„èµ„æºç®¡ç†è¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚</p>
<h3 id="ç¼–å†™å¼•å¯¼å®¢æˆ·ç«¯">ç¼–å†™å¼•å¯¼å®¢æˆ·ç«¯<a hidden class="anchor" aria-hidden="true" href="#ç¼–å†™å¼•å¯¼å®¢æˆ·ç«¯">#</a></h3>
<p>å¼•å¯¼å®¢æˆ·ç«¯ç±»ä¼¼äºå¼•å¯¼æœåŠ¡å™¨ï¼Œä¸åŒçš„æ˜¯ï¼Œå®¢æˆ·ç«¯æ˜¯ä½¿ç”¨ä¸»æœºå’Œç«¯å£å‚æ•°æ¥è¿æ¥è¿œç¨‹åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„Echo æœåŠ¡å™¨çš„åœ°å€ï¼Œè€Œä¸æ˜¯ç»‘å®šåˆ°ä¸€ä¸ªä¸€ç›´è¢«ç›‘å¬çš„ç«¯å£ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> nia.chapter2.echoclient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.bootstrap.Bootstrap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelFuture;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelInitializer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.EventLoopGroup;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.nio.NioEventLoopGroup;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.socket.SocketChannel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.socket.nio.NioSocketChannel;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.net.InetSocketAddress;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 2-4 å®¢æˆ·ç«¯çš„ä¸»ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EchoClient {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String host;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> port;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> EchoClient(String host, <span style="color:#fff;font-weight:bold">int</span> port) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">host</span> = host;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">port</span> = port;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> start()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//åˆ›å»º Bootstrap</span>
</span></span><span style="display:flex;"><span>            Bootstrap b = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æŒ‡å®š EventLoopGroup ä»¥å¤„ç†å®¢æˆ·ç«¯äº‹ä»¶ï¼›éœ€è¦é€‚ç”¨äº NIO çš„å®ç°</span>
</span></span><span style="display:flex;"><span>            b.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//é€‚ç”¨äº NIO ä¼ è¾“çš„Channel ç±»å‹</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">channel</span>(NioSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//è®¾ç½®æœåŠ¡å™¨çš„InetSocketAddress</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">remoteAddress</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(host, port))
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//åœ¨åˆ›å»ºChannelæ—¶ï¼Œå‘ ChannelPipelineä¸­æ·»åŠ ä¸€ä¸ª EchoClientHandlerå®ä¾‹</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">handler</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelInitializer&lt;SocketChannel&gt;() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(SocketChannel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>                             <span style="color:#fff;font-weight:bold">new</span> EchoClientHandler());
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼Œé˜»å¡ç­‰å¾…ç›´åˆ°è¿æ¥å®Œæˆ</span>
</span></span><span style="display:flex;"><span>            ChannelFuture f = b.<span style="color:#007f7f">connect</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//é˜»å¡ï¼Œç›´åˆ°Channel å…³é—­</span>
</span></span><span style="display:flex;"><span>            f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å…³é—­çº¿ç¨‹æ± å¹¶ä¸”é‡Šæ”¾æ‰€æœ‰çš„èµ„æº</span>
</span></span><span style="display:flex;"><span>            group.<span style="color:#007f7f">shutdownGracefully</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">new</span> EchoClient(<span style="color:#0ff;font-weight:bold">&#34;localhost&#34;</span>, 8888).<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å’Œä¹‹å‰ä¸€æ ·ï¼Œä½¿ç”¨äº† NIO ä¼ è¾“ã€‚æ³¨æ„ï¼Œä½ å¯ä»¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸Šåˆ†åˆ«ä½¿ç”¨ä¸åŒçš„ä¼ è¾“ã€‚
ä¾‹å¦‚ï¼Œåœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨ NIO ä¼ è¾“ï¼Œè€Œåœ¨å®¢æˆ·ç«¯ä½¿ç”¨ OIO ä¼ è¾“ã€‚</p>
<p>è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹è¿™ä¸€èŠ‚ä¸­æ‰€ä»‹ç»çš„è¦ç‚¹ï¼š</p>
<ul>
<li>ä¸ºåˆå§‹åŒ–å®¢æˆ·ç«¯ï¼Œåˆ›å»ºäº†ä¸€ä¸ª Bootstrap å®ä¾‹</li>
<li>ä¸ºè¿›è¡Œäº‹ä»¶å¤„ç†åˆ†é…äº†ä¸€ä¸ª NioEventLoopGroup å®ä¾‹ï¼Œå…¶ä¸­äº‹ä»¶å¤„ç†åŒ…æ‹¬åˆ›å»ºæ–°çš„è¿æ¥ä»¥åŠå¤„ç†å…¥ç«™å’Œå‡ºç«™æ•°æ®</li>
<li>ä¸ºæœåŠ¡å™¨è¿æ¥åˆ›å»ºäº†ä¸€ä¸ª InetSocketAddress å®ä¾‹</li>
<li>å½“è¿æ¥è¢«å»ºç«‹æ—¶ï¼Œä¸€ä¸ª EchoClientHandler å®ä¾‹ä¼šè¢«å®‰è£…åˆ°ï¼ˆè¯¥ Channel çš„ï¼‰ChannelPipeline ä¸­</li>
<li>åœ¨ä¸€åˆ‡éƒ½è®¾ç½®å®Œæˆåï¼Œè°ƒç”¨ Bootstrap.connect()æ–¹æ³•è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹</li>
</ul>
<p>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å®Œæˆäº†ï¼Œå¯ä»¥æµ‹è¯•äº†ã€‚</p>
<ol>
<li>
<p>é€šè¿‡mainæ–¹æ³•è¿è¡Œ<code>EchoServer</code>
æ§åˆ¶å°æ‰“å°
<code>nia.chapter2.echoserver.EchoServer started and listening for connections on /0:0:0:0:0:0:0:0:8888</code></p>
</li>
<li>
<p>é€šè¿‡mainæ–¹æ³•è¿è¡Œ<code>EchoClient</code>
<code>Client received: Netty rocks!</code></p>
</li>
</ol>
<p>æœåŠ¡ç«¯å†æ¬¡æ‰“å°
<code>Server received: Netty rocks!</code></p>
<p>ä¸‹é¢æ˜¯å‘ç”Ÿçš„äº‹ï¼š
ï¼ˆ1ï¼‰ä¸€æ—¦å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼Œå®ƒå°±å‘é€å®ƒçš„æ¶ˆæ¯â€”â€”Netty rocks!ï¼›
ï¼ˆ2ï¼‰æœåŠ¡å™¨æŠ¥å‘Šæ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œå¹¶å°†å…¶å›é€ç»™å®¢æˆ·ç«¯ï¼›
ï¼ˆ3ï¼‰å®¢æˆ·ç«¯æŠ¥å‘Šè¿”å›çš„æ¶ˆæ¯å¹¶é€€å‡ºã€‚</p>
<p>éœ€è¦æ³¨æ„ï¼ŒæœåŠ¡ç«¯å¿…é¡»å…ˆå¯åŠ¨ï¼Œå®¢æˆ·ç«¯å…ˆå¯åŠ¨ä¼šæŠ›å‡ºå¼‚å¸¸<code>ConnectException</code>ã€‚
è¿™ä¸ªå¼‚å¸¸ä¸ä¼šè¢«<code>exceptionCaught</code>æ•æ‰åˆ°ã€‚åŸä¹¦è¿™é‡Œæœ‰äº›é—®é¢˜ã€‚</p>
<h1 id="nettyçš„ç»„ä»¶å’Œè®¾è®¡">Nettyçš„ç»„ä»¶å’Œè®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#nettyçš„ç»„ä»¶å’Œè®¾è®¡">#</a></h1>
<h2 id="channelæ¥å£">Channelæ¥å£<a hidden class="anchor" aria-hidden="true" href="#channelæ¥å£">#</a></h2>
<p>åŸºæœ¬çš„ I/O æ“ä½œï¼ˆbind()ã€connect()ã€read()å’Œ write()ï¼‰ä¾èµ–äºåº•å±‚ç½‘ç»œä¼ è¾“æ‰€æä¾›çš„åŸè¯­ã€‚
åœ¨åŸºäº Java çš„ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œå…¶åŸºæœ¬çš„æ„é€ æ˜¯ class Socketã€‚Netty çš„ Channel æ¥å£æ‰€æä¾›çš„ APIï¼Œ
å¤§å¤§åœ°é™ä½äº†ç›´æ¥ä½¿ç”¨ Socket ç±»çš„å¤æ‚æ€§ã€‚æ­¤å¤–ï¼ŒChannel ä¹Ÿæ˜¯æ‹¥æœ‰è®¸å¤šé¢„å®šä¹‰çš„ã€ä¸“é—¨åŒ–å®ç°çš„å¹¿æ³›ç±»å±‚æ¬¡ç»“æ„çš„æ ¹ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€çŸ­çš„éƒ¨åˆ†æ¸…å•ï¼š
EmbeddedChannel
LocalServerChannel
NioDatagramChannel
NioSctpChannel
NioSocketChannel</p>
<h2 id="eventloopæ¥å£">EventLoopæ¥å£<a hidden class="anchor" aria-hidden="true" href="#eventloopæ¥å£">#</a></h2>
<p>EventLoop å®šä¹‰äº† Netty çš„æ ¸å¿ƒæŠ½è±¡ï¼Œç”¨äºå¤„ç†è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸä¸­æ‰€å‘ç”Ÿçš„äº‹ä»¶ã€‚æˆ‘ä»¬å°†åœ¨ç¬¬ 7 ç« ä¸­ç»“åˆ Netty çš„çº¿ç¨‹å¤„ç†æ¨¡å‹çš„ä¸Šä¸‹æ–‡å¯¹ EventLoop è¿›è¡Œè¯¦ç»†çš„è®¨è®ºã€‚ç›®å‰ï¼Œä¸‹å›¾åœ¨é«˜å±‚æ¬¡ä¸Šè¯´æ˜äº† Channelã€EventLoopã€Thread ä»¥åŠ EventLoopGroup ä¹‹é—´çš„å…³ç³»ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/28.png"></p>
<ul>
<li>ä¸€ä¸ª EventLoopGroup åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ª EventLoopï¼›</li>
<li>ä¸€ä¸ª EventLoop åœ¨å®ƒçš„ç”Ÿå‘½å‘¨æœŸå†…åªå’Œä¸€ä¸ª Thread ç»‘å®šï¼›</li>
<li>æ‰€æœ‰ç”± EventLoop å¤„ç†çš„ I/O äº‹ä»¶éƒ½å°†åœ¨å®ƒä¸“æœ‰çš„ Thread ä¸Šè¢«å¤„ç†ï¼›</li>
<li>ä¸€ä¸ª Channel åœ¨å®ƒçš„ç”Ÿå‘½å‘¨æœŸå†…åªæ³¨å†Œäºä¸€ä¸ª EventLoopï¼›</li>
<li>ä¸€ä¸ª EventLoop å¯èƒ½ä¼šè¢«åˆ†é…ç»™ä¸€ä¸ªæˆ–å¤šä¸ª Channelã€‚</li>
</ul>
<p>æ³¨æ„ï¼Œåœ¨è¿™ç§è®¾è®¡ä¸­ï¼Œä¸€ä¸ªç»™å®š Channel çš„ I/O æ“ä½œéƒ½æ˜¯ç”±ç›¸åŒçš„ Thread æ‰§è¡Œçš„ï¼Œå®é™…ä¸Šæ¶ˆé™¤äº†å¯¹äºåŒæ­¥çš„éœ€è¦ã€‚</p>
<h2 id="channelfutureæ¥å£">ChannelFutureæ¥å£<a hidden class="anchor" aria-hidden="true" href="#channelfutureæ¥å£">#</a></h2>
<p>æ­£å¦‚æˆ‘ä»¬å·²ç»è§£é‡Šè¿‡çš„é‚£æ ·ï¼ŒNetty ä¸­æ‰€æœ‰çš„ I/O æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ã€‚å› ä¸ºä¸€ä¸ªæ“ä½œå¯èƒ½ä¸ä¼šç«‹å³è¿”å›ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§ç”¨äºåœ¨ä¹‹åçš„æŸä¸ªæ—¶é—´ç‚¹ç¡®å®šå…¶ç»“æœçš„æ–¹æ³•ã€‚ä¸ºæ­¤ï¼ŒNetty æä¾›äº†ChannelFuture æ¥å£ï¼Œå…¶ addListener()æ–¹æ³•æ³¨å†Œäº†ä¸€ä¸ª ChannelFutureListenerï¼Œä»¥ä¾¿åœ¨æŸä¸ªæ“ä½œå®Œæˆæ—¶ï¼ˆæ— è®ºæ˜¯å¦æˆåŠŸï¼‰å¾—åˆ°é€šçŸ¥ã€‚</p>
<h2 id="channelhandleræ¥å£">ChannelHandleræ¥å£<a hidden class="anchor" aria-hidden="true" href="#channelhandleræ¥å£">#</a></h2>
<p>ä»åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜çš„è§’åº¦æ¥çœ‹ï¼ŒNetty çš„ä¸»è¦ç»„ä»¶æ˜¯ ChannelHandlerï¼Œå®ƒå……å½“äº†æ‰€æœ‰å¤„ç†å…¥ç«™å’Œå‡ºç«™æ•°æ®çš„åº”ç”¨ç¨‹åºé€»è¾‘çš„å®¹å™¨ã€‚è¿™æ˜¯å¯è¡Œçš„ï¼Œå› ä¸º ChannelHandler çš„æ–¹æ³•æ˜¯ç”±ç½‘ç»œäº‹ä»¶ï¼ˆå…¶ä¸­æœ¯è¯­â€œäº‹ä»¶â€çš„ä½¿ç”¨éå¸¸å¹¿æ³›ï¼‰è§¦å‘çš„ã€‚äº‹å®ä¸Šï¼ŒChannelHandler å¯ä¸“é—¨ç”¨äºå‡ ä¹ä»»ä½•ç±»å‹çš„åŠ¨ä½œï¼Œä¾‹å¦‚å°†æ•°æ®ä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦å¤–ä¸€ç§æ ¼å¼ï¼Œæˆ–è€…å¤„ç†è½¬æ¢è¿‡ç¨‹ä¸­æ‰€æŠ›å‡ºçš„å¼‚å¸¸ã€‚
ä¸¾ä¾‹æ¥è¯´ï¼ŒChannelInboundHandler æ˜¯ä¸€ä¸ªä½ å°†ä¼šç»å¸¸å®ç°çš„å­æ¥å£ã€‚è¿™ç§ç±»å‹çš„ChannelHandler æ¥æ”¶å…¥ç«™äº‹ä»¶å’Œæ•°æ®ï¼Œè¿™äº›æ•°æ®éšåå°†ä¼šè¢«ä½ çš„åº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘æ‰€å¤„ç†ã€‚å½“ä½ è¦ç»™è¿æ¥çš„å®¢æˆ·ç«¯å‘é€å“åº”æ—¶ï¼Œä¹Ÿå¯ä»¥ä» ChannelInboundHandler å†²åˆ·æ•°æ®ã€‚ä½ çš„åº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘é€šå¸¸é©»ç•™åœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ª ChannelInboundHandler ä¸­ã€‚</p>
<h2 id="channelpipelineæ¥å£">ChannelPipelineæ¥å£<a hidden class="anchor" aria-hidden="true" href="#channelpipelineæ¥å£">#</a></h2>
<p>ChannelPipeline æä¾›äº† ChannelHandler é“¾çš„å®¹å™¨ï¼Œå¹¶å®šä¹‰äº†ç”¨äºåœ¨è¯¥é“¾ä¸Šä¼ æ’­å…¥ç«™å’Œå‡ºç«™äº‹ä»¶æµçš„ APIã€‚
å½“ Channel è¢«åˆ›å»ºæ—¶ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨åœ°åˆ†é…åˆ°å®ƒä¸“å±çš„ ChannelPipelineã€‚
ChannelHandler å®‰è£…åˆ° ChannelPipeline ä¸­çš„è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li>ä¸€ä¸ªChannelInitializerçš„å®ç°è¢«æ³¨å†Œåˆ°äº†ServerBootstrapä¸­</li>
<li>å½“ ChannelInitializer.initChannel()æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒChannelInitializer
å°†åœ¨ ChannelPipeline ä¸­å®‰è£…ä¸€ç»„è‡ªå®šä¹‰çš„ ChannelHandler</li>
<li>ChannelInitializer å°†å®ƒè‡ªå·±ä» ChannelPipeline ä¸­ç§»é™¤ã€‚</li>
</ul>
<p>ChannelHandler æ˜¯ä¸“ä¸ºæ”¯æŒå¹¿æ³›çš„ç”¨é€”è€Œè®¾è®¡çš„ï¼Œå¯ä»¥å°†å®ƒçœ‹ä½œæ˜¯å¤„ç†å¾€æ¥ ChannelPipeline äº‹ä»¶
ï¼ˆåŒ…æ‹¬æ•°æ®ï¼‰çš„ä»»ä½•ä»£ç çš„é€šç”¨å®¹å™¨ã€‚å›¾ 3-2 è¯´æ˜äº†è¿™ä¸€ç‚¹ï¼Œå…¶å±•ç¤ºäº†ä» ChannelHandler æ´¾ç”Ÿçš„
ChannelInboundHandler å’Œ ChannelOutboundHandler æ¥å£ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/29.png"></p>
<p>ä½¿å¾—äº‹ä»¶æµç» ChannelPipeline æ˜¯ ChannelHandler çš„å·¥ä½œï¼Œå®ƒä»¬æ˜¯åœ¨åº”ç”¨ç¨‹åºçš„åˆå§‹åŒ–æˆ–è€…å¼•å¯¼é˜¶æ®µè¢«å®‰è£…çš„ã€‚è¿™äº›å¯¹è±¡æ¥æ”¶äº‹ä»¶ã€æ‰§è¡Œå®ƒä»¬æ‰€å®ç°çš„å¤„ç†é€»è¾‘ï¼Œå¹¶å°†æ•°æ®ä¼ é€’ç»™é“¾ä¸­çš„ä¸‹ä¸€ä¸ª ChannelHandlerã€‚
å®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯ç”±å®ƒä»¬è¢«æ·»åŠ çš„é¡ºåºæ‰€å†³å®šçš„ã€‚å®é™…ä¸Šï¼Œè¢«æˆ‘ä»¬ç§°ä¸º ChannelPipeline çš„æ˜¯è¿™äº› ChannelHandler çš„ç¼–æ’é¡ºåºã€‚</p>
<p>å›¾ 3-3 è¯´æ˜äº†ä¸€ä¸ª Netty åº”ç”¨ç¨‹åºä¸­å…¥ç«™å’Œå‡ºç«™æ•°æ®æµä¹‹é—´çš„åŒºåˆ«ã€‚ä»ä¸€ä¸ªå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºçš„è§’åº¦æ¥çœ‹ï¼Œå¦‚æœäº‹ä»¶çš„è¿åŠ¨æ–¹å‘æ˜¯ä»å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨ç«¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§°è¿™äº›äº‹ä»¶ä¸ºå‡ºç«™çš„ï¼Œåä¹‹åˆ™ç§°ä¸ºå…¥ç«™çš„ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/30.png"></p>
<p>å›¾ 3-3 ä¹Ÿæ˜¾ç¤ºäº†å…¥ç«™å’Œå‡ºç«™ ChannelHandler å¯ä»¥è¢«å®‰è£…åˆ°åŒä¸€ä¸ª ChannelPipelineä¸­ã€‚å¦‚æœä¸€ä¸ªæ¶ˆæ¯æˆ–è€…ä»»ä½•å…¶ä»–çš„å…¥ç«™äº‹ä»¶è¢«è¯»å–ï¼Œé‚£ä¹ˆå®ƒä¼šä» ChannelPipeline çš„å¤´éƒ¨å¼€å§‹æµåŠ¨ï¼Œå¹¶è¢«ä¼ é€’ç»™ç¬¬ä¸€ä¸ªChannelInboundHandlerã€‚è¿™ä¸ª ChannelHandler ä¸ä¸€å®šä¼šå®é™…åœ°ä¿®æ”¹æ•°æ®ï¼Œå…·ä½“å–å†³äºå®ƒçš„å…·ä½“åŠŸèƒ½ï¼Œåœ¨è¿™ä¹‹åï¼Œæ•°æ®å°†ä¼šè¢«ä¼ é€’ç»™é“¾ä¸­çš„ä¸‹ä¸€ä¸ªChannelInboundHandlerã€‚æœ€ç»ˆï¼Œæ•°æ®å°†ä¼šåˆ°è¾¾ ChannelPipeline çš„å°¾ç«¯ï¼Œå±Šæ—¶ï¼Œæ‰€æœ‰å¤„ç†å°±éƒ½ç»“æŸäº†ã€‚</p>
<p>æ•°æ®çš„å‡ºç«™è¿åŠ¨ï¼ˆå³æ­£åœ¨è¢«å†™çš„æ•°æ®ï¼‰åœ¨æ¦‚å¿µä¸Šä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®å°†ä»
ChannelOutboundHandler é“¾çš„å°¾ç«¯å¼€å§‹æµåŠ¨ï¼Œç›´åˆ°å®ƒåˆ°è¾¾é“¾çš„å¤´éƒ¨ä¸ºæ­¢ã€‚åœ¨è¿™ä¹‹åï¼Œå‡ºç«™æ•°æ®å°†ä¼šåˆ°è¾¾ç½‘ç»œä¼ è¾“å±‚ï¼Œè¿™é‡Œæ˜¾ç¤ºä¸º Socketã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™å°†è§¦å‘ä¸€ä¸ªå†™æ“ä½œã€‚</p>
<p>å…³äºå…¥ç«™å’Œå‡ºç«™ ChannelHandler çš„æ›´å¤šè®¨è®º
é€šè¿‡ä½¿ç”¨ä½œä¸ºå‚æ•°ä¼ é€’åˆ°æ¯ä¸ªæ–¹æ³•çš„ ChannelHandlerContextï¼Œäº‹ä»¶å¯ä»¥è¢«ä¼ é€’ç»™å½“å‰
ChannelHandler é“¾ä¸­çš„ä¸‹ä¸€ä¸ª ChannelHandlerã€‚å› ä¸ºä½ æœ‰æ—¶ä¼šå¿½ç•¥é‚£äº›ä¸æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œæ‰€ä»¥ Nettyæä¾›äº†æŠ½è±¡åŸºç±» ChannelInboundHandlerAdapter å’Œ ChannelOutboundHandlerAdapterã€‚é€šè¿‡è°ƒç”¨ ChannelHandlerContext ä¸Šçš„å¯¹åº”æ–¹æ³•ï¼Œæ¯ä¸ªéƒ½æä¾›äº†ç®€å•åœ°å°†äº‹ä»¶ä¼ é€’ç»™ä¸‹ä¸€ä¸ªChannelHandlerçš„æ–¹æ³•çš„å®ç°ã€‚éšåï¼Œä½ å¯ä»¥é€šè¿‡é‡å†™ä½ æ‰€æ„Ÿå…´è¶£çš„é‚£äº›æ–¹æ³•æ¥æ‰©å±•è¿™äº›ç±»ã€‚</p>
<p>é‰´äºå‡ºç«™æ“ä½œå’Œå…¥ç«™æ“ä½œæ˜¯ä¸åŒçš„ï¼Œä½ å¯èƒ½ä¼šæƒ³çŸ¥é“å¦‚æœå°†ä¸¤ä¸ªç±»åˆ«çš„ ChannelHandleréƒ½æ··åˆæ·»åŠ åˆ°åŒä¸€ä¸ª ChannelPipeline ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆã€‚è™½ç„¶ ChannelInboundHandle å’ŒChannelOutboundHandle éƒ½æ‰©å±•è‡ªChannelHandlerï¼Œä½†æ˜¯ Netty èƒ½åŒºåˆ† ChannelInboundHandler å®ç°å’Œ ChannelOutboundHandler å®ç°ï¼Œå¹¶ç¡®ä¿æ•°æ®åªä¼šåœ¨å…·æœ‰ç›¸åŒå®šå‘ç±»å‹çš„ä¸¤ä¸ª ChannelHandler ä¹‹é—´ä¼ é€’ã€‚</p>
<p>å½“ChannelHandler è¢«æ·»åŠ åˆ°ChannelPipeline æ—¶ï¼Œå®ƒå°†ä¼šè¢«åˆ†é…ä¸€ä¸ªChannelHandlerContextï¼Œå…¶ä»£è¡¨äº†ChannelHandler å’Œ ChannelPipeline ä¹‹é—´çš„ç»‘å®šã€‚è™½ç„¶è¿™ä¸ªå¯¹è±¡å¯ä»¥è¢«ç”¨äºè·å–åº•å±‚çš„ Channelï¼Œä½†æ˜¯å®ƒä¸»è¦è¿˜æ˜¯è¢«ç”¨äºå†™å‡ºç«™æ•°æ®ã€‚
åœ¨ Netty ä¸­ï¼Œæœ‰ä¸¤ç§å‘é€æ¶ˆæ¯çš„æ–¹å¼ã€‚ä½ å¯ä»¥ç›´æ¥å†™åˆ° Channel ä¸­ï¼Œä¹Ÿå¯ä»¥ å†™åˆ°å’Œ ChannelHandlerç›¸å…³è”çš„ChannelHandlerContextå¯¹è±¡ä¸­ã€‚å‰ä¸€ç§æ–¹å¼å°†ä¼šå¯¼è‡´æ¶ˆæ¯ä»ChannelPipeline çš„å°¾ç«¯å¼€å§‹æµåŠ¨ï¼Œè€Œåè€…å°†å¯¼è‡´æ¶ˆæ¯ä» ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelHandler å¼€å§‹æµåŠ¨ã€‚</p>
<h2 id="æ›´åŠ æ·±å…¥åœ°äº†è§£-channelhandler">æ›´åŠ æ·±å…¥åœ°äº†è§£ ChannelHandler<a hidden class="anchor" aria-hidden="true" href="#æ›´åŠ æ·±å…¥åœ°äº†è§£-channelhandler">#</a></h2>
<p>æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„ï¼Œæœ‰è®¸å¤šä¸åŒç±»å‹çš„ ChannelHandlerï¼Œå®ƒä»¬å„è‡ªçš„åŠŸèƒ½ä¸»è¦å–å†³äºå®ƒä»¬çš„è¶…ç±»ã€‚Netty ä»¥é€‚é…å™¨ç±»çš„å½¢å¼æä¾›äº†å¤§é‡é»˜è®¤çš„ ChannelHandler å®ç°ï¼Œå…¶æ—¨åœ¨ç®€åŒ–åº”ç”¨ç¨‹åºå¤„ç†é€»è¾‘çš„å¼€å‘è¿‡ç¨‹ã€‚ä½ å·²ç»çœ‹åˆ°äº†ï¼ŒChannelPipelineä¸­çš„æ¯ä¸ªChannelHandlerå°†è´Ÿè´£æŠŠäº‹ä»¶è½¬å‘åˆ°é“¾ä¸­çš„ä¸‹ä¸€ä¸ªChannelHandlerã€‚è¿™äº›é€‚é…å™¨ç±»ï¼ˆåŠå®ƒä»¬çš„å­ç±»ï¼‰å°†è‡ªåŠ¨æ‰§è¡Œè¿™ä¸ªæ“ä½œï¼Œæ‰€ä»¥ä½ å¯ä»¥åªé‡å†™é‚£äº›ä½ æƒ³è¦ç‰¹æ®Šå¤„ç†çš„æ–¹æ³•å’Œäº‹ä»¶ã€‚</p>
<p>ä¸ºä»€ä¹ˆéœ€è¦é€‚é…å™¨ç±»
æœ‰ä¸€äº›é€‚é…å™¨ç±»å¯ä»¥å°†ç¼–å†™è‡ªå®šä¹‰çš„ ChannelHandler æ‰€éœ€è¦çš„åŠªåŠ›é™åˆ°æœ€ä½é™åº¦ï¼Œå› ä¸ºå®ƒä»¬æä¾›äº†å®šä¹‰åœ¨å¯¹åº”æ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³•çš„é»˜è®¤å®ç°ã€‚
ä¸‹é¢è¿™äº›æ˜¯ç¼–å†™è‡ªå®šä¹‰ ChannelHandler æ—¶ç»å¸¸ä¼šç”¨åˆ°çš„é€‚é…å™¨ç±»ï¼š
ChannelHandlerAdapter
ChannelInboundHandlerAdapter
ChannelOutboundHandlerAdapter
ChannelDuplexHandler</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ç ”ç©¶ 3 ä¸ª ChannelHandler çš„å­ç±»å‹ï¼šç¼–ç å™¨ã€è§£ç å™¨å’Œ
<code>SimpleChannelInboundHandler&lt;T&gt;</code>â€”â€” ChannelInboundHandlerAdapter çš„ä¸€ä¸ªå­ç±»ã€‚</p>
<h2 id="ç¼–ç å™¨å’Œè§£ç å™¨">ç¼–ç å™¨å’Œè§£ç å™¨<a hidden class="anchor" aria-hidden="true" href="#ç¼–ç å™¨å’Œè§£ç å™¨">#</a></h2>
<p>å½“ä½ é€šè¿‡ Netty å‘é€æˆ–è€…æ¥æ”¶ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶å€™ï¼Œå°±å°†ä¼šå‘ç”Ÿä¸€æ¬¡æ•°æ®è½¬æ¢ã€‚å…¥ç«™æ¶ˆæ¯ä¼šè¢«è§£ç ï¼›
ä¹Ÿå°±æ˜¯è¯´ï¼Œä»å­—èŠ‚è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª Java å¯¹è±¡ã€‚å¦‚æœæ˜¯å‡ºç«™æ¶ˆæ¯ï¼Œåˆ™ä¼šå‘ç”Ÿç›¸åæ–¹å‘çš„è½¬æ¢ï¼šå®ƒå°†ä»å®ƒçš„å½“å‰æ ¼å¼è¢«ç¼–ç ä¸ºå­—èŠ‚ã€‚è¿™ä¸¤ç§æ–¹å‘çš„è½¬æ¢çš„åŸå› å¾ˆç®€å•ï¼šç½‘ç»œæ•°æ®æ€»æ˜¯ä¸€ç³»åˆ—çš„å­—èŠ‚ã€‚</p>
<p>å¯¹åº”äºç‰¹å®šçš„éœ€è¦ï¼ŒNetty ä¸ºç¼–ç å™¨å’Œè§£ç å™¨æä¾›äº†ä¸åŒç±»å‹çš„æŠ½è±¡ç±»ã€‚ä¾‹å¦‚ï¼Œä½ çš„åº”ç”¨ç¨‹åºå¯èƒ½ä½¿ç”¨äº†ä¸€ç§ä¸­é—´æ ¼å¼ï¼Œè€Œä¸éœ€è¦ç«‹å³å°†æ¶ˆæ¯è½¬æ¢æˆå­—èŠ‚ã€‚ä½ å°†ä»ç„¶éœ€è¦ä¸€ä¸ªç¼–ç å™¨ï¼Œä½†æ˜¯å®ƒå°†æ´¾ç”Ÿè‡ªä¸€ä¸ªä¸åŒçš„è¶…ç±»ã€‚
ä¸ºäº†ç¡®å®šåˆé€‚çš„ç¼–ç å™¨ç±»å‹ï¼Œä½ å¯ä»¥åº”ç”¨ä¸€ä¸ªç®€å•çš„å‘½åçº¦å®šã€‚é€šå¸¸æ¥è¯´ï¼Œè¿™äº›åŸºç±»çš„åç§°å°†ç±»ä¼¼äºByteToMessageDecoder æˆ– MessageToByteEncoderã€‚å¯¹äºç‰¹æ®Šçš„ç±»å‹ï¼Œä½ å¯èƒ½ä¼šå‘ç°ç±»ä¼¼äº ProtobufEncoder å’Œ ProtobufDecoderè¿™æ ·çš„åç§°â€”â€”é¢„ç½®çš„ç”¨æ¥æ”¯æŒ Google çš„ Protocol Buffersã€‚</p>
<p>ä¸¥æ ¼åœ°è¯´ï¼Œå…¶ä»–çš„å¤„ç†å™¨ä¹Ÿå¯ä»¥å®Œæˆç¼–ç å™¨å’Œè§£ç å™¨çš„åŠŸèƒ½ã€‚ä½†æ˜¯ï¼Œæ­£å¦‚æœ‰ç”¨æ¥ç®€åŒ–ChannelHandler çš„åˆ›å»ºçš„é€‚é…å™¨ç±»ä¸€æ ·ï¼Œæ‰€æœ‰ç”± Netty æä¾›çš„ç¼–ç å™¨/è§£ç å™¨é€‚é…å™¨ç±»éƒ½å®ç°äº†
ChannelOutboundHandler æˆ–è€… ChannelInboundHandler æ¥å£ã€‚</p>
<p>ä½ å°†ä¼šå‘ç°å¯¹äºå…¥ç«™æ•°æ®æ¥è¯´ï¼ŒchannelRead æ–¹æ³•/äº‹ä»¶å·²ç»è¢«é‡å†™äº†ã€‚å¯¹äºæ¯ä¸ªä»å…¥ç«™Channel
è¯»å–çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ–¹æ³•éƒ½å°†ä¼šè¢«è°ƒç”¨ã€‚éšåï¼Œå®ƒå°†è°ƒç”¨ç”±é¢„ç½®è§£ç å™¨æ‰€æä¾›çš„ decode()
æ–¹æ³•ï¼Œå¹¶å°†å·²è§£ç çš„å­—èŠ‚è½¬å‘ç»™ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelInboundHandlerã€‚å‡ºç«™æ¶ˆæ¯çš„æ¨¡å¼æ˜¯ç›¸åæ–¹å‘çš„ï¼šç¼–ç å™¨å°†æ¶ˆæ¯è½¬æ¢ä¸ºå­—èŠ‚ï¼Œå¹¶å°†å®ƒä»¬è½¬å‘ç»™ä¸‹ä¸€ChannelOutboundHandlerã€‚</p>
<h2 id="æŠ½è±¡ç±»-simplechannelinboundhandler">æŠ½è±¡ç±» SimpleChannelInboundHandler<a hidden class="anchor" aria-hidden="true" href="#æŠ½è±¡ç±»-simplechannelinboundhandler">#</a></h2>
<p>é€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨ä¸€ä¸ª ChannelHandler æ¥æ¥æ”¶è§£ç æ¶ˆæ¯ï¼Œå¹¶ç»“åˆä¸šåŠ¡é€»è¾‘æ¥å¤„ç†è¿™ä¸ªæ¶ˆæ¯ã€‚
è¦åˆ›å»ºä¸€ä¸ªè¿™æ ·çš„ ChannelHandlerï¼Œä½ åªéœ€è¦æ‰©å±•åŸºç±» <code>SimpleChannelInboundHandler&lt;T&gt;</code>ï¼Œ
å…¶ä¸­ T æ˜¯ä½ è¦å¤„ç†çš„æ¶ˆæ¯çš„ Java ç±»å‹ ã€‚åœ¨è¿™ä¸ª ChannelHandler ä¸­ï¼Œä½ å°†éœ€è¦é‡å†™åŸºç±»çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”è·å–ä¸€ä¸ªåˆ° ChannelHandlerContext çš„å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨å°†ä½œä¸ºè¾“å…¥å‚æ•°ä¼ é€’ç»™ ChannelHandler çš„æ‰€æœ‰æ–¹æ³•ã€‚
åœ¨è¿™ç§ç±»å‹çš„ ChannelHandler ä¸­ï¼Œæœ€é‡è¦çš„æ–¹æ³•æ˜¯ channelRead0(ChannelHandlerContext,T)ã€‚
é™¤äº†è¦æ±‚ä¸è¦é˜»å¡å½“å‰çš„ I/O çº¿ç¨‹ä¹‹å¤–ï¼Œå…¶å…·ä½“å®ç°å®Œå…¨å–å†³äºä½ ã€‚æˆ‘ä»¬ç¨åå°†å¯¹è¿™ä¸€ä¸»é¢˜è¿›è¡Œæ›´å¤šçš„è¯´æ˜ã€‚</p>
<h2 id="å¼•å¯¼ç±»">å¼•å¯¼ç±»<a hidden class="anchor" aria-hidden="true" href="#å¼•å¯¼ç±»">#</a></h2>
<p>Netty çš„å¼•å¯¼ç±»ä¸ºåº”ç”¨ç¨‹åºçš„ç½‘ç»œå±‚é…ç½®æä¾›äº†å®¹å™¨ï¼Œè¿™æ¶‰åŠå°†ä¸€ä¸ªè¿›ç¨‹ç»‘å®šåˆ°æŸä¸ªæŒ‡å®šçš„ç«¯å£ï¼Œæˆ–è€…å°†ä¸€ä¸ªè¿›ç¨‹è¿æ¥åˆ°å¦ä¸€ä¸ªè¿è¡Œåœ¨æŸä¸ªæŒ‡å®šä¸»æœºçš„æŒ‡å®šç«¯å£ä¸Šçš„è¿›ç¨‹ã€‚é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬æŠŠå‰é¢çš„ç”¨ä¾‹ç§°ä½œå¼•å¯¼ä¸€ä¸ªæœåŠ¡å™¨ï¼Œåé¢çš„ç”¨ä¾‹ç§°ä½œå¼•å¯¼ä¸€ä¸ªå®¢æˆ·ç«¯ã€‚è™½ç„¶è¿™ä¸ªæœ¯è¯­ç®€å•æ–¹ä¾¿ï¼Œä½†æ˜¯å®ƒç•¥å¾®æ©ç›–äº†ä¸€ä¸ªé‡è¦çš„äº‹å®ï¼Œå³â€œæœåŠ¡å™¨â€å’Œâ€œå®¢æˆ·ç«¯â€å®é™…ä¸Šè¡¨ç¤ºäº†ä¸åŒçš„ç½‘ç»œè¡Œä¸ºï¼›æ¢å¥è¯è¯´ï¼Œæ˜¯ç›‘å¬ä¼ å…¥çš„è¿æ¥è¿˜æ˜¯å»ºç«‹åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¿›ç¨‹çš„è¿æ¥ã€‚</p>
<p>å› æ­¤ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„å¼•å¯¼ï¼šBootstrapç”¨äºå®¢æˆ·ç«¯ï¼ŒServerBootstrapç”¨äºæœåŠ¡å™¨ã€‚
æ— è®ºä½ çš„åº”ç”¨ç¨‹åºä½¿ç”¨å“ªç§åè®®æˆ–è€…å¤„ç†å“ªç§ç±»å‹çš„æ•°æ®ï¼Œå”¯ä¸€å†³å®šå®ƒä½¿ç”¨å“ªç§å¼•å¯¼ç±»çš„æ˜¯å®ƒæ˜¯ä½œä¸ºä¸€ä¸ªå®¢æˆ·ç«¯è¿˜æ˜¯ä½œä¸ºä¸€ä¸ªæœåŠ¡å™¨ã€‚ä¸¤ç§å¼•å¯¼ç±»çš„åŒºåˆ«æ˜¯ï¼š</p>
<table>
<thead>
<tr>
<th>ç±»åˆ«</th>
<th>ç½‘ç»œç¼–ç¨‹ä¸­çš„ä½œç”¨</th>
<th>EventLoopGroup çš„æ•°ç›®</th>
</tr>
</thead>
<tbody>
<tr>
<td>bootstrap</td>
<td>è¿æ¥è¿œç¨‹ä¸»æœºå’Œç«¯å£</td>
<td>1</td>
</tr>
<tr>
<td>serverbootstrap</td>
<td>ç»‘å®šåˆ°ä¸€ä¸ªæœ¬åœ°ç«¯å£</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>å¼•å¯¼ä¸€ä¸ªå®¢æˆ·ç«¯åªéœ€è¦ä¸€ä¸ª EventLoopGroupï¼Œä½†æ˜¯ä¸€ä¸ªServerBootstrap åˆ™éœ€è¦ä¸¤ä¸ªï¼ˆä¹Ÿå¯ä»¥æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼‰ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿï¼ˆå®é™…ä¸Šï¼ŒServerBootstrap ç±»ä¹Ÿå¯ä»¥åªä½¿ç”¨ä¸€ä¸ª EventLoopGroupï¼Œæ­¤æ—¶å…¶å°†åœ¨ä¸¤ä¸ªåœºæ™¯ä¸‹å…±ç”¨åŒä¸€ä¸ª EventLoopGroupã€‚ï¼‰</p>
<p>å› ä¸ºæœåŠ¡å™¨éœ€è¦ä¸¤ç»„ä¸åŒçš„ Channelã€‚ç¬¬ä¸€ç»„å°†åªåŒ…å«ä¸€ä¸ª ServerChannelï¼Œä»£è¡¨æœåŠ¡å™¨è‡ªèº«çš„å·²ç»‘å®šåˆ°æŸä¸ªæœ¬åœ°ç«¯å£çš„æ­£åœ¨ç›‘å¬çš„å¥—æ¥å­—ã€‚è€Œç¬¬äºŒç»„å°†åŒ…å«æ‰€æœ‰å·²åˆ›å»ºçš„ç”¨æ¥å¤„ç†ä¼ å…¥å®¢æˆ·ç«¯è¿æ¥ï¼ˆå¯¹äºæ¯ä¸ªæœåŠ¡å™¨å·²ç»æ¥å—çš„è¿æ¥éƒ½æœ‰ä¸€ä¸ªï¼‰çš„ Channelã€‚å›¾ 3-4 è¯´æ˜äº†è¿™ä¸ªæ¨¡å‹ï¼Œå¹¶ä¸”å±•ç¤ºäº†ä¸ºä½•éœ€è¦ä¸¤ä¸ªä¸åŒçš„ EventLoopGroupã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/31.png"></p>
<p>ä¸ ServerChannel ç›¸å…³è”çš„ EventLoopGroup å°†åˆ†é…ä¸€ä¸ªè´Ÿè´£ä¸ºä¼ å…¥è¿æ¥è¯·æ±‚åˆ›å»ºChannel çš„ EventLoopã€‚ä¸€æ—¦è¿æ¥è¢«æ¥å—ï¼Œç¬¬äºŒä¸ª EventLoopGroup å°±ä¼šç»™å®ƒçš„ Channelåˆ†é…ä¸€ä¸ª EventLoopã€‚</p>
<h1 id="ä¼ è¾“">ä¼ è¾“<a hidden class="anchor" aria-hidden="true" href="#ä¼ è¾“">#</a></h1>
<h2 id="æ¡ˆä¾‹ç ”ç©¶">æ¡ˆä¾‹ç ”ç©¶<a hidden class="anchor" aria-hidden="true" href="#æ¡ˆä¾‹ç ”ç©¶">#</a></h2>
<p>æˆ‘ä»¬å°†ä»ä¸€ä¸ªåº”ç”¨ç¨‹åºå¼€å§‹æˆ‘ä»¬å¯¹ä¼ è¾“çš„å­¦ä¹ ï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºåªç®€å•åœ°æ¥å—è¿æ¥ï¼Œå‘å®¢æˆ·ç«¯å†™â€œHi!â€ï¼Œç„¶åå…³é—­è¿æ¥ã€‚</p>
<h3 id="ä¸é€šè¿‡-netty-ä½¿ç”¨-oio-å’Œ-nio">ä¸é€šè¿‡ Netty ä½¿ç”¨ OIO å’Œ NIO<a hidden class="anchor" aria-hidden="true" href="#ä¸é€šè¿‡-netty-ä½¿ç”¨-oio-å’Œ-nio">#</a></h3>
<p>æˆ‘ä»¬å°†ä»‹ç»ä»…ä½¿ç”¨äº† JDK API çš„åº”ç”¨ç¨‹åºçš„é˜»å¡ï¼ˆOIOï¼‰ç‰ˆæœ¬å’Œå¼‚æ­¥ï¼ˆNIOï¼‰ç‰ˆæœ¬ã€‚ä»£ç æ¸…å• 4-1 å±•ç¤ºäº†å…¶sé˜»å¡ç‰ˆæœ¬çš„å®ç°ã€‚å¦‚æœä½ æ›¾äº«å—è¿‡ä½¿ç”¨ JDK è¿›è¡Œç½‘ç»œç¼–ç¨‹çš„ä¹è¶£ï¼Œé‚£ä¹ˆè¿™æ®µä»£ç å°†å”¤èµ·ä½ ç¾å¥½çš„å›å¿†ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 4-1 æœªä½¿ç”¨ Netty çš„é˜»å¡ç½‘ç»œç¼–ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PlainOioServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> server(<span style="color:#fff;font-weight:bold">int</span> port) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†æœåŠ¡å™¨ç»‘å®šåˆ°æŒ‡å®šç«¯å£</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> ServerSocket socket = <span style="color:#fff;font-weight:bold">new</span> ServerSocket(port);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span>(;;) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//æ¥å—è¿æ¥</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">final</span> Socket clientSocket = socket.<span style="color:#007f7f">accept</span>();
</span></span><span style="display:flex;"><span>                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Accepted connection from &#34;</span> + clientSocket);
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥å¤„ç†è¯¥è¿æ¥</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> Thread(<span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>                        OutputStream out;
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//å°†æ¶ˆæ¯å†™ç»™å·²è¿æ¥çš„å®¢æˆ·ç«¯</span>
</span></span><span style="display:flex;"><span>                            out = clientSocket.<span style="color:#007f7f">getOutputStream</span>();
</span></span><span style="display:flex;"><span>                            out.<span style="color:#007f7f">write</span>(<span style="color:#0ff;font-weight:bold">&#34;Hi!\r\n&#34;</span>.<span style="color:#007f7f">getBytes</span>(Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>)));
</span></span><span style="display:flex;"><span>                            out.<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//å…³é—­è¿æ¥</span>
</span></span><span style="display:flex;"><span>                            clientSocket.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>                            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                                clientSocket.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                            } <span style="color:#fff;font-weight:bold">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>                                <span style="color:#007f7f">// ignore on close</span>
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å¯åŠ¨çº¿ç¨‹</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }).<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ®µä»£ç å®Œå…¨å¯ä»¥å¤„ç†ä¸­ç­‰æ•°é‡çš„å¹¶å‘å®¢æˆ·ç«¯ã€‚ä½†æ˜¯éšç€åº”ç”¨ç¨‹åºå˜å¾—æµè¡Œèµ·æ¥ï¼Œä½ ä¼šå‘ç°å®ƒå¹¶ä¸èƒ½å¾ˆå¥½åœ°ä¼¸ç¼©åˆ°æ”¯æ’‘æˆåƒä¸Šä¸‡çš„å¹¶å‘è¿å…¥è¿æ¥ã€‚ä½ å†³å®šæ”¹ç”¨å¼‚æ­¥ç½‘ç»œç¼–ç¨‹ï¼Œä½†æ˜¯å¾ˆå¿«å°±å‘ç°å¼‚æ­¥ API æ˜¯å®Œå…¨ä¸åŒçš„ï¼Œä»¥è‡³äºç°åœ¨ä½ ä¸å¾—ä¸é‡å†™ä½ çš„åº”ç”¨ç¨‹åºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 4-2 æœªä½¿ç”¨ Netty çš„å¼‚æ­¥ç½‘ç»œç¼–ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PlainNioServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> server(<span style="color:#fff;font-weight:bold">int</span> port) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        ServerSocketChannel serverChannel = ServerSocketChannel.<span style="color:#007f7f">open</span>();
</span></span><span style="display:flex;"><span>        serverChannel.<span style="color:#007f7f">configureBlocking</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        ServerSocket ss = serverChannel.<span style="color:#007f7f">socket</span>();
</span></span><span style="display:flex;"><span>        InetSocketAddress address = <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†æœåŠ¡å™¨ç»‘å®šåˆ°é€‰å®šçš„ç«¯å£</span>
</span></span><span style="display:flex;"><span>        ss.<span style="color:#007f7f">bind</span>(address);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ‰“å¼€Selectoræ¥å¤„ç† Channel</span>
</span></span><span style="display:flex;"><span>        Selector selector = Selector.<span style="color:#007f7f">open</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†ServerSocketChannelæ³¨å†Œåˆ°Selectorä»¥æ¥å—è¿æ¥</span>
</span></span><span style="display:flex;"><span>        serverChannel.<span style="color:#007f7f">register</span>(selector, SelectionKey.<span style="color:#007f7f">OP_ACCEPT</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> ByteBuffer msg = ByteBuffer.<span style="color:#007f7f">wrap</span>(<span style="color:#0ff;font-weight:bold">&#34;Hi!\r\n&#34;</span>.<span style="color:#007f7f">getBytes</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (;;){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//ç­‰å¾…éœ€è¦å¤„ç†çš„æ–°äº‹ä»¶ï¼›é˜»å¡å°†ä¸€ç›´æŒç»­åˆ°ä¸‹ä¸€ä¸ªä¼ å…¥äº‹ä»¶</span>
</span></span><span style="display:flex;"><span>                selector.<span style="color:#007f7f">select</span>();
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>                ex.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//handle exception</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è·å–æ‰€æœ‰æ¥æ”¶äº‹ä»¶çš„SelectionKeyå®ä¾‹</span>
</span></span><span style="display:flex;"><span>            Set&lt;SelectionKey&gt; readyKeys = selector.<span style="color:#007f7f">selectedKeys</span>();
</span></span><span style="display:flex;"><span>            Iterator&lt;SelectionKey&gt; iterator = readyKeys.<span style="color:#007f7f">iterator</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">while</span> (iterator.<span style="color:#007f7f">hasNext</span>()) {
</span></span><span style="display:flex;"><span>                SelectionKey key = iterator.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>                iterator.<span style="color:#007f7f">remove</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//æ£€æŸ¥äº‹ä»¶æ˜¯å¦æ˜¯ä¸€ä¸ªæ–°çš„å·²ç»å°±ç»ªå¯ä»¥è¢«æ¥å—çš„è¿æ¥</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (key.<span style="color:#007f7f">isAcceptable</span>()) {
</span></span><span style="display:flex;"><span>                        ServerSocketChannel server = (ServerSocketChannel) key.<span style="color:#007f7f">channel</span>();
</span></span><span style="display:flex;"><span>                        SocketChannel client = server.<span style="color:#007f7f">accept</span>();
</span></span><span style="display:flex;"><span>                        client.<span style="color:#007f7f">configureBlocking</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//æ¥å—å®¢æˆ·ç«¯ï¼Œå¹¶å°†å®ƒæ³¨å†Œåˆ°é€‰æ‹©å™¨</span>
</span></span><span style="display:flex;"><span>                        client.<span style="color:#007f7f">register</span>(selector, SelectionKey.<span style="color:#007f7f">OP_WRITE</span> | SelectionKey.<span style="color:#007f7f">OP_READ</span>, msg.<span style="color:#007f7f">duplicate</span>());
</span></span><span style="display:flex;"><span>                        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Accepted connection from &#34;</span> + client);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//æ£€æŸ¥å¥—æ¥å­—æ˜¯å¦å·²ç»å‡†å¤‡å¥½å†™æ•°æ®</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (key.<span style="color:#007f7f">isWritable</span>()) {
</span></span><span style="display:flex;"><span>                        SocketChannel client = (SocketChannel) key.<span style="color:#007f7f">channel</span>();
</span></span><span style="display:flex;"><span>                        ByteBuffer buffer = (ByteBuffer) key.<span style="color:#007f7f">attachment</span>();
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">while</span> (buffer.<span style="color:#007f7f">hasRemaining</span>()) {
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//å°†æ•°æ®å†™åˆ°å·²è¿æ¥çš„å®¢æˆ·ç«¯</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">if</span> (client.<span style="color:#007f7f">write</span>(buffer) == 0) {
</span></span><span style="display:flex;"><span>                                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//å…³é—­è¿æ¥</span>
</span></span><span style="display:flex;"><span>                        client.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>                    key.<span style="color:#007f7f">cancel</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                        key.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                    } <span style="color:#fff;font-weight:bold">catch</span> (IOException cex) {
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// ignore on close</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚åŒä½ æ‰€çœ‹åˆ°çš„ï¼Œè™½ç„¶è¿™æ®µä»£ç æ‰€åšçš„äº‹æƒ…ä¸ä¹‹å‰çš„ç‰ˆæœ¬å®Œå…¨ç›¸åŒï¼Œä½†æ˜¯ä»£ç å´æˆªç„¶ä¸åŒã€‚å¦‚æœä¸ºäº†ç”¨äºéé˜»å¡ I/O è€Œé‡æ–°å®ç°è¿™ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œéƒ½éœ€è¦ä¸€æ¬¡å®Œå…¨çš„é‡å†™çš„è¯ï¼Œé‚£ä¹ˆä¸éš¾æƒ³è±¡ï¼Œç§»æ¤çœŸæ­£å¤æ‚çš„åº”ç”¨ç¨‹åºéœ€è¦ä»˜å‡ºä»€ä¹ˆæ ·çš„åŠªåŠ›ã€‚é‰´äºæ­¤ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ä½¿ç”¨ Netty å®ç°è¯¥åº”ç”¨ç¨‹åºå°†ä¼šæ˜¯ä»€ä¹ˆæ ·å­å§ã€‚</p>
<h3 id="é€šè¿‡-netty-ä½¿ç”¨-oio-å’Œ-nio">é€šè¿‡ Netty ä½¿ç”¨ OIO å’Œ NIO<a hidden class="anchor" aria-hidden="true" href="#é€šè¿‡-netty-ä½¿ç”¨-oio-å’Œ-nio">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 4-3 ä½¿ç”¨ Netty çš„é˜»å¡ç½‘ç»œç¼–ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> NettyOioServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> server(<span style="color:#fff;font-weight:bold">int</span> port) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> ByteBuf buf = Unpooled.<span style="color:#007f7f">unreleasableBuffer</span>(Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Hi!\r\n&#34;</span>, Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>)));
</span></span><span style="display:flex;"><span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> OioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//åˆ›å»º ServerBootstrap</span>
</span></span><span style="display:flex;"><span>            ServerBootstrap b = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>            b.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//ä½¿ç”¨ OioEventLoopGroupä»¥å…è®¸é˜»å¡æ¨¡å¼ï¼ˆæ—§çš„I/Oï¼‰</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">channel</span>(OioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">localAddress</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port))
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//æŒ‡å®š ChannelInitializerï¼Œå¯¹äºæ¯ä¸ªå·²æ¥å—çš„è¿æ¥éƒ½è°ƒç”¨å®ƒ</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">childHandler</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelInitializer&lt;SocketChannel&gt;() {
</span></span><span style="display:flex;"><span>                        @Override
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(SocketChannel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                                ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>                                    <span style="color:#007f7f">//æ·»åŠ ä¸€ä¸ª ChannelInboundHandlerAdapterä»¥æ‹¦æˆªå’Œå¤„ç†äº‹ä»¶</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#fff;font-weight:bold">new</span> ChannelInboundHandlerAdapter() {
</span></span><span style="display:flex;"><span>                                        @Override
</span></span><span style="display:flex;"><span>                                        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(ChannelHandlerContext ctx) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                                            ctx.<span style="color:#007f7f">writeAndFlush</span>(buf.<span style="color:#007f7f">duplicate</span>())
</span></span><span style="display:flex;"><span>                                                    .<span style="color:#007f7f">addListener</span>(
</span></span><span style="display:flex;"><span>                                                            <span style="color:#007f7f">//å°†æ¶ˆæ¯å†™åˆ°å®¢æˆ·ç«¯ï¼Œå¹¶æ·»åŠ  ChannelFutureListenerï¼Œ</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#007f7f">//ä»¥ä¾¿æ¶ˆæ¯ä¸€è¢«å†™å®Œå°±å…³é—­è¿æ¥</span>
</span></span><span style="display:flex;"><span>                                                            ChannelFutureListener.<span style="color:#007f7f">CLOSE</span>);
</span></span><span style="display:flex;"><span>                                        }
</span></span><span style="display:flex;"><span>                                    });
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    });
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ç»‘å®šæœåŠ¡å™¨ä»¥æ¥å—è¿æ¥</span>
</span></span><span style="display:flex;"><span>            ChannelFuture f = b.<span style="color:#007f7f">bind</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>            f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//é‡Šæ”¾æ‰€æœ‰çš„èµ„æº</span>
</span></span><span style="display:flex;"><span>            group.<span style="color:#007f7f">shutdownGracefully</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="éé˜»å¡çš„-netty-ç‰ˆæœ¬">éé˜»å¡çš„ Netty ç‰ˆæœ¬<a hidden class="anchor" aria-hidden="true" href="#éé˜»å¡çš„-netty-ç‰ˆæœ¬">#</a></h3>
<p>ä»£ç æ¸…å• 4-4 å’Œä»£ç æ¸…å• 4-3 å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œé™¤äº†é«˜äº®æ˜¾ç¤ºçš„é‚£ä¸¤è¡Œã€‚è¿™å°±æ˜¯ä»é˜»å¡ï¼ˆOIOï¼‰ä¼ è¾“åˆ‡æ¢åˆ°éé˜»å¡ï¼ˆNIOï¼‰ä¼ è¾“éœ€è¦åšçš„æ‰€æœ‰å˜æ›´ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 4-4 ä½¿ç”¨ Netty çš„å¼‚æ­¥ç½‘ç»œå¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> NettyNioServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> server(<span style="color:#fff;font-weight:bold">int</span> port) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> ByteBuf buf = Unpooled.<span style="color:#007f7f">unreleasableBuffer</span>(Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Hi!\r\n&#34;</span>, Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>)));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä¸ºéé˜»å¡æ¨¡å¼ä½¿ç”¨NioEventLoopGroup</span>
</span></span><span style="display:flex;"><span>        NioEventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//åˆ›å»ºServerBootstrap</span>
</span></span><span style="display:flex;"><span>            ServerBootstrap b = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>            b.<span style="color:#007f7f">group</span>(group).<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">localAddress</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port))
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//æŒ‡å®š ChannelInitializerï¼Œå¯¹äºæ¯ä¸ªå·²æ¥å—çš„è¿æ¥éƒ½è°ƒç”¨å®ƒ</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">childHandler</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelInitializer&lt;SocketChannel&gt;() {
</span></span><span style="display:flex;"><span>                                      @Override
</span></span><span style="display:flex;"><span>                                      <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(SocketChannel ch)
</span></span><span style="display:flex;"><span>                                              <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                                              ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>                                                 <span style="color:#007f7f">//æ·»åŠ  ChannelInboundHandlerAdapterä»¥æ¥æ”¶å’Œå¤„ç†äº‹ä»¶</span>
</span></span><span style="display:flex;"><span>                                                  <span style="color:#fff;font-weight:bold">new</span> ChannelInboundHandlerAdapter() {
</span></span><span style="display:flex;"><span>                                                      @Override
</span></span><span style="display:flex;"><span>                                                      <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(
</span></span><span style="display:flex;"><span>                                                              <span style="color:#007f7f">//å°†æ¶ˆæ¯å†™åˆ°å®¢æˆ·ç«¯ï¼Œå¹¶æ·»åŠ ChannelFutureListenerï¼Œ</span>
</span></span><span style="display:flex;"><span>                                                              <span style="color:#007f7f">//ä»¥ä¾¿æ¶ˆæ¯ä¸€è¢«å†™å®Œå°±å…³é—­è¿æ¥</span>
</span></span><span style="display:flex;"><span>                                                              ChannelHandlerContext ctx) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                                                                ctx.<span style="color:#007f7f">writeAndFlush</span>(buf.<span style="color:#007f7f">duplicate</span>())
</span></span><span style="display:flex;"><span>                                                                  .<span style="color:#007f7f">addListener</span>(
</span></span><span style="display:flex;"><span>                                                                          ChannelFutureListener.<span style="color:#007f7f">CLOSE</span>);
</span></span><span style="display:flex;"><span>                                                      }
</span></span><span style="display:flex;"><span>                                                  });
</span></span><span style="display:flex;"><span>                                      }
</span></span><span style="display:flex;"><span>                                  }
</span></span><span style="display:flex;"><span>                    );
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ç»‘å®šæœåŠ¡å™¨ä»¥æ¥å—è¿æ¥</span>
</span></span><span style="display:flex;"><span>            ChannelFuture f = b.<span style="color:#007f7f">bind</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>            f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//é‡Šæ”¾æ‰€æœ‰çš„èµ„æº</span>
</span></span><span style="display:flex;"><span>            group.<span style="color:#007f7f">shutdownGracefully</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸º Netty ä¸ºæ¯ç§ä¼ è¾“çš„å®ç°éƒ½æš´éœ²äº†ç›¸åŒçš„ APIï¼Œæ‰€ä»¥æ— è®ºé€‰ç”¨å“ªä¸€ç§ä¼ è¾“çš„å®ç°ï¼Œä½ çš„ä»£ç éƒ½ä»ç„¶å‡ ä¹ä¸å—å½±å“ã€‚åœ¨æ‰€æœ‰çš„æƒ…å†µä¸‹ï¼Œä¼ è¾“çš„å®ç°éƒ½ä¾èµ–äº interface Channelã€ChannelPipeline å’Œ ChannelHandlerã€‚åœ¨çœ‹è¿‡ä¸€äº›ä½¿ç”¨åŸºäº Netty çš„ä¼ è¾“çš„è¿™äº›ä¼˜ç‚¹ä¹‹åï¼Œè®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ä¼ è¾“ API æœ¬èº«ã€‚</p>
<h2 id="ä¼ è¾“api">ä¼ è¾“API<a hidden class="anchor" aria-hidden="true" href="#ä¼ è¾“api">#</a></h2>
<p>ä¼ è¾“ API çš„æ ¸å¿ƒæ˜¯ interface Channelï¼Œå®ƒè¢«ç”¨äºæ‰€æœ‰çš„ I/O æ“ä½œã€‚Channel ç±»çš„å±‚æ¬¡ç»“æ„å¦‚å›¾ 4-1 æ‰€ç¤ºã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/32.png">
å¦‚å›¾æ‰€ç¤ºï¼Œæ¯ä¸ª Channel éƒ½å°†ä¼šè¢«åˆ†é…ä¸€ä¸ª ChannelPipeline å’Œ ChannelConfigã€‚ChannelConfig åŒ…å«äº†è¯¥ Channel çš„æ‰€æœ‰é…ç½®è®¾ç½®ï¼Œå¹¶ä¸”æ”¯æŒçƒ­æ›´æ–°ã€‚ç”±äºç‰¹å®šçš„ä¼ è¾“å¯èƒ½å…·æœ‰ç‹¬ç‰¹çš„è®¾ç½®ï¼Œæ‰€ä»¥å®ƒå¯èƒ½ä¼šå®ç°ä¸€ä¸ª ChannelConfig çš„å­ç±»å‹ã€‚ï¼ˆè¯·å‚è€ƒ ChannelConfigå®ç°å¯¹åº”çš„ Javadocã€‚ï¼‰
ç”±äº Channel æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯é¡ºåºå°† Channel å£°æ˜ä¸º java.lang.Comparable çš„ä¸€ä¸ªå­æ¥å£ã€‚å› æ­¤ï¼Œå¦‚æœä¸¤ä¸ªä¸åŒçš„ Channel å®ä¾‹éƒ½è¿”å›äº†ç›¸åŒçš„æ•£åˆ—ç ï¼Œé‚£ä¹ˆ AbstractChannel ä¸­çš„ compareTo()æ–¹æ³•çš„å®ç°å°†ä¼šæŠ›å‡ºä¸€ä¸ª Errorã€‚</p>
<p>ChannelPipeline æŒæœ‰æ‰€æœ‰å°†åº”ç”¨äºå…¥ç«™å’Œå‡ºç«™æ•°æ®ä»¥åŠäº‹ä»¶çš„ ChannelHandler å®ä¾‹ï¼Œè¿™äº›
ChannelHandler å®ç°äº†åº”ç”¨ç¨‹åºç”¨äºå¤„ç†çŠ¶æ€å˜åŒ–ä»¥åŠæ•°æ®å¤„ç†çš„é€»è¾‘ã€‚</p>
<p>ChannelHandler çš„å…¸å‹ç”¨é€”åŒ…æ‹¬ï¼š</p>
<ul>
<li>å°†æ•°æ®ä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼ï¼›</li>
<li>æä¾›å¼‚å¸¸çš„é€šçŸ¥ï¼›</li>
<li>æä¾› Channel å˜ä¸ºæ´»åŠ¨çš„æˆ–è€…éæ´»åŠ¨çš„é€šçŸ¥ï¼›</li>
<li>æä¾›å½“ Channel æ³¨å†Œåˆ° EventLoop æˆ–è€…ä» EventLoop æ³¨é”€æ—¶çš„é€šçŸ¥ï¼›</li>
<li>æä¾›æœ‰å…³ç”¨æˆ·è‡ªå®šä¹‰äº‹ä»¶çš„é€šçŸ¥ã€‚</li>
</ul>
<p>ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦é€šè¿‡æ·»åŠ æˆ–è€…ç§»é™¤ChannelHandlerå®ä¾‹æ¥ä¿®æ”¹ChannelPipelineã€‚</p>
<p>é€šè¿‡åˆ©ç”¨Nettyçš„è¿™é¡¹èƒ½åŠ›å¯ä»¥æ„å»ºå‡ºé«˜åº¦çµæ´»çš„åº”ç”¨ç¨‹åºã€‚ä¾‹å¦‚ï¼Œæ¯å½“STARTTLSâ‘ åè®®è¢«è¯·æ±‚æ—¶ï¼Œä½ å¯ä»¥ç®€å•åœ°é€šè¿‡ å‘ ChannelPipeline æ·» åŠ  ä¸€ä¸ªé€‚å½“çš„ ChannelHandlerï¼ˆSslHandlerï¼‰æ¥æŒ‰éœ€åœ°æ”¯æŒSTARTTLSåè®®ã€‚é™¤äº†è®¿é—®æ‰€åˆ†é…çš„ ChannelPipeline å’Œ ChannelConfig ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ Channelçš„å…¶ä»–æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>eventLoop</td>
<td>è¿”å›åˆ†é…ç»™ Channel çš„ EventLoop</td>
</tr>
<tr>
<td>pipeline</td>
<td>è¿”å›åˆ†é…ç»™ Channel çš„ ChannelPipeline</td>
</tr>
<tr>
<td>isActive</td>
<td>å¦‚æœ Channel æ˜¯æ´»åŠ¨çš„ï¼Œåˆ™è¿”å› trueã€‚æ´»åŠ¨çš„æ„ä¹‰å¯èƒ½ä¾èµ–äºåº•å±‚çš„ä¼ è¾“ã€‚ä¾‹å¦‚ï¼Œ ä¸€ä¸ª Socket ä¼ è¾“ä¸€æ—¦è¿æ¥åˆ°äº†è¿œç¨‹èŠ‚ç‚¹ä¾¿æ˜¯æ´»åŠ¨çš„ï¼Œè€Œä¸€ä¸ª Datagram ä¼ è¾“ä¸€æ—¦è¢«æ‰“å¼€ä¾¿æ˜¯æ´»åŠ¨çš„</td>
</tr>
<tr>
<td>localAddress</td>
<td>è¿”å›æœ¬åœ°çš„ SokcetAddress</td>
</tr>
<tr>
<td>remoteAddress</td>
<td>è¿”å›è¿œç¨‹çš„ SocketAddress</td>
</tr>
<tr>
<td>write</td>
<td>å°†æ•°æ®å†™åˆ°è¿œç¨‹èŠ‚ç‚¹ã€‚è¿™ä¸ªæ•°æ®å°†è¢«ä¼ é€’ç»™ ChannelPipelineï¼Œå¹¶ä¸”æ’é˜Ÿç›´åˆ°å®ƒè¢«å†²åˆ·</td>
</tr>
<tr>
<td>flush</td>
<td>å°†ä¹‹å‰å·²å†™çš„æ•°æ®å†²åˆ·åˆ°åº•å±‚ä¼ è¾“ï¼Œå¦‚ä¸€ä¸ª Socket</td>
</tr>
<tr>
<td>writeAndFlush</td>
<td>ä¸€ä¸ªç®€ä¾¿çš„æ–¹æ³•ï¼Œç­‰åŒäºè°ƒç”¨ write()å¹¶æ¥ç€è°ƒç”¨ flush()</td>
</tr>
</tbody>
</table>
<p>ç¨åæˆ‘ä»¬å°†è¿›ä¸€æ­¥æ·±å…¥åœ°è®¨è®ºæ‰€æœ‰è¿™äº›ç‰¹æ€§çš„åº”ç”¨ã€‚ç›®å‰ï¼Œè¯·è®°ä½ï¼ŒNetty æ‰€æä¾›çš„å¹¿æ³›åŠŸèƒ½åªä¾èµ–äºå°‘é‡çš„æ¥å£ã€‚è¿™æ„å‘³ç€ï¼Œä½ å¯ä»¥å¯¹ä½ çš„åº”ç”¨ç¨‹åºé€»è¾‘è¿›è¡Œé‡å¤§çš„ä¿®æ”¹ï¼Œè€Œåˆæ— éœ€å¤§è§„æ¨¡åœ°é‡æ„ä½ çš„ä»£ç åº“ã€‚</p>
<p>è€ƒè™‘ä¸€ä¸‹å†™æ•°æ®å¹¶å°†å…¶å†²åˆ·åˆ°è¿œç¨‹èŠ‚ç‚¹è¿™æ ·çš„å¸¸è§„ä»»åŠ¡ã€‚ä»£ç æ¸…å• 4-5 æ¼”ç¤ºäº†ä½¿ç”¨Channel.writeAndFlush()æ¥å®ç°è¿™ä¸€ç›®çš„ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 4-5 å†™å‡ºåˆ° Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 4-6 ä»å¤šä¸ªçº¿ç¨‹ä½¿ç”¨åŒä¸€ä¸ª Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ChannelOperationExamples {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> Channel CHANNEL_FROM_SOMEWHERE = <span style="color:#fff;font-weight:bold">new</span> NioSocketChannel();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 4-5 å†™å‡ºåˆ° Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> writingToChannel() {
</span></span><span style="display:flex;"><span>        Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// Get the channel reference from somewhere</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºæŒæœ‰è¦å†™æ•°æ®çš„ ByteBuf</span>
</span></span><span style="display:flex;"><span>        ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;your data&#34;</span>, CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        ChannelFuture cf = channel.<span style="color:#007f7f">writeAndFlush</span>(buf);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  ChannelFutureListener ä»¥ä¾¿åœ¨å†™æ“ä½œå®Œæˆåæ¥æ”¶é€šçŸ¥</span>
</span></span><span style="display:flex;"><span>        cf.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture future) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å†™æ“ä½œå®Œæˆï¼Œå¹¶ä¸”æ²¡æœ‰é”™è¯¯å‘ç”Ÿ</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (future.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Write successful&#34;</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//è®°å½•é”™è¯¯</span>
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Write error&#34;</span>);
</span></span><span style="display:flex;"><span>                    future.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 4-6 ä»å¤šä¸ªçº¿ç¨‹ä½¿ç”¨åŒä¸€ä¸ª Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> writingToChannelFromManyThreads() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// Get the channel reference from somewhere</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºæŒæœ‰è¦å†™æ•°æ®çš„ByteBuf</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;your data&#34;</span>,
</span></span><span style="display:flex;"><span>                CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºå°†æ•°æ®å†™åˆ°Channel çš„ Runnable</span>
</span></span><span style="display:flex;"><span>        Runnable writer = <span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>                channel.<span style="color:#007f7f">write</span>(buf.<span style="color:#007f7f">duplicate</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è·å–åˆ°çº¿ç¨‹æ± Executor çš„å¼•ç”¨</span>
</span></span><span style="display:flex;"><span>        Executor executor = Executors.<span style="color:#007f7f">newCachedThreadPool</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//é€’äº¤å†™ä»»åŠ¡ç»™çº¿ç¨‹æ± ä»¥ä¾¿åœ¨æŸä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// write in one thread</span>
</span></span><span style="display:flex;"><span>        executor.<span style="color:#007f7f">execute</span>(writer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//é€’äº¤å¦ä¸€ä¸ªå†™ä»»åŠ¡ä»¥ä¾¿åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// write in another thread</span>
</span></span><span style="display:flex;"><span>        executor.<span style="color:#007f7f">execute</span>(writer);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty çš„ Channel å®ç°æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› æ­¤ä½ å¯ä»¥å­˜å‚¨ä¸€ä¸ªåˆ° Channel çš„å¼•ç”¨ï¼Œå¹¶ä¸”æ¯å½“ä½ éœ€è¦å‘è¿œç¨‹èŠ‚ç‚¹å†™æ•°æ®æ—¶ï¼Œéƒ½å¯ä»¥ä½¿ç”¨å®ƒï¼Œå³ä½¿å½“æ—¶è®¸å¤šçº¿ç¨‹éƒ½åœ¨ä½¿ç”¨å®ƒã€‚ä»£ç æ¸…å• 4-6 ï¼ˆä¸Šè¾¹ï¼‰å±•ç¤ºäº†ä¸€ä¸ªå¤šçº¿ç¨‹å†™æ•°æ®çš„ç®€å•ä¾‹å­ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¶ˆæ¯å°†ä¼šè¢«ä¿è¯æŒ‰é¡ºåºå‘é€ã€‚</p>
<h2 id="å†…ç½®çš„ä¼ è¾“">å†…ç½®çš„ä¼ è¾“<a hidden class="anchor" aria-hidden="true" href="#å†…ç½®çš„ä¼ è¾“">#</a></h2>
<p>Netty å†…ç½®äº†ä¸€äº›å¯å¼€ç®±å³ç”¨çš„ä¼ è¾“ã€‚å› ä¸ºå¹¶ä¸æ˜¯å®ƒä»¬æ‰€æœ‰çš„ä¼ è¾“éƒ½æ”¯æŒæ¯ä¸€ç§åè®®ï¼Œæ‰€ä»¥ä½ å¿…é¡»é€‰æ‹©ä¸€ä¸ªå’Œä½ çš„åº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„åè®®ç›¸å®¹çš„ä¼ è¾“ã€‚åœ¨æœ¬èŠ‚ä¸­æˆ‘ä»¬å°†è®¨è®ºè¿™äº›å…³ç³»ã€‚</p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>åŒ…</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>NIO</td>
<td>io.netty.channel.socket.nio</td>
<td>ä½¿ç”¨ java.nio.channels åŒ…ä½œä¸ºåŸºç¡€â€”â€”åŸºäº é€‰æ‹©å™¨çš„æ–¹å¼</td>
</tr>
<tr>
<td>Epoll</td>
<td>io.netty.channel.epoll</td>
<td>ç”± JNI é©±åŠ¨çš„ epoll()å’Œéé˜»å¡ IOã€‚è¿™ä¸ªä¼ è¾“æ”¯æŒ åªæœ‰åœ¨Linuxä¸Šå¯ç”¨çš„å¤šç§ç‰¹æ€§ï¼Œå¦‚SO_REUSEPORTï¼Œ æ¯” NIO ä¼ è¾“æ›´å¿«ï¼Œè€Œä¸”æ˜¯å®Œå…¨éé˜»å¡çš„</td>
</tr>
<tr>
<td>OIO</td>
<td>io.netty.channel.socket.oio</td>
<td>ä½¿ç”¨ java.net åŒ…ä½œä¸ºåŸºç¡€â€”â€”ä½¿ç”¨é˜»å¡æµ</td>
</tr>
<tr>
<td>Local</td>
<td>io.netty.channel.local</td>
<td>å¯ä»¥åœ¨ VM å†…éƒ¨é€šè¿‡ç®¡é“è¿›è¡Œé€šä¿¡çš„æœ¬åœ°ä¼ è¾“</td>
</tr>
<tr>
<td>Embedded</td>
<td>io.netty.channel.embedded</td>
<td>Embedded ä¼ è¾“ï¼Œå…è®¸ä½¿ç”¨ ChannelHandler è€Œåˆ ä¸éœ€è¦ä¸€ä¸ªçœŸæ­£çš„åŸºäºç½‘ç»œçš„ä¼ è¾“ã€‚è¿™åœ¨æµ‹è¯•ä½ çš„ ChannelHandler å®ç°æ—¶éå¸¸æœ‰ç”¨</td>
</tr>
</tbody>
</table>
<h3 id="nioéé˜»å¡-io">NIOâ€”â€”éé˜»å¡ I/O<a hidden class="anchor" aria-hidden="true" href="#nioéé˜»å¡-io">#</a></h3>
<p>NIO æä¾›äº†ä¸€ä¸ªæ‰€æœ‰ I/O æ“ä½œçš„å…¨å¼‚æ­¥çš„å®ç°ã€‚å®ƒåˆ©ç”¨äº†è‡ª NIO å­ç³»ç»Ÿè¢«å¼•å…¥ JDK 1.4 æ—¶ä¾¿å¯ç”¨çš„åŸºäºé€‰æ‹©å™¨çš„ APIã€‚é€‰æ‹©å™¨èƒŒåçš„åŸºæœ¬æ¦‚å¿µæ˜¯å……å½“ä¸€ä¸ªæ³¨å†Œè¡¨ï¼Œåœ¨é‚£é‡Œä½ å°†å¯ä»¥è¯·æ±‚åœ¨ Channel çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å¾—åˆ°é€šçŸ¥ã€‚å¯èƒ½çš„çŠ¶æ€å˜åŒ–æœ‰ï¼š</p>
<ul>
<li>æ–°çš„ Channel å·²è¢«æ¥å—å¹¶ä¸”å°±ç»ªï¼›</li>
<li>Channel è¿æ¥å·²ç»å®Œæˆï¼›</li>
<li>Channel æœ‰å·²ç»å°±ç»ªçš„å¯ä¾›è¯»å–çš„æ•°æ®ï¼›</li>
<li>Channel å¯ç”¨äºå†™æ•°æ®ã€‚</li>
</ul>
<p>é€‰æ‹©å™¨è¿è¡Œåœ¨ä¸€ä¸ªæ£€æŸ¥çŠ¶æ€å˜åŒ–å¹¶å¯¹å…¶åšå‡ºç›¸åº”å“åº”çš„çº¿ç¨‹ä¸Šï¼Œåœ¨åº”ç”¨ç¨‹åºå¯¹çŠ¶æ€çš„æ”¹å˜åšå‡ºå“åº”ä¹‹åï¼Œé€‰æ‹©å™¨å°†ä¼šè¢«é‡ç½®ï¼Œå¹¶å°†é‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚è¡¨4-3ä¸­çš„å¸¸é‡å€¼ä»£è¡¨äº†ç”±class java.nio.channels.SelectionKeyå®šä¹‰çš„ä½æ¨¡å¼ã€‚è¿™äº›ä½æ¨¡å¼å¯ä»¥ç»„åˆèµ·æ¥å®šä¹‰ä¸€ç»„åº”ç”¨ç¨‹åºæ­£åœ¨è¯·æ±‚é€šçŸ¥çš„çŠ¶æ€å˜åŒ–é›†ã€‚</p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>OP_ACCEPT</td>
<td>è¯·æ±‚åœ¨æ¥å—æ–°è¿æ¥å¹¶åˆ›å»º Channel æ—¶è·å¾—é€šçŸ¥</td>
</tr>
<tr>
<td>OP_CONNECT</td>
<td>è¯·æ±‚åœ¨å»ºç«‹ä¸€ä¸ªè¿æ¥æ—¶è·å¾—é€šçŸ¥</td>
</tr>
<tr>
<td>OP_READ</td>
<td>è¯·æ±‚å½“æ•°æ®å·²ç»å°±ç»ªï¼Œå¯ä»¥ä» Channel ä¸­è¯»å–æ—¶è·å¾—é€šçŸ¥</td>
</tr>
<tr>
<td>OP_WRITE</td>
<td>è¯·æ±‚å½“å¯ä»¥å‘ Channel ä¸­å†™æ›´å¤šçš„æ•°æ®æ—¶è·å¾—é€šçŸ¥ã€‚è¿™å¤„ç†äº†å¥—æ¥å­—ç¼“å†²åŒºè¢«å®Œ å…¨å¡«æ»¡æ—¶çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µé€šå¸¸å‘ç”Ÿåœ¨æ•°æ®çš„å‘é€é€Ÿåº¦æ¯”è¿œç¨‹èŠ‚ç‚¹å¯å¤„ç†çš„é€Ÿåº¦æ›´ å¿«çš„æ—¶å€™</td>
</tr>
</tbody>
</table>
<p>å¯¹äºæ‰€æœ‰ Netty çš„ä¼ è¾“å®ç°éƒ½å…±æœ‰çš„ç”¨æˆ·çº§åˆ« API å®Œå…¨åœ°éšè—äº†è¿™äº› NIO çš„å†…éƒ¨ç»†èŠ‚ã€‚å›¾ 4-2 å±•ç¤ºäº†è¯¥å¤„ç†æµç¨‹ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/33.png"></p>
<p>é›¶æ‹·è´ï¼ˆzero-copyï¼‰æ˜¯ä¸€ç§ç›®å‰åªæœ‰åœ¨ä½¿ç”¨ NIO å’Œ Epoll ä¼ è¾“æ—¶æ‰å¯ä½¿ç”¨çš„ç‰¹æ€§ã€‚å®ƒä½¿ä½ å¯ä»¥å¿«é€Ÿé«˜æ•ˆåœ°å°†æ•°æ®ä»æ–‡ä»¶ç³»ç»Ÿç§»åŠ¨åˆ°ç½‘ç»œæ¥å£ï¼Œè€Œä¸éœ€è¦å°†å…¶ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå…¶åœ¨åƒ FTP æˆ–è€…HTTP è¿™æ ·çš„åè®®ä¸­å¯ä»¥æ˜¾è‘—åœ°æå‡æ€§èƒ½ã€‚ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒè¿™ä¸€ç‰¹æ€§ã€‚ç‰¹åˆ«åœ°ï¼Œå®ƒå¯¹äºå®ç°äº†æ•°æ®åŠ å¯†æˆ–è€…å‹ç¼©çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸å¯ç”¨çš„â€”â€”åªèƒ½ä¼ è¾“æ–‡ä»¶çš„åŸå§‹å†…å®¹ã€‚åè¿‡æ¥è¯´ï¼Œä¼ è¾“å·²è¢«åŠ å¯†çš„æ–‡ä»¶åˆ™ä¸æ˜¯é—®é¢˜ã€‚</p>
<h3 id="epollç”¨äº-linux-çš„æœ¬åœ°éé˜»å¡ä¼ è¾“">Epollâ€”ç”¨äº Linux çš„æœ¬åœ°éé˜»å¡ä¼ è¾“<a hidden class="anchor" aria-hidden="true" href="#epollç”¨äº-linux-çš„æœ¬åœ°éé˜»å¡ä¼ è¾“">#</a></h3>
<p>æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„ï¼ŒNetty çš„ NIO ä¼ è¾“åŸºäº Java æä¾›çš„å¼‚æ­¥/éé˜»å¡ç½‘ç»œç¼–ç¨‹çš„é€šç”¨æŠ½è±¡ã€‚è™½ç„¶è¿™ä¿è¯äº†Netty çš„éé˜»å¡ API å¯ä»¥åœ¨ä»»ä½•å¹³å°ä¸Šä½¿ç”¨ï¼Œä½†å®ƒä¹ŸåŒ…å«äº†ç›¸åº”çš„é™åˆ¶ï¼Œå› ä¸º JDKä¸ºäº†åœ¨æ‰€æœ‰ç³»ç»Ÿä¸Šæä¾›ç›¸åŒçš„åŠŸèƒ½ï¼Œå¿…é¡»åšå‡ºå¦¥åã€‚Linuxä½œä¸ºé«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹çš„å¹³å°ï¼Œå…¶é‡è¦æ€§ä¸æ—¥ä¿±å¢ï¼Œè¿™å‚¬ç”Ÿäº†å¤§é‡å…ˆè¿›ç‰¹æ€§çš„å¼€å‘ï¼Œå…¶ä¸­åŒ…æ‹¬epollâ€”â€”ä¸€ä¸ªé«˜åº¦å¯æ‰©å±•çš„I/Oäº‹ä»¶é€šçŸ¥ç‰¹æ€§ã€‚è¿™ä¸ªAPIè‡ªLinuxå†…æ ¸ç‰ˆæœ¬ 2.5.44ï¼ˆ2002ï¼‰è¢«å¼•å…¥ï¼Œæä¾›äº†æ¯”æ—§çš„POSIX selectå’Œpollç³»ç»Ÿè°ƒç”¨æ›´å¥½çš„æ€§èƒ½ã€‚åŒæ—¶ç°åœ¨ä¹Ÿæ˜¯Linuxä¸Šéé˜»å¡ç½‘ç»œç¼–ç¨‹çš„äº‹å®æ ‡å‡†ã€‚Linux JDK NIO APIä½¿ç”¨äº†è¿™äº›epollè°ƒç”¨ã€‚
Nettyä¸ºLinuxæä¾›äº†ä¸€ç»„NIO APIï¼Œå…¶ä»¥ä¸€ç§å’Œå®ƒæœ¬èº«çš„è®¾è®¡æ›´åŠ ä¸€è‡´çš„æ–¹å¼ä½¿ç”¨epollï¼Œå¹¶ä¸”ä»¥ä¸€ç§æ›´åŠ è½»é‡çš„æ–¹å¼ä½¿ç”¨ä¸­æ–­ã€‚å¦‚æœä½ çš„åº”ç”¨ç¨‹åºæ—¨åœ¨è¿è¡ŒäºLinuxç³»ç»Ÿï¼Œé‚£ä¹ˆè¯·è€ƒè™‘åˆ©ç”¨è¿™ä¸ªç‰ˆæœ¬çš„ä¼ è¾“ï¼›ä½ å°†å‘ç°åœ¨é«˜è´Ÿè½½ä¸‹å®ƒçš„æ€§èƒ½è¦ä¼˜äºJDKçš„NIOå®ç°ã€‚</p>
<p>è¿™ä¸ªä¼ è¾“çš„è¯­ä¹‰ä¸åœ¨å›¾ 4-2 æ‰€ç¤ºçš„å®Œå…¨ç›¸åŒï¼Œè€Œä¸”å®ƒçš„ç”¨æ³•ä¹Ÿæ˜¯ç®€å•ç›´æ¥çš„ã€‚ç›¸å…³ç¤ºä¾‹å‚ç…§ä»£ç æ¸…å• 4-4ã€‚å¦‚æœè¦åœ¨é‚£ä¸ªä»£ç æ¸…å•ä¸­ä½¿ç”¨ epoll æ›¿ä»£ NIOï¼Œåªéœ€è¦å°† NioEventLoopGroupæ›¿æ¢ä¸º EpollEventLoopGroupï¼Œå¹¶ä¸”å°† NioServerSocketChannel.class æ›¿æ¢ä¸ºEpollServerSocketChannel.class å³å¯ã€‚</p>
<h3 id="oioæ—§çš„é˜»å¡-io">OIOâ€”æ—§çš„é˜»å¡ I/O<a hidden class="anchor" aria-hidden="true" href="#oioæ—§çš„é˜»å¡-io">#</a></h3>
<p>Netty çš„ OIO ä¼ è¾“å®ç°ä»£è¡¨äº†ä¸€ç§æŠ˜ä¸­ï¼šå®ƒå¯ä»¥é€šè¿‡å¸¸è§„çš„ä¼ è¾“ API ä½¿ç”¨ï¼Œä½†æ˜¯ç”±äºå®ƒæ˜¯å»ºç«‹åœ¨
java.net åŒ…çš„é˜»å¡å®ç°ä¹‹ä¸Šçš„ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯å¼‚æ­¥çš„ã€‚ä½†æ˜¯ï¼Œå®ƒä»ç„¶éå¸¸é€‚åˆäºæŸäº›ç”¨é€”ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½éœ€è¦ç§»æ¤ä½¿ç”¨äº†ä¸€äº›è¿›è¡Œé˜»å¡è°ƒç”¨çš„åº“ï¼ˆå¦‚JDBCï¼‰çš„é—ç•™ä»£ç ï¼Œè€Œå°†é€»è¾‘è½¬æ¢ä¸ºéé˜»å¡çš„å¯èƒ½ä¹Ÿæ˜¯ä¸åˆ‡å®é™…çš„ã€‚ç›¸åï¼Œä½ å¯ä»¥åœ¨çŸ­æœŸå†…ä½¿ç”¨Nettyçš„OIOä¼ è¾“ï¼Œç„¶åå†å°†ä½ çš„ä»£ç ç§»æ¤åˆ°çº¯ç²¹çš„å¼‚æ­¥ä¼ è¾“ä¸Šã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹æ€ä¹ˆåšã€‚</p>
<p>åœ¨ java.net API ä¸­ï¼Œä½ é€šå¸¸ä¼šæœ‰ä¸€ä¸ªç”¨æ¥æ¥å—åˆ°è¾¾æ­£åœ¨ç›‘å¬çš„ ServerSocket çš„æ–°è¿æ¥çš„çº¿ç¨‹ã€‚ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å’Œè¿œç¨‹èŠ‚ç‚¹è¿›è¡Œäº¤äº’çš„å¥—æ¥å­—ï¼Œå¹¶ä¸”ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„ç”¨äºå¤„ç†ç›¸åº”é€šä¿¡æµé‡çš„çº¿ç¨‹ã€‚è¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºæŸä¸ªæŒ‡å®šå¥—æ¥å­—ä¸Šçš„ä»»ä½• I/O æ“ä½œåœ¨ä»»æ„çš„æ—¶é—´ç‚¹ä¸Šéƒ½å¯èƒ½ä¼šé˜»å¡ã€‚ä½¿ç”¨å•ä¸ªçº¿ç¨‹æ¥å¤„ç†å¤šä¸ªå¥—æ¥å­—ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´ä¸€ä¸ªå¥—æ¥å­—ä¸Šçš„é˜»å¡æ“ä½œä¹Ÿæ†ç»‘äº†æ‰€æœ‰å…¶ä»–çš„å¥—æ¥å­—ã€‚</p>
<p>æœ‰äº†è¿™ä¸ªèƒŒæ™¯ï¼Œä½ å¯èƒ½ä¼šæƒ³ï¼ŒNettyæ˜¯å¦‚ä½•èƒ½å¤Ÿä½¿ç”¨å’Œç”¨äºå¼‚æ­¥ä¼ è¾“ç›¸åŒçš„APIæ¥æ”¯æŒOIOçš„å‘¢ã€‚ç­”æ¡ˆå°±æ˜¯ï¼ŒNettyåˆ©ç”¨äº†SO_TIMEOUTè¿™ä¸ªSocketæ ‡å¿—ï¼Œå®ƒæŒ‡å®šäº†ç­‰å¾…ä¸€ä¸ªI/Oæ“ä½œå®Œæˆçš„æœ€å¤§æ¯«ç§’æ•°ã€‚å¦‚æœæ“ä½œåœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…æ²¡æœ‰å®Œæˆï¼Œåˆ™å°†ä¼šæŠ›å‡ºä¸€ä¸ªSocketTimeout Exceptionã€‚Nettyå°†æ•è·è¿™ä¸ªå¼‚å¸¸å¹¶ç»§ç»­å¤„ç†å¾ªç¯ã€‚
åœ¨EventLoopä¸‹ä¸€æ¬¡è¿è¡Œæ—¶ï¼Œå®ƒå°†å†æ¬¡å°è¯•ã€‚è¿™å®é™…ä¸Šä¹Ÿæ˜¯ç±»ä¼¼äºNettyè¿™æ ·çš„å¼‚æ­¥æ¡†æ¶èƒ½å¤Ÿæ”¯æŒOIOçš„å”¯ä¸€æ–¹å¼ã€‚</p>
<h3 id="ç”¨äº-jvm-å†…éƒ¨é€šä¿¡çš„-local-ä¼ è¾“">ç”¨äº JVM å†…éƒ¨é€šä¿¡çš„ Local ä¼ è¾“<a hidden class="anchor" aria-hidden="true" href="#ç”¨äº-jvm-å†…éƒ¨é€šä¿¡çš„-local-ä¼ è¾“">#</a></h3>
<p>Netty æä¾›äº†ä¸€ä¸ª Local ä¼ è¾“ï¼Œç”¨äºåœ¨åŒä¸€ä¸ª JVM ä¸­è¿è¡Œçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç¨‹åºä¹‹é—´çš„å¼‚æ­¥é€šä¿¡ã€‚åŒæ ·ï¼Œè¿™ä¸ªä¼ è¾“ä¹Ÿæ”¯æŒå¯¹äºæ‰€æœ‰ Netty ä¼ è¾“å®ç°éƒ½å…±åŒçš„ APIã€‚
åœ¨è¿™ä¸ªä¼ è¾“ä¸­ï¼Œå’ŒæœåŠ¡å™¨ Channel ç›¸å…³è”çš„ SocketAddress å¹¶æ²¡æœ‰ç»‘å®šç‰©ç†ç½‘ç»œåœ°å€ï¼›ç›¸åï¼Œåªè¦æœåŠ¡å™¨è¿˜åœ¨è¿è¡Œï¼Œå®ƒå°±ä¼šè¢«å­˜å‚¨åœ¨æ³¨å†Œè¡¨é‡Œï¼Œå¹¶åœ¨ Channel å…³é—­æ—¶æ³¨é”€ã€‚å› ä¸ºè¿™ä¸ªä¼ è¾“å¹¶ä¸æ¥å—çœŸæ­£çš„ç½‘ç»œæµé‡ï¼Œæ‰€ä»¥å®ƒå¹¶ä¸èƒ½å¤Ÿå’Œå…¶ä»–ä¼ è¾“å®ç°è¿›è¡Œäº’æ“ä½œã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯å¸Œæœ›è¿æ¥åˆ°ï¼ˆåœ¨åŒä¸€ä¸ª JVM ä¸­ï¼‰ä½¿ç”¨äº†è¿™ä¸ªä¼ è¾“çš„æœåŠ¡å™¨ç«¯æ—¶ä¹Ÿå¿…é¡»ä½¿ç”¨å®ƒã€‚é™¤äº†è¿™ä¸ªé™åˆ¶ï¼Œå®ƒçš„ä½¿ç”¨æ–¹å¼å’Œå…¶ä»–çš„ä¼ è¾“ä¸€æ¨¡ä¸€æ ·ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/34.png"></p>
<h3 id="embedded-ä¼ è¾“">Embedded ä¼ è¾“<a hidden class="anchor" aria-hidden="true" href="#embedded-ä¼ è¾“">#</a></h3>
<p>Netty æä¾›äº†ä¸€ç§é¢å¤–çš„ä¼ è¾“ï¼Œä½¿å¾—ä½ å¯ä»¥å°†ä¸€ç»„ ChannelHandler ä½œä¸ºå¸®åŠ©å™¨ç±»åµŒå…¥åˆ°å…¶ä»–çš„
ChannelHandler å†…éƒ¨ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å°†å¯ä»¥æ‰©å±•ä¸€ä¸ª ChannelHandler çš„åŠŸèƒ½ï¼Œè€Œåˆä¸éœ€è¦ä¿®æ”¹å…¶å†…éƒ¨ä»£ç ã€‚ä¸è¶³ä¸ºå¥‡çš„æ˜¯ï¼ŒEmbedded ä¼ è¾“çš„å…³é”®æ˜¯ä¸€ä¸ªè¢«ç§°ä¸º EmbeddedChannel çš„å…·ä½“çš„ Channelå®ç°ã€‚åœ¨ç¬¬ 9 ç« ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†åœ°è®¨è®ºå¦‚ä½•ä½¿ç”¨è¿™ä¸ªç±»æ¥ä¸º ChannelHandler çš„å®ç°åˆ›å»ºå•å…ƒæµ‹è¯•ç”¨ä¾‹ã€‚</p>
<h2 id="é€‰æ‹©å“ªä¸€ç§ä¼ è¾“">é€‰æ‹©å“ªä¸€ç§ä¼ è¾“<a hidden class="anchor" aria-hidden="true" href="#é€‰æ‹©å“ªä¸€ç§ä¼ è¾“">#</a></h2>
<h3 id="éé˜»å¡ä»£ç åº“">éé˜»å¡ä»£ç åº“<a hidden class="anchor" aria-hidden="true" href="#éé˜»å¡ä»£ç åº“">#</a></h3>
<p>å¦‚æœä½ çš„ä»£ç åº“ä¸­æ²¡æœ‰é˜»å¡è°ƒç”¨ï¼ˆæˆ–è€…ä½ èƒ½å¤Ÿé™åˆ¶å®ƒä»¬çš„èŒƒå›´ï¼‰ï¼Œé‚£ä¹ˆåœ¨ Linux ä¸Šä½¿ç”¨ NIO æˆ–è€… epoll å§‹ç»ˆæ˜¯ä¸ªå¥½ä¸»æ„ã€‚è™½ç„¶ NIO/epoll æ—¨åœ¨å¤„ç†å¤§é‡çš„å¹¶å‘è¿æ¥ï¼Œä½†æ˜¯åœ¨å¤„ç†è¾ƒå°æ•°ç›®çš„å¹¶å‘è¿æ¥æ—¶ï¼Œå®ƒä¹Ÿèƒ½å¾ˆå¥½åœ°å·¥ä½œï¼Œå°¤å…¶æ˜¯è€ƒè™‘åˆ°å®ƒåœ¨è¿æ¥ä¹‹é—´å…±äº«çº¿ç¨‹çš„æ–¹å¼ã€‚</p>
<h3 id="é˜»å¡ä»£ç åº“">é˜»å¡ä»£ç åº“<a hidden class="anchor" aria-hidden="true" href="#é˜»å¡ä»£ç åº“">#</a></h3>
<p>æ­£å¦‚æˆ‘ä»¬å·²ç»æŒ‡å‡ºçš„ï¼Œå¦‚æœä½ çš„ä»£ç åº“ä¸¥é‡åœ°ä¾èµ–äºé˜»å¡ I/Oï¼Œè€Œä¸”ä½ çš„åº”ç”¨ç¨‹åºä¹Ÿæœ‰ä¸€ä¸ªç›¸åº”çš„è®¾è®¡ï¼Œé‚£ä¹ˆåœ¨ä½ å°è¯•å°†å…¶ç›´æ¥è½¬æ¢ä¸º Netty çš„ NIO ä¼ è¾“æ—¶ï¼Œä½ å°†å¯èƒ½ä¼šé‡åˆ°å’Œé˜»å¡æ“ä½œç›¸å…³çš„é—®é¢˜ã€‚ä¸è¦ä¸ºæ­¤è€Œé‡å†™ä½ çš„ä»£ç ï¼Œå¯ä»¥è€ƒè™‘åˆ†é˜¶æ®µè¿ç§»ï¼šå…ˆä»OIO å¼€å§‹ï¼Œç­‰ä½ çš„ä»£ç ä¿®æ”¹å¥½ä¹‹åï¼Œå†è¿ç§»åˆ° NIOï¼ˆæˆ–è€…ä½¿ç”¨ epollï¼Œå¦‚æœä½ åœ¨ä½¿ç”¨ Linuxï¼‰ã€‚</p>
<h3 id="åœ¨åŒä¸€ä¸ª-jvm-å†…éƒ¨çš„é€šä¿¡">åœ¨åŒä¸€ä¸ª JVM å†…éƒ¨çš„é€šä¿¡<a hidden class="anchor" aria-hidden="true" href="#åœ¨åŒä¸€ä¸ª-jvm-å†…éƒ¨çš„é€šä¿¡">#</a></h3>
<p>â€”åœ¨åŒä¸€ä¸ª JVM å†…éƒ¨çš„é€šä¿¡ï¼Œä¸éœ€è¦é€šè¿‡ç½‘ç»œæš´éœ²æœåŠ¡ï¼Œæ˜¯Local ä¼ è¾“çš„å®Œç¾ç”¨ä¾‹ã€‚è¿™å°†æ¶ˆé™¤æ‰€æœ‰çœŸå®ç½‘ç»œæ“ä½œçš„å¼€é”€ï¼ŒåŒæ—¶ä»ç„¶ä½¿ç”¨ä½ çš„ Netty ä»£ç åº“ã€‚å¦‚æœéšåéœ€è¦é€šè¿‡ç½‘ç»œæš´éœ²æœåŠ¡ï¼Œé‚£ä¹ˆä½ å°†åªéœ€è¦æŠŠä¼ è¾“æ”¹ä¸º NIO æˆ–è€… OIO å³å¯ã€‚</p>
<h3 id="æµ‹è¯•ä½ çš„-channelhandler-å®ç°">æµ‹è¯•ä½ çš„ ChannelHandler å®ç°<a hidden class="anchor" aria-hidden="true" href="#æµ‹è¯•ä½ çš„-channelhandler-å®ç°">#</a></h3>
<p>å¦‚æœä½ æƒ³è¦ä¸ºè‡ªå·±çš„ ChannelHandler å®ç°ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œé‚£ä¹ˆè¯·è€ƒè™‘ä½¿ç”¨ Embedded ä¼ è¾“ã€‚è¿™æ—¢ä¾¿äºæµ‹è¯•ä½ çš„ä»£ç ï¼Œè€Œåˆä¸éœ€è¦åˆ›å»ºå¤§é‡çš„æ¨¡æ‹Ÿï¼ˆmockï¼‰å¯¹è±¡ã€‚ä½ çš„ç±»å°†ä»ç„¶ç¬¦åˆå¸¸è§„çš„ API äº‹ä»¶æµï¼Œä¿è¯è¯¥ ChannelHandleråœ¨å’ŒçœŸå®çš„ä¼ è¾“ä¸€èµ·ä½¿ç”¨æ—¶èƒ½å¤Ÿæ­£ç¡®åœ°å·¥ä½œã€‚</p>
<h1 id="bytebuf">ByteBuf<a hidden class="anchor" aria-hidden="true" href="#bytebuf">#</a></h1>
<p>ç½‘ç»œæ•°æ®çš„åŸºæœ¬å•ä½æ€»æ˜¯å­—èŠ‚ã€‚Java NIO æä¾›äº† ByteBuffer ä½œä¸ºå®ƒçš„å­—èŠ‚å®¹å™¨ï¼Œä½†æ˜¯è¿™ä¸ªç±»ä½¿ç”¨èµ·æ¥è¿‡äºå¤æ‚ã€‚Netty çš„ ByteBuffer æ›¿ä»£å“æ˜¯ ByteBufï¼Œä¸€ä¸ªå¼ºå¤§çš„å®ç°ï¼Œæ—¢è§£å†³äº† JDK API çš„å±€é™æ€§ï¼Œåˆä¸ºç½‘ç»œåº”ç”¨ç¨‹åºçš„å¼€å‘è€…æä¾›äº†æ›´å¥½çš„ APIã€‚åœ¨æœ¬ç« ä¸­æˆ‘ä»¬å°†ä¼šè¯´æ˜å’Œ JDK çš„ ByteBuffer ç›¸æ¯”ï¼ŒByteBuf çš„å“è¶ŠåŠŸèƒ½æ€§å’Œçµæ´»æ€§ã€‚è¿™ä¹Ÿå°†æœ‰åŠ©äºæ›´å¥½åœ°ç†è§£ Netty æ•°æ®å¤„ç†çš„ä¸€èˆ¬æ–¹å¼ï¼Œå¹¶ä¸ºå°†åœ¨ç¬¬ 6 ç« ä¸­é’ˆå¯¹ChannelPipelineå’Œ ChannelHandler çš„è®¨è®ºåšå¥½å‡†å¤‡ã€‚</p>
<h2 id="bytebuf-çš„-api">ByteBuf çš„ API<a hidden class="anchor" aria-hidden="true" href="#bytebuf-çš„-api">#</a></h2>
<p>Netty çš„æ•°æ®å¤„ç† API é€šè¿‡ä¸¤ä¸ªç»„ä»¶æš´éœ²â€”â€”abstract class ByteBuf å’Œ interfaceByteBufHolderã€‚
ä¸‹é¢æ˜¯ä¸€äº› ByteBuf API çš„ä¼˜ç‚¹</p>
<ul>
<li>å®ƒå¯ä»¥è¢«ç”¨æˆ·è‡ªå®šä¹‰çš„ç¼“å†²åŒºç±»å‹æ‰©å±•ï¼›</li>
<li>é€šè¿‡å†…ç½®çš„å¤åˆç¼“å†²åŒºç±»å‹å®ç°äº†é€æ˜çš„é›¶æ‹·è´ï¼›</li>
<li>å®¹é‡å¯ä»¥æŒ‰éœ€å¢é•¿ï¼ˆç±»ä¼¼äº JDK çš„ StringBuilderï¼‰ï¼›</li>
<li>åœ¨è¯»å’Œå†™è¿™ä¸¤ç§æ¨¡å¼ä¹‹é—´åˆ‡æ¢ä¸éœ€è¦è°ƒç”¨ ByteBuffer çš„ flip()æ–¹æ³•ï¼›</li>
<li>è¯»å’Œå†™ä½¿ç”¨äº†ä¸åŒçš„ç´¢å¼•ï¼›</li>
<li>æ”¯æŒæ–¹æ³•çš„é“¾å¼è°ƒç”¨</li>
<li>æ”¯æŒå¼•ç”¨è®¡æ•°ï¼›</li>
<li>æ”¯æŒæ± åŒ–ã€‚
å…¶ä»–ç±»å¯ç”¨äºç®¡ç† ByteBuf å®ä¾‹çš„åˆ†é…ï¼Œä»¥åŠæ‰§è¡Œå„ç§é’ˆå¯¹äºæ•°æ®å®¹å™¨æœ¬èº«å’Œå®ƒæ‰€æŒæœ‰çš„æ•°æ®çš„æ“ä½œã€‚æˆ‘ä»¬å°†åœ¨ä»”ç»†ç ”ç©¶ ByteBuf å’Œ ByteBufHolder æ—¶æ¢è®¨è¿™äº›ç‰¹æ€§ã€‚</li>
</ul>
<h2 id="bytebuf-ç±»netty-çš„æ•°æ®å®¹å™¨">ByteBuf ç±»â€”â€”Netty çš„æ•°æ®å®¹å™¨<a hidden class="anchor" aria-hidden="true" href="#bytebuf-ç±»netty-çš„æ•°æ®å®¹å™¨">#</a></h2>
<p>å› ä¸ºæ‰€æœ‰çš„ç½‘ç»œé€šä¿¡éƒ½æ¶‰åŠå­—èŠ‚åºåˆ—çš„ç§»åŠ¨ï¼Œæ‰€ä»¥é«˜æ•ˆæ˜“ç”¨çš„æ•°æ®ç»“æ„æ˜æ˜¾æ˜¯å¿…ä¸å¯å°‘çš„ã€‚
Netty çš„ ByteBuf å®ç°æ»¡è¶³å¹¶è¶…è¶Šäº†è¿™äº›éœ€æ±‚ã€‚è®©æˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•é€šè¿‡ä½¿ç”¨ä¸åŒçš„ç´¢å¼•æ¥ç®€åŒ–å¯¹å®ƒæ‰€åŒ…å«çš„æ•°æ®çš„è®¿é—®çš„å§ã€‚</p>
<h3 id="bytebufå¦‚ä½•å·¥ä½œ">bytebufå¦‚ä½•å·¥ä½œ<a hidden class="anchor" aria-hidden="true" href="#bytebufå¦‚ä½•å·¥ä½œ">#</a></h3>
<p>ByteBuf ç»´æŠ¤äº†ä¸¤ä¸ªä¸åŒçš„ç´¢å¼•ï¼šä¸€ä¸ªç”¨äºè¯»å–ï¼Œä¸€ä¸ªç”¨äºå†™å…¥ã€‚å½“ä½ ä» ByteBuf è¯»å–æ—¶ï¼Œ
å®ƒçš„ readerIndex å°†ä¼šè¢«é€’å¢å·²ç»è¢«è¯»å–çš„å­—èŠ‚æ•°ã€‚åŒæ ·åœ°ï¼Œå½“ä½ å†™å…¥ ByteBuf æ—¶ï¼Œå®ƒçš„
writerIndex ä¹Ÿä¼šè¢«é€’å¢ã€‚å›¾ 5-1 å±•ç¤ºäº†ä¸€ä¸ªç©º ByteBuf çš„å¸ƒå±€ç»“æ„å’ŒçŠ¶æ€ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/35.png"></p>
<p>è¦äº†è§£è¿™äº›ç´¢å¼•ä¸¤ä¸¤ä¹‹é—´çš„å…³ç³»ï¼Œè¯·è€ƒè™‘ä¸€ä¸‹ï¼Œå¦‚æœæ‰“ç®—è¯»å–å­—èŠ‚ç›´åˆ° readerIndex è¾¾åˆ°
å’Œ writerIndex åŒæ ·çš„å€¼æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚åœ¨é‚£æ—¶ï¼Œä½ å°†ä¼šåˆ°è¾¾â€œå¯ä»¥è¯»å–çš„â€æ•°æ®çš„æœ«å°¾ã€‚å°±å¦‚åŒè¯•å›¾è¯»å–è¶…å‡ºæ•°ç»„æœ«å°¾çš„æ•°æ®ä¸€æ ·ï¼Œè¯•å›¾è¯»å–è¶…å‡ºè¯¥ç‚¹çš„æ•°æ®å°†ä¼šè§¦å‘ä¸€ä¸ª IndexOutOfBoundsExceptionã€‚</p>
<p>åç§°ä»¥ read æˆ–è€… write å¼€å¤´çš„ ByteBuf æ–¹æ³•ï¼Œå°†ä¼šæ¨è¿›å…¶å¯¹åº”çš„ç´¢å¼•ï¼Œè€Œåç§°ä»¥ set æˆ–
è€… get å¼€å¤´çš„æ“ä½œåˆ™ä¸ä¼šã€‚åé¢çš„è¿™äº›æ–¹æ³•å°†åœ¨ä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ å…¥çš„ä¸€ä¸ªç›¸å¯¹ç´¢å¼•ä¸Šæ‰§è¡Œæ“ä½œã€‚
å¯ä»¥æŒ‡å®š ByteBuf çš„æœ€å¤§å®¹é‡ã€‚è¯•å›¾ç§»åŠ¨å†™ç´¢å¼•ï¼ˆå³ writerIndexï¼‰è¶…è¿‡è¿™ä¸ªå€¼å°†ä¼šè§¦å‘ä¸€ä¸ªå¼‚å¸¸â‘ ã€‚ï¼ˆé»˜è®¤çš„é™åˆ¶æ˜¯ Integer.MAX_VALUEã€‚ï¼‰</p>
<h3 id="bytebuf-çš„ä½¿ç”¨æ¨¡å¼">ByteBuf çš„ä½¿ç”¨æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#bytebuf-çš„ä½¿ç”¨æ¨¡å¼">#</a></h3>
<p>åœ¨ä½¿ç”¨ Netty æ—¶ï¼Œä½ å°†é‡åˆ°å‡ ç§å¸¸è§çš„å›´ç»• ByteBuf è€Œæ„å»ºçš„ä½¿ç”¨æ¨¡å¼ã€‚åœ¨ç ”ç©¶å®ƒä»¬æ—¶ï¼Œæˆ‘ä»¬å¿ƒé‡Œæƒ³ç€å›¾ 5-1 ä¼šæœ‰æ‰€è£¨ç›Šï¼Œä¸€ä¸ªç”±ä¸åŒçš„ç´¢å¼•åˆ†åˆ«æ§åˆ¶è¯»è®¿é—®å’Œå†™è®¿é—®çš„å­—èŠ‚æ•°ç»„ã€‚</p>
<h4 id="å †ç¼“å†²åŒº">å †ç¼“å†²åŒº<a hidden class="anchor" aria-hidden="true" href="#å †ç¼“å†²åŒº">#</a></h4>
<p>æœ€å¸¸ç”¨çš„ ByteBuf æ¨¡å¼æ˜¯å°†æ•°æ®å­˜å‚¨åœ¨ JVM çš„å †ç©ºé—´ä¸­ã€‚è¿™ç§æ¨¡å¼è¢«ç§°ä¸ºæ”¯æ’‘æ•°ç»„
ï¼ˆbacking arrayï¼‰ï¼Œå®ƒèƒ½åœ¨æ²¡æœ‰ä½¿ç”¨æ± åŒ–çš„æƒ…å†µä¸‹æä¾›å¿«é€Ÿçš„åˆ†é…å’Œé‡Šæ”¾ã€‚è¿™ç§æ–¹å¼ï¼Œå¦‚ä»£ç æ¸…å•
5-1 æ‰€ç¤ºï¼Œéå¸¸é€‚åˆäºæœ‰é—ç•™çš„æ•°æ®éœ€è¦å¤„ç†çš„æƒ…å†µã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-1 æ”¯æ’‘æ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> heapBuffer() {
</span></span><span style="display:flex;"><span>	ByteBuf heapBuf = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//æ£€æŸ¥ ByteBuf æ˜¯å¦æœ‰ä¸€ä¸ªæ”¯æ’‘æ•°ç»„</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> (heapBuf.<span style="color:#007f7f">hasArray</span>()) {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//å¦‚æœæœ‰ï¼Œåˆ™è·å–å¯¹è¯¥æ•°ç»„çš„å¼•ç”¨</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">byte</span>[] array = heapBuf.<span style="color:#007f7f">array</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//è®¡ç®—ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åç§»é‡</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">int</span> offset = heapBuf.<span style="color:#007f7f">arrayOffset</span>() + heapBuf.<span style="color:#007f7f">readerIndex</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//è·å¾—å¯è¯»å­—èŠ‚æ•°</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">int</span> length = heapBuf.<span style="color:#007f7f">readableBytes</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//ä½¿ç”¨æ•°ç»„ã€åç§»é‡å’Œé•¿åº¦ä½œä¸ºå‚æ•°è°ƒç”¨ä½ çš„æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>		handleArray(array, offset, length);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ç›´æ¥ç¼“å†²åŒº">ç›´æ¥ç¼“å†²åŒº<a hidden class="anchor" aria-hidden="true" href="#ç›´æ¥ç¼“å†²åŒº">#</a></h4>
<p>ç›´æ¥ç¼“å†²åŒºæ˜¯å¦å¤–ä¸€ç§ ByteBuf æ¨¡å¼ã€‚æˆ‘ä»¬æœŸæœ›ç”¨äºå¯¹è±¡åˆ›å»ºçš„å†…å­˜åˆ†é…æ°¸è¿œéƒ½æ¥è‡ªäºå †ä¸­ï¼Œä½†è¿™å¹¶ä¸æ˜¯å¿…é¡»çš„â€”â€”NIO åœ¨ JDK 1.4 ä¸­å¼•å…¥çš„ ByteBuffer ç±»å…è®¸ JVM å®ç°é€šè¿‡æœ¬åœ°è°ƒç”¨æ¥åˆ†é…å†…å­˜ã€‚è¿™ä¸»è¦æ˜¯ä¸ºäº†é¿å…åœ¨æ¯æ¬¡è°ƒç”¨æœ¬åœ° I/O æ“ä½œä¹‹å‰ï¼ˆæˆ–è€…ä¹‹åï¼‰å°†ç¼“å†²åŒºçš„å†…å®¹å¤åˆ¶åˆ°ä¸€ä¸ªä¸­é—´ç¼“å†²åŒºï¼ˆæˆ–è€…ä»ä¸­é—´ç¼“å†²åŒºæŠŠå†…å®¹å¤åˆ¶åˆ°ç¼“å†²åŒºï¼‰ã€‚</p>
<p>ByteBufferçš„Javadocæ˜ç¡®æŒ‡å‡ºï¼šâ€œç›´æ¥ç¼“å†²åŒºçš„å†…å®¹å°†é©»ç•™åœ¨å¸¸è§„çš„ä¼šè¢«åƒåœ¾å›æ”¶çš„å †ä¹‹å¤–ã€‚â€è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä½•ç›´æ¥ç¼“å†²åŒºå¯¹äºç½‘ç»œæ•°æ®ä¼ è¾“æ˜¯ç†æƒ³çš„é€‰æ‹©ã€‚å¦‚æœä½ çš„æ•°æ®åŒ…å«åœ¨ä¸€ä¸ªåœ¨å †ä¸Šåˆ†é…çš„ç¼“å†²åŒºä¸­ï¼Œé‚£ä¹ˆäº‹å®ä¸Šï¼Œåœ¨é€šè¿‡å¥—æ¥å­—å‘é€å®ƒä¹‹å‰ï¼ŒJVMå°†ä¼šåœ¨å†…éƒ¨æŠŠä½ çš„ç¼“å†²åŒºå¤åˆ¶åˆ°ä¸€ä¸ªç›´æ¥ç¼“å†²åŒºä¸­ã€‚</p>
<p>ç›´æ¥ç¼“å†²åŒºçš„ä¸»è¦ç¼ºç‚¹æ˜¯ï¼Œç›¸å¯¹äºåŸºäºå †çš„ç¼“å†²åŒºï¼Œå®ƒä»¬çš„åˆ†é…å’Œé‡Šæ”¾éƒ½è¾ƒä¸ºæ˜‚è´µã€‚å¦‚æœä½ æ­£åœ¨å¤„ç†é—ç•™ä»£ç ï¼Œä½ ä¹Ÿå¯èƒ½ä¼šé‡åˆ°å¦å¤–ä¸€ä¸ªç¼ºç‚¹ï¼šå› ä¸ºæ•°æ®ä¸æ˜¯åœ¨å †ä¸Šï¼Œæ‰€ä»¥ä½ ä¸å¾—ä¸è¿›è¡Œä¸€æ¬¡å¤åˆ¶ï¼Œå¦‚ä»£ç æ¸…å• 5-2 æ‰€ç¤ºã€‚æ˜¾ç„¶ï¼Œä¸ä½¿ç”¨æ”¯æ’‘æ•°ç»„ç›¸æ¯”ï¼Œè¿™æ¶‰åŠçš„å·¥ä½œæ›´å¤šã€‚å› æ­¤ï¼Œå¦‚æœäº‹å…ˆçŸ¥é“å®¹å™¨ä¸­çš„æ•°æ®å°†ä¼šè¢«ä½œä¸ºæ•°ç»„æ¥è®¿é—®ï¼Œä½ å¯èƒ½æ›´æ„¿æ„ä½¿ç”¨å †å†…å­˜ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-2 è®¿é—®ç›´æ¥ç¼“å†²åŒºçš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> directBuffer() {
</span></span><span style="display:flex;"><span>	ByteBuf directBuf = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//æ£€æŸ¥ ByteBuf æ˜¯å¦ç”±æ•°ç»„æ”¯æ’‘ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™è¿™æ˜¯ä¸€ä¸ªç›´æ¥ç¼“å†²åŒº</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> (!directBuf.<span style="color:#007f7f">hasArray</span>()) {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//è·å–å¯è¯»å­—èŠ‚æ•°</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">int</span> length = directBuf.<span style="color:#007f7f">readableBytes</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//åˆ†é…ä¸€ä¸ªæ–°çš„æ•°ç»„æ¥ä¿å­˜å…·æœ‰è¯¥é•¿åº¦çš„å­—èŠ‚æ•°æ®</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">byte</span>[] array = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[length];
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//å°†å­—èŠ‚å¤åˆ¶åˆ°è¯¥æ•°ç»„</span>
</span></span><span style="display:flex;"><span>		directBuf.<span style="color:#007f7f">getBytes</span>(directBuf.<span style="color:#007f7f">readerIndex</span>(), array);
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//ä½¿ç”¨æ•°ç»„ã€åç§»é‡å’Œé•¿åº¦ä½œä¸ºå‚æ•°è°ƒç”¨ä½ çš„æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>		handleArray(array, 0, length);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å¤åˆç¼“å†²åŒº">å¤åˆç¼“å†²åŒº<a hidden class="anchor" aria-hidden="true" href="#å¤åˆç¼“å†²åŒº">#</a></h4>
<p>ç¬¬ä¸‰ç§ä¹Ÿæ˜¯æœ€åä¸€ç§æ¨¡å¼ä½¿ç”¨çš„æ˜¯å¤åˆç¼“å†²åŒºï¼Œå®ƒä¸ºå¤šä¸ª ByteBuf æä¾›ä¸€ä¸ªèšåˆè§†å›¾ã€‚åœ¨è¿™é‡Œä½ å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æˆ–è€…åˆ é™¤ ByteBuf å®ä¾‹ï¼Œè¿™æ˜¯ä¸€ä¸ª JDK çš„ ByteBuffer å®ç°å®Œå…¨ç¼ºå¤±çš„ç‰¹æ€§ã€‚</p>
<p>Netty é€šè¿‡ä¸€ä¸ª ByteBuf å­ç±»â€”â€”CompositeByteBufâ€”â€”å®ç°äº†è¿™ä¸ªæ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå°†å¤šä¸ªç¼“å†²åŒºè¡¨ç¤ºä¸ºå•ä¸ªåˆå¹¶ç¼“å†²åŒºçš„è™šæ‹Ÿè¡¨ç¤ºã€‚</p>
<p>è­¦å‘Šï¼šCompositeByteBuf ä¸­çš„ ByteBuf å®ä¾‹å¯èƒ½åŒæ—¶åŒ…å«ç›´æ¥å†…å­˜åˆ†é…å’Œéç›´æ¥å†…å­˜åˆ†é…ã€‚å¦‚æœå…¶ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆå¯¹ CompositeByteBuf ä¸Šçš„ hasArray()æ–¹æ³•çš„è°ƒç”¨å°†è¿”å›è¯¥ç»„ä»¶ä¸Šçš„ hasArray()æ–¹æ³•çš„å€¼ï¼›å¦åˆ™å®ƒå°†è¿”å› falseã€‚</p>
<p>ä¸¾ä¾‹ï¼šä¸€ä¸ªç”±å¤´éƒ¨å’Œä¸»ä½“ç»„æˆçš„æ¶ˆæ¯ï¼Œå°†é€šè¿‡httpåè®®ä¼ è¾“ã€‚è¿™ä¸¤éƒ¨åˆ†ç”±åº”ç”¨ç¨‹åºçš„ä¸åŒæ¨¡å—äº§ç”Ÿï¼Œ
å°†ä¼šåœ¨æ¶ˆæ¯è¢«å‘é€çš„æ—¶å€™ç»„è£…ã€‚è¯¥åº”ç”¨ç¨‹åºå¯ä»¥é€‰æ‹©ä¸ºå¤šä¸ªæ¶ˆæ¯é‡ç”¨ç›¸åŒçš„æ¶ˆæ¯ä¸»ä½“ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œå¯¹äºæ¯ä¸ªæ¶ˆæ¯éƒ½å°†ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¤´éƒ¨ã€‚
å› ä¸ºæˆ‘ä»¬ä¸æƒ³ä¸ºæ¯ä¸ªæ¶ˆæ¯éƒ½é‡æ–°åˆ†é…è¿™ä¸¤ä¸ªç¼“å†²åŒºï¼Œæ‰€ä»¥ä½¿ç”¨ CompositeByteBuf æ˜¯ä¸€ä¸ªå®Œç¾çš„é€‰æ‹©ã€‚å®ƒåœ¨æ¶ˆé™¤äº†æ²¡å¿…è¦çš„å¤åˆ¶çš„åŒæ—¶ï¼Œæš´éœ²äº†é€šç”¨çš„ ByteBuf APIã€‚</p>
<p>ä»£ç æ¸…å• 5-3 å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ä½¿ç”¨ JDK çš„ ByteBuffer æ¥å®ç°è¿™ä¸€éœ€æ±‚ã€‚åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«ä¸¤ä¸ª
ByteBuffer çš„æ•°ç»„ç”¨æ¥ä¿å­˜è¿™äº›æ¶ˆæ¯ç»„ä»¶ï¼ŒåŒæ—¶åˆ›å»ºäº†ç¬¬ä¸‰ä¸ª ByteBuffer ç”¨æ¥ä¿å­˜æ‰€æœ‰è¿™äº›æ•°æ®çš„å‰¯æœ¬ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-3 ä½¿ç”¨ ByteBuffer çš„å¤åˆç¼“å†²åŒºæ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufferComposite(ByteBuffer header, ByteBuffer body) {
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// Use an array to hold the message parts</span>
</span></span><span style="display:flex;"><span>	ByteBuffer[] message =  <span style="color:#fff;font-weight:bold">new</span> ByteBuffer[]{ header, body };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// Create a new ByteBuffer and use copy to merge the header and body</span>
</span></span><span style="display:flex;"><span>	ByteBuffer message2 =
</span></span><span style="display:flex;"><span>			ByteBuffer.<span style="color:#007f7f">allocate</span>(header.<span style="color:#007f7f">remaining</span>() + body.<span style="color:#007f7f">remaining</span>());
</span></span><span style="display:flex;"><span>	message2.<span style="color:#007f7f">put</span>(header);
</span></span><span style="display:flex;"><span>	message2.<span style="color:#007f7f">put</span>(body);
</span></span><span style="display:flex;"><span>	message2.<span style="color:#007f7f">flip</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ†é…å’Œå¤åˆ¶æ“ä½œï¼Œä»¥åŠä¼´éšç€å¯¹æ•°ç»„ç®¡ç†çš„éœ€è¦ï¼Œä½¿å¾—è¿™ä¸ªç‰ˆæœ¬çš„å®ç°æ•ˆç‡ä½ä¸‹è€Œä¸”ç¬¨æ‹™ã€‚
ä»£ç æ¸…å• 5-4 å±•ç¤ºäº†ä¸€ä¸ªä½¿ç”¨äº† CompositeByteBuf çš„ç‰ˆæœ¬ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-4 ä½¿ç”¨ CompositeByteBuf çš„å¤åˆç¼“å†²åŒºæ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufComposite() {
</span></span><span style="display:flex;"><span>	CompositeByteBuf messageBuf = Unpooled.<span style="color:#007f7f">compositeBuffer</span>();
</span></span><span style="display:flex;"><span>	ByteBuf headerBuf = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">// can be backing or direct</span>
</span></span><span style="display:flex;"><span>	ByteBuf bodyBuf = BYTE_BUF_FROM_SOMEWHERE;   <span style="color:#007f7f">// can be backing or direct</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å°† ByteBuf å®ä¾‹è¿½åŠ åˆ° CompositeByteBuf</span>
</span></span><span style="display:flex;"><span>	messageBuf.<span style="color:#007f7f">addComponents</span>(headerBuf, bodyBuf);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//åˆ é™¤ä½äºç´¢å¼•ä½ç½®ä¸º 0ï¼ˆç¬¬ä¸€ä¸ªç»„ä»¶ï¼‰çš„ ByteBuf</span>
</span></span><span style="display:flex;"><span>	messageBuf.<span style="color:#007f7f">removeComponent</span>(0); <span style="color:#007f7f">// remove the header</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å¾ªç¯éå†æ‰€æœ‰çš„ ByteBuf å®ä¾‹</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">for</span> (ByteBuf buf : messageBuf) {
</span></span><span style="display:flex;"><span>		System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(buf.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>CompositeByteBuf å¯èƒ½ä¸æ”¯æŒè®¿é—®å…¶æ”¯æ’‘æ•°ç»„ï¼Œå› æ­¤è®¿é—® CompositeByteBuf ä¸­çš„æ•°æ®ç±»ä¼¼
äºï¼ˆè®¿é—®ï¼‰ç›´æ¥ç¼“å†²åŒºçš„æ¨¡å¼ï¼Œå¦‚ä»£ç æ¸…å• 5-5 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-5 è®¿é—® CompositeByteBuf ä¸­çš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufCompositeArray() {
</span></span><span style="display:flex;"><span>	CompositeByteBuf compBuf = Unpooled.<span style="color:#007f7f">compositeBuffer</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//è·å¾—å¯è¯»å­—èŠ‚æ•°</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">int</span> length = compBuf.<span style="color:#007f7f">readableBytes</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//åˆ†é…ä¸€ä¸ªå…·æœ‰å¯è¯»å­—èŠ‚æ•°é•¿åº¦çš„æ–°æ•°ç»„</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">byte</span>[] array = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[length];
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å°†å­—èŠ‚è¯»åˆ°è¯¥æ•°ç»„ä¸­</span>
</span></span><span style="display:flex;"><span>	compBuf.<span style="color:#007f7f">getBytes</span>(compBuf.<span style="color:#007f7f">readerIndex</span>(), array);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//ä½¿ç”¨åç§»é‡å’Œé•¿åº¦ä½œä¸ºå‚æ•°ä½¿ç”¨è¯¥æ•°ç»„</span>
</span></span><span style="display:flex;"><span>	handleArray(array, 0, array.<span style="color:#007f7f">length</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒNettyä½¿ç”¨äº†CompositeByteBufæ¥ä¼˜åŒ–å¥—æ¥å­—çš„I/Oæ“ä½œï¼Œå°½å¯èƒ½åœ°æ¶ˆé™¤äº†ç”±JDKçš„ç¼“å†²åŒºå®ç°æ‰€å¯¼è‡´çš„æ€§èƒ½ä»¥åŠå†…å­˜ä½¿ç”¨ç‡çš„æƒ©ç½šã€‚è¿™ç§ä¼˜åŒ–å‘ç”Ÿåœ¨Nettyçš„æ ¸å¿ƒä»£ç ä¸­ï¼Œå› æ­¤ä¸ä¼šè¢«æš´éœ²å‡ºæ¥ï¼Œä½†æ˜¯ä½ åº”è¯¥çŸ¥é“å®ƒæ‰€å¸¦æ¥çš„å½±å“ã€‚CompositeByteBuf API é™¤äº†ä» ByteBuf ç»§æ‰¿çš„æ–¹æ³•ï¼ŒCompositeByteBuf æä¾›äº†å¤§é‡çš„é™„åŠ åŠŸèƒ½ã€‚è¯·å‚è€ƒ Netty çš„ Javadoc ä»¥è·å¾—è¯¥ API çš„å®Œæ•´åˆ—è¡¨ã€‚</p>
<h2 id="byebufå­—èŠ‚çº§æ“ä½œ">ByeBufå­—èŠ‚çº§æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#byebufå­—èŠ‚çº§æ“ä½œ">#</a></h2>
<p>ByteBuf æä¾›äº†è®¸å¤šè¶…å‡ºåŸºæœ¬è¯»ã€å†™æ“ä½œçš„æ–¹æ³•ç”¨äºä¿®æ”¹å®ƒçš„æ•°æ®ã€‚æˆ‘ä»¬å°†ä¼šè®¨è®ºè¿™äº›ä¸­æœ€é‡è¦çš„éƒ¨åˆ†ã€‚</p>
<h3 id="éšæœºè®¿é—®ç´¢å¼•">éšæœºè®¿é—®ç´¢å¼•<a hidden class="anchor" aria-hidden="true" href="#éšæœºè®¿é—®ç´¢å¼•">#</a></h3>
<p>å¦‚åŒåœ¨æ™®é€šçš„ Java å­—èŠ‚æ•°ç»„ä¸­ä¸€æ ·ï¼ŒByteBuf çš„ç´¢å¼•æ˜¯ä»é›¶å¼€å§‹çš„ï¼šç¬¬ä¸€ä¸ªå­—èŠ‚çš„ç´¢å¼•æ˜¯0ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚çš„ç´¢å¼•æ€»æ˜¯ capacity() - 1ã€‚ä»£ç æ¸…å• 5-6 è¡¨æ˜ï¼Œå¯¹å­˜å‚¨æœºåˆ¶çš„å°è£…ä½¿å¾—éå† ByteBuf çš„å†…å®¹éå¸¸ç®€å•ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-6 è®¿é—®æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufRelativeAccess() {
</span></span><span style="display:flex;"><span>	ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; buffer.<span style="color:#007f7f">capacity</span>(); i++) {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">byte</span> b = buffer.<span style="color:#007f7f">getByte</span>(i);
</span></span><span style="display:flex;"><span>		System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>((<span style="color:#fff;font-weight:bold">char</span>) b);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨é‚£äº›éœ€è¦ä¸€ä¸ªç´¢å¼•å€¼å‚æ•°çš„æ–¹æ³•ï¼ˆçš„å…¶ä¸­ï¼‰ä¹‹ä¸€æ¥è®¿é—®æ•°æ®æ—¢ä¸ä¼šæ”¹å˜readerIndexä¹Ÿä¸ä¼šæ”¹å˜ writerIndexã€‚å¦‚æœæœ‰éœ€è¦ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ readerIndex(index)æˆ–è€…writerIndex(index)æ¥æ‰‹åŠ¨ç§»åŠ¨è¿™ä¸¤è€…ã€‚</p>
<h3 id="é¡ºåºè®¿é—®ç´¢å¼•">é¡ºåºè®¿é—®ç´¢å¼•<a hidden class="anchor" aria-hidden="true" href="#é¡ºåºè®¿é—®ç´¢å¼•">#</a></h3>
<p>è™½ç„¶ ByteBuf åŒæ—¶å…·æœ‰è¯»ç´¢å¼•å’Œå†™ç´¢å¼•ï¼Œä½†æ˜¯ JDK çš„ ByteBuffer å´åªæœ‰ä¸€ä¸ªç´¢å¼•ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå¿…é¡»è°ƒç”¨ flip()æ–¹æ³•æ¥åœ¨è¯»æ¨¡å¼å’Œå†™æ¨¡å¼ä¹‹é—´è¿›è¡Œåˆ‡æ¢çš„åŸå› ã€‚å›¾ 5-3 å±•ç¤ºäº†ByteBuf æ˜¯å¦‚ä½•è¢«å®ƒçš„ä¸¤ä¸ªç´¢å¼•åˆ’åˆ†æˆ 3 ä¸ªåŒºåŸŸçš„ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/36.png"></p>
<h3 id="å¯ä¸¢å¼ƒå­—èŠ‚">å¯ä¸¢å¼ƒå­—èŠ‚<a hidden class="anchor" aria-hidden="true" href="#å¯ä¸¢å¼ƒå­—èŠ‚">#</a></h3>
<p>åœ¨å›¾ 5-3 ä¸­æ ‡è®°ä¸ºå¯ä¸¢å¼ƒå­—èŠ‚çš„åˆ†æ®µåŒ…å«äº†å·²ç»è¢«è¯»è¿‡çš„å­—èŠ‚ã€‚é€šè¿‡è°ƒç”¨ discardReadBytes()æ–¹æ³•ï¼Œå¯ä»¥ä¸¢å¼ƒå®ƒä»¬å¹¶å›æ”¶ç©ºé—´ã€‚è¿™ä¸ªåˆ†æ®µçš„åˆå§‹å¤§å°ä¸º 0ï¼Œå­˜å‚¨åœ¨ readerIndex ä¸­ï¼Œä¼šéšç€ read æ“ä½œçš„æ‰§è¡Œè€Œå¢åŠ ï¼ˆget*æ“ä½œä¸ä¼šç§»åŠ¨ readerIndexï¼‰ã€‚å›¾ 5-4 å±•ç¤ºäº†å›¾ 5-3 ä¸­æ‰€å±•ç¤ºçš„ç¼“å†²åŒºä¸Šè°ƒç”¨discardReadBytes()æ–¹æ³•åçš„ç»“æœã€‚å¯ä»¥çœ‹åˆ°ï¼Œå¯ä¸¢å¼ƒå­—èŠ‚åˆ†æ®µä¸­çš„ç©ºé—´å·²ç»å˜ä¸ºå¯å†™çš„äº†ã€‚æ³¨æ„ï¼Œåœ¨è°ƒç”¨discardReadBytes()ä¹‹åï¼Œå¯¹å¯å†™åˆ†æ®µçš„å†…å®¹å¹¶æ²¡æœ‰ä»»ä½•çš„ä¿è¯ â‘ ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/37.png"></p>
<p>è™½ç„¶ä½ å¯èƒ½ä¼šå€¾å‘äºé¢‘ç¹åœ°è°ƒç”¨ discardReadBytes()æ–¹æ³•ä»¥ç¡®ä¿å¯å†™åˆ†æ®µçš„æœ€å¤§åŒ–ï¼Œä½†æ˜¯è¯·æ³¨æ„ï¼Œè¿™å°†ææœ‰å¯èƒ½ä¼šå¯¼è‡´å†…å­˜å¤åˆ¶ï¼Œå› ä¸ºå¯è¯»å­—èŠ‚ï¼ˆå›¾ä¸­æ ‡è®°ä¸º CONTENT çš„éƒ¨åˆ†ï¼‰å¿…é¡»è¢«ç§»åŠ¨åˆ°ç¼“å†²åŒºçš„å¼€å§‹ä½ç½®ã€‚æˆ‘ä»¬å»ºè®®åªåœ¨æœ‰çœŸæ­£éœ€è¦çš„æ—¶å€™æ‰è¿™æ ·åšï¼Œä¾‹å¦‚ï¼Œå½“å†…å­˜éå¸¸å®è´µçš„æ—¶å€™ã€‚</p>
<h3 id="å¯è¯»å­—èŠ‚">å¯è¯»å­—èŠ‚<a hidden class="anchor" aria-hidden="true" href="#å¯è¯»å­—èŠ‚">#</a></h3>
<p>ByteBuf çš„å¯è¯»å­—èŠ‚åˆ†æ®µå­˜å‚¨äº†å®é™…æ•°æ®ã€‚æ–°åˆ†é…çš„ã€åŒ…è£…çš„æˆ–è€…å¤åˆ¶çš„ç¼“å†²åŒºçš„é»˜è®¤çš„readerIndexå€¼ä¸º0ã€‚
ä»»ä½•åç§°ä»¥readæˆ–è€…skipå¼€å¤´çš„æ“ä½œéƒ½å°†æ£€ç´¢æˆ–è€…è·³è¿‡ä½äºå½“å‰readerIndexçš„æ•°æ®ï¼Œå¹¶ä¸”å°†å®ƒå¢åŠ å·²è¯»å­—èŠ‚æ•°ã€‚å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•éœ€è¦ä¸€ä¸ª ByteBuf å‚æ•°ä½œä¸ºå†™å…¥çš„ç›®æ ‡ï¼Œå¹¶ä¸”æ²¡æœ‰æŒ‡å®šç›®æ ‡ç´¢å¼•å‚æ•°ï¼Œé‚£ä¹ˆè¯¥ç›®æ ‡ç¼“å†²åŒºçš„ writerIndex ä¹Ÿå°†è¢«å¢åŠ ï¼Œä¾‹å¦‚ï¼š<code>readBytes(ByteBuf dest);</code></p>
<p>å¦‚æœå°è¯•åœ¨ç¼“å†²åŒºçš„å¯è¯»å­—èŠ‚æ•°å·²ç»è€—å°½æ—¶ä»ä¸­è¯»å–æ•°æ®ï¼Œé‚£ä¹ˆå°†ä¼šå¼•å‘ä¸€ä¸ª IndexOutOfBoundsExceptionã€‚
ä»£ç æ¸…å• 5-7 å±•ç¤ºäº†å¦‚ä½•è¯»å–æ‰€æœ‰å¯ä»¥è¯»çš„å­—èŠ‚ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-7 è¯»å–æ‰€æœ‰æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> readAllData() {
</span></span><span style="display:flex;"><span>	ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">while</span> (buffer.<span style="color:#007f7f">isReadable</span>()) {
</span></span><span style="display:flex;"><span>		System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(buffer.<span style="color:#007f7f">readByte</span>());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å¯å†™å­—èŠ‚">å¯å†™å­—èŠ‚<a hidden class="anchor" aria-hidden="true" href="#å¯å†™å­—èŠ‚">#</a></h3>
<p>å¯å†™å­—èŠ‚åˆ†æ®µæ˜¯æŒ‡ä¸€ä¸ªæ‹¥æœ‰æœªå®šä¹‰å†…å®¹çš„ã€å†™å…¥å°±ç»ªçš„å†…å­˜åŒºåŸŸã€‚æ–°åˆ†é…çš„ç¼“å†²åŒºçš„writerIndexçš„é»˜è®¤å€¼ä¸º0ã€‚ä»»ä½•åç§°ä»¥ write å¼€å¤´çš„æ“ä½œéƒ½å°†ä»å½“å‰çš„ writerIndex å¤„å¼€å§‹å†™æ•°æ®ï¼Œå¹¶å°†å®ƒå¢åŠ å·²ç»å†™å…¥çš„å­—èŠ‚æ•°ã€‚å¦‚æœå†™æ“ä½œçš„ç›®æ ‡ä¹Ÿæ˜¯ ByteBufï¼Œå¹¶ä¸”æ²¡æœ‰æŒ‡å®šæºç´¢å¼•çš„å€¼ï¼Œåˆ™æºç¼“å†²åŒºçš„ readerIndex ä¹ŸåŒæ ·ä¼šè¢«å¢åŠ ç›¸åŒçš„å¤§å°ã€‚è¿™ä¸ªè°ƒç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š<code>writeBytes(ByteBuf dest);</code></p>
<p>å¦‚æœå°è¯•å¾€ç›®æ ‡å†™å…¥è¶…è¿‡ç›®æ ‡å®¹é‡çš„æ•°æ®ï¼Œå°†ä¼šå¼•å‘ä¸€ä¸ªIndexOutOfBoundExceptionã€‚
åœ¨å¾€ ByteBuf ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œå…¶å°†é¦–å…ˆç¡®ä¿ç›®æ ‡ ByteBuf å…·æœ‰è¶³å¤Ÿçš„å¯å†™å…¥ç©ºé—´æ¥å®¹çº³å½“å‰è¦å†™å…¥
çš„æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å°†æ£€æŸ¥å½“å‰çš„å†™ç´¢å¼•ä»¥åŠæœ€å¤§å®¹é‡æ˜¯å¦å¯ä»¥åœ¨æ‰©å±•åå®¹çº³è¯¥æ•°æ®ï¼Œå¯ä»¥åˆ™ä¼šåˆ†é…å¹¶è°ƒæ•´å®¹é‡ï¼Œå¦åˆ™å°±ä¼šæŠ›å‡ºè¯¥å¼‚å¸¸ã€‚
ä»£ç æ¸…å•5-8 æ˜¯ä¸€ä¸ªç”¨éšæœºæ•´æ•°å€¼å¡«å……ç¼“å†²åŒºï¼Œç›´åˆ°å®ƒç©ºé—´ä¸è¶³ä¸ºæ­¢çš„ä¾‹å­ã€‚writeableBytes()
æ–¹æ³•åœ¨è¿™é‡Œè¢«ç”¨æ¥ç¡®å®šè¯¥ç¼“å†²åŒºä¸­æ˜¯å¦è¿˜æœ‰è¶³å¤Ÿçš„ç©ºé—´ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * ä»£ç æ¸…å• 5-8 å†™æ•°æ®
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>public static void write() {
</span></span><span style="display:flex;"><span>	// Fills the writable bytes of a buffer with random integers.
</span></span><span style="display:flex;"><span>	ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; //get reference form somewhere
</span></span><span style="display:flex;"><span>	while (buffer.writableBytes() &gt;= 4) {
</span></span><span style="display:flex;"><span>		buffer.writeInt(random.nextInt());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç´¢å¼•ç®¡ç†">ç´¢å¼•ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#ç´¢å¼•ç®¡ç†">#</a></h3>
<p>JDK çš„ InputStream å®šä¹‰äº† mark(int readlimit)å’Œ reset()æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åˆ†åˆ«è¢«ç”¨æ¥å°†æµä¸­çš„å½“å‰ä½ç½®æ ‡è®°ä¸ºæŒ‡å®šçš„å€¼ï¼Œä»¥åŠå°†æµé‡ç½®åˆ°è¯¥ä½ç½®ã€‚åŒæ ·ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ markReaderIndex()ã€markWriterIndex()ã€resetWriterIndex()å’Œ resetReaderIndex()æ¥æ ‡è®°å’Œé‡ç½® ByteBuf çš„ readerIndex å’Œ writerIndexã€‚
è¿™äº›å’ŒInputStream ä¸Šçš„è°ƒç”¨ç±»ä¼¼ï¼Œåªæ˜¯æ²¡æœ‰ readlimit å‚æ•°æ¥æŒ‡å®šæ ‡è®°ä»€ä¹ˆæ—¶å€™å¤±æ•ˆã€‚ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨readerIndex(int)æˆ–è€… writerIndex(int)æ¥å°†ç´¢å¼•ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®ã€‚è¯•å›¾å°†ä»»ä½•ä¸€ä¸ªç´¢å¼•è®¾ç½®åˆ°ä¸€ä¸ªæ— æ•ˆçš„ä½ç½®éƒ½å°†å¯¼è‡´ä¸€ä¸ª IndexOutOfBoundsExceptionã€‚å¯ä»¥é€šè¿‡è°ƒç”¨ clear()æ–¹æ³•æ¥å°† readerIndex å’ŒwriterIndex éƒ½è®¾ç½®ä¸º 0ã€‚æ³¨æ„ï¼Œè¿™å¹¶ä¸ä¼šæ¸…é™¤å†…å­˜ä¸­çš„å†…å®¹ã€‚
å›¾ 5-5ï¼ˆé‡å¤ä¸Šé¢çš„å›¾ 5-3ï¼‰å±•ç¤ºäº†å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/36.png"></p>
<p>å’Œä¹‹å‰ä¸€æ ·ï¼ŒByteBuf åŒ…å« 3 ä¸ªåˆ†æ®µã€‚å›¾ 5-6 å±•ç¤ºäº†åœ¨ clear()æ–¹æ³•è¢«è°ƒç”¨ä¹‹å ByteBufçš„çŠ¶æ€ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/38.png">
è°ƒç”¨ clear()æ¯”è°ƒç”¨ discardReadBytes()è½»é‡å¾—å¤šï¼Œå› ä¸ºå®ƒå°†åªæ˜¯é‡ç½®ç´¢å¼•è€Œä¸ä¼šå¤åˆ¶ä»»ä½•çš„å†…å­˜ã€‚</p>
<h3 id="æŸ¥æ‰¾æ“ä½œ">æŸ¥æ‰¾æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#æŸ¥æ‰¾æ“ä½œ">#</a></h3>
<p>åœ¨ByteBufä¸­æœ‰å¤šç§å¯ä»¥ç”¨æ¥ç¡®å®šæŒ‡å®šå€¼çš„ç´¢å¼•çš„æ–¹æ³•ã€‚æœ€ç®€å•çš„æ˜¯ä½¿ç”¨indexOf()æ–¹æ³•ã€‚è¾ƒå¤æ‚çš„æŸ¥æ‰¾å¯ä»¥é€šè¿‡é‚£äº›éœ€è¦ä¸€ä¸ªio.netty.util.ByteProcessorä¸ºå‚æ•°çš„æ–¹æ³•è¾¾æˆã€‚è¿™ä¸ªæ¥å£åªå®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•ï¼š
<code>boolean process(byte value)</code>
å®ƒå°†æ£€æŸ¥è¾“å…¥å€¼æ˜¯å¦æ˜¯æ­£åœ¨æŸ¥æ‰¾çš„å€¼ã€‚
ByteProcessoré’ˆå¯¹ä¸€äº›å¸¸è§çš„å€¼å®šä¹‰äº†è®¸å¤šä¾¿åˆ©çš„æ–¹æ³•ã€‚å‡è®¾ä½ çš„åº”ç”¨ç¨‹åºéœ€è¦å’Œæ‰€è°“çš„åŒ…å«æœ‰ä»¥NULLç»“å°¾çš„å†…å®¹çš„Flashå¥—æ¥å­—é›†æˆï¼Œè°ƒç”¨<code>forEachByte(ByteBufProcessor.FIND_NUL)</code>
å°†ç®€å•é«˜æ•ˆåœ°æ¶ˆè´¹è¯¥ Flash æ•°æ®ï¼Œå› ä¸ºåœ¨å¤„ç†æœŸé—´åªä¼šæ‰§è¡Œè¾ƒå°‘çš„è¾¹ç•Œæ£€æŸ¥ã€‚
ä»£ç æ¸…å• 5-9 å±•ç¤ºäº†ä¸€ä¸ªæŸ¥æ‰¾å›è½¦ç¬¦ï¼ˆ\rï¼‰çš„ä¾‹å­ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-9 ä½¿ç”¨ ByteBufProcessor æ¥å¯»æ‰¾\r
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * use {@link io.netty.util.ByteProcessor in Netty 4.0.x}
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteProcessor() {
</span></span><span style="display:flex;"><span>	ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">int</span> index = buffer.<span style="color:#007f7f">forEachByte</span>(ByteProcessor.<span style="color:#007f7f">FIND_CR</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨ï¼šByteBufProcessoråœ¨netty 4.1.xç‰ˆæœ¬å·²ç»åºŸå¼ƒã€‚</p>
<h3 id="æ´¾ç”Ÿç¼“å†²åŒº">æ´¾ç”Ÿç¼“å†²åŒº<a hidden class="anchor" aria-hidden="true" href="#æ´¾ç”Ÿç¼“å†²åŒº">#</a></h3>
<p>æ´¾ç”Ÿç¼“å†²åŒºä¸º ByteBuf æä¾›äº†ä»¥ä¸“é—¨çš„æ–¹å¼æ¥å‘ˆç°å…¶å†…å®¹çš„è§†å›¾ã€‚è¿™ç±»è§†å›¾æ˜¯é€šè¿‡ä»¥ä¸‹æ–¹æ³•è¢«åˆ›å»ºçš„ï¼š
duplicate()
slice()
slice(int, int)
Unpooled.unmodifiableBuffer(â€¦)
order(ByteOrder)
readSlice(int)</p>
<p>æ¯ä¸ªè¿™äº›æ–¹æ³•éƒ½å°†è¿”å›ä¸€ä¸ªæ–°çš„ ByteBuf å®ä¾‹ï¼Œå®ƒå…·æœ‰è‡ªå·±çš„è¯»ç´¢å¼•ã€å†™ç´¢å¼•å’Œæ ‡è®°ç´¢å¼•ã€‚å…¶å†…éƒ¨å­˜å‚¨å’ŒJDK çš„ ByteBuffer ä¸€æ ·ä¹Ÿæ˜¯å…±äº«çš„ã€‚è¿™ä½¿å¾—æ´¾ç”Ÿç¼“å†²åŒºçš„åˆ›å»ºæˆæœ¬æ˜¯å¾ˆä½å»‰çš„ï¼Œä½†æ˜¯è¿™ä¹Ÿæ„å‘³ç€ï¼Œå¦‚æœä½ ä¿®æ”¹äº†å®ƒçš„å†…å®¹ï¼Œä¹ŸåŒæ—¶ä¿®æ”¹äº†å…¶å¯¹åº”çš„æºå®ä¾‹ï¼Œæ‰€ä»¥è¦å°å¿ƒã€‚
ByteBuf å¤åˆ¶ï¼šå¦‚æœéœ€è¦ä¸€ä¸ªç°æœ‰ç¼“å†²åŒºçš„çœŸå®å‰¯æœ¬ï¼Œè¯·ä½¿ç”¨ copy()æˆ–è€… copy(int, int)æ–¹
æ³•ã€‚ä¸åŒäºæ´¾ç”Ÿç¼“å†²åŒºï¼Œç”±è¿™ä¸ªè°ƒç”¨æ‰€è¿”å›çš„ ByteBuf æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®å‰¯æœ¬ã€‚</p>
<p>ä»£ç æ¸…å• 5-10 å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ slice(int, int)æ–¹æ³•æ¥æ“ä½œ ByteBuf çš„ä¸€ä¸ªåˆ†æ®µã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-10 å¯¹ ByteBuf è¿›è¡Œåˆ‡ç‰‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufSlice() {
</span></span><span style="display:flex;"><span>	Charset utf8 = Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ªç”¨äºä¿å­˜ç»™å®šå­—ç¬¦ä¸²çš„å­—èŠ‚çš„ ByteBuf</span>
</span></span><span style="display:flex;"><span>	ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Netty in Action rocks!&#34;</span>, utf8);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//åˆ›å»ºè¯¥ ByteBuf ä»ç´¢å¼• 0 å¼€å§‹åˆ°ç´¢å¼• 15 ç»“æŸçš„ä¸€ä¸ªæ–°åˆ‡ç‰‡</span>
</span></span><span style="display:flex;"><span>	ByteBuf sliced = buf.<span style="color:#007f7f">slice</span>(0, 15);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å°†æ‰“å°â€œNetty in Actionâ€</span>
</span></span><span style="display:flex;"><span>	System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(sliced.<span style="color:#007f7f">toString</span>(utf8));
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//æ›´æ–°ç´¢å¼• 0 å¤„çš„å­—èŠ‚</span>
</span></span><span style="display:flex;"><span>	buf.<span style="color:#007f7f">setByte</span>(0, (<span style="color:#fff;font-weight:bold">byte</span>)<span style="color:#0ff;font-weight:bold">&#39;J&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å°†ä¼šæˆåŠŸï¼Œå› ä¸ºæ•°æ®æ˜¯å…±äº«çš„ï¼Œå¯¹å…¶ä¸­ä¸€ä¸ªæ‰€åšçš„æ›´æ”¹å¯¹å¦å¤–ä¸€ä¸ªä¹Ÿæ˜¯å¯è§çš„</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">assert</span> buf.<span style="color:#007f7f">getByte</span>(0) == sliced.<span style="color:#007f7f">getByte</span>(0);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ ByteBuf çš„åˆ†æ®µçš„å‰¯æœ¬å’Œåˆ‡ç‰‡æœ‰ä½•åŒºåˆ«ï¼Œå¦‚ä»£ç æ¸…å• 5-11 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-11 å¤åˆ¶ä¸€ä¸ª ByteBuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufCopy() {
</span></span><span style="display:flex;"><span>	Charset utf8 = Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//åˆ›å»º ByteBuf ä»¥ä¿å­˜æ‰€æä¾›çš„å­—ç¬¦ä¸²çš„å­—èŠ‚</span>
</span></span><span style="display:flex;"><span>	ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Netty in Action rocks!&#34;</span>, utf8);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//åˆ›å»ºè¯¥ ByteBuf ä»ç´¢å¼• 0 å¼€å§‹åˆ°ç´¢å¼• 15 ç»“æŸçš„åˆ†æ®µçš„å‰¯æœ¬</span>
</span></span><span style="display:flex;"><span>	ByteBuf copy = buf.<span style="color:#007f7f">copy</span>(0, 15);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å°†æ‰“å°â€œNetty in Actionâ€</span>
</span></span><span style="display:flex;"><span>	System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(copy.<span style="color:#007f7f">toString</span>(utf8));
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//æ›´æ–°ç´¢å¼• 0 å¤„çš„å­—èŠ‚</span>
</span></span><span style="display:flex;"><span>	buf.<span style="color:#007f7f">setByte</span>(0, (<span style="color:#fff;font-weight:bold">byte</span>)<span style="color:#0ff;font-weight:bold">&#39;J&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å°†ä¼šæˆåŠŸï¼Œå› ä¸ºæ•°æ®ä¸æ˜¯å…±äº«çš„</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">assert</span> buf.<span style="color:#007f7f">getByte</span>(0) != copy.<span style="color:#007f7f">getByte</span>(0);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é™¤äº†ä¿®æ”¹åŸå§‹ ByteBuf çš„åˆ‡ç‰‡æˆ–è€…å‰¯æœ¬çš„æ•ˆæœä»¥å¤–ï¼Œè¿™ä¸¤ç§åœºæ™¯æ˜¯ç›¸åŒçš„ã€‚
åªè¦æœ‰å¯èƒ½ï¼Œä½¿ç”¨slice()æ–¹æ³•æ¥é¿å…å¤åˆ¶å†…å­˜çš„å¼€é”€ã€‚</p>
<h3 id="è¯»å†™æ“ä½œ">è¯»/å†™æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#è¯»å†™æ“ä½œ">#</a></h3>
<p>ByteBufæœ‰ä¸¤ç§è¯»å†™æ“ä½œã€‚
get()å’Œ set()æ“ä½œï¼Œä»ç»™å®šçš„ç´¢å¼•å¼€å§‹ï¼Œå¹¶ä¸”ä¿æŒç´¢å¼•ä¸å˜ã€‚
read()å’Œ write()æ“ä½œï¼Œä»ç»™å®šçš„ç´¢å¼•å¼€å§‹ï¼Œå¹¶ä¸”ä¼šæ ¹æ®å·²ç»è®¿é—®è¿‡çš„å­—èŠ‚æ•°å¯¹ç´¢å¼•è¿›è¡Œè°ƒæ•´ã€‚</p>
<p>è¡¨ 5-1 åˆ—ä¸¾äº†æœ€å¸¸ç”¨çš„ get()æ–¹æ³•ã€‚å®Œæ•´åˆ—è¡¨è¯·å‚è€ƒå¯¹åº”çš„ API æ–‡æ¡£ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>getBoolean(int)</td>
<td>è¿”å›ç»™å®šç´¢å¼•å¤„çš„ Boolean å€¼</td>
</tr>
<tr>
<td>getByte(int)</td>
<td>è¿”å›ç»™å®šç´¢å¼•å¤„çš„å­—èŠ‚</td>
</tr>
<tr>
<td>getUnsignedByte(int)</td>
<td>å°†ç»™å®šç´¢å¼•å¤„çš„æ— ç¬¦å·å­—èŠ‚å€¼ä½œä¸º short è¿”å›</td>
</tr>
<tr>
<td>getMedium(int</td>
<td>è¿”å›ç»™å®šç´¢å¼•å¤„çš„ 24 ä½çš„ä¸­ç­‰ int å€¼</td>
</tr>
<tr>
<td>getUnsignedMedium(int</td>
<td>è¿”å›ç»™å®šç´¢å¼•å¤„çš„æ— ç¬¦å·çš„ 24 ä½çš„ä¸­ç­‰ int å€¼</td>
</tr>
<tr>
<td>getInt(int)</td>
<td>è¿”å›ç»™å®šç´¢å¼•å¤„çš„ int å€¼</td>
</tr>
<tr>
<td>getUnsignedInt(int)</td>
<td>å°†ç»™å®šç´¢å¼•å¤„çš„æ— ç¬¦å· int å€¼ä½œä¸º long è¿”å›</td>
</tr>
<tr>
<td>getLong(int)</td>
<td>è¿”å›ç»™å®šç´¢å¼•å¤„çš„ long å€¼</td>
</tr>
<tr>
<td>getShort(int)</td>
<td>è¿”å›ç»™å®šç´¢å¼•å¤„çš„ short å€¼</td>
</tr>
<tr>
<td>getUnsignedShort(int)</td>
<td>å°†ç»™å®šç´¢å¼•å¤„çš„æ— ç¬¦å· short å€¼ä½œä¸º int è¿”å›</td>
</tr>
<tr>
<td>getBytes(int, &hellip;)</td>
<td>å°†è¯¥ç¼“å†²åŒºä¸­ä»ç»™å®šç´¢å¼•å¼€å§‹çš„æ•°æ®ä¼ é€åˆ°æŒ‡å®šçš„ç›®çš„åœ°</td>
</tr>
</tbody>
</table>
<p>ä¸Šè¾¹çš„å¤§å¤šæ•°çš„è¿™äº›æ“ä½œéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ set()æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•åœ¨è¡¨ 5-2 ä¸­åˆ—å‡ºã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>setBoolean(int, boolean)</td>
<td>è®¾å®šç»™å®šç´¢å¼•å¤„çš„ Boolean å€¼</td>
</tr>
<tr>
<td>setByte(int index, int value)</td>
<td>è®¾å®šç»™å®šç´¢å¼•å¤„çš„å­—èŠ‚å€¼</td>
</tr>
<tr>
<td>setMedium(int index, int value)</td>
<td>è®¾å®šç»™å®šç´¢å¼•å¤„çš„ 24 ä½çš„ä¸­ç­‰ int å€¼</td>
</tr>
<tr>
<td>setInt(int index, int value)</td>
<td>è®¾å®šç»™å®šç´¢å¼•å¤„çš„ int å€¼</td>
</tr>
<tr>
<td>setLong(int index, long value)</td>
<td>è®¾å®šç»™å®šç´¢å¼•å¤„çš„ long å€¼</td>
</tr>
<tr>
<td>setShort(int index, int value)</td>
<td>è®¾å®šç»™å®šç´¢å¼•å¤„çš„ short å€¼</td>
</tr>
</tbody>
</table>
<p>ä»£ç æ¸…å• 5-12 è¯´æ˜äº† get()å’Œ set()æ–¹æ³•çš„ç”¨æ³•ï¼Œè¡¨æ˜äº†å®ƒä»¬ä¸ä¼šæ”¹å˜è¯»ç´¢å¼•å’Œå†™ç´¢å¼•ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-12 get()å’Œ set()æ–¹æ³•çš„ç”¨æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufSetGet() {
</span></span><span style="display:flex;"><span>	Charset utf8 = Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ªæ–°çš„ ByteBufä»¥ä¿å­˜ç»™å®šå­—ç¬¦ä¸²çš„å­—èŠ‚</span>
</span></span><span style="display:flex;"><span>	ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Netty in Action rocks!&#34;</span>, utf8);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//æ‰“å°ç¬¬ä¸€ä¸ªå­—ç¬¦&#39;N&#39;</span>
</span></span><span style="display:flex;"><span>	System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>((<span style="color:#fff;font-weight:bold">char</span>)buf.<span style="color:#007f7f">getByte</span>(0));
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å­˜å‚¨å½“å‰çš„ readerIndex å’Œ writerIndex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">int</span> readerIndex = buf.<span style="color:#007f7f">readerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">int</span> writerIndex = buf.<span style="color:#007f7f">writerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å°†ç´¢å¼• 0 å¤„çš„å­— èŠ‚æ›´æ–°ä¸ºå­—ç¬¦&#39;B&#39;</span>
</span></span><span style="display:flex;"><span>	buf.<span style="color:#007f7f">setByte</span>(0, (<span style="color:#fff;font-weight:bold">byte</span>)<span style="color:#0ff;font-weight:bold">&#39;B&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//æ‰“å°ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œç°åœ¨æ˜¯&#39;B&#39;</span>
</span></span><span style="display:flex;"><span>	System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>((<span style="color:#fff;font-weight:bold">char</span>)buf.<span style="color:#007f7f">getByte</span>(0));
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å°†ä¼šæˆåŠŸï¼Œå› ä¸ºè¿™äº›æ“ä½œå¹¶ä¸ä¼šä¿®æ”¹ç›¸åº”çš„ç´¢å¼•</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">assert</span> readerIndex == buf.<span style="color:#007f7f">readerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">assert</span> writerIndex == buf.<span style="color:#007f7f">writerIndex</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹ read()æ“ä½œï¼Œå…¶ä½œç”¨äºå½“å‰çš„ readerIndex æˆ– writerIndexã€‚
è¿™äº›æ–¹æ³•å°†ç”¨äºä» ByteBuf ä¸­è¯»å–æ•°æ®ï¼Œå¦‚åŒå®ƒæ˜¯ä¸€ä¸ªæµã€‚è¡¨ 5-3 å±•ç¤ºäº†æœ€å¸¸ç”¨çš„æ–¹æ³•ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>readBoolean()</td>
<td>è¿”å›å½“å‰ readerIndex å¤„çš„ Booleanï¼Œå¹¶å°† readerIndex å¢åŠ  1</td>
</tr>
<tr>
<td>readByte()</td>
<td>è¿”å›å½“å‰ readerIndex å¤„çš„å­—èŠ‚ï¼Œå¹¶å°† readerIndex å¢åŠ  1</td>
</tr>
<tr>
<td>readUnsignedByte()</td>
<td>å°†å½“å‰ readerIndex å¤„çš„æ— ç¬¦å·å­—èŠ‚å€¼ä½œä¸º short è¿”å›ï¼Œå¹¶å°† readerIndex å¢åŠ  1</td>
</tr>
<tr>
<td>readMedium()</td>
<td>è¿”å›å½“å‰ readerIndex å¤„çš„ 24 ä½çš„ä¸­ç­‰ int å€¼ï¼Œå¹¶å°† readerIndex å¢åŠ  3</td>
</tr>
<tr>
<td>readUnsignedMedium()</td>
<td>è¿”å›å½“å‰ readerIndex å¤„çš„ 24 ä½çš„æ— ç¬¦å·çš„ä¸­ç­‰ int å€¼ï¼Œå¹¶å°† readerIndex å¢åŠ  3</td>
</tr>
<tr>
<td>readInt()</td>
<td>è¿”å›å½“å‰ readerIndex çš„ int å€¼ï¼Œå¹¶å°† readerIndex å¢åŠ  4</td>
</tr>
<tr>
<td>readUnsignedInt()</td>
<td>å°†å½“å‰ readerIndex å¤„çš„æ— ç¬¦å·çš„ int å€¼ä½œä¸º long å€¼è¿”å›ï¼Œå¹¶å°† readerIndex å¢åŠ  4</td>
</tr>
<tr>
<td>readLong()</td>
<td>è¿”å›å½“å‰ readerIndex å¤„çš„ long å€¼ï¼Œå¹¶å°† readerIndex å¢åŠ  8</td>
</tr>
<tr>
<td>readShort()</td>
<td>è¿”å›å½“å‰ readerIndex å¤„çš„ short å€¼ï¼Œå¹¶å°† readerIndex å¢åŠ  2</td>
</tr>
<tr>
<td>readUnsignedShort()</td>
<td>å°†å½“å‰ readerIndex å¤„çš„æ— ç¬¦å· short å€¼ä½œä¸º int å€¼è¿”å›ï¼Œå¹¶å°† readerIndex å¢åŠ  2</td>
</tr>
<tr>
<td>readBytes(ByteBuf byte[] destination, int dstIndex [,int length])</td>
<td>å°†å½“å‰ ByteBuf ä¸­ä»å½“å‰ readerIndex å¤„å¼€å§‹çš„ï¼ˆå¦‚æœè®¾ç½®äº†ï¼Œ length é•¿åº¦çš„å­—èŠ‚ï¼‰æ•°æ®ä¼ é€åˆ°ä¸€ä¸ªç›®æ ‡ ByteBuf æˆ–è€… byte[]ï¼Œä» ç›®æ ‡çš„ dstIndex å¼€å§‹çš„ä½ç½®ã€‚æœ¬åœ°çš„ readerIndex å°†è¢«å¢åŠ å·²ç»ä¼  è¾“çš„å­—èŠ‚æ•°</td>
</tr>
</tbody>
</table>
<p>å‡ ä¹æ¯ä¸ª read()æ–¹æ³•éƒ½æœ‰å¯¹åº”çš„ write()æ–¹æ³•ï¼Œç”¨äºå°†æ•°æ®è¿½åŠ åˆ° ByteBuf ä¸­ã€‚æ³¨æ„ï¼Œ
è¡¨ 5-4 ä¸­æ‰€åˆ—å‡ºçš„è¿™äº›æ–¹æ³•çš„å‚æ•°æ˜¯éœ€è¦å†™å…¥çš„å€¼ï¼Œè€Œä¸æ˜¯ç´¢å¼•å€¼ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>writeBoolean(boolean)</td>
<td>åœ¨å½“å‰ writerIndex å¤„å†™å…¥ä¸€ä¸ª Booleanï¼Œå¹¶å°† writerIndex å¢åŠ  1</td>
</tr>
<tr>
<td>writeByte(int)</td>
<td>åœ¨å½“å‰ writerIndex å¤„å†™å…¥ä¸€ä¸ªå­—èŠ‚å€¼ï¼Œå¹¶å°† writerIndex å¢åŠ  1</td>
</tr>
<tr>
<td>writeMedium(int)</td>
<td>åœ¨å½“å‰ writerIndex å¤„å†™å…¥ä¸€ä¸ªä¸­ç­‰çš„ int å€¼ï¼Œå¹¶å°† writerIndex å¢åŠ  3</td>
</tr>
<tr>
<td>writeInt(int)</td>
<td>åœ¨å½“å‰ writerIndex å¤„å†™å…¥ä¸€ä¸ª int å€¼ï¼Œå¹¶å°† writerIndex å¢åŠ  4</td>
</tr>
<tr>
<td>writeLong(long)</td>
<td>åœ¨å½“å‰ writerIndex å¤„å†™å…¥ä¸€ä¸ª long å€¼ï¼Œå¹¶å°† writerIndex å¢åŠ  8</td>
</tr>
<tr>
<td>writeShort(int)</td>
<td>åœ¨å½“å‰ writerIndex å¤„å†™å…¥ä¸€ä¸ª short å€¼ï¼Œå¹¶å°† writerIndex å¢åŠ  2</td>
</tr>
<tr>
<td>writeBytes(source ByteBuf byte[] [,int srcIndex ,int length])</td>
<td>ä»å½“å‰ writerIndex å¼€å§‹ï¼Œä¼ è¾“æ¥è‡ªäºæŒ‡å®šæºï¼ˆByteBuf æˆ–è€… byte[]ï¼‰ çš„æ•°æ®ã€‚å¦‚æœæä¾›äº† srcIndex å’Œ lengthï¼Œåˆ™ä» srcIndex å¼€å§‹è¯»å–ï¼Œ å¹¶ä¸”å¤„ç†é•¿åº¦ä¸º length çš„å­—èŠ‚ã€‚å½“å‰ writerIndex å°†ä¼šè¢«å¢åŠ æ‰€å†™å…¥ çš„å­—èŠ‚æ•°</td>
</tr>
</tbody>
</table>
<p>ä»£ç æ¸…å• 5-13 å±•ç¤ºäº†è¿™äº›æ–¹æ³•çš„ç”¨æ³•ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-13 ByteBuf ä¸Šçš„ read()å’Œ write()æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufWriteRead() {
</span></span><span style="display:flex;"><span>	Charset utf8 = Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ªæ–°çš„ ByteBuf ä»¥ä¿å­˜ç»™å®šå­—ç¬¦ä¸²çš„å­—èŠ‚</span>
</span></span><span style="display:flex;"><span>	ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Netty in Action rocks!&#34;</span>, utf8);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//æ‰“å°ç¬¬ä¸€ä¸ªå­—ç¬¦&#39;N&#39;</span>
</span></span><span style="display:flex;"><span>	System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>((<span style="color:#fff;font-weight:bold">char</span>)buf.<span style="color:#007f7f">readByte</span>());
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å­˜å‚¨å½“å‰çš„readerIndex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">int</span> readerIndex = buf.<span style="color:#007f7f">readerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å­˜å‚¨å½“å‰çš„writerIndex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">int</span> writerIndex = buf.<span style="color:#007f7f">writerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å°†å­—ç¬¦ &#39;?&#39;è¿½åŠ åˆ°ç¼“å†²åŒº</span>
</span></span><span style="display:flex;"><span>	buf.<span style="color:#007f7f">writeByte</span>((<span style="color:#fff;font-weight:bold">byte</span>)<span style="color:#0ff;font-weight:bold">&#39;?&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">assert</span> readerIndex == buf.<span style="color:#007f7f">readerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å°†ä¼šæˆåŠŸï¼Œå› ä¸º writeByte()æ–¹æ³•ç§»åŠ¨äº† writerIndex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">assert</span> writerIndex != buf.<span style="color:#007f7f">writerIndex</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bytebufå…¶ä»–æ“ä½œ">byteBufå…¶ä»–æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#bytebufå…¶ä»–æ“ä½œ">#</a></h3>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>isReadable()</td>
<td>å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªå­—èŠ‚å¯ä¾›è¯»å–ï¼Œåˆ™è¿”å› true</td>
</tr>
<tr>
<td>isWritable()</td>
<td>å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªå­—èŠ‚å¯è¢«å†™å…¥ï¼Œåˆ™è¿”å› true</td>
</tr>
<tr>
<td>readableBytes()</td>
<td>è¿”å›å¯è¢«è¯»å–çš„å­—èŠ‚æ•°</td>
</tr>
<tr>
<td>writableBytes()</td>
<td>è¿”å›å¯è¢«å†™å…¥çš„å­—èŠ‚æ•°</td>
</tr>
<tr>
<td>capacity()</td>
<td>è¿”å› ByteBuf å¯å®¹çº³çš„å­—èŠ‚æ•°ã€‚åœ¨æ­¤ä¹‹åï¼Œå®ƒä¼šå°è¯•å†æ¬¡æ‰©å±•ç›´ åˆ°è¾¾åˆ° maxCapacity()</td>
</tr>
<tr>
<td>maxCapacity()</td>
<td>è¿”å› ByteBuf å¯ä»¥å®¹çº³çš„æœ€å¤§å­—èŠ‚æ•°</td>
</tr>
<tr>
<td>hasArray()</td>
<td>å¦‚æœ ByteBuf ç”±ä¸€ä¸ªå­—èŠ‚æ•°ç»„æ”¯æ’‘ï¼Œåˆ™è¿”å› true</td>
</tr>
<tr>
<td>array()</td>
<td>å¦‚æœ ByteBuf ç”±ä¸€ä¸ªå­—èŠ‚æ•°ç»„æ”¯æ’‘åˆ™è¿”å›è¯¥æ•°ç»„ï¼›å¦åˆ™ï¼Œå®ƒå°†æŠ›å‡ºä¸€ä¸ª UnsupportedOperationException å¼‚å¸¸</td>
</tr>
</tbody>
</table>
<h2 id="bytebufholder-æ¥å£">ByteBufHolder æ¥å£<a hidden class="anchor" aria-hidden="true" href="#bytebufholder-æ¥å£">#</a></h2>
<p>æˆ‘ä»¬ç»å¸¸å‘ç°ï¼Œé™¤äº†å®é™…çš„æ•°æ®è´Ÿè½½ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å­˜å‚¨å„ç§å±æ€§å€¼ã€‚HTTP å“åº”ä¾¿æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œé™¤äº†è¡¨ç¤ºä¸ºå­—èŠ‚çš„å†…å®¹ï¼Œè¿˜åŒ…æ‹¬çŠ¶æ€ç ã€cookie ç­‰ã€‚ä¸ºäº†å¤„ç†è¿™ç§å¸¸è§çš„ç”¨ä¾‹ï¼ŒNetty æä¾›äº†ByteBufHolderã€‚ByteBufHolder ä¹Ÿä¸º Netty çš„é«˜çº§ç‰¹æ€§æä¾›äº†æ”¯æŒï¼Œå¦‚ç¼“å†²åŒºæ± åŒ–ï¼Œå…¶ä¸­å¯ä»¥ä»æ± ä¸­å€Ÿç”¨ ByteBufï¼Œå¹¶ä¸”åœ¨éœ€è¦æ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚ByteBufHolder åªæœ‰å‡ ç§ç”¨äºè®¿é—®åº•å±‚æ•°æ®å’Œå¼•ç”¨è®¡æ•°çš„æ–¹æ³•ã€‚è¡¨ 5-6 åˆ—å‡ºäº†å®ƒä»¬ï¼ˆè¿™é‡Œä¸åŒ…æ‹¬å®ƒç»§æ‰¿è‡ª ReferenceCounted çš„é‚£äº›æ–¹æ³•ï¼‰ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>content()</td>
<td>è¿”å›ç”±è¿™ä¸ª ByteBufHolder æ‰€æŒæœ‰çš„ ByteBuf</td>
</tr>
<tr>
<td>copy()</td>
<td>è¿”å›è¿™ä¸ª ByteBufHolder çš„ä¸€ä¸ªæ·±æ‹·è´ï¼ŒåŒ…æ‹¬ä¸€ä¸ªå…¶æ‰€åŒ…å«çš„ ByteBuf çš„éå…±äº«æ‹·è´</td>
</tr>
<tr>
<td>duplicate()</td>
<td>è¿”å›è¿™ä¸ª ByteBufHolder çš„ä¸€ä¸ªæµ…æ‹·è´ï¼ŒåŒ…æ‹¬ä¸€ä¸ªå…¶æ‰€åŒ…å«çš„ ByteBuf çš„å…±äº«æ‹·è´</td>
</tr>
</tbody>
</table>
<p>å¦‚æœæƒ³è¦å®ç°ä¸€ä¸ªå°†å…¶æœ‰æ•ˆè´Ÿè½½å­˜å‚¨åœ¨ ByteBuf ä¸­çš„æ¶ˆæ¯å¯¹è±¡ï¼Œé‚£ä¹ˆ ByteBufHolder å°†æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
<h2 id="bytebufåˆ†é…ç®¡ç†">ByteBufåˆ†é…(ç®¡ç†)<a hidden class="anchor" aria-hidden="true" href="#bytebufåˆ†é…ç®¡ç†">#</a></h2>
<h3 id="æŒ‰éœ€åˆ†é…bytebufallocator-æ¥å£">æŒ‰éœ€åˆ†é…ï¼šByteBufAllocator æ¥å£<a hidden class="anchor" aria-hidden="true" href="#æŒ‰éœ€åˆ†é…bytebufallocator-æ¥å£">#</a></h3>
<p>ä¸ºäº†é™ä½åˆ†é…å’Œé‡Šæ”¾å†…å­˜çš„å¼€é”€ï¼ŒNetty é€šè¿‡ interface ByteBufAllocator å®ç°äº†ï¼ˆByteBuf çš„ï¼‰æ± åŒ–ï¼Œå®ƒå¯ä»¥ç”¨æ¥åˆ†é…æˆ‘ä»¬æ‰€æè¿°è¿‡çš„ä»»æ„ç±»å‹çš„ ByteBuf å®ä¾‹ã€‚ä½¿ç”¨æ± åŒ–æ˜¯ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„å†³å®šï¼Œå…¶å¹¶ä¸ä¼šä»¥ä»»ä½•æ–¹å¼æ”¹å˜ ByteBuf APIï¼ˆçš„è¯­ä¹‰ï¼‰ã€‚</p>
<p>è¡¨ 5-7 åˆ—å‡ºäº† ByteBufAllocator æä¾›çš„ä¸€äº›æ“ä½œã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>buffer() buffer(int initialCapacity); buffer(int initialCapacity, int maxCapacity);</td>
<td>è¿”å›ä¸€ä¸ªåŸºäºå †æˆ–è€…ç›´æ¥å†…å­˜ å­˜å‚¨çš„ ByteBuf</td>
</tr>
<tr>
<td>heapBuffer() heapBuffer(int initialCapacity) heapBuffer(int initialCapacity, int maxCapacity)</td>
<td>è¿”å›ä¸€ä¸ªåŸºäºå †å†…å­˜å­˜å‚¨çš„ ByteBuf</td>
</tr>
<tr>
<td>directBuffer() directBuffer(int initialCapacity) directBuffer(int initialCapacity, int maxCapacity)</td>
<td>è¿”å›ä¸€ä¸ªåŸºäºç›´æ¥å†…å­˜å­˜å‚¨çš„ ByteBuf</td>
</tr>
<tr>
<td>compositeBuffer() compositeBuffer(int maxNumComponents) compositeDirectBuffer() compositeDirectBuffer(int maxNumComponents); compositeHeapBuffer() compositeHeapBuffer(int maxNumComponents);</td>
<td>è¿”å›ä¸€ä¸ªå¯ä»¥é€šè¿‡æ·»åŠ æœ€å¤§åˆ° æŒ‡å®šæ•°ç›®çš„åŸºäºå †çš„æˆ–è€…ç›´æ¥ å†…å­˜å­˜å‚¨çš„ç¼“å†²åŒºæ¥æ‰©å±•çš„ CompositeByteBuf</td>
</tr>
<tr>
<td>ioBuffer()</td>
<td>è¿”å›ä¸€ä¸ªç”¨äºå¥—æ¥å­—çš„ I/O æ“ ä½œçš„ ByteBuf</td>
</tr>
</tbody>
</table>
<p>å¯ä»¥é€šè¿‡ Channelï¼ˆæ¯ä¸ªéƒ½å¯ä»¥æœ‰ä¸€ä¸ªä¸åŒçš„ ByteBufAllocator å®ä¾‹ï¼‰æˆ–è€…ç»‘å®šåˆ°ChannelHandler
çš„ ChannelHandlerContext è·å–ä¸€ä¸ªåˆ° ByteBufAllocator çš„å¼•ç”¨ã€‚
ä»£ç æ¸…å• 5-14 è¯´æ˜äº†è¿™ä¸¤ç§æ–¹æ³•ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-14 è·å–ä¸€ä¸ªåˆ° ByteBufAllocator çš„å¼•ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> obtainingByteBufAllocatorReference(){
</span></span><span style="display:flex;"><span>	Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//ä» Channel è·å–ä¸€ä¸ªåˆ°ByteBufAllocator çš„å¼•ç”¨</span>
</span></span><span style="display:flex;"><span>	ByteBufAllocator allocator = channel.<span style="color:#007f7f">alloc</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>	ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//ä» ChannelHandlerContext è·å–ä¸€ä¸ªåˆ° ByteBufAllocator çš„å¼•ç”¨</span>
</span></span><span style="display:flex;"><span>	ByteBufAllocator allocator2 = ctx.<span style="color:#007f7f">alloc</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Nettyæä¾›äº†ä¸¤ç§ByteBufAllocatorçš„å®ç°ï¼šPooledByteBufAllocatorå’ŒUnpooledByteBufAllocatorã€‚
å‰è€…æ± åŒ–äº†ByteBufçš„å®ä¾‹ä»¥æé«˜æ€§èƒ½å¹¶æœ€å¤§é™åº¦åœ°å‡å°‘å†…å­˜ç¢ç‰‡ã€‚æ­¤å®ç°ä½¿ç”¨äº†ä¸€ç§ç§°ä¸ºjemallocçš„å·²è¢«å¤§é‡ç°ä»£æ“ä½œç³»ç»Ÿæ‰€é‡‡ç”¨çš„é«˜æ•ˆæ–¹æ³•æ¥åˆ†é…å†…å­˜ã€‚åè€…çš„å®ç°ä¸æ± åŒ–ByteBufå®ä¾‹ï¼Œå¹¶ä¸”åœ¨æ¯æ¬¡å®ƒè¢«è°ƒç”¨æ—¶éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚è™½ç„¶Nettyé»˜è®¤ä½¿ç”¨äº†PooledByteBufAllocatorï¼Œä½†è¿™å¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡ChannelConfigAPIæˆ–è€…åœ¨å¼•å¯¼ä½ çš„åº”ç”¨ç¨‹åºæ—¶æŒ‡å®šä¸€ä¸ªä¸åŒçš„åˆ†é…å™¨æ¥æ›´æ”¹ã€‚</p>
<h3 id="unpooled-ç¼“å†²åŒº">Unpooled ç¼“å†²åŒº<a hidden class="anchor" aria-hidden="true" href="#unpooled-ç¼“å†²åŒº">#</a></h3>
<p>å¯èƒ½æŸäº›æƒ…å†µä¸‹ï¼Œä½ æœªèƒ½è·å–ä¸€ä¸ªåˆ° ByteBufAllocator çš„å¼•ç”¨ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼ŒNetty æä¾›äº†ä¸€ä¸ªç®€å•çš„ç§°ä¸º Unpooled çš„å·¥å…·ç±»ï¼Œå®ƒæä¾›äº†é™æ€çš„è¾…åŠ©æ–¹æ³•æ¥åˆ›å»ºæœªæ± åŒ–çš„ ByteBufå®ä¾‹ã€‚
è¡¨ 5-8 åˆ—ä¸¾äº†è¿™äº›ä¸­æœ€é‡è¦çš„æ–¹æ³•ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>buffer() buffer(int initialCapacity) buffer(int initialCapacity, int maxCapacity)</td>
<td>è¿”å›ä¸€ä¸ªæœªæ± åŒ–çš„åŸºäºå †å†…å­˜å­˜å‚¨çš„ ByteBuf</td>
</tr>
<tr>
<td>directBuffer() directBuffer(int initialCapacity) directBuffer(int initialCapacity, int maxCapacity)</td>
<td>è¿”å›ä¸€ä¸ªæœªæ± åŒ–çš„åŸºäºç›´æ¥å†…å­˜å­˜å‚¨ çš„ ByteBuf</td>
</tr>
<tr>
<td>wrappedBuffer()</td>
<td>è¿”å›ä¸€ä¸ªåŒ…è£…äº†ç»™å®šæ•°æ®çš„ ByteBuf</td>
</tr>
<tr>
<td>copiedBuffer()</td>
<td>è¿”å›ä¸€ä¸ªå¤åˆ¶äº†ç»™å®šæ•°æ®çš„ ByteBuf</td>
</tr>
</tbody>
</table>
<p>Unpooled ç±»è¿˜ä½¿å¾— ByteBuf åŒæ ·å¯ç”¨äºé‚£äº›å¹¶ä¸éœ€è¦ Netty çš„å…¶ä»–ç»„ä»¶çš„éç½‘ç»œé¡¹ç›®ï¼Œä½¿å¾—å…¶èƒ½å¾—ç›Šäºé«˜æ€§èƒ½çš„å¯æ‰©å±•çš„ç¼“å†²åŒº APIã€‚</p>
<h3 id="bytebufutil-ç±»">ByteBufUtil ç±»<a hidden class="anchor" aria-hidden="true" href="#bytebufutil-ç±»">#</a></h3>
<p>ByteBufUtil æä¾›äº†ç”¨äºæ“ä½œ ByteBuf çš„é™æ€çš„è¾…åŠ©æ–¹æ³•ã€‚å› ä¸ºè¿™ä¸ª API æ˜¯é€šç”¨çš„ï¼Œå¹¶ä¸”å’Œæ± åŒ–æ— å…³ï¼Œæ‰€ä»¥è¿™äº›æ–¹æ³•å·²ç„¶åœ¨åˆ†é…ç±»çš„å¤–éƒ¨å®ç°ã€‚è¿™äº›é™æ€æ–¹æ³•ä¸­æœ€æœ‰ä»·å€¼çš„å¯èƒ½å°±æ˜¯ hexdump()æ–¹æ³•ï¼Œå®ƒä»¥åå…­è¿›åˆ¶çš„è¡¨ç¤ºå½¢å¼æ‰“å°ByteBuf çš„å†…å®¹ã€‚è¿™åœ¨å„ç§æƒ…å†µä¸‹éƒ½å¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚ï¼Œå‡ºäºè°ƒè¯•çš„ç›®çš„è®°å½• ByteBuf çš„å†…å®¹ã€‚åå…­è¿›åˆ¶çš„è¡¨ç¤ºé€šå¸¸ä¼šæä¾›ä¸€ä¸ªæ¯”å­—èŠ‚å€¼çš„ç›´æ¥è¡¨ç¤ºå½¢å¼æ›´åŠ æœ‰ç”¨çš„æ—¥å¿—æ¡ç›®ï¼Œæ­¤å¤–ï¼Œåå…­è¿›åˆ¶çš„ç‰ˆæœ¬è¿˜å¯ä»¥å¾ˆå®¹æ˜“åœ°è½¬æ¢å›å®é™…çš„å­—èŠ‚è¡¨ç¤ºã€‚å¦ä¸€ä¸ªæœ‰ç”¨çš„æ–¹æ³•æ˜¯ boolean equals(ByteBuf, ByteBuf)ï¼Œå®ƒè¢«ç”¨æ¥åˆ¤æ–­ä¸¤ä¸ª ByteBufå®ä¾‹çš„ç›¸ç­‰æ€§ã€‚å¦‚æœä½ å®ç°è‡ªå·±çš„ ByteBuf å­ç±»ï¼Œä½ å¯èƒ½ä¼šå‘ç° ByteBufUtil çš„å…¶ä»–æœ‰ç”¨æ–¹æ³•ã€‚</p>
<h2 id="å¼•ç”¨è®¡æ•°æ³•">å¼•ç”¨è®¡æ•°æ³•<a hidden class="anchor" aria-hidden="true" href="#å¼•ç”¨è®¡æ•°æ³•">#</a></h2>
<p>å¼•ç”¨è®¡æ•°æ˜¯ä¸€ç§é€šè¿‡åœ¨æŸä¸ªå¯¹è±¡æ‰€æŒæœ‰çš„èµ„æºä¸å†è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨æ—¶é‡Šæ”¾è¯¥å¯¹è±¡æ‰€æŒæœ‰çš„èµ„æºæ¥ä¼˜åŒ–å†…å­˜ä½¿ç”¨å’Œæ€§èƒ½çš„æŠ€æœ¯ã€‚ã€‚Netty åœ¨ç¬¬ 4 ç‰ˆä¸­ä¸º ByteBuf å’Œ ByteBufHolder å¼•å…¥äº†å¼•ç”¨è®¡æ•°æŠ€æœ¯ï¼Œå®ƒä»¬éƒ½å®ç°äº†interface ReferenceCountedã€‚
å¼•ç”¨è®¡æ•°æ³•å¹¶ä¸å¤æ‚ï¼Œå®ƒä¸»è¦æ¶‰åŠè·Ÿè¸ªåˆ°æŸä¸ªç‰¹å®šå¯¹è±¡çš„æ´»åŠ¨å¼•ç”¨çš„æ•°é‡ã€‚ä¸€ä¸ª ReferenceCounted å®ç°çš„å®ä¾‹å°†é€šå¸¸ä»¥æ´»åŠ¨çš„å¼•ç”¨è®¡æ•°ä¸º 1 ä½œä¸ºå¼€å§‹ã€‚åªè¦å¼•ç”¨è®¡æ•°å¤§äº 0ï¼Œå°±èƒ½ä¿è¯å¯¹è±¡ä¸ä¼šè¢«é‡Šæ”¾ã€‚å½“æ´»åŠ¨å¼•ç”¨çš„æ•°é‡å‡å°‘åˆ° 0 æ—¶ï¼Œè¯¥å®ä¾‹å°±ä¼šè¢«é‡Šæ”¾ã€‚æ³¨æ„ï¼Œè™½ç„¶é‡Šæ”¾çš„ç¡®åˆ‡è¯­ä¹‰å¯èƒ½æ˜¯ç‰¹å®šäºå®ç°çš„ï¼Œä½†æ˜¯è‡³å°‘å·²ç»é‡Šæ”¾çš„å¯¹è±¡åº”è¯¥ä¸å¯å†ç”¨äº†ã€‚
å¼•ç”¨è®¡æ•°å¯¹äºæ± åŒ–å®ç°ï¼ˆå¦‚ PooledByteBufAllocatorï¼‰æ¥è¯´æ˜¯è‡³å…³é‡è¦çš„ï¼Œå®ƒé™ä½äº†å†…å­˜åˆ†é…çš„å¼€é”€ã€‚ä»£ç æ¸…å• 5-15 å’Œä»£ç æ¸…å• 5-16 å±•ç¤ºäº†ç›¸å…³çš„ç¤ºä¾‹ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-15 å¼•ç”¨è®¡æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> referenceCounting(){
</span></span><span style="display:flex;"><span>	Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//ä» Channel è·å–ByteBufAllocator</span>
</span></span><span style="display:flex;"><span>	ByteBufAllocator allocator = channel.<span style="color:#007f7f">alloc</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//ä» ByteBufAllocatoråˆ†é…ä¸€ä¸ª ByteBuf</span>
</span></span><span style="display:flex;"><span>	ByteBuf buffer = allocator.<span style="color:#007f7f">directBuffer</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//æ£€æŸ¥å¼•ç”¨è®¡æ•°æ˜¯å¦ä¸ºé¢„æœŸçš„ 1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">assert</span> buffer.<span style="color:#007f7f">refCnt</span>() == 1;
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 5-16 é‡Šæ”¾å¼•ç”¨è®¡æ•°çš„å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> releaseReferenceCountedObject(){
</span></span><span style="display:flex;"><span>	ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å‡å°‘åˆ°è¯¥å¯¹è±¡çš„æ´»åŠ¨å¼•ç”¨ã€‚å½“å‡å°‘åˆ° 0 æ—¶ï¼Œè¯¥å¯¹è±¡è¢«é‡Šæ”¾ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•è¿”å› true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">boolean</span> released = buffer.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¯•å›¾è®¿é—®ä¸€ä¸ªå·²ç»è¢«é‡Šæ”¾çš„å¼•ç”¨è®¡æ•°çš„å¯¹è±¡ï¼Œå°†ä¼šå¯¼è‡´ä¸€ä¸ª IllegalReferenceCountExceptionã€‚
æ³¨æ„ï¼Œä¸€ä¸ªç‰¹å®šçš„ï¼ˆReferenceCounted çš„å®ç°ï¼‰ç±»ï¼Œå¯ä»¥ç”¨å®ƒè‡ªå·±çš„ç‹¬ç‰¹æ–¹å¼æ¥å®šä¹‰å®ƒçš„å¼•ç”¨è®¡æ•°è§„åˆ™ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è®¾æƒ³ä¸€ä¸ªç±»ï¼Œå…¶ release()æ–¹æ³•çš„å®ç°æ€»æ˜¯å°†å¼•ç”¨è®¡æ•°è®¾ä¸ºé›¶ï¼Œè€Œä¸ç”¨å…³å¿ƒå®ƒçš„å½“å‰å€¼ï¼Œä»è€Œä¸€æ¬¡æ€§åœ°ä½¿æ‰€æœ‰çš„æ´»åŠ¨å¼•ç”¨éƒ½å¤±æ•ˆã€‚
è°è´Ÿè´£é‡Šæ”¾ï¼šä¸€èˆ¬æ¥è¯´ï¼Œæ˜¯ç”±æœ€åè®¿é—®ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰å¯¹è±¡çš„é‚£ä¸€æ–¹æ¥è´Ÿè´£å°†å®ƒé‡Šæ”¾ã€‚</p>
<h1 id="channelhandlerå’Œchannelpipeline">ChannelHandlerå’ŒChannelPipeline<a hidden class="anchor" aria-hidden="true" href="#channelhandlerå’Œchannelpipeline">#</a></h1>
<p>åœ¨ä¸Šä¸€ç« ä¸­ä½ å­¦ä¹ äº†Nettyçš„æ•°æ®å®¹å™¨ByteBufã€‚å½“æˆ‘ä»¬åœ¨æœ¬ç« ä¸­æ¢è®¨ Netty çš„æ•°æ®æµä»¥åŠå¤„ç†ç»„ä»¶æ—¶ï¼Œæˆ‘ä»¬å°†åŸºäºå·²ç»å­¦è¿‡çš„ä¸œè¥¿ï¼Œå¹¶ä¸”ä½ å°†å¼€å§‹çœ‹åˆ°æ¡†æ¶çš„é‡è¦å…ƒç´ éƒ½ç»“åˆåˆ°äº†ä¸€èµ·ã€‚ä½ å·²ç»çŸ¥é“ï¼Œå¯ä»¥åœ¨ ChannelPipeline ä¸­å°† ChannelHandler é“¾æ¥åœ¨ä¸€èµ·ä»¥ç»„ç»‡å¤„ç†é€»è¾‘ã€‚æˆ‘ä»¬å°†ä¼šç ”ç©¶æ¶‰åŠè¿™äº›ç±»çš„å„ç§ç”¨ä¾‹ï¼Œä»¥åŠä¸€ä¸ªé‡è¦çš„å…³ç³»â€”ChannelHandlerContextã€‚ç†è§£æ‰€æœ‰è¿™äº›ç»„ä»¶ä¹‹é—´çš„äº¤äº’å¯¹äºé€šè¿‡ Netty æ„å»ºæ¨¡å—åŒ–çš„ã€å¯é‡ç”¨çš„å®ç°è‡³å…³é‡è¦ã€‚</p>
<h2 id="channelhandlerå®¶æ—">ChannelHandlerå®¶æ—<a hidden class="anchor" aria-hidden="true" href="#channelhandlerå®¶æ—">#</a></h2>
<h3 id="channelçš„ç”Ÿå‘½å‘¨æœŸ">Channelçš„ç”Ÿå‘½å‘¨æœŸ<a hidden class="anchor" aria-hidden="true" href="#channelçš„ç”Ÿå‘½å‘¨æœŸ">#</a></h3>
<table>
<thead>
<tr>
<th>çŠ¶ æ€</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>ChannelUnregistered</td>
<td>Channel å·²ç»è¢«åˆ›å»ºï¼Œä½†è¿˜æœªæ³¨å†Œåˆ° EventLoop</td>
</tr>
<tr>
<td>ChannelRegistered</td>
<td>Channel å·²ç»è¢«æ³¨å†Œåˆ°äº† EventLoop</td>
</tr>
<tr>
<td>ChannelActive</td>
<td>Channel å¤„äºæ´»åŠ¨çŠ¶æ€ï¼ˆå·²ç»è¿æ¥åˆ°å®ƒçš„è¿œç¨‹èŠ‚ç‚¹ï¼‰ã€‚å®ƒç°åœ¨å¯ä»¥æ¥æ”¶å’Œå‘é€æ•°æ®äº†</td>
</tr>
<tr>
<td>ChannelInactive</td>
<td>Channel æ²¡æœ‰è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹</td>
</tr>
</tbody>
</table>
<p>å½“è¿™äº›çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå°†ä¼šç”Ÿæˆå¯¹åº”çš„äº‹ä»¶ã€‚
è¿™äº›äº‹ä»¶å°†ä¼šè¢«è½¬å‘ç»™ ChannelPipeline ä¸­çš„ ChannelHandlerï¼Œå…¶å¯ä»¥éšåå¯¹å®ƒä»¬åšå‡ºå“åº”ã€‚
ChannelRegistered-&gt;ChannelActive-&gt;ChannelInactive-&gt;ChannelUnregistered</p>
<h3 id="channelhandlerçš„ç”Ÿå‘½å‘¨æœŸ">ChannelHandlerçš„ç”Ÿå‘½å‘¨æœŸ<a hidden class="anchor" aria-hidden="true" href="#channelhandlerçš„ç”Ÿå‘½å‘¨æœŸ">#</a></h3>
<table>
<thead>
<tr>
<th>çŠ¶ æ€</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>handlerAdded</td>
<td>å½“æŠŠ ChannelHandler æ·»åŠ åˆ° ChannelPipeline ä¸­æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>handlerRemoved</td>
<td>å½“ä» ChannelPipeline ä¸­ç§»é™¤ ChannelHandler æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>exceptionCaught</td>
<td>å½“å¤„ç†è¿‡ç¨‹ä¸­åœ¨ ChannelPipeline ä¸­æœ‰é”™è¯¯äº§ç”Ÿæ—¶è¢«è°ƒç”¨</td>
</tr>
</tbody>
</table>
<p>åœ¨ ChannelHandlerè¢«æ·»åŠ åˆ° ChannelPipeline ä¸­æˆ–è€…è¢«ä» ChannelPipeline ä¸­ç§»é™¤æ—¶ä¼šè°ƒç”¨è¿™äº›æ“ä½œã€‚è¿™äº›æ–¹æ³•ä¸­çš„æ¯ä¸€ä¸ªéƒ½æ¥å—ä¸€ä¸ª ChannelHandlerContext å‚æ•°ã€‚
Netty å®šä¹‰äº†ä¸‹é¢ä¸¤ä¸ªé‡è¦çš„ ChannelHandler å­æ¥å£ï¼š
ChannelInboundHandlerâ€”â€”å¤„ç†å…¥ç«™æ•°æ®ä»¥åŠå„ç§çŠ¶æ€å˜åŒ–ï¼›
ChannelOutboundHandlerâ€”â€”å¤„ç†å‡ºç«™æ•°æ®å¹¶ä¸”å…è®¸æ‹¦æˆªæ‰€æœ‰çš„æ“ä½œã€‚</p>
<h3 id="channelinboundhandler-æ¥å£">ChannelInboundHandler æ¥å£<a hidden class="anchor" aria-hidden="true" href="#channelinboundhandler-æ¥å£">#</a></h3>
<table>
<thead>
<tr>
<th>ç±» å‹</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>channelRegistered</td>
<td>å½“ Channel å·²ç»æ³¨å†Œåˆ°å®ƒçš„ EventLoop å¹¶ä¸”èƒ½å¤Ÿå¤„ç† I/O æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>channelUnregistered</td>
<td>å½“ Channel ä»å®ƒçš„ EventLoop æ³¨é”€å¹¶ä¸”æ— æ³•å¤„ç†ä»»ä½• I/O æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>channelActive</td>
<td>å½“ Channel å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶è¢«è°ƒç”¨ï¼›Channel å·²ç»è¿æ¥/ç»‘å®šå¹¶ä¸”å·²ç»å°±ç»ª</td>
</tr>
<tr>
<td>channelInactive</td>
<td>å½“ Channel ç¦»å¼€æ´»åŠ¨çŠ¶æ€å¹¶ä¸”ä¸å†è¿æ¥å®ƒçš„è¿œç¨‹èŠ‚ç‚¹æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>channelReadComplete</td>
<td>å½“Channelä¸Šçš„ä¸€ä¸ªè¯»æ“ä½œå®Œæˆæ—¶è¢«è°ƒç”¨(æ³¨ï¼šå½“æ‰€æœ‰å¯è¯»çš„å­—èŠ‚éƒ½å·²ç»ä» Channel ä¸­è¯»å–ä¹‹åï¼Œå°†ä¼šè°ƒç”¨è¯¥å›è°ƒæ–¹æ³•ï¼›æ‰€ä»¥ï¼Œå¯èƒ½åœ¨ channelReadComplete()è¢«è°ƒç”¨ä¹‹å‰çœ‹åˆ°å¤šæ¬¡è°ƒç”¨ channelRead(&hellip;))</td>
</tr>
<tr>
<td>channelRead</td>
<td>å½“ä» Channel è¯»å–æ•°æ®æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>ChannelWritability-Changed</td>
<td>å½“ Channel çš„å¯å†™çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶è¢«è°ƒç”¨ã€‚ç”¨æˆ·å¯ä»¥ç¡®ä¿å†™æ“ä½œä¸ä¼šå®Œæˆ å¾—å¤ªå¿«ï¼ˆä»¥é¿å…å‘ç”Ÿ OutOfMemoryErrorï¼‰æˆ–è€…å¯ä»¥åœ¨ Channel å˜ä¸ºå† æ¬¡å¯å†™æ—¶æ¢å¤å†™å…¥ã€‚å¯ä»¥é€šè¿‡è°ƒç”¨ Channel çš„ isWritable()æ–¹æ³•æ¥æ£€æµ‹ Channel çš„å¯å†™æ€§ã€‚ä¸å¯å†™æ€§ç›¸å…³çš„é˜ˆå€¼å¯ä»¥é€šè¿‡ Channel.config(). setWriteHighWaterMark()å’Œ Channel.config().setWriteLowWaterMark()æ–¹æ³•æ¥è®¾ç½®</td>
</tr>
<tr>
<td>userEventTriggered</td>
<td>å½“ ChannelnboundHandler.fireUserEventTriggered()æ–¹æ³•è¢«è°ƒ ç”¨æ—¶è¢«è°ƒç”¨ï¼Œå› ä¸ºä¸€ä¸ª POJO è¢«ä¼ ç»äº† ChannelPipeline</td>
</tr>
</tbody>
</table>
<p>è¿™äº›æ–¹æ³•å°†ä¼šåœ¨æ•°æ®è¢«æ¥æ”¶æ—¶æˆ–è€…ä¸å…¶å¯¹åº”çš„ Channel çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶è¢«è°ƒç”¨ã€‚æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€æåˆ°çš„ï¼Œè¿™äº›æ–¹æ³•å’Œ Channel çš„ç”Ÿå‘½å‘¨æœŸå¯†åˆ‡ç›¸å…³ã€‚
å½“æŸä¸ª ChannelInboundHandler çš„å®ç°é‡å†™ channelRead()æ–¹æ³•æ—¶ï¼Œå®ƒå°†è´Ÿè´£æ˜¾å¼åœ°é‡Šæ”¾ä¸æ± åŒ–çš„ ByteBuf å®ä¾‹ç›¸å…³çš„å†…å­˜ã€‚Netty ä¸ºæ­¤æä¾›äº†ä¸€ä¸ªå®ç”¨æ–¹æ³• ReferenceCountUtil.release()ï¼Œå¦‚ä»£ç æ¸…å• 6-1 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * <span style="color:#f00">ä»£ç æ¸…å•</span> <span style="color:#ff0;font-weight:bold">6</span>-<span style="color:#ff0;font-weight:bold">1</span> <span style="color:#f00">é‡Šæ”¾æ¶ˆæ¯èµ„æº</span>
</span></span><span style="display:flex;"><span> * <span style="color:#f00">@</span>author &lt;a href=<span style="color:#0ff;font-weight:bold">&#34;mailto:norman.maurer@gmail.com&#34;</span>&gt;Norman Maurer&lt;/a&gt;
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span><span style="color:#f00">@</span>Sharable
</span></span><span style="display:flex;"><span>//<span style="color:#f00">æ‰©å±•äº†</span> ChannelInboundHandlerAdapter
</span></span><span style="display:flex;"><span>public <span style="color:#fff;font-weight:bold">class</span> DiscardHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    <span style="color:#f00">@</span>Override
</span></span><span style="display:flex;"><span>    public void channelRead(ChannelHandlerContext ctx, Object msg) {
</span></span><span style="display:flex;"><span>        //<span style="color:#f00">ä¸¢å¼ƒå·²æ¥æ”¶çš„æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>        ReferenceCountUtil.release(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty å°†ä½¿ç”¨ WARN çº§åˆ«çš„æ—¥å¿—æ¶ˆæ¯è®°å½•æœªé‡Šæ”¾çš„èµ„æºï¼Œä½¿å¾—å¯ä»¥éå¸¸ç®€å•åœ°åœ¨ä»£ç ä¸­å‘ç°è¿è§„çš„å®ä¾‹ã€‚ä½†æ˜¯ä»¥è¿™ç§æ–¹å¼ç®¡ç†èµ„æºå¯èƒ½å¾ˆç¹çã€‚ä¸€ä¸ªæ›´åŠ ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ SimpleChannelInboundHandlerã€‚
ä»£ç æ¸…å• 6-2 æ˜¯ä»£ç æ¸…å• 6-1 çš„ä¸€ä¸ªå˜ä½“ï¼Œè¯´æ˜äº†è¿™ä¸€ç‚¹ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * <span style="color:#f00">ä»£ç æ¸…å•</span> <span style="color:#ff0;font-weight:bold">6</span>-<span style="color:#ff0;font-weight:bold">2</span> <span style="color:#f00">ä½¿ç”¨</span> SimpleChannelInboundHandler
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * <span style="color:#f00">@</span>author &lt;a href=<span style="color:#0ff;font-weight:bold">&#34;mailto:norman.maurer@gmail.com&#34;</span>&gt;Norman Maurer&lt;/a&gt;
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span><span style="color:#f00">@</span>Sharable
</span></span><span style="display:flex;"><span>//<span style="color:#f00">æ‰©å±•äº†</span>SimpleChannelInboundHandler
</span></span><span style="display:flex;"><span>public <span style="color:#fff;font-weight:bold">class</span> SimpleDiscardHandler <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;Object&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#f00">@</span>Override
</span></span><span style="display:flex;"><span>    public void channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        Object msg) {
</span></span><span style="display:flex;"><span>        //<span style="color:#f00">ä¸éœ€è¦ä»»ä½•æ˜¾å¼çš„èµ„æºé‡Šæ”¾</span>
</span></span><span style="display:flex;"><span>        // No need to <span style="color:#fff;font-weight:bold">do</span> anything special
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±äº SimpleChannelInboundHandler ä¼šè‡ªåŠ¨é‡Šæ”¾èµ„æºï¼Œæ‰€ä»¥ä½ ä¸åº”è¯¥å­˜å‚¨æŒ‡å‘ä»»ä½•æ¶ˆæ¯çš„å¼•ç”¨ä¾›å°†æ¥ä½¿ç”¨ï¼Œå› ä¸ºè¿™äº›å¼•ç”¨éƒ½å°†ä¼šå¤±æ•ˆã€‚</p>
<h3 id="channeloutboundhandler-æ¥å£">ChannelOutboundHandler æ¥å£<a hidden class="anchor" aria-hidden="true" href="#channeloutboundhandler-æ¥å£">#</a></h3>
<p>å‡ºç«™æ“ä½œå’Œæ•°æ®å°†ç”± ChannelOutboundHandler å¤„ç†ã€‚
å®ƒçš„æ–¹æ³•å°†è¢« Channelã€ChannelPipeline ä»¥åŠ ChannelHandlerContext è°ƒç”¨ã€‚
ChannelOutboundHandler çš„ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½æ˜¯å¯ä»¥æŒ‰éœ€æ¨è¿Ÿæ“ä½œæˆ–è€…äº‹ä»¶ï¼Œè¿™ä½¿å¾—å¯ä»¥é€šè¿‡ä¸€äº›å¤æ‚çš„æ–¹æ³•æ¥å¤„ç†è¯·æ±‚ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåˆ°è¿œç¨‹èŠ‚ç‚¹çš„å†™å…¥è¢«æš‚åœäº†ï¼Œé‚£ä¹ˆä½ å¯ä»¥æ¨è¿Ÿå†²åˆ·æ“ä½œå¹¶åœ¨ç¨åç»§ç»­ã€‚</p>
<table>
<thead>
<tr>
<th>ç±» å‹</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>bind(ChannelHandlerContext, SocketAddress,ChannelPromise)</td>
<td>å½“è¯·æ±‚å°† Channel ç»‘å®šåˆ°æœ¬åœ°åœ°å€æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>connect(ChannelHandlerContext, SocketAddress,SocketAddress,ChannelPromise)</td>
<td>å½“è¯·æ±‚å°† Channel è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>disconnect(ChannelHandlerContext, ChannelPromise)</td>
<td>å½“è¯·æ±‚å°† Channel ä»è¿œç¨‹èŠ‚ç‚¹æ–­å¼€æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>close(ChannelHandlerContext,ChannelPromise)</td>
<td>å½“è¯·æ±‚å…³é—­ Channel æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>deregister(ChannelHandlerContext, ChannelPromise)</td>
<td>å½“è¯·æ±‚å°† Channel ä»å®ƒçš„ EventLoop æ³¨é”€ æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>read(ChannelHandlerContext)</td>
<td>å½“è¯·æ±‚ä» Channel è¯»å–æ›´å¤šçš„æ•°æ®æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>flush(ChannelHandlerContext)</td>
<td>å½“è¯·æ±‚é€šè¿‡ Channel å°†å…¥é˜Ÿæ•°æ®å†²åˆ·åˆ°è¿œç¨‹ èŠ‚ç‚¹æ—¶è¢«è°ƒç”¨</td>
</tr>
<tr>
<td>write(ChannelHandlerContext,Object, ChannelPromise)</td>
<td>å½“è¯·æ±‚é€šè¿‡ Channel å°†æ•°æ®å†™åˆ°è¿œç¨‹èŠ‚ç‚¹æ—¶ è¢«è°ƒç”¨</td>
</tr>
</tbody>
</table>
<p>ChannelPromiseä¸ChannelFuture ChannelOutboundHandlerä¸­çš„å¤§éƒ¨åˆ†æ–¹æ³•éƒ½éœ€è¦ä¸€ä¸ªChannelPromiseå‚æ•°ï¼Œä»¥ä¾¿åœ¨æ“ä½œå®Œæˆæ—¶å¾—åˆ°é€šçŸ¥ã€‚ChannelPromiseæ˜¯ChannelFutureçš„ä¸€ä¸ªå­ç±»ï¼Œå…¶å®šä¹‰äº†ä¸€äº›å¯å†™çš„æ–¹æ³•ï¼Œå¦‚setSuccess()å’ŒsetFailure()ï¼Œä»è€Œä½¿ChannelFutureä¸å¯å˜ã€‚</p>
<h3 id="channelhandler-é€‚é…å™¨">ChannelHandler é€‚é…å™¨<a hidden class="anchor" aria-hidden="true" href="#channelhandler-é€‚é…å™¨">#</a></h3>
<p>ä½ å¯ä»¥ä½¿ç”¨ ChannelInboundHandlerAdapter å’Œ ChannelOutboundHandlerAdapterç±»ä½œä¸ºè‡ªå·±çš„
ChannelHandler çš„èµ·å§‹ç‚¹ã€‚è¿™ä¸¤ä¸ªé€‚é…å™¨åˆ†åˆ«æä¾›äº† ChannelInboundHandlerå’Œ
ChannelOutboundHandler çš„åŸºæœ¬å®ç°ã€‚é€šè¿‡æ‰©å±•æŠ½è±¡ç±» ChannelHandlerAdapterï¼Œå®ƒä»¬è·å¾—äº†å®ƒä»¬å…±åŒçš„è¶…æ¥å£ ChannelHandler çš„æ–¹æ³•ã€‚ç”Ÿæˆçš„ç±»çš„å±‚æ¬¡ç»“æ„å¦‚å›¾ 6-2 æ‰€ç¤ºã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/39.png">
ChannelHandlerAdapter è¿˜æä¾›äº†å®ç”¨æ–¹æ³• isSharable()ã€‚å¦‚æœå…¶å¯¹åº”çš„å®ç°è¢«æ ‡æ³¨ä¸º Sharableï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°†è¿”å› trueï¼Œè¡¨ç¤ºå®ƒå¯ä»¥è¢«æ·»åŠ åˆ°å¤šä¸ª ChannelPipelineä¸­ã€‚ä½ è¦æƒ³åœ¨è‡ªå·±çš„
ChannelHandler ä¸­ä½¿ç”¨è¿™äº›é€‚é…å™¨ç±»ï¼Œåªéœ€è¦ç®€å•åœ°æ‰©å±•å®ƒä»¬ï¼Œå¹¶ä¸”é‡å†™é‚£äº›ä½ æƒ³è¦è‡ªå®šä¹‰çš„æ–¹æ³•ã€‚</p>
<h3 id="èµ„æºç®¡ç†">èµ„æºç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#èµ„æºç®¡ç†">#</a></h3>
<p>æ¯å½“é€šè¿‡è°ƒç”¨ ChannelInboundHandler.channelRead()æˆ–è€… ChannelOutboundHandler.write()æ–¹æ³•æ¥å¤„ç†æ•°æ®æ—¶ï¼Œä½ éƒ½éœ€è¦ç¡®ä¿æ²¡æœ‰ä»»ä½•çš„èµ„æºæ³„æ¼ã€‚ä½ å¯èƒ½è¿˜è®°å¾—åœ¨å‰é¢çš„ç« èŠ‚ä¸­æ‰€æåˆ°çš„ï¼ŒNetty ä½¿ç”¨å¼•ç”¨è®¡æ•°æ¥å¤„ç†æ± åŒ–çš„ ByteBufã€‚æ‰€ä»¥åœ¨å®Œå…¨ä½¿ç”¨å®ŒæŸä¸ªByteBuf åï¼Œè°ƒæ•´å…¶å¼•ç”¨è®¡æ•°æ˜¯å¾ˆé‡è¦çš„ã€‚ä¸ºäº†å¸®åŠ©ä½ è¯Šæ–­æ½œåœ¨çš„ï¼ˆèµ„æºæ³„æ¼ï¼‰é—®é¢˜ï¼ŒNettyæä¾›äº†class ResourceLeakDetectorï¼ˆå…¶åˆ©ç”¨äº† JDK æä¾›çš„ <code>PhantomReference&lt;T&gt;</code>ç±»æ¥å®ç°è¿™ä¸€ç‚¹ï¼‰ã€‚å®ƒå°†å¯¹ä½ åº”ç”¨ç¨‹åºçš„ç¼“å†²åŒºåˆ†é…åšå¤§çº¦ 1%çš„é‡‡æ ·æ¥æ£€æµ‹å†…å­˜æ³„éœ²ï¼Œç›¸å…³çš„å¼€é”€æ˜¯éå¸¸å°çš„ã€‚å¦‚æœæ£€æµ‹åˆ°äº†å†…å­˜æ³„éœ²ï¼Œå°†ä¼šäº§ç”Ÿç±»ä¼¼äºä¸‹é¢çš„æ—¥å¿—æ¶ˆæ¯ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>LEAK: ByteBuf.release() was not called before it&#39;s garbage-collected. Enable
</span></span><span style="display:flex;"><span>advanced leak reporting to find out where the leak occurred. To enable
</span></span><span style="display:flex;"><span>advanced leak reporting, specify the JVM option
</span></span><span style="display:flex;"><span>&#39;-Dio.netty.leakDetectionLevel=ADVANCED&#39; or call
</span></span><span style="display:flex;"><span>ResourceLeakDetector.setLevel().
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty ç›®å‰å®šä¹‰äº† 4 ç§æ³„æ¼æ£€æµ‹çº§åˆ«ï¼Œå¦‚è¡¨ 6-5 æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>çº§ åˆ«</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>DISABLED</td>
<td>ç¦ç”¨æ³„æ¼æ£€æµ‹ã€‚åªæœ‰åœ¨è¯¦å°½çš„æµ‹è¯•ä¹‹åæ‰åº”è®¾ç½®ä¸ºè¿™ä¸ªå€¼</td>
</tr>
<tr>
<td>SIMPLE</td>
<td>ä½¿ç”¨ 1%çš„é»˜è®¤é‡‡æ ·ç‡æ£€æµ‹å¹¶æŠ¥å‘Šä»»ä½•å‘ç°çš„æ³„éœ²ã€‚è¿™æ˜¯é»˜è®¤çº§åˆ«ï¼Œé€‚åˆç»å¤§éƒ¨åˆ†çš„æƒ…å†µ</td>
</tr>
<tr>
<td>ADVANCED</td>
<td>ä½¿ç”¨é»˜è®¤çš„é‡‡æ ·ç‡ï¼ŒæŠ¥å‘Šæ‰€å‘ç°çš„ä»»ä½•çš„æ³„éœ²ä»¥åŠå¯¹åº”çš„æ¶ˆæ¯è¢«è®¿é—®çš„ä½ç½®</td>
</tr>
<tr>
<td>PARANOID</td>
<td>ç±»ä¼¼äº ADVANCEDï¼Œä½†æ˜¯å…¶å°†ä¼šå¯¹æ¯æ¬¡ï¼ˆå¯¹æ¶ˆæ¯çš„ï¼‰è®¿é—®éƒ½è¿›è¡Œé‡‡æ ·ã€‚è¿™å¯¹æ€§èƒ½å°†ä¼šæœ‰å¾ˆ å¤§çš„å½±å“ï¼Œåº”è¯¥åªåœ¨è°ƒè¯•é˜¶æ®µä½¿ç”¨</td>
</tr>
<tr>
<td>æ³„éœ²æ£€æµ‹çº§åˆ«å¯ä»¥é€šè¿‡å°†ä¸‹é¢çš„ Java ç³»ç»Ÿå±æ€§è®¾ç½®ä¸ºè¡¨ä¸­çš„ä¸€ä¸ªå€¼æ¥å®šä¹‰ï¼š</td>
<td></td>
</tr>
<tr>
<td><code>java -Dio.netty.leakDetectionLevel=ADVANCED</code></td>
<td></td>
</tr>
<tr>
<td>å¦‚æœå¸¦ç€è¯¥ JVM é€‰é¡¹é‡æ–°å¯åŠ¨ä½ çš„åº”ç”¨ç¨‹åºï¼Œä½ å°†çœ‹åˆ°è‡ªå·±çš„åº”ç”¨ç¨‹åºæœ€è¿‘è¢«æ³„æ¼çš„ç¼“å†²åŒºè¢«è®¿é—®çš„ä½ç½®ã€‚</td>
<td></td>
</tr>
<tr>
<td>ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„ç”±å•å…ƒæµ‹è¯•äº§ç”Ÿçš„æ³„æ¼æŠ¥å‘Šï¼š</td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Running io.netty.handler.codec.xml.XmlFrameDecoderTest
</span></span><span style="display:flex;"><span>15:03:36.886 [main] ERROR io.netty.util.ResourceLeakDetector - LEAK:
</span></span><span style="display:flex;"><span>ByteBuf.release() was not called before it&#39;s garbage-collected.
</span></span><span style="display:flex;"><span>Recent access records: 1
</span></span><span style="display:flex;"><span>#1: io.netty.buffer.AdvancedLeakAwareByteBuf.toString(
</span></span><span style="display:flex;"><span>AdvancedLeakAwareByteBuf.java:697)
</span></span><span style="display:flex;"><span>io.netty.handler.codec.xml.XmlFrameDecoderTest.testDecodeWithXml(
</span></span><span style="display:flex;"><span>XmlFrameDecoderTest.java:157)
</span></span><span style="display:flex;"><span>io.netty.handler.codec.xml.XmlFrameDecoderTest.testDecodeWithTwoMessages(
</span></span><span style="display:flex;"><span>XmlFrameDecoderTest.java:133)
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ç° ChannelInboundHandler.channelRead()å’Œ ChannelOutboundHandler.write()æ–¹æ³•æ—¶ï¼Œåº”è¯¥å¦‚ä½•ä½¿ç”¨è¿™ä¸ªè¯Šæ–­å·¥å…·æ¥é˜²æ­¢æ³„éœ²å‘¢ï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹ä½ çš„ channelRead()æ“ä½œç›´æ¥æ¶ˆè´¹å…¥ç«™æ¶ˆæ¯çš„æƒ…å†µï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¸ä¼šé€šè¿‡è°ƒç”¨ ChannelHandlerContext.fireChannelRead()æ–¹æ³•å°†å…¥ç«™æ¶ˆæ¯è½¬å‘ç»™ä¸‹ä¸€ä¸ª
ChannelInboundHandlerã€‚ä»£ç æ¸…å• 6-3 å±•ç¤ºäº†å¦‚ä½•é‡Šæ”¾æ¶ˆæ¯ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * <span style="color:#f00">ä»£ç æ¸…å•</span> <span style="color:#ff0;font-weight:bold">6</span>-<span style="color:#ff0;font-weight:bold">3</span> <span style="color:#f00">æ¶ˆè´¹å¹¶é‡Šæ”¾å…¥ç«™æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * <span style="color:#f00">@</span>author &lt;a href=<span style="color:#0ff;font-weight:bold">&#34;mailto:norman.maurer@gmail.com&#34;</span>&gt;Norman Maurer&lt;/a&gt;
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span><span style="color:#f00">@</span>Sharable
</span></span><span style="display:flex;"><span>//<span style="color:#f00">æ‰©å±•äº†</span>ChannelInboundandlerAdapter
</span></span><span style="display:flex;"><span>public <span style="color:#fff;font-weight:bold">class</span> DiscardInboundHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    <span style="color:#f00">@</span>Override
</span></span><span style="display:flex;"><span>    public void channelRead(ChannelHandlerContext ctx, Object msg) {
</span></span><span style="display:flex;"><span>        //<span style="color:#f00">é€šè¿‡è°ƒç”¨</span> ReferenceCountUtil.release()<span style="color:#f00">æ–¹æ³•é‡Šæ”¾èµ„æº</span>
</span></span><span style="display:flex;"><span>        ReferenceCountUtil.release(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¶ˆè´¹å…¥ç«™æ¶ˆæ¯çš„ç®€å•æ–¹å¼ï¼šç”±äºæ¶ˆè´¹å…¥ç«™æ•°æ®æ˜¯ä¸€é¡¹å¸¸è§„ä»»åŠ¡ï¼Œæ‰€ä»¥ Netty æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„è¢«
ç§°ä¸º SimpleChannelInboundHandler çš„ ChannelInboundHandler å®ç°ã€‚è¿™ä¸ªå®ç°ä¼šåœ¨æ¶ˆæ¯è¢«
channelRead0()æ–¹æ³•æ¶ˆè´¹ä¹‹åè‡ªåŠ¨é‡Šæ”¾æ¶ˆæ¯ã€‚
åœ¨å‡ºç«™æ–¹å‘è¿™è¾¹ï¼Œå¦‚æœä½ å¤„ç†äº† write()æ“ä½œå¹¶ä¸¢å¼ƒäº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œé‚£ä¹ˆä½ ä¹Ÿåº”è¯¥è´Ÿè´£é‡Šæ”¾å®ƒã€‚
ä»£ç æ¸…å• 6-4 å±•ç¤ºäº†ä¸€ä¸ªä¸¢å¼ƒæ‰€æœ‰çš„å†™å…¥æ•°æ®çš„å®ç°ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * <span style="color:#f00">ä»£ç æ¸…å•</span> <span style="color:#ff0;font-weight:bold">6</span>-<span style="color:#ff0;font-weight:bold">4</span> <span style="color:#f00">ä¸¢å¼ƒå¹¶é‡Šæ”¾å‡ºç«™æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * <span style="color:#f00">@</span>author &lt;a href=<span style="color:#0ff;font-weight:bold">&#34;mailto:norman.maurer@gmail.com&#34;</span>&gt;Norman Maurer&lt;/a&gt;
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span><span style="color:#f00">@</span>Sharable
</span></span><span style="display:flex;"><span>//<span style="color:#f00">æ‰©å±•äº†</span>ChannelOutboundHandlerAdapter
</span></span><span style="display:flex;"><span>public <span style="color:#fff;font-weight:bold">class</span> DiscardOutboundHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelOutboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    <span style="color:#f00">@</span>Override
</span></span><span style="display:flex;"><span>    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {
</span></span><span style="display:flex;"><span>        //<span style="color:#f00">é€šè¿‡ä½¿ç”¨</span> ReferenceCountUtil.realse(...)<span style="color:#f00">æ–¹æ³•é‡Šæ”¾èµ„æº</span>
</span></span><span style="display:flex;"><span>        ReferenceCountUtil.release(msg);
</span></span><span style="display:flex;"><span>        //<span style="color:#f00">é€šçŸ¥</span> ChannelPromiseæ•°æ®å·²ç»è¢«å¤„ç†äº†
</span></span><span style="display:flex;"><span>        promise.setSuccess();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é‡è¦çš„æ˜¯ï¼Œä¸ä»…è¦é‡Šæ”¾èµ„æºï¼Œè¿˜è¦é€šçŸ¥ ChannelPromiseã€‚å¦åˆ™å¯èƒ½ä¼šå‡ºç° ChannelFutureListener
æ”¶ä¸åˆ°æŸä¸ªæ¶ˆæ¯å·²ç»è¢«å¤„ç†äº†çš„é€šçŸ¥çš„æƒ…å†µã€‚æ€»ä¹‹ï¼Œå¦‚æœä¸€ä¸ªæ¶ˆæ¯è¢«æ¶ˆè´¹æˆ–è€…ä¸¢å¼ƒäº†ï¼Œå¹¶ä¸”æ²¡æœ‰ä¼ é€’ç»™ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ªChannelOutboundHandlerï¼Œé‚£ä¹ˆç”¨æˆ·å°±æœ‰è´£ä»»è°ƒç”¨
ReferenceCountUtil.release()ã€‚å¦‚æœæ¶ˆæ¯åˆ°è¾¾äº†å®é™…çš„ä¼ è¾“å±‚ï¼Œé‚£ä¹ˆå½“å®ƒè¢«å†™å…¥æ—¶æˆ–è€… Channel å…³é—­æ—¶ï¼Œéƒ½å°†è¢«è‡ªåŠ¨é‡Šæ”¾ã€‚</p>
<h2 id="channelpipeline-æ¥å£">ChannelPipeline æ¥å£<a hidden class="anchor" aria-hidden="true" href="#channelpipeline-æ¥å£">#</a></h2>
<p>ChannelPipelineæ˜¯ä¸€ä¸ªæ‹¦æˆªæµç»Channelçš„å…¥ç«™å’Œå‡ºç«™äº‹ä»¶çš„ChannelHandler å®ä¾‹é“¾ã€‚
è¿™äº› ChannelHandler ä¹‹é—´çš„äº¤äº’ï¼Œç»„æˆäº†ä¸€ä¸ªåº”ç”¨ç¨‹åºæ•°æ®å’Œäº‹ä»¶å¤„ç†é€»è¾‘çš„æ ¸å¿ƒã€‚
æ¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ Channel éƒ½å°†ä¼šè¢«åˆ†é…ä¸€ä¸ªæ–°çš„ ChannelPipelineã€‚è¿™é¡¹å…³è”æ˜¯æ°¸ä¹…æ€§çš„ï¼›
Channel æ—¢ä¸èƒ½é™„åŠ å¦å¤–ä¸€ä¸ª ChannelPipelineï¼Œä¹Ÿä¸èƒ½åˆ†ç¦»å…¶å½“å‰çš„ã€‚åœ¨ Netty ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè¿™æ˜¯ä¸€é¡¹å›ºå®šçš„æ“ä½œï¼Œä¸éœ€è¦å¼€å‘äººå‘˜çš„ä»»ä½•å¹²é¢„ã€‚
æ ¹æ®äº‹ä»¶çš„èµ·æºï¼Œäº‹ä»¶å°†ä¼šè¢« ChannelInboundHandler æˆ–è€… ChannelOutboundHandlerå¤„ç†ã€‚éšåï¼Œé€šè¿‡è°ƒç”¨ ChannelHandlerContext å®ç°ï¼Œå®ƒå°†è¢«è½¬å‘ç»™åŒä¸€è¶…ç±»å‹çš„ä¸‹ä¸€ä¸ªChannelHandlerã€‚</p>
<p>ChannelHandlerContextä½¿å¾—ChannelHandlerèƒ½å¤Ÿå’Œå®ƒçš„ChannelPipelineä»¥åŠå…¶ä»–çš„
ChannelHandler äº¤äº’ã€‚ ChannelHandler å¯ä»¥é€šçŸ¥å…¶æ‰€å±çš„ ChannelPipeline ä¸­çš„ä¸‹ä¸€ ä¸ªChannelHandlerï¼Œç”šè‡³å¯ä»¥åŠ¨æ€ä¿®æ”¹å®ƒæ‰€å±çš„ChannelPipelineä¸­çš„ ChannelHandler çš„ç¼–æ’ã€‚</p>
<p>ChannelHandlerContext å…·æœ‰ä¸°å¯Œçš„ç”¨äºå¤„ç†äº‹ä»¶å’Œæ‰§è¡Œ I/O æ“ä½œçš„ APIã€‚6.3 èŠ‚å°†æä¾›æœ‰å…³ChannelHandlerContext çš„æ›´å¤šå†…å®¹ã€‚</p>
<p>å›¾ 6-3 å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„åŒæ—¶å…·æœ‰å…¥ç«™å’Œå‡ºç«™ ChannelHandler çš„ ChannelPipeline çš„å¸ƒå±€ï¼Œå¹¶ä¸”å°è¯äº†æˆ‘ä»¬ä¹‹å‰çš„å…³äº ChannelPipeline ä¸»è¦ç”±ä¸€ç³»åˆ—çš„ ChannelHandler æ‰€ç»„æˆçš„è¯´æ³•ã€‚ChannelPipeline è¿˜æä¾›äº†é€šè¿‡ ChannelPipeline æœ¬èº«ä¼ æ’­äº‹ä»¶çš„æ–¹æ³•ã€‚å¦‚æœä¸€ä¸ªå…¥ç«™äº‹ä»¶è¢«è§¦å‘ï¼Œå®ƒå°†è¢«ä» ChannelPipeline çš„å¤´éƒ¨å¼€å§‹ä¸€ç›´è¢«ä¼ æ’­åˆ° Channel Pipeline çš„å°¾ç«¯ã€‚åœ¨å›¾ 6-3 ä¸­ï¼Œä¸€ä¸ªå‡ºç«™ I/O äº‹ä»¶å°†ä»ChannelPipeline çš„æœ€å³è¾¹å¼€å§‹ï¼Œç„¶åå‘å·¦ä¼ æ’­ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/40.png"></p>
<p>ChannelPipeline ç›¸å¯¹è®ºï¼š
ä½ å¯èƒ½ä¼šè¯´ï¼Œä»äº‹ä»¶é€”ç» ChannelPipeline çš„è§’åº¦æ¥çœ‹ï¼ŒChannelPipeline çš„å¤´éƒ¨å’Œå°¾ç«¯å–å†³äºè¯¥äº‹ä»¶æ˜¯å…¥ç«™çš„è¿˜æ˜¯å‡ºç«™çš„ã€‚ç„¶è€Œ Netty æ€»æ˜¯å°† ChannelPipeline çš„å…¥ç«™å£ï¼ˆå›¾ 6-3 ä¸­çš„å·¦ä¾§ï¼‰ä½œä¸ºå¤´éƒ¨ï¼Œè€Œå°†å‡ºç«™å£ï¼ˆè¯¥å›¾çš„å³ä¾§ï¼‰ä½œä¸ºå°¾ç«¯ã€‚
å½“ä½ å®Œæˆäº†é€šè¿‡è°ƒç”¨ ChannelPipeline.add*()æ–¹æ³•å°†å…¥ç«™å¤„ç†å™¨ï¼ˆChannelInboundHandlerï¼‰å’Œå‡ºç«™å¤„ç†å™¨ï¼ˆ ChannelOutboundHandler ï¼‰æ··åˆæ·»åŠ åˆ° ChannelPipeline ä¹‹åï¼Œæ¯ä¸€ä¸ªChannelHandler ä»å¤´éƒ¨åˆ°å°¾ç«¯çš„é¡ºåºä½ç½®æ­£å¦‚åŒæˆ‘ä»¬æ–¹æ‰æ‰€å®šä¹‰å®ƒä»¬çš„ä¸€æ ·ã€‚å› æ­¤ï¼Œå¦‚æœä½ å°†å›¾ 6-3 ä¸­çš„å¤„ç†å™¨ï¼ˆChannelHandlerï¼‰ä»å·¦åˆ°å³è¿›è¡Œç¼–å·ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªè¢«å…¥ç«™äº‹ä»¶çœ‹åˆ°çš„ ChannelHandler å°†æ˜¯1ï¼Œè€Œç¬¬ä¸€ä¸ªè¢«å‡ºç«™äº‹ä»¶çœ‹åˆ°çš„ ChannelHandler å°†æ˜¯ 5ã€‚</p>
<p>åœ¨ ChannelPipeline ä¼ æ’­äº‹ä»¶æ—¶ï¼Œå®ƒä¼šæµ‹è¯• ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelHandler çš„ç±»å‹æ˜¯å¦å’Œäº‹ä»¶çš„è¿åŠ¨æ–¹å‘ç›¸åŒ¹é…ã€‚å¦‚æœä¸åŒ¹é…ï¼ŒChannelPipeline å°†è·³è¿‡è¯¥ChannelHandler å¹¶å‰è¿›åˆ°ä¸‹ä¸€ä¸ªï¼Œç›´åˆ°å®ƒæ‰¾åˆ°å’Œè¯¥äº‹ä»¶æ‰€æœŸæœ›çš„æ–¹å‘ç›¸åŒ¹é…çš„ä¸ºæ­¢ã€‚ï¼ˆå½“ç„¶ï¼ŒChannelHandler ä¹Ÿå¯ä»¥åŒæ—¶å®ç°ChannelInboundHandler æ¥å£å’Œ ChannelOutboundHandler æ¥å£ã€‚ï¼‰</p>
<h3 id="ä¿®æ”¹-channelpipeline">ä¿®æ”¹ ChannelPipeline<a hidden class="anchor" aria-hidden="true" href="#ä¿®æ”¹-channelpipeline">#</a></h3>
<p>ChannelHandler å¯ä»¥é€šè¿‡æ·»åŠ ã€åˆ é™¤æˆ–è€…æ›¿æ¢å…¶ä»–çš„ ChannelHandler æ¥å®æ—¶åœ°ä¿®æ”¹ChannelPipelineçš„å¸ƒå±€ã€‚
ï¼ˆå®ƒä¹Ÿå¯ä»¥å°†å®ƒè‡ªå·±ä» ChannelPipeline ä¸­ç§»é™¤ã€‚ï¼‰è¿™æ˜¯ ChannelHandler æœ€é‡è¦çš„èƒ½åŠ›ä¹‹ä¸€ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä»”ç»†åœ°æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•åšåˆ°çš„ã€‚è¡¨ 6-6 åˆ—å‡ºäº†ç›¸å…³çš„æ–¹æ³•ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>AddFirstaddBefore addAfteraddLast</td>
<td>å°†ä¸€ä¸ªChannelHandler æ·»åŠ åˆ°ChannelPipeline ä¸­</td>
</tr>
<tr>
<td>remove</td>
<td>å°†ä¸€ä¸ªChannelHandler ä»ChannelPipeline ä¸­ç§»é™¤</td>
</tr>
<tr>
<td>replace</td>
<td>å°† ChannelPipeline ä¸­çš„ä¸€ä¸ª ChannelHandler æ›¿æ¢ä¸ºå¦ä¸€ä¸ª ChannelHandler</td>
</tr>
<tr>
<td>ä»£ç æ¸…å• 6-5 å±•ç¤ºäº†è¿™äº›æ–¹æ³•çš„ä½¿ç”¨ã€‚</td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 6-5 ä¿®æ”¹ ChannelPipeline
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ModifyChannelPipeline {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ChannelPipeline CHANNEL_PIPELINE_FROM_SOMEWHERE = DUMMY_INSTANCE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 6-5 ä¿®æ”¹ ChannelPipeline
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> modifyPipeline() {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = CHANNEL_PIPELINE_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference to pipeline;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª FirstHandler çš„å®ä¾‹</span>
</span></span><span style="display:flex;"><span>        FirstHandler firstHandler = <span style="color:#fff;font-weight:bold">new</span> FirstHandler();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†è¯¥å®ä¾‹ä½œä¸º&#34;handler1&#34;æ·»åŠ åˆ°ChannelPipeline ä¸­</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;handler1&#34;</span>, firstHandler);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†ä¸€ä¸ª SecondHandlerçš„å®ä¾‹ä½œä¸º&#34;handler2&#34;æ·»åŠ åˆ° ChannelPipelineçš„ç¬¬ä¸€ä¸ªæ§½ä¸­ã€‚è¿™æ„å‘³ç€å®ƒå°†è¢«æ”¾ç½®åœ¨å·²æœ‰çš„&#34;handler1&#34;ä¹‹å‰</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addFirst</span>(<span style="color:#0ff;font-weight:bold">&#34;handler2&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> SecondHandler());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†ä¸€ä¸ª ThirdHandler çš„å®ä¾‹ä½œä¸º&#34;handler3&#34;æ·»åŠ åˆ° ChannelPipeline çš„æœ€åä¸€ä¸ªæ§½ä¸­</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;handler3&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> ThirdHandler());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//é€šè¿‡åç§°ç§»é™¤&#34;handler3&#34;</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">remove</span>(<span style="color:#0ff;font-weight:bold">&#34;handler3&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//é€šè¿‡å¼•ç”¨ç§»é™¤FirstHandlerï¼ˆå®ƒæ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦å®ƒçš„åç§°ï¼‰</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">remove</span>(firstHandler);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°† SecondHandler(&#34;handler2&#34;)æ›¿æ¢ä¸º FourthHandler:&#34;handler4&#34;</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;handler2&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;handler4&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> FourthHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> FirstHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelHandlerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SecondHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelHandlerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ThirdHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelHandlerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> FourthHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelHandlerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¨åï¼Œä½ å°†çœ‹åˆ°ï¼Œé‡ç»„ ChannelHandler çš„è¿™ç§èƒ½åŠ›ä½¿æˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥è½»æ¾åœ°å®ç°æå…¶çµæ´»çš„é€»è¾‘ã€‚</p>
<p>ChannelHandler çš„æ‰§è¡Œå’Œé˜»å¡ï¼š
é€šå¸¸ ChannelPipeline ä¸­çš„æ¯ä¸€ä¸ª ChannelHandler éƒ½æ˜¯é€šè¿‡å®ƒçš„ EventLoopï¼ˆI/O çº¿ç¨‹ï¼‰æ¥å¤„
ç†ä¼ é€’ç»™å®ƒçš„äº‹ä»¶çš„ã€‚æ‰€ä»¥è‡³å…³é‡è¦çš„æ˜¯ä¸è¦é˜»å¡è¿™ä¸ªçº¿ç¨‹ï¼Œå› ä¸ºè¿™ä¼šå¯¹æ•´ä½“çš„ I/O å¤„ç†äº§ç”Ÿè´Ÿé¢çš„å½±å“ã€‚ä½†æœ‰æ—¶å¯èƒ½éœ€è¦ä¸é‚£äº›ä½¿ç”¨é˜»å¡ API çš„é—ç•™ä»£ç è¿›è¡Œäº¤äº’ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼ŒChannelPipeline æœ‰ä¸€äº›æ¥å—ä¸€ä¸ª EventExecutorGroup çš„ add()æ–¹æ³•ã€‚å¦‚æœä¸€ä¸ªäº‹ä»¶è¢«ä¼ é€’ç»™ä¸€ä¸ªè‡ªå®šä¹‰çš„ EventExecutor-Groupï¼Œå®ƒå°†è¢«åŒ…å«åœ¨è¿™ä¸ª EventExecutorGroup ä¸­çš„æŸä¸ª EventExecutor æ‰€å¤„ç†ï¼Œä»è€Œè¢«ä»è¯¥Channel æœ¬èº«çš„EventLoop ä¸­ç§»é™¤ã€‚å¯¹äºè¿™ç§ç”¨ä¾‹ï¼ŒNetty æä¾›äº†ä¸€ä¸ªå« DefaultEventExecutorGroup çš„é»˜è®¤å®ç°ã€‚
é™¤äº†è¿™äº›æ“ä½œï¼Œè¿˜æœ‰åˆ«çš„é€šè¿‡ç±»å‹æˆ–è€…åç§°æ¥è®¿é—® ChannelHandler çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•éƒ½åˆ—åœ¨äº†è¡¨ 6-7 ä¸­ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>get</td>
<td>é€šè¿‡ç±»å‹æˆ–è€…åç§°è¿”å› ChannelHandler</td>
</tr>
<tr>
<td>context</td>
<td>è¿”å›å’Œ ChannelHandler ç»‘å®šçš„ ChannelHandlerContext</td>
</tr>
<tr>
<td>names</td>
<td>è¿”å› ChannelPipeline ä¸­æ‰€æœ‰ ChannelHandler çš„åç§°</td>
</tr>
</tbody>
</table>
<h3 id="è§¦å‘äº‹ä»¶">è§¦å‘äº‹ä»¶<a hidden class="anchor" aria-hidden="true" href="#è§¦å‘äº‹ä»¶">#</a></h3>
<p>ChannelPipeline çš„ API å…¬å¼€äº†ç”¨äºè°ƒç”¨å…¥ç«™å’Œå‡ºç«™æ“ä½œçš„é™„åŠ æ–¹æ³•ã€‚è¡¨ 6-8 åˆ—å‡ºäº†å…¥ç«™æ“ä½œï¼Œ
ç”¨äºé€šçŸ¥ ChannelInboundHandler åœ¨ ChannelPipeline ä¸­æ‰€å‘ç”Ÿçš„äº‹ä»¶ã€‚</p>
<table>
<thead>
<tr>
<th>æ–¹ æ³• å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>fireChannelRegistered</td>
<td>è°ƒç”¨ ChannelPipeline ä¸­ä¸‹ä¸€ä¸ª ChannelInboundHandler çš„ channelRegistered(ChannelHandlerContext)æ–¹æ³•</td>
</tr>
<tr>
<td>fireChannelUnregistered</td>
<td>è°ƒç”¨ ChannelPipeline ä¸­ä¸‹ä¸€ä¸ª ChannelInboundHandler çš„ channelUnregistered(ChannelHandlerContext)æ–¹æ³•</td>
</tr>
<tr>
<td>fireChannelActive</td>
<td>è°ƒç”¨ ChannelPipeline ä¸­ä¸‹ä¸€ä¸ª ChannelInboundHandler çš„ channelActive(ChannelHandlerContext)æ–¹æ³•</td>
</tr>
<tr>
<td>fireChannelInactive</td>
<td>è°ƒç”¨ ChannelPipeline ä¸­ä¸‹ä¸€ä¸ª ChannelInboundHandler çš„ channelInactive(ChannelHandlerContext)æ–¹æ³•</td>
</tr>
<tr>
<td>fireExceptionCaught</td>
<td>è°ƒç”¨ ChannelPipeline ä¸­ä¸‹ä¸€ä¸ª ChannelInboundHandler çš„ exceptionCaught(ChannelHandlerContext, Throwable)æ–¹æ³•</td>
</tr>
<tr>
<td>fireUserEventTriggered</td>
<td>è°ƒç”¨ ChannelPipeline ä¸­ä¸‹ä¸€ä¸ª ChannelInboundHandler çš„ userEventTriggered(ChannelHandlerContext, Object)æ–¹æ³•</td>
</tr>
<tr>
<td>fireChannelRead</td>
<td>è°ƒç”¨ ChannelPipeline ä¸­ä¸‹ä¸€ä¸ª ChannelInboundHandler çš„ channelRead(ChannelHandlerContext, Object msg)æ–¹æ³•</td>
</tr>
<tr>
<td>fireChannelReadComplete</td>
<td>è°ƒç”¨ ChannelPipeline ä¸­ä¸‹ä¸€ä¸ª ChannelInboundHandler çš„ channelReadComplete(ChannelHandlerContext)æ–¹æ³•</td>
</tr>
<tr>
<td>fireChannelWritability-Changed</td>
<td>è°ƒç”¨ ChannelPipeline ä¸­ä¸‹ä¸€ä¸ª ChannelInboundHandler çš„ channelWritabilityChanged(ChannelHandlerContext)æ–¹æ³•</td>
</tr>
</tbody>
</table>
<p>åœ¨å‡ºç«™è¿™è¾¹ï¼Œå¤„ç†äº‹ä»¶å°†ä¼šå¯¼è‡´åº•å±‚çš„å¥—æ¥å­—ä¸Šå‘ç”Ÿä¸€ç³»åˆ—çš„åŠ¨ä½œã€‚è¡¨ 6-9 åˆ—å‡ºäº† ChannelPipeline API çš„å‡ºç«™æ“ä½œã€‚</p>
<table>
<thead>
<tr>
<th>æ–¹ æ³• å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>bind</td>
<td>å°† Channel ç»‘å®šåˆ°ä¸€ä¸ªæœ¬åœ°åœ°å€ï¼Œè¿™å°†è°ƒç”¨ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelOutboundHandler çš„ bind(ChannelHandlerContext, SocketAddress, ChannelPromise)æ–¹æ³•</td>
</tr>
<tr>
<td>connect</td>
<td>å°† Channel è¿æ¥åˆ°ä¸€ä¸ªè¿œç¨‹åœ°å€ï¼Œè¿™å°†è°ƒç”¨ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelOutboundHandler çš„ connect(ChannelHandlerContext, SocketAddress, ChannelPromise)æ–¹æ³•</td>
</tr>
<tr>
<td>disconnect</td>
<td>å°†Channel æ–­å¼€è¿æ¥ã€‚è¿™å°†è°ƒç”¨ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ªChannelOutboundHandler çš„ disconnect(ChannelHandlerContext, Channel Promise)æ–¹æ³•</td>
</tr>
<tr>
<td>close</td>
<td>å°† Channel å…³é—­ã€‚è¿™å°†è°ƒç”¨ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelOutboundHandler çš„ close(ChannelHandlerContext, ChannelPromise)æ–¹æ³•</td>
</tr>
<tr>
<td>deregister</td>
<td>å°† Channel ä»å®ƒå…ˆå‰æ‰€åˆ†é…çš„ EventExecutorï¼ˆå³ EventLoopï¼‰ä¸­æ³¨é”€ã€‚è¿™å°†è°ƒ ç”¨ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelOutboundHandler çš„ deregister (ChannelHandlerContext, ChannelPromise)æ–¹æ³•</td>
</tr>
<tr>
<td>flush</td>
<td>å†²åˆ·Channelæ‰€æœ‰æŒ‚èµ·çš„å†™å…¥ã€‚è¿™å°†è°ƒç”¨ChannelPipelineä¸­çš„ä¸‹ä¸€ä¸ªChannelOutboundHandler çš„ flush(ChannelHandlerContext)æ–¹æ³•</td>
</tr>
<tr>
<td>write</td>
<td>å°†æ¶ˆæ¯å†™å…¥ Channelã€‚è¿™å°†è°ƒç”¨ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelOutboundHandlerçš„write(ChannelHandlerContext, Object msg, ChannelPromise)æ–¹æ³•ã€‚æ³¨æ„ï¼šè¿™å¹¶ä¸ä¼šå°†æ¶ˆæ¯å†™å…¥åº•å±‚çš„ Socketï¼Œè€Œåªä¼šå°†å®ƒæ”¾å…¥é˜Ÿåˆ—ä¸­ã€‚ è¦å°†å®ƒå†™å…¥ Socketï¼Œéœ€è¦è°ƒç”¨ flush()æˆ–è€… writeAndFlush()æ–¹æ³•</td>
</tr>
<tr>
<td>writeAndFlush</td>
<td>è¿™æ˜¯ä¸€ä¸ªå…ˆè°ƒç”¨ write()æ–¹æ³•å†æ¥ç€è°ƒç”¨ flush()æ–¹æ³•çš„ä¾¿åˆ©æ–¹æ³•</td>
</tr>
<tr>
<td>read</td>
<td>è¯·æ±‚ä» Channel ä¸­è¯»å–æ›´å¤šçš„æ•°æ®ã€‚è¿™å°†è°ƒç”¨ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelOutboundHandler çš„ read(ChannelHandlerContext)æ–¹æ³•</td>
</tr>
</tbody>
</table>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>ChannelPipeline ä¿å­˜äº†ä¸ Channel ç›¸å…³è”çš„ ChannelHandlerï¼›</li>
<li>ChannelPipeline å¯ä»¥æ ¹æ®éœ€è¦ï¼Œé€šè¿‡æ·»åŠ æˆ–è€…åˆ é™¤ ChannelHandler æ¥åŠ¨æ€åœ°ä¿®æ”¹ï¼›</li>
<li>ChannelPipeline æœ‰ç€ä¸°å¯Œçš„ API ç”¨ä»¥è¢«è°ƒç”¨ï¼Œä»¥å“åº”å…¥ç«™å’Œå‡ºç«™äº‹ä»¶ã€‚</li>
</ul>
<h2 id="channelhandlercontext-æ¥å£">ChannelHandlerContext æ¥å£<a hidden class="anchor" aria-hidden="true" href="#channelhandlercontext-æ¥å£">#</a></h2>
<p>ChannelHandlerContextzä»£è¡¨äº† ChannelHandler å’Œ ChannelPipeline ä¹‹é—´çš„å…³è”ã€‚
æ¯å½“æœ‰ ChannelHandler æ·»åŠ åˆ° ChannelPipeline ä¸­æ—¶ï¼Œéƒ½ä¼šåˆ›å»º ChannelHandlerContextã€‚
ChannelHandlerContext çš„ä¸»è¦åŠŸèƒ½æ˜¯ç®¡ç†å®ƒæ‰€å…³è”çš„ ChannelHandler å’Œåœ¨åŒä¸€ä¸ª ChannelPipelineä¸­çš„å…¶ä»– ChannelHandler ä¹‹é—´çš„äº¤äº’ã€‚
ChannelHandlerContext æœ‰å¾ˆå¤šçš„æ–¹æ³•ï¼Œå…¶ä¸­ä¸€äº›æ–¹æ³•ä¹Ÿå­˜åœ¨äº Channel å’Œ ChannelPipeline æœ¬èº«ä¸Šï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹é‡è¦çš„ä¸åŒã€‚å¦‚æœè°ƒç”¨ Channel æˆ–è€… ChannelPipeline ä¸Šçš„è¿™äº›æ–¹æ³•ï¼Œå®ƒä»¬å°†æ²¿ç€æ•´ä¸ªChannelPipeline è¿›è¡Œä¼ æ’­ã€‚è€Œè°ƒç”¨ä½äº ChannelHandlerContextä¸Šçš„ç›¸åŒæ–¹æ³•ï¼Œåˆ™å°†ä»å½“å‰æ‰€å…³è”çš„ChannelHandler å¼€å§‹ï¼Œå¹¶ä¸”åªä¼šä¼ æ’­ç»™ä½äºè¯¥ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ªèƒ½å¤Ÿå¤„ç†è¯¥äº‹ä»¶çš„ ChannelHandlerã€‚</p>
<table>
<thead>
<tr>
<th>æ–¹ æ³• å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>alloc</td>
<td>è¿”å›å’Œè¿™ä¸ªå®ä¾‹ç›¸å…³è”çš„Channel æ‰€é…ç½®çš„ ByteBufAllocator</td>
</tr>
<tr>
<td>bind</td>
<td>ç»‘å®šåˆ°ç»™å®šçš„ SocketAddressï¼Œå¹¶è¿”å› ChannelFuture</td>
</tr>
<tr>
<td>channel</td>
<td>è¿”å›ç»‘å®šåˆ°è¿™ä¸ªå®ä¾‹çš„ Channel</td>
</tr>
<tr>
<td>close</td>
<td>å…³é—­ Channelï¼Œå¹¶è¿”å› ChannelFuture</td>
</tr>
<tr>
<td>connect</td>
<td>è¿æ¥ç»™å®šçš„ SocketAddressï¼Œå¹¶è¿”å› ChannelFuture</td>
</tr>
<tr>
<td>deregister</td>
<td>ä»ä¹‹å‰åˆ†é…çš„ EventExecutor æ³¨é”€ï¼Œå¹¶è¿”å› ChannelFuture</td>
</tr>
<tr>
<td>executor</td>
<td>è¿”å›è°ƒåº¦äº‹ä»¶çš„ EventExecutor</td>
</tr>
<tr>
<td>fireChannelActive</td>
<td>è§¦å‘å¯¹ä¸‹ä¸€ä¸ª ChannelInboundHandler ä¸Šçš„ channelActive()æ–¹æ³•ï¼ˆå·²è¿æ¥ï¼‰çš„è°ƒç”¨</td>
</tr>
<tr>
<td>fireChannelInactive</td>
<td>è§¦å‘å¯¹ä¸‹ä¸€ä¸ª ChannelInboundHandler ä¸Šçš„ channelInactive()æ–¹æ³•ï¼ˆå·²å…³é—­ï¼‰çš„è°ƒç”¨</td>
</tr>
<tr>
<td>fireChannelRead</td>
<td>è§¦å‘å¯¹ä¸‹ä¸€ä¸ª ChannelInboundHandler ä¸Šçš„ channelRead()æ–¹æ³•ï¼ˆå·²æ¥æ”¶çš„æ¶ˆæ¯ï¼‰çš„è°ƒç”¨</td>
</tr>
<tr>
<td>fireChannelReadComplete</td>
<td>è§¦å‘å¯¹ä¸‹ä¸€ä¸ªChannelInboundHandlerä¸Šçš„ channelReadComplete()æ–¹æ³•çš„è°ƒç”¨</td>
</tr>
<tr>
<td>fireChannelRegistered</td>
<td>è§¦å‘å¯¹ä¸‹ä¸€ä¸ª ChannelInboundHandler ä¸Šçš„ fireChannelRegistered()æ–¹æ³•çš„è°ƒç”¨</td>
</tr>
<tr>
<td>fireChannelUnregistered</td>
<td>è§¦å‘å¯¹ä¸‹ä¸€ä¸ª ChannelInboundHandler ä¸Šçš„ fireChannelUnregistered()æ–¹æ³•çš„è°ƒç”¨</td>
</tr>
<tr>
<td>fireChannelWritabilityChanged</td>
<td>è§¦å‘å¯¹ä¸‹ä¸€ä¸ª ChannelInboundHandler ä¸Šçš„ fireChannelWritabilityChanged()æ–¹æ³•çš„è°ƒç”¨</td>
</tr>
<tr>
<td>fireExceptionCaught</td>
<td>è§¦å‘å¯¹ä¸‹ä¸€ä¸ª ChannelInboundHandler ä¸Šçš„ fireExceptionCaught(Throwable)æ–¹æ³•çš„è°ƒç”¨</td>
</tr>
<tr>
<td>fireUserEventTriggered</td>
<td>è§¦å‘å¯¹ä¸‹ä¸€ä¸ª ChannelInboundHandler ä¸Šçš„ fireUserEventTriggered(Object evt)æ–¹æ³•çš„è°ƒç”¨</td>
</tr>
<tr>
<td>handler</td>
<td>è¿”å›ç»‘å®šåˆ°è¿™ä¸ªå®ä¾‹çš„ ChannelHandler</td>
</tr>
<tr>
<td>isRemoved</td>
<td>å¦‚æœæ‰€å…³è”çš„ ChannelHandler å·²ç»è¢«ä» ChannelPipeline ä¸­ç§»é™¤åˆ™è¿”å› true</td>
</tr>
<tr>
<td>name</td>
<td>è¿”å›è¿™ä¸ªå®ä¾‹çš„å”¯ä¸€åç§°</td>
</tr>
<tr>
<td>pipeline</td>
<td>è¿”å›è¿™ä¸ªå®ä¾‹æ‰€å…³è”çš„ ChannelPipeline</td>
</tr>
<tr>
<td>read</td>
<td>å°†æ•°æ®ä»Channelè¯»å–åˆ°ç¬¬ä¸€ä¸ªå…¥ç«™ç¼“å†²åŒºï¼›å¦‚æœè¯»å–æˆåŠŸåˆ™è§¦å‘ä¸€ä¸ªchannelReadäº‹ä»¶ï¼Œå¹¶ï¼ˆåœ¨æœ€åä¸€ä¸ªæ¶ˆæ¯è¢«è¯»å–å®Œæˆåï¼‰ é€š çŸ¥ ChannelInboundHandler çš„ channelReadComplete (ChannelHandlerContext)æ–¹æ³•ã€‚é€šè¿‡é…åˆ ChannelConfig.setAutoRead(boolean autoRead)æ–¹æ³•ï¼Œå¯ä»¥å®ç°ååº”å¼ç³»ç»Ÿçš„ç‰¹æ€§ ä¹‹ä¸€å›å‹ï¼ˆback-pressureï¼‰</td>
</tr>
<tr>
<td>write</td>
<td>é€šè¿‡è¿™ä¸ªå®ä¾‹å†™å…¥æ¶ˆæ¯å¹¶ç»è¿‡ ChannelPipeline</td>
</tr>
<tr>
<td>writeAndFlush</td>
<td>é€šè¿‡è¿™ä¸ªå®ä¾‹å†™å…¥å¹¶å†²åˆ·æ¶ˆæ¯å¹¶ç»è¿‡ ChannelPipeline</td>
</tr>
</tbody>
</table>
<p>å½“ä½¿ç”¨ ChannelHandlerContext çš„ API çš„æ—¶å€™ï¼Œè¯·ç‰¢è®°ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ul>
<li>ChannelHandlerContext å’Œ ChannelHandler ä¹‹é—´çš„å…³è”ï¼ˆç»‘å®šï¼‰æ˜¯æ°¸è¿œä¸ä¼šæ”¹å˜çš„ï¼Œæ‰€ä»¥ç¼“å­˜å¯¹å®ƒçš„å¼•ç”¨æ˜¯å®‰å…¨çš„ï¼›</li>
<li>å¦‚åŒæˆ‘ä»¬åœ¨æœ¬èŠ‚å¼€å¤´æ‰€è§£é‡Šçš„ä¸€æ ·ï¼Œç›¸å¯¹äºå…¶ä»–ç±»çš„åŒåæ–¹æ³•ï¼ŒChannelHandler Contextçš„æ–¹æ³•å°†äº§ç”Ÿæ›´çŸ­çš„äº‹ä»¶æµï¼Œåº”è¯¥å°½å¯èƒ½åœ°åˆ©ç”¨è¿™ä¸ªç‰¹æ€§æ¥è·å¾—æœ€å¤§çš„æ€§èƒ½ã€‚</li>
</ul>
<h3 id="ä½¿ç”¨-channelhandlercontext">ä½¿ç”¨ ChannelHandlerContext<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨-channelhandlercontext">#</a></h3>
<p>åœ¨è¿™ä¸€èŠ‚ä¸­æˆ‘ä»¬å°†è®¨è®º ChannelHandlerContext çš„ç”¨æ³•ï¼Œä»¥åŠå­˜åœ¨äº ChannelHandlerContextã€
Channel å’Œ ChannelPipeline ä¸Šçš„æ–¹æ³•çš„è¡Œä¸ºã€‚å›¾ 6-4 å±•ç¤ºäº†å®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/41.png"></p>
<p>åœ¨ä»£ç æ¸…å• 6-6 ä¸­ï¼Œå°†é€šè¿‡ ChannelHandlerContext è·å–åˆ° Channel çš„å¼•ç”¨ã€‚è°ƒç”¨
Channel ä¸Šçš„ write()æ–¹æ³•å°†ä¼šå¯¼è‡´å†™å…¥äº‹ä»¶ä»å°¾ç«¯åˆ°å¤´éƒ¨åœ°æµç» ChannelPipelineã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * ä»£ç æ¸…å• 6-6 ä» ChannelHandlerContext è®¿é—® Channel
</span></span><span style="display:flex;"><span> * */
</span></span><span style="display:flex;"><span>public static void writeViaChannel() {
</span></span><span style="display:flex;"><span>	ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; //get reference form somewhere
</span></span><span style="display:flex;"><span>	//è·å–åˆ°ä¸ ChannelHandlerContextç›¸å…³è”çš„ Channel çš„å¼•ç”¨
</span></span><span style="display:flex;"><span>	Channel channel = ctx.channel();
</span></span><span style="display:flex;"><span>	//é€šè¿‡ Channel å†™å…¥ç¼“å†²åŒº
</span></span><span style="display:flex;"><span>	channel.write(Unpooled.copiedBuffer(&#34;Netty in Action&#34;, CharsetUtil.UTF_8));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»£ç æ¸…å• 6-7 å±•ç¤ºäº†ä¸€ä¸ªç±»ä¼¼çš„ä¾‹å­ï¼Œä½†æ˜¯è¿™ä¸€æ¬¡æ˜¯å†™å…¥ ChannelPipelineã€‚æˆ‘ä»¬å†æ¬¡çœ‹
åˆ°ï¼Œï¼ˆåˆ° ChannelPipline çš„ï¼‰å¼•ç”¨æ˜¯é€šè¿‡ ChannelHandlerContext è·å–çš„ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * ä»£ç æ¸…å• 6-7 é€šè¿‡ ChannelHandlerContext è®¿é—® ChannelPipeline
</span></span><span style="display:flex;"><span> * */
</span></span><span style="display:flex;"><span>public static void writeViaChannelPipeline() {
</span></span><span style="display:flex;"><span>	ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; //get reference form somewhere
</span></span><span style="display:flex;"><span>	//è·å–åˆ°ä¸ ChannelHandlerContextç›¸å…³è”çš„ ChannelPipeline çš„å¼•ç”¨
</span></span><span style="display:flex;"><span>	ChannelPipeline pipeline = ctx.pipeline(); //get reference form somewhere
</span></span><span style="display:flex;"><span>	//é€šè¿‡ ChannelPipelineå†™å…¥ç¼“å†²åŒº
</span></span><span style="display:flex;"><span>	pipeline.write(Unpooled.copiedBuffer(&#34;Netty in Action&#34;, CharsetUtil.UTF_8));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚åŒåœ¨å›¾ 6-5 ä¸­æ‰€èƒ½å¤Ÿçœ‹åˆ°çš„ä¸€æ ·ï¼Œä»£ç æ¸…å• 6-6 å’Œä»£ç æ¸…å• 6-7 ä¸­çš„äº‹ä»¶æµæ˜¯ä¸€æ ·çš„ã€‚é‡è¦çš„æ˜¯è¦æ³¨æ„åˆ°ï¼Œè™½ç„¶è¢«è°ƒç”¨çš„ Channel æˆ– ChannelPipeline ä¸Šçš„ write()æ–¹æ³•å°†ä¸€ç›´ä¼ æ’­äº‹ä»¶é€šè¿‡æ•´ä¸ª
ChannelPipelineï¼Œä½†æ˜¯åœ¨ ChannelHandler çš„çº§åˆ«ä¸Šï¼Œäº‹ä»¶ä»ä¸€ä¸ª ChannelHandleråˆ°ä¸‹ä¸€ä¸ª
ChannelHandler çš„ç§»åŠ¨æ˜¯ç”± ChannelHandlerContext ä¸Šçš„è°ƒç”¨å®Œæˆçš„ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/42.png"></p>
<p>ä¸ºä»€ä¹ˆä¼šæƒ³è¦ä» ChannelPipeline ä¸­çš„æŸä¸ªç‰¹å®šç‚¹å¼€å§‹ä¼ æ’­äº‹ä»¶å‘¢ï¼Ÿ</p>
<ul>
<li>ä¸ºäº†å‡å°‘å°†äº‹ä»¶ä¼ ç»å¯¹å®ƒä¸æ„Ÿå…´è¶£çš„ ChannelHandler æ‰€å¸¦æ¥çš„å¼€é”€ã€‚</li>
<li>ä¸ºäº†é¿å…å°†äº‹ä»¶ä¼ ç»é‚£äº›å¯èƒ½ä¼šå¯¹å®ƒæ„Ÿå…´è¶£çš„ ChannelHandlerã€‚
è¦æƒ³è°ƒç”¨ä»æŸä¸ªç‰¹å®šçš„ ChannelHandler å¼€å§‹çš„å¤„ç†è¿‡ç¨‹ï¼Œå¿…é¡»è·å–åˆ°åœ¨ï¼ˆChannelPipelineï¼‰è¯¥
ChannelHandler ä¹‹å‰çš„ ChannelHandler æ‰€å…³è”çš„ ChannelHandlerContextã€‚è¿™ä¸ª ChannelHandlerContextå°†è°ƒç”¨å’Œå®ƒæ‰€å…³è”çš„ ChannelHandler ä¹‹åçš„ChannelHandlerã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * ä»£ç æ¸…å• 6-8 è°ƒç”¨ ChannelHandlerContext çš„ write()æ–¹æ³•
</span></span><span style="display:flex;"><span> * */
</span></span><span style="display:flex;"><span>public static void writeViaChannelHandlerContext() {
</span></span><span style="display:flex;"><span>	//è·å–åˆ° ChannelHandlerContext çš„å¼•ç”¨
</span></span><span style="display:flex;"><span>	ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; //get reference form somewhere;
</span></span><span style="display:flex;"><span>	//write()æ–¹æ³•å°†æŠŠç¼“å†²åŒºæ•°æ®å‘é€åˆ°ä¸‹ä¸€ä¸ª ChannelHandler
</span></span><span style="display:flex;"><span>	ctx.write(Unpooled.copiedBuffer(&#34;Netty in Action&#34;, CharsetUtil.UTF_8));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/43.png"></p>
<h3 id="channelhandler-å’Œ-channelhandlercontext-çš„é«˜çº§ç”¨æ³•">ChannelHandler å’Œ ChannelHandlerContext çš„é«˜çº§ç”¨æ³•<a hidden class="anchor" aria-hidden="true" href="#channelhandler-å’Œ-channelhandlercontext-çš„é«˜çº§ç”¨æ³•">#</a></h3>
<p>æ­£å¦‚æˆ‘ä»¬åœ¨ä»£ç æ¸…å• 6-6 ä¸­æ‰€çœ‹åˆ°çš„ï¼Œä½ å¯ä»¥é€šè¿‡è°ƒç”¨ ChannelHandlerContext ä¸Šçš„pipeline()æ–¹æ³•æ¥è·å¾—è¢«å°é—­çš„ ChannelPipeline çš„å¼•ç”¨ã€‚è¿™ä½¿å¾—è¿è¡Œæ—¶å¾—ä»¥æ“ä½œChannelPipeline çš„ ChannelHandlerï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ¥å®ç°ä¸€äº›å¤æ‚çš„è®¾è®¡ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡å°† ChannelHandler æ·»åŠ åˆ° ChannelPipeline ä¸­æ¥å®ç°åŠ¨æ€çš„åè®®åˆ‡æ¢ã€‚</p>
<p>å¦ä¸€ç§é«˜çº§çš„ç”¨æ³•æ˜¯ç¼“å­˜åˆ° ChannelHandlerContext çš„å¼•ç”¨ä»¥ä¾›ç¨åä½¿ç”¨ï¼Œè¿™å¯èƒ½ä¼šå‘ç”Ÿåœ¨ä»»ä½•çš„
ChannelHandler æ–¹æ³•ä¹‹å¤–ï¼Œç”šè‡³æ¥è‡ªäºä¸åŒçš„çº¿ç¨‹ã€‚ä»£ç æ¸…å• 6-9 å±•ç¤ºäº†ç”¨è¿™ç§æ¨¡å¼æ¥è§¦å‘äº‹ä»¶ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 6-9 ç¼“å­˜åˆ° ChannelHandlerContext çš„å¼•ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WriteHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelHandlerAdapter {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> ChannelHandlerContext ctx;
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handlerAdded(ChannelHandlerContext ctx) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å­˜å‚¨åˆ° ChannelHandlerContextçš„å¼•ç”¨ä»¥ä¾›ç¨åä½¿ç”¨</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">ctx</span> = ctx;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> send(String msg) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä½¿ç”¨ä¹‹å‰å­˜å‚¨çš„åˆ° ChannelHandlerContextçš„å¼•ç”¨æ¥å‘é€æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">writeAndFlush</span>(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºä¸€ä¸ª ChannelHandler å¯ä»¥ä»å±äºå¤šä¸ª ChannelPipelineï¼Œæ‰€ä»¥å®ƒä¹Ÿå¯ä»¥ç»‘å®šåˆ°å¤šä¸ª
ChannelHandlerContext å®ä¾‹ã€‚å¯¹äºè¿™ç§ç”¨æ³•æŒ‡åœ¨å¤šä¸ª ChannelPipeline ä¸­å…±äº«åŒä¸€ä¸ª ChannelHandlerï¼Œå¯¹åº”çš„ ChannelHandler å¿…é¡»è¦ä½¿ç”¨@Sharable æ³¨è§£æ ‡æ³¨ï¼›å¦åˆ™ï¼Œè¯•å›¾å°†å®ƒæ·»åŠ åˆ°å¤šä¸ª ChannelPipeline æ—¶å°†ä¼šè§¦å‘å¼‚å¸¸ã€‚æ˜¾è€Œæ˜“è§ï¼Œä¸ºäº†å®‰å…¨åœ°è¢«ç”¨äºå¤šä¸ªå¹¶å‘çš„ Channelï¼ˆå³è¿æ¥ï¼‰ï¼Œè¿™æ ·çš„ ChannelHandler å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä»£ç æ¸…å• 6-10 å±•ç¤ºäº†è¿™ç§æ¨¡å¼çš„ä¸€ä¸ªæ­£ç¡®å®ç°ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 6-10 å¯å…±äº«çš„ ChannelHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//ä½¿ç”¨æ³¨è§£@Sharableæ ‡æ³¨</span>
</span></span><span style="display:flex;"><span>@Sharable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SharableHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead(ChannelHandlerContext ctx, Object msg) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;channel read message &#34;</span> + msg);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®°å½•æ–¹æ³•è°ƒç”¨ï¼Œå¹¶è½¬å‘ç»™ä¸‹ä¸€ä¸ª ChannelHandler</span>
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">fireChannelRead</span>(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‰é¢çš„ ChannelHandler å®ç°ç¬¦åˆæ‰€æœ‰çš„å°†å…¶åŠ å…¥åˆ°å¤šä¸ª ChannelPipeline çš„éœ€æ±‚ï¼Œå³å®ƒä½¿ç”¨äº†æ³¨è§£
@Sharable æ ‡æ³¨ï¼Œå¹¶ä¸”ä¹Ÿä¸æŒæœ‰ä»»ä½•çš„çŠ¶æ€ã€‚ç›¸åï¼Œä»£ç æ¸…å• 6-11 ä¸­çš„å®ç°å°†ä¼šå¯¼è‡´é—®é¢˜ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 6-11 @Sharable çš„é”™è¯¯ç”¨æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//ä½¿ç”¨æ³¨è§£@Sharableæ ‡æ³¨</span>
</span></span><span style="display:flex;"><span>@Sharable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UnsharableHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> count;
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead(ChannelHandlerContext ctx, Object msg) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°† count å­—æ®µçš„å€¼åŠ  1</span>
</span></span><span style="display:flex;"><span>        count++;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®°å½•æ–¹æ³•è°ƒç”¨ï¼Œå¹¶è½¬å‘ç»™ä¸‹ä¸€ä¸ªChannelHandler</span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;inboundBufferUpdated(...) called the &#34;</span> + count + <span style="color:#0ff;font-weight:bold">&#34; time&#34;</span>);
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">fireChannelRead</span>(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ®µä»£ç çš„ä¸»è¦çš„é—®é¢˜åœ¨äºï¼Œå¯¹äºå…¶æ‰€æŒæœ‰çš„çŠ¶æ€çš„ä¿®æ”¹å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ AtomicIntegeræ¥è§„é¿è¿™ä¸ªé—®é¢˜ï¼‰ï¼Œå³ç”¨äºè·Ÿè¸ªæ–¹æ³•è°ƒç”¨æ¬¡æ•°çš„å®ä¾‹å˜é‡countã€‚å°†è¿™ä¸ªç±»çš„ä¸€ä¸ªå®ä¾‹æ·»åŠ åˆ°ChannelPipelineå°†ææœ‰å¯èƒ½åœ¨å®ƒè¢«å¤šä¸ªå¹¶å‘çš„Channelè®¿é—®æ—¶å¯¼è‡´é—®é¢˜ã€‚ï¼ˆå½“ç„¶ï¼Œè¿™ä¸ªç®€å•çš„é—®é¢˜å¯ä»¥é€šè¿‡ä½¿channelRead()æ–¹æ³•å˜ä¸ºåŒæ­¥æ–¹æ³•æ¥ä¿®æ­£ã€‚ï¼‰
æ€»ä¹‹ï¼Œåªåº”è¯¥åœ¨ç¡®å®šäº†ä½ çš„ ChannelHandler æ˜¯çº¿ç¨‹å®‰å…¨çš„æ—¶æ‰ä½¿ç”¨@Sharable æ³¨è§£ã€‚
ä¸ºä½•è¦å…±äº«åŒä¸€ä¸ªChannelHandler åœ¨å¤šä¸ªChannelPipelineä¸­å®‰è£…åŒä¸€ä¸ªChannelHandlerçš„ä¸€ä¸ªå¸¸è§çš„åŸå› æ˜¯ç”¨äºæ”¶é›†è·¨è¶Šå¤šä¸ª Channel çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p>
<h2 id="å¼‚å¸¸å¤„ç†">å¼‚å¸¸å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#å¼‚å¸¸å¤„ç†">#</a></h2>
<p>å¼‚å¸¸å¤„ç†æ˜¯ç¨‹åºçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼ŒNettyæä¾›äº†å‡ ç§æ–¹å¼ç”¨äºå¤„ç†å‡ºå…¥ç«™è¿‡ç¨‹ä¸­æ‰€æŠ›å‡ºçš„å¼‚å¸¸ã€‚</p>
<h3 id="å…¥ç«™å¼‚å¸¸">å…¥ç«™å¼‚å¸¸<a hidden class="anchor" aria-hidden="true" href="#å…¥ç«™å¼‚å¸¸">#</a></h3>
<p>å¦‚æœåœ¨å¤„ç†å…¥ç«™äº‹ä»¶çš„è¿‡ç¨‹ä¸­æœ‰å¼‚å¸¸è¢«æŠ›å‡ºï¼Œé‚£ä¹ˆå®ƒå°†ä»å®ƒåœ¨ ChannelInboundHandleré‡Œè¢«è§¦å‘çš„é‚£ä¸€ç‚¹å¼€å§‹æµç» ChannelPipelineã€‚è¦æƒ³å¤„ç†è¿™ç§ç±»å‹çš„å…¥ç«™å¼‚å¸¸ï¼Œä½ éœ€è¦åœ¨ä½ çš„ ChannelInboundHandler å®ç°ä¸­é‡å†™ä¸‹é¢çš„æ–¹æ³•ã€‚
<code>public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception</code></p>
<p>ä»£ç æ¸…å• 6-12 å±•ç¤ºäº†ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå…¶å…³é—­äº† Channel å¹¶æ‰“å°äº†å¼‚å¸¸çš„æ ˆè·Ÿè¸ªä¿¡æ¯ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 6-12 åŸºæœ¬çš„å…¥ç«™å¼‚å¸¸å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> InboundExceptionHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> exceptionCaught(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        Throwable cause) {
</span></span><span style="display:flex;"><span>        cause.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºå¼‚å¸¸å°†ä¼šç»§ç»­æŒ‰ç…§å…¥ç«™æ–¹å‘æµåŠ¨ï¼ˆå°±åƒæ‰€æœ‰çš„å…¥ç«™äº‹ä»¶ä¸€æ ·ï¼‰ï¼Œæ‰€ä»¥å®ç°äº†å‰é¢æ‰€ç¤ºé€»è¾‘çš„
ChannelInboundHandler é€šå¸¸ä½äº ChannelPipeline çš„æœ€åã€‚è¿™ç¡®ä¿äº†æ‰€æœ‰çš„å…¥ç«™å¼‚å¸¸éƒ½æ€»æ˜¯ä¼šè¢«å¤„ç†ï¼Œæ— è®ºå®ƒä»¬å¯èƒ½ä¼šå‘ç”Ÿåœ¨ ChannelPipeline ä¸­çš„ä»€ä¹ˆä½ç½®ã€‚
ä½ åº”è¯¥å¦‚ä½•å“åº”å¼‚å¸¸ï¼Œå¯èƒ½å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºä½ çš„åº”ç”¨ç¨‹åºã€‚ä½ å¯èƒ½æƒ³è¦å…³é—­Channelï¼ˆå’Œè¿æ¥ï¼‰ï¼Œä¹Ÿå¯èƒ½ä¼šå°è¯•è¿›è¡Œæ¢å¤ã€‚å¦‚æœä½ ä¸å®ç°ä»»ä½•å¤„ç†å…¥ç«™å¼‚å¸¸çš„é€»è¾‘ï¼ˆæˆ–è€…æ²¡æœ‰æ¶ˆè´¹è¯¥å¼‚å¸¸ï¼‰ï¼Œé‚£ä¹ˆNettyå°†ä¼šè®°å½•è¯¥å¼‚å¸¸æ²¡æœ‰è¢«å¤„ç†çš„äº‹å®ï¼Œå³ Netty å°†ä¼šé€šè¿‡ Warning çº§åˆ«çš„æ—¥å¿—è®°å½•è¯¥å¼‚å¸¸åˆ°è¾¾äº† ChannelPipeline çš„å°¾ç«¯ï¼Œä½†æ²¡æœ‰è¢«å¤„ç†ï¼Œå¹¶å°è¯•é‡Šæ”¾è¯¥å¼‚å¸¸ã€‚
æ€»ç»“ï¼š</p>
<ul>
<li>ChannelHandler.exceptionCaught()çš„é»˜è®¤å®ç°æ˜¯ç®€å•åœ°å°†å½“å‰å¼‚å¸¸è½¬å‘ç»™ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ªChannelHandlerï¼›</li>
<li>å¦‚æœå¼‚å¸¸åˆ°è¾¾äº† ChannelPipeline çš„å°¾ç«¯ï¼Œå®ƒå°†ä¼šè¢«è®°å½•ä¸ºæœªè¢«å¤„ç†ï¼›</li>
<li>è¦æƒ³å®šä¹‰è‡ªå®šä¹‰çš„å¤„ç†é€»è¾‘ï¼Œä½ éœ€è¦é‡å†™ exceptionCaught()æ–¹æ³•ã€‚ç„¶åä½ éœ€è¦å†³å®šæ˜¯å¦éœ€è¦å°†è¯¥å¼‚å¸¸ä¼ æ’­å‡ºå»ã€‚</li>
</ul>
<h3 id="å‡ºç«™å¼‚å¸¸">å‡ºç«™å¼‚å¸¸<a hidden class="anchor" aria-hidden="true" href="#å‡ºç«™å¼‚å¸¸">#</a></h3>
<p>ç”¨äºå¤„ç†å‡ºç«™æ“ä½œä¸­çš„æ­£å¸¸å®Œæˆä»¥åŠå¼‚å¸¸çš„é€‰é¡¹ï¼Œéƒ½åŸºäºä»¥ä¸‹çš„é€šçŸ¥æœºåˆ¶ã€‚</p>
<ul>
<li>æ¯ä¸ªå‡ºç«™æ“ä½œéƒ½å°†è¿”å›ä¸€ä¸ª ChannelFutureã€‚æ³¨å†Œåˆ° ChannelFuture çš„ ChannelFutureListener å°†åœ¨æ“ä½œå®Œæˆæ—¶è¢«é€šçŸ¥è¯¥æ“ä½œæ˜¯æˆåŠŸäº†è¿˜æ˜¯å‡ºé”™äº†ã€‚</li>
<li>å‡ ä¹æ‰€æœ‰çš„ ChannelOutboundHandler ä¸Šçš„æ–¹æ³•éƒ½ä¼šä¼ å…¥ä¸€ä¸ª ChannelPromiseçš„å®ä¾‹ã€‚ä½œä¸ºChannelFutureçš„å­ç±»ï¼ŒChannelPromise ä¹Ÿå¯ä»¥è¢«åˆ†é…ç”¨äºå¼‚æ­¥é€šçŸ¥çš„ç›‘å¬å™¨ã€‚ä½†æ˜¯ï¼ŒChannelPromise è¿˜å…·æœ‰æä¾›ç«‹å³é€šçŸ¥çš„å¯å†™æ–¹æ³•ï¼š
ChannelPromise setSuccess();
ChannelPromise setFailure(Throwable cause);</li>
</ul>
<p>æ·»åŠ  ChannelFutureListener åªéœ€è¦è°ƒç”¨ ChannelFuture å®ä¾‹ä¸Šçš„ addListener
(ChannelFutureListener)æ–¹æ³•ï¼Œå¹¶ä¸”æœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚å…¶ä¸­æœ€å¸¸ç”¨çš„æ–¹å¼æ˜¯ï¼Œè°ƒç”¨å‡ºç«™æ“ä½œï¼ˆå¦‚ write()æ–¹æ³•ï¼‰æ‰€è¿”å›çš„ ChannelFuture ä¸Šçš„ addListener()æ–¹æ³•ã€‚
ä»£ç æ¸…å• 6-13 ä½¿ç”¨äº†è¿™ç§æ–¹å¼æ¥æ·»åŠ  ChannelFutureListenerï¼Œå®ƒå°†æ‰“å°æ ˆè·Ÿè¸ªä¿¡æ¯å¹¶ä¸”éšåå…³é—­ Channelã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * Created by kerr.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 6-13 æ·»åŠ  ChannelFutureListener åˆ° ChannelFuture
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ChannelFutures {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> Channel CHANNEL_FROM_SOMEWHERE = <span style="color:#fff;font-weight:bold">new</span> NioSocketChannel();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ByteBuf SOME_MSG_FROM_SOMEWHERE = Unpooled.<span style="color:#007f7f">buffer</span>(1024);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 6-13 æ·»åŠ  ChannelFutureListener åˆ° ChannelFuture
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> addingChannelFutureListener(){
</span></span><span style="display:flex;"><span>        Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference to pipeline;</span>
</span></span><span style="display:flex;"><span>        ByteBuf someMessage = SOME_MSG_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference to pipeline;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>        io.<span style="color:#007f7f">netty</span>.<span style="color:#007f7f">channel</span>.<span style="color:#007f7f">ChannelFuture</span> future = channel.<span style="color:#007f7f">write</span>(someMessage);
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(io.<span style="color:#007f7f">netty</span>.<span style="color:#007f7f">channel</span>.<span style="color:#007f7f">ChannelFuture</span> f) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (!f.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    f.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                    f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬äºŒç§æ–¹å¼æ˜¯å°† ChannelFutureListener æ·»åŠ åˆ°å³å°†ä½œä¸ºå‚æ•°ä¼ é€’ç»™ ChannelOutboundHandler çš„æ–¹æ³•çš„ChannelPromiseã€‚ä»£ç æ¸…å• 6-14 ä¸­æ‰€å±•ç¤ºçš„ä»£ç å’Œä»£ç æ¸…å• 6-13ä¸­æ‰€å±•ç¤ºçš„å…·æœ‰ç›¸åŒçš„æ•ˆæœã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 6-14 æ·»åŠ  ChannelFutureListener åˆ° ChannelPromise
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OutboundExceptionHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelOutboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> write(ChannelHandlerContext ctx, Object msg,
</span></span><span style="display:flex;"><span>        ChannelPromise promise) {
</span></span><span style="display:flex;"><span>        promise.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture f) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (!f.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    f.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                    f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ChannelPromise çš„å¯å†™æ–¹æ³•ï¼š
é€šè¿‡è°ƒç”¨ ChannelPromise ä¸Šçš„ setSuccess()å’Œ setFailure()æ–¹æ³•ï¼Œå¯ä»¥ä½¿ä¸€ä¸ªæ“ä½œçš„çŠ¶æ€åœ¨
ChannelHandler çš„æ–¹æ³•è¿”å›ç»™å…¶è°ƒç”¨è€…æ—¶ä¾¿å³åˆ»è¢«æ„ŸçŸ¥åˆ°ã€‚
ä¸ºä½•é€‰æ‹©ä¸€ç§æ–¹å¼è€Œä¸æ˜¯å¦ä¸€ç§å‘¢ï¼Ÿå¯¹äºç»†è‡´çš„å¼‚å¸¸å¤„ç†ï¼Œä½ å¯èƒ½ä¼šå‘ç°ï¼Œåœ¨è°ƒç”¨å‡ºç«™æ“ä½œæ—¶æ·»åŠ 
ChannelFutureListener æ›´åˆé€‚ï¼Œå¦‚ä»£ç æ¸…å• 6-13 æ‰€ç¤ºã€‚è€Œå¯¹äºä¸€èˆ¬çš„å¼‚å¸¸å¤„ç†ï¼Œä½ å¯èƒ½ä¼šå‘ç°ï¼Œ
ä»£ç æ¸…å• 6-14 æ‰€ç¤ºçš„è‡ªå®šä¹‰çš„ ChannelOutboundHandler å®ç°çš„æ–¹å¼æ›´åŠ çš„ç®€å•ã€‚
å¦‚æœä½ çš„ ChannelOutboundHandler æœ¬èº«æŠ›å‡ºäº†å¼‚å¸¸ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒNetty æœ¬èº«ä¼šé€šçŸ¥ä»»ä½•å·²ç»æ³¨å†Œåˆ°å¯¹åº” ChannelPromise çš„ç›‘å¬å™¨ã€‚</p>
<h1 id="eventloopå’Œçº¿ç¨‹æ¨¡å‹">EventLoopå’Œçº¿ç¨‹æ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#eventloopå’Œçº¿ç¨‹æ¨¡å‹">#</a></h1>
<p>ç®€å•åœ°è¯´ï¼Œçº¿ç¨‹æ¨¡å‹æŒ‡å®šäº†æ“ä½œç³»ç»Ÿã€ç¼–ç¨‹è¯­è¨€ã€æ¡†æ¶æˆ–è€…åº”ç”¨ç¨‹åºçš„ä¸Šä¸‹æ–‡ä¸­çš„çº¿ç¨‹ç®¡ç†çš„å…³é”®æ–¹é¢ã€‚æ˜¾è€Œæ˜“è§åœ°ï¼Œå¦‚ä½•ä»¥åŠä½•æ—¶åˆ›å»ºçº¿ç¨‹å°†å¯¹åº”ç”¨ç¨‹åºä»£ç çš„æ‰§è¡Œäº§ç”Ÿæ˜¾è‘—çš„å½±å“ï¼Œå› æ­¤å¼€å‘äººå‘˜éœ€è¦ç†è§£ä¸ä¸åŒæ¨¡å‹ç›¸å…³çš„æƒè¡¡ã€‚æ— è®ºæ˜¯ä»–ä»¬è‡ªå·±é€‰æ‹©æ¨¡å‹ï¼Œè¿˜æ˜¯é€šè¿‡é‡‡ç”¨æŸç§ç¼–ç¨‹è¯­è¨€æˆ–è€…æ¡†æ¶éšå¼åœ°è·å¾—å®ƒï¼Œè¿™éƒ½æ˜¯çœŸå®çš„ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†åœ°æ¢è®¨ Netty çš„çº¿ç¨‹æ¨¡å‹ã€‚å®ƒå¼ºå¤§ä½†åˆæ˜“ç”¨ï¼Œå¹¶ä¸”å’Œ Netty çš„ä¸€è´¯å®—æ—¨ä¸€æ ·ï¼Œæ—¨åœ¨ç®€åŒ–ä½ çš„åº”ç”¨ç¨‹åºä»£ç ï¼ŒåŒæ—¶æœ€å¤§é™åº¦åœ°æé«˜æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚æˆ‘ä»¬è¿˜å°†è®¨è®ºè‡´ä½¿é€‰æ‹©å½“å‰çº¿ç¨‹æ¨¡å‹çš„ç»éªŒã€‚</p>
<h2 id="çº¿ç¨‹æ¨¡å‹æ¦‚è¿°">çº¿ç¨‹æ¨¡å‹æ¦‚è¿°<a hidden class="anchor" aria-hidden="true" href="#çº¿ç¨‹æ¨¡å‹æ¦‚è¿°">#</a></h2>
<p>æ­£å¦‚æˆ‘ä»¬åœ¨æœ¬ç« å¼€å¤´æ‰€æŒ‡å‡ºçš„ï¼Œçº¿ç¨‹æ¨¡å‹ç¡®å®šäº†ä»£ç çš„æ‰§è¡Œæ–¹å¼ã€‚ç”±äºæˆ‘ä»¬æ€»æ˜¯å¿…é¡»è§„é¿å¹¶å‘æ‰§è¡Œå¯èƒ½ä¼šå¸¦æ¥çš„å‰¯ä½œç”¨ï¼Œæ‰€ä»¥ç†è§£æ‰€é‡‡ç”¨çš„å¹¶å‘æ¨¡å‹ï¼ˆä¹Ÿæœ‰å•çº¿ç¨‹çš„çº¿ç¨‹æ¨¡å‹ï¼‰çš„å½±å“å¾ˆé‡è¦ã€‚å¿½ç•¥è¿™äº›é—®é¢˜ï¼Œä»…å¯„å¸Œæœ›äºæœ€å¥½çš„æƒ…å†µï¼ˆä¸ä¼šå¼•å‘å¹¶å‘é—®é¢˜ï¼‰æ— ç–‘æ˜¯æ©è€³ç›—é“ƒã€‚</p>
<p>ç°åœ¨å¤šæ ¸å¿ƒå¤šçº¿ç¨‹çš„CPUå·²ç»å¸ç©ºè§æƒ¯ï¼Œå¤§å¤šæ•°çš„ç°ä»£åº”ç”¨ç¨‹åºéƒ½åˆ©ç”¨äº†å¤æ‚çš„å¤šçº¿ç¨‹å¤„ç†æŠ€æœ¯ä»¥æœ‰æ•ˆåœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨æ—©æœŸçš„ Java è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†çš„ä¸»è¦æ–¹å¼æ— éæ˜¯æŒ‰éœ€åˆ›å»ºå’Œå¯åŠ¨æ–°çš„Thread æ¥æ‰§è¡Œå¹¶å‘çš„ä»»åŠ¡å•å…ƒï¼ˆä¸€ç§åœ¨é«˜è´Ÿè½½ä¸‹å·¥ä½œå¾—å¾ˆå·®çš„åŸå§‹æ–¹å¼ã€‚ï¼‰
Java 5 éšåå¼•å…¥äº† Executor APIï¼Œå…¶çº¿ç¨‹æ± é€šè¿‡ç¼“å­˜å’Œé‡ç”¨Thread æå¤§åœ°æé«˜äº†æ€§èƒ½ã€‚</p>
<p>åŸºæœ¬çš„çº¿ç¨‹æ± åŒ–æ¨¡å¼å¯ä»¥æè¿°ä¸ºï¼š</p>
<ul>
<li>ä»æ± çš„ç©ºé—²çº¿ç¨‹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ª Threadï¼Œå¹¶ä¸”æŒ‡æ´¾å®ƒå»è¿è¡Œä¸€ä¸ªå·²æäº¤çš„ä»»åŠ¡ï¼ˆä¸€ä¸ªRunnable çš„å®ç°ï¼‰ï¼›</li>
<li>å½“ä»»åŠ¡å®Œæˆæ—¶ï¼Œå°†è¯¥ Thread è¿”å›ç»™è¯¥åˆ—è¡¨ï¼Œä½¿å…¶å¯è¢«é‡ç”¨ã€‚å›¾ 7-1 è¯´æ˜äº†è¿™ä¸ªæ¨¡å¼ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/44.png">
è™½ç„¶æ± åŒ–å’Œé‡ç”¨çº¿ç¨‹ç›¸å¯¹äºç®€å•åœ°ä¸ºæ¯ä¸ªä»»åŠ¡éƒ½åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹æ˜¯ä¸€ç§è¿›æ­¥ï¼Œä½†æ˜¯å®ƒå¹¶ä¸èƒ½æ¶ˆé™¤ç”±ä¸Šä¸‹æ–‡åˆ‡æ¢æ‰€å¸¦æ¥çš„å¼€é”€ï¼Œå…¶å°†éšç€çº¿ç¨‹æ•°é‡çš„å¢åŠ å¾ˆå¿«å˜å¾—æ˜æ˜¾ï¼Œå¹¶ä¸”åœ¨é«˜è´Ÿè½½ä¸‹æ„ˆæ¼”æ„ˆçƒˆã€‚æ­¤å¤–ï¼Œä»…ä»…ç”±äºåº”ç”¨ç¨‹åºçš„æ•´ä½“å¤æ‚æ€§æˆ–è€…å¹¶å‘éœ€æ±‚ï¼Œåœ¨é¡¹ç›®çš„ç”Ÿå‘½å‘¨æœŸå†…ä¹Ÿå¯èƒ½ä¼šå‡ºç°å…¶ä»–å’Œçº¿ç¨‹ç›¸å…³çš„é—®é¢˜ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå¤šçº¿ç¨‹å¤„ç†æ˜¯å¾ˆå¤æ‚çš„ã€‚åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ° Netty æ˜¯å¦‚ä½•å¸®åŠ©ç®€åŒ–å®ƒçš„ã€‚</li>
</ul>
<h2 id="eventloopæ¥å£-1">EventLoopæ¥å£<a hidden class="anchor" aria-hidden="true" href="#eventloopæ¥å£-1">#</a></h2>
<p>è¿è¡Œä»»åŠ¡æ¥å¤„ç†åœ¨è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸå†…å‘ç”Ÿçš„äº‹ä»¶æ˜¯ä»»ä½•ç½‘ç»œæ¡†æ¶çš„åŸºæœ¬åŠŸèƒ½ã€‚ä¸ä¹‹ç›¸åº”çš„ç¼–ç¨‹ä¸Šçš„æ„é€ é€šå¸¸è¢«ç§°ä¸ºäº‹ä»¶å¾ªç¯ï¼šä¸€ä¸ª Netty ä½¿ç”¨äº† interface io.netty.channel.EventLoop æ¥é€‚é…çš„æœ¯è¯­ã€‚
ä»£ç æ¸…å• 7-1 ä¸­è¯´æ˜äº†äº‹ä»¶å¾ªç¯çš„åŸºæœ¬æ€æƒ³ï¼Œå…¶ä¸­æ¯ä¸ªä»»åŠ¡éƒ½æ˜¯ä¸€ä¸ª Runnable çš„å®ä¾‹ï¼ˆå¦‚å›¾ 7-1 æ‰€ç¤ºï¼‰ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 7-1 åœ¨äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œä»»åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EventLoopExamples {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 7-1 åœ¨äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œä»»åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> executeTaskInEventLoop() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">boolean</span> terminated = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> (!terminated) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//é˜»å¡ï¼Œç›´åˆ°æœ‰äº‹ä»¶å·²ç»å°±ç»ªå¯è¢«è¿è¡Œ</span>
</span></span><span style="display:flex;"><span>            List&lt;Runnable&gt; readyEvents = blockUntilEventsReady();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (Runnable ev: readyEvents) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å¾ªç¯éå†ï¼Œå¹¶å¤„ç†æ‰€æœ‰çš„äº‹ä»¶</span>
</span></span><span style="display:flex;"><span>                ev.<span style="color:#007f7f">run</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;Runnable&gt; blockUntilEventsReady() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> Collections.&lt;Runnable&gt;singletonList(<span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                    Thread.<span style="color:#007f7f">sleep</span>(1000);
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>                    e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty çš„ EventLoop æ˜¯ååŒè®¾è®¡çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒé‡‡ç”¨äº†ä¸¤ä¸ªåŸºæœ¬çš„ APIï¼šå¹¶å‘å’Œç½‘ç»œç¼–ç¨‹ã€‚
é¦–å…ˆï¼Œio.netty.util.concurrent åŒ…æ„å»ºåœ¨ JDK çš„ java.util.concurrent åŒ…ä¸Šï¼Œç”¨æ¥æä¾›çº¿ç¨‹æ‰§è¡Œå™¨ã€‚
å…¶æ¬¡ï¼Œio.netty.channel åŒ…ä¸­çš„ç±»ï¼Œä¸ºäº†ä¸ Channel çš„äº‹ä»¶è¿›è¡Œäº¤äº’ï¼Œæ‰©å±•äº†è¿™äº›æ¥å£/ç±»ã€‚
å›¾ 7-2 å±•ç¤ºäº†ç”Ÿæˆçš„ç±»å±‚æ¬¡ç»“æ„ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/45.png"></p>
<p>åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œä¸€ä¸ª EventLoop å°†ç”±ä¸€ä¸ªæ°¸è¿œéƒ½ä¸ä¼šæ”¹å˜çš„ Thread é©±åŠ¨ï¼Œ
åŒæ—¶ä»»åŠ¡ï¼ˆRunnable æˆ–è€… Callableï¼‰å¯ä»¥ç›´æ¥æäº¤ç»™ EventLoop å®ç°ï¼Œä»¥ç«‹å³æ‰§è¡Œæˆ–è€…è°ƒåº¦æ‰§è¡Œã€‚æ ¹æ®é…ç½®å’Œå¯ç”¨æ ¸å¿ƒçš„ä¸åŒï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤šä¸ª EventLoop å®ä¾‹ç”¨ä»¥ä¼˜åŒ–èµ„æºçš„ä½¿ç”¨ï¼Œå¹¶ä¸”å•ä¸ªEventLoop å¯èƒ½ä¼šè¢«æŒ‡æ´¾ç”¨äºæœåŠ¡å¤šä¸ª Channelã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒNettyçš„EventLoopåœ¨ç»§æ‰¿äº†ScheduledExecutorServiceçš„åŒæ—¶ï¼Œåªå®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•ï¼Œparent()ã€‚è¿™ä¸ªæ–¹æ³•é‡å†™äº† EventExecutor çš„ EventExecutorGroup.parent()æ–¹æ³•ã€‚ç”¨äºè¿”å›åˆ°å½“å‰EventLoopå®ç°çš„å®ä¾‹æ‰€å±çš„EventLoopGroupçš„å¼•ç”¨ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>public interface EventLoop <span style="color:#fff;font-weight:bold">extends</span> EventExecutor, EventLoopGroup {
</span></span><span style="display:flex;"><span><span style="color:#f00">@</span>Override
</span></span><span style="display:flex;"><span>EventLoopGroup parent();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>äº‹ä»¶/ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼š
äº‹ä»¶å’Œä»»åŠ¡æ˜¯ä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºæ‰§è¡Œçš„ã€‚è¿™æ ·å¯ä»¥é€šè¿‡ä¿è¯å­—èŠ‚å†…å®¹æ€»æ˜¯æŒ‰æ­£ç¡®çš„é¡ºåºè¢«å¤„ç†ï¼Œæ¶ˆé™¤æ½œåœ¨çš„æ•°æ®æŸåçš„å¯èƒ½æ€§ã€‚</p>
<h3 id="netty-4-ä¸­çš„-io-å’Œäº‹ä»¶å¤„ç†">Netty 4 ä¸­çš„ I/O å’Œäº‹ä»¶å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#netty-4-ä¸­çš„-io-å’Œäº‹ä»¶å¤„ç†">#</a></h3>
<p>æ­£å¦‚æˆ‘ä»¬åœ¨ç¬¬ 6 ç« ä¸­æ‰€è¯¦ç»†æè¿°çš„ï¼Œç”± I/O æ“ä½œè§¦å‘çš„äº‹ä»¶å°†æµç»å®‰è£…äº†ä¸€ä¸ªæˆ–è€…å¤šä¸ªChannelHandlerçš„ChannelPipelineã€‚ä¼ æ’­è¿™äº›äº‹ä»¶çš„æ–¹æ³•è°ƒç”¨å¯ä»¥éšåè¢« ChannelHandler æ‰€æ‹¦æˆªï¼Œå¹¶ä¸”å¯ä»¥æŒ‰éœ€åœ°å¤„ç†äº‹ä»¶ã€‚
äº‹ä»¶çš„æ€§è´¨é€šå¸¸å†³å®šäº†å®ƒå°†è¢«å¦‚ä½•å¤„ç†ï¼›å®ƒå¯èƒ½å°†æ•°æ®ä»ç½‘ç»œæ ˆä¸­ä¼ é€’åˆ°ä½ çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ–è€…è¿›è¡Œé€†å‘æ“ä½œï¼Œæˆ–è€… æ‰§è¡Œä¸€äº›æˆªç„¶ä¸åŒçš„æ“ä½œã€‚ä½†æ˜¯äº‹ä»¶çš„å¤„ç†é€»è¾‘å¿…é¡»è¶³å¤Ÿçš„é€šç”¨å’Œçµæ´»ï¼Œä»¥å¤„ç†æ‰€æœ‰å¯èƒ½çš„ç”¨ä¾‹ã€‚å› æ­¤ï¼Œåœ¨Netty 4 ä¸­ï¼Œæ‰€æœ‰çš„I/Oæ“ä½œå’Œäº‹ä»¶éƒ½ç”±å·²ç»è¢«åˆ†é…ç»™äº†EventLoopçš„é‚£ä¸ªThreadæ¥å¤„ç†ã€‚</p>
<h3 id="netty-3-ä¸­çš„-io-æ“ä½œ">Netty 3 ä¸­çš„ I/O æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#netty-3-ä¸­çš„-io-æ“ä½œ">#</a></h3>
<p>åœ¨ä»¥å‰çš„ç‰ˆæœ¬ä¸­æ‰€ä½¿ç”¨çš„çº¿ç¨‹æ¨¡å‹åªä¿è¯äº†å…¥ç«™ï¼ˆä¹‹å‰ç§°ä¸ºä¸Šæ¸¸ï¼‰äº‹ä»¶ä¼šåœ¨æ‰€è°“çš„ I/O çº¿ç¨‹ï¼ˆå¯¹åº”äºNetty 4 ä¸­çš„ EventLoopï¼‰ä¸­æ‰§è¡Œã€‚æ‰€æœ‰çš„å‡ºç«™ï¼ˆä¸‹æ¸¸ï¼‰äº‹ä»¶éƒ½ç”±è°ƒç”¨çº¿ç¨‹å¤„ç†ï¼Œå…¶å¯èƒ½æ˜¯ I/O çº¿ç¨‹ä¹Ÿå¯èƒ½æ˜¯åˆ«çš„çº¿ç¨‹ã€‚å¼€å§‹çœ‹èµ·æ¥è¿™ä¼¼ä¹æ˜¯ä¸ªå¥½ä¸»æ„ï¼Œä½†æ˜¯å·²ç»è¢«å‘ç°æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºéœ€è¦åœ¨ ChannelHandler ä¸­å¯¹å‡ºç«™äº‹ä»¶è¿›è¡Œä»”ç»†çš„åŒæ­¥ã€‚ç®€è€Œè¨€ä¹‹ï¼Œä¸å¯èƒ½ä¿è¯å¤šä¸ªçº¿ç¨‹ä¸ä¼šåœ¨åŒä¸€æ—¶åˆ»å°è¯•è®¿é—®å‡ºç«™äº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ é€šè¿‡åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è°ƒç”¨ Channel.write()æ–¹æ³•ï¼Œé’ˆå¯¹åŒä¸€ä¸ª Channel åŒæ—¶è§¦å‘å‡ºç«™çš„äº‹ä»¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚å½“å‡ºç«™äº‹ä»¶è§¦å‘äº†å…¥ç«™äº‹ä»¶æ—¶ï¼Œå°†ä¼šå¯¼è‡´å¦ä¸€ä¸ªè´Ÿé¢å½±å“ã€‚å½“ Channel.write()æ–¹æ³•å¯¼è‡´å¼‚å¸¸æ—¶ï¼Œéœ€è¦ç”Ÿæˆå¹¶è§¦å‘ä¸€ä¸ª exceptionCaught äº‹ä»¶ã€‚ä½†æ˜¯åœ¨ Netty 3 çš„æ¨¡å‹ä¸­ï¼Œç”±äºè¿™æ˜¯ä¸€ä¸ªå…¥ç«™äº‹ä»¶ï¼Œéœ€è¦åœ¨è°ƒç”¨çº¿ç¨‹ä¸­æ‰§è¡Œä»£ç ï¼Œç„¶åå°†äº‹ä»¶ç§»äº¤ç»™ I/O çº¿ç¨‹å»æ‰§è¡Œï¼Œç„¶è€Œè¿™å°†å¸¦æ¥é¢å¤–çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚Netty 4 ä¸­æ‰€é‡‡ç”¨çš„çº¿ç¨‹æ¨¡å‹ï¼Œé€šè¿‡åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†æŸä¸ªç»™å®šçš„ EventLoop ä¸­æ‰€äº§ç”Ÿçš„æ‰€æœ‰äº‹ä»¶ï¼Œè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚è¿™æä¾›äº†ä¸€ä¸ªæ›´åŠ ç®€å•çš„æ‰§è¡Œä½“ç³»æ¶æ„ï¼Œå¹¶ä¸”æ¶ˆé™¤äº†åœ¨å¤šä¸ªChannelHandler ä¸­è¿›è¡ŒåŒæ­¥çš„éœ€è¦ï¼ˆé™¤äº†ä»»ä½•å¯èƒ½éœ€è¦åœ¨å¤šä¸ª Channel ä¸­å…±äº«çš„ï¼‰ã€‚ç°åœ¨ï¼Œå·²ç»ç†è§£äº† EventLoop çš„è§’è‰²ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»»åŠ¡æ˜¯å¦‚ä½•è¢«è°ƒåº¦æ‰§è¡Œçš„å§ã€‚</p>
<h2 id="ä»»åŠ¡è°ƒåº¦">ä»»åŠ¡è°ƒåº¦<a hidden class="anchor" aria-hidden="true" href="#ä»»åŠ¡è°ƒåº¦">#</a></h2>
<p>æœ‰æ—¶å€™ï¼Œä½ å°†éœ€è¦è°ƒåº¦ä¸€ä¸ªä»»åŠ¡ä»¥ä¾¿ç¨åï¼ˆå»¶è¿Ÿï¼‰æ‰§è¡Œæˆ–è€…å‘¨æœŸæ€§åœ°æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½æƒ³è¦æ³¨å†Œä¸€ä¸ªåœ¨å®¢æˆ·ç«¯å·²ç»è¿æ¥äº† 5 åˆ†é’Ÿä¹‹åè§¦å‘çš„ä»»åŠ¡ã€‚ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯ï¼Œå‘é€å¿ƒè·³æ¶ˆæ¯åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼Œä»¥æ£€æŸ¥è¿æ¥æ˜¯å¦ä»ç„¶è¿˜æ´»ç€ã€‚å¦‚æœæ²¡æœ‰å“åº”ï¼Œä½ ä¾¿çŸ¥é“å¯ä»¥å…³é—­è¯¥ Channel äº†ã€‚
åœ¨æ¥ä¸‹æ¥çš„å‡ èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨æ ¸å¿ƒçš„Java API å’Œ Netty çš„ EventLoop æ¥è°ƒåº¦ä»»åŠ¡ã€‚
ç„¶åï¼Œæˆ‘ä»¬å°†ç ”ç©¶ Netty çš„å†…éƒ¨å®ç°ï¼Œå¹¶è®¨è®ºå®ƒçš„ä¼˜ç‚¹å’Œå±€é™æ€§ã€‚</p>
<h3 id="jdk-çš„ä»»åŠ¡è°ƒåº¦-api">JDK çš„ä»»åŠ¡è°ƒåº¦ API<a hidden class="anchor" aria-hidden="true" href="#jdk-çš„ä»»åŠ¡è°ƒåº¦-api">#</a></h3>
<p>åœ¨ Java 5 ä¹‹å‰ï¼Œä»»åŠ¡è°ƒåº¦æ˜¯å»ºç«‹åœ¨ java.util.Timer ç±»ä¹‹ä¸Šçš„ï¼Œå…¶ä½¿ç”¨äº†ä¸€ä¸ªåå° Threadï¼Œå¹¶ä¸”å…·æœ‰ä¸æ ‡å‡†çº¿ç¨‹ç›¸åŒçš„é™åˆ¶ã€‚éšåï¼ŒJDK æä¾›äº† java.util.concurrent åŒ…ï¼Œå®ƒå®šä¹‰äº†
interface ScheduledExecutorServiceã€‚å¦‚ä¸‹æ˜¯ java.util.concurrent.Executorsçš„ç›¸å…³å·¥å‚æ–¹æ³•ã€‚</p>
<p>newScheduledThreadPool( int corePoolSize)
newScheduledThreadPool( int corePoolSize, ThreadFactorythreadFactory)
åˆ›å»ºä¸€ä¸ª ScheduledThreadExecutorServiceï¼Œ ç”¨äºè°ƒåº¦å‘½ä»¤åœ¨æŒ‡å®šå»¶è¿Ÿä¹‹åè¿è¡Œæˆ–è€…å‘¨æœŸæ€§åœ°æ‰§ è¡Œã€‚å®ƒä½¿ç”¨ corePoolSize å‚æ•°æ¥è®¡ç®—çº¿ç¨‹æ•°</p>
<p>newSingleThreadScheduledExecutor(),
newSingleThreadScheduledExecutor( ThreadFactorythreadFactory)
åˆ›å»ºä¸€ä¸ª ScheduledThreadExecutorServiceï¼Œ ç”¨äºè°ƒåº¦å‘½ä»¤åœ¨æŒ‡å®šå»¶è¿Ÿä¹‹åè¿è¡Œæˆ–è€…å‘¨æœŸæ€§åœ°æ‰§è¡Œã€‚å®ƒä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œè¢«è°ƒåº¦çš„ä»»åŠ¡</p>
<p>è™½ç„¶é€‰æ‹©ä¸å¤šï¼Œä½†æ˜¯è¿™äº›é¢„ç½®çš„å®ç°å·²ç»è¶³ä»¥åº”å¯¹å¤§å¤šæ•°çš„ç”¨ä¾‹ã€‚
ä»£ç æ¸…å• 7-2 å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ScheduledExecutorServiceæ¥åœ¨ 60 ç§’çš„å»¶è¿Ÿä¹‹åæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 7-2 ä½¿ç”¨ ScheduledExecutorService è°ƒåº¦ä»»åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> schedule() {
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ªå…¶çº¿ç¨‹æ± å…·æœ‰ 10 ä¸ªçº¿ç¨‹çš„ScheduledExecutorService</span>
</span></span><span style="display:flex;"><span>	ScheduledExecutorService executor = Executors.<span style="color:#007f7f">newScheduledThreadPool</span>(10);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ScheduledFuture&lt;?&gt; future = executor.<span style="color:#007f7f">schedule</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª Runnableï¼Œä»¥ä¾›è°ƒåº¦ç¨åæ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>		@Override
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//è¯¥ä»»åŠ¡è¦æ‰“å°çš„æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>			System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Now it is 60 seconds later&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//è°ƒåº¦ä»»åŠ¡åœ¨ä»ç°åœ¨å¼€å§‹çš„ 60 ç§’ä¹‹åæ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>	}, 60, TimeUnit.<span style="color:#007f7f">SECONDS</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//ä¸€æ—¦è°ƒåº¦ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå°±å…³é—­ ScheduledExecutorService ä»¥é‡Šæ”¾èµ„æº</span>
</span></span><span style="display:flex;"><span>	executor.<span style="color:#007f7f">shutdown</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è™½ç„¶ ScheduledExecutorService API æ˜¯ç›´æˆªäº†å½“çš„ï¼Œä½†æ˜¯åœ¨é«˜è´Ÿè½½ä¸‹å®ƒå°†å¸¦æ¥æ€§èƒ½ä¸Šçš„è´Ÿæ‹…ã€‚
åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ° Netty æ˜¯å¦‚ä½•ä»¥æ›´é«˜çš„æ•ˆç‡æä¾›ç›¸åŒçš„åŠŸèƒ½çš„ã€‚</p>
<h3 id="ä½¿ç”¨-eventloop-è°ƒåº¦ä»»åŠ¡">ä½¿ç”¨ EventLoop è°ƒåº¦ä»»åŠ¡<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨-eventloop-è°ƒåº¦ä»»åŠ¡">#</a></h3>
<p>ScheduledExecutorService çš„å®ç°å…·æœ‰å±€é™æ€§ï¼Œå› ä¸ºä½œä¸ºçº¿ç¨‹æ± ç®¡ç†çš„ä¸€éƒ¨åˆ†ï¼Œå°†ä¼šæœ‰é¢å¤–çš„çº¿ç¨‹åˆ›å»ºã€‚å¦‚æœæœ‰å¤§é‡ä»»åŠ¡è¢«ç´§å‡‘åœ°è°ƒåº¦ï¼Œé‚£ä¹ˆè¿™å°†æˆä¸ºä¸€ä¸ªé—®é¢˜ã€‚Netty é€šè¿‡ Channel çš„ EventLoop å®ç°ä»»åŠ¡è°ƒåº¦è§£å†³äº†è¿™ä¸€é—®é¢˜ï¼Œå¦‚ä»£ç æ¸…å• 7-3 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 7-3 ä½¿ç”¨ EventLoop è°ƒåº¦ä»»åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> scheduleViaEventLoop() {
</span></span><span style="display:flex;"><span>	Channel ch = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference from somewhere</span>
</span></span><span style="display:flex;"><span>	ScheduledFuture&lt;?&gt; future = ch.<span style="color:#007f7f">eventLoop</span>().<span style="color:#007f7f">schedule</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª Runnableä»¥ä¾›è°ƒåº¦ç¨åæ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>		@Override
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//è¦æ‰§è¡Œçš„ä»£ç </span>
</span></span><span style="display:flex;"><span>			System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;60 seconds later&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//è°ƒåº¦ä»»åŠ¡åœ¨ä»ç°åœ¨å¼€å§‹çš„ 60 ç§’ä¹‹åæ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>	}, 60, TimeUnit.<span style="color:#007f7f">SECONDS</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç»è¿‡ 60 ç§’ä¹‹åï¼ŒRunnable å®ä¾‹å°†ç”±åˆ†é…ç»™ Channel çš„ EventLoop æ‰§è¡Œã€‚å¦‚æœè¦è°ƒåº¦ä»»åŠ¡ä»¥æ¯éš” 60 ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œè¯·ä½¿ç”¨ scheduleAtFixedRate()æ–¹æ³•ï¼Œå¦‚ä»£ç æ¸…å• 7-4 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 7-4 ä½¿ç”¨ EventLoop è°ƒåº¦å‘¨æœŸæ€§çš„ä»»åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> scheduleFixedViaEventLoop() {
</span></span><span style="display:flex;"><span>	Channel ch = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference from somewhere</span>
</span></span><span style="display:flex;"><span>	ScheduledFuture&lt;?&gt; future = ch.<span style="color:#007f7f">eventLoop</span>().<span style="color:#007f7f">scheduleAtFixedRate</span>(
</span></span><span style="display:flex;"><span>	   <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª Runnableï¼Œä»¥ä¾›è°ƒåº¦ç¨åæ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>	   <span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>	   @Override
</span></span><span style="display:flex;"><span>	   <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//è¿™å°†ä¸€ç›´è¿è¡Œï¼Œç›´åˆ° ScheduledFuture è¢«å–æ¶ˆ</span>
</span></span><span style="display:flex;"><span>			System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Run every 60 seconds&#34;</span>);
</span></span><span style="display:flex;"><span>	   }
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//è°ƒåº¦åœ¨ 60 ç§’ä¹‹åï¼Œå¹¶ä¸”ä»¥åæ¯é—´éš” 60 ç§’è¿è¡Œ</span>
</span></span><span style="display:flex;"><span>	}, 60, 60, TimeUnit.<span style="color:#007f7f">SECONDS</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æˆ‘ä»¬å‰é¢æ‰€æåˆ°çš„ï¼ŒNettyçš„EventLoopæ‰©å±•äº†ScheduledExecutorServiceï¼ˆè§å›¾7-2ï¼‰ï¼Œæ‰€ä»¥å®ƒæä¾›äº†ä½¿ç”¨JDKå®ç°å¯ç”¨çš„æ‰€æœ‰æ–¹æ³•ï¼ŒåŒ…æ‹¬åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ä½¿ç”¨åˆ°çš„schedule()å’ŒscheduleAtFixedRate()æ–¹æ³•ã€‚
æ‰€æœ‰æ“ä½œçš„å®Œæ•´åˆ—è¡¨å¯ä»¥åœ¨ScheduledExecutorServiceçš„Javadocä¸­æ‰¾åˆ°ã€‚
â‘ Javaå¹³å°ï¼Œæ ‡å‡†ç‰ˆç¬¬8ç‰ˆAPIè§„èŒƒï¼Œjava.util.concurrentï¼ŒInterface ScheduledExecutorServiceï¼š
<a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ScheduledExecutorService.html">http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ScheduledExecutorService.html</a></p>
<p>è¦æƒ³å–æ¶ˆæˆ–è€…æ£€æŸ¥ï¼ˆè¢«è°ƒåº¦ä»»åŠ¡çš„ï¼‰æ‰§è¡ŒçŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨æ¯ä¸ªå¼‚æ­¥æ“ä½œæ‰€è¿”å›çš„ ScheduledFutureã€‚
ä»£ç æ¸…å• 7-5 å±•ç¤ºäº†ä¸€ä¸ªç®€å•çš„å–æ¶ˆæ“ä½œã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 7-5 ä½¿ç”¨ ScheduledFuture å–æ¶ˆä»»åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> cancelingTaskUsingScheduledFuture(){
</span></span><span style="display:flex;"><span>	Channel ch = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference from somewhere</span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//è°ƒåº¦ä»»åŠ¡ï¼Œå¹¶è·å¾—æ‰€è¿”å›çš„ScheduledFuture</span>
</span></span><span style="display:flex;"><span>	ScheduledFuture&lt;?&gt; future = ch.<span style="color:#007f7f">eventLoop</span>().<span style="color:#007f7f">scheduleAtFixedRate</span>(
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>				@Override
</span></span><span style="display:flex;"><span>				<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>					System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Run every 60 seconds&#34;</span>);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}, 60, 60, TimeUnit.<span style="color:#007f7f">SECONDS</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//è¿è¡Œå…¶ä»–ä»£ç </span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">boolean</span> mayInterruptIfRunning = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å–æ¶ˆè¯¥ä»»åŠ¡ï¼Œé˜²æ­¢å®ƒå†æ¬¡è¿è¡Œ</span>
</span></span><span style="display:flex;"><span>	future.<span style="color:#007f7f">cancel</span>(mayInterruptIfRunning);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™äº›ä¾‹å­è¯´æ˜ï¼Œå¯ä»¥åˆ©ç”¨ Netty çš„ä»»åŠ¡è°ƒåº¦åŠŸèƒ½æ¥è·å¾—æ€§èƒ½ä¸Šçš„æå‡ã€‚
åè¿‡æ¥ï¼Œè¿™äº›ä¹Ÿä¾èµ–äºåº•å±‚çš„çº¿ç¨‹æ¨¡å‹ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°†å¯¹å…¶è¿›è¡Œç ”ç©¶ã€‚</p>
<h2 id="å®ç°ç»†èŠ‚">å®ç°ç»†èŠ‚<a hidden class="anchor" aria-hidden="true" href="#å®ç°ç»†èŠ‚">#</a></h2>
<p>è¿™ä¸€èŠ‚å°†æ›´åŠ è¯¦ç»†åœ°æ¢è®¨ Netty çš„çº¿ç¨‹æ¨¡å‹å’Œä»»åŠ¡è°ƒåº¦å®ç°çš„ä¸»è¦å†…å®¹ã€‚
æˆ‘ä»¬ä¹Ÿå°†ä¼šæåˆ°éœ€è¦æ³¨æ„çš„å±€é™æ€§ï¼Œä»¥åŠæ­£åœ¨ä¸æ–­å‘å±•ä¸­çš„é¢†åŸŸã€‚</p>
<h3 id="çº¿ç¨‹ç®¡ç†">çº¿ç¨‹ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#çº¿ç¨‹ç®¡ç†">#</a></h3>
<p>Nettyçº¿ç¨‹æ¨¡å‹çš„å“è¶Šæ€§èƒ½å–å†³äºå¯¹äºå½“å‰æ‰§è¡Œçš„Threadçš„èº«ä»½çš„ç¡®å®šã€‚
ï¼ˆé€šè¿‡è°ƒç”¨ EventLoop çš„ inEventLoop(Thread)æ–¹æ³•å®ç°ï¼‰
ä¹Ÿå°±æ˜¯è¯´ï¼Œç¡®å®šå®ƒæ˜¯å¦æ˜¯åˆ†é…ç»™å½“å‰Channelä»¥åŠå®ƒçš„EventLoopçš„é‚£ä¸€ä¸ªçº¿ç¨‹ã€‚ï¼ˆEventLoopå°†è´Ÿè´£å¤„ç†ä¸€ä¸ªChannelçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…çš„æ‰€æœ‰äº‹ä»¶ã€‚ï¼‰</p>
<p>å¦‚æœï¼ˆå½“å‰ï¼‰è°ƒç”¨çº¿ç¨‹æ­£æ˜¯æ”¯æ’‘ EventLoop çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆæ‰€æäº¤çš„ä»£ç å—å°†ä¼šè¢«ï¼ˆç›´æ¥ï¼‰æ‰§è¡Œã€‚
å¦åˆ™ï¼ŒEventLoop å°†è°ƒåº¦è¯¥ä»»åŠ¡ä»¥ä¾¿ç¨åæ‰§è¡Œï¼Œå¹¶å°†å®ƒæ”¾å…¥åˆ°å†…éƒ¨é˜Ÿåˆ—ä¸­ã€‚å½“ EventLoopä¸‹æ¬¡å¤„ç†å®ƒçš„äº‹ä»¶æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„é‚£äº›ä»»åŠ¡/äº‹ä»¶ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†ä»»ä½•çš„ Thread æ˜¯å¦‚ä½•ä¸ Channel ç›´æ¥äº¤äº’è€Œæ— éœ€åœ¨ChannelHandler ä¸­è¿›è¡Œé¢å¤–åŒæ­¥çš„ã€‚</p>
<p>æ³¨æ„ï¼Œæ¯ä¸ª EventLoop éƒ½æœ‰å®ƒè‡ªå·²çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç‹¬ç«‹äºä»»ä½•å…¶ä»–çš„ EventLoopã€‚
å›¾ 7-3å±•ç¤ºäº† EventLoop ç”¨äºè°ƒåº¦ä»»åŠ¡çš„æ‰§è¡Œé€»è¾‘ã€‚è¿™æ˜¯ Netty çº¿ç¨‹æ¨¡å‹çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/46.png">
æˆ‘ä»¬ä¹‹å‰å·²ç»é˜æ˜äº†ä¸è¦é˜»å¡å½“å‰ I/O çº¿ç¨‹çš„é‡è¦æ€§ã€‚æˆ‘ä»¬å†ä»¥å¦ä¸€ç§æ–¹å¼é‡ç”³ä¸€æ¬¡ï¼šâ€œæ°¸è¿œä¸è¦å°†ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡æ”¾å…¥åˆ°æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œå› ä¸ºå®ƒå°†é˜»å¡éœ€è¦åœ¨åŒä¸€çº¿ç¨‹ä¸Šæ‰§è¡Œçš„ä»»ä½•å…¶ä»–ä»»åŠ¡ã€‚â€å¦‚æœå¿…é¡»è¦è¿›è¡Œé˜»å¡è°ƒç”¨æˆ–è€…æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ä¸€ä¸ªä¸“é—¨çš„EventExecutorã€‚
ï¼ˆè§ 6.2.1 èŠ‚çš„â€œChannelHandler çš„æ‰§è¡Œå’Œé˜»å¡â€ï¼‰ã€‚
é™¤äº†è¿™ç§å—é™çš„åœºæ™¯ï¼Œå¦‚åŒä¼ è¾“æ‰€é‡‡ç”¨çš„ä¸åŒçš„äº‹ä»¶å¤„ç†å®ç°ä¸€æ ·ï¼Œæ‰€ä½¿ç”¨çš„çº¿ç¨‹æ¨¡å‹ä¹Ÿå¯ä»¥å¼ºçƒˆåœ°å½±å“åˆ°æ’é˜Ÿçš„ä»»åŠ¡å¯¹æ•´ä½“ç³»ç»Ÿæ€§èƒ½çš„å½±å“ã€‚ï¼ˆå¦‚åŒæˆ‘ä»¬åœ¨ç¬¬ 4 ç« ä¸­æ‰€çœ‹åˆ°çš„ï¼Œä½¿ç”¨ Nettyå¯ä»¥è½»æ¾åœ°åˆ‡æ¢åˆ°ä¸åŒçš„ä¼ è¾“å®ç°ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹ä½ çš„ä»£ç åº“ã€‚ï¼‰</p>
<h3 id="eventloopçº¿ç¨‹çš„åˆ†é…">EventLoop/çº¿ç¨‹çš„åˆ†é…<a hidden class="anchor" aria-hidden="true" href="#eventloopçº¿ç¨‹çš„åˆ†é…">#</a></h3>
<p>æœåŠ¡äº Channel çš„ I/O å’Œäº‹ä»¶çš„ EventLoop åŒ…å«åœ¨ EventLoopGroup ä¸­ã€‚
æ ¹æ®ä¸åŒçš„ä¼ è¾“å®ç°ï¼ŒEventLoop çš„åˆ›å»ºå’Œåˆ†é…æ–¹å¼ä¹Ÿä¸åŒã€‚</p>
<ol>
<li>å¼‚æ­¥ä¼ è¾“
å¼‚æ­¥ä¼ è¾“å®ç°åªä½¿ç”¨äº†å°‘é‡çš„ EventLoopï¼ˆä»¥åŠå’Œå®ƒä»¬ç›¸å…³è”çš„ Threadï¼‰ï¼Œè€Œä¸”åœ¨å½“å‰çš„çº¿ç¨‹æ¨¡å‹ä¸­ï¼Œå®ƒä»¬å¯èƒ½ä¼šè¢«å¤šä¸ª Channel æ‰€å…±äº«ã€‚è¿™ä½¿å¾—å¯ä»¥é€šè¿‡å°½å¯èƒ½å°‘é‡çš„ Thread æ¥æ”¯æ’‘å¤§é‡çš„ Channelï¼Œè€Œä¸æ˜¯æ¯ä¸ªChannel åˆ†é…ä¸€ä¸ª Threadã€‚
å›¾ 7-4 æ˜¾ç¤ºäº†ä¸€ä¸ª EventLoopGroupï¼Œå®ƒå…·æœ‰ 3 ä¸ªå›ºå®šå¤§å°çš„ EventLoopï¼ˆæ¯ä¸ª EventLoopéƒ½ç”±ä¸€ä¸ªThreadæ”¯æ’‘ï¼‰ã€‚åœ¨åˆ›å»º EventLoopGroup æ—¶å°±ç›´æ¥åˆ†é…äº† EventLoopï¼ˆä»¥åŠæ”¯æ’‘å®ƒä»¬çš„ Threadï¼‰ï¼Œä»¥ç¡®ä¿åœ¨éœ€è¦æ—¶å®ƒä»¬æ˜¯å¯ç”¨çš„ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/47.png"></li>
</ol>
<p>EventLoopGroup è´Ÿè´£ä¸ºæ¯ä¸ªæ–°åˆ›å»ºçš„ Channel åˆ†é…ä¸€ä¸ª EventLoopã€‚åœ¨å½“å‰å®ç°ä¸­ï¼Œä½¿ç”¨é¡ºåºå¾ªç¯ï¼ˆround-robinï¼‰çš„æ–¹å¼è¿›è¡Œåˆ†é…ä»¥è·å–ä¸€ä¸ªå‡è¡¡çš„åˆ†å¸ƒï¼Œå¹¶ä¸”ç›¸åŒçš„ EventLoopå¯èƒ½ä¼šè¢«åˆ†é…ç»™å¤šä¸ªChannelã€‚ï¼ˆè¿™ä¸€ç‚¹åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­å¯èƒ½ä¼šæ”¹å˜ã€‚ï¼‰ä¸€æ—¦ä¸€ä¸ª Channel è¢«åˆ†é…ç»™ä¸€ä¸ª EventLoopï¼Œå®ƒå°†åœ¨å®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­éƒ½ä½¿ç”¨è¿™ä¸ªEventLoopï¼ˆä»¥åŠç›¸å…³è”çš„ Threadï¼‰ã€‚è¿™å°†å½±å“ä½ ChannelHandlerçš„åŒæ­¥å’Œçº¿ç¨‹å®‰å…¨ã€‚</p>
<ol start="2">
<li>é˜»å¡ä¼ è¾“
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/48.png">
é˜»å¡ä¼ è¾“çš„æ¨¡å‹æœ‰æ‰€ä¸åŒã€‚è¿™é‡Œæ¯ä¸€ä¸ª Channel éƒ½å°†è¢«åˆ†é…ç»™ä¸€ä¸ª EventLoopï¼ˆä»¥åŠå®ƒçš„ Threadï¼‰ã€‚å¯ä»¥ä¿è¯çš„æ˜¯æ¯ä¸ª Channel çš„ I/O äº‹ä»¶éƒ½å°†åªä¼šè¢«ä¸€ä¸ª Threadå¤„ç†ï¼ˆç”¨äºæ”¯æ’‘è¯¥ Channel çš„ EventLoop çš„é‚£ä¸ª Threadï¼‰ã€‚è¿™ä¹Ÿæ˜¯Nettyä¸€è‡´æ€§çš„ä¾‹å­ï¼Œè¿™ç§è®¾è®¡ä¸Šçš„ä¸€è‡´æ€§ï¼Œæ­£æ˜¯Nettyçš„å¯é æ€§å’Œæ˜“ç”¨æ€§çš„ä½“ç°ã€‚</li>
</ol>
<h2 id="å°ç»“">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“">#</a></h2>
<p>æœ¬ç« æˆ‘ä»¬å­¦ä¹ äº†Netty æ‰€é‡‡ç”¨çš„çº¿ç¨‹æ¨¡å‹ï¼Œè¯¦ç»†æ¢è®¨äº†å…¶æ€§èƒ½ä»¥åŠä¸€è‡´æ€§ã€‚ä½ å­¦ä¹ äº†å¦‚ä½•è°ƒåº¦ä»»åŠ¡ä»¥ä¾¿æ¨è¿Ÿæ‰§è¡Œï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜æ¢è®¨äº†é«˜è´Ÿè½½ä¸‹çš„ä¼¸ç¼©æ€§é—®é¢˜ã€‚ä½ ä¹Ÿçœ‹åˆ°äº†å¦‚ä½•éªŒè¯ä¸€ä¸ªä»»åŠ¡æ˜¯å¦å·²è¢«æ‰§è¡Œä»¥åŠå¦‚ä½•å–æ¶ˆå®ƒã€‚é€šè¿‡æˆ‘ä»¬å¯¹ Netty æ¡†æ¶çš„å®ç°ç»†èŠ‚çš„ç ”ç©¶æ‰€è·å¾—çš„è¿™äº›ä¿¡æ¯ï¼Œå°†å¸®åŠ©ä½ åœ¨ç®€åŒ–ä½ çš„åº”ç”¨ç¨‹åºä»£ç åº“çš„åŒæ—¶æœ€å¤§é™åº¦åœ°æé«˜å®ƒçš„æ€§èƒ½ã€‚</p>
<h1 id="å¼•å¯¼">å¼•å¯¼<a hidden class="anchor" aria-hidden="true" href="#å¼•å¯¼">#</a></h1>
<p>ç®€å•æ¥è¯´ï¼Œå¼•å¯¼ä¸€ä¸ªåº”ç”¨ç¨‹åºæ˜¯æŒ‡å¯¹å®ƒè¿›è¡Œé…ç½®ï¼Œå¹¶ä½¿å®ƒè¿è¡Œèµ·æ¥çš„è¿‡ç¨‹ã€‚æœ¬ç« æˆ‘ä»¬ä¼šé€šè¿‡å¼•å¯¼å°†
ChannelPipelineã€ChannelHandlerå’Œ EventLoopç»„åˆèµ·æ¥ã€‚
Nettyçš„å¼•å¯¼ä¼šå°†ä½ çš„åº”ç”¨ç¨‹åºå’Œç½‘ç»œå±‚éš”ç¦»ï¼ˆåˆ†å±‚æŠ½è±¡ï¼‰ã€‚</p>
<h2 id="bootstrapç±»">Bootstrapç±»<a hidden class="anchor" aria-hidden="true" href="#bootstrapç±»">#</a></h2>
<p><img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/49.png">
æœåŠ¡å™¨è‡´åŠ›äºä½¿ç”¨ä¸€ä¸ªçˆ¶ Channel æ¥æ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå¹¶åˆ›å»ºå­ Channel ä»¥ç”¨äºå®ƒä»¬ä¹‹é—´çš„é€šä¿¡ï¼›è€Œå®¢æˆ·ç«¯å°†æœ€å¯èƒ½åªéœ€è¦ä¸€ä¸ªå•ç‹¬çš„ã€æ²¡æœ‰çˆ¶ Channel çš„ Channel æ¥ç”¨äºæ‰€æœ‰çš„ç½‘ç»œäº¤äº’ã€‚ï¼ˆæ­£å¦‚åŒæˆ‘ä»¬å°†è¦çœ‹åˆ°çš„ï¼Œè¿™ä¹Ÿé€‚ç”¨äºæ— è¿æ¥çš„ä¼ è¾“åè®®ï¼Œå¦‚ UDPï¼Œå› ä¸ºå®ƒä»¬å¹¶ä¸æ˜¯æ¯ä¸ªè¿æ¥éƒ½éœ€è¦ä¸€ä¸ªå•ç‹¬çš„ Channelï¼‰</p>
<p>ä¸ºä»€ä¹ˆå¼•å¯¼ç±»æ˜¯ Cloneable çš„ï¼Ÿ
ä½ æœ‰æ—¶å¯èƒ½ä¼šéœ€è¦åˆ›å»ºå¤šä¸ªå…·æœ‰ç±»ä¼¼é…ç½®æˆ–è€…å®Œå…¨ç›¸åŒé…ç½®çš„Channelã€‚ä¸ºäº†æ”¯æŒè¿™ç§æ¨¡å¼è€Œåˆä¸éœ€è¦ä¸ºæ¯ä¸ªChannel éƒ½åˆ›å»ºå¹¶é…ç½®ä¸€ä¸ªæ–°çš„å¼•å¯¼ç±»å®ä¾‹ï¼Œ AbstractBootstrap è¢«æ ‡è®°ä¸ºäº†Cloneableã€‚
åœ¨ä¸€ä¸ªå·²ç»é…ç½®å®Œæˆçš„å¼•å¯¼ç±»å®ä¾‹ä¸Šè°ƒç”¨clone()æ–¹æ³•å°†è¿”å›å¦ä¸€ä¸ªå¯ä»¥ç«‹å³ä½¿ç”¨çš„å¼•å¯¼ç±»å®ä¾‹ã€‚
æ³¨æ„ï¼Œè¿™ç§æ–¹å¼åªä¼šåˆ›å»ºå¼•å¯¼ç±»å®ä¾‹çš„EventLoopGroupçš„ä¸€ä¸ªæµ…æ‹·è´ï¼Œæ‰€ä»¥è¢«æµ…æ‹·è´çš„ EventLoopGroupå°†åœ¨æ‰€æœ‰å…‹éš†çš„Channelå®ä¾‹ä¹‹é—´å…±äº«ã€‚è¿™æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå› ä¸ºé€šå¸¸è¿™äº›å…‹éš†çš„Channelçš„ç”Ÿå‘½å‘¨æœŸéƒ½å¾ˆçŸ­æš‚ï¼Œä¸€ä¸ªå…¸å‹çš„åœºæ™¯æ˜¯ï¼šåˆ›å»ºä¸€ä¸ªChannelä»¥è¿›è¡Œä¸€æ¬¡HTTPè¯·æ±‚ã€‚</p>
<p>AbstractBootstrap ç±»çš„å®Œæ•´å£°æ˜æ˜¯ï¼š
public abstract class AbstractBootstrap
&lt;B extends AbstractBootstrap&lt;B,C&gt;,C extends Channel&gt;
åœ¨è¿™ä¸ªç­¾åä¸­ï¼Œå­ç±»å‹ B æ˜¯å…¶çˆ¶ç±»å‹çš„ä¸€ä¸ªç±»å‹å‚æ•°ï¼Œå› æ­¤å¯ä»¥è¿”å›åˆ°è¿è¡Œæ—¶å®ä¾‹çš„å¼•ç”¨ä»¥æ”¯æŒæ–¹æ³•çš„é“¾å¼è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„æµå¼è¯­æ³•ã€‚</p>
<p>å…¶å­ç±»çš„å£°æ˜å¦‚ä¸‹ï¼š
public class Bootstrap
extends AbstractBootstrap&lt;Bootstrap,Channel&gt;</p>
<p>public class ServerBootstrap
extends AbstractBootstrap&lt;ServerBootstrap,ServerChannel&gt;</p>
<h2 id="å¼•å¯¼å®¢æˆ·ç«¯å’Œæ— è¿æ¥åè®®">å¼•å¯¼å®¢æˆ·ç«¯å’Œæ— è¿æ¥åè®®<a hidden class="anchor" aria-hidden="true" href="#å¼•å¯¼å®¢æˆ·ç«¯å’Œæ— è¿æ¥åè®®">#</a></h2>
<p>Bootstrap ç±»è¢«ç”¨äºå®¢æˆ·ç«¯æˆ–è€…ä½¿ç”¨äº†æ— è¿æ¥åè®®çš„åº”ç”¨ç¨‹åºä¸­ã€‚è¡¨ 8-1 æä¾›äº†è¯¥ç±»çš„ä¸€ä¸ªæ¦‚è§ˆï¼Œå…¶ä¸­è®¸å¤šæ–¹æ³•éƒ½ç»§æ‰¿è‡ª AbstractBootstrap ç±»ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bootstrap group(EventLoopGroup)</td>
<td>è®¾ç½®ç”¨äºå¤„ç† Channel æ‰€æœ‰äº‹ä»¶çš„ EventLoopGroup</td>
</tr>
<tr>
<td><code>Bootstrap channel( Class&lt;? extends C&gt;) Bootstrap channelFactory( ChannelFactory&lt;? extends C&gt;) </code></td>
<td>channel()æ–¹æ³•æŒ‡å®šäº†Channelçš„å®ç°ç±»ã€‚å¦‚æœè¯¥å®ç°ç±» æ²¡æä¾›é»˜è®¤çš„æ„é€ å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨channelFactory()æ–¹æ³•æ¥æŒ‡å®šä¸€ä¸ªå·¥å‚ç±»ï¼Œå®ƒå°†ä¼šè¢«bind()æ–¹ æ³•è°ƒç”¨</td>
</tr>
<tr>
<td>Bootstrap localAddress( SocketAddress)</td>
<td>æŒ‡å®š Channel åº”è¯¥ç»‘å®šåˆ°çš„æœ¬åœ°åœ°å€ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œ åˆ™å°†ç”±æ“ä½œç³»ç»Ÿåˆ›å»ºä¸€ä¸ªéšæœºçš„åœ°å€ã€‚æˆ–è€…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ bind()æˆ–è€… connect()æ–¹æ³•æŒ‡å®š localAddress</td>
</tr>
<tr>
<td><code>&lt;T&gt; Bootstrap option( ChannelOption&lt;T&gt; option, T value)</code></td>
<td>è®¾ç½® ChannelOptionï¼Œå…¶å°†è¢«åº”ç”¨åˆ°æ¯ä¸ªæ–°åˆ›å»ºçš„ Channel çš„ ChannelConfigã€‚è¿™äº›é€‰é¡¹å°†ä¼šé€šè¿‡ bind()æˆ–è€… connect()æ–¹æ³•è®¾ç½®åˆ° Channelï¼Œä¸ç®¡å“ª ä¸ªå…ˆè¢«è°ƒç”¨ã€‚è¿™ä¸ªæ–¹æ³•åœ¨ Channel å·²ç»è¢«åˆ›å»ºåå†è°ƒç”¨ å°†ä¸ä¼šæœ‰ä»»ä½•çš„æ•ˆæœã€‚æ”¯æŒçš„ ChannelOption å–å†³äº ä½¿ç”¨çš„ Channel ç±»å‹ã€‚ å‚è§ 8.6 èŠ‚ä»¥åŠ ChannelConfig çš„ API æ–‡æ¡£ï¼Œäº†è§£æ‰€ ä½¿ç”¨çš„ Channel ç±»å‹</td>
</tr>
<tr>
<td><code>&lt;T&gt; Bootstrap attr( Attribute&lt;T&gt; key, T value)</code></td>
<td>æŒ‡å®šæ–°åˆ›å»ºçš„ Channel çš„å±æ€§å€¼ã€‚è¿™äº›å±æ€§å€¼æ˜¯é€šè¿‡ bind()æˆ–è€… connect()æ–¹æ³•è®¾ç½®åˆ° Channel çš„ï¼Œå…·ä½“ å–å†³äºè°æœ€å…ˆè¢«è°ƒç”¨ã€‚è¿™ä¸ªæ–¹æ³•åœ¨ Channel è¢«åˆ›å»ºåå°† ä¸ä¼šæœ‰ä»»ä½•çš„æ•ˆæœã€‚å‚è§ 8.6 èŠ‚</td>
</tr>
<tr>
<td>Bootstrap handler(ChannelHandler)</td>
<td>è®¾ç½®å°†è¢«æ·»åŠ åˆ° ChannelPipeline ä»¥æ¥æ”¶äº‹ä»¶é€šçŸ¥çš„ ChannelHandler</td>
</tr>
<tr>
<td>Bootstrap clone()</td>
<td>åˆ›å»ºä¸€ä¸ªå½“å‰ Bootstrap çš„å…‹éš†ï¼Œå…¶å…·æœ‰å’ŒåŸå§‹çš„ Bootstrap ç›¸åŒçš„è®¾ç½®ä¿¡æ¯</td>
</tr>
<tr>
<td>Bootstrap remoteAddress( SocketAddress)</td>
<td>è®¾ç½®è¿œç¨‹åœ°å€ã€‚æˆ–è€…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ connect()æ–¹æ³•æ¥æŒ‡ å®šå®ƒ</td>
</tr>
<tr>
<td>ChannelFuture connect()</td>
<td>è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹å¹¶è¿”å›ä¸€ä¸ª ChannelFutureï¼Œå…¶å°† ä¼šåœ¨ è¿æ¥æ“ä½œå®Œæˆåæ¥æ”¶åˆ°é€šçŸ¥</td>
</tr>
<tr>
<td>ChannelFuture bind()</td>
<td>ç»‘å®š Channel å¹¶è¿”å›ä¸€ä¸ª ChannelFutureï¼Œå…¶å°†ä¼šåœ¨ç»‘ å®šæ“ä½œå®Œæˆåæ¥æ”¶åˆ°é€šçŸ¥ï¼Œåœ¨é‚£ä¹‹åå¿…é¡»è°ƒç”¨ Channel. connect()æ–¹æ³•æ¥å»ºç«‹è¿æ¥</td>
</tr>
</tbody>
</table>
<h3 id="å¼•å¯¼å®¢æˆ·ç«¯">å¼•å¯¼å®¢æˆ·ç«¯<a hidden class="anchor" aria-hidden="true" href="#å¼•å¯¼å®¢æˆ·ç«¯">#</a></h3>
<p>Bootstrap ç±»è´Ÿè´£ä¸ºå®¢æˆ·ç«¯å’Œä½¿ç”¨æ— è¿æ¥åè®®çš„åº”ç”¨ç¨‹åºåˆ›å»º Channelï¼Œå¦‚å›¾ 8-2 æ‰€ç¤ºã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/50.png">
ä»£ç æ¸…å• 8-1 ä¸­çš„ä»£ç å¼•å¯¼äº†ä¸€ä¸ªä½¿ç”¨ NIO TCP ä¼ è¾“çš„å®¢æˆ·ç«¯ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 8-1 å¼•å¯¼ä¸€ä¸ªå®¢æˆ·ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:mawolfthal@gmail.com&#34;&gt;Marvin Wolfthal&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapClient {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String args[]) {
</span></span><span style="display:flex;"><span>        BootstrapClient client = <span style="color:#fff;font-weight:bold">new</span> BootstrapClient();
</span></span><span style="display:flex;"><span>        client.<span style="color:#007f7f">bootstrap</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 8-1 å¼•å¯¼ä¸€ä¸ªå®¢æˆ·ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½® EventLoopGroupï¼Œæä¾›ç”¨äºå¤„ç† Channel äº‹ä»¶çš„ EventLoop</span>
</span></span><span style="display:flex;"><span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ªBootstrapç±»çš„å®ä¾‹ä»¥åˆ›å»ºå’Œè¿æ¥æ–°çš„å®¢æˆ·ç«¯Channel</span>
</span></span><span style="display:flex;"><span>        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æŒ‡å®šè¦ä½¿ç”¨çš„Channel å®ç°</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">channel</span>(NioSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è®¾ç½®ç”¨äº Channel äº‹ä»¶å’Œæ•°æ®çš„ChannelInboundHandler</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">handler</span>(<span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                @Override
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                    ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                    ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è¿æ¥åˆ°è¿œç¨‹ä¸»æœº</span>
</span></span><span style="display:flex;"><span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">connect</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;www.manning.com&#34;</span>, 80));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture channelFuture)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (channelFuture.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Connection established&#34;</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Connection attempt failed&#34;</span>);
</span></span><span style="display:flex;"><span>                    channelFuture.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªç¤ºä¾‹ä½¿ç”¨äº†å‰é¢æåˆ°çš„æµå¼è¯­æ³•ï¼›è¿™äº›æ–¹æ³•ï¼ˆé™¤äº† connect()æ–¹æ³•ä»¥å¤–ï¼‰å°†é€šè¿‡æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ‰€è¿”å›çš„å¯¹ Bootstrap å®ä¾‹çš„å¼•ç”¨é“¾æ¥åœ¨ä¸€èµ·ã€‚</p>
<h3 id="channel-å’Œ-eventloopgroup-çš„å…¼å®¹æ€§">Channel å’Œ EventLoopGroup çš„å…¼å®¹æ€§<a hidden class="anchor" aria-hidden="true" href="#channel-å’Œ-eventloopgroup-çš„å…¼å®¹æ€§">#</a></h3>
<p>ä»£ç æ¸…å• 8-2 æ‰€ç¤ºçš„ç›®å½•æ¸…å•æ¥è‡ª io.netty.channel åŒ…ã€‚ä½ å¯ä»¥ä»åŒ…åä»¥åŠä¸å…¶ç›¸å¯¹åº”çš„ç±»åçš„å‰ç¼€çœ‹åˆ°ï¼Œå¯¹äº NIO ä»¥åŠ OIO ä¼ è¾“ä¸¤è€…æ¥è¯´ï¼Œéƒ½æœ‰ç›¸å…³çš„ EventLoopGroup å’ŒChannel å®ç°ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>channel
</span></span><span style="display:flex;"><span>â”œâ”€â”€â”€nio
</span></span><span style="display:flex;"><span>â”‚ NioEventLoopGroup
</span></span><span style="display:flex;"><span>â”œâ”€â”€â”€oio
</span></span><span style="display:flex;"><span>â”‚ OioEventLoopGroup
</span></span><span style="display:flex;"><span>â””â”€â”€â”€socket
</span></span><span style="display:flex;"><span>â”œâ”€â”€â”€nio
</span></span><span style="display:flex;"><span>â”‚ NioDatagramChannel
</span></span><span style="display:flex;"><span>â”‚ NioServerSocketChannel
</span></span><span style="display:flex;"><span>â”‚ NioSocketChannel
</span></span><span style="display:flex;"><span>â””â”€â”€â”€oio
</span></span><span style="display:flex;"><span>OioDatagramChannel
</span></span><span style="display:flex;"><span>OioServerSocketChannel
</span></span><span style="display:flex;"><span>OioSocketChannel
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¿…é¡»ä¿æŒè¿™ç§å…¼å®¹æ€§ï¼Œä¸èƒ½æ··ç”¨å…·æœ‰ä¸åŒå‰ç¼€çš„ç»„ä»¶ï¼Œå¦‚ NioEventLoopGroup å’ŒOioSocketChannelã€‚
ä»£ç æ¸…å• 8-3 å±•ç¤ºäº†è¯•å›¾è¿™æ ·åšçš„ä¸€ä¸ªä¾‹å­ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 8-3 ä¸å…¼å®¹çš„ Channel å’Œ EventLoopGroup
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> InvalidBootstrapClient {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String args[]) {
</span></span><span style="display:flex;"><span>        InvalidBootstrapClient client = <span style="color:#fff;font-weight:bold">new</span> InvalidBootstrapClient();
</span></span><span style="display:flex;"><span>        client.<span style="color:#007f7f">bootstrap</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 8-3 ä¸å…¼å®¹çš„ Channel å’Œ EventLoopGroup
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ªæ–°çš„ Bootstrap ç±»çš„å®ä¾‹ï¼Œä»¥åˆ›å»ºæ–°çš„å®¢æˆ·ç«¯Channel</span>
</span></span><span style="display:flex;"><span>        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æŒ‡å®šä¸€ä¸ªé€‚ç”¨äº NIO çš„ EventLoopGroup å®ç°</span>
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æŒ‡å®šä¸€ä¸ªé€‚ç”¨äº OIO çš„ Channel å®ç°ç±»</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">channel</span>(OioSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è®¾ç½®ä¸€ä¸ªç”¨äºå¤„ç† Channelçš„ I/O äº‹ä»¶å’Œæ•°æ®çš„ ChannelInboundHandler</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">handler</span>(<span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                @Override
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                    ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                    ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>             });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°è¯•è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">connect</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;www.manning.com&#34;</span>, 80));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ®µä»£ç å°†ä¼šå¯¼è‡´ IllegalStateExceptionï¼Œå› ä¸ºå®ƒæ··ç”¨äº†ä¸å…¼å®¹çš„ä¼ è¾“ã€‚</p>
<p>å…³äº IllegalStateException çš„æ›´å¤šè®¨è®º
åœ¨å¼•å¯¼çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨è°ƒç”¨ bind()æˆ–è€… connect()æ–¹æ³•ä¹‹å‰ï¼Œå¿…é¡»è°ƒç”¨ä»¥ä¸‹æ–¹æ³•æ¥è®¾ç½®æ‰€éœ€çš„ç»„ä»¶ï¼š</p>
<ul>
<li>group()ï¼›</li>
<li>channel()æˆ–è€… channelFactory()ï¼›</li>
<li>handler()ã€‚</li>
</ul>
<p>å¦‚æœä¸è¿™æ ·åšï¼Œåˆ™å°†ä¼šå¯¼è‡´ IllegalStateExceptionã€‚å¯¹ handler()æ–¹æ³•çš„è°ƒç”¨å°¤å…¶é‡è¦ï¼Œå› ä¸ºå®ƒéœ€è¦é…ç½®å¥½ ChannelPipelineã€‚</p>
<h2 id="å¼•å¯¼æœåŠ¡å™¨">å¼•å¯¼æœåŠ¡å™¨<a hidden class="anchor" aria-hidden="true" href="#å¼•å¯¼æœåŠ¡å™¨">#</a></h2>
<h3 id="serverbootstrap-ç±»">ServerBootstrap ç±»<a hidden class="anchor" aria-hidden="true" href="#serverbootstrap-ç±»">#</a></h3>
<p>è¡¨ 8-2 ServerBootstrap ç±»çš„æ–¹æ³•</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>group</td>
<td>è®¾ç½® ServerBootstrap è¦ç”¨çš„ EventLoopGroupã€‚è¿™ä¸ª EventLoopGroup å°†ç”¨äº ServerChannel å’Œè¢«æ¥å—çš„å­ Channel çš„ I/O å¤„ç†</td>
</tr>
<tr>
<td>channel</td>
<td>è®¾ç½®å°†è¦è¢«å®ä¾‹åŒ–çš„ ServerChannel ç±»</td>
</tr>
<tr>
<td>channelFactory</td>
<td>å¦‚æœä¸èƒ½é€šè¿‡é»˜è®¤çš„æ„é€ å‡½æ•°åˆ›å»ºChannelï¼Œé‚£ä¹ˆå¯ä»¥æä¾›ä¸€ä¸ªChannelFactory</td>
</tr>
<tr>
<td>localAddress</td>
<td>æŒ‡å®š ServerChannel åº”è¯¥ç»‘å®šåˆ°çš„æœ¬åœ°åœ°å€ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™å°†ç”±æ“ä½œç³» ç»Ÿä½¿ç”¨ä¸€ä¸ªéšæœºåœ°å€ã€‚æˆ–è€…ï¼Œå¯ä»¥é€šè¿‡ bind()æ–¹æ³•æ¥æŒ‡å®šè¯¥ localAddress</td>
</tr>
<tr>
<td>option</td>
<td>æŒ‡å®šè¦åº”ç”¨åˆ°æ–°åˆ›å»ºçš„ ServerChannel çš„ ChannelConfig çš„ ChannelOptionã€‚è¿™äº›é€‰é¡¹å°†ä¼šé€šè¿‡ bind()æ–¹æ³•è®¾ç½®åˆ° Channelã€‚åœ¨ bind()æ–¹æ³• è¢«è°ƒç”¨ä¹‹åï¼Œè®¾ç½®æˆ–è€…æ”¹å˜ ChannelOption éƒ½ä¸ä¼šæœ‰ä»»ä½•çš„æ•ˆæœã€‚æ‰€æ”¯æŒ çš„ ChannelOption å–å†³äºæ‰€ä½¿ç”¨çš„ Channel ç±»å‹ã€‚å‚è§æ­£åœ¨ä½¿ç”¨çš„ ChannelConfig çš„ API æ–‡æ¡£</td>
</tr>
<tr>
<td>childOption</td>
<td>æŒ‡å®šå½“å­ Channel è¢«æ¥å—æ—¶ï¼Œåº”ç”¨åˆ°å­ Channel çš„ ChannelConfig çš„ ChannelOptionã€‚æ‰€æ”¯æŒçš„ ChannelOption å–å†³äºæ‰€ä½¿ç”¨çš„ Channel çš„ç±» å‹ã€‚å‚è§æ­£åœ¨ä½¿ç”¨çš„ ChannelConfig çš„ API æ–‡æ¡£</td>
</tr>
<tr>
<td>attr</td>
<td>æŒ‡å®š ServerChannel ä¸Šçš„å±æ€§ï¼Œå±æ€§å°†ä¼šé€šè¿‡ bind()æ–¹æ³•è®¾ç½®ç»™ Channelã€‚ åœ¨è°ƒç”¨ bind()æ–¹æ³•ä¹‹åæ”¹å˜å®ƒä»¬å°†ä¸ä¼šæœ‰ä»»ä½•çš„æ•ˆæœ</td>
</tr>
<tr>
<td>childAttr</td>
<td>å°†å±æ€§è®¾ç½®ç»™å·²ç»è¢«æ¥å—çš„å­ Channelã€‚æ¥ä¸‹æ¥çš„è°ƒç”¨å°†ä¸ä¼šæœ‰ä»»ä½•çš„æ•ˆæœ</td>
</tr>
<tr>
<td>handler</td>
<td>è®¾ç½®è¢«æ·»åŠ åˆ°ServerChannel çš„ChannelPipelineä¸­çš„ChannelHandlerã€‚ æ›´åŠ å¸¸ç”¨çš„æ–¹æ³•å‚è§ childHandler()</td>
</tr>
<tr>
<td>childHandler</td>
<td>è®¾ç½®å°†è¢«æ·»åŠ åˆ°å·²è¢«æ¥å—çš„å­ Channel çš„ ChannelPipeline ä¸­çš„ ChannelHandlerã€‚handler()æ–¹æ³•å’Œ childHandler()æ–¹æ³•ä¹‹é—´çš„åŒºåˆ«æ˜¯ï¼šå‰è€…æ‰€ æ·»åŠ çš„ ChannelHandler ç”±æ¥å—å­ Channel çš„ ServerChannel å¤„ç†ï¼Œè€Œ childHandler()æ–¹æ³•æ‰€æ·»åŠ çš„ ChannelHandler å°†ç”±å·²è¢«æ¥å—çš„å­ Channel å¤„ç†ï¼Œå…¶ä»£è¡¨ä¸€ä¸ªç»‘å®šåˆ°è¿œç¨‹èŠ‚ç‚¹çš„å¥—æ¥å­—</td>
</tr>
<tr>
<td>clone</td>
<td>å…‹éš†ä¸€ä¸ªè®¾ç½®å’ŒåŸå§‹çš„ ServerBootstrap ç›¸åŒçš„ ServerBootstrap</td>
</tr>
<tr>
<td>bind</td>
<td>ç»‘å®š ServerChannel å¹¶ä¸”è¿”å›ä¸€ä¸ª ChannelFutureï¼Œå…¶å°†ä¼šåœ¨ç»‘å®šæ“ä½œå®Œ æˆåæ”¶åˆ°é€šçŸ¥ï¼ˆå¸¦ç€æˆåŠŸæˆ–è€…å¤±è´¥çš„ç»“æœï¼‰</td>
</tr>
</tbody>
</table>
<h3 id="å¼•å¯¼æœåŠ¡å™¨-1">å¼•å¯¼æœåŠ¡å™¨<a hidden class="anchor" aria-hidden="true" href="#å¼•å¯¼æœåŠ¡å™¨-1">#</a></h3>
<p>ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°äº†ï¼Œè¡¨ 8-2 ä¸­åˆ—å‡ºäº†ä¸€äº›åœ¨è¡¨ 8-1 ä¸­ä¸å­˜åœ¨çš„æ–¹æ³•ï¼šchildHandler()ã€childAttr()å’Œ
childOption()ã€‚è¿™äº›è°ƒç”¨æ”¯æŒç‰¹åˆ«ç”¨äºæœåŠ¡å™¨åº”ç”¨ç¨‹åºçš„æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼ŒServerChannel çš„å®ç°è´Ÿè´£åˆ›å»ºå­ Channelï¼Œè¿™äº›å­ Channel ä»£è¡¨äº†å·²è¢«æ¥å—çš„è¿æ¥ã€‚å› æ­¤ï¼Œè´Ÿè´£å¼•å¯¼ ServerChannel çš„
ServerBootstrap æä¾›äº†è¿™äº›æ–¹æ³•ï¼Œä»¥ç®€åŒ–å°†è®¾ç½®åº”ç”¨åˆ°å·²è¢«æ¥å—çš„å­ Channel çš„ ChannelConfig çš„ä»»åŠ¡ã€‚
å›¾ 8-3 å±•ç¤ºäº† ServerBootstrap åœ¨ bind()æ–¹æ³•è¢«è°ƒç”¨æ—¶åˆ›å»ºäº†ä¸€ä¸ª ServerChannelï¼Œå¹¶ä¸”è¯¥ ServerChannel ç®¡ç†äº†å¤šä¸ªå­ Channelã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/51.png">
ä»£ç æ¸…å• 8-4 ä¸­çš„ä»£ç å®ç°äº†å›¾ 8-3 ä¸­æ‰€å±•ç¤ºçš„æœåŠ¡å™¨çš„å¼•å¯¼è¿‡ç¨‹ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 8-4 å¼•å¯¼æœåŠ¡å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:mawolfthal@gmail.com&#34;&gt;Marvin Wolfthal&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapServer {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 8-4 å¼•å¯¼æœåŠ¡å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        NioEventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»º Server Bootstrap</span>
</span></span><span style="display:flex;"><span>        ServerBootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½® EventLoopGroupï¼Œå…¶æä¾›äº†ç”¨äºå¤„ç† Channel äº‹ä»¶çš„EventLoop</span>
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æŒ‡å®šè¦ä½¿ç”¨çš„ Channel å®ç°</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è®¾ç½®ç”¨äºå¤„ç†å·²è¢«æ¥å—çš„å­ Channel çš„I/OåŠæ•°æ®çš„ ChannelInboundHandler</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">childHandler</span>(<span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                @Override
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                    ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//é€šè¿‡é…ç½®å¥½çš„ ServerBootstrap çš„å®ä¾‹ç»‘å®šè¯¥ Channel</span>
</span></span><span style="display:flex;"><span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">bind</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(8080));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture channelFuture)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (channelFuture.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Server bound&#34;</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Bind attempt failed&#34;</span>);
</span></span><span style="display:flex;"><span>                    channelFuture.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä»-channel-å¼•å¯¼å®¢æˆ·ç«¯">ä» Channel å¼•å¯¼å®¢æˆ·ç«¯<a hidden class="anchor" aria-hidden="true" href="#ä»-channel-å¼•å¯¼å®¢æˆ·ç«¯">#</a></h2>
<p>å‡è®¾ä½ çš„æœåŠ¡å™¨æ­£åœ¨å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚éœ€è¦å®ƒå……å½“ç¬¬ä¸‰æ–¹ç³»ç»Ÿçš„å®¢æˆ·ç«¯ã€‚å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆå¦‚ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼‰å¿…é¡»è¦å’Œç»„ç»‡ç°æœ‰çš„ç³»ç»Ÿï¼ˆå¦‚ Web æœåŠ¡æˆ–è€…æ•°æ®åº“ï¼‰é›†æˆæ—¶ï¼Œå°±å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µã€‚
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†éœ€è¦ä»å·²ç»è¢«æ¥å—çš„å­ Channel ä¸­å¼•å¯¼ä¸€ä¸ªå®¢æˆ·ç«¯ Channelã€‚ä½ å¯ä»¥æŒ‰ç…§ 8.2.1 èŠ‚ä¸­æ‰€æè¿°çš„æ–¹å¼åˆ›å»ºæ–°çš„ Bootstrap å®ä¾‹ï¼Œä½†æ˜¯è¿™å¹¶ä¸æ˜¯æœ€é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå®ƒå°†è¦æ±‚ä½ ä¸ºæ¯ä¸ªæ–°åˆ›å»ºçš„å®¢æˆ·ç«¯ Channel å®šä¹‰å¦ä¸€ä¸ª EventLoopã€‚è¿™ä¼šäº§ç”Ÿé¢å¤–çš„çº¿ç¨‹ï¼Œä»¥åŠåœ¨å·²è¢«æ¥å—çš„å­ Channel å’Œå®¢æˆ·ç«¯Channel ä¹‹é—´äº¤æ¢æ•°æ®æ—¶ä¸å¯é¿å…çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p>
<p>ä¸€ä¸ªæ›´å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šé€šè¿‡å°†å·²è¢«æ¥å—çš„å­ Channel çš„ EventLoop ä¼ é€’ç»™ Bootstrapçš„ group()æ–¹æ³•æ¥å…±äº«è¯¥ EventLoopã€‚å› ä¸ºåˆ†é…ç»™ EventLoop çš„æ‰€æœ‰ Channel éƒ½ä½¿ç”¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥è¿™é¿å…äº†é¢å¤–çš„çº¿ç¨‹åˆ›å»ºï¼Œä»¥åŠå‰é¢æ‰€æåˆ°çš„ç›¸å…³çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚è¿™ä¸ªå…±äº«çš„è§£å†³æ–¹æ¡ˆå¦‚å›¾ 8-4 æ‰€ç¤ºã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/52.png">
å®ç° EventLoop å…±äº«æ¶‰åŠé€šè¿‡è°ƒç”¨ group()æ–¹æ³•æ¥è®¾ç½® EventLoopï¼Œå¦‚ä»£ç æ¸…å• 8-5 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 8-5 å¼•å¯¼æœåŠ¡å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:mawolfthal@gmail.com&#34;&gt;Marvin Wolfthal&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapSharingEventLoopGroup {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 8-5 å¼•å¯¼æœåŠ¡å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»º ServerBootstrap ä»¥åˆ›å»º ServerSocketChannelï¼Œå¹¶ç»‘å®šå®ƒ</span>
</span></span><span style="display:flex;"><span>        ServerBootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½® EventLoopGroupï¼Œå…¶å°†æä¾›ç”¨ä»¥å¤„ç† Channel äº‹ä»¶çš„ EventLoop</span>
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(<span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup(), <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup())
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æŒ‡å®šè¦ä½¿ç”¨çš„ Channel å®ç°</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è®¾ç½®ç”¨äºå¤„ç†å·²è¢«æ¥å—çš„å­ Channel çš„ I/O å’Œæ•°æ®çš„ ChannelInboundHandler</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">childHandler</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                    ChannelFuture connectFuture;
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(ChannelHandlerContext ctx)
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª Bootstrap ç±»çš„å®ä¾‹ä»¥è¿æ¥åˆ°è¿œç¨‹ä¸»æœº</span>
</span></span><span style="display:flex;"><span>                        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//æŒ‡å®š Channel çš„å®ç°</span>
</span></span><span style="display:flex;"><span>                        bootstrap.<span style="color:#007f7f">channel</span>(NioSocketChannel.<span style="color:#007f7f">class</span>).<span style="color:#007f7f">handler</span>(
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//ä¸ºå…¥ç«™ I/O è®¾ç½® ChannelInboundHandler</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                                @Override
</span></span><span style="display:flex;"><span>                                <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                                    ChannelHandlerContext ctx, ByteBuf in)
</span></span><span style="display:flex;"><span>                                    <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            });
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//ä½¿ç”¨ä¸åˆ†é…ç»™å·²è¢«æ¥å—çš„å­Channelç›¸åŒçš„EventLoop</span>
</span></span><span style="display:flex;"><span>                        bootstrap.<span style="color:#007f7f">group</span>(ctx.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">eventLoop</span>());
</span></span><span style="display:flex;"><span>                        connectFuture = bootstrap.<span style="color:#007f7f">connect</span>(
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;www.manning.com&#34;</span>, 80));
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                        ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                            ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">if</span> (connectFuture.<span style="color:#007f7f">isDone</span>()) {
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//å½“è¿æ¥å®Œæˆæ—¶ï¼Œæ‰§è¡Œä¸€äº›æ•°æ®æ“ä½œï¼ˆå¦‚ä»£ç†ï¼‰</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">// do something with the data</span>
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//é€šè¿‡é…ç½®å¥½çš„ ServerBootstrap ç»‘å®šè¯¥ ServerSocketChannel</span>
</span></span><span style="display:flex;"><span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">bind</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(8080));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture channelFuture)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (channelFuture.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Server bound&#34;</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Bind attempt failed&#34;</span>);
</span></span><span style="display:flex;"><span>                    channelFuture.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬åœ¨è¿™ä¸€èŠ‚ä¸­æ‰€è®¨è®ºçš„ä¸»é¢˜ä»¥åŠæ‰€æå‡ºçš„è§£å†³æ–¹æ¡ˆéƒ½åæ˜ äº†ç¼–å†™ Netty åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªä¸€èˆ¬å‡†åˆ™ï¼šå°½å¯èƒ½åœ°é‡ç”¨ EventLoopï¼Œä»¥å‡å°‘çº¿ç¨‹åˆ›å»ºæ‰€å¸¦æ¥çš„å¼€é”€ã€‚</p>
<h2 id="åœ¨å¼•å¯¼è¿‡ç¨‹ä¸­æ·»åŠ å¤šä¸ª-channelhandler">åœ¨å¼•å¯¼è¿‡ç¨‹ä¸­æ·»åŠ å¤šä¸ª ChannelHandler<a hidden class="anchor" aria-hidden="true" href="#åœ¨å¼•å¯¼è¿‡ç¨‹ä¸­æ·»åŠ å¤šä¸ª-channelhandler">#</a></h2>
<p>åœ¨æ‰€æœ‰æˆ‘ä»¬å±•ç¤ºè¿‡çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬éƒ½åœ¨å¼•å¯¼çš„è¿‡ç¨‹ä¸­è°ƒç”¨äº† handler()æˆ–è€… childHandler()æ–¹æ³•æ¥æ·»åŠ å•ä¸ªçš„ ChannelHandlerã€‚è¿™å¯¹äºç®€å•çš„åº”ç”¨ç¨‹åºæ¥è¯´å¯èƒ½å·²ç»è¶³å¤Ÿäº†ï¼Œä½†æ˜¯å®ƒä¸èƒ½æ»¡è¶³æ›´åŠ å¤æ‚çš„éœ€æ±‚ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¿…é¡»è¦æ”¯æŒå¤šç§åè®®çš„åº”ç”¨ç¨‹åºå°†ä¼šæœ‰å¾ˆå¤šçš„ChannelHandlerï¼Œè€Œä¸ä¼šæ˜¯ä¸€ä¸ªåºå¤§è€Œåˆç¬¨é‡çš„ç±»ã€‚</p>
<p>æ­£å¦‚ä½ ç»å¸¸æ‰€çœ‹åˆ°çš„ä¸€æ ·ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ï¼Œé€šè¿‡åœ¨ ChannelPipeline ä¸­å°†å®ƒä»¬é“¾æ¥åœ¨ä¸€èµ·æ¥éƒ¨ç½²å°½å¯èƒ½å¤šçš„ ChannelHandlerã€‚ä½†æ˜¯ï¼Œå¦‚æœåœ¨å¼•å¯¼çš„è¿‡ç¨‹ä¸­ä½ åªèƒ½è®¾ç½®ä¸€ä¸ª ChannelHandlerï¼Œé‚£ä¹ˆä½ åº”è¯¥æ€ä¹ˆåšåˆ°è¿™ä¸€ç‚¹å‘¢ï¼Ÿæ­£æ˜¯é’ˆå¯¹äºè¿™ä¸ªç”¨ä¾‹ï¼ŒNetty æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„ ChannelInboundHandlerAdapter å­ç±»ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>public abstract <span style="color:#fff;font-weight:bold">class</span> ChannelInitializer&lt;C <span style="color:#fff;font-weight:bold">extends</span> Channel&gt;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒå®šä¹‰äº†ä¸‹é¢çš„æ–¹æ³•ï¼š
<code>protected abstract void initChannel(C ch) throws Exception;</code>
è¿™ä¸ªæ–¹æ³•æä¾›äº†ä¸€ç§å°†å¤šä¸ª ChannelHandler æ·»åŠ åˆ°ä¸€ä¸ª ChannelPipeline ä¸­çš„ç®€ä¾¿æ–¹æ³•ã€‚ä½ åªéœ€è¦ç®€å•åœ°å‘ Bootstrap æˆ– ServerBootstrap çš„å®ä¾‹æä¾›ä½ çš„ ChannelInitializer å®ç°å³å¯ï¼Œå¹¶ä¸”ä¸€æ—¦ Channel è¢«æ³¨å†Œåˆ°äº†å®ƒçš„ EventLoop ä¹‹åï¼Œå°±ä¼šè°ƒç”¨ä½ çš„initChannel()ç‰ˆæœ¬ã€‚åœ¨è¯¥æ–¹æ³•è¿”å›ä¹‹åï¼ŒChannelInitializer çš„å®ä¾‹å°†ä¼šä» ChannelPipeline ä¸­ç§»é™¤å®ƒè‡ªå·±ã€‚</p>
<p>ä»£ç æ¸…å• 8-6 å®šä¹‰äº†ChannelInitializerImplç±»ï¼Œå¹¶é€šè¿‡ServerBootstrapçš„childHandler()æ–¹æ³•æ³¨å†Œå®ƒã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªçœ‹ä¼¼å¤æ‚çš„æ“ä½œå®é™…ä¸Šæ˜¯ç›¸å½“ç®€å•ç›´æ¥çš„ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 8-6 å¼•å¯¼å’Œä½¿ç”¨ ChannelInitializer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapWithInitializer {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 8-6 å¼•å¯¼å’Œä½¿ç”¨ ChannelInitializer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() <span style="color:#fff;font-weight:bold">throws</span> InterruptedException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»º ServerBootstrap ä»¥åˆ›å»ºå’Œç»‘å®šæ–°çš„ Channel</span>
</span></span><span style="display:flex;"><span>        ServerBootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½® EventLoopGroupï¼Œå…¶å°†æä¾›ç”¨ä»¥å¤„ç† Channel äº‹ä»¶çš„ EventLoop</span>
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(<span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup(), <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup())
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æŒ‡å®š Channel çš„å®ç°</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ³¨å†Œä¸€ä¸ª ChannelInitializerImpl çš„å®ä¾‹æ¥è®¾ç½® ChannelPipeline</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">childHandler</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelInitializerImpl());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç»‘å®šåˆ°åœ°å€</span>
</span></span><span style="display:flex;"><span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">bind</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(8080));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç”¨ä»¥è®¾ç½® ChannelPipeline çš„è‡ªå®šä¹‰ ChannelInitializerImpl å®ç°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ChannelInitializerImpl <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†æ‰€éœ€çš„ ChannelHandler æ·»åŠ åˆ° ChannelPipeline</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HttpClientCodec());
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HttpObjectAggregator(Integer.<span style="color:#007f7f">MAX_VALUE</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœä½ çš„åº”ç”¨ç¨‹åºä½¿ç”¨äº†å¤šä¸ª ChannelHandlerï¼Œè¯·å®šä¹‰ä½ è‡ªå·±çš„
ChannelInitializerå®ç°æ¥å°†å®ƒä»¬å®‰è£…åˆ° ChannelPipeline ä¸­ã€‚</p>
<h2 id="ä½¿ç”¨-netty-çš„-channeloption-å’Œå±æ€§">ä½¿ç”¨ Netty çš„ ChannelOption å’Œå±æ€§<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨-netty-çš„-channeloption-å’Œå±æ€§">#</a></h2>
<p>åœ¨æ¯ä¸ª Channel åˆ›å»ºæ—¶éƒ½æ‰‹åŠ¨é…ç½®å®ƒå¯èƒ½ä¼šå˜å¾—ç›¸å½“ä¹å‘³ã€‚å¹¸è¿çš„æ˜¯ï¼Œä½ ä¸å¿…è¿™æ ·åšã€‚ç›¸åï¼Œä½ å¯ä»¥ä½¿ç”¨option()æ–¹æ³•æ¥å°† ChannelOption åº”ç”¨åˆ°å¼•å¯¼ã€‚ä½ æ‰€æä¾›çš„å€¼å°†ä¼šè¢«è‡ªåŠ¨åº”ç”¨åˆ°å¼•å¯¼æ‰€åˆ›å»ºçš„æ‰€æœ‰ Channelã€‚å¯ç”¨çš„ ChannelOption åŒ…æ‹¬äº†åº•å±‚è¿æ¥çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚keep-alive æˆ–è€…è¶…æ—¶å±æ€§ä»¥åŠç¼“å†²åŒºè®¾ç½®ã€‚</p>
<p>Netty åº”ç”¨ç¨‹åºé€šå¸¸ä¸ç»„ç»‡çš„ä¸“æœ‰è½¯ä»¶é›†æˆåœ¨ä¸€èµ·ï¼Œè€Œåƒ Channel è¿™æ ·çš„ç»„ä»¶å¯èƒ½ç”šè‡³ä¼šåœ¨æ­£å¸¸çš„ Netty ç”Ÿå‘½å‘¨æœŸä¹‹å¤–è¢«ä½¿ç”¨ã€‚åœ¨æŸäº›å¸¸ç”¨çš„å±æ€§å’Œæ•°æ®ä¸å¯ç”¨æ—¶ï¼ŒNetty æä¾›äº†AttributeMap æŠ½è±¡ï¼ˆä¸€ä¸ªç”± Channelå’Œå¼•å¯¼ç±»æä¾›çš„é›†åˆï¼‰ä»¥åŠ<code>AttributeKey&lt;T&gt;</code>ï¼ˆä¸€ä¸ªç”¨äºæ’å…¥å’Œè·å–å±æ€§å€¼çš„æ³›å‹ç±»ï¼‰ã€‚ä½¿ç”¨è¿™äº›å·¥å…·ï¼Œä¾¿å¯ä»¥å®‰å…¨åœ°å°†ä»»ä½•ç±»å‹çš„æ•°æ®é¡¹ä¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ Channelï¼ˆåŒ…å« ServerChannel çš„å­ Channelï¼‰ç›¸å…³è”äº†ã€‚</p>
<p>ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªç”¨äºè·Ÿè¸ªç”¨æˆ·å’Œ Channel ä¹‹é—´çš„å…³ç³»çš„æœåŠ¡å™¨åº”ç”¨ç¨‹åºã€‚è¿™å¯ä»¥é€šè¿‡å°†ç”¨æˆ·çš„ ID å­˜å‚¨ä¸ºChannel çš„ä¸€ä¸ªå±æ€§æ¥å®Œæˆã€‚ç±»ä¼¼çš„æŠ€æœ¯å¯ä»¥è¢«ç”¨æ¥åŸºäºç”¨æˆ·çš„ ID å°†æ¶ˆæ¯è·¯ç”±ç»™ç”¨æˆ·ï¼Œæˆ–è€…å…³é—­æ´»åŠ¨è¾ƒå°‘çš„ Channelã€‚ä»£ç æ¸…å• 8-7 å±•ç¤ºäº†å¯ä»¥å¦‚ä½•ä½¿ç”¨ ChannelOption æ¥é…ç½® Channelï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨å±æ€§æ¥å­˜å‚¨æ•´å‹å€¼ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 8-7 ä½¿ç”¨å±æ€§å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapClientWithOptionsAndAttrs {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 8-7 ä½¿ç”¨å±æ€§å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª AttributeKey ä»¥æ ‡è¯†è¯¥å±æ€§</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> AttributeKey&lt;Integer&gt; id = AttributeKey.<span style="color:#007f7f">newInstance</span>(<span style="color:#0ff;font-weight:bold">&#34;ID&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª Bootstrap ç±»çš„å®ä¾‹ä»¥åˆ›å»ºå®¢æˆ·ç«¯ Channel å¹¶è¿æ¥å®ƒä»¬</span>
</span></span><span style="display:flex;"><span>        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½® EventLoopGroupï¼Œå…¶æä¾›äº†ç”¨ä»¥å¤„ç† Channel äº‹ä»¶çš„ EventLoop</span>
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(<span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup())
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æŒ‡å®š Channel çš„å®ç°</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">channel</span>(NioSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">handler</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//è®¾ç½®ç”¨ä»¥å¤„ç† Channel çš„ I/O ä»¥åŠæ•°æ®çš„ ChannelInboundHandler</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRegistered(ChannelHandlerContext ctx)
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//ä½¿ç”¨ AttributeKey æ£€ç´¢å±æ€§ä»¥åŠå®ƒçš„å€¼</span>
</span></span><span style="display:flex;"><span>                        Integer idValue = ctx.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">attr</span>(id).<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// do something with the idValue</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                        ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                        ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½® ChannelOptionï¼Œå…¶å°†åœ¨ connect()æˆ–è€…bind()æ–¹æ³•è¢«è°ƒç”¨æ—¶è¢«è®¾ç½®åˆ°å·²ç»åˆ›å»ºçš„ Channel ä¸Š</span>
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">option</span>(ChannelOption.<span style="color:#007f7f">SO_KEEPALIVE</span>, <span style="color:#fff;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">option</span>(ChannelOption.<span style="color:#007f7f">CONNECT_TIMEOUT_MILLIS</span>, 5000);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å­˜å‚¨è¯¥ id å±æ€§</span>
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">attr</span>(id, 123456);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä½¿ç”¨é…ç½®å¥½çš„ Bootstrap å®ä¾‹è¿æ¥åˆ°è¿œç¨‹ä¸»æœº</span>
</span></span><span style="display:flex;"><span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">connect</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;www.manning.com&#34;</span>, 80));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å¼•å¯¼-datagramchannel">å¼•å¯¼ DatagramChannel<a hidden class="anchor" aria-hidden="true" href="#å¼•å¯¼-datagramchannel">#</a></h2>
<p>å‰é¢çš„å¼•å¯¼ä»£ç ç¤ºä¾‹ä½¿ç”¨çš„éƒ½æ˜¯åŸºäº TCP åè®®çš„ SocketChannelï¼Œä½†æ˜¯ Bootstrap ç±»ä¹Ÿå¯ä»¥è¢«ç”¨äºæ— è¿æ¥çš„åè®®ã€‚ä¸ºæ­¤ï¼ŒNetty æä¾›äº†å„ç§ DatagramChannel çš„å®ç°ã€‚å”¯ä¸€åŒºåˆ«å°±æ˜¯ï¼Œä¸å†è°ƒç”¨ connect()æ–¹æ³•ï¼Œè€Œæ˜¯åªè°ƒç”¨ bind()æ–¹æ³•ï¼Œå¦‚ä»£ç æ¸…å• 8-8 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 8-8 ä½¿ç”¨ Bootstrap å’Œ DatagramChannel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapDatagramChannel {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 8-8 ä½¿ç”¨ Bootstrap å’Œ DatagramChannel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª Bootstrap çš„å®ä¾‹ä»¥åˆ›å»ºå’Œç»‘å®šæ–°çš„æ•°æ®æŠ¥ Channel</span>
</span></span><span style="display:flex;"><span>        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½® EventLoopGroupï¼Œå…¶æä¾›äº†ç”¨ä»¥å¤„ç† Channel äº‹ä»¶çš„ EventLoop</span>
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(<span style="color:#fff;font-weight:bold">new</span> OioEventLoopGroup()).<span style="color:#007f7f">channel</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æŒ‡å®š Channel çš„å®ç°</span>
</span></span><span style="display:flex;"><span>            OioDatagramChannel.<span style="color:#007f7f">class</span>).<span style="color:#007f7f">handler</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è®¾ç½®ç”¨ä»¥å¤„ç† Channel çš„ I/O ä»¥åŠæ•°æ®çš„ ChannelInboundHandler</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;DatagramPacket&gt;() {
</span></span><span style="display:flex;"><span>                @Override
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>                    DatagramPacket msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">// Do something with the packet</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è°ƒç”¨ bind() æ–¹æ³•ï¼Œå› ä¸ºè¯¥åè®®æ˜¯æ— è¿æ¥çš„</span>
</span></span><span style="display:flex;"><span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">bind</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(0));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture channelFuture)
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">if</span> (channelFuture.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                   System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Channel bound&#34;</span>);
</span></span><span style="display:flex;"><span>               } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                   System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Bind attempt failed&#34;</span>);
</span></span><span style="display:flex;"><span>                   channelFuture.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>               }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å…³é—­ç¨‹åº">å…³é—­ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#å…³é—­ç¨‹åº">#</a></h2>
<p>è™½ç„¶å¯ä»¥è®© JVM åœ¨é€€å‡ºæ—¶å¤„ç†å¥½ä¸€åˆ‡ï¼Œä½†æ˜¯è¿™å¹¶ä¸ä¼˜é›…ï¼Œä¼˜é›…æ˜¯æŒ‡å¹²å‡€åœ°é‡Šæ”¾èµ„æºã€‚
é¦–å…ˆéœ€è¦å…³é—­ EventLoopGroupï¼Œå¹¶ä¸”éšåé‡Šæ”¾æ‰€æœ‰æ´»åŠ¨çš„çº¿ç¨‹ã€‚è¿™å°±æ˜¯è°ƒç”¨
EventLoopGroup.shutdownGracefully()æ–¹æ³•çš„ä½œç”¨ã€‚è¿™ä¸ªæ–¹æ³•è°ƒç”¨å°†ä¼šè¿”å›ä¸€ä¸ª Futureï¼Œè¿™ä¸ª Future å°†åœ¨å…³é—­å®Œæˆæ—¶æ¥æ”¶åˆ°é€šçŸ¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒshutdownGracefully()æ–¹æ³•ä¹Ÿæ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æ“ä½œï¼Œæ‰€ä»¥ä½ éœ€è¦é˜»å¡ç­‰å¾…ç›´åˆ°å®ƒå®Œæˆï¼Œæˆ–è€…å‘æ‰€è¿”å›çš„ Future æ³¨å†Œä¸€ä¸ªç›‘å¬å™¨ä»¥åœ¨å…³é—­å®Œæˆæ—¶è·å¾—é€šçŸ¥ã€‚
ä»£ç æ¸…å• 8-9 ç¬¦åˆä¼˜é›…å…³é—­çš„å®šä¹‰ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 8-9 ä¼˜é›…å…³é—­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> GracefulShutdown {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String args[]) {
</span></span><span style="display:flex;"><span>        GracefulShutdown client = <span style="color:#fff;font-weight:bold">new</span> GracefulShutdown();
</span></span><span style="display:flex;"><span>        client.<span style="color:#007f7f">bootstrap</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ä»£ç æ¸…å• 8-9 ä¼˜é›…å…³é—­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºå¤„ç† I/O çš„EventLoopGroup</span>
</span></span><span style="display:flex;"><span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª Bootstrap ç±»çš„å®ä¾‹å¹¶é…ç½®å®ƒ</span>
</span></span><span style="display:flex;"><span>        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>             .<span style="color:#007f7f">channel</span>(NioSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>             .<span style="color:#007f7f">handler</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                            ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                            ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>             );
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">connect</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;www.manning.com&#34;</span>, 80)).<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//,,,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//shutdownGracefully()æ–¹æ³•å°†é‡Šæ”¾æ‰€æœ‰çš„èµ„æºï¼Œå¹¶ä¸”å…³é—­æ‰€æœ‰çš„å½“å‰æ­£åœ¨ä½¿ç”¨ä¸­çš„ Channel</span>
</span></span><span style="display:flex;"><span>        Future&lt;?&gt; future = group.<span style="color:#007f7f">shutdownGracefully</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// block until the group has shutdown</span>
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ–è€…ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨è°ƒç”¨ EventLoopGroup.shutdownGracefully()æ–¹æ³•ä¹‹å‰ï¼Œæ˜¾å¼åœ°åœ¨æ‰€æœ‰æ´»åŠ¨çš„
Channel ä¸Šè°ƒç”¨ Channel.close()æ–¹æ³•ã€‚ä½†æ˜¯åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œéƒ½è¯·è®°å¾—å…³é—­EventLoopGroup æœ¬èº«ã€‚</p>
<h2 id="å°ç»“-1">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“-1">#</a></h2>
<p>åœ¨æœ¬ç« ä¸­ï¼Œä½ å­¦ä¹ äº†å¦‚ä½•å¼•å¯¼ Netty æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬é‚£äº›ä½¿ç”¨æ— è¿æ¥åè®®çš„åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬ä¹Ÿæ¶µç›–äº†ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼ŒåŒ…æ‹¬åœ¨æœåŠ¡å™¨åº”ç”¨ç¨‹åºä¸­å¼•å¯¼å®¢æˆ·ç«¯ Channelï¼Œä»¥åŠä½¿ç”¨ ChannelInitializeræ¥å¤„ç†å¼•å¯¼è¿‡ç¨‹ä¸­çš„å¤šä¸ª ChannelHandler çš„å®‰è£…ã€‚ä½ çœ‹åˆ°äº†å¦‚ä½•è®¾ç½® Channel çš„é…ç½®é€‰é¡¹ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨å±æ€§æ¥å°†ä¿¡æ¯é™„åŠ åˆ° Channelã€‚æœ€åï¼Œä½ å­¦ä¹ äº†å¦‚ä½•ä¼˜é›…åœ°å…³é—­åº”ç”¨ç¨‹åºï¼Œä»¥æœ‰åºåœ°é‡Šæ”¾æ‰€æœ‰çš„èµ„æºã€‚åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶ Netty æä¾›çš„å¸®åŠ©ä½ æµ‹è¯•ä½ çš„ ChannelHandler å®ç°çš„å·¥å…·ã€‚</p>
<h1 id="å•å…ƒæµ‹è¯•">å•å…ƒæµ‹è¯•<a hidden class="anchor" aria-hidden="true" href="#å•å…ƒæµ‹è¯•">#</a></h1>
<p>ChannelHandler æ˜¯ Netty åº”ç”¨ç¨‹åºçš„å…³é”®å…ƒç´ ï¼Œæ‰€ä»¥å½»åº•åœ°æµ‹è¯•å®ƒä»¬åº”è¯¥æ˜¯ä½ çš„å¼€å‘è¿‡ç¨‹çš„ä¸€ä¸ªæ ‡å‡†éƒ¨åˆ†ã€‚
æœ€ä½³å®è·µè¦æ±‚ä½ çš„æµ‹è¯•ä¸ä»…è¦èƒ½å¤Ÿè¯æ˜ä½ çš„å®ç°æ˜¯æ­£ç¡®çš„ï¼Œè€Œä¸”è¿˜è¦èƒ½å¤Ÿå¾ˆå®¹æ˜“åœ°éš”ç¦»é‚£äº›å› ä¿®æ”¹ä»£ç è€Œçªç„¶å‡ºç°çš„é—®é¢˜ã€‚è¿™ç§ç±»å‹çš„æµ‹è¯•å«ä½œå•å…ƒæµ‹è¯•ã€‚
è™½ç„¶å•å…ƒæµ‹è¯•æ²¡æœ‰ç»Ÿä¸€çš„å®šä¹‰ï¼Œä½†æ˜¯å¤§å¤šæ•°çš„ä»ä¸šè€…éƒ½æœ‰åŸºæœ¬çš„å…±è¯†ã€‚å…¶åŸºæœ¬æ€æƒ³æ˜¯ï¼Œä»¥å°½å¯èƒ½å°çš„åŒºå—æµ‹è¯•ä½ çš„ä»£ç ï¼Œå¹¶ä¸”å°½å¯èƒ½åœ°å’Œå…¶ä»–çš„ä»£ç æ¨¡å—ä»¥åŠè¿è¡Œæ—¶çš„ä¾èµ–ï¼ˆå¦‚æ•°æ®åº“å’Œç½‘ç»œï¼‰ç›¸éš”ç¦»ã€‚å¦‚æœä½ çš„åº”ç”¨ç¨‹åºèƒ½é€šè¿‡æµ‹è¯•éªŒè¯æ¯ä¸ªå•å…ƒæœ¬èº«éƒ½èƒ½å¤Ÿæ­£å¸¸åœ°å·¥ä½œï¼Œé‚£ä¹ˆåœ¨å‡ºäº†é—®é¢˜æ—¶å°†å¯ä»¥æ›´åŠ å®¹æ˜“åœ°æ‰¾å‡ºæ ¹æœ¬åŸå› ã€‚
åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ä¸€ç§ç‰¹æ®Šçš„ Channel å®ç°â€”â€”EmbeddedChannelï¼Œå®ƒæ˜¯ Netty ä¸“é—¨ä¸ºæ”¹è¿›é’ˆå¯¹ChannelHandler çš„å•å…ƒæµ‹è¯•è€Œæä¾›çš„ã€‚å› ä¸ºæ­£åœ¨è¢«æµ‹è¯•çš„ä»£ç æ¨¡å—æˆ–è€…å•å…ƒå°†åœ¨å®ƒæ­£å¸¸çš„è¿è¡Œæ—¶ç¯å¢ƒä¹‹å¤–è¢«æ‰§è¡Œï¼Œæ‰€ä»¥ä½ éœ€è¦ä¸€ä¸ªæ¡†æ¶æˆ–è€…è„šæ‰‹æ¶ä»¥ä¾¿åœ¨å…¶ä¸­è¿è¡Œå®ƒã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ JUnit 4 ä½œä¸ºæˆ‘ä»¬çš„æµ‹è¯•æ¡†æ¶ï¼Œæ‰€ä»¥ä½ éœ€è¦å¯¹å®ƒçš„ç”¨æ³•æœ‰ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ã€‚å¦‚æœå®ƒå¯¹ä½ æ¥è¯´æ¯”è¾ƒé™Œç”Ÿï¼Œä¸è¦å®³æ€•ï¼›è™½ç„¶å®ƒåŠŸèƒ½å¼ºå¤§ï¼Œä½†å´å¾ˆç®€å•ï¼Œä½ å¯ä»¥åœ¨ JUnit çš„å®˜æ–¹ç½‘ç«™ <a href="https://junit.org/">https://junit.org/</a> ä¸Šæ‰¾åˆ°ä½ æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p>
<h2 id="embeddedchannel-æ¦‚è¿°">EmbeddedChannel æ¦‚è¿°<a hidden class="anchor" aria-hidden="true" href="#embeddedchannel-æ¦‚è¿°">#</a></h2>
<p>ä½ å·²ç»çŸ¥é“ï¼Œå¯ä»¥å°† ChannelPipeline ä¸­çš„ ChannelHandler å®ç°é“¾æ¥åœ¨ä¸€èµ·ï¼Œä»¥æ„å»ºä½ çš„åº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘ã€‚æˆ‘ä»¬å·²ç»åœ¨å‰é¢è§£é‡Šè¿‡ï¼Œè¿™ç§è®¾è®¡æ”¯æŒå°†ä»»ä½•æ½œåœ¨çš„å¤æ‚å¤„ç†è¿‡ç¨‹åˆ†è§£ä¸ºå°çš„å¯é‡ç”¨çš„ç»„ä»¶ï¼Œæ¯ä¸ªç»„ä»¶éƒ½å°†å¤„ç†ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„ä»»åŠ¡æˆ–è€…æ­¥éª¤ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬è¿˜å°†å±•ç¤ºå®ƒæ˜¯å¦‚ä½•ç®€åŒ–æµ‹è¯•çš„ã€‚
Netty æä¾›äº†å®ƒæ‰€è°“çš„ Embedded ä¼ è¾“ï¼Œç”¨äºæµ‹è¯• ChannelHandlerã€‚è¿™ä¸ªä¼ è¾“æ˜¯ä¸€ç§ç‰¹æ®Šçš„Channel å®ç°ï¼ŒEmbeddedChannelçš„åŠŸèƒ½ï¼Œè¿™ä¸ªå®ç°æä¾›äº†é€šè¿‡ ChannelPipelineä¼ æ’­äº‹ä»¶çš„ç®€ä¾¿æ–¹æ³•ã€‚</p>
<p>å°†å…¥ç«™æ•°æ®æˆ–è€…å‡ºç«™æ•°æ®å†™å…¥åˆ° EmbeddedChannel ä¸­ï¼Œç„¶åæ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ä¸œè¥¿åˆ°è¾¾äº† ChannelPipelineçš„å°¾ç«¯ã€‚ä»¥è¿™ç§æ–¹å¼ï¼Œä½ ä¾¿å¯ä»¥ç¡®å®šæ¶ˆæ¯æ˜¯å¦å·²ç»è¢«ç¼–ç æˆ–è€…è¢«è§£ç è¿‡äº†ï¼Œä»¥åŠæ˜¯å¦è§¦å‘äº†ä»»ä½•çš„ChannelHandler åŠ¨ä½œã€‚è¡¨ 9-1 ä¸­åˆ—å‡ºäº† EmbeddedChannel çš„ç›¸å…³æ–¹æ³•ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>èŒ è´£</th>
</tr>
</thead>
<tbody>
<tr>
<td>writeInbound( Object&hellip; msgs)</td>
<td>å°†å…¥ç«™æ¶ˆæ¯å†™åˆ° EmbeddedChannel ä¸­ã€‚å¦‚æœå¯ä»¥é€šè¿‡ readInbound() æ–¹æ³•ä» EmbeddedChannel ä¸­è¯»å–æ•°æ®ï¼Œåˆ™è¿”å› true</td>
</tr>
<tr>
<td>readInbound()</td>
<td>ä» EmbeddedChannel ä¸­è¯»å–ä¸€ä¸ªå…¥ç«™æ¶ˆæ¯ã€‚ä»»ä½•è¿”å›çš„ä¸œè¥¿éƒ½ç©¿è¶Šäº†æ•´ ä¸ª ChannelPipelineã€‚å¦‚æœæ²¡æœ‰ä»»ä½•å¯ä¾›è¯»å–çš„ï¼Œåˆ™è¿”å› null</td>
</tr>
<tr>
<td>writeOutbound( Object&hellip; msgs)</td>
<td>å°†å‡ºç«™æ¶ˆæ¯å†™åˆ°EmbeddedChannelä¸­ã€‚å¦‚æœç°åœ¨å¯ä»¥é€šè¿‡readOutbound() æ–¹æ³•ä» EmbeddedChannel ä¸­è¯»å–åˆ°ä»€ä¹ˆä¸œè¥¿ï¼Œåˆ™è¿”å› true</td>
</tr>
<tr>
<td>readOutbound()</td>
<td>EmbeddedChannel ä¸­è¯»å–ä¸€ä¸ªå‡ºç«™æ¶ˆæ¯ã€‚ä»»ä½•è¿”å›çš„ä¸œè¥¿éƒ½ç©¿è¶Šäº†æ•´ ä¸ª ChannelPipelineã€‚å¦‚æœæ²¡æœ‰ä»»ä½•å¯ä¾›è¯»å–çš„ï¼Œåˆ™è¿”å› null</td>
</tr>
<tr>
<td>finish()</td>
<td>å°† EmbeddedChannel æ ‡è®°ä¸ºå®Œæˆï¼Œå¹¶ä¸”å¦‚æœæœ‰å¯è¢«è¯»å–çš„å…¥ç«™æ•°æ®æˆ–è€… å‡ºç«™æ•°æ®ï¼Œåˆ™è¿”å› trueã€‚è¿™ä¸ªæ–¹æ³•è¿˜å°†ä¼šè°ƒç”¨ EmbeddedChannel ä¸Šçš„ close()æ–¹æ³•</td>
</tr>
</tbody>
</table>
<p>å…¥ç«™æ•°æ®ç”± ChannelInboundHandler å¤„ç†ï¼Œä»£è¡¨ä»è¿œç¨‹èŠ‚ç‚¹è¯»å–çš„æ•°æ®ã€‚å‡ºç«™æ•°æ®ç”±
ChannelOutboundHandler å¤„ç†ï¼Œä»£è¡¨å°†è¦å†™åˆ°è¿œç¨‹èŠ‚ç‚¹çš„æ•°æ®ã€‚æ ¹æ®ä½ è¦æµ‹è¯•çš„ ChannelHandlerï¼Œä½ å°†ä½¿ç”¨<em>Inbound()æˆ–è€…</em>Outbound()æ–¹æ³•å¯¹ï¼Œæˆ–è€…å…¼è€Œæœ‰ä¹‹ã€‚
å›¾ 9-1 å±•ç¤ºäº†ä½¿ç”¨ EmbeddedChannel çš„æ–¹æ³•ï¼Œæ•°æ®æ˜¯å¦‚ä½•æµç» ChannelPipeline çš„ã€‚ä½ å¯ä»¥ä½¿ç”¨
writeOutbound()æ–¹æ³•å°†æ¶ˆæ¯å†™åˆ° Channel ä¸­ï¼Œå¹¶é€šè¿‡ ChannelPipeline æ²¿ç€å‡ºç«™çš„æ–¹å‘ä¼ é€’ã€‚éšåï¼Œä½ å¯ä»¥ä½¿ç”¨ readOutbound()æ–¹æ³•æ¥è¯»å–å·²è¢«å¤„ç†è¿‡çš„æ¶ˆæ¯ï¼Œä»¥ç¡®å®šç»“æœæ˜¯å¦å’Œé¢„æœŸä¸€æ ·ã€‚ç±»ä¼¼åœ°ï¼Œå¯¹äºå…¥ç«™æ•°æ®ï¼Œä½ éœ€è¦ä½¿ç”¨writeInbound()å’ŒreadInbound()æ–¹æ³•ã€‚
åœ¨æ¯ç§æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯éƒ½å°†ä¼šä¼ é€’è¿‡ ChannelPipelineï¼Œå¹¶ä¸”è¢«ç›¸å…³çš„ ChannelInboundHandler æˆ–è€…
ChannelOutboundHandler å¤„ç†ã€‚å¦‚æœæ¶ˆæ¯æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨readInbound()æˆ–è€…
readOutbound()æ–¹æ³•æ¥åœ¨å¤„ç†è¿‡äº†è¿™äº›æ¶ˆæ¯ä¹‹åï¼Œé…Œæƒ…æŠŠå®ƒä»¬ä»Channelä¸­è¯»å‡ºæ¥ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/53.png">
æ¥ä¸‹æ¥è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹è¿™ä¸¤ç§åœºæ™¯ï¼Œä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•åº”ç”¨äºæµ‹è¯•ä½ çš„åº”ç”¨ç¨‹åºé€»è¾‘çš„å§ã€‚</p>
<h2 id="ä½¿ç”¨-embeddedchannel-æµ‹è¯•-channelhandler">ä½¿ç”¨ EmbeddedChannel æµ‹è¯• ChannelHandler<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨-embeddedchannel-æµ‹è¯•-channelhandler">#</a></h2>
<p>JUnit æ–­è¨€ï¼š
org.junit.Assert ç±»æä¾›äº†å¾ˆå¤šç”¨äºæµ‹è¯•çš„é™æ€æ–¹æ³•ã€‚å¤±è´¥çš„æ–­è¨€å°†å¯¼è‡´ä¸€ä¸ªå¼‚å¸¸è¢«æŠ›å‡ºï¼Œå¹¶å°†ç»ˆæ­¢å½“å‰æ­£åœ¨æ‰§è¡Œä¸­çš„æµ‹è¯•ã€‚å¯¼å…¥è¿™äº›æ–­è¨€çš„æœ€é«˜æ•ˆçš„æ–¹å¼æ˜¯é€šè¿‡ä¸€ä¸ª import static è¯­å¥æ¥å®ç°ï¼š
<code>import static org.junit.Assert.*;</code>
ä¸€æ—¦è¿™æ ·åšäº†ï¼Œå°±å¯ä»¥ç›´æ¥è°ƒç”¨ Assert æ–¹æ³•äº†ï¼š
<code>assertEquals(buf.readSlice(3), read);</code></p>
<h3 id="æµ‹è¯•å…¥ç«™æ¶ˆæ¯">æµ‹è¯•å…¥ç«™æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#æµ‹è¯•å…¥ç«™æ¶ˆæ¯">#</a></h3>
<p>å›¾ 9-2 å±•ç¤ºäº†ä¸€ä¸ªç®€å•çš„ ByteToMessageDecoder å®ç°ã€‚ç»™å®šè¶³å¤Ÿçš„æ•°æ®ï¼Œè¿™ä¸ªå®ç°å°†äº§ç”Ÿå›ºå®šå¤§å°çš„å¸§ã€‚å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®å¯ä¾›è¯»å–ï¼Œå®ƒå°†ç­‰å¾…ä¸‹ä¸€ä¸ªæ•°æ®å—çš„åˆ°æ¥ï¼Œå¹¶å°†å†æ¬¡æ£€æŸ¥æ˜¯å¦èƒ½å¤Ÿäº§ç”Ÿä¸€ä¸ªæ–°çš„å¸§ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/54.png">
æ­£å¦‚å¯ä»¥ä»å›¾ 9-2 å³ä¾§çš„å¸§çœ‹åˆ°çš„é‚£æ ·ï¼Œè¿™ä¸ªç‰¹å®šçš„è§£ç å™¨å°†äº§ç”Ÿå›ºå®šä¸º 3 å­—èŠ‚å¤§å°çš„å¸§ã€‚å› æ­¤ï¼Œå®ƒå¯èƒ½ä¼šéœ€è¦å¤šä¸ªäº‹ä»¶æ¥æä¾›è¶³å¤Ÿçš„å­—èŠ‚æ•°ä»¥äº§ç”Ÿä¸€ä¸ªå¸§ã€‚æœ€ç»ˆï¼Œæ¯ä¸ªå¸§éƒ½ä¼šè¢«ä¼ é€’ç»™ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ªChannelHandlerã€‚è¯¥è§£ç å™¨çš„å®ç°ï¼Œå¦‚ä»£ç æ¸…å• 9-1 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å•9-1 FixedLengthFrameDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±• ByteToMessageDecoder ä»¥å¤„ç†å…¥ç«™å­—èŠ‚ï¼Œå¹¶å°†å®ƒä»¬è§£ç ä¸ºæ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FixedLengthFrameDecoder <span style="color:#fff;font-weight:bold">extends</span> ByteToMessageDecoder {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> frameLength;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æŒ‡å®šè¦ç”Ÿæˆçš„å¸§çš„é•¿åº¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FixedLengthFrameDecoder(<span style="color:#fff;font-weight:bold">int</span> frameLength) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (frameLength &lt;= 0) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalArgumentException(<span style="color:#0ff;font-weight:bold">&#34;frameLength must be a positive integer: &#34;</span> + frameLength);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">frameLength</span> = frameLength;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å­—èŠ‚å¯ä»¥è¢«è¯»å–ï¼Œä»¥ç”Ÿæˆä¸‹ä¸€ä¸ªå¸§</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> (in.<span style="color:#007f7f">readableBytes</span>() &gt;= frameLength) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ä» ByteBuf ä¸­è¯»å–ä¸€ä¸ªæ–°å¸§</span>
</span></span><span style="display:flex;"><span>            ByteBuf buf = in.<span style="color:#007f7f">readBytes</span>(frameLength);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å°†è¯¥å¸§æ·»åŠ åˆ°å·²è¢«è§£ç çš„æ¶ˆæ¯åˆ—è¡¨ä¸­</span>
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(buf);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå•å…ƒæµ‹è¯•ï¼Œä»¥ç¡®ä¿è¿™æ®µä»£ç å°†æŒ‰ç…§é¢„æœŸæ‰§è¡Œã€‚å³ä½¿æ˜¯åœ¨ç®€å•çš„ä»£ç ä¸­ï¼Œå•å…ƒæµ‹è¯•ä¹Ÿèƒ½å¸®åŠ©æˆ‘ä»¬é˜²æ­¢åœ¨å°†æ¥ä»£ç é‡æ„æ—¶å¯èƒ½ä¼šå¯¼è‡´çš„é—®é¢˜ï¼Œå¹¶ä¸”èƒ½åœ¨é—®é¢˜å‘ç”Ÿæ—¶å¸®åŠ©æˆ‘ä»¬è¯Šæ–­å®ƒä»¬ã€‚ä»£ç æ¸…å• 9-2 å±•ç¤ºäº†ä¸€ä¸ªä½¿ç”¨ EmbeddedChannel çš„å¯¹äºå‰é¢ä»£ç çš„æµ‹è¯•ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å•9-5 FrameChunkDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FixedLengthFrameDecoderTest {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ä½¿ç”¨äº†æ³¨è§£@Test æ ‡æ³¨ï¼Œå› æ­¤JUnit å°†ä¼šæ‰§è¡Œè¯¥æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> testFramesDecoded() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª ByteBufï¼Œå¹¶å­˜å‚¨ 9 å­—èŠ‚</span>
</span></span><span style="display:flex;"><span>        ByteBuf buf = Unpooled.<span style="color:#007f7f">buffer</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; 9; i++) {
</span></span><span style="display:flex;"><span>            buf.<span style="color:#007f7f">writeByte</span>(i);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ByteBuf input = buf.<span style="color:#007f7f">duplicate</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ªEmbeddedChannelï¼Œå¹¶æ·»åŠ ä¸€ä¸ªFixedLengthFrameDecoderï¼Œå…¶å°†ä»¥ 3 å­—èŠ‚çš„å¸§é•¿åº¦è¢«æµ‹è¯•</span>
</span></span><span style="display:flex;"><span>        EmbeddedChannel channel = <span style="color:#fff;font-weight:bold">new</span> EmbeddedChannel(<span style="color:#fff;font-weight:bold">new</span> FixedLengthFrameDecoder(3));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å°†æ•°æ®å†™å…¥EmbeddedChannel</span>
</span></span><span style="display:flex;"><span>        assertTrue(channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">retain</span>()));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ ‡è®° Channelä¸ºå·²å®ŒæˆçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>        assertTrue(channel.<span style="color:#007f7f">finish</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è¯»å–æ‰€ç”Ÿæˆçš„æ¶ˆæ¯ï¼Œå¹¶ä¸”éªŒè¯æ˜¯å¦æœ‰ 3 å¸§ï¼ˆåˆ‡ç‰‡ï¼‰ï¼Œå…¶ä¸­æ¯å¸§ï¼ˆåˆ‡ç‰‡ï¼‰éƒ½ä¸º 3 å­—èŠ‚</span>
</span></span><span style="display:flex;"><span>        ByteBuf read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(3), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(3), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(3), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        assertNull(channel.<span style="color:#007f7f">readInbound</span>());
</span></span><span style="display:flex;"><span>        buf.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> testFramesDecoded2() {
</span></span><span style="display:flex;"><span>        ByteBuf buf = Unpooled.<span style="color:#007f7f">buffer</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; 9; i++) {
</span></span><span style="display:flex;"><span>            buf.<span style="color:#007f7f">writeByte</span>(i);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ByteBuf input = buf.<span style="color:#007f7f">duplicate</span>();
</span></span><span style="display:flex;"><span>        EmbeddedChannel channel = <span style="color:#fff;font-weight:bold">new</span> EmbeddedChannel(<span style="color:#fff;font-weight:bold">new</span> FixedLengthFrameDecoder(3));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è¿”å› falseï¼Œå› ä¸ºæ²¡æœ‰ä¸€ä¸ªå®Œæ•´çš„å¯ä¾›è¯»å–çš„å¸§</span>
</span></span><span style="display:flex;"><span>        assertFalse(channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">readBytes</span>(2)));
</span></span><span style="display:flex;"><span>        assertTrue(channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">readBytes</span>(7)));
</span></span><span style="display:flex;"><span>        assertTrue(channel.<span style="color:#007f7f">finish</span>());
</span></span><span style="display:flex;"><span>        ByteBuf read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(3), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(3), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(3), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        assertNull(channel.<span style="color:#007f7f">readInbound</span>());
</span></span><span style="display:flex;"><span>        buf.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¯¥ testFramesDecoded()æ–¹æ³•éªŒè¯äº†ï¼šä¸€ä¸ªåŒ…å« 9 ä¸ªå¯è¯»å­—èŠ‚çš„ ByteBuf è¢«è§£ç ä¸º 3ä¸ª ByteBufï¼Œæ¯ä¸ªéƒ½åŒ…å«äº† 3 å­—èŠ‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»…é€šè¿‡ä¸€æ¬¡å¯¹ writeInbound()æ–¹æ³•çš„è°ƒç”¨ï¼ŒByteBuf æ˜¯å¦‚ä½•è¢«å¡«å……äº† 9 ä¸ªå¯è¯»å­—èŠ‚çš„ã€‚åœ¨æ­¤ä¹‹åï¼Œé€šè¿‡æ‰§è¡Œ finish()æ–¹æ³•ï¼Œå°†EmbeddedChannel æ ‡è®°ä¸ºäº†å·²å®ŒæˆçŠ¶æ€ã€‚æœ€åï¼Œé€šè¿‡è°ƒç”¨readInbound()æ–¹æ³•ï¼Œä» EmbeddedChannel ä¸­æ­£å¥½è¯»å–äº† 3 ä¸ªå¸§å’Œä¸€ä¸ª nullã€‚testFramesDecoded2()æ–¹æ³•ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåªæœ‰ä¸€å¤„ä¸åŒï¼šå…¥ç«™ ByteBuf æ˜¯é€šè¿‡ä¸¤ä¸ªæ­¥éª¤å†™å…¥çš„ã€‚
å½“ writeInbound(input.readBytes(2))è¢«è°ƒç”¨æ—¶ï¼Œè¿”å›äº† falseã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ­£å¦‚åŒè¡¨ 9-1 ä¸­æ‰€æè¿°çš„ï¼Œå¦‚æœå¯¹ readInbound()çš„åç»­è°ƒç”¨å°†ä¼šè¿”å›æ•°æ®ï¼Œé‚£ä¹ˆ writeInbound()æ–¹æ³•å°†ä¼šè¿”å› trueã€‚ä½†æ˜¯åªæœ‰å½“æœ‰ 3 ä¸ªæˆ–è€…æ›´å¤šçš„å­—èŠ‚å¯ä¾›è¯»å–æ—¶ï¼ŒFixedLengthFrameDecoder æ‰ä¼šäº§ç”Ÿè¾“å‡ºã€‚
è¯¥æµ‹è¯•å‰©ä¸‹çš„éƒ¨åˆ†å’Œ testFramesDecoded()æ˜¯ç›¸åŒçš„ã€‚</p>
<h3 id="æµ‹è¯•å‡ºç«™æ¶ˆæ¯">æµ‹è¯•å‡ºç«™æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#æµ‹è¯•å‡ºç«™æ¶ˆæ¯">#</a></h3>
<p>æµ‹è¯•å‡ºç«™æ¶ˆæ¯çš„å¤„ç†è¿‡ç¨‹å’Œåˆšæ‰æ‰€çœ‹åˆ°çš„ç±»ä¼¼ã€‚
åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šå±•ç¤ºå¦‚ä½•ä½¿ç”¨EmbeddedChannelæ¥æµ‹è¯•ä¸€ä¸ªç¼–ç å™¨å½¢å¼çš„
ChannelOutboundHandlerï¼Œç¼–ç å™¨æ˜¯ä¸€ç§å°†ä¸€ç§æ¶ˆæ¯æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§çš„ç»„ä»¶ã€‚ä½ å°†åœ¨ä¸‹ä¸€ç« ä¸­éå¸¸è¯¦ç»†åœ°å­¦ä¹ ç¼–ç å™¨å’Œè§£ç å™¨ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬åªéœ€è¦ç®€å•åœ°æåŠæˆ‘ä»¬æ­£åœ¨æµ‹è¯•çš„å¤„ç†å™¨â€”AbsIntegerEncoderï¼Œå®ƒæ˜¯Netty çš„MessageToMessageEncoder çš„ä¸€ä¸ªç‰¹æ®ŠåŒ–çš„å®ç°ï¼Œç”¨äºå°†è´Ÿå€¼æ•´æ•°è½¬æ¢ä¸ºç»å¯¹å€¼ã€‚è¯¥ç¤ºä¾‹å°†ä¼šæŒ‰ç…§ä¸‹åˆ—æ–¹å¼å·¥ä½œï¼š</p>
<ul>
<li>æŒæœ‰ AbsIntegerEncoder çš„ EmbeddedChannel å°†ä¼šä»¥ 4 å­—èŠ‚çš„è´Ÿæ•´æ•°çš„å½¢å¼å†™å‡ºç«™æ•°æ®ï¼›</li>
<li>ç¼–ç å™¨å°†ä»ä¼ å…¥çš„ ByteBuf ä¸­è¯»å–æ¯ä¸ªè´Ÿæ•´æ•°ï¼Œå¹¶å°†ä¼šè°ƒç”¨ Math.abs()æ–¹æ³•æ¥è·å–å…¶ç»å¯¹å€¼ï¼›</li>
<li>ç¼–ç å™¨å°†ä¼šæŠŠæ¯ä¸ªè´Ÿæ•´æ•°çš„ç»å¯¹å€¼å†™åˆ° ChannelPipeline ä¸­ã€‚
å›¾ 9-3 å±•ç¤ºäº†è¯¥é€»è¾‘ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/55.png">
ä»£ç æ¸…å• 9-3 å®ç°äº†è¿™ä¸ªé€»è¾‘ï¼Œå¦‚å›¾ 9-3 æ‰€ç¤ºã€‚encode()æ–¹æ³•å°†æŠŠäº§ç”Ÿçš„å€¼å†™åˆ°ä¸€ä¸ªList ä¸­ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å•9-3 AbsIntegerEncoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±• MessageToMessageEncoder ä»¥å°†ä¸€ä¸ªæ¶ˆæ¯ç¼–ç ä¸ºå¦å¤–ä¸€ç§æ ¼å¼</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AbsIntegerEncoder <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageEncoder&lt;ByteBuf&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext channelHandlerContext, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å­—èŠ‚ç”¨æ¥ç¼–ç </span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> (in.<span style="color:#007f7f">readableBytes</span>() &gt;= 4) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ä»è¾“å…¥çš„ ByteBufä¸­è¯»å–ä¸‹ä¸€ä¸ªæ•´æ•°ï¼Œå¹¶ä¸”è®¡ç®—å…¶ç»å¯¹å€¼</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> value = Math.<span style="color:#007f7f">abs</span>(in.<span style="color:#007f7f">readInt</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å°†è¯¥æ•´æ•°å†™å…¥åˆ°ç¼–ç æ¶ˆæ¯çš„ List ä¸­</span>
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(value);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»£ç æ¸…å• 9-4 ä½¿ç”¨äº† EmbeddedChannel æ¥æµ‹è¯•ä»£ç ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 9-4 æµ‹è¯• AbsIntegerEncoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AbsIntegerEncoderTest {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> testEncoded() {
</span></span><span style="display:flex;"><span>        ByteBuf buf = Unpooled.<span style="color:#007f7f">buffer</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª ByteBufï¼Œå¹¶ä¸”å†™å…¥ 9 ä¸ªè´Ÿæ•´æ•°</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 1; i &lt; 10; i++) {
</span></span><span style="display:flex;"><span>            buf.<span style="color:#007f7f">writeInt</span>(i * -1);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ªEmbeddedChannelï¼Œå¹¶å®‰è£…ä¸€ä¸ªè¦æµ‹è¯•çš„AbsIntegerEncoder</span>
</span></span><span style="display:flex;"><span>        EmbeddedChannel channel = <span style="color:#fff;font-weight:bold">new</span> EmbeddedChannel(<span style="color:#fff;font-weight:bold">new</span> AbsIntegerEncoder());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å†™å…¥ ByteBufï¼Œå¹¶æ–­è¨€è°ƒç”¨ readOutbound()æ–¹æ³•å°†ä¼šäº§ç”Ÿæ•°æ®</span>
</span></span><span style="display:flex;"><span>        assertTrue(channel.<span style="color:#007f7f">writeOutbound</span>(buf));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†è¯¥Channelæ ‡è®°ä¸ºå·²å®ŒæˆçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>        assertTrue(channel.<span style="color:#007f7f">finish</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è¯»å–æ‰€äº§ç”Ÿçš„æ¶ˆæ¯ï¼Œå¹¶æ–­è¨€å®ƒä»¬åŒ…å«äº†å¯¹åº”çš„ç»å¯¹å€¼</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 1; i &lt; 10; i++) {
</span></span><span style="display:flex;"><span>            assertEquals(i, channel.<span style="color:#007f7f">readOutbound</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        assertNull(channel.<span style="color:#007f7f">readOutbound</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢æ˜¯ä»£ç ä¸­æ‰§è¡Œçš„æ­¥éª¤ã€‚</p>
<ol>
<li>å°† 4 å­—èŠ‚çš„è´Ÿæ•´æ•°å†™åˆ°ä¸€ä¸ªæ–°çš„ ByteBuf ä¸­ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ª EmbeddedChannelï¼Œå¹¶ä¸ºå®ƒåˆ†é…ä¸€ä¸ª AbsIntegerEncoderã€‚</li>
<li>è°ƒç”¨ EmbeddedChannel ä¸Šçš„ writeOutbound()æ–¹æ³•æ¥å†™å…¥è¯¥ ByteBufã€‚</li>
<li>æ ‡è®°è¯¥ Channel ä¸ºå·²å®ŒæˆçŠ¶æ€ã€‚</li>
<li>ä» EmbeddedChannel çš„å‡ºç«™ç«¯è¯»å–æ‰€æœ‰çš„æ•´æ•°ï¼Œå¹¶éªŒè¯æ˜¯å¦åªäº§ç”Ÿäº†ç»å¯¹å€¼ã€‚</li>
</ol>
<h2 id="æµ‹è¯•å¼‚å¸¸å¤„ç†">æµ‹è¯•å¼‚å¸¸å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#æµ‹è¯•å¼‚å¸¸å¤„ç†">#</a></h2>
<p>åº”ç”¨ç¨‹åºé€šå¸¸éœ€è¦æ‰§è¡Œæ¯”è½¬æ¢æ•°æ®æ›´åŠ å¤æ‚çš„ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½éœ€è¦å¤„ç†æ ¼å¼ä¸æ­£ç¡®çš„è¾“å…¥æˆ–è€…è¿‡é‡çš„æ•°æ®ã€‚åœ¨ä¸‹ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œå¦‚æœæ‰€è¯»å–çš„å­—èŠ‚æ•°è¶…å‡ºäº†æŸä¸ªç‰¹å®šçš„é™åˆ¶ï¼Œæˆ‘ä»¬å°†ä¼šæŠ›å‡ºä¸€ä¸ª TooLongFrameExceptionã€‚è¿™æ˜¯ä¸€ç§ç»å¸¸ç”¨æ¥é˜²èŒƒèµ„æºè¢«è€—å°½çš„æ–¹æ³•ã€‚
åœ¨å›¾ 9-4 ä¸­ï¼Œæœ€å¤§çš„å¸§å¤§å°å·²ç»è¢«è®¾ç½®ä¸º 3 å­—èŠ‚ã€‚å¦‚æœä¸€ä¸ªå¸§çš„å¤§å°è¶…å‡ºäº†è¯¥é™åˆ¶ï¼Œé‚£ä¹ˆç¨‹åºå°†ä¼šä¸¢å¼ƒå®ƒçš„å­—èŠ‚ï¼Œå¹¶æŠ›å‡ºä¸€ä¸ª TooLongFrameExceptionã€‚ä½äº ChannelPipeline ä¸­çš„å…¶ä»–ChannelHandler å¯ä»¥é€‰æ‹©åœ¨ exceptionCaught()æ–¹æ³•ä¸­å¤„ç†è¯¥å¼‚å¸¸æˆ–è€…å¿½ç•¥å®ƒã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/56.png">
å®ç°å¦‚ä»£ç æ¸…å• 9-5 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å•9-5 FrameChunkDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±• ByteToMessageDecoderä»¥å°†å…¥ç«™å­—èŠ‚è§£ç ä¸ºæ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FrameChunkDecoder <span style="color:#fff;font-weight:bold">extends</span> ByteToMessageDecoder {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> maxFrameSize;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æŒ‡å®šå°†è¦äº§ç”Ÿçš„å¸§çš„æœ€å¤§å…è®¸å¤§å°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FrameChunkDecoder(<span style="color:#fff;font-weight:bold">int</span> maxFrameSize) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">maxFrameSize</span> = maxFrameSize;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> readableBytes = in.<span style="color:#007f7f">readableBytes</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (readableBytes &gt; maxFrameSize) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// discard the bytes</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœè¯¥å¸§å¤ªå¤§ï¼Œåˆ™ä¸¢å¼ƒå®ƒå¹¶æŠ›å‡ºä¸€ä¸ª TooLongFrameExceptionâ€¦â€¦</span>
</span></span><span style="display:flex;"><span>            in.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> TooLongFrameException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//â€¦â€¦å¦åˆ™ï¼Œä» ByteBuf ä¸­è¯»å–ä¸€ä¸ªæ–°çš„å¸§</span>
</span></span><span style="display:flex;"><span>        ByteBuf buf = in.<span style="color:#007f7f">readBytes</span>(readableBytes);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†è¯¥å¸§æ·»åŠ åˆ°è§£ç  è¯»å–ä¸€ä¸ªæ–°çš„å¸§æ¶ˆæ¯çš„ List ä¸­</span>
</span></span><span style="display:flex;"><span>        out.<span style="color:#007f7f">add</span>(buf);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬å†ä½¿ç”¨ EmbeddedChannel æ¥æµ‹è¯•ä¸€æ¬¡è¿™æ®µä»£ç ï¼Œå¦‚ä»£ç æ¸…å• 9-6 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 9-6 æµ‹è¯• FrameChunkDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FrameChunkDecoderTest {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> testFramesDecoded() {
</span></span><span style="display:flex;"><span>        ByteBuf buf = Unpooled.<span style="color:#007f7f">buffer</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª ByteBufï¼Œå¹¶å‘å®ƒå†™å…¥ 9 å­—èŠ‚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; 9; i++) {
</span></span><span style="display:flex;"><span>            buf.<span style="color:#007f7f">writeByte</span>(i);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ByteBuf input = buf.<span style="color:#007f7f">duplicate</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª EmbeddedChannelï¼Œå¹¶å‘å…¶å®‰è£…ä¸€ä¸ªå¸§å¤§å°ä¸º 3 å­—èŠ‚çš„ FixedLengthFrameDecoder</span>
</span></span><span style="display:flex;"><span>        EmbeddedChannel channel = <span style="color:#fff;font-weight:bold">new</span> EmbeddedChannel(<span style="color:#fff;font-weight:bold">new</span> FrameChunkDecoder(3));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å‘å®ƒå†™å…¥ 2 å­—èŠ‚ï¼Œå¹¶æ–­è¨€å®ƒä»¬å°†ä¼šäº§ç”Ÿä¸€ä¸ªæ–°å¸§</span>
</span></span><span style="display:flex;"><span>        assertTrue(channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">readBytes</span>(2)));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å†™å…¥ä¸€ä¸ª 4 å­—èŠ‚å¤§å°çš„å¸§ï¼Œå¹¶æ•è·é¢„æœŸçš„TooLongFrameException</span>
</span></span><span style="display:flex;"><span>            channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">readBytes</span>(4));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœä¸Šé¢æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆå°±ä¼šåˆ°è¾¾è¿™ä¸ªæ–­è¨€ï¼Œå¹¶ä¸”æµ‹è¯•å¤±è´¥</span>
</span></span><span style="display:flex;"><span>            Assert.<span style="color:#007f7f">fail</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (TooLongFrameException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// expected exception</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å†™å…¥å‰©ä½™çš„2å­—èŠ‚ï¼Œå¹¶æ–­è¨€å°†ä¼šäº§ç”Ÿä¸€ä¸ªæœ‰æ•ˆå¸§</span>
</span></span><span style="display:flex;"><span>        assertTrue(channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">readBytes</span>(3)));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†è¯¥ Channel æ ‡è®°ä¸ºå·²å®ŒæˆçŠ¶æ€</span>
</span></span><span style="display:flex;"><span>        assertTrue(channel.<span style="color:#007f7f">finish</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è¯»å–äº§ç”Ÿçš„æ¶ˆæ¯ï¼Œå¹¶ä¸”éªŒè¯å€¼</span>
</span></span><span style="display:flex;"><span>        ByteBuf read = (ByteBuf) channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(2), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        read = (ByteBuf) channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">skipBytes</span>(4).<span style="color:#007f7f">readSlice</span>(3), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        buf.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¹ä¸€çœ‹ï¼Œè¿™çœ‹èµ·æ¥éå¸¸ç±»ä¼¼äºä»£ç æ¸…å• 9-2 ä¸­çš„æµ‹è¯•ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªæœ‰è¶£çš„è½¬æŠ˜ç‚¹ï¼Œå³å¯¹
TooLongFrameExceptionçš„å¤„ç†ã€‚è¿™é‡Œä½¿ç”¨çš„try/catchå—æ˜¯EmbeddedChannelçš„ä¸€ä¸ªç‰¹æ®ŠåŠŸèƒ½ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªwrite*æ–¹æ³•äº§ç”Ÿäº†ä¸€ä¸ªå—æ£€æŸ¥çš„Exceptionï¼Œé‚£ä¹ˆå®ƒå°†ä¼šè¢«åŒ…è£…åœ¨ä¸€ä¸ªRuntimeExceptionä¸­å¹¶æŠ›å‡ºã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¯¥ç±»å®ç°äº† exceptionCaught()æ–¹æ³•å¹¶å¤„ç†äº†è¯¥å¼‚å¸¸ï¼Œé‚£ä¹ˆå®ƒå°†ä¸ä¼šè¢« catchå—æ‰€æ•è·ã€‚è¿™ä½¿å¾—å¯ä»¥å®¹æ˜“åœ°æµ‹è¯•å‡ºä¸€ä¸ªExceptionæ˜¯å¦åœ¨å¤„ç†æ•°æ®çš„è¿‡ç¨‹ä¸­å·²ç»è¢«å¤„ç†äº†ã€‚è¿™é‡Œä»‹ç»çš„æµ‹è¯•æ–¹æ³•å¯ä»¥ç”¨äºä»»ä½•èƒ½æŠ›å‡º Exception çš„ ChannelHandler å®ç°ã€‚</p>
<h2 id="å°ç»“-2">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“-2">#</a></h2>
<p>ä½¿ç”¨ JUnit è¿™æ ·çš„æµ‹è¯•å·¥å…·æ¥è¿›è¡Œå•å…ƒæµ‹è¯•æ˜¯ä¸€ç§éå¸¸è¡Œä¹‹æœ‰æ•ˆçš„æ–¹å¼ï¼Œå®ƒèƒ½ä¿è¯ä½ çš„ä»£ç çš„æ­£ç¡®æ€§å¹¶æé«˜å®ƒçš„å¯ç»´æŠ¤æ€§ã€‚åœ¨æœ¬ç« ä¸­ï¼Œä½ å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ Netty æä¾›çš„æµ‹è¯•å·¥å…·æ¥æµ‹è¯•ä½ è‡ªå®šä¹‰çš„ ChannelHandlerã€‚åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¸“æ³¨äºä½¿ç”¨ Netty ç¼–å†™çœŸå®ä¸–ç•Œçš„åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬ä¸ä¼šå†æä¾›ä»»ä½•è¿›ä¸€æ­¥çš„æµ‹è¯•ä»£ç ç¤ºä¾‹äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›ä½ å°†è¿™é‡Œæ‰€å±•ç¤ºçš„æµ‹è¯•æ–¹æ³•çš„é‡è¦æ€§ç‰¢è®°äºå¿ƒã€‚</p>
<h1 id="ç¼–è§£ç å™¨æ¡†æ¶">ç¼–è§£ç å™¨æ¡†æ¶<a hidden class="anchor" aria-hidden="true" href="#ç¼–è§£ç å™¨æ¡†æ¶">#</a></h1>
<p>å°±åƒå¾ˆå¤šæ ‡å‡†çš„æ¶æ„æ¨¡å¼éƒ½è¢«å„ç§ä¸“ç”¨æ¡†æ¶æ‰€æ”¯æŒä¸€æ ·ï¼Œå¸¸è§çš„æ•°æ®å¤„ç†æ¨¡å¼å¾€å¾€ä¹Ÿæ˜¯ç›®æ ‡å®ç°çš„å¾ˆå¥½çš„å€™é€‰å¯¹è±¡ï¼Œå®ƒå¯ä»¥èŠ‚çœå¼€å‘äººå‘˜å¤§é‡çš„æ—¶é—´å’Œç²¾åŠ›ã€‚å½“ç„¶è¿™ä¹Ÿé€‚åº”äºæœ¬ç« çš„ä¸»é¢˜ï¼šç¼–ç å’Œè§£ç ï¼Œæˆ–è€…æ•°æ®ä»ä¸€ç§ç‰¹å®šåè®®çš„æ ¼å¼åˆ°å¦ä¸€ç§æ ¼å¼çš„è½¬æ¢ã€‚è¿™äº›ä»»åŠ¡å°†ç”±é€šå¸¸ç§°ä¸ºç¼–è§£ç å™¨çš„ç»„ä»¶æ¥å¤„ç†ã€‚Netty æä¾›äº†å¤šç§ç»„ä»¶ï¼Œç®€åŒ–äº†ä¸ºäº†æ”¯æŒå¹¿æ³›çš„åè®®è€Œåˆ›å»ºè‡ªå®šä¹‰çš„ç¼–è§£ç å™¨çš„è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨æ„å»ºä¸€ä¸ªåŸºäº Nettyçš„é‚®ä»¶æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä½ å°†ä¼šå‘ç° Netty å¯¹äºç¼–è§£ç å™¨çš„æ”¯æŒå¯¹äºå®ç° POP3ã€IMAP å’Œ SMTP åè®®æ¥è¯´æ˜¯å¤šä¹ˆçš„å®è´µã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯ç¼–è§£ç å™¨">ä»€ä¹ˆæ˜¯ç¼–è§£ç å™¨<a hidden class="anchor" aria-hidden="true" href="#ä»€ä¹ˆæ˜¯ç¼–è§£ç å™¨">#</a></h2>
<p>æ¯ä¸ªç½‘ç»œåº”ç”¨ç¨‹åºéƒ½å¿…é¡»å®šä¹‰å¦‚ä½•è§£æåœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´æ¥å›ä¼ è¾“çš„åŸå§‹å­—èŠ‚ï¼Œä»¥åŠå¦‚ä½•å°†å…¶å’Œç›®æ ‡åº”ç”¨ç¨‹åºçš„æ•°æ®æ ¼å¼åšç›¸äº’è½¬æ¢ã€‚è¿™ç§è½¬æ¢é€»è¾‘ç”±ç¼–è§£ç å™¨å¤„ç†ï¼Œç¼–è§£ç å™¨ç”±ç¼–ç å™¨å’Œè§£ç å™¨ç»„æˆï¼Œå®ƒä»¬æ¯ç§éƒ½å¯ä»¥å°†å­—èŠ‚æµä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼ã€‚é‚£ä¹ˆå®ƒä»¬çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¦‚æœå°†æ¶ˆæ¯çœ‹ä½œæ˜¯å¯¹äºç‰¹å®šçš„åº”ç”¨ç¨‹åºå…·æœ‰å…·ä½“å«ä¹‰çš„ç»“æ„åŒ–çš„å­—èŠ‚åºåˆ—â€”å®ƒçš„æ•°æ®ã€‚é‚£ä¹ˆç¼–ç å™¨æ˜¯å°†æ¶ˆæ¯è½¬æ¢ä¸ºé€‚åˆäºä¼ è¾“çš„æ ¼å¼ï¼ˆæœ€æœ‰å¯èƒ½çš„å°±æ˜¯å­—èŠ‚æµï¼‰ï¼›è€Œå¯¹åº”çš„è§£ç å™¨åˆ™æ˜¯å°†ç½‘ç»œå­—èŠ‚æµè½¬æ¢å›åº”ç”¨ç¨‹åºçš„æ¶ˆæ¯æ ¼å¼ã€‚å› æ­¤ï¼Œç¼–ç å™¨æ“ä½œå‡ºç«™æ•°æ®ï¼Œè€Œè§£ç å™¨å¤„ç†å…¥ç«™æ•°æ®ã€‚è®°ä½è¿™äº›èƒŒæ™¯ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹ Netty æ‰€æä¾›çš„ç”¨äºå®ç°è¿™ä¸¤ç§ç»„ä»¶çš„ç±»ã€‚</p>
<h2 id="è§£ç å™¨">è§£ç å™¨<a hidden class="anchor" aria-hidden="true" href="#è§£ç å™¨">#</a></h2>
<p>åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶ Netty æ‰€æä¾›çš„è§£ç å™¨ç±»ï¼Œå¹¶æä¾›å…³äºä½•æ—¶ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬çš„å…·ä½“ç¤ºä¾‹ã€‚
è¿™äº›ç±»è¦†ç›–äº†ä¸¤ä¸ªä¸åŒçš„ç”¨ä¾‹ï¼š</p>
<ul>
<li>å°†å­—èŠ‚è§£ç ä¸ºæ¶ˆæ¯â€”â€”ByteToMessageDecoder å’Œ ReplayingDecoderï¼›</li>
<li>å°†ä¸€ç§æ¶ˆæ¯ç±»å‹è§£ç ä¸ºå¦ä¸€ç§â€”â€”MessageToMessageDecoderã€‚
å› ä¸ºè§£ç å™¨æ˜¯è´Ÿè´£å°†å…¥ç«™æ•°æ®ä»ä¸€ç§æ ¼å¼è½¬æ¢åˆ°å¦ä¸€ç§æ ¼å¼çš„ï¼Œæ‰€ä»¥çŸ¥é“ Netty çš„è§£ç å™¨å®ç°äº†
ChannelInboundHandler ä¹Ÿä¸ä¼šè®©ä½ æ„Ÿåˆ°æ„å¤–ã€‚
ä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°è§£ç å™¨å‘¢ï¼Ÿå¾ˆç®€å•ï¼šæ¯å½“éœ€è¦ä¸º ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelInboundHandler è½¬æ¢å…¥ç«™æ•°æ®æ—¶ä¼šç”¨åˆ°ã€‚æ­¤å¤–ï¼Œå¾—ç›Šäº ChannelPipeline çš„è®¾è®¡ï¼Œå¯ä»¥å°†å¤šä¸ªè§£ç å™¨é“¾æ¥åœ¨ä¸€èµ·ï¼Œä»¥å®ç°ä»»æ„å¤æ‚çš„è½¬æ¢é€»è¾‘ï¼Œè¿™ä¹Ÿæ˜¯ Netty æ˜¯å¦‚ä½•æ”¯æŒä»£ç çš„æ¨¡å—åŒ–ä»¥åŠå¤ç”¨çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚</li>
</ul>
<h3 id="æŠ½è±¡ç±»-bytetomessagedecoder">æŠ½è±¡ç±» ByteToMessageDecoder<a hidden class="anchor" aria-hidden="true" href="#æŠ½è±¡ç±»-bytetomessagedecoder">#</a></h3>
<p>å°†å­—èŠ‚è§£ç ä¸ºæ¶ˆæ¯ï¼ˆæˆ–è€…å¦ä¸€ä¸ªå­—èŠ‚åºåˆ—ï¼‰æ˜¯ä¸€é¡¹å¾ˆå¸¸è§çš„ä»»åŠ¡ï¼ŒNetty ä¸ºå®ƒæä¾›äº†ä¸€ä¸ªæŠ½è±¡çš„åŸºç±»ï¼šByteToMessageDecoderã€‚ç”±äºä½ ä¸å¯èƒ½çŸ¥é“è¿œç¨‹èŠ‚ç‚¹æ˜¯å¦ä¼šä¸€æ¬¡æ€§åœ°å‘é€ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥è¿™ä¸ªç±»ä¼šå¯¹å…¥ç«™æ•°æ®è¿›è¡Œç¼“å†²ï¼Œç›´åˆ°å®ƒå‡†å¤‡å¥½å¤„ç†ã€‚è¡¨ 10-1 è§£é‡Šäº†å®ƒæœ€é‡è¦çš„ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<table>
<thead>
<tr>
<th>æ–¹ æ³•</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>decode( ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code></td>
<td>è¿™æ˜¯ä½ å¿…é¡»å®ç°çš„å”¯ä¸€æŠ½è±¡æ–¹æ³•ã€‚decode()æ–¹æ³•è¢«è°ƒç”¨æ—¶å°†ä¼šä¼  å…¥ä¸€ä¸ªåŒ…å«äº†ä¼ å…¥æ•°æ®çš„ ByteBufï¼Œä»¥åŠä¸€ä¸ªç”¨æ¥æ·»åŠ è§£ç æ¶ˆæ¯ çš„ Listã€‚å¯¹è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨å°†ä¼šé‡å¤è¿›è¡Œï¼Œç›´åˆ°ç¡®å®šæ²¡æœ‰æ–°çš„å…ƒ ç´ è¢«æ·»åŠ åˆ°è¯¥ Listï¼Œæˆ–è€…è¯¥ ByteBuf ä¸­æ²¡æœ‰æ›´å¤šå¯è¯»å–çš„å­—èŠ‚ æ—¶ä¸ºæ­¢ã€‚ç„¶åï¼Œå¦‚æœè¯¥ List ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå®ƒçš„å†…å®¹å°†ä¼šè¢«ä¼ é€’ç»™ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelInboundHandler</td>
</tr>
<tr>
<td><code>decodeLast( ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code></td>
<td>Nettyæä¾›çš„è¿™ä¸ªé»˜è®¤å®ç°åªæ˜¯ç®€å•åœ°è°ƒç”¨äº†decode()æ–¹æ³•ã€‚ å½“Channelçš„çŠ¶æ€å˜ä¸ºéæ´»åŠ¨æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å°†ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚ å¯ä»¥é‡å†™è¯¥æ–¹æ³•ä»¥æä¾›ç‰¹æ®Šçš„å¤„ç†</td>
</tr>
</tbody>
</table>
<p>ä¸‹é¢ä¸¾ä¸€ä¸ªå¦‚ä½•ä½¿ç”¨è¿™ä¸ªç±»çš„ç¤ºä¾‹ï¼Œå‡è®¾ä½ æ¥æ”¶äº†ä¸€ä¸ªåŒ…å«ç®€å• int çš„å­—èŠ‚æµï¼Œæ¯ä¸ª intéƒ½éœ€è¦è¢«å•ç‹¬å¤„ç†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ éœ€è¦ä»å…¥ç«™ ByteBuf ä¸­è¯»å–æ¯ä¸ª intï¼Œå¹¶å°†å®ƒä¼ é€’ç»™ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ªChannelInboundHandlerã€‚ä¸ºäº†è§£ç è¿™ä¸ªå­—èŠ‚æµï¼Œä½ è¦æ‰©å±•ByteToMessageDecoder ç±»ã€‚
ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŸå­ç±»å‹çš„ int åœ¨è¢«æ·»åŠ åˆ° List ä¸­æ—¶ï¼Œä¼šè¢«è‡ªåŠ¨è£…ç®±ä¸º Integerã€‚ï¼‰è¯¥è®¾è®¡å¦‚å›¾ 10-1 æ‰€ç¤ºã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/57.png">
æ¯æ¬¡ä»å…¥ç«™ ByteBuf ä¸­è¯»å– 4 å­—èŠ‚ï¼Œå°†å…¶è§£ç ä¸ºä¸€ä¸ª intï¼Œç„¶åå°†å®ƒæ·»åŠ åˆ°ä¸€ä¸ª List ä¸­ã€‚
å½“æ²¡æœ‰æ›´å¤šçš„å…ƒç´ å¯ä»¥è¢«æ·»åŠ åˆ°è¯¥ List ä¸­æ—¶ï¼Œå®ƒçš„å†…å®¹å°†ä¼šè¢«å‘é€ç»™ä¸‹ä¸€ä¸ª ChannelInboundHandlerã€‚
ä»£ç æ¸…å• 10-1 å±•ç¤ºäº† ToIntegerDecoder çš„ä»£ç ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 10-1 ToIntegerDecoder ç±»æ‰©å±•äº† ByteToMessageDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±•ByteToMessageDecoderç±»ï¼Œä»¥å°†å­—èŠ‚è§£ç ä¸ºç‰¹å®šçš„æ ¼å¼</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ToIntegerDecoder <span style="color:#fff;font-weight:bold">extends</span> ByteToMessageDecoder {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ£€æŸ¥æ˜¯å¦è‡³å°‘æœ‰ 4 å­—èŠ‚å¯è¯»ï¼ˆä¸€ä¸ª int çš„å­—èŠ‚é•¿åº¦ï¼‰</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (in.<span style="color:#007f7f">readableBytes</span>() &gt;= 4) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ä»å…¥ç«™ ByteBuf ä¸­è¯»å–ä¸€ä¸ª intï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°è§£ç æ¶ˆæ¯çš„ List ä¸­</span>
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(in.<span style="color:#007f7f">readInt</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è™½ç„¶ ByteToMessageDecoder ä½¿å¾—å¯ä»¥å¾ˆç®€å•åœ°å®ç°è¿™ç§æ¨¡å¼ï¼Œä½†æ˜¯ä½ å¯èƒ½ä¼šå‘ç°ï¼Œåœ¨è°ƒç”¨ readInt()æ–¹æ³•å‰ä¸å¾—ä¸éªŒè¯æ‰€è¾“å…¥çš„ ByteBuf æ˜¯å¦å…·æœ‰è¶³å¤Ÿçš„æ•°æ®æœ‰ç‚¹ç¹çã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®º ReplayingDecoderï¼Œå®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è§£ç å™¨ï¼Œä»¥å°‘é‡çš„å¼€é”€æ¶ˆé™¤äº†è¿™ä¸ªæ­¥éª¤ã€‚
ç¼–è§£ç å™¨ä¸­çš„å¼•ç”¨è®¡æ•°ï¼š
æ­£å¦‚æˆ‘ä»¬åœ¨ç¬¬ 5 ç« å’Œç¬¬ 6 ç« ä¸­æ‰€æåˆ°çš„ï¼Œå¼•ç”¨è®¡æ•°éœ€è¦ç‰¹åˆ«çš„æ³¨æ„ã€‚å¯¹äºç¼–ç å™¨å’Œè§£ç å™¨æ¥è¯´ï¼Œå…¶è¿‡ç¨‹ä¹Ÿæ˜¯ç›¸å½“çš„ç®€å•ï¼šä¸€æ—¦æ¶ˆæ¯è¢«ç¼–ç æˆ–è€…è§£ç ï¼Œå®ƒå°±ä¼šè¢« ReferenceCountUtil.release(message)è°ƒç”¨è‡ªåŠ¨é‡Šæ”¾ã€‚å¦‚æœä½ éœ€è¦ä¿ç•™å¼•ç”¨ä»¥ä¾¿ç¨åä½¿ç”¨ï¼Œé‚£ä¹ˆä½ å¯ä»¥è°ƒç”¨ ReferenceCountUtil.retain(message)æ–¹æ³•ã€‚è¿™å°†ä¼šå¢åŠ è¯¥å¼•ç”¨è®¡æ•°ï¼Œä»è€Œé˜²æ­¢è¯¥æ¶ˆæ¯è¢«é‡Šæ”¾ã€‚</p>
<h3 id="æŠ½è±¡ç±»-replayingdecoder">æŠ½è±¡ç±» ReplayingDecoder<a hidden class="anchor" aria-hidden="true" href="#æŠ½è±¡ç±»-replayingdecoder">#</a></h3>
<p>ReplayingDecoderæ‰©å±•äº†ByteToMessageDecoderç±»ï¼Œä½¿å¾—æˆ‘ä»¬ä¸å¿…è°ƒç”¨ readableBytes()æ–¹æ³•ã€‚å®ƒé€šè¿‡ä½¿ç”¨ä¸€ä¸ªè‡ªå®šä¹‰çš„ByteBufå®ç°ï¼ŒReplayingDecoderByteBufï¼ŒåŒ…è£…ä¼ å…¥çš„ByteBufå®ç°äº†è¿™ä¸€ç‚¹ï¼Œå…¶å°†åœ¨å†…éƒ¨è°ƒç”¨ readableBytes()æ–¹æ³•ã€‚è¿™ä¸ªç±»çš„å®Œæ•´å£°æ˜æ˜¯ï¼š
<code>public abstract class ReplayingDecoder&lt;S&gt; extends ByteToMessageDecoder</code>
ç±»å‹å‚æ•° S æŒ‡å®šäº†ç”¨äºçŠ¶æ€ç®¡ç†çš„ç±»å‹ï¼Œå…¶ä¸­ Void ä»£è¡¨ä¸éœ€è¦çŠ¶æ€ç®¡ç†ã€‚
ä»£ç æ¸…å• 10-2å±•ç¤ºäº†åŸºäº ReplayingDecoder é‡æ–°å®ç°çš„ ToIntegerDecoderã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 10-2 ToIntegerDecoder2 ç±»æ‰©å±•äº† ReplayingDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±• ReplayingDecoder&lt;Void&gt; ä»¥å°†å­—èŠ‚è§£ç ä¸ºæ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ToIntegerDecoder2 <span style="color:#fff;font-weight:bold">extends</span> ReplayingDecoder&lt;Void&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, <span style="color:#007f7f">//ä¼ å…¥çš„ ByteBuf æ˜¯ ReplayingDecoderByteBuf</span>
</span></span><span style="display:flex;"><span>        List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä»å…¥ç«™ ByteBuf ä¸­è¯»å– ä¸€ä¸ª intï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°è§£ç æ¶ˆæ¯çš„ List ä¸­</span>
</span></span><span style="display:flex;"><span>        out.<span style="color:#007f7f">add</span>(in.<span style="color:#007f7f">readInt</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å’Œä¹‹å‰ä¸€æ ·ï¼Œä»ByteBufä¸­æå–çš„intå°†ä¼šè¢«æ·»åŠ åˆ°Listä¸­ã€‚å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å­—èŠ‚å¯ç”¨ï¼Œè¿™ä¸ªreadInt()æ–¹æ³•çš„å®ç°å°†ä¼šæŠ›å‡ºä¸€ä¸ªError(è¿™é‡Œå®é™…ä¸ŠæŠ›å‡ºçš„æ˜¯ä¸€ä¸ª Signalï¼Œè¯¦è§ io.netty.util.Signal ç±»)ï¼Œå…¶å°†åœ¨åŸºç±»ä¸­è¢«æ•è·å¹¶å¤„ç†ã€‚å½“æœ‰æ›´å¤šçš„æ•°æ®å¯ä¾›è¯»å–æ—¶ï¼Œè¯¥decode()æ–¹æ³•å°†ä¼šè¢«å†æ¬¡è°ƒç”¨ã€‚
è¯·æ³¨æ„ ReplayingDecoderByteBuf çš„ä¸‹é¢è¿™äº›æ–¹é¢ï¼š</p>
<ul>
<li>å¹¶ä¸æ˜¯æ‰€æœ‰çš„ ByteBuf æ“ä½œéƒ½è¢«æ”¯æŒï¼Œå¦‚æœè°ƒç”¨äº†ä¸€ä¸ªä¸è¢«æ”¯æŒçš„æ–¹æ³•ï¼Œå°†ä¼šæŠ›å‡ºä¸€ä¸ª UnsupportedOperationExceptionï¼›</li>
<li>ReplayingDecoder ç¨æ…¢äº ByteToMessageDecoderã€‚
å¦‚æœå¯¹æ¯”ä»£ç æ¸…å• 10-1 å’Œä»£ç æ¸…å• 10-2ï¼Œä½ ä¼šå‘ç°åè€…æ˜æ˜¾æ›´ç®€å•ã€‚ç¤ºä¾‹æœ¬èº«æ˜¯å¾ˆåŸºæœ¬çš„ï¼Œæ‰€ä»¥è¯·è®°ä½ï¼Œåœ¨çœŸå®çš„ã€æ›´åŠ å¤æ‚çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ä¸€ç§æˆ–è€…å¦ä¸€ç§ä½œä¸ºåŸºç±»æ‰€å¸¦æ¥çš„å·®å¼‚å¯èƒ½æ˜¯å¾ˆæ˜¾è‘—çš„ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„å‡†åˆ™ï¼šå¦‚æœä½¿ç”¨ ByteToMessageDecoder ä¸ä¼šå¼•å…¥å¤ªå¤šçš„å¤æ‚æ€§ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨å®ƒï¼›å¦åˆ™ï¼Œè¯·ä½¿ç”¨ ReplayingDecoderã€‚æ›´å¤šçš„è§£ç å™¨ï¼š
io.netty.handler.codec.LineBasedFrameDecoder
è¿™ä¸ªç±»åœ¨ Netty å†…éƒ¨ä¹Ÿæœ‰ä½¿ç”¨ï¼Œå®ƒä½¿ç”¨äº†è¡Œå°¾æ§åˆ¶å­—ç¬¦ï¼ˆ\n æˆ–è€…\r\nï¼‰æ¥è§£ææ¶ˆæ¯æ•°æ®ï¼›</li>
</ul>
<p>io.netty.handler.codec.http.HttpObjectDecoder
ä¸€ä¸ª HTTP æ•°æ®çš„è§£ç å™¨ã€‚
åœ¨ io.netty.handler.codec å­åŒ…ä¸‹é¢ï¼Œä½ å°†ä¼šå‘ç°æ›´å¤šç”¨äºç‰¹å®šç”¨ä¾‹çš„ç¼–ç å™¨å’Œè§£ç å™¨å®ç°ã€‚</p>
<h3 id="æŠ½è±¡ç±»-messagetomessagedecoder">æŠ½è±¡ç±» MessageToMessageDecoder<a hidden class="anchor" aria-hidden="true" href="#æŠ½è±¡ç±»-messagetomessagedecoder">#</a></h3>
<p>åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è§£é‡Šå¦‚ä½•ä½¿ç”¨ä¸‹é¢çš„æŠ½è±¡åŸºç±»åœ¨ä¸¤ä¸ªæ¶ˆæ¯æ ¼å¼ä¹‹é—´è¿›è¡Œè½¬æ¢
ï¼ˆä¾‹å¦‚ï¼Œä»ä¸€ç§ POJO ç±»å‹è½¬æ¢ä¸ºå¦ä¸€ç§ï¼‰ï¼š
<code>public abstract class MessageToMessageDecoder&lt;I&gt; extends ChannelInboundHandlerAdapter</code>
ç±»å‹å‚æ•° I æŒ‡å®šäº† decode()æ–¹æ³•çš„è¾“å…¥å‚æ•° msg çš„ç±»å‹ï¼Œå®ƒæ˜¯ä½ å¿…é¡»å®ç°çš„å”¯ä¸€æ–¹æ³•ã€‚
MessageToMessageDecoderçš„APIï¼š
<code>decode(ChannelHandlerContext ctx,I msg,List&lt;Object&gt; out)</code>
å¯¹äºæ¯ä¸ªéœ€è¦è¢«è§£ç ä¸ºå¦ä¸€ç§æ ¼å¼çš„å…¥ç«™æ¶ˆæ¯æ¥è¯´ï¼Œè¯¥æ–¹æ³•éƒ½å°†ä¼šè¢«è°ƒç”¨ã€‚
è§£ç æ¶ˆæ¯éšåä¼šè¢«ä¼ é€’ç»™ ChannelPipelineä¸­çš„ä¸‹ä¸€ä¸ª ChannelInboundHandlerã€‚</p>
<p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ª IntegerToStringDecoder è§£ç å™¨æ¥æ‰©å±•
<code>MessageToMessageDecoder&lt;Integer&gt;</code>ã€‚å®ƒçš„ decode()æ–¹æ³•ä¼šæŠŠ Integer å‚æ•°è½¬æ¢ä¸ºå®ƒçš„ Stringè¡¨ç¤ºï¼Œå¹¶å°†æ‹¥æœ‰ä¸‹åˆ—ç­¾åï¼š
<code>public void decode( ChannelHandlerContext ctx,Integer msg, List&lt;Object&gt; out ) throws Exception</code></p>
<p>å’Œä¹‹å‰ä¸€æ ·ï¼Œè§£ç çš„Stringå°†è¢«æ·»åŠ åˆ°ä¼ å‡ºçš„Listä¸­ï¼Œå¹¶è½¬å‘ç»™ä¸‹ä¸€ä¸ªChannelInboundHandlerã€‚
è¯¥è®¾è®¡å¦‚å›¾ 10-2 æ‰€ç¤ºã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/58.png">
ä»£ç æ¸…å• 10-3 ç»™å‡ºäº† IntegerToStringDecoder çš„å®ç°ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 10-3 IntegerToStringDecoder ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±•äº†MessageToMessageDecoder&lt;Integer&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> IntegerToStringDecoder <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageDecoder&lt;Integer&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, Integer msg, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°† Integer æ¶ˆæ¯è½¬æ¢ä¸ºå®ƒçš„ String è¡¨ç¤ºï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°è¾“å‡ºçš„ List ä¸­</span>
</span></span><span style="display:flex;"><span>        out.<span style="color:#007f7f">add</span>(String.<span style="color:#007f7f">valueOf</span>(msg));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>HttpObjectAggregatorï¼š
æœ‰å…³æ›´åŠ å¤æ‚çš„ä¾‹å­ï¼Œè¯·ç ”ç©¶ io.netty.handler.codec.http.HttpObjectAggregator ç±»ï¼Œ
å®ƒæ‰©å±•äº†<code>MessageToMessageDecoder&lt;HttpObject&gt;</code>ã€‚</p>
<h3 id="toolongframeexception-ç±»">TooLongFrameException ç±»<a hidden class="anchor" aria-hidden="true" href="#toolongframeexception-ç±»">#</a></h3>
<p>ç”±äº Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥æ¡†æ¶ï¼Œæ‰€ä»¥éœ€è¦åœ¨å­—èŠ‚å¯ä»¥è§£ç ä¹‹å‰åœ¨å†…å­˜ä¸­ç¼“å†²å®ƒä»¬ã€‚å› æ­¤ï¼Œä¸èƒ½è®©è§£ç å™¨ç¼“å†²å¤§é‡çš„æ•°æ®ä»¥è‡³äºè€—å°½å¯ç”¨çš„å†…å­˜ã€‚ä¸ºäº†è§£é™¤è¿™ä¸ªå¸¸è§çš„é¡¾è™‘ï¼ŒNetty æä¾›äº†TooLongFrameException ç±»ï¼Œå…¶å°†ç”±è§£ç å™¨åœ¨å¸§è¶…å‡ºæŒ‡å®šçš„å¤§å°é™åˆ¶æ—¶æŠ›å‡ºã€‚
ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œä½ å¯ä»¥è®¾ç½®ä¸€ä¸ªæœ€å¤§å­—èŠ‚æ•°çš„é˜ˆå€¼ï¼Œå¦‚æœè¶…å‡ºè¯¥é˜ˆå€¼ï¼Œåˆ™ä¼šå¯¼è‡´æŠ›å‡ºä¸€ä¸ª
TooLongFrameExceptionï¼ˆéšåä¼šè¢« ChannelHandler.exceptionCaught()æ–¹æ³•æ•è·ï¼‰ã€‚ç„¶åï¼Œå¦‚ä½•å¤„ç†è¯¥å¼‚å¸¸åˆ™å®Œå…¨å–å†³äºè¯¥è§£ç å™¨çš„ç”¨æˆ·ã€‚æŸäº›åè®®ï¼ˆå¦‚ HTTPï¼‰å¯èƒ½å…è®¸ä½ è¿”å›ä¸€ä¸ªç‰¹æ®Šçš„å“åº”ã€‚è€Œåœ¨å…¶ä»–çš„æƒ…å†µä¸‹ï¼Œå”¯ä¸€çš„é€‰æ‹©å¯èƒ½å°±æ˜¯å…³é—­å¯¹åº”çš„è¿æ¥ã€‚ä»£ç æ¸…å• 10-4 å±•ç¤ºäº† ByteToMessageDecoder æ˜¯å¦‚ä½•ä½¿ç”¨TooLongFrameExceptionæ¥é€šçŸ¥ ChannelPipeline ä¸­çš„å…¶ä»– ChannelHandler å‘ç”Ÿäº†å¸§å¤§å°æº¢å‡ºçš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½ æ­£åœ¨ä½¿ç”¨ä¸€ä¸ªå¯å˜å¸§å¤§å°çš„åè®®ï¼Œé‚£ä¹ˆè¿™ç§ä¿æŠ¤æªæ–½å°†æ˜¯å°¤ä¸ºé‡è¦çš„ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 10-4 TooLongFrameException
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±• ByteToMessageDecoder ä»¥å°†å­—èŠ‚è§£ç ä¸ºæ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SafeByteToMessageDecoder <span style="color:#fff;font-weight:bold">extends</span> ByteToMessageDecoder {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> MAX_FRAME_SIZE = 1024;
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> readable = in.<span style="color:#007f7f">readableBytes</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ£€æŸ¥ç¼“å†²åŒºä¸­æ˜¯å¦æœ‰è¶…è¿‡ MAX_FRAME_SIZE ä¸ªå­—èŠ‚</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (readable &gt; MAX_FRAME_SIZE) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//è·³è¿‡æ‰€æœ‰çš„å¯è¯»å­—èŠ‚ï¼ŒæŠ›å‡º TooLongFrameException å¹¶é€šçŸ¥ ChannelHandler</span>
</span></span><span style="display:flex;"><span>                in.<span style="color:#007f7f">skipBytes</span>(readable);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> TooLongFrameException(<span style="color:#0ff;font-weight:bold">&#34;Frame too big!&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// do something</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ...</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æ¢è®¨äº†è§£ç å™¨çš„å¸¸è§„ç”¨ä¾‹ï¼Œä»¥åŠ Netty æ‰€æä¾›çš„ç”¨äºæ„å»ºå®ƒä»¬çš„æŠ½è±¡åŸºç±»ã€‚ä½†æ˜¯è§£ç å™¨åªæ˜¯ç¡¬å¸çš„ä¸€é¢ã€‚ç¡¬å¸çš„å¦ä¸€é¢æ˜¯ç¼–ç å™¨ï¼Œå®ƒå°†æ¶ˆæ¯è½¬æ¢ä¸ºé€‚åˆäºä¼ å‡ºä¼ è¾“çš„æ ¼å¼ã€‚è¿™äº›ç¼–ç å™¨å®Œå¤‡äº†ç¼–è§£ç å™¨ APIï¼Œå®ƒä»¬å°†æ˜¯æˆ‘ä»¬çš„ä¸‹ä¸€ä¸ªä¸»é¢˜ã€‚</p>
<h2 id="ç¼–ç å™¨">ç¼–ç å™¨<a hidden class="anchor" aria-hidden="true" href="#ç¼–ç å™¨">#</a></h2>
<p>å›é¡¾ä¸€ä¸‹æˆ‘ä»¬å…ˆå‰çš„å®šä¹‰ï¼Œç¼–ç å™¨å®ç°äº† ChannelOutboundHandlerï¼Œå¹¶å°†å‡ºç«™æ•°æ®ä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼ï¼Œå’Œæˆ‘ä»¬æ–¹æ‰å­¦ä¹ çš„è§£ç å™¨çš„åŠŸèƒ½æ­£å¥½ç›¸åã€‚
Netty æä¾›äº†ä¸€ç»„ç±»ï¼Œç”¨äºå¸®åŠ©ä½ ç¼–å†™å…·æœ‰ä»¥ä¸‹åŠŸèƒ½çš„ç¼–ç å™¨ï¼š</p>
<ul>
<li>å°†æ¶ˆæ¯ç¼–ç ä¸ºå­—èŠ‚ï¼›</li>
<li>å°†æ¶ˆæ¯ç¼–ç ä¸ºæ¶ˆæ¯(å¦å¤–ä¸€ç§æ ¼å¼çš„æ¶ˆæ¯)</li>
</ul>
<h3 id="æŠ½è±¡ç±»-messagetobyteencoder">æŠ½è±¡ç±» MessageToByteEncoder<a hidden class="anchor" aria-hidden="true" href="#æŠ½è±¡ç±»-messagetobyteencoder">#</a></h3>
<p>encode(ChannelHandlerContext ctx,I msg,ByteBuf out)ï¼š
encode()æ–¹æ³•æ˜¯ä½ éœ€è¦å®ç°çš„å”¯ä¸€æŠ½è±¡æ–¹æ³•ã€‚å®ƒè¢«è°ƒç”¨æ—¶å°†ä¼šä¼ å…¥è¦è¢«è¯¥ç±»ç¼–ç ä¸º ByteBuf çš„ï¼ˆç±»å‹ä¸º I çš„ï¼‰å‡ºç«™æ¶ˆæ¯ã€‚è¯¥ ByteBuf éšåå°†ä¼šè¢«è½¬å‘ç»™ ChannelPipelineä¸­çš„ä¸‹ä¸€ä¸ª ChannelOutboundHandlerã€‚
ç¼–ç å™¨è¿™ä¸ªç±»åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œè§£ç å™¨æœ‰ä¸¤ä¸ªã€‚åŸå› æ˜¯æ˜¯è§£ç å™¨é€šå¸¸éœ€è¦åœ¨Channel å…³é—­ä¹‹åäº§ç”Ÿæœ€åä¸€ä¸ªæ¶ˆæ¯ï¼ˆå› æ­¤ä¹Ÿå°±æœ‰äº† decodeLast()æ–¹æ³•ï¼‰ï¼Œè¿™æ˜¾ç„¶ä¸é€‚ç”¨äºç¼–ç å™¨çš„åœºæ™¯ï¼Œåœ¨è¿æ¥è¢«å…³é—­ä¹‹åä»ç„¶äº§ç”Ÿä¸€ä¸ªæ¶ˆæ¯æ˜¯æ¯«æ— æ„ä¹‰çš„ã€‚
å›¾ 10-3 å±•ç¤ºäº† ShortToByteEncoderï¼Œå…¶æ¥å—ä¸€ä¸ª Short ç±»å‹çš„å®ä¾‹ä½œä¸ºæ¶ˆæ¯ï¼Œå°†å®ƒç¼–ç ä¸º Short çš„åŸå­ç±»å‹å€¼ï¼Œå¹¶å°†å®ƒå†™å…¥ ByteBuf ä¸­ï¼Œå…¶å°†éšåè¢«è½¬å‘ç»™ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ªChannelOutboundHandlerã€‚æ¯ä¸ªä¼ å‡ºçš„ Short å€¼éƒ½å°†ä¼šå ç”¨ ByteBuf ä¸­çš„ 2 å­—èŠ‚ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/59.png">
ShortToByteEncoder çš„å®ç°å¦‚ä»£ç æ¸…å• 10-5 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 10-5 ShortToByteEncoder ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±•äº†MessageToByteEncoder</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ShortToByteEncoder <span style="color:#fff;font-weight:bold">extends</span> MessageToByteEncoder&lt;Short&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext ctx, Short msg, ByteBuf out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°† Short å†™å…¥ ByteBuf ä¸­</span>
</span></span><span style="display:flex;"><span>        out.<span style="color:#007f7f">writeShort</span>(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty æä¾›äº†ä¸€äº›ä¸“é—¨åŒ–çš„ MessageToByteEncoderï¼Œä½ å¯ä»¥åŸºäºå®ƒä»¬å®ç°è‡ªå·±çš„ç¼–ç å™¨ã€‚
WebSocket08FrameEncoder ç±»æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„å®ä¾‹ã€‚
ä½ å¯ä»¥åœ¨ io.netty.handler.codec.http.websocketx åŒ…ä¸­æ‰¾åˆ°å®ƒã€‚</p>
<h3 id="æŠ½è±¡ç±»-messagetomessageencoder">æŠ½è±¡ç±» MessageToMessageEncoder<a hidden class="anchor" aria-hidden="true" href="#æŠ½è±¡ç±»-messagetomessageencoder">#</a></h3>
<p>MessageToMessageEncoder ç±»çš„ encode()æ–¹æ³•ï¼Œå¯ä»¥å°†å‡ºæˆ˜æ•°æ®ä»ä¸€ç§æ¶ˆæ¯ç¼–ç ä¸ºå¦ä¸€ç§æ¶ˆæ¯ã€‚
<code>encode(ChannelHandlerContext ctx,I msg,List&lt;Object&gt; out)</code>è¿™æ˜¯ä½ éœ€è¦å®ç°çš„å”¯ä¸€æ–¹æ³•ã€‚
æ¯ä¸ªé€šè¿‡ write()æ–¹æ³•å†™å…¥çš„æ¶ˆæ¯éƒ½å°†ä¼šè¢«ä¼ é€’ç»™ encode()æ–¹æ³•ï¼Œä»¥ç¼–ç ä¸ºä¸€ä¸ªæˆ–è€…å¤šä¸ªå‡ºç«™æ¶ˆæ¯ã€‚
éšåï¼Œè¿™äº›å‡ºç«™æ¶ˆæ¯å°†ä¼šè¢«è½¬å‘ç»™ ChannelPipelineä¸­çš„ä¸‹ä¸€ä¸ª ChannelOutboundHandlerã€‚
ä¸ºäº†æ¼”ç¤ºï¼Œä»£ç æ¸…å• 10-6 ä½¿ç”¨ IntegerToStringEncoder æ‰©å±•äº† MessageToMessageEncoderã€‚
å…¶è®¾è®¡å¦‚å›¾ 10-4 æ‰€ç¤ºã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/60.png">
å¦‚ä»£ç æ¸…å• 10-6 æ‰€ç¤ºï¼Œç¼–ç å™¨å°†æ¯ä¸ªå‡ºç«™ Integer çš„ String è¡¨ç¤ºæ·»åŠ åˆ°äº†è¯¥ List ä¸­ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 10-6 IntegerToStringEncoder ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±•äº† MessageToMessageEncoder</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> IntegerToStringEncoder <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageEncoder&lt;Integer&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext ctx, Integer msg, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°† Integer è½¬æ¢ä¸º Stringï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° List ä¸­</span>
</span></span><span style="display:flex;"><span>        out.<span style="color:#007f7f">add</span>(String.<span style="color:#007f7f">valueOf</span>(msg));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æŠ½è±¡çš„ç¼–è§£ç å™¨ç±»">æŠ½è±¡çš„ç¼–è§£ç å™¨ç±»<a hidden class="anchor" aria-hidden="true" href="#æŠ½è±¡çš„ç¼–è§£ç å™¨ç±»">#</a></h2>
<p>è™½ç„¶æˆ‘ä»¬ä¸€ç›´å°†è§£ç å™¨å’Œç¼–ç å™¨ä½œä¸ºå•ç‹¬çš„å®ä½“è®¨è®ºï¼Œä½†æ˜¯ä½ æœ‰æ—¶å°†ä¼šå‘ç°åœ¨åŒä¸€ä¸ªç±»ä¸­ç®¡ç†å…¥ç«™å’Œå‡ºç«™æ•°æ®å’Œæ¶ˆæ¯çš„è½¬æ¢æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚Netty çš„æŠ½è±¡ç¼–è§£ç å™¨ç±»æ­£å¥½ç”¨äºè¿™ä¸ªç›®çš„ï¼Œå› ä¸ºå®ƒä»¬æ¯ä¸ªéƒ½å°†æ†ç»‘ä¸€ä¸ªè§£ç å™¨/ç¼–ç å™¨å¯¹ï¼Œä»¥å¤„ç†æˆ‘ä»¬ä¸€ç›´åœ¨å­¦ä¹ çš„è¿™ä¸¤ç§ç±»å‹çš„æ“ä½œã€‚æ­£å¦‚åŒä½ å¯èƒ½å·²ç»çŒœæƒ³åˆ°çš„ï¼Œè¿™äº›ç±»åŒæ—¶å®ç°äº†ChannelInboundHandler å’Œ ChannelOutboundHandler æ¥å£ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬å¹¶æ²¡æœ‰ä¸€ç›´ä¼˜å…ˆäºå•ç‹¬çš„è§£ç å™¨å’Œç¼–ç å™¨ä½¿ç”¨è¿™äº›å¤åˆç±»å‘¢ï¼Ÿå› ä¸ºé€šè¿‡å°½å¯èƒ½åœ°å°†è¿™ä¸¤ç§åŠŸèƒ½åˆ†å¼€ï¼Œæœ€å¤§åŒ–äº†ä»£ç çš„å¯é‡ç”¨æ€§å’Œå¯æ‰©å±•æ€§ï¼Œè¿™æ˜¯ Netty è®¾è®¡çš„ä¸€ä¸ªåŸºæœ¬åŸåˆ™ã€‚åœ¨æˆ‘ä»¬æŸ¥çœ‹è¿™äº›æŠ½è±¡çš„ç¼–è§£ç å™¨ç±»æ—¶ï¼Œæˆ‘ä»¬å°†ä¼šæŠŠå®ƒä»¬ä¸ç›¸åº”çš„å•ç‹¬çš„è§£ç å™¨å’Œç¼–ç å™¨è¿›è¡Œæ¯”è¾ƒå’Œå‚ç…§ã€‚</p>
<h3 id="æŠ½è±¡ç±»-bytetomessagecodec">æŠ½è±¡ç±» ByteToMessageCodec<a hidden class="anchor" aria-hidden="true" href="#æŠ½è±¡ç±»-bytetomessagecodec">#</a></h3>
<p>è®©æˆ‘ä»¬æ¥ç ”ç©¶è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯ï¼šæˆ‘ä»¬éœ€è¦å°†å­—èŠ‚è§£ç ä¸ºæŸç§å½¢å¼çš„æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯ POJOï¼Œéšåå†æ¬¡å¯¹å®ƒè¿›è¡Œç¼–ç ã€‚ByteToMessageCodec å°†ä¸ºæˆ‘ä»¬å¤„ç†å¥½è¿™ä¸€åˆ‡ï¼Œå› ä¸ºå®ƒç»“åˆäº†ByteToMessageDecoder ä»¥åŠå®ƒçš„é€†å‘â€”â€”MessageToByteEncoderã€‚è¡¨ 10-5 åˆ—å‡ºäº†å…¶ä¸­é‡è¦çš„æ–¹æ³•ã€‚</p>
<table>
<thead>
<tr>
<th>æ–¹ æ³• å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>decode( ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt;)</code></td>
<td>åªè¦æœ‰å­—èŠ‚å¯ä»¥è¢«æ¶ˆè´¹ï¼Œè¿™ä¸ªæ–¹æ³•å°±å°†ä¼šè¢«è°ƒç”¨ã€‚å®ƒå°†å…¥ç«™ ByteBuf è½¬æ¢ä¸ºæŒ‡å®šçš„æ¶ˆæ¯æ ¼å¼ï¼Œå¹¶å°†å…¶è½¬å‘ç»™ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelInboundHandler</td>
</tr>
<tr>
<td><code>decodeLast( ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code></td>
<td>è¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°å§”æ‰˜ç»™äº† decode()æ–¹æ³•ã€‚å®ƒåªä¼šåœ¨ Channel çš„çŠ¶æ€å˜ä¸ºéæ´»åŠ¨æ—¶è¢«è°ƒç”¨ä¸€æ¬¡ã€‚å®ƒå¯ä»¥è¢«é‡å†™ä»¥ å®ç°ç‰¹æ®Šçš„å¤„ç†</td>
</tr>
<tr>
<td>encode( ChannelHandlerContext ctx, I msg, ByteBuf out)</td>
<td>å¯¹äºæ¯ä¸ªå°†è¢«ç¼–ç å¹¶å†™å…¥å‡ºç«™ ByteBuf çš„ï¼ˆç±»å‹ä¸º I çš„ï¼‰ æ¶ˆæ¯æ¥è¯´ï¼Œè¿™ä¸ªæ–¹æ³•éƒ½å°†ä¼šè¢«è°ƒç”¨</td>
</tr>
</tbody>
</table>
<p>ä»»ä½•çš„è¯·æ±‚/å“åº”åè®®éƒ½å¯ä»¥ä½œä¸ºä½¿ç”¨ByteToMessageCodecçš„ç†æƒ³é€‰æ‹©ã€‚ä¾‹å¦‚ï¼Œåœ¨æŸä¸ªSMTPçš„å®ç°ä¸­ï¼Œç¼–è§£ç å™¨å°†è¯»å–ä¼ å…¥å­—èŠ‚ï¼Œå¹¶å°†å®ƒä»¬è§£ç ä¸ºä¸€ä¸ªè‡ªå®šä¹‰çš„æ¶ˆæ¯ç±»å‹ï¼Œå¦‚SmtpRequestã€‚è€Œåœ¨æ¥æ”¶ç«¯ï¼Œå½“ä¸€ä¸ªå“åº”è¢«åˆ›å»ºæ—¶ï¼Œå°†ä¼šäº§ç”Ÿä¸€ä¸ªSmtpResponseï¼Œå…¶å°†è¢«ç¼–ç å›å­—èŠ‚ä»¥ä¾¿è¿›è¡Œä¼ è¾“ã€‚</p>
<h3 id="æŠ½è±¡ç±»-messagetomessagecodec">æŠ½è±¡ç±» MessageToMessageCodec<a hidden class="anchor" aria-hidden="true" href="#æŠ½è±¡ç±»-messagetomessagecodec">#</a></h3>
<p>åœ¨ 10.3.1 èŠ‚ä¸­ï¼Œä½ çœ‹åˆ°äº†ä¸€ä¸ªæ‰©å±•äº† MessageToMessageEncoder ä»¥å°†ä¸€ç§æ¶ˆæ¯æ ¼å¼è½¬æ¢ä¸ºå¦å¤–ä¸€ç§æ¶ˆæ¯æ ¼å¼çš„ä¾‹å­ã€‚é€šè¿‡ä½¿ç”¨ MessageToMessageCodecï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªå•ä¸ªçš„ç±»ä¸­å®ç°è¯¥è½¬æ¢çš„å¾€è¿”è¿‡ç¨‹ã€‚MessageToMessageCodec æ˜¯ä¸€ä¸ªå‚æ•°åŒ–çš„ç±»ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š
<code>public abstract class MessageToMessageCodec&lt;INBOUND_IN,OUTBOUND_IN&gt;</code></p>
<table>
<thead>
<tr>
<th>æ–¹ æ³• å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>protected abstract decode( ChannelHandlerContext ctx, INBOUND_IN msg, List&lt;Object&gt; out)</code></td>
<td>è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ä¼šè¢«ä¼ å…¥ INBOUND_IN ç±»å‹çš„æ¶ˆæ¯ã€‚ å®ƒå°†æŠŠå®ƒä»¬è§£ç ä¸º OUTBOUND_IN ç±»å‹çš„æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆæ¯ å°†è¢«è½¬å‘ç»™ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelInboundHandler</td>
</tr>
<tr>
<td><code>protected abstract encode( ChannelHandlerContext ctx, OUTBOUND_IN msg, List&lt;Object&gt; out)</code></td>
<td>å¯¹äºæ¯ä¸ª OUTBOUND_IN ç±»å‹çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ–¹æ³•éƒ½å°†ä¼š è¢«è°ƒç”¨ã€‚è¿™äº›æ¶ˆæ¯å°†ä¼šè¢«ç¼–ç ä¸º INBOUND_IN ç±»å‹çš„æ¶ˆ æ¯ï¼Œç„¶åè¢«è½¬å‘ç»™ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelOutboundHandler</td>
</tr>
</tbody>
</table>
<p>decode()æ–¹æ³•æ˜¯å°†INBOUND_INç±»å‹çš„æ¶ˆæ¯è½¬æ¢ä¸ºOUTBOUND_INç±»å‹çš„æ¶ˆæ¯ï¼Œè€Œencode()æ–¹æ³•åˆ™è¿›è¡Œå®ƒçš„é€†å‘æ“ä½œã€‚å°†INBOUND_INç±»å‹çš„æ¶ˆæ¯çœ‹ä½œæ˜¯é€šè¿‡ç½‘ç»œå‘é€çš„ç±»å‹ï¼Œè€Œå°†OUTBOUND_INç±»å‹çš„æ¶ˆæ¯çœ‹ä½œæ˜¯åº”ç”¨ç¨‹åºæ‰€å¤„ç†çš„ç±»å‹ï¼Œå°†å¯èƒ½æœ‰æ‰€è£¨ç›Šã€‚
è™½ç„¶è¿™ä¸ªç¼–è§£ç å™¨å¯èƒ½çœ‹èµ·æ¥æœ‰ç‚¹é«˜æ·±ï¼Œä½†æ˜¯å®ƒæ‰€å¤„ç†çš„ç”¨ä¾‹å´æ˜¯ç›¸å½“å¸¸è§çš„ï¼šåœ¨ä¸¤ç§ä¸åŒçš„æ¶ˆæ¯ API ä¹‹é—´æ¥å›è½¬æ¢æ•°æ®ã€‚å½“æˆ‘ä»¬ä¸å¾—ä¸å’Œä½¿ç”¨é—ç•™æˆ–è€…ä¸“æœ‰æ¶ˆæ¯æ ¼å¼çš„ API è¿›è¡Œäº’æ“ä½œæ—¶ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™ç§æ¨¡å¼ã€‚WebSocket åè®®ï¼š
ä¸‹é¢å…³äº MessageToMessageCodec çš„ç¤ºä¾‹å¼•ç”¨äº†ä¸€ä¸ªæ–°å‡ºçš„ WebSocket åè®®ï¼Œè¿™ä¸ªåè®®èƒ½å®ç° Web æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„å…¨åŒå‘é€šä¿¡ã€‚æˆ‘ä»¬å°†åœ¨ç¬¬ 12 ç« ä¸­è¯¦ç»†åœ°è®¨è®º Netty å¯¹äº WebSocket çš„æ”¯æŒã€‚</p>
<p>ä»£ç æ¸…å• 10-7 å±•ç¤ºäº†Web æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„åŒå‘é€šä¿¡å¯èƒ½çš„å®ç°æ–¹å¼ã€‚
æˆ‘ä»¬çš„WebSocketConvertHandleråœ¨å‚æ•°åŒ–MessageToMessageCodecæ—¶å°†ä½¿ç”¨INBOUND_INç±»å‹çš„WebSocketFrameï¼Œä»¥åŠOUTBOUND_INç±»å‹çš„MyWebSocketFrameï¼Œåè€…æ˜¯WebSocketConvertHandler
æœ¬èº«çš„ä¸€ä¸ªé™æ€åµŒå¥—ç±»ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 10-7 ä½¿ç”¨ MessageToMessageCodec
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@Sharable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WebSocketConvertHandler <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageCodec&lt;WebSocketFrame, WebSocketConvertHandler.<span style="color:#007f7f">MyWebSocketFrame</span>&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     @Override
</span></span><span style="display:flex;"><span>     <span style="color:#007f7f">//å°† MyWebSocketFrame ç¼–ç ä¸ºæŒ‡å®šçš„ WebSocketFrame å­ç±»å‹</span>
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext ctx, WebSocketConvertHandler.<span style="color:#007f7f">MyWebSocketFrame</span> msg, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>         ByteBuf payload = msg.<span style="color:#007f7f">getData</span>().<span style="color:#007f7f">duplicate</span>().<span style="color:#007f7f">retain</span>();
</span></span><span style="display:flex;"><span>         <span style="color:#007f7f">//å®ä¾‹åŒ–ä¸€ä¸ªæŒ‡å®šå­ç±»å‹çš„ WebSocketFrame</span>
</span></span><span style="display:flex;"><span>         <span style="color:#fff;font-weight:bold">switch</span> (msg.<span style="color:#007f7f">getType</span>()) {
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> BINARY:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> BinaryWebSocketFrame(payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> TEXT:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> TextWebSocketFrame(payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> CLOSE:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> CloseWebSocketFrame(<span style="color:#fff;font-weight:bold">true</span>, 0, payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> CONTINUATION:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> ContinuationWebSocketFrame(payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> PONG:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> PongWebSocketFrame(payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> PING:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> PingWebSocketFrame(payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalStateException(<span style="color:#0ff;font-weight:bold">&#34;Unsupported websocket msg &#34;</span> + msg);}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å°† WebSocketFrame è§£ç ä¸º MyWebSocketFrameï¼Œå¹¶è®¾ç½® FrameType</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, WebSocketFrame msg, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ByteBuf payload = msg.<span style="color:#007f7f">content</span>().<span style="color:#007f7f">duplicate</span>().<span style="color:#007f7f">retain</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> BinaryWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame(MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">BINARY</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> CloseWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame (MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">CLOSE</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> PingWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame (MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">PING</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> PongWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame (MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">PONG</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> TextWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame (MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">TEXT</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> ContinuationWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame (MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">CONTINUATION</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalStateException(<span style="color:#0ff;font-weight:bold">&#34;Unsupported websocket msg &#34;</span> + msg);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å£°æ˜ WebSocketConvertHandler æ‰€ä½¿ç”¨çš„ OUTBOUND_IN ç±»å‹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> MyWebSocketFrame {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å®šä¹‰æ‹¥æœ‰è¢«åŒ…è£…çš„æœ‰æ•ˆè´Ÿè½½çš„ WebSocketFrame çš„ç±»å‹</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">enum</span> FrameType {
</span></span><span style="display:flex;"><span>            BINARY,
</span></span><span style="display:flex;"><span>            CLOSE,
</span></span><span style="display:flex;"><span>            PING,
</span></span><span style="display:flex;"><span>            PONG,
</span></span><span style="display:flex;"><span>            TEXT,
</span></span><span style="display:flex;"><span>            CONTINUATION
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> FrameType type;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ByteBuf data;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> MyWebSocketFrame(FrameType type, ByteBuf data) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">type</span> = type;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">data</span> = data;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> FrameType getType() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> type;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> ByteBuf getData() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> data;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="combinedchannelduplexhandler-ç±»">CombinedChannelDuplexHandler ç±»<a hidden class="anchor" aria-hidden="true" href="#combinedchannelduplexhandler-ç±»">#</a></h3>
<p>æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€æåˆ°çš„ï¼Œç»“åˆä¸€ä¸ªè§£ç å™¨å’Œç¼–ç å™¨å¯èƒ½ä¼šå¯¹å¯é‡ç”¨æ€§é€ æˆå½±å“ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ç§æ–¹æ³•æ—¢èƒ½å¤Ÿé¿å…è¿™ç§æƒ©ç½šï¼Œåˆä¸ä¼šç‰ºç‰²å°†ä¸€ä¸ªè§£ç å™¨å’Œä¸€ä¸ªç¼–ç å™¨ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å•å…ƒéƒ¨ç½²æ‰€å¸¦æ¥çš„ä¾¿åˆ©æ€§ã€‚
CombinedChannelDuplexHandler æä¾›äº†è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Œå…¶å£°æ˜ä¸ºï¼š
public class CombinedChannelDuplexHandler
&lt;I extends ChannelInboundHandler,
O extends ChannelOutboundHandler&gt;</p>
<p>è¿™ä¸ªç±»å……å½“äº† ChannelInboundHandler å’Œ ChannelOutboundHandlerï¼ˆè¯¥ç±»çš„ç±»å‹å‚æ•° I å’Œ Oï¼‰çš„å®¹å™¨ã€‚é€šè¿‡æä¾›åˆ†åˆ«ç»§æ‰¿äº†è§£ç å™¨ç±»å’Œç¼–ç å™¨ç±»çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªç¼–è§£ç å™¨ï¼Œè€Œåˆä¸å¿…ç›´æ¥æ‰©å±•æŠ½è±¡çš„ç¼–è§£ç å™¨ç±»ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­è¯´æ˜è¿™ä¸€ç‚¹ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç ”ç©¶ä»£ç æ¸…å• 10-8 ä¸­çš„ ByteToCharDecoderã€‚æ³¨æ„ï¼Œè¯¥å®ç°æ‰©å±•äº† ByteToMessageDecoderï¼Œå› ä¸ºå®ƒè¦ä» ByteBuf ä¸­è¯»å–å­—ç¬¦ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 10-8 ByteToCharDecoder ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±•äº†ByteToMessageDecoder</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ByteToCharDecoder <span style="color:#fff;font-weight:bold">extends</span> ByteToMessageDecoder {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (in.<span style="color:#007f7f">readableBytes</span>() &gt;= 2) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å°†ä¸€ä¸ªæˆ–è€…å¤šä¸ª Character å¯¹è±¡æ·»åŠ åˆ°ä¼ å‡ºçš„ List ä¸­</span>
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(in.<span style="color:#007f7f">readChar</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œçš„ decode()æ–¹æ³•ä¸€æ¬¡å°†ä» ByteBuf ä¸­æå– 2 å­—èŠ‚ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸º char å†™å…¥åˆ° Listä¸­ï¼Œå…¶å°†ä¼šè¢«è‡ªåŠ¨è£…ç®±ä¸º Character å¯¹è±¡ã€‚ä»£ç æ¸…å• 10-9 åŒ…å«äº† CharToByteEncoderï¼Œå®ƒèƒ½å°† Character è½¬æ¢å›å­—èŠ‚ã€‚è¿™ä¸ªç±»æ‰©å±•äº† MessageToByteEncoderï¼Œå› ä¸ºå®ƒéœ€è¦å°† char æ¶ˆæ¯ç¼–ç åˆ° ByteBuf ä¸­ã€‚è¿™æ˜¯é€šè¿‡ç›´æ¥å†™å…¥ ByteBuf åšåˆ°çš„ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 9 CharToByteEncoder ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±•äº†MessageToByteEncoder</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CharToByteEncoder <span style="color:#fff;font-weight:bold">extends</span>
</span></span><span style="display:flex;"><span>    MessageToByteEncoder&lt;Character&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext ctx, Character msg, ByteBuf out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°† Character è§£ç ä¸º charï¼Œå¹¶å°†å…¶å†™å…¥åˆ°å‡ºç«™ ByteBuf ä¸­</span>
</span></span><span style="display:flex;"><span>        out.<span style="color:#007f7f">writeChar</span>(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ—¢ç„¶æˆ‘ä»¬æœ‰äº†è§£ç å™¨å’Œç¼–ç å™¨ï¼Œæˆ‘ä»¬å°†ä¼šç»“åˆå®ƒä»¬æ¥æ„å»ºä¸€ä¸ªç¼–è§£ç å™¨ã€‚
ä»£ç æ¸…å• 10-10 å±•ç¤ºäº†è¿™æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• CombinedChannelDuplexHandler&lt;I,O&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//é€šè¿‡è¯¥è§£ç å™¨å’Œç¼–ç å™¨å®ç°å‚æ•°åŒ– CombinedByteCharCodec</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CombinedByteCharCodec <span style="color:#fff;font-weight:bold">extends</span>
</span></span><span style="display:flex;"><span>    CombinedChannelDuplexHandler&lt;ByteToCharDecoder, CharToByteEncoder&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> CombinedByteCharCodec() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†å§”æ‰˜å®ä¾‹ä¼ é€’ç»™çˆ¶ç±»</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(<span style="color:#fff;font-weight:bold">new</span> ByteToCharDecoder(), <span style="color:#fff;font-weight:bold">new</span> CharToByteEncoder());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­£å¦‚ä½ æ‰€èƒ½çœ‹åˆ°çš„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ç»“åˆå®ç°ç›¸å¯¹äºä½¿ç”¨ç¼–è§£ç å™¨ç±»çš„æ–¹å¼æ¥è¯´å¯èƒ½æ›´åŠ çš„ç®€å•ä¹Ÿæ›´åŠ çš„çµæ´»ã€‚å½“ç„¶ï¼Œè¿™å¯èƒ½ä¹Ÿå½’ç»“äºä¸ªäººçš„åå¥½é—®é¢˜ã€‚</p>
<h2 id="å°ç»“-3">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“-3">#</a></h2>
<p>åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ Netty çš„ç¼–è§£ç å™¨ API æ¥ç¼–å†™è§£ç å™¨å’Œç¼–ç å™¨ã€‚ä½ ä¹Ÿäº†è§£äº†ä¸ºä»€ä¹ˆä½¿ç”¨è¿™ä¸ªAPI ç›¸å¯¹äºç›´æ¥ä½¿ç”¨ ChannelHandler API æ›´å¥½ã€‚ä½ çœ‹åˆ°äº†æŠ½è±¡çš„ç¼–è§£ç å™¨ç±»æ˜¯å¦‚ä½•ä¸ºåœ¨ä¸€ä¸ªå®ç°ä¸­å¤„ç†è§£ç å’Œç¼–ç æä¾›æ”¯æŒçš„ã€‚å¦‚æœä½ éœ€è¦æ›´å¤§çš„çµæ´»æ€§ï¼Œæˆ–è€…å¸Œæœ›é‡ç”¨ç°æœ‰çš„å®ç°ï¼Œé‚£ä¹ˆä½ è¿˜å¯ä»¥é€‰æ‹©ç»“åˆä»–ä»¬ï¼Œè€Œæ— éœ€æ‰©å±•ä»»ä½•æŠ½è±¡çš„ç¼–è§£ç å™¨ç±»ã€‚åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºä½œä¸º Netty æ¡†æ¶æœ¬èº«çš„ä¸€éƒ¨åˆ†çš„ChannelHandler å®ç°å’Œç¼–è§£ç å™¨ï¼Œä½ å¯ä»¥åˆ©ç”¨å®ƒä»¬æ¥å¤„ç†ç‰¹å®šçš„åè®®å’Œä»»åŠ¡ã€‚</p>
<h1 id="é¢„ç½®çš„channelhandlerå’Œç¼–è§£ç å™¨">é¢„ç½®çš„ChannelHandlerå’Œç¼–è§£ç å™¨<a hidden class="anchor" aria-hidden="true" href="#é¢„ç½®çš„channelhandlerå’Œç¼–è§£ç å™¨">#</a></h1>
<p>Netty ä¸ºè®¸å¤šé€šç”¨åè®®æä¾›äº†ç¼–è§£ç å™¨å’Œå¤„ç†å™¨ï¼Œå‡ ä¹å¯ä»¥å¼€ç®±å³ç”¨ï¼Œè¿™å‡å°‘äº†ä½ åœ¨é‚£äº›ç›¸å½“ç¹ççš„äº‹åŠ¡ä¸Šæœ¬æ¥ä¼šèŠ±è´¹çš„æ—¶é—´ä¸ç²¾åŠ›ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨è¿™äº›å·¥å…·ä»¥åŠå®ƒä»¬æ‰€å¸¦æ¥çš„å¥½å¤„ï¼Œå…¶ä¸­åŒ…æ‹¬ Netty å¯¹äºSSL/TLS å’Œ WebSocket çš„æ”¯æŒï¼Œä»¥åŠå¦‚ä½•ç®€å•åœ°é€šè¿‡æ•°æ®å‹ç¼©æ¥å‹æ¦¨HTTPï¼Œä»¥è·å–æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<h2 id="é€šè¿‡-ssltls-ä¿æŠ¤-netty-åº”ç”¨ç¨‹åº">é€šè¿‡ SSL/TLS ä¿æŠ¤ Netty åº”ç”¨ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#é€šè¿‡-ssltls-ä¿æŠ¤-netty-åº”ç”¨ç¨‹åº">#</a></h2>
<p>å¦‚ä»Šï¼Œæ•°æ®éšç§æ˜¯ä¸€ä¸ªéå¸¸å€¼å¾—å…³æ³¨çš„é—®é¢˜ï¼Œä½œä¸ºå¼€å‘äººå‘˜ï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡å¥½åº”å¯¹å®ƒã€‚è‡³å°‘ï¼Œæˆ‘ä»¬åº”è¯¥ç†Ÿæ‚‰åƒSSLå’ŒTLSè¿™æ ·çš„å®‰å…¨åè®®è®®ï¼Œå®ƒä»¬å±‚å åœ¨å…¶ä»–åè®®ä¹‹ä¸Šï¼Œç”¨ä»¥å®ç°æ•°æ®å®‰å…¨ã€‚æˆ‘ä»¬åœ¨è®¿é—®å®‰å…¨ç½‘ç«™æ—¶é‡åˆ°è¿‡è¿™äº›åè®®ï¼Œä½†æ˜¯å®ƒä»¬ä¹Ÿå¯ç”¨äºå…¶ä»–ä¸æ˜¯åŸºäºHTTPçš„åº”ç”¨ç¨‹åºï¼Œå¦‚å®‰å…¨SMTPï¼ˆSMTPSï¼‰é‚®ä»¶æœåŠ¡å™¨ç”šè‡³æ˜¯å…³ç³»å‹æ•°æ®åº“ç³»ç»Ÿã€‚
ä¸ºäº†æ”¯æŒ SSL/TLSï¼ŒJava æä¾›äº† javax.net.ssl åŒ…ï¼Œå®ƒçš„ SSLContext å’Œ SSLEngineç±»ä½¿å¾—å®ç°è§£å¯†å’ŒåŠ å¯†ç›¸å½“ç®€å•ç›´æ¥ã€‚Netty é€šè¿‡ä¸€ä¸ªåä¸º SslHandler çš„ ChannelHandlerå®ç°åˆ©ç”¨äº†è¿™ä¸ª APIï¼Œå…¶ä¸­ SslHandleråœ¨å†…éƒ¨ä½¿ç”¨ SSLEngine æ¥å®Œæˆå®é™…çš„å·¥ä½œã€‚å›¾ 11-1 å±•ç¤ºäº†ä½¿ç”¨ SslHandler çš„æ•°æ®æµã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/61.png"></p>
<p>Netty çš„ OpenSSL/SSLEngine å®ç°ï¼š
Netty è¿˜æä¾›äº†ä½¿ç”¨ OpenSSL å·¥å…·åŒ…  <a href="https://www.openssl.org">www.openssl.org</a>  çš„ SSLEngine å®ç°ã€‚è¿™ä¸ª OpenSslEngine ç±»æä¾›äº†æ¯” JDK æä¾›çš„ SSLEngine å®ç°æ›´å¥½çš„æ€§èƒ½ã€‚å¦‚æœOpenSSLåº“å¯ç”¨ï¼Œå¯ä»¥å°†Nettyåº”ç”¨ç¨‹åºï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ï¼‰é…ç½®ä¸ºé»˜è®¤ä½¿ç”¨OpenSslEngineã€‚å¦‚æœä¸å¯ç”¨ï¼ŒNetty å°†ä¼šå›é€€åˆ° JDK å®ç°ã€‚æœ‰å…³é…ç½® OpenSSL æ”¯æŒçš„è¯¦ç»†è¯´æ˜ï¼Œå‚è§ Netty æ–‡æ¡£ï¼šhttp://netty.io/wiki/forked-tomcat-native.html#wikih2-1ã€‚
æ³¨æ„ï¼Œæ— è®ºä½ ä½¿ç”¨ JDK çš„ SSLEngine è¿˜æ˜¯ä½¿ç”¨ Netty çš„ OpenSslEngineï¼ŒSSL API å’Œæ•°æ®æµéƒ½æ˜¯ä¸€è‡´çš„ã€‚ä»£ç æ¸…å•11-1å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ChannelInitializeræ¥å°†SslHandleræ·»åŠ åˆ°ChannelPipeline ä¸­ã€‚å›æƒ³ä¸€ä¸‹ï¼ŒChannelInitializer ç”¨äºåœ¨ Channel æ³¨å†Œå¥½æ—¶è®¾ç½® ChannelPipelineã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-1 æ·»åŠ  SSL/TLS æ”¯æŒ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SslChannelInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SslContext context;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> startTls;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SslChannelInitializer(SslContext context,     <span style="color:#007f7f">//ä¼ å…¥è¦ä½¿ç”¨çš„ SslContext</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">boolean</span> startTls) {                              <span style="color:#007f7f">//å¦‚æœè®¾ç½®ä¸º trueï¼Œç¬¬ä¸€ä¸ªå†™å…¥çš„æ¶ˆæ¯å°†ä¸ä¼šè¢«åŠ å¯†ï¼ˆå®¢æˆ·ç«¯åº”è¯¥è®¾ç½®ä¸º trueï¼‰</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">context</span> = context;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">startTls</span> = startTls;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å¯¹äºæ¯ä¸ª SslHandler å®ä¾‹ï¼Œéƒ½ä½¿ç”¨ Channel çš„ ByteBufAllocator ä» SslContext è·å–ä¸€ä¸ªæ–°çš„ SSLEngine</span>
</span></span><span style="display:flex;"><span>        SSLEngine engine = context.<span style="color:#007f7f">newEngine</span>(ch.<span style="color:#007f7f">alloc</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°† SslHandler ä½œä¸ºç¬¬ä¸€ä¸ª ChannelHandler æ·»åŠ åˆ° ChannelPipeline ä¸­</span>
</span></span><span style="display:flex;"><span>        ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addFirst</span>(<span style="color:#0ff;font-weight:bold">&#34;ssl&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> SslHandler(engine, startTls));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒSslHandler å°†æ˜¯ ChannelPipeline ä¸­çš„ç¬¬ä¸€ä¸ª ChannelHandlerã€‚è¿™ç¡®ä¿äº†åªæœ‰åœ¨æ‰€æœ‰å…¶ä»–çš„ ChannelHandler å°†å®ƒä»¬çš„é€»è¾‘åº”ç”¨åˆ°æ•°æ®ä¹‹åï¼Œæ‰ä¼šè¿›è¡ŒåŠ å¯†ã€‚SslHandler å…·æœ‰ä¸€äº›æœ‰ç”¨çš„æ–¹æ³•ï¼Œå¦‚è¡¨ 11-1 æ‰€ç¤ºã€‚ä¾‹å¦‚ï¼Œåœ¨æ¡æ‰‹é˜¶æ®µï¼Œä¸¤ä¸ªèŠ‚ç‚¹å°†ç›¸äº’éªŒè¯å¹¶ä¸”å•†å®šä¸€ç§åŠ å¯†æ–¹å¼ã€‚
ä½ å¯ä»¥é€šè¿‡é…ç½® SslHandler æ¥ä¿®æ”¹å®ƒçš„è¡Œä¸ºï¼Œæˆ–è€…åœ¨ SSL/TLSæ¡æ‰‹ä¸€æ—¦å®Œæˆä¹‹åæä¾›é€šçŸ¥ï¼Œæ¡æ‰‹é˜¶æ®µå®Œæˆä¹‹åï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½å°†ä¼šè¢«åŠ å¯†ã€‚SSL/TLS æ¡æ‰‹å°†ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œã€‚</p>
<table>
<thead>
<tr>
<th>æ–¹ æ³• å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>setHandshakeTimeout (long,TimeUnit) setHandshakeTimeoutMillis (long) getHandshakeTimeoutMillis()</td>
<td>è®¾ç½®å’Œè·å–è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶ä¹‹åï¼Œæ¡æ‰‹ ChannelFuture å°†ä¼šè¢«é€šçŸ¥å¤±è´¥</td>
</tr>
<tr>
<td>setCloseNotifyTimeout (long,TimeUnit) setCloseNotifyTimeoutMillis (long) getCloseNotifyTimeoutMillis()</td>
<td>è®¾ç½®å’Œè·å–è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶ä¹‹åï¼Œå°†ä¼šè§¦ å‘ä¸€ä¸ªå…³é—­é€šçŸ¥å¹¶å…³é—­è¿æ¥ã€‚è¿™ä¹Ÿå°†ä¼šå¯¼ è‡´é€šçŸ¥è¯¥ ChannelFuture å¤±è´¥</td>
</tr>
<tr>
<td>handshakeFuture()</td>
<td>è¿”å›ä¸€ä¸ªåœ¨æ¡æ‰‹å®Œæˆåå°†ä¼šå¾—åˆ°é€šçŸ¥çš„ ChannelFutureã€‚å¦‚æœæ¡æ‰‹å…ˆå‰å·²ç»æ‰§ è¡Œè¿‡äº†ï¼Œåˆ™è¿”å›ä¸€ä¸ªåŒ…å«äº†å…ˆå‰çš„æ¡æ‰‹ç»“ æœçš„ ChannelFuture</td>
</tr>
<tr>
<td>close() close(ChannelPromise) close(ChannelHandlerContext,ChannelPromise)</td>
<td>å‘é€ close_notify ä»¥è¯·æ±‚å…³é—­å¹¶é”€æ¯ åº•å±‚çš„ SslEngine</td>
</tr>
</tbody>
</table>
<h2 id="æ„å»ºåŸºäº-netty-çš„-httphttps-åº”ç”¨ç¨‹åº">æ„å»ºåŸºäº Netty çš„ HTTP/HTTPS åº”ç”¨ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#æ„å»ºåŸºäº-netty-çš„-httphttps-åº”ç”¨ç¨‹åº">#</a></h2>
<p>HTTP/HTTPS æ˜¯æœ€å¸¸è§çš„åè®®å¥—ä»¶ä¹‹ä¸€ï¼Œå¹¶ä¸”éšç€æ™ºèƒ½æ‰‹æœºçš„æˆåŠŸï¼Œå®ƒçš„åº”ç”¨ä¹Ÿæ—¥ç›Šå¹¿æ³›ï¼Œå› ä¸ºå¯¹äºä»»ä½•å…¬å¸æ¥è¯´ï¼Œæ‹¥æœ‰ä¸€ä¸ªå¯ä»¥è¢«ç§»åŠ¨è®¾å¤‡è®¿é—®çš„ç½‘ç«™å‡ ä¹æ˜¯å¿…é¡»çš„ã€‚è¿™äº›åè®®ä¹Ÿè¢«ç”¨äºå…¶ä»–æ–¹é¢ã€‚è®¸å¤šç»„ç»‡å¯¼å‡ºçš„ç”¨äºå’Œä»–ä»¬çš„å•†ä¸šåˆä½œä¼™ä¼´é€šä¿¡çš„ WebService API ä¸€èˆ¬ä¹Ÿæ˜¯åŸºäºHTTPï¼ˆSï¼‰çš„ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Nettyæä¾›çš„ ChannelHandlerï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥å¤„ç† HTTP å’Œ HTTPSåè®®ï¼Œè€Œä¸å¿…ç¼–å†™è‡ªå®šä¹‰çš„ç¼–è§£ç å™¨ã€‚</p>
<h3 id="http-è§£ç å™¨ç¼–ç å™¨å’Œç¼–è§£ç å™¨">HTTP è§£ç å™¨ã€ç¼–ç å™¨å’Œç¼–è§£ç å™¨<a hidden class="anchor" aria-hidden="true" href="#http-è§£ç å™¨ç¼–ç å™¨å’Œç¼–è§£ç å™¨">#</a></h3>
<p>HTTP æ˜¯åŸºäºè¯·æ±‚/å“åº”æ¨¡å¼çš„ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œç„¶åæœåŠ¡å™¨å°†ä¼šè¿”å›ä¸€ä¸ª HTTP å“åº”ã€‚
Netty æä¾›äº†å¤šç§ç¼–ç å™¨å’Œè§£ç å™¨ä»¥ç®€åŒ–å¯¹è¿™ä¸ªåè®®çš„ä½¿ç”¨ã€‚
å›¾ 11-2 å’Œå›¾ 11-3åˆ†åˆ«å±•ç¤ºäº†ç”Ÿäº§å’Œæ¶ˆè´¹ HTTP è¯·æ±‚å’Œ HTTP å“åº”çš„æ–¹æ³•ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/62.png">
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/63.png">
å¦‚å›¾ 11-2 å’Œå›¾ 11-3 æ‰€ç¤ºï¼Œä¸€ä¸ª HTTP è¯·æ±‚/å“åº”å¯èƒ½ç”±å¤šä¸ªæ•°æ®éƒ¨åˆ†ç»„æˆï¼Œå¹¶ä¸”å®ƒæ€»æ˜¯ä»¥ä¸€ä¸ª
LastHttpContent éƒ¨åˆ†ä½œä¸ºç»“æŸã€‚FullHttpRequest å’Œ FullHttpResponse æ¶ˆæ¯æ˜¯ç‰¹æ®Šçš„å­ç±»å‹ï¼Œåˆ†åˆ«ä»£è¡¨äº†å®Œæ•´çš„è¯·æ±‚å’Œå“åº”ã€‚æ‰€æœ‰ç±»å‹çš„ HTTP æ¶ˆæ¯ï¼ˆFullHttpRequestã€LastHttpContent ä»¥åŠä»£ç æ¸…å• 11-2 ä¸­å±•ç¤ºçš„é‚£äº›ï¼‰éƒ½å®ç°äº† HttpObject æ¥å£ã€‚
è¡¨ 11-2 æ¦‚è¦åœ°ä»‹ç»äº†å¤„ç†å’Œç”Ÿæˆè¿™äº›æ¶ˆæ¯çš„ HTTP è§£ç å™¨å’Œç¼–ç å™¨ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>HttpRequestEncoder</td>
<td>å°†HttpRequestã€HttpContent å’Œ LastHttpContent æ¶ˆæ¯ç¼–ç ä¸ºå­—èŠ‚</td>
</tr>
<tr>
<td>HttpResponseEncoder</td>
<td>å°†HttpResponseã€HttpContent å’ŒLastHttpContent æ¶ˆæ¯ç¼–ç ä¸ºå­—èŠ‚</td>
</tr>
<tr>
<td>HttpRequestDecoder</td>
<td>å°†å­—èŠ‚è§£ç ä¸ºHttpRequestã€HttpContent å’Œ LastHttpContent æ¶ˆæ¯</td>
</tr>
<tr>
<td>HttpResponseDecoder</td>
<td>å°†å­—èŠ‚è§£ç ä¸ºHttpResponseã€HttpContent å’ŒLastHttpContent æ¶ˆæ¯</td>
</tr>
</tbody>
</table>
<p>ä»£ç æ¸…å• 11-2 ä¸­çš„ HttpPipelineInitializer ç±»å±•ç¤ºäº†å°† HTTP æ”¯æŒæ·»åŠ åˆ°ä½ çš„åº”ç”¨ç¨‹åºæ˜¯å¤šä¹ˆç®€å•ï¼Œ
åªéœ€è¦å°†æ­£ç¡®çš„ ChannelHandler æ·»åŠ åˆ° ChannelPipeline ä¸­ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-2 æ·»åŠ  HTTP æ”¯æŒ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpPipelineInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> client;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpPipelineInitializer(<span style="color:#fff;font-weight:bold">boolean</span> client) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">client</span> = client;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (client) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯å®¢æˆ·ç«¯ï¼Œåˆ™æ·»åŠ  HttpResponseDecoder ä»¥å¤„ç†æ¥è‡ªæœåŠ¡å™¨çš„å“åº”</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;decoder&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpResponseDecoder());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯å®¢æˆ·ç«¯ï¼Œåˆ™æ·»åŠ  HttpRequestEncoder ä»¥å‘æœåŠ¡å™¨å‘é€è¯·æ±‚</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;encoder&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpRequestEncoder());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯æœåŠ¡å™¨ï¼Œåˆ™æ·»åŠ  HttpRequestDecoder ä»¥æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;decoder&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpRequestDecoder());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯æœåŠ¡å™¨ï¼Œåˆ™æ·»åŠ  HttpResponseEncoder ä»¥å‘å®¢æˆ·ç«¯å‘é€å“åº”</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;encoder&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpResponseEncoder());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="èšåˆ-http-æ¶ˆæ¯">èšåˆ HTTP æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#èšåˆ-http-æ¶ˆæ¯">#</a></h3>
<p>åœ¨ ChannelInitializer å°† ChannelHandler å®‰è£…åˆ° ChannelPipeline ä¸­ä¹‹åï¼Œä½ ä¾¿å¯ä»¥å¤„ç†ä¸åŒç±»å‹çš„
HttpObject æ¶ˆæ¯äº†ã€‚ä½†æ˜¯ç”±äº HTTP çš„è¯·æ±‚å’Œå“åº”å¯èƒ½ç”±è®¸å¤šéƒ¨åˆ†ç»„æˆï¼Œå› æ­¤ä½ éœ€è¦èšåˆå®ƒä»¬ä»¥å½¢æˆå®Œæ•´çš„æ¶ˆæ¯ã€‚ä¸ºäº†æ¶ˆé™¤è¿™é¡¹ç¹ççš„ä»»åŠ¡ï¼ŒNetty æä¾›äº†ä¸€ä¸ªèšåˆå™¨ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ªæ¶ˆæ¯éƒ¨åˆ†åˆå¹¶ä¸º
FullHttpRequest æˆ–è€… FullHttpResponse æ¶ˆæ¯ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œä½ å°†æ€»æ˜¯çœ‹åˆ°å®Œæ•´çš„æ¶ˆæ¯å†…å®¹ã€‚
ç”±äºæ¶ˆæ¯åˆ†æ®µéœ€è¦è¢«ç¼“å†²ï¼Œç›´åˆ°å¯ä»¥è½¬å‘ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ç»™ä¸‹ä¸€ä¸ª ChannelInboundHandlerï¼Œæ‰€ä»¥è¿™ä¸ªæ“ä½œæœ‰è½»å¾®çš„å¼€é”€ã€‚å…¶æ‰€å¸¦æ¥çš„å¥½å¤„ä¾¿æ˜¯ä½ ä¸å¿…å…³å¿ƒæ¶ˆæ¯ç¢ç‰‡äº†ã€‚å¼•å…¥è¿™ç§è‡ªåŠ¨èšåˆæœºåˆ¶åªä¸è¿‡æ˜¯å‘ChannelPipeline ä¸­æ·»åŠ å¦å¤–ä¸€ä¸ª ChannelHandlerç½¢äº†ã€‚ä»£ç æ¸…å• 11-3 å±•ç¤ºäº†å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-3 è‡ªåŠ¨èšåˆ HTTP çš„æ¶ˆæ¯ç‰‡æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpAggregatorInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> isClient;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpAggregatorInitializer(<span style="color:#fff;font-weight:bold">boolean</span> isClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">isClient</span> = isClient;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (isClient) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯å®¢æˆ·ç«¯ï¼Œåˆ™æ·»åŠ  HttpClientCodec</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpClientCodec());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯æœåŠ¡å™¨ï¼Œåˆ™æ·»åŠ  HttpServerCodec</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpServerCodec());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†æœ€å¤§çš„æ¶ˆæ¯å¤§å°ä¸º 512 KB çš„ HttpObjectAggregator æ·»åŠ åˆ° ChannelPipeline</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;aggregator&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpObjectAggregator(512 * 1024));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="http-å‹ç¼©">HTTP å‹ç¼©<a hidden class="anchor" aria-hidden="true" href="#http-å‹ç¼©">#</a></h3>
<p>å½“ä½¿ç”¨ HTTP æ—¶ï¼Œå»ºè®®å¼€å¯å‹ç¼©åŠŸèƒ½ä»¥å°½å¯èƒ½å¤šåœ°å‡å°ä¼ è¾“æ•°æ®çš„å¤§å°ã€‚è™½ç„¶å‹ç¼©ä¼šå¸¦æ¥ä¸€äº› CPU æ—¶é’Ÿå‘¨æœŸä¸Šçš„å¼€é”€ï¼Œä½†æ˜¯é€šå¸¸æ¥è¯´å®ƒéƒ½æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œç‰¹åˆ«æ˜¯å¯¹äºæ–‡æœ¬æ•°æ®æ¥è¯´ã€‚
Netty ä¸ºå‹ç¼©å’Œè§£å‹ç¼©æä¾›äº† ChannelHandler å®ç°ï¼Œå®ƒä»¬åŒæ—¶æ”¯æŒ gzip å’Œ deflate ç¼–ç ã€‚
HTTP è¯·æ±‚çš„å¤´éƒ¨ä¿¡æ¯ï¼š
å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æä¾›ä»¥ä¸‹å¤´éƒ¨ä¿¡æ¯æ¥æŒ‡ç¤ºæœåŠ¡å™¨å®ƒæ‰€æ”¯æŒçš„å‹ç¼©æ ¼å¼ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>GET /encrypted-area HTTP/1.1
</span></span><span style="display:flex;"><span>Host: www.example.com
</span></span><span style="display:flex;"><span>Accept-Encoding: gzip, deflate
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶è€Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæœåŠ¡å™¨æ²¡æœ‰ä¹‰åŠ¡å‹ç¼©å®ƒæ‰€å‘é€çš„æ•°æ®ã€‚
ä»£ç æ¸…å• 11-4 å±•ç¤ºäº†ä¸€ä¸ªä¾‹å­ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-4 è‡ªåŠ¨å‹ç¼© HTTP æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpCompressionInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> isClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpCompressionInitializer(<span style="color:#fff;font-weight:bold">boolean</span> isClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">isClient</span> = isClient;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (isClient) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯å®¢æˆ·ç«¯ï¼Œåˆ™æ·»åŠ  HttpClientCodec</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpClientCodec());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯å®¢æˆ·ç«¯ï¼Œåˆ™æ·»åŠ  HttpContentDecompressor ä»¥å¤„ç†æ¥è‡ªæœåŠ¡å™¨çš„å‹ç¼©å†…å®¹</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;decompressor&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpContentDecompressor());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯æœåŠ¡å™¨ï¼Œåˆ™æ·»åŠ  HttpServerCodec</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpServerCodec());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯æœåŠ¡å™¨ï¼Œåˆ™æ·»åŠ HttpContentCompressor æ¥å‹ç¼©æ•°æ®ï¼ˆå¦‚æœå®¢æˆ·ç«¯æ”¯æŒå®ƒï¼‰</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;compressor&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpContentCompressor());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä½¿ç”¨-https">ä½¿ç”¨ HTTPS<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨-https">#</a></h3>
<p>ä»£ç æ¸…å• 11-5 æ˜¾ç¤ºï¼Œå¯ç”¨ HTTPS åªéœ€è¦å°†SslHandleræ·»åŠ åˆ° ChannelPipeline çš„ChannelHandler ç»„åˆä¸­ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-5 ä½¿ç”¨ HTTPS
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpsCodecInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SslContext context;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> isClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpsCodecInitializer(SslContext context, <span style="color:#fff;font-weight:bold">boolean</span> isClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">context</span> = context;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">isClient</span> = isClient;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        SSLEngine engine = context.<span style="color:#007f7f">newEngine</span>(ch.<span style="color:#007f7f">alloc</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°† SslHandler æ·»åŠ åˆ°ChannelPipeline ä¸­ä»¥ä½¿ç”¨ HTTPS</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addFirst</span>(<span style="color:#0ff;font-weight:bold">&#34;ssl&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> SslHandler(engine));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (isClient) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯å®¢æˆ·ç«¯ï¼Œåˆ™æ·»åŠ  HttpClientCodec</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpClientCodec());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœæ˜¯æœåŠ¡å™¨ï¼Œåˆ™æ·»åŠ  HttpServerCodec</span>
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpServerCodec());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ®µä»£ç è¯´æ˜äº† Netty çš„æ¶æ„æ–¹å¼æ˜¯å¦‚ä½•å°†ä»£ç é‡ç”¨å˜ä¸ºæ æ†ä½œç”¨çš„ã€‚åªéœ€è¦ç®€å•åœ°å°†ä¸€ä¸ªChannelHandleræ·»åŠ åˆ° ChannelPipeline ä¸­ï¼Œä¾¿å¯ä»¥æä¾›ä¸€é¡¹æ–°åŠŸèƒ½ï¼Œç”šè‡³åƒåŠ å¯†è¿™æ ·é‡è¦çš„åŠŸèƒ½éƒ½èƒ½æä¾›ã€‚</p>
<h3 id="websocket">WebSocket<a hidden class="anchor" aria-hidden="true" href="#websocket">#</a></h3>
<p>Netty é’ˆå¯¹åŸºäº HTTP çš„åº”ç”¨ç¨‹åºçš„å¹¿æ³›å·¥å…·åŒ…ä¸­åŒ…æ‹¬äº†å¯¹å®ƒçš„ä¸€äº›æœ€å…ˆè¿›çš„ç‰¹æ€§çš„æ”¯æŒã€‚åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ WebSocketï¼šä¸€ç§åœ¨ 2011 å¹´è¢«äº’è”ç½‘å·¥ç¨‹ä»»åŠ¡ç»„ï¼ˆIETFï¼‰æ ‡å‡†åŒ–çš„åè®®ã€‚
WebSocketè§£å†³äº†ä¸€ä¸ªé•¿æœŸå­˜åœ¨çš„é—®é¢˜ï¼šæ—¢ç„¶åº•å±‚çš„åè®®ï¼ˆHTTPï¼‰æ˜¯ä¸€ä¸ªè¯·æ±‚/å“åº”æ¨¡å¼çš„äº¤äº’åºåˆ—ï¼Œé‚£ä¹ˆå¦‚ä½•å®æ—¶åœ°å‘å¸ƒä¿¡æ¯å‘¢ï¼ŸAJAXæä¾›äº†ä¸€å®šç¨‹åº¦ä¸Šçš„æ”¹å–„ï¼Œä½†æ˜¯æ•°æ®æµä»ç„¶æ˜¯ç”±å®¢æˆ·ç«¯æ‰€å‘é€çš„è¯·æ±‚é©±åŠ¨çš„ã€‚
è¿˜æœ‰å…¶ä»–çš„ä¸€äº›æˆ–å¤šæˆ–å°‘çš„å–å·§æ–¹å¼ï¼ˆå¦‚Cometï¼‰ï¼Œä½†æ˜¯æœ€ç»ˆå®ƒä»¬ä»ç„¶å±äºæ‰©å±•æ€§å—é™çš„å˜é€šä¹‹æ³•ã€‚WebSocketè§„èŒƒä»¥åŠå®ƒçš„å®ç°ä»£è¡¨äº†å¯¹ä¸€ç§æ›´åŠ æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆçš„å°è¯•ã€‚ç®€å•åœ°è¯´ï¼ŒWebSocketæä¾›äº†â€œåœ¨ä¸€ä¸ªå•ä¸ªçš„TCPè¿æ¥ä¸Šæä¾›åŒå‘çš„é€šä¿¡â€¦â€¦ç»“åˆWebSocket APIâ€¦â€¦å®ƒä¸ºç½‘é¡µå’Œè¿œç¨‹æœåŠ¡å™¨ä¹‹é—´çš„åŒå‘é€šä¿¡æä¾›äº†ä¸€ç§æ›¿ä»£HTTPè½®è¯¢çš„æ–¹æ¡ˆã€‚â€
ä¹Ÿå°±æ˜¯è¯´ï¼ŒWebSocket åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´æä¾›äº†çœŸæ­£çš„åŒå‘æ•°æ®äº¤æ¢ã€‚æˆ‘ä»¬ä¸ä¼šæ·±å…¥åœ°æè¿°å¤ªå¤šçš„å†…éƒ¨ç»†èŠ‚ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯åº”è¯¥æåˆ°ï¼Œå°½ç®¡æœ€æ—©çš„å®ç°ä»…é™äºæ–‡æœ¬æ•°æ®ï¼Œä½†æ˜¯ç°åœ¨å·²ç»ä¸æ˜¯é—®é¢˜äº†ï¼›WebSocketç°åœ¨å¯ä»¥ç”¨äºä¼ è¾“ä»»æ„ç±»å‹çš„æ•°æ®ï¼Œå¾ˆåƒæ™®é€šçš„å¥—æ¥å­—ã€‚
å›¾ 11-4 ç»™å‡ºäº† WebSocket åè®®çš„ä¸€èˆ¬æ¦‚å¿µã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œé€šä¿¡å°†ä½œä¸ºæ™®é€šçš„ HTTP åè®®å¼€å§‹ï¼Œéšåå‡çº§åˆ°åŒå‘çš„ WebSocket åè®®ã€‚<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/64.png">
è¦æƒ³å‘ä½ çš„åº”ç”¨ç¨‹åºä¸­æ·»åŠ å¯¹äº WebSocket çš„æ”¯æŒï¼Œä½ éœ€è¦å°†é€‚å½“çš„å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨ChannelHandleræ·»åŠ åˆ° ChannelPipeline ä¸­ã€‚è¿™ä¸ªç±»å°†å¤„ç†ç”± WebSocket å®šä¹‰çš„ç§°ä¸ºå¸§çš„ç‰¹æ®Šæ¶ˆæ¯ç±»å‹ã€‚å¦‚è¡¨ 11-3 æ‰€ç¤ºï¼ŒWebSocketFrame å¯ä»¥è¢«å½’ç±»ä¸ºæ•°æ®å¸§æˆ–è€…æ§åˆ¶å¸§ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>BinaryWebSocketFrame</td>
<td>æ•°æ®å¸§ï¼šäºŒè¿›åˆ¶æ•°æ®</td>
</tr>
<tr>
<td>TextWebSocketFrame</td>
<td>æ•°æ®å¸§ï¼šæ–‡æœ¬æ•°æ®</td>
</tr>
<tr>
<td>ContinuationWebSocketFrame</td>
<td>æ•°æ®å¸§ï¼šå±äºä¸Šä¸€ä¸ª BinaryWebSocketFrame æˆ–è€… TextWebSocketFrame çš„æ–‡æœ¬çš„æˆ–è€…äºŒè¿›åˆ¶æ•°æ®</td>
</tr>
<tr>
<td>CloseWebSocketFrame</td>
<td>æ§åˆ¶å¸§ï¼šä¸€ä¸ª CLOSE è¯·æ±‚ã€å…³é—­çš„çŠ¶æ€ç ä»¥åŠå…³é—­çš„åŸå› </td>
</tr>
<tr>
<td>PingWebSocketFrame</td>
<td>æ§åˆ¶å¸§ï¼šè¯·æ±‚ä¸€ä¸ª PongWebSocketFrame</td>
</tr>
<tr>
<td>PongWebSocketFrame</td>
<td>æ§åˆ¶å¸§ï¼šå¯¹ PingWebSocketFrame è¯·æ±‚çš„å“åº”</td>
</tr>
</tbody>
</table>
<p>å› ä¸ºNettyä¸»è¦æ˜¯ä¸€ç§æœåŠ¡å™¨ç«¯çš„æŠ€æœ¯ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬é‡ç‚¹åˆ›å»ºWebSocketæœåŠ¡å™¨ã€‚
å…³äºWebSocketçš„å®¢æˆ·ç«¯ç¤ºä¾‹ï¼Œè¯·å‚è€ƒNettyæºä»£ç ä¸­æ‰€åŒ…å«çš„ä¾‹å­ï¼šhttps://github.com/netty/netty/
tree/4.1/example/src/main/java/io/netty/example/http/websocketx/clientã€‚
ä»£ç æ¸…å• 11-6 å±•ç¤ºäº†ä¸€ä¸ªä½¿ç”¨WebSocketServerProtocolHandlerçš„ç®€å•ç¤ºä¾‹ï¼Œè¿™ä¸ªç±»å¤„ç†åè®®å‡çº§æ¡æ‰‹ï¼Œä»¥åŠ 3 ç§æ§åˆ¶å¸§â€”â€”Closeã€Pingå’ŒPongã€‚Textå’ŒBinaryæ•°æ®å¸§å°†ä¼šè¢«ä¼ é€’ç»™ä¸‹ä¸€ä¸ªï¼ˆç”±ä½ å®ç°çš„ï¼‰ChannelHandlerè¿›è¡Œå¤„ç†ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-6 åœ¨æœåŠ¡å™¨ç«¯æ”¯æŒ WebSocket
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WebSocketServerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> HttpServerCodec(),
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ä¸ºæ¡æ‰‹æä¾›èšåˆçš„ HttpRequest</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> HttpObjectAggregator(65536),
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœè¢«è¯·æ±‚çš„ç«¯ç‚¹æ˜¯&#34;/websocket&#34;ï¼Œåˆ™å¤„ç†è¯¥å‡çº§æ¡æ‰‹</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> WebSocketServerProtocolHandler(<span style="color:#0ff;font-weight:bold">&#34;/websocket&#34;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//TextFrameHandler å¤„ç† TextWebSocketFrame</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> TextFrameHandler(),
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//BinaryFrameHandler å¤„ç† BinaryWebSocketFrame</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> BinaryFrameHandler(),
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ContinuationFrameHandler å¤„ç† ContinuationWebSocketFrame</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> ContinuationFrameHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> TextFrameHandler <span style="color:#fff;font-weight:bold">extends</span>
</span></span><span style="display:flex;"><span>        SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>            TextWebSocketFrame msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Handle text frame</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> BinaryFrameHandler <span style="color:#fff;font-weight:bold">extends</span>
</span></span><span style="display:flex;"><span>        SimpleChannelInboundHandler&lt;BinaryWebSocketFrame&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>            BinaryWebSocketFrame msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Handle binary frame</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ContinuationFrameHandler <span style="color:#fff;font-weight:bold">extends</span>
</span></span><span style="display:flex;"><span>        SimpleChannelInboundHandler&lt;ContinuationWebSocketFrame&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>            ContinuationWebSocketFrame msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Handle continuation frame</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¦æƒ³ä¸º WebSocket æ·»åŠ å®‰å…¨æ€§ï¼Œåªéœ€è¦å°† SslHandler ä½œä¸ºç¬¬ä¸€ä¸ª ChannelHandleræ·»åŠ åˆ°
ChannelPipeline ä¸­ã€‚æ›´åŠ å…¨é¢çš„ç¤ºä¾‹å‚è§ç¬¬ 12 ç« ï¼Œé‚£ä¸€ç« ä¼šæ·±å…¥æ¢è®¨å®æ—¶ WebSocket åº”ç”¨ç¨‹åºçš„è®¾è®¡ã€‚</p>
<h2 id="ç©ºé—²çš„è¿æ¥å’Œè¶…æ—¶">ç©ºé—²çš„è¿æ¥å’Œè¶…æ—¶<a hidden class="anchor" aria-hidden="true" href="#ç©ºé—²çš„è¿æ¥å’Œè¶…æ—¶">#</a></h2>
<p>æ£€æµ‹ç©ºé—²è¿æ¥ä»¥åŠè¶…æ—¶å¯¹äºåŠæ—¶é‡Šæ”¾èµ„æºæ¥è¯´æ˜¯è‡³å…³é‡è¦çš„ã€‚ç”±äºè¿™æ˜¯ä¸€é¡¹å¸¸è§çš„ä»»åŠ¡ï¼ŒNetty ç‰¹åœ°ä¸ºå®ƒæä¾›äº†å‡ ä¸ª ChannelHandler å®ç°ã€‚è¡¨ 11-4 ç»™å‡ºäº†å®ƒä»¬çš„æ¦‚è¿°ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>IdleStateHandler</td>
<td>å½“è¿æ¥ç©ºé—²æ—¶é—´å¤ªé•¿æ—¶ï¼Œå°†ä¼šè§¦å‘ä¸€ä¸ª IdleStateEvent äº‹ä»¶ã€‚ç„¶åï¼Œ ä½ å¯ä»¥é€šè¿‡åœ¨ä½ çš„ ChannelInboundHandler ä¸­é‡å†™ userEventTriggered()æ–¹æ³•æ¥å¤„ç†è¯¥ IdleStateEvent äº‹ä»¶</td>
</tr>
<tr>
<td>ReadTimeoutHandler</td>
<td>å¦‚æœåœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…æ²¡æœ‰æ”¶åˆ°ä»»ä½•çš„å…¥ç«™æ•°æ®ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ª ReadTimeoutException å¹¶å…³é—­å¯¹åº”çš„ Channelã€‚å¯ä»¥é€šè¿‡é‡å†™ä½ çš„ ChannelHandler ä¸­çš„ exceptionCaught()æ–¹æ³•æ¥æ£€æµ‹è¯¥ ReadTimeoutException</td>
</tr>
<tr>
<td>WriteTimeoutHandler</td>
<td>å¦‚æœåœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…æ²¡æœ‰ä»»ä½•å‡ºç«™æ•°æ®å†™å…¥ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ª WriteTimeoutException å¹¶å…³é—­å¯¹åº”çš„ Channel ã€‚å¯ä»¥é€šè¿‡é‡å†™ä½ çš„ ChannelHandler çš„ exceptionCaught()æ–¹æ³•æ£€æµ‹è¯¥ WriteTimeoutException</td>
</tr>
</tbody>
</table>
<p>è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹åœ¨å®è·µä¸­ä½¿ç”¨å¾—æœ€å¤šçš„ IdleStateHandler å§ã€‚ä»£ç æ¸…å• 11-7 å±•ç¤ºäº†å½“ä½¿ç”¨é€šå¸¸çš„å‘é€å¿ƒè·³æ¶ˆæ¯åˆ°è¿œç¨‹èŠ‚ç‚¹çš„æ–¹æ³•æ—¶ï¼Œå¦‚æœåœ¨ 60 ç§’ä¹‹å†…æ²¡æœ‰æ¥æ”¶æˆ–è€…å‘é€ä»»ä½•çš„æ•°æ®ï¼Œæˆ‘ä»¬å°†å¦‚ä½•å¾—åˆ°é€šçŸ¥ï¼›å¦‚æœæ²¡æœ‰å“åº”ï¼Œåˆ™è¿æ¥ä¼šè¢«å…³é—­ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-7 å‘é€å¿ƒè·³
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> IdleStateHandlerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt;
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//(1) IdleStateHandler å°†åœ¨è¢«è§¦å‘æ—¶å‘é€ä¸€ä¸ªIdleStateEvent äº‹ä»¶</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> IdleStateHandler(0, 0, 60, TimeUnit.<span style="color:#007f7f">SECONDS</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†ä¸€ä¸ª HeartbeatHandler æ·»åŠ åˆ°ChannelPipelineä¸­</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HeartbeatHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å®ç° userEventTriggered() æ–¹æ³•ä»¥å‘é€å¿ƒè·³æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> HeartbeatHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å‘é€åˆ°è¿œç¨‹èŠ‚ç‚¹çš„å¿ƒè·³æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ByteBuf HEARTBEAT_SEQUENCE =
</span></span><span style="display:flex;"><span>                Unpooled.<span style="color:#007f7f">unreleasableBuffer</span>(Unpooled.<span style="color:#007f7f">copiedBuffer</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;HEARTBEAT&#34;</span>, CharsetUtil.<span style="color:#007f7f">ISO_8859_1</span>));
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> userEventTriggered(ChannelHandlerContext ctx, Object evt) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(2) å‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œå¹¶åœ¨å‘é€å¤±è´¥æ—¶å…³é—­è¯¥è¿æ¥</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (evt <span style="color:#fff;font-weight:bold">instanceof</span> IdleStateEvent) {
</span></span><span style="display:flex;"><span>                ctx.<span style="color:#007f7f">writeAndFlush</span>(HEARTBEAT_SEQUENCE.<span style="color:#007f7f">duplicate</span>())
</span></span><span style="display:flex;"><span>                     .<span style="color:#007f7f">addListener</span>(
</span></span><span style="display:flex;"><span>                         ChannelFutureListener.<span style="color:#007f7f">CLOSE_ON_FAILURE</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//ä¸æ˜¯ IdleStateEvent äº‹ä»¶ï¼Œæ‰€ä»¥å°†å®ƒä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelInboundHandler</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">userEventTriggered</span>(ctx, evt);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ IdleStateHandler æ¥æµ‹è¯•è¿œç¨‹èŠ‚ç‚¹æ˜¯å¦ä»ç„¶è¿˜æ´»ç€ï¼Œå¹¶ä¸”åœ¨å®ƒå¤±æ´»æ—¶é€šè¿‡å…³é—­è¿æ¥æ¥é‡Šæ”¾èµ„æºã€‚å¦‚æœè¿æ¥è¶…è¿‡ 60 ç§’æ²¡æœ‰æ¥æ”¶æˆ–è€…å‘é€ä»»ä½•çš„æ•°æ®ï¼Œé‚£ä¹ˆ IdleStateHandler å°†ä¼šä½¿ç”¨ä¸€ä¸ªIdleStateEvent äº‹ä»¶æ¥è°ƒç”¨ fireUserEventTriggered()æ–¹æ³•ã€‚HeartbeatHandler å®ç°äº†
userEventTriggered()æ–¹æ³•ï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•æ£€æµ‹åˆ° IdleStateEvent äº‹ä»¶ï¼Œå®ƒå°†ä¼šå‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œå¹¶ä¸”æ·»åŠ ä¸€ä¸ªå°†åœ¨å‘é€æ“ä½œå¤±è´¥æ—¶å…³é—­è¯¥è¿æ¥çš„ ChannelFutureListener ã€‚</p>
<h2 id="è§£ç åŸºäºåˆ†éš”ç¬¦çš„åè®®å’ŒåŸºäºé•¿åº¦çš„åè®®">è§£ç åŸºäºåˆ†éš”ç¬¦çš„åè®®å’ŒåŸºäºé•¿åº¦çš„åè®®<a hidden class="anchor" aria-hidden="true" href="#è§£ç åŸºäºåˆ†éš”ç¬¦çš„åè®®å’ŒåŸºäºé•¿åº¦çš„åè®®">#</a></h2>
<p>åœ¨ä½¿ç”¨ Netty çš„è¿‡ç¨‹ä¸­ï¼Œä½ å°†ä¼šé‡åˆ°éœ€è¦è§£ç å™¨çš„åŸºäºåˆ†éš”ç¬¦å’Œå¸§é•¿åº¦çš„åè®®ã€‚ä¸‹ä¸€èŠ‚å°†è§£é‡Š Netty æ‰€æä¾›çš„ç”¨äºå¤„ç†è¿™äº›åœºæ™¯çš„å®ç°ã€‚</p>
<h3 id="åŸºäºåˆ†éš”ç¬¦çš„åè®®">åŸºäºåˆ†éš”ç¬¦çš„åè®®<a hidden class="anchor" aria-hidden="true" href="#åŸºäºåˆ†éš”ç¬¦çš„åè®®">#</a></h3>
<p>åŸºäºåˆ†éš”ç¬¦çš„ï¼ˆdelimitedï¼‰æ¶ˆæ¯åè®®ä½¿ç”¨å®šä¹‰çš„å­—ç¬¦æ¥æ ‡è®°çš„æ¶ˆæ¯æˆ–è€…æ¶ˆæ¯æ®µï¼ˆé€šå¸¸è¢«ç§°ä¸ºå¸§ï¼‰çš„å¼€å¤´æˆ–è€…ç»“å°¾ã€‚ç”±RFCæ–‡æ¡£æ­£å¼å®šä¹‰çš„è®¸å¤šåè®®ï¼ˆå¦‚SMTPã€POP3ã€IMAPä»¥åŠTelne )éƒ½æ˜¯è¿™æ ·çš„ã€‚æ­¤å¤–ï¼Œå½“ç„¶ï¼Œç§æœ‰ç»„ç»‡é€šå¸¸ä¹Ÿæ‹¥æœ‰ä»–ä»¬è‡ªå·±çš„ä¸“æœ‰æ ¼å¼ã€‚æ— è®ºä½ ä½¿ç”¨ä»€ä¹ˆæ ·çš„åè®®ï¼Œè¡¨ 11-5 ä¸­åˆ—å‡ºçš„è§£ç å™¨éƒ½èƒ½å¸®åŠ©ä½ å®šä¹‰å¯ä»¥æå–ç”±ä»»æ„æ ‡è®°ï¼ˆtokenï¼‰åºåˆ—åˆ†éš”çš„å¸§çš„è‡ªå®šä¹‰è§£ç å™¨ã€‚æ— è®ºä½ ä½¿ç”¨ä»€ä¹ˆæ ·çš„åè®®ï¼Œè¡¨ 11-5 ä¸­åˆ—å‡ºçš„è§£ç å™¨éƒ½èƒ½å¸®åŠ©ä½ å®šä¹‰å¯ä»¥æå–ç”±ä»»æ„æ ‡è®°ï¼ˆtokenï¼‰åºåˆ—åˆ†éš”çš„å¸§çš„è‡ªå®šä¹‰è§£ç å™¨ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>DelimiterBasedFrameDecoder</td>
<td>ä½¿ç”¨ä»»ä½•ç”±ç”¨æˆ·æä¾›çš„åˆ†éš”ç¬¦æ¥æå–å¸§çš„é€šç”¨è§£ç å™¨</td>
</tr>
<tr>
<td>LineBasedFrameDecoder</td>
<td>æå–ç”±è¡Œå°¾ç¬¦ï¼ˆ\n æˆ–è€…\r\nï¼‰åˆ†éš”çš„å¸§çš„è§£ç å™¨ã€‚è¿™ä¸ªè§£ç  å™¨æ¯” DelimiterBasedFrameDecoder æ›´å¿«</td>
</tr>
</tbody>
</table>
<p>å›¾ 11-5 å±•ç¤ºäº†å½“å¸§ç”±è¡Œå°¾åºåˆ—\r\nï¼ˆå›è½¦ç¬¦+æ¢è¡Œç¬¦ï¼‰åˆ†éš”æ—¶æ˜¯å¦‚ä½•è¢«å¤„ç†çš„ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/65.png"></p>
<p>ä»£ç æ¸…å• 11-8 å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ LineBasedFrameDecoder æ¥å¤„ç†å›¾ 11-5 æ‰€ç¤ºçš„åœºæ™¯ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-8 å¤„ç†ç”±è¡Œå°¾ç¬¦åˆ†éš”çš„å¸§
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LineBasedHandlerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è¯¥ LineBasedFrameDecoder å°†æå–çš„å¸§è½¬å‘ç»™ä¸‹ä¸€ä¸ª ChannelInboundHandler</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> LineBasedFrameDecoder(64 * 1024));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  FrameHandler ä»¥æ¥æ”¶å¸§</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> FrameHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> FrameHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;ByteBuf&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä¼ å…¥äº†å•ä¸ªå¸§çš„å†…å®¹</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, ByteBuf msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Do something with the data extracted from the frame</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœä½ æ­£åœ¨ä½¿ç”¨é™¤äº†è¡Œå°¾ç¬¦ä¹‹å¤–çš„åˆ†éš”ç¬¦åˆ†éš”çš„å¸§ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä»¥ç±»ä¼¼çš„æ–¹å¼ä½¿ç”¨
DelimiterBasedFrameDecoderï¼Œåªéœ€è¦å°†ç‰¹å®šçš„åˆ†éš”ç¬¦åºåˆ—æŒ‡å®šåˆ°å…¶æ„é€ å‡½æ•°å³å¯ã€‚
è¿™äº›è§£ç å™¨æ˜¯å®ç°ä½ è‡ªå·±çš„åŸºäºåˆ†éš”ç¬¦çš„åè®®çš„å·¥å…·ã€‚ä½œä¸ºç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸‹é¢çš„åè®®è§„èŒƒï¼š</p>
<ul>
<li>ä¼ å…¥æ•°æ®æµæ˜¯ä¸€ç³»åˆ—çš„å¸§ï¼Œæ¯ä¸ªå¸§éƒ½ç”±æ¢è¡Œç¬¦ï¼ˆ\nï¼‰åˆ†éš”ï¼›</li>
<li>æ¯ä¸ªå¸§éƒ½ç”±ä¸€ç³»åˆ—çš„å…ƒç´ ç»„æˆï¼Œæ¯ä¸ªå…ƒç´ éƒ½ç”±å•ä¸ªç©ºæ ¼å­—ç¬¦åˆ†éš”ï¼›</li>
<li>ä¸€ä¸ªå¸§çš„å†…å®¹ä»£è¡¨ä¸€ä¸ªå‘½ä»¤ï¼Œå®šä¹‰ä¸ºä¸€ä¸ªå‘½ä»¤åç§°åè·Ÿç€æ•°ç›®å¯å˜çš„å‚æ•°ã€‚</li>
</ul>
<p>æˆ‘ä»¬ç”¨äºè¿™ä¸ªåè®®çš„è‡ªå®šä¹‰è§£ç å™¨å°†å®šä¹‰ä»¥ä¸‹ç±»ï¼š</p>
<ul>
<li>Cmdâ€”å°†å¸§ï¼ˆå‘½ä»¤ï¼‰çš„å†…å®¹å­˜å‚¨åœ¨ ByteBuf ä¸­ï¼Œä¸€ä¸ª ByteBuf ç”¨äºåç§°ï¼Œå¦ä¸€ä¸ªç”¨äºå‚æ•°ï¼›</li>
<li>CmdDecoderâ€”ä»è¢«é‡å†™äº†çš„ decode()æ–¹æ³•ä¸­è·å–ä¸€è¡Œå­—ç¬¦ä¸²ï¼Œå¹¶ä»å®ƒçš„å†…å®¹æ„å»ºä¸€ä¸ª Cmd çš„å®ä¾‹ï¼›</li>
<li>CmdHandlerâ€”ä» CmdDecoder è·å–è§£ç çš„ Cmd å¯¹è±¡ï¼Œå¹¶å¯¹å®ƒè¿›è¡Œä¸€äº›å¤„ç†ï¼›</li>
<li>CmdHandlerInitializer â€”ä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å°†ä¼šæŠŠå‰é¢çš„è¿™äº›ç±»å®šä¹‰ä¸ºä¸“é—¨çš„ ChannelInitializer çš„åµŒå¥—ç±»ï¼Œå…¶å°†ä¼šæŠŠè¿™äº› ChannelInboundHandler å®‰è£…åˆ° ChannelPipeline ä¸­ã€‚
æ­£å¦‚å°†åœ¨ä»£ç æ¸…å• 11-9 ä¸­æ‰€èƒ½çœ‹åˆ°çš„é‚£æ ·ï¼Œè¿™ä¸ªè§£ç å™¨çš„å…³é”®æ˜¯æ‰©å±• LineBasedFrameDecoderã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-9 ä½¿ç”¨ ChannelInitializer å®‰è£…è§£ç å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CmdHandlerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">byte</span> SPACE = (<span style="color:#fff;font-weight:bold">byte</span>)<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>;
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  CmdDecoder ä»¥æå– Cmd å¯¹è±¡ï¼Œå¹¶å°†å®ƒè½¬å‘ç»™ä¸‹ä¸€ä¸ª ChannelInboundHandler</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> CmdDecoder(64 * 1024));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  CmdHandler ä»¥æ¥æ”¶å’Œå¤„ç† Cmd å¯¹è±¡</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> CmdHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//Cmd POJO</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> Cmd {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ByteBuf name;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ByteBuf args;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> Cmd(ByteBuf name, ByteBuf args) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">name</span> = name;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">args</span> = args;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> ByteBuf name() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> name;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> ByteBuf args() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> args;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> CmdDecoder <span style="color:#fff;font-weight:bold">extends</span> LineBasedFrameDecoder {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> CmdDecoder(<span style="color:#fff;font-weight:bold">int</span> maxLength) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">super</span>(maxLength);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">protected</span> Object decode(ChannelHandlerContext ctx, ByteBuf buffer)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ä» ByteBuf ä¸­æå–ç”±è¡Œå°¾ç¬¦åºåˆ—åˆ†éš”çš„å¸§</span>
</span></span><span style="display:flex;"><span>            ByteBuf frame = (ByteBuf) <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">decode</span>(ctx, buffer);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (frame == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å¦‚æœè¾“å…¥ä¸­æ²¡æœ‰å¸§ï¼Œåˆ™è¿”å› null</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æŸ¥æ‰¾ç¬¬ä¸€ä¸ªç©ºæ ¼å­—ç¬¦çš„ç´¢å¼•ã€‚å‰é¢æ˜¯å‘½ä»¤åç§°ï¼Œæ¥ç€æ˜¯å‚æ•°</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> index = frame.<span style="color:#007f7f">indexOf</span>(frame.<span style="color:#007f7f">readerIndex</span>(),
</span></span><span style="display:flex;"><span>                    frame.<span style="color:#007f7f">writerIndex</span>(), SPACE);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ä½¿ç”¨åŒ…å«æœ‰å‘½ä»¤åç§°å’Œå‚æ•°çš„åˆ‡ç‰‡åˆ›å»ºæ–°çš„ Cmd å¯¹è±¡</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> Cmd(frame.<span style="color:#007f7f">slice</span>(frame.<span style="color:#007f7f">readerIndex</span>(), index),
</span></span><span style="display:flex;"><span>                    frame.<span style="color:#007f7f">slice</span>(index + 1, frame.<span style="color:#007f7f">writerIndex</span>()));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> CmdHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;Cmd&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, Cmd msg)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Do something with the command</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¤„ç†ä¼ ç» ChannelPipeline çš„ Cmd å¯¹è±¡</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="åŸºäºé•¿åº¦çš„åè®®">åŸºäºé•¿åº¦çš„åè®®<a hidden class="anchor" aria-hidden="true" href="#åŸºäºé•¿åº¦çš„åè®®">#</a></h3>
<p>åŸºäºé•¿åº¦çš„åè®®é€šè¿‡å°†å®ƒçš„é•¿åº¦ç¼–ç åˆ°å¸§çš„å¤´éƒ¨æ¥å®šä¹‰å¸§ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç‰¹æ®Šçš„åˆ†éš”ç¬¦æ¥æ ‡è®°å®ƒçš„ç»“æŸã€‚(å¯¹äºå›ºå®šå¸§å¤§å°çš„åè®®æ¥è¯´ï¼Œä¸éœ€è¦å°†å¸§é•¿åº¦ç¼–ç åˆ°å¤´éƒ¨)
è¡¨ 11-6 åˆ—å‡ºäº†Nettyæä¾›çš„ç”¨äºå¤„ç†è¿™ç§ç±»å‹çš„åè®®çš„ä¸¤ç§è§£ç å™¨ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>FixedLengthFrameDecoder</td>
<td>æå–åœ¨è°ƒç”¨æ„é€ å‡½æ•°æ—¶æŒ‡å®šçš„å®šé•¿å¸§</td>
</tr>
<tr>
<td>LengthFieldBasedFrameDecoder</td>
<td>æ ¹æ®ç¼–ç è¿›å¸§å¤´éƒ¨ä¸­çš„é•¿åº¦å€¼æå–å¸§ï¼›è¯¥å­—æ®µçš„åç§»é‡ä»¥åŠ é•¿åº¦åœ¨æ„é€ å‡½æ•°ä¸­æŒ‡å®š</td>
</tr>
</tbody>
</table>
<p>å›¾ 11-6 å±•ç¤ºäº† FixedLengthFrameDecoder çš„åŠŸèƒ½ï¼Œå…¶åœ¨æ„é€ æ—¶å·²ç»æŒ‡å®šäº†å¸§é•¿åº¦ä¸º 8å­—èŠ‚ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/66.png"></p>
<p>ä½ å°†ç»å¸¸ä¼šé‡åˆ°è¢«ç¼–ç åˆ°æ¶ˆæ¯å¤´éƒ¨çš„å¸§å¤§å°ä¸æ˜¯å›ºå®šå€¼çš„åè®®ã€‚ä¸ºäº†å¤„ç†è¿™ç§å˜é•¿å¸§ï¼Œä½ å¯ä»¥ä½¿ç”¨
LengthFieldBasedFrameDecoderï¼Œå®ƒå°†ä»å¤´éƒ¨å­—æ®µç¡®å®šå¸§é•¿ï¼Œç„¶åä»æ•°æ®æµä¸­æå–æŒ‡å®šçš„å­—èŠ‚æ•°ã€‚
å›¾ 11-7 å±•ç¤ºäº†ä¸€ä¸ªç¤ºä¾‹ï¼Œå…¶ä¸­é•¿åº¦å­—æ®µåœ¨å¸§ä¸­çš„åç§»é‡ä¸º 0ï¼Œå¹¶ä¸”é•¿åº¦ä¸º 2 å­—èŠ‚ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/67.png"></p>
<p>LengthFieldBasedFrameDecoder æä¾›äº†å‡ ä¸ªæ„é€ å‡½æ•°æ¥æ”¯æŒå„ç§å„æ ·çš„å¤´éƒ¨é…ç½®æƒ…å†µã€‚ä»£ç æ¸…å• 11-10 å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨å…¶ 3 ä¸ªæ„é€ å‚æ•°åˆ†åˆ«ä¸º maxFrameLengthã€lengthFieldOffset å’Œ lengthFieldLength çš„æ„é€ å‡½æ•°ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œå¸§çš„é•¿åº¦è¢«ç¼–ç åˆ°äº†å¸§èµ·å§‹çš„å‰8 ä¸ªå­—èŠ‚ä¸­ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-10 ä½¿ç”¨ LengthFieldBasedFrameDecoder è§£ç å™¨åŸºäºé•¿åº¦çš„åè®®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LengthBasedInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//ä½¿ç”¨ LengthFieldBasedFrameDecoder è§£ç å°†å¸§é•¿åº¦ç¼–ç åˆ°å¸§èµ·å§‹çš„å‰ 8 ä¸ªå­—èŠ‚ä¸­çš„æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> LengthFieldBasedFrameDecoder(64 * 1024, 0, 8));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  FrameHandler ä»¥å¤„ç†æ¯ä¸ªå¸§</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> FrameHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> FrameHandler <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;ByteBuf&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, ByteBuf msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Do something with the frame</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¤„ç†å¸§çš„æ•°æ®</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½ ç°åœ¨å·²ç»çœ‹åˆ°äº† Netty æä¾›çš„ï¼Œç”¨äºæ”¯æŒé‚£äº›é€šè¿‡æŒ‡å®šåè®®å¸§çš„åˆ†éš”ç¬¦æˆ–è€…é•¿åº¦ï¼ˆå›ºå®šçš„æˆ–è€…å¯å˜çš„ï¼‰ä»¥å®šä¹‰å­—èŠ‚æµçš„ç»“æ„çš„åè®®çš„ç¼–è§£ç å™¨ã€‚ä½ å°†ä¼šå‘ç°è¿™äº›ç¼–è§£ç å™¨çš„è®¸å¤šç”¨é€”ï¼Œå› ä¸ºè®¸å¤šçš„å¸¸è§åè®®éƒ½è½åˆ°äº†è¿™äº›åˆ†ç±»ä¹‹ä¸€ä¸­ã€‚</p>
<h2 id="å†™å¤§å‹æ•°æ®">å†™å¤§å‹æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#å†™å¤§å‹æ•°æ®">#</a></h2>
<p>å› ä¸ºç½‘ç»œé¥±å’Œçš„å¯èƒ½æ€§ï¼Œå¦‚ä½•åœ¨å¼‚æ­¥æ¡†æ¶ä¸­é«˜æ•ˆåœ°å†™å¤§å—çš„æ•°æ®æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é—®é¢˜ã€‚ç”±äºå†™æ“ä½œæ˜¯éé˜»å¡çš„ï¼Œæ‰€ä»¥å³ä½¿æ²¡æœ‰å†™å‡ºæ‰€æœ‰çš„æ•°æ®ï¼Œå†™æ“ä½œä¹Ÿä¼šåœ¨å®Œæˆæ—¶è¿”å›å¹¶é€šçŸ¥ ChannelFutureã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œå¦‚æœä»ç„¶ä¸åœåœ°å†™å…¥ï¼Œå°±æœ‰å†…å­˜è€—å°½çš„é£é™©ã€‚æ‰€ä»¥åœ¨å†™å¤§å‹æ•°æ®æ—¶ï¼Œéœ€è¦å‡†å¤‡å¥½å¤„ç†åˆ°è¿œç¨‹èŠ‚ç‚¹çš„è¿æ¥æ˜¯æ…¢é€Ÿè¿æ¥çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¼šå¯¼è‡´å†…å­˜é‡Šæ”¾çš„å»¶è¿Ÿã€‚è®©æˆ‘ä»¬è€ƒè™‘ä¸‹å°†ä¸€ä¸ªæ–‡ä»¶å†…å®¹å†™å‡ºåˆ°ç½‘ç»œçš„æƒ…å†µã€‚
åœ¨æˆ‘ä»¬è®¨è®ºä¼ è¾“ï¼ˆè§ 4.2 èŠ‚ï¼‰çš„è¿‡ç¨‹ä¸­ï¼Œæåˆ°äº† NIO çš„é›¶æ‹·è´ç‰¹æ€§ï¼Œè¿™ç§ç‰¹æ€§æ¶ˆé™¤äº†å°†æ–‡ä»¶çš„å†…å®¹ä»æ–‡ä»¶ç³»ç»Ÿç§»åŠ¨åˆ°ç½‘ç»œæ ˆçš„å¤åˆ¶è¿‡ç¨‹ã€‚æ‰€æœ‰çš„è¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨ Netty çš„æ ¸å¿ƒä¸­ï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºæ‰€æœ‰éœ€è¦åšçš„å°±æ˜¯ä½¿ç”¨ä¸€ä¸ª FileRegion æ¥å£çš„å®ç°ï¼Œå…¶åœ¨ Netty çš„ API æ–‡æ¡£ä¸­çš„å®šä¹‰æ˜¯ï¼š
â€œé€šè¿‡æ”¯æŒé›¶æ‹·è´çš„æ–‡ä»¶ä¼ è¾“çš„ Channel æ¥å‘é€çš„æ–‡ä»¶åŒºåŸŸã€‚â€
ä»£ç æ¸…å• 11-11 å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ä»FileInputStreamåˆ›å»ºä¸€ä¸ªDefaultFileRegionï¼Œå¹¶å°†å…¶å†™å…¥Channelã€‚ï¼ˆæˆ‘ä»¬ç”šè‡³å¯ä»¥åˆ©ç”¨ io.netty.channel.ChannelProgressivePromise æ¥å®æ—¶è·å–ä¼ è¾“çš„è¿›åº¦ï¼‰ï¼Œä»è€Œåˆ©ç”¨é›¶æ‹·è´ç‰¹æ€§æ¥ä¼ è¾“ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * Created by kerr.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-11 ä½¿ç”¨ FileRegion ä¼ è¾“æ–‡ä»¶çš„å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FileRegionWriteHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> Channel CHANNEL_FROM_SOMEWHERE = <span style="color:#fff;font-weight:bold">new</span> NioSocketChannel();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> File FILE_FROM_SOMEWHERE = <span style="color:#fff;font-weight:bold">new</span> File(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(<span style="color:#fff;font-weight:bold">final</span> ChannelHandlerContext ctx) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        File file = FILE_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference from somewhere</span>
</span></span><span style="display:flex;"><span>        Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference from somewhere</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ª FileInputStream</span>
</span></span><span style="display:flex;"><span>        FileInputStream in = <span style="color:#fff;font-weight:bold">new</span> FileInputStream(file);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä»¥è¯¥æ–‡ä»¶çš„å®Œæ•´é•¿åº¦åˆ›å»ºä¸€ä¸ªæ–°çš„ DefaultFileRegion</span>
</span></span><span style="display:flex;"><span>        FileRegion region = <span style="color:#fff;font-weight:bold">new</span> DefaultFileRegion(
</span></span><span style="display:flex;"><span>                in.<span style="color:#007f7f">getChannel</span>(), 0, file.<span style="color:#007f7f">length</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å‘é€è¯¥ DefaultFileRegionï¼Œå¹¶æ³¨å†Œä¸€ä¸ª ChannelFutureListener</span>
</span></span><span style="display:flex;"><span>        channel.<span style="color:#007f7f">writeAndFlush</span>(region).<span style="color:#007f7f">addListener</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture future)
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">if</span> (!future.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                   <span style="color:#007f7f">//å¤„ç†å¤±è´¥</span>
</span></span><span style="display:flex;"><span>                   Throwable cause = future.<span style="color:#007f7f">cause</span>();
</span></span><span style="display:flex;"><span>                   <span style="color:#007f7f">// Do something</span>
</span></span><span style="display:flex;"><span>               }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªç¤ºä¾‹åªé€‚ç”¨äºæ–‡ä»¶å†…å®¹çš„ç›´æ¥ä¼ è¾“ï¼Œä¸åŒ…æ‹¬åº”ç”¨ç¨‹åºå¯¹æ•°æ®çš„ä»»ä½•å¤„ç†ã€‚åœ¨éœ€è¦å°†æ•°æ®ä»æ–‡ä»¶ç³»ç»Ÿå¤åˆ¶åˆ°ç”¨æˆ·å†…å­˜ä¸­æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ ChunkedWriteHandlerï¼Œå®ƒæ”¯æŒå¼‚æ­¥å†™å¤§å‹æ•°æ®æµï¼Œè€Œåˆä¸ä¼šå¯¼è‡´å¤§é‡çš„å†…å­˜æ¶ˆè€—ã€‚å…³é”®æ˜¯ <code>interface ChunkedInput&lt;B&gt;</code>ï¼Œå…¶ä¸­ç±»å‹å‚æ•° B æ˜¯ readChunk()æ–¹æ³•è¿”å›çš„ç±»å‹ã€‚Netty é¢„ç½®äº†è¯¥æ¥å£çš„ 4 ä¸ªå®ç°ï¼Œå¦‚è¡¨ 11-7 ä¸­æ‰€åˆ—å‡ºçš„ã€‚æ¯ä¸ªéƒ½ä»£è¡¨äº†ä¸€ä¸ªå°†ç”± ChunkedWriteHandler å¤„ç†çš„ä¸å®šé•¿åº¦çš„æ•°æ®æµã€‚
ä»£ç æ¸…å• 11-12 è¯´æ˜äº† ChunkedStream çš„ç”¨æ³•ï¼Œå®ƒæ˜¯å®è·µä¸­æœ€å¸¸ç”¨çš„å®ç°ã€‚æ‰€ç¤ºçš„ç±»ä½¿ç”¨äº†ä¸€ä¸ªFile ä»¥åŠä¸€ä¸ª SslContext è¿›è¡Œå®ä¾‹åŒ–ã€‚å½“ initChannel()æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®ƒå°†ä½¿ç”¨æ‰€ç¤ºçš„ ChannelHandler é“¾åˆå§‹åŒ–è¯¥ Channelã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>ChunkedFile</td>
<td>ä»æ–‡ä»¶ä¸­é€å—è·å–æ•°æ®ï¼Œå½“ä½ çš„å¹³å°ä¸æ”¯æŒé›¶æ‹·è´æˆ–è€…ä½ éœ€è¦è½¬æ¢æ•°æ®æ—¶ä½¿ç”¨</td>
</tr>
<tr>
<td>ChunkedNioFile</td>
<td>å’Œ ChunkedFile ç±»ä¼¼ï¼Œåªæ˜¯å®ƒä½¿ç”¨äº† FileChannel</td>
</tr>
<tr>
<td>ChunkedStream</td>
<td>ä» InputStream ä¸­é€å—ä¼ è¾“å†…å®¹</td>
</tr>
<tr>
<td>ChunkedNioStream</td>
<td>ä» ReadableByteChannel ä¸­é€å—ä¼ è¾“å†…å®¹</td>
</tr>
</tbody>
</table>
<p>å½“ Channel çš„çŠ¶æ€å˜ä¸ºæ´»åŠ¨çš„æ—¶ï¼ŒWriteStreamHandler å°†ä¼šé€å—åœ°æŠŠæ¥è‡ªæ–‡ä»¶ä¸­çš„æ•°æ®ä½œä¸º
ChunkedStream å†™å…¥ã€‚æ•°æ®åœ¨ä¼ è¾“ä¹‹å‰å°†ä¼šç”± SslHandler åŠ å¯†ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-12 ä½¿ç”¨ ChunkedStream ä¼ è¾“æ–‡ä»¶å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ChunkedWriteHandlerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> File file;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SslContext sslCtx;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ChunkedWriteHandlerInitializer(File file, SslContext sslCtx) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">file</span> = file;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">sslCtx</span> = sslCtx;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°† SslHandler æ·»åŠ åˆ° ChannelPipeline ä¸­</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> SslHandler(sslCtx.<span style="color:#007f7f">newEngine</span>(ch.<span style="color:#007f7f">alloc</span>())));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  ChunkedWriteHandler ä»¥å¤„ç†ä½œä¸º ChunkedInput ä¼ å…¥çš„æ•°æ®</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ChunkedWriteHandler());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä¸€æ—¦è¿æ¥å»ºç«‹ï¼ŒWriteStreamHandler å°±å¼€å§‹å†™æ–‡ä»¶æ•°æ®</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> WriteStreamHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> WriteStreamHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å½“è¿æ¥å»ºç«‹æ—¶ï¼ŒchannelActive() æ–¹æ³•å°†ä½¿ç”¨ ChunkedInput å†™æ–‡ä»¶æ•°æ®</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(ChannelHandlerContext ctx)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">channelActive</span>(ctx);
</span></span><span style="display:flex;"><span>            ctx.<span style="color:#007f7f">writeAndFlush</span>(<span style="color:#fff;font-weight:bold">new</span> ChunkedStream(<span style="color:#fff;font-weight:bold">new</span> FileInputStream(file)));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€å—è¾“å…¥ï¼šè¦ä½¿ç”¨ä½ è‡ªå·±çš„ ChunkedInput å®ç°ï¼Œè¯·åœ¨ ChannelPipeline ä¸­å®‰è£…ä¸€ä¸ªChunkedWriteHandlerã€‚
åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†å¦‚ä½•é€šè¿‡ä½¿ç”¨é›¶æ‹·è´ç‰¹æ€§æ¥é«˜æ•ˆåœ°ä¼ è¾“æ–‡ä»¶ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ä½¿ç”¨
ChunkedWriteHandler æ¥å†™å¤§å‹æ•°æ®è€Œåˆä¸å¿…å†’ç€å¯¼è‡´ OutOfMemoryError çš„é£é™©ã€‚
åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»”ç»†ç ”ç©¶å‡ ç§åºåˆ—åŒ– POJO çš„æ–¹æ³•ã€‚</p>
<h2 id="åºåˆ—åŒ–æ•°æ®">åºåˆ—åŒ–æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#åºåˆ—åŒ–æ•°æ®">#</a></h2>
<p>JDK æä¾›äº† ObjectOutputStream å’Œ ObjectInputStreamï¼Œç”¨äºé€šè¿‡ç½‘ç»œå¯¹ POJO çš„åŸºæœ¬æ•°æ®ç±»å‹å’Œå›¾è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚è¯¥ API å¹¶ä¸å¤æ‚ï¼Œè€Œä¸”å¯ä»¥è¢«åº”ç”¨äºä»»ä½•å®ç°äº†java.io.Serializable æ¥å£çš„å¯¹è±¡ã€‚ä½†æ˜¯å®ƒçš„æ€§èƒ½ä¹Ÿä¸æ˜¯éå¸¸é«˜æ•ˆçš„ã€‚åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ° Netty å¿…é¡»ä¸ºæ­¤æä¾›ä»€ä¹ˆã€‚</p>
<h3 id="jdk-åºåˆ—åŒ–">JDK åºåˆ—åŒ–<a hidden class="anchor" aria-hidden="true" href="#jdk-åºåˆ—åŒ–">#</a></h3>
<p>å¦‚æœä½ çš„åº”ç”¨ç¨‹åºå¿…é¡»è¦å’Œä½¿ç”¨äº†ObjectOutputStreamå’ŒObjectInputStreamçš„è¿œç¨‹èŠ‚ç‚¹äº¤äº’ï¼Œå¹¶ä¸”å…¼å®¹æ€§ä¹Ÿæ˜¯ä½ æœ€å…³å¿ƒçš„ï¼Œé‚£ä¹ˆJDKåºåˆ—åŒ–å°†æ˜¯æ­£ç¡®çš„é€‰æ‹©è¡¨ã€‚
11-8 ä¸­åˆ—å‡ºäº†Nettyæä¾›çš„ç”¨äºå’ŒJDKè¿›è¡Œäº’æ“ä½œçš„åºåˆ—åŒ–ç±»ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>CompatibleObjectDecoder(å·²åºŸå¼ƒ)</td>
<td>å’Œä½¿ç”¨ JDK åºåˆ—åŒ–çš„éåŸºäº Netty çš„è¿œç¨‹èŠ‚ç‚¹è¿›è¡Œäº’æ“ä½œçš„è§£ç å™¨</td>
</tr>
<tr>
<td>CompatibleObjectEncoder</td>
<td>å’Œä½¿ç”¨ JDK åºåˆ—åŒ–çš„éåŸºäº Netty çš„è¿œç¨‹èŠ‚ç‚¹è¿›è¡Œäº’æ“ä½œçš„ç¼–ç å™¨</td>
</tr>
<tr>
<td>ObjectDecoder</td>
<td>æ„å»ºäº JDK åºåˆ—åŒ–ä¹‹ä¸Šçš„ä½¿ç”¨è‡ªå®šä¹‰çš„åºåˆ—åŒ–æ¥è§£ç çš„è§£ç å™¨ï¼›å½“ æ²¡æœ‰å…¶ä»–çš„å¤–éƒ¨ä¾èµ–æ—¶ï¼Œå®ƒæä¾›äº†é€Ÿåº¦ä¸Šçš„æ”¹è¿›ã€‚å¦åˆ™å…¶ä»–çš„åºåˆ—åŒ– å®ç°æ›´åŠ å¯å–</td>
</tr>
<tr>
<td>ObjectEncoder</td>
<td>æ„å»ºäº JDK åºåˆ—åŒ–ä¹‹ä¸Šçš„ä½¿ç”¨è‡ªå®šä¹‰çš„åºåˆ—åŒ–æ¥ç¼–ç çš„ç¼–ç å™¨ï¼›å½“ æ²¡æœ‰å…¶ä»–çš„å¤–éƒ¨ä¾èµ–æ—¶ï¼Œå®ƒæä¾›äº†é€Ÿåº¦ä¸Šçš„æ”¹è¿›ã€‚å¦åˆ™å…¶ä»–çš„åºåˆ—åŒ– å®ç°æ›´åŠ å¯å–</td>
</tr>
</tbody>
</table>
<h3 id="ä½¿ç”¨-jboss-marshalling-è¿›è¡Œåºåˆ—åŒ–">ä½¿ç”¨ JBoss Marshalling è¿›è¡Œåºåˆ—åŒ–<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨-jboss-marshalling-è¿›è¡Œåºåˆ—åŒ–">#</a></h3>
<p>å¦‚æœä½ å¯ä»¥è‡ªç”±åœ°ä½¿ç”¨å¤–éƒ¨ä¾èµ–ï¼Œé‚£ä¹ˆJBoss Marshallingå°†æ˜¯ä¸ªç†æƒ³çš„é€‰æ‹©ï¼šå®ƒæ¯”JDKåºåˆ—åŒ–æœ€å¤šå¿« 3 å€ï¼Œè€Œä¸”ä¹Ÿæ›´åŠ ç´§å‡‘ã€‚åœ¨JBoss Marshallingå®˜æ–¹ç½‘ç«™ä¸»é¡µä¸Šçš„æ¦‚è¿°ä¸­å¯¹å®ƒæ˜¯è¿™ä¹ˆå®šä¹‰çš„ï¼š
JBoss Marshalling æ˜¯ä¸€ç§å¯é€‰çš„åºåˆ—åŒ– APIï¼Œå®ƒä¿®å¤äº†åœ¨ JDK åºåˆ—åŒ– API ä¸­æ‰€å‘ç°çš„è®¸å¤šé—®é¢˜ï¼ŒåŒæ—¶ä¿ç•™äº†ä¸ java.io.Serializable åŠå…¶ç›¸å…³ç±»çš„å…¼å®¹æ€§ï¼Œå¹¶æ·»åŠ äº†å‡ ä¸ªæ–°çš„å¯è°ƒä¼˜å‚æ•°ä»¥åŠé¢å¤–çš„ç‰¹æ€§ï¼Œæ‰€æœ‰çš„è¿™äº›éƒ½æ˜¯å¯ä»¥é€šè¿‡å·¥å‚é…ç½®ï¼ˆå¦‚å¤–éƒ¨åºåˆ—åŒ–å™¨ã€ç±»/å®ä¾‹æŸ¥æ‰¾è¡¨ã€ç±»è§£æä»¥åŠå¯¹è±¡æ›¿æ¢ç­‰ï¼‰å®ç°å¯æ’æ‹”çš„ã€‚
Netty é€šè¿‡è¡¨ 11-9 æ‰€ç¤ºçš„ä¸¤ç»„è§£ç å™¨/ç¼–ç å™¨å¯¹ä¸º Boss Marshalling æä¾›äº†æ”¯æŒã€‚ç¬¬ä¸€ç»„å…¼å®¹åªä½¿ç”¨ JDK åºåˆ—åŒ–çš„è¿œç¨‹èŠ‚ç‚¹ã€‚ç¬¬äºŒç»„æä¾›äº†æœ€å¤§çš„æ€§èƒ½ï¼Œé€‚ç”¨äºå’Œä½¿ç”¨ JBoss Marshalling çš„è¿œç¨‹èŠ‚ç‚¹ä¸€èµ·ä½¿ç”¨ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>CompatibleMarshallingDecoder CompatibleMarshallingEncoder</td>
<td>ä¸åªä½¿ç”¨ JDK åºåˆ—åŒ–çš„è¿œç¨‹èŠ‚ç‚¹å…¼å®¹</td>
</tr>
<tr>
<td>MarshallingDecoder MarshallingEncoder</td>
<td>é€‚ç”¨äºä½¿ç”¨ JBoss Marshalling çš„èŠ‚ç‚¹ã€‚è¿™äº›ç±»å¿…é¡»ä¸€èµ·ä½¿ç”¨</td>
</tr>
</tbody>
</table>
<p>ä»£ç æ¸…å• 11-13 å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ MarshallingDecoder å’Œ MarshallingEncoderã€‚åŒæ ·ï¼Œå‡ ä¹åªæ˜¯é€‚å½“åœ°é…ç½® ChannelPipeline ç½¢äº†ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-13 ä½¿ç”¨ JBoss Marshalling
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MarshallingInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> MarshallerProvider marshallerProvider;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> UnmarshallerProvider unmarshallerProvider;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> MarshallingInitializer(UnmarshallerProvider unmarshallerProvider,
</span></span><span style="display:flex;"><span>            MarshallerProvider marshallerProvider) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">marshallerProvider</span> = marshallerProvider;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">unmarshallerProvider</span> = unmarshallerProvider;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel channel) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = channel.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  MarshallingDecoder ä»¥å°† ByteBuf è½¬æ¢ä¸º POJO</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> MarshallingDecoder(unmarshallerProvider));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  MarshallingEncoder ä»¥å°†POJO è½¬æ¢ä¸º ByteBuf</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> MarshallingEncoder(marshallerProvider));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  ObjectHandlerï¼Œä»¥å¤„ç†æ™®é€šçš„å®ç°äº†Serializable æ¥å£çš„ POJO</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ObjectHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ObjectHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;Serializable&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>            ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>            Serializable serializable) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Do something</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="é€šè¿‡-protocol-buffers-åºåˆ—åŒ–">é€šè¿‡ Protocol Buffers åºåˆ—åŒ–<a hidden class="anchor" aria-hidden="true" href="#é€šè¿‡-protocol-buffers-åºåˆ—åŒ–">#</a></h3>
<p>Nettyåºåˆ—åŒ–çš„æœ€åä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯åˆ©ç”¨Protocol Buffersçš„ç¼–è§£ç å™¨ï¼Œå®ƒæ˜¯ä¸€ç§ç”±Googleå…¬å¸å¼€å‘çš„ã€ç°åœ¨å·²ç»å¼€æºçš„æ•°æ®äº¤æ¢æ ¼å¼ã€‚å¯ä»¥åœ¨https://github.com/google/protobufæ‰¾åˆ°æºä»£ç ã€‚
Protocol Buffers ä»¥ä¸€ç§ç´§å‡‘è€Œé«˜æ•ˆçš„æ–¹å¼å¯¹ç»“æ„åŒ–çš„æ•°æ®è¿›è¡Œç¼–ç ä»¥åŠè§£ç ã€‚å®ƒå…·æœ‰è®¸å¤šçš„ç¼–ç¨‹è¯­è¨€ç»‘å®šï¼Œä½¿å¾—å®ƒå¾ˆé€‚åˆè·¨è¯­è¨€çš„é¡¹ç›®ã€‚è¡¨ 11-10 å±•ç¤ºäº† Netty ä¸ºæ”¯æŒ protobuf æ‰€æä¾›çš„ChannelHandler å®ç°ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>ProtobufDecoder</td>
<td>ä½¿ç”¨ protobuf å¯¹æ¶ˆæ¯è¿›è¡Œè§£ç </td>
</tr>
<tr>
<td>ProtobufEncoder</td>
<td>ä½¿ç”¨ protobuf å¯¹æ¶ˆæ¯è¿›è¡Œç¼–ç </td>
</tr>
<tr>
<td>ProtobufVarint32FrameDecoder</td>
<td>æ ¹æ®æ¶ˆæ¯ä¸­çš„ Google Protocol Buffers çš„â€œBase 128 Varintsâ€æ•´å‹é•¿åº¦å­—æ®µå€¼åŠ¨æ€åœ°åˆ†å‰²æ‰€æ¥æ”¶åˆ°çš„ ByteBuf</td>
</tr>
<tr>
<td>ProtobufVarint32LengthFieldPrepender</td>
<td>å‘ ByteBuf å‰è¿½åŠ ä¸€ä¸ª Google Protocal Buffers çš„â€œBase 128 Varintsâ€æ•´å‹çš„é•¿åº¦å­—æ®µå€¼</td>
</tr>
</tbody>
</table>
<p>ä½¿ç”¨ protobufåªéœ€è¦å°†æ­£ç¡®çš„ ChannelHandler æ·»åŠ åˆ° ChannelPipeline ä¸­ï¼Œå¦‚ä»£ç æ¸…å• 11-14 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 11-14 ä½¿ç”¨ protobuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ProtoBufInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> MessageLite lite;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ProtoBufInitializer(MessageLite lite) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">lite</span> = lite;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  ProtobufVarint32FrameDecoder ä»¥åˆ†éš”å¸§</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ProtobufVarint32FrameDecoder());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  ProtobufEncoder ä»¥å¤„ç†æ¶ˆæ¯çš„ç¼–ç </span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ProtobufEncoder());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  ProtobufDecoder ä»¥è§£ç æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ProtobufDecoder(lite));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ  ObjectHandler ä»¥å¤„ç†è§£ç æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ObjectHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ObjectHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;Object&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, Object msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Do something with the object</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ¢è®¨äº†ç”± Netty ä¸“é—¨çš„è§£ç å™¨å’Œç¼–ç å™¨æ‰€æ”¯æŒçš„ä¸åŒçš„åºåˆ—åŒ–é€‰é¡¹ï¼š
æ ‡å‡†JDK åºåˆ—åŒ–ã€JBoss Marshalling ä»¥åŠ Google çš„ Protocol Buffersã€‚</p>
<h2 id="å°ç»“-4">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“-4">#</a></h2>
<p>Netty æä¾›çš„ç¼–è§£ç å™¨ä»¥åŠå„ç§ ChannelHandler å¯ä»¥è¢«ç»„åˆå’Œæ‰©å±•ï¼Œä»¥å®ç°éå¸¸å¹¿æ³›çš„å¤„ç†æ–¹æ¡ˆã€‚
æ­¤å¤–ï¼Œå®ƒä»¬ä¹Ÿæ˜¯è¢«è®ºè¯çš„ã€å¥å£®çš„ç»„ä»¶ï¼Œå·²ç»è¢«è®¸å¤šçš„å¤§å‹ç³»ç»Ÿæ‰€ä½¿ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åªæ¶µç›–äº†æœ€å¸¸è§çš„ç¤ºä¾‹ï¼›Netty çš„ API æ–‡æ¡£æä¾›äº†æ›´åŠ å…¨é¢çš„è¦†ç›–ã€‚åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦ä¸€ç§å…ˆè¿›çš„åè®®ï¼šWebSocketï¼Œå®ƒè¢«å¼€å‘ç”¨ä»¥æ”¹è¿› Web åº”ç”¨ç¨‹åºçš„æ€§èƒ½ä»¥åŠå“åº”æ€§ã€‚Netty æä¾›äº†ä½ å°†ä¼šéœ€è¦çš„å·¥å…·ï¼Œä»¥ä¾¿ä½ å¿«é€Ÿã€è½»æ¾åœ°åˆ©ç”¨å®ƒå¼ºå¤§çš„åŠŸèƒ½ã€‚</p>
<h1 id="websocket-1">WebSocket<a hidden class="anchor" aria-hidden="true" href="#websocket-1">#</a></h1>
<p>WebSocket æ˜¯ä¸€ç§ä¸ºäº†æé«˜ Web åº”ç”¨ç¨‹åºçš„æ€§èƒ½ä»¥åŠå“åº”æ€§è€Œå¼€å‘çš„å…ˆè¿›çš„ç½‘ç»œåè®®ã€‚æˆ‘ä»¬å°†é€šè¿‡ç¼–å†™ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºæ¥æ¢ç´¢ Netty å¯¹å®ƒä»¬çš„æ”¯æŒã€‚åœ¨ç¬¬ 12 ç« ä¸­ï¼Œé€šè¿‡æ„å»ºä¸€ä¸ªå¯ä»¥åœ¨å¤šä¸ªæµè§ˆå™¨å®¢æˆ·ç«¯ä¹‹é—´è¿›è¡Œå®æ—¶é€šä¿¡çš„èŠå¤©å®¤ï¼Œä½ å°†å­¦ä¹ åˆ°å¦‚ä½•ä½¿ç”¨ WebSocket æ¥å®ç°åŒå‘æ•°æ®ä¼ è¾“ã€‚ä½ è¿˜å°†ä¼šçœ‹åˆ°å¦‚ä½•åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­é€šè¿‡æ£€æµ‹å®¢æˆ·ç«¯æ˜¯å¦æ”¯æŒ WebSocket åè®®ï¼Œä»è€Œä» HTTP åè®®åˆ‡æ¢åˆ°WebSocket åè®®ã€‚é€šè¿‡å¯¹ç¬¬ 13 ç« ä¸­ Netty å¯¹äºç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼ˆUDPï¼‰çš„æ”¯æŒçš„å­¦ä¹ ï¼Œæˆ‘ä»¬å°†ç»“æŸç¬¬ä¸‰éƒ¨åˆ†ã€‚åœ¨è¿™ä¸€ç« ä¸­ï¼Œä½ å°†ä¼šæ„å»ºå¯é€‚ç”¨äºå¤šç§å®é™…ç”¨é€”çš„å¹¿æ’­æœåŠ¡å™¨å’Œç›‘è§†å™¨å®¢æˆ·ç«¯ã€‚</p>
<p>å¦‚æœä½ æœ‰è·Ÿè¿› Web æŠ€æœ¯çš„æœ€æ–°è¿›å±•ï¼Œä½ å¾ˆå¯èƒ½å°±é‡åˆ°è¿‡â€œå®æ—¶ Webâ€è¿™ä¸ªçŸ­è¯­ï¼Œè€Œå¦‚æœä½ åœ¨å·¥ç¨‹é¢†åŸŸä¸­æœ‰å®æ—¶åº”ç”¨ç¨‹åºçš„å®æˆ˜ç»éªŒï¼Œé‚£ä¹ˆä½ å¯èƒ½æœ‰ç‚¹æ€€ç–‘è¿™ä¸ªæœ¯è¯­åˆ°åº•æ„å‘³ç€ä»€ä¹ˆã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬é¦–å…ˆæ¾„æ¸…ï¼Œè¿™é‡Œå¹¶ä¸æ˜¯æŒ‡æ‰€è°“çš„ç¡¬å®æ—¶æœåŠ¡è´¨é‡ï¼ˆQoSï¼‰ï¼Œç¡¬å®æ—¶æœåŠ¡è´¨é‡æ˜¯ä¿è¯è®¡ç®—ç»“æœå°†åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…è¢«é€’äº¤ã€‚ä»…HTTP çš„è¯·æ±‚/å“åº”æ¨¡å¼è®¾è®¡å°±ä½¿å¾—å…¶å¾ˆéš¾è¢«æ”¯æŒï¼Œä»è¿‡å»æ‰€è®¾è®¡çš„å„ç§æ–¹æ¡ˆä¸­éƒ½æ²¡æœ‰æä¾›ä¸€ç§èƒ½å¤Ÿæä¾›ä»¤äººæ»¡æ„çš„è§£å†³æ–¹æ¡ˆçš„äº‹å®ä¸­ä¾¿å¯è§ä¸€æ–‘ã€‚è™½ç„¶å·²ç»æœ‰äº†ä¸€äº›å…³äºæ­£å¼å®šä¹‰å®æ—¶WebæœåŠ¡è¯­ä¹‰çš„å­¦æœ¯è®¨è®ºï¼Œä½†æ˜¯è¢«æ™®éæ¥å—çš„å®šä¹‰ä¼¼ä¹è¿˜æœªå‡ºç°ã€‚å› æ­¤ç°åœ¨æˆ‘ä»¬å°†é‡‡çº³ä¸‹é¢æ¥è‡ªç»´åŸºç™¾ç§‘çš„éæƒå¨æ€§æè¿°ï¼š
å®æ—¶ Web åˆ©ç”¨æŠ€æœ¯å’Œå®è·µï¼Œä½¿ç”¨æˆ·åœ¨ä¿¡æ¯çš„ä½œè€…å‘å¸ƒä¿¡æ¯ä¹‹åå°±èƒ½å¤Ÿç«‹å³æ”¶åˆ°ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦ä»–ä»¬æˆ–è€…ä»–ä»¬çš„è½¯ä»¶å‘¨æœŸæ€§åœ°æ£€æŸ¥ä¿¡æ¯æºä»¥è·å–æ›´æ–°ã€‚
ç®€è€Œè¨€ä¹‹ï¼Œè™½ç„¶å…¨é¢çš„å®æ—¶Webå¯èƒ½å¹¶ä¸ä¼šé©¬ä¸Šåˆ°æ¥ï¼Œä½†æ˜¯å®ƒèƒŒåçš„æƒ³æ³•å´åŠ©é•¿äº†å¯¹äºå‡ ä¹ç¬æ—¶è·å¾—ä¿¡æ¯çš„æœŸæœ›ã€‚æˆ‘ä»¬å°†åœ¨æœ¬ç« ä¸­è®¨è®ºçš„WebSocketåè®®ä¾¿æ˜¯åœ¨è¿™ä¸ªæ–¹å‘ä¸Šè¿ˆå‡ºçš„åšå®çš„ä¸€æ­¥ã€‚</p>
<h2 id="websocket-ç®€ä»‹">WebSocket ç®€ä»‹<a hidden class="anchor" aria-hidden="true" href="#websocket-ç®€ä»‹">#</a></h2>
<p>WebSocket åè®®æ˜¯å®Œå…¨é‡æ–°è®¾è®¡çš„åè®®ï¼Œæ—¨åœ¨ä¸º Web ä¸Šçš„åŒå‘æ•°æ®ä¼ è¾“é—®é¢˜æä¾›ä¸€ä¸ªåˆ‡å®å¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»ä¼ è¾“æ¶ˆæ¯ï¼Œå› æ­¤ï¼Œè¿™ä¹Ÿå°±è¦æ±‚å®ƒä»¬å¼‚æ­¥åœ°å¤„ç†æ¶ˆæ¯å›æ‰§ã€‚ï¼ˆä½œä¸ºHTML5 å®¢æˆ·ç«¯ API çš„ä¸€éƒ¨åˆ†ï¼Œå¤§éƒ¨åˆ†æœ€æ–°çš„æµè§ˆå™¨éƒ½å·²ç»æ”¯æŒäº† WebSocketã€‚ï¼‰Netty å¯¹äº WebSocket çš„æ”¯æŒåŒ…å«äº†æ‰€æœ‰æ­£åœ¨ä½¿ç”¨ä¸­çš„ä¸»è¦å®ç°ï¼Œå› æ­¤åœ¨ä½ çš„ä¸‹ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­é‡‡ç”¨å®ƒå°†æ˜¯ç®€å•ç›´æ¥çš„ã€‚å’Œå¾€å¸¸ä½¿ç”¨ Netty ä¸€æ ·ï¼Œä½ å¯ä»¥å®Œå…¨ä½¿ç”¨è¯¥åè®®ï¼Œè€Œæ— éœ€å…³å¿ƒå®ƒå†…éƒ¨çš„å®ç°ç»†èŠ‚ã€‚æˆ‘ä»¬å°†é€šè¿‡åˆ›å»ºä¸€ä¸ªåŸºäº WebSocket çš„å®æ—¶èŠå¤©åº”ç”¨ç¨‹åºæ¥æ¼”ç¤ºè¿™ä¸€ç‚¹ã€‚</p>
<h2 id="æˆ‘ä»¬çš„-websocket-ç¤ºä¾‹åº”ç”¨ç¨‹åº">æˆ‘ä»¬çš„ WebSocket ç¤ºä¾‹åº”ç”¨ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#æˆ‘ä»¬çš„-websocket-ç¤ºä¾‹åº”ç”¨ç¨‹åº">#</a></h2>
<p>ä¸ºäº†è®©ç¤ºä¾‹åº”ç”¨ç¨‹åºå±•ç¤ºå®ƒçš„å®æ—¶åŠŸèƒ½ï¼Œæˆ‘ä»¬ å°†é€šè¿‡ä½¿ç”¨ WebSocket åè®®æ¥å®ç°ä¸€ä¸ªåŸºäºæµè§ˆå™¨çš„èŠå¤©åº”ç”¨ç¨‹åºï¼Œå°±åƒä½ å¯èƒ½åœ¨ Facebook çš„æ–‡æœ¬æ¶ˆæ¯åŠŸèƒ½ä¸­è§åˆ°è¿‡çš„é‚£æ ·ã€‚æˆ‘ä»¬å°†é€šè¿‡ä½¿å¾—å¤šä¸ªç”¨æˆ·ä¹‹é—´å¯ä»¥åŒæ—¶è¿›è¡Œç›¸äº’é€šä¿¡ï¼Œä»è€Œæ›´è¿›ä¸€æ­¥ã€‚</p>
<p>å›¾ 12-1 è¯´æ˜äº†è¯¥åº”ç”¨ç¨‹åºçš„é€»è¾‘ï¼š
ï¼ˆ1ï¼‰å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼›
ï¼ˆ2ï¼‰è¯¥æ¶ˆæ¯å°†è¢«å¹¿æ’­åˆ°æ‰€æœ‰å…¶ä»–è¿æ¥çš„å®¢æˆ·ç«¯
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/68.png"></p>
<p>é€šè¿‡æˆ‘ä»¬çš„ç¨‹åºï¼Œæ‰€æœ‰çš„äººéƒ½å¯ä»¥å’Œå…¶ä»–çš„äººèŠå¤©ã€‚åœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†åªå®ç°æœåŠ¡å™¨ç«¯ï¼Œè€Œå®¢æˆ·ç«¯åˆ™æ˜¯é€šè¿‡Web é¡µé¢è®¿é—®è¯¥èŠå¤©å®¤çš„æµè§ˆå™¨ã€‚å¯ä»¥å‘ç°ï¼ŒWebSocket ç®€åŒ–äº†ç¼–å†™è¿™æ ·çš„æœåŠ¡å™¨çš„è¿‡ç¨‹ã€‚</p>
<h2 id="æ·»åŠ -websocket-æ”¯æŒ">æ·»åŠ  WebSocket æ”¯æŒ<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ -websocket-æ”¯æŒ">#</a></h2>
<p>åœ¨ä»æ ‡å‡†çš„HTTPæˆ–è€…HTTPSåè®®åˆ‡æ¢åˆ°WebSocketæ—¶ï¼Œå°†ä¼šä½¿ç”¨ä¸€ç§ç§°ä¸ºå‡çº§æ¡æ‰‹çš„æœºåˆ¶ã€‚å› æ­¤ï¼Œä½¿ç”¨WebSocketçš„åº”ç”¨ç¨‹åºå°†å§‹ç»ˆä»¥HTTP/Sä½œä¸ºå¼€å§‹ï¼Œç„¶åå†æ‰§è¡Œå‡çº§ã€‚è¿™ä¸ªå‡çº§åŠ¨ä½œå‘ç”Ÿçš„ç¡®åˆ‡æ—¶åˆ»ç‰¹å®šäºåº”ç”¨ç¨‹åºï¼›å®ƒå¯èƒ½ä¼šå‘ç”Ÿåœ¨å¯åŠ¨æ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šå‘ç”Ÿåœ¨è¯·æ±‚äº†æŸä¸ªç‰¹å®šçš„URLä¹‹åã€‚
æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°†é‡‡ç”¨ä¸‹é¢çš„çº¦å®šï¼šå¦‚æœè¢«è¯·æ±‚çš„ URL ä»¥/ws ç»“å°¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ä¼šæŠŠè¯¥åè®®å‡çº§ä¸º
WebSocketï¼›å¦åˆ™ï¼ŒæœåŠ¡å™¨å°†ä½¿ç”¨åŸºæœ¬çš„ HTTP/Sã€‚åœ¨è¿æ¥å·²ç»å‡çº§å®Œæˆä¹‹åï¼Œæ‰€æœ‰æ•°æ®éƒ½å°†ä¼šä½¿ç”¨WebSocket è¿›è¡Œä¼ è¾“ã€‚å›¾ 12-2 è¯´æ˜äº†è¯¥æœåŠ¡å™¨é€»è¾‘ï¼Œä¸€å¦‚åœ¨ Netty ä¸­ä¸€æ ·ï¼Œå®ƒç”±ä¸€ç»„ChannelHandlerå®ç°ã€‚
æˆ‘ä»¬å°†ä¼šåœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œè§£é‡Šç”¨äºå¤„ç† HTTP ä»¥åŠ WebSocket åè®®çš„æŠ€æœ¯æ—¶ï¼Œæè¿°å®ƒä»¬ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/69.png"></p>
<h3 id="å¤„ç†-http-è¯·æ±‚">å¤„ç† HTTP è¯·æ±‚<a hidden class="anchor" aria-hidden="true" href="#å¤„ç†-http-è¯·æ±‚">#</a></h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†å®ç°è¯¥å¤„ç† HTTP è¯·æ±‚çš„ç»„ä»¶ã€‚è¿™ä¸ªç»„ä»¶å°†æä¾›ç”¨äºè®¿é—®èŠå¤©å®¤å¹¶æ˜¾ç¤ºç”±è¿æ¥çš„å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯çš„ç½‘é¡µã€‚ä»£ç æ¸…å• 12-1 ç»™å‡ºäº†è¿™ä¸ª HttpRequestHandler å¯¹åº”çš„ä»£ç ï¼Œå…¶æ‰©å±•äº†
SimpleChannelInboundHandler ä»¥å¤„ç† FullHttpRequest æ¶ˆæ¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒchannelRead0()æ–¹æ³•çš„å®ç°æ˜¯å¦‚ä½•è½¬å‘ä»»ä½•ç›®æ ‡ URI ä¸º/ws çš„è¯·æ±‚çš„ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 12-1 HTTPRequestHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±• SimpleChannelInboundHandler ä»¥å¤„ç† FullHttpRequest æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpRequestHandler <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;FullHttpRequest&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String wsUri;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> File INDEX;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>        URL location = HttpRequestHandler.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getProtectionDomain</span>().<span style="color:#007f7f">getCodeSource</span>().<span style="color:#007f7f">getLocation</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            String path = location.<span style="color:#007f7f">toURI</span>() + <span style="color:#0ff;font-weight:bold">&#34;index.html&#34;</span>;
</span></span><span style="display:flex;"><span>            path = !path.<span style="color:#007f7f">contains</span>(<span style="color:#0ff;font-weight:bold">&#34;file:&#34;</span>) ? path : path.<span style="color:#007f7f">substring</span>(5);
</span></span><span style="display:flex;"><span>            INDEX = <span style="color:#fff;font-weight:bold">new</span> File(path);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (URISyntaxException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalStateException(
</span></span><span style="display:flex;"><span>                 <span style="color:#0ff;font-weight:bold">&#34;Unable to locate index.html&#34;</span>, e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpRequestHandler(String wsUri) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">wsUri</span> = wsUri;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        FullHttpRequest request) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//(1) å¦‚æœè¯·æ±‚äº† WebSocket åè®®å‡çº§ï¼Œåˆ™å¢åŠ å¼•ç”¨è®¡æ•°ï¼ˆè°ƒç”¨ retain()æ–¹æ³•ï¼‰ï¼Œå¹¶å°†å®ƒä¼ é€’ç»™ä¸‹ä¸€ ä¸ª ChannelInboundHandler</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (wsUri.<span style="color:#007f7f">equalsIgnoreCase</span>(request.<span style="color:#007f7f">getUri</span>())) {
</span></span><span style="display:flex;"><span>            ctx.<span style="color:#007f7f">fireChannelRead</span>(request.<span style="color:#007f7f">retain</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(2) å¤„ç† 100 Continue è¯·æ±‚ä»¥ç¬¦åˆ HTTP 1.1 è§„èŒƒ</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (HttpHeaders.<span style="color:#007f7f">is100ContinueExpected</span>(request)) {
</span></span><span style="display:flex;"><span>                send100Continue(ctx);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è¯»å– index.html</span>
</span></span><span style="display:flex;"><span>            RandomAccessFile file = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(INDEX, <span style="color:#0ff;font-weight:bold">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>            HttpResponse response = <span style="color:#fff;font-weight:bold">new</span> DefaultHttpResponse(
</span></span><span style="display:flex;"><span>                request.<span style="color:#007f7f">getProtocolVersion</span>(), HttpResponseStatus.<span style="color:#007f7f">OK</span>);
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">headers</span>().<span style="color:#007f7f">set</span>(
</span></span><span style="display:flex;"><span>                HttpHeaders.<span style="color:#007f7f">Names</span>.<span style="color:#007f7f">CONTENT_TYPE</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;text/html; charset=UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">boolean</span> keepAlive = HttpHeaders.<span style="color:#007f7f">isKeepAlive</span>(request);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœè¯·æ±‚äº†keep-aliveï¼Œåˆ™æ·»åŠ æ‰€éœ€è¦çš„ HTTP å¤´ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (keepAlive) {
</span></span><span style="display:flex;"><span>                response.<span style="color:#007f7f">headers</span>().<span style="color:#007f7f">set</span>(
</span></span><span style="display:flex;"><span>                    HttpHeaders.<span style="color:#007f7f">Names</span>.<span style="color:#007f7f">CONTENT_LENGTH</span>, file.<span style="color:#007f7f">length</span>());
</span></span><span style="display:flex;"><span>                response.<span style="color:#007f7f">headers</span>().<span style="color:#007f7f">set</span>( HttpHeaders.<span style="color:#007f7f">Names</span>.<span style="color:#007f7f">CONNECTION</span>,
</span></span><span style="display:flex;"><span>                    HttpHeaders.<span style="color:#007f7f">Values</span>.<span style="color:#007f7f">KEEP_ALIVE</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(3) å°† HttpResponse å†™åˆ°å®¢æˆ·ç«¯</span>
</span></span><span style="display:flex;"><span>            ctx.<span style="color:#007f7f">write</span>(response);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(4) å°† index.html å†™åˆ°å®¢æˆ·ç«¯</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (ctx.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">get</span>(SslHandler.<span style="color:#007f7f">class</span>) == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                ctx.<span style="color:#007f7f">write</span>(<span style="color:#fff;font-weight:bold">new</span> DefaultFileRegion(
</span></span><span style="display:flex;"><span>                    file.<span style="color:#007f7f">getChannel</span>(), 0, file.<span style="color:#007f7f">length</span>()));
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                ctx.<span style="color:#007f7f">write</span>(<span style="color:#fff;font-weight:bold">new</span> ChunkedNioFile(file.<span style="color:#007f7f">getChannel</span>()));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(5) å†™ LastHttpContent å¹¶å†²åˆ·è‡³å®¢æˆ·ç«¯</span>
</span></span><span style="display:flex;"><span>            ChannelFuture future = ctx.<span style="color:#007f7f">writeAndFlush</span>(
</span></span><span style="display:flex;"><span>                LastHttpContent.<span style="color:#007f7f">EMPTY_LAST_CONTENT</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(6) å¦‚æœæ²¡æœ‰è¯·æ±‚keep-aliveï¼Œåˆ™åœ¨å†™æ“ä½œå®Œæˆåå…³é—­ Channel</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (!keepAlive) {
</span></span><span style="display:flex;"><span>                future.<span style="color:#007f7f">addListener</span>(ChannelFutureListener.<span style="color:#007f7f">CLOSE</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> send100Continue(ChannelHandlerContext ctx) {
</span></span><span style="display:flex;"><span>        FullHttpResponse response = <span style="color:#fff;font-weight:bold">new</span> DefaultFullHttpResponse(
</span></span><span style="display:flex;"><span>            HttpVersion.<span style="color:#007f7f">HTTP_1_1</span>, HttpResponseStatus.<span style="color:#007f7f">CONTINUE</span>);
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">writeAndFlush</span>(response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> exceptionCaught(ChannelHandlerContext ctx, Throwable cause)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        cause.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœè¯¥ HTTP è¯·æ±‚æŒ‡å‘äº†åœ°å€ä¸º/ws çš„ URIï¼Œé‚£ä¹ˆ HttpRequestHandler å°†è°ƒç”¨ FullHttpRequest å¯¹è±¡ä¸Šçš„retain()æ–¹æ³•ï¼Œå¹¶é€šè¿‡è°ƒç”¨ fireChannelRead(msg)æ–¹æ³•å°†å®ƒè½¬å‘ç»™ä¸‹ä¸€ä¸ª ChannelInboundHandler ã€‚
ä¹‹æ‰€ä»¥éœ€è¦è°ƒç”¨ retain()æ–¹æ³•ï¼Œæ˜¯å› ä¸ºè°ƒç”¨ channelRead()æ–¹æ³•å®Œæˆä¹‹åï¼Œå®ƒå°†è°ƒç”¨ FullHttpRequest å¯¹è±¡ä¸Šçš„ release()æ–¹æ³•ä»¥é‡Šæ”¾å®ƒçš„èµ„æºã€‚ï¼ˆå‚è§æˆ‘ä»¬åœ¨ç¬¬ 6 ç« ä¸­å¯¹äº SimpleChannelInboundHandler çš„è®¨è®ºï¼‰å¦‚æœå®¢æˆ·ç«¯å‘é€äº† HTTP 1.1 çš„ HTTP å¤´ä¿¡æ¯ Expect: 100-continueï¼Œé‚£ä¹ˆ HttpRequestHandler å°†ä¼šå‘é€ä¸€ä¸ª 100 Continue å“åº”ã€‚åœ¨è¯¥ HTTP å¤´ä¿¡æ¯è¢«è®¾ç½®ä¹‹åï¼ŒHttpRequestHandler å°†ä¼šå†™å›ä¸€ä¸ªHttpResponse ç»™å®¢æˆ·ç«¯ã€‚è¿™ä¸æ˜¯ä¸€ä¸ª FullHttpResponseï¼Œå› ä¸ºå®ƒåªæ˜¯å“åº”çš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†ã€‚æ­¤å¤–ï¼Œè¿™é‡Œä¹Ÿä¸ä¼šè°ƒç”¨ writeAndFlush()æ–¹æ³•ï¼Œåœ¨ç»“æŸçš„æ—¶å€™æ‰ä¼šè°ƒç”¨ã€‚</p>
<p>å¦‚æœä¸éœ€è¦åŠ å¯†å’Œå‹ç¼©ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡å°† index.html çš„å†…å®¹å­˜å‚¨åˆ° DefaultFileRegion ä¸­æ¥è¾¾åˆ°æœ€ä½³æ•ˆç‡ã€‚è¿™å°†ä¼šåˆ©ç”¨é›¶æ‹·è´ç‰¹æ€§æ¥è¿›è¡Œå†…å®¹çš„ä¼ è¾“ã€‚ä¸ºæ­¤ï¼Œä½ å¯ä»¥æ£€æŸ¥ä¸€ä¸‹ï¼Œæ˜¯å¦æœ‰ SslHandler å­˜åœ¨äºåœ¨ChannelPipeline ä¸­ã€‚å¦åˆ™ï¼Œä½ å¯ä»¥ä½¿ç”¨ ChunkedNioFileã€‚HttpRequestHandler å°†å†™ä¸€ä¸ª
LastHttpContent æ¥æ ‡è®°å“åº”çš„ç»“æŸã€‚å¦‚æœæ²¡æœ‰è¯·æ±‚ keep-alive ï¼Œé‚£ä¹ˆ HttpRequestHandler å°†ä¼šæ·»åŠ ä¸€ä¸ª ChannelFutureListeneråˆ°æœ€åä¸€æ¬¡å†™å‡ºåŠ¨ä½œçš„ ChannelFutureï¼Œå¹¶å…³é—­è¯¥è¿æ¥ã€‚
åœ¨è¿™é‡Œï¼Œä½ å°†è°ƒç”¨ writeAndFlush()æ–¹æ³•ä»¥å†²åˆ·æ‰€æœ‰ä¹‹å‰å†™å…¥çš„æ¶ˆæ¯ã€‚è¿™éƒ¨åˆ†ä»£ç ä»£è¡¨äº†èŠå¤©æœåŠ¡å™¨çš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†ï¼Œå®ƒç®¡ç†çº¯ç²¹çš„ HTTP è¯·æ±‚å’Œå“åº”ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å¤„ç†ä¼ è¾“å®é™…èŠå¤©æ¶ˆæ¯çš„ WebSocket å¸§ã€‚</p>
<p>WEBSOCKET å¸§ï¼šWebSocket ä»¥å¸§çš„æ–¹å¼ä¼ è¾“æ•°æ®ï¼Œæ¯ä¸€å¸§ä»£è¡¨æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†ã€‚ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯å¯èƒ½ä¼šåŒ…å«è®¸å¤šå¸§ã€‚</p>
<h3 id="å¤„ç†-websocket-å¸§">å¤„ç† WebSocket å¸§<a hidden class="anchor" aria-hidden="true" href="#å¤„ç†-websocket-å¸§">#</a></h3>
<p>ç”± IETF å‘å¸ƒçš„ WebSocket RFCï¼Œå®šä¹‰äº† 6 ç§å¸§ï¼ŒNetty ä¸ºå®ƒä»¬æ¯ç§éƒ½æä¾›äº†ä¸€ä¸ª POJO å®ç°ã€‚
è¡¨ 12-1 åˆ—å‡ºäº†è¿™äº›å¸§ç±»å‹ï¼Œå¹¶æè¿°äº†å®ƒä»¬çš„ç”¨æ³•ã€‚</p>
<table>
<thead>
<tr>
<th>å¸§ ç±» å‹</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>BinaryWebSocketFrame</td>
<td>åŒ…å«äº†äºŒè¿›åˆ¶æ•°æ®</td>
</tr>
<tr>
<td>TextWebSocketFrame</td>
<td>åŒ…å«äº†æ–‡æœ¬æ•°æ®</td>
</tr>
<tr>
<td>ContinuationWebSocketFrame</td>
<td>åŒ…å«å±äºä¸Šä¸€ä¸ªBinaryWebSocketFrameæˆ–TextWebSocketFrame çš„æ–‡æœ¬æ•°æ®æˆ–è€…äºŒè¿›åˆ¶æ•°æ®</td>
</tr>
<tr>
<td>CloseWebSocketFrame</td>
<td>è¡¨ç¤ºä¸€ä¸ª CLOSE è¯·æ±‚ï¼ŒåŒ…å«ä¸€ä¸ªå…³é—­çš„çŠ¶æ€ç å’Œå…³é—­çš„åŸå› </td>
</tr>
<tr>
<td>PingWebSocketFrame</td>
<td>è¯·æ±‚ä¼ è¾“ä¸€ä¸ª PongWebSocketFrame</td>
</tr>
<tr>
<td>PongWebSocketFrame</td>
<td>ä½œä¸ºä¸€ä¸ªå¯¹äº PingWebSocketFrame çš„å“åº”è¢«å‘é€</td>
</tr>
</tbody>
</table>
<p>æˆ‘ä»¬çš„èŠå¤©åº”ç”¨ç¨‹åºå°†ä½¿ç”¨ä¸‹é¢å‡ ç§å¸§ç±»å‹ï¼š
CloseWebSocketFrameï¼›
PingWebSocketFrameï¼›
PongWebSocketFrame;
TextWebSocketFrameã€‚</p>
<p>TextWebSocketFrame æ˜¯æˆ‘ä»¬å”¯ä¸€çœŸæ­£éœ€è¦å¤„ç†çš„å¸§ç±»å‹ã€‚ä¸ºäº†ç¬¦åˆ WebSocket RFCï¼Œ
Netty æä¾›äº† WebSocketServerProtocolHandler æ¥å¤„ç†å…¶ä»–ç±»å‹çš„å¸§ã€‚
ä»£ç æ¸…å• 12-2 å±•ç¤ºäº†æˆ‘ä»¬ç”¨äºå¤„ç† TextWebSocketFrame çš„ ChannelInboundHandlerï¼Œ
å…¶è¿˜å°†åœ¨å®ƒçš„ ChannelGroup ä¸­è·Ÿè¸ªæ‰€æœ‰æ´»åŠ¨çš„ WebSocket è¿æ¥ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 12-2 å¤„ç†æ–‡æœ¬å¸§
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±• SimpleChannelInboundHandlerï¼Œå¹¶å¤„ç† TextWebSocketFrame æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TextWebSocketFrameHandler <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ChannelGroup group;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TextWebSocketFrameHandler(ChannelGroup group) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">group</span> = group;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//é‡å†™ userEventTriggered()æ–¹æ³•ä»¥å¤„ç†è‡ªå®šä¹‰äº‹ä»¶</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> userEventTriggered(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        Object evt) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å¦‚æœè¯¥äº‹ä»¶è¡¨ç¤ºæ¡æ‰‹æˆåŠŸï¼Œåˆ™ä»è¯¥ ChannelPipeline ä¸­ç§»é™¤HttpRequest-Handlerï¼Œå› ä¸ºå°†ä¸ä¼šæ¥æ”¶åˆ°ä»»ä½•HTTPæ¶ˆæ¯äº†</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (evt == WebSocketServerProtocolHandler.<span style="color:#007f7f">ServerHandshakeStateEvent</span>.<span style="color:#007f7f">HANDSHAKE_COMPLETE</span>) {
</span></span><span style="display:flex;"><span>            ctx.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">remove</span>(HttpRequestHandler.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(1) é€šçŸ¥æ‰€æœ‰å·²ç»è¿æ¥çš„ WebSocket å®¢æˆ·ç«¯æ–°çš„å®¢æˆ·ç«¯å·²ç»è¿æ¥ä¸Šäº†</span>
</span></span><span style="display:flex;"><span>            group.<span style="color:#007f7f">writeAndFlush</span>(<span style="color:#fff;font-weight:bold">new</span> TextWebSocketFrame(
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;Client &#34;</span> + ctx.<span style="color:#007f7f">channel</span>() + <span style="color:#0ff;font-weight:bold">&#34; joined&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(2) å°†æ–°çš„ WebSocket Channel æ·»åŠ åˆ° ChannelGroup ä¸­ï¼Œä»¥ä¾¿å®ƒå¯ä»¥æ¥æ”¶åˆ°æ‰€æœ‰çš„æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>            group.<span style="color:#007f7f">add</span>(ctx.<span style="color:#007f7f">channel</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">userEventTriggered</span>(ctx, evt);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//(3) å¢åŠ æ¶ˆæ¯çš„å¼•ç”¨è®¡æ•°ï¼Œå¹¶å°†å®ƒå†™åˆ° ChannelGroup ä¸­æ‰€æœ‰å·²ç»è¿æ¥çš„å®¢æˆ·ç«¯</span>
</span></span><span style="display:flex;"><span>        group.<span style="color:#007f7f">writeAndFlush</span>(msg.<span style="color:#007f7f">retain</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>TextWebSocketFrameHandler åªæœ‰ä¸€ç»„éå¸¸å°‘é‡çš„è´£ä»»ã€‚å½“å’Œæ–°å®¢æˆ·ç«¯çš„ WebSocketæ¡æ‰‹æˆåŠŸå®Œæˆä¹‹å ï¼Œå®ƒå°†é€šè¿‡æŠŠé€šçŸ¥æ¶ˆæ¯å†™åˆ° ChannelGroup ä¸­çš„æ‰€æœ‰ Channel æ¥é€šçŸ¥æ‰€æœ‰å·²ç»è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œç„¶åå®ƒå°†æŠŠè¿™ä¸ªæ–° Channel åŠ å…¥åˆ°è¯¥ ChannelGroup ä¸­ ã€‚å¦‚æœæ¥æ”¶åˆ°äº† TextWebSocketFrame æ¶ˆæ¯ ï¼ŒTextWebSocketFrameHandler å°†è°ƒç”¨TextWebSocketFrame æ¶ˆæ¯ä¸Šçš„ retain()æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨writeAndFlush()æ–¹æ³•æ¥å°†å®ƒä¼ è¾“ç»™ ChannelGroupï¼Œä»¥ä¾¿æ‰€æœ‰å·²ç»è¿æ¥çš„ WebSocket Channel éƒ½å°†æ¥æ”¶åˆ°å®ƒã€‚
å’Œä¹‹å‰ä¸€æ ·ï¼Œå¯¹äº retain()æ–¹æ³•çš„è°ƒç”¨æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºå½“ channelRead0()æ–¹æ³•è¿”å›æ—¶ï¼Œ
TextWebSocketFrame çš„å¼•ç”¨è®¡æ•°å°†ä¼šè¢«å‡å°‘ã€‚ç”±äºæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå› æ­¤ï¼ŒwriteAndFlush()æ–¹æ³•å¯èƒ½ä¼šåœ¨ channelRead0()æ–¹æ³•è¿”å›ä¹‹åå®Œæˆï¼Œè€Œä¸”å®ƒç»å¯¹ä¸èƒ½è®¿é—®ä¸€ä¸ªå·²ç»å¤±æ•ˆçš„å¼•ç”¨ã€‚å› ä¸º Netty åœ¨å†…éƒ¨å¤„ç†äº†å¤§éƒ¨åˆ†å‰©ä¸‹çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ç°åœ¨å‰©ä¸‹å”¯ä¸€éœ€è¦åšçš„äº‹æƒ…å°±æ˜¯ä¸ºæ¯ä¸ªæ–°åˆ›å»ºçš„ Channel åˆå§‹åŒ–å…¶ChannelPipelineã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†éœ€è¦ä¸€ä¸ª ChannelInitializerã€‚</p>
<h3 id="åˆå§‹åŒ–-channelpipeline">åˆå§‹åŒ– ChannelPipeline<a hidden class="anchor" aria-hidden="true" href="#åˆå§‹åŒ–-channelpipeline">#</a></h3>
<p>æ­£å¦‚ä½ å·²ç»å­¦ä¹ åˆ°çš„ï¼Œä¸ºäº†å°† ChannelHandler å®‰è£…åˆ° ChannelPipeline ä¸­ï¼Œä½ æ‰©å±•äº† ChannelInitializerï¼Œå¹¶å®ç°äº† initChannel()æ–¹æ³•ã€‚ä»£ç æ¸…å• 12-3 å±•ç¤ºäº†ç”±æ­¤ç”Ÿæˆçš„ ChatServerInitializer çš„ä»£ç ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 12-3 åˆå§‹åŒ– ChannelPipeline
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±•äº† ChannelInitializer</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ChatServerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ChannelGroup group;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ChatServerInitializer(ChannelGroup group) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">group</span> = group;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å°†æ‰€æœ‰éœ€è¦çš„ ChannelHandler æ·»åŠ åˆ° ChannelPipeline ä¸­</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HttpServerCodec());
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ChunkedWriteHandler());
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HttpObjectAggregator(64 * 1024));
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HttpRequestHandler(<span style="color:#0ff;font-weight:bold">&#34;/ws&#34;</span>));
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> WebSocketServerProtocolHandler(<span style="color:#0ff;font-weight:bold">&#34;/ws&#34;</span>));
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> TextWebSocketFrameHandler(group));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äº initChannel()æ–¹æ³•çš„è°ƒç”¨ï¼Œé€šè¿‡å®‰è£…æ‰€æœ‰å¿…éœ€çš„ ChannelHandler æ¥è®¾ç½®è¯¥æ–°æ³¨å†Œçš„ Channel çš„ChannelPipelineã€‚è¿™äº› ChannelHandler ä»¥åŠå®ƒä»¬å„è‡ªçš„èŒè´£éƒ½è¢«æ€»ç»“åœ¨äº†è¡¨ 12-2 ä¸­ã€‚</p>
<table>
<thead>
<tr>
<th>ChannelHandler</th>
<th>èŒ è´£</th>
</tr>
</thead>
<tbody>
<tr>
<td>HttpServerCodec</td>
<td>å°†å­—èŠ‚è§£ç ä¸º HttpRequestã€HttpContent å’Œ LastHttpContentã€‚å¹¶å°† HttpRequestã€HttpContent å’Œ LastHttpContent ç¼–ç ä¸ºå­—èŠ‚</td>
</tr>
<tr>
<td>ChunkedWriteHandler</td>
<td>å†™å…¥ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹</td>
</tr>
<tr>
<td>HttpObjectAggregator</td>
<td>å°†ä¸€ä¸ª HttpMessage å’Œè·Ÿéšå®ƒçš„å¤šä¸ª HttpContent èšåˆ ä¸ºå•ä¸ª FullHttpRequest æˆ–è€… FullHttpResponseï¼ˆå– å†³äºå®ƒæ˜¯è¢«ç”¨æ¥å¤„ç†è¯·æ±‚è¿˜æ˜¯å“åº”ï¼‰ã€‚å®‰è£…äº†è¿™ä¸ªä¹‹åï¼Œ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelHandler å°†åªä¼š æ”¶åˆ°å®Œæ•´çš„ HTTP è¯·æ±‚æˆ–å“åº”</td>
</tr>
<tr>
<td>HttpRequestHandler</td>
<td>å¤„ç† FullHttpRequestï¼ˆé‚£äº›ä¸å‘é€åˆ°/ws URI çš„è¯·æ±‚ï¼‰</td>
</tr>
<tr>
<td>WebSocketServerProtocolHandler</td>
<td>æŒ‰ç…§ WebSocket è§„èŒƒçš„è¦æ±‚ï¼Œå¤„ç† WebSocket å‡çº§æ¡æ‰‹ã€ PingWebSocketFrame ã€ PongWebSocketFrame å’Œ CloseWebSocketFrame</td>
</tr>
<tr>
<td>TextWebSocketFrameHandler</td>
<td>å¤„ç† TextWebSocketFrame å’Œæ¡æ‰‹å®Œæˆäº‹ä»¶</td>
</tr>
</tbody>
</table>
<p>Netty çš„ WebSocketServerProtocolHandler å¤„ç†äº†æ‰€æœ‰å§”æ‰˜ç®¡ç†çš„ WebSocket å¸§ç±»å‹ä»¥åŠå‡çº§æ¡æ‰‹æœ¬èº«ã€‚å¦‚æœæ¡æ‰‹æˆåŠŸï¼Œé‚£ä¹ˆæ‰€éœ€çš„ ChannelHandler å°†ä¼šè¢«æ·»åŠ åˆ° ChannelPipelineä¸­ï¼Œè€Œé‚£äº›ä¸å†éœ€è¦çš„ChannelHandler åˆ™å°†ä¼šè¢«ç§»é™¤ã€‚
WebSocket åè®®å‡çº§ä¹‹å‰çš„ ChannelPipeline çš„çŠ¶æ€å¦‚å›¾ 12-3 æ‰€ç¤ºã€‚è¿™ä»£è¡¨äº†åˆšåˆšè¢«ChatServerInitializer åˆå§‹åŒ–ä¹‹åçš„ ChannelPipelineã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/70.png">
å½“ WebSocket åè®®å‡çº§å®Œæˆä¹‹åï¼ŒWebSocketServerProtocolHandler å°†ä¼šæŠŠ HttpRequestDecoder æ›¿æ¢ä¸º WebSocketFrameDecoderï¼ŒæŠŠ HttpResponseEncoder æ›¿æ¢ä¸ºWebSocketFrameEncoderã€‚ä¸ºäº†æ€§èƒ½æœ€å¤§åŒ–ï¼Œå®ƒå°†ç§»é™¤ä»»ä½•ä¸å†è¢« WebSocket è¿æ¥æ‰€éœ€è¦çš„ChannelHandlerã€‚
è¿™ä¹ŸåŒ…æ‹¬äº†å›¾ 12-3 æ‰€ç¤ºçš„ HttpObjectAggregator å’Œ HttpRequestHandlerã€‚
å›¾ 12-4 å±•ç¤ºäº†è¿™äº›æ“ä½œå®Œæˆä¹‹åçš„ChannelPipelineã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒNettyç›®å‰æ”¯æŒ 4ä¸ªç‰ˆæœ¬çš„
WebSocketåè®®ï¼Œå®ƒä»¬æ¯ä¸ªéƒ½å…·æœ‰è‡ªå·±çš„å®ç°ç±»ã€‚Nettyå°†ä¼šæ ¹æ®å®¢æˆ·ç«¯ï¼ˆè¿™é‡ŒæŒ‡æµè§ˆå™¨ï¼‰æ‰€æ”¯æŒçš„ç‰ˆæœ¬ ï¼Œ(åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‡è®¾ä½¿ç”¨äº†13 ç‰ˆçš„ WebSocket åè®®ï¼Œæ‰€ä»¥å›¾ä¸­å±•ç¤ºçš„æ˜¯WebSocketFrameDecoder13å’Œ WebSocketFrameEncoder13ã€‚)
è‡ªåŠ¨åœ°é€‰æ‹©æ­£ç¡®ç‰ˆæœ¬çš„WebSocketFrameDecoderå’ŒWebSocketFrameEncoderã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/71.png"></p>
<h3 id="å¼•å¯¼-1">å¼•å¯¼<a hidden class="anchor" aria-hidden="true" href="#å¼•å¯¼-1">#</a></h3>
<p>è¿™å¹…æ‹¼å›¾æœ€åçš„ä¸€éƒ¨åˆ†æ˜¯å¼•å¯¼è¯¥æœåŠ¡å™¨ï¼Œå¹¶å®‰è£… ChatServerInitializer çš„ä»£ç ã€‚è¿™å°†ç”± ChatServer ç±»å¤„ç†ï¼Œå¦‚ä»£ç æ¸…å• 12-4 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 12-4 å¼•å¯¼æœåŠ¡å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ChatServer {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ›å»º DefaultChannelGroupï¼Œå…¶å°†ä¿å­˜æ‰€æœ‰å·²ç»è¿æ¥çš„ WebSocket Channel</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ChannelGroup channelGroup =
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">new</span> DefaultChannelGroup(ImmediateEventExecutor.<span style="color:#007f7f">INSTANCE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Channel channel;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ChannelFuture start(InetSocketAddress address) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å¼•å¯¼æœåŠ¡å™¨</span>
</span></span><span style="display:flex;"><span>        ServerBootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>             .<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>             .<span style="color:#007f7f">childHandler</span>(createInitializer(channelGroup));
</span></span><span style="display:flex;"><span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">bind</span>(address);
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>        channel = future.<span style="color:#007f7f">channel</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> future;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ›å»º ChatServerInitializer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> ChannelInitializer&lt;Channel&gt; createInitializer(
</span></span><span style="display:flex;"><span>        ChannelGroup group) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ChatServerInitializer(group);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å¤„ç†æœåŠ¡å™¨å…³é—­ï¼Œå¹¶é‡Šæ”¾æ‰€æœ‰çš„èµ„æº</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> destroy() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (channel != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            channel.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        channelGroup.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        group.<span style="color:#007f7f">shutdownGracefully</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        if (args.length != 1) {</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//            System.err.println(&#34;Please give port as argument&#34;);</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//            System.exit(1);</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        }</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        int port = Integer.parseInt(args[0]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> port = 8989;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> ChatServer endpoint = <span style="color:#fff;font-weight:bold">new</span> ChatServer();
</span></span><span style="display:flex;"><span>        ChannelFuture future = endpoint.<span style="color:#007f7f">start</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port));
</span></span><span style="display:flex;"><span>        Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">addShutdownHook</span>(<span style="color:#fff;font-weight:bold">new</span> Thread() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>                endpoint.<span style="color:#007f7f">destroy</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æµ‹è¯•è¯¥åº”ç”¨ç¨‹åº">æµ‹è¯•è¯¥åº”ç”¨ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#æµ‹è¯•è¯¥åº”ç”¨ç¨‹åº">#</a></h2>
<p>é€šè¿‡mainæ–¹æ³•è¿è¡Œç¨‹åºï¼Œç„¶ååœ¨æµè§ˆå™¨è®¿é—®æˆ‘ä»¬åœ¨ä»£ç ä¸­æŒ‡å®šçš„ç«¯å£8989ã€‚å¼€ä¸¤ä¸ªé¡µé¢ï¼Œéƒ½è®¿é—®ï¼š
<code>localhost:8989</code>ï¼Œåœ¨ä¸¤ä¸ªé¡µé¢åˆ†åˆ«ç‚¹å‡»connectï¼Œä¸€æ—¦è¿æ¥ä¸Šï¼Œå°±å¯ä»¥è¾“å…¥æ¶ˆæ¯å¹¶ç‚¹å‡»å‘é€æŒ‰é’®ï¼Œç„¶åå°±å¯ä»¥åœ¨å¦å¤–ä¸€ä¸ªé¡µé¢çœ‹åˆ°å‘é€çš„æ¶ˆæ¯ã€‚å¯ä»¥å¼€Nä¸ªé¡µé¢ï¼Œä»£è¡¨Nä¸ªå®¢æˆ·ç«¯ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªç®€æ˜“çš„å¤šäººèŠå¤©å®¤ã€‚</p>
<h3 id="å¦‚ä½•è¿›è¡ŒåŠ å¯†">å¦‚ä½•è¿›è¡ŒåŠ å¯†<a hidden class="anchor" aria-hidden="true" href="#å¦‚ä½•è¿›è¡ŒåŠ å¯†">#</a></h3>
<p>åœ¨çœŸå®ä¸–ç•Œçš„åœºæ™¯ä¸­ï¼Œä½ å°†å¾ˆå¿«å°±ä¼šè¢«è¦æ±‚å‘è¯¥æœåŠ¡å™¨æ·»åŠ åŠ å¯†ã€‚ä½¿ç”¨ Nettyï¼Œè¿™ä¸è¿‡æ˜¯å°†ä¸€ä¸ª SslHandleræ·»åŠ åˆ° ChannelPipeline ä¸­ï¼Œå¹¶é…ç½®å®ƒçš„é—®é¢˜ã€‚ä»£ç æ¸…å• 12-6 å±•ç¤ºäº†å¦‚ä½•é€šè¿‡æ‰©å±•æˆ‘ä»¬çš„ChatServerInitializeræ¥åˆ›å»ºä¸€ä¸ªSecureChatServerInitializer ä»¥å®Œæˆè¿™ä¸ªéœ€æ±‚ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 12-6 ä¸º ChannelPipeline æ·»åŠ åŠ å¯†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±• ChatServerInitializer ä»¥æ·»åŠ åŠ å¯†</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecureChatServerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChatServerInitializer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SslContext context;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SecureChatServerInitializer(ChannelGroup group,
</span></span><span style="display:flex;"><span>        SslContext context) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(group);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">context</span> = context;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è°ƒç”¨çˆ¶ç±»çš„ initChannel() æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">initChannel</span>(ch);
</span></span><span style="display:flex;"><span>        SSLEngine engine = context.<span style="color:#007f7f">newEngine</span>(ch.<span style="color:#007f7f">alloc</span>());
</span></span><span style="display:flex;"><span>        engine.<span style="color:#007f7f">setUseClientMode</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°† SslHandler æ·»åŠ åˆ° ChannelPipeline ä¸­</span>
</span></span><span style="display:flex;"><span>        ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addFirst</span>(<span style="color:#fff;font-weight:bold">new</span> SslHandler(engine));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ€åä¸€æ­¥æ˜¯è°ƒæ•´ChatServerä»¥ä½¿ç”¨SecureChatServerInitializerï¼Œä»¥ä¾¿åœ¨ChannelPipeline ä¸­å®‰è£…
SslHandlerã€‚è¿™ç»™äº†æˆ‘ä»¬ä»£ç æ¸…å• 12-7 ä¸­æ‰€å±•ç¤ºçš„ SecureChatServerã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 12-7 å‘ ChatServer æ·»åŠ åŠ å¯†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//SecureChatServer æ‰©å±• ChatServer ä»¥æ”¯æŒåŠ å¯†</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecureChatServer <span style="color:#fff;font-weight:bold">extends</span> ChatServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SslContext context;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SecureChatServer(SslContext context) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">context</span> = context;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> ChannelInitializer&lt;Channel&gt; createInitializer(ChannelGroup group) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è¿”å›ä¹‹å‰åˆ›å»ºçš„ SecureChatServerInitializer ä»¥å¯ç”¨åŠ å¯†</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> SecureChatServerInitializer(group, context);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        if (args.length != 1) {</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//            System.err.println(&#34;Please give port as argument&#34;);</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//            System.exit(1);</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        }</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        int port = Integer.parseInt(args[0]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> port = 9000;
</span></span><span style="display:flex;"><span>        SelfSignedCertificate cert = <span style="color:#fff;font-weight:bold">new</span> SelfSignedCertificate();
</span></span><span style="display:flex;"><span>        SslContext context = SslContext.<span style="color:#007f7f">newServerContext</span>(
</span></span><span style="display:flex;"><span>                cert.<span style="color:#007f7f">certificate</span>(), cert.<span style="color:#007f7f">privateKey</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> SecureChatServer endpoint = <span style="color:#fff;font-weight:bold">new</span> SecureChatServer(context);
</span></span><span style="display:flex;"><span>        ChannelFuture future = endpoint.<span style="color:#007f7f">start</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port));
</span></span><span style="display:flex;"><span>        Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">addShutdownHook</span>(<span style="color:#fff;font-weight:bold">new</span> Thread() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>                endpoint.<span style="color:#007f7f">destroy</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™å°±æ˜¯ä¸ºæ‰€æœ‰çš„é€šä¿¡å¯ç”¨ SSL/TLS åŠ å¯†éœ€è¦åšçš„å…¨éƒ¨ã€‚æˆ‘ä»¬è¿˜ä½¿ç”¨mainæ–¹æ³•æ¥å¯åŠ¨ç¨‹åºã€‚ç°åœ¨ï¼Œä½ ä¾¿å¯ä»¥ä» SecureChatServer çš„ HTTPS URL åœ°å€ https://localhost:9999 è®¿é—®å®ƒäº†ã€‚</p>
<h1 id="ä½¿ç”¨dupå¹¿æ’­äº‹ä»¶">ä½¿ç”¨DUPå¹¿æ’­äº‹ä»¶<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨dupå¹¿æ’­äº‹ä»¶">#</a></h1>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä½ æ‰€è§è¿‡çš„ç»å¤§å¤šæ•°çš„ä¾‹å­éƒ½ä½¿ç”¨äº†åŸºäºè¿æ¥çš„åè®®ï¼Œå¦‚TCPã€‚
æœ¬ç« æˆ‘ä»¬å­¦ä¹ DUP(User Datagram Protocol)ç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼Œä¹Ÿå«æ— è¿æ¥åè®®ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯å…è®¸ä¸€å®šçš„æ•°æ®åŒ…ä¸¢å¤±ï¼Œæ³¨é‡æ€§èƒ½ã€‚</p>
<h2 id="dupåŸºç¡€">DUPåŸºç¡€<a hidden class="anchor" aria-hidden="true" href="#dupåŸºç¡€">#</a></h2>
<p>é¢å‘è¿æ¥çš„ä¼ è¾“ï¼ˆå¦‚ TCPï¼‰ç®¡ç†äº†ä¸¤ä¸ªç½‘ç»œç«¯ç‚¹ä¹‹é—´çš„è¿æ¥çš„å»ºç«‹ï¼Œåœ¨è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸå†…çš„æœ‰åºå’Œå¯é çš„æ¶ˆæ¯ä¼ è¾“ï¼Œä»¥åŠæœ€åï¼Œè¿æ¥çš„æœ‰åºç»ˆæ­¢ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨ç±»ä¼¼äº UDP è¿™æ ·çš„æ— è¿æ¥åè®®ä¸­ï¼Œå¹¶æ²¡æœ‰æŒä¹…åŒ–è¿æ¥è¿™æ ·çš„æ¦‚å¿µï¼Œå¹¶ä¸”æ¯ä¸ªæ¶ˆæ¯ï¼ˆä¸€ä¸ª UDP æ•°æ®æŠ¥ï¼‰éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„ä¼ è¾“å•å…ƒã€‚
æ­¤å¤–ï¼ŒUDP ä¹Ÿæ²¡æœ‰ TCP çš„çº é”™æœºåˆ¶ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½å°†ç¡®è®¤å®ƒä»¬æ‰€æ¥æ”¶åˆ°çš„åŒ…ï¼Œè€Œæ²¡æœ‰è¢«ç¡®è®¤çš„åŒ…å°†ä¼šè¢«å‘é€æ–¹é‡æ–°ä¼ è¾“ã€‚TCP è¿æ¥å°±åƒæ‰“ç”µè¯ï¼Œå…¶ä¸­ä¸€ç³»åˆ—çš„æœ‰åºæ¶ˆæ¯å°†ä¼šåœ¨ä¸¤ä¸ªæ–¹å‘ä¸ŠæµåŠ¨ã€‚ç›¸åï¼ŒUDP åˆ™ç±»ä¼¼äºå¾€é‚®ç®±ä¸­æŠ•å…¥ä¸€å æ˜ä¿¡ç‰‡ã€‚ä½ æ— æ³•çŸ¥é“å®ƒä»¬å°†ä»¥ä½•ç§é¡ºåºåˆ°è¾¾å®ƒä»¬çš„ç›®çš„åœ°ï¼Œæˆ–è€…å®ƒä»¬æ˜¯å¦æ‰€æœ‰çš„éƒ½èƒ½å¤Ÿåˆ°è¾¾å®ƒä»¬çš„ç›®çš„åœ°ã€‚UDPçš„è¿™äº›æ–¹é¢å¯èƒ½ä¼šè®©ä½ æ„Ÿè§‰åˆ°ä¸¥é‡çš„å±€é™æ€§ï¼Œä½†è¿™ä¹Ÿæ˜¯DUPæ¯”TCPè¦å¿«çš„å¤šçš„åŸå› ï¼š
æ‰€æœ‰çš„æ¡æ‰‹ä»¥åŠæ¶ˆæ¯ç®¡ç†æœºåˆ¶çš„å¼€é”€éƒ½å·²ç»è¢«æ¶ˆé™¤äº†ã€‚æ˜¾ç„¶ï¼ŒUDPå¾ˆé€‚åˆé‚£äº›èƒ½å¤Ÿå¤„ç†æˆ–è€…å®¹å¿æ¶ˆæ¯ä¸¢å¤±çš„åº”ç”¨ç¨‹åºï¼Œä½†å¯èƒ½ä¸é€‚åˆé‚£äº›å¤„ç†é‡‘èäº¤æ˜“çš„åº”ç”¨ç¨‹åºã€‚</p>
<h2 id="dupå¹¿æ’­">DUPå¹¿æ’­<a hidden class="anchor" aria-hidden="true" href="#dupå¹¿æ’­">#</a></h2>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„ä¾‹å­é‡‡ç”¨çš„éƒ½æ˜¯ä¸€ç§å«ä½œå•æ’­çš„ä¼ è¾“æ¨¡å¼ã€‚å®šä¹‰ä¸ºå‘é€æ¶ˆæ¯ç»™ä¸€ä¸ªç”±å”¯ä¸€çš„åœ°å€æ‰€æ ‡è¯†çš„å•ä¸€çš„ç½‘ç»œç›®çš„åœ°ã€‚é¢å‘è¿æ¥çš„åè®®å’Œæ— è¿æ¥åè®®éƒ½æ”¯æŒè¿™ç§æ¨¡å¼ã€‚
UDP æä¾›äº†å‘å¤šä¸ªæ¥æ”¶è€…å‘é€æ¶ˆæ¯çš„é¢å¤–ä¼ è¾“æ¨¡å¼ï¼š</p>
<ul>
<li>å¤šæ’­â€”â€”ä¼ è¾“åˆ°ä¸€ä¸ªé¢„å®šä¹‰çš„ä¸»æœºç»„ï¼›</li>
<li>å¹¿æ’­â€”â€”ä¼ è¾“åˆ°ç½‘ç»œï¼ˆæˆ–è€…å­ç½‘ï¼‰ä¸Šçš„æ‰€æœ‰ä¸»æœºã€‚
æœ¬ç« ä¸­çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºå°†é€šè¿‡å‘é€èƒ½å¤Ÿè¢«åŒä¸€ä¸ªç½‘ç»œä¸­çš„æ‰€æœ‰ä¸»æœºæ‰€æ¥æ”¶çš„æ¶ˆæ¯æ¥æ¼”ç¤ºUDP å¹¿æ’­çš„ä½¿ç”¨ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç‰¹æ®Šçš„å—é™å¹¿æ’­åœ°å€æˆ–è€…é›¶ç½‘ç»œåœ°å€ 255.255.255.255ã€‚å‘é€åˆ°è¿™ä¸ªåœ°å€çš„æ¶ˆæ¯éƒ½å°†ä¼šè¢«å®šå‘ç»™æœ¬åœ°ç½‘ç»œï¼ˆ0.0.0.0ï¼‰ä¸Šçš„æ‰€æœ‰ä¸»æœºï¼Œè€Œä¸ä¼šè¢«è·¯ç”±å™¨è½¬å‘ç»™å…¶ä»–çš„ç½‘ç»œã€‚</li>
</ul>
<h2 id="udp-ç¤ºä¾‹åº”ç”¨ç¨‹åº">UDP ç¤ºä¾‹åº”ç”¨ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#udp-ç¤ºä¾‹åº”ç”¨ç¨‹åº">#</a></h2>
<p>æˆ‘ä»¬çš„ç¤ºä¾‹ç¨‹åºå°†æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œéšåå°†ä¼šé€šè¿‡ UDP æŠŠæ¯ä¸€è¡Œéƒ½ä½œä¸ºä¸€ä¸ªæ¶ˆæ¯å¹¿æ’­åˆ°ä¸€ä¸ªæŒ‡å®šçš„ç«¯å£ã€‚å¦‚æœä½ ç†Ÿæ‚‰ç±» UNIX æ“ä½œç³»ç»Ÿï¼Œä½ å¯èƒ½ä¼šè®¤è¯†åˆ°è¿™æ˜¯æ ‡å‡†çš„ syslog å®ç”¨ç¨‹åºçš„ä¸€ä¸ªéå¸¸ç®€åŒ–çš„ç‰ˆæœ¬ã€‚UDP éå¸¸é€‚åˆäºè¿™æ ·çš„åº”ç”¨ç¨‹åºï¼Œå› ä¸ºè€ƒè™‘åˆ°æ—¥å¿—æ–‡ä»¶æœ¬èº«å·²ç»è¢«å­˜å‚¨åœ¨äº†æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå› æ­¤ï¼Œå¶å°”ä¸¢å¤±æ—¥å¿—æ–‡ä»¶ä¸­çš„ä¸€ä¸¤è¡Œæ˜¯å¯ä»¥å®¹å¿çš„ã€‚æ­¤å¤–ï¼Œè¯¥åº”ç”¨ç¨‹åºè¿˜æä¾›äº†æå…·ä»·å€¼çš„é«˜æ•ˆå¤„ç†å¤§é‡æ•°æ®çš„èƒ½åŠ›ã€‚
æ¥æ”¶æ–¹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿé€šè¿‡ UDP å¹¿æ’­ï¼Œåªéœ€ç®€å•åœ°é€šè¿‡åœ¨æŒ‡å®šçš„ç«¯å£ä¸Šå¯åŠ¨ä¸€ä¸ªç›‘å¬ç¨‹åºï¼Œä¾¿å¯ä»¥åˆ›å»ºä¸€ä¸ªäº‹ä»¶ç›‘è§†å™¨æ¥æ¥æ”¶æ—¥å¿—æ¶ˆæ¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ ·çš„è½»æ¾è®¿é—®æ€§ä¹Ÿå¸¦æ¥äº†æ½œåœ¨çš„å®‰å…¨éšæ‚£ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä½•åœ¨ä¸å®‰å…¨çš„ç¯å¢ƒä¸­å¹¶ä¸å€¾å‘äºä½¿ç”¨ UDP å¹¿æ’­çš„åŸå› ä¹‹ä¸€ã€‚å‡ºäºåŒæ ·çš„åŸå› ï¼Œè·¯ç”±å™¨é€šå¸¸ä¹Ÿä¼šé˜»æ­¢å¹¿æ’­æ¶ˆæ¯ï¼Œå¹¶å°†å®ƒä»¬é™åˆ¶åœ¨å®ƒä»¬çš„æ¥æºç½‘ç»œä¸Šã€‚
å›¾ 13-1 å±•ç¤ºäº†æ•´ä¸ªç³»ç»Ÿçš„ä¸€ä¸ªé«˜çº§åˆ«è§†å›¾ï¼Œå…¶ç”±ä¸€ä¸ªå¹¿æ’­è€…ä»¥åŠä¸€ä¸ªæˆ–è€…å¤šä¸ªäº‹ä»¶ç›‘è§†å™¨æ‰€ç»„æˆã€‚å¹¿æ’­è€…å°†ç›‘å¬æ–°å†…å®¹çš„å‡ºç°ï¼Œå½“å®ƒå‡ºç°æ—¶ï¼Œåˆ™é€šè¿‡ UDP å°†å®ƒä½œä¸ºä¸€ä¸ªå¹¿æ’­æ¶ˆæ¯è¿›è¡Œä¼ è¾“ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/72.png">
æ‰€æœ‰çš„åœ¨è¯¥ UDP ç«¯å£ä¸Šç›‘å¬çš„äº‹ä»¶ç›‘è§†å™¨éƒ½å°†ä¼šæ¥æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ã€‚
ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†ä¸ä¼šä¸ºæˆ‘ä»¬çš„ç¤ºä¾‹ç¨‹åºæ·»åŠ èº«ä»½è®¤è¯ã€éªŒè¯æˆ–è€…åŠ å¯†ã€‚ä½†æ˜¯ï¼Œè¦åŠ å…¥è¿™äº›åŠŸèƒ½å¹¶ä½¿å¾—å…¶æˆä¸ºä¸€ä¸ªå¥å£®çš„ã€å¯ç”¨çš„å®ç”¨ç¨‹åºåº”è¯¥ä¹Ÿä¸éš¾ã€‚</p>
<h2 id="æ¶ˆæ¯-pojo-logeventc">æ¶ˆæ¯ POJO: LogEventc<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆæ¯-pojo-logeventc">#</a></h2>
<p>åœ¨æ¶ˆæ¯å¤„ç†åº”ç”¨ç¨‹åºä¸­ï¼Œæ•°æ®é€šå¸¸ç”± POJO è¡¨ç¤ºï¼Œé™¤äº†å®é™…ä¸Šçš„æ¶ˆæ¯å†…å®¹ï¼Œå…¶è¿˜å¯ä»¥åŒ…å«é…ç½®æˆ–å¤„ç†ä¿¡æ¯ã€‚åœ¨è¿™ä¸ªåº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å°†ä¼šæŠŠæ¶ˆæ¯ä½œä¸ºäº‹ä»¶å¤„ç†ï¼Œå¹¶ä¸”ç”±äºè¯¥æ•°æ®æ¥è‡ªäºæ—¥å¿—æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒç§°ä¸ºLogEventã€‚ä»£ç æ¸…å• 13-1 å±•ç¤ºäº†è¿™ä¸ªç®€å•çš„ POJO çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 13-1 LogEvent æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> LogEvent {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">byte</span> SEPARATOR = (<span style="color:#fff;font-weight:bold">byte</span>) <span style="color:#0ff;font-weight:bold">&#39;:&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> InetSocketAddress source;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String logfile;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String msg;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> received;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç”¨äºä¼ å‡ºæ¶ˆæ¯çš„æ„é€ å‡½æ•°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> LogEvent(String logfile, String msg) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>(<span style="color:#fff;font-weight:bold">null</span>, -1, logfile, msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç”¨äºä¼ å…¥æ¶ˆæ¯çš„æ„é€ å‡½æ•°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> LogEvent(InetSocketAddress source, <span style="color:#fff;font-weight:bold">long</span> received,
</span></span><span style="display:flex;"><span>        String logfile, String msg) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">source</span> = source;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">logfile</span> = logfile;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">msg</span> = msg;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">received</span> = received;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è¿”å›å‘é€ LogEvent çš„æºçš„ InetSocketAddress</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> InetSocketAddress getSource() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> source;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è¿”å›æ‰€å‘é€çš„ LogEvent çš„æ—¥å¿—æ–‡ä»¶çš„åç§°</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getLogfile() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> logfile;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è¿”å›æ¶ˆæ¯å†…å®¹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getMsg() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> msg;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è¿”å›æ¥æ”¶ LogEvent çš„æ—¶é—´</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">long</span> getReceivedTimestamp() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> received;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®šä¹‰å¥½äº†æ¶ˆæ¯ç»„ä»¶ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å®ç°è¯¥åº”ç”¨ç¨‹åºçš„å¹¿æ’­é€»è¾‘äº†ã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶ç”¨äºç¼–ç å’Œä¼ è¾“LogEvent æ¶ˆæ¯çš„ Netty æ¡†æ¶ç±»ã€‚</p>
<h2 id="ç¼–å†™å¹¿æ’­è€…">ç¼–å†™å¹¿æ’­è€…<a hidden class="anchor" aria-hidden="true" href="#ç¼–å†™å¹¿æ’­è€…">#</a></h2>
<p>Netty æä¾›äº†å¤§é‡çš„ç±»æ¥æ”¯æŒ UDP åº”ç”¨ç¨‹åºçš„ç¼–å†™ã€‚
è¡¨ 13-1 åˆ—å‡ºäº†æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„ä¸»è¦çš„æ¶ˆæ¯å®¹å™¨ä»¥åŠ Channel ç±»å‹ã€‚</p>
<table>
<thead>
<tr>
<th>å ç§°</th>
<th>æ è¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>interface AddressedEnvelope &lt;M, A extends SocketAddress&gt; extends ReferenceCounted</td>
<td>å®šä¹‰ä¸€ä¸ªæ¶ˆæ¯ï¼Œå…¶åŒ…è£…äº†å¦ä¸€ä¸ªæ¶ˆæ¯å¹¶å¸¦æœ‰å‘ é€è€…å’Œæ¥æ”¶è€…åœ°å€ã€‚å…¶ä¸­ M æ˜¯æ¶ˆæ¯ç±»å‹ï¼›A æ˜¯ åœ°å€ç±»å‹</td>
</tr>
<tr>
<td>class DefaultAddressedEnvelope &lt;M, A extends SocketAddress&gt; implements AddressedEnvelope&lt;M,A&gt;</td>
<td>æä¾›äº† interface AddressedEnvelope çš„é»˜è®¤å®ç°</td>
</tr>
<tr>
<td>class DatagramPacket extends DefaultAddressedEnvelope &lt;ByteBuf, InetSocketAddress&gt; implements ByteBufHolder</td>
<td>æ‰©å±•äº† DefaultAddressedEnvelope ä»¥ä½¿ ç”¨ ByteBuf ä½œä¸ºæ¶ˆæ¯æ•°æ®å®¹å™¨</td>
</tr>
<tr>
<td>interface DatagramChannel extends Channel</td>
<td>æ‰©å±•äº† Netty çš„ Channel æŠ½è±¡ä»¥æ”¯æŒ UDP çš„ å¤šæ’­ç»„ç®¡ç†</td>
</tr>
<tr>
<td>class NioDatagramChannnel extends AbstractNioMessageChannel implements DatagramChannel</td>
<td>å®šä¹‰äº†ä¸€ä¸ªèƒ½å¤Ÿå‘é€å’Œæ¥æ”¶ AddressedEnvelope æ¶ˆæ¯çš„ Channel ç±»å‹</td>
</tr>
</tbody>
</table>
<p>Netty çš„ DatagramPacket æ˜¯ä¸€ä¸ªç®€å•çš„æ¶ˆæ¯å®¹å™¨ï¼ŒDatagramChannel å®ç°ç”¨å®ƒæ¥å’Œè¿œç¨‹èŠ‚ç‚¹é€šä¿¡ã€‚ç±»ä¼¼äºåœ¨æˆ‘ä»¬å…ˆå‰çš„ç±»æ¯”ä¸­çš„æ˜ä¿¡ç‰‡ï¼Œå®ƒåŒ…å«äº†æ¥æ”¶è€…ï¼ˆå’Œå¯é€‰çš„å‘é€è€…ï¼‰çš„åœ°å€ä»¥åŠæ¶ˆæ¯çš„æœ‰æ•ˆè´Ÿè½½æœ¬èº«ã€‚è¦å°† LogEvent æ¶ˆæ¯è½¬æ¢ä¸º DatagramPacketï¼Œæˆ‘ä»¬å°†éœ€è¦ä¸€ä¸ªç¼–ç å™¨ã€‚ä½†æ˜¯æ²¡æœ‰å¿…è¦ä»å¤´å¼€å§‹ç¼–å†™æˆ‘ä»¬è‡ªå·±çš„ã€‚æˆ‘ä»¬å°†æ‰©å±• Netty çš„ MessageToMessageEncoderï¼Œåœ¨ç¬¬ 10 ç« å’Œç¬¬11 ç« ä¸­æˆ‘ä»¬å·²ç»ä½¿ç”¨è¿‡äº†ã€‚å›¾ 13-2 å±•ç¤ºäº†æ­£åœ¨å¹¿æ’­çš„ 3 ä¸ªæ—¥å¿—æ¡ç›®ï¼Œæ¯ä¸€ä¸ªéƒ½å°†é€šè¿‡ä¸€ä¸ªä¸“é—¨çš„ DatagramPacketè¿›è¡Œå¹¿æ’­ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/73.png"></p>
<p>å›¾ 13-3 å‘ˆç°äº†è¯¥ LogEventBroadcaster çš„ ChannelPipeline çš„ä¸€ä¸ªé«˜çº§åˆ«è§†å›¾ï¼Œå±•ç¤ºäº† LogEvent æ¶ˆæ¯æ˜¯å¦‚ä½•æµç»å®ƒçš„ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/74.png"></p>
<p>æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæ‰€æœ‰çš„å°†è¦è¢«ä¼ è¾“çš„æ•°æ®éƒ½è¢«å°è£…åœ¨äº† LogEvent æ¶ˆæ¯ä¸­ã€‚LogEventBroadcaster å°†æŠŠè¿™äº›å†™å…¥åˆ° Channel ä¸­ï¼Œå¹¶é€šè¿‡ ChannelPipeline å‘é€å®ƒä»¬ï¼Œåœ¨é‚£é‡Œå®ƒä»¬å°†ä¼šè¢«è½¬æ¢ï¼ˆç¼–ç ï¼‰ä¸ºDatagramPacket æ¶ˆæ¯ã€‚æœ€åï¼Œä»–ä»¬éƒ½å°†é€šè¿‡ UDP è¢«å¹¿æ’­ï¼Œå¹¶ç”±è¿œç¨‹èŠ‚ç‚¹ï¼ˆç›‘è§†å™¨ï¼‰æ‰€æ•è·ã€‚
ä»£ç æ¸…å• 13-2 å±•ç¤ºäº†æˆ‘ä»¬è‡ªå®šä¹‰ç‰ˆæœ¬çš„ MessageToMessageEncoderï¼Œå…¶å°†æ‰§è¡Œåˆšæ‰æ‰€æè¿°çš„è½¬æ¢ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 13-2 LogEventEncoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LogEventEncoder <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageEncoder&lt;LogEvent&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> InetSocketAddress remoteAddress;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//LogEventEncoder åˆ›å»ºäº†å³å°†è¢«å‘é€åˆ°æŒ‡å®šçš„ InetSocketAddress çš„ DatagramPacket æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> LogEventEncoder(InetSocketAddress remoteAddress) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">remoteAddress</span> = remoteAddress;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>        LogEvent logEvent, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[] file = logEvent.<span style="color:#007f7f">getLogfile</span>().<span style="color:#007f7f">getBytes</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[] msg = logEvent.<span style="color:#007f7f">getMsg</span>().<span style="color:#007f7f">getBytes</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        ByteBuf buf = channelHandlerContext.<span style="color:#007f7f">alloc</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">buffer</span>(file.<span style="color:#007f7f">length</span> + msg.<span style="color:#007f7f">length</span> + 1);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†æ–‡ä»¶åå†™å…¥åˆ° ByteBuf ä¸­</span>
</span></span><span style="display:flex;"><span>        buf.<span style="color:#007f7f">writeBytes</span>(file);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ·»åŠ ä¸€ä¸ª SEPARATOR</span>
</span></span><span style="display:flex;"><span>        buf.<span style="color:#007f7f">writeByte</span>(LogEvent.<span style="color:#007f7f">SEPARATOR</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†æ—¥å¿—æ¶ˆæ¯å†™å…¥ ByteBuf ä¸­</span>
</span></span><span style="display:flex;"><span>        buf.<span style="color:#007f7f">writeBytes</span>(msg);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†ä¸€ä¸ªæ‹¥æœ‰æ•°æ®å’Œç›®çš„åœ°åœ°å€çš„æ–° DatagramPacket æ·»åŠ åˆ°å‡ºç«™çš„æ¶ˆæ¯åˆ—è¡¨ä¸­</span>
</span></span><span style="display:flex;"><span>        out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> DatagramPacket(buf, remoteAddress));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ LogEventEncoder è¢«å®ç°ä¹‹åï¼Œæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†å¼•å¯¼è¯¥æœåŠ¡å™¨ï¼Œå…¶åŒ…æ‹¬è®¾ç½®å„ç§å„æ ·çš„ChannelOptionï¼Œä»¥åŠåœ¨ ChannelPipeline ä¸­å®‰è£…æ‰€éœ€è¦çš„ ChannelHandlerã€‚è¿™å°†é€šè¿‡ä¸»ç±» LogEventBroadcaster å®Œæˆï¼Œ
å¦‚ä»£ç æ¸…å• 13-3 æ‰€ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 13-3 LogEventBroadcaster
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LogEventBroadcaster {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> EventLoopGroup group;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Bootstrap bootstrap;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> File file;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> LogEventBroadcaster(InetSocketAddress address, File file) {
</span></span><span style="display:flex;"><span>        group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å¼•å¯¼è¯¥ NioDatagramChannelï¼ˆæ— è¿æ¥çš„ï¼‰</span>
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(group).<span style="color:#007f7f">channel</span>(NioDatagramChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>             <span style="color:#007f7f">//è®¾ç½® SO_BROADCAST å¥—æ¥å­—é€‰é¡¹</span>
</span></span><span style="display:flex;"><span>             .<span style="color:#007f7f">option</span>(ChannelOption.<span style="color:#007f7f">SO_BROADCAST</span>, <span style="color:#fff;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>             .<span style="color:#007f7f">handler</span>(<span style="color:#fff;font-weight:bold">new</span> LogEventEncoder(address));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">file</span> = file;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç»‘å®š Channel</span>
</span></span><span style="display:flex;"><span>        Channel ch = bootstrap.<span style="color:#007f7f">bind</span>(0).<span style="color:#007f7f">sync</span>().<span style="color:#007f7f">channel</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> pointer = 0;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å¯åŠ¨ä¸»å¤„ç†å¾ªç¯</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (;;) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">long</span> len = file.<span style="color:#007f7f">length</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (len &lt; pointer) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// file was reset</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å¦‚æœæœ‰å¿…è¦ï¼Œå°†æ–‡ä»¶æŒ‡é’ˆè®¾ç½®åˆ°è¯¥æ–‡ä»¶çš„æœ€åä¸€ä¸ªå­—èŠ‚</span>
</span></span><span style="display:flex;"><span>                pointer = len;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (len &gt; pointer) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// Content was added</span>
</span></span><span style="display:flex;"><span>                RandomAccessFile raf = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(file, <span style="color:#0ff;font-weight:bold">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//è®¾ç½®å½“å‰çš„æ–‡ä»¶æŒ‡é’ˆï¼Œä»¥ç¡®ä¿æ²¡æœ‰ä»»ä½•çš„æ—§æ—¥å¿—è¢«å‘é€</span>
</span></span><span style="display:flex;"><span>                raf.<span style="color:#007f7f">seek</span>(pointer);
</span></span><span style="display:flex;"><span>                String line;
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">while</span> ((line = raf.<span style="color:#007f7f">readLine</span>()) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//å¯¹äºæ¯ä¸ªæ—¥å¿—æ¡ç›®ï¼Œå†™å…¥ä¸€ä¸ª LogEvent åˆ° Channel ä¸­</span>
</span></span><span style="display:flex;"><span>                    ch.<span style="color:#007f7f">writeAndFlush</span>(<span style="color:#fff;font-weight:bold">new</span> LogEvent(<span style="color:#fff;font-weight:bold">null</span>, -1,
</span></span><span style="display:flex;"><span>                    file.<span style="color:#007f7f">getAbsolutePath</span>(), line));
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å­˜å‚¨å…¶åœ¨æ–‡ä»¶ä¸­çš„å½“å‰ä½ç½®</span>
</span></span><span style="display:flex;"><span>                pointer = raf.<span style="color:#007f7f">getFilePointer</span>();
</span></span><span style="display:flex;"><span>                raf.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//ä¼‘çœ  1 ç§’ï¼Œå¦‚æœè¢«ä¸­æ–­ï¼Œåˆ™é€€å‡ºå¾ªç¯ï¼›å¦åˆ™é‡æ–°å¤„ç†å®ƒ</span>
</span></span><span style="display:flex;"><span>                Thread.<span style="color:#007f7f">sleep</span>(1000);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>                Thread.<span style="color:#007f7f">interrupted</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> stop() {
</span></span><span style="display:flex;"><span>        group.<span style="color:#007f7f">shutdownGracefully</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        if (args.length != 2) {</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//            throw new IllegalArgumentException();</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        }</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„ LogEventBroadcaster çš„å®ä¾‹</span>
</span></span><span style="display:flex;"><span>        LogEventBroadcaster broadcaster = <span style="color:#fff;font-weight:bold">new</span> LogEventBroadcaster(
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//                new InetSocketAddress(&#34;255.255.255.255&#34;, Integer.parseInt(args[0])),</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//                new File(args[1]));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//æ”¹ç”¨mainæ–¹æ³•å¯åŠ¨</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;255.255.255.255&#34;</span>,8888),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//éœ€è¦æå‰åœ¨å¯¹åº”è·¯å¾„åˆ›å»ºå¥½æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> File(<span style="color:#0ff;font-weight:bold">&#34;D:\\test\\my.log&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            broadcaster.<span style="color:#007f7f">run</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            broadcaster.<span style="color:#007f7f">stop</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·å°±å®Œæˆäº†è¯¥åº”ç”¨ç¨‹åºçš„å¹¿æ’­è€…ç»„ä»¶ã€‚å¯¹äºåˆå§‹æµ‹è¯•ï¼Œä½ å¯ä»¥ä½¿ç”¨netcatç¨‹åºã€‚åœ¨UNIX/Linuxç³»ç»Ÿä¸­ï¼Œä½ èƒ½å‘ç°å®ƒå·²ç»ä½œä¸ºncè¢«é¢„è£…äº†ã€‚ç”¨äºWindowsçš„ç‰ˆæœ¬å¯ä»¥ä»http://nmap.org/ncatè·å–ã€‚
netcat éå¸¸é€‚åˆäºå¯¹è¿™ä¸ªåº”ç”¨ç¨‹åºè¿›è¡ŒåŸºæœ¬çš„æµ‹è¯•ï¼›å®ƒåªæ˜¯ç›‘å¬æŸä¸ªæŒ‡å®šçš„ç«¯å£ï¼Œå¹¶ä¸”å°†æ‰€æœ‰æ¥æ”¶
åˆ°çš„æ•°æ®æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚å¯ä»¥é€šè¿‡ä¸‹é¢æ‰€ç¤ºçš„æ–¹å¼ï¼Œå°†å…¶è®¾ç½®ä¸ºç›‘å¬ UDP ç«¯å£ 9999 ä¸Šçš„æ•°æ®ï¼š
<code>$ nc -l -u -p 9999</code>
ç°åœ¨æˆ‘ä»¬éœ€è¦å¯åŠ¨æˆ‘ä»¬çš„ LogEventBroadcasterã€‚ä»£ç æ¸…å• 13-4 å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ mvn
æ¥ç¼–è¯‘å’Œè¿è¡Œè¯¥å¹¿æ’­è€…åº”ç”¨ç¨‹åºã€‚pom.xml æ–‡ä»¶ä¸­çš„é…ç½®æŒ‡å‘äº†ä¸€ä¸ªå°†è¢«é¢‘ç¹æ›´æ–°çš„æ–‡ä»¶ï¼Œ
/var/log/messagesï¼ˆå‡è®¾æ˜¯ä¸€ä¸ª UNIX/Linux ç¯å¢ƒï¼‰ï¼Œå¹¶å°†ç«¯å£è®¾ç½®ä¸ºäº† 9999ã€‚è¯¥æ–‡ä»¶ä¸­çš„
æ¡ç›®å°†ä¼šé€šè¿‡ UDP å¹¿æ’­åˆ°é‚£ä¸ªç«¯å£ï¼Œå¹¶åœ¨ä½ å¯åŠ¨äº† netcat çš„ç»ˆç«¯ä¸Šæ‰“å°å‡ºæ¥ã€‚
<code>mvn clean package exec:exec LogEventBroadcaster</code>
è¦æ”¹å˜è¯¥æ—¥å¿—æ–‡ä»¶å’Œç«¯å£å€¼ï¼Œå¯ä»¥åœ¨å¯åŠ¨ mvn çš„æ—¶å€™é€šè¿‡ System å±æ€§æ¥æŒ‡å®šå®ƒä»¬ã€‚ä»£ç æ¸…å• 13-5 å±•ç¤ºäº†å¦‚ä½•å°†æ—¥å¿—æ–‡ä»¶è®¾ç½®ä¸º/var/log/mail.logï¼Œå¹¶å°†ç«¯å£è®¾ç½®ä¸º 8888ã€‚
mvn clean package exec:exec -PLogEventBroadcaster /
-Dlogfile=/var/log/mail.log â€“Dport=8888 â€“&hellip;.
å½“ä½ çœ‹åˆ° LogEventBroadcaster running æ—¶ï¼Œä½ ä¾¿çŸ¥é“å®ƒå·²ç»æˆåŠŸåœ°å¯åŠ¨äº†ã€‚å¦‚æœæœ‰
é”™è¯¯å‘ç”Ÿï¼Œå°†ä¼šæ‰“å°ä¸€ä¸ªå¼‚å¸¸æ¶ˆæ¯ã€‚ä¸€æ—¦è¿™ä¸ªè¿›ç¨‹è¿è¡Œèµ·æ¥ï¼Œå®ƒå°±ä¼šå¹¿æ’­ä»»ä½•æ–°è¢«æ·»åŠ åˆ°è¯¥æ—¥å¿—
æ–‡ä»¶ä¸­çš„æ—¥å¿—æ¶ˆæ¯ã€‚ä½¿ç”¨ netcat å¯¹äºæµ‹è¯•æ¥è¯´æ˜¯è¶³å¤Ÿäº†ï¼Œä½†æ˜¯å®ƒå¹¶ä¸é€‚åˆäºç”Ÿäº§ç³»ç»Ÿã€‚è¿™ä¹Ÿå°±æœ‰äº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„ç¬¬äºŒä¸ªéƒ¨åˆ†â€”â€”æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­å®ç°çš„å¹¿æ’­ç›‘è§†å™¨ã€‚</p>
<h2 id="ç¼–å†™ç›‘è§†å™¨">ç¼–å†™ç›‘è§†å™¨<a hidden class="anchor" aria-hidden="true" href="#ç¼–å†™ç›‘è§†å™¨">#</a></h2>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°† netcat æ›¿æ¢ä¸ºä¸€ä¸ªæ›´åŠ å®Œæ•´çš„äº‹ä»¶æ¶ˆè´¹è€…ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º LogEventMonitorã€‚è¿™ä¸ªç¨‹åºå°†ï¼š</p>
<ul>
<li>æ¥æ”¶ç”± LogEventBroadcaster å¹¿æ’­çš„ UDP DatagramPacketï¼›</li>
<li>å°†å®ƒä»¬è§£ç ä¸º LogEvent æ¶ˆæ¯ï¼›</li>
<li>å°† LogEvent æ¶ˆæ¯å†™å‡ºåˆ° System.outã€‚
å’Œä¹‹å‰ä¸€æ ·ï¼Œè¯¥é€»è¾‘ç”±ä¸€ç»„è‡ªå®šä¹‰çš„ ChannelHandler å®ç°â€”â€”å¯¹äºæˆ‘ä»¬çš„è§£ç å™¨æ¥è¯´ï¼Œæˆ‘ä»¬å°†æ‰©å±•
MessageToMessageDecoderã€‚å›¾ 13-4 æç»˜äº† LogEventMonitor çš„ ChannelPipelineï¼Œå¹¶ä¸”å±•ç¤ºäº†
LogEvent æ˜¯å¦‚ä½•æµç»å®ƒçš„ã€‚
<img loading="lazy" src="/posts/java/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/75.png">
ChannelPipeline ä¸­çš„ç¬¬ä¸€ä¸ªè§£ç å™¨LogEventDecoder è´Ÿè´£å°†ä¼ å…¥çš„DatagramPacketè§£ç ä¸º LogEventæ¶ˆæ¯ï¼ˆä¸€ä¸ªç”¨äºè½¬æ¢å…¥ç«™æ•°æ®çš„ä»»ä½• Netty åº”ç”¨ç¨‹åºçš„å…¸å‹è®¾ç½®ï¼‰ã€‚ä»£ç æ¸…å•13-6 å±•ç¤ºäº†è¯¥å®ç°ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 13-6 LogEventDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LogEventDecoder <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageDecoder&lt;DatagramPacket&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, DatagramPacket datagramPacket, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è·å–å¯¹ DatagramPacket ä¸­çš„æ•°æ®ï¼ˆByteBufï¼‰çš„å¼•ç”¨</span>
</span></span><span style="display:flex;"><span>        ByteBuf data = datagramPacket.<span style="color:#007f7f">content</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è·å–è¯¥ SEPARATOR çš„ç´¢å¼•</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> idx = data.<span style="color:#007f7f">indexOf</span>(0, data.<span style="color:#007f7f">readableBytes</span>(), LogEvent.<span style="color:#007f7f">SEPARATOR</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æå–æ–‡ä»¶å</span>
</span></span><span style="display:flex;"><span>        String filename = data.<span style="color:#007f7f">slice</span>(0, idx).<span style="color:#007f7f">toString</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æå–æ—¥å¿—æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span>        String logMsg = data.<span style="color:#007f7f">slice</span>(idx + 1, data.<span style="color:#007f7f">readableBytes</span>()).<span style="color:#007f7f">toString</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ„å»ºä¸€ä¸ªæ–°çš„ LogEvent å¯¹è±¡ï¼Œå¹¶ä¸”å°†å®ƒæ·»åŠ åˆ°ï¼ˆå·²ç»è§£ç çš„æ¶ˆæ¯çš„ï¼‰åˆ—è¡¨ä¸­</span>
</span></span><span style="display:flex;"><span>        LogEvent event = <span style="color:#fff;font-weight:bold">new</span> LogEvent(datagramPacket.<span style="color:#007f7f">sender</span>(), System.<span style="color:#007f7f">currentTimeMillis</span>(), filename, logMsg);
</span></span><span style="display:flex;"><span>        out.<span style="color:#007f7f">add</span>(event);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬äºŒä¸ª ChannelHandler çš„å·¥ä½œæ˜¯å¯¹ç¬¬ä¸€ä¸ª ChannelHandler æ‰€åˆ›å»ºçš„ LogEvent æ¶ˆæ¯æ‰§è¡Œä¸€äº›å¤„ç†ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œå®ƒåªæ˜¯ç®€å•åœ°å°†å®ƒä»¬å†™å‡ºåˆ° System.outã€‚åœ¨çœŸå®ä¸–ç•Œçš„åº”ç”¨ç¨‹åºä¸­ï¼Œä½ å¯èƒ½éœ€è¦èšåˆæ¥æºäºä¸åŒæ—¥å¿—æ–‡ä»¶çš„äº‹ä»¶ï¼Œæˆ–è€…å°†å®ƒä»¬å‘å¸ƒåˆ°æ•°æ®åº“ä¸­ã€‚
ä»£ç æ¸…å•13-7 å±•ç¤ºäº† LogEventHandlerï¼Œå…¶è¯´æ˜äº†éœ€è¦éµå¾ªçš„åŸºæœ¬æ­¥éª¤ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 13-7 LogEventHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ‰©å±• SimpleChannelInboundHandler ä»¥å¤„ç† LogEvent æ¶ˆæ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LogEventHandler <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;LogEvent&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> exceptionCaught(ChannelHandlerContext ctx, Throwable cause) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å½“å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œæ‰“å°æ ˆè·Ÿè¸ªä¿¡æ¯ï¼Œå¹¶å…³é—­å¯¹åº”çš„ Channel</span>
</span></span><span style="display:flex;"><span>        cause.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, LogEvent event) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ›å»º StringBuilderï¼Œå¹¶ä¸”æ„å»ºè¾“å‡ºçš„å­—ç¬¦ä¸²</span>
</span></span><span style="display:flex;"><span>        StringBuilder builder = <span style="color:#fff;font-weight:bold">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(event.<span style="color:#007f7f">getReceivedTimestamp</span>());
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(<span style="color:#0ff;font-weight:bold">&#34; [&#34;</span>);
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(event.<span style="color:#007f7f">getSource</span>().<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(<span style="color:#0ff;font-weight:bold">&#34;] [&#34;</span>);
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(event.<span style="color:#007f7f">getLogfile</span>());
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(<span style="color:#0ff;font-weight:bold">&#34;] : &#34;</span>);
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(event.<span style="color:#007f7f">getMsg</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ‰“å° LogEvent çš„æ•°æ®</span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(builder.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>LogEventHandler å°†ä»¥ä¸€ç§ç®€å•æ˜“è¯»çš„æ ¼å¼æ‰“å° LogEvent æ¶ˆæ¯ï¼ŒåŒ…æ‹¬ä»¥ä¸‹çš„å„é¡¹ï¼š</p>
<ul>
<li>ä»¥æ¯«ç§’ä¸ºå•ä½çš„è¢«æ¥æ”¶çš„æ—¶é—´æˆ³ï¼›</li>
<li>å‘é€æ–¹çš„ InetSocketAddressï¼Œå…¶ç”± IP åœ°å€å’Œç«¯å£ç»„æˆï¼›</li>
<li>ç”Ÿæˆ LogEvent æ¶ˆæ¯çš„æ—¥å¿—æ–‡ä»¶çš„ç»å¯¹è·¯å¾„åï¼›</li>
<li>å®é™…ä¸Šçš„æ—¥å¿—æ¶ˆæ¯ï¼Œå…¶ä»£è¡¨æ—¥å¿—æ–‡ä»¶ä¸­çš„ä¸€è¡Œã€‚</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„LogEventDecoder å’ŒLogEventHandler å®‰è£…åˆ°ChannelPipelineä¸­ï¼Œ
å¦‚å›¾ 13-4 æ‰€ç¤ºã€‚ä»£ç æ¸…å• 13-8 å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ LogEventMonitor ä¸»ç±»æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç æ¸…å• 13-8 LogEventMonitor
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LogEventMonitor {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> EventLoopGroup group;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Bootstrap bootstrap;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> LogEventMonitor(InetSocketAddress address) {
</span></span><span style="display:flex;"><span>        group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å¼•å¯¼è¯¥ NioDatagramChannel</span>
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">channel</span>(NioDatagramChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è®¾ç½®å¥—æ¥å­—é€‰é¡¹ SO_BROADCAST</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">option</span>(ChannelOption.<span style="color:#007f7f">SO_BROADCAST</span>, <span style="color:#fff;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">handler</span>( <span style="color:#fff;font-weight:bold">new</span> ChannelInitializer&lt;Channel&gt;() {
</span></span><span style="display:flex;"><span>                @Override
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel channel)
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                    ChannelPipeline pipeline = channel.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//å°† LogEventDecoder å’Œ LogEventHandler æ·»åŠ åˆ° ChannelPipeline ä¸­</span>
</span></span><span style="display:flex;"><span>                    pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> LogEventDecoder());
</span></span><span style="display:flex;"><span>                    pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> LogEventHandler());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } )
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">localAddress</span>(address);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Channel bind() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç»‘å®š Channelã€‚æ³¨æ„ï¼ŒDatagramChannel æ˜¯æ— è¿æ¥çš„</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bootstrap.<span style="color:#007f7f">bind</span>().<span style="color:#007f7f">syncUninterruptibly</span>().<span style="color:#007f7f">channel</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> stop() {
</span></span><span style="display:flex;"><span>        group.<span style="color:#007f7f">shutdownGracefully</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        if (args.length != 1) {</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//            throw new IllegalArgumentException(&#34;Usage: LogEventMonitor &lt;port&gt;&#34;);</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        }</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ„é€ ä¸€ä¸ªæ–°çš„ LogEventMonitor</span>
</span></span><span style="display:flex;"><span>        LogEventMonitor monitor = <span style="color:#fff;font-weight:bold">new</span> LogEventMonitor(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(8888));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Channel channel = monitor.<span style="color:#007f7f">bind</span>();
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;LogEventMonitor running&#34;</span>);
</span></span><span style="display:flex;"><span>            channel.<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            monitor.<span style="color:#007f7f">stop</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="è¿è¡Œ-logeventbroadcaster-å’Œ-logeventmonitor">è¿è¡Œ LogEventBroadcaster å’Œ LogEventMonitor<a hidden class="anchor" aria-hidden="true" href="#è¿è¡Œ-logeventbroadcaster-å’Œ-logeventmonitor">#</a></h2>
<p>é€šè¿‡mainæ–¹æ³•å¯åŠ¨<code>LogEventBroadcaster</code>ï¼Œå°†é€šè¿‡ UDP åè®®å¹¿æ’­æ—¥å¿—æ¶ˆæ¯ã€‚
ç»§ç»­é€šè¿‡mainæ–¹æ³•å¯åŠ¨<code>LogEventMonitor</code>ä»¥æ¥æ”¶å’Œæ˜¾ç¤ºå¹¿æ’­æ¶ˆæ¯ã€‚å½“ä½ çœ‹åˆ° LogEventMonitor running æ—¶ï¼Œä½ å°†çŸ¥é“å®ƒå·²ç»æˆåŠŸåœ°å¯åŠ¨äº†ã€‚å¦‚æœæœ‰é”™è¯¯å‘ç”Ÿï¼Œåˆ™å°†ä¼šæ‰“å°å¼‚å¸¸ä¿¡æ¯ã€‚å¦‚ä»£ç æ¸…å• 13-10 æ‰€ç¤ºï¼Œå½“ä»»ä½•æ–°çš„æ—¥å¿—äº‹ä»¶è¢«æ·»åŠ åˆ°è¯¥æ—¥å¿—æ–‡ä»¶ä¸­æ—¶ï¼Œè¯¥ç»ˆç«¯éƒ½ä¼šæ˜¾ç¤ºå®ƒä»¬ã€‚æ¶ˆæ¯çš„æ ¼å¼åˆ™æ˜¯ç”± LogEventHandler åˆ›å»ºçš„ã€‚ä»£ç æ¸…å• 13-10 LogEventMonitor çš„è¾“å‡º</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">1364217299382</span> [/<span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.38</span>:<span style="color:#ff0;font-weight:bold">63182</span>] [/<span style="color:#fff;font-weight:bold">var</span>/<span style="color:#fff;font-weight:bold">log</span>/messages] : Mar <span style="color:#ff0;font-weight:bold">25</span> <span style="color:#ff0;font-weight:bold">13</span>:<span style="color:#ff0;font-weight:bold">55</span>:<span style="color:#ff0;font-weight:bold">08</span>
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPREQUEST of <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.50</span> on eth2 to <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.254</span>
</span></span><span style="display:flex;"><span>port <span style="color:#ff0;font-weight:bold">67</span>
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">1364217299382</span> [/<span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.38</span>:<span style="color:#ff0;font-weight:bold">63182</span>] [/<span style="color:#fff;font-weight:bold">var</span>/<span style="color:#fff;font-weight:bold">log</span>/messages] : Mar <span style="color:#ff0;font-weight:bold">25</span> <span style="color:#ff0;font-weight:bold">13</span>:<span style="color:#ff0;font-weight:bold">55</span>:<span style="color:#ff0;font-weight:bold">08</span>
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPACK of <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.50</span> from <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.254</span>
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">1364217299382</span> [/<span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.38</span>:<span style="color:#ff0;font-weight:bold">63182</span>] [/<span style="color:#fff;font-weight:bold">var</span>/<span style="color:#fff;font-weight:bold">log</span>/messages] : Mar <span style="color:#ff0;font-weight:bold">25</span> <span style="color:#ff0;font-weight:bold">13</span>:<span style="color:#ff0;font-weight:bold">55</span>:<span style="color:#ff0;font-weight:bold">08</span>
</span></span><span style="display:flex;"><span>dev-linux dhclient: bound to <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.50</span> -- renewal in <span style="color:#ff0;font-weight:bold">270</span> seconds.
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">1364217299382</span> [/<span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.38</span>:<span style="color:#ff0;font-weight:bold">63182</span>] [[/<span style="color:#fff;font-weight:bold">var</span>/<span style="color:#fff;font-weight:bold">log</span>/messages] : Mar <span style="color:#ff0;font-weight:bold">25</span> <span style="color:#ff0;font-weight:bold">13</span>:<span style="color:#ff0;font-weight:bold">59</span>:<span style="color:#ff0;font-weight:bold">38</span>
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPREQUEST of <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.50</span> on eth2 to <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.254</span>
</span></span><span style="display:flex;"><span>port <span style="color:#ff0;font-weight:bold">67</span>
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">1364217299382</span> [/<span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.38</span>:<span style="color:#ff0;font-weight:bold">63182</span>] [/[/<span style="color:#fff;font-weight:bold">var</span>/<span style="color:#fff;font-weight:bold">log</span>/messages] : Mar <span style="color:#ff0;font-weight:bold">25</span> <span style="color:#ff0;font-weight:bold">13</span>:<span style="color:#ff0;font-weight:bold">59</span>:<span style="color:#ff0;font-weight:bold">38</span>
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPACK of <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.50</span> from <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.254</span>
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">1364217299382</span> [/<span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.38</span>:<span style="color:#ff0;font-weight:bold">63182</span>] [/<span style="color:#fff;font-weight:bold">var</span>/<span style="color:#fff;font-weight:bold">log</span>/messages] : Mar <span style="color:#ff0;font-weight:bold">25</span> <span style="color:#ff0;font-weight:bold">13</span>:<span style="color:#ff0;font-weight:bold">59</span>:<span style="color:#ff0;font-weight:bold">38</span>
</span></span><span style="display:flex;"><span>dev-linux dhclient: bound to <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.50</span> -- renewal in <span style="color:#ff0;font-weight:bold">259</span> seconds.
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">1364217299383</span> [/<span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.38</span>:<span style="color:#ff0;font-weight:bold">63182</span>] [/<span style="color:#fff;font-weight:bold">var</span>/<span style="color:#fff;font-weight:bold">log</span>/messages] : Mar <span style="color:#ff0;font-weight:bold">25</span> <span style="color:#ff0;font-weight:bold">14</span>:<span style="color:#ff0;font-weight:bold">03</span>:<span style="color:#ff0;font-weight:bold">57</span>
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPREQUEST of <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.50</span> on eth2 to <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.254</span>
</span></span><span style="display:flex;"><span>port <span style="color:#ff0;font-weight:bold">67</span>
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">1364217299383</span> [/<span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.38</span>:<span style="color:#ff0;font-weight:bold">63182</span>] [/<span style="color:#fff;font-weight:bold">var</span>/<span style="color:#fff;font-weight:bold">log</span>/messages] : Mar <span style="color:#ff0;font-weight:bold">25</span> <span style="color:#ff0;font-weight:bold">14</span>:<span style="color:#ff0;font-weight:bold">03</span>:<span style="color:#ff0;font-weight:bold">57</span>
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPACK of <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.50</span> from <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.254</span>
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">1364217299383</span> [/<span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.38</span>:<span style="color:#ff0;font-weight:bold">63182</span>] [/<span style="color:#fff;font-weight:bold">var</span>/<span style="color:#fff;font-weight:bold">log</span>/messages] : Mar <span style="color:#ff0;font-weight:bold">25</span> <span style="color:#ff0;font-weight:bold">14</span>:<span style="color:#ff0;font-weight:bold">03</span>:<span style="color:#ff0;font-weight:bold">57</span>
</span></span><span style="display:flex;"><span>dev-linux dhclient: bound to <span style="color:#ff0;font-weight:bold">192.168</span>.<span style="color:#ff0;font-weight:bold">0.50</span> -- renewal in <span style="color:#ff0;font-weight:bold">285</span> seconds.
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœä½ ä¸èƒ½è®¿é—® UNIX çš„ syslogï¼Œé‚£ä¹ˆä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„æ–‡ä»¶ï¼Œå¹¶æ‰‹åŠ¨æä¾›å†…å®¹ä»¥è§‚æµ‹è¯¥åº”ç”¨ç¨‹åºçš„ååº”ã€‚ä»¥ä½¿ç”¨ touch å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ä½œä¸ºå¼€å§‹ï¼Œä¸‹é¢æ‰€å±•ç¤ºçš„æ­¥éª¤ä½¿ç”¨äº† UNIX å‘½ä»¤ã€‚
<code> touch ~/mylog.log</code>
ç°åœ¨å†æ¬¡å¯åŠ¨ LogEventBroadcasterï¼Œå¹¶é€šè¿‡è®¾ç½®ç³»ç»Ÿå±æ€§æ¥å°†å…¶æŒ‡å‘è¯¥æ–‡ä»¶ï¼š
<code> chapter13&gt; mvn exec:exec -PLogEventBroadcaster -Dlogfile=~/mylog.log</code>
ä¸€æ—¦ LogEventBroadcaster è¿è¡Œï¼Œä½ å°±å¯ä»¥æ‰‹åŠ¨å°†æ¶ˆæ¯æ·»åŠ åˆ°è¯¥æ–‡ä»¶ä¸­ï¼Œä»¥åœ¨
LogEventMonitor ç»ˆç«¯ä¸­æŸ¥çœ‹å¹¿æ’­è¾“å‡ºã€‚ä½¿ç”¨ echo å‘½ä»¤å¹¶å°†è¾“å‡ºé‡å®šå‘åˆ°è¯¥æ–‡ä»¶ï¼Œå¦‚ä¸‹
æ‰€ç¤ºï¼š<code>echo 'Test log entry' &gt;&gt; ~/mylog.log</code>
ä½ å¯ä»¥æ ¹æ®éœ€è¦å¯åŠ¨ä»»æ„å¤šçš„ç›‘è§†å™¨å®ä¾‹ï¼Œå®ƒä»¬æ¯ä¸€ä¸ªéƒ½å°†æ¥æ”¶å¹¶æ˜¾ç¤ºç›¸åŒçš„æ¶ˆæ¯ã€‚</p>
<h1 id="æ¡ˆä¾‹ç ”ç©¶-1">æ¡ˆä¾‹ç ”ç©¶<a hidden class="anchor" aria-hidden="true" href="#æ¡ˆä¾‹ç ”ç©¶-1">#</a></h1>
<p>åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä¸¤éƒ¨åˆ†æ¡ˆä¾‹ç ”ç©¶ä¸­çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œå®ƒä»¬æ˜¯ç”±å·²ç»åœ¨å†…éƒ¨åŸºç¡€è®¾æ–½ä¸­å¹¿æ³›ä½¿ç”¨äº† Netty çš„å…¬å¸è´¡çŒ®çš„ã€‚æˆ‘ä»¬å¸Œæœ›è¿™äº›å…¶ä»–äººå¦‚ä½•åˆ©ç”¨ Netty æ¡†æ¶æ¥è§£å†³ç°å®ä¸–ç•Œé—®é¢˜çš„ä¾‹å­ï¼Œèƒ½å¤Ÿæ‹“å±•ä½ å¯¹äº Nettyèƒ½å¤Ÿåšåˆ°ä»€ä¹ˆäº‹æƒ…çš„ç†è§£ã€‚ç•¥&hellip;çœ‹åŸä¹¦å§</p>
<h1 id="å•ç”¨æˆ·ç™»å½•åŠŸèƒ½">å•ç”¨æˆ·ç™»å½•åŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#å•ç”¨æˆ·ç™»å½•åŠŸèƒ½">#</a></h1>
<p>aç™»å½•ï¼Œæ€è¿›ç¨‹
bç™»å½•ï¼Œï¼ˆæƒ³T aï¼Œä½†æ˜¯aè¿›ç¨‹è¢«æ€ï¼Œé•¿é“¾æ¥æ–­å¼€ï¼Œsessionä¸­å·²ç»æ²¡æœ‰ï¼Œtå¤±è´¥ï¼‰
aæ‰“å¼€ï¼Œåº”è¯¥è¢«T</p>
<p>aç™»å½•ï¼Œæ€è¿›ç¨‹
bç™»å½•ï¼Œæ€è¿›ç¨‹
bå†æ¬¡æ‰“å¼€ï¼Œè‡ªå·±è¢«T</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://009965.xyz/tags/java/">Java</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://009965.xyz/">Wjy&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>