<!DOCTYPE html>
<html lang="en" dir="auto">

<head>
    
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://009965.xyz/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://009965.xyz/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://009965.xyz/">Home</a>&nbsp;»&nbsp;<a href="https://009965.xyz/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      手写Tomcat
    </h1>
    <div class="post-meta"><span title='2024-03-06 18:18:52 +0000 UTC'>2024-03-06</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e8%ae%be%e8%ae%a1%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%9e%b6%e6%9e%84" aria-label="设计服务器架构">设计服务器架构</a></li>
                <li>
                    <a href="#servlet%e8%a7%84%e8%8c%83" aria-label="Servlet规范">Servlet规范</a><ul>
                        <ul>
                        
                <li>
                    <a href="#servlet%e5%a4%84%e7%90%86%e6%b5%81%e7%a8%8b" aria-label="Servlet处理流程">Servlet处理流程</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0http%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="实现HTTP服务器">实现HTTP服务器</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0servlet%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="实现Servlet服务器">实现Servlet服务器</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0servlet%e7%bb%84%e4%bb%b6" aria-label="实现Servlet组件">实现Servlet组件</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0servletcontext" aria-label="实现ServletContext">实现ServletContext</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0filterchain" aria-label="实现FilterChain">实现FilterChain</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0httpsession" aria-label="实现HttpSession">实现HttpSession</a><ul>
                        
                <li>
                    <a href="#session%e5%8e%9f%e7%90%86" aria-label="Session原理">Session原理</a></li>
                <li>
                    <a href="#session%e7%94%a8%e9%80%94" aria-label="Session用途">Session用途</a></li>
                <li>
                    <a href="#httpsession%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="HttpSession的生命周期">HttpSession的生命周期</a></li>
                <li>
                    <a href="#httpsession%e6%8e%a5%e5%8f%a3" aria-label="HttpSession接口">HttpSession接口</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95httpsession" aria-label="测试HttpSession">测试HttpSession</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0listener" aria-label="实现Listener">实现Listener</a><ul>
                        
                <li>
                    <a href="#listener%e5%8e%9f%e7%90%86" aria-label="Listener原理">Listener原理</a></li>
                <li>
                    <a href="#listener%e7%b1%bb%e5%9e%8b" aria-label="Listener类型">Listener类型</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95listener" aria-label="测试Listener">测试Listener</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%8a%a0%e8%bd%bdweb-app" aria-label="加载Web App">加载Web App</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0classloader" aria-label="实现ClassLoader">实现ClassLoader</a><ul>
                        
                <li>
                    <a href="#%e7%bc%96%e5%86%99classloader" aria-label="编写ClassLoader">编写ClassLoader</a></li>
                <li>
                    <a href="#%e8%ae%be%e7%bd%aecontextclassloader" aria-label="设置ContextClassLoader">设置ContextClassLoader</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2web-app" aria-label="部署Web App">部署Web App</a></li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2spring-web-app" aria-label="部署Spring Web App">部署Spring Web App</a></li></ul>
                </li>
                <li>
                    <a href="#faq" aria-label="FAQ">FAQ</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98" aria-label="常见问题">常见问题</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e6%ad%a3%e7%a1%ae%e5%ae%9e%e7%8e%b0getoutputstream%e5%92%8cgetwriter" aria-label="如何正确实现getOutputStream()和getWriter()？">如何正确实现getOutputStream()和getWriter()？</a></li>
                <li>
                    <a href="#httpservletresponse%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e5%ae%9e%e7%8e%b0cleanup" aria-label="HttpServletResponse为什么要实现cleanup()？">HttpServletResponse为什么要实现cleanup()？</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%af%b9servlet%e6%8e%92%e5%ba%8f" aria-label="如何对Servlet排序？">如何对Servlet排序？</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86%e6%98%a0%e5%b0%84" aria-label="如何处理“/”映射？">如何处理“/”映射？</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86%e9%9d%99%e6%80%81%e6%96%87%e4%bb%b6" aria-label="如何处理静态文件？">如何处理静态文件？</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%af%b9filter%e6%8e%92%e5%ba%8f" aria-label="如何对Filter排序？">如何对Filter排序？</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%90%af%e7%94%a8%e8%99%9a%e6%8b%9f%e7%ba%bf%e7%a8%8b" aria-label="如何启用虚拟线程？">如何启用虚拟线程？</a>
                </li>
            </ul>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>对于Java后端开发的同学来说，<a href="https://tomcat.apache.org/">Tomcat</a>服务器肯定不陌生。开发Java Web App，最后通常都会部署到Tomcat这样的服务器上。</p>
<p>很多同学可能觉得开发Web App是比较容易的，开发Web服务器就比较困难了。实际上，虽然开发Web服务器的难度比开发Web App要高，但也不是高得特别离谱。</p>
<p>对于已经能熟练开发Web App的同学来说，要进一步提升自己的架构水平，不如自己动手，从零开始编写一个Tomcat服务器。</p>
<p>本教程的目标就是以Tomcat服务器为原型，专注于实现一个支持Servlet标准的Web服务器，即实现一个迷你版的Tomcat Server，我们把它命名为Jerrymouse Server，与Tomcat主要区别在于，它俩的图标有所不同。</p>
<p>Jerrymouse Server设计目标如下：</p>
<ul>
<li>支持Servlet 6的大部分功能：
<ul>
<li>支持Servlet组件；</li>
<li>支持Filter组件；</li>
<li>支持Listener组件；</li>
<li>支持Sesssion（仅限Cookie模式）；</li>
<li>不支持JSP；</li>
<li>不支持async模式与WebSocket；</li>
</ul>
</li>
<li>可部署一个标准的Web App；</li>
<li>不支持同时部署多个Web App；</li>
<li>不支持热部署。</li>
</ul>
<p>我们会一步一步实现一个完整的Web Server，并在此基础上部署一个完整的Web应用程序。</p>
<p>本教程的所有源码均可从<a href="https://github.com/michaelliao/jerrymouse">GitHub</a>或<a href="https://gitee.com/liaoxuefeng/jerrymouse">Gitee</a>下载。</p>
<p>参考：<a href="https://www.liaoxuefeng.com/wiki/1545956031987744">手写Tomcat - 廖雪峰的官方网站 (liaoxuefeng.com)</a></p>
<h1 id="设计服务器架构">设计服务器架构<a hidden class="anchor" aria-hidden="true" href="#设计服务器架构">#</a></h1>
<p>在开发我们自己的Web服务器之前，我们先看一下Tomcat的架构。</p>
<p>Tomcat是一个开源的Web服务器，它的架构是基于组件的设计，可以将多个组件组合起来使用，用一张图表示如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>  ┌─────────────────────────────────────────────────────┐
</span></span><span style="display:flex;"><span>  │                    Tomcat Server                    │
</span></span><span style="display:flex;"><span>  │ ┌─────────────────────────────────────────────────┐ │
</span></span><span style="display:flex;"><span>  │ │                     Service                     │ │
</span></span><span style="display:flex;"><span>  │ │                 ┌─────────────────────────────┐ │ │
</span></span><span style="display:flex;"><span>  │ │                 │           Engine            │ │ │
</span></span><span style="display:flex;"><span>  │ │                 │ ┌─────────────────────┐     │ │ │
</span></span><span style="display:flex;"><span>  │ │                 │ │        Host         │     │ │ │
</span></span><span style="display:flex;"><span>  │ │ ┌───────────┐   │ │ ┌───────────────────┴─┐   │ │ │
</span></span><span style="display:flex;"><span>  │ │ │Connectors │   │ │ │        Host         │   │ │ │
</span></span><span style="display:flex;"><span>  │ │ │┌─────────┐│   │ │ │ ┌───────────────────┴─┐ │ │ │
</span></span><span style="display:flex;"><span>  │ │ ││Connector││   │ │ │ │        Host         │ │ │ │
</span></span><span style="display:flex;"><span>  │ │ │└─────────┘│   │ │ │ │ ┌─────────────┐     │ │ │ │
</span></span><span style="display:flex;"><span>  │ │ │┌─────────┐│   │ │ │ │ │   Context   │     │ │ │ │
</span></span><span style="display:flex;"><span>◀─┼─┼▶││Connector││◀─▶│ │ │ │ │ ┌───────────┴─┐   │ │ │ │
</span></span><span style="display:flex;"><span>  │ │ │└─────────┘│   │ │ │ │ │ │   Context   │   │ │ │ │
</span></span><span style="display:flex;"><span>  │ │ │┌─────────┐│   │ │ │ │ │ │ ┌───────────┴─┐ │ │ │ │
</span></span><span style="display:flex;"><span>  │ │ ││Connector││   │ │ │ │ └─┤ │   Context   │ │ │ │ │
</span></span><span style="display:flex;"><span>  │ │ │└─────────┘│   │ └─┤ │   │ │ ┌─────────┐ │ │ │ │ │
</span></span><span style="display:flex;"><span>  │ │ └───────────┘   │   │ │   └─┤ │ Web App │ │ │ │ │ │
</span></span><span style="display:flex;"><span>  │ │                 │   └─┤     │ └─────────┘ │ │ │ │ │
</span></span><span style="display:flex;"><span>  │ │                 │     │     └─────────────┘ │ │ │ │
</span></span><span style="display:flex;"><span>  │ │                 │     └─────────────────────┘ │ │ │
</span></span><span style="display:flex;"><span>  │ │                 └─────────────────────────────┘ │ │
</span></span><span style="display:flex;"><span>  │ └─────────────────────────────────────────────────┘ │
</span></span><span style="display:flex;"><span>  └─────────────────────────────────────────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>一个Tomcat Server内部可以有多个Service（服务），通常是一个Service。Service内部包含两个组件：</p>
<ul>
<li>Connectors：代表一组Connector（连接器），至少定义一个Connector，也允许定义多个Connector，例如，HTTP和HTTPS两个Connector；</li>
<li>Engine：代表一个引擎，所有HTTP请求经过Connector后传递给Engine。</li>
</ul>
<p>在一个Engine内部，可以有一个或多个Host（主机），Host可以根据域名区分，在Host内部，又可以有一个或多个Context（上下文），每个Context对应一个Web App。Context是由路径前缀区分的，如<code>/abc</code>、<code>/xyz</code>、<code>/</code>分别代表3个Web App，<code>/</code>表示的Web App在Tomcat中表示根Web App。</p>
<p>因此，一个HTTP请求：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>http://www.example.com/abc/hello
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先根据域名<code>www.example.com</code>定位到某个Host，然后，根据路径前缀<code>/abc</code>定位到某个Context，若路径前缀没有匹配到任何Context，则匹配<code>/</code>Context。在Context内部，就是开发者编写的Web App，一个Context仅包含一个Web App。</p>
<p>可见Tomcat Server是一个全功能的Web服务器，它支持HTTP、HTTPS和AJP等多种Connector，又能同时运行多个Host，每个Host内部，还可以挂载一个或多个Context，对应一个或多个Web App。</p>
<p>我们设计Jerrymouse Server就没必要搞这么复杂，可以大幅简化为：</p>
<ul>
<li>仅一个HTTP Connector，不支持HTTPS；</li>
<li>仅支持挂载到<code>/</code>的一个Context，不支持多个Host与多个Context。</li>
</ul>
<p>因为只有一个Context，所以也只能有一个Web App。Jerrymouse Server的架构如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>  ┌───────────────────────────────┐
</span></span><span style="display:flex;"><span>  │       Jerrymouse Server       │
</span></span><span style="display:flex;"><span>  │                 ┌───────────┐ │
</span></span><span style="display:flex;"><span>  │  ┌─────────┐    │  Context  │ │
</span></span><span style="display:flex;"><span>  │  │  HTTP   │    │┌─────────┐│ │
</span></span><span style="display:flex;"><span>◀─┼─▶│Connector│◀──▶││ Web App ││ │
</span></span><span style="display:flex;"><span>  │  └─────────┘    │└─────────┘│ │
</span></span><span style="display:flex;"><span>  │                 └───────────┘ │
</span></span><span style="display:flex;"><span>  └───────────────────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>有的同学会担心，如果要运行多个Web App怎么办？</p>
<p>这个问题很容易解决：运行多个Jerrymouse Server就可以运行多个Web App了。</p>
<p>还有的同学会担心，只支持HTTP，如果一定要使用HTTPS怎么办？</p>
<p>HTTPS可以部署在网关，通过网关将HTTPS请求转发为HTTP请求给Jerrymouse Server即可。部署一个Nginx就可以充当网关：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>               ┌───────────────────────────────┐
</span></span><span style="display:flex;"><span>               │       Jerrymouse Server       │
</span></span><span style="display:flex;"><span>               │ ┌─────────────────────────────┴─┐
</span></span><span style="display:flex;"><span>               │ │       Jerrymouse Server       │
</span></span><span style="display:flex;"><span>    ┌───────┐  │ │ ┌─────────────────────────────┴─┐
</span></span><span style="display:flex;"><span>    │       │◀─┼─│ │       Jerrymouse Server       │
</span></span><span style="display:flex;"><span>    │       │  │ │ │                 ┌───────────┐ │
</span></span><span style="display:flex;"><span>◀──▶│ Nginx │◀─┼─┼─│  ┌─────────┐    │  Context  │ │
</span></span><span style="display:flex;"><span>    │       │  └─┤ │  │  HTTP   │    │┌─────────┐│ │
</span></span><span style="display:flex;"><span>    │       │◀───┼─┼─▶│Connector│◀──▶││ Web App ││ │
</span></span><span style="display:flex;"><span>    └───────┘    └─┤  └─────────┘    │└─────────┘│ │
</span></span><span style="display:flex;"><span>                   │                 └───────────┘ │
</span></span><span style="display:flex;"><span>                   └───────────────────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>此外，Nginx还可以定义多个Host，根据Host转发给不同的Jerrymouse Server，所以，我们专注于实现一个仅支持HTTP、仅支持一个Web App的Web服务器，把HTTPS、HTTP/2、HTTP/3、Host、Cluster（集群）等功能全部扔给Nginx即可。</p>
<h1 id="servlet规范">Servlet规范<a hidden class="anchor" aria-hidden="true" href="#servlet规范">#</a></h1>
<p>在Java Web应用中，除了Tomcat服务器外，其实还有<a href="https://eclipse.dev/jetty/">Jetty</a>、<a href="https://javaee.github.io/glassfish/">GlassFish</a>、<a href="https://undertow.io/">Undertow</a>等多种Web服务器。</p>
<p>一个Java Web App通常打包为<code>.war</code>文件，并且可以部署到Tomcat、Jetty等多种Web服务器上。为什么一个Java Web App基本上可以无修改地部署到多种Web服务器上呢？原因就在于Servlet规范。</p>
<p>Servlet规范是Java Servlet API的规范，用于定义Web服务器如何处理HTTP请求和响应。Servlet规范有一组接口，对于Web App来说，操作的是接口，而真正对应的实现类，则由各个Web Server实现，这样一来，Java Web App实际上编译的时候仅用到了Servlet规范定义的接口，只要每个Web服务器在实现Servlet接口时严格按照规范实现，就可以保证一个Web App可以正常运行在多种Web服务器上：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>  ┌─────────────────┐
</span></span><span style="display:flex;"><span>  │     Web App     │
</span></span><span style="display:flex;"><span>  └─────────────────┘
</span></span><span style="display:flex;"><span>           ▲
</span></span><span style="display:flex;"><span>           │
</span></span><span style="display:flex;"><span>           ▼
</span></span><span style="display:flex;"><span>  ┌─────────────────┐
</span></span><span style="display:flex;"><span>┌─┤Servlet Interface├─┐
</span></span><span style="display:flex;"><span>│ └─────────────────┘ │
</span></span><span style="display:flex;"><span>│          ▲          │
</span></span><span style="display:flex;"><span>│          │          │
</span></span><span style="display:flex;"><span>│          ▼          │
</span></span><span style="display:flex;"><span>│ ┌─────────────────┐ │
</span></span><span style="display:flex;"><span>│ │     Servlet     │ │
</span></span><span style="display:flex;"><span>│ │ Implementation  │ │
</span></span><span style="display:flex;"><span>│ └─────────────────┘ │
</span></span><span style="display:flex;"><span>│       Server        │
</span></span><span style="display:flex;"><span>└─────────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于Web应用程序，Servlet规范是非常重要的。Servlet规范有好几个版本，每个版本都有一些新的功能。以下是一些常见版本的新功能：</p>
<p>Servlet 1.0：定义了Servlet组件，一个Servlet组件运行在Servlet容器（Container）中，通过与容器交互，就可以响应一个HTTP请求；</p>
<p>Servlet 2.0：定义了JSP组件，一个JSP页面可以被动态编译为Servlet组件；</p>
<p>Servlet 2.4：定义了Filter（过滤器）组件，可以实现过滤功能；</p>
<p>Servlet 2.5：支持注解，提供了ServletContextListener接口，增加了一些安全性相关的特性；</p>
<p>Servlet 3.0：支持异步处理的Servlet，支持注解配置Servlet和过滤器，增加了SessionCookieConfig接口；</p>
<p>Servlet 3.1：提供了WebSocket的支持，增加了对HTTP请求和响应的流式操作的支持，增加了对HTTP协议的新特性的支持；</p>
<p>Servlet 4.0：支持HTTP/2的新特性，提供了HTTP/2的Server Push等特性；</p>
<p>Servlet 5.0：主要是把<code>javax.servlet</code>包名改成了<code>jakarta.servlet</code>；</p>
<p>Servlet 6.0：继续增加一些新功能，并废除一部分功能。</p>
<p>目前最新的Servlet版本是6.0，我们开发Jerrymouse Server也是基于最新的Servlet 6.0。</p>
<h3 id="servlet处理流程">Servlet处理流程<a hidden class="anchor" aria-hidden="true" href="#servlet处理流程">#</a></h3>
<p>当Servlet容器接收到用户的HTTP请求后，由容器负责把请求转换为<code>HttpServletRequest</code>和<code>HttpServletResponse</code>对象，分别代表HTTP请求和响应，然后，经过若干个Filter组件后，到达最终的Servlet组件，由Servlet组件完成HTTP处理，将响应写入<code>HttpServletResponse</code>对象：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> ┌────────────────────────────────┐
</span></span><span style="display:flex;"><span> │         ServletContext         │
</span></span><span style="display:flex;"><span> │                                │
</span></span><span style="display:flex;"><span> │HttpServletRequest  ┌─────────┐ │
</span></span><span style="display:flex;"><span>─┼───────────────────▶│ Filter  │ │
</span></span><span style="display:flex;"><span> │HttpServletResponse └─────────┘ │
</span></span><span style="display:flex;"><span> │                         │      │
</span></span><span style="display:flex;"><span> │                         ▼      │
</span></span><span style="display:flex;"><span> │                    ┌─────────┐ │
</span></span><span style="display:flex;"><span> │                    │ Filter  │ │
</span></span><span style="display:flex;"><span> │                    └─────────┘ │
</span></span><span style="display:flex;"><span> │                         │      │
</span></span><span style="display:flex;"><span> │ ┌─────────┐             ▼      │
</span></span><span style="display:flex;"><span> │ │Listener │        ┌─────────┐ │
</span></span><span style="display:flex;"><span> │ └─────────┘        │ Filter  │ │
</span></span><span style="display:flex;"><span> │ ┌─────────┐        └─────────┘ │
</span></span><span style="display:flex;"><span> │ │Listener │             │      │
</span></span><span style="display:flex;"><span> │ └─────────┘             ▼      │
</span></span><span style="display:flex;"><span> │ ┌─────────┐        ┌─────────┐ │
</span></span><span style="display:flex;"><span> │ │Listener │        │ Servlet │ │
</span></span><span style="display:flex;"><span> │ └─────────┘        └─────────┘ │
</span></span><span style="display:flex;"><span> └────────────────────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中，<code>ServletContext</code>代表整个容器的信息，如果容器实现了<code>ServletContext</code>接口，也可以把<code>ServletContext</code>可以看作容器本身。<code>ServletContext</code>、<code>HttpServletRequest</code>和<code>HttpServletResponse</code>都是接口，具体实现由Web服务器完成。<code>Filter</code>、<code>Servlet</code>组件也是接口，但具体实现由Web App完成。此外，还有一种<code>Listener</code>接口，可以监听各种事件，但不直接参与处理HTTP请求，具体实现由Web App完成，何时调用则由容器决定。因此，针对Web App的三大组件：<code>Servlet</code>、<code>Filter</code>和<code>Listener</code>都是运行在容器中的组件，只有容器才能主动调用它们。（此处略去JSP组件，因为我们不打算支持JSP）</p>
<p>对于Jerrymouse服务器来说，开发服务器就必须实现Servlet容器本身，容器实现<code>ServletContext</code>接口，容器内部管理若干个<code>Servlet</code>、<code>Filter</code>和<code>Listener</code>组件。</p>
<p>对每个请求，需要创建<code>HttpServletRequest</code>和<code>HttpServletResponse</code>实例，查找并匹配合适的一组<code>Filter</code>和一个<code>Servlet</code>，让它们处理HTTP请求。</p>
<p>在处理过程中，会产生各种事件，容器负责将产生的事件发送到<code>Listener</code>组件处理。</p>
<p>以上就是我们编写Servlet容器按照Servlet规范所必须的全部功能。</p>
<h1 id="实现http服务器">实现HTTP服务器<a hidden class="anchor" aria-hidden="true" href="#实现http服务器">#</a></h1>
<p>我们设计的Jerrymouse Server的架构如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>  ┌───────────────────────────────┐
</span></span><span style="display:flex;"><span>  │       Jerrymouse Server       │
</span></span><span style="display:flex;"><span>  │                 ┌───────────┐ │
</span></span><span style="display:flex;"><span>  │  ┌─────────┐    │  Context  │ │
</span></span><span style="display:flex;"><span>  │  │  HTTP   │    │┌─────────┐│ │
</span></span><span style="display:flex;"><span>◀─┼─▶│Connector│◀──▶││ Web App ││ │
</span></span><span style="display:flex;"><span>  │  └─────────┘    │└─────────┘│ │
</span></span><span style="display:flex;"><span>  │                 └───────────┘ │
</span></span><span style="display:flex;"><span>  └───────────────────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>在实现Servlet支持之前，我们先实现一个HTTP Connector。</p>
<p>所谓Connector，这里可以简化为一个能处理HTTP请求的服务器，HTTP/1.x协议是基于TCP连接的一个简单的请求-响应协议，首先由浏览器发送请求：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>GET /hello HTTP/1.1
</span></span><span style="display:flex;"><span>Host: www.example.com
</span></span><span style="display:flex;"><span>User-Agent: curl/7.88.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span></code></pre></td></tr></table>
</div>
</div><p>请求头指出了请求的方法<code>GET</code>，主机<code>www.example.com</code>，路径<code>/hello</code>，接下来服务器解析请求，输出响应：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>HTTP/1.1 200 OK
</span></span><span style="display:flex;"><span>Server: Simple HttpServer/1.0
</span></span><span style="display:flex;"><span>Date: Fri, 07 Jul 2023 23:15:09 GMT
</span></span><span style="display:flex;"><span>Content-Type: text/html; charset=utf-8
</span></span><span style="display:flex;"><span>Content-Length: 22
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;h1&gt;Hello, world.&lt;/h1&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>响应返回状态码<code>200</code>，每个响应头<code>Header: Value</code>，最后是以<code>\r\n\r\n</code>分隔的响应内容。</p>
<p>所以我们编写HTTP Server实际上就是：</p>
<ol>
<li>监听TCP端口，等待浏览器连接；</li>
<li>接受TCP连接后，创建一个线程处理该TCP连接：
<ol>
<li>接收浏览器发送的HTTP请求；</li>
<li>解析HTTP请求；</li>
<li>处理请求；</li>
<li>发送HTTP响应；</li>
<li>重复1～4直到TCP连接关闭。</li>
</ol>
</li>
</ol>
<p>整个流程不复杂，但是处理步骤比较繁琐，尤其是解析HTTP请求，是个体力活，不但要去读HTTP协议手册，还要做大量的兼容性测试。</p>
<p>所以我们选择直接使用JDK内置的<code>jdk.httpserver</code>。<code>jdk.httpserver</code>从JDK 9开始作为一个公开模块可以直接使用，它的包是<code>com.sun.net.httpserver</code>，主要提供以下几个类：</p>
<ul>
<li>HttpServer：通过指定IP地址和端口号，定义一个HTTP服务实例；</li>
<li>HttpHandler：处理HTTP请求的核心接口，必须实现<code>handle(HttpExchange)</code>方法；</li>
<li>HttpExchange：可以读取HTTP请求的输入，并将HTTP响应输出给它。</li>
</ul>
<p>一个能处理HTTP请求的简单类实现如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> SimpleHttpHandler <span style="color:#fff;font-weight:bold">implements</span> HttpHandler {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Logger logger = LoggerFactory.<span style="color:#007f7f">getLogger</span>(getClass());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handle(HttpExchange exchange) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 获取请求方法、URI、Path、Query等:</span>
</span></span><span style="display:flex;"><span>        String method = exchange.<span style="color:#007f7f">getRequestMethod</span>();
</span></span><span style="display:flex;"><span>        URI uri = exchange.<span style="color:#007f7f">getRequestURI</span>();
</span></span><span style="display:flex;"><span>        String path = uri.<span style="color:#007f7f">getPath</span>();
</span></span><span style="display:flex;"><span>        String query = uri.<span style="color:#007f7f">getRawQuery</span>();
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;{}: {}?{}&#34;</span>, method, path, query);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 输出响应的Header:</span>
</span></span><span style="display:flex;"><span>        Headers respHeaders = exchange.<span style="color:#007f7f">getResponseHeaders</span>();
</span></span><span style="display:flex;"><span>        respHeaders.<span style="color:#007f7f">set</span>(<span style="color:#0ff;font-weight:bold">&#34;Content-Type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;text/html; charset=utf-8&#34;</span>);
</span></span><span style="display:flex;"><span>        respHeaders.<span style="color:#007f7f">set</span>(<span style="color:#0ff;font-weight:bold">&#34;Cache-Control&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;no-cache&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 设置200响应:</span>
</span></span><span style="display:flex;"><span>        exchange.<span style="color:#007f7f">sendResponseHeaders</span>(200, 0);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 输出响应的内容:</span>
</span></span><span style="display:flex;"><span>        String s = <span style="color:#0ff;font-weight:bold">&#34;&lt;h1&gt;Hello, world.&lt;/h1&gt;&lt;p&gt;&#34;</span> + LocalDateTime.<span style="color:#007f7f">now</span>().<span style="color:#007f7f">withNano</span>(0) + <span style="color:#0ff;font-weight:bold">&#34;&lt;/p&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> (OutputStream out = exchange.<span style="color:#007f7f">getResponseBody</span>()) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">write</span>(s.<span style="color:#007f7f">getBytes</span>(StandardCharsets.<span style="color:#007f7f">UTF_8</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>可见，<code>HttpExchange</code>封装了HTTP请求和响应，我们不再需要解析原始的HTTP请求，也无需构造原始的HTTP响应，而是通过<code>HttpExchange</code>间接操作，大大简化了HTTP请求的处理。</p>
<p>最后写一个<code>SimpleHttpServer</code>把启动<code>HttpServer</code>、处理请求连起来：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SimpleHttpServer <span style="color:#fff;font-weight:bold">implements</span> HttpHandler, AutoCloseable {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Logger logger = LoggerFactory.<span style="color:#007f7f">getLogger</span>(getClass());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        String host = <span style="color:#0ff;font-weight:bold">&#34;0.0.0.0&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> port = 8080;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> (SimpleHttpServer connector = <span style="color:#fff;font-weight:bold">new</span> SimpleHttpServer(host, port)) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (;;) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                    Thread.<span style="color:#007f7f">sleep</span>(1000);
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> HttpServer httpServer;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> String host;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> port;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SimpleHttpServer(String host, <span style="color:#fff;font-weight:bold">int</span> port) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">host</span> = host;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">port</span> = port;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">httpServer</span> = HttpServer.<span style="color:#007f7f">create</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;0.0.0.0&#34;</span>, 8080), 0, <span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">httpServer</span>.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;start jerrymouse http server at {}:{}&#34;</span>, host, port);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> close() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">httpServer</span>.<span style="color:#007f7f">stop</span>(3);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handle(HttpExchange exchange) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行后打开浏览器，访问<code>http://localhost:8080</code>，可以看到如下输出：</p>
<p><img alt="simple-http-server" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1556276528021568/l"></p>
<p>这样，我们就成功实现了一个简单的HTTP Server。</p>
<h1 id="实现servlet服务器">实现Servlet服务器<a hidden class="anchor" aria-hidden="true" href="#实现servlet服务器">#</a></h1>
<p>在上一节，我们已经成功实现了一个简单的HTTP服务器，但是，好像和Servlet没啥关系，因为整个操作都是基于<code>HttpExchange</code>接口做的。</p>
<p>而Servlet处理HTTP的接口是基于<code>HttpServletRequest</code>和<code>HttpServletResponse</code>，前者负责读取HTTP请求，后者负责写入HTTP响应。</p>
<p>怎么把基于<code>HttpExchange</code>的操作转换为基于<code>HttpServletRequest</code>和<code>HttpServletResponse</code>？答案是使用<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1281319245971489">Adapter模式</a>。</p>
<p>首先我们定义<code>HttpExchangeAdapter</code>，它持有一个<code>HttpExchange</code>实例，并实现<code>HttpExchangeRequest</code>和<code>HttpExchangeResponse</code>接口：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">interface</span> HttpExchangeRequest {
</span></span><span style="display:flex;"><span>    String getRequestMethod();
</span></span><span style="display:flex;"><span>    URI getRequestURI();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">interface</span> HttpExchangeResponse {
</span></span><span style="display:flex;"><span>    Headers getResponseHeaders();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> sendResponseHeaders(<span style="color:#fff;font-weight:bold">int</span> rCode, <span style="color:#fff;font-weight:bold">long</span> responseLength) <span style="color:#fff;font-weight:bold">throws</span> IOException;
</span></span><span style="display:flex;"><span>    OutputStream getResponseBody();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpExchangeAdapter <span style="color:#fff;font-weight:bold">implements</span> HttpExchangeRequest, HttpExchangeResponse {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> HttpExchange exchange;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpExchangeAdapter(HttpExchange exchange) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">exchange</span> = exchange;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 实现方法</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>紧接着我们编写<code>HttpServletRequestImpl</code>，它内部持有<code>HttpServletRequest</code>，并实现了<code>HttpServletRequest</code>接口：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpServletRequestImpl <span style="color:#fff;font-weight:bold">implements</span> HttpServletRequest {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> HttpExchangeRequest exchangeRequest;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpServletRequestImpl(HttpExchangeRequest exchangeRequest) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">exchangeRequest</span> = exchangeRequest;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 实现方法</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>同理，编写<code>HttpServletResponseImpl</code>如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpServletResponseImpl <span style="color:#fff;font-weight:bold">implements</span> HttpServletResponse {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> HttpExchangeResponse exchangeResponse;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpServletResponseImpl(HttpExchangeResponse exchangeResponse) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">exchangeResponse</span> = exchangeResponse;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 实现方法</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>用一个图表示从<code>HttpExchange</code>转换为<code>HttpServletRequest</code>和<code>HttpServletResponse</code>如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>   ┌──────────────────────┐ ┌───────────────────────┐
</span></span><span style="display:flex;"><span>   │  HttpServletRequest  │ │  HttpServletResponse  │
</span></span><span style="display:flex;"><span>   └──────────────────────┘ └───────────────────────┘
</span></span><span style="display:flex;"><span>               ▲                        ▲
</span></span><span style="display:flex;"><span>               │                        │
</span></span><span style="display:flex;"><span>   ┌──────────────────────┐ ┌───────────────────────┐
</span></span><span style="display:flex;"><span>   │HttpServletRequestImpl│ │HttpServletResponseImpl│
</span></span><span style="display:flex;"><span>┌──│- exchangeRequest     │ │- exchangeResponse ────┼──┐
</span></span><span style="display:flex;"><span>│  └──────────────────────┘ └───────────────────────┘  │
</span></span><span style="display:flex;"><span>│                                                      │
</span></span><span style="display:flex;"><span>│  ┌──────────────────────┐ ┌───────────────────────┐  │
</span></span><span style="display:flex;"><span>└─▶│ HttpExchangeRequest  │ │ HttpExchangeResponse  │◀─┘
</span></span><span style="display:flex;"><span>   └──────────────────────┘ └───────────────────────┘
</span></span><span style="display:flex;"><span>                      ▲         ▲
</span></span><span style="display:flex;"><span>                      │         │
</span></span><span style="display:flex;"><span>                      │         │
</span></span><span style="display:flex;"><span>                 ┌───────────────────┐
</span></span><span style="display:flex;"><span>                 │HttpExchangeAdapter│   ┌────────────┐
</span></span><span style="display:flex;"><span>                 │- httpExchange ────┼──▶│HttpExchange│
</span></span><span style="display:flex;"><span>                 └───────────────────┘   └────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来我们改造处理HTTP请求的<code>HttpHandler</code>接口：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpConnector <span style="color:#fff;font-weight:bold">implements</span> HttpHandler {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handle(HttpExchange exchange) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> adapter = <span style="color:#fff;font-weight:bold">new</span> HttpExchangeAdapter(exchange);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> request = <span style="color:#fff;font-weight:bold">new</span> HttpServletRequestImpl(adapter);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> response = <span style="color:#fff;font-weight:bold">new</span> HttpServletResponseImpl(adapter);
</span></span><span style="display:flex;"><span>        process(request, response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> process(HttpServletRequest request, HttpServletResponse response) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// TODO</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>handle(HttpExchange)</code>方法内部，我们创建的对象如下：</p>
<ol>
<li>HttpExchangeAdapter实例：它内部引用了jdk.httpserver提供的HttpExchange实例；</li>
<li>HttpServletRequestImpl实例：它内部引用了HttpExchangeAdapter实例，但是转换为HttpExchangeRequest接口；</li>
<li>HttpServletResponseImpl实例：它内部引用了HttpExchangeAdapter实例，但是转换为HttpExchangeResponse接口。</li>
</ol>
<p>所以实际上创建的实例只有3个。最后调用<code>process(HttpServletRequest, HttpServletResponse)</code>方法，这个方法内部就可以按照Servlet标准来处理HTTP请求了，因为方法参数是标准的Servlet接口：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> process(HttpServletRequest request, HttpServletResponse response) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>    String name = request.<span style="color:#007f7f">getParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;name&#34;</span>);
</span></span><span style="display:flex;"><span>    String html = <span style="color:#0ff;font-weight:bold">&#34;&lt;h1&gt;Hello, &#34;</span> + (name == <span style="color:#fff;font-weight:bold">null</span> ? <span style="color:#0ff;font-weight:bold">&#34;world&#34;</span> : name) + <span style="color:#0ff;font-weight:bold">&#34;.&lt;/h1&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>    response.<span style="color:#007f7f">setContentType</span>(<span style="color:#0ff;font-weight:bold">&#34;text/html&#34;</span>);
</span></span><span style="display:flex;"><span>    PrintWriter pw = response.<span style="color:#007f7f">getWriter</span>();
</span></span><span style="display:flex;"><span>    pw.<span style="color:#007f7f">write</span>(html);
</span></span><span style="display:flex;"><span>    pw.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>目前，我们仅实现了代码调用时用到的<code>getParameter()</code>、<code>setContentType()</code>和<code>getWriter()</code>这几个方法。如果补全<code>HttpServletRequest</code>和<code>HttpServletResponse</code>接口所有的方法定义，我们就得到了完整的<code>HttpServletRequest</code>和<code>HttpServletResponse</code>接口实现。</p>
<p>运行代码，在浏览器输入<code>http://localhost:8080/?name=World</code>，结果如下：</p>
<p><img alt="simple-servlet-server" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1556283320696896/l"></p>
<h1 id="实现servlet组件">实现Servlet组件<a hidden class="anchor" aria-hidden="true" href="#实现servlet组件">#</a></h1>
<p>现在，我们已经成功实现了一个<code>HttpConnector</code>，并且，将jdk.httpserver提供的输入输出<code>HttpExchange</code>转换为Servlet标准定义的<code>HttpServletRequest</code>和<code>HttpServletResponse</code>接口，最终处理方法如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> process(HttpServletRequest request, HttpServletResponse response) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// TODO</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样，我们就有了处理<code>HttpServletRequest</code>和<code>HttpServletResponse</code>的入口，回顾一下Jerrymouse设计的架构图：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>  ┌───────────────────────────────┐
</span></span><span style="display:flex;"><span>  │       Jerrymouse Server       │
</span></span><span style="display:flex;"><span>  │                 ┌───────────┐ │
</span></span><span style="display:flex;"><span>  │  ┌─────────┐    │  Context  │ │
</span></span><span style="display:flex;"><span>  │  │  HTTP   │    │┌─────────┐│ │
</span></span><span style="display:flex;"><span>◀─┼─▶│Connector│◀──▶││ Web App ││ │
</span></span><span style="display:flex;"><span>  │  └─────────┘    │└─────────┘│ │
</span></span><span style="display:flex;"><span>  │                 └───────────┘ │
</span></span><span style="display:flex;"><span>  └───────────────────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们让<code>HttpConnector</code>持有一个Context实例，在Context定义<code>process(req, resp)</code>方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>          │
</span></span><span style="display:flex;"><span>          ▼
</span></span><span style="display:flex;"><span>┌───────────────────┐
</span></span><span style="display:flex;"><span>│   HttpConnector   │
</span></span><span style="display:flex;"><span>└───────────────────┘
</span></span><span style="display:flex;"><span>          │
</span></span><span style="display:flex;"><span>          ▼
</span></span><span style="display:flex;"><span>┌───────────────────┐
</span></span><span style="display:flex;"><span>│      Context      │
</span></span><span style="display:flex;"><span>├───────────────────┤
</span></span><span style="display:flex;"><span>│process(req, resp) │
</span></span><span style="display:flex;"><span>└───────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个Context组件本质上可以视为Servlet规范定义的<code>ServletContext</code>，而规范定义的Servlet、Filter、Listener等组件，就可以让<code>ServletContext</code>管理，后续的服务器设计就简化为如何实现<code>ServletContext</code>，以及如何管理Servlet、Filter、Listener等组件。</p>
<h2 id="实现servletcontext">实现ServletContext<a hidden class="anchor" aria-hidden="true" href="#实现servletcontext">#</a></h2>
<p>在Java Web应用程序中，<code>ServletContext</code>代表应用程序的运行环境，一个Web应用程序对应一个唯一的<code>ServletContext</code>实例，<code>ServletContext</code>可以用于：</p>
<ul>
<li>提供初始化和全局配置：可以从<code>ServletContext</code>获取Web App配置的初始化参数、资源路径等信息；</li>
<li>共享全局数据：<code>ServletContext</code>存储的数据可以被整个Web App的所有组件读写。</li>
</ul>
<p>既然<code>ServletContext</code>是一个Web App的全局唯一实例，而Web App又运行在Servlet容器中，我们在实现<code>ServletContext</code>时，完全可以把它当作Servlet容器来实现，它在内部维护一组Servlet实例，并根据Servlet配置的路由信息将请求转发给对应的Servlet处理。假设我们编写了两个Servlet：</p>
<ul>
<li>IndexServlet：映射路径为<code>/</code>；</li>
<li>HelloServlet：映射路径为<code>/hello</code>。</li>
</ul>
<p>那么，处理HTTP请求的路径如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>                     ┌────────────────────┐
</span></span><span style="display:flex;"><span>                     │   ServletContext   │
</span></span><span style="display:flex;"><span>                     ├────────────────────┤
</span></span><span style="display:flex;"><span>                     │     ┌────────────┐ │
</span></span><span style="display:flex;"><span>    ┌─────────────┐  │ ┌──▶│IndexServlet│ │
</span></span><span style="display:flex;"><span>───▶│HttpConnector│──┼─┤   ├────────────┤ │
</span></span><span style="display:flex;"><span>    └─────────────┘  │ └──▶│HelloServlet│ │
</span></span><span style="display:flex;"><span>                     │     └────────────┘ │
</span></span><span style="display:flex;"><span>                     └────────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面，我们来实现<code>ServletContext</code>。首先定义<code>ServletMapping</code>，它包含一个Servlet实例，以及将映射路径编译为正则表达式：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ServletMapping {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Pattern pattern; <span style="color:#007f7f">// 编译后的正则表达式</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Servlet servlet; <span style="color:#007f7f">// Servlet实例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ServletMapping(String urlPattern, Servlet servlet) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">pattern</span> = buildPattern(urlPattern); <span style="color:#007f7f">// 编译为正则表达式</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servlet</span> = servlet;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来实现<code>ServletContext</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ServletContextImpl <span style="color:#fff;font-weight:bold">implements</span> ServletContext {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> List&lt;ServletMapping&gt; servletMappings = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个数据结构足够能让我们实现根据请求路径路由到某个特定的Servlet：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ServletContextImpl <span style="color:#fff;font-weight:bold">implements</span> ServletContext {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// HTTP请求处理入口:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> process(HttpServletRequest request, HttpServletResponse response) <span style="color:#fff;font-weight:bold">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 请求路径:</span>
</span></span><span style="display:flex;"><span>        String path = request.<span style="color:#007f7f">getRequestURI</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 搜索Servlet:</span>
</span></span><span style="display:flex;"><span>        Servlet servlet = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (ServletMapping mapping : <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletMappings</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (mapping.<span style="color:#007f7f">matches</span>(path)) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 路径匹配:</span>
</span></span><span style="display:flex;"><span>                servlet = mapping.<span style="color:#007f7f">servlet</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (servlet == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 未匹配到任何Servlet显示404 Not Found:</span>
</span></span><span style="display:flex;"><span>            PrintWriter pw = response.<span style="color:#007f7f">getWriter</span>();
</span></span><span style="display:flex;"><span>            pw.<span style="color:#007f7f">write</span>(<span style="color:#0ff;font-weight:bold">&#34;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;p&gt;No mapping for URL: &#34;</span> + path + <span style="color:#0ff;font-weight:bold">&#34;&lt;/p&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>            pw.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 由Servlet继续处理请求:</span>
</span></span><span style="display:flex;"><span>        servlet.<span style="color:#007f7f">service</span>(request, response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样我们就实现了<code>ServletContext</code>！</p>
<p>不过，细心的同学会发现，我们编写的两个Servlet：<code>IndexServlet</code>和<code>HelloServlet</code>，还没有被添加到<code>ServletContext</code>中。那么问题来了：Servlet在什么时候被初始化？</p>
<p>答案是在创建<code>ServletContext</code>实例后，就立刻初始化所有的Servlet。我们编写一个<code>initialize()</code>方法，用于初始化Servlet：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ServletContextImpl <span style="color:#fff;font-weight:bold">implements</span> ServletContext {
</span></span><span style="display:flex;"><span>    Map&lt;String, ServletRegistrationImpl&gt; servletRegistrations = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    Map&lt;String, Servlet&gt; nameToServlets = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    List&lt;ServletMapping&gt; servletMappings = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> initialize(List&lt;Class&lt;?&gt;&gt; servletClasses) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 依次添加每个Servlet:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (Class&lt;?&gt; c : servletClasses) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 获取@WebServlet注解:</span>
</span></span><span style="display:flex;"><span>            WebServlet ws = c.<span style="color:#007f7f">getAnnotation</span>(WebServlet.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>            Class&lt;? <span style="color:#fff;font-weight:bold">extends</span> Servlet&gt; clazz = (Class&lt;? <span style="color:#fff;font-weight:bold">extends</span> Servlet&gt;) c;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 创建一个ServletRegistration.Dynamic:</span>
</span></span><span style="display:flex;"><span>            ServletRegistration.<span style="color:#007f7f">Dynamic</span> registration = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">addServlet</span>(AnnoUtils.<span style="color:#007f7f">getServletName</span>(clazz), clazz);
</span></span><span style="display:flex;"><span>            registration.<span style="color:#007f7f">addMapping</span>(AnnoUtils.<span style="color:#007f7f">getServletUrlPatterns</span>(clazz));
</span></span><span style="display:flex;"><span>            registration.<span style="color:#007f7f">setInitParameters</span>(AnnoUtils.<span style="color:#007f7f">getServletInitParams</span>(clazz));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 实例化Servlet:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (String name : <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletRegistrations</span>.<span style="color:#007f7f">keySet</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">var</span> registration = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletRegistrations</span>.<span style="color:#007f7f">get</span>(name);
</span></span><span style="display:flex;"><span>            registration.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">init</span>(registration.<span style="color:#007f7f">getServletConfig</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">nameToServlets</span>.<span style="color:#007f7f">put</span>(name, registration.<span style="color:#007f7f">servlet</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (String urlPattern : registration.<span style="color:#007f7f">getMappings</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletMappings</span>.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> ServletMapping(urlPattern, registration.<span style="color:#007f7f">servlet</span>));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            registration.<span style="color:#007f7f">initialized</span> = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ServletRegistration.<span style="color:#007f7f">Dynamic</span> addServlet(String name, Servlet servlet) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> registration = <span style="color:#fff;font-weight:bold">new</span> ServletRegistrationImpl(<span style="color:#fff;font-weight:bold">this</span>, name, servlet);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletRegistrations</span>.<span style="color:#007f7f">put</span>(name, registration);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> registration;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>从Servlet 3.0规范开始，我们必须要提供<code>addServlet()</code>动态添加一个Servlet，并且返回<code>ServletRegistration.Dynamic</code>，因此，我们在<code>initialize()</code>方法中调用<code>addServlet()</code>，完成所有Servlet的创建和初始化。</p>
<p>最后我们修改<code>HttpConnector</code>，实例化<code>ServletContextImpl</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpConnector <span style="color:#fff;font-weight:bold">implements</span> HttpHandler {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 持有ServletContext实例:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> ServletContextImpl servletContext;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> HttpServer httpServer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpConnector() <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 创建ServletContext:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span> = <span style="color:#fff;font-weight:bold">new</span> ServletContextImpl();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 初始化Servlet:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>.<span style="color:#007f7f">initialize</span>(List.<span style="color:#007f7f">of</span>(IndexServlet.<span style="color:#007f7f">class</span>, HelloServlet.<span style="color:#007f7f">class</span>));
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handle(HttpExchange exchange) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> adapter = <span style="color:#fff;font-weight:bold">new</span> HttpExchangeAdapter(exchange);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> request = <span style="color:#fff;font-weight:bold">new</span> HttpServletRequestImpl(adapter);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> response = <span style="color:#fff;font-weight:bold">new</span> HttpServletResponseImpl(adapter);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// process:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>.<span style="color:#007f7f">process</span>(request, response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行服务器，输入<code>http://localhost:8080/</code>，查看<code>IndexServlet</code>的输出：</p>
<p><img alt="index" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1556731440136257/l"></p>
<p>输入<code>http://localhost:8080/hello?name=Bob</code>，查看<code>HelloServlet</code>的输出：</p>
<p><img alt="hello" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1556731521925184/l"></p>
<p>输入错误的路径，查看404输出：</p>
<p><img alt="404" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1556731565965377/l"></p>
<p>可见，我们已经成功完成了<code>ServletContext</code>和所有Servlet的管理，并实现了正确的路由。</p>
<p>有的同学会问：Servlet本身应该是Web App开发人员实现，而不是由服务器实现。我们在服务器中却写死了两个Servlet，这显然是不合理的。正确的方式是从外部war包加载Servlet，但是这个问题我们放到后面解决。</p>
<h2 id="实现filterchain">实现FilterChain<a hidden class="anchor" aria-hidden="true" href="#实现filterchain">#</a></h2>
<p>上一节我们实现了<code>ServletContext</code>，并且能够管理所有的Servlet组件。本节我们继续增加对Filter组件的支持。</p>
<p>Filter是Servlet规范中的一个重要组件，它的作用是在HTTP请求到达Servlet之前进行预处理。它可以被一个或多个Filter按照一定的顺序组成一个处理链（FilterChain），用来处理一些公共逻辑，比如打印日志、登录检查等。</p>
<p>Filter还可以有针对性地拦截或者放行HTTP请求，本质上一个<code>FilterChain</code>就是一个<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1281319474561057">责任链</a>模式。在Servlet容器中，处理流程如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>  ┌─────────────────┐
</span></span><span style="display:flex;"><span>  │ ServletContext  │
</span></span><span style="display:flex;"><span>  │ ┌ ─ ─ ─ ─ ─ ─ ┐ │
</span></span><span style="display:flex;"><span>  │   FilterChain   │
</span></span><span style="display:flex;"><span>  │ │ ┌─────────┐ │ │
</span></span><span style="display:flex;"><span>──┼──▶│ Filter  │   │
</span></span><span style="display:flex;"><span>  │ │ └─────────┘ │ │
</span></span><span style="display:flex;"><span>  │        │        │
</span></span><span style="display:flex;"><span>  │ │      ▼      │ │
</span></span><span style="display:flex;"><span>  │   ┌─────────┐   │
</span></span><span style="display:flex;"><span>  │ │ │ Filter  │ │ │
</span></span><span style="display:flex;"><span>  │   └─────────┘   │
</span></span><span style="display:flex;"><span>  │ │      │      │ │
</span></span><span style="display:flex;"><span>  │        ▼        │
</span></span><span style="display:flex;"><span>  │ │ ┌─────────┐ │ │
</span></span><span style="display:flex;"><span>  │   │ Filter  │   │
</span></span><span style="display:flex;"><span>  │ │ └─────────┘ │ │
</span></span><span style="display:flex;"><span>  │  ─ ─ ─ ┬ ─ ─ ─  │
</span></span><span style="display:flex;"><span>  │        ▼        │
</span></span><span style="display:flex;"><span>  │   ┌─────────┐   │
</span></span><span style="display:flex;"><span>  │   │ Servlet │   │
</span></span><span style="display:flex;"><span>  │   └─────────┘   │
</span></span><span style="display:flex;"><span>  └─────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里有几点需要注意：</p>
<ol>
<li>最终处理请求的Servlet是根据请求路径选择的；</li>
<li>Filter链上的Filter是根据请求路径匹配的，可能匹配0个或多个Filter；</li>
<li>匹配的Filter将组成FilterChain进行调用。</li>
</ol>
<p>下面，我们首先将<code>Filter</code>纳入<code>ServletContext</code>中管理。和<code>ServletMapping</code>类似，先定义<code>FilterMapping</code>，它包含一个<code>Filter</code>实例，以及将映射路径编译为正则表达式：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FilterMapping {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Pattern pattern; <span style="color:#007f7f">// 编译后的正则表达式</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Filter filter;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FilterMapping(String urlPattern, Filter filter) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">pattern</span> = buildPattern(urlPattern); <span style="color:#007f7f">// 编译为正则表达式</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">filter</span> = filter;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着，根据Servlet规范，我们需要提供<code>addFilter()</code>动态添加一个<code>Filter</code>，并且返回<code>FilterRegistration.Dynamic</code>，所以需要在<code>ServletContext</code>中实现相关方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ServletContextImpl <span style="color:#fff;font-weight:bold">implements</span> ServletContext {
</span></span><span style="display:flex;"><span>    Map&lt;String, FilterRegistrationImpl&gt; filterRegistrations = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    Map&lt;String, Filter&gt; nameToFilters = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    List&lt;FilterMapping&gt; filterMappings = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 根据Class Name添加Filter:</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FilterRegistration.<span style="color:#007f7f">Dynamic</span> addFilter(String name, String className) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> addFilter(name, Class.<span style="color:#007f7f">forName</span>(className));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 根据Class添加Filter:</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FilterRegistration.<span style="color:#007f7f">Dynamic</span> addFilter(String name, Class&lt;? <span style="color:#fff;font-weight:bold">extends</span> Filter&gt; clazz) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> addFilter(name, clazz.<span style="color:#007f7f">newInstance</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 根据Filter实例添加Filter:</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FilterRegistration.<span style="color:#007f7f">Dynamic</span> addFilter(String name, Filter filter) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> registration = <span style="color:#fff;font-weight:bold">new</span> FilterRegistrationImpl(<span style="color:#fff;font-weight:bold">this</span>, name, filter);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">filterRegistrations</span>.<span style="color:#007f7f">put</span>(name, registration);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> registration;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>再添加一个<code>initFilters()</code>方法用于向容器添加<code>Filter</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ServletContextImpl <span style="color:#fff;font-weight:bold">implements</span> ServletContext {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> initFilters(List&lt;Class&lt;?&gt;&gt; filterClasses) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (Class&lt;?&gt; c : filterClasses) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 获取@WebFilter注解:</span>
</span></span><span style="display:flex;"><span>            WebFilter wf = c.<span style="color:#007f7f">getAnnotation</span>(WebFilter.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 添加Filter:</span>
</span></span><span style="display:flex;"><span>            FilterRegistration.<span style="color:#007f7f">Dynamic</span> registration = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">addFilter</span>(AnnoUtils.<span style="color:#007f7f">getFilterName</span>(clazz), clazz);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 添加URL映射:</span>
</span></span><span style="display:flex;"><span>            registration.<span style="color:#007f7f">addMappingForUrlPatterns</span>(EnumSet.<span style="color:#007f7f">of</span>(DispatcherType.<span style="color:#007f7f">REQUEST</span>), <span style="color:#fff;font-weight:bold">true</span>, AnnoUtils.<span style="color:#007f7f">getFilterUrlPatterns</span>(clazz));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 设置初始化参数:</span>
</span></span><span style="display:flex;"><span>            registration.<span style="color:#007f7f">setInitParameters</span>(AnnoUtils.<span style="color:#007f7f">getFilterInitParams</span>(clazz));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (String name : <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">filterRegistrations</span>.<span style="color:#007f7f">keySet</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 依次处理每个FilterRegistration.Dynamic:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">var</span> registration = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">filterRegistrations</span>.<span style="color:#007f7f">get</span>(name);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 调用Filter.init()方法:</span>
</span></span><span style="display:flex;"><span>            registration.<span style="color:#007f7f">filter</span>.<span style="color:#007f7f">init</span>(registration.<span style="color:#007f7f">getFilterConfig</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">nameToFilters</span>.<span style="color:#007f7f">put</span>(name, registration.<span style="color:#007f7f">filter</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 将Filter定义的每个URL映射编译为正则表达式:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (String urlPattern : registration.<span style="color:#007f7f">getUrlPatternMappings</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">filterMappings</span>.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> FilterMapping(urlPattern, registration.<span style="color:#007f7f">filter</span>));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样，我们就完成了对Filter组件的管理。</p>
<p>下一步，是改造<code>process()</code>方法，把原来直接把请求扔给<code>Servlet</code>处理，改成先匹配<code>Filter</code>，处理后再扔给最终的<code>Servlet</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ServletContextImpl <span style="color:#fff;font-weight:bold">implements</span> ServletContext {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> process(HttpServletRequest request, HttpServletResponse response) <span style="color:#fff;font-weight:bold">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 获取请求路径:</span>
</span></span><span style="display:flex;"><span>        String path = request.<span style="color:#007f7f">getRequestURI</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 查找Servlet:</span>
</span></span><span style="display:flex;"><span>        Servlet servlet = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (ServletMapping mapping : <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletMappings</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (mapping.<span style="color:#007f7f">matches</span>(path)) {
</span></span><span style="display:flex;"><span>                servlet = mapping.<span style="color:#007f7f">servlet</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (servlet == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 404错误:</span>
</span></span><span style="display:flex;"><span>            PrintWriter pw = response.<span style="color:#007f7f">getWriter</span>();
</span></span><span style="display:flex;"><span>            pw.<span style="color:#007f7f">write</span>(<span style="color:#0ff;font-weight:bold">&#34;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;p&gt;No mapping for URL: &#34;</span> + path + <span style="color:#0ff;font-weight:bold">&#34;&lt;/p&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>            pw.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 查找Filter:</span>
</span></span><span style="display:flex;"><span>        List&lt;Filter&gt; enabledFilters = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (FilterMapping mapping : <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">filterMappings</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (mapping.<span style="color:#007f7f">matches</span>(path)) {
</span></span><span style="display:flex;"><span>                enabledFilters.<span style="color:#007f7f">add</span>(mapping.<span style="color:#007f7f">filter</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Filter[] filters = enabledFilters.<span style="color:#007f7f">toArray</span>(Filter[]::<span style="color:#fff;font-weight:bold">new</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 构造FilterChain实例:</span>
</span></span><span style="display:flex;"><span>        FilterChain chain = <span style="color:#fff;font-weight:bold">new</span> FilterChainImpl(filters, servlet);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 由FilterChain处理:</span>
</span></span><span style="display:flex;"><span>        chain.<span style="color:#007f7f">doFilter</span>(request, response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意上述<code>FilterChain</code>不仅包含一个<code>Filter[]</code>数组，还包含一个<code>Servlet</code>，这样我们调用<code>chain.doFilter()</code>时，在<code>FilterChain</code>中最后一个处理请求的就是<code>Servlet</code>，这样设计可以简化我们实现<code>FilterChain</code>的代码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FilterChainImpl <span style="color:#fff;font-weight:bold">implements</span> FilterChain {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Filter[] filters;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Servlet servlet;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> total; <span style="color:#007f7f">// Filter总数量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> index = 0; <span style="color:#007f7f">// 下一个要处理的Filter[index]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FilterChainImpl(Filter[] filters, Servlet servlet) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">filters</span> = filters;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servlet</span> = servlet;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">total</span> = filters.<span style="color:#007f7f">length</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> doFilter(ServletRequest request, ServletResponse response) <span style="color:#fff;font-weight:bold">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (index &lt; total) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> current = index;
</span></span><span style="display:flex;"><span>            index++;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 调用下一个Filter处理:</span>
</span></span><span style="display:flex;"><span>            filters[current].<span style="color:#007f7f">doFilter</span>(request, response, <span style="color:#fff;font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 调用Servlet处理:</span>
</span></span><span style="display:flex;"><span>            servlet.<span style="color:#007f7f">service</span>(request, response);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意<code>FilterChain</code>是一个递归调用，因为在执行<code>Filter.doFilter()</code>时，需要把<code>FilterChain</code>自身传进去，在执行<code>Filter.doFilter()</code>之前，就要把<code>index</code>调整到正确的值。</p>
<p>我们编写两个测试用的Filter：</p>
<ul>
<li>LogFilter：匹配<code>/*</code>，打印请求方法、路径等信息；</li>
<li>HelloFilter：匹配<code>/hello</code>，根据请求参数决定放行还是返回403错误。</li>
</ul>
<p>在初始化ServletContextImpl时将Filter加进去，先测试<code>http://localhost:8080/</code>：</p>
<p><img alt="index" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1556731440136257/l"></p>
<p>观察后台输出，<code>LogFilter</code>应该起作用：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>16:48:00.304 [HTTP-Dispatcher] INFO  c.i.j.engine.filter.LogFilter -- GET: /
</span></span></code></pre></td></tr></table>
</div>
</div><p>再测试<code>http://localhost:8080/hello?name=Bob</code>：</p>
<p><img alt="hello" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1556731521925184/l"></p>
<p>观察后台输出，<code>HelloFilter</code>和<code>LogFilter</code>应该起作用：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>16:49:31.409 [HTTP-Dispatcher] INFO  c.i.j.engine.filter.HelloFilter -- Check parameter name = Bob
</span></span><span style="display:flex;"><span>16:49:31.409 [HTTP-Dispatcher] INFO  c.i.j.engine.filter.LogFilter -- GET: /hello
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后测试<code>http://localhost:8080/hello?name=Jim</code>：</p>
<p><img alt="403" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1556743431651392/l"></p>
<p>可以看到，<code>HelloFilter</code>拦截了请求，返回403错误，最终的<code>HelloServlet</code>并没有处理该请求。</p>
<p>现在，我们就成功地在<code>ServletContext</code>中实现了对<code>Filter</code>的管理，以及根据每个请求，构造对应的<code>FilterChain</code>来处理请求。目前还有几个小问题：</p>
<p>一是和Servlet一样，Filter本身应该是Web App开发人员实现，而不是由服务器实现。我们在在服务器中写死了两个Filter，这个问题后续解决；</p>
<p>二是Servlet规范并没有规定多个Filter应该如何排序，我们在实现时也没有对Filter进行排序。如果要按固定顺序给Filter排序，从Servlet规范来说怎么排序都可以，通常是按<code>@WebFilter</code>定义的<code>filterName</code>进行排序，Spring Boot提供的一个<code>FilterRegistrationBean</code>允许开发人员自己定义Filter的顺序。</p>
<h2 id="实现httpsession">实现HttpSession<a hidden class="anchor" aria-hidden="true" href="#实现httpsession">#</a></h2>
<p>HttpSession是Java Web App的一种机制，用于在客户端和服务器之间维护会话状态信息。</p>
<h3 id="session原理">Session原理<a hidden class="anchor" aria-hidden="true" href="#session原理">#</a></h3>
<p>当客户端第一次请求Web应用程序时，服务器会为该客户端创建一个唯一的Session ID，该ID本质上是一个随机字符串，然后，将该ID存储在客户端的一个名为<code>JSESSIONID</code>的Cookie中。与此同时，服务器会在内存中创建一个<code>HttpSession</code>对象，与Session ID关联，用于存储与该客户端相关的状态信息。</p>
<p>当客户端发送后续请求时，服务器根据客户端发送的名为<code>JSESSIONID</code>的Cookie中获得Session ID，然后查找对应的<code>HttpSession</code>对象，并从中读取或继续写入状态信息。</p>
<h3 id="session用途">Session用途<a hidden class="anchor" aria-hidden="true" href="#session用途">#</a></h3>
<p>Session主要用于维护一个客户端的会话状态。通常，用户成功登录后，可以通过如下代码创建一个新的<code>HttpSession</code>，并将用户ID、用户名等信息放入<code>HttpSession</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@WebServlet(urlPatterns = <span style="color:#0ff;font-weight:bold">&#34;/login&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LoginServlet <span style="color:#fff;font-weight:bold">extends</span> HttpServlet {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doPost(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        String username = req.<span style="color:#007f7f">getParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;username&#34;</span>);
</span></span><span style="display:flex;"><span>        String password = req.<span style="color:#007f7f">getParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;password&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (loginOk(username, password)) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 登录成功，获取Session:</span>
</span></span><span style="display:flex;"><span>            HttpSession session = req.<span style="color:#007f7f">getSession</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 将用户名放入Session:</span>
</span></span><span style="display:flex;"><span>            session.<span style="color:#007f7f">setAttribute</span>(<span style="color:#0ff;font-weight:bold">&#34;username&#34;</span>, username);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 返回首页:</span>
</span></span><span style="display:flex;"><span>            resp.<span style="color:#007f7f">sendRedirect</span>(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 登录失败:</span>
</span></span><span style="display:flex;"><span>            resp.<span style="color:#007f7f">sendRedirect</span>(<span style="color:#0ff;font-weight:bold">&#34;/error&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在其他页面，可以随时获取<code>HttpSession</code>并取出用户信息，然后在页面展示给用户：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@WebServlet(urlPatterns = <span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> IndexServlet <span style="color:#fff;font-weight:bold">extends</span> HttpServlet {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doGet(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 获取Session:</span>
</span></span><span style="display:flex;"><span>        HttpSession session = req.<span style="color:#007f7f">getSession</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 从Session中取出用户名:</span>
</span></span><span style="display:flex;"><span>        String username = (String) session.<span style="color:#007f7f">getAttribute</span>(<span style="color:#0ff;font-weight:bold">&#34;username&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (username == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 未获取到用户名，说明未登录:</span>
</span></span><span style="display:flex;"><span>            resp.<span style="color:#007f7f">sendRedirect</span>(<span style="color:#0ff;font-weight:bold">&#34;/login&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 获取到用户名，说明已登录:</span>
</span></span><span style="display:flex;"><span>            String html = <span style="color:#0ff;font-weight:bold">&#34;&lt;p&gt;Welcome, &#34;</span> + username + <span style="color:#0ff;font-weight:bold">&#34;!&lt;/p&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>            resp.<span style="color:#007f7f">setContentType</span>(<span style="color:#0ff;font-weight:bold">&#34;text/html&#34;</span>);
</span></span><span style="display:flex;"><span>            PrintWriter pw = resp.<span style="color:#007f7f">getWriter</span>();
</span></span><span style="display:flex;"><span>            pw.<span style="color:#007f7f">write</span>(html);
</span></span><span style="display:flex;"><span>            pw.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>当用户登出时，需要调用<code>HttpSession</code>的<code>invalidate()</code>方法，让会话失效，这样，用户将重新回到未登录状态，因为后续调用<code>req.getSession()</code>将返回一个新的<code>HttpSession</code>，从这个新的<code>HttpSession</code>取出的<code>username</code>将是<code>null</code>。</p>
<h3 id="httpsession的生命周期">HttpSession的生命周期<a hidden class="anchor" aria-hidden="true" href="#httpsession的生命周期">#</a></h3>
<p>第一次调用<code>req.getSession()</code>时，服务器会为该客户端创建一个新的<code>HttpSession</code>对象；</p>
<p>后续调用<code>req.getSession()</code>时，服务器会返回与之关联的<code>HttpSession</code>对象；</p>
<p>调用<code>req.getSession().invalidate()</code>时，服务器会销毁该客户端对应的<code>HttpSession</code>对象；</p>
<p>当客户端一段时间内没有新的请求，服务器会根据Session超时自动销毁超时的<code>HttpSession</code>对象。</p>
<h3 id="httpsession接口">HttpSession接口<a hidden class="anchor" aria-hidden="true" href="#httpsession接口">#</a></h3>
<p><code>HttpSession</code>是一个接口，Java的Web应用调用<code>HttpServletRequest</code>的<code>getSession()</code>方法时，需要返回一个<code>HttpSession</code>的实现类。</p>
<p>了解了以上关于<code>HttpSession</code>的相关规范后，我们就可以开始实现对<code>HttpSession</code>的支持。</p>
<p>首先，我们需要一个<code>SessionManager</code>，用来管理所有的Session：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SessionManager {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 引用ServletContext:</span>
</span></span><span style="display:flex;"><span>    ServletContextImpl servletContext;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 持有SessionID -&gt; Session:</span>
</span></span><span style="display:flex;"><span>    Map&lt;String, HttpSessionImpl&gt; sessions = <span style="color:#fff;font-weight:bold">new</span> ConcurrentHashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Session默认过期时间(秒):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> inactiveInterval;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 根据SessionID获取一个Session:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpSession getSession(String sessionId) {
</span></span><span style="display:flex;"><span>        HttpSessionImpl session = sessions.<span style="color:#007f7f">get</span>(sessionId);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (session == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Session未找到，创建一个新的Session:</span>
</span></span><span style="display:flex;"><span>            session = <span style="color:#fff;font-weight:bold">new</span> HttpSessionImpl(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>, sessionId, inactiveInterval);
</span></span><span style="display:flex;"><span>            sessions.<span style="color:#007f7f">put</span>(sessionId, session);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Session已存在，更新最后访问时间:</span>
</span></span><span style="display:flex;"><span>            session.<span style="color:#007f7f">lastAccessedTime</span> = System.<span style="color:#007f7f">currentTimeMillis</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> session;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 删除Session:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> remove(HttpSession session) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">sessions</span>.<span style="color:#007f7f">remove</span>(session.<span style="color:#007f7f">getId</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>SessionManager</code>由<code>ServletContextImpl</code>持有唯一实例。</p>
<p>再编写一个<code>HttpSession</code>的实现类<code>HttpSessionImpl</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpSessionImpl <span style="color:#fff;font-weight:bold">implements</span> HttpSession {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ServletContextImpl servletContext; <span style="color:#007f7f">// ServletContext</span>
</span></span><span style="display:flex;"><span>    String sessionId; <span style="color:#007f7f">// SessionID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> maxInactiveInterval; <span style="color:#007f7f">// 过期时间(s)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> creationTime; <span style="color:#007f7f">// 创建时间(ms)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">long</span> lastAccessedTime; <span style="color:#007f7f">// 最后一次访问时间(ms)</span>
</span></span><span style="display:flex;"><span>    Attributes attributes; <span style="color:#007f7f">// getAttribute/setAttribute</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后，我们分析一下用户调用Session的代码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>HttpSession session = request.<span style="color:#007f7f">getSession</span>();
</span></span><span style="display:flex;"><span>session.<span style="color:#007f7f">invalidate</span>();
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于<code>HttpSession</code>是从<code>HttpServletRequest</code>获得的，因此，必须在<code>HttpServletRequestImpl</code>中引用<code>ServletContextImpl</code>，才能访问<code>SessionManager</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpServletRequestImpl <span style="color:#fff;font-weight:bold">implements</span> HttpServletRequest {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 引用ServletContextImpl:</span>
</span></span><span style="display:flex;"><span>    ServletContextImpl servletContext;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 引用HttpServletResponse:</span>
</span></span><span style="display:flex;"><span>    HttpServletResponse response;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpSession getSession(<span style="color:#fff;font-weight:bold">boolean</span> create) {
</span></span><span style="display:flex;"><span>        String sessionId = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 获取所有Cookie:</span>
</span></span><span style="display:flex;"><span>        Cookie[] cookies = getCookies();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (cookies != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 查找JSESSIONID:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (Cookie cookie : cookies) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#0ff;font-weight:bold">&#34;JSESSIONID&#34;</span>.<span style="color:#007f7f">equals</span>(cookie.<span style="color:#007f7f">getName</span>())) {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">// 拿到Session ID:</span>
</span></span><span style="display:flex;"><span>                    sessionId = cookie.<span style="color:#007f7f">getValue</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 未获取到SessionID，且create=false，返回null:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (sessionId == <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; !create) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 未获取到SessionID，但create=true，创建新的Session:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (sessionId == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 如果Header已经发送，则无法创建Session，因为无法添加Cookie:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">response</span>.<span style="color:#007f7f">isCommitted</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalStateException(<span style="color:#0ff;font-weight:bold">&#34;Cannot create session for response is commited.&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 创建随机字符串作为SessionID:</span>
</span></span><span style="display:flex;"><span>            sessionId = UUID.<span style="color:#007f7f">randomUUID</span>().<span style="color:#007f7f">toString</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 构造一个名为JSESSIONID的Cookie:</span>
</span></span><span style="display:flex;"><span>            String cookieValue = <span style="color:#0ff;font-weight:bold">&#34;JSESSIONID=&#34;</span> + sessionId + <span style="color:#0ff;font-weight:bold">&#34;; Path=/; SameSite=Strict; HttpOnly&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 添加到HttpServletResponse的Header:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">response</span>.<span style="color:#007f7f">addHeader</span>(<span style="color:#0ff;font-weight:bold">&#34;Set-Cookie&#34;</span>, cookieValue);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 返回一个Session对象:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>.<span style="color:#007f7f">sessionManager</span>.<span style="color:#007f7f">getSession</span>(sessionId);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpSession getSession() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> getSession(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>对<code>HttpServletRequestImpl</code>的改造主要是加入了<code>ServletContextImpl</code>和<code>HttpServletResponse</code>的引用：可以通过前者访问到<code>SessionManager</code>，而创建的新的SessionID需要通过后者把Cookie发送到客户端，因此，在<code>HttpConnector</code>中，做相应的修改如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpConnector <span style="color:#fff;font-weight:bold">implements</span> HttpHandler {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handle(HttpExchange exchange) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> adapter = <span style="color:#fff;font-weight:bold">new</span> HttpExchangeAdapter(exchange);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> response = <span style="color:#fff;font-weight:bold">new</span> HttpServletResponseImpl(adapter);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 创建Request时，需要引用servletContext和response:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> request = <span style="color:#fff;font-weight:bold">new</span> HttpServletRequestImpl(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>, adapter, response);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// process:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>.<span style="color:#007f7f">process</span>(request, response);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            logger.<span style="color:#007f7f">error</span>(e.<span style="color:#007f7f">getMessage</span>(), e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>当用户调用<code>session.invalidate()</code>时，要让Session失效，就需要从<code>SessionManager</code>中移除：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpSessionImpl <span style="color:#fff;font-weight:bold">implements</span> HttpSession {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> invalidate() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 从SessionManager中移除:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>.<span style="color:#007f7f">sessionManager</span>.<span style="color:#007f7f">remove</span>(<span style="color:#fff;font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">sessionId</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后，我们还需要实现Session的自动过期。由于我们管理的Session实际上是以<code>Map&lt;String, HttpSession&gt;</code>存储的，所以，让Session自动过期就是定期扫描所有的Session，然后根据最后一次访问时间将过期的Session自动删除。给<code>SessionManager</code>加一个<code>Runnable</code>接口，并启动一个Daemon线程：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SessionManager <span style="color:#fff;font-weight:bold">implements</span> Runnable {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SessionManager(ServletContextImpl servletContext, <span style="color:#fff;font-weight:bold">int</span> interval) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 启动Daemon线程:</span>
</span></span><span style="display:flex;"><span>        Thread t = <span style="color:#fff;font-weight:bold">new</span> Thread(<span style="color:#fff;font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>        t.<span style="color:#007f7f">setDaemon</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        t.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 扫描线程:</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (;;) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 每60秒扫描一次:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                Thread.<span style="color:#007f7f">sleep</span>(60_000L);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 当前时间:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">long</span> now = System.<span style="color:#007f7f">currentTimeMillis</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 遍历Session:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (String sessionId : sessions.<span style="color:#007f7f">keySet</span>()) {
</span></span><span style="display:flex;"><span>                HttpSession session = sessions.<span style="color:#007f7f">get</span>(sessionId);
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 判断是否过期:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (session.<span style="color:#007f7f">getLastAccessedTime</span>() + session.<span style="color:#007f7f">getMaxInactiveInterval</span>() * 1000L &lt; now) {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">// 删除过期的Session:</span>
</span></span><span style="display:flex;"><span>                    logger.<span style="color:#007f7f">warn</span>(<span style="color:#0ff;font-weight:bold">&#34;remove expired session: {}, last access time: {}&#34;</span>, sessionId, DateUtils.<span style="color:#007f7f">formatDateTimeGMT</span>(session.<span style="color:#007f7f">getLastAccessedTime</span>()));
</span></span><span style="display:flex;"><span>                    session.<span style="color:#007f7f">invalidate</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>将<code>HttpServletRequest</code>和<code>HttpServletResponse</code>与Cookie相关的实现方法补全，我们就得到了一个基于Cookie的<code>HttpSession</code>实现！</p>
<p>最后需要注意的一点是，和<code>HttpServletRequest</code>不同，访问<code>HttpServletRequest</code>实例的一定是一个线程，因此，<code>HttpServletRequest</code>的<code>getAttribute()</code>和<code>setAttribute()</code>不需要同步，底层存储用<code>HashMap</code>即可。但是，访问<code>HttpSession</code>实例的可能是多线程，所以，<code>HttpSession</code>的<code>getAttribute()</code>和<code>setAttribute()</code>需要实现并发访问，底层存储用<code>ConcurrentHashMap</code>即可。</p>
<h3 id="测试httpsession">测试HttpSession<a hidden class="anchor" aria-hidden="true" href="#测试httpsession">#</a></h3>
<p>访问<code>IndexServlet</code>，第一次访问时，将获取到新的<code>HttpSession</code>，此时，<code>HttpSession</code>没有用户信息，因此显示登录表单：</p>
<p><img alt="index-login" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1557468186411073/l"></p>
<p>登录成功后，可以看到用户名已放入<code>HttpSession</code>，<code>IndexServlet</code>从<code>HttpSession</code>获取到用户名后将用户名显示出来：</p>
<p><img alt="index-page" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1557467855061056/l"></p>
<p>刷新页面，<code>IndexServlet</code>仍将显示登录的用户名，因为根据Cookie拿到相同的SessionID后，获取的<code>HttpSession</code>是同一个实例。</p>
<p>由于我们设定的<code>HttpSession</code>过期时间是10分钟，等待至少10分钟，观察控制台输出：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>21:41:38.001 [HTTP-Dispatcher] INFO  c.i.j.engine.filter.LogFilter -- GET: /
</span></span><span style="display:flex;"><span>21:42:05.586 [HTTP-Dispatcher] INFO  c.i.j.engine.filter.LogFilter -- GET: /
</span></span><span style="display:flex;"><span>21:52:15.578 [Thread-0] WARN  c.i.j.engine.SessionManagerImpl -- remove expired session: 899eb456-5aa3-40d4-8c64-ddc97d39c0d2, last access time: Fri, 14 Jul 2023 13:42:05 GMT
</span></span></code></pre></td></tr></table>
</div>
</div><p>大约在21:52:15时清理了过期的Session，最后一次访问时间是21:42:05（注意时间需要经过时区调整），再次刷新页面将显示登录表单：</p>
<p><img alt="index-login" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1557468186411073/l"></p>
<h2 id="实现listener">实现Listener<a hidden class="anchor" aria-hidden="true" href="#实现listener">#</a></h2>
<p>在Java Web App中，除了Servlet、Filter和HttpSession外，还有一种Listener组件，用于事件监听。</p>
<h3 id="listener原理">Listener原理<a hidden class="anchor" aria-hidden="true" href="#listener原理">#</a></h3>
<p>Listener是Java Web App中的一种事件监听机制，用于监听Web应用程序中产生的事件，例如，在<code>ServletContext</code>初始化完成后，会触发<code>contextInitialized</code>事件，实现了<code>ServletContextListener</code>接口的Listener就可以接收到事件通知，可以在内部做一些初始化工作，如加载配置文件，初始化数据库连接池等。实现了<code>HttpSessionListener</code>接口的Listener可以接收到Session的创建和消耗事件，这样就可以统计在线用户数。</p>
<p>Listener机制是基于<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1281319577321505">观察者模式</a>实现的，即当某个事件发生时，Listener会接收到通知并执行相应的操作。</p>
<h3 id="listener类型">Listener类型<a hidden class="anchor" aria-hidden="true" href="#listener类型">#</a></h3>
<p>Servlet规范定义了很多种Listener接口，常用的Listener包括：</p>
<ul>
<li><code>ServletContextListener</code>：用于监听<code>ServletContext</code>的创建和销毁事件；</li>
<li><code>HttpSessionListener</code>：用于监听<code>HttpSession</code>的创建和销毁事件；</li>
<li><code>ServletRequestListener</code>：用于监听<code>ServletRequest</code>的创建和销毁事件；</li>
<li><code>ServletContextAttributeListener</code>：用于监听<code>ServletContext</code>属性的添加、修改和删除事件；</li>
<li><code>HttpSessionAttributeListener</code>：用于监听<code>HttpSession</code>属性的添加、修改和删除事件；</li>
<li><code>ServletRequestAttributeListener</code>：用于监听<code>ServletRequest</code>属性的添加、修改和删除事件。</li>
</ul>
<p>下面我们就来实现上述常用的Listener。</p>
<p>首先我们需要在<code>ServletContextImpl</code>中注册并管理所有的Listener，所以用不同的<code>List</code>持有注册的Listener：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ServletContextImpl <span style="color:#fff;font-weight:bold">implements</span> ServletContext {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> List&lt;ServletContextListener&gt; servletContextListeners = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> List&lt;ServletContextAttributeListener&gt; servletContextAttributeListeners = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> List&lt;ServletRequestListener&gt; servletRequestListeners = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> List&lt;ServletRequestAttributeListener&gt; servletRequestAttributeListeners = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> List&lt;HttpSessionAttributeListener&gt; httpSessionAttributeListeners = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> List&lt;HttpSessionListener&gt; httpSessionListeners = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后，实现<code>ServletContext</code>的<code>addListener()</code>接口，用于注册Listener：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ServletContextImpl <span style="color:#fff;font-weight:bold">implements</span> ServletContext {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> addListener(String className) {
</span></span><span style="display:flex;"><span>        addListener(Class.<span style="color:#007f7f">forName</span>(className));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> addListener(Class&lt;? <span style="color:#fff;font-weight:bold">extends</span> EventListener&gt; clazz) {
</span></span><span style="display:flex;"><span>        addListener(clazz.<span style="color:#007f7f">newInstance</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> &lt;T <span style="color:#fff;font-weight:bold">extends</span> EventListener&gt; <span style="color:#fff;font-weight:bold">void</span> addListener(T t) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 根据Listener类型放入不同的List:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (t <span style="color:#fff;font-weight:bold">instanceof</span> ServletContextListener listener) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextListeners</span> == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextListeners</span> = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextListeners</span>.<span style="color:#007f7f">add</span>(listener);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (t <span style="color:#fff;font-weight:bold">instanceof</span> ServletContextAttributeListener listener) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextAttributeListeners</span> == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextAttributeListeners</span> = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextAttributeListeners</span>.<span style="color:#007f7f">add</span>(listener);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> ...
</span></span><span style="display:flex;"><span>            ...<span style="color:#007f7f">代码略</span>...
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalArgumentException(<span style="color:#0ff;font-weight:bold">&#34;Unsupported listener: &#34;</span> + t.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，就是在合适的时机，触发这些Listener。以<code>ServletContextAttributeListener</code>为例，统一触发的方法放在<code>ServletContextImpl</code>中：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ServletContextImpl <span style="color:#fff;font-weight:bold">implements</span> ServletContext {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> invokeServletContextAttributeAdded(String name, Object value) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;invoke ServletContextAttributeAdded: {} = {}&#34;</span>, name, value);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextAttributeListeners</span> != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">var</span> event = <span style="color:#fff;font-weight:bold">new</span> ServletContextAttributeEvent(<span style="color:#fff;font-weight:bold">this</span>, name, value);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">var</span> listener : <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextAttributeListeners</span>) {
</span></span><span style="display:flex;"><span>                listener.<span style="color:#007f7f">attributeAdded</span>(event);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> invokeServletContextAttributeRemoved(String name, Object value) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;invoke ServletContextAttributeRemoved: {} = {}&#34;</span>, name, value);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextAttributeListeners</span> != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">var</span> event = <span style="color:#fff;font-weight:bold">new</span> ServletContextAttributeEvent(<span style="color:#fff;font-weight:bold">this</span>, name, value);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">var</span> listener : <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextAttributeListeners</span>) {
</span></span><span style="display:flex;"><span>                listener.<span style="color:#007f7f">attributeRemoved</span>(event);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> invokeServletContextAttributeReplaced(String name, Object value) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;invoke ServletContextAttributeReplaced: {} = {}&#34;</span>, name, value);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextAttributeListeners</span> != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">var</span> event = <span style="color:#fff;font-weight:bold">new</span> ServletContextAttributeEvent(<span style="color:#fff;font-weight:bold">this</span>, name, value);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">var</span> listener : <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContextAttributeListeners</span>) {
</span></span><span style="display:flex;"><span>                listener.<span style="color:#007f7f">attributeReplaced</span>(event);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>当Web App的任何组件调用<code>ServletContext</code>的<code>setAttribute()</code>或<code>removeAttribute()</code>时，就可以触发事件通知：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ServletContextImpl <span style="color:#fff;font-weight:bold">implements</span> ServletContext {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setAttribute(String name, Object value) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (value == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            removeAttribute(name);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            Object old = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">attributes</span>.<span style="color:#007f7f">setAttribute</span>(name, value);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (old == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 触发attributeAdded:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">invokeServletContextAttributeAdded</span>(name, value);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 触发attributeReplaced:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">invokeServletContextAttributeReplaced</span>(name, value);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> removeAttribute(String name) {
</span></span><span style="display:flex;"><span>        Object old = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">attributes</span>.<span style="color:#007f7f">removeAttribute</span>(name);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 触发attributeRemoved:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">invokeServletContextAttributeRemoved</span>(name, old);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>其他事件触发也是类似的写法，此处不再重复。</p>
<h3 id="测试listener">测试Listener<a hidden class="anchor" aria-hidden="true" href="#测试listener">#</a></h3>
<p>为了测试Listener机制是否生效，我们还需要先编写不同类型的Listener，例如，<code>HelloHttpSessionAttributeListener</code>实现如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@WebListener
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HelloHelloHttpSessionAttributeListener <span style="color:#fff;font-weight:bold">implements</span> HttpSessionAttributeListener {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Logger logger = LoggerFactory.<span style="color:#007f7f">getLogger</span>(getClass());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> attributeAdded(HttpSessionBindingEvent event) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;&gt;&gt;&gt; HttpSession attribute added: {} = {}&#34;</span>, event.<span style="color:#007f7f">getName</span>(), event.<span style="color:#007f7f">getValue</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> attributeRemoved(HttpSessionBindingEvent event) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;&gt;&gt;&gt; HttpSession attribute removed: {} = {}&#34;</span>, event.<span style="color:#007f7f">getName</span>(), event.<span style="color:#007f7f">getValue</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> attributeReplaced(HttpSessionBindingEvent event) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;&gt;&gt;&gt; HttpSession attribute replaced: {} = {}&#34;</span>, event.<span style="color:#007f7f">getName</span>(), event.<span style="color:#007f7f">getValue</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后在<code>HttpConnector</code>中注册所有的Listener：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List&lt;Class&lt;? <span style="color:#fff;font-weight:bold">extends</span> EventListener&gt;&gt; listenerClasses = List.<span style="color:#007f7f">of</span>(HelloHttpSessionAttributeListener.<span style="color:#007f7f">class</span>, ...);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> (Class&lt;? <span style="color:#fff;font-weight:bold">extends</span> EventListener&gt; listenerClass : listenerClasses) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>.<span style="color:#007f7f">addListener</span>(listenerClass);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>启动服务器，在浏览器中登录或登出，观察日志输出，在每个请求处理前后，可以看到<code>ServletRequestListener</code>的创建和销毁事件：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>08:58:23.<span style="color:#007f7f">944</span> [HTTP-Dispatcher] INFO  c.<span style="color:#007f7f">i</span>.<span style="color:#007f7f">j</span>.<span style="color:#007f7f">e</span>.<span style="color:#007f7f">l</span>.<span style="color:#007f7f">HelloServletRequestListener</span> -- &gt;&gt;&gt; ServletRequest initialized: HttpServletRequestImpl@71a49a97[GET:/]
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>08:58:24.<span style="color:#007f7f">008</span> [HTTP-Dispatcher] INFO  c.<span style="color:#007f7f">i</span>.<span style="color:#007f7f">j</span>.<span style="color:#007f7f">e</span>.<span style="color:#007f7f">l</span>.<span style="color:#007f7f">HelloServletRequestListener</span> -- &gt;&gt;&gt; ServletRequest destroyed: HttpServletRequestImpl@71a49a97[GET:/]
</span></span></code></pre></td></tr></table>
</div>
</div><p>在第一次访问页面和登出时，可以看到<code>HttpSessionListener</code>的创建和销毁事件：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>08:58:23.<span style="color:#007f7f">947</span> [HTTP-Dispatcher] INFO  c.<span style="color:#007f7f">i</span>.<span style="color:#007f7f">j</span>.<span style="color:#007f7f">e</span>.<span style="color:#007f7f">l</span>.<span style="color:#007f7f">HelloHttpSessionListener</span> -- &gt;&gt;&gt; HttpSession created: com.<span style="color:#007f7f">itranswarp</span>.<span style="color:#007f7f">jerrymouse</span>.<span style="color:#007f7f">engine</span>.<span style="color:#007f7f">HttpSessionImpl</span>@15037a31
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>08:58:36.<span style="color:#007f7f">766</span> [HTTP-Dispatcher] INFO  c.<span style="color:#007f7f">i</span>.<span style="color:#007f7f">j</span>.<span style="color:#007f7f">e</span>.<span style="color:#007f7f">l</span>.<span style="color:#007f7f">HelloHttpSessionListener</span> -- &gt;&gt;&gt; HttpSession destroyed: com.<span style="color:#007f7f">itranswarp</span>.<span style="color:#007f7f">jerrymouse</span>.<span style="color:#007f7f">engine</span>.<span style="color:#007f7f">HttpSessionImpl</span>@15037a31
</span></span></code></pre></td></tr></table>
</div>
</div><p>其他事件的触发也可以在日志中找到，这说明我们成功地实现了Servlet规范的Listener机制。</p>
<h1 id="加载web-app">加载Web App<a hidden class="anchor" aria-hidden="true" href="#加载web-app">#</a></h1>
<p>到目前为止，我们已经实现了<code>ServletContext</code>容器，支持<code>Servlet</code>、<code>Filter</code>和<code>Listener</code>组件，支持<code>HttpSession</code>，但是，加载<code>Servlet</code>、<code>Filter</code>和<code>Listener</code>组件时，是写死在服务器里面的<code>IndexServlet</code>、<code>LogFilter</code>和<code>HelloHttpSessionListener</code>这样的类。</p>
<p>而一个正常的Web服务器是从外部加载这些组件的，根据Servlet规范，Web App开发者完成了<code>Servlet</code>、<code>Filter</code>和<code>Listener</code>等组件后，需要按规范把它们打包成<code>.war</code>文件。<code>.war</code>文件本质上就是一个jar包，但它的目录组织如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>hello-webapp
</span></span><span style="display:flex;"><span>├── WEB-INF
</span></span><span style="display:flex;"><span>│   ├── classes
</span></span><span style="display:flex;"><span>│   │   └── com
</span></span><span style="display:flex;"><span>│   │       └── example
</span></span><span style="display:flex;"><span>│   │           ├── filter
</span></span><span style="display:flex;"><span>│   │           │   └── LogFilter.class
</span></span><span style="display:flex;"><span>│   │           ├── listener
</span></span><span style="display:flex;"><span>│   │           │   ├── HelloHttpSessionListener.class
</span></span><span style="display:flex;"><span>│   │           │   └── HelloServletContextAttributeListener.class
</span></span><span style="display:flex;"><span>│   │           ├── servlet
</span></span><span style="display:flex;"><span>│   │           │   ├── HelloServlet.class
</span></span><span style="display:flex;"><span>│   │           │   └── IndexServlet.class
</span></span><span style="display:flex;"><span>│   │           └── util
</span></span><span style="display:flex;"><span>│   │               └── DateUtil.class
</span></span><span style="display:flex;"><span>│   └── lib
</span></span><span style="display:flex;"><span>│       ├── logback-classic-1.4.6.jar
</span></span><span style="display:flex;"><span>│       ├── logback-core-1.4.6.jar
</span></span><span style="display:flex;"><span>│       └── slf4j-api-2.0.4.jar
</span></span><span style="display:flex;"><span>├── contact.html
</span></span><span style="display:flex;"><span>└── favicon.ico
</span></span></code></pre></td></tr></table>
</div>
</div><p>Servlet规范规定，一个<code>.war</code>包解压后，目录<code>/WEB-INF/classes</code>存放所有编译后的<code>.class</code>文件，目录<code>/WEB-INF/lib</code>存放所有依赖的第三方jar包，其他文件可按任意目录存放。</p>
<p>Web服务器通常会提供一个用于访问文件的Servlet，对于以<code>/WEB-INF/</code>开头的路径，Web服务器会拒绝访问，其他路径则按正常文件访问，因此，路径<code>/contact.html</code>可以被访问到，而路径<code>/WEB-INF/contact.html</code>则不能被访问到。注意这个限制是针对浏览器发出的请求的路径限制，如果在Servlet内部读写<code>/WEB-INF/</code>目录下的文件则没有任何限制。利用这个限制，很多MVC框架的模版页通常会存放在<code>/WEB-INF/templates</code>目录下。</p>
<p>以上是关于<code>.war</code>包的目录规范。我们要把写死的<code>Servlet</code>、<code>Filter</code>和<code>Listener</code>组件从服务器项目中摘出来，单独实现一个<code>.war</code>包，然后，我们需要实现服务器启动后动态加载<code>war</code>包，就实现了一个比较完善的Web服务器。</p>
<h2 id="实现classloader">实现ClassLoader<a hidden class="anchor" aria-hidden="true" href="#实现classloader">#</a></h2>
<p>要通过Web服务器加载<code>war</code>包，我们首先要了解JVM的ClassLoader（类加载器）的机制。</p>
<p>在Java中，所有的类，都是由ClassLoader加载到JVM中执行的，但JVM中不止一种ClassLoader。写个简单的程序就可以测试：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Main {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(String.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getClassLoader</span>()); <span style="color:#007f7f">// null</span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(DataSource.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getClassLoader</span>()); <span style="color:#007f7f">// PlatformClassLoader</span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(Main.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getClassLoader</span>()); <span style="color:#007f7f">// AppClassLoader</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于Java核心类，如<code>java.lang.String</code>，返回<code>null</code>表示使用的是JVM内部的启动类加载器（<code>BootClassLoader</code>），对于非核心的JDK类，如<code>javax.sql.DataSource</code>，使用的是<code>PlatformClassLoader</code>，对于用户编写的类，如<code>Main</code>，使用的是<code>AppClassLoader</code>。</p>
<p>我们通常说的ClassPath机制，即JVM应该在哪些目录和哪些jar包里去找Class，实际上说的是<code>AppClassLoader</code>使用的ClassPath，这3个ClassLoader按优先级排序如下：</p>
<ol>
<li>BootClassLoader</li>
<li>PlatformClassLoader</li>
<li>AppClassLoader</li>
</ol>
<p>用AppClassLoader加载一个Class时，它首先会委托父级ClassLoader尝试加载，如果加载失败，才尝试自己加载，这就是JVM的ClassLoader使用的双亲委派模型，它是为了防止用AppClassLoader加载用户自己编写的<code>java.lang.String</code>导致破坏JDK的核心类。</p>
<p>因此，对于一个Class来说，它始终关联着一个加载它自己的ClassLoader：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>                           ┌───────────────────────────────┐
</span></span><span style="display:flex;"><span>┌───────────────────┐      │java.lang.String               │
</span></span><span style="display:flex;"><span>│  BootClassLoader  │◀─ ─ ─│java.util.List                 │
</span></span><span style="display:flex;"><span>└───────────────────┘      │...                            │
</span></span><span style="display:flex;"><span>          ▲                └───────────────────────────────┘
</span></span><span style="display:flex;"><span>          │                ┌───────────────────────────────┐
</span></span><span style="display:flex;"><span>┌───────────────────┐      │javax.sql.DataSource           │
</span></span><span style="display:flex;"><span>│PlatformClassLoader│◀─ ─ ─│javax.transaction.xa.XAResource│
</span></span><span style="display:flex;"><span>└───────────────────┘      │...                            │
</span></span><span style="display:flex;"><span>          ▲                └───────────────────────────────┘
</span></span><span style="display:flex;"><span>          │                ┌───────────────────────────────┐
</span></span><span style="display:flex;"><span>┌───────────────────┐      │com.example.Main               │
</span></span><span style="display:flex;"><span>│  AppClassLoader   │◀─ ─ ─│org.slf4j.Logger               │
</span></span><span style="display:flex;"><span>└───────────────────┘      │...                            │
</span></span><span style="display:flex;"><span>                           └───────────────────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，假设我们完成了Jerrymouse服务器的开发，那么最后得到的就是<code>jerrymouse.jar</code>这样的jar包，如果要运行一个<code>hello-webapp.war</code>，我们期待的命令行如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ java -jar jerrymouse.jar --war hello-webapp.war
</span></span></code></pre></td></tr></table>
</div>
</div><p>上述命令行的classpath实际上是<code>jerrymouse.jar</code>，服务器的类均可以被JVM的<code>AppClassLoader</code>加载，但是，<code>AppClassLoader</code>无法加载<code>hello-webapp.war</code>在<code>/WEB-INF/classes</code>存放的<code>.class</code>文件，也无法加载在<code>/WEB-INF/lib</code>存放的jar文件，原因是它们均不在classpath中，且运行期无法修改classpath。</p>
<p>因此，我们必须自己编写ClassLoader，才能加载到<code>hello-webapp.war</code>里的<code>.class</code>文件和<code>jar</code>包。</p>
<h3 id="编写classloader">编写ClassLoader<a hidden class="anchor" aria-hidden="true" href="#编写classloader">#</a></h3>
<p>为了加载<code>war</code>包里的<code>.class</code>文件和<code>jar</code>包，我们定义一个<code>WebAppClassLoader</code>。直接从<code>ClassLoader</code>继承不是不可以，但是要自己编写的代码太多。ClassLoader看起来很复杂，实际上就是想办法以任何方式拿到<code>.class</code>文件的用<code>byte[]</code>表示的内容，然后用<code>ClassLoader</code>的<code>defineClass()</code>获得JVM加载后的<code>Class</code>实例。大多数ClassLoader都是基于文件的加载，因此，JDK提供了一个<code>URLClassLoader</code>方便编写从文件加载的ClassLoader：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WebAppClassLoader <span style="color:#fff;font-weight:bold">extends</span> URLClassLoader {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> WebAppClassLoader(Path classPath, Path libPath) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(<span style="color:#0ff;font-weight:bold">&#34;WebAppClassLoader&#34;</span>, createUrls(classPath, libPath), ClassLoader.<span style="color:#007f7f">getSystemClassLoader</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 返回一组URL用于搜索class:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> URL[] createUrls(Path classPath, Path libPath) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        List&lt;URL&gt; urls = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>        urls.<span style="color:#007f7f">add</span>(toDirURL(classPath));
</span></span><span style="display:flex;"><span>        Files.<span style="color:#007f7f">list</span>(libPath).<span style="color:#007f7f">filter</span>(p -&gt; p.<span style="color:#007f7f">toString</span>().<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.jar&#34;</span>)).<span style="color:#007f7f">sorted</span>().<span style="color:#007f7f">forEach</span>(p -&gt; {
</span></span><span style="display:flex;"><span>            urls.<span style="color:#007f7f">add</span>(toJarURL(p));
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> urls.<span style="color:#007f7f">toArray</span>(URL[]::<span style="color:#fff;font-weight:bold">new</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> URL toDirURL(Path p) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 将目录转换为URL:</span>
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> URL toJarURL(Path p) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 将jar包转换为URL:</span>
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>只要传入正确的目录和一组jar包，<code>WebAppClassLoader</code>就可以加载到对应的<code>.class</code>文件。</p>
<p>下一步是修改启动流程，先解析命令行参数<code>--war</code>拿到<code>war</code>包的路径，然后解压到临时目录，获取到<code>/tmp/xxx/WEB-INF/classes</code>路径以及<code>/tmp/xxx/WEB-INF/lib</code>路径，就可以构造<code>WebAppClassLoader</code>了：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Path classesPath = ...
</span></span><span style="display:flex;"><span>Path libPath = ...
</span></span><span style="display:flex;"><span>ClassLoader classLoader = <span style="color:#fff;font-weight:bold">new</span> WebAppClassLoader(classesPath, libPath);
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，需要获取到所有的<code>Servlet</code>、<code>Filter</code>和<code>Listener</code>组件，因此需要在<code>WebAppClassLoader</code>的范围内扫描所有<code>.class</code>文件：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Set&lt;Class&lt;?&gt;&gt; classSet = ... <span style="color:#007f7f">// 扫描获得所有Class</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改<code>HttpConnector</code>，传入<code>ClassLoader</code>和扫描的Class，就可以把所有<code>Servlet</code>、<code>Filter</code>和<code>Listener</code>添加到<code>ServletContext</code>中。这样，我们就把写死的Servlet组件从服务器中移除掉，并实现了从外部war包动态加载Servlet组件。</p>
<h3 id="设置contextclassloader">设置ContextClassLoader<a hidden class="anchor" aria-hidden="true" href="#设置contextclassloader">#</a></h3>
<p>在<code>HttpConnector</code>中，我们还需要对<code>handler()</code>方法进行改进，正确设置线程的ContextClassLoader（上下文类加载器）：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handle(HttpExchange exchange) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">var</span> adapter = <span style="color:#fff;font-weight:bold">new</span> HttpExchangeAdapter(exchange);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">var</span> response = <span style="color:#fff;font-weight:bold">new</span> HttpServletResponseImpl(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">config</span>, adapter);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">var</span> request = <span style="color:#fff;font-weight:bold">new</span> HttpServletRequestImpl(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">config</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>, adapter, response);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 将线程的上下文类加载器设置为WebAppClassLoader:</span>
</span></span><span style="display:flex;"><span>        Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">setContextClassLoader</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">classLoader</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>.<span style="color:#007f7f">process</span>(request, response);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">error</span>(e.<span style="color:#007f7f">getMessage</span>(), e);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 恢复默认的线程的上下文类加载器:</span>
</span></span><span style="display:flex;"><span>        Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">setContextClassLoader</span>(<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        response.<span style="color:#007f7f">cleanup</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>为什么需要设置线程的ContextClassLoader？执行<code>handle()</code>方法的线程是由线程池提供的，线程池是<code>HttpConnector</code>创建的，因此，<code>handle()</code>方法内部加载的任何类都是由<code>AppClassLoader</code>加载的，而我们希望加载的类是由<code>WebAppClassLoader</code>从解压的<code>war</code>包中加载，此时，就需要设置线程的上下文类加载器。</p>
<p>举例说明：</p>
<p>当我们在一个方法中调用<code>Class.forName()</code>时：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Object createInstance(String className) {
</span></span><span style="display:flex;"><span>    Class&lt;?&gt; clazz = Class.<span style="color:#007f7f">forName</span>(className);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> clazz.<span style="color:#007f7f">newInstance</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>正常情况下，将由<code>AppClassLoader</code>负责查找<code>Class</code>，显然是找不到war包解压后存放在<code>classes</code>和<code>lib</code>目录里的类，只有我们自己写的<code>WebAppClassLoader</code>才能找到，因此，必须设置正确的线程上下文类加载器：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Object createInstance(String className) {
</span></span><span style="display:flex;"><span>    Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">setContextClassLoader</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">classLoader</span>);
</span></span><span style="display:flex;"><span>    Class&lt;?&gt; clazz = Class.<span style="color:#007f7f">forName</span>(className);
</span></span><span style="display:flex;"><span>    Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">setContextClassLoader</span>(<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> clazz.<span style="color:#007f7f">newInstance</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后，完善所有接口的实现类，我们就成功开发了一个迷你版的Tomcat服务器！</p>
<h2 id="部署web-app">部署Web App<a hidden class="anchor" aria-hidden="true" href="#部署web-app">#</a></h2>
<p>现在，我们已经实现了<code>WebAppClassLoader</code>，就可以启动Web Server、加载war包。</p>
<p>先编写一个简单的<code>hello-webapp</code>，实现Servlet、Filter和Listener如下：</p>
<ul>
<li>HelloServlet：输出一个简单的<code>Hello, {name}</code>；</li>
<li>LoginServlet：使用Session实现登录功能；</li>
<li>LogoutServlet：使用Session实现登出功能；</li>
<li>LogFilter：打印日志的Filter；</li>
<li>若干Listener：用于监听各种事件。</li>
</ul>
<p>用Maven打包为标准的war包，我们得到一个<code>hello-webapp-1.0.war</code>文件。</p>
<p>启动Web Server并加载war文件，使用以下命令：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ java -jar /path/to/jerrymouse-1.0.0.jar -w /path/to/hello-webapp-1.0.war
</span></span></code></pre></td></tr></table>
</div>
</div><p>确保路径正确，就可以看到如下输出：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.586</span> [main] INFO  com.itranswarp.jerrymouse.Start -- extract <span style="color:#0ff;font-weight:bold">&#39;/Users/liaoxuefeng/Git/Github/jerrymouse/step-by-step/hello-webapp/target/hello-webapp-1.0.war&#39;</span> to <span style="color:#0ff;font-weight:bold">&#39;/var/folders/np/n5bzqjhs2l521tn0bkcqvzcc0000gn/T/_jm_10421889768839940273&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.619</span> [main] INFO  com.itranswarp.jerrymouse.Start -- set web root: /<span style="color:#fff;font-weight:bold">var</span>/folders/np/n5bzqjhs2l521tn0bkcqvzcc0000gn/T/_jm_10421889768839940273
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.943</span> [main] INFO  c.i.j.classloader.WebAppClassLoader -- set classes path: /<span style="color:#fff;font-weight:bold">var</span>/folders/np/n5bzqjhs2l521tn0bkcqvzcc0000gn/T/_jm_10421889768839940273/WEB-INF/classes
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.944</span> [main] INFO  c.i.j.classloader.WebAppClassLoader -- set jar path: /<span style="color:#fff;font-weight:bold">var</span>/folders/np/n5bzqjhs2l521tn0bkcqvzcc0000gn/T/_jm_10421889768839940273/WEB-INF/lib/logback-classic-<span style="color:#ff0;font-weight:bold">1.4</span>.<span style="color:#ff0;font-weight:bold">6.j</span>ar
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.944</span> [main] INFO  c.i.j.classloader.WebAppClassLoader -- set jar path: /<span style="color:#fff;font-weight:bold">var</span>/folders/np/n5bzqjhs2l521tn0bkcqvzcc0000gn/T/_jm_10421889768839940273/WEB-INF/lib/logback-core-<span style="color:#ff0;font-weight:bold">1.4</span>.<span style="color:#ff0;font-weight:bold">6.j</span>ar
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.944</span> [main] INFO  c.i.j.classloader.WebAppClassLoader -- set jar path: /<span style="color:#fff;font-weight:bold">var</span>/folders/np/n5bzqjhs2l521tn0bkcqvzcc0000gn/T/_jm_10421889768839940273/WEB-INF/lib/slf4j-api-<span style="color:#ff0;font-weight:bold">2.0</span>.<span style="color:#ff0;font-weight:bold">4.j</span>ar
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.954</span> [main] INFO  com.itranswarp.jerrymouse.Start -- Found <span style="color:#f00">@</span>WebServlet: com.itranswarp.sample.web.HelloServlet
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.955</span> [main] INFO  com.itranswarp.jerrymouse.Start -- Found <span style="color:#f00">@</span>WebServlet: com.itranswarp.sample.web.LoginServlet
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.956</span> [main] INFO  com.itranswarp.jerrymouse.Start -- Found <span style="color:#f00">@</span>WebServlet: com.itranswarp.sample.web.LogoutServlet
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.960</span> [main] INFO  com.itranswarp.jerrymouse.Start -- Found <span style="color:#f00">@</span>WebFilter: com.itranswarp.sample.web.filter.LogFilter
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.962</span> [main] INFO  com.itranswarp.jerrymouse.Start -- Found <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloHttpSessionAttributeListener
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.963</span> [main] INFO  com.itranswarp.jerrymouse.Start -- Found <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloHttpSessionListener
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.964</span> [main] INFO  com.itranswarp.jerrymouse.Start -- Found <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloServletContextAttributeListener
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.965</span> [main] INFO  com.itranswarp.jerrymouse.Start -- Found <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloServletContextListener
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.966</span> [main] INFO  com.itranswarp.jerrymouse.Start -- Found <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloServletRequestAttributeListener
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">07.967</span> [main] INFO  com.itranswarp.jerrymouse.Start -- Found <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloServletRequestListener
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">08.003</span> [main] ERROR com.itranswarp.jerrymouse.Start -- <span style="color:#fff;font-weight:bold">load</span> <span style="color:#fff;font-weight:bold">class</span> <span style="color:#0ff;font-weight:bold">&#39;ch.qos.logback.core.net.LoginAuthenticator&#39;</span> failed: NoClassDefFoundError: jakarta/mail/Authenticator
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">08.038</span> [main] INFO  c.i.j.connector.HttpConnector -- starting jerrymouse http server at <span style="color:#ff0;font-weight:bold">0.0</span>.<span style="color:#ff0;font-weight:bold">0.0</span>:<span style="color:#ff0;font-weight:bold">8080.</span>..
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">08.044</span> [main] INFO  c.i.j.engine.ServletContextImpl -- set web root: /<span style="color:#fff;font-weight:bold">var</span>/folders/np/n5bzqjhs2l521tn0bkcqvzcc0000gn/T/_jm_10421889768839940273
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">08.044</span> [main] INFO  c.i.j.engine.ServletContextImpl -- auto register <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloServletRequestAttributeListener
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">08.045</span> [main] INFO  c.i.j.engine.ServletContextImpl -- auto register <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloHttpSessionAttributeListener
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">08.045</span> [main] INFO  c.i.j.engine.ServletContextImpl -- auto register <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloServletContextListener
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">08.045</span> [main] INFO  c.i.j.engine.ServletContextImpl -- auto register <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloHttpSessionListener
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">08.045</span> [main] INFO  c.i.j.engine.ServletContextImpl -- auto register <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloServletContextAttributeListener
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">10</span>:<span style="color:#ff0;font-weight:bold">20</span>:<span style="color:#ff0;font-weight:bold">08.045</span> [main] INFO  c.i.j.engine.ServletContextImpl -- auto register <span style="color:#f00">@</span>WebListener: com.itranswarp.sample.web.listener.HelloServletRequestListener
</span></span></code></pre></td></tr></table>
</div>
</div><p>从日志信息可知，<code>war</code>包被自动解压到临时目录，然后，初始化<code>WebAppClassLoader</code>，定位<code>classes</code>目录和<code>lib</code>目录下的所有jar包，自动扫描所有class文件，找出Servlet、Filter和Listener组件并自动注册，我们就可以在浏览器测试页面：</p>
<p><img alt="index-page" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1557467855061056/l"></p>
<p>并在后台观察Listener输出：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>10:20:49.380 [pool-1-thread-11] DEBUG c.i.j.engine.ServletContextImpl -- process /login by filter [com.itranswarp.sample.web.filter.LogFilter@7bf37a4a], servlet com.itranswarp.sample.web.LoginServlet@2a156b2d
</span></span><span style="display:flex;"><span>10:20:49.380 [pool-1-thread-11] DEBUG c.i.j.engine.ServletContextImpl -- invoke ServletRequestInitialized: request = HttpServletRequestImpl@24d2901f[GET:/login]
</span></span><span style="display:flex;"><span>10:20:49.380 [pool-1-thread-11] INFO  c.i.s.w.l.HelloServletRequestListener -- &gt;&gt;&gt; ServletRequest initialized: HttpServletRequestImpl@24d2901f[GET:/login]
</span></span><span style="display:flex;"><span>10:20:49.380 [pool-1-thread-11] INFO  c.i.sample.web.filter.LogFilter -- [GET] /login
</span></span><span style="display:flex;"><span>10:20:49.383 [pool-1-thread-11] DEBUG c.i.j.engine.ServletContextImpl -- invoke HttpSessionCreated: session = HttpSessionImpl@5c0656b[id=ef81240c-12ac-414b-96e6-fe843951fd1f]
</span></span><span style="display:flex;"><span>10:20:49.384 [pool-1-thread-11] INFO  c.i.s.w.l.HelloHttpSessionListener -- &gt;&gt;&gt; HttpSession created: HttpSessionImpl@5c0656b[id=ef81240c-12ac-414b-96e6-fe843951fd1f]
</span></span><span style="display:flex;"><span>10:20:49.385 [pool-1-thread-11] DEBUG c.i.j.engine.ServletContextImpl -- invoke ServletRequestDestroyed: request = HttpServletRequestImpl@24d2901f[GET:/login]
</span></span><span style="display:flex;"><span>10:20:49.385 [pool-1-thread-11] INFO  c.i.s.w.l.HelloServletRequestListener -- &gt;&gt;&gt; ServletRequest destroyed: HttpServletRequestImpl@24d2901f[GET:/login]
</span></span><span style="display:flex;"><span>10:21:04.777 [pool-1-thread-12] DEBUG c.i.j.engine.ServletContextImpl -- process /login by filter [com.itranswarp.sample.web.filter.LogFilter@7bf37a4a], servlet com.itranswarp.sample.web.LoginServlet@2a156b2d
</span></span><span style="display:flex;"><span>10:21:04.778 [pool-1-thread-12] DEBUG c.i.j.engine.ServletContextImpl -- invoke ServletRequestInitialized: request = HttpServletRequestImpl@73a3895e[POST:/login]
</span></span><span style="display:flex;"><span>10:21:04.778 [pool-1-thread-12] INFO  c.i.s.w.l.HelloServletRequestListener -- &gt;&gt;&gt; ServletRequest initialized: HttpServletRequestImpl@73a3895e[POST:/login]
</span></span><span style="display:flex;"><span>10:21:04.778 [pool-1-thread-12] INFO  c.i.sample.web.filter.LogFilter -- [POST] /login
</span></span><span style="display:flex;"><span>10:21:04.779 [pool-1-thread-12] DEBUG c.i.j.engine.ServletContextImpl -- invoke HttpSessionAttributeAdded: username = bob, session = HttpSessionImpl@5c0656b[id=ef81240c-12ac-414b-96e6-fe843951fd1f]
</span></span><span style="display:flex;"><span>10:21:04.780 [pool-1-thread-12] INFO  c.i.s.w.l.HelloHttpSessionAttributeListener -- &gt;&gt;&gt; HttpSession attribute added: username = bob
</span></span><span style="display:flex;"><span>10:21:04.781 [pool-1-thread-12] DEBUG c.i.j.engine.ServletContextImpl -- invoke ServletRequestDestroyed: request = HttpServletRequestImpl@73a3895e[POST:/login]
</span></span><span style="display:flex;"><span>10:21:04.781 [pool-1-thread-12] INFO  c.i.s.w.l.HelloServletRequestListener -- &gt;&gt;&gt; ServletRequest destroyed: HttpServletRequestImpl@73a3895e[POST:/login]
</span></span><span style="display:flex;"><span>10:21:04.790 [pool-1-thread-13] DEBUG c.i.j.engine.ServletContextImpl -- process /login by filter [com.itranswarp.sample.web.filter.LogFilter@7bf37a4a], servlet com.itranswarp.sample.web.LoginServlet@2a156b2d
</span></span><span style="display:flex;"><span>10:21:04.790 [pool-1-thread-13] DEBUG c.i.j.engine.ServletContextImpl -- invoke ServletRequestInitialized: request = HttpServletRequestImpl@455863b5[GET:/login]
</span></span><span style="display:flex;"><span>10:21:04.790 [pool-1-thread-13] INFO  c.i.s.w.l.HelloServletRequestListener -- &gt;&gt;&gt; ServletRequest initialized: HttpServletRequestImpl@455863b5[GET:/login]
</span></span><span style="display:flex;"><span>10:21:04.790 [pool-1-thread-13] INFO  c.i.sample.web.filter.LogFilter -- [GET] /login
</span></span><span style="display:flex;"><span>10:21:04.791 [pool-1-thread-13] DEBUG c.i.j.engine.ServletContextImpl -- invoke ServletRequestDestroyed: request = HttpServletRequestImpl@455863b5[GET:/login]
</span></span><span style="display:flex;"><span>10:21:04.791 [pool-1-thread-13] INFO  c.i.s.w.l.HelloServletRequestListener -- &gt;&gt;&gt; ServletRequest destroyed: HttpServletRequestImpl@455863b5[GET:/login]
</span></span><span style="display:flex;"><span>10:21:05.798 [pool-1-thread-14] DEBUG c.i.j.engine.ServletContextImpl -- process /logout by filter [com.itranswarp.sample.web.filter.LogFilter@7bf37a4a], servlet com.itranswarp.sample.web.LogoutServlet@20675c59
</span></span><span style="display:flex;"><span>10:21:05.798 [pool-1-thread-14] DEBUG c.i.j.engine.ServletContextImpl -- invoke ServletRequestInitialized: request = HttpServletRequestImpl@2ea0a625[GET:/logout]
</span></span><span style="display:flex;"><span>10:21:05.798 [pool-1-thread-14] INFO  c.i.s.w.l.HelloServletRequestListener -- &gt;&gt;&gt; ServletRequest initialized: HttpServletRequestImpl@2ea0a625[GET:/logout]
</span></span><span style="display:flex;"><span>10:21:05.798 [pool-1-thread-14] INFO  c.i.sample.web.filter.LogFilter -- [GET] /logout
</span></span><span style="display:flex;"><span>10:21:05.798 [pool-1-thread-14] DEBUG c.i.j.engine.ServletContextImpl -- invoke ServletContextAttributeRemoved: username = bob, session = HttpSessionImpl@5c0656b[id=ef81240c-12ac-414b-96e6-fe843951fd1f]
</span></span><span style="display:flex;"><span>10:21:05.798 [pool-1-thread-14] INFO  c.i.s.w.l.HelloHttpSessionAttributeListener -- &gt;&gt;&gt; HttpSession attribute removed: username = bob
</span></span><span style="display:flex;"><span>10:21:05.798 [pool-1-thread-14] DEBUG c.i.j.engine.ServletContextImpl -- invoke HttpSessionDestroyed: session = HttpSessionImpl@5c0656b[id=ef81240c-12ac-414b-96e6-fe843951fd1f]
</span></span><span style="display:flex;"><span>10:21:05.798 [pool-1-thread-14] INFO  c.i.s.w.l.HelloHttpSessionListener -- &gt;&gt;&gt; HttpSession destroyed: HttpSessionImpl@5c0656b[id=ef81240c-12ac-414b-96e6-fe843951fd1f]
</span></span><span style="display:flex;"><span>10:21:05.799 [pool-1-thread-14] DEBUG c.i.j.engine.ServletContextImpl -- invoke ServletRequestDestroyed: request = HttpServletRequestImpl@2ea0a625[GET:/logout]
</span></span><span style="display:flex;"><span>10:21:05.799 [pool-1-thread-14] INFO  c.i.s.w.l.HelloServletRequestListener -- &gt;&gt;&gt; ServletRequest destroyed: HttpServletRequestImpl@2ea0a625[GET:/logout]
</span></span></code></pre></td></tr></table>
</div>
</div><p>此外，因为我们没有定义映射到<code>/</code>的Servlet，因此，Web Server自动注册一个内置的<code>DefaultServlet</code>，用于显示目录：</p>
<p><img alt="index-page" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1560099061497920/l"></p>
<p>按Ctrl+C关闭服务器，由于我们在Web Server启动时设置了ShutdownHook，所以临时目录会被自动删除。</p>
<h2 id="部署spring-web-app">部署Spring Web App<a hidden class="anchor" aria-hidden="true" href="#部署spring-web-app">#</a></h2>
<p>现在，我们编写的Jerrymouse Server运行一个简单的<code>hello-webapp</code>没问题，那么复杂的Web App呢？</p>
<p>我们来编写一个基于Spring MVC的Web App。</p>
<p>首先，我们要加载Spring内置的<code>DispatcherServlet</code>，如果用传统的<code>web.xml</code>配置，则可以编写如下配置文件：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;web-app&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;servlet&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;servlet-name&gt;</span>dispatcher<span style="font-weight:bold">&lt;/servlet-name&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span style="font-weight:bold">&lt;/servlet-class&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;init-param&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;param-name&gt;</span>contextClass<span style="font-weight:bold">&lt;/param-name&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;param-value&gt;</span>org.springframework.web.context.support.AnnotationConfigWebApplicationContext<span style="font-weight:bold">&lt;/param-value&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/init-param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;init-param&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;param-name&gt;</span>contextConfigLocation<span style="font-weight:bold">&lt;/param-name&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;param-value&gt;</span>com.itranswarp.sample.AppConfig<span style="font-weight:bold">&lt;/param-value&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/init-param&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/servlet&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;servlet-mapping&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;servlet-name&gt;</span>dispatcher<span style="font-weight:bold">&lt;/servlet-name&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;url-pattern&gt;</span>/<span style="font-weight:bold">&lt;/url-pattern&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/servlet-mapping&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/web-app&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是，我们已经干掉了通过<code>web.xml</code>配置的方式，只支持自动扫描<code>@WebServlet</code>，因此，需要编写一个继承自<code>DispatcherServlet</code>的<code>AppDispatcherServlet</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@WebServlet(
</span></span><span style="display:flex;"><span>    urlPatterns = <span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>,
</span></span><span style="display:flex;"><span>    initParams = {
</span></span><span style="display:flex;"><span>        @WebInitParam(name = <span style="color:#0ff;font-weight:bold">&#34;contextClass&#34;</span>, value = <span style="color:#0ff;font-weight:bold">&#34;org.springframework.web.context.support.AnnotationConfigWebApplicationContext&#34;</span>),
</span></span><span style="display:flex;"><span>        @WebInitParam(name = <span style="color:#0ff;font-weight:bold">&#34;contextConfigLocation&#34;</span>, value = <span style="color:#0ff;font-weight:bold">&#34;com.itranswarp.sample.AppConfig&#34;</span>) })
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppDispatcherServlet <span style="color:#fff;font-weight:bold">extends</span> DispatcherServlet {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样，Jerrymouse Server会自动扫描到<code>AppDispatcherServlet</code>，然后，根据<code>@WebServlet</code>的配置，启动Spring容器，类型为<code>AnnotationConfigWebApplicationContext</code>，配置类<code>com.itranswarp.sample.AppConfig</code>，所以还需要编写配置类<code>AppConfig</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span>@EnableWebMvc
</span></span><span style="display:flex;"><span>@EnableTransactionManagement
</span></span><span style="display:flex;"><span>@PropertySource(<span style="color:#0ff;font-weight:bold">&#34;classpath:/jdbc.properties&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    WebMvcConfigurer createWebMvcConfigurer() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> WebMvcConfigurer() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> addResourceHandlers(ResourceHandlerRegistry registry) {
</span></span><span style="display:flex;"><span>                registry.<span style="color:#007f7f">addResourceHandler</span>(<span style="color:#0ff;font-weight:bold">&#34;/static/**&#34;</span>).<span style="color:#007f7f">addResourceLocations</span>(<span style="color:#0ff;font-weight:bold">&#34;/static/&#34;</span>);
</span></span><span style="display:flex;"><span>                registry.<span style="color:#007f7f">addResourceHandler</span>(<span style="color:#0ff;font-weight:bold">&#34;/favicon.ico&#34;</span>).<span style="color:#007f7f">addResourceLocations</span>(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    ViewResolver createViewResolver(@Autowired ServletContext servletContext) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> engine = <span style="color:#fff;font-weight:bold">new</span> PebbleEngine.<span style="color:#007f7f">Builder</span>().<span style="color:#007f7f">autoEscaping</span>(<span style="color:#fff;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// loader:</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">loader</span>(<span style="color:#fff;font-weight:bold">new</span> Servlet5Loader(servletContext))
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// build:</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> viewResolver = <span style="color:#fff;font-weight:bold">new</span> PebbleViewResolver(engine);
</span></span><span style="display:flex;"><span>        viewResolver.<span style="color:#007f7f">setPrefix</span>(<span style="color:#0ff;font-weight:bold">&#34;/WEB-INF/templates/&#34;</span>);
</span></span><span style="display:flex;"><span>        viewResolver.<span style="color:#007f7f">setSuffix</span>(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> viewResolver;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    DataSource createDataSource(@Value(<span style="color:#0ff;font-weight:bold">&#34;${jdbc.driver}&#34;</span>) String jdbcDriver, @Value(<span style="color:#0ff;font-weight:bold">&#34;${jdbc.url}&#34;</span>) String jdbcUrl,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${jdbc.username}&#34;</span>) String jdbcUsername, @Value(<span style="color:#0ff;font-weight:bold">&#34;${jdbc.password}&#34;</span>) String jdbcPassword) {
</span></span><span style="display:flex;"><span>        HikariConfig config = <span style="color:#fff;font-weight:bold">new</span> HikariConfig();
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setDriverClassName</span>(jdbcDriver);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setJdbcUrl</span>(jdbcUrl);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setUsername</span>(jdbcUsername);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setPassword</span>(jdbcPassword);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">addDataSourceProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;autoCommit&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;false&#34;</span>);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">addDataSourceProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;connectionTimeout&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;5&#34;</span>);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">addDataSourceProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;idleTimeout&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;60&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> HikariDataSource(config);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    JdbcTemplate createJdbcTemplate(@Autowired DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> JdbcTemplate(dataSource);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    PlatformTransactionManager createTxManager(@Autowired DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> DataSourceTransactionManager(dataSource);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>AppConfig</code>是标准的Spring配置类，我们正常配置MVC、ViewResolver、JDBC相关的DataSource、JdbcTemplate和PlatformTransactionManager，以及Spring容器需要的Service、Controller等，就可以实现一个完整的Spring MVC的WebApp。</p>
<p>用Maven编译<code>spring-webapp</code>，得到<code>spring-webapp-1.0.war</code>文件。用以下命令运行：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ java -jar /path/to/jerrymouse-1.0.0.jar -w /path/to/spring-webapp-1.0.war
</span></span></code></pre></td></tr></table>
</div>
</div><p>观察<code>AppDispatcherServlet</code>的输出：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>10:48:08.200 [main] DEBUG o.s.w.c.s.AnnotationConfigWebApplicationContext -- Refreshing WebApplicationContext for namespace &#39;appDispatcherServlet-servlet&#39;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>10:48:08.223 [main] DEBUG c.i.j.engine.ServletContextImpl -- invoke ServletContextAttributeAdded: org.springframework.web.context.support.ServletContextScope = org.springframework.web.context.support.ServletContextScope@2616b618
</span></span><span style="display:flex;"><span>10:48:08.225 [main] DEBUG o.s.b.f.s.DefaultListableBeanFactory -- Creating shared instance of singleton bean &#39;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&#39;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>10:48:08.705 [main] DEBUG c.i.sample.AppDispatcherServlet -- Detected AcceptHeaderLocaleResolver
</span></span><span style="display:flex;"><span>10:48:08.705 [main] DEBUG c.i.sample.AppDispatcherServlet -- Detected FixedThemeResolver
</span></span><span style="display:flex;"><span>10:48:08.706 [main] DEBUG c.i.sample.AppDispatcherServlet -- Detected org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator@559fd5ec
</span></span><span style="display:flex;"><span>10:48:08.706 [main] DEBUG c.i.sample.AppDispatcherServlet -- Detected org.springframework.web.servlet.support.SessionFlashMapManager@bb12f41
</span></span><span style="display:flex;"><span>10:48:08.707 [main] DEBUG c.i.j.engine.ServletContextImpl -- invoke ServletContextAttributeAdded: org.springframework.web.servlet.FrameworkServlet.CONTEXT.appDispatcherServlet = WebApplicationContext for namespace &#39;appDispatcherServlet-servlet&#39;, started on Sat Jul 29 10:48:08 CST 2023
</span></span><span style="display:flex;"><span>10:48:08.707 [HikariPool-1 connection adder] DEBUG com.zaxxer.hikari.pool.HikariPool -- HikariPool-1 - Added connection org.hsqldb.jdbc.JDBCConnection@4b7d3c3b
</span></span><span style="display:flex;"><span>10:48:08.707 [main] DEBUG c.i.sample.AppDispatcherServlet -- enableLoggingRequestDetails=&#39;false&#39;: request parameters and headers will be masked to prevent unsafe logging of potentially sensitive data
</span></span><span style="display:flex;"><span>10:48:08.707 [main] INFO  c.i.sample.AppDispatcherServlet -- Completed initialization in 511 ms
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意到<code>AppDispatcherServlet</code>是绑定到<code>/</code>的，因此，所有请求均全部由Spring提供的<code>DispatcherServlet</code>处理，包括静态文件。</p>
<p>访问<code>http://localhost:8080</code>，观察MVC的输出：</p>
<p><img alt="spring-web-app-1" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1558459629699137/l"></p>
<p>观察登录后的输出：</p>
<p><img alt="spring-web-app-2" loading="lazy" src="https://www.liaoxuefeng.com/files/attachments/1558459654864960/l"></p>
<p>可见，Jerrymouse Server可以正常运行基于Spring MVC的Web App。不过，我们无法使用Spring提供的<code>async</code>相关功能，例如<code>DeferredResult</code>，也不能使用WebSocket相关功能。</p>
<h1 id="faq">FAQ<a hidden class="anchor" aria-hidden="true" href="#faq">#</a></h1>
<h3 id="常见问题">常见问题<a hidden class="anchor" aria-hidden="true" href="#常见问题">#</a></h3>
<p>本节列出常见的一些问题。</p>
<h3 id="如何正确实现getoutputstream和getwriter">如何正确实现getOutputStream()和getWriter()？<a hidden class="anchor" aria-hidden="true" href="#如何正确实现getoutputstream和getwriter">#</a></h3>
<p>根据Servlet规范，<code>getOutputStream()</code>和<code>getWriter()</code>在一次HTTP处理中只能二选一，不能都调用，因此，HttpServletResponse内部会用<code>callOutput</code>记录调用状态：</p>
<ul>
<li>null：未调用<code>getOutputStream()</code>和<code>getWriter()</code>；</li>
<li>Boolean.TRUE：已调用<code>getOutputStream()</code>；</li>
<li>Boolean.FALSE：已调用<code>getWriter()</code>。</li>
</ul>
<p>违反调用规则会抛出<code>IllegalStateException</code>。</p>
<h3 id="httpservletresponse为什么要实现cleanup">HttpServletResponse为什么要实现cleanup()？<a hidden class="anchor" aria-hidden="true" href="#httpservletresponse为什么要实现cleanup">#</a></h3>
<p>因为Web App可能不会调用<code>getOutputStream()</code>或<code>getWriter()</code>，而是直接设置Header后返回：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>resp.setStatus(403);
</span></span></code></pre></td></tr></table>
</div>
</div><p>此时，<code>HttpConnector</code>要调用<code>cleanup()</code>，如果发现没有发送Header，则需要立刻发送Header，否则浏览器无法收到响应。</p>
<p>此外，根据HttpConnector的实现方式，基于JDK的<code>HttpExchange</code>的<code>OutputStream</code>也需要关闭（但不一定会关闭对应的TCP连接）。</p>
<h3 id="如何对servlet排序">如何对Servlet排序？<a hidden class="anchor" aria-hidden="true" href="#如何对servlet排序">#</a></h3>
<p>Servlet需要根据映射进行排序，遵循以下原则：</p>
<ul>
<li>路径长的优先级高，例如，<code>/auth/login</code>排在<code>/auth</code>前；</li>
<li>前缀匹配比后缀匹配优先级高，例如，<code>/auth/*</code>排在<code>*.do</code>前。</li>
</ul>
<h3 id="如何处理映射">如何处理“/”映射？<a hidden class="anchor" aria-hidden="true" href="#如何处理映射">#</a></h3>
<p>根据Servlet规范，<code>/</code>相当于<code>/*</code>，但还是有所不同，因为<code>/</code>表示默认的Servlet，即所有规则均不匹配时，最后匹配<code>/</code>。</p>
<p>如果一个Web App没有提供<code>/</code>映射，则Web Server可以自动提供一个默认的映射到<code>/</code>的Servlet。Jerrymouse和Tomcat类似，提供一个浏览文件的<code>DefaultServlet</code>。</p>
<h3 id="如何处理静态文件">如何处理静态文件？<a hidden class="anchor" aria-hidden="true" href="#如何处理静态文件">#</a></h3>
<p>处理静态文件时，将URL路径<code>/path/to/file.doc</code>转换为本地文件路径<code>${webroot}/path/to/file.doc</code>，然后根据扩展名设置正确的<code>Content-Type</code>，读取文件内容，发送即可。</p>
<p>需要注意的是，Servlet规范规定，不允许访问<code>/WEB-INF/</code>开头的URL，因此，遇到访问<code>/WEB-INF/*</code>的请求时，直接返回404错误码。</p>
<h3 id="如何对filter排序">如何对Filter排序？<a hidden class="anchor" aria-hidden="true" href="#如何对filter排序">#</a></h3>
<p>Servlet规范没有对Filter排序的要求，但我们在实现时还是按<code>@WebFilter</code>的<code>filterName()</code>进行排序，这样Web App可以根据名称调整Filter的顺序。</p>
<h3 id="如何启用虚拟线程">如何启用虚拟线程？<a hidden class="anchor" aria-hidden="true" href="#如何启用虚拟线程">#</a></h3>
<p>默认情况下，Jerrymouse Server采用线程池模式，要启用虚拟线程，可以加上配置项，以创建不同类型的<code>ExecutorService</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ExecutorService executor = config.<span style="color:#007f7f">server</span>.<span style="color:#007f7f">enableVirtualThread</span> ?
</span></span><span style="display:flex;"><span>        Executors.<span style="color:#007f7f">newVirtualThreadPerTaskExecutor</span>() :
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">new</span> ThreadPoolExecutor(0, config.<span style="color:#007f7f">server</span>.<span style="color:#007f7f">threadPoolSize</span>, 0L, TimeUnit.<span style="color:#007f7f">MILLISECONDS</span>, <span style="color:#fff;font-weight:bold">new</span> LinkedBlockingQueue&lt;&gt;());
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://009965.xyz/tags/java/">Java</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://009965.xyz/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>