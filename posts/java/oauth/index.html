<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>OAuth | Wjy&#39;s Blog</title>
<meta name="keywords" content="java">
<meta name="description" content="OAuth
OAuth 2.0 是目前最流行的授权机制，用来授权第三方应用，获取用户数据。这个标准比较抽象，使用了很多术语，初学者不容易理解。其实说起来并不复杂，下面我就通过一个简单的类比，帮助大家轻松理解，OAuth 2.0 到底是什么。">
<meta name="author" content="Me, You">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/java/oauth/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="OAuth" />
<meta property="og:description" content="OAuth
OAuth 2.0 是目前最流行的授权机制，用来授权第三方应用，获取用户数据。这个标准比较抽象，使用了很多术语，初学者不容易理解。其实说起来并不复杂，下面我就通过一个简单的类比，帮助大家轻松理解，OAuth 2.0 到底是什么。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/java/oauth/" /><meta property="article:section" content="posts" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="OAuth"/>
<meta name="twitter:description" content="OAuth
OAuth 2.0 是目前最流行的授权机制，用来授权第三方应用，获取用户数据。这个标准比较抽象，使用了很多术语，初学者不容易理解。其实说起来并不复杂，下面我就通过一个简单的类比，帮助大家轻松理解，OAuth 2.0 到底是什么。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "OAuth",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/java/oauth/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "OAuth",
  "name": "OAuth",
  "description": "OAuth OAuth 2.0 是目前最流行的授权机制，用来授权第三方应用，获取用户数据。这个标准比较抽象，使用了很多术语，初学者不容易理解。其实说起来并不复杂，下面我就通过一个简单的类比，帮助大家轻松理解，OAuth 2.0 到底是什么。\n",
  "keywords": [
    "java"
  ],
  "articleBody": "OAuth OAuth 2.0 是目前最流行的授权机制，用来授权第三方应用，获取用户数据。这个标准比较抽象，使用了很多术语，初学者不容易理解。其实说起来并不复杂，下面我就通过一个简单的类比，帮助大家轻松理解，OAuth 2.0 到底是什么。\n快递员问题 我住在一个大型的居民小区，小区有门禁系统，进入的时候需要输入密码，我经常网购和点外卖，每天都有快递员来送货。我必须找到一个办法，让快递员通过门禁系统，进入小区。如果我把自己的密码，告诉快递员，他就拥有了与我同样的权限，这样好像不太合适。万一我想取消他进入小区的权力，也很麻烦，我自己的密码也得跟着改了，还得通知其他的快递员。有没有一种办法，让快递员能够自由进入小区，又不必知道小区居民的密码，而且他的唯一权限就是送货，其他需要密码的场合，他都没有权限？\n授权机制的设计 第一步，门禁系统的密码输入器下面，增加一个按钮，叫做\"获取授权\"。快递员需要首先按这个按钮，去申请授权。\n第二步，他按下按钮以后，屋主（也就是我）的手机就会跳出对话框：有人正在要求授权。系统还会显示该快递员的姓名、工号和所属的快递公司。我确认请求属实，就点击按钮，告诉门禁系统，我同意给予他进入小区的授权。\n第三步，门禁系统得到我的确认以后，向快递员显示一个进入小区的令牌（access token）。令牌就是类似密码的一串数字，只在短期内（比如七天）有效。\n第四步，快递员向门禁系统输入令牌，进入小区。\n有人可能会问，为什么不是远程为快递员开门，而要为他单独生成一个令牌？这是因为快递员可能每天都会来送货，第二天他还可以复用这个令牌。另外，有的小区有多重门禁，快递员可以使用同一个令牌通过它们。\n互联网场景 我们把上面的例子搬到互联网，就是 OAuth 的设计了。 首先，居民小区就是储存用户数据的网络服务。比如，微信储存了我的好友信息，获取这些信息，就必须经过微信的\"门禁系统\"。其次，快递员（或者说快递公司）就是第三方应用，想要穿过门禁系统，进入小区。最后，我就是用户本人，同意授权第三方应用进入小区，获取我的数据。\n简单说，OAuth 就是一种授权机制。数据的所有者告诉系统，同意授权第三方应用进入系统，获取这些数据。系统从而产生一个短期的进入令牌（token），用来代替密码，供第三方应用使用。\n令牌与密码 令牌（token）与密码（password）的作用是一样的，都可以进入系统，但是有三点差异。\n令牌是短期的，到期会自动失效，用户自己无法修改。密码一般长期有效，用户不修改，就不会发生变化。 令牌可以被数据所有者撤销，会立即失效。以上例而言，屋主可以随时取消快递员的令牌。密码一般不允许被他人撤销。 令牌有权限范围（scope），比如只能进小区的二号门。对于网络服务来说，只读令牌就比读写令牌更安全。密码一般是完整权限。 上面这些设计，保证了令牌既可以让第三方应用获得权限，同时又随时可控，不会危及系统安全。这就是OAuth 2.0 的优点。\n注意，只要知道了令牌，就能进入系统。系统一般不会再次确认身份，所以令牌必须保密，泄漏令牌与泄漏密码的后果是一样的。 这也是为什么令牌的有效期，一般都设置得很短的原因。\nOAuth 2.0 对于如何颁发令牌的细节，规定得非常详细。具体来说，一共分成四种授权类型（authorizationgrant），即四种颁发令牌的方式，适用于不同的互联网场景。\nRFC 6749 OAuth 2.0 的标准是 RFC 6749 文件。该文件先解释了 OAuth 是什么。 OAuth 引入了一个授权层，用来分离两种不同的角色：客户端和资源所有者。……资源所有者同意以后，资源服务器可以向客户端颁发令牌。客户端通过令牌，去请求数据。\n这段话的意思就是，OAuth 的核心就是向第三方应用颁发令牌。然后，RFC 6749 接着写道： （由于互联网有多种场景，）本标准定义了获得令牌的四种授权方式（authorization grant ）。 也就是说，OAuth 2.0 规定了四种获得令牌的流程。你可以选择最适合自己的那一种，向第三方应用颁发令牌。 下面就是这四种授权方式。 授权码（authorization-code） 隐藏式（implicit） 密码式（password） 客户端凭证（client credentials）\n注意，不管哪一种授权方式，第三方应用申请令牌之前，都必须先到系统备案，说明自己的身份，然后会拿到两个身份识别码：客户端 ID（client ID）和客户端密钥（client secret）。这是为了防止令牌被滥用，没有备案过的第三方应用，是不会拿到令牌的。\n第一种授权方式：授权码 授权码（authorization code）方式，指的是第三方应用先申请一个授权码，然后再用该码获取令牌。这种方式是最常用的流程，安全性也最高，它适用于那些有后端的 Web 应用。授权码通过前端传送，令牌则是储存在后端，而且所有与资源服务器的通信都在后端完成。这样的前后端分离，可以避免令牌泄漏。微信公众号获取用户信息，就是完全按照授权码模式来的。\n第一步，A 网站提供一个链接，用户点击后就会跳转到 B 网站，授权用户数据给 A 网站使用。下面就是 A 网站跳转 B 网站的一个示意链接。\n1 2 3 4 5 https://b.com/oauth/authorize? response_type=code\u0026 client_id=CLIENT_ID\u0026 redirect_uri=CALLBACK_URL\u0026 scope=read 上面 URL 中，response_type参数表示要求返回授权码（code），client_id参数让 B 知道是谁在请求，redirect_uri参数是 B 接受或拒绝请求后的跳转网址，scope参数表示要求的授权范围（这里是只读）。这一步前端自己就可以实现，不需要后端。client_id，即appId可以存在前端，没有危险。\n第二步，用户跳转后，B 网站会要求用户登录，然后询问是否同意给予 A 网站授权。用户表示同意，这时 B 网站就会跳回redirect_uri参数指定的网址。跳转时，会传回一个授权码，就像下面这样。https://a.com/callback?code=AUTHORIZATION_CODE 上面 URL 中，code参数就是授权码。前端在url上拿到code了。\n第三步，A 网站（即前端）拿到授权码code以后，将code通过接口传给后端，后端通过拿到的code，请求B网站，获取令牌。\n1 2 3 4 5 https://b.com/oauth/token? client_id=CLIENT_ID\u0026 client_secret=CLIENT_SECRET\u0026 grant_type=authorization_code\u0026 code=AUTHORIZATION_CODE 第四步，B 网站收到请求以后，就会通过上面的http请求返回json数据，其中包含了令牌，格式如下\n1 2 3 4 5 6 7 8 9 { \"access_token\":\"ACCESS_TOKEN\", \"token_type\":\"bearer\", \"expires_in\":2592000, \"refresh_token\":\"REFRESH_TOKEN\", \"scope\":\"read\", \"uid\":100101, \"info\":{...} } 上面 JSON 数据中，access_token字段就是令牌，A 网站在后端拿到了。之后就可以通过access_token来获取资源服务器的数据了。\n按照微信获取用户信息的步骤来说： 第一步：前端请求微信的接口\n1 2 3 4 String url = \"https://open.weixin.qq.com/connect/oauth2/authorize?\" + \"appid=\" + APPID + \"\u0026redirect_uri=\" + URLEncoder.encode(rediretUrl, PayConstant.DEFAULT_CHARSET) + \"\u0026response_type=code\u0026scope=snsapi_base\u0026state=123#wechat_redirect\"; 微信会将code拼到前端指定的redirect_uri的后面。\n第二步：前端拿到code后，将code传给后端，后端先通过code向微信服务器发送get请求,获取access_token和openid，然后再次向微信发送请求,通过access_token和openid,获取userinfo，然后返回给前端展示。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /** * @author: wjy * @description: h5非静默授权, 通过code获取用户信息 * 注意：code使用一次就会失效，所有每次请求接口，前端都要重新获取code */ @ResponseBody @GetMapping(\"getWxUserinfoByCode\") public JSONObject getWxUserinfoByCode(@RequestParam(\"code\") String code) { LOGGER.info(\"*************获取access_token和openid,然后获取微信userinfo***********************************************\"); JSONObject userInfoJson = new JSONObject(); try { //获取openId地址 String getOpenidUrl = \"https://api.weixin.qq.com/sns/oauth2/access_token\"; String param = \"appid=\" + WxUtil.getAppid(environment, WxPlatformConstant.PARENT_GZH)+ \"\u0026secret=\" + WxUtil.getAppSecret(environment, WxPlatformConstant.PARENT_GZH) + \"\u0026code=\" + code + \"\u0026grant_type=authorization_code\"; //向微信服务器发送get请求,获取access_token和openid String accessTokenAndOpenid = HttpUtil.sendGet(getOpenidUrl, param); JSONObject jsonObject = JSONObject.parseObject(accessTokenAndOpenid); //再次向微信发送请求,通过access_token和openid,获取userinfo String userInfo = HttpUtil.sendGet( \"https://api.weixin.qq.com/sns/userinfo\", \"access_token=\" + jsonObject.getString(\"access_token\") + \"\u0026openid=\" + jsonObject.get(\"openid\") + \"\u0026lang=zh_CN\"); userInfoJson = JSON.parseObject(userInfo); } catch (Exception e) { e.printStackTrace(); } return userInfoJson; } 两步就完事了。\n第二种方式：隐藏式(简化模式) 有些 Web 应用是纯前端应用，没有后端。这时就不能用上面的方式了，必须将令牌储存在前端。RFC 6749 就规定了第二种方式，允许直接向前端颁发令牌。这种方式没有授权码这个中间步骤，所以称为（授权码）“隐藏式”（implicit）。\n第一步，A 网站提供一个链接，要求用户跳转到 B 网站，授权用户数据给 A 网站使用。\n1 2 3 4 5 https://b.com/oauth/authorize? response_type=token\u0026 client_id=CLIENT_ID\u0026 redirect_uri=CALLBACK_URL\u0026 scope=read 上面 URL 中，response_type参数为token，表示要求直接返回令牌。 第二步，用户跳转到 B 网站，登录后同意给予 A 网站授权。这时，B 网站就会跳回redirect_uri参数指定的跳转网址，并且把令牌作为 URL 参数，传给 A 网站。 https://a.com/callback#token=ACCESS_TOKEN 上面 URL 中，token参数就是令牌，A 网站因此直接在前端拿到令牌。\n注意，令牌的位置是 URL 锚点（fragment），而不是查询字符串（querystring），这是因为 OAuth 2.0 允许跳转网址是 HTTP 协议，因此存在\"中间人攻击\"的风险，而浏览器跳转时，锚点不会发到服务器，就减少了泄漏令牌的风险。\n这种方式把令牌直接传给前端，是很不安全的。因此，只能用于一些安全要求不高的场景，并且令牌的有效期必须非常短，通常就是会话期间（session）有效，浏览器关掉，令牌就失效了。\n第三种方式：密码式 如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌，这种方式称为\"密码式\"（password）。\n第一步，A 网站要求用户提供 B 网站的用户名和密码。拿到以后，A 就直接向 B 请求令牌。\n1 2 3 4 5 https://oauth.b.com/token? grant_type=password\u0026 username=USERNAME\u0026 password=PASSWORD\u0026 client_id=CLIENT_ID 上面 URL 中，grant_type参数是授权方式，这里的password表示\"密码式\"，username和password是 B 的用户名和密码。 第二步，B 网站验证身份通过后，直接给出令牌。注意，这时不需要跳转，而是把令牌放在 JSON 数据里面，作为 HTTP 回应，A 因此拿到令牌。 这种方式需要用户给出自己的用户名/密码，显然风险很大，因此只适用于其他授权方式都无法采用的情况，而且必须是用户高度信任的应用。\n第四种方式：凭证式 最后一种方式是凭证式（client credentials），适用于没有前端的命令行应用，即在命令行下请求令牌。第一步，A 应用在命令行向 B 发出请求。\n1 2 3 4 https://oauth.b.com/token? grant_type=client_credentials\u0026 client_id=CLIENT_ID\u0026 client_secret=CLIENT_SECRET 上面 URL 中，grant_type参数等于client_credentials表示采用凭证式，client_id和client_secret用来让 B确认 A 的身份。 第二步，B 网站验证通过以后，直接返回令牌。这种方式给出的令牌，是针对第三方应用的，而不是针对用户的，即有可能多个用户共享同一个令牌。\n令牌的使用 A 网站拿到令牌以后，就可以向 B 网站的 API 请求数据了。 此时，每个发到 API 的请求，都必须带有令牌。具体做法是在请求的头信息，加上一个Authorization字段，令牌就放在这个字段里面。\n1 2 curl -H \"Authorization: Bearer ACCESS_TOKEN\" \\ \"https://api.b.com\" 上面命令中，ACCESS_TOKEN就是拿到的令牌。\n更新令牌 令牌的有效期到了，如果让用户重新走一遍上面的流程，再申请一个新的令牌，很可能体验不好，而且也没有必要。OAuth 2.0 允许用户自动更新令牌。 具体方法是，B 网站颁发令牌的时候，一次性颁发两个令牌，一个用于获取数据，另一个用于获取新的令牌（refresh token 字段）。令牌到期前，用户使用 refresh token 发一个请求，去更新令牌。\n1 2 3 4 5 https://b.com/oauth/token? grant_type=refresh_token\u0026 client_id=CLIENT_ID\u0026 client_secret=CLIENT_SECRET\u0026 refresh_token=REFRESH_TOKEN 上面 URL 中，grant_type参数为refresh_token表示要求更新令牌，client_id参数和client_secret参数用于确认身份，refresh_token参数就是用于更新令牌的令牌。\nB 网站验证通过以后，就会颁发新的令牌。\n参考阮一峰老师的文章 OAuth中文规范\nJWT(JSON WEB TOKENS) JSON Web Token（缩写 JWT）是目前最流行的跨域认证解决方案，特别适用于分布式站点的单点登录（SSO）场景。 官方标准\n跨域认证的问题 互联网服务离不开用户认证。一般流程是下面这样。 1、用户向服务器发送用户名和密码。 2、服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间等等。 3、服务器向用户返回一个 session_id，写入用户的 Cookie。 4、用户随后的每一次请求，都会通过 Cookie，将 session_id 传回服务器。 5、服务器收到 session_id，找到前期保存的数据，由此得知用户的身份。\n这种模式的问题在于，扩展性（scaling）不好。单机当然没有问题，如果是服务器集群，或者是跨域的服务导向架构，就要求 session 数据共享，每台服务器都能够读取 session。 举例来说，A 网站和 B 网站是同一家公司的关联服务。现在要求，用户只要在其中一个网站登录，再访问另一个网站就会自动登录，请问怎么实现？ 一种解决方案是 session 数据持久化，写入数据库或别的持久层。各种服务收到请求后，都向持久层请求数据。 这种方案的优点是架构清晰，缺点是工程量比较大。另外，持久层万一挂了，就会单点失败。 另一种方案是服务器索性不保存 session 数据了，所有数据都保存在客户端，每次请求都发回服务器。JWT 就是这种方案的一个代表。\nJWT 的原理 JWT 的原理是，服务器认证以后，生成一个 JSON 对象，发回给用户，就像下面这样。\n1 2 3 4 5 { \"姓名\": \"张三\", \"角色\": \"管理员\", \"到期时间\": \"2018年7月1日0点0分\" } 以后，用户与服务端通信的时候，都要发回这个 JSON 对象。服务器完全只靠这个对象认定用户身份。为了防止用户篡改数据，服务器在生成这个对象的时候，会加上签名（详见后文）。 服务器就不保存任何 session 数据了，也就是说，服务器变成无状态了，从而比较容易实现扩展。\nJWT 的数据结构 实际的 JWT 大概就像下面这样。 eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nJWT 的三个部分依次如下。 Header（头部） Payload（负载） Signature（签名）\n写成一行，就是下面的样子。 Header.Payload.Signature\nHeader Header 部分是一个 JSON 对象，描述 JWT 的元数据，通常是下面的样子。\n1 2 3 4 { \"alg\": \"HS256\", \"typ\": \"JWT\" } 上面代码中，alg属性表示签名的算法（algorithm），默认是 HMAC SHA256（写成 HS256）；typ属性表示这个令牌（token）的类型（type），JWT 令牌统一写为JWT。 最后，将上面的 JSON 对象使用 Base64URL 算法（详见后文）转成字符串。\nPayload Payload 部分也是一个 JSON 对象，用来存放实际需要传递的数据。JWT 规定了7个官方字段，供选用。\n1 2 3 4 5 6 7 iss (issuer)：签发人 exp (expiration time)：过期时间 sub (subject)：主题 aud (audience)：受众 nbf (Not Before)：生效时间 iat (Issued At)：签发时间 jti (JWT ID)：编号 除了官方字段，你还可以在这个部分定义私有字段，下面就是一个例子。\n1 2 3 4 5 { \"sub\": \"1234567890\", \"name\": \"John Doe\", \"admin\": true } 注意，JWT 默认是不加密的，任何人都可以读到，所以不要把秘密信息放在这个部分。\nSignature Signature 部分是对前两部分的签名，防止数据篡改。 首先，需要指定一个密钥（secret）。这个密钥只有服务器才知道，不能泄露给用户。然后，使用 Header 里面指定的签名算法（默认是 HMAC SHA256），按照下面的公式产生签名。\n1 2 3 4 HMACSHA256( base64UrlEncode(header) + \".\" + base64UrlEncode(payload), secret) 算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用\"点\"（.）分隔，就可以返回给用户。\nBase64URL 前面提到，Header 和 Payload 串型化的算法是 Base64URL。这个算法跟 Base64 算法基本类似，但有一些小的不同。JWT 作为一个令牌（token），有些场合可能会放到 URL（比如 api.example.com/?token=xxx）。Base64 有三个字符+、/和=，在 URL 里面有特殊含义，所以要被替换掉：=被省略、+替换成-，/替换成_ 。这就是 Base64URL 算法。\nJWT 的使用方式 客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage。 此后，客户端每次与服务器通信，都要带上这个 JWT。你可以把它放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求的头信息Authorization字段里面。 Authorization: Bearer 另一种做法是，跨域的时候，JWT 就放在 POST 请求的数据体里面。\nJWT 的几个特点 JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。 JWT 不加密的情况下，不能将秘密数据写入 JWT。 JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。 JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。 JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。 为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输。 理解Spring Cloud Security OAuth2及JWT\nSpring Security OAuth2 构建项目 用idea创建spring boot项目，并引入如下maven依赖：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 org.springframework.boot spring-boot-starter-web mysql mysql-connector-java runtime com.alibaba druid 1.0.29 org.springframework spring-jdbc 5.1.9.RELEASE org.springframework.boot spring-boot-starter-data-jpa org.springframework.boot spring-boot-starter-security org.springframework.security.oauth spring-security-oauth2 2.3.3.RELEASE 项目配置文件 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 spring: datasource: type: com.alibaba.druid.pool.DruidDataSource driver-class-name: com.mysql.jdbc.Driver url: jdbc:mysql://127.0.0.1:3306/oauth2?characterEncoding=utf8 username: root password: 123456 #最大活跃数 maxActive: 20 #初始化数量 initialSize: 1 #最大连接等待超时时间 maxWait: 60000 #打开PSCache，并且指定每个连接PSCache的大小 poolPreparedStatements: true maxPoolPreparedStatementPerConnectionSize: 20 #通过connectionProperties属性来打开mergeSql功能；慢SQL记录 #connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000 minIdle: 1 timeBetweenEvictionRunsMillis: 60000 minEvictableIdleTimeMillis: 300000 validationQuery: select 1 from dual testWhileIdle: true testOnBorrow: false testOnReturn: false #配置监控统计拦截的filters，去掉后监控界面sql将无法统计,'wall'用于防火墙 filters: stat, wall, log4j jpa: properties: hibernate: show_sql: true format_sql: true 数据库 因为我们使用数据库保存用户、角色、accessToken、RefershToken等信息，所以要新建需要的表。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 -- ---------------------------- -- 用户表 -- ---------------------------- CREATE TABLE `user` ( `username` varchar(50) NOT NULL, `email` varchar(50) DEFAULT NULL, `password` varchar(500) DEFAULT NULL, `activated` tinyint(1) DEFAULT '0', `activationkey` varchar(50) DEFAULT NULL, `resetpasswordkey` varchar(50) DEFAULT NULL, PRIMARY KEY (`username`) ) ENGINE=MyISAM DEFAULT CHARSET=utf8; -- ---------------------------- -- 用户数据。需要注意密码字段，存的是加密之后的密文。加密算法会在后面说明。 -- ---------------------------- INSERT INTO `user` VALUES ('admin', 'admin@mail.me', '$2a$10$vHCuajBQOH4ZX8LKRoRFI.6s23W9wgPUyw6VqJS5KWEZkjnT52nfi', '1', null, null); INSERT INTO `user` VALUES ('user', 'user@mail.me', '$2a$10$vHCuajBQOH4ZX8LKRoRFI.6s23W9wgPUyw6VqJS5KWEZkjnT52nfi', '1', null, null); -- ---------------------------- -- 角色表 -- ---------------------------- CREATE TABLE `authority` ( `name` varchar(50) NOT NULL, PRIMARY KEY (`name`) ) ENGINE=MyISAM DEFAULT CHARSET=utf8; -- ---------------------------- -- 角色数据 -- ---------------------------- INSERT INTO `authority` VALUES ('ROLE_ADMIN'); INSERT INTO `authority` VALUES ('ROLE_USER'); -- ---------------------------- -- 用户角色关联表 -- ---------------------------- CREATE TABLE `user_authority` ( `username` varchar(50) NOT NULL, `authority` varchar(50) NOT NULL, UNIQUE KEY `user_authority_idx_1` (`username`,`authority`), KEY `authority` (`authority`) ) ENGINE=MyISAM DEFAULT CHARSET=utf8; -- ---------------------------- -- 中间表数据 -- ---------------------------- INSERT INTO `user_authority` VALUES ('admin', 'ROLE_ADMIN'); INSERT INTO `user_authority` VALUES ('admin', 'ROLE_USER'); INSERT INTO `user_authority` VALUES ('user', 'ROLE_USER'); -- ---------------------------- -- 我们使用的是SpringSecurityOAuth2提供的Jdbc方式进行操作Token，所以需要根据标准创建对应的表结构 -- ---------------------------- CREATE TABLE `oauth_access_token` ( `token_id` varchar(256) DEFAULT NULL, `token` blob, `authentication_id` varchar(256) DEFAULT NULL, `user_name` varchar(256) DEFAULT NULL, `client_id` varchar(256) DEFAULT NULL, `authentication` blob, `refresh_token` varchar(256) DEFAULT NULL ) ENGINE=MyISAM DEFAULT CHARSET=utf8; -- ---------------------------- -- 刷新Token时需要用到refresh_token信息表 -- ---------------------------- CREATE TABLE `oauth_refresh_token` ( `token_id` varchar(256) DEFAULT NULL, `token` blob, `authentication` blob ) ENGINE=MyISAM DEFAULT CHARSET=utf8; 创建实体类 只需要创建用户、角色实体类。因为OAuth2内部操作数据库使用的JdbcTemplate我们只需要传入一个DataSource对象就可以了，实体并不需要配置。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Entity public class User { @Id @Column(updatable = false, nullable = false) private String username; private String password; private String email; private boolean activated; @Column(name = \"activationkey\") private String activationKey; @Column(name = \"resetpasswordkey\") private String resetPasswordKey; @ManyToMany @JoinTable( name = \"user_authority\", joinColumns = @JoinColumn(name = \"username\"), inverseJoinColumns = @JoinColumn(name = \"authority\")) private Set authorities; } 1 2 3 4 5 6 @Entity public class Authority { @Id private String name; } 用户实体以及角色实体是用来配置SpringSecurity时用到的实体，我们配置SpringSecurity时需要使用SpringDataJPA从数据库中读取数据，下我们来配置UserJPA以及AuthorityJPA。\n1 2 3 4 5 6 public interface UserJPA extends JpaRepository { @Query(\"SELECT u FROM User u WHERE LOWER(u.username) = LOWER(:username)\") User findByUsernameCaseInsensitive(@Param(\"username\") String username); } 我们在UserJPA内添加了一个自定义查询，使用了HQL语法来构建的语句，根据用户名不区分大小写进行查询。\n1 2 public interface AuthorityJPA extends JpaRepository { } 自定义UserDetailsService 创建类并实现UserDetailsService:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Component(\"userDetailsService\") public class OauthUserDetailsService implements UserDetailsService { @Autowired private UserJPA userRepository; @Override @Transactional public UserDetails loadUserByUsername(final String login) { String lowercaseLogin = login.toLowerCase(); User userFromDatabase = userRepository.findByUsernameCaseInsensitive(lowercaseLogin); if (userFromDatabase == null) { throw new NewUserNotFoundException(\"User \" + lowercaseLogin + \" was not found in the database\"); } //获取用户的所有权限，权限是SpringSecurity需要的集合 Collection grantedAuthorities = new ArrayList\u003c\u003e(); for (Authority authority : userFromDatabase.getAuthorities()) { GrantedAuthority grantedAuthority = new SimpleGrantedAuthority(authority.getName()); grantedAuthorities.add(grantedAuthority); } //返回一个SpringSecurity需要的用户对象 return new org.springframework.security.core.userdetails.User( userFromDatabase.getUsername(), userFromDatabase.getPassword(), grantedAuthorities); } } 自定义的 OauthUserDetailsService 类中做了从数据库读取用户的操作，如果没有查询到用户直接抛出异常提示，如果查询到并且设置对应的角色后返回SpringSecurity内置的User对象实例。\n配置SpringSecurity 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 @Configuration @EnableWebSecurity public class SecurityConfiguration extends WebSecurityConfigurerAdapter { //注入自定义的UserDetailsService @Autowired private OauthUserDetailsService oauthUserDetailsService; //配置匹配用户时密码规则 @Bean public PasswordEncoder passwordEncoder() { return new BCryptPasswordEncoder(); } // @Bean // public PasswordEncoder passwordEncoder(){ // return PasswordEncoderFactories.createDelegatingPasswordEncoder(); // } //配置全局设置 @Autowired public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception { //设置UserDetailsService以及密码规则 //这个规则影响了数据库里存储的password字段，向数据库存储password时，也要按照这个算法 auth.userDetailsService(oauthUserDetailsService).passwordEncoder(passwordEncoder()); } //排除/hello路径拦截 @Override public void configure(WebSecurity web) throws Exception { web.ignoring().antMatchers(\"/hello\"); } @Override @Bean public AuthenticationManager authenticationManagerBean() throws Exception { return super.authenticationManagerBean(); } //开启全局方法拦截 @EnableGlobalMethodSecurity(prePostEnabled = true, jsr250Enabled = true) public static class GlobalSecurityConfiguration extends GlobalMethodSecurityConfiguration { @Override protected MethodSecurityExpressionHandler createExpressionHandler() { return new OAuth2MethodSecurityExpressionHandler(); } } } 我们在配置类中注入了上面我们自定义的 OauthUserDetailsService 以及用户密码验证规则，我们使用ignoring()方法排除了HelloWorldController内的公开方法，这里可以配置通配符的形式排除。\n自定义401错误码内容 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /** * 自定义401错误码内容 */ @Component public class CustomAuthenticationEntryPoint implements AuthenticationEntryPoint { private final Logger log = LoggerFactory.getLogger(CustomAuthenticationEntryPoint.class); public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException ae) throws IOException, ServletException { log.info(\"Pre-authenticated entry point called. Rejecting access\"); response.sendError(HttpServletResponse.SC_UNAUTHORIZED, \"Access Denied\"); } } 实现了CustomAuthenticationEntryPoint接口，该类是用来配置如果没有权限访问接口时我们返回的错误码以及错误内容。\n定义登出控制 当我们退出系统时需要访问SpringSecrutiy的logout方法来清空对应的session信息，那我们退出后改用户的access_token还依然存在那就危险了，一旦别人知道该token就可以使用之前登录用户的权限来操作业务。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @Component public class CustomLogoutSuccessHandler extends AbstractAuthenticationTargetUrlRequestHandler implements LogoutSuccessHandler { private static final String BEARER_AUTHENTICATION = \"Bearer \"; private static final String HEADER_AUTHORIZATION = \"authorization\"; @Autowired private TokenStore tokenStore; @Override public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException { String token = request.getHeader(HEADER_AUTHORIZATION); if (token != null \u0026\u0026 token.startsWith(BEARER_AUTHENTICATION)) { OAuth2AccessToken oAuth2AccessToken = tokenStore.readAccessToken(token.split(\" \")[0]); if (oAuth2AccessToken != null) { tokenStore.removeAccessToken(oAuth2AccessToken); } } response.setStatus(HttpServletResponse.SC_OK); } } 配置资源服务器 创建一个OAuth2总配置类OAuth2Configuration，类内添加一个子类用于配置资源服务器，另一个用于OAuth2认证服务器。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 @Configuration public class OAuth2Configuration { /** * 资源服务器 */ @Configuration @EnableResourceServer protected static class ResourceServerConfiguration extends ResourceServerConfigurerAdapter { @Autowired private CustomAuthenticationEntryPoint customAuthenticationEntryPoint; @Autowired private CustomLogoutSuccessHandler customLogoutSuccessHandler; @Override public void configure(HttpSecurity http) throws Exception { http .exceptionHandling() .authenticationEntryPoint(customAuthenticationEntryPoint) .and() .logout() .logoutUrl(\"/oauth/logout\") .logoutSuccessHandler(customLogoutSuccessHandler) .and() .authorizeRequests() .antMatchers(\"/hello/\").permitAll() .antMatchers(\"/secure/**\").authenticated(); } } /** * OAuth2认证服务器 */ @Configuration @EnableAuthorizationServer protected static class AuthorizationServerConfiguration extends AuthorizationServerConfigurerAdapter{ //客户端id private String client_id = \"wjy_client\"; //客户端密钥 private String secret = \"wjy_secret\"; //token过期时间（秒） private Integer token_validity_seconds = 1800; @Autowired private DataSource dataSource; //如果想用redis存储token //@Autowired //RedisConnectionFactory redisConnectionFactory; @Bean public TokenStore tokenStore() { return new JdbcTokenStore(dataSource); } @Autowired @Qualifier(\"authenticationManagerBean\") private AuthenticationManager authenticationManager; @Override public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception { endpoints //使用SpringSecurityOAuth2内定义的JdbcStore来操作数据库中的Token .tokenStore(tokenStore()) //如果想用redis存储token，就这么写 //.tokenStore(new RedisTokenStore(redisConnectionFactory)) .authenticationManager(authenticationManager); } @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception { clients.inMemory().withClient(client_id) .secret(new BCryptPasswordEncoder().encode(secret))//将明文加密 .scopes(\"read\", \"write\") .authorities(Authorities.ROLE_ADMIN.name(), Authorities.ROLE_USER.name()) .authorizedGrantTypes(\"password\", \"refresh_token\") .additionalInformation(\"model\",\"test\") .accessTokenValiditySeconds(token_validity_seconds); } } public static void main(String[] args) { //加密方式测试 BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder(); System.out.println(new BCryptPasswordEncoder().encode(\"123456\")); } } 这里client_id和secret直接写在了内存中，也可以存在数据库中。\n配置控制器（Controller） 下面我们来配置两个控制器用来区分我们配置OAuth2是否生效。 我在HelloWorldController内只添加一个字符串的输出，这个控制器我们开放，让SpringSecurity不去管理，配置将会在下面展现，代码如下：\n1 2 3 4 5 6 7 8 9 10 @RestController @RequestMapping(\"/hello\") public class HelloWorldController { @RequestMapping(method = RequestMethod.GET) public String sayHello() { return \"Hello User!\"; } } SecureController这个控制器是需要我们获取授权Token后使用Token才可以访问到的，代码如下\n1 2 3 4 5 6 7 8 9 10 @RestController @RequestMapping(\"/secure\") public class SecureController { @RequestMapping(method = RequestMethod.GET) public String sayHello() { return \"Secure Hello!\"; } } 测试 启动项目，使用postMan进行测试。 先访问公开的接口地址： http://127.0.0.1:8080/hello\n得到接口正确的返回内容： Hello User!\n继续验证访问受限的接口： 127.0.0.1:8080/secure\n得到返回内容：\n1 2 3 4 5 6 7 { \"timestamp\": \"2021-03-24T09:07:28.276+0000\", \"status\": 401, \"error\": \"Unauthorized\", \"message\": \"Access Denied\", \"path\": \"/secure\" } 正如我们预期一样，返回了401错误以及我们自定义的错误码”Access Denied“ 如果返回的是一些html，那么需要在配置文件中加入：\n1 2 3 4 security: oauth2: resource: filter-order: 3 这个配置将我们的资源拦截的过滤器运行顺序放到第3个执行，也就是在oauth2的认证服务器后面执行。\n获取AccessToken 获取token之前需要在数据库中添加用户数据。然后访问 http://localhost:8080/oauth/token?username=admin\u0026password=123456\u0026grant_type=password\n注意：参数名不能改变。 username：数据库中的username。 password：数据库中的password。 grant_type：授权类型，这里默认password\n还需要在postMan的Auth一栏，type选择Basic Auth，然后在下面填入我们在内存中配置的client_id和client_secret。 请求成功返回结果：\n1 2 3 4 5 6 7 { \"access_token\": \"b2911fcc-a969-4f2d-843d-dc8cb9be3c85\", \"token_type\": \"bearer\", \"refresh_token\": \"889b1731-19a0-4f05-b5d5-2ee996ba1f1c\", \"expires_in\": 840, \"scope\": \"read write\" } access_token：本地访问获取到的access_token，会自动写入到数据库中。 token_type：获取到的access_token的授权方式 refersh_token：刷新token时所用到的授权token expires_in：有效期（从获取开始计时，值秒后过期） scope：客户端的接口操作权限（read：读，write：写）\n使用access_token访问数据 获得access_token之后，就可以使用access_token访问刚才受限的接口了。 http://127.0.0.1:8080/secure?access_token=b2911fcc-a969-4f2d-843d-dc8cb9be3c85\nSecure Hello! 可以看到已经可以正常访问受限的接口了，证明我们的access_token是有效的。 access_token过期后，会返回如下内容：\n1 2 3 4 { \"error\": \"invalid_token\", \"error_description\": \"Invalid access token: b2911fcc-a969-4f2d-843d-dc8cb9be3c85\" } access_token过期了，此时可以通过接口来刷新access_token。\n刷新AccessToken http://localhost:8080/oauth/token?grant_type=refresh_token\u0026refresh_token=889b1731-19a0-4f05-b5d5-2ee996ba1f1c\ngrant_type：授权类型，此时填写refresh_token refresh_token：是我们获取access_token时，接口返回的refresh_token，需要用到该值来刷新token。 新的token值得有效期可以看到又是我们配置的默认1800秒，刷新token时oauth2还是给我们返回了一个refersh_token值，该值要作为下次刷新token时使用。\n参考 源码 spring-data-jpa学习 其他参考 参考\n",
  "wordCount" : "10984",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "Me"
  }, {
    "@type": "Person",
    "name": "You"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/java/oauth/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title">
      OAuth
    </h1>
    <div class="post-meta">Me, You

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#oauth" aria-label="OAuth">OAuth</a><ul>
                        
                <li>
                    <a href="#%e5%bf%ab%e9%80%92%e5%91%98%e9%97%ae%e9%a2%98" aria-label="快递员问题">快递员问题</a></li>
                <li>
                    <a href="#%e6%8e%88%e6%9d%83%e6%9c%ba%e5%88%b6%e7%9a%84%e8%ae%be%e8%ae%a1" aria-label="授权机制的设计">授权机制的设计</a></li>
                <li>
                    <a href="#%e4%ba%92%e8%81%94%e7%bd%91%e5%9c%ba%e6%99%af" aria-label="互联网场景">互联网场景</a></li>
                <li>
                    <a href="#%e4%bb%a4%e7%89%8c%e4%b8%8e%e5%af%86%e7%a0%81" aria-label="令牌与密码">令牌与密码</a></li>
                <li>
                    <a href="#rfc-6749" aria-label="RFC 6749">RFC 6749</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%b8%80%e7%a7%8d%e6%8e%88%e6%9d%83%e6%96%b9%e5%bc%8f%e6%8e%88%e6%9d%83%e7%a0%81" aria-label="第一种授权方式：授权码">第一种授权方式：授权码</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%ba%8c%e7%a7%8d%e6%96%b9%e5%bc%8f%e9%9a%90%e8%97%8f%e5%bc%8f%e7%ae%80%e5%8c%96%e6%a8%a1%e5%bc%8f" aria-label="第二种方式：隐藏式(简化模式)">第二种方式：隐藏式(简化模式)</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%b8%89%e7%a7%8d%e6%96%b9%e5%bc%8f%e5%af%86%e7%a0%81%e5%bc%8f" aria-label="第三种方式：密码式">第三种方式：密码式</a></li>
                <li>
                    <a href="#%e7%ac%ac%e5%9b%9b%e7%a7%8d%e6%96%b9%e5%bc%8f%e5%87%ad%e8%af%81%e5%bc%8f" aria-label="第四种方式：凭证式">第四种方式：凭证式</a></li>
                <li>
                    <a href="#%e4%bb%a4%e7%89%8c%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="令牌的使用">令牌的使用</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0%e4%bb%a4%e7%89%8c" aria-label="更新令牌">更新令牌</a></li></ul>
                </li>
                <li>
                    <a href="#jwtjson-web-tokens" aria-label="JWT(JSON WEB TOKENS)">JWT(JSON WEB TOKENS)</a><ul>
                        
                <li>
                    <a href="#%e8%b7%a8%e5%9f%9f%e8%ae%a4%e8%af%81%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="跨域认证的问题">跨域认证的问题</a></li>
                <li>
                    <a href="#jwt-%e7%9a%84%e5%8e%9f%e7%90%86" aria-label="JWT 的原理">JWT 的原理</a></li>
                <li>
                    <a href="#jwt-%e7%9a%84%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="JWT 的数据结构">JWT 的数据结构</a><ul>
                        
                <li>
                    <a href="#header" aria-label="Header">Header</a></li>
                <li>
                    <a href="#payload" aria-label="Payload">Payload</a></li>
                <li>
                    <a href="#signature" aria-label="Signature">Signature</a></li>
                <li>
                    <a href="#base64url" aria-label="Base64URL">Base64URL</a></li></ul>
                </li>
                <li>
                    <a href="#jwt-%e7%9a%84%e4%bd%bf%e7%94%a8%e6%96%b9%e5%bc%8f" aria-label="JWT 的使用方式">JWT 的使用方式</a></li>
                <li>
                    <a href="#jwt-%e7%9a%84%e5%87%a0%e4%b8%aa%e7%89%b9%e7%82%b9" aria-label="JWT 的几个特点">JWT 的几个特点</a></li></ul>
                </li>
                <li>
                    <a href="#spring-security-oauth2" aria-label="Spring Security OAuth2">Spring Security OAuth2</a><ul>
                        
                <li>
                    <a href="#%e6%9e%84%e5%bb%ba%e9%a1%b9%e7%9b%ae" aria-label="构建项目">构建项目</a></li>
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="项目配置文件">项目配置文件</a></li>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e5%ba%93" aria-label="数据库">数据库</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%ae%9e%e4%bd%93%e7%b1%bb" aria-label="创建实体类">创建实体类</a></li>
                <li>
                    <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89userdetailsservice" aria-label="自定义UserDetailsService">自定义UserDetailsService</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aespringsecurity" aria-label="配置SpringSecurity">配置SpringSecurity</a></li>
                <li>
                    <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89401%e9%94%99%e8%af%af%e7%a0%81%e5%86%85%e5%ae%b9" aria-label="自定义401错误码内容">自定义401错误码内容</a></li>
                <li>
                    <a href="#%e5%ae%9a%e4%b9%89%e7%99%bb%e5%87%ba%e6%8e%a7%e5%88%b6" aria-label="定义登出控制">定义登出控制</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e8%b5%84%e6%ba%90%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="配置资源服务器">配置资源服务器</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e6%8e%a7%e5%88%b6%e5%99%a8controller" aria-label="配置控制器（Controller）">配置控制器（Controller）</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95" aria-label="测试">测试</a><ul>
                        
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96accesstoken" aria-label="获取AccessToken">获取AccessToken</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8access_token%e8%ae%bf%e9%97%ae%e6%95%b0%e6%8d%ae" aria-label="使用access_token访问数据">使用access_token访问数据</a></li>
                <li>
                    <a href="#%e5%88%b7%e6%96%b0accesstoken" aria-label="刷新AccessToken">刷新AccessToken</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="oauth">OAuth<a hidden class="anchor" aria-hidden="true" href="#oauth">#</a></h1>
<p>OAuth 2.0 是目前最流行的授权机制，用来授权第三方应用，获取用户数据。这个标准比较抽象，使用了很多术语，初学者不容易理解。其实说起来并不复杂，下面我就通过一个简单的类比，帮助大家轻松理解，OAuth 2.0 到底是什么。</p>
<h2 id="快递员问题">快递员问题<a hidden class="anchor" aria-hidden="true" href="#快递员问题">#</a></h2>
<p>我住在一个大型的居民小区，小区有门禁系统，进入的时候需要输入密码，我经常网购和点外卖，每天都有快递员来送货。我必须找到一个办法，让快递员通过门禁系统，进入小区。如果我把自己的密码，告诉快递员，他就拥有了与我同样的权限，这样好像不太合适。万一我想取消他进入小区的权力，也很麻烦，我自己的密码也得跟着改了，还得通知其他的快递员。有没有一种办法，让快递员能够自由进入小区，又不必知道小区居民的密码，而且他的唯一权限就是送货，其他需要密码的场合，他都没有权限？</p>
<h2 id="授权机制的设计">授权机制的设计<a hidden class="anchor" aria-hidden="true" href="#授权机制的设计">#</a></h2>
<p>第一步，门禁系统的密码输入器下面，增加一个按钮，叫做&quot;获取授权&quot;。快递员需要首先按这个按钮，去申请授权。</p>
<p>第二步，他按下按钮以后，屋主（也就是我）的手机就会跳出对话框：有人正在要求授权。系统还会显示该快递员的姓名、工号和所属的快递公司。我确认请求属实，就点击按钮，告诉门禁系统，我同意给予他进入小区的授权。</p>
<p>第三步，门禁系统得到我的确认以后，向快递员显示一个进入小区的令牌（access token）。令牌就是类似密码的一串数字，只在短期内（比如七天）有效。</p>
<p>第四步，快递员向门禁系统输入令牌，进入小区。</p>
<p>有人可能会问，为什么不是远程为快递员开门，而要为他单独生成一个令牌？这是因为快递员可能每天都会来送货，第二天他还可以复用这个令牌。另外，有的小区有多重门禁，快递员可以使用同一个令牌通过它们。</p>
<h2 id="互联网场景">互联网场景<a hidden class="anchor" aria-hidden="true" href="#互联网场景">#</a></h2>
<p>我们把上面的例子搬到互联网，就是 OAuth 的设计了。
首先，居民小区就是储存用户数据的网络服务。比如，微信储存了我的好友信息，获取这些信息，就必须经过微信的&quot;门禁系统&quot;。其次，快递员（或者说快递公司）就是第三方应用，想要穿过门禁系统，进入小区。最后，我就是用户本人，同意授权第三方应用进入小区，获取我的数据。</p>
<p>简单说，OAuth 就是一种授权机制。数据的所有者告诉系统，同意授权第三方应用进入系统，获取这些数据。系统从而产生一个短期的进入令牌（token），用来代替密码，供第三方应用使用。</p>
<h2 id="令牌与密码">令牌与密码<a hidden class="anchor" aria-hidden="true" href="#令牌与密码">#</a></h2>
<p>令牌（token）与密码（password）的作用是一样的，都可以进入系统，但是有三点差异。</p>
<ul>
<li>令牌是短期的，到期会自动失效，用户自己无法修改。密码一般长期有效，用户不修改，就不会发生变化。</li>
<li>令牌可以被数据所有者撤销，会立即失效。以上例而言，屋主可以随时取消快递员的令牌。密码一般不允许被他人撤销。</li>
<li>令牌有权限范围（scope），比如只能进小区的二号门。对于网络服务来说，只读令牌就比读写令牌更安全。密码一般是完整权限。</li>
</ul>
<p>上面这些设计，保证了令牌既可以让第三方应用获得权限，同时又随时可控，不会危及系统安全。这就是OAuth 2.0 的优点。</p>
<p>注意，只要知道了令牌，就能进入系统。系统一般不会再次确认身份，所以令牌必须保密，泄漏令牌与泄漏密码的后果是一样的。 这也是为什么令牌的有效期，一般都设置得很短的原因。</p>
<p>OAuth 2.0 对于如何颁发令牌的细节，规定得非常详细。具体来说，一共分成四种授权类型（authorizationgrant），即四种颁发令牌的方式，适用于不同的互联网场景。</p>
<h2 id="rfc-6749">RFC 6749<a hidden class="anchor" aria-hidden="true" href="#rfc-6749">#</a></h2>
<p>OAuth 2.0 的标准是 <a href="https://tools.ietf.org/html/rfc6749">RFC 6749</a> 文件。该文件先解释了 OAuth 是什么。
OAuth 引入了一个授权层，用来分离两种不同的角色：客户端和资源所有者。&hellip;&hellip;资源所有者同意以后，资源服务器可以向客户端颁发令牌。客户端通过令牌，去请求数据。</p>
<p>这段话的意思就是，OAuth 的核心就是向第三方应用颁发令牌。然后，RFC 6749 接着写道：
（由于互联网有多种场景，）本标准定义了获得令牌的四种授权方式（authorization grant ）。
也就是说，OAuth 2.0 规定了四种获得令牌的流程。你可以选择最适合自己的那一种，向第三方应用颁发令牌。
下面就是这四种授权方式。
授权码（authorization-code）
隐藏式（implicit）
密码式（password）
客户端凭证（client credentials）</p>
<p>注意，不管哪一种授权方式，第三方应用申请令牌之前，都必须先到系统备案，说明自己的身份，然后会拿到两个身份识别码：客户端 ID（client ID）和客户端密钥（client secret）。这是为了防止令牌被滥用，没有备案过的第三方应用，是不会拿到令牌的。</p>
<h2 id="第一种授权方式授权码">第一种授权方式：授权码<a hidden class="anchor" aria-hidden="true" href="#第一种授权方式授权码">#</a></h2>
<p>授权码（authorization code）方式，指的是第三方应用先申请一个授权码，然后再用该码获取令牌。这种方式是最常用的流程，安全性也最高，它适用于那些有后端的 Web 应用。授权码通过前端传送，令牌则是储存在后端，而且所有与资源服务器的通信都在后端完成。这样的前后端分离，可以避免令牌泄漏。微信公众号获取用户信息，就是完全按照授权码模式来的。</p>
<p>第一步，A 网站提供一个链接，用户点击后就会跳转到 B 网站，授权用户数据给 A 网站使用。下面就是 A 网站跳转 B 网站的一个示意链接。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://b.com/oauth/authorize?
</span></span><span style="display:flex;"><span>  response_type=code&amp;
</span></span><span style="display:flex;"><span>  client_id=CLIENT_ID&amp;
</span></span><span style="display:flex;"><span>  redirect_uri=CALLBACK_URL&amp;
</span></span><span style="display:flex;"><span>  scope=read
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面 URL 中，response_type参数表示要求返回授权码（code），client_id参数让 B 知道是谁在请求，redirect_uri参数是 B 接受或拒绝请求后的跳转网址，scope参数表示要求的授权范围（这里是只读）。这一步前端自己就可以实现，不需要后端。client_id，即appId可以存在前端，没有危险。</p>
<p>第二步，用户跳转后，B 网站会要求用户登录，然后询问是否同意给予 A 网站授权。用户表示同意，这时 B 网站就会跳回redirect_uri参数指定的网址。跳转时，会传回一个授权码，就像下面这样。<code>https://a.com/callback?code=AUTHORIZATION_CODE</code>
上面 URL 中，code参数就是授权码。前端在url上拿到code了。</p>
<p>第三步，A 网站（即前端）拿到授权码code以后，将code通过接口传给后端，后端通过拿到的code，请求B网站，获取令牌。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://b.com/oauth/token?
</span></span><span style="display:flex;"><span> client_id=CLIENT_ID&amp;
</span></span><span style="display:flex;"><span> client_secret=CLIENT_SECRET&amp;
</span></span><span style="display:flex;"><span> grant_type=authorization_code&amp;
</span></span><span style="display:flex;"><span> code=AUTHORIZATION_CODE
</span></span></code></pre></td></tr></table>
</div>
</div><p>第四步，B 网站收到请求以后，就会通过上面的http请求返回json数据，其中包含了令牌，格式如下</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;access_token&#34;:&#34;ACCESS_TOKEN&#34;,
</span></span><span style="display:flex;"><span>  &#34;token_type&#34;:&#34;bearer&#34;,
</span></span><span style="display:flex;"><span>  &#34;expires_in&#34;:2592000,
</span></span><span style="display:flex;"><span>  &#34;refresh_token&#34;:&#34;REFRESH_TOKEN&#34;,
</span></span><span style="display:flex;"><span>  &#34;scope&#34;:&#34;read&#34;,
</span></span><span style="display:flex;"><span>  &#34;uid&#34;:100101,
</span></span><span style="display:flex;"><span>  &#34;info&#34;:{...}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面 JSON 数据中，access_token字段就是令牌，A 网站在后端拿到了。之后就可以通过access_token来获取资源服务器的数据了。</p>
<p>按照微信获取用户信息的步骤来说：
第一步：前端请求微信的接口</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>String url = &#34;https://open.weixin.qq.com/connect/oauth2/authorize?&#34;
</span></span><span style="display:flex;"><span>                    + &#34;appid=&#34; + APPID
</span></span><span style="display:flex;"><span>                    + &#34;&amp;redirect_uri=&#34; + URLEncoder.encode(rediretUrl, PayConstant.DEFAULT_CHARSET)
</span></span><span style="display:flex;"><span>                    + &#34;&amp;response_type=code&amp;scope=snsapi_base&amp;state=123#wechat_redirect&#34;;
</span></span></code></pre></td></tr></table>
</div>
</div><p>微信会将code拼到前端指定的redirect_uri的后面。</p>
<p>第二步：前端拿到code后，将code传给后端，后端先通过code向微信服务器发送get请求,获取access_token和openid，然后再次向微信发送请求,通过access_token和openid,获取userinfo，然后返回给前端展示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @author: wjy
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @description: h5非静默授权, 通过code获取用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 注意：code使用一次就会失效，所有每次请求接口，前端都要重新获取code
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@GetMapping(<span style="color:#0ff;font-weight:bold">&#34;getWxUserinfoByCode&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> JSONObject getWxUserinfoByCode(@RequestParam(<span style="color:#0ff;font-weight:bold">&#34;code&#34;</span>) String code) {
</span></span><span style="display:flex;"><span>    LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;*************获取access_token和openid,然后获取微信userinfo***********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>    JSONObject userInfoJson = <span style="color:#fff;font-weight:bold">new</span> JSONObject();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//获取openId地址
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String getOpenidUrl = <span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/sns/oauth2/access_token&#34;</span>;
</span></span><span style="display:flex;"><span>        String param = <span style="color:#0ff;font-weight:bold">&#34;appid=&#34;</span> + WxUtil.<span style="color:#007f7f">getAppid</span>(environment, WxPlatformConstant.<span style="color:#007f7f">PARENT_GZH</span>)+
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;secret=&#34;</span> + WxUtil.<span style="color:#007f7f">getAppSecret</span>(environment, WxPlatformConstant.<span style="color:#007f7f">PARENT_GZH</span>) +
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;code=&#34;</span> + code +
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;grant_type=authorization_code&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//向微信服务器发送get请求,获取access_token和openid
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String accessTokenAndOpenid = HttpUtil.<span style="color:#007f7f">sendGet</span>(getOpenidUrl, param);
</span></span><span style="display:flex;"><span>        JSONObject jsonObject = JSONObject.<span style="color:#007f7f">parseObject</span>(accessTokenAndOpenid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//再次向微信发送请求,通过access_token和openid,获取userinfo
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String userInfo = HttpUtil.<span style="color:#007f7f">sendGet</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/sns/userinfo&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;access_token=&#34;</span> + jsonObject.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;access_token&#34;</span>)
</span></span><span style="display:flex;"><span>            + <span style="color:#0ff;font-weight:bold">&#34;&amp;openid=&#34;</span> + jsonObject.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;openid&#34;</span>)
</span></span><span style="display:flex;"><span>            + <span style="color:#0ff;font-weight:bold">&#34;&amp;lang=zh_CN&#34;</span>);
</span></span><span style="display:flex;"><span>        userInfoJson = JSON.<span style="color:#007f7f">parseObject</span>(userInfo);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> userInfoJson;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>两步就完事了。</p>
<h2 id="第二种方式隐藏式简化模式">第二种方式：隐藏式(简化模式)<a hidden class="anchor" aria-hidden="true" href="#第二种方式隐藏式简化模式">#</a></h2>
<p>有些 Web 应用是纯前端应用，没有后端。这时就不能用上面的方式了，必须将令牌储存在前端。RFC 6749 就规定了第二种方式，允许直接向前端颁发令牌。这种方式没有授权码这个中间步骤，所以称为（授权码）&ldquo;隐藏式&rdquo;（implicit）。</p>
<p>第一步，A 网站提供一个链接，要求用户跳转到 B 网站，授权用户数据给 A 网站使用。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://b.com/oauth/authorize?
</span></span><span style="display:flex;"><span>  response_type=token&amp;
</span></span><span style="display:flex;"><span>  client_id=CLIENT_ID&amp;
</span></span><span style="display:flex;"><span>  redirect_uri=CALLBACK_URL&amp;
</span></span><span style="display:flex;"><span>  scope=read
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面 URL 中，response_type参数为token，表示要求直接返回令牌。
第二步，用户跳转到 B 网站，登录后同意给予 A 网站授权。这时，B 网站就会跳回redirect_uri参数指定的跳转网址，并且把令牌作为 URL 参数，传给 A 网站。
<code>https://a.com/callback#token=ACCESS_TOKEN</code>
上面 URL 中，token参数就是令牌，A 网站因此直接在前端拿到令牌。</p>
<p>注意，令牌的位置是 URL 锚点（fragment），而不是查询字符串（querystring），这是因为 OAuth 2.0 允许跳转网址是 HTTP 协议，因此存在&quot;中间人攻击&quot;的风险，而浏览器跳转时，锚点不会发到服务器，就减少了泄漏令牌的风险。</p>
<p>这种方式把令牌直接传给前端，是很不安全的。因此，只能用于一些安全要求不高的场景，并且令牌的有效期必须非常短，通常就是会话期间（session）有效，浏览器关掉，令牌就失效了。</p>
<h2 id="第三种方式密码式">第三种方式：密码式<a hidden class="anchor" aria-hidden="true" href="#第三种方式密码式">#</a></h2>
<p>如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌，这种方式称为&quot;密码式&quot;（password）。</p>
<p>第一步，A 网站要求用户提供 B 网站的用户名和密码。拿到以后，A 就直接向 B 请求令牌。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://oauth.b.com/token?
</span></span><span style="display:flex;"><span>  grant_type=password&amp;
</span></span><span style="display:flex;"><span>  username=USERNAME&amp;
</span></span><span style="display:flex;"><span>  password=PASSWORD&amp;
</span></span><span style="display:flex;"><span>  client_id=CLIENT_ID
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面 URL 中，grant_type参数是授权方式，这里的password表示&quot;密码式&quot;，username和password是 B 的用户名和密码。
第二步，B 网站验证身份通过后，直接给出令牌。注意，这时不需要跳转，而是把令牌放在 JSON 数据里面，作为 HTTP 回应，A 因此拿到令牌。
这种方式需要用户给出自己的用户名/密码，显然风险很大，因此只适用于其他授权方式都无法采用的情况，而且必须是用户高度信任的应用。</p>
<h2 id="第四种方式凭证式">第四种方式：凭证式<a hidden class="anchor" aria-hidden="true" href="#第四种方式凭证式">#</a></h2>
<p>最后一种方式是凭证式（client credentials），适用于没有前端的命令行应用，即在命令行下请求令牌。第一步，A 应用在命令行向 B 发出请求。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://oauth.b.com/token?
</span></span><span style="display:flex;"><span>  grant_type=client_credentials&amp;
</span></span><span style="display:flex;"><span>  client_id=CLIENT_ID&amp;
</span></span><span style="display:flex;"><span>  client_secret=CLIENT_SECRET
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面 URL 中，grant_type参数等于client_credentials表示采用凭证式，client_id和client_secret用来让 B确认 A 的身份。
第二步，B 网站验证通过以后，直接返回令牌。这种方式给出的令牌，是针对第三方应用的，而不是针对用户的，即有可能多个用户共享同一个令牌。</p>
<h2 id="令牌的使用">令牌的使用<a hidden class="anchor" aria-hidden="true" href="#令牌的使用">#</a></h2>
<p>A 网站拿到令牌以后，就可以向 B 网站的 API 请求数据了。
此时，每个发到 API 的请求，都必须带有令牌。具体做法是在请求的头信息，加上一个Authorization字段，令牌就放在这个字段里面。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>curl -H &#34;Authorization: Bearer ACCESS_TOKEN&#34; \
</span></span><span style="display:flex;"><span>&#34;https://api.b.com&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面命令中，ACCESS_TOKEN就是拿到的令牌。</p>
<h2 id="更新令牌">更新令牌<a hidden class="anchor" aria-hidden="true" href="#更新令牌">#</a></h2>
<p>令牌的有效期到了，如果让用户重新走一遍上面的流程，再申请一个新的令牌，很可能体验不好，而且也没有必要。OAuth 2.0 允许用户自动更新令牌。
具体方法是，B 网站颁发令牌的时候，一次性颁发两个令牌，一个用于获取数据，另一个用于获取新的令牌（refresh token 字段）。令牌到期前，用户使用 refresh token 发一个请求，去更新令牌。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://b.com/oauth/token?
</span></span><span style="display:flex;"><span>  grant_type=refresh_token&amp;
</span></span><span style="display:flex;"><span>  client_id=CLIENT_ID&amp;
</span></span><span style="display:flex;"><span>  client_secret=CLIENT_SECRET&amp;
</span></span><span style="display:flex;"><span>  refresh_token=REFRESH_TOKEN
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面 URL 中，grant_type参数为refresh_token表示要求更新令牌，client_id参数和client_secret参数用于确认身份，refresh_token参数就是用于更新令牌的令牌。</p>
<p>B 网站验证通过以后，就会颁发新的令牌。</p>
<p><a href="http://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html">参考阮一峰老师的文章</a>
<a href="https://www.kancloud.cn/gzy37/oauth2/1093498">OAuth中文规范</a></p>
<h1 id="jwtjson-web-tokens">JWT(JSON WEB TOKENS)<a hidden class="anchor" aria-hidden="true" href="#jwtjson-web-tokens">#</a></h1>
<p>JSON Web Token（缩写 JWT）是目前最流行的跨域认证解决方案，特别适用于分布式站点的单点登录（SSO）场景。
<a href="https://tools.ietf.org/html/rfc7519">官方标准</a></p>
<h2 id="跨域认证的问题">跨域认证的问题<a hidden class="anchor" aria-hidden="true" href="#跨域认证的问题">#</a></h2>
<p>互联网服务离不开用户认证。一般流程是下面这样。
1、用户向服务器发送用户名和密码。
2、服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间等等。
3、服务器向用户返回一个 session_id，写入用户的 Cookie。
4、用户随后的每一次请求，都会通过 Cookie，将 session_id 传回服务器。
5、服务器收到 session_id，找到前期保存的数据，由此得知用户的身份。</p>
<p>这种模式的问题在于，扩展性（scaling）不好。单机当然没有问题，如果是服务器集群，或者是跨域的服务导向架构，就要求 session 数据共享，每台服务器都能够读取 session。
举例来说，A 网站和 B 网站是同一家公司的关联服务。现在要求，用户只要在其中一个网站登录，再访问另一个网站就会自动登录，请问怎么实现？
一种解决方案是 session 数据持久化，写入数据库或别的持久层。各种服务收到请求后，都向持久层请求数据。
这种方案的优点是架构清晰，缺点是工程量比较大。另外，持久层万一挂了，就会单点失败。
另一种方案是服务器索性不保存 session 数据了，所有数据都保存在客户端，每次请求都发回服务器。JWT 就是这种方案的一个代表。</p>
<h2 id="jwt-的原理">JWT 的原理<a hidden class="anchor" aria-hidden="true" href="#jwt-的原理">#</a></h2>
<p>JWT 的原理是，服务器认证以后，生成一个 JSON 对象，发回给用户，就像下面这样。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;姓名&#34;: &#34;张三&#34;,
</span></span><span style="display:flex;"><span>  &#34;角色&#34;: &#34;管理员&#34;,
</span></span><span style="display:flex;"><span>  &#34;到期时间&#34;: &#34;2018年7月1日0点0分&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>以后，用户与服务端通信的时候，都要发回这个 JSON 对象。服务器完全只靠这个对象认定用户身份。为了防止用户篡改数据，服务器在生成这个对象的时候，会加上签名（详见后文）。
服务器就不保存任何 session 数据了，也就是说，服务器变成无状态了，从而比较容易实现扩展。</p>
<h2 id="jwt-的数据结构">JWT 的数据结构<a hidden class="anchor" aria-hidden="true" href="#jwt-的数据结构">#</a></h2>
<p>实际的 JWT 大概就像下面这样。
<code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</code></p>
<p>JWT 的三个部分依次如下。
Header（头部）
Payload（负载）
Signature（签名）</p>
<p>写成一行，就是下面的样子。
<code>Header.Payload.Signature</code></p>
<h3 id="header">Header<a hidden class="anchor" aria-hidden="true" href="#header">#</a></h3>
<p>Header 部分是一个 JSON 对象，描述 JWT 的元数据，通常是下面的样子。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;alg&#34;: &#34;HS256&#34;,
</span></span><span style="display:flex;"><span>  &#34;typ&#34;: &#34;JWT&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面代码中，alg属性表示签名的算法（algorithm），默认是 HMAC SHA256（写成 HS256）；typ属性表示这个令牌（token）的类型（type），JWT 令牌统一写为JWT。
最后，将上面的 JSON 对象使用 Base64URL 算法（详见后文）转成字符串。</p>
<h3 id="payload">Payload<a hidden class="anchor" aria-hidden="true" href="#payload">#</a></h3>
<p>Payload 部分也是一个 JSON 对象，用来存放实际需要传递的数据。JWT 规定了7个官方字段，供选用。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>iss (issuer)：签发人
</span></span><span style="display:flex;"><span>exp (expiration time)：过期时间
</span></span><span style="display:flex;"><span>sub (subject)：主题
</span></span><span style="display:flex;"><span>aud (audience)：受众
</span></span><span style="display:flex;"><span>nbf (Not Before)：生效时间
</span></span><span style="display:flex;"><span>iat (Issued At)：签发时间
</span></span><span style="display:flex;"><span>jti (JWT ID)：编号
</span></span></code></pre></td></tr></table>
</div>
</div><p>除了官方字段，你还可以在这个部分定义私有字段，下面就是一个例子。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;sub&#34;: &#34;1234567890&#34;,
</span></span><span style="display:flex;"><span>  &#34;name&#34;: &#34;John Doe&#34;,
</span></span><span style="display:flex;"><span>  &#34;admin&#34;: true
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意，JWT 默认是不加密的，任何人都可以读到，所以不要把秘密信息放在这个部分。</p>
<h3 id="signature">Signature<a hidden class="anchor" aria-hidden="true" href="#signature">#</a></h3>
<p>Signature 部分是对前两部分的签名，防止数据篡改。
首先，需要指定一个密钥（secret）。这个密钥只有服务器才知道，不能泄露给用户。然后，使用 Header 里面指定的签名算法（默认是 HMAC SHA256），按照下面的公式产生签名。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>HMACSHA256(
</span></span><span style="display:flex;"><span>  base64UrlEncode(header) + &#34;.&#34; +
</span></span><span style="display:flex;"><span>  base64UrlEncode(payload),
</span></span><span style="display:flex;"><span>  secret)
</span></span></code></pre></td></tr></table>
</div>
</div><p>算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用&quot;点&quot;（.）分隔，就可以返回给用户。</p>
<h3 id="base64url">Base64URL<a hidden class="anchor" aria-hidden="true" href="#base64url">#</a></h3>
<p>前面提到，Header 和 Payload 串型化的算法是 Base64URL。这个算法跟 Base64 算法基本类似，但有一些小的不同。JWT 作为一个令牌（token），有些场合可能会放到 URL（比如 api.example.com/?token=xxx）。Base64 有三个字符+、/和=，在 URL 里面有特殊含义，所以要被替换掉：=被省略、+替换成-，/替换成_ 。这就是 Base64URL 算法。</p>
<h2 id="jwt-的使用方式">JWT 的使用方式<a hidden class="anchor" aria-hidden="true" href="#jwt-的使用方式">#</a></h2>
<p>客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage。
此后，客户端每次与服务器通信，都要带上这个 JWT。你可以把它放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求的头信息Authorization字段里面。
<code>Authorization: Bearer &lt;token&gt;</code>
另一种做法是，跨域的时候，JWT 就放在 POST 请求的数据体里面。</p>
<h2 id="jwt-的几个特点">JWT 的几个特点<a hidden class="anchor" aria-hidden="true" href="#jwt-的几个特点">#</a></h2>
<ul>
<li>JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。</li>
<li>JWT 不加密的情况下，不能将秘密数据写入 JWT。</li>
<li>JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。</li>
<li>JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。</li>
<li>JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。</li>
<li>为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输。</li>
</ul>
<p><a href="https://www.jianshu.com/p/cb886f995e86">理解Spring Cloud Security OAuth2及JWT</a></p>
<h1 id="spring-security-oauth2">Spring Security OAuth2<a hidden class="anchor" aria-hidden="true" href="#spring-security-oauth2">#</a></h1>
<h2 id="构建项目">构建项目<a hidden class="anchor" aria-hidden="true" href="#构建项目">#</a></h2>
<p>用idea创建spring boot项目，并引入如下maven依赖：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;!--Web--&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;!--MySQL--&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;mysql&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>	&lt;scope&gt;runtime&lt;/scope&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;!--引入druid最新maven依赖--&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;com.alibaba&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;druid&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>	&lt;version&gt;1.0.29&lt;/version&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;org.springframework&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>	&lt;version&gt;5.1.9.RELEASE&lt;/version&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;!--SpringDataJPA--&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;!--SpringSecurity--&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;!-- https://mvnrepository.com/artifact/org.springframework.security.oauth/spring-security-oauth2 --&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;org.springframework.security.oauth&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;spring-security-oauth2&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>	&lt;version&gt;2.3.3.RELEASE&lt;/version&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="项目配置文件">项目配置文件<a hidden class="anchor" aria-hidden="true" href="#项目配置文件">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">type</span>: com.alibaba.druid.pool.DruidDataSource
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">driver-class-name</span>: com.mysql.jdbc.Driver
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:mysql://127.0.0.1:3306/oauth2?characterEncoding=utf8
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: root
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: <span style="color:#ff0;font-weight:bold">123456</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#最大活跃数</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">maxActive</span>: <span style="color:#ff0;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#初始化数量</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">initialSize</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#最大连接等待超时时间</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">maxWait</span>: <span style="color:#ff0;font-weight:bold">60000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#打开PSCache，并且指定每个连接PSCache的大小</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">poolPreparedStatements</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">maxPoolPreparedStatementPerConnectionSize</span>: <span style="color:#ff0;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#通过connectionProperties属性来打开mergeSql功能；慢SQL记录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">minIdle</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">timeBetweenEvictionRunsMillis</span>: <span style="color:#ff0;font-weight:bold">60000</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">minEvictableIdleTimeMillis</span>: <span style="color:#ff0;font-weight:bold">300000</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">validationQuery</span>: select 1 from dual
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">testWhileIdle</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">testOnBorrow</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">testOnReturn</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#配置监控统计拦截的filters，去掉后监控界面sql将无法统计,&#39;wall&#39;用于防火墙</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">filters</span>: stat, wall, log4j
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">jpa</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">properties</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">hibernate</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">show_sql</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">format_sql</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="数据库">数据库<a hidden class="anchor" aria-hidden="true" href="#数据库">#</a></h2>
<p>因为我们使用数据库保存用户、角色、accessToken、RefershToken等信息，所以要新建需要的表。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 用户表
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> `<span style="color:#fff;font-weight:bold">user</span>` (
</span></span><span style="display:flex;"><span>  `username` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">NOT</span> NULL,
</span></span><span style="display:flex;"><span>  `email` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `password` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">500</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `activated` <span style="color:#fff;font-weight:bold">tinyint</span>(<span style="color:#ff0;font-weight:bold">1</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#0ff;font-weight:bold">&#39;0&#39;</span>,
</span></span><span style="display:flex;"><span>  `activationkey` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `resetpasswordkey` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">PRIMARY</span> <span style="color:#fff;font-weight:bold">KEY</span> (`username`)
</span></span><span style="display:flex;"><span>) <span style="color:#fff;font-weight:bold">ENGINE</span>=MyISAM <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#fff;font-weight:bold">CHARSET</span>=utf8;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 用户数据。需要注意密码字段，存的是加密之后的密文。加密算法会在后面说明。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `<span style="color:#fff;font-weight:bold">user</span>` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;admin&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;admin@mail.me&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;$2a$10$vHCuajBQOH4ZX8LKRoRFI.6s23W9wgPUyw6VqJS5KWEZkjnT52nfi&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>, null, null);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `<span style="color:#fff;font-weight:bold">user</span>` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;user&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;user@mail.me&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;$2a$10$vHCuajBQOH4ZX8LKRoRFI.6s23W9wgPUyw6VqJS5KWEZkjnT52nfi&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>, null, null);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 角色表
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> `authority` (
</span></span><span style="display:flex;"><span>  `name` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">NOT</span> NULL,
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">PRIMARY</span> <span style="color:#fff;font-weight:bold">KEY</span> (`name`)
</span></span><span style="display:flex;"><span>) <span style="color:#fff;font-weight:bold">ENGINE</span>=MyISAM <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#fff;font-weight:bold">CHARSET</span>=utf8;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 角色数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `authority` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;ROLE_ADMIN&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `authority` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;ROLE_USER&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 用户角色关联表
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> `user_authority` (
</span></span><span style="display:flex;"><span>  `username` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">NOT</span> NULL,
</span></span><span style="display:flex;"><span>  `authority` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">NOT</span> NULL,
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">UNIQUE</span> <span style="color:#fff;font-weight:bold">KEY</span> `user_authority_idx_1` (`username`,`authority`),
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">KEY</span> `authority` (`authority`)
</span></span><span style="display:flex;"><span>) <span style="color:#fff;font-weight:bold">ENGINE</span>=MyISAM <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#fff;font-weight:bold">CHARSET</span>=utf8;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 中间表数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `user_authority` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;admin&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;ROLE_ADMIN&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `user_authority` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;admin&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;ROLE_USER&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `user_authority` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;user&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;ROLE_USER&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 我们使用的是SpringSecurityOAuth2提供的Jdbc方式进行操作Token，所以需要根据标准创建对应的表结构
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> `oauth_access_token` (
</span></span><span style="display:flex;"><span>  `token_id` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `token` <span style="color:#fff;font-weight:bold">blob</span>,
</span></span><span style="display:flex;"><span>  `authentication_id` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `user_name` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `client_id` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `authentication` <span style="color:#fff;font-weight:bold">blob</span>,
</span></span><span style="display:flex;"><span>  `refresh_token` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL
</span></span><span style="display:flex;"><span>) <span style="color:#fff;font-weight:bold">ENGINE</span>=MyISAM <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#fff;font-weight:bold">CHARSET</span>=utf8;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 刷新Token时需要用到refresh_token信息表
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> `oauth_refresh_token` (
</span></span><span style="display:flex;"><span>  `token_id` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `token` <span style="color:#fff;font-weight:bold">blob</span>,
</span></span><span style="display:flex;"><span>  `authentication` <span style="color:#fff;font-weight:bold">blob</span>
</span></span><span style="display:flex;"><span>) <span style="color:#fff;font-weight:bold">ENGINE</span>=MyISAM <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#fff;font-weight:bold">CHARSET</span>=utf8;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="创建实体类">创建实体类<a hidden class="anchor" aria-hidden="true" href="#创建实体类">#</a></h2>
<p>只需要创建用户、角色实体类。因为OAuth2内部操作数据库使用的JdbcTemplate我们只需要传入一个DataSource对象就可以了，实体并不需要配置。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@Entity
</span></span><span style="display:flex;"><span>public class User {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Id
</span></span><span style="display:flex;"><span>    @Column(updatable = false, nullable = false)
</span></span><span style="display:flex;"><span>    private String username;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    private String password;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    private String email;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    private boolean activated;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Column(name = &#34;activationkey&#34;)
</span></span><span style="display:flex;"><span>    private String activationKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Column(name = &#34;resetpasswordkey&#34;)
</span></span><span style="display:flex;"><span>    private String resetPasswordKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ManyToMany
</span></span><span style="display:flex;"><span>    @JoinTable(
</span></span><span style="display:flex;"><span>            name = &#34;user_authority&#34;,
</span></span><span style="display:flex;"><span>            joinColumns = @JoinColumn(name = &#34;username&#34;),
</span></span><span style="display:flex;"><span>            inverseJoinColumns = @JoinColumn(name = &#34;authority&#34;))
</span></span><span style="display:flex;"><span>    private Set&lt;Authority&gt; authorities;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@Entity
</span></span><span style="display:flex;"><span>public class Authority {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Id
</span></span><span style="display:flex;"><span>    private String name;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>用户实体以及角色实体是用来配置SpringSecurity时用到的实体，我们配置SpringSecurity时需要使用SpringDataJPA从数据库中读取数据，下我们来配置UserJPA以及AuthorityJPA。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public interface UserJPA extends JpaRepository&lt;User, String&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Query(&#34;SELECT u FROM User u WHERE LOWER(u.username) = LOWER(:username)&#34;)
</span></span><span style="display:flex;"><span>    User findByUsernameCaseInsensitive(@Param(&#34;username&#34;) String username);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们在UserJPA内添加了一个自定义查询，使用了HQL语法来构建的语句，根据用户名不区分大小写进行查询。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public interface AuthorityJPA extends JpaRepository&lt;Authority, String&gt; {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="自定义userdetailsservice">自定义UserDetailsService<a hidden class="anchor" aria-hidden="true" href="#自定义userdetailsservice">#</a></h2>
<p>创建类并实现<code>UserDetailsService</code>:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component(<span style="color:#0ff;font-weight:bold">&#34;userDetailsService&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OauthUserDetailsService <span style="color:#fff;font-weight:bold">implements</span> UserDetailsService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> UserJPA userRepository;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    @Transactional
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserDetails loadUserByUsername(<span style="color:#fff;font-weight:bold">final</span> String login) {
</span></span><span style="display:flex;"><span>        String lowercaseLogin = login.<span style="color:#007f7f">toLowerCase</span>();
</span></span><span style="display:flex;"><span>        User userFromDatabase = userRepository.<span style="color:#007f7f">findByUsernameCaseInsensitive</span>(lowercaseLogin);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (userFromDatabase == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> NewUserNotFoundException(<span style="color:#0ff;font-weight:bold">&#34;User &#34;</span> + lowercaseLogin + <span style="color:#0ff;font-weight:bold">&#34; was not found in the database&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//获取用户的所有权限，权限是SpringSecurity需要的集合
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Collection&lt;GrantedAuthority&gt; grantedAuthorities = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (Authority authority : userFromDatabase.<span style="color:#007f7f">getAuthorities</span>()) {
</span></span><span style="display:flex;"><span>            GrantedAuthority grantedAuthority = <span style="color:#fff;font-weight:bold">new</span> SimpleGrantedAuthority(authority.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>            grantedAuthorities.<span style="color:#007f7f">add</span>(grantedAuthority);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//返回一个SpringSecurity需要的用户对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> org.<span style="color:#007f7f">springframework</span>.<span style="color:#007f7f">security</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">userdetails</span>.<span style="color:#007f7f">User</span>(
</span></span><span style="display:flex;"><span>                userFromDatabase.<span style="color:#007f7f">getUsername</span>(),
</span></span><span style="display:flex;"><span>                userFromDatabase.<span style="color:#007f7f">getPassword</span>(),
</span></span><span style="display:flex;"><span>                grantedAuthorities);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>自定义的 OauthUserDetailsService 类中做了从数据库读取用户的操作，如果没有查询到用户直接抛出异常提示，如果查询到并且设置对应的角色后返回SpringSecurity内置的User对象实例。</p>
<h2 id="配置springsecurity">配置SpringSecurity<a hidden class="anchor" aria-hidden="true" href="#配置springsecurity">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@EnableWebSecurity
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecurityConfiguration <span style="color:#fff;font-weight:bold">extends</span> WebSecurityConfigurerAdapter {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//注入自定义的UserDetailsService
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> OauthUserDetailsService oauthUserDetailsService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//配置匹配用户时密码规则
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> PasswordEncoder passwordEncoder() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> BCryptPasswordEncoder();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//    @Bean
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//    public PasswordEncoder passwordEncoder(){
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//    }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//配置全局设置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> configureGlobal(AuthenticationManagerBuilder auth) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设置UserDetailsService以及密码规则
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#007f7f">//这个规则影响了数据库里存储的password字段，向数据库存储password时，也要按照这个算法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        auth.<span style="color:#007f7f">userDetailsService</span>(oauthUserDetailsService).<span style="color:#007f7f">passwordEncoder</span>(passwordEncoder());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//排除/hello路径拦截
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> configure(WebSecurity web) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        web.<span style="color:#007f7f">ignoring</span>().<span style="color:#007f7f">antMatchers</span>(<span style="color:#0ff;font-weight:bold">&#34;/hello&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> AuthenticationManager authenticationManagerBean() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">authenticationManagerBean</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//开启全局方法拦截
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @EnableGlobalMethodSecurity(prePostEnabled = <span style="color:#fff;font-weight:bold">true</span>, jsr250Enabled = <span style="color:#fff;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">class</span> GlobalSecurityConfiguration <span style="color:#fff;font-weight:bold">extends</span> GlobalMethodSecurityConfiguration {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">protected</span> MethodSecurityExpressionHandler createExpressionHandler() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> OAuth2MethodSecurityExpressionHandler();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们在配置类中注入了上面我们自定义的 OauthUserDetailsService 以及用户密码验证规则，我们使用ignoring()方法排除了HelloWorldController内的公开方法，这里可以配置通配符的形式排除。</p>
<h2 id="自定义401错误码内容">自定义401错误码内容<a hidden class="anchor" aria-hidden="true" href="#自定义401错误码内容">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 自定义401错误码内容
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CustomAuthenticationEntryPoint <span style="color:#fff;font-weight:bold">implements</span> AuthenticationEntryPoint {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Logger log = LoggerFactory.<span style="color:#007f7f">getLogger</span>(CustomAuthenticationEntryPoint.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> commence(HttpServletRequest request,
</span></span><span style="display:flex;"><span>                         HttpServletResponse response,
</span></span><span style="display:flex;"><span>                         AuthenticationException ae) <span style="color:#fff;font-weight:bold">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;Pre-authenticated entry point called. Rejecting access&#34;</span>);
</span></span><span style="display:flex;"><span>        response.<span style="color:#007f7f">sendError</span>(HttpServletResponse.<span style="color:#007f7f">SC_UNAUTHORIZED</span>, <span style="color:#0ff;font-weight:bold">&#34;Access Denied&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>实现了CustomAuthenticationEntryPoint接口，该类是用来配置如果没有权限访问接口时我们返回的错误码以及错误内容。</p>
<h2 id="定义登出控制">定义登出控制<a hidden class="anchor" aria-hidden="true" href="#定义登出控制">#</a></h2>
<p>当我们退出系统时需要访问SpringSecrutiy的logout方法来清空对应的session信息，那我们退出后改用户的access_token还依然存在那就危险了，一旦别人知道该token就可以使用之前登录用户的权限来操作业务。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CustomLogoutSuccessHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">extends</span> AbstractAuthenticationTargetUrlRequestHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">implements</span> LogoutSuccessHandler {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String BEARER_AUTHENTICATION = <span style="color:#0ff;font-weight:bold">&#34;Bearer &#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String HEADER_AUTHORIZATION = <span style="color:#0ff;font-weight:bold">&#34;authorization&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> TokenStore tokenStore;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onLogoutSuccess(HttpServletRequest request,
</span></span><span style="display:flex;"><span>                                HttpServletResponse response,
</span></span><span style="display:flex;"><span>                                Authentication authentication) <span style="color:#fff;font-weight:bold">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>        String token = request.<span style="color:#007f7f">getHeader</span>(HEADER_AUTHORIZATION);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (token != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; token.<span style="color:#007f7f">startsWith</span>(BEARER_AUTHENTICATION)) {
</span></span><span style="display:flex;"><span>            OAuth2AccessToken oAuth2AccessToken = tokenStore.<span style="color:#007f7f">readAccessToken</span>(token.<span style="color:#007f7f">split</span>(<span style="color:#0ff;font-weight:bold">&#34; &#34;</span>)[<span style="color:#ff0;font-weight:bold">0</span>]);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (oAuth2AccessToken != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                tokenStore.<span style="color:#007f7f">removeAccessToken</span>(oAuth2AccessToken);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        response.<span style="color:#007f7f">setStatus</span>(HttpServletResponse.<span style="color:#007f7f">SC_OK</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="配置资源服务器">配置资源服务器<a hidden class="anchor" aria-hidden="true" href="#配置资源服务器">#</a></h2>
<p>创建一个OAuth2总配置类OAuth2Configuration，类内添加一个子类用于配置资源服务器，另一个用于OAuth2认证服务器。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">89
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OAuth2Configuration {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 资源服务器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Configuration
</span></span><span style="display:flex;"><span>    @EnableResourceServer
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">class</span> ResourceServerConfiguration <span style="color:#fff;font-weight:bold">extends</span> ResourceServerConfigurerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Autowired
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> CustomAuthenticationEntryPoint customAuthenticationEntryPoint;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Autowired
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> CustomLogoutSuccessHandler customLogoutSuccessHandler;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> configure(HttpSecurity http) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            http
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">exceptionHandling</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">authenticationEntryPoint</span>(customAuthenticationEntryPoint)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">and</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">logout</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">logoutUrl</span>(<span style="color:#0ff;font-weight:bold">&#34;/oauth/logout&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">logoutSuccessHandler</span>(customLogoutSuccessHandler)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">and</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">authorizeRequests</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">antMatchers</span>(<span style="color:#0ff;font-weight:bold">&#34;/hello/&#34;</span>).<span style="color:#007f7f">permitAll</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">antMatchers</span>(<span style="color:#0ff;font-weight:bold">&#34;/secure/**&#34;</span>).<span style="color:#007f7f">authenticated</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * OAuth2认证服务器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Configuration
</span></span><span style="display:flex;"><span>    @EnableAuthorizationServer
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">class</span> AuthorizationServerConfiguration <span style="color:#fff;font-weight:bold">extends</span> AuthorizationServerConfigurerAdapter{
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//客户端id
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">private</span> String client_id = <span style="color:#0ff;font-weight:bold">&#34;wjy_client&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//客户端密钥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">private</span> String secret = <span style="color:#0ff;font-weight:bold">&#34;wjy_secret&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//token过期时间（秒）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">private</span> Integer token_validity_seconds = <span style="color:#ff0;font-weight:bold">1800</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Autowired
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> DataSource dataSource;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//如果想用redis存储token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//@Autowired
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//RedisConnectionFactory redisConnectionFactory;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        @Bean
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> TokenStore tokenStore() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> JdbcTokenStore(dataSource);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Autowired
</span></span><span style="display:flex;"><span>        @Qualifier(<span style="color:#0ff;font-weight:bold">&#34;authenticationManagerBean&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> AuthenticationManager authenticationManager;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> configure(AuthorizationServerEndpointsConfigurer endpoints) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            endpoints
</span></span><span style="display:flex;"><span>					<span style="color:#007f7f">//使用SpringSecurityOAuth2内定义的JdbcStore来操作数据库中的Token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    .<span style="color:#007f7f">tokenStore</span>(tokenStore())
</span></span><span style="display:flex;"><span>					<span style="color:#007f7f">//如果想用redis存储token，就这么写
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#007f7f">//.tokenStore(new RedisTokenStore(redisConnectionFactory))
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    .<span style="color:#007f7f">authenticationManager</span>(authenticationManager);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> configure(ClientDetailsServiceConfigurer clients) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            clients.<span style="color:#007f7f">inMemory</span>().<span style="color:#007f7f">withClient</span>(client_id)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">secret</span>(<span style="color:#fff;font-weight:bold">new</span> BCryptPasswordEncoder().<span style="color:#007f7f">encode</span>(secret))<span style="color:#007f7f">//将明文加密
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    .<span style="color:#007f7f">scopes</span>(<span style="color:#0ff;font-weight:bold">&#34;read&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;write&#34;</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">authorities</span>(Authorities.<span style="color:#007f7f">ROLE_ADMIN</span>.<span style="color:#007f7f">name</span>(), Authorities.<span style="color:#007f7f">ROLE_USER</span>.<span style="color:#007f7f">name</span>())
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">authorizedGrantTypes</span>(<span style="color:#0ff;font-weight:bold">&#34;password&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;refresh_token&#34;</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">additionalInformation</span>(<span style="color:#0ff;font-weight:bold">&#34;model&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;test&#34;</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">accessTokenValiditySeconds</span>(token_validity_seconds);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//加密方式测试
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        BCryptPasswordEncoder passwordEncoder = <span style="color:#fff;font-weight:bold">new</span> BCryptPasswordEncoder();
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#fff;font-weight:bold">new</span> BCryptPasswordEncoder().<span style="color:#007f7f">encode</span>(<span style="color:#0ff;font-weight:bold">&#34;123456&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里client_id和secret直接写在了内存中，也可以存在数据库中。</p>
<h2 id="配置控制器controller">配置控制器（Controller）<a hidden class="anchor" aria-hidden="true" href="#配置控制器controller">#</a></h2>
<p>下面我们来配置两个控制器用来区分我们配置OAuth2是否生效。
我在HelloWorldController内只添加一个字符串的输出，这个控制器我们开放，让SpringSecurity不去管理，配置将会在下面展现，代码如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span>@RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/hello&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HelloWorldController {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @RequestMapping(method = RequestMethod.<span style="color:#007f7f">GET</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String sayHello() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Hello User!&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>SecureController这个控制器是需要我们获取授权Token后使用Token才可以访问到的，代码如下</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span>@RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/secure&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecureController {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RequestMapping(method = RequestMethod.<span style="color:#007f7f">GET</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String sayHello() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Secure Hello!&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="测试">测试<a hidden class="anchor" aria-hidden="true" href="#测试">#</a></h2>
<p>启动项目，使用postMan进行测试。
先访问公开的接口地址：
<code>http://127.0.0.1:8080/hello</code></p>
<p>得到接口正确的返回内容：
<code>Hello User!</code></p>
<p>继续验证访问受限的接口：
<code>127.0.0.1:8080/secure</code></p>
<p>得到返回内容：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    &#34;timestamp&#34;: &#34;2021-03-24T09:07:28.276+0000&#34;,
</span></span><span style="display:flex;"><span>    &#34;status&#34;: 401,
</span></span><span style="display:flex;"><span>    &#34;error&#34;: &#34;Unauthorized&#34;,
</span></span><span style="display:flex;"><span>    &#34;message&#34;: &#34;Access Denied&#34;,
</span></span><span style="display:flex;"><span>    &#34;path&#34;: &#34;/secure&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>正如我们预期一样，返回了401错误以及我们自定义的错误码”Access Denied“
如果返回的是一些html，那么需要在配置文件中加入：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>security:
</span></span><span style="display:flex;"><span>  oauth2:
</span></span><span style="display:flex;"><span>    resource:
</span></span><span style="display:flex;"><span>      filter-order: 3
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个配置将我们的资源拦截的过滤器运行顺序放到第3个执行，也就是在oauth2的认证服务器后面执行。</p>
<h3 id="获取accesstoken">获取AccessToken<a hidden class="anchor" aria-hidden="true" href="#获取accesstoken">#</a></h3>
<p>获取token之前需要在数据库中添加用户数据。然后访问
<code>http://localhost:8080/oauth/token?username=admin&amp;password=123456&amp;grant_type=password</code></p>
<p>注意：参数名不能改变。
username：数据库中的username。
password：数据库中的password。
grant_type：授权类型，这里默认password</p>
<p>还需要在postMan的<code>Auth</code>一栏，type选择<code>Basic Auth</code>，然后在下面填入我们在内存中配置的client_id和client_secret。
请求成功返回结果：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    &#34;access_token&#34;: &#34;b2911fcc-a969-4f2d-843d-dc8cb9be3c85&#34;,
</span></span><span style="display:flex;"><span>    &#34;token_type&#34;: &#34;bearer&#34;,
</span></span><span style="display:flex;"><span>    &#34;refresh_token&#34;: &#34;889b1731-19a0-4f05-b5d5-2ee996ba1f1c&#34;,
</span></span><span style="display:flex;"><span>    &#34;expires_in&#34;: 840,
</span></span><span style="display:flex;"><span>    &#34;scope&#34;: &#34;read write&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>access_token：本地访问获取到的access_token，会自动写入到数据库中。
token_type：获取到的access_token的授权方式
refersh_token：刷新token时所用到的授权token
expires_in：有效期（从获取开始计时，值秒后过期）
scope：客户端的接口操作权限（read：读，write：写）</p>
<h3 id="使用access_token访问数据">使用access_token访问数据<a hidden class="anchor" aria-hidden="true" href="#使用access_token访问数据">#</a></h3>
<p>获得access_token之后，就可以使用access_token访问刚才受限的接口了。
<code>http://127.0.0.1:8080/secure?access_token=b2911fcc-a969-4f2d-843d-dc8cb9be3c85</code></p>
<p><code>Secure Hello!</code>
可以看到已经可以正常访问受限的接口了，证明我们的access_token是有效的。
access_token过期后，会返回如下内容：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    &#34;error&#34;: &#34;invalid_token&#34;,
</span></span><span style="display:flex;"><span>    &#34;error_description&#34;: &#34;Invalid access token: b2911fcc-a969-4f2d-843d-dc8cb9be3c85&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>access_token过期了，此时可以通过接口来刷新access_token。</p>
<h3 id="刷新accesstoken">刷新AccessToken<a hidden class="anchor" aria-hidden="true" href="#刷新accesstoken">#</a></h3>
<p><code>http://localhost:8080/oauth/token?grant_type=refresh_token&amp;refresh_token=889b1731-19a0-4f05-b5d5-2ee996ba1f1c</code></p>
<p>grant_type：授权类型，此时填写refresh_token
refresh_token：是我们获取access_token时，接口返回的refresh_token，需要用到该值来刷新token。
新的token值得有效期可以看到又是我们配置的默认1800秒，刷新token时oauth2还是给我们返回了一个refersh_token值，该值要作为下次刷新token时使用。</p>
<p><a href="https://www.jianshu.com/p/ded9dc32f550">参考</a>
<a href="https://gitee.com/hengboy/spring-boot-chapter/tree/1.x/">源码</a>
<a href="https://blog.csdn.net/qq_42495847/article/details/107991361">spring-data-jpa学习</a>
<a href="https://lexburner.github.io/categories/Spring-Security-OAuth2/">其他参考</a>
<a href="https://blog.csdn.net/a624193873/article/details/106417218/">参考</a></p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/java/">java</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%85%B6%E4%BB%96/jrebel/">
    <span class="title">« Prev</span>
    <br>
    <span>JRebel</span>
  </a>
  <a class="next" href="https://funny-toffee-4aa7c3.netlify.app/posts/spring/spring-boot/">
    <span class="title">Next »</span>
    <br>
    <span>spring boot</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>