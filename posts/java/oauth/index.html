<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>OAuth | Wjy&#39;s Blog</title>
<meta name="keywords" content="java">
<meta name="description" content="OAuth
OAuth 2.0 æ˜¯ç›®å‰æœ€æµè¡Œçš„æˆæƒæœºåˆ¶ï¼Œç”¨æ¥æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œè·å–ç”¨æˆ·æ•°æ®ã€‚è¿™ä¸ªæ ‡å‡†æ¯”è¾ƒæŠ½è±¡ï¼Œä½¿ç”¨äº†å¾ˆå¤šæœ¯è¯­ï¼Œåˆå­¦è€…ä¸å®¹æ˜“ç†è§£ã€‚å…¶å®è¯´èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œä¸‹é¢æˆ‘å°±é€šè¿‡ä¸€ä¸ªç®€å•çš„ç±»æ¯”ï¼Œå¸®åŠ©å¤§å®¶è½»æ¾ç†è§£ï¼ŒOAuth 2.0 åˆ°åº•æ˜¯ä»€ä¹ˆã€‚">
<meta name="author" content="Me, You">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/java/oauth/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="OAuth" />
<meta property="og:description" content="OAuth
OAuth 2.0 æ˜¯ç›®å‰æœ€æµè¡Œçš„æˆæƒæœºåˆ¶ï¼Œç”¨æ¥æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œè·å–ç”¨æˆ·æ•°æ®ã€‚è¿™ä¸ªæ ‡å‡†æ¯”è¾ƒæŠ½è±¡ï¼Œä½¿ç”¨äº†å¾ˆå¤šæœ¯è¯­ï¼Œåˆå­¦è€…ä¸å®¹æ˜“ç†è§£ã€‚å…¶å®è¯´èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œä¸‹é¢æˆ‘å°±é€šè¿‡ä¸€ä¸ªç®€å•çš„ç±»æ¯”ï¼Œå¸®åŠ©å¤§å®¶è½»æ¾ç†è§£ï¼ŒOAuth 2.0 åˆ°åº•æ˜¯ä»€ä¹ˆã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/java/oauth/" /><meta property="article:section" content="posts" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="OAuth"/>
<meta name="twitter:description" content="OAuth
OAuth 2.0 æ˜¯ç›®å‰æœ€æµè¡Œçš„æˆæƒæœºåˆ¶ï¼Œç”¨æ¥æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œè·å–ç”¨æˆ·æ•°æ®ã€‚è¿™ä¸ªæ ‡å‡†æ¯”è¾ƒæŠ½è±¡ï¼Œä½¿ç”¨äº†å¾ˆå¤šæœ¯è¯­ï¼Œåˆå­¦è€…ä¸å®¹æ˜“ç†è§£ã€‚å…¶å®è¯´èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œä¸‹é¢æˆ‘å°±é€šè¿‡ä¸€ä¸ªç®€å•çš„ç±»æ¯”ï¼Œå¸®åŠ©å¤§å®¶è½»æ¾ç†è§£ï¼ŒOAuth 2.0 åˆ°åº•æ˜¯ä»€ä¹ˆã€‚"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "OAuth",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/java/oauth/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "OAuth",
  "name": "OAuth",
  "description": "OAuth OAuth 2.0 æ˜¯ç›®å‰æœ€æµè¡Œçš„æˆæƒæœºåˆ¶ï¼Œç”¨æ¥æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œè·å–ç”¨æˆ·æ•°æ®ã€‚è¿™ä¸ªæ ‡å‡†æ¯”è¾ƒæŠ½è±¡ï¼Œä½¿ç”¨äº†å¾ˆå¤šæœ¯è¯­ï¼Œåˆå­¦è€…ä¸å®¹æ˜“ç†è§£ã€‚å…¶å®è¯´èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œä¸‹é¢æˆ‘å°±é€šè¿‡ä¸€ä¸ªç®€å•çš„ç±»æ¯”ï¼Œå¸®åŠ©å¤§å®¶è½»æ¾ç†è§£ï¼ŒOAuth 2.0 åˆ°åº•æ˜¯ä»€ä¹ˆã€‚\n",
  "keywords": [
    "java"
  ],
  "articleBody": "OAuth OAuth 2.0 æ˜¯ç›®å‰æœ€æµè¡Œçš„æˆæƒæœºåˆ¶ï¼Œç”¨æ¥æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œè·å–ç”¨æˆ·æ•°æ®ã€‚è¿™ä¸ªæ ‡å‡†æ¯”è¾ƒæŠ½è±¡ï¼Œä½¿ç”¨äº†å¾ˆå¤šæœ¯è¯­ï¼Œåˆå­¦è€…ä¸å®¹æ˜“ç†è§£ã€‚å…¶å®è¯´èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œä¸‹é¢æˆ‘å°±é€šè¿‡ä¸€ä¸ªç®€å•çš„ç±»æ¯”ï¼Œå¸®åŠ©å¤§å®¶è½»æ¾ç†è§£ï¼ŒOAuth 2.0 åˆ°åº•æ˜¯ä»€ä¹ˆã€‚\nå¿«é€’å‘˜é—®é¢˜ æˆ‘ä½åœ¨ä¸€ä¸ªå¤§å‹çš„å±…æ°‘å°åŒºï¼Œå°åŒºæœ‰é—¨ç¦ç³»ç»Ÿï¼Œè¿›å…¥çš„æ—¶å€™éœ€è¦è¾“å…¥å¯†ç ï¼Œæˆ‘ç»å¸¸ç½‘è´­å’Œç‚¹å¤–å–ï¼Œæ¯å¤©éƒ½æœ‰å¿«é€’å‘˜æ¥é€è´§ã€‚æˆ‘å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªåŠæ³•ï¼Œè®©å¿«é€’å‘˜é€šè¿‡é—¨ç¦ç³»ç»Ÿï¼Œè¿›å…¥å°åŒºã€‚å¦‚æœæˆ‘æŠŠè‡ªå·±çš„å¯†ç ï¼Œå‘Šè¯‰å¿«é€’å‘˜ï¼Œä»–å°±æ‹¥æœ‰äº†ä¸æˆ‘åŒæ ·çš„æƒé™ï¼Œè¿™æ ·å¥½åƒä¸å¤ªåˆé€‚ã€‚ä¸‡ä¸€æˆ‘æƒ³å–æ¶ˆä»–è¿›å…¥å°åŒºçš„æƒåŠ›ï¼Œä¹Ÿå¾ˆéº»çƒ¦ï¼Œæˆ‘è‡ªå·±çš„å¯†ç ä¹Ÿå¾—è·Ÿç€æ”¹äº†ï¼Œè¿˜å¾—é€šçŸ¥å…¶ä»–çš„å¿«é€’å‘˜ã€‚æœ‰æ²¡æœ‰ä¸€ç§åŠæ³•ï¼Œè®©å¿«é€’å‘˜èƒ½å¤Ÿè‡ªç”±è¿›å…¥å°åŒºï¼Œåˆä¸å¿…çŸ¥é“å°åŒºå±…æ°‘çš„å¯†ç ï¼Œè€Œä¸”ä»–çš„å”¯ä¸€æƒé™å°±æ˜¯é€è´§ï¼Œå…¶ä»–éœ€è¦å¯†ç çš„åœºåˆï¼Œä»–éƒ½æ²¡æœ‰æƒé™ï¼Ÿ\næˆæƒæœºåˆ¶çš„è®¾è®¡ ç¬¬ä¸€æ­¥ï¼Œé—¨ç¦ç³»ç»Ÿçš„å¯†ç è¾“å…¥å™¨ä¸‹é¢ï¼Œå¢åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œå«åš\"è·å–æˆæƒ\"ã€‚å¿«é€’å‘˜éœ€è¦é¦–å…ˆæŒ‰è¿™ä¸ªæŒ‰é’®ï¼Œå»ç”³è¯·æˆæƒã€‚\nç¬¬äºŒæ­¥ï¼Œä»–æŒ‰ä¸‹æŒ‰é’®ä»¥åï¼Œå±‹ä¸»ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ï¼‰çš„æ‰‹æœºå°±ä¼šè·³å‡ºå¯¹è¯æ¡†ï¼šæœ‰äººæ­£åœ¨è¦æ±‚æˆæƒã€‚ç³»ç»Ÿè¿˜ä¼šæ˜¾ç¤ºè¯¥å¿«é€’å‘˜çš„å§“åã€å·¥å·å’Œæ‰€å±çš„å¿«é€’å…¬å¸ã€‚æˆ‘ç¡®è®¤è¯·æ±‚å±å®ï¼Œå°±ç‚¹å‡»æŒ‰é’®ï¼Œå‘Šè¯‰é—¨ç¦ç³»ç»Ÿï¼Œæˆ‘åŒæ„ç»™äºˆä»–è¿›å…¥å°åŒºçš„æˆæƒã€‚\nç¬¬ä¸‰æ­¥ï¼Œé—¨ç¦ç³»ç»Ÿå¾—åˆ°æˆ‘çš„ç¡®è®¤ä»¥åï¼Œå‘å¿«é€’å‘˜æ˜¾ç¤ºä¸€ä¸ªè¿›å…¥å°åŒºçš„ä»¤ç‰Œï¼ˆaccess tokenï¼‰ã€‚ä»¤ç‰Œå°±æ˜¯ç±»ä¼¼å¯†ç çš„ä¸€ä¸²æ•°å­—ï¼Œåªåœ¨çŸ­æœŸå†…ï¼ˆæ¯”å¦‚ä¸ƒå¤©ï¼‰æœ‰æ•ˆã€‚\nç¬¬å››æ­¥ï¼Œå¿«é€’å‘˜å‘é—¨ç¦ç³»ç»Ÿè¾“å…¥ä»¤ç‰Œï¼Œè¿›å…¥å°åŒºã€‚\næœ‰äººå¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯è¿œç¨‹ä¸ºå¿«é€’å‘˜å¼€é—¨ï¼Œè€Œè¦ä¸ºä»–å•ç‹¬ç”Ÿæˆä¸€ä¸ªä»¤ç‰Œï¼Ÿè¿™æ˜¯å› ä¸ºå¿«é€’å‘˜å¯èƒ½æ¯å¤©éƒ½ä¼šæ¥é€è´§ï¼Œç¬¬äºŒå¤©ä»–è¿˜å¯ä»¥å¤ç”¨è¿™ä¸ªä»¤ç‰Œã€‚å¦å¤–ï¼Œæœ‰çš„å°åŒºæœ‰å¤šé‡é—¨ç¦ï¼Œå¿«é€’å‘˜å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªä»¤ç‰Œé€šè¿‡å®ƒä»¬ã€‚\näº’è”ç½‘åœºæ™¯ æˆ‘ä»¬æŠŠä¸Šé¢çš„ä¾‹å­æ¬åˆ°äº’è”ç½‘ï¼Œå°±æ˜¯ OAuth çš„è®¾è®¡äº†ã€‚ é¦–å…ˆï¼Œå±…æ°‘å°åŒºå°±æ˜¯å‚¨å­˜ç”¨æˆ·æ•°æ®çš„ç½‘ç»œæœåŠ¡ã€‚æ¯”å¦‚ï¼Œå¾®ä¿¡å‚¨å­˜äº†æˆ‘çš„å¥½å‹ä¿¡æ¯ï¼Œè·å–è¿™äº›ä¿¡æ¯ï¼Œå°±å¿…é¡»ç»è¿‡å¾®ä¿¡çš„\"é—¨ç¦ç³»ç»Ÿ\"ã€‚å…¶æ¬¡ï¼Œå¿«é€’å‘˜ï¼ˆæˆ–è€…è¯´å¿«é€’å…¬å¸ï¼‰å°±æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œæƒ³è¦ç©¿è¿‡é—¨ç¦ç³»ç»Ÿï¼Œè¿›å…¥å°åŒºã€‚æœ€åï¼Œæˆ‘å°±æ˜¯ç”¨æˆ·æœ¬äººï¼ŒåŒæ„æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è¿›å…¥å°åŒºï¼Œè·å–æˆ‘çš„æ•°æ®ã€‚\nç®€å•è¯´ï¼ŒOAuth å°±æ˜¯ä¸€ç§æˆæƒæœºåˆ¶ã€‚æ•°æ®çš„æ‰€æœ‰è€…å‘Šè¯‰ç³»ç»Ÿï¼ŒåŒæ„æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è¿›å…¥ç³»ç»Ÿï¼Œè·å–è¿™äº›æ•°æ®ã€‚ç³»ç»Ÿä»è€Œäº§ç”Ÿä¸€ä¸ªçŸ­æœŸçš„è¿›å…¥ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œç”¨æ¥ä»£æ›¿å¯†ç ï¼Œä¾›ç¬¬ä¸‰æ–¹åº”ç”¨ä½¿ç”¨ã€‚\nä»¤ç‰Œä¸å¯†ç  ä»¤ç‰Œï¼ˆtokenï¼‰ä¸å¯†ç ï¼ˆpasswordï¼‰çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œéƒ½å¯ä»¥è¿›å…¥ç³»ç»Ÿï¼Œä½†æ˜¯æœ‰ä¸‰ç‚¹å·®å¼‚ã€‚\nä»¤ç‰Œæ˜¯çŸ­æœŸçš„ï¼Œåˆ°æœŸä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œç”¨æˆ·è‡ªå·±æ— æ³•ä¿®æ”¹ã€‚å¯†ç ä¸€èˆ¬é•¿æœŸæœ‰æ•ˆï¼Œç”¨æˆ·ä¸ä¿®æ”¹ï¼Œå°±ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚ ä»¤ç‰Œå¯ä»¥è¢«æ•°æ®æ‰€æœ‰è€…æ’¤é”€ï¼Œä¼šç«‹å³å¤±æ•ˆã€‚ä»¥ä¸Šä¾‹è€Œè¨€ï¼Œå±‹ä¸»å¯ä»¥éšæ—¶å–æ¶ˆå¿«é€’å‘˜çš„ä»¤ç‰Œã€‚å¯†ç ä¸€èˆ¬ä¸å…è®¸è¢«ä»–äººæ’¤é”€ã€‚ ä»¤ç‰Œæœ‰æƒé™èŒƒå›´ï¼ˆscopeï¼‰ï¼Œæ¯”å¦‚åªèƒ½è¿›å°åŒºçš„äºŒå·é—¨ã€‚å¯¹äºç½‘ç»œæœåŠ¡æ¥è¯´ï¼Œåªè¯»ä»¤ç‰Œå°±æ¯”è¯»å†™ä»¤ç‰Œæ›´å®‰å…¨ã€‚å¯†ç ä¸€èˆ¬æ˜¯å®Œæ•´æƒé™ã€‚ ä¸Šé¢è¿™äº›è®¾è®¡ï¼Œä¿è¯äº†ä»¤ç‰Œæ—¢å¯ä»¥è®©ç¬¬ä¸‰æ–¹åº”ç”¨è·å¾—æƒé™ï¼ŒåŒæ—¶åˆéšæ—¶å¯æ§ï¼Œä¸ä¼šå±åŠç³»ç»Ÿå®‰å…¨ã€‚è¿™å°±æ˜¯OAuth 2.0 çš„ä¼˜ç‚¹ã€‚\næ³¨æ„ï¼Œåªè¦çŸ¥é“äº†ä»¤ç‰Œï¼Œå°±èƒ½è¿›å…¥ç³»ç»Ÿã€‚ç³»ç»Ÿä¸€èˆ¬ä¸ä¼šå†æ¬¡ç¡®è®¤èº«ä»½ï¼Œæ‰€ä»¥ä»¤ç‰Œå¿…é¡»ä¿å¯†ï¼Œæ³„æ¼ä»¤ç‰Œä¸æ³„æ¼å¯†ç çš„åæœæ˜¯ä¸€æ ·çš„ã€‚ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä»¤ç‰Œçš„æœ‰æ•ˆæœŸï¼Œä¸€èˆ¬éƒ½è®¾ç½®å¾—å¾ˆçŸ­çš„åŸå› ã€‚\nOAuth 2.0 å¯¹äºå¦‚ä½•é¢å‘ä»¤ç‰Œçš„ç»†èŠ‚ï¼Œè§„å®šå¾—éå¸¸è¯¦ç»†ã€‚å…·ä½“æ¥è¯´ï¼Œä¸€å…±åˆ†æˆå››ç§æˆæƒç±»å‹ï¼ˆauthorizationgrantï¼‰ï¼Œå³å››ç§é¢å‘ä»¤ç‰Œçš„æ–¹å¼ï¼Œé€‚ç”¨äºä¸åŒçš„äº’è”ç½‘åœºæ™¯ã€‚\nRFC 6749 OAuth 2.0 çš„æ ‡å‡†æ˜¯ RFC 6749 æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å…ˆè§£é‡Šäº† OAuth æ˜¯ä»€ä¹ˆã€‚ OAuth å¼•å…¥äº†ä¸€ä¸ªæˆæƒå±‚ï¼Œç”¨æ¥åˆ†ç¦»ä¸¤ç§ä¸åŒçš„è§’è‰²ï¼šå®¢æˆ·ç«¯å’Œèµ„æºæ‰€æœ‰è€…ã€‚â€¦â€¦èµ„æºæ‰€æœ‰è€…åŒæ„ä»¥åï¼Œèµ„æºæœåŠ¡å™¨å¯ä»¥å‘å®¢æˆ·ç«¯é¢å‘ä»¤ç‰Œã€‚å®¢æˆ·ç«¯é€šè¿‡ä»¤ç‰Œï¼Œå»è¯·æ±‚æ•°æ®ã€‚\nè¿™æ®µè¯çš„æ„æ€å°±æ˜¯ï¼ŒOAuth çš„æ ¸å¿ƒå°±æ˜¯å‘ç¬¬ä¸‰æ–¹åº”ç”¨é¢å‘ä»¤ç‰Œã€‚ç„¶åï¼ŒRFC 6749 æ¥ç€å†™é“ï¼š ï¼ˆç”±äºäº’è”ç½‘æœ‰å¤šç§åœºæ™¯ï¼Œï¼‰æœ¬æ ‡å‡†å®šä¹‰äº†è·å¾—ä»¤ç‰Œçš„å››ç§æˆæƒæ–¹å¼ï¼ˆauthorization grant ï¼‰ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼ŒOAuth 2.0 è§„å®šäº†å››ç§è·å¾—ä»¤ç‰Œçš„æµç¨‹ã€‚ä½ å¯ä»¥é€‰æ‹©æœ€é€‚åˆè‡ªå·±çš„é‚£ä¸€ç§ï¼Œå‘ç¬¬ä¸‰æ–¹åº”ç”¨é¢å‘ä»¤ç‰Œã€‚ ä¸‹é¢å°±æ˜¯è¿™å››ç§æˆæƒæ–¹å¼ã€‚ æˆæƒç ï¼ˆauthorization-codeï¼‰ éšè—å¼ï¼ˆimplicitï¼‰ å¯†ç å¼ï¼ˆpasswordï¼‰ å®¢æˆ·ç«¯å‡­è¯ï¼ˆclient credentialsï¼‰\næ³¨æ„ï¼Œä¸ç®¡å“ªä¸€ç§æˆæƒæ–¹å¼ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨ç”³è¯·ä»¤ç‰Œä¹‹å‰ï¼Œéƒ½å¿…é¡»å…ˆåˆ°ç³»ç»Ÿå¤‡æ¡ˆï¼Œè¯´æ˜è‡ªå·±çš„èº«ä»½ï¼Œç„¶åä¼šæ‹¿åˆ°ä¸¤ä¸ªèº«ä»½è¯†åˆ«ç ï¼šå®¢æˆ·ç«¯ IDï¼ˆclient IDï¼‰å’Œå®¢æˆ·ç«¯å¯†é’¥ï¼ˆclient secretï¼‰ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢ä»¤ç‰Œè¢«æ»¥ç”¨ï¼Œæ²¡æœ‰å¤‡æ¡ˆè¿‡çš„ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œæ˜¯ä¸ä¼šæ‹¿åˆ°ä»¤ç‰Œçš„ã€‚\nç¬¬ä¸€ç§æˆæƒæ–¹å¼ï¼šæˆæƒç  æˆæƒç ï¼ˆauthorization codeï¼‰æ–¹å¼ï¼ŒæŒ‡çš„æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨å…ˆç”³è¯·ä¸€ä¸ªæˆæƒç ï¼Œç„¶åå†ç”¨è¯¥ç è·å–ä»¤ç‰Œã€‚è¿™ç§æ–¹å¼æ˜¯æœ€å¸¸ç”¨çš„æµç¨‹ï¼Œå®‰å…¨æ€§ä¹Ÿæœ€é«˜ï¼Œå®ƒé€‚ç”¨äºé‚£äº›æœ‰åç«¯çš„ Web åº”ç”¨ã€‚æˆæƒç é€šè¿‡å‰ç«¯ä¼ é€ï¼Œä»¤ç‰Œåˆ™æ˜¯å‚¨å­˜åœ¨åç«¯ï¼Œè€Œä¸”æ‰€æœ‰ä¸èµ„æºæœåŠ¡å™¨çš„é€šä¿¡éƒ½åœ¨åç«¯å®Œæˆã€‚è¿™æ ·çš„å‰åç«¯åˆ†ç¦»ï¼Œå¯ä»¥é¿å…ä»¤ç‰Œæ³„æ¼ã€‚å¾®ä¿¡å…¬ä¼—å·è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå°±æ˜¯å®Œå…¨æŒ‰ç…§æˆæƒç æ¨¡å¼æ¥çš„ã€‚\nç¬¬ä¸€æ­¥ï¼ŒA ç½‘ç«™æä¾›ä¸€ä¸ªé“¾æ¥ï¼Œç”¨æˆ·ç‚¹å‡»åå°±ä¼šè·³è½¬åˆ° B ç½‘ç«™ï¼Œæˆæƒç”¨æˆ·æ•°æ®ç»™ A ç½‘ç«™ä½¿ç”¨ã€‚ä¸‹é¢å°±æ˜¯ A ç½‘ç«™è·³è½¬ B ç½‘ç«™çš„ä¸€ä¸ªç¤ºæ„é“¾æ¥ã€‚\n1 2 3 4 5 https://b.com/oauth/authorize? response_type=code\u0026 client_id=CLIENT_ID\u0026 redirect_uri=CALLBACK_URL\u0026 scope=read ä¸Šé¢ URL ä¸­ï¼Œresponse_typeå‚æ•°è¡¨ç¤ºè¦æ±‚è¿”å›æˆæƒç ï¼ˆcodeï¼‰ï¼Œclient_idå‚æ•°è®© B çŸ¥é“æ˜¯è°åœ¨è¯·æ±‚ï¼Œredirect_uriå‚æ•°æ˜¯ B æ¥å—æˆ–æ‹’ç»è¯·æ±‚åçš„è·³è½¬ç½‘å€ï¼Œscopeå‚æ•°è¡¨ç¤ºè¦æ±‚çš„æˆæƒèŒƒå›´ï¼ˆè¿™é‡Œæ˜¯åªè¯»ï¼‰ã€‚è¿™ä¸€æ­¥å‰ç«¯è‡ªå·±å°±å¯ä»¥å®ç°ï¼Œä¸éœ€è¦åç«¯ã€‚client_idï¼Œå³appIdå¯ä»¥å­˜åœ¨å‰ç«¯ï¼Œæ²¡æœ‰å±é™©ã€‚\nç¬¬äºŒæ­¥ï¼Œç”¨æˆ·è·³è½¬åï¼ŒB ç½‘ç«™ä¼šè¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œç„¶åè¯¢é—®æ˜¯å¦åŒæ„ç»™äºˆ A ç½‘ç«™æˆæƒã€‚ç”¨æˆ·è¡¨ç¤ºåŒæ„ï¼Œè¿™æ—¶ B ç½‘ç«™å°±ä¼šè·³å›redirect_uriå‚æ•°æŒ‡å®šçš„ç½‘å€ã€‚è·³è½¬æ—¶ï¼Œä¼šä¼ å›ä¸€ä¸ªæˆæƒç ï¼Œå°±åƒä¸‹é¢è¿™æ ·ã€‚https://a.com/callback?code=AUTHORIZATION_CODE ä¸Šé¢ URL ä¸­ï¼Œcodeå‚æ•°å°±æ˜¯æˆæƒç ã€‚å‰ç«¯åœ¨urlä¸Šæ‹¿åˆ°codeäº†ã€‚\nç¬¬ä¸‰æ­¥ï¼ŒA ç½‘ç«™ï¼ˆå³å‰ç«¯ï¼‰æ‹¿åˆ°æˆæƒç codeä»¥åï¼Œå°†codeé€šè¿‡æ¥å£ä¼ ç»™åç«¯ï¼Œåç«¯é€šè¿‡æ‹¿åˆ°çš„codeï¼Œè¯·æ±‚Bç½‘ç«™ï¼Œè·å–ä»¤ç‰Œã€‚\n1 2 3 4 5 https://b.com/oauth/token? client_id=CLIENT_ID\u0026 client_secret=CLIENT_SECRET\u0026 grant_type=authorization_code\u0026 code=AUTHORIZATION_CODE ç¬¬å››æ­¥ï¼ŒB ç½‘ç«™æ”¶åˆ°è¯·æ±‚ä»¥åï¼Œå°±ä¼šé€šè¿‡ä¸Šé¢çš„httpè¯·æ±‚è¿”å›jsonæ•°æ®ï¼Œå…¶ä¸­åŒ…å«äº†ä»¤ç‰Œï¼Œæ ¼å¼å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 { \"access_token\":\"ACCESS_TOKEN\", \"token_type\":\"bearer\", \"expires_in\":2592000, \"refresh_token\":\"REFRESH_TOKEN\", \"scope\":\"read\", \"uid\":100101, \"info\":{...} } ä¸Šé¢ JSON æ•°æ®ä¸­ï¼Œaccess_tokenå­—æ®µå°±æ˜¯ä»¤ç‰Œï¼ŒA ç½‘ç«™åœ¨åç«¯æ‹¿åˆ°äº†ã€‚ä¹‹åå°±å¯ä»¥é€šè¿‡access_tokenæ¥è·å–èµ„æºæœåŠ¡å™¨çš„æ•°æ®äº†ã€‚\næŒ‰ç…§å¾®ä¿¡è·å–ç”¨æˆ·ä¿¡æ¯çš„æ­¥éª¤æ¥è¯´ï¼š ç¬¬ä¸€æ­¥ï¼šå‰ç«¯è¯·æ±‚å¾®ä¿¡çš„æ¥å£\n1 2 3 4 String url = \"https://open.weixin.qq.com/connect/oauth2/authorize?\" + \"appid=\" + APPID + \"\u0026redirect_uri=\" + URLEncoder.encode(rediretUrl, PayConstant.DEFAULT_CHARSET) + \"\u0026response_type=code\u0026scope=snsapi_base\u0026state=123#wechat_redirect\"; å¾®ä¿¡ä¼šå°†codeæ‹¼åˆ°å‰ç«¯æŒ‡å®šçš„redirect_uriçš„åé¢ã€‚\nç¬¬äºŒæ­¥ï¼šå‰ç«¯æ‹¿åˆ°codeåï¼Œå°†codeä¼ ç»™åç«¯ï¼Œåç«¯å…ˆé€šè¿‡codeå‘å¾®ä¿¡æœåŠ¡å™¨å‘é€getè¯·æ±‚,è·å–access_tokenå’Œopenidï¼Œç„¶åå†æ¬¡å‘å¾®ä¿¡å‘é€è¯·æ±‚,é€šè¿‡access_tokenå’Œopenid,è·å–userinfoï¼Œç„¶åè¿”å›ç»™å‰ç«¯å±•ç¤ºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /** * @author: wjy * @description: h5éé™é»˜æˆæƒ, é€šè¿‡codeè·å–ç”¨æˆ·ä¿¡æ¯ * æ³¨æ„ï¼šcodeä½¿ç”¨ä¸€æ¬¡å°±ä¼šå¤±æ•ˆï¼Œæ‰€æœ‰æ¯æ¬¡è¯·æ±‚æ¥å£ï¼Œå‰ç«¯éƒ½è¦é‡æ–°è·å–code */ @ResponseBody @GetMapping(\"getWxUserinfoByCode\") public JSONObject getWxUserinfoByCode(@RequestParam(\"code\") String code) { LOGGER.info(\"*************è·å–access_tokenå’Œopenid,ç„¶åè·å–å¾®ä¿¡userinfo***********************************************\"); JSONObject userInfoJson = new JSONObject(); try { //è·å–openIdåœ°å€ String getOpenidUrl = \"https://api.weixin.qq.com/sns/oauth2/access_token\"; String param = \"appid=\" + WxUtil.getAppid(environment, WxPlatformConstant.PARENT_GZH)+ \"\u0026secret=\" + WxUtil.getAppSecret(environment, WxPlatformConstant.PARENT_GZH) + \"\u0026code=\" + code + \"\u0026grant_type=authorization_code\"; //å‘å¾®ä¿¡æœåŠ¡å™¨å‘é€getè¯·æ±‚,è·å–access_tokenå’Œopenid String accessTokenAndOpenid = HttpUtil.sendGet(getOpenidUrl, param); JSONObject jsonObject = JSONObject.parseObject(accessTokenAndOpenid); //å†æ¬¡å‘å¾®ä¿¡å‘é€è¯·æ±‚,é€šè¿‡access_tokenå’Œopenid,è·å–userinfo String userInfo = HttpUtil.sendGet( \"https://api.weixin.qq.com/sns/userinfo\", \"access_token=\" + jsonObject.getString(\"access_token\") + \"\u0026openid=\" + jsonObject.get(\"openid\") + \"\u0026lang=zh_CN\"); userInfoJson = JSON.parseObject(userInfo); } catch (Exception e) { e.printStackTrace(); } return userInfoJson; } ä¸¤æ­¥å°±å®Œäº‹äº†ã€‚\nç¬¬äºŒç§æ–¹å¼ï¼šéšè—å¼(ç®€åŒ–æ¨¡å¼) æœ‰äº› Web åº”ç”¨æ˜¯çº¯å‰ç«¯åº”ç”¨ï¼Œæ²¡æœ‰åç«¯ã€‚è¿™æ—¶å°±ä¸èƒ½ç”¨ä¸Šé¢çš„æ–¹å¼äº†ï¼Œå¿…é¡»å°†ä»¤ç‰Œå‚¨å­˜åœ¨å‰ç«¯ã€‚RFC 6749 å°±è§„å®šäº†ç¬¬äºŒç§æ–¹å¼ï¼Œå…è®¸ç›´æ¥å‘å‰ç«¯é¢å‘ä»¤ç‰Œã€‚è¿™ç§æ–¹å¼æ²¡æœ‰æˆæƒç è¿™ä¸ªä¸­é—´æ­¥éª¤ï¼Œæ‰€ä»¥ç§°ä¸ºï¼ˆæˆæƒç ï¼‰â€œéšè—å¼â€ï¼ˆimplicitï¼‰ã€‚\nç¬¬ä¸€æ­¥ï¼ŒA ç½‘ç«™æä¾›ä¸€ä¸ªé“¾æ¥ï¼Œè¦æ±‚ç”¨æˆ·è·³è½¬åˆ° B ç½‘ç«™ï¼Œæˆæƒç”¨æˆ·æ•°æ®ç»™ A ç½‘ç«™ä½¿ç”¨ã€‚\n1 2 3 4 5 https://b.com/oauth/authorize? response_type=token\u0026 client_id=CLIENT_ID\u0026 redirect_uri=CALLBACK_URL\u0026 scope=read ä¸Šé¢ URL ä¸­ï¼Œresponse_typeå‚æ•°ä¸ºtokenï¼Œè¡¨ç¤ºè¦æ±‚ç›´æ¥è¿”å›ä»¤ç‰Œã€‚ ç¬¬äºŒæ­¥ï¼Œç”¨æˆ·è·³è½¬åˆ° B ç½‘ç«™ï¼Œç™»å½•ååŒæ„ç»™äºˆ A ç½‘ç«™æˆæƒã€‚è¿™æ—¶ï¼ŒB ç½‘ç«™å°±ä¼šè·³å›redirect_uriå‚æ•°æŒ‡å®šçš„è·³è½¬ç½‘å€ï¼Œå¹¶ä¸”æŠŠä»¤ç‰Œä½œä¸º URL å‚æ•°ï¼Œä¼ ç»™ A ç½‘ç«™ã€‚ https://a.com/callback#token=ACCESS_TOKEN ä¸Šé¢ URL ä¸­ï¼Œtokenå‚æ•°å°±æ˜¯ä»¤ç‰Œï¼ŒA ç½‘ç«™å› æ­¤ç›´æ¥åœ¨å‰ç«¯æ‹¿åˆ°ä»¤ç‰Œã€‚\næ³¨æ„ï¼Œä»¤ç‰Œçš„ä½ç½®æ˜¯ URL é”šç‚¹ï¼ˆfragmentï¼‰ï¼Œè€Œä¸æ˜¯æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆquerystringï¼‰ï¼Œè¿™æ˜¯å› ä¸º OAuth 2.0 å…è®¸è·³è½¬ç½‘å€æ˜¯ HTTP åè®®ï¼Œå› æ­¤å­˜åœ¨\"ä¸­é—´äººæ”»å‡»\"çš„é£é™©ï¼Œè€Œæµè§ˆå™¨è·³è½¬æ—¶ï¼Œé”šç‚¹ä¸ä¼šå‘åˆ°æœåŠ¡å™¨ï¼Œå°±å‡å°‘äº†æ³„æ¼ä»¤ç‰Œçš„é£é™©ã€‚\nè¿™ç§æ–¹å¼æŠŠä»¤ç‰Œç›´æ¥ä¼ ç»™å‰ç«¯ï¼Œæ˜¯å¾ˆä¸å®‰å…¨çš„ã€‚å› æ­¤ï¼Œåªèƒ½ç”¨äºä¸€äº›å®‰å…¨è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œå¹¶ä¸”ä»¤ç‰Œçš„æœ‰æ•ˆæœŸå¿…é¡»éå¸¸çŸ­ï¼Œé€šå¸¸å°±æ˜¯ä¼šè¯æœŸé—´ï¼ˆsessionï¼‰æœ‰æ•ˆï¼Œæµè§ˆå™¨å…³æ‰ï¼Œä»¤ç‰Œå°±å¤±æ•ˆäº†ã€‚\nç¬¬ä¸‰ç§æ–¹å¼ï¼šå¯†ç å¼ å¦‚æœä½ é«˜åº¦ä¿¡ä»»æŸä¸ªåº”ç”¨ï¼ŒRFC 6749 ä¹Ÿå…è®¸ç”¨æˆ·æŠŠç”¨æˆ·åå’Œå¯†ç ï¼Œç›´æ¥å‘Šè¯‰è¯¥åº”ç”¨ã€‚è¯¥åº”ç”¨å°±ä½¿ç”¨ä½ çš„å¯†ç ï¼Œç”³è¯·ä»¤ç‰Œï¼Œè¿™ç§æ–¹å¼ç§°ä¸º\"å¯†ç å¼\"ï¼ˆpasswordï¼‰ã€‚\nç¬¬ä¸€æ­¥ï¼ŒA ç½‘ç«™è¦æ±‚ç”¨æˆ·æä¾› B ç½‘ç«™çš„ç”¨æˆ·åå’Œå¯†ç ã€‚æ‹¿åˆ°ä»¥åï¼ŒA å°±ç›´æ¥å‘ B è¯·æ±‚ä»¤ç‰Œã€‚\n1 2 3 4 5 https://oauth.b.com/token? grant_type=password\u0026 username=USERNAME\u0026 password=PASSWORD\u0026 client_id=CLIENT_ID ä¸Šé¢ URL ä¸­ï¼Œgrant_typeå‚æ•°æ˜¯æˆæƒæ–¹å¼ï¼Œè¿™é‡Œçš„passwordè¡¨ç¤º\"å¯†ç å¼\"ï¼Œusernameå’Œpasswordæ˜¯ B çš„ç”¨æˆ·åå’Œå¯†ç ã€‚ ç¬¬äºŒæ­¥ï¼ŒB ç½‘ç«™éªŒè¯èº«ä»½é€šè¿‡åï¼Œç›´æ¥ç»™å‡ºä»¤ç‰Œã€‚æ³¨æ„ï¼Œè¿™æ—¶ä¸éœ€è¦è·³è½¬ï¼Œè€Œæ˜¯æŠŠä»¤ç‰Œæ”¾åœ¨ JSON æ•°æ®é‡Œé¢ï¼Œä½œä¸º HTTP å›åº”ï¼ŒA å› æ­¤æ‹¿åˆ°ä»¤ç‰Œã€‚ è¿™ç§æ–¹å¼éœ€è¦ç”¨æˆ·ç»™å‡ºè‡ªå·±çš„ç”¨æˆ·å/å¯†ç ï¼Œæ˜¾ç„¶é£é™©å¾ˆå¤§ï¼Œå› æ­¤åªé€‚ç”¨äºå…¶ä»–æˆæƒæ–¹å¼éƒ½æ— æ³•é‡‡ç”¨çš„æƒ…å†µï¼Œè€Œä¸”å¿…é¡»æ˜¯ç”¨æˆ·é«˜åº¦ä¿¡ä»»çš„åº”ç”¨ã€‚\nç¬¬å››ç§æ–¹å¼ï¼šå‡­è¯å¼ æœ€åä¸€ç§æ–¹å¼æ˜¯å‡­è¯å¼ï¼ˆclient credentialsï¼‰ï¼Œé€‚ç”¨äºæ²¡æœ‰å‰ç«¯çš„å‘½ä»¤è¡Œåº”ç”¨ï¼Œå³åœ¨å‘½ä»¤è¡Œä¸‹è¯·æ±‚ä»¤ç‰Œã€‚ç¬¬ä¸€æ­¥ï¼ŒA åº”ç”¨åœ¨å‘½ä»¤è¡Œå‘ B å‘å‡ºè¯·æ±‚ã€‚\n1 2 3 4 https://oauth.b.com/token? grant_type=client_credentials\u0026 client_id=CLIENT_ID\u0026 client_secret=CLIENT_SECRET ä¸Šé¢ URL ä¸­ï¼Œgrant_typeå‚æ•°ç­‰äºclient_credentialsè¡¨ç¤ºé‡‡ç”¨å‡­è¯å¼ï¼Œclient_idå’Œclient_secretç”¨æ¥è®© Bç¡®è®¤ A çš„èº«ä»½ã€‚ ç¬¬äºŒæ­¥ï¼ŒB ç½‘ç«™éªŒè¯é€šè¿‡ä»¥åï¼Œç›´æ¥è¿”å›ä»¤ç‰Œã€‚è¿™ç§æ–¹å¼ç»™å‡ºçš„ä»¤ç‰Œï¼Œæ˜¯é’ˆå¯¹ç¬¬ä¸‰æ–¹åº”ç”¨çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹ç”¨æˆ·çš„ï¼Œå³æœ‰å¯èƒ½å¤šä¸ªç”¨æˆ·å…±äº«åŒä¸€ä¸ªä»¤ç‰Œã€‚\nä»¤ç‰Œçš„ä½¿ç”¨ A ç½‘ç«™æ‹¿åˆ°ä»¤ç‰Œä»¥åï¼Œå°±å¯ä»¥å‘ B ç½‘ç«™çš„ API è¯·æ±‚æ•°æ®äº†ã€‚ æ­¤æ—¶ï¼Œæ¯ä¸ªå‘åˆ° API çš„è¯·æ±‚ï¼Œéƒ½å¿…é¡»å¸¦æœ‰ä»¤ç‰Œã€‚å…·ä½“åšæ³•æ˜¯åœ¨è¯·æ±‚çš„å¤´ä¿¡æ¯ï¼ŒåŠ ä¸Šä¸€ä¸ªAuthorizationå­—æ®µï¼Œä»¤ç‰Œå°±æ”¾åœ¨è¿™ä¸ªå­—æ®µé‡Œé¢ã€‚\n1 2 curl -H \"Authorization: Bearer ACCESS_TOKEN\" \\ \"https://api.b.com\" ä¸Šé¢å‘½ä»¤ä¸­ï¼ŒACCESS_TOKENå°±æ˜¯æ‹¿åˆ°çš„ä»¤ç‰Œã€‚\næ›´æ–°ä»¤ç‰Œ ä»¤ç‰Œçš„æœ‰æ•ˆæœŸåˆ°äº†ï¼Œå¦‚æœè®©ç”¨æˆ·é‡æ–°èµ°ä¸€éä¸Šé¢çš„æµç¨‹ï¼Œå†ç”³è¯·ä¸€ä¸ªæ–°çš„ä»¤ç‰Œï¼Œå¾ˆå¯èƒ½ä½“éªŒä¸å¥½ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰å¿…è¦ã€‚OAuth 2.0 å…è®¸ç”¨æˆ·è‡ªåŠ¨æ›´æ–°ä»¤ç‰Œã€‚ å…·ä½“æ–¹æ³•æ˜¯ï¼ŒB ç½‘ç«™é¢å‘ä»¤ç‰Œçš„æ—¶å€™ï¼Œä¸€æ¬¡æ€§é¢å‘ä¸¤ä¸ªä»¤ç‰Œï¼Œä¸€ä¸ªç”¨äºè·å–æ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºè·å–æ–°çš„ä»¤ç‰Œï¼ˆrefresh token å­—æ®µï¼‰ã€‚ä»¤ç‰Œåˆ°æœŸå‰ï¼Œç”¨æˆ·ä½¿ç”¨ refresh token å‘ä¸€ä¸ªè¯·æ±‚ï¼Œå»æ›´æ–°ä»¤ç‰Œã€‚\n1 2 3 4 5 https://b.com/oauth/token? grant_type=refresh_token\u0026 client_id=CLIENT_ID\u0026 client_secret=CLIENT_SECRET\u0026 refresh_token=REFRESH_TOKEN ä¸Šé¢ URL ä¸­ï¼Œgrant_typeå‚æ•°ä¸ºrefresh_tokenè¡¨ç¤ºè¦æ±‚æ›´æ–°ä»¤ç‰Œï¼Œclient_idå‚æ•°å’Œclient_secretå‚æ•°ç”¨äºç¡®è®¤èº«ä»½ï¼Œrefresh_tokenå‚æ•°å°±æ˜¯ç”¨äºæ›´æ–°ä»¤ç‰Œçš„ä»¤ç‰Œã€‚\nB ç½‘ç«™éªŒè¯é€šè¿‡ä»¥åï¼Œå°±ä¼šé¢å‘æ–°çš„ä»¤ç‰Œã€‚\nå‚è€ƒé˜®ä¸€å³°è€å¸ˆçš„æ–‡ç«  OAuthä¸­æ–‡è§„èŒƒ\nJWT(JSON WEB TOKENS) JSON Web Tokenï¼ˆç¼©å†™ JWTï¼‰æ˜¯ç›®å‰æœ€æµè¡Œçš„è·¨åŸŸè®¤è¯è§£å†³æ–¹æ¡ˆï¼Œç‰¹åˆ«é€‚ç”¨äºåˆ†å¸ƒå¼ç«™ç‚¹çš„å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰åœºæ™¯ã€‚ å®˜æ–¹æ ‡å‡†\nè·¨åŸŸè®¤è¯çš„é—®é¢˜ äº’è”ç½‘æœåŠ¡ç¦»ä¸å¼€ç”¨æˆ·è®¤è¯ã€‚ä¸€èˆ¬æµç¨‹æ˜¯ä¸‹é¢è¿™æ ·ã€‚ 1ã€ç”¨æˆ·å‘æœåŠ¡å™¨å‘é€ç”¨æˆ·åå’Œå¯†ç ã€‚ 2ã€æœåŠ¡å™¨éªŒè¯é€šè¿‡åï¼Œåœ¨å½“å‰å¯¹è¯ï¼ˆsessionï¼‰é‡Œé¢ä¿å­˜ç›¸å…³æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·è§’è‰²ã€ç™»å½•æ—¶é—´ç­‰ç­‰ã€‚ 3ã€æœåŠ¡å™¨å‘ç”¨æˆ·è¿”å›ä¸€ä¸ª session_idï¼Œå†™å…¥ç”¨æˆ·çš„ Cookieã€‚ 4ã€ç”¨æˆ·éšåçš„æ¯ä¸€æ¬¡è¯·æ±‚ï¼Œéƒ½ä¼šé€šè¿‡ Cookieï¼Œå°† session_id ä¼ å›æœåŠ¡å™¨ã€‚ 5ã€æœåŠ¡å™¨æ”¶åˆ° session_idï¼Œæ‰¾åˆ°å‰æœŸä¿å­˜çš„æ•°æ®ï¼Œç”±æ­¤å¾—çŸ¥ç”¨æˆ·çš„èº«ä»½ã€‚\nè¿™ç§æ¨¡å¼çš„é—®é¢˜åœ¨äºï¼Œæ‰©å±•æ€§ï¼ˆscalingï¼‰ä¸å¥½ã€‚å•æœºå½“ç„¶æ²¡æœ‰é—®é¢˜ï¼Œå¦‚æœæ˜¯æœåŠ¡å™¨é›†ç¾¤ï¼Œæˆ–è€…æ˜¯è·¨åŸŸçš„æœåŠ¡å¯¼å‘æ¶æ„ï¼Œå°±è¦æ±‚ session æ•°æ®å…±äº«ï¼Œæ¯å°æœåŠ¡å™¨éƒ½èƒ½å¤Ÿè¯»å– sessionã€‚ ä¸¾ä¾‹æ¥è¯´ï¼ŒA ç½‘ç«™å’Œ B ç½‘ç«™æ˜¯åŒä¸€å®¶å…¬å¸çš„å…³è”æœåŠ¡ã€‚ç°åœ¨è¦æ±‚ï¼Œç”¨æˆ·åªè¦åœ¨å…¶ä¸­ä¸€ä¸ªç½‘ç«™ç™»å½•ï¼Œå†è®¿é—®å¦ä¸€ä¸ªç½‘ç«™å°±ä¼šè‡ªåŠ¨ç™»å½•ï¼Œè¯·é—®æ€ä¹ˆå®ç°ï¼Ÿ ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ session æ•°æ®æŒä¹…åŒ–ï¼Œå†™å…¥æ•°æ®åº“æˆ–åˆ«çš„æŒä¹…å±‚ã€‚å„ç§æœåŠ¡æ”¶åˆ°è¯·æ±‚åï¼Œéƒ½å‘æŒä¹…å±‚è¯·æ±‚æ•°æ®ã€‚ è¿™ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯æ¶æ„æ¸…æ™°ï¼Œç¼ºç‚¹æ˜¯å·¥ç¨‹é‡æ¯”è¾ƒå¤§ã€‚å¦å¤–ï¼ŒæŒä¹…å±‚ä¸‡ä¸€æŒ‚äº†ï¼Œå°±ä¼šå•ç‚¹å¤±è´¥ã€‚ å¦ä¸€ç§æ–¹æ¡ˆæ˜¯æœåŠ¡å™¨ç´¢æ€§ä¸ä¿å­˜ session æ•°æ®äº†ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½å‘å›æœåŠ¡å™¨ã€‚JWT å°±æ˜¯è¿™ç§æ–¹æ¡ˆçš„ä¸€ä¸ªä»£è¡¨ã€‚\nJWT çš„åŸç† JWT çš„åŸç†æ˜¯ï¼ŒæœåŠ¡å™¨è®¤è¯ä»¥åï¼Œç”Ÿæˆä¸€ä¸ª JSON å¯¹è±¡ï¼Œå‘å›ç»™ç”¨æˆ·ï¼Œå°±åƒä¸‹é¢è¿™æ ·ã€‚\n1 2 3 4 5 { \"å§“å\": \"å¼ ä¸‰\", \"è§’è‰²\": \"ç®¡ç†å‘˜\", \"åˆ°æœŸæ—¶é—´\": \"2018å¹´7æœˆ1æ—¥0ç‚¹0åˆ†\" } ä»¥åï¼Œç”¨æˆ·ä¸æœåŠ¡ç«¯é€šä¿¡çš„æ—¶å€™ï¼Œéƒ½è¦å‘å›è¿™ä¸ª JSON å¯¹è±¡ã€‚æœåŠ¡å™¨å®Œå…¨åªé è¿™ä¸ªå¯¹è±¡è®¤å®šç”¨æˆ·èº«ä»½ã€‚ä¸ºäº†é˜²æ­¢ç”¨æˆ·ç¯¡æ”¹æ•°æ®ï¼ŒæœåŠ¡å™¨åœ¨ç”Ÿæˆè¿™ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œä¼šåŠ ä¸Šç­¾åï¼ˆè¯¦è§åæ–‡ï¼‰ã€‚ æœåŠ¡å™¨å°±ä¸ä¿å­˜ä»»ä½• session æ•°æ®äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒæœåŠ¡å™¨å˜æˆæ— çŠ¶æ€äº†ï¼Œä»è€Œæ¯”è¾ƒå®¹æ˜“å®ç°æ‰©å±•ã€‚\nJWT çš„æ•°æ®ç»“æ„ å®é™…çš„ JWT å¤§æ¦‚å°±åƒä¸‹é¢è¿™æ ·ã€‚ eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nJWT çš„ä¸‰ä¸ªéƒ¨åˆ†ä¾æ¬¡å¦‚ä¸‹ã€‚ Headerï¼ˆå¤´éƒ¨ï¼‰ Payloadï¼ˆè´Ÿè½½ï¼‰ Signatureï¼ˆç­¾åï¼‰\nå†™æˆä¸€è¡Œï¼Œå°±æ˜¯ä¸‹é¢çš„æ ·å­ã€‚ Header.Payload.Signature\nHeader Header éƒ¨åˆ†æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œæè¿° JWT çš„å…ƒæ•°æ®ï¼Œé€šå¸¸æ˜¯ä¸‹é¢çš„æ ·å­ã€‚\n1 2 3 4 { \"alg\": \"HS256\", \"typ\": \"JWT\" } ä¸Šé¢ä»£ç ä¸­ï¼Œalgå±æ€§è¡¨ç¤ºç­¾åçš„ç®—æ³•ï¼ˆalgorithmï¼‰ï¼Œé»˜è®¤æ˜¯ HMAC SHA256ï¼ˆå†™æˆ HS256ï¼‰ï¼›typå±æ€§è¡¨ç¤ºè¿™ä¸ªä»¤ç‰Œï¼ˆtokenï¼‰çš„ç±»å‹ï¼ˆtypeï¼‰ï¼ŒJWT ä»¤ç‰Œç»Ÿä¸€å†™ä¸ºJWTã€‚ æœ€åï¼Œå°†ä¸Šé¢çš„ JSON å¯¹è±¡ä½¿ç”¨ Base64URL ç®—æ³•ï¼ˆè¯¦è§åæ–‡ï¼‰è½¬æˆå­—ç¬¦ä¸²ã€‚\nPayload Payload éƒ¨åˆ†ä¹Ÿæ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾å®é™…éœ€è¦ä¼ é€’çš„æ•°æ®ã€‚JWT è§„å®šäº†7ä¸ªå®˜æ–¹å­—æ®µï¼Œä¾›é€‰ç”¨ã€‚\n1 2 3 4 5 6 7 iss (issuer)ï¼šç­¾å‘äºº exp (expiration time)ï¼šè¿‡æœŸæ—¶é—´ sub (subject)ï¼šä¸»é¢˜ aud (audience)ï¼šå—ä¼— nbf (Not Before)ï¼šç”Ÿæ•ˆæ—¶é—´ iat (Issued At)ï¼šç­¾å‘æ—¶é—´ jti (JWT ID)ï¼šç¼–å· é™¤äº†å®˜æ–¹å­—æ®µï¼Œä½ è¿˜å¯ä»¥åœ¨è¿™ä¸ªéƒ¨åˆ†å®šä¹‰ç§æœ‰å­—æ®µï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªä¾‹å­ã€‚\n1 2 3 4 5 { \"sub\": \"1234567890\", \"name\": \"John Doe\", \"admin\": true } æ³¨æ„ï¼ŒJWT é»˜è®¤æ˜¯ä¸åŠ å¯†çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥è¯»åˆ°ï¼Œæ‰€ä»¥ä¸è¦æŠŠç§˜å¯†ä¿¡æ¯æ”¾åœ¨è¿™ä¸ªéƒ¨åˆ†ã€‚\nSignature Signature éƒ¨åˆ†æ˜¯å¯¹å‰ä¸¤éƒ¨åˆ†çš„ç­¾åï¼Œé˜²æ­¢æ•°æ®ç¯¡æ”¹ã€‚ é¦–å…ˆï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªå¯†é’¥ï¼ˆsecretï¼‰ã€‚è¿™ä¸ªå¯†é’¥åªæœ‰æœåŠ¡å™¨æ‰çŸ¥é“ï¼Œä¸èƒ½æ³„éœ²ç»™ç”¨æˆ·ã€‚ç„¶åï¼Œä½¿ç”¨ Header é‡Œé¢æŒ‡å®šçš„ç­¾åç®—æ³•ï¼ˆé»˜è®¤æ˜¯ HMAC SHA256ï¼‰ï¼ŒæŒ‰ç…§ä¸‹é¢çš„å…¬å¼äº§ç”Ÿç­¾åã€‚\n1 2 3 4 HMACSHA256( base64UrlEncode(header) + \".\" + base64UrlEncode(payload), secret) ç®—å‡ºç­¾åä»¥åï¼ŒæŠŠ Headerã€Payloadã€Signature ä¸‰ä¸ªéƒ¨åˆ†æ‹¼æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªéƒ¨åˆ†ä¹‹é—´ç”¨\"ç‚¹\"ï¼ˆ.ï¼‰åˆ†éš”ï¼Œå°±å¯ä»¥è¿”å›ç»™ç”¨æˆ·ã€‚\nBase64URL å‰é¢æåˆ°ï¼ŒHeader å’Œ Payload ä¸²å‹åŒ–çš„ç®—æ³•æ˜¯ Base64URLã€‚è¿™ä¸ªç®—æ³•è·Ÿ Base64 ç®—æ³•åŸºæœ¬ç±»ä¼¼ï¼Œä½†æœ‰ä¸€äº›å°çš„ä¸åŒã€‚JWT ä½œä¸ºä¸€ä¸ªä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œæœ‰äº›åœºåˆå¯èƒ½ä¼šæ”¾åˆ° URLï¼ˆæ¯”å¦‚ api.example.com/?token=xxxï¼‰ã€‚Base64 æœ‰ä¸‰ä¸ªå­—ç¬¦+ã€/å’Œ=ï¼Œåœ¨ URL é‡Œé¢æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œæ‰€ä»¥è¦è¢«æ›¿æ¢æ‰ï¼š=è¢«çœç•¥ã€+æ›¿æ¢æˆ-ï¼Œ/æ›¿æ¢æˆ_ ã€‚è¿™å°±æ˜¯ Base64URL ç®—æ³•ã€‚\nJWT çš„ä½¿ç”¨æ–¹å¼ å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„ JWTï¼Œå¯ä»¥å‚¨å­˜åœ¨ Cookie é‡Œé¢ï¼Œä¹Ÿå¯ä»¥å‚¨å­˜åœ¨ localStorageã€‚ æ­¤åï¼Œå®¢æˆ·ç«¯æ¯æ¬¡ä¸æœåŠ¡å™¨é€šä¿¡ï¼Œéƒ½è¦å¸¦ä¸Šè¿™ä¸ª JWTã€‚ä½ å¯ä»¥æŠŠå®ƒæ”¾åœ¨ Cookie é‡Œé¢è‡ªåŠ¨å‘é€ï¼Œä½†æ˜¯è¿™æ ·ä¸èƒ½è·¨åŸŸï¼Œæ‰€ä»¥æ›´å¥½çš„åšæ³•æ˜¯æ”¾åœ¨ HTTP è¯·æ±‚çš„å¤´ä¿¡æ¯Authorizationå­—æ®µé‡Œé¢ã€‚ Authorization: Bearer å¦ä¸€ç§åšæ³•æ˜¯ï¼Œè·¨åŸŸçš„æ—¶å€™ï¼ŒJWT å°±æ”¾åœ¨ POST è¯·æ±‚çš„æ•°æ®ä½“é‡Œé¢ã€‚\nJWT çš„å‡ ä¸ªç‰¹ç‚¹ JWT é»˜è®¤æ˜¯ä¸åŠ å¯†ï¼Œä½†ä¹Ÿæ˜¯å¯ä»¥åŠ å¯†çš„ã€‚ç”ŸæˆåŸå§‹ Token ä»¥åï¼Œå¯ä»¥ç”¨å¯†é’¥å†åŠ å¯†ä¸€æ¬¡ã€‚ JWT ä¸åŠ å¯†çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½å°†ç§˜å¯†æ•°æ®å†™å…¥ JWTã€‚ JWT ä¸ä»…å¯ä»¥ç”¨äºè®¤è¯ï¼Œä¹Ÿå¯ä»¥ç”¨äºäº¤æ¢ä¿¡æ¯ã€‚æœ‰æ•ˆä½¿ç”¨ JWTï¼Œå¯ä»¥é™ä½æœåŠ¡å™¨æŸ¥è¯¢æ•°æ®åº“çš„æ¬¡æ•°ã€‚ JWT çš„æœ€å¤§ç¼ºç‚¹æ˜¯ï¼Œç”±äºæœåŠ¡å™¨ä¸ä¿å­˜ session çŠ¶æ€ï¼Œå› æ­¤æ— æ³•åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­åºŸæ­¢æŸä¸ª tokenï¼Œæˆ–è€…æ›´æ”¹token çš„æƒé™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ JWT ç­¾å‘äº†ï¼Œåœ¨åˆ°æœŸä¹‹å‰å°±ä¼šå§‹ç»ˆæœ‰æ•ˆï¼Œé™¤éæœåŠ¡å™¨éƒ¨ç½²é¢å¤–çš„é€»è¾‘ã€‚ JWT æœ¬èº«åŒ…å«äº†è®¤è¯ä¿¡æ¯ï¼Œä¸€æ—¦æ³„éœ²ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å¾—è¯¥ä»¤ç‰Œçš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWT çš„æœ‰æ•ˆæœŸåº”è¯¥è®¾ç½®å¾—æ¯”è¾ƒçŸ­ã€‚å¯¹äºä¸€äº›æ¯”è¾ƒé‡è¦çš„æƒé™ï¼Œä½¿ç”¨æ—¶åº”è¯¥å†æ¬¡å¯¹ç”¨æˆ·è¿›è¡Œè®¤è¯ã€‚ ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWT ä¸åº”è¯¥ä½¿ç”¨ HTTP åè®®æ˜ç ä¼ è¾“ï¼Œè¦ä½¿ç”¨ HTTPS åè®®ä¼ è¾“ã€‚ ç†è§£Spring Cloud Security OAuth2åŠJWT\nSpring Security OAuth2 æ„å»ºé¡¹ç›® ç”¨ideaåˆ›å»ºspring booté¡¹ç›®ï¼Œå¹¶å¼•å…¥å¦‚ä¸‹mavenä¾èµ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 org.springframework.boot spring-boot-starter-web mysql mysql-connector-java runtime com.alibaba druid 1.0.29 org.springframework spring-jdbc 5.1.9.RELEASE org.springframework.boot spring-boot-starter-data-jpa org.springframework.boot spring-boot-starter-security org.springframework.security.oauth spring-security-oauth2 2.3.3.RELEASE é¡¹ç›®é…ç½®æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 spring: datasource: type: com.alibaba.druid.pool.DruidDataSource driver-class-name: com.mysql.jdbc.Driver url: jdbc:mysql://127.0.0.1:3306/oauth2?characterEncoding=utf8 username: root password: 123456 #æœ€å¤§æ´»è·ƒæ•° maxActive: 20 #åˆå§‹åŒ–æ•°é‡ initialSize: 1 #æœ€å¤§è¿æ¥ç­‰å¾…è¶…æ—¶æ—¶é—´ maxWait: 60000 #æ‰“å¼€PSCacheï¼Œå¹¶ä¸”æŒ‡å®šæ¯ä¸ªè¿æ¥PSCacheçš„å¤§å° poolPreparedStatements: true maxPoolPreparedStatementPerConnectionSize: 20 #é€šè¿‡connectionPropertieså±æ€§æ¥æ‰“å¼€mergeSqlåŠŸèƒ½ï¼›æ…¢SQLè®°å½• #connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000 minIdle: 1 timeBetweenEvictionRunsMillis: 60000 minEvictableIdleTimeMillis: 300000 validationQuery: select 1 from dual testWhileIdle: true testOnBorrow: false testOnReturn: false #é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filtersï¼Œå»æ‰åç›‘æ§ç•Œé¢sqlå°†æ— æ³•ç»Ÿè®¡,'wall'ç”¨äºé˜²ç«å¢™ filters: stat, wall, log4j jpa: properties: hibernate: show_sql: true format_sql: true æ•°æ®åº“ å› ä¸ºæˆ‘ä»¬ä½¿ç”¨æ•°æ®åº“ä¿å­˜ç”¨æˆ·ã€è§’è‰²ã€accessTokenã€RefershTokenç­‰ä¿¡æ¯ï¼Œæ‰€ä»¥è¦æ–°å»ºéœ€è¦çš„è¡¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 -- ---------------------------- -- ç”¨æˆ·è¡¨ -- ---------------------------- CREATE TABLE `user` ( `username` varchar(50) NOT NULL, `email` varchar(50) DEFAULT NULL, `password` varchar(500) DEFAULT NULL, `activated` tinyint(1) DEFAULT '0', `activationkey` varchar(50) DEFAULT NULL, `resetpasswordkey` varchar(50) DEFAULT NULL, PRIMARY KEY (`username`) ) ENGINE=MyISAM DEFAULT CHARSET=utf8; -- ---------------------------- -- ç”¨æˆ·æ•°æ®ã€‚éœ€è¦æ³¨æ„å¯†ç å­—æ®µï¼Œå­˜çš„æ˜¯åŠ å¯†ä¹‹åçš„å¯†æ–‡ã€‚åŠ å¯†ç®—æ³•ä¼šåœ¨åé¢è¯´æ˜ã€‚ -- ---------------------------- INSERT INTO `user` VALUES ('admin', 'admin@mail.me', '$2a$10$vHCuajBQOH4ZX8LKRoRFI.6s23W9wgPUyw6VqJS5KWEZkjnT52nfi', '1', null, null); INSERT INTO `user` VALUES ('user', 'user@mail.me', '$2a$10$vHCuajBQOH4ZX8LKRoRFI.6s23W9wgPUyw6VqJS5KWEZkjnT52nfi', '1', null, null); -- ---------------------------- -- è§’è‰²è¡¨ -- ---------------------------- CREATE TABLE `authority` ( `name` varchar(50) NOT NULL, PRIMARY KEY (`name`) ) ENGINE=MyISAM DEFAULT CHARSET=utf8; -- ---------------------------- -- è§’è‰²æ•°æ® -- ---------------------------- INSERT INTO `authority` VALUES ('ROLE_ADMIN'); INSERT INTO `authority` VALUES ('ROLE_USER'); -- ---------------------------- -- ç”¨æˆ·è§’è‰²å…³è”è¡¨ -- ---------------------------- CREATE TABLE `user_authority` ( `username` varchar(50) NOT NULL, `authority` varchar(50) NOT NULL, UNIQUE KEY `user_authority_idx_1` (`username`,`authority`), KEY `authority` (`authority`) ) ENGINE=MyISAM DEFAULT CHARSET=utf8; -- ---------------------------- -- ä¸­é—´è¡¨æ•°æ® -- ---------------------------- INSERT INTO `user_authority` VALUES ('admin', 'ROLE_ADMIN'); INSERT INTO `user_authority` VALUES ('admin', 'ROLE_USER'); INSERT INTO `user_authority` VALUES ('user', 'ROLE_USER'); -- ---------------------------- -- æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯SpringSecurityOAuth2æä¾›çš„Jdbcæ–¹å¼è¿›è¡Œæ“ä½œTokenï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®æ ‡å‡†åˆ›å»ºå¯¹åº”çš„è¡¨ç»“æ„ -- ---------------------------- CREATE TABLE `oauth_access_token` ( `token_id` varchar(256) DEFAULT NULL, `token` blob, `authentication_id` varchar(256) DEFAULT NULL, `user_name` varchar(256) DEFAULT NULL, `client_id` varchar(256) DEFAULT NULL, `authentication` blob, `refresh_token` varchar(256) DEFAULT NULL ) ENGINE=MyISAM DEFAULT CHARSET=utf8; -- ---------------------------- -- åˆ·æ–°Tokenæ—¶éœ€è¦ç”¨åˆ°refresh_tokenä¿¡æ¯è¡¨ -- ---------------------------- CREATE TABLE `oauth_refresh_token` ( `token_id` varchar(256) DEFAULT NULL, `token` blob, `authentication` blob ) ENGINE=MyISAM DEFAULT CHARSET=utf8; åˆ›å»ºå®ä½“ç±» åªéœ€è¦åˆ›å»ºç”¨æˆ·ã€è§’è‰²å®ä½“ç±»ã€‚å› ä¸ºOAuth2å†…éƒ¨æ“ä½œæ•°æ®åº“ä½¿ç”¨çš„JdbcTemplateæˆ‘ä»¬åªéœ€è¦ä¼ å…¥ä¸€ä¸ªDataSourceå¯¹è±¡å°±å¯ä»¥äº†ï¼Œå®ä½“å¹¶ä¸éœ€è¦é…ç½®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Entity public class User { @Id @Column(updatable = false, nullable = false) private String username; private String password; private String email; private boolean activated; @Column(name = \"activationkey\") private String activationKey; @Column(name = \"resetpasswordkey\") private String resetPasswordKey; @ManyToMany @JoinTable( name = \"user_authority\", joinColumns = @JoinColumn(name = \"username\"), inverseJoinColumns = @JoinColumn(name = \"authority\")) private Set authorities; } 1 2 3 4 5 6 @Entity public class Authority { @Id private String name; } ç”¨æˆ·å®ä½“ä»¥åŠè§’è‰²å®ä½“æ˜¯ç”¨æ¥é…ç½®SpringSecurityæ—¶ç”¨åˆ°çš„å®ä½“ï¼Œæˆ‘ä»¬é…ç½®SpringSecurityæ—¶éœ€è¦ä½¿ç”¨SpringDataJPAä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ï¼Œä¸‹æˆ‘ä»¬æ¥é…ç½®UserJPAä»¥åŠAuthorityJPAã€‚\n1 2 3 4 5 6 public interface UserJPA extends JpaRepository { @Query(\"SELECT u FROM User u WHERE LOWER(u.username) = LOWER(:username)\") User findByUsernameCaseInsensitive(@Param(\"username\") String username); } æˆ‘ä»¬åœ¨UserJPAå†…æ·»åŠ äº†ä¸€ä¸ªè‡ªå®šä¹‰æŸ¥è¯¢ï¼Œä½¿ç”¨äº†HQLè¯­æ³•æ¥æ„å»ºçš„è¯­å¥ï¼Œæ ¹æ®ç”¨æˆ·åä¸åŒºåˆ†å¤§å°å†™è¿›è¡ŒæŸ¥è¯¢ã€‚\n1 2 public interface AuthorityJPA extends JpaRepository { } è‡ªå®šä¹‰UserDetailsService åˆ›å»ºç±»å¹¶å®ç°UserDetailsService:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Component(\"userDetailsService\") public class OauthUserDetailsService implements UserDetailsService { @Autowired private UserJPA userRepository; @Override @Transactional public UserDetails loadUserByUsername(final String login) { String lowercaseLogin = login.toLowerCase(); User userFromDatabase = userRepository.findByUsernameCaseInsensitive(lowercaseLogin); if (userFromDatabase == null) { throw new NewUserNotFoundException(\"User \" + lowercaseLogin + \" was not found in the database\"); } //è·å–ç”¨æˆ·çš„æ‰€æœ‰æƒé™ï¼Œæƒé™æ˜¯SpringSecurityéœ€è¦çš„é›†åˆ Collection grantedAuthorities = new ArrayList\u003c\u003e(); for (Authority authority : userFromDatabase.getAuthorities()) { GrantedAuthority grantedAuthority = new SimpleGrantedAuthority(authority.getName()); grantedAuthorities.add(grantedAuthority); } //è¿”å›ä¸€ä¸ªSpringSecurityéœ€è¦çš„ç”¨æˆ·å¯¹è±¡ return new org.springframework.security.core.userdetails.User( userFromDatabase.getUsername(), userFromDatabase.getPassword(), grantedAuthorities); } } è‡ªå®šä¹‰çš„ OauthUserDetailsService ç±»ä¸­åšäº†ä»æ•°æ®åº“è¯»å–ç”¨æˆ·çš„æ“ä½œï¼Œå¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°ç”¨æˆ·ç›´æ¥æŠ›å‡ºå¼‚å¸¸æç¤ºï¼Œå¦‚æœæŸ¥è¯¢åˆ°å¹¶ä¸”è®¾ç½®å¯¹åº”çš„è§’è‰²åè¿”å›SpringSecurityå†…ç½®çš„Userå¯¹è±¡å®ä¾‹ã€‚\né…ç½®SpringSecurity 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 @Configuration @EnableWebSecurity public class SecurityConfiguration extends WebSecurityConfigurerAdapter { //æ³¨å…¥è‡ªå®šä¹‰çš„UserDetailsService @Autowired private OauthUserDetailsService oauthUserDetailsService; //é…ç½®åŒ¹é…ç”¨æˆ·æ—¶å¯†ç è§„åˆ™ @Bean public PasswordEncoder passwordEncoder() { return new BCryptPasswordEncoder(); } // @Bean // public PasswordEncoder passwordEncoder(){ // return PasswordEncoderFactories.createDelegatingPasswordEncoder(); // } //é…ç½®å…¨å±€è®¾ç½® @Autowired public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception { //è®¾ç½®UserDetailsServiceä»¥åŠå¯†ç è§„åˆ™ //è¿™ä¸ªè§„åˆ™å½±å“äº†æ•°æ®åº“é‡Œå­˜å‚¨çš„passwordå­—æ®µï¼Œå‘æ•°æ®åº“å­˜å‚¨passwordæ—¶ï¼Œä¹Ÿè¦æŒ‰ç…§è¿™ä¸ªç®—æ³• auth.userDetailsService(oauthUserDetailsService).passwordEncoder(passwordEncoder()); } //æ’é™¤/helloè·¯å¾„æ‹¦æˆª @Override public void configure(WebSecurity web) throws Exception { web.ignoring().antMatchers(\"/hello\"); } @Override @Bean public AuthenticationManager authenticationManagerBean() throws Exception { return super.authenticationManagerBean(); } //å¼€å¯å…¨å±€æ–¹æ³•æ‹¦æˆª @EnableGlobalMethodSecurity(prePostEnabled = true, jsr250Enabled = true) public static class GlobalSecurityConfiguration extends GlobalMethodSecurityConfiguration { @Override protected MethodSecurityExpressionHandler createExpressionHandler() { return new OAuth2MethodSecurityExpressionHandler(); } } } æˆ‘ä»¬åœ¨é…ç½®ç±»ä¸­æ³¨å…¥äº†ä¸Šé¢æˆ‘ä»¬è‡ªå®šä¹‰çš„ OauthUserDetailsService ä»¥åŠç”¨æˆ·å¯†ç éªŒè¯è§„åˆ™ï¼Œæˆ‘ä»¬ä½¿ç”¨ignoring()æ–¹æ³•æ’é™¤äº†HelloWorldControllerå†…çš„å…¬å¼€æ–¹æ³•ï¼Œè¿™é‡Œå¯ä»¥é…ç½®é€šé…ç¬¦çš„å½¢å¼æ’é™¤ã€‚\nè‡ªå®šä¹‰401é”™è¯¯ç å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /** * è‡ªå®šä¹‰401é”™è¯¯ç å†…å®¹ */ @Component public class CustomAuthenticationEntryPoint implements AuthenticationEntryPoint { private final Logger log = LoggerFactory.getLogger(CustomAuthenticationEntryPoint.class); public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException ae) throws IOException, ServletException { log.info(\"Pre-authenticated entry point called. Rejecting access\"); response.sendError(HttpServletResponse.SC_UNAUTHORIZED, \"Access Denied\"); } } å®ç°äº†CustomAuthenticationEntryPointæ¥å£ï¼Œè¯¥ç±»æ˜¯ç”¨æ¥é…ç½®å¦‚æœæ²¡æœ‰æƒé™è®¿é—®æ¥å£æ—¶æˆ‘ä»¬è¿”å›çš„é”™è¯¯ç ä»¥åŠé”™è¯¯å†…å®¹ã€‚\nå®šä¹‰ç™»å‡ºæ§åˆ¶ å½“æˆ‘ä»¬é€€å‡ºç³»ç»Ÿæ—¶éœ€è¦è®¿é—®SpringSecrutiyçš„logoutæ–¹æ³•æ¥æ¸…ç©ºå¯¹åº”çš„sessionä¿¡æ¯ï¼Œé‚£æˆ‘ä»¬é€€å‡ºåæ”¹ç”¨æˆ·çš„access_tokenè¿˜ä¾ç„¶å­˜åœ¨é‚£å°±å±é™©äº†ï¼Œä¸€æ—¦åˆ«äººçŸ¥é“è¯¥tokenå°±å¯ä»¥ä½¿ç”¨ä¹‹å‰ç™»å½•ç”¨æˆ·çš„æƒé™æ¥æ“ä½œä¸šåŠ¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @Component public class CustomLogoutSuccessHandler extends AbstractAuthenticationTargetUrlRequestHandler implements LogoutSuccessHandler { private static final String BEARER_AUTHENTICATION = \"Bearer \"; private static final String HEADER_AUTHORIZATION = \"authorization\"; @Autowired private TokenStore tokenStore; @Override public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException { String token = request.getHeader(HEADER_AUTHORIZATION); if (token != null \u0026\u0026 token.startsWith(BEARER_AUTHENTICATION)) { OAuth2AccessToken oAuth2AccessToken = tokenStore.readAccessToken(token.split(\" \")[0]); if (oAuth2AccessToken != null) { tokenStore.removeAccessToken(oAuth2AccessToken); } } response.setStatus(HttpServletResponse.SC_OK); } } é…ç½®èµ„æºæœåŠ¡å™¨ åˆ›å»ºä¸€ä¸ªOAuth2æ€»é…ç½®ç±»OAuth2Configurationï¼Œç±»å†…æ·»åŠ ä¸€ä¸ªå­ç±»ç”¨äºé…ç½®èµ„æºæœåŠ¡å™¨ï¼Œå¦ä¸€ä¸ªç”¨äºOAuth2è®¤è¯æœåŠ¡å™¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 @Configuration public class OAuth2Configuration { /** * èµ„æºæœåŠ¡å™¨ */ @Configuration @EnableResourceServer protected static class ResourceServerConfiguration extends ResourceServerConfigurerAdapter { @Autowired private CustomAuthenticationEntryPoint customAuthenticationEntryPoint; @Autowired private CustomLogoutSuccessHandler customLogoutSuccessHandler; @Override public void configure(HttpSecurity http) throws Exception { http .exceptionHandling() .authenticationEntryPoint(customAuthenticationEntryPoint) .and() .logout() .logoutUrl(\"/oauth/logout\") .logoutSuccessHandler(customLogoutSuccessHandler) .and() .authorizeRequests() .antMatchers(\"/hello/\").permitAll() .antMatchers(\"/secure/**\").authenticated(); } } /** * OAuth2è®¤è¯æœåŠ¡å™¨ */ @Configuration @EnableAuthorizationServer protected static class AuthorizationServerConfiguration extends AuthorizationServerConfigurerAdapter{ //å®¢æˆ·ç«¯id private String client_id = \"wjy_client\"; //å®¢æˆ·ç«¯å¯†é’¥ private String secret = \"wjy_secret\"; //tokenè¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ private Integer token_validity_seconds = 1800; @Autowired private DataSource dataSource; //å¦‚æœæƒ³ç”¨rediså­˜å‚¨token //@Autowired //RedisConnectionFactory redisConnectionFactory; @Bean public TokenStore tokenStore() { return new JdbcTokenStore(dataSource); } @Autowired @Qualifier(\"authenticationManagerBean\") private AuthenticationManager authenticationManager; @Override public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception { endpoints //ä½¿ç”¨SpringSecurityOAuth2å†…å®šä¹‰çš„JdbcStoreæ¥æ“ä½œæ•°æ®åº“ä¸­çš„Token .tokenStore(tokenStore()) //å¦‚æœæƒ³ç”¨rediså­˜å‚¨tokenï¼Œå°±è¿™ä¹ˆå†™ //.tokenStore(new RedisTokenStore(redisConnectionFactory)) .authenticationManager(authenticationManager); } @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception { clients.inMemory().withClient(client_id) .secret(new BCryptPasswordEncoder().encode(secret))//å°†æ˜æ–‡åŠ å¯† .scopes(\"read\", \"write\") .authorities(Authorities.ROLE_ADMIN.name(), Authorities.ROLE_USER.name()) .authorizedGrantTypes(\"password\", \"refresh_token\") .additionalInformation(\"model\",\"test\") .accessTokenValiditySeconds(token_validity_seconds); } } public static void main(String[] args) { //åŠ å¯†æ–¹å¼æµ‹è¯• BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder(); System.out.println(new BCryptPasswordEncoder().encode(\"123456\")); } } è¿™é‡Œclient_idå’Œsecretç›´æ¥å†™åœ¨äº†å†…å­˜ä¸­ï¼Œä¹Ÿå¯ä»¥å­˜åœ¨æ•°æ®åº“ä¸­ã€‚\né…ç½®æ§åˆ¶å™¨ï¼ˆControllerï¼‰ ä¸‹é¢æˆ‘ä»¬æ¥é…ç½®ä¸¤ä¸ªæ§åˆ¶å™¨ç”¨æ¥åŒºåˆ†æˆ‘ä»¬é…ç½®OAuth2æ˜¯å¦ç”Ÿæ•ˆã€‚ æˆ‘åœ¨HelloWorldControllerå†…åªæ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²çš„è¾“å‡ºï¼Œè¿™ä¸ªæ§åˆ¶å™¨æˆ‘ä»¬å¼€æ”¾ï¼Œè®©SpringSecurityä¸å»ç®¡ç†ï¼Œé…ç½®å°†ä¼šåœ¨ä¸‹é¢å±•ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 @RestController @RequestMapping(\"/hello\") public class HelloWorldController { @RequestMapping(method = RequestMethod.GET) public String sayHello() { return \"Hello User!\"; } } SecureControllerè¿™ä¸ªæ§åˆ¶å™¨æ˜¯éœ€è¦æˆ‘ä»¬è·å–æˆæƒTokenåä½¿ç”¨Tokenæ‰å¯ä»¥è®¿é—®åˆ°çš„ï¼Œä»£ç å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 @RestController @RequestMapping(\"/secure\") public class SecureController { @RequestMapping(method = RequestMethod.GET) public String sayHello() { return \"Secure Hello!\"; } } æµ‹è¯• å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨postManè¿›è¡Œæµ‹è¯•ã€‚ å…ˆè®¿é—®å…¬å¼€çš„æ¥å£åœ°å€ï¼š http://127.0.0.1:8080/hello\nå¾—åˆ°æ¥å£æ­£ç¡®çš„è¿”å›å†…å®¹ï¼š Hello User!\nç»§ç»­éªŒè¯è®¿é—®å—é™çš„æ¥å£ï¼š 127.0.0.1:8080/secure\nå¾—åˆ°è¿”å›å†…å®¹ï¼š\n1 2 3 4 5 6 7 { \"timestamp\": \"2021-03-24T09:07:28.276+0000\", \"status\": 401, \"error\": \"Unauthorized\", \"message\": \"Access Denied\", \"path\": \"/secure\" } æ­£å¦‚æˆ‘ä»¬é¢„æœŸä¸€æ ·ï¼Œè¿”å›äº†401é”™è¯¯ä»¥åŠæˆ‘ä»¬è‡ªå®šä¹‰çš„é”™è¯¯ç â€Access Deniedâ€œ å¦‚æœè¿”å›çš„æ˜¯ä¸€äº›htmlï¼Œé‚£ä¹ˆéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ï¼š\n1 2 3 4 security: oauth2: resource: filter-order: 3 è¿™ä¸ªé…ç½®å°†æˆ‘ä»¬çš„èµ„æºæ‹¦æˆªçš„è¿‡æ»¤å™¨è¿è¡Œé¡ºåºæ”¾åˆ°ç¬¬3ä¸ªæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯åœ¨oauth2çš„è®¤è¯æœåŠ¡å™¨åé¢æ‰§è¡Œã€‚\nè·å–AccessToken è·å–tokenä¹‹å‰éœ€è¦åœ¨æ•°æ®åº“ä¸­æ·»åŠ ç”¨æˆ·æ•°æ®ã€‚ç„¶åè®¿é—® http://localhost:8080/oauth/token?username=admin\u0026password=123456\u0026grant_type=password\næ³¨æ„ï¼šå‚æ•°åä¸èƒ½æ”¹å˜ã€‚ usernameï¼šæ•°æ®åº“ä¸­çš„usernameã€‚ passwordï¼šæ•°æ®åº“ä¸­çš„passwordã€‚ grant_typeï¼šæˆæƒç±»å‹ï¼Œè¿™é‡Œé»˜è®¤password\nè¿˜éœ€è¦åœ¨postMançš„Authä¸€æ ï¼Œtypeé€‰æ‹©Basic Authï¼Œç„¶ååœ¨ä¸‹é¢å¡«å…¥æˆ‘ä»¬åœ¨å†…å­˜ä¸­é…ç½®çš„client_idå’Œclient_secretã€‚ è¯·æ±‚æˆåŠŸè¿”å›ç»“æœï¼š\n1 2 3 4 5 6 7 { \"access_token\": \"b2911fcc-a969-4f2d-843d-dc8cb9be3c85\", \"token_type\": \"bearer\", \"refresh_token\": \"889b1731-19a0-4f05-b5d5-2ee996ba1f1c\", \"expires_in\": 840, \"scope\": \"read write\" } access_tokenï¼šæœ¬åœ°è®¿é—®è·å–åˆ°çš„access_tokenï¼Œä¼šè‡ªåŠ¨å†™å…¥åˆ°æ•°æ®åº“ä¸­ã€‚ token_typeï¼šè·å–åˆ°çš„access_tokençš„æˆæƒæ–¹å¼ refersh_tokenï¼šåˆ·æ–°tokenæ—¶æ‰€ç”¨åˆ°çš„æˆæƒtoken expires_inï¼šæœ‰æ•ˆæœŸï¼ˆä»è·å–å¼€å§‹è®¡æ—¶ï¼Œå€¼ç§’åè¿‡æœŸï¼‰ scopeï¼šå®¢æˆ·ç«¯çš„æ¥å£æ“ä½œæƒé™ï¼ˆreadï¼šè¯»ï¼Œwriteï¼šå†™ï¼‰\nä½¿ç”¨access_tokenè®¿é—®æ•°æ® è·å¾—access_tokenä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨access_tokenè®¿é—®åˆšæ‰å—é™çš„æ¥å£äº†ã€‚ http://127.0.0.1:8080/secure?access_token=b2911fcc-a969-4f2d-843d-dc8cb9be3c85\nSecure Hello! å¯ä»¥çœ‹åˆ°å·²ç»å¯ä»¥æ­£å¸¸è®¿é—®å—é™çš„æ¥å£äº†ï¼Œè¯æ˜æˆ‘ä»¬çš„access_tokenæ˜¯æœ‰æ•ˆçš„ã€‚ access_tokenè¿‡æœŸåï¼Œä¼šè¿”å›å¦‚ä¸‹å†…å®¹ï¼š\n1 2 3 4 { \"error\": \"invalid_token\", \"error_description\": \"Invalid access token: b2911fcc-a969-4f2d-843d-dc8cb9be3c85\" } access_tokenè¿‡æœŸäº†ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡æ¥å£æ¥åˆ·æ–°access_tokenã€‚\nåˆ·æ–°AccessToken http://localhost:8080/oauth/token?grant_type=refresh_token\u0026refresh_token=889b1731-19a0-4f05-b5d5-2ee996ba1f1c\ngrant_typeï¼šæˆæƒç±»å‹ï¼Œæ­¤æ—¶å¡«å†™refresh_token refresh_tokenï¼šæ˜¯æˆ‘ä»¬è·å–access_tokenæ—¶ï¼Œæ¥å£è¿”å›çš„refresh_tokenï¼Œéœ€è¦ç”¨åˆ°è¯¥å€¼æ¥åˆ·æ–°tokenã€‚ æ–°çš„tokenå€¼å¾—æœ‰æ•ˆæœŸå¯ä»¥çœ‹åˆ°åˆæ˜¯æˆ‘ä»¬é…ç½®çš„é»˜è®¤1800ç§’ï¼Œåˆ·æ–°tokenæ—¶oauth2è¿˜æ˜¯ç»™æˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªrefersh_tokenå€¼ï¼Œè¯¥å€¼è¦ä½œä¸ºä¸‹æ¬¡åˆ·æ–°tokenæ—¶ä½¿ç”¨ã€‚\nå‚è€ƒ æºç  spring-data-jpaå­¦ä¹  å…¶ä»–å‚è€ƒ å‚è€ƒ\n",
  "wordCount" : "10984",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "Me"
  }, {
    "@type": "Person",
    "name": "You"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/java/oauth/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;Â»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title">
      OAuth
    </h1>
    <div class="post-meta">Me, You

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#oauth" aria-label="OAuth">OAuth</a><ul>
                        
                <li>
                    <a href="#%e5%bf%ab%e9%80%92%e5%91%98%e9%97%ae%e9%a2%98" aria-label="å¿«é€’å‘˜é—®é¢˜">å¿«é€’å‘˜é—®é¢˜</a></li>
                <li>
                    <a href="#%e6%8e%88%e6%9d%83%e6%9c%ba%e5%88%b6%e7%9a%84%e8%ae%be%e8%ae%a1" aria-label="æˆæƒæœºåˆ¶çš„è®¾è®¡">æˆæƒæœºåˆ¶çš„è®¾è®¡</a></li>
                <li>
                    <a href="#%e4%ba%92%e8%81%94%e7%bd%91%e5%9c%ba%e6%99%af" aria-label="äº’è”ç½‘åœºæ™¯">äº’è”ç½‘åœºæ™¯</a></li>
                <li>
                    <a href="#%e4%bb%a4%e7%89%8c%e4%b8%8e%e5%af%86%e7%a0%81" aria-label="ä»¤ç‰Œä¸å¯†ç ">ä»¤ç‰Œä¸å¯†ç </a></li>
                <li>
                    <a href="#rfc-6749" aria-label="RFC 6749">RFC 6749</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%b8%80%e7%a7%8d%e6%8e%88%e6%9d%83%e6%96%b9%e5%bc%8f%e6%8e%88%e6%9d%83%e7%a0%81" aria-label="ç¬¬ä¸€ç§æˆæƒæ–¹å¼ï¼šæˆæƒç ">ç¬¬ä¸€ç§æˆæƒæ–¹å¼ï¼šæˆæƒç </a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%ba%8c%e7%a7%8d%e6%96%b9%e5%bc%8f%e9%9a%90%e8%97%8f%e5%bc%8f%e7%ae%80%e5%8c%96%e6%a8%a1%e5%bc%8f" aria-label="ç¬¬äºŒç§æ–¹å¼ï¼šéšè—å¼(ç®€åŒ–æ¨¡å¼)">ç¬¬äºŒç§æ–¹å¼ï¼šéšè—å¼(ç®€åŒ–æ¨¡å¼)</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%b8%89%e7%a7%8d%e6%96%b9%e5%bc%8f%e5%af%86%e7%a0%81%e5%bc%8f" aria-label="ç¬¬ä¸‰ç§æ–¹å¼ï¼šå¯†ç å¼">ç¬¬ä¸‰ç§æ–¹å¼ï¼šå¯†ç å¼</a></li>
                <li>
                    <a href="#%e7%ac%ac%e5%9b%9b%e7%a7%8d%e6%96%b9%e5%bc%8f%e5%87%ad%e8%af%81%e5%bc%8f" aria-label="ç¬¬å››ç§æ–¹å¼ï¼šå‡­è¯å¼">ç¬¬å››ç§æ–¹å¼ï¼šå‡­è¯å¼</a></li>
                <li>
                    <a href="#%e4%bb%a4%e7%89%8c%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="ä»¤ç‰Œçš„ä½¿ç”¨">ä»¤ç‰Œçš„ä½¿ç”¨</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0%e4%bb%a4%e7%89%8c" aria-label="æ›´æ–°ä»¤ç‰Œ">æ›´æ–°ä»¤ç‰Œ</a></li></ul>
                </li>
                <li>
                    <a href="#jwtjson-web-tokens" aria-label="JWT(JSON WEB TOKENS)">JWT(JSON WEB TOKENS)</a><ul>
                        
                <li>
                    <a href="#%e8%b7%a8%e5%9f%9f%e8%ae%a4%e8%af%81%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="è·¨åŸŸè®¤è¯çš„é—®é¢˜">è·¨åŸŸè®¤è¯çš„é—®é¢˜</a></li>
                <li>
                    <a href="#jwt-%e7%9a%84%e5%8e%9f%e7%90%86" aria-label="JWT çš„åŸç†">JWT çš„åŸç†</a></li>
                <li>
                    <a href="#jwt-%e7%9a%84%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="JWT çš„æ•°æ®ç»“æ„">JWT çš„æ•°æ®ç»“æ„</a><ul>
                        
                <li>
                    <a href="#header" aria-label="Header">Header</a></li>
                <li>
                    <a href="#payload" aria-label="Payload">Payload</a></li>
                <li>
                    <a href="#signature" aria-label="Signature">Signature</a></li>
                <li>
                    <a href="#base64url" aria-label="Base64URL">Base64URL</a></li></ul>
                </li>
                <li>
                    <a href="#jwt-%e7%9a%84%e4%bd%bf%e7%94%a8%e6%96%b9%e5%bc%8f" aria-label="JWT çš„ä½¿ç”¨æ–¹å¼">JWT çš„ä½¿ç”¨æ–¹å¼</a></li>
                <li>
                    <a href="#jwt-%e7%9a%84%e5%87%a0%e4%b8%aa%e7%89%b9%e7%82%b9" aria-label="JWT çš„å‡ ä¸ªç‰¹ç‚¹">JWT çš„å‡ ä¸ªç‰¹ç‚¹</a></li></ul>
                </li>
                <li>
                    <a href="#spring-security-oauth2" aria-label="Spring Security OAuth2">Spring Security OAuth2</a><ul>
                        
                <li>
                    <a href="#%e6%9e%84%e5%bb%ba%e9%a1%b9%e7%9b%ae" aria-label="æ„å»ºé¡¹ç›®">æ„å»ºé¡¹ç›®</a></li>
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="é¡¹ç›®é…ç½®æ–‡ä»¶">é¡¹ç›®é…ç½®æ–‡ä»¶</a></li>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e5%ba%93" aria-label="æ•°æ®åº“">æ•°æ®åº“</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%ae%9e%e4%bd%93%e7%b1%bb" aria-label="åˆ›å»ºå®ä½“ç±»">åˆ›å»ºå®ä½“ç±»</a></li>
                <li>
                    <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89userdetailsservice" aria-label="è‡ªå®šä¹‰UserDetailsService">è‡ªå®šä¹‰UserDetailsService</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aespringsecurity" aria-label="é…ç½®SpringSecurity">é…ç½®SpringSecurity</a></li>
                <li>
                    <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89401%e9%94%99%e8%af%af%e7%a0%81%e5%86%85%e5%ae%b9" aria-label="è‡ªå®šä¹‰401é”™è¯¯ç å†…å®¹">è‡ªå®šä¹‰401é”™è¯¯ç å†…å®¹</a></li>
                <li>
                    <a href="#%e5%ae%9a%e4%b9%89%e7%99%bb%e5%87%ba%e6%8e%a7%e5%88%b6" aria-label="å®šä¹‰ç™»å‡ºæ§åˆ¶">å®šä¹‰ç™»å‡ºæ§åˆ¶</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e8%b5%84%e6%ba%90%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="é…ç½®èµ„æºæœåŠ¡å™¨">é…ç½®èµ„æºæœåŠ¡å™¨</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e6%8e%a7%e5%88%b6%e5%99%a8controller" aria-label="é…ç½®æ§åˆ¶å™¨ï¼ˆControllerï¼‰">é…ç½®æ§åˆ¶å™¨ï¼ˆControllerï¼‰</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95" aria-label="æµ‹è¯•">æµ‹è¯•</a><ul>
                        
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96accesstoken" aria-label="è·å–AccessToken">è·å–AccessToken</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8access_token%e8%ae%bf%e9%97%ae%e6%95%b0%e6%8d%ae" aria-label="ä½¿ç”¨access_tokenè®¿é—®æ•°æ®">ä½¿ç”¨access_tokenè®¿é—®æ•°æ®</a></li>
                <li>
                    <a href="#%e5%88%b7%e6%96%b0accesstoken" aria-label="åˆ·æ–°AccessToken">åˆ·æ–°AccessToken</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="oauth">OAuth<a hidden class="anchor" aria-hidden="true" href="#oauth">#</a></h1>
<p>OAuth 2.0 æ˜¯ç›®å‰æœ€æµè¡Œçš„æˆæƒæœºåˆ¶ï¼Œç”¨æ¥æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œè·å–ç”¨æˆ·æ•°æ®ã€‚è¿™ä¸ªæ ‡å‡†æ¯”è¾ƒæŠ½è±¡ï¼Œä½¿ç”¨äº†å¾ˆå¤šæœ¯è¯­ï¼Œåˆå­¦è€…ä¸å®¹æ˜“ç†è§£ã€‚å…¶å®è¯´èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œä¸‹é¢æˆ‘å°±é€šè¿‡ä¸€ä¸ªç®€å•çš„ç±»æ¯”ï¼Œå¸®åŠ©å¤§å®¶è½»æ¾ç†è§£ï¼ŒOAuth 2.0 åˆ°åº•æ˜¯ä»€ä¹ˆã€‚</p>
<h2 id="å¿«é€’å‘˜é—®é¢˜">å¿«é€’å‘˜é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#å¿«é€’å‘˜é—®é¢˜">#</a></h2>
<p>æˆ‘ä½åœ¨ä¸€ä¸ªå¤§å‹çš„å±…æ°‘å°åŒºï¼Œå°åŒºæœ‰é—¨ç¦ç³»ç»Ÿï¼Œè¿›å…¥çš„æ—¶å€™éœ€è¦è¾“å…¥å¯†ç ï¼Œæˆ‘ç»å¸¸ç½‘è´­å’Œç‚¹å¤–å–ï¼Œæ¯å¤©éƒ½æœ‰å¿«é€’å‘˜æ¥é€è´§ã€‚æˆ‘å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªåŠæ³•ï¼Œè®©å¿«é€’å‘˜é€šè¿‡é—¨ç¦ç³»ç»Ÿï¼Œè¿›å…¥å°åŒºã€‚å¦‚æœæˆ‘æŠŠè‡ªå·±çš„å¯†ç ï¼Œå‘Šè¯‰å¿«é€’å‘˜ï¼Œä»–å°±æ‹¥æœ‰äº†ä¸æˆ‘åŒæ ·çš„æƒé™ï¼Œè¿™æ ·å¥½åƒä¸å¤ªåˆé€‚ã€‚ä¸‡ä¸€æˆ‘æƒ³å–æ¶ˆä»–è¿›å…¥å°åŒºçš„æƒåŠ›ï¼Œä¹Ÿå¾ˆéº»çƒ¦ï¼Œæˆ‘è‡ªå·±çš„å¯†ç ä¹Ÿå¾—è·Ÿç€æ”¹äº†ï¼Œè¿˜å¾—é€šçŸ¥å…¶ä»–çš„å¿«é€’å‘˜ã€‚æœ‰æ²¡æœ‰ä¸€ç§åŠæ³•ï¼Œè®©å¿«é€’å‘˜èƒ½å¤Ÿè‡ªç”±è¿›å…¥å°åŒºï¼Œåˆä¸å¿…çŸ¥é“å°åŒºå±…æ°‘çš„å¯†ç ï¼Œè€Œä¸”ä»–çš„å”¯ä¸€æƒé™å°±æ˜¯é€è´§ï¼Œå…¶ä»–éœ€è¦å¯†ç çš„åœºåˆï¼Œä»–éƒ½æ²¡æœ‰æƒé™ï¼Ÿ</p>
<h2 id="æˆæƒæœºåˆ¶çš„è®¾è®¡">æˆæƒæœºåˆ¶çš„è®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#æˆæƒæœºåˆ¶çš„è®¾è®¡">#</a></h2>
<p>ç¬¬ä¸€æ­¥ï¼Œé—¨ç¦ç³»ç»Ÿçš„å¯†ç è¾“å…¥å™¨ä¸‹é¢ï¼Œå¢åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œå«åš&quot;è·å–æˆæƒ&quot;ã€‚å¿«é€’å‘˜éœ€è¦é¦–å…ˆæŒ‰è¿™ä¸ªæŒ‰é’®ï¼Œå»ç”³è¯·æˆæƒã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼Œä»–æŒ‰ä¸‹æŒ‰é’®ä»¥åï¼Œå±‹ä¸»ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ï¼‰çš„æ‰‹æœºå°±ä¼šè·³å‡ºå¯¹è¯æ¡†ï¼šæœ‰äººæ­£åœ¨è¦æ±‚æˆæƒã€‚ç³»ç»Ÿè¿˜ä¼šæ˜¾ç¤ºè¯¥å¿«é€’å‘˜çš„å§“åã€å·¥å·å’Œæ‰€å±çš„å¿«é€’å…¬å¸ã€‚æˆ‘ç¡®è®¤è¯·æ±‚å±å®ï¼Œå°±ç‚¹å‡»æŒ‰é’®ï¼Œå‘Šè¯‰é—¨ç¦ç³»ç»Ÿï¼Œæˆ‘åŒæ„ç»™äºˆä»–è¿›å…¥å°åŒºçš„æˆæƒã€‚</p>
<p>ç¬¬ä¸‰æ­¥ï¼Œé—¨ç¦ç³»ç»Ÿå¾—åˆ°æˆ‘çš„ç¡®è®¤ä»¥åï¼Œå‘å¿«é€’å‘˜æ˜¾ç¤ºä¸€ä¸ªè¿›å…¥å°åŒºçš„ä»¤ç‰Œï¼ˆaccess tokenï¼‰ã€‚ä»¤ç‰Œå°±æ˜¯ç±»ä¼¼å¯†ç çš„ä¸€ä¸²æ•°å­—ï¼Œåªåœ¨çŸ­æœŸå†…ï¼ˆæ¯”å¦‚ä¸ƒå¤©ï¼‰æœ‰æ•ˆã€‚</p>
<p>ç¬¬å››æ­¥ï¼Œå¿«é€’å‘˜å‘é—¨ç¦ç³»ç»Ÿè¾“å…¥ä»¤ç‰Œï¼Œè¿›å…¥å°åŒºã€‚</p>
<p>æœ‰äººå¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯è¿œç¨‹ä¸ºå¿«é€’å‘˜å¼€é—¨ï¼Œè€Œè¦ä¸ºä»–å•ç‹¬ç”Ÿæˆä¸€ä¸ªä»¤ç‰Œï¼Ÿè¿™æ˜¯å› ä¸ºå¿«é€’å‘˜å¯èƒ½æ¯å¤©éƒ½ä¼šæ¥é€è´§ï¼Œç¬¬äºŒå¤©ä»–è¿˜å¯ä»¥å¤ç”¨è¿™ä¸ªä»¤ç‰Œã€‚å¦å¤–ï¼Œæœ‰çš„å°åŒºæœ‰å¤šé‡é—¨ç¦ï¼Œå¿«é€’å‘˜å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªä»¤ç‰Œé€šè¿‡å®ƒä»¬ã€‚</p>
<h2 id="äº’è”ç½‘åœºæ™¯">äº’è”ç½‘åœºæ™¯<a hidden class="anchor" aria-hidden="true" href="#äº’è”ç½‘åœºæ™¯">#</a></h2>
<p>æˆ‘ä»¬æŠŠä¸Šé¢çš„ä¾‹å­æ¬åˆ°äº’è”ç½‘ï¼Œå°±æ˜¯ OAuth çš„è®¾è®¡äº†ã€‚
é¦–å…ˆï¼Œå±…æ°‘å°åŒºå°±æ˜¯å‚¨å­˜ç”¨æˆ·æ•°æ®çš„ç½‘ç»œæœåŠ¡ã€‚æ¯”å¦‚ï¼Œå¾®ä¿¡å‚¨å­˜äº†æˆ‘çš„å¥½å‹ä¿¡æ¯ï¼Œè·å–è¿™äº›ä¿¡æ¯ï¼Œå°±å¿…é¡»ç»è¿‡å¾®ä¿¡çš„&quot;é—¨ç¦ç³»ç»Ÿ&quot;ã€‚å…¶æ¬¡ï¼Œå¿«é€’å‘˜ï¼ˆæˆ–è€…è¯´å¿«é€’å…¬å¸ï¼‰å°±æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œæƒ³è¦ç©¿è¿‡é—¨ç¦ç³»ç»Ÿï¼Œè¿›å…¥å°åŒºã€‚æœ€åï¼Œæˆ‘å°±æ˜¯ç”¨æˆ·æœ¬äººï¼ŒåŒæ„æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è¿›å…¥å°åŒºï¼Œè·å–æˆ‘çš„æ•°æ®ã€‚</p>
<p>ç®€å•è¯´ï¼ŒOAuth å°±æ˜¯ä¸€ç§æˆæƒæœºåˆ¶ã€‚æ•°æ®çš„æ‰€æœ‰è€…å‘Šè¯‰ç³»ç»Ÿï¼ŒåŒæ„æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è¿›å…¥ç³»ç»Ÿï¼Œè·å–è¿™äº›æ•°æ®ã€‚ç³»ç»Ÿä»è€Œäº§ç”Ÿä¸€ä¸ªçŸ­æœŸçš„è¿›å…¥ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œç”¨æ¥ä»£æ›¿å¯†ç ï¼Œä¾›ç¬¬ä¸‰æ–¹åº”ç”¨ä½¿ç”¨ã€‚</p>
<h2 id="ä»¤ç‰Œä¸å¯†ç ">ä»¤ç‰Œä¸å¯†ç <a hidden class="anchor" aria-hidden="true" href="#ä»¤ç‰Œä¸å¯†ç ">#</a></h2>
<p>ä»¤ç‰Œï¼ˆtokenï¼‰ä¸å¯†ç ï¼ˆpasswordï¼‰çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œéƒ½å¯ä»¥è¿›å…¥ç³»ç»Ÿï¼Œä½†æ˜¯æœ‰ä¸‰ç‚¹å·®å¼‚ã€‚</p>
<ul>
<li>ä»¤ç‰Œæ˜¯çŸ­æœŸçš„ï¼Œåˆ°æœŸä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œç”¨æˆ·è‡ªå·±æ— æ³•ä¿®æ”¹ã€‚å¯†ç ä¸€èˆ¬é•¿æœŸæœ‰æ•ˆï¼Œç”¨æˆ·ä¸ä¿®æ”¹ï¼Œå°±ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚</li>
<li>ä»¤ç‰Œå¯ä»¥è¢«æ•°æ®æ‰€æœ‰è€…æ’¤é”€ï¼Œä¼šç«‹å³å¤±æ•ˆã€‚ä»¥ä¸Šä¾‹è€Œè¨€ï¼Œå±‹ä¸»å¯ä»¥éšæ—¶å–æ¶ˆå¿«é€’å‘˜çš„ä»¤ç‰Œã€‚å¯†ç ä¸€èˆ¬ä¸å…è®¸è¢«ä»–äººæ’¤é”€ã€‚</li>
<li>ä»¤ç‰Œæœ‰æƒé™èŒƒå›´ï¼ˆscopeï¼‰ï¼Œæ¯”å¦‚åªèƒ½è¿›å°åŒºçš„äºŒå·é—¨ã€‚å¯¹äºç½‘ç»œæœåŠ¡æ¥è¯´ï¼Œåªè¯»ä»¤ç‰Œå°±æ¯”è¯»å†™ä»¤ç‰Œæ›´å®‰å…¨ã€‚å¯†ç ä¸€èˆ¬æ˜¯å®Œæ•´æƒé™ã€‚</li>
</ul>
<p>ä¸Šé¢è¿™äº›è®¾è®¡ï¼Œä¿è¯äº†ä»¤ç‰Œæ—¢å¯ä»¥è®©ç¬¬ä¸‰æ–¹åº”ç”¨è·å¾—æƒé™ï¼ŒåŒæ—¶åˆéšæ—¶å¯æ§ï¼Œä¸ä¼šå±åŠç³»ç»Ÿå®‰å…¨ã€‚è¿™å°±æ˜¯OAuth 2.0 çš„ä¼˜ç‚¹ã€‚</p>
<p>æ³¨æ„ï¼Œåªè¦çŸ¥é“äº†ä»¤ç‰Œï¼Œå°±èƒ½è¿›å…¥ç³»ç»Ÿã€‚ç³»ç»Ÿä¸€èˆ¬ä¸ä¼šå†æ¬¡ç¡®è®¤èº«ä»½ï¼Œæ‰€ä»¥ä»¤ç‰Œå¿…é¡»ä¿å¯†ï¼Œæ³„æ¼ä»¤ç‰Œä¸æ³„æ¼å¯†ç çš„åæœæ˜¯ä¸€æ ·çš„ã€‚ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä»¤ç‰Œçš„æœ‰æ•ˆæœŸï¼Œä¸€èˆ¬éƒ½è®¾ç½®å¾—å¾ˆçŸ­çš„åŸå› ã€‚</p>
<p>OAuth 2.0 å¯¹äºå¦‚ä½•é¢å‘ä»¤ç‰Œçš„ç»†èŠ‚ï¼Œè§„å®šå¾—éå¸¸è¯¦ç»†ã€‚å…·ä½“æ¥è¯´ï¼Œä¸€å…±åˆ†æˆå››ç§æˆæƒç±»å‹ï¼ˆauthorizationgrantï¼‰ï¼Œå³å››ç§é¢å‘ä»¤ç‰Œçš„æ–¹å¼ï¼Œé€‚ç”¨äºä¸åŒçš„äº’è”ç½‘åœºæ™¯ã€‚</p>
<h2 id="rfc-6749">RFC 6749<a hidden class="anchor" aria-hidden="true" href="#rfc-6749">#</a></h2>
<p>OAuth 2.0 çš„æ ‡å‡†æ˜¯ <a href="https://tools.ietf.org/html/rfc6749">RFC 6749</a> æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å…ˆè§£é‡Šäº† OAuth æ˜¯ä»€ä¹ˆã€‚
OAuth å¼•å…¥äº†ä¸€ä¸ªæˆæƒå±‚ï¼Œç”¨æ¥åˆ†ç¦»ä¸¤ç§ä¸åŒçš„è§’è‰²ï¼šå®¢æˆ·ç«¯å’Œèµ„æºæ‰€æœ‰è€…ã€‚&hellip;&hellip;èµ„æºæ‰€æœ‰è€…åŒæ„ä»¥åï¼Œèµ„æºæœåŠ¡å™¨å¯ä»¥å‘å®¢æˆ·ç«¯é¢å‘ä»¤ç‰Œã€‚å®¢æˆ·ç«¯é€šè¿‡ä»¤ç‰Œï¼Œå»è¯·æ±‚æ•°æ®ã€‚</p>
<p>è¿™æ®µè¯çš„æ„æ€å°±æ˜¯ï¼ŒOAuth çš„æ ¸å¿ƒå°±æ˜¯å‘ç¬¬ä¸‰æ–¹åº”ç”¨é¢å‘ä»¤ç‰Œã€‚ç„¶åï¼ŒRFC 6749 æ¥ç€å†™é“ï¼š
ï¼ˆç”±äºäº’è”ç½‘æœ‰å¤šç§åœºæ™¯ï¼Œï¼‰æœ¬æ ‡å‡†å®šä¹‰äº†è·å¾—ä»¤ç‰Œçš„å››ç§æˆæƒæ–¹å¼ï¼ˆauthorization grant ï¼‰ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼ŒOAuth 2.0 è§„å®šäº†å››ç§è·å¾—ä»¤ç‰Œçš„æµç¨‹ã€‚ä½ å¯ä»¥é€‰æ‹©æœ€é€‚åˆè‡ªå·±çš„é‚£ä¸€ç§ï¼Œå‘ç¬¬ä¸‰æ–¹åº”ç”¨é¢å‘ä»¤ç‰Œã€‚
ä¸‹é¢å°±æ˜¯è¿™å››ç§æˆæƒæ–¹å¼ã€‚
æˆæƒç ï¼ˆauthorization-codeï¼‰
éšè—å¼ï¼ˆimplicitï¼‰
å¯†ç å¼ï¼ˆpasswordï¼‰
å®¢æˆ·ç«¯å‡­è¯ï¼ˆclient credentialsï¼‰</p>
<p>æ³¨æ„ï¼Œä¸ç®¡å“ªä¸€ç§æˆæƒæ–¹å¼ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨ç”³è¯·ä»¤ç‰Œä¹‹å‰ï¼Œéƒ½å¿…é¡»å…ˆåˆ°ç³»ç»Ÿå¤‡æ¡ˆï¼Œè¯´æ˜è‡ªå·±çš„èº«ä»½ï¼Œç„¶åä¼šæ‹¿åˆ°ä¸¤ä¸ªèº«ä»½è¯†åˆ«ç ï¼šå®¢æˆ·ç«¯ IDï¼ˆclient IDï¼‰å’Œå®¢æˆ·ç«¯å¯†é’¥ï¼ˆclient secretï¼‰ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢ä»¤ç‰Œè¢«æ»¥ç”¨ï¼Œæ²¡æœ‰å¤‡æ¡ˆè¿‡çš„ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œæ˜¯ä¸ä¼šæ‹¿åˆ°ä»¤ç‰Œçš„ã€‚</p>
<h2 id="ç¬¬ä¸€ç§æˆæƒæ–¹å¼æˆæƒç ">ç¬¬ä¸€ç§æˆæƒæ–¹å¼ï¼šæˆæƒç <a hidden class="anchor" aria-hidden="true" href="#ç¬¬ä¸€ç§æˆæƒæ–¹å¼æˆæƒç ">#</a></h2>
<p>æˆæƒç ï¼ˆauthorization codeï¼‰æ–¹å¼ï¼ŒæŒ‡çš„æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨å…ˆç”³è¯·ä¸€ä¸ªæˆæƒç ï¼Œç„¶åå†ç”¨è¯¥ç è·å–ä»¤ç‰Œã€‚è¿™ç§æ–¹å¼æ˜¯æœ€å¸¸ç”¨çš„æµç¨‹ï¼Œå®‰å…¨æ€§ä¹Ÿæœ€é«˜ï¼Œå®ƒé€‚ç”¨äºé‚£äº›æœ‰åç«¯çš„ Web åº”ç”¨ã€‚æˆæƒç é€šè¿‡å‰ç«¯ä¼ é€ï¼Œä»¤ç‰Œåˆ™æ˜¯å‚¨å­˜åœ¨åç«¯ï¼Œè€Œä¸”æ‰€æœ‰ä¸èµ„æºæœåŠ¡å™¨çš„é€šä¿¡éƒ½åœ¨åç«¯å®Œæˆã€‚è¿™æ ·çš„å‰åç«¯åˆ†ç¦»ï¼Œå¯ä»¥é¿å…ä»¤ç‰Œæ³„æ¼ã€‚å¾®ä¿¡å…¬ä¼—å·è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå°±æ˜¯å®Œå…¨æŒ‰ç…§æˆæƒç æ¨¡å¼æ¥çš„ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼ŒA ç½‘ç«™æä¾›ä¸€ä¸ªé“¾æ¥ï¼Œç”¨æˆ·ç‚¹å‡»åå°±ä¼šè·³è½¬åˆ° B ç½‘ç«™ï¼Œæˆæƒç”¨æˆ·æ•°æ®ç»™ A ç½‘ç«™ä½¿ç”¨ã€‚ä¸‹é¢å°±æ˜¯ A ç½‘ç«™è·³è½¬ B ç½‘ç«™çš„ä¸€ä¸ªç¤ºæ„é“¾æ¥ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://b.com/oauth/authorize?
</span></span><span style="display:flex;"><span>  response_type=code&amp;
</span></span><span style="display:flex;"><span>  client_id=CLIENT_ID&amp;
</span></span><span style="display:flex;"><span>  redirect_uri=CALLBACK_URL&amp;
</span></span><span style="display:flex;"><span>  scope=read
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ URL ä¸­ï¼Œresponse_typeå‚æ•°è¡¨ç¤ºè¦æ±‚è¿”å›æˆæƒç ï¼ˆcodeï¼‰ï¼Œclient_idå‚æ•°è®© B çŸ¥é“æ˜¯è°åœ¨è¯·æ±‚ï¼Œredirect_uriå‚æ•°æ˜¯ B æ¥å—æˆ–æ‹’ç»è¯·æ±‚åçš„è·³è½¬ç½‘å€ï¼Œscopeå‚æ•°è¡¨ç¤ºè¦æ±‚çš„æˆæƒèŒƒå›´ï¼ˆè¿™é‡Œæ˜¯åªè¯»ï¼‰ã€‚è¿™ä¸€æ­¥å‰ç«¯è‡ªå·±å°±å¯ä»¥å®ç°ï¼Œä¸éœ€è¦åç«¯ã€‚client_idï¼Œå³appIdå¯ä»¥å­˜åœ¨å‰ç«¯ï¼Œæ²¡æœ‰å±é™©ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼Œç”¨æˆ·è·³è½¬åï¼ŒB ç½‘ç«™ä¼šè¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œç„¶åè¯¢é—®æ˜¯å¦åŒæ„ç»™äºˆ A ç½‘ç«™æˆæƒã€‚ç”¨æˆ·è¡¨ç¤ºåŒæ„ï¼Œè¿™æ—¶ B ç½‘ç«™å°±ä¼šè·³å›redirect_uriå‚æ•°æŒ‡å®šçš„ç½‘å€ã€‚è·³è½¬æ—¶ï¼Œä¼šä¼ å›ä¸€ä¸ªæˆæƒç ï¼Œå°±åƒä¸‹é¢è¿™æ ·ã€‚<code>https://a.com/callback?code=AUTHORIZATION_CODE</code>
ä¸Šé¢ URL ä¸­ï¼Œcodeå‚æ•°å°±æ˜¯æˆæƒç ã€‚å‰ç«¯åœ¨urlä¸Šæ‹¿åˆ°codeäº†ã€‚</p>
<p>ç¬¬ä¸‰æ­¥ï¼ŒA ç½‘ç«™ï¼ˆå³å‰ç«¯ï¼‰æ‹¿åˆ°æˆæƒç codeä»¥åï¼Œå°†codeé€šè¿‡æ¥å£ä¼ ç»™åç«¯ï¼Œåç«¯é€šè¿‡æ‹¿åˆ°çš„codeï¼Œè¯·æ±‚Bç½‘ç«™ï¼Œè·å–ä»¤ç‰Œã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://b.com/oauth/token?
</span></span><span style="display:flex;"><span> client_id=CLIENT_ID&amp;
</span></span><span style="display:flex;"><span> client_secret=CLIENT_SECRET&amp;
</span></span><span style="display:flex;"><span> grant_type=authorization_code&amp;
</span></span><span style="display:flex;"><span> code=AUTHORIZATION_CODE
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬å››æ­¥ï¼ŒB ç½‘ç«™æ”¶åˆ°è¯·æ±‚ä»¥åï¼Œå°±ä¼šé€šè¿‡ä¸Šé¢çš„httpè¯·æ±‚è¿”å›jsonæ•°æ®ï¼Œå…¶ä¸­åŒ…å«äº†ä»¤ç‰Œï¼Œæ ¼å¼å¦‚ä¸‹</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;access_token&#34;:&#34;ACCESS_TOKEN&#34;,
</span></span><span style="display:flex;"><span>  &#34;token_type&#34;:&#34;bearer&#34;,
</span></span><span style="display:flex;"><span>  &#34;expires_in&#34;:2592000,
</span></span><span style="display:flex;"><span>  &#34;refresh_token&#34;:&#34;REFRESH_TOKEN&#34;,
</span></span><span style="display:flex;"><span>  &#34;scope&#34;:&#34;read&#34;,
</span></span><span style="display:flex;"><span>  &#34;uid&#34;:100101,
</span></span><span style="display:flex;"><span>  &#34;info&#34;:{...}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ JSON æ•°æ®ä¸­ï¼Œaccess_tokenå­—æ®µå°±æ˜¯ä»¤ç‰Œï¼ŒA ç½‘ç«™åœ¨åç«¯æ‹¿åˆ°äº†ã€‚ä¹‹åå°±å¯ä»¥é€šè¿‡access_tokenæ¥è·å–èµ„æºæœåŠ¡å™¨çš„æ•°æ®äº†ã€‚</p>
<p>æŒ‰ç…§å¾®ä¿¡è·å–ç”¨æˆ·ä¿¡æ¯çš„æ­¥éª¤æ¥è¯´ï¼š
ç¬¬ä¸€æ­¥ï¼šå‰ç«¯è¯·æ±‚å¾®ä¿¡çš„æ¥å£</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>String url = &#34;https://open.weixin.qq.com/connect/oauth2/authorize?&#34;
</span></span><span style="display:flex;"><span>                    + &#34;appid=&#34; + APPID
</span></span><span style="display:flex;"><span>                    + &#34;&amp;redirect_uri=&#34; + URLEncoder.encode(rediretUrl, PayConstant.DEFAULT_CHARSET)
</span></span><span style="display:flex;"><span>                    + &#34;&amp;response_type=code&amp;scope=snsapi_base&amp;state=123#wechat_redirect&#34;;
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¾®ä¿¡ä¼šå°†codeæ‹¼åˆ°å‰ç«¯æŒ‡å®šçš„redirect_uriçš„åé¢ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼šå‰ç«¯æ‹¿åˆ°codeåï¼Œå°†codeä¼ ç»™åç«¯ï¼Œåç«¯å…ˆé€šè¿‡codeå‘å¾®ä¿¡æœåŠ¡å™¨å‘é€getè¯·æ±‚,è·å–access_tokenå’Œopenidï¼Œç„¶åå†æ¬¡å‘å¾®ä¿¡å‘é€è¯·æ±‚,é€šè¿‡access_tokenå’Œopenid,è·å–userinfoï¼Œç„¶åè¿”å›ç»™å‰ç«¯å±•ç¤ºã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @author: wjy
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @description: h5éé™é»˜æˆæƒ, é€šè¿‡codeè·å–ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * æ³¨æ„ï¼šcodeä½¿ç”¨ä¸€æ¬¡å°±ä¼šå¤±æ•ˆï¼Œæ‰€æœ‰æ¯æ¬¡è¯·æ±‚æ¥å£ï¼Œå‰ç«¯éƒ½è¦é‡æ–°è·å–code
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@GetMapping(<span style="color:#0ff;font-weight:bold">&#34;getWxUserinfoByCode&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> JSONObject getWxUserinfoByCode(@RequestParam(<span style="color:#0ff;font-weight:bold">&#34;code&#34;</span>) String code) {
</span></span><span style="display:flex;"><span>    LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;*************è·å–access_tokenå’Œopenid,ç„¶åè·å–å¾®ä¿¡userinfo***********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>    JSONObject userInfoJson = <span style="color:#fff;font-weight:bold">new</span> JSONObject();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è·å–openIdåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String getOpenidUrl = <span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/sns/oauth2/access_token&#34;</span>;
</span></span><span style="display:flex;"><span>        String param = <span style="color:#0ff;font-weight:bold">&#34;appid=&#34;</span> + WxUtil.<span style="color:#007f7f">getAppid</span>(environment, WxPlatformConstant.<span style="color:#007f7f">PARENT_GZH</span>)+
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;secret=&#34;</span> + WxUtil.<span style="color:#007f7f">getAppSecret</span>(environment, WxPlatformConstant.<span style="color:#007f7f">PARENT_GZH</span>) +
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;code=&#34;</span> + code +
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;grant_type=authorization_code&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å‘å¾®ä¿¡æœåŠ¡å™¨å‘é€getè¯·æ±‚,è·å–access_tokenå’Œopenid
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String accessTokenAndOpenid = HttpUtil.<span style="color:#007f7f">sendGet</span>(getOpenidUrl, param);
</span></span><span style="display:flex;"><span>        JSONObject jsonObject = JSONObject.<span style="color:#007f7f">parseObject</span>(accessTokenAndOpenid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å†æ¬¡å‘å¾®ä¿¡å‘é€è¯·æ±‚,é€šè¿‡access_tokenå’Œopenid,è·å–userinfo
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String userInfo = HttpUtil.<span style="color:#007f7f">sendGet</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/sns/userinfo&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;access_token=&#34;</span> + jsonObject.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;access_token&#34;</span>)
</span></span><span style="display:flex;"><span>            + <span style="color:#0ff;font-weight:bold">&#34;&amp;openid=&#34;</span> + jsonObject.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;openid&#34;</span>)
</span></span><span style="display:flex;"><span>            + <span style="color:#0ff;font-weight:bold">&#34;&amp;lang=zh_CN&#34;</span>);
</span></span><span style="display:flex;"><span>        userInfoJson = JSON.<span style="color:#007f7f">parseObject</span>(userInfo);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> userInfoJson;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸¤æ­¥å°±å®Œäº‹äº†ã€‚</p>
<h2 id="ç¬¬äºŒç§æ–¹å¼éšè—å¼ç®€åŒ–æ¨¡å¼">ç¬¬äºŒç§æ–¹å¼ï¼šéšè—å¼(ç®€åŒ–æ¨¡å¼)<a hidden class="anchor" aria-hidden="true" href="#ç¬¬äºŒç§æ–¹å¼éšè—å¼ç®€åŒ–æ¨¡å¼">#</a></h2>
<p>æœ‰äº› Web åº”ç”¨æ˜¯çº¯å‰ç«¯åº”ç”¨ï¼Œæ²¡æœ‰åç«¯ã€‚è¿™æ—¶å°±ä¸èƒ½ç”¨ä¸Šé¢çš„æ–¹å¼äº†ï¼Œå¿…é¡»å°†ä»¤ç‰Œå‚¨å­˜åœ¨å‰ç«¯ã€‚RFC 6749 å°±è§„å®šäº†ç¬¬äºŒç§æ–¹å¼ï¼Œå…è®¸ç›´æ¥å‘å‰ç«¯é¢å‘ä»¤ç‰Œã€‚è¿™ç§æ–¹å¼æ²¡æœ‰æˆæƒç è¿™ä¸ªä¸­é—´æ­¥éª¤ï¼Œæ‰€ä»¥ç§°ä¸ºï¼ˆæˆæƒç ï¼‰&ldquo;éšè—å¼&rdquo;ï¼ˆimplicitï¼‰ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼ŒA ç½‘ç«™æä¾›ä¸€ä¸ªé“¾æ¥ï¼Œè¦æ±‚ç”¨æˆ·è·³è½¬åˆ° B ç½‘ç«™ï¼Œæˆæƒç”¨æˆ·æ•°æ®ç»™ A ç½‘ç«™ä½¿ç”¨ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://b.com/oauth/authorize?
</span></span><span style="display:flex;"><span>  response_type=token&amp;
</span></span><span style="display:flex;"><span>  client_id=CLIENT_ID&amp;
</span></span><span style="display:flex;"><span>  redirect_uri=CALLBACK_URL&amp;
</span></span><span style="display:flex;"><span>  scope=read
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ URL ä¸­ï¼Œresponse_typeå‚æ•°ä¸ºtokenï¼Œè¡¨ç¤ºè¦æ±‚ç›´æ¥è¿”å›ä»¤ç‰Œã€‚
ç¬¬äºŒæ­¥ï¼Œç”¨æˆ·è·³è½¬åˆ° B ç½‘ç«™ï¼Œç™»å½•ååŒæ„ç»™äºˆ A ç½‘ç«™æˆæƒã€‚è¿™æ—¶ï¼ŒB ç½‘ç«™å°±ä¼šè·³å›redirect_uriå‚æ•°æŒ‡å®šçš„è·³è½¬ç½‘å€ï¼Œå¹¶ä¸”æŠŠä»¤ç‰Œä½œä¸º URL å‚æ•°ï¼Œä¼ ç»™ A ç½‘ç«™ã€‚
<code>https://a.com/callback#token=ACCESS_TOKEN</code>
ä¸Šé¢ URL ä¸­ï¼Œtokenå‚æ•°å°±æ˜¯ä»¤ç‰Œï¼ŒA ç½‘ç«™å› æ­¤ç›´æ¥åœ¨å‰ç«¯æ‹¿åˆ°ä»¤ç‰Œã€‚</p>
<p>æ³¨æ„ï¼Œä»¤ç‰Œçš„ä½ç½®æ˜¯ URL é”šç‚¹ï¼ˆfragmentï¼‰ï¼Œè€Œä¸æ˜¯æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆquerystringï¼‰ï¼Œè¿™æ˜¯å› ä¸º OAuth 2.0 å…è®¸è·³è½¬ç½‘å€æ˜¯ HTTP åè®®ï¼Œå› æ­¤å­˜åœ¨&quot;ä¸­é—´äººæ”»å‡»&quot;çš„é£é™©ï¼Œè€Œæµè§ˆå™¨è·³è½¬æ—¶ï¼Œé”šç‚¹ä¸ä¼šå‘åˆ°æœåŠ¡å™¨ï¼Œå°±å‡å°‘äº†æ³„æ¼ä»¤ç‰Œçš„é£é™©ã€‚</p>
<p>è¿™ç§æ–¹å¼æŠŠä»¤ç‰Œç›´æ¥ä¼ ç»™å‰ç«¯ï¼Œæ˜¯å¾ˆä¸å®‰å…¨çš„ã€‚å› æ­¤ï¼Œåªèƒ½ç”¨äºä¸€äº›å®‰å…¨è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œå¹¶ä¸”ä»¤ç‰Œçš„æœ‰æ•ˆæœŸå¿…é¡»éå¸¸çŸ­ï¼Œé€šå¸¸å°±æ˜¯ä¼šè¯æœŸé—´ï¼ˆsessionï¼‰æœ‰æ•ˆï¼Œæµè§ˆå™¨å…³æ‰ï¼Œä»¤ç‰Œå°±å¤±æ•ˆäº†ã€‚</p>
<h2 id="ç¬¬ä¸‰ç§æ–¹å¼å¯†ç å¼">ç¬¬ä¸‰ç§æ–¹å¼ï¼šå¯†ç å¼<a hidden class="anchor" aria-hidden="true" href="#ç¬¬ä¸‰ç§æ–¹å¼å¯†ç å¼">#</a></h2>
<p>å¦‚æœä½ é«˜åº¦ä¿¡ä»»æŸä¸ªåº”ç”¨ï¼ŒRFC 6749 ä¹Ÿå…è®¸ç”¨æˆ·æŠŠç”¨æˆ·åå’Œå¯†ç ï¼Œç›´æ¥å‘Šè¯‰è¯¥åº”ç”¨ã€‚è¯¥åº”ç”¨å°±ä½¿ç”¨ä½ çš„å¯†ç ï¼Œç”³è¯·ä»¤ç‰Œï¼Œè¿™ç§æ–¹å¼ç§°ä¸º&quot;å¯†ç å¼&quot;ï¼ˆpasswordï¼‰ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼ŒA ç½‘ç«™è¦æ±‚ç”¨æˆ·æä¾› B ç½‘ç«™çš„ç”¨æˆ·åå’Œå¯†ç ã€‚æ‹¿åˆ°ä»¥åï¼ŒA å°±ç›´æ¥å‘ B è¯·æ±‚ä»¤ç‰Œã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://oauth.b.com/token?
</span></span><span style="display:flex;"><span>  grant_type=password&amp;
</span></span><span style="display:flex;"><span>  username=USERNAME&amp;
</span></span><span style="display:flex;"><span>  password=PASSWORD&amp;
</span></span><span style="display:flex;"><span>  client_id=CLIENT_ID
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ URL ä¸­ï¼Œgrant_typeå‚æ•°æ˜¯æˆæƒæ–¹å¼ï¼Œè¿™é‡Œçš„passwordè¡¨ç¤º&quot;å¯†ç å¼&quot;ï¼Œusernameå’Œpasswordæ˜¯ B çš„ç”¨æˆ·åå’Œå¯†ç ã€‚
ç¬¬äºŒæ­¥ï¼ŒB ç½‘ç«™éªŒè¯èº«ä»½é€šè¿‡åï¼Œç›´æ¥ç»™å‡ºä»¤ç‰Œã€‚æ³¨æ„ï¼Œè¿™æ—¶ä¸éœ€è¦è·³è½¬ï¼Œè€Œæ˜¯æŠŠä»¤ç‰Œæ”¾åœ¨ JSON æ•°æ®é‡Œé¢ï¼Œä½œä¸º HTTP å›åº”ï¼ŒA å› æ­¤æ‹¿åˆ°ä»¤ç‰Œã€‚
è¿™ç§æ–¹å¼éœ€è¦ç”¨æˆ·ç»™å‡ºè‡ªå·±çš„ç”¨æˆ·å/å¯†ç ï¼Œæ˜¾ç„¶é£é™©å¾ˆå¤§ï¼Œå› æ­¤åªé€‚ç”¨äºå…¶ä»–æˆæƒæ–¹å¼éƒ½æ— æ³•é‡‡ç”¨çš„æƒ…å†µï¼Œè€Œä¸”å¿…é¡»æ˜¯ç”¨æˆ·é«˜åº¦ä¿¡ä»»çš„åº”ç”¨ã€‚</p>
<h2 id="ç¬¬å››ç§æ–¹å¼å‡­è¯å¼">ç¬¬å››ç§æ–¹å¼ï¼šå‡­è¯å¼<a hidden class="anchor" aria-hidden="true" href="#ç¬¬å››ç§æ–¹å¼å‡­è¯å¼">#</a></h2>
<p>æœ€åä¸€ç§æ–¹å¼æ˜¯å‡­è¯å¼ï¼ˆclient credentialsï¼‰ï¼Œé€‚ç”¨äºæ²¡æœ‰å‰ç«¯çš„å‘½ä»¤è¡Œåº”ç”¨ï¼Œå³åœ¨å‘½ä»¤è¡Œä¸‹è¯·æ±‚ä»¤ç‰Œã€‚ç¬¬ä¸€æ­¥ï¼ŒA åº”ç”¨åœ¨å‘½ä»¤è¡Œå‘ B å‘å‡ºè¯·æ±‚ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://oauth.b.com/token?
</span></span><span style="display:flex;"><span>  grant_type=client_credentials&amp;
</span></span><span style="display:flex;"><span>  client_id=CLIENT_ID&amp;
</span></span><span style="display:flex;"><span>  client_secret=CLIENT_SECRET
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ URL ä¸­ï¼Œgrant_typeå‚æ•°ç­‰äºclient_credentialsè¡¨ç¤ºé‡‡ç”¨å‡­è¯å¼ï¼Œclient_idå’Œclient_secretç”¨æ¥è®© Bç¡®è®¤ A çš„èº«ä»½ã€‚
ç¬¬äºŒæ­¥ï¼ŒB ç½‘ç«™éªŒè¯é€šè¿‡ä»¥åï¼Œç›´æ¥è¿”å›ä»¤ç‰Œã€‚è¿™ç§æ–¹å¼ç»™å‡ºçš„ä»¤ç‰Œï¼Œæ˜¯é’ˆå¯¹ç¬¬ä¸‰æ–¹åº”ç”¨çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹ç”¨æˆ·çš„ï¼Œå³æœ‰å¯èƒ½å¤šä¸ªç”¨æˆ·å…±äº«åŒä¸€ä¸ªä»¤ç‰Œã€‚</p>
<h2 id="ä»¤ç‰Œçš„ä½¿ç”¨">ä»¤ç‰Œçš„ä½¿ç”¨<a hidden class="anchor" aria-hidden="true" href="#ä»¤ç‰Œçš„ä½¿ç”¨">#</a></h2>
<p>A ç½‘ç«™æ‹¿åˆ°ä»¤ç‰Œä»¥åï¼Œå°±å¯ä»¥å‘ B ç½‘ç«™çš„ API è¯·æ±‚æ•°æ®äº†ã€‚
æ­¤æ—¶ï¼Œæ¯ä¸ªå‘åˆ° API çš„è¯·æ±‚ï¼Œéƒ½å¿…é¡»å¸¦æœ‰ä»¤ç‰Œã€‚å…·ä½“åšæ³•æ˜¯åœ¨è¯·æ±‚çš„å¤´ä¿¡æ¯ï¼ŒåŠ ä¸Šä¸€ä¸ªAuthorizationå­—æ®µï¼Œä»¤ç‰Œå°±æ”¾åœ¨è¿™ä¸ªå­—æ®µé‡Œé¢ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>curl -H &#34;Authorization: Bearer ACCESS_TOKEN&#34; \
</span></span><span style="display:flex;"><span>&#34;https://api.b.com&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢å‘½ä»¤ä¸­ï¼ŒACCESS_TOKENå°±æ˜¯æ‹¿åˆ°çš„ä»¤ç‰Œã€‚</p>
<h2 id="æ›´æ–°ä»¤ç‰Œ">æ›´æ–°ä»¤ç‰Œ<a hidden class="anchor" aria-hidden="true" href="#æ›´æ–°ä»¤ç‰Œ">#</a></h2>
<p>ä»¤ç‰Œçš„æœ‰æ•ˆæœŸåˆ°äº†ï¼Œå¦‚æœè®©ç”¨æˆ·é‡æ–°èµ°ä¸€éä¸Šé¢çš„æµç¨‹ï¼Œå†ç”³è¯·ä¸€ä¸ªæ–°çš„ä»¤ç‰Œï¼Œå¾ˆå¯èƒ½ä½“éªŒä¸å¥½ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰å¿…è¦ã€‚OAuth 2.0 å…è®¸ç”¨æˆ·è‡ªåŠ¨æ›´æ–°ä»¤ç‰Œã€‚
å…·ä½“æ–¹æ³•æ˜¯ï¼ŒB ç½‘ç«™é¢å‘ä»¤ç‰Œçš„æ—¶å€™ï¼Œä¸€æ¬¡æ€§é¢å‘ä¸¤ä¸ªä»¤ç‰Œï¼Œä¸€ä¸ªç”¨äºè·å–æ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºè·å–æ–°çš„ä»¤ç‰Œï¼ˆrefresh token å­—æ®µï¼‰ã€‚ä»¤ç‰Œåˆ°æœŸå‰ï¼Œç”¨æˆ·ä½¿ç”¨ refresh token å‘ä¸€ä¸ªè¯·æ±‚ï¼Œå»æ›´æ–°ä»¤ç‰Œã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://b.com/oauth/token?
</span></span><span style="display:flex;"><span>  grant_type=refresh_token&amp;
</span></span><span style="display:flex;"><span>  client_id=CLIENT_ID&amp;
</span></span><span style="display:flex;"><span>  client_secret=CLIENT_SECRET&amp;
</span></span><span style="display:flex;"><span>  refresh_token=REFRESH_TOKEN
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ URL ä¸­ï¼Œgrant_typeå‚æ•°ä¸ºrefresh_tokenè¡¨ç¤ºè¦æ±‚æ›´æ–°ä»¤ç‰Œï¼Œclient_idå‚æ•°å’Œclient_secretå‚æ•°ç”¨äºç¡®è®¤èº«ä»½ï¼Œrefresh_tokenå‚æ•°å°±æ˜¯ç”¨äºæ›´æ–°ä»¤ç‰Œçš„ä»¤ç‰Œã€‚</p>
<p>B ç½‘ç«™éªŒè¯é€šè¿‡ä»¥åï¼Œå°±ä¼šé¢å‘æ–°çš„ä»¤ç‰Œã€‚</p>
<p><a href="http://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html">å‚è€ƒé˜®ä¸€å³°è€å¸ˆçš„æ–‡ç« </a>
<a href="https://www.kancloud.cn/gzy37/oauth2/1093498">OAuthä¸­æ–‡è§„èŒƒ</a></p>
<h1 id="jwtjson-web-tokens">JWT(JSON WEB TOKENS)<a hidden class="anchor" aria-hidden="true" href="#jwtjson-web-tokens">#</a></h1>
<p>JSON Web Tokenï¼ˆç¼©å†™ JWTï¼‰æ˜¯ç›®å‰æœ€æµè¡Œçš„è·¨åŸŸè®¤è¯è§£å†³æ–¹æ¡ˆï¼Œç‰¹åˆ«é€‚ç”¨äºåˆ†å¸ƒå¼ç«™ç‚¹çš„å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰åœºæ™¯ã€‚
<a href="https://tools.ietf.org/html/rfc7519">å®˜æ–¹æ ‡å‡†</a></p>
<h2 id="è·¨åŸŸè®¤è¯çš„é—®é¢˜">è·¨åŸŸè®¤è¯çš„é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#è·¨åŸŸè®¤è¯çš„é—®é¢˜">#</a></h2>
<p>äº’è”ç½‘æœåŠ¡ç¦»ä¸å¼€ç”¨æˆ·è®¤è¯ã€‚ä¸€èˆ¬æµç¨‹æ˜¯ä¸‹é¢è¿™æ ·ã€‚
1ã€ç”¨æˆ·å‘æœåŠ¡å™¨å‘é€ç”¨æˆ·åå’Œå¯†ç ã€‚
2ã€æœåŠ¡å™¨éªŒè¯é€šè¿‡åï¼Œåœ¨å½“å‰å¯¹è¯ï¼ˆsessionï¼‰é‡Œé¢ä¿å­˜ç›¸å…³æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·è§’è‰²ã€ç™»å½•æ—¶é—´ç­‰ç­‰ã€‚
3ã€æœåŠ¡å™¨å‘ç”¨æˆ·è¿”å›ä¸€ä¸ª session_idï¼Œå†™å…¥ç”¨æˆ·çš„ Cookieã€‚
4ã€ç”¨æˆ·éšåçš„æ¯ä¸€æ¬¡è¯·æ±‚ï¼Œéƒ½ä¼šé€šè¿‡ Cookieï¼Œå°† session_id ä¼ å›æœåŠ¡å™¨ã€‚
5ã€æœåŠ¡å™¨æ”¶åˆ° session_idï¼Œæ‰¾åˆ°å‰æœŸä¿å­˜çš„æ•°æ®ï¼Œç”±æ­¤å¾—çŸ¥ç”¨æˆ·çš„èº«ä»½ã€‚</p>
<p>è¿™ç§æ¨¡å¼çš„é—®é¢˜åœ¨äºï¼Œæ‰©å±•æ€§ï¼ˆscalingï¼‰ä¸å¥½ã€‚å•æœºå½“ç„¶æ²¡æœ‰é—®é¢˜ï¼Œå¦‚æœæ˜¯æœåŠ¡å™¨é›†ç¾¤ï¼Œæˆ–è€…æ˜¯è·¨åŸŸçš„æœåŠ¡å¯¼å‘æ¶æ„ï¼Œå°±è¦æ±‚ session æ•°æ®å…±äº«ï¼Œæ¯å°æœåŠ¡å™¨éƒ½èƒ½å¤Ÿè¯»å– sessionã€‚
ä¸¾ä¾‹æ¥è¯´ï¼ŒA ç½‘ç«™å’Œ B ç½‘ç«™æ˜¯åŒä¸€å®¶å…¬å¸çš„å…³è”æœåŠ¡ã€‚ç°åœ¨è¦æ±‚ï¼Œç”¨æˆ·åªè¦åœ¨å…¶ä¸­ä¸€ä¸ªç½‘ç«™ç™»å½•ï¼Œå†è®¿é—®å¦ä¸€ä¸ªç½‘ç«™å°±ä¼šè‡ªåŠ¨ç™»å½•ï¼Œè¯·é—®æ€ä¹ˆå®ç°ï¼Ÿ
ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ session æ•°æ®æŒä¹…åŒ–ï¼Œå†™å…¥æ•°æ®åº“æˆ–åˆ«çš„æŒä¹…å±‚ã€‚å„ç§æœåŠ¡æ”¶åˆ°è¯·æ±‚åï¼Œéƒ½å‘æŒä¹…å±‚è¯·æ±‚æ•°æ®ã€‚
è¿™ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯æ¶æ„æ¸…æ™°ï¼Œç¼ºç‚¹æ˜¯å·¥ç¨‹é‡æ¯”è¾ƒå¤§ã€‚å¦å¤–ï¼ŒæŒä¹…å±‚ä¸‡ä¸€æŒ‚äº†ï¼Œå°±ä¼šå•ç‚¹å¤±è´¥ã€‚
å¦ä¸€ç§æ–¹æ¡ˆæ˜¯æœåŠ¡å™¨ç´¢æ€§ä¸ä¿å­˜ session æ•°æ®äº†ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½å‘å›æœåŠ¡å™¨ã€‚JWT å°±æ˜¯è¿™ç§æ–¹æ¡ˆçš„ä¸€ä¸ªä»£è¡¨ã€‚</p>
<h2 id="jwt-çš„åŸç†">JWT çš„åŸç†<a hidden class="anchor" aria-hidden="true" href="#jwt-çš„åŸç†">#</a></h2>
<p>JWT çš„åŸç†æ˜¯ï¼ŒæœåŠ¡å™¨è®¤è¯ä»¥åï¼Œç”Ÿæˆä¸€ä¸ª JSON å¯¹è±¡ï¼Œå‘å›ç»™ç”¨æˆ·ï¼Œå°±åƒä¸‹é¢è¿™æ ·ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;å§“å&#34;: &#34;å¼ ä¸‰&#34;,
</span></span><span style="display:flex;"><span>  &#34;è§’è‰²&#34;: &#34;ç®¡ç†å‘˜&#34;,
</span></span><span style="display:flex;"><span>  &#34;åˆ°æœŸæ—¶é—´&#34;: &#34;2018å¹´7æœˆ1æ—¥0ç‚¹0åˆ†&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥åï¼Œç”¨æˆ·ä¸æœåŠ¡ç«¯é€šä¿¡çš„æ—¶å€™ï¼Œéƒ½è¦å‘å›è¿™ä¸ª JSON å¯¹è±¡ã€‚æœåŠ¡å™¨å®Œå…¨åªé è¿™ä¸ªå¯¹è±¡è®¤å®šç”¨æˆ·èº«ä»½ã€‚ä¸ºäº†é˜²æ­¢ç”¨æˆ·ç¯¡æ”¹æ•°æ®ï¼ŒæœåŠ¡å™¨åœ¨ç”Ÿæˆè¿™ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œä¼šåŠ ä¸Šç­¾åï¼ˆè¯¦è§åæ–‡ï¼‰ã€‚
æœåŠ¡å™¨å°±ä¸ä¿å­˜ä»»ä½• session æ•°æ®äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒæœåŠ¡å™¨å˜æˆæ— çŠ¶æ€äº†ï¼Œä»è€Œæ¯”è¾ƒå®¹æ˜“å®ç°æ‰©å±•ã€‚</p>
<h2 id="jwt-çš„æ•°æ®ç»“æ„">JWT çš„æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#jwt-çš„æ•°æ®ç»“æ„">#</a></h2>
<p>å®é™…çš„ JWT å¤§æ¦‚å°±åƒä¸‹é¢è¿™æ ·ã€‚
<code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</code></p>
<p>JWT çš„ä¸‰ä¸ªéƒ¨åˆ†ä¾æ¬¡å¦‚ä¸‹ã€‚
Headerï¼ˆå¤´éƒ¨ï¼‰
Payloadï¼ˆè´Ÿè½½ï¼‰
Signatureï¼ˆç­¾åï¼‰</p>
<p>å†™æˆä¸€è¡Œï¼Œå°±æ˜¯ä¸‹é¢çš„æ ·å­ã€‚
<code>Header.Payload.Signature</code></p>
<h3 id="header">Header<a hidden class="anchor" aria-hidden="true" href="#header">#</a></h3>
<p>Header éƒ¨åˆ†æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œæè¿° JWT çš„å…ƒæ•°æ®ï¼Œé€šå¸¸æ˜¯ä¸‹é¢çš„æ ·å­ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;alg&#34;: &#34;HS256&#34;,
</span></span><span style="display:flex;"><span>  &#34;typ&#34;: &#34;JWT&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ä»£ç ä¸­ï¼Œalgå±æ€§è¡¨ç¤ºç­¾åçš„ç®—æ³•ï¼ˆalgorithmï¼‰ï¼Œé»˜è®¤æ˜¯ HMAC SHA256ï¼ˆå†™æˆ HS256ï¼‰ï¼›typå±æ€§è¡¨ç¤ºè¿™ä¸ªä»¤ç‰Œï¼ˆtokenï¼‰çš„ç±»å‹ï¼ˆtypeï¼‰ï¼ŒJWT ä»¤ç‰Œç»Ÿä¸€å†™ä¸ºJWTã€‚
æœ€åï¼Œå°†ä¸Šé¢çš„ JSON å¯¹è±¡ä½¿ç”¨ Base64URL ç®—æ³•ï¼ˆè¯¦è§åæ–‡ï¼‰è½¬æˆå­—ç¬¦ä¸²ã€‚</p>
<h3 id="payload">Payload<a hidden class="anchor" aria-hidden="true" href="#payload">#</a></h3>
<p>Payload éƒ¨åˆ†ä¹Ÿæ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾å®é™…éœ€è¦ä¼ é€’çš„æ•°æ®ã€‚JWT è§„å®šäº†7ä¸ªå®˜æ–¹å­—æ®µï¼Œä¾›é€‰ç”¨ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>iss (issuer)ï¼šç­¾å‘äºº
</span></span><span style="display:flex;"><span>exp (expiration time)ï¼šè¿‡æœŸæ—¶é—´
</span></span><span style="display:flex;"><span>sub (subject)ï¼šä¸»é¢˜
</span></span><span style="display:flex;"><span>aud (audience)ï¼šå—ä¼—
</span></span><span style="display:flex;"><span>nbf (Not Before)ï¼šç”Ÿæ•ˆæ—¶é—´
</span></span><span style="display:flex;"><span>iat (Issued At)ï¼šç­¾å‘æ—¶é—´
</span></span><span style="display:flex;"><span>jti (JWT ID)ï¼šç¼–å·
</span></span></code></pre></td></tr></table>
</div>
</div><p>é™¤äº†å®˜æ–¹å­—æ®µï¼Œä½ è¿˜å¯ä»¥åœ¨è¿™ä¸ªéƒ¨åˆ†å®šä¹‰ç§æœ‰å­—æ®µï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;sub&#34;: &#34;1234567890&#34;,
</span></span><span style="display:flex;"><span>  &#34;name&#34;: &#34;John Doe&#34;,
</span></span><span style="display:flex;"><span>  &#34;admin&#34;: true
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„ï¼ŒJWT é»˜è®¤æ˜¯ä¸åŠ å¯†çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥è¯»åˆ°ï¼Œæ‰€ä»¥ä¸è¦æŠŠç§˜å¯†ä¿¡æ¯æ”¾åœ¨è¿™ä¸ªéƒ¨åˆ†ã€‚</p>
<h3 id="signature">Signature<a hidden class="anchor" aria-hidden="true" href="#signature">#</a></h3>
<p>Signature éƒ¨åˆ†æ˜¯å¯¹å‰ä¸¤éƒ¨åˆ†çš„ç­¾åï¼Œé˜²æ­¢æ•°æ®ç¯¡æ”¹ã€‚
é¦–å…ˆï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªå¯†é’¥ï¼ˆsecretï¼‰ã€‚è¿™ä¸ªå¯†é’¥åªæœ‰æœåŠ¡å™¨æ‰çŸ¥é“ï¼Œä¸èƒ½æ³„éœ²ç»™ç”¨æˆ·ã€‚ç„¶åï¼Œä½¿ç”¨ Header é‡Œé¢æŒ‡å®šçš„ç­¾åç®—æ³•ï¼ˆé»˜è®¤æ˜¯ HMAC SHA256ï¼‰ï¼ŒæŒ‰ç…§ä¸‹é¢çš„å…¬å¼äº§ç”Ÿç­¾åã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>HMACSHA256(
</span></span><span style="display:flex;"><span>  base64UrlEncode(header) + &#34;.&#34; +
</span></span><span style="display:flex;"><span>  base64UrlEncode(payload),
</span></span><span style="display:flex;"><span>  secret)
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç®—å‡ºç­¾åä»¥åï¼ŒæŠŠ Headerã€Payloadã€Signature ä¸‰ä¸ªéƒ¨åˆ†æ‹¼æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªéƒ¨åˆ†ä¹‹é—´ç”¨&quot;ç‚¹&quot;ï¼ˆ.ï¼‰åˆ†éš”ï¼Œå°±å¯ä»¥è¿”å›ç»™ç”¨æˆ·ã€‚</p>
<h3 id="base64url">Base64URL<a hidden class="anchor" aria-hidden="true" href="#base64url">#</a></h3>
<p>å‰é¢æåˆ°ï¼ŒHeader å’Œ Payload ä¸²å‹åŒ–çš„ç®—æ³•æ˜¯ Base64URLã€‚è¿™ä¸ªç®—æ³•è·Ÿ Base64 ç®—æ³•åŸºæœ¬ç±»ä¼¼ï¼Œä½†æœ‰ä¸€äº›å°çš„ä¸åŒã€‚JWT ä½œä¸ºä¸€ä¸ªä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œæœ‰äº›åœºåˆå¯èƒ½ä¼šæ”¾åˆ° URLï¼ˆæ¯”å¦‚ api.example.com/?token=xxxï¼‰ã€‚Base64 æœ‰ä¸‰ä¸ªå­—ç¬¦+ã€/å’Œ=ï¼Œåœ¨ URL é‡Œé¢æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œæ‰€ä»¥è¦è¢«æ›¿æ¢æ‰ï¼š=è¢«çœç•¥ã€+æ›¿æ¢æˆ-ï¼Œ/æ›¿æ¢æˆ_ ã€‚è¿™å°±æ˜¯ Base64URL ç®—æ³•ã€‚</p>
<h2 id="jwt-çš„ä½¿ç”¨æ–¹å¼">JWT çš„ä½¿ç”¨æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#jwt-çš„ä½¿ç”¨æ–¹å¼">#</a></h2>
<p>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„ JWTï¼Œå¯ä»¥å‚¨å­˜åœ¨ Cookie é‡Œé¢ï¼Œä¹Ÿå¯ä»¥å‚¨å­˜åœ¨ localStorageã€‚
æ­¤åï¼Œå®¢æˆ·ç«¯æ¯æ¬¡ä¸æœåŠ¡å™¨é€šä¿¡ï¼Œéƒ½è¦å¸¦ä¸Šè¿™ä¸ª JWTã€‚ä½ å¯ä»¥æŠŠå®ƒæ”¾åœ¨ Cookie é‡Œé¢è‡ªåŠ¨å‘é€ï¼Œä½†æ˜¯è¿™æ ·ä¸èƒ½è·¨åŸŸï¼Œæ‰€ä»¥æ›´å¥½çš„åšæ³•æ˜¯æ”¾åœ¨ HTTP è¯·æ±‚çš„å¤´ä¿¡æ¯Authorizationå­—æ®µé‡Œé¢ã€‚
<code>Authorization: Bearer &lt;token&gt;</code>
å¦ä¸€ç§åšæ³•æ˜¯ï¼Œè·¨åŸŸçš„æ—¶å€™ï¼ŒJWT å°±æ”¾åœ¨ POST è¯·æ±‚çš„æ•°æ®ä½“é‡Œé¢ã€‚</p>
<h2 id="jwt-çš„å‡ ä¸ªç‰¹ç‚¹">JWT çš„å‡ ä¸ªç‰¹ç‚¹<a hidden class="anchor" aria-hidden="true" href="#jwt-çš„å‡ ä¸ªç‰¹ç‚¹">#</a></h2>
<ul>
<li>JWT é»˜è®¤æ˜¯ä¸åŠ å¯†ï¼Œä½†ä¹Ÿæ˜¯å¯ä»¥åŠ å¯†çš„ã€‚ç”ŸæˆåŸå§‹ Token ä»¥åï¼Œå¯ä»¥ç”¨å¯†é’¥å†åŠ å¯†ä¸€æ¬¡ã€‚</li>
<li>JWT ä¸åŠ å¯†çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½å°†ç§˜å¯†æ•°æ®å†™å…¥ JWTã€‚</li>
<li>JWT ä¸ä»…å¯ä»¥ç”¨äºè®¤è¯ï¼Œä¹Ÿå¯ä»¥ç”¨äºäº¤æ¢ä¿¡æ¯ã€‚æœ‰æ•ˆä½¿ç”¨ JWTï¼Œå¯ä»¥é™ä½æœåŠ¡å™¨æŸ¥è¯¢æ•°æ®åº“çš„æ¬¡æ•°ã€‚</li>
<li>JWT çš„æœ€å¤§ç¼ºç‚¹æ˜¯ï¼Œç”±äºæœåŠ¡å™¨ä¸ä¿å­˜ session çŠ¶æ€ï¼Œå› æ­¤æ— æ³•åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­åºŸæ­¢æŸä¸ª tokenï¼Œæˆ–è€…æ›´æ”¹token çš„æƒé™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ JWT ç­¾å‘äº†ï¼Œåœ¨åˆ°æœŸä¹‹å‰å°±ä¼šå§‹ç»ˆæœ‰æ•ˆï¼Œé™¤éæœåŠ¡å™¨éƒ¨ç½²é¢å¤–çš„é€»è¾‘ã€‚</li>
<li>JWT æœ¬èº«åŒ…å«äº†è®¤è¯ä¿¡æ¯ï¼Œä¸€æ—¦æ³„éœ²ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å¾—è¯¥ä»¤ç‰Œçš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWT çš„æœ‰æ•ˆæœŸåº”è¯¥è®¾ç½®å¾—æ¯”è¾ƒçŸ­ã€‚å¯¹äºä¸€äº›æ¯”è¾ƒé‡è¦çš„æƒé™ï¼Œä½¿ç”¨æ—¶åº”è¯¥å†æ¬¡å¯¹ç”¨æˆ·è¿›è¡Œè®¤è¯ã€‚</li>
<li>ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWT ä¸åº”è¯¥ä½¿ç”¨ HTTP åè®®æ˜ç ä¼ è¾“ï¼Œè¦ä½¿ç”¨ HTTPS åè®®ä¼ è¾“ã€‚</li>
</ul>
<p><a href="https://www.jianshu.com/p/cb886f995e86">ç†è§£Spring Cloud Security OAuth2åŠJWT</a></p>
<h1 id="spring-security-oauth2">Spring Security OAuth2<a hidden class="anchor" aria-hidden="true" href="#spring-security-oauth2">#</a></h1>
<h2 id="æ„å»ºé¡¹ç›®">æ„å»ºé¡¹ç›®<a hidden class="anchor" aria-hidden="true" href="#æ„å»ºé¡¹ç›®">#</a></h2>
<p>ç”¨ideaåˆ›å»ºspring booté¡¹ç›®ï¼Œå¹¶å¼•å…¥å¦‚ä¸‹mavenä¾èµ–ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;!--Web--&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;!--MySQL--&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;mysql&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>	&lt;scope&gt;runtime&lt;/scope&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;!--å¼•å…¥druidæœ€æ–°mavenä¾èµ–--&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;com.alibaba&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;druid&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>	&lt;version&gt;1.0.29&lt;/version&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;org.springframework&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>	&lt;version&gt;5.1.9.RELEASE&lt;/version&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;!--SpringDataJPA--&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;!--SpringSecurity--&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span><span style="display:flex;"><span>&lt;!-- https://mvnrepository.com/artifact/org.springframework.security.oauth/spring-security-oauth2 --&gt;
</span></span><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>	&lt;groupId&gt;org.springframework.security.oauth&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>	&lt;artifactId&gt;spring-security-oauth2&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>	&lt;version&gt;2.3.3.RELEASE&lt;/version&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="é¡¹ç›®é…ç½®æ–‡ä»¶">é¡¹ç›®é…ç½®æ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#é¡¹ç›®é…ç½®æ–‡ä»¶">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">type</span>: com.alibaba.druid.pool.DruidDataSource
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">driver-class-name</span>: com.mysql.jdbc.Driver
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:mysql://127.0.0.1:3306/oauth2?characterEncoding=utf8
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: root
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: <span style="color:#ff0;font-weight:bold">123456</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#æœ€å¤§æ´»è·ƒæ•°</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">maxActive</span>: <span style="color:#ff0;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#åˆå§‹åŒ–æ•°é‡</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">initialSize</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#æœ€å¤§è¿æ¥ç­‰å¾…è¶…æ—¶æ—¶é—´</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">maxWait</span>: <span style="color:#ff0;font-weight:bold">60000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#æ‰“å¼€PSCacheï¼Œå¹¶ä¸”æŒ‡å®šæ¯ä¸ªè¿æ¥PSCacheçš„å¤§å°</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">poolPreparedStatements</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">maxPoolPreparedStatementPerConnectionSize</span>: <span style="color:#ff0;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#é€šè¿‡connectionPropertieså±æ€§æ¥æ‰“å¼€mergeSqlåŠŸèƒ½ï¼›æ…¢SQLè®°å½•</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">minIdle</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">timeBetweenEvictionRunsMillis</span>: <span style="color:#ff0;font-weight:bold">60000</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">minEvictableIdleTimeMillis</span>: <span style="color:#ff0;font-weight:bold">300000</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">validationQuery</span>: select 1 from dual
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">testWhileIdle</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">testOnBorrow</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">testOnReturn</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">#é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filtersï¼Œå»æ‰åç›‘æ§ç•Œé¢sqlå°†æ— æ³•ç»Ÿè®¡,&#39;wall&#39;ç”¨äºé˜²ç«å¢™</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">filters</span>: stat, wall, log4j
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">jpa</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">properties</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">hibernate</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">show_sql</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">format_sql</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ•°æ®åº“">æ•°æ®åº“<a hidden class="anchor" aria-hidden="true" href="#æ•°æ®åº“">#</a></h2>
<p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨æ•°æ®åº“ä¿å­˜ç”¨æˆ·ã€è§’è‰²ã€accessTokenã€RefershTokenç­‰ä¿¡æ¯ï¼Œæ‰€ä»¥è¦æ–°å»ºéœ€è¦çš„è¡¨ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ç”¨æˆ·è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> `<span style="color:#fff;font-weight:bold">user</span>` (
</span></span><span style="display:flex;"><span>  `username` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">NOT</span> NULL,
</span></span><span style="display:flex;"><span>  `email` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `password` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">500</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `activated` <span style="color:#fff;font-weight:bold">tinyint</span>(<span style="color:#ff0;font-weight:bold">1</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#0ff;font-weight:bold">&#39;0&#39;</span>,
</span></span><span style="display:flex;"><span>  `activationkey` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `resetpasswordkey` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">PRIMARY</span> <span style="color:#fff;font-weight:bold">KEY</span> (`username`)
</span></span><span style="display:flex;"><span>) <span style="color:#fff;font-weight:bold">ENGINE</span>=MyISAM <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#fff;font-weight:bold">CHARSET</span>=utf8;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ç”¨æˆ·æ•°æ®ã€‚éœ€è¦æ³¨æ„å¯†ç å­—æ®µï¼Œå­˜çš„æ˜¯åŠ å¯†ä¹‹åçš„å¯†æ–‡ã€‚åŠ å¯†ç®—æ³•ä¼šåœ¨åé¢è¯´æ˜ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `<span style="color:#fff;font-weight:bold">user</span>` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;admin&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;admin@mail.me&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;$2a$10$vHCuajBQOH4ZX8LKRoRFI.6s23W9wgPUyw6VqJS5KWEZkjnT52nfi&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>, null, null);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `<span style="color:#fff;font-weight:bold">user</span>` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;user&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;user@mail.me&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;$2a$10$vHCuajBQOH4ZX8LKRoRFI.6s23W9wgPUyw6VqJS5KWEZkjnT52nfi&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>, null, null);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- è§’è‰²è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> `authority` (
</span></span><span style="display:flex;"><span>  `name` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">NOT</span> NULL,
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">PRIMARY</span> <span style="color:#fff;font-weight:bold">KEY</span> (`name`)
</span></span><span style="display:flex;"><span>) <span style="color:#fff;font-weight:bold">ENGINE</span>=MyISAM <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#fff;font-weight:bold">CHARSET</span>=utf8;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- è§’è‰²æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `authority` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;ROLE_ADMIN&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `authority` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;ROLE_USER&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> `user_authority` (
</span></span><span style="display:flex;"><span>  `username` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">NOT</span> NULL,
</span></span><span style="display:flex;"><span>  `authority` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">50</span>) <span style="color:#fff;font-weight:bold">NOT</span> NULL,
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">UNIQUE</span> <span style="color:#fff;font-weight:bold">KEY</span> `user_authority_idx_1` (`username`,`authority`),
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">KEY</span> `authority` (`authority`)
</span></span><span style="display:flex;"><span>) <span style="color:#fff;font-weight:bold">ENGINE</span>=MyISAM <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#fff;font-weight:bold">CHARSET</span>=utf8;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ä¸­é—´è¡¨æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `user_authority` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;admin&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;ROLE_ADMIN&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `user_authority` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;admin&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;ROLE_USER&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `user_authority` <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;user&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;ROLE_USER&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯SpringSecurityOAuth2æä¾›çš„Jdbcæ–¹å¼è¿›è¡Œæ“ä½œTokenï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®æ ‡å‡†åˆ›å»ºå¯¹åº”çš„è¡¨ç»“æ„
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> `oauth_access_token` (
</span></span><span style="display:flex;"><span>  `token_id` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `token` <span style="color:#fff;font-weight:bold">blob</span>,
</span></span><span style="display:flex;"><span>  `authentication_id` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `user_name` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `client_id` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `authentication` <span style="color:#fff;font-weight:bold">blob</span>,
</span></span><span style="display:flex;"><span>  `refresh_token` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL
</span></span><span style="display:flex;"><span>) <span style="color:#fff;font-weight:bold">ENGINE</span>=MyISAM <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#fff;font-weight:bold">CHARSET</span>=utf8;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- åˆ·æ–°Tokenæ—¶éœ€è¦ç”¨åˆ°refresh_tokenä¿¡æ¯è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- ----------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> `oauth_refresh_token` (
</span></span><span style="display:flex;"><span>  `token_id` <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">256</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> NULL,
</span></span><span style="display:flex;"><span>  `token` <span style="color:#fff;font-weight:bold">blob</span>,
</span></span><span style="display:flex;"><span>  `authentication` <span style="color:#fff;font-weight:bold">blob</span>
</span></span><span style="display:flex;"><span>) <span style="color:#fff;font-weight:bold">ENGINE</span>=MyISAM <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#fff;font-weight:bold">CHARSET</span>=utf8;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="åˆ›å»ºå®ä½“ç±»">åˆ›å»ºå®ä½“ç±»<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºå®ä½“ç±»">#</a></h2>
<p>åªéœ€è¦åˆ›å»ºç”¨æˆ·ã€è§’è‰²å®ä½“ç±»ã€‚å› ä¸ºOAuth2å†…éƒ¨æ“ä½œæ•°æ®åº“ä½¿ç”¨çš„JdbcTemplateæˆ‘ä»¬åªéœ€è¦ä¼ å…¥ä¸€ä¸ªDataSourceå¯¹è±¡å°±å¯ä»¥äº†ï¼Œå®ä½“å¹¶ä¸éœ€è¦é…ç½®ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@Entity
</span></span><span style="display:flex;"><span>public class User {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Id
</span></span><span style="display:flex;"><span>    @Column(updatable = false, nullable = false)
</span></span><span style="display:flex;"><span>    private String username;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    private String password;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    private String email;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    private boolean activated;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Column(name = &#34;activationkey&#34;)
</span></span><span style="display:flex;"><span>    private String activationKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Column(name = &#34;resetpasswordkey&#34;)
</span></span><span style="display:flex;"><span>    private String resetPasswordKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ManyToMany
</span></span><span style="display:flex;"><span>    @JoinTable(
</span></span><span style="display:flex;"><span>            name = &#34;user_authority&#34;,
</span></span><span style="display:flex;"><span>            joinColumns = @JoinColumn(name = &#34;username&#34;),
</span></span><span style="display:flex;"><span>            inverseJoinColumns = @JoinColumn(name = &#34;authority&#34;))
</span></span><span style="display:flex;"><span>    private Set&lt;Authority&gt; authorities;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@Entity
</span></span><span style="display:flex;"><span>public class Authority {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Id
</span></span><span style="display:flex;"><span>    private String name;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”¨æˆ·å®ä½“ä»¥åŠè§’è‰²å®ä½“æ˜¯ç”¨æ¥é…ç½®SpringSecurityæ—¶ç”¨åˆ°çš„å®ä½“ï¼Œæˆ‘ä»¬é…ç½®SpringSecurityæ—¶éœ€è¦ä½¿ç”¨SpringDataJPAä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ï¼Œä¸‹æˆ‘ä»¬æ¥é…ç½®UserJPAä»¥åŠAuthorityJPAã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public interface UserJPA extends JpaRepository&lt;User, String&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Query(&#34;SELECT u FROM User u WHERE LOWER(u.username) = LOWER(:username)&#34;)
</span></span><span style="display:flex;"><span>    User findByUsernameCaseInsensitive(@Param(&#34;username&#34;) String username);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬åœ¨UserJPAå†…æ·»åŠ äº†ä¸€ä¸ªè‡ªå®šä¹‰æŸ¥è¯¢ï¼Œä½¿ç”¨äº†HQLè¯­æ³•æ¥æ„å»ºçš„è¯­å¥ï¼Œæ ¹æ®ç”¨æˆ·åä¸åŒºåˆ†å¤§å°å†™è¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public interface AuthorityJPA extends JpaRepository&lt;Authority, String&gt; {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="è‡ªå®šä¹‰userdetailsservice">è‡ªå®šä¹‰UserDetailsService<a hidden class="anchor" aria-hidden="true" href="#è‡ªå®šä¹‰userdetailsservice">#</a></h2>
<p>åˆ›å»ºç±»å¹¶å®ç°<code>UserDetailsService</code>:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component(<span style="color:#0ff;font-weight:bold">&#34;userDetailsService&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OauthUserDetailsService <span style="color:#fff;font-weight:bold">implements</span> UserDetailsService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> UserJPA userRepository;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    @Transactional
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserDetails loadUserByUsername(<span style="color:#fff;font-weight:bold">final</span> String login) {
</span></span><span style="display:flex;"><span>        String lowercaseLogin = login.<span style="color:#007f7f">toLowerCase</span>();
</span></span><span style="display:flex;"><span>        User userFromDatabase = userRepository.<span style="color:#007f7f">findByUsernameCaseInsensitive</span>(lowercaseLogin);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (userFromDatabase == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> NewUserNotFoundException(<span style="color:#0ff;font-weight:bold">&#34;User &#34;</span> + lowercaseLogin + <span style="color:#0ff;font-weight:bold">&#34; was not found in the database&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è·å–ç”¨æˆ·çš„æ‰€æœ‰æƒé™ï¼Œæƒé™æ˜¯SpringSecurityéœ€è¦çš„é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Collection&lt;GrantedAuthority&gt; grantedAuthorities = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (Authority authority : userFromDatabase.<span style="color:#007f7f">getAuthorities</span>()) {
</span></span><span style="display:flex;"><span>            GrantedAuthority grantedAuthority = <span style="color:#fff;font-weight:bold">new</span> SimpleGrantedAuthority(authority.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>            grantedAuthorities.<span style="color:#007f7f">add</span>(grantedAuthority);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è¿”å›ä¸€ä¸ªSpringSecurityéœ€è¦çš„ç”¨æˆ·å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> org.<span style="color:#007f7f">springframework</span>.<span style="color:#007f7f">security</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">userdetails</span>.<span style="color:#007f7f">User</span>(
</span></span><span style="display:flex;"><span>                userFromDatabase.<span style="color:#007f7f">getUsername</span>(),
</span></span><span style="display:flex;"><span>                userFromDatabase.<span style="color:#007f7f">getPassword</span>(),
</span></span><span style="display:flex;"><span>                grantedAuthorities);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‡ªå®šä¹‰çš„ OauthUserDetailsService ç±»ä¸­åšäº†ä»æ•°æ®åº“è¯»å–ç”¨æˆ·çš„æ“ä½œï¼Œå¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°ç”¨æˆ·ç›´æ¥æŠ›å‡ºå¼‚å¸¸æç¤ºï¼Œå¦‚æœæŸ¥è¯¢åˆ°å¹¶ä¸”è®¾ç½®å¯¹åº”çš„è§’è‰²åè¿”å›SpringSecurityå†…ç½®çš„Userå¯¹è±¡å®ä¾‹ã€‚</p>
<h2 id="é…ç½®springsecurity">é…ç½®SpringSecurity<a hidden class="anchor" aria-hidden="true" href="#é…ç½®springsecurity">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@EnableWebSecurity
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecurityConfiguration <span style="color:#fff;font-weight:bold">extends</span> WebSecurityConfigurerAdapter {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ³¨å…¥è‡ªå®šä¹‰çš„UserDetailsService
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> OauthUserDetailsService oauthUserDetailsService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//é…ç½®åŒ¹é…ç”¨æˆ·æ—¶å¯†ç è§„åˆ™
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> PasswordEncoder passwordEncoder() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> BCryptPasswordEncoder();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//    @Bean
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//    public PasswordEncoder passwordEncoder(){
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//    }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//é…ç½®å…¨å±€è®¾ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> configureGlobal(AuthenticationManagerBuilder auth) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¾ç½®UserDetailsServiceä»¥åŠå¯†ç è§„åˆ™
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#007f7f">//è¿™ä¸ªè§„åˆ™å½±å“äº†æ•°æ®åº“é‡Œå­˜å‚¨çš„passwordå­—æ®µï¼Œå‘æ•°æ®åº“å­˜å‚¨passwordæ—¶ï¼Œä¹Ÿè¦æŒ‰ç…§è¿™ä¸ªç®—æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        auth.<span style="color:#007f7f">userDetailsService</span>(oauthUserDetailsService).<span style="color:#007f7f">passwordEncoder</span>(passwordEncoder());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ’é™¤/helloè·¯å¾„æ‹¦æˆª
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> configure(WebSecurity web) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        web.<span style="color:#007f7f">ignoring</span>().<span style="color:#007f7f">antMatchers</span>(<span style="color:#0ff;font-weight:bold">&#34;/hello&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> AuthenticationManager authenticationManagerBean() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">authenticationManagerBean</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å¼€å¯å…¨å±€æ–¹æ³•æ‹¦æˆª
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @EnableGlobalMethodSecurity(prePostEnabled = <span style="color:#fff;font-weight:bold">true</span>, jsr250Enabled = <span style="color:#fff;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">class</span> GlobalSecurityConfiguration <span style="color:#fff;font-weight:bold">extends</span> GlobalMethodSecurityConfiguration {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">protected</span> MethodSecurityExpressionHandler createExpressionHandler() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> OAuth2MethodSecurityExpressionHandler();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬åœ¨é…ç½®ç±»ä¸­æ³¨å…¥äº†ä¸Šé¢æˆ‘ä»¬è‡ªå®šä¹‰çš„ OauthUserDetailsService ä»¥åŠç”¨æˆ·å¯†ç éªŒè¯è§„åˆ™ï¼Œæˆ‘ä»¬ä½¿ç”¨ignoring()æ–¹æ³•æ’é™¤äº†HelloWorldControllerå†…çš„å…¬å¼€æ–¹æ³•ï¼Œè¿™é‡Œå¯ä»¥é…ç½®é€šé…ç¬¦çš„å½¢å¼æ’é™¤ã€‚</p>
<h2 id="è‡ªå®šä¹‰401é”™è¯¯ç å†…å®¹">è‡ªå®šä¹‰401é”™è¯¯ç å†…å®¹<a hidden class="anchor" aria-hidden="true" href="#è‡ªå®šä¹‰401é”™è¯¯ç å†…å®¹">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * è‡ªå®šä¹‰401é”™è¯¯ç å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CustomAuthenticationEntryPoint <span style="color:#fff;font-weight:bold">implements</span> AuthenticationEntryPoint {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Logger log = LoggerFactory.<span style="color:#007f7f">getLogger</span>(CustomAuthenticationEntryPoint.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> commence(HttpServletRequest request,
</span></span><span style="display:flex;"><span>                         HttpServletResponse response,
</span></span><span style="display:flex;"><span>                         AuthenticationException ae) <span style="color:#fff;font-weight:bold">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;Pre-authenticated entry point called. Rejecting access&#34;</span>);
</span></span><span style="display:flex;"><span>        response.<span style="color:#007f7f">sendError</span>(HttpServletResponse.<span style="color:#007f7f">SC_UNAUTHORIZED</span>, <span style="color:#0ff;font-weight:bold">&#34;Access Denied&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ç°äº†CustomAuthenticationEntryPointæ¥å£ï¼Œè¯¥ç±»æ˜¯ç”¨æ¥é…ç½®å¦‚æœæ²¡æœ‰æƒé™è®¿é—®æ¥å£æ—¶æˆ‘ä»¬è¿”å›çš„é”™è¯¯ç ä»¥åŠé”™è¯¯å†…å®¹ã€‚</p>
<h2 id="å®šä¹‰ç™»å‡ºæ§åˆ¶">å®šä¹‰ç™»å‡ºæ§åˆ¶<a hidden class="anchor" aria-hidden="true" href="#å®šä¹‰ç™»å‡ºæ§åˆ¶">#</a></h2>
<p>å½“æˆ‘ä»¬é€€å‡ºç³»ç»Ÿæ—¶éœ€è¦è®¿é—®SpringSecrutiyçš„logoutæ–¹æ³•æ¥æ¸…ç©ºå¯¹åº”çš„sessionä¿¡æ¯ï¼Œé‚£æˆ‘ä»¬é€€å‡ºåæ”¹ç”¨æˆ·çš„access_tokenè¿˜ä¾ç„¶å­˜åœ¨é‚£å°±å±é™©äº†ï¼Œä¸€æ—¦åˆ«äººçŸ¥é“è¯¥tokenå°±å¯ä»¥ä½¿ç”¨ä¹‹å‰ç™»å½•ç”¨æˆ·çš„æƒé™æ¥æ“ä½œä¸šåŠ¡ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CustomLogoutSuccessHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">extends</span> AbstractAuthenticationTargetUrlRequestHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">implements</span> LogoutSuccessHandler {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String BEARER_AUTHENTICATION = <span style="color:#0ff;font-weight:bold">&#34;Bearer &#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String HEADER_AUTHORIZATION = <span style="color:#0ff;font-weight:bold">&#34;authorization&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> TokenStore tokenStore;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onLogoutSuccess(HttpServletRequest request,
</span></span><span style="display:flex;"><span>                                HttpServletResponse response,
</span></span><span style="display:flex;"><span>                                Authentication authentication) <span style="color:#fff;font-weight:bold">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>        String token = request.<span style="color:#007f7f">getHeader</span>(HEADER_AUTHORIZATION);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (token != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; token.<span style="color:#007f7f">startsWith</span>(BEARER_AUTHENTICATION)) {
</span></span><span style="display:flex;"><span>            OAuth2AccessToken oAuth2AccessToken = tokenStore.<span style="color:#007f7f">readAccessToken</span>(token.<span style="color:#007f7f">split</span>(<span style="color:#0ff;font-weight:bold">&#34; &#34;</span>)[<span style="color:#ff0;font-weight:bold">0</span>]);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (oAuth2AccessToken != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                tokenStore.<span style="color:#007f7f">removeAccessToken</span>(oAuth2AccessToken);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        response.<span style="color:#007f7f">setStatus</span>(HttpServletResponse.<span style="color:#007f7f">SC_OK</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="é…ç½®èµ„æºæœåŠ¡å™¨">é…ç½®èµ„æºæœåŠ¡å™¨<a hidden class="anchor" aria-hidden="true" href="#é…ç½®èµ„æºæœåŠ¡å™¨">#</a></h2>
<p>åˆ›å»ºä¸€ä¸ªOAuth2æ€»é…ç½®ç±»OAuth2Configurationï¼Œç±»å†…æ·»åŠ ä¸€ä¸ªå­ç±»ç”¨äºé…ç½®èµ„æºæœåŠ¡å™¨ï¼Œå¦ä¸€ä¸ªç”¨äºOAuth2è®¤è¯æœåŠ¡å™¨ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">89
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OAuth2Configuration {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * èµ„æºæœåŠ¡å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Configuration
</span></span><span style="display:flex;"><span>    @EnableResourceServer
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">class</span> ResourceServerConfiguration <span style="color:#fff;font-weight:bold">extends</span> ResourceServerConfigurerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Autowired
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> CustomAuthenticationEntryPoint customAuthenticationEntryPoint;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Autowired
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> CustomLogoutSuccessHandler customLogoutSuccessHandler;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> configure(HttpSecurity http) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            http
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">exceptionHandling</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">authenticationEntryPoint</span>(customAuthenticationEntryPoint)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">and</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">logout</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">logoutUrl</span>(<span style="color:#0ff;font-weight:bold">&#34;/oauth/logout&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">logoutSuccessHandler</span>(customLogoutSuccessHandler)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">and</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">authorizeRequests</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">antMatchers</span>(<span style="color:#0ff;font-weight:bold">&#34;/hello/&#34;</span>).<span style="color:#007f7f">permitAll</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">antMatchers</span>(<span style="color:#0ff;font-weight:bold">&#34;/secure/**&#34;</span>).<span style="color:#007f7f">authenticated</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * OAuth2è®¤è¯æœåŠ¡å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Configuration
</span></span><span style="display:flex;"><span>    @EnableAuthorizationServer
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">class</span> AuthorizationServerConfiguration <span style="color:#fff;font-weight:bold">extends</span> AuthorizationServerConfigurerAdapter{
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å®¢æˆ·ç«¯id
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">private</span> String client_id = <span style="color:#0ff;font-weight:bold">&#34;wjy_client&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å®¢æˆ·ç«¯å¯†é’¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">private</span> String secret = <span style="color:#0ff;font-weight:bold">&#34;wjy_secret&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//tokenè¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">private</span> Integer token_validity_seconds = <span style="color:#ff0;font-weight:bold">1800</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Autowired
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> DataSource dataSource;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//å¦‚æœæƒ³ç”¨rediså­˜å‚¨token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//@Autowired
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//RedisConnectionFactory redisConnectionFactory;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        @Bean
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> TokenStore tokenStore() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> JdbcTokenStore(dataSource);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Autowired
</span></span><span style="display:flex;"><span>        @Qualifier(<span style="color:#0ff;font-weight:bold">&#34;authenticationManagerBean&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> AuthenticationManager authenticationManager;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> configure(AuthorizationServerEndpointsConfigurer endpoints) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            endpoints
</span></span><span style="display:flex;"><span>					<span style="color:#007f7f">//ä½¿ç”¨SpringSecurityOAuth2å†…å®šä¹‰çš„JdbcStoreæ¥æ“ä½œæ•°æ®åº“ä¸­çš„Token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    .<span style="color:#007f7f">tokenStore</span>(tokenStore())
</span></span><span style="display:flex;"><span>					<span style="color:#007f7f">//å¦‚æœæƒ³ç”¨rediså­˜å‚¨tokenï¼Œå°±è¿™ä¹ˆå†™
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#007f7f">//.tokenStore(new RedisTokenStore(redisConnectionFactory))
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    .<span style="color:#007f7f">authenticationManager</span>(authenticationManager);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> configure(ClientDetailsServiceConfigurer clients) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            clients.<span style="color:#007f7f">inMemory</span>().<span style="color:#007f7f">withClient</span>(client_id)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">secret</span>(<span style="color:#fff;font-weight:bold">new</span> BCryptPasswordEncoder().<span style="color:#007f7f">encode</span>(secret))<span style="color:#007f7f">//å°†æ˜æ–‡åŠ å¯†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    .<span style="color:#007f7f">scopes</span>(<span style="color:#0ff;font-weight:bold">&#34;read&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;write&#34;</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">authorities</span>(Authorities.<span style="color:#007f7f">ROLE_ADMIN</span>.<span style="color:#007f7f">name</span>(), Authorities.<span style="color:#007f7f">ROLE_USER</span>.<span style="color:#007f7f">name</span>())
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">authorizedGrantTypes</span>(<span style="color:#0ff;font-weight:bold">&#34;password&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;refresh_token&#34;</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">additionalInformation</span>(<span style="color:#0ff;font-weight:bold">&#34;model&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;test&#34;</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">accessTokenValiditySeconds</span>(token_validity_seconds);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//åŠ å¯†æ–¹å¼æµ‹è¯•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        BCryptPasswordEncoder passwordEncoder = <span style="color:#fff;font-weight:bold">new</span> BCryptPasswordEncoder();
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#fff;font-weight:bold">new</span> BCryptPasswordEncoder().<span style="color:#007f7f">encode</span>(<span style="color:#0ff;font-weight:bold">&#34;123456&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œclient_idå’Œsecretç›´æ¥å†™åœ¨äº†å†…å­˜ä¸­ï¼Œä¹Ÿå¯ä»¥å­˜åœ¨æ•°æ®åº“ä¸­ã€‚</p>
<h2 id="é…ç½®æ§åˆ¶å™¨controller">é…ç½®æ§åˆ¶å™¨ï¼ˆControllerï¼‰<a hidden class="anchor" aria-hidden="true" href="#é…ç½®æ§åˆ¶å™¨controller">#</a></h2>
<p>ä¸‹é¢æˆ‘ä»¬æ¥é…ç½®ä¸¤ä¸ªæ§åˆ¶å™¨ç”¨æ¥åŒºåˆ†æˆ‘ä»¬é…ç½®OAuth2æ˜¯å¦ç”Ÿæ•ˆã€‚
æˆ‘åœ¨HelloWorldControllerå†…åªæ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²çš„è¾“å‡ºï¼Œè¿™ä¸ªæ§åˆ¶å™¨æˆ‘ä»¬å¼€æ”¾ï¼Œè®©SpringSecurityä¸å»ç®¡ç†ï¼Œé…ç½®å°†ä¼šåœ¨ä¸‹é¢å±•ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span>@RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/hello&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HelloWorldController {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @RequestMapping(method = RequestMethod.<span style="color:#007f7f">GET</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String sayHello() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Hello User!&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>SecureControllerè¿™ä¸ªæ§åˆ¶å™¨æ˜¯éœ€è¦æˆ‘ä»¬è·å–æˆæƒTokenåä½¿ç”¨Tokenæ‰å¯ä»¥è®¿é—®åˆ°çš„ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span>@RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/secure&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecureController {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RequestMapping(method = RequestMethod.<span style="color:#007f7f">GET</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String sayHello() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Secure Hello!&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æµ‹è¯•">æµ‹è¯•<a hidden class="anchor" aria-hidden="true" href="#æµ‹è¯•">#</a></h2>
<p>å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨postManè¿›è¡Œæµ‹è¯•ã€‚
å…ˆè®¿é—®å…¬å¼€çš„æ¥å£åœ°å€ï¼š
<code>http://127.0.0.1:8080/hello</code></p>
<p>å¾—åˆ°æ¥å£æ­£ç¡®çš„è¿”å›å†…å®¹ï¼š
<code>Hello User!</code></p>
<p>ç»§ç»­éªŒè¯è®¿é—®å—é™çš„æ¥å£ï¼š
<code>127.0.0.1:8080/secure</code></p>
<p>å¾—åˆ°è¿”å›å†…å®¹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    &#34;timestamp&#34;: &#34;2021-03-24T09:07:28.276+0000&#34;,
</span></span><span style="display:flex;"><span>    &#34;status&#34;: 401,
</span></span><span style="display:flex;"><span>    &#34;error&#34;: &#34;Unauthorized&#34;,
</span></span><span style="display:flex;"><span>    &#34;message&#34;: &#34;Access Denied&#34;,
</span></span><span style="display:flex;"><span>    &#34;path&#34;: &#34;/secure&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­£å¦‚æˆ‘ä»¬é¢„æœŸä¸€æ ·ï¼Œè¿”å›äº†401é”™è¯¯ä»¥åŠæˆ‘ä»¬è‡ªå®šä¹‰çš„é”™è¯¯ç â€Access Deniedâ€œ
å¦‚æœè¿”å›çš„æ˜¯ä¸€äº›htmlï¼Œé‚£ä¹ˆéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>security:
</span></span><span style="display:flex;"><span>  oauth2:
</span></span><span style="display:flex;"><span>    resource:
</span></span><span style="display:flex;"><span>      filter-order: 3
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªé…ç½®å°†æˆ‘ä»¬çš„èµ„æºæ‹¦æˆªçš„è¿‡æ»¤å™¨è¿è¡Œé¡ºåºæ”¾åˆ°ç¬¬3ä¸ªæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯åœ¨oauth2çš„è®¤è¯æœåŠ¡å™¨åé¢æ‰§è¡Œã€‚</p>
<h3 id="è·å–accesstoken">è·å–AccessToken<a hidden class="anchor" aria-hidden="true" href="#è·å–accesstoken">#</a></h3>
<p>è·å–tokenä¹‹å‰éœ€è¦åœ¨æ•°æ®åº“ä¸­æ·»åŠ ç”¨æˆ·æ•°æ®ã€‚ç„¶åè®¿é—®
<code>http://localhost:8080/oauth/token?username=admin&amp;password=123456&amp;grant_type=password</code></p>
<p>æ³¨æ„ï¼šå‚æ•°åä¸èƒ½æ”¹å˜ã€‚
usernameï¼šæ•°æ®åº“ä¸­çš„usernameã€‚
passwordï¼šæ•°æ®åº“ä¸­çš„passwordã€‚
grant_typeï¼šæˆæƒç±»å‹ï¼Œè¿™é‡Œé»˜è®¤password</p>
<p>è¿˜éœ€è¦åœ¨postMançš„<code>Auth</code>ä¸€æ ï¼Œtypeé€‰æ‹©<code>Basic Auth</code>ï¼Œç„¶ååœ¨ä¸‹é¢å¡«å…¥æˆ‘ä»¬åœ¨å†…å­˜ä¸­é…ç½®çš„client_idå’Œclient_secretã€‚
è¯·æ±‚æˆåŠŸè¿”å›ç»“æœï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    &#34;access_token&#34;: &#34;b2911fcc-a969-4f2d-843d-dc8cb9be3c85&#34;,
</span></span><span style="display:flex;"><span>    &#34;token_type&#34;: &#34;bearer&#34;,
</span></span><span style="display:flex;"><span>    &#34;refresh_token&#34;: &#34;889b1731-19a0-4f05-b5d5-2ee996ba1f1c&#34;,
</span></span><span style="display:flex;"><span>    &#34;expires_in&#34;: 840,
</span></span><span style="display:flex;"><span>    &#34;scope&#34;: &#34;read write&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>access_tokenï¼šæœ¬åœ°è®¿é—®è·å–åˆ°çš„access_tokenï¼Œä¼šè‡ªåŠ¨å†™å…¥åˆ°æ•°æ®åº“ä¸­ã€‚
token_typeï¼šè·å–åˆ°çš„access_tokençš„æˆæƒæ–¹å¼
refersh_tokenï¼šåˆ·æ–°tokenæ—¶æ‰€ç”¨åˆ°çš„æˆæƒtoken
expires_inï¼šæœ‰æ•ˆæœŸï¼ˆä»è·å–å¼€å§‹è®¡æ—¶ï¼Œå€¼ç§’åè¿‡æœŸï¼‰
scopeï¼šå®¢æˆ·ç«¯çš„æ¥å£æ“ä½œæƒé™ï¼ˆreadï¼šè¯»ï¼Œwriteï¼šå†™ï¼‰</p>
<h3 id="ä½¿ç”¨access_tokenè®¿é—®æ•°æ®">ä½¿ç”¨access_tokenè®¿é—®æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨access_tokenè®¿é—®æ•°æ®">#</a></h3>
<p>è·å¾—access_tokenä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨access_tokenè®¿é—®åˆšæ‰å—é™çš„æ¥å£äº†ã€‚
<code>http://127.0.0.1:8080/secure?access_token=b2911fcc-a969-4f2d-843d-dc8cb9be3c85</code></p>
<p><code>Secure Hello!</code>
å¯ä»¥çœ‹åˆ°å·²ç»å¯ä»¥æ­£å¸¸è®¿é—®å—é™çš„æ¥å£äº†ï¼Œè¯æ˜æˆ‘ä»¬çš„access_tokenæ˜¯æœ‰æ•ˆçš„ã€‚
access_tokenè¿‡æœŸåï¼Œä¼šè¿”å›å¦‚ä¸‹å†…å®¹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    &#34;error&#34;: &#34;invalid_token&#34;,
</span></span><span style="display:flex;"><span>    &#34;error_description&#34;: &#34;Invalid access token: b2911fcc-a969-4f2d-843d-dc8cb9be3c85&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>access_tokenè¿‡æœŸäº†ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡æ¥å£æ¥åˆ·æ–°access_tokenã€‚</p>
<h3 id="åˆ·æ–°accesstoken">åˆ·æ–°AccessToken<a hidden class="anchor" aria-hidden="true" href="#åˆ·æ–°accesstoken">#</a></h3>
<p><code>http://localhost:8080/oauth/token?grant_type=refresh_token&amp;refresh_token=889b1731-19a0-4f05-b5d5-2ee996ba1f1c</code></p>
<p>grant_typeï¼šæˆæƒç±»å‹ï¼Œæ­¤æ—¶å¡«å†™refresh_token
refresh_tokenï¼šæ˜¯æˆ‘ä»¬è·å–access_tokenæ—¶ï¼Œæ¥å£è¿”å›çš„refresh_tokenï¼Œéœ€è¦ç”¨åˆ°è¯¥å€¼æ¥åˆ·æ–°tokenã€‚
æ–°çš„tokenå€¼å¾—æœ‰æ•ˆæœŸå¯ä»¥çœ‹åˆ°åˆæ˜¯æˆ‘ä»¬é…ç½®çš„é»˜è®¤1800ç§’ï¼Œåˆ·æ–°tokenæ—¶oauth2è¿˜æ˜¯ç»™æˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªrefersh_tokenå€¼ï¼Œè¯¥å€¼è¦ä½œä¸ºä¸‹æ¬¡åˆ·æ–°tokenæ—¶ä½¿ç”¨ã€‚</p>
<p><a href="https://www.jianshu.com/p/ded9dc32f550">å‚è€ƒ</a>
<a href="https://gitee.com/hengboy/spring-boot-chapter/tree/1.x/">æºç </a>
<a href="https://blog.csdn.net/qq_42495847/article/details/107991361">spring-data-jpaå­¦ä¹ </a>
<a href="https://lexburner.github.io/categories/Spring-Security-OAuth2/">å…¶ä»–å‚è€ƒ</a>
<a href="https://blog.csdn.net/a624193873/article/details/106417218/">å‚è€ƒ</a></p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/java/">java</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%85%B6%E4%BB%96/jrebel/">
    <span class="title">Â« Prev</span>
    <br>
    <span>JRebel</span>
  </a>
  <a class="next" href="https://funny-toffee-4aa7c3.netlify.app/posts/spring/spring-boot/">
    <span class="title">Next Â»</span>
    <br>
    <span>spring boot</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>