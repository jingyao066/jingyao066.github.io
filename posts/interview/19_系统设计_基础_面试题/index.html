<!DOCTYPE html>
<html lang="en" dir="auto">

<head>
    
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://009965.xyz/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://009965.xyz/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://009965.xyz/">Home</a>&nbsp;»&nbsp;<a href="https://009965.xyz/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      19_系统设计_基础_面试题
    </h1>
    <div class="post-meta"><span title='2023-08-01 05:00:00 +0000 UTC'>2023-08-01</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#restful-api-%e7%ae%80%e6%98%8e%e6%95%99%e7%a8%8b" aria-label="RestFul API 简明教程">RestFul API 简明教程</a><ul>
                        
                <li>
                    <a href="#%e4%bd%95%e4%b8%ba-api" aria-label="何为 API？">何为 API？</a></li>
                <li>
                    <a href="#%e4%bd%95%e4%b8%ba-restful-api" aria-label="何为 RESTful API？">何为 RESTful API？</a></li>
                <li>
                    <a href="#%e8%a7%a3%e8%af%bb-rest" aria-label="解读 REST">解读 REST</a></li>
                <li>
                    <a href="#restful-api-%e8%a7%84%e8%8c%83" aria-label="RESTful API 规范">RESTful API 规范</a><ul>
                        
                <li>
                    <a href="#%e5%8a%a8%e4%bd%9c" aria-label="动作">动作</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%b7%af%e5%be%84%e6%8e%a5%e5%8f%a3%e5%91%bd%e5%90%8d" aria-label="路径（接口命名）">路径（接口命名）</a></li>
                <li>
                    <a href="#%e8%bf%87%e6%bb%a4%e4%bf%a1%e6%81%affiltering" aria-label="过滤信息（Filtering）">过滤信息（Filtering）</a></li>
                <li>
                    <a href="#%e7%8a%b6%e6%80%81%e7%a0%81status-codes" aria-label="状态码（Status Codes）">状态码（Status Codes）</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%bd%af%e4%bb%b6%e5%b7%a5%e7%a8%8b%e7%ae%80%e6%98%8e%e6%95%99%e7%a8%8b" aria-label="软件工程简明教程">软件工程简明教程</a><ul>
                        
                <li>
                    <a href="#%e4%bd%95%e4%b8%ba%e8%bd%af%e4%bb%b6%e5%b7%a5%e7%a8%8b" aria-label="何为软件工程？">何为软件工程？</a></li>
                <li>
                    <a href="#%e8%bd%af%e4%bb%b6%e5%bc%80%e5%8f%91%e8%bf%87%e7%a8%8b" aria-label="软件开发过程">软件开发过程</a></li>
                <li>
                    <a href="#%e8%bd%af%e4%bb%b6%e5%bc%80%e5%8f%91%e6%a8%a1%e5%9e%8b" aria-label="软件开发模型">软件开发模型</a></li>
                <li>
                    <a href="#%e8%bd%af%e4%bb%b6%e5%bc%80%e5%8f%91%e7%9a%84%e5%9f%ba%e6%9c%ac%e7%ad%96%e7%95%a5" aria-label="软件开发的基本策略">软件开发的基本策略</a><ul>
                        
                <li>
                    <a href="#%e8%bd%af%e4%bb%b6%e5%a4%8d%e7%94%a8" aria-label="软件复用">软件复用</a></li>
                <li>
                    <a href="#%e5%88%86%e8%80%8c%e6%b2%bb%e4%b9%8b" aria-label="分而治之">分而治之</a></li>
                <li>
                    <a href="#%e9%80%90%e6%ad%a5%e6%bc%94%e8%bf%9b" aria-label="逐步演进">逐步演进</a></li>
                <li>
                    <a href="#%e4%bc%98%e5%8c%96%e6%8a%98%e4%b8%ad" aria-label="优化折中">优化折中</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%91%bd%e5%90%8d%e6%8c%87%e5%8d%97" aria-label="命名指南">命名指南</a><ul>
                        
                <li>
                    <a href="#%e5%b8%b8%e8%a7%81%e5%91%bd%e5%90%8d%e8%a7%84%e5%88%99%e4%bb%a5%e5%8f%8a%e9%80%82%e7%94%a8%e5%9c%ba%e6%99%af" aria-label="常见命名规则以及适用场景">常见命名规则以及适用场景</a><ul>
                        
                <li>
                    <a href="#%e9%a9%bc%e5%b3%b0%e5%91%bd%e5%90%8d%e6%b3%95camelcase" aria-label="驼峰命名法（CamelCase）">驼峰命名法（CamelCase）</a><ul>
                        
                <li>
                    <a href="#%e9%a9%bc%e5%b3%b0%e5%91%bd%e5%90%8d%e6%b3%95uppercamelcase" aria-label="驼峰命名法（UpperCamelCase）">驼峰命名法（UpperCamelCase）</a></li>
                <li>
                    <a href="#%e9%a9%bc%e5%b3%b0%e5%91%bd%e5%90%8d%e6%b3%95lowercamelcase" aria-label="驼峰命名法（lowerCamelCase）">驼峰命名法（lowerCamelCase）</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%9b%87%e5%bd%a2%e5%91%bd%e5%90%8d%e6%b3%95snake_case" aria-label="蛇形命名法（snake_case）">蛇形命名法（snake_case）</a></li>
                <li>
                    <a href="#%e4%b8%b2%e5%bc%8f%e5%91%bd%e5%90%8d%e6%b3%95kebab-case" aria-label="串式命名法（kebab-case）">串式命名法（kebab-case）</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b8%b8%e8%a7%81%e5%91%bd%e5%90%8d%e8%a7%84%e8%8c%83" aria-label="常见命名规范">常见命名规范</a><ul>
                        
                <li>
                    <a href="#java-%e8%af%ad%e8%a8%80%e5%9f%ba%e6%9c%ac%e5%91%bd%e5%90%8d%e8%a7%84%e8%8c%83" aria-label="Java 语言基本命名规范">Java 语言基本命名规范</a></li>
                <li>
                    <a href="#%e5%91%bd%e5%90%8d%e6%98%93%e8%af%bb%e6%80%a7%e8%a7%84%e8%8c%83" aria-label="命名易读性规范">命名易读性规范</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e9%87%8d%e6%9e%84" aria-label="代码重构">代码重构</a><ul>
                        
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e9%87%8d%e6%9e%84" aria-label="为什么要重构？">为什么要重构？</a></li>
                <li>
                    <a href="#%e4%bd%95%e6%97%b6%e8%bf%9b%e8%a1%8c%e9%87%8d%e6%9e%84" aria-label="何时进行重构？">何时进行重构？</a><ul>
                        
                <li>
                    <a href="#%e6%8f%90%e4%ba%a4%e4%bb%a3%e7%a0%81%e4%b9%8b%e5%89%8d" aria-label="提交代码之前">提交代码之前</a></li>
                <li>
                    <a href="#%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aa%e6%96%b0%e5%8a%9f%e8%83%bd%e4%b9%8b%e5%90%8e%e4%b9%8b%e5%89%8d" aria-label="开发一个新功能之后&amp;之前">开发一个新功能之后&amp;之前</a></li>
                <li>
                    <a href="#code-review-%e4%b9%8b%e5%90%8e" aria-label="Code Review 之后">Code Review 之后</a></li>
                <li>
                    <a href="#%e6%8d%a1%e5%9e%83%e5%9c%be%e5%bc%8f%e9%87%8d%e6%9e%84" aria-label="捡垃圾式重构">捡垃圾式重构</a></li>
                <li>
                    <a href="#%e6%8d%a1%e5%9e%83%e5%9c%be%e5%bc%8f%e9%87%8d%e6%9e%84-1" aria-label="捡垃圾式重构">捡垃圾式重构</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%87%8d%e6%9e%84%e6%9c%89%e5%93%aa%e4%ba%9b%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" aria-label="重构有哪些注意事项？">重构有哪些注意事项？</a><ul>
                        
                <li>
                    <a href="#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e6%98%af%e9%87%8d%e6%9e%84%e7%9a%84%e4%bf%9d%e6%8a%a4%e7%bd%91" aria-label="单元测试是重构的保护网">单元测试是重构的保护网</a></li>
                <li>
                    <a href="#%e4%b8%8d%e8%a6%81%e4%b8%ba%e4%ba%86%e9%87%8d%e6%9e%84%e8%80%8c%e9%87%8d%e6%9e%84" aria-label="不要为了重构而重构">不要为了重构而重构</a></li>
                <li>
                    <a href="#%e9%81%b5%e5%be%aa%e6%96%b9%e6%b3%95" aria-label="遵循方法">遵循方法</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e7%bb%83%e4%b9%a0%e9%87%8d%e6%9e%84" aria-label="如何练习重构？">如何练习重构？</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e6%8c%87%e5%8d%97" aria-label="单元测试指南">单元测试指南</a><ul>
                        
                <li>
                    <a href="#%e4%bd%95%e8%b0%93%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95" aria-label="何谓单元测试？">何谓单元测试？</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95" aria-label="为什么需要单元测试？">为什么需要单元测试？</a><ul>
                        
                <li>
                    <a href="#%e4%b8%ba%e9%87%8d%e6%9e%84%e4%bf%9d%e9%a9%be%e6%8a%a4%e8%88%aa" aria-label="为重构保驾护航">为重构保驾护航</a></li>
                <li>
                    <a href="#%e6%8f%90%e9%ab%98%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f" aria-label="提高代码质量">提高代码质量</a></li>
                <li>
                    <a href="#%e5%87%8f%e5%b0%91-bug" aria-label="减少 bug">减少 bug</a></li>
                <li>
                    <a href="#%e5%bf%ab%e9%80%9f%e5%ae%9a%e4%bd%8d-bug" aria-label="快速定位 bug">快速定位 bug</a></li>
                <li>
                    <a href="#%e6%8c%81%e7%bb%ad%e9%9b%86%e6%88%90%e4%be%9d%e8%b5%96%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95" aria-label="持续集成依赖单元测试">持续集成依赖单元测试</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%b0%81%e9%80%bc%e4%bd%a0%e5%86%99%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95" aria-label="谁逼你写单元测试？">谁逼你写单元测试？</a><ul>
                        
                <li>
                    <a href="#%e9%a2%86%e5%af%bc%e8%a6%81%e6%b1%82" aria-label="领导要求">领导要求</a></li>
                <li>
                    <a href="#%e5%a4%a7%e7%89%9b%e9%83%bd%e5%86%99%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95" aria-label="大牛都写单元测试">大牛都写单元测试</a></li>
                <li>
                    <a href="#%e4%bf%9d%e4%bd%8f%e9%9d%a2%e5%ad%90" aria-label="保住面子">保住面子</a></li>
                <li>
                    <a href="#%e5%bf%83%e8%99%9a" aria-label="心虚">心虚</a></li></ul>
                </li>
                <li>
                    <a href="#tdd-%e6%b5%8b%e8%af%95%e9%a9%b1%e5%8a%a8%e5%bc%80%e5%8f%91" aria-label="TDD 测试驱动开发">TDD 测试驱动开发</a><ul>
                        
                <li>
                    <a href="#%e4%bd%95%e8%b0%93-tdd" aria-label="何谓 TDD？">何谓 TDD？</a></li>
                <li>
                    <a href="#tdd-%e4%bc%98%e7%bc%ba%e7%82%b9%e5%88%86%e6%9e%90" aria-label="TDD 优缺点分析">TDD 优缺点分析</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8d%95%e6%b5%8b%e6%a1%86%e6%9e%b6%e5%a6%82%e4%bd%95%e9%80%89%e6%8b%a9" aria-label="单测框架如何选择？">单测框架如何选择？</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li></ul>
                </li>
                <li>
                    <a href="#java-%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1%e8%af%a6%e8%a7%a3" aria-label="Java 定时任务详解">Java 定时任务详解</a><ul>
                        
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1" aria-label="为什么需要定时任务？">为什么需要定时任务？</a></li>
                <li>
                    <a href="#%e5%8d%95%e6%9c%ba%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1%e6%8a%80%e6%9c%af%e9%80%89%e5%9e%8b" aria-label="单机定时任务技术选型">单机定时任务技术选型</a><ul>
                        
                <li>
                    <a href="#timer" aria-label="Timer">Timer</a></li>
                <li>
                    <a href="#scheduledexecutorservice" aria-label="ScheduledExecutorService">ScheduledExecutorService</a></li>
                <li>
                    <a href="#spring-task" aria-label="Spring Task">Spring Task</a></li>
                <li>
                    <a href="#%e6%97%b6%e9%97%b4%e8%bd%ae" aria-label="时间轮">时间轮</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1%e6%8a%80%e6%9c%af%e9%80%89%e5%9e%8b" aria-label="分布式定时任务技术选型">分布式定时任务技术选型</a><ul>
                        
                <li>
                    <a href="#quartz" aria-label="Quartz">Quartz</a></li>
                <li>
                    <a href="#elastic-job" aria-label="Elastic-Job">Elastic-Job</a></li>
                <li>
                    <a href="#xxl-job" aria-label="XXL-JOB">XXL-JOB</a></li>
                <li>
                    <a href="#powerjob" aria-label="PowerJob">PowerJob</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-1" aria-label="总结">总结</a></li></ul>
                </li>
                <li>
                    <a href="#web-%e5%ae%9e%e6%97%b6%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81%e8%af%a6%e8%a7%a3" aria-label="Web 实时消息推送详解">Web 实时消息推送详解</a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81" aria-label="什么是消息推送？">什么是消息推送？</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81%e5%b8%b8%e8%a7%81%e6%96%b9%e6%a1%88" aria-label="消息推送常见方案">消息推送常见方案</a><ul>
                        
                <li>
                    <a href="#%e7%9f%ad%e8%bd%ae%e8%af%a2" aria-label="短轮询">短轮询</a></li>
                <li>
                    <a href="#%e9%95%bf%e8%bd%ae%e8%af%a2" aria-label="长轮询">长轮询</a></li>
                <li>
                    <a href="#iframe-%e6%b5%81" aria-label="iframe 流">iframe 流</a></li>
                <li>
                    <a href="#sse" aria-label="SSE">SSE</a></li>
                <li>
                    <a href="#websocket" aria-label="Websocket">Websocket</a></li>
                <li>
                    <a href="#mqtt" aria-label="MQTT">MQTT</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-2" aria-label="总结">总结</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="restful-api-简明教程">RestFul API 简明教程<a hidden class="anchor" aria-hidden="true" href="#restful-api-简明教程">#</a></h1>
<h2 id="何为-api">何为 API？<a hidden class="anchor" aria-hidden="true" href="#何为-api">#</a></h2>
<p><strong>API（Application Programming Interface）</strong> 翻译过来是应用程序编程接口的意思。</p>
<p>我们在进行后端开发的时候，主要的工作就是为前端或者其他后端服务提供 API 比如查询用户数据的 API 。</p>
<p>但是， API 不仅仅代表后端系统暴露的接口，像框架中提供的方法也属于 API 的范畴。</p>
<p>为了方便大家理解，我再列举几个例子 🌰：</p>
<ol>
<li>你通过某电商网站搜索某某商品，电商网站的前端就调用了后端提供了搜索商品相关的 API。</li>
<li>你使用 JDK 开发 Java 程序，想要读取用户的输入的话，你就需要使用 JDK 提供的 IO 相关的 API。</li>
<li>&hellip;&hellip;</li>
</ol>
<p>你可以把 API 理解为程序与程序之间通信的桥梁，其本质就是一个函数而已。另外，API 的使用也不是没有章法的，它的规则由（比如数据输入和输出的格式）API 提供方制定。</p>
<h2 id="何为-restful-api">何为 RESTful API？<a hidden class="anchor" aria-hidden="true" href="#何为-restful-api">#</a></h2>
<p><strong>RESTful API</strong> 经常也被叫做 <strong>REST API</strong>，它是基于 REST 构建的 API。这个 REST 到底是什么，我们后文在讲，涉及到的概念比较多。</p>
<p>如果你看 RESTful API 相关的文章的话一般都比较晦涩难懂，主要是因为 REST 涉及到的一些概念比较难以理解。但是，实际上，我们平时开发用到的 RESTful API 的知识非常简单也很容易概括！</p>
<p>举个例子，如果我给你下面两个 API 你是不是立马能知道它们是干什么用的！这就是 RESTful API 的强大之处！</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>GET    /classes：列出所有班级
</span></span><span style="display:flex;"><span>POST   /classes：新建一个班级
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>RESTful API 可以让你看到 URL+Http Method 就知道这个 URL 是干什么的，让你看到了 HTTP 状态码（status code）就知道请求结果如何。</strong></p>
<p>像咱们在开发过程中设计 API 的时候也应该至少要满足 RESTful API 的最基本的要求（比如接口中尽量使用名词，使用 <code>POST</code> 请求创建资源，<code>DELETE</code> 请求删除资源等等，示例：<code>GET /notes/id</code>：获取某个指定 id 的笔记的信息）。</p>
<h2 id="解读-rest">解读 REST<a hidden class="anchor" aria-hidden="true" href="#解读-rest">#</a></h2>
<p><strong>REST</strong> 是 <code>REpresentational State Transfer</code> 的缩写。这个词组的翻译过来就是“<strong>表现层状态转化</strong>”。</p>
<p>这样理解起来甚是晦涩，实际上 REST 的全称是 <strong>Resource Representational State Transfer</strong> ，直白地翻译过来就是 <strong>“资源”在网络传输中以某种“表现形式”进行“状态转移”</strong> 。如果还是不能继续理解，请继续往下看，相信下面的讲解一定能让你理解到底啥是 REST 。</p>
<p>我们分别对上面涉及到的概念进行解读，以便加深理解，实际上你不需要搞懂下面这些概念，也能看懂我下一部分要介绍到的内容。不过，为了更好地能跟别人扯扯 “RESTful API”我建议你还是要好好理解一下！</p>
<ul>
<li><strong>资源（Resource）</strong>：我们可以把真实的对象数据称为资源。一个资源既可以是一个集合，也可以是单个个体。比如我们的班级 classes 是代表一个集合形式的资源，而特定的 class 代表单个个体资源。每一种资源都有特定的 URI（统一资源标识符）与之对应，如果我们需要获取这个资源，访问这个 URI 就可以了，比如获取特定的班级：<code>/class/12</code>。另外，资源也可以包含子资源，比如 <code>/classes/classId/teachers</code>：列出某个指定班级的所有老师的信息</li>
<li><strong>表现形式（Representational）</strong>：&ldquo;资源&quot;是一种信息实体，它可以有多种外在表现形式。我们把&quot;资源&quot;具体呈现出来的形式比如 <code>json</code>，<code>xml</code>，<code>image</code>,<code>txt</code> 等等叫做它的&quot;表现层/表现形式&rdquo;。</li>
<li><strong>状态转移（State Transfer）</strong>：大家第一眼看到这个词语一定会很懵逼？内心 BB：这尼玛是啥啊？ 大白话来说 REST 中的状态转移更多地描述的服务器端资源的状态，比如你通过增删改查（通过 HTTP 动词实现）引起资源状态的改变。ps:互联网通信协议 HTTP 协议，是一个无状态协议，所有的资源状态都保存在服务器端。</li>
</ul>
<p>综合上面的解释，我们总结一下什么是 RESTful 架构：</p>
<ol>
<li>每一个 URI 代表一种资源；</li>
<li>客户端和服务器之间，传递这种资源的某种表现形式比如 <code>json</code>，<code>xml</code>，<code>image</code>,<code>txt</code> 等等；</li>
<li>客户端通过特定的 HTTP 动词，对服务器端资源进行操作，实现&quot;表现层状态转化&quot;。</li>
</ol>
<h2 id="restful-api-规范">RESTful API 规范<a hidden class="anchor" aria-hidden="true" href="#restful-api-规范">#</a></h2>
<h3 id="动作">动作<a hidden class="anchor" aria-hidden="true" href="#动作">#</a></h3>
<ul>
<li><code>GET</code>：请求从服务器获取特定资源。举个例子：<code>GET /classes</code>（获取所有班级）</li>
<li><code>POST</code>：在服务器上创建一个新的资源。举个例子：<code>POST /classes</code>（创建班级）</li>
<li><code>PUT</code>：更新服务器上的资源（客户端提供更新后的整个资源）。举个例子：<code>PUT /classes/12</code>（更新编号为 12 的班级）</li>
<li><code>DELETE</code>：从服务器删除特定的资源。举个例子：<code>DELETE /classes/12</code>（删除编号为 12 的班级）</li>
<li><code>PATCH</code>：更新服务器上的资源（客户端提供更改的属性，可以看做作是部分更新），使用的比较少，这里就不举例子了。</li>
</ul>
<h2 id="路径接口命名">路径（接口命名）<a hidden class="anchor" aria-hidden="true" href="#路径接口命名">#</a></h2>
<p>路径又称&quot;终点&quot;（endpoint），表示 API 的具体网址。实际开发中常见的规范如下：</p>
<ol>
<li><strong>网址中不能有动词，只能有名词，API 中的名词也应该使用复数。</strong> 因为 REST 中的资源往往和数据库中的表对应，而数据库中的表都是同种记录的&quot;集合&quot;（collection）。如果 API 调用并不涉及资源（如计算，翻译等操作）的话，可以用动词。比如：<code>GET /calculate?param1=11&amp;param2=33</code> 。</li>
<li><strong>不用大写字母，建议用中杠 - 不用下杠 _</strong> 。比如邀请码写成 <code>invitation-code</code>而不是 invitation_code 。</li>
<li><strong>善用版本化 API</strong>。当我们的 API 发生了重大改变而不兼容前期版本的时候，我们可以通过 URL 来实现版本化，比如 <code>http://api.example.com/v1</code>、<code>http://apiv1.example.com</code> 。版本不必非要是数字，只是数字用的最多，日期、季节都可以作为版本标识符，项目团队达成共识就可。</li>
<li><strong>接口尽量使用名词，避免使用动词。</strong> RESTful API 操作（HTTP Method）的是资源（名词）而不是动作（动词）。</li>
</ol>
<p>Talk is cheap！来举个实际的例子来说明一下吧！现在有这样一个 API 提供班级（class）的信息，还包括班级中的学生和教师的信息，则它的路径应该设计成下面这样。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>GET    /classes：列出所有班级
</span></span><span style="display:flex;"><span>POST   /classes：新建一个班级
</span></span><span style="display:flex;"><span>GET    /classes/{classId}：获取某个指定班级的信息
</span></span><span style="display:flex;"><span>PUT    /classes/{classId}：更新某个指定班级的信息（一般倾向整体更新）
</span></span><span style="display:flex;"><span>PATCH  /classes/{classId}：更新某个指定班级的信息（一般倾向部分更新）
</span></span><span style="display:flex;"><span>DELETE /classes/{classId}：删除某个班级
</span></span><span style="display:flex;"><span>GET    /classes/{classId}/teachers：列出某个指定班级的所有老师的信息
</span></span><span style="display:flex;"><span>GET    /classes/{classId}/students：列出某个指定班级的所有学生的信息
</span></span><span style="display:flex;"><span>DELETE /classes/{classId}/teachers/{ID}：删除某个指定班级下的指定的老师的信息
</span></span></code></pre></td></tr></table>
</div>
</div><p>反例：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>/getAllclasses
</span></span><span style="display:flex;"><span>/createNewclass
</span></span><span style="display:flex;"><span>/deleteAllActiveclasses
</span></span></code></pre></td></tr></table>
</div>
</div><p>理清资源的层次结构，比如业务针对的范围是学校，那么学校会是一级资源:<code>/schools</code>，老师: <code>/schools/teachers</code>，学生: <code>/schools/students</code> 就是二级资源。</p>
<h2 id="过滤信息filtering">过滤信息（Filtering）<a hidden class="anchor" aria-hidden="true" href="#过滤信息filtering">#</a></h2>
<p>如果我们在查询的时候需要添加特定条件的话，建议使用 url 参数的形式。比如我们要查询 state 状态为 active 并且 name 为 guidegege 的班级：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>GET    /classes?state=active&amp;name=guidegege
</span></span></code></pre></td></tr></table>
</div>
</div><p>比如我们要实现分页查询：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>GET    /classes?page=1&amp;size=10 //指定第1页，每页10个数据
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="状态码status-codes">状态码（Status Codes）<a hidden class="anchor" aria-hidden="true" href="#状态码status-codes">#</a></h2>
<p><strong>状态码范围：</strong></p>
<table>
<thead>
<tr>
<th>2xx：成功</th>
<th>3xx：重定向</th>
<th>4xx：客户端错误</th>
<th>5xx：服务器错误</th>
</tr>
</thead>
<tbody>
<tr>
<td>200 成功</td>
<td>301 永久重定向</td>
<td>400 参数错误</td>
<td>500 服务器错误</td>
</tr>
<tr>
<td>201 创建</td>
<td>304 资源未修改</td>
<td>401 未授权</td>
<td>502 网关错误</td>
</tr>
<tr>
<td></td>
<td></td>
<td>403 禁止访问</td>
<td>504 网关超时</td>
</tr>
<tr>
<td></td>
<td></td>
<td>404 未找到</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>405 请求方法不对</td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="软件工程简明教程">软件工程简明教程<a hidden class="anchor" aria-hidden="true" href="#软件工程简明教程">#</a></h1>
<h2 id="何为软件工程">何为软件工程？<a hidden class="anchor" aria-hidden="true" href="#何为软件工程">#</a></h2>
<p>1968 年 NATO（北大西洋公约组织）提出了<strong>软件危机</strong>（<strong>Software crisis</strong>）一词。同年，为了解决软件危机问题，“<strong>软件工程</strong>”的概念诞生了。一门叫做软件工程的学科也就应运而生。</p>
<p>随着时间的推移，软件工程这门学科也经历了一轮又一轮的完善，其中的一些核心内容比如软件开发模型越来越丰富实用！</p>
<p><strong>什么是软件危机呢？</strong></p>
<p>简单来说，软件危机描述了当时软件开发的一个痛点：我们很难高效地开发出质量高的软件。</p>
<p>Dijkstra（Dijkstra 算法的作者） 在 1972 年图灵奖获奖感言中也提高过软件危机，他是这样说的：“导致软件危机的主要原因是机器变得功能强大了几个数量级！坦率地说：只要没有机器，编程就完全没有问题。当我们有一些弱小的计算机时，编程成为一个温和的问题，而现在我们有了庞大的计算机，编程也同样成为一个巨大的问题”。</p>
<p><strong>说了这么多，到底什么是软件工程呢？</strong></p>
<p>工程是为了解决实际的问题将理论应用于实践。软件工程指的就是将工程思想应用于软件开发。</p>
<p>上面是我对软件工程的定义，我们再来看看比较权威的定义。IEEE 软件工程汇刊给出的定义是这样的：　(1)将系统化的、规范的、可量化的方法应用到软件的开发、运行及维护中，即将工程化方法应用于软件。　(2)在(1)中所述方法的研究。</p>
<p>总之，软件工程的终极目标就是：<strong>在更少资源消耗的情况下，创造出更好、更容易维护的软件。</strong></p>
<h2 id="软件开发过程">软件开发过程<a hidden class="anchor" aria-hidden="true" href="#软件开发过程">#</a></h2>
<p><a href="https://zh.wikipedia.org/wiki/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B">维基百科是这样定义软件开发过程</a>的：</p>
<blockquote>
<p>软件开发过程（英语：software development process），或软件过程（英语：software process），是软件开发的开发生命周期（software development life cycle），其各个阶段实现了软件的需求定义与分析、设计、实现、测试、交付和维护。软件过程是在开发与构建系统时应遵循的步骤，是软件开发的路线图。</p>
</blockquote>
<ul>
<li>需求分析：分析用户的需求，建立逻辑模型。</li>
<li>软件设计：根据需求分析的结果对软件架构进行设计。</li>
<li>编码：编写程序运行的源代码。</li>
<li>测试 : 确定测试用例，编写测试报告。</li>
<li>交付：将做好的软件交付给客户。</li>
<li>维护：对软件进行维护比如解决 bug，完善功能。</li>
</ul>
<p>软件开发过程只是比较笼统的层面上，一定义了一个软件开发可能涉及到的一些流程。</p>
<p>软件开发模型更具体地定义了软件开发过程，对开发过程提供了强有力的理论支持。</p>
<h2 id="软件开发模型">软件开发模型<a hidden class="anchor" aria-hidden="true" href="#软件开发模型">#</a></h2>
<p>软件开发模型有很多种，比如瀑布模型（Waterfall Model）、快速原型模型（Rapid Prototype Model）、V 模型（V-model）、W 模型（W-model）、敏捷开发模型。其中最具有代表性的还是 <strong>瀑布模型</strong> 和 <strong>敏捷开发</strong> 。</p>
<p><strong>瀑布模型</strong> 定义了一套完成的软件开发周期，完整地展示了一个软件的的生命周期。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/up-264f2750a3d30366e36c375ec3a30ec2775.png"></p>
<p><strong>敏捷开发模型</strong> 是目前使用的最多的一种软件开发模型。<a href="https://wiki.mbalib.com/wiki/%E6%95%8F%E6%8D%B7%E5%BC%80%E5%8F%91">MBA 智库百科对敏捷开发的描述</a>是这样的:</p>
<blockquote>
<p><strong>敏捷开发</strong> 是一种以人为核心、迭代、循序渐进的开发方法。在敏捷开发中，软件项目的构建被切分成多个子项目，各个子项目的成果都经过测试，具备集成和可运行的特征。换言之，就是把一个大项目分为多个相互联系，但也可独立运行的小项目，并分别完成，在此过程中软件一直处于可使用状态。</p>
</blockquote>
<p>像现在比较常见的一些概念比如 <strong>持续集成</strong>、<strong>重构</strong>、<strong>小版本发布</strong>、<strong>低文档</strong>、<strong>站会</strong>、<strong>结对编程</strong>、<strong>测试驱动开发</strong> 都是敏捷开发的核心。</p>
<h2 id="软件开发的基本策略">软件开发的基本策略<a hidden class="anchor" aria-hidden="true" href="#软件开发的基本策略">#</a></h2>
<h3 id="软件复用">软件复用<a hidden class="anchor" aria-hidden="true" href="#软件复用">#</a></h3>
<p>我们在构建一个新的软件的时候，不需要从零开始，通过复用已有的一些轮子（框架、第三方库等）、设计模式、设计原则等等现成的物料，我们可以更快地构建出一个满足要求的软件。</p>
<p>像我们平时接触的开源项目就是最好的例子。我想，如果不是开源，我们构建出一个满足要求的软件，耗费的精力和时间要比现在多的多！</p>
<h3 id="分而治之">分而治之<a hidden class="anchor" aria-hidden="true" href="#分而治之">#</a></h3>
<p>构建软件的过程中，我们会遇到很多问题。我们可以将一些比较复杂的问题拆解为一些小问题，然后，一一攻克。</p>
<p>我结合现在比较火的软件设计方法—领域驱动设计（Domain Driven Design，简称 DDD）来说说。</p>
<p>在领域驱动设计中，很重要的一个概念就是<strong>领域（Domain）</strong>，它就是我们要解决的问题。在领域驱动设计中，我们要做的就是把比较大的领域（问题）拆解为若干的小领域（子域）。</p>
<p>除此之外，分而治之也是一个比较常用的算法思想，对应的就是分治算法。如果你想了解分治算法的话，推荐你看一下北大的<a href="https://www.coursera.org/learn/algorithms">《算法设计与分析 Design and Analysis of Algorithms》</a>。</p>
<h3 id="逐步演进">逐步演进<a hidden class="anchor" aria-hidden="true" href="#逐步演进">#</a></h3>
<p>软件开发是一个逐步演进的过程，我们需要不断进行迭代式增量开发，最终交付符合客户价值的产品。</p>
<p>这里补充一个在软件开发领域，非常重要的概念：<strong>MVP（Minimum Viable Product，最小可行产品</strong>）。</p>
<p>这个最小可行产品，可以理解为刚好能够满足客户需求的产品。下面这张图片把这个思想展示的非常精髓。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/up-a99961ff7725106c0592abca845d555568a.png"></p>
<p>利用最小可行产品，我们可以也可以提早进行市场分析，这对于我们在探索产品不确定性的道路上非常有帮助。可以非常有效地指导我们下一步该往哪里走。</p>
<h3 id="优化折中">优化折中<a hidden class="anchor" aria-hidden="true" href="#优化折中">#</a></h3>
<p>软件开发是一个不断优化改进的过程。任何软件都有很多可以优化的点，不可能完美。我们需要不断改进和提升软件的质量。</p>
<p>但是，也不要陷入这个怪圈。要学会折中，在有限的投入内，以最有效的方式提高现有软件的质量。</p>
<h1 id="命名指南">命名指南<a hidden class="anchor" aria-hidden="true" href="#命名指南">#</a></h1>
<h2 id="常见命名规则以及适用场景">常见命名规则以及适用场景<a hidden class="anchor" aria-hidden="true" href="#常见命名规则以及适用场景">#</a></h2>
<p>这里只介绍 3 种最常见的命名规范。</p>
<h3 id="驼峰命名法camelcase">驼峰命名法（CamelCase）<a hidden class="anchor" aria-hidden="true" href="#驼峰命名法camelcase">#</a></h3>
<p>驼峰命名法应该我们最常见的一个，这种命名方式使用大小写混合的格式来区别各个单词，并且单词之间不使用空格隔开或者连接字符连接的命名方式</p>
<h4 id="驼峰命名法uppercamelcase">驼峰命名法（UpperCamelCase）<a hidden class="anchor" aria-hidden="true" href="#驼峰命名法uppercamelcase">#</a></h4>
<p><strong>类名需要使用大驼峰命名法（UpperCamelCase）</strong></p>
<p>正例：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ServiceDiscovery<span style="color:#f00">、</span>ServiceInstance<span style="color:#f00">、</span>LruCacheFactory
</span></span></code></pre></td></tr></table>
</div>
</div><p>反例：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>serviceDiscovery<span style="color:#f00">、</span>Serviceinstance<span style="color:#f00">、</span>LRUCacheFactory
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="驼峰命名法lowercamelcase">驼峰命名法（lowerCamelCase）<a hidden class="anchor" aria-hidden="true" href="#驼峰命名法lowercamelcase">#</a></h4>
<p><strong>方法名、参数名、成员变量、局部变量需要使用小驼峰命名法（lowerCamelCase）。</strong></p>
<p>正例：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>getUserInfo()
</span></span><span style="display:flex;"><span>createCustomThreadPool()
</span></span><span style="display:flex;"><span>setNameFormat(String nameFormat)
</span></span><span style="display:flex;"><span>Uservice userService;
</span></span></code></pre></td></tr></table>
</div>
</div><p>反例：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>GetUserInfo()<span style="color:#f00">、</span>CreateCustomThreadPool()<span style="color:#f00">、</span>setNameFormat(String NameFormat)
</span></span><span style="display:flex;"><span>Uservice user_service
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="蛇形命名法snake_case">蛇形命名法（snake_case）<a hidden class="anchor" aria-hidden="true" href="#蛇形命名法snake_case">#</a></h3>
<p><strong>测试方法名、常量、枚举名称需要使用蛇形命名法（snake_case）</strong></p>
<p>在蛇形命名法中，各个单词之间通过下划线“_”连接，比如<code>should_get_200_status_code_when_request_is_valid</code>、<code>CLIENT_CONNECT_SERVER_FAILURE</code>。</p>
<p>蛇形命名法的优势是命名所需要的单词比较多的时候，比如我把上面的命名通过小驼峰命名法给大家看一下：“shouldGet200StatusCodeWhenRequestIsValid”。</p>
<p>感觉如何？ 相比于使用蛇形命名法（snake_case）来说是不是不那么易读？</p>
<p>正例：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> should_get_200_status_code_when_request_is_valid() {
</span></span><span style="display:flex;"><span>  ......
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>反例：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> shouldGet200StatusCodeWhenRequestIsValid() {
</span></span><span style="display:flex;"><span>  ......
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="串式命名法kebab-case">串式命名法（kebab-case）<a hidden class="anchor" aria-hidden="true" href="#串式命名法kebab-case">#</a></h3>
<p>在串式命名法中，各个单词之间通过连接符“-”连接，比如<code>dubbo-registry</code>。</p>
<p>建议项目文件夹名称使用串式命名法（kebab-case），比如 dubbo 项目的各个模块的命名是下面这样的。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/dubbo-naming.png"></p>
<h2 id="常见命名规范">常见命名规范<a hidden class="anchor" aria-hidden="true" href="#常见命名规范">#</a></h2>
<h3 id="java-语言基本命名规范">Java 语言基本命名规范<a hidden class="anchor" aria-hidden="true" href="#java-语言基本命名规范">#</a></h3>
<p><strong>1、类名需要使用大驼峰命名法（UpperCamelCase）风格。方法名、参数名、成员变量、局部变量需要使用小驼峰命名法（lowerCamelCase）。</strong></p>
<p><strong>2、测试方法名、常量、枚举名称需要使用蛇形命名法（snake_case）</strong>，比如<code>should_get_200_status_code_when_request_is_valid</code>、<code>CLIENT_CONNECT_SERVER_FAILURE</code>。并且，<strong>测试方法名称要求全部小写，常量以及枚举名称需要全部大写。</strong></p>
<p><strong>3、项目文件夹名称使用串式命名法（kebab-case），比如<code>dubbo-registry</code>。</strong></p>
<p><strong>4、包名统一使用小写，尽量使用单个名词作为包名，各个单词通过 &ldquo;.&rdquo; 分隔符连接，并且各个单词必须为单数。</strong></p>
<p>正例：<code>org.apache.dubbo.common.threadlocal</code></p>
<p>反例：<code>org.apache_dubbo.Common.threadLocals</code></p>
<p><strong>5、抽象类命名使用 Abstract 开头</strong>。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//为远程传输部分抽象出来的一个抽象类（出处：Dubbo源码）</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">class</span> AbstractClient <span style="color:#fff;font-weight:bold">extends</span> AbstractEndpoint <span style="color:#fff;font-weight:bold">implements</span> Client {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>6、异常类命名使用 Exception 结尾。</strong></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//自定义的 NoSuchMethodException（出处：Dubbo源码）</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> NoSuchMethodException <span style="color:#fff;font-weight:bold">extends</span> RuntimeException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> serialVersionUID = -2725364246023268766L;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> NoSuchMethodException() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> NoSuchMethodException(String msg) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>7、测试类命名以它要测试的类的名称开始，以 Test 结尾。</strong></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//为 AnnotationUtils 类写的测试类（出处：Dubbo源码）</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationUtilsTest {
</span></span><span style="display:flex;"><span>  ......
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>POJO 类中布尔类型的变量，都不要加 is 前缀，否则部分框架解析会引起序列化错误。</p>
<p>如果模块、接口、类、方法使用了设计模式，在命名时需体现出具体模式。</p>
<h3 id="命名易读性规范">命名易读性规范<a hidden class="anchor" aria-hidden="true" href="#命名易读性规范">#</a></h3>
<p><strong>1、为了能让命名更加易懂和易读，尽量不要缩写/简写单词，除非这些单词已经被公认可以被这样缩写/简写。比如 <code>CustomThreadFactory</code> 不可以被写成 ~~<code>CustomTF</code> 。</strong></p>
<p><strong>2、命名不像函数一样要尽量追求短，可读性强的名字优先于简短的名字，虽然可读性强的名字会比较长一点。</strong> 这个对应我们上面说的第 1 点。</p>
<p><strong>3、避免无意义的命名，你起的每一个名字都要能表明意思。</strong></p>
<p>正例：<code>UserService userService;</code> <code>int userCount</code>;</p>
<p>反例: <code>UserService service</code> <code>int count</code></p>
<p><strong>4、避免命名过长（50 个字符以内最好），过长的命名难以阅读并且丑陋。</strong></p>
<p><strong>5、不要使用拼音，更不要使用中文。</strong> 不过像 alibaba、wuhan、taobao 这种国际通用名词可以当做英文来看待。</p>
<p>正例：discount</p>
<p>反例：dazhe</p>
<h1 id="代码重构">代码重构<a hidden class="anchor" aria-hidden="true" href="#代码重构">#</a></h1>
<p>学习重构必看的一本神书《重构：改善代码既有设计》从两个角度给出了重构的定义：</p>
<blockquote>
<ul>
<li>重构（名词）：对软件内部结构的一种调整，目的是在不改变软件可观察行为的前提下，提高其可理解性，降低其修改成本。</li>
<li>重构（动词）：使用一系列重构手法，在不改变软件可观察行为的前提下，调整其结构。</li>
</ul>
</blockquote>
<p>用更贴近工程师的语言来说：<strong>重构就是利用设计模式(如组合模式、策略模式、责任链模式)、软件设计原则（如 SOLID 原则、YAGNI 原则、KISS 原则）和重构手段（如封装、继承、构建测试体系）来让代码更容易理解，更易于修改。</strong></p>
<p>软件设计原则指导着我们组织和规范代码，同时，重构也是为了能够尽量设计出尽量满足软件设计原则的软件。</p>
<p>正确重构的核心在于 <strong>步子一定要小，每一步的重构都不会影响软件的正常运行，可以随时停止重构。</strong></p>
<h2 id="为什么要重构">为什么要重构？<a hidden class="anchor" aria-hidden="true" href="#为什么要重构">#</a></h2>
<p>在上面介绍重构定义的时候，我从比较抽象的角度介绍了重构的好处：重构的主要目的主要是提升代码&amp;架构的灵活性/可扩展性以及复用性。</p>
<p>如果对应到一个真实的项目，重构具体能为我们带来什么好处呢？</p>
<ol>
<li><strong>让代码更容易理解</strong>：通过添加注释、命名规范、逻辑优化等手段可以让我们的代码更容易被理解；</li>
<li><strong>避免代码腐化</strong>：通过重构干掉坏味道代码；</li>
<li><strong>加深对代码的理解</strong>：重构代码的过程会加深你对某部分代码的理解；</li>
<li><strong>发现潜在 bug</strong>：是这样的，很多潜在的 bug ，都是我们在重构的过程中发现的；</li>
<li>&hellip;&hellip;</li>
</ol>
<p>看了上面介绍的关于重构带来的好处之后，你会发现重构的最终目标是 <strong>提高软件开发速度和质量</strong> 。</p>
<p>重构并不会减慢软件开发速度，相反，如果代码质量和软件设计较差，当我们想要添加新功能的话，开发速度会越来越慢。到了最后，甚至都有想要重写整个系统的冲动。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/bad&good-design.png"></p>
<p>《重构：改善代码既有设计》这本书中这样说：</p>
<blockquote>
<p>重构的唯一目的就是让我们开发更快，用更少的工作量创造更大的价值。</p>
</blockquote>
<h2 id="何时进行重构">何时进行重构？<a hidden class="anchor" aria-hidden="true" href="#何时进行重构">#</a></h2>
<p>重构在是开发过程中随时可以进行的，见机行事即可，并不需要单独分配一两天的时间专门用来重构。</p>
<h3 id="提交代码之前">提交代码之前<a hidden class="anchor" aria-hidden="true" href="#提交代码之前">#</a></h3>
<p>《重构：改善代码既有设计》这本书介绍了一个 <strong>营地法则</strong> 的概念:</p>
<blockquote>
<p>编程时，需要遵循营地法则：保证你离开时的代码库一定比来时更健康。</p>
</blockquote>
<p>这个概念表达的核心思想其实很简单：在你提交代码的之前，花一会时间想一想，我这次的提交是让项目代码变得更健康了，还是更腐化了，或者说没什么变化？</p>
<p>项目团队的每一个人只有保证自己的提交没有让项目代码变得更腐化，项目代码才会朝着健康的方向发展。</p>
<p><strong>当我们离开营地（项目代码）的时候，请不要留下垃圾！尽量确保营地变得更干净了！</strong></p>
<h3 id="开发一个新功能之后之前">开发一个新功能之后&amp;之前<a hidden class="anchor" aria-hidden="true" href="#开发一个新功能之后之前">#</a></h3>
<p>在开发一个新功能之后，我们应该回过头看看是不是有可以改进的地方。在添加一个新功能之前，我们可以思考一下自己是否可以重构代码以让新功能的开发更容易。</p>
<p>一个新功能的开发不应该仅仅只有功能验证通过那么简单，我们还应该尽量保证代码质量。</p>
<p>有一个两顶帽子的比喻：在我开发新功能之前，我发现重构可以让新功能的开发更容易，于是我戴上了重构的帽子。重构之后，我换回原来的帽子，继续开发新能功能。新功能开发完成之后，我又发现自己的代码难以理解，于是我又戴上了重构帽子。比较好的开发状态就是就是这样在重构和开发新功能之间来回切换。</p>
<h3 id="code-review-之后">Code Review 之后<a hidden class="anchor" aria-hidden="true" href="#code-review-之后">#</a></h3>
<p>Code Review 可以非常有效提高代码的整体质量，它会帮助我们发现代码中的坏味道以及可能存在问题的地方。并且， Code Review 可以帮助项目团队其他程序员理解你负责的业务模块，有效避免人员方面的单点风险。</p>
<p>经历一次 Code Review ，你的代码可能会收到很多改进建议。</p>
<h3 id="捡垃圾式重构">捡垃圾式重构<a hidden class="anchor" aria-hidden="true" href="#捡垃圾式重构">#</a></h3>
<p>当我们发现垃圾代码的时候，如果我们不想停下手头自己正在做的工作，但又不想放着垃圾不管，我们可以这样做：</p>
<ul>
<li>如果这个垃圾很容易重构的话，我们可以立即重构它。</li>
<li>如果这个垃圾不太容易重构的话，我们可以先记录下来，当完成当下的任务再回来重构它。</li>
</ul>
<h3 id="捡垃圾式重构-1">捡垃圾式重构<a hidden class="anchor" aria-hidden="true" href="#捡垃圾式重构-1">#</a></h3>
<p>当我们发现坏味道代码（垃圾）的时候，如果我们不想停下手头自己正在做的工作，但又不想放着垃圾不管，我们可以这样做：</p>
<ul>
<li>如果这个垃圾很容易重构的话，我们可以立即重构它。</li>
<li>如果这个垃圾不太容易重构的话，我们可以先记录下来，当完成当下的任务再回来重构它。</li>
</ul>
<h2 id="重构有哪些注意事项">重构有哪些注意事项？<a hidden class="anchor" aria-hidden="true" href="#重构有哪些注意事项">#</a></h2>
<h3 id="单元测试是重构的保护网">单元测试是重构的保护网<a hidden class="anchor" aria-hidden="true" href="#单元测试是重构的保护网">#</a></h3>
<p><strong>单元测试可以为重构提供信心，降低重构的成本。我们要像重视生产代码那样，重视单元测试。</strong></p>
<p>另外，多提一句：持续集成也要依赖单元测试，当持续集成服务自动构建新代码之后，会自动运行单元测试来发现代码错误。</p>
<p><strong>怎样才能算单元测试呢？</strong> 网上的定义很多，很抽象，很容易把人给看迷糊了。我觉得对于单元测试的定义主要取决于你的项目，一个函数甚至是一个类都可以看作是一个单元。就比如说我们写了一个计算个人股票收益率的方法，我们为了验证它的正确性专门为它写了一个单元测试。再比如说我们代码有一个类专门负责数据脱敏，我们为了验证脱敏是否符合预期专门为这个类写了一个单元测试。</p>
<p><strong>单元测试也是需要重构或者修改的。</strong> <a href="https://book.douban.com/subject/4199741/">《代码整洁之道:敏捷软件开发手册》</a>这本书这样写到：</p>
<blockquote>
<p>测试代码需要随着生产代码的演进而修改，如果测试不能保持整洁，只会越来越难修改。</p>
</blockquote>
<h3 id="不要为了重构而重构">不要为了重构而重构<a hidden class="anchor" aria-hidden="true" href="#不要为了重构而重构">#</a></h3>
<p><strong>重构一定是要为项目带来价值的！</strong> 某些情况下我们不应该进行重构：</p>
<ul>
<li>学习了某个设计模式/工程实践之后，不顾项目实际情况，刻意使用在项目上（避免货物崇拜编程）；</li>
<li>项目进展比较急的时候，重构项目调用的某个 API 的底层代码（重构之后对项目调用这个 API 并没有带来什么价值）；</li>
<li>重写比重构更容易更省事；</li>
<li>&hellip;&hellip;</li>
</ul>
<h3 id="遵循方法">遵循方法<a hidden class="anchor" aria-hidden="true" href="#遵循方法">#</a></h3>
<p>《重构：改善代码既有设计》这本书中列举除了代码常见的一些坏味道（比如重复代码、过长函数）和重构手段（如提炼函数、提炼变量、提炼类）。我们应该花时间去学习这些重构相关的理论知识，并在代码中去实践这些重构理论。</p>
<h2 id="如何练习重构">如何练习重构？<a hidden class="anchor" aria-hidden="true" href="#如何练习重构">#</a></h2>
<p>除了可以在重构项目代码的过程中练习精进重构之外，你还可以有下面这些手段：</p>
<ul>
<li><a href="https://linesh.gitbook.io/refactoring/">重构实战练习</a>：通过几个小案例一步一步带你学习重构！</li>
<li><a href="https://refactoringguru.cn/">设计模式+重构学习网站</a>：免费在线学习代码重构、 设计模式、 SOLID 原则 （单一职责、 开闭原则、 里氏替换、 接口隔离以及依赖反转） 。</li>
<li><a href="https://www.jetbrains.com/help/idea/refactoring-source-code.html#popular-refactorings">IDEA 官方文档的代码重构教程</a>：教你如何使用 IDEA 进行重构。</li>
</ul>
<h1 id="单元测试指南">单元测试指南<a hidden class="anchor" aria-hidden="true" href="#单元测试指南">#</a></h1>
<h2 id="何谓单元测试">何谓单元测试？<a hidden class="anchor" aria-hidden="true" href="#何谓单元测试">#</a></h2>
<p>维基百科是这样介绍单元测试的：</p>
<blockquote>
<p>在计算机编程中，单元测试（Unit Testing）是针对程序模块（软件设计的最小单位）进行的正确性检验测试工作。</p>
<p>程序单元是应用的 <strong>最小可测试部件</strong> 。在过程化编程中，一个单元就是单个程序、函数、过程等；对于面向对象编程，最小单元就是方法，包括基类（超类）、抽象类、或者派生类（子类）中的方法。</p>
</blockquote>
<p>由于每个单元有独立的逻辑，在做单元测试时，为了隔离外部依赖，确保这些依赖不影响验证逻辑，我们经常会用到 Fake、Stub 与 Mock 。</p>
<p>关于 Fake、Mock 与 Stub 这几个概念的解读，可以看看这篇文章：<a href="https://zhuanlan.zhihu.com/p/26942686">测试中 Fakes、Mocks 以及 Stubs 概念明晰 - 王下邀月熊 - 2018</a> 。</p>
<h2 id="为什么需要单元测试">为什么需要单元测试？<a hidden class="anchor" aria-hidden="true" href="#为什么需要单元测试">#</a></h2>
<h3 id="为重构保驾护航">为重构保驾护航<a hidden class="anchor" aria-hidden="true" href="#为重构保驾护航">#</a></h3>
<blockquote>
<p>单元测试可以为重构提供信心，降低重构的成本。我们要像重视生产代码那样，重视单元测试。</p>
</blockquote>
<p>每个开发者都会经历重构，重构后把代码改坏了的情况并不少见，很可能你只是修改了一个很简单的方法就导致系统出现了一个比较严重的错误。</p>
<p>如果有了单元测试的话，就不会存在这个隐患了。写完一个类，把单元测试写了，确保这个类逻辑正确；写第二个类，单元测试&hellip;..写 100 个类，道理一样，每个类做到第一点“保证逻辑正确性”，100 个类拼在一起肯定不出问题。你大可以放心一边重构，一边运行 APP；而不是整体重构完，提心吊胆地 run。</p>
<h3 id="提高代码质量">提高代码质量<a hidden class="anchor" aria-hidden="true" href="#提高代码质量">#</a></h3>
<p>由于每个单元有独立的逻辑，做单元测试时需要隔离外部依赖，确保这些依赖不影响验证逻辑。因为要把各种依赖分离，单元测试会促进工程进行组件拆分，整理工程依赖关系，更大程度减少代码耦合。这样写出来的代码，更好维护，更好扩展，从而提高代码质量。</p>
<h3 id="减少-bug">减少 bug<a hidden class="anchor" aria-hidden="true" href="#减少-bug">#</a></h3>
<p>一个机器，由各种细小的零件组成，如果其中某件零件坏了，机器运行故障。必须保证每个零件都按设计图要求的规格，机器才能正常运行。</p>
<p>一个可单元测试的工程，会把业务、功能分割成规模更小、有独立的逻辑部件，称为单元。单元测试的目标，就是保证各个单元的逻辑正确性。单元测试保障工程各个“零件”按“规格”（需求）执行，从而保证整个“机器”（项目）运行正确，最大限度减少 bug。</p>
<h3 id="快速定位-bug">快速定位 bug<a hidden class="anchor" aria-hidden="true" href="#快速定位-bug">#</a></h3>
<p>如果程序有 bug，我们运行一次全部单元测试，找到不通过的测试，可以很快地定位对应的执行代码。修复代码后，运行对应的单元测试；如还不通过，继续修改，运行测试&hellip;..直到<strong>测试通过</strong>。</p>
<h3 id="持续集成依赖单元测试">持续集成依赖单元测试<a hidden class="anchor" aria-hidden="true" href="#持续集成依赖单元测试">#</a></h3>
<p>持续集成需要依赖单元测试，当持续集成服务自动构建新代码之后，会自动运行单元测试来发现代码错误。</p>
<h2 id="谁逼你写单元测试">谁逼你写单元测试？<a hidden class="anchor" aria-hidden="true" href="#谁逼你写单元测试">#</a></h2>
<h3 id="领导要求">领导要求<a hidden class="anchor" aria-hidden="true" href="#领导要求">#</a></h3>
<p>有些经验丰富的领导，或多或少都会要求团队写单元测试。对于有一定工作经验的队友，这要求挺合理；对于经验尚浅的、毕业生，恐怕要死要活了，连代码都写不好，还要写单元测试，are you kidding me？</p>
<p>培训新人单元测试用法，是一项艰巨的任务。新人代码风格未形成，也不知道单元测试多重要，强制单元测试会让他们感到困惑，没办法按自己思路写代码。</p>
<h3 id="大牛都写单元测试">大牛都写单元测试<a hidden class="anchor" aria-hidden="true" href="#大牛都写单元测试">#</a></h3>
<p>国外很多家喻户晓的开源项目，都有大量单元测试。例如，<a href="https://link.jianshu.com?t=https://github.com/square/retrofit/tree/master/retrofit/src/test/java/retrofit2">retrofit</a>、<a href="https://link.jianshu.com?t=https://github.com/square/okhttp/tree/master/okhttp-tests/src/test/java/okhttp3">okhttp</a>、<a href="https://link.jianshu.com?t=https://github.com/JakeWharton/butterknife/tree/master/butterknife-compiler/src/test/java/butterknife">butterknife</a>&hellip;. 国外大牛都写单元测试，我们也写吧！</p>
<p>很多读者都有这种想法，一开始满腔热血。当真要对自己项目单元测试时，便困难重重，很大原因是项目对单元测试不友好。最后只能对一些不痛不痒的工具类做单元测试，久而久之，当初美好愿望也不了了之。</p>
<h3 id="保住面子">保住面子<a hidden class="anchor" aria-hidden="true" href="#保住面子">#</a></h3>
<p>都是有些许年经验的老鸟，还天天被测试同学追 bug，好意思么？花多一点时间写单元测试，确保没低级 bug，还能彰显大牛风范，何乐而不为？</p>
<h3 id="心虚">心虚<a hidden class="anchor" aria-hidden="true" href="#心虚">#</a></h3>
<p>笔者也是个不太相信自己代码的人，总觉得哪里会突然冒出莫名其妙的 bug，也怕别人不小心改了自己的代码（被害妄想症），新版本上线提心吊胆&hellip;&hellip;花点时间写单元测试，有事没事跑一下测试，确保原逻辑没问题，至少能睡安稳一点。</p>
<h2 id="tdd-测试驱动开发">TDD 测试驱动开发<a hidden class="anchor" aria-hidden="true" href="#tdd-测试驱动开发">#</a></h2>
<h3 id="何谓-tdd">何谓 TDD？<a hidden class="anchor" aria-hidden="true" href="#何谓-tdd">#</a></h3>
<p>TDD 即 Test-Driven Development（ 测试驱动开发），这是敏捷开发的一项核心实践和技术，也是一种设计方法论。</p>
<p>TDD 原理是开发功能代码之前，先编写测试用例代码，然后针对测试用例编写功能代码，使其能够通过。</p>
<p>TDD 的节奏：“红 - 绿 - 重构”。</p>
<p><img alt="img" loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/090e1fc6aff08b4aa66376f776c2337f.png"></p>
<p>由于 TDD 对开发人员要求非常高，跟传统开发思维不一样，因此实施起来相当困难。</p>
<p>TDD 在很多人眼中是不实用的，一来他们并不理解测试“驱动”开发的含义，但更重要的是，他们很少会做任务分解。而任务分解是做好 TDD 的关键点。只有把任务分解到可以测试的地步，才能够有针对性地写测试。</p>
<h3 id="tdd-优缺点分析">TDD 优缺点分析<a hidden class="anchor" aria-hidden="true" href="#tdd-优缺点分析">#</a></h3>
<p>测试驱动开发有好处也有坏处。因为每个测试用例都是根据需求来的，或者说把一个大需求分解成若干小需求编写测试用例，所以测试用例写出来后，开发者写的执行代码，必须满足测试用例。如果测试不通过，则修改执行代码，直到测试用例通过。</p>
<p><strong>优点</strong>：</p>
<ol>
<li>帮你整理需求，梳理思路；</li>
<li>帮你设计出更合理的接口（空想的话很容易设计出屎）；</li>
<li>减小代码出现 bug 的概率；</li>
<li>提高开发效率（前提是正确且熟练使用 TDD）。</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>能用好 TDD 的人非常少，看似简单，实则门槛很高；</li>
<li>投入开发资源（时间和精力）通常会更多；</li>
<li>由于测试用例在未进行代码设计前写；很有可能限制开发者对代码整体设计；</li>
<li>可能引起开发人员不满情绪，我觉得这点很严重，毕竟不是人人都喜欢单元测试，尽管单元测试会带给我们相当多的好处。</li>
</ol>
<p>相关阅读：<a href="https://zhuanlan.zhihu.com/p/24997923">如何用正确的姿势打开 TDD？ - 陈天 - 2017</a></p>
<h2 id="单测框架如何选择">单测框架如何选择？<a hidden class="anchor" aria-hidden="true" href="#单测框架如何选择">#</a></h2>
<p>对于单测来说，目前常用的单测框架有：JUnit、Mockito、Spock、PowerMock、JMockit、TestableMock 等等。</p>
<p>JUnit 几乎是默认选择，但是其不支持 Mock，因此我们还需要选择一个 Mock 工具。Mockito 和 Spock 是最主流的两款 Mock 工具，一般都是在这两者中选择。</p>
<p>究竟是选择 Mockito 还是 Spock 呢？我这里做了一些简单的对比分析：</p>
<ul>
<li>Spock 没办法 Mock 静态方法和私有方法 ，Mockito 3.4.0 以后，支持静态方法的 Mock，具体可以看这个 issue：<a href="https://github.com/mockito/mockito/issues/1013%EF%BC%8C%E5%85%B7%E4%BD%93%E6%95%99%E7%A8%8B%E5%8F%AF%E4%BB%A5%E7%9C%8B%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%EF%BC%9Ahttps://www.baeldung.com/mockito-mock-static-methods%E3%80%82">https://github.com/mockito/mockito/issues/1013，具体教程可以看这篇文章：https://www.baeldung.com/mockito-mock-static-methods。</a></li>
<li>Spock 基于 Groovy，写出来的测试代码更清晰易读，比较规范(自带 given-when-then 的常用测试结构规范)。Mockito 没有具体的结构规范，需要项目组自己约定一个或者遵守比较好的测试代码实践。通常来说，同样的测试用例，Spock 的代码要更简洁。</li>
<li>Mockito 使用的人群更广泛，稳定可靠。并且，Mockito 是 SpringBoot Test 默认集成的 Mock 工具。</li>
</ul>
<p>Mockito 和 Spock 都是非常不错的 Mock 工具，相对来说，Mockito 的适用性更强一些。</p>
<h2 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h2>
<p>单元测试确实会带给你相当多的好处，但不是立刻体验出来。正如买重疾保险，交了很多保费，没病没痛，十几年甚至几十年都用不上，最好就是一辈子用不上理赔，身体健康最重要。单元测试也一样，写了可以买个放心，对代码的一种保障，有 bug 尽快测出来，没 bug 就最好，总不能说“写那么多单元测试，结果测不出 bug，浪费时间”吧？</p>
<p>以下是个人对单元测试一些建议：</p>
<blockquote>
<ul>
<li>越重要的代码，越要写单元测试；</li>
<li>代码做不到单元测试，多思考如何改进，而不是放弃；</li>
<li>边写业务代码，边写单元测试，而不是完成整个新功能后再写；</li>
<li>多思考如何改进、简化测试代码。</li>
<li>测试代码需要随着生产代码的演进而重构或者修改，如果测试不能保持整洁，只会越来越难修改。</li>
</ul>
</blockquote>
<p>作为一名经验丰富的程序员，写单元测试更多的是<strong>对自己的代码负责</strong>。有测试用例的代码，别人更容易看懂，以后别人接手你的代码时，也可能放心做改动。</p>
<p><strong>多敲代码实践，多跟有单元测试经验的工程师交流</strong>，你会发现写单元测试获得的收益会更多。</p>
<h1 id="java-定时任务详解">Java 定时任务详解<a hidden class="anchor" aria-hidden="true" href="#java-定时任务详解">#</a></h1>
<h2 id="为什么需要定时任务">为什么需要定时任务？<a hidden class="anchor" aria-hidden="true" href="#为什么需要定时任务">#</a></h2>
<p>我们来看一下几个非常常见的业务场景：</p>
<ol>
<li>某系统凌晨要进行数据备份。</li>
<li>某媒体聚合平台，每 10 分钟动态抓取某某网站的数据为自己所用。</li>
<li>某基金平台，每晚定时计算用户当日收益情况并推送给用户最新的数据。</li>
</ol>
<p>这些场景往往都要求我们在某个特定的时间去做某个事情。</p>
<h2 id="单机定时任务技术选型">单机定时任务技术选型<a hidden class="anchor" aria-hidden="true" href="#单机定时任务技术选型">#</a></h2>
<h3 id="timer">Timer<a hidden class="anchor" aria-hidden="true" href="#timer">#</a></h3>
<p><code>java.util.Timer</code>是 JDK 1.3 开始就已经支持的一种定时任务的实现方式。</p>
<p><code>Timer</code> 内部使用一个叫做 <code>TaskQueue</code> 的类存放定时任务，它是一个基于最小堆实现的优先级队列。<code>TaskQueue</code> 会按照任务距离下一次执行时间的大小将任务排序，保证在堆顶的任务最先执行。这样在需要执行任务时，每次只需要取出堆顶的任务运行即可！</p>
<p><code>Timer</code> 使用起来比较简单，通过下面的方式我们就能创建一个 1s 之后执行的定时任务。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 示例代码：</span>
</span></span><span style="display:flex;"><span>TimerTask task = <span style="color:#fff;font-weight:bold">new</span> TimerTask() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;当前时间: &#34;</span> + <span style="color:#fff;font-weight:bold">new</span> Date() + <span style="color:#0ff;font-weight:bold">&#34;n&#34;</span> +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;线程名称: &#34;</span> + Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;当前时间: &#34;</span> + <span style="color:#fff;font-weight:bold">new</span> Date() + <span style="color:#0ff;font-weight:bold">&#34;n&#34;</span> +
</span></span><span style="display:flex;"><span>        <span style="color:#0ff;font-weight:bold">&#34;线程名称: &#34;</span> + Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>Timer timer = <span style="color:#fff;font-weight:bold">new</span> Timer(<span style="color:#0ff;font-weight:bold">&#34;Timer&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">long</span> delay = 1000L;
</span></span><span style="display:flex;"><span>timer.<span style="color:#007f7f">schedule</span>(task, delay);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//输出：</span>
</span></span><span style="display:flex;"><span>当前时间: Fri May 28 15:18:47 CST 2021n线程名称: main
</span></span><span style="display:flex;"><span>当前时间: Fri May 28 15:18:48 CST 2021n线程名称: Timer
</span></span></code></pre></td></tr></table>
</div>
</div><p>不过其缺陷较多，比如一个 <code>Timer</code> 一个线程，这就导致 <code>Timer</code> 的任务的执行只能串行执行，一个任务执行时间过长的话会影响其他任务（性能非常差），再比如发生异常时任务直接停止（<code>Timer</code> 只捕获了 <code>InterruptedException</code> ）。</p>
<p><code>Timer</code> 类上的有一段注释是这样写的：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span> * This <span style="color:#fff;font-weight:bold">class</span> does not offer real-time guarantees: it schedules
</span></span><span style="display:flex;"><span> * tasks using the &lt;tt&gt;Object.<span style="color:#007f7f">wait</span>(<span style="color:#fff;font-weight:bold">long</span>)&lt;/tt&gt; method.
</span></span><span style="display:flex;"><span> *Java 5.<span style="color:#007f7f">0</span> introduced the {@code java.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">concurrent</span>} <span style="color:#fff;font-weight:bold">package</span> and
</span></span><span style="display:flex;"><span> * one of the concurrency utilities therein is the {@link
</span></span><span style="display:flex;"><span> * java.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">concurrent</span>.<span style="color:#007f7f">ScheduledThreadPoolExecutor</span>
</span></span><span style="display:flex;"><span> * ScheduledThreadPoolExecutor} which is a thread pool <span style="color:#fff;font-weight:bold">for</span> repeatedly
</span></span><span style="display:flex;"><span> * executing tasks at a given rate or delay.  It is effectively a more
</span></span><span style="display:flex;"><span> * versatile replacement <span style="color:#fff;font-weight:bold">for</span> the {@code Timer}/{@code TimerTask}
</span></span><span style="display:flex;"><span> * combination, as it allows multiple service threads, accepts various
</span></span><span style="display:flex;"><span> * time units, and doesn<span style="color:#f00">&#39;</span>t require subclassing {@code TimerTask} (just
</span></span><span style="display:flex;"><span> * implement {@code Runnable}).  Configuring {@code
</span></span><span style="display:flex;"><span> * ScheduledThreadPoolExecutor} with one thread makes it equivalent to
</span></span><span style="display:flex;"><span> * {@code Timer}.
</span></span></code></pre></td></tr></table>
</div>
</div><p>大概的意思就是：<code>ScheduledThreadPoolExecutor</code> 支持多线程执行定时任务并且功能更强大，是 <code>Timer</code> 的替代品。</p>
<h3 id="scheduledexecutorservice">ScheduledExecutorService<a hidden class="anchor" aria-hidden="true" href="#scheduledexecutorservice">#</a></h3>
<p><code>ScheduledExecutorService</code> 是一个接口，有多个实现类，比较常用的是 <code>ScheduledThreadPoolExecutor</code> 。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/20210607154324712.png"></p>
<p><code>ScheduledThreadPoolExecutor</code> 本身就是一个线程池，支持任务并发执行。并且，其内部使用 <code>DelayedWorkQueue</code> 作为任务队列。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 示例代码：</span>
</span></span><span style="display:flex;"><span>TimerTask repeatedTask = <span style="color:#fff;font-weight:bold">new</span> TimerTask() {
</span></span><span style="display:flex;"><span>    @SneakyThrows
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;当前时间: &#34;</span> + <span style="color:#fff;font-weight:bold">new</span> Date() + <span style="color:#0ff;font-weight:bold">&#34;n&#34;</span> +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;线程名称: &#34;</span> + Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;当前时间: &#34;</span> + <span style="color:#fff;font-weight:bold">new</span> Date() + <span style="color:#0ff;font-weight:bold">&#34;n&#34;</span> +
</span></span><span style="display:flex;"><span>        <span style="color:#0ff;font-weight:bold">&#34;线程名称: &#34;</span> + Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>ScheduledExecutorService executor = Executors.<span style="color:#007f7f">newScheduledThreadPool</span>(3);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">long</span> delay  = 1000L;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">long</span> period = 1000L;
</span></span><span style="display:flex;"><span>executor.<span style="color:#007f7f">scheduleAtFixedRate</span>(repeatedTask, delay, period, TimeUnit.<span style="color:#007f7f">MILLISECONDS</span>);
</span></span><span style="display:flex;"><span>Thread.<span style="color:#007f7f">sleep</span>(delay + period * 5);
</span></span><span style="display:flex;"><span>executor.<span style="color:#007f7f">shutdown</span>();
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//输出：</span>
</span></span><span style="display:flex;"><span>当前时间: Fri May 28 15:40:46 CST 2021n线程名称: main
</span></span><span style="display:flex;"><span>当前时间: Fri May 28 15:40:47 CST 2021n线程名称: pool-1-thread-1
</span></span><span style="display:flex;"><span>当前时间: Fri May 28 15:40:48 CST 2021n线程名称: pool-1-thread-1
</span></span><span style="display:flex;"><span>当前时间: Fri May 28 15:40:49 CST 2021n线程名称: pool-1-thread-2
</span></span><span style="display:flex;"><span>当前时间: Fri May 28 15:40:50 CST 2021n线程名称: pool-1-thread-2
</span></span><span style="display:flex;"><span>当前时间: Fri May 28 15:40:51 CST 2021n线程名称: pool-1-thread-2
</span></span><span style="display:flex;"><span>当前时间: Fri May 28 15:40:52 CST 2021n线程名称: pool-1-thread-2
</span></span></code></pre></td></tr></table>
</div>
</div><p>不论是使用 <code>Timer</code> 还是 <code>ScheduledExecutorService</code> 都无法使用 Cron 表达式指定任务执行的具体时间。</p>
<h3 id="spring-task">Spring Task<a hidden class="anchor" aria-hidden="true" href="#spring-task">#</a></h3>
<p>我们直接通过 Spring 提供的 <code>@Scheduled</code> 注解即可定义定时任务，非常方便！</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * cron：使用Cron表达式。　每分钟的1，2秒运行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@Scheduled(cron = <span style="color:#0ff;font-weight:bold">&#34;1-2 * * * * ? &#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> reportCurrentTimeWithCronExpression() {
</span></span><span style="display:flex;"><span>  log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;Cron Expression: The time is now {}&#34;</span>, dateFormat.<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> Date()));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我在大学那会做的一个 SSM 的企业级项目，就是用的 Spring Task 来做的定时任务。</p>
<p>并且，Spring Task 还是支持 <strong>Cron 表达式</strong> 的。Cron 表达式主要用于定时作业(定时任务)系统定义执行时间或执行频率的表达式，非常厉害，你可以通过 Cron 表达式进行设置定时任务每天或者每个月什么时候执行等等操作。咱们要学习定时任务的话，Cron 表达式是一定是要重点关注的。推荐一个在线 Cron 表达式生成器：<a href="http://cron.qqe2.com/">http://cron.qqe2.com/</a> 。</p>
<p>但是，Spring 自带的定时调度只支持单机，并且提供的功能比较单一。之前写过一篇文章:<a href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485563&idx=1&sn=7419341f04036a10b141b74624a3f8c9&chksm=cea247b0f9d5cea6440759e6d49b4e77d06f4c99470243a10c1463834e873ca90266413fbc92&token=2133161636&lang=zh_CN#rd">《5 分钟搞懂如何在 Spring Boot 中 Schedule Tasks》</a> ，不了解的小伙伴可以参考一下。</p>
<p>Spring Task 底层是基于 JDK 的 <code>ScheduledThreadPoolExecutor</code> 线程池来实现的。</p>
<p><strong>优缺点总结：</strong></p>
<ul>
<li>优点：简单，轻量，支持 Cron 表达式</li>
<li>缺点：功能单一</li>
</ul>
<h3 id="时间轮">时间轮<a hidden class="anchor" aria-hidden="true" href="#时间轮">#</a></h3>
<p>Kafka、Dubbo、ZooKeeper、Netty、Caffeine、Akka 中都有对时间轮的实现。</p>
<p>时间轮简单来说就是一个环形的队列（底层一般基于数组实现），队列中的每一个元素（时间格）都可以存放一个定时任务列表。</p>
<p>时间轮中的每个时间格代表了时间轮的基本时间跨度或者说时间精度，假如时间一秒走一个时间格的话，那么这个时间轮的最高精度就是 1 秒（也就是说 3 s 和 3.9s 会在同一个时间格中）。</p>
<p>下图是一个有 12 个时间格的时间轮，转完一圈需要 12 s。当我们需要新建一个 3s 后执行的定时任务，只需要将定时任务放在下标为 3 的时间格中即可。当我们需要新建一个 9s 后执行的定时任务，只需要将定时任务放在下标为 9 的时间格中即可。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/one-layers-of-time-wheel.png"></p>
<p>那当我们需要创建一个 13s 后执行的定时任务怎么办呢？这个时候可以引入一叫做 <strong>圈数/轮数</strong> 的概念，也就是说这个任务还是放在下标为 3 的时间格中， 不过它的圈数为 2 。</p>
<p>除了增加圈数这种方法之外，还有一种 <strong>多层次时间轮</strong> （类似手表），Kafka 采用的就是这种方案。</p>
<p>针对下图的时间轮，我来举一个例子便于大家理解。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/three-layers-of-time-wheel.png"></p>
<p>上图的时间轮，第 1 层的时间精度为 1 ，第 2 层的时间精度为 20 ，第 3 层的时间精度为 400。假如我们需要添加一个 350s 后执行的任务 A 的话（当前时间是 0s），这个任务会被放在第 2 层（因为第二层的时间跨度为 20*20=400&gt;350）的第 350/20=17 个时间格子。</p>
<p>当第一层转了 17 圈之后，时间过去了 340s ，第 2 层的指针此时来到第 17 个时间格子。此时，第 2 层第 17 个格子的任务会被移动到第 1 层。</p>
<p>任务 A 当前是 10s 之后执行，因此它会被移动到第 1 层的第 10 个时间格子。</p>
<p>这里在层与层之间的移动也叫做时间轮的升降级。参考手表来理解就好！</p>
<p><strong>时间轮比较适合任务数量比较多的定时任务场景，它的任务写入和执行的时间复杂度都是 0（1）。</strong></p>
<h2 id="分布式定时任务技术选型">分布式定时任务技术选型<a hidden class="anchor" aria-hidden="true" href="#分布式定时任务技术选型">#</a></h2>
<p>上面提到的一些定时任务的解决方案都是在单机下执行的，适用于比较简单的定时任务场景比如每天凌晨备份一次数据。</p>
<p>如果我们需要一些高级特性比如支持任务在分布式场景下的分片和高可用的话，我们就需要用到分布式任务调度框架了。</p>
<p>通常情况下，一个定时任务的执行往往涉及到下面这些角色：</p>
<ul>
<li><strong>任务</strong>：首先肯定是要执行的任务，这个任务就是具体的业务逻辑比如定时发送文章。</li>
<li><strong>调度器</strong>：其次是调度中心，调度中心主要负责任务管理，会分配任务给执行器。</li>
<li><strong>执行器</strong>：最后就是执行器，执行器接收调度器分派的任务并执行。</li>
</ul>
<h3 id="quartz">Quartz<a hidden class="anchor" aria-hidden="true" href="#quartz">#</a></h3>
<p>一个很火的开源任务调度框架，完全由Java写成。Quartz 可以说是 Java 定时任务领域的老大哥或者说参考标准，其他的任务调度框架基本都是基于 Quartz 开发的，比如当当网的<code>elastic-job</code>就是基于Quartz二次开发之后的分布式调度解决方案。</p>
<p>使用 Quartz 可以很方便地与 Spring集成，并且支持动态添加任务和集群。但是，Quartz 使用起来也比较麻烦，API 繁琐。</p>
<p>并且，Quartz 并没有内置 UI 管理控制台，不过你可以使用 <a href="https://github.com/zhaopeiym/quartzui">quartzui</a> 这个开源项目来解决这个问题。</p>
<p>另外，Quartz 虽然也支持分布式任务。但是，它是在数据库层面，通过数据库的锁机制做的，有非常多的弊端比如系统侵入性严重、节点负载不均衡。有点伪分布式的味道。</p>
<p><strong>优缺点总结：</strong></p>
<ul>
<li>优点：可以与 Spring集成，并且支持动态添加任务和集群。</li>
<li>缺点：分布式支持不友好，没有内置 UI 管理控制台、使用麻烦（相比于其他同类型框架来说）</li>
</ul>
<h3 id="elastic-job">Elastic-Job<a hidden class="anchor" aria-hidden="true" href="#elastic-job">#</a></h3>
<p>ElasticJob 当当网开源的一个面向互联网生态和海量任务的分布式调度解决方案，由两个相互独立的子项目 ElasticJob-Lite 和 ElasticJob-Cloud 组成。</p>
<p>ElasticJob-Lite 和 ElasticJob-Cloud 两者的对比如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">ElasticJob-Lite</th>
<th style="text-align:left">ElasticJob-Cloud</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">无中心化</td>
<td style="text-align:left">是</td>
<td>否</td>
</tr>
<tr>
<td style="text-align:left">资源分配</td>
<td style="text-align:left">不支持</td>
<td>支持</td>
</tr>
<tr>
<td style="text-align:left">作业模式</td>
<td style="text-align:left">常驻</td>
<td>常驻 + 瞬时</td>
</tr>
<tr>
<td style="text-align:left">部署依赖</td>
<td style="text-align:left">ZooKeeper</td>
<td>ZooKeeper + Mesos</td>
</tr>
</tbody>
</table>
<p><code>ElasticJob</code> 支持任务在分布式场景下的分片和高可用、任务可视化管理等功能。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/elasticjob-feature-list.png"></p>
<p>ElasticJob-Lite 的架构设计如下图所示：</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/elasticjob-lite-architecture-design.png"></p>
<p>从上图可以看出，Elastic-Job没有调度中心这一概念，而是使用 ZooKeeper 作为注册中心，注册中心负责协调分配任务到不同的节点上。</p>
<p>Elastic-Job 中的定时调度都是由执行器自行触发，这种设计也被称为去中心化设计（调度和处理都是执行器单独完成）。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@ElasticJobConf(name = <span style="color:#0ff;font-weight:bold">&#34;dayJob&#34;</span>, cron = <span style="color:#0ff;font-weight:bold">&#34;0/10 * * * * ?&#34;</span>, shardingTotalCount = 2,
</span></span><span style="display:flex;"><span>        shardingItemParameters = <span style="color:#0ff;font-weight:bold">&#34;0=AAAA,1=BBBB&#34;</span>, description = <span style="color:#0ff;font-weight:bold">&#34;简单任务&#34;</span>, failover = <span style="color:#fff;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TestJob <span style="color:#fff;font-weight:bold">implements</span> SimpleJob {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> execute(ShardingContext shardingContext) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;TestJob任务名：【{}】, 片数：【{}】, param=【{}】&#34;</span>, shardingContext.<span style="color:#007f7f">getJobName</span>(), shardingContext.<span style="color:#007f7f">getShardingTotalCount</span>(),
</span></span><span style="display:flex;"><span>                shardingContext.<span style="color:#007f7f">getShardingParameter</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>相关地址：</strong></p>
<ul>
<li>GitHub 地址：<a href="https://github.com/apache/shardingsphere-elasticjob%E3%80%82">https://github.com/apache/shardingsphere-elasticjob。</a></li>
<li>官方网站：<a href="https://shardingsphere.apache.org/elasticjob/index_zh.html">https://shardingsphere.apache.org/elasticjob/index_zh.html</a> 。</li>
</ul>
<p><strong>优缺点总结：</strong></p>
<ul>
<li>优点：可以与 Spring集成、支持分布式、支持集群、性能不错</li>
<li>缺点：依赖了额外的中间件比如 Zookeeper（复杂度增加，可靠性降低、维护成本变高）</li>
</ul>
<h3 id="xxl-job">XXL-JOB<a hidden class="anchor" aria-hidden="true" href="#xxl-job">#</a></h3>
<p><code>XXL-JOB</code> 于 2015 年开源，是一款优秀的轻量级分布式任务调度框架，支持任务可视化管理、弹性扩容缩容、任务失败重试和告警、任务分片等功能，</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/xxljob-feature-list.png"></p>
<p>根据 <code>XXL-JOB</code> 官网介绍，其解决了很多 Quartz 的不足。</p>
<blockquote>
<p>Quartz作为开源作业调度中的佼佼者，是作业调度的首选。但是集群环境中Quartz采用API的方式对任务进行管理，从而可以避免上述问题，但是同样存在以下问题：</p>
<ul>
<li>问题一：调用API的的方式操作任务，不人性化；</li>
<li>问题二：需要持久化业务QuartzJobBean到底层数据表中，系统侵入性相当严重。</li>
<li>问题三：调度逻辑和QuartzJobBean耦合在同一个项目中，这将导致一个问题，在调度任务数量逐渐增多，同时调度任务逻辑逐渐加重的情况下，此时调度系统的性能将大大受限于业务；</li>
<li>问题四：quartz底层以“抢占式”获取DB锁并由抢占成功节点负责运行任务，会导致节点负载悬殊非常大；而XXL-JOB通过执行器实现“协同分配式”运行任务，充分发挥集群优势，负载各节点均衡。</li>
</ul>
<p>XXL-JOB弥补了quartz的上述不足之处。</p>
</blockquote>
<p><code>XXL-JOB</code> 的架构设计如下图所示：</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/xxljob-architecture-design-v2.1.0.png"></p>
<p>从上图可以看出，<code>XXL-JOB</code> 由 <strong>调度中心</strong> 和 <strong>执行器</strong> 两大部分组成。调度中心主要负责任务管理、执行器管理以及日志管理。执行器主要是接收调度信号并处理。另外，调度中心进行任务调度时，是通过自研 RPC 来实现的。</p>
<p>不同于 Elastic-Job的去中心化设计， <code>XXL-JOB</code> 的这种设计也被称为中心化设计（调度中心调度多个执行器执行任务）。</p>
<p>和 <code>Quzrtz</code> 类似 <code>XXL-JOB</code> 也是基于数据库锁调度任务，存在性能瓶颈。不过，一般在任务量不是特别大的情况下，没有什么影响的，可以满足绝大部分公司的要求。</p>
<p>不要被 <code>XXL-JOB</code> 的架构图给吓着了，实际上，我们要用 <code>XXL-JOB</code> 的话，只需要重写 <code>IJobHandler</code> 自定义任务执行逻辑就可以了，非常易用！</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@JobHandler(value=<span style="color:#0ff;font-weight:bold">&#34;myApiJobHandler&#34;</span>)
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MyApiJobHandler <span style="color:#fff;font-weight:bold">extends</span> IJobHandler {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ReturnT&lt;String&gt; execute(String param) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//......</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ReturnT.<span style="color:#007f7f">SUCCESS</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>还可以直接基于注解定义任务。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@XxlJob(<span style="color:#0ff;font-weight:bold">&#34;myAnnotationJobHandler&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ReturnT&lt;String&gt; myAnnotationJobHandler(String param) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f">//......</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">return</span> ReturnT.<span style="color:#007f7f">SUCCESS</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/xxljob-admin-task-management.png"></p>
<p><strong>相关地址：</strong></p>
<ul>
<li>GitHub 地址：<a href="https://github.com/xuxueli/xxl-job/%E3%80%82">https://github.com/xuxueli/xxl-job/。</a></li>
<li>官方介绍：<a href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a> 。</li>
</ul>
<p><strong>优缺点总结：</strong></p>
<ul>
<li>优点：开箱即用（学习成本比较低）、与 Spring 集成、支持分布式、支持集群、内置了 UI 管理控制台。</li>
<li>缺点：不支持动态添加任务（如果一定想要动态创建任务也是支持的，参见：<a href="https://github.com/xuxueli/xxl-job/issues/277">xxl-job issue277</a>）。</li>
</ul>
<h3 id="powerjob">PowerJob<a hidden class="anchor" aria-hidden="true" href="#powerjob">#</a></h3>
<p>非常值得关注的一个分布式任务调度框架，分布式任务调度领域的新星。目前，已经有很多公司接入比如 OPPO、京东、中通、思科。</p>
<p>这个框架的诞生也挺有意思的，PowerJob 的作者当时在阿里巴巴实习过，阿里巴巴那会使用的是内部自研的 SchedulerX（阿里云付费产品）。实习期满之后，PowerJob 的作者离开了阿里巴巴。想着说自研一个 SchedulerX，防止哪天 SchedulerX 满足不了需求，于是 PowerJob 就诞生了。</p>
<p>更多关于 PowerJob 的故事，小伙伴们可以去看看 PowerJob 作者的视频 <a href="https://www.bilibili.com/video/BV1SK411A7F3/">《我和我的任务调度中间件》</a>。简单点概括就是：“游戏没啥意思了，我要扛起了新一代分布式任务调度与计算框架的大旗！”。</p>
<p>由于 SchedulerX 属于人民币产品，我这里就不过多介绍。PowerJob 官方也对比过其和 QuartZ、XXL-JOB 以及 SchedulerX。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/quartz-xxljob-schedulerx2.0-powerjob-comparison.png"></p>
<h2 id="总结-1">总结<a hidden class="anchor" aria-hidden="true" href="#总结-1">#</a></h2>
<p>这篇文章中，我主要介绍了：</p>
<ul>
<li><strong>定时任务的相关概念</strong>：为什么需要定时任务、定时任务中的核心角色、分布式定时任务。</li>
<li><strong>定时任务的技术选型</strong>：XXL-JOB 2015 年推出，已经经过了很多年的考验。XXL-JOB 轻量级，并且使用起来非常简单。虽然存在性能瓶颈，但是，在绝大多数情况下，对于企业的基本需求来说是没有影响的。PowerJob 属于分布式任务调度领域里的新星，其稳定性还有待继续考察。ElasticJob 由于在架构设计上是基于 Zookeeper ，而 XXL-JOB 是基于数据库，性能方面的话，ElasticJob 略胜一筹。</li>
</ul>
<p>这篇文章并没有介绍到实际使用，但是，并不代表实际使用不重要。我在写这篇文章之前，已经动手写过相应的 Demo。像 Quartz，我在大学那会就用过。不过，当时用的是 Spring 。为了能够更好地体验，我自己又在 Spring Boot 上实际体验了一下。如果你并没有实际使用某个框架，就直接说它并不好用的话，是站不住脚的。</p>
<h1 id="web-实时消息推送详解">Web 实时消息推送详解<a hidden class="anchor" aria-hidden="true" href="#web-实时消息推送详解">#</a></h1>
<h2 id="什么是消息推送">什么是消息推送？<a hidden class="anchor" aria-hidden="true" href="#什么是消息推送">#</a></h2>
<p>推送的场景比较多，比如有人关注我的公众号，这时我就会收到一条推送消息，以此来吸引我点击打开应用。</p>
<p>消息推送通常是指网站的运营工作等人员，通过某种工具对用户当前网页或移动设备 APP 进行的主动消息推送。</p>
<p>消息推送一般又分为 Web 端消息推送和移动端消息推送。</p>
<p>移动端消息推送示例：</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/IKleJ9auR1Ojdicyr0bH.png"></p>
<p>Web 端消息推送示例：</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/image-20220819100512941.png"></p>
<p>在具体实现之前，咱们再来分析一下前边的需求，其实功能很简单，只要触发某个事件（主动分享了资源或者后台主动推送消息），Web 页面的通知小红点就会实时的 <code>+1</code> 就可以了。</p>
<p>通常在服务端会有若干张消息推送表，用来记录用户触发不同事件所推送不同类型的消息，前端主动查询（拉）或者被动接收（推）用户所有未读的消息数。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/1460000042192384.png"></p>
<p>消息推送无非是推（push）和拉（pull）两种形式，下边我们逐个了解下。</p>
<h2 id="消息推送常见方案">消息推送常见方案<a hidden class="anchor" aria-hidden="true" href="#消息推送常见方案">#</a></h2>
<h3 id="短轮询">短轮询<a hidden class="anchor" aria-hidden="true" href="#短轮询">#</a></h3>
<p><strong>轮询(polling)</strong> 应该是实现消息推送方案中最简单的一种，这里我们暂且将轮询分为短轮询和长轮询。</p>
<p>短轮询很好理解，指定的时间间隔，由浏览器向服务器发出 HTTP 请求，服务器实时返回未读消息数据给客户端，浏览器再做渲染显示。</p>
<p>一个简单的 JS 定时器就可以搞定，每秒钟请求一次未读消息数接口，返回的数据展示即可。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span>setInterval(() =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f">// 方法请求
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>  messageCount().then((res) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (res.code === <span style="color:#ff0;font-weight:bold">200</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">this</span>.messageCount = res.data;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>}, <span style="color:#ff0;font-weight:bold">1000</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果还是可以的，短轮询实现固然简单，缺点也是显而易见，由于推送数据并不会频繁变更，无论后端此时是否有新的消息产生，客户端都会进行请求，势必会对服务端造成很大压力，浪费带宽和服务器资源。</p>
<h3 id="长轮询">长轮询<a hidden class="anchor" aria-hidden="true" href="#长轮询">#</a></h3>
<p>长轮询是对上边短轮询的一种改进版本，在尽可能减少对服务器资源浪费的同时，保证消息的相对实时性。长轮询在中间件中应用的很广泛，比如 Nacos 和 Apollo 配置中心，消息队列 Kafka、RocketMQ 中都有用到长轮询。</p>
<p><a href="https://mp.weixin.qq.com/s/94ftESkDoZI9gAGflLiGwg">Nacos 配置中心交互模型是 push 还是 pull？</a>一文中我详细介绍过 Nacos 长轮询的实现原理，感兴趣的小伙伴可以瞅瞅。</p>
<p>长轮询其实原理跟轮询差不多，都是采用轮询的方式。不过，如果服务端的数据没有发生变更，会 一直 hold 住请求，直到服务端的数据发生变化，或者等待一定时间超时才会返回。返回后，客户端又会立即再次发起下一次长轮询。</p>
<p>这次我使用 Apollo 配置中心实现长轮询的方式，应用了一个类<code>DeferredResult</code>，它是在 Servlet3.0 后经过 Spring 封装提供的一种异步请求机制，直意就是延迟结果。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/1460000042192386.png"></p>
<p><code>DeferredResult</code>可以允许容器线程快速释放占用的资源，不阻塞请求线程，以此接受更多的请求提升系统的吞吐量，然后启动异步工作线程处理真正的业务逻辑，处理完成调用<code>DeferredResult.setResult(200)</code>提交响应结果。</p>
<p>下边我们用长轮询来实现消息推送。</p>
<p>因为一个 ID 可能会被多个长轮询请求监听，所以我采用了 Guava 包提供的<code>Multimap</code>结构存放长轮询，一个 key 可以对应多个 value。一旦监听到 key 发生变化，对应的所有长轮询都会响应。前端得到非请求超时的状态码，知晓数据变更，主动查询未读消息数接口，更新页面数据。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span>@RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/polling&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PollingController {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 存放监听某个Id的长轮询集合</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 线程同步结构</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Multimap&lt;String, DeferredResult&lt;String&gt;&gt; watchRequests = Multimaps.<span style="color:#007f7f">synchronizedMultimap</span>(HashMultimap.<span style="color:#007f7f">create</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 设置监听
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @GetMapping(path = <span style="color:#0ff;font-weight:bold">&#34;watch/{id}&#34;</span>)
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> DeferredResult&lt;String&gt; watch(@PathVariable String id) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 延迟对象设置超时时间</span>
</span></span><span style="display:flex;"><span>        DeferredResult&lt;String&gt; deferredResult = <span style="color:#fff;font-weight:bold">new</span> DeferredResult&lt;&gt;(TIME_OUT);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 异步请求完成时移除 key，防止内存溢出</span>
</span></span><span style="display:flex;"><span>        deferredResult.<span style="color:#007f7f">onCompletion</span>(() -&gt; {
</span></span><span style="display:flex;"><span>            watchRequests.<span style="color:#007f7f">remove</span>(id, deferredResult);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 注册长轮询请求</span>
</span></span><span style="display:flex;"><span>        watchRequests.<span style="color:#007f7f">put</span>(id, deferredResult);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> deferredResult;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 变更数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @GetMapping(path = <span style="color:#0ff;font-weight:bold">&#34;publish/{id}&#34;</span>)
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String publish(@PathVariable String id) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 数据变更 取出监听ID的所有长轮询请求，并一一响应处理</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (watchRequests.<span style="color:#007f7f">containsKey</span>(id)) {
</span></span><span style="display:flex;"><span>            Collection&lt;DeferredResult&lt;String&gt;&gt; deferredResults = watchRequests.<span style="color:#007f7f">get</span>(id);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (DeferredResult&lt;String&gt; deferredResult : deferredResults) {
</span></span><span style="display:flex;"><span>                deferredResult.<span style="color:#007f7f">setResult</span>(<span style="color:#0ff;font-weight:bold">&#34;我更新了&#34;</span> + <span style="color:#fff;font-weight:bold">new</span> Date());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;success&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>当请求超过设置的超时时间，会抛出<code>AsyncRequestTimeoutException</code>异常，这里直接用<code>@ControllerAdvice</code>全局捕获统一返回即可，前端获取约定好的状态码后再次发起长轮询请求，如此往复调用。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span>@ControllerAdvice
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AsyncRequestTimeoutHandler {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ResponseStatus(HttpStatus.NOT_MODIFIED)
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    @ExceptionHandler(AsyncRequestTimeoutException.<span style="color:#fff;font-weight:bold">class</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String asyncRequestTimeoutHandler(AsyncRequestTimeoutException e) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#fff;font-weight:bold">out</span>.println(<span style="color:#0ff;font-weight:bold">&#34;异步请求超时&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;304&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们来测试一下，首先页面发起长轮询请求<code>/polling/watch/10086</code>监听消息更变，请求被挂起，不变更数据直至超时，再次发起了长轮询请求；紧接着手动变更数据<code>/polling/publish/10086</code>，长轮询得到响应，前端处理业务逻辑完成后再次发起请求，如此循环往复。</p>
<p>长轮询相比于短轮询在性能上提升了很多，但依然会产生较多的请求，这是它的一点不完美的地方。</p>
<h3 id="iframe-流">iframe 流<a hidden class="anchor" aria-hidden="true" href="#iframe-流">#</a></h3>
<p>iframe 流就是在页面中插入一个隐藏的<code>&lt;iframe&gt;</code>标签，通过在<code>src</code>中请求消息数量 API 接口，由此在服务端和客户端之间创建一条长连接，服务端持续向<code>iframe</code>传输数据。</p>
<p>传输的数据通常是 HTML、或是内嵌的 JavaScript 脚本，来达到实时更新页面的效果。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/1460000042192388.png"></p>
<p>这种方式实现简单，前端只要一个<code>&lt;iframe&gt;</code>标签搞定了</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="font-weight:bold">iframe</span> <span style="color:#007f7f">src</span>=<span style="color:#0ff;font-weight:bold">&#34;/iframe/message&#34;</span> <span style="color:#007f7f">style</span>=<span style="color:#0ff;font-weight:bold">&#34;display:none&#34;</span>&gt;&lt;/<span style="font-weight:bold">iframe</span>&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端直接组装 HTML、JS 脚本数据向 response 写入就行了</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span>@RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/iframe&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> IframeController {
</span></span><span style="display:flex;"><span>    @GetMapping(path = <span style="color:#0ff;font-weight:bold">&#34;message&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> message(HttpServletResponse response) <span style="color:#fff;font-weight:bold">throws</span> IOException, InterruptedException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> (<span style="color:#fff;font-weight:bold">true</span>) {
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">setHeader</span>(<span style="color:#0ff;font-weight:bold">&#34;Pragma&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;no-cache&#34;</span>);
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">setDateHeader</span>(<span style="color:#0ff;font-weight:bold">&#34;Expires&#34;</span>, 0);
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">setHeader</span>(<span style="color:#0ff;font-weight:bold">&#34;Cache-Control&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;no-cache,no-store&#34;</span>);
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">setStatus</span>(HttpServletResponse.<span style="color:#007f7f">SC_OK</span>);
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">print</span>(<span style="color:#0ff;font-weight:bold">&#34; &lt;script type=\&#34;text/javascript\&#34;&gt;\n&#34;</span> +
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;parent.document.getElementById(&#39;clock&#39;).innerHTML = \&#34;&#34;</span> + count.<span style="color:#007f7f">get</span>() + <span style="color:#0ff;font-weight:bold">&#34;\&#34;;&#34;</span> +
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;parent.document.getElementById(&#39;count&#39;).innerHTML = \&#34;&#34;</span> + count.<span style="color:#007f7f">get</span>() + <span style="color:#0ff;font-weight:bold">&#34;\&#34;;&#34;</span> +
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;&lt;/script&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>iframe 流的服务器开销很大，而且 IE、Chrome 等浏览器一直会处于 loading 状态，图标会不停旋转，简直是强迫症杀手。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/1460000042192389.png"></p>
<p>iframe 流非常不友好，强烈不推荐。</p>
<h3 id="sse">SSE<a hidden class="anchor" aria-hidden="true" href="#sse">#</a></h3>
<p>很多人可能不知道，服务端向客户端推送消息，其实除了可以用<code>WebSocket</code>这种耳熟能详的机制外，还有一种服务器发送事件(Server-Sent Events)，简称 SSE。这是一种服务器端到客户端(浏览器)的单向消息推送。</p>
<p>SSE 基于 HTTP 协议的，我们知道一般意义上的 HTTP 协议是无法做到服务端主动向客户端推送消息的，但 SSE 是个例外，它变换了一种思路。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/1460000042192390.png"></p>
<p>SSE 在服务器和客户端之间打开一个单向通道，服务端响应的不再是一次性的数据包而是<code>text/event-stream</code>类型的数据流信息，在有数据变更时从服务器流式传输到客户端。</p>
<p>整体的实现思路有点类似于在线视频播放，视频流会连续不断的推送到浏览器，你也可以理解成，客户端在完成一次用时很长（网络不畅）的下载。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/1460000042192391.png"></p>
<p>SSE 与 WebSocket 作用相似，都可以建立服务端与浏览器之间的通信，实现服务端向客户端推送消息，但还是有些许不同：</p>
<ul>
<li>SSE 是基于 HTTP 协议的，它们不需要特殊的协议或服务器实现即可工作；WebSocket 需单独服务器来处理协议。</li>
<li>SSE 单向通信，只能由服务端向客户端单向通信；WebSocket 全双工通信，即通信的双方可以同时发送和接受信息。</li>
<li>SSE 实现简单开发成本低，无需引入其他组件；WebSocket 传输数据需做二次解析，开发门槛高一些。</li>
<li>SSE 默认支持断线重连；WebSocket 则需要自己实现。</li>
<li>SSE 只能传送文本消息，二进制数据需要经过编码后传送；WebSocket 默认支持传送二进制数据。</li>
</ul>
<p><strong>SSE 与 WebSocket 该如何选择？</strong></p>
<blockquote>
<p>技术并没有好坏之分，只有哪个更合适</p>
</blockquote>
<p>SSE 好像一直不被大家所熟知，一部分原因是出现了 WebSocket，这个提供了更丰富的协议来执行双向、全双工通信。对于游戏、即时通信以及需要双向近乎实时更新的场景，拥有双向通道更具吸引力。</p>
<p>但是，在某些情况下，不需要从客户端发送数据。而你只需要一些服务器操作的更新。比如：站内信、未读消息数、状态更新、股票行情、监控数量等场景，SEE 不管是从实现的难易和成本上都更加有优势。此外，SSE 具有 WebSocket 在设计上缺乏的多种功能，例如：自动重新连接、事件 ID 和发送任意事件的能力。</p>
<p>前端只需进行一次 HTTP 请求，带上唯一 ID，打开事件流，监听服务端推送的事件就可以了</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>&lt;script&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">let</span> source = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">let</span> userId = <span style="color:#ff0;font-weight:bold">7777</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">window</span>.EventSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 建立连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        source = <span style="color:#fff;font-weight:bold">new</span> EventSource(<span style="color:#0ff;font-weight:bold">&#39;http://localhost:7777/sse/sub/&#39;</span>+userId);
</span></span><span style="display:flex;"><span>        setMessageInnerHTML(<span style="color:#0ff;font-weight:bold">&#34;连接用户=&#34;</span> + userId);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * 连接一旦建立，就会触发open事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * 另一种写法：source.onopen = function (event) {}
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>        source.addEventListener(<span style="color:#0ff;font-weight:bold">&#39;open&#39;</span>, <span style="color:#fff;font-weight:bold">function</span> (e) {
</span></span><span style="display:flex;"><span>            setMessageInnerHTML(<span style="color:#0ff;font-weight:bold">&#34;建立连接。。。&#34;</span>);
</span></span><span style="display:flex;"><span>        }, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * 客户端收到服务器发来的数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * 另一种写法：source.onmessage = function (event) {}
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>        source.addEventListener(<span style="color:#0ff;font-weight:bold">&#39;message&#39;</span>, <span style="color:#fff;font-weight:bold">function</span> (e) {
</span></span><span style="display:flex;"><span>            setMessageInnerHTML(e.data);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        setMessageInnerHTML(<span style="color:#0ff;font-weight:bold">&#34;你的浏览器不支持SSE&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f00">/script&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端的实现更简单，创建一个<code>SseEmitter</code>对象放入<code>sseEmitterMap</code>进行管理</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> Map&lt;String, SseEmitter&gt; sseEmitterMap = <span style="color:#fff;font-weight:bold">new</span> ConcurrentHashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 创建连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> SseEmitter connect(String userId) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 设置超时时间，0表示不过期。默认30秒</span>
</span></span><span style="display:flex;"><span>        SseEmitter sseEmitter = <span style="color:#fff;font-weight:bold">new</span> SseEmitter(0L);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 注册回调</span>
</span></span><span style="display:flex;"><span>        sseEmitter.<span style="color:#007f7f">onCompletion</span>(completionCallBack(userId));
</span></span><span style="display:flex;"><span>        sseEmitter.<span style="color:#007f7f">onError</span>(errorCallBack(userId));
</span></span><span style="display:flex;"><span>        sseEmitter.<span style="color:#007f7f">onTimeout</span>(timeoutCallBack(userId));
</span></span><span style="display:flex;"><span>        sseEmitterMap.<span style="color:#007f7f">put</span>(userId, sseEmitter);
</span></span><span style="display:flex;"><span>        count.<span style="color:#007f7f">getAndIncrement</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> sseEmitter;
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;创建新的sse连接异常，当前用户：{}&#34;</span>, userId);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 给指定用户发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> sendMessage(String userId, String message) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (sseEmitterMap.<span style="color:#007f7f">containsKey</span>(userId)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            sseEmitterMap.<span style="color:#007f7f">get</span>(userId).<span style="color:#007f7f">send</span>(message);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;用户[{}]推送异常:{}&#34;</span>, userId, e.<span style="color:#007f7f">getMessage</span>());
</span></span><span style="display:flex;"><span>            removeUser(userId);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>注意：</strong> SSE 不支持 IE 浏览器，对其他主流浏览器兼容性做的还不错。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/1460000042192393.png"></p>
<h3 id="websocket">Websocket<a hidden class="anchor" aria-hidden="true" href="#websocket">#</a></h3>
<p>Websocket 应该是大家都比较熟悉的一种实现消息推送的方式，上边我们在讲 SSE 的时候也和 Websocket 进行过比较。</p>
<p>是一种在 TCP 连接上进行全双工通信的协议，建立客户端和服务器之间的通信渠道。浏览器和服务器仅需一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/1460000042192394.png"></p>
<p>SpringBoot 整合 Websocket，先引入 Websocket 相关的工具包，和 SSE 相比额外的开发成本。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#007f7f">&lt;!-- 引入websocket --&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-websocket<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端使用<code>@ServerEndpoint</code>注解标注当前类为一个 WebSocket 服务器，客户端可以通过<code>ws://localhost:7777/webSocket/10086</code>来连接到 WebSocket 服务器端。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@Slf4j
</span></span><span style="display:flex;"><span>@ServerEndpoint(<span style="color:#0ff;font-weight:bold">&#34;/websocket/{userId}&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WebSocketServer {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//与某个客户端的连接会话，需要通过它来给客户端发送数据</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Session session;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> CopyOnWriteArraySet&lt;WebSocketServer&gt; webSockets = <span style="color:#fff;font-weight:bold">new</span> CopyOnWriteArraySet&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 用来存在线连接数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;String, Session&gt; sessionPool = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;String, Session&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 链接成功调用的方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @OnOpen
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onOpen(Session session, @PathParam(value = <span style="color:#0ff;font-weight:bold">&#34;userId&#34;</span>) String userId) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">session</span> = session;
</span></span><span style="display:flex;"><span>            webSockets.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>            sessionPool.<span style="color:#007f7f">put</span>(userId, session);
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;websocket消息: 有新的连接，总数为:&#34;</span> + webSockets.<span style="color:#007f7f">size</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 收到客户端消息后调用的方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @OnMessage
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onMessage(String message) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;websocket消息: 收到客户端消息:&#34;</span> + message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 此为单点消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendOneMessage(String userId, String message) {
</span></span><span style="display:flex;"><span>        Session session = sessionPool.<span style="color:#007f7f">get</span>(userId);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (session != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; session.<span style="color:#007f7f">isOpen</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;websocket消: 单点消息:&#34;</span> + message);
</span></span><span style="display:flex;"><span>                session.<span style="color:#007f7f">getAsyncRemote</span>().<span style="color:#007f7f">sendText</span>(message);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>                e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>前端初始化打开 WebSocket 连接，并监听连接状态，接收服务端数据或向服务端发送数据。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>&lt;script&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">var</span> ws = <span style="color:#fff;font-weight:bold">new</span> WebSocket(<span style="color:#0ff;font-weight:bold">&#39;ws://localhost:7777/webSocket/10086&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 获取连接状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    console.log(<span style="color:#0ff;font-weight:bold">&#39;ws连接状态：&#39;</span> + ws.readyState);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//监听是否连接成功
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ws.onopen = <span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>        console.log(<span style="color:#0ff;font-weight:bold">&#39;ws连接状态：&#39;</span> + ws.readyState);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//连接成功则发送一个数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ws.send(<span style="color:#0ff;font-weight:bold">&#39;test1&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 接听服务器发回的信息并处理展示
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ws.onmessage = <span style="color:#fff;font-weight:bold">function</span> (data) {
</span></span><span style="display:flex;"><span>        console.log(<span style="color:#0ff;font-weight:bold">&#39;接收到来自服务器的消息：&#39;</span>);
</span></span><span style="display:flex;"><span>        console.log(data);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//完成通信后关闭WebSocket连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ws.close();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 监听连接关闭事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ws.onclose = <span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 监听整个过程中websocket的状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        console.log(<span style="color:#0ff;font-weight:bold">&#39;ws连接状态：&#39;</span> + ws.readyState);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 监听并处理error事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ws.onerror = <span style="color:#fff;font-weight:bold">function</span> (error) {
</span></span><span style="display:flex;"><span>        console.log(error);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">function</span> sendMessage() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> content = $(<span style="color:#0ff;font-weight:bold">&#34;#message&#34;</span>).val();
</span></span><span style="display:flex;"><span>        $.ajax({
</span></span><span style="display:flex;"><span>            url: <span style="color:#0ff;font-weight:bold">&#39;/socket/publish?userId=10086&amp;message=&#39;</span> + content,
</span></span><span style="display:flex;"><span>            type: <span style="color:#0ff;font-weight:bold">&#39;GET&#39;</span>,
</span></span><span style="display:flex;"><span>            data: { <span style="color:#0ff;font-weight:bold">&#34;id&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;7777&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;content&#34;</span>: content },
</span></span><span style="display:flex;"><span>            success: <span style="color:#fff;font-weight:bold">function</span> (data) {
</span></span><span style="display:flex;"><span>                console.log(data)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f00">/script&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>页面初始化建立 WebSocket 连接，之后就可以进行双向通信了，效果还不错。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/1460000042192395.png"></p>
<h3 id="mqtt">MQTT<a hidden class="anchor" aria-hidden="true" href="#mqtt">#</a></h3>
<p><strong>什么是 MQTT 协议？</strong></p>
<p>MQTT (Message Queue Telemetry Transport)是一种基于发布/订阅（publish/subscribe）模式的轻量级通讯协议，通过订阅相应的主题来获取消息，是物联网（Internet of Thing）中的一个标准传输协议。</p>
<p>该协议将消息的发布者（publisher）与订阅者（subscriber）进行分离，因此可以在不可靠的网络环境中，为远程连接的设备提供可靠的消息服务，使用方式与传统的 MQ 有点类似。</p>
<p><img loading="lazy" src="/posts/interview/19_%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1_%E5%9F%BA%E7%A1%80_%E9%9D%A2%E8%AF%95%E9%A2%98/1460000022986325.png"></p>
<p>TCP 协议位于传输层，MQTT 协议位于应用层，MQTT 协议构建于 TCP/IP 协议上，也就是说只要支持 TCP/IP 协议栈的地方，都可以使用 MQTT 协议。</p>
<p><strong>为什么要用 MQTT 协议？</strong></p>
<p>MQTT 协议为什么在物联网（IOT）中如此受偏爱？而不是其它协议，比如我们更为熟悉的 HTTP 协议呢？</p>
<ul>
<li>首先 HTTP 协议它是一种同步协议，客户端请求后需要等待服务器的响应。而在物联网（IOT）环境中，设备会很受制于环境的影响，比如带宽低、网络延迟高、网络通信不稳定等，显然异步消息协议更为适合 IOT 应用程序。</li>
<li>HTTP 是单向的，如果要获取消息客户端必须发起连接，而在物联网（IOT）应用程序中，设备或传感器往往都是客户端，这意味着它们无法被动地接收来自网络的命令。</li>
<li>通常需要将一条命令或者消息，发送到网络上的所有设备上。HTTP 要实现这样的功能不但很困难，而且成本极高。</li>
</ul>
<p>具体的 MQTT 协议介绍和实践，这里我就不再赘述了，大家可以参考我之前的两篇文章，里边写的也都很详细了。</p>
<ul>
<li>MQTT 协议的介绍：<a href="https://mp.weixin.qq.com/s/udFE6k9pPetIWsa6KeErrA">我也没想到 SpringBoot + RabbitMQ 做智能家居，会这么简单</a></li>
<li>MQTT 实现消息推送：<a href="https://mp.weixin.qq.com/s/U-fUGr9i1MVa4PoVyiDFCg">未读消息（小红点），前端 与 RabbitMQ 实时消息推送实践，贼简单~</a></li>
</ul>
<h2 id="总结-2">总结<a hidden class="anchor" aria-hidden="true" href="#总结-2">#</a></h2>
<table>
<thead>
<tr>
<th></th>
<th>介绍</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>短轮询</td>
<td>客户端定时向服务端发送请求，服务端直接返回响应数据（即使没有数据更新）</td>
<td>简单、易理解、易实现</td>
<td>实时性太差，无效请求太多，频繁建立连接太耗费资源</td>
</tr>
<tr>
<td>长轮询</td>
<td>与短轮询不同是，长轮询接收到客户端请求之后等到有数据更新才返回请求</td>
<td>减少了无效请求</td>
<td>挂起请求会导致资源浪费</td>
</tr>
<tr>
<td>iframe 流</td>
<td>服务端和客户端之间创建一条长连接，服务端持续向<code>iframe</code>传输数据。</td>
<td>简单、易理解、易实现</td>
<td>维护一个长连接会增加开销，效果太差（图标会不停旋转）</td>
</tr>
<tr>
<td>SSE</td>
<td>一种服务器端到客户端(浏览器)的单向消息推送。</td>
<td>简单、易实现，功能丰富</td>
<td>不支持双向通信</td>
</tr>
<tr>
<td>WebSocket</td>
<td>除了最初建立连接时用 HTTP 协议，其他时候都是直接基于 TCP 协议进行通信的，可以实现客户端和服务端的全双工通信。</td>
<td>性能高、开销小</td>
<td>对开发人员要求更高，实现相对复杂一些</td>
</tr>
<tr>
<td>MQTT</td>
<td>基于发布/订阅（publish/subscribe）模式的轻量级通讯协议，通过订阅相应的主题来获取消息。</td>
<td>成熟稳定，轻量级</td>
<td>对开发人员要求更高，实现相对复杂一些</td>
</tr>
</tbody>
</table>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://009965.xyz/tags/interview/">Interview</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://009965.xyz/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>