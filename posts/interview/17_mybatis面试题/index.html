<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>17_MyBatis面试题 | Wjy&#39;s Blog</title>
<meta name="keywords" content="interview">
<meta name="description" content="#{} 和 ${} 的区别是什么？ 在 MyBatis 中，#{} 和 ${} 都是用来处理 SQL 语句中的参数占位符。 #{} - 参数占位符（推荐使用） 会被解析为 JDBC 预编译语句（PreparedS">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://009965.xyz/posts/interview/17_mybatis%E9%9D%A2%E8%AF%95%E9%A2%98/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://009965.xyz/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://009965.xyz/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://009965.xyz/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://009965.xyz/apple-touch-icon.png">
<link rel="mask-icon" href="https://009965.xyz/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://009965.xyz/posts/interview/17_mybatis%E9%9D%A2%E8%AF%95%E9%A2%98/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:url" content="https://009965.xyz/posts/interview/17_mybatis%E9%9D%A2%E8%AF%95%E9%A2%98/">
  <meta property="og:site_name" content="Wjy&#39;s Blog">
  <meta property="og:title" content="17_MyBatis面试题">
  <meta property="og:description" content="#{} 和 ${} 的区别是什么？ 在 MyBatis 中，#{} 和 ${} 都是用来处理 SQL 语句中的参数占位符。 #{} - 参数占位符（推荐使用） 会被解析为 JDBC 预编译语句（PreparedS">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-07-31T05:00:00+00:00">
    <meta property="article:modified_time" content="2023-07-31T05:00:00+00:00">
    <meta property="article:tag" content="Interview">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="17_MyBatis面试题">
<meta name="twitter:description" content="#{} 和 ${} 的区别是什么？ 在 MyBatis 中，#{} 和 ${} 都是用来处理 SQL 语句中的参数占位符。 #{} - 参数占位符（推荐使用） 会被解析为 JDBC 预编译语句（PreparedS">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://009965.xyz/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "17_MyBatis面试题",
      "item": "https://009965.xyz/posts/interview/17_mybatis%E9%9D%A2%E8%AF%95%E9%A2%98/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "17_MyBatis面试题",
  "name": "17_MyBatis面试题",
  "description": "#{} 和 ${} 的区别是什么？ 在 MyBatis 中，#{} 和 ${} 都是用来处理 SQL 语句中的参数占位符。 #{} - 参数占位符（推荐使用） 会被解析为 JDBC 预编译语句（PreparedS",
  "keywords": [
    "interview"
  ],
  "articleBody": "#{} 和 ${} 的区别是什么？ 在 MyBatis 中，#{} 和 ${} 都是用来处理 SQL 语句中的参数占位符。\n#{} - 参数占位符（推荐使用）\n会被解析为 JDBC 预编译语句（PreparedStatement）中的 ? 占位符 会进行类型匹配和自动类型转换 具有防止 SQL 注入攻击的功能 ${} - 字符串替换占位符\n会直接将参数值替换到 SQL 语句中 不会进行预编译处理 存在 SQL 注入风险 #{}适用于大多数场景，${}适用于动态表名，动态列名。\nMybatis的优缺点 Mybatis 的优点：\n与 JDBC 相比，Mybatis 减少了复杂的代码配置，让开发者不用过于关注繁琐连接操作。 通过将 SQL 语句保持在 XML 文件或注解中，很好的将逻辑层与数据层分离，灵活性高。 内置一级缓存和二级缓存机制，可提高数据库查询性能。 支持多种数据库和连接池，在多种开发环境中都能使用。 提供了强大的动态 SQL 功能，能够根据条件灵活生成 SQL 语句。 与 Hibernate 相比，MyBatis 更加轻量级，也提供了更多的 SQL 控制权，适合复杂查询和高性能需求的场景。 Mybatis 的缺点：\nMyBatis 不会像全自动 ORM 框架（如 Hibernate）那样自动生成 SQL 语句， 对于一些简单的查询修改操作，也需要自己写 SQL，增加了工作量。 对大型项目来说，可能需要大量的 xml 文件，会导致配置的复杂性和维护的困难。 因为 MyBatis 缺乏 SQL 自动能力，因此维护成本会高一些，例如修改了表结构或字段名或迁移了数据库，都需要手动修改相应的 SQL，还容易漏改。 缓存会产生脏读，因此一二级缓存都不建议开启。 MyBatis 写个 Xml 映射文件，再写个 DAO 接口就能执行，这个原理是什么？ 核心原理是 JDBC 的能力 和 动态代理，通过解析 XML 映射文件和动态生成 DAO 接口实现类来完成 SQL 的执行。以下是详细的执行原理：\n1）加载配置和 Mapper 映射文件：\nMyBatis 启动时，通过配置文件（mybatis-config.xml）加载数据库连接信息和 Mapper 映射文件（Mapper.xml）。 XML 文件中的 SQL 被解析为内部的 MappedStatement 对象，包含 SQL 语句、参数映射规则和返回结果映射规则。 2）动态代理实现 DAO 接口：\nMyBatis 为每个 DAO 接口生成一个动态代理类（MapperProxy），拦截接口方法调用。 动态代理的核心是根据方法名和参数匹配到对应的 MappedStatement，然后调用 JDBC 来执行 SQL。 3）通过 JDBC 执行 SQL：\nMyBatis 的 SqlSession 是对 JDBC 的封装，它的核心是使用 PreparedStatement 来完成 SQL 的执行。 根据 XML 中定义的 SQL 和 DAO 接口方法传入的参数，生成完整的 SQL 查询，并将参数通过占位符（?）绑定到 PreparedStatement。 最终通过 JDBC 执行 SQL，并获取 ResultSet。 4）结果映射：\nJDBC 的查询结果（ResultSet）会被 MyBatis 的 ResultMap 或 resultType 映射为 DAO 接口方法的返回值类型（如 POJO、Map 或 List）。 详细说说 MyBatis 的执行流程 MyBatis 的执行原理可以概括为以下几个关键步骤：\n‌初始化‌：加载配置文件和xxxMapper.xml文件。创建全局配置对象Configuration，在其中保存配置信息、注册Mapper接口和创建sql语句对象MappedStatement。另创建 SqlSessionFactory。 ‌获取 SqlSession‌：通过 SqlSessionFactory 获取 SqlSession 实例。 ‌获取 Mapper 代理对象‌：通过 SqlSession 获取 Mapper 接口的代理对象。 ‌执行代理对象中的方法‌：调用 Mapper 方法时， MapperProxy 代理对象的invoke方法根据传来的方法名和参数类型，找到对应的sql语句对象 MappedStatement，并创建 Executor 执行器执行 SQL 语句。 ‌返回结果‌：将执行结果映射到java对象中返回给调用者。 详细步骤：\n1.初始化阶段\n‌加载配置文件‌：这是MyBatis初始化的第一步，涉及加载mybatis-config.xml全局配置文件和Mapper XML文件（如xxxxMapper.xml）。这些文件包含了数据库连接信息、事务管理器配置、SQL映射语句等关键信息。\n‌创建Configuration全局配置对象‌：在加载并解析mybatis-config.xml配置文件的过程中，MyBatis会创建并初始化Configuration对象。这个对象是MyBatis的全局配置对象，它持有MyBatis运行所需的所有配置信息。\n‌注册Mapper接口‌：在创建Configuration对象的同时或之后，MyBatis会扫描Mapper XML文件或注解，并根据其中的信息注册Mapper接口。这一步骤并不会直接创建Mapper接口的实例，而是创建了MapperProxyFactory实例，并将它们与Mapper接口一一关联起来，存储在Configuration对象的某个结构中（如MapperRegistry）。当需要执行某个Mapper接口中的方法时，MyBatis会使用对应的MapperProxyFactory实例来创建Mapper接口的代理对象MapperProxy。\n‌创建MappedStatement对象：在扫描Mapper XML文件或注解时，对于Mapper XML文件中的每个SQL映射语句（、、、），MyBatis会解析其内容，并创建一个MappedStatement对象。这些对象包含了执行SQL语句所需的所有信息，如SQL语句本身、参数类型、返回类型等。MappedStatement对象会被添加到Configuration对象的映射器配置中。\n‌创建SqlSessionFactory：在完成上述步骤后，MyBatis会使用Configuration对象来创建SqlSessionFactory实例。这个工厂是MyBatis的核心，用于生成SqlSession实例，进而执行SQL语句。 Configuration对象是MyBatis的全局配置对象，它包含了MyBatis运行所需的所有配置信息、Mapper接口信息、MappedStatement对象等。\n2.获取 SqlSession\n‌创建 SqlSession‌：通过调用 SqlSessionFactory 的 openSession 方法，可以获取到一个 SqlSession 实例。SqlSession 是 MyBatis 提供的操作数据库的主要接口，它包含了执行 SQL 语句、管理事务和获取 Mapper 代理对象等方法。\n3.获取 Mapper 代理对象 MapperProxy\n‌Mapper 代理对象的生成‌：当调用 SqlSession 的 getMapper 方法时，MyBatis 会根据传入的 Mapper 接口类型，从 MapperRegistry 中找到对应的 MapperProxyFactory 实例。然后，通过该工厂实例创建一个 MapperProxy 对象作为 Mapper 接口的代理对象。\n4.执行 MapperProxy 中的方法\n‌调用 Mapper 方法‌：当通过Mapper接口代理对象 MapperProxy 调用某个方法时，实际上是调用了 MapperProxy 的 invoke 方法。\n‌查找 MappedStatement‌：在 invoke 方法内部，MyBatis 会根据传来的方法名和参数类型，从 Configuration 对象中查找到对应的 MappedStatement 对象。\n‌创建 Executor‌：MyBatis 会根据当前事务的状态和配置信息，创建一个 Executor 执行器对象。Executor 是 MyBatis 执行 SQL 语句的核心组件，它负责处理 SQL 语句的编译、缓存、执行以及结果映射等工作。\n‌执行 SQL 语句‌：Executor 获取连接池或JDBC中的数据库链接Connection，构造Statement对象，使用Statement对象的execute方法执行SQL 语句（Executor 到 MappedStatement 对象获取，获取到的信息包括SQL 语句、输入参数映射、输出结果映射等），通过resultSetHandler获取到执行结果，并将结果映射到 Java 对象中。\n5.返回结果\n‌返回执行结果‌：执行完成后，Executor 将结果返回给 MapperProxy，MapperProxy 再将结果返回给调用者。\n说说 MyBatis 的缓存机制 Mybatis中有一级缓存和二级缓存。一级缓存默认开启，二级缓存默认关闭。查询数据执行数据是：二级缓存-\u003e一级缓存-\u003e数据库。\n一级缓存：分session级别和statement级别。默认是会话session级别，创建一个SqlSession就是一个会话，查询会缓存到会话中，增删改操作会清除会话即缓存。statement粒度更小，指在statement中缓存数据。\n二级缓存：指在同一个namespace下的mapper作用域起作用。\n生产上一般都是关闭Mybatis缓存的。因为一级缓存二级缓存都会因为分布式等问题，频繁增删改清除缓存，缓存就变得可有可无。另外，二级缓存作用域namespace，联表查询时，namespace无法感应到数据的变更，会造成脏数据的问题。\nMyBatis 动态 sql 有什么用？执行原理？有哪些动态 sql？ 动态 SQL 是在 MyBatis 中根据不同的条件、需求动态生成 SQL 语句的一种机制。\n动态sql标签：\n、、、、\n原理：\n解析动态 SQL：MyBatis 会解析 XML 文件中的动态 SQL 标签（if、where、foreach等）。 参数绑定：当执行 SQL 语句时，MyBatis 会根据传入的参数绑定具体的值。 生成最终 SQL：根据参数值和动态 SQL 标签生成最终的 SQL 语句。 执行 SQL：MyBatis 执行生成的 SQL 语句，并返回结果。 Mybatis 如何实现一对一、一对多的关联查询 通过 resultMap 实现，结合标签（一对一），（一对多）。\nMyBatis 是否支持延迟加载？如果支持，它的实现原理是什么？ 延迟加载的定义：在需要用到数据时才进行加载，不需要用到数据时就不加载数据。\nMyBatis对延迟加载的支持：MyBatis支持一对一关联对象和一对多关联集合对象的延迟加载。\n配置延迟加载：在MyBatis配置文件中，可以配置是否启用延迟加载，通过设置 lazyLoadingEnabled=true|false。默认情况下，延迟加载是关闭的。\n延迟加载的底层原理：\n使用CGLIB（Code Generation Library）动态生成目标对象的代理对象。 当调用目标方法时，进入拦截器的 invoke 方法，- 如果发现目标方法的值为 null，则执行 SQL 查询以获取数据。 获取数据后，调用 set 方法设置属性值，- 再次调用目标方法时，属性值已经存在，不再为空。 使用 MyBatis 的 mapper 接口调用时有哪些要求？ 要求 说明 方法名与 id 一致 接口方法名必须与 XML 中 SQL 的 id 完全匹配。 namespace 正确 XML 的 namespace 必须是接口的全限定类名（含包名）。 参数类型匹配 方法输入参数类型需与 parameterType 一致。 返回值类型匹配 方法返回类型需与 resultType 或 resultMap 对应的类型一致。 简述MyBatis 的插件运行原理，以及如何编写一个插件？ 主要是通过动态代理实现，主要是在SQL执行的关键点上进行拦截做增强操作 关键点(只能拦截以下4种)\nExecutor:负责执行增删改查操作 ParameterHandler:负责处理 SQL 语句中的参数 ResultSetHandler：负责处理结果集 StatementHandler：负责处理 SQL 语句 如何编写MyBatis插件\n实现 Interceptor接口:编写一个类，实现MyBatis的Interceptor接口，并定义拦截逻辑。 定义拦截逻辑:在 intercept 方法中实现增强逻辑。使用Invocation 对象调用目标方法。 配置插件:在mybatis-config.xml 文件中配置插件类和参数。 插件常见用途\n性能分析：统计 SQL 的执行时间，输出到日志中。 动态参数注入：在 ParameterHandler 中修改或添加 SQL 参数。 数据脱敏：在 ResultSetHandler 中对查询结果进行脱敏处理。 自动分页：在 StatementHandler 中拦截 SQL，自动添加分页逻辑。 JDBC 编程有哪些不足之处，MyBatis 是如何解决的？ JDBC 不足之处如下：\nJDBC 代码冗余度高，需要手动管理连接（Connection）、预处理语句（PreparedStatement）、结果集（ResultSet），以及关闭这些资源。这样的样板代码非常多，容易出错。 JDBC SQL 语句通常直接硬编码在 Java 代码中，维护性和可读性较差。 JDBC 需要手动处理结果集，特别是在需要处理多表关联查询的情况下，映射逻辑会非常复杂。 JDBC 参数处理复杂，参数的设置和结果集的处理都需要手动完成，且需要明确知道字段和类型，容易出错。 JDBC 事务处理麻烦，事务的开启、提交和回滚需要手动处理。对于复杂的事务逻辑，容易导致资源泄漏或不一致。 Mybatis 刚刚好解决了这些问题：\nMyBatis 提供了一种机制来封装 JDBC 的所有重复代码，减少了代码冗余以及异常处理，让开发人员只需关注 SQL 和业务逻辑。 MyBatis 允许将 SQL 语句配置在 XML 文件或通过注解配置，解决了代码耦合问题，使得代码更加清晰、易维护。 MyBatis 自动将 SQL 查询结果映射到 Java 对象或集合，解决了手动处理结果集问题。 MyBatis 自动处理参数绑定和类型转换，通过 #{} 占位符将参数绑定到 SQL 中，同时自动识别参数类型，减少手动错误 MyBatis 与 Spring 集成后，可以利用 Spring 的声明式事务管理，简化事务的配置和使用，减少代码复杂性。 MyBatis 还内置了缓存机制，提升性能。 JDBC 与 MyBatis 的对比\n特性 JDBC MyBatis 资源管理 手动管理连接和关闭，代码复杂 自动管理资源，通过 SqlSession 简化 SQL 与代码分离 SQL 嵌套在代码中，难以维护 支持 XML 和注解分离 SQL，提高可维护性 参数绑定 手动拼接参数，容易出错 自动绑定参数，支持动态 SQL 结果映射 手动从 ResultSet 提取并映射到对象 自动映射，支持复杂嵌套 事务管理 手动管理事务，易出错 集成 Spring，支持声明式事务 Mybatis 都有哪些 Executor 执行器？它们之间的区别是什么？ SimpleExecutor： 每执行一次 update 或 select，就开启一个 Statement 对象，用完立刻关闭 Statement 对象。 ReuseExecutor： 执行 update 或 select，以 sql 作为 key 查找 Statement 对象，存在就使用，不存在就创建，用完后，不关闭 Statement 对象，而是放置于 Map内，供下一次使用。简言之，就是重复使用 Statement 对象。 BatchExecutor：执行 update（没有 select，JDBC 批处理不支持 select），将所有 sql 都添加到批处理中（addBatch()），等待统一执行（executeBatch()），它缓存了多个 Statement 对象，每个 Statement 对象都是 addBatch()完毕后，等待逐一执行 executeBatch()批处理。与 JDBC 批处理相同。 作用范围：Executor 的这些特点，都严格限制在 SqlSession 生命周期范围内。\nmybatis默认的执行器是SimpleExecutor。\nMyBatis 如何实现数据库类型和 Java 类型的转换的？ MyBatis 类型转换主要依赖于 MyBatis 的 类型处理器（TypeHandler） 机制。\nTypeHandler 的核心作用：\n将 Java 类型转换为 JDBC 类型，用于 SQL 参数设置。 将 JDBC 类型转换为 Java 类型，用于查询结果的映射。 Dao 接口的工作原理是什么？Dao 接口里的方法，参数不同时，方法能重载吗？ 最佳实践中，通常一个 xml 映射文件，都会写一个 Dao 接口与之对应。Dao 接口就是人们常说的 Mapper 接口，接口的全限名，就是映射文件中的 namespace 的值，接口的方法名，就是映射文件中 MappedStatement 的 id 值，接口方法内的参数，就是传递给 sql 的参数。 Mapper 接口是没有实现类的，当调用接口方法时，接口全限名+方法名拼接字符串作为 key 值，可唯一定位一个 MappedStatement ，举例：com.mybatis3.mappers. StudentDao.findStudentById ，可以唯一找到 namespace 为 com.mybatis3.mappers. StudentDao 下面 id = findStudentById 的 MappedStatement 。在 MyBatis 中，每一个 、 、 、 标签，都会被解析为一个 MappedStatement 对象。\nDao 接口里的方法，是不能重载的，因为是全限名+方法名的保存和寻找策略。\nDao 接口里的方法可以重载，但是 Mybatis 的 xml 里面的 ID 不允许重复。\nMybatis 版本 3.3.0，亲测如下：\n1 2 3 4 5 6 7 8 9 /** * Mapper接口里面方法重载 */ public interface StuMapper { List getAllStu(); List getAllStu(@Param(\"id\") Integer id); } 然后在 StuMapper.xml 中利用 Mybatis 的动态 sql 就可以实现。\n1 2 3 4 5 6 7 8 ",
  "wordCount" : "9231",
  "inLanguage": "en",
  "datePublished": "2023-07-31T05:00:00Z",
  "dateModified": "2023-07-31T05:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://009965.xyz/posts/interview/17_mybatis%E9%9D%A2%E8%AF%95%E9%A2%98/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://009965.xyz/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://009965.xyz/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://009965.xyz/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://009965.xyz/">Home</a>&nbsp;»&nbsp;<a href="https://009965.xyz/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      17_MyBatis面试题
    </h1>
    <div class="post-meta"><span title='2023-07-31 05:00:00 +0000 UTC'>2023-07-31</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#-%e5%92%8c--%e7%9a%84%e5%8c%ba%e5%88%ab%e6%98%af%e4%bb%80%e4%b9%88" aria-label="#{} 和 ${} 的区别是什么？">#{} 和 ${} 的区别是什么？</a></li>
                <li>
                    <a href="#mybatis%e7%9a%84%e4%bc%98%e7%bc%ba%e7%82%b9" aria-label="Mybatis的优缺点">Mybatis的优缺点</a></li>
                <li>
                    <a href="#mybatis-%e5%86%99%e4%b8%aa-xml-%e6%98%a0%e5%b0%84%e6%96%87%e4%bb%b6%e5%86%8d%e5%86%99%e4%b8%aa-dao-%e6%8e%a5%e5%8f%a3%e5%b0%b1%e8%83%bd%e6%89%a7%e8%a1%8c%e8%bf%99%e4%b8%aa%e5%8e%9f%e7%90%86%e6%98%af%e4%bb%80%e4%b9%88" aria-label="MyBatis 写个 Xml 映射文件，再写个 DAO 接口就能执行，这个原理是什么？">MyBatis 写个 Xml 映射文件，再写个 DAO 接口就能执行，这个原理是什么？</a></li>
                <li>
                    <a href="#%e8%af%a6%e7%bb%86%e8%af%b4%e8%af%b4-mybatis-%e7%9a%84%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b" aria-label="详细说说 MyBatis 的执行流程">详细说说 MyBatis 的执行流程</a></li>
                <li>
                    <a href="#%e8%af%b4%e8%af%b4-mybatis-%e7%9a%84%e7%bc%93%e5%ad%98%e6%9c%ba%e5%88%b6" aria-label="说说 MyBatis 的缓存机制">说说 MyBatis 的缓存机制</a></li>
                <li>
                    <a href="#mybatis-%e5%8a%a8%e6%80%81-sql-%e6%9c%89%e4%bb%80%e4%b9%88%e7%94%a8%e6%89%a7%e8%a1%8c%e5%8e%9f%e7%90%86%e6%9c%89%e5%93%aa%e4%ba%9b%e5%8a%a8%e6%80%81-sql" aria-label="MyBatis 动态 sql 有什么用？执行原理？有哪些动态 sql？">MyBatis 动态 sql 有什么用？执行原理？有哪些动态 sql？</a></li>
                <li>
                    <a href="#mybatis-%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%b8%80%e5%af%b9%e4%b8%80%e4%b8%80%e5%af%b9%e5%a4%9a%e7%9a%84%e5%85%b3%e8%81%94%e6%9f%a5%e8%af%a2" aria-label="Mybatis 如何实现一对一、一对多的关联查询">Mybatis 如何实现一对一、一对多的关联查询</a></li>
                <li>
                    <a href="#mybatis-%e6%98%af%e5%90%a6%e6%94%af%e6%8c%81%e5%bb%b6%e8%bf%9f%e5%8a%a0%e8%bd%bd%e5%a6%82%e6%9e%9c%e6%94%af%e6%8c%81%e5%ae%83%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e6%98%af%e4%bb%80%e4%b9%88" aria-label="MyBatis 是否支持延迟加载？如果支持，它的实现原理是什么？">MyBatis 是否支持延迟加载？如果支持，它的实现原理是什么？</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-mybatis-%e7%9a%84-mapper-%e6%8e%a5%e5%8f%a3%e8%b0%83%e7%94%a8%e6%97%b6%e6%9c%89%e5%93%aa%e4%ba%9b%e8%a6%81%e6%b1%82" aria-label="使用 MyBatis 的 mapper 接口调用时有哪些要求？">使用 MyBatis 的 mapper 接口调用时有哪些要求？</a></li>
                <li>
                    <a href="#%e7%ae%80%e8%bf%b0mybatis-%e7%9a%84%e6%8f%92%e4%bb%b6%e8%bf%90%e8%a1%8c%e5%8e%9f%e7%90%86%e4%bb%a5%e5%8f%8a%e5%a6%82%e4%bd%95%e7%bc%96%e5%86%99%e4%b8%80%e4%b8%aa%e6%8f%92%e4%bb%b6" aria-label="简述MyBatis 的插件运行原理，以及如何编写一个插件？">简述MyBatis 的插件运行原理，以及如何编写一个插件？</a></li>
                <li>
                    <a href="#jdbc-%e7%bc%96%e7%a8%8b%e6%9c%89%e5%93%aa%e4%ba%9b%e4%b8%8d%e8%b6%b3%e4%b9%8b%e5%a4%84mybatis-%e6%98%af%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3%e7%9a%84" aria-label="JDBC 编程有哪些不足之处，MyBatis 是如何解决的？">JDBC 编程有哪些不足之处，MyBatis 是如何解决的？</a></li>
                <li>
                    <a href="#mybatis-%e9%83%bd%e6%9c%89%e5%93%aa%e4%ba%9b-executor-%e6%89%a7%e8%a1%8c%e5%99%a8%e5%ae%83%e4%bb%ac%e4%b9%8b%e9%97%b4%e7%9a%84%e5%8c%ba%e5%88%ab%e6%98%af%e4%bb%80%e4%b9%88" aria-label="Mybatis 都有哪些 Executor 执行器？它们之间的区别是什么？">Mybatis 都有哪些 Executor 执行器？它们之间的区别是什么？</a></li>
                <li>
                    <a href="#mybatis-%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e6%95%b0%e6%8d%ae%e5%ba%93%e7%b1%bb%e5%9e%8b%e5%92%8c-java-%e7%b1%bb%e5%9e%8b%e7%9a%84%e8%bd%ac%e6%8d%a2%e7%9a%84" aria-label="MyBatis 如何实现数据库类型和 Java 类型的转换的？">MyBatis 如何实现数据库类型和 Java 类型的转换的？</a></li>
                <li>
                    <a href="#dao-%e6%8e%a5%e5%8f%a3%e7%9a%84%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86%e6%98%af%e4%bb%80%e4%b9%88dao-%e6%8e%a5%e5%8f%a3%e9%87%8c%e7%9a%84%e6%96%b9%e6%b3%95%e5%8f%82%e6%95%b0%e4%b8%8d%e5%90%8c%e6%97%b6%e6%96%b9%e6%b3%95%e8%83%bd%e9%87%8d%e8%bd%bd%e5%90%97" aria-label="Dao 接口的工作原理是什么？Dao 接口里的方法，参数不同时，方法能重载吗？">Dao 接口的工作原理是什么？Dao 接口里的方法，参数不同时，方法能重载吗？</a></li>
                <li>
                    <a href="#mybatis-%e6%98%af%e5%a6%82%e4%bd%95%e8%bf%9b%e8%a1%8c%e5%88%86%e9%a1%b5%e7%9a%84%e5%88%86%e9%a1%b5%e6%8f%92%e4%bb%b6%e7%9a%84%e5%8e%9f%e7%90%86%e6%98%af%e4%bb%80%e4%b9%88" aria-label="MyBatis 是如何进行分页的？分页插件的原理是什么？">MyBatis 是如何进行分页的？分页插件的原理是什么？</a></li>
                <li>
                    <a href="#mybatis-%e6%89%a7%e8%a1%8c%e6%89%b9%e9%87%8f%e6%8f%92%e5%85%a5%e8%83%bd%e8%bf%94%e5%9b%9e%e6%95%b0%e6%8d%ae%e5%ba%93%e4%b8%bb%e9%94%ae%e5%88%97%e8%a1%a8%e5%90%97" aria-label="MyBatis 执行批量插入，能返回数据库主键列表吗？">MyBatis 执行批量插入，能返回数据库主键列表吗？</a></li>
                <li>
                    <a href="#mybatis-%e6%98%af%e5%a6%82%e4%bd%95%e5%b0%86-sql-%e6%89%a7%e8%a1%8c%e7%bb%93%e6%9e%9c%e5%b0%81%e8%a3%85%e4%b8%ba%e7%9b%ae%e6%a0%87%e5%af%b9%e8%b1%a1%e5%b9%b6%e8%bf%94%e5%9b%9e%e7%9a%84%e9%83%bd%e6%9c%89%e5%93%aa%e4%ba%9b%e6%98%a0%e5%b0%84%e5%bd%a2%e5%bc%8f" aria-label="MyBatis 是如何将 sql 执行结果封装为目标对象并返回的？都有哪些映射形式？">MyBatis 是如何将 sql 执行结果封装为目标对象并返回的？都有哪些映射形式？</a></li>
                <li>
                    <a href="#mybatis-%e7%9a%84-xml-%e6%98%a0%e5%b0%84%e6%96%87%e4%bb%b6%e4%b8%ad%e4%b8%8d%e5%90%8c%e7%9a%84-xml-%e6%98%a0%e5%b0%84%e6%96%87%e4%bb%b6id-%e6%98%af%e5%90%a6%e5%8f%af%e4%bb%a5%e9%87%8d%e5%a4%8d" aria-label="MyBatis 的 xml 映射文件中，不同的 xml 映射文件，id 是否可以重复？">MyBatis 的 xml 映射文件中，不同的 xml 映射文件，id 是否可以重复？</a></li>
                <li>
                    <a href="#mybatis-%e4%b8%ad%e5%a6%82%e4%bd%95%e6%89%a7%e8%a1%8c%e6%89%b9%e5%a4%84%e7%90%86" aria-label="MyBatis 中如何执行批处理？">MyBatis 中如何执行批处理？</a></li>
                <li>
                    <a href="#mybatis-%e6%98%af%e5%90%a6%e5%8f%af%e4%bb%a5%e6%98%a0%e5%b0%84-enum-%e6%9e%9a%e4%b8%be%e7%b1%bb" aria-label="MyBatis 是否可以映射 Enum 枚举类？">MyBatis 是否可以映射 Enum 枚举类？</a></li>
                <li>
                    <a href="#mybatis-%e6%98%a0%e5%b0%84%e6%96%87%e4%bb%b6%e4%b8%ad%e5%a6%82%e6%9e%9c-a-%e6%a0%87%e7%ad%be%e9%80%9a%e8%bf%87-include-%e5%bc%95%e7%94%a8%e4%ba%86-b-%e6%a0%87%e7%ad%be%e7%9a%84%e5%86%85%e5%ae%b9%e8%af%b7%e9%97%aeb-%e6%a0%87%e7%ad%be%e8%83%bd%e5%90%a6%e5%ae%9a%e4%b9%89%e5%9c%a8-a-%e6%a0%87%e7%ad%be%e7%9a%84%e5%90%8e%e9%9d%a2%e8%bf%98%e6%98%af%e8%af%b4%e5%bf%85%e9%a1%bb%e5%ae%9a%e4%b9%89%e5%9c%a8-a-%e6%a0%87%e7%ad%be%e7%9a%84%e5%89%8d%e9%9d%a2" aria-label="MyBatis 映射文件中，如果 A 标签通过 include 引用了 B 标签的内容，请问，B 标签能否定义在 A 标签的后面，还是说必须定义在 A 标签的前面？">MyBatis 映射文件中，如果 A 标签通过 include 引用了 B 标签的内容，请问，B 标签能否定义在 A 标签的后面，还是说必须定义在 A 标签的前面？</a></li>
                <li>
                    <a href="#%e7%ae%80%e8%bf%b0-mybatis-%e7%9a%84-xml-%e6%98%a0%e5%b0%84%e6%96%87%e4%bb%b6%e5%92%8c-mybatis-%e5%86%85%e9%83%a8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e4%b9%8b%e9%97%b4%e7%9a%84%e6%98%a0%e5%b0%84%e5%85%b3%e7%b3%bb" aria-label="简述 MyBatis 的 xml 映射文件和 MyBatis 内部数据结构之间的映射关系？">简述 MyBatis 的 xml 映射文件和 MyBatis 内部数据结构之间的映射关系？</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%af%b4-mybatis-%e6%98%af%e5%8d%8a%e8%87%aa%e5%8a%a8-orm-%e6%98%a0%e5%b0%84%e5%b7%a5%e5%85%b7%e5%ae%83%e4%b8%8e%e5%85%a8%e8%87%aa%e5%8a%a8%e7%9a%84%e5%8c%ba%e5%88%ab%e5%9c%a8%e5%93%aa%e9%87%8c" aria-label="为什么说 MyBatis 是半自动 ORM 映射工具？它与全自动的区别在哪里？">为什么说 MyBatis 是半自动 ORM 映射工具？它与全自动的区别在哪里？</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="-和--的区别是什么">#{} 和 ${} 的区别是什么？<a hidden class="anchor" aria-hidden="true" href="#-和--的区别是什么">#</a></h1>
<p>在 MyBatis 中，<code>#{}</code> 和 <code>${}</code> 都是用来处理 SQL 语句中的参数占位符。</p>
<p><code>#{}</code> - 参数占位符（推荐使用）</p>
<ul>
<li>会被解析为 JDBC 预编译语句（PreparedStatement）中的 <code>?</code> 占位符</li>
<li>会进行类型匹配和自动类型转换</li>
<li><strong>具有防止 SQL 注入攻击的功能</strong></li>
</ul>
<p><code>${}</code> - 字符串替换占位符</p>
<ul>
<li>会直接将参数值替换到 SQL 语句中</li>
<li>不会进行预编译处理</li>
<li><strong>存在 SQL 注入风险</strong></li>
</ul>
<p><code>#{}</code>适用于大多数场景，<code>${}</code>适用于动态表名，动态列名。</p>
<h1 id="mybatis的优缺点">Mybatis的优缺点<a hidden class="anchor" aria-hidden="true" href="#mybatis的优缺点">#</a></h1>
<p>Mybatis 的优点：</p>
<ol>
<li>与 JDBC 相比，Mybatis 减少了复杂的代码配置，让开发者不用过于关注繁琐连接操作。</li>
<li>通过将 SQL 语句保持在 XML 文件或注解中，很好的将逻辑层与数据层分离，灵活性高。</li>
<li>内置一级缓存和二级缓存机制，可提高数据库查询性能。</li>
<li>支持多种数据库和连接池，在多种开发环境中都能使用。</li>
<li>提供了强大的动态 SQL 功能，能够根据条件灵活生成 SQL 语句。</li>
<li>与 Hibernate 相比，MyBatis 更加轻量级，也提供了更多的 SQL 控制权，适合复杂查询和高性能需求的场景。</li>
</ol>
<p>Mybatis 的缺点：</p>
<ol>
<li>MyBatis 不会像全自动 ORM 框架（如 Hibernate）那样自动生成 SQL 语句， 对于一些简单的查询修改操作，也需要自己写 SQL，<strong>增加了工作量</strong>。</li>
<li>对大型项目来说，可能需要大量的 xml 文件，<strong>会导致配置的复杂性和维护的困难</strong>。</li>
<li>因为 MyBatis 缺乏 SQL 自动能力，因此维护成本会高一些，例如修改了表结构或字段名或迁移了数据库，<strong>都需要手动修改相应的 SQL</strong>，还容易漏改。</li>
<li>缓存会产生脏读，因此一二级缓存都不建议开启。</li>
</ol>
<h1 id="mybatis-写个-xml-映射文件再写个-dao-接口就能执行这个原理是什么">MyBatis 写个 Xml 映射文件，再写个 DAO 接口就能执行，这个原理是什么？<a hidden class="anchor" aria-hidden="true" href="#mybatis-写个-xml-映射文件再写个-dao-接口就能执行这个原理是什么">#</a></h1>
<p>核心原理是 <strong>JDBC 的能力</strong> 和 <strong>动态代理</strong>，通过解析 XML 映射文件和动态生成 DAO 接口实现类来完成 SQL 的执行。以下是详细的执行原理：</p>
<p>1）<strong>加载配置和 Mapper 映射文件</strong>：</p>
<ul>
<li>MyBatis 启动时，通过配置文件（<code>mybatis-config.xml</code>）加载数据库连接信息和 Mapper 映射文件（<code>Mapper.xml</code>）。</li>
<li>XML 文件中的 SQL 被解析为内部的 <code>MappedStatement</code> 对象，包含 SQL 语句、参数映射规则和返回结果映射规则。</li>
</ul>
<p>2）<strong>动态代理实现 DAO 接口</strong>：</p>
<ul>
<li>MyBatis 为每个 DAO 接口生成一个动态代理类（<code>MapperProxy</code>），拦截接口方法调用。</li>
<li>动态代理的核心是根据方法名和参数匹配到对应的 <code>MappedStatement</code>，然后调用 JDBC 来执行 SQL。</li>
</ul>
<p>3）<strong>通过 JDBC 执行 SQL</strong>：</p>
<ul>
<li>MyBatis 的 <code>SqlSession</code> 是对 JDBC 的封装，它的核心是使用 <code>PreparedStatement</code> 来完成 SQL 的执行。</li>
<li>根据 XML 中定义的 SQL 和 DAO 接口方法传入的参数，生成完整的 SQL 查询，并将参数通过占位符（<code>?</code>）绑定到 <code>PreparedStatement</code>。</li>
<li>最终通过 JDBC 执行 SQL，并获取 <code>ResultSet</code>。</li>
</ul>
<p>4）<strong>结果映射</strong>：</p>
<ul>
<li>JDBC 的查询结果（<code>ResultSet</code>）会被 MyBatis 的 <code>ResultMap</code> 或 <code>resultType</code> 映射为 DAO 接口方法的返回值类型（如 POJO、Map 或 List）。</li>
</ul>
<h1 id="详细说说-mybatis-的执行流程">详细说说 MyBatis 的执行流程<a hidden class="anchor" aria-hidden="true" href="#详细说说-mybatis-的执行流程">#</a></h1>
<p><strong>MyBatis 的执行原理可以概括为以下几个关键步骤：</strong></p>
<ol>
<li>‌初始化‌：加载配置文件和xxxMapper.xml文件。创建全局配置对象Configuration，在其中保存配置信息、注册Mapper接口和创建sql语句对象MappedStatement。另创建 SqlSessionFactory。</li>
<li>‌获取 SqlSession‌：通过 SqlSessionFactory 获取 SqlSession 实例。</li>
<li>‌获取 Mapper 代理对象‌：通过 SqlSession 获取 Mapper 接口的代理对象。</li>
<li>‌执行代理对象中的方法‌：调用 Mapper 方法时， MapperProxy 代理对象的invoke方法根据传来的方法名和参数类型，找到对应的sql语句对象 MappedStatement，并创建 Executor 执行器执行 SQL 语句。</li>
<li>‌返回结果‌：将执行结果映射到java对象中返回给调用者。</li>
</ol>
<p>详细步骤：</p>
<p>1.初始化阶段<br>
‌加载配置文件‌：这是MyBatis初始化的第一步，涉及加载mybatis-config.xml全局配置文件和Mapper XML文件（如xxxxMapper.xml）。这些文件包含了数据库连接信息、事务管理器配置、SQL映射语句等关键信息。</p>
<p>‌创建Configuration全局配置对象‌：在加载并解析mybatis-config.xml配置文件的过程中，MyBatis会创建并初始化Configuration对象。这个对象是MyBatis的全局配置对象，它持有MyBatis运行所需的所有配置信息。</p>
<p>‌注册Mapper接口‌：在创建Configuration对象的同时或之后，MyBatis会扫描Mapper XML文件或注解，并根据其中的信息注册Mapper接口。这一步骤并不会直接创建Mapper接口的实例，而是创建了MapperProxyFactory实例，并将它们与Mapper接口一一关联起来，存储在Configuration对象的某个结构中（如MapperRegistry）。当需要执行某个Mapper接口中的方法时，MyBatis会使用对应的MapperProxyFactory实例来创建Mapper接口的代理对象MapperProxy。</p>
<p>‌创建MappedStatement对象：在扫描Mapper XML文件或注解时，对于Mapper XML文件中的每个SQL映射语句<code>（&lt;select&gt;、&lt;insert&gt;、&lt;update&gt;、&lt;delete&gt;）</code>，MyBatis会解析其内容，并创建一个MappedStatement对象。这些对象包含了执行SQL语句所需的所有信息，如SQL语句本身、参数类型、返回类型等。MappedStatement对象会被添加到Configuration对象的映射器配置中。</p>
<p>‌创建SqlSessionFactory：在完成上述步骤后，MyBatis会使用Configuration对象来创建SqlSessionFactory实例。这个工厂是MyBatis的核心，用于生成SqlSession实例，进而执行SQL语句。 Configuration对象是MyBatis的全局配置对象，它包含了MyBatis运行所需的所有配置信息、Mapper接口信息、MappedStatement对象等。</p>
<p>2.获取 SqlSession<br>
‌创建 SqlSession‌：通过调用 SqlSessionFactory 的 openSession 方法，可以获取到一个 SqlSession 实例。SqlSession 是 MyBatis 提供的操作数据库的主要接口，它包含了执行 SQL 语句、管理事务和获取 Mapper 代理对象等方法。</p>
<p>3.获取 Mapper 代理对象 MapperProxy<br>
‌Mapper 代理对象的生成‌：当调用 SqlSession 的 getMapper 方法时，MyBatis 会根据传入的 Mapper 接口类型，从 MapperRegistry 中找到对应的 MapperProxyFactory 实例。然后，通过该工厂实例创建一个 MapperProxy 对象作为 Mapper 接口的代理对象。</p>
<p>4.执行 MapperProxy 中的方法<br>
‌调用 Mapper 方法‌：当通过Mapper接口代理对象 MapperProxy 调用某个方法时，实际上是调用了 MapperProxy 的 invoke 方法。</p>
<p>‌查找 MappedStatement‌：在 invoke 方法内部，MyBatis 会根据传来的方法名和参数类型，从 Configuration 对象中查找到对应的 MappedStatement 对象。</p>
<p>‌创建 Executor‌：MyBatis 会根据当前事务的状态和配置信息，创建一个 Executor 执行器对象。Executor 是 MyBatis 执行 SQL 语句的核心组件，它负责处理 SQL 语句的编译、缓存、执行以及结果映射等工作。</p>
<p>‌执行 SQL 语句‌：Executor 获取连接池或JDBC中的数据库链接Connection，构造Statement对象，使用Statement对象的execute方法执行SQL 语句（Executor 到 MappedStatement 对象获取，获取到的信息包括SQL 语句、输入参数映射、输出结果映射等），通过resultSetHandler获取到执行结果，并将结果映射到 Java 对象中。</p>
<p>5.返回结果<br>
‌返回执行结果‌：执行完成后，Executor 将结果返回给 MapperProxy，MapperProxy 再将结果返回给调用者。</p>
<h1 id="说说-mybatis-的缓存机制">说说 MyBatis 的缓存机制<a hidden class="anchor" aria-hidden="true" href="#说说-mybatis-的缓存机制">#</a></h1>
<p>Mybatis中有一级缓存和二级缓存。一级缓存默认开启，二级缓存默认关闭。查询数据执行数据是：二级缓存-&gt;一级缓存-&gt;数据库。</p>
<p>一级缓存：分session级别和statement级别。默认是会话session级别，创建一个SqlSession就是一个会话，查询会缓存到会话中，增删改操作会清除会话即缓存。statement粒度更小，指在statement中缓存数据。</p>
<p>二级缓存：指在同一个namespace下的mapper作用域起作用。</p>
<p>生产上一般都是关闭Mybatis缓存的。因为一级缓存二级缓存都会因为分布式等问题，频繁增删改清除缓存，缓存就变得可有可无。另外，二级缓存作用域namespace，联表查询时，namespace无法感应到数据的变更，会造成脏数据的问题。</p>
<h1 id="mybatis-动态-sql-有什么用执行原理有哪些动态-sql">MyBatis 动态 sql 有什么用？执行原理？有哪些动态 sql？<a hidden class="anchor" aria-hidden="true" href="#mybatis-动态-sql-有什么用执行原理有哪些动态-sql">#</a></h1>
<p>动态 <code>SQL</code> 是在 <code>MyBatis</code> 中根据不同的条件、需求动态生成 <code>SQL</code> 语句的一种机制。</p>
<p>动态sql标签：<br>
<code>&lt;if&gt;、&lt;where&gt;、&lt;foreach&gt;、&lt;include&gt;、&lt;set&gt;</code></p>
<p>原理：</p>
<ul>
<li>解析动态 SQL：MyBatis 会解析 XML 文件中的动态 SQL 标签（if、where、foreach等）。</li>
<li>参数绑定：当执行 SQL 语句时，MyBatis 会根据传入的参数绑定具体的值。</li>
<li>生成最终 SQL：根据参数值和动态 SQL 标签生成最终的 SQL 语句。</li>
<li>执行 SQL：MyBatis 执行生成的 SQL 语句，并返回结果。</li>
</ul>
<h1 id="mybatis-如何实现一对一一对多的关联查询">Mybatis 如何实现一对一、一对多的关联查询<a hidden class="anchor" aria-hidden="true" href="#mybatis-如何实现一对一一对多的关联查询">#</a></h1>
<p>通过 resultMap 实现，结合标签<code>&lt;association&gt;（一对一），&lt;collection&gt;（一对多）</code>。</p>
<h1 id="mybatis-是否支持延迟加载如果支持它的实现原理是什么">MyBatis 是否支持延迟加载？如果支持，它的实现原理是什么？<a hidden class="anchor" aria-hidden="true" href="#mybatis-是否支持延迟加载如果支持它的实现原理是什么">#</a></h1>
<p><strong>延迟加载的定义</strong>：在需要用到数据时才进行加载，不需要用到数据时就不加载数据。</p>
<p><strong>MyBatis对延迟加载的支持</strong>：MyBatis支持一对一关联对象和一对多关联集合对象的延迟加载。</p>
<p><strong>配置延迟加载</strong>：在MyBatis配置文件中，可以配置是否启用延迟加载，通过设置 <code>lazyLoadingEnabled=true|false</code>。默认情况下，延迟加载是关闭的。</p>
<p><strong>延迟加载的底层原理：</strong></p>
<ol>
<li>使用CGLIB（Code Generation Library）动态生成目标对象的代理对象。</li>
<li>当调用目标方法时，进入拦截器的 <code>invoke</code> 方法，- 如果发现目标方法的值为 <code>null</code>，则执行 SQL 查询以获取数据。</li>
<li>获取数据后，调用 <code>set</code> 方法设置属性值，- 再次调用目标方法时，属性值已经存在，不再为空。</li>
</ol>
<h1 id="使用-mybatis-的-mapper-接口调用时有哪些要求">使用 MyBatis 的 mapper 接口调用时有哪些要求？<a hidden class="anchor" aria-hidden="true" href="#使用-mybatis-的-mapper-接口调用时有哪些要求">#</a></h1>
<table>
<thead>
<tr>
<th><strong>要求</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>方法名与 <code>id</code> 一致</td>
<td>接口方法名必须与 XML 中 SQL 的 <code>id</code> 完全匹配。</td>
</tr>
<tr>
<td><code>namespace</code> 正确</td>
<td>XML 的 <code>namespace</code> 必须是接口的全限定类名（含包名）。</td>
</tr>
<tr>
<td>参数类型匹配</td>
<td>方法输入参数类型需与 <code>parameterType</code> 一致。</td>
</tr>
<tr>
<td>返回值类型匹配</td>
<td>方法返回类型需与 <code>resultType</code> 或 <code>resultMap</code> 对应的类型一致。</td>
</tr>
</tbody>
</table>
<h1 id="简述mybatis-的插件运行原理以及如何编写一个插件">简述MyBatis 的插件运行原理，以及如何编写一个插件？<a hidden class="anchor" aria-hidden="true" href="#简述mybatis-的插件运行原理以及如何编写一个插件">#</a></h1>
<p><em>主要是通过动态代理实现，主要是在SQL执行的关键点上进行拦截做增强操作</em> <strong>关键点(只能拦截以下4种)</strong></p>
<ul>
<li>Executor:负责执行增删改查操作</li>
<li>ParameterHandler:负责处理 SQL 语句中的参数</li>
<li>ResultSetHandler：负责处理结果集</li>
<li>StatementHandler：负责处理 SQL 语句</li>
</ul>
<p><strong>如何编写MyBatis插件</strong></p>
<ol>
<li>实现 Interceptor接口:编写一个类，实现MyBatis的Interceptor接口，并定义拦截逻辑。</li>
<li>定义拦截逻辑:在 intercept 方法中实现增强逻辑。使用Invocation 对象调用目标方法。</li>
<li>配置插件:在mybatis-config.xml 文件中配置插件类和参数。</li>
</ol>
<p><strong>插件常见用途</strong></p>
<ol>
<li><strong>性能分析</strong>：统计 SQL 的执行时间，输出到日志中。</li>
<li><strong>动态参数注入</strong>：在 <code>ParameterHandler</code> 中修改或添加 SQL 参数。</li>
<li><strong>数据脱敏</strong>：在 <code>ResultSetHandler</code> 中对查询结果进行脱敏处理。</li>
<li><strong>自动分页</strong>：在 <code>StatementHandler</code> 中拦截 SQL，自动添加分页逻辑。</li>
</ol>
<h1 id="jdbc-编程有哪些不足之处mybatis-是如何解决的">JDBC 编程有哪些不足之处，MyBatis 是如何解决的？<a hidden class="anchor" aria-hidden="true" href="#jdbc-编程有哪些不足之处mybatis-是如何解决的">#</a></h1>
<p><strong>JDBC 不足之处如下</strong>：</p>
<ol>
<li>JDBC 代码冗余度高，需要手动管理连接（<code>Connection</code>）、预处理语句（<code>PreparedStatement</code>）、结果集（<code>ResultSet</code>），以及关闭这些资源。这样的样板代码非常多，容易出错。</li>
<li>JDBC SQL 语句通常直接硬编码在 Java 代码中，维护性和可读性较差。</li>
<li>JDBC 需要手动处理结果集，特别是在需要处理多表关联查询的情况下，映射逻辑会非常复杂。</li>
<li>JDBC 参数处理复杂，参数的设置和结果集的处理都需要手动完成，且需要明确知道字段和类型，容易出错。</li>
<li>JDBC 事务处理麻烦，事务的开启、提交和回滚需要手动处理。对于复杂的事务逻辑，容易导致资源泄漏或不一致。</li>
</ol>
<p><strong>Mybatis 刚刚好解决了这些问题</strong>：</p>
<ol>
<li>MyBatis 提供了一种机制来封装 JDBC 的所有重复代码，减少了代码冗余以及异常处理，让开发人员只需关注 SQL 和业务逻辑。</li>
<li>MyBatis 允许将 SQL 语句配置在 XML 文件或通过注解配置，解决了代码耦合问题，使得代码更加清晰、易维护。</li>
<li>MyBatis 自动将 SQL 查询结果映射到 Java 对象或集合，解决了手动处理结果集问题。</li>
<li>MyBatis 自动处理参数绑定和类型转换，通过 <code>#{}</code> 占位符将参数绑定到 SQL 中，同时自动识别参数类型，减少手动错误</li>
<li>MyBatis 与 Spring 集成后，可以利用 Spring 的声明式事务管理，简化事务的配置和使用，减少代码复杂性。</li>
<li>MyBatis 还内置了缓存机制，提升性能。</li>
</ol>
<p><strong>JDBC</strong> 与 MyBatis 的对比</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>JDBC</th>
<th>MyBatis</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>资源管理</strong></td>
<td>手动管理连接和关闭，代码复杂</td>
<td>自动管理资源，通过 <code>SqlSession</code> 简化</td>
</tr>
<tr>
<td><strong>SQL 与代码分离</strong></td>
<td>SQL 嵌套在代码中，难以维护</td>
<td>支持 XML 和注解分离 SQL，提高可维护性</td>
</tr>
<tr>
<td><strong>参数绑定</strong></td>
<td>手动拼接参数，容易出错</td>
<td>自动绑定参数，支持动态 SQL</td>
</tr>
<tr>
<td><strong>结果映射</strong></td>
<td>手动从 <code>ResultSet</code> 提取并映射到对象</td>
<td>自动映射，支持复杂嵌套</td>
</tr>
<tr>
<td><strong>事务管理</strong></td>
<td>手动管理事务，易出错</td>
<td>集成 Spring，支持声明式事务</td>
</tr>
</tbody>
</table>
<h1 id="mybatis-都有哪些-executor-执行器它们之间的区别是什么">Mybatis 都有哪些 Executor 执行器？它们之间的区别是什么？<a hidden class="anchor" aria-hidden="true" href="#mybatis-都有哪些-executor-执行器它们之间的区别是什么">#</a></h1>
<ul>
<li><strong><code>SimpleExecutor</code>：</strong> 每执行一次 update 或 select，就开启一个 Statement 对象，用完立刻关闭 Statement 对象。</li>
<li><strong><code>ReuseExecutor</code>：</strong> 执行 update 或 select，以 sql 作为 key 查找 Statement 对象，存在就使用，不存在就创建，用完后，不关闭 Statement 对象，而是放置于 Map&lt;String, Statement&gt;内，供下一次使用。简言之，就是重复使用 Statement 对象。</li>
<li><strong><code>BatchExecutor</code></strong>：执行 update（没有 select，JDBC 批处理不支持 select），将所有 sql 都添加到批处理中（addBatch()），等待统一执行（executeBatch()），它缓存了多个 Statement 对象，每个 Statement 对象都是 addBatch()完毕后，等待逐一执行 executeBatch()批处理。与 JDBC 批处理相同。</li>
</ul>
<p>作用范围：<code>Executor</code> 的这些特点，都严格限制在 SqlSession 生命周期范围内。</p>
<p>mybatis默认的执行器是SimpleExecutor。</p>
<h1 id="mybatis-如何实现数据库类型和-java-类型的转换的">MyBatis 如何实现数据库类型和 Java 类型的转换的？<a hidden class="anchor" aria-hidden="true" href="#mybatis-如何实现数据库类型和-java-类型的转换的">#</a></h1>
<p>MyBatis 类型转换主要依赖于 MyBatis 的 <strong>类型处理器（TypeHandler）</strong> 机制。</p>
<p><strong><code>TypeHandler</code> 的核心作用</strong>：</p>
<ul>
<li>将 Java 类型转换为 JDBC 类型，用于 SQL 参数设置。</li>
<li>将 JDBC 类型转换为 Java 类型，用于查询结果的映射。</li>
</ul>
<h1 id="dao-接口的工作原理是什么dao-接口里的方法参数不同时方法能重载吗">Dao 接口的工作原理是什么？Dao 接口里的方法，参数不同时，方法能重载吗？<a hidden class="anchor" aria-hidden="true" href="#dao-接口的工作原理是什么dao-接口里的方法参数不同时方法能重载吗">#</a></h1>
<p>最佳实践中，通常一个 xml 映射文件，都会写一个 Dao 接口与之对应。Dao 接口就是人们常说的 <code>Mapper</code> 接口，接口的全限名，就是映射文件中的 namespace 的值，接口的方法名，就是映射文件中 <code>MappedStatement</code> 的 id 值，接口方法内的参数，就是传递给 sql 的参数。 <code>Mapper</code> 接口是没有实现类的，当调用接口方法时，接口全限名+方法名拼接字符串作为 key 值，可唯一定位一个 <code>MappedStatement</code> ，举例：<code>com.mybatis3.mappers. StudentDao.findStudentById</code> ，可以唯一找到 namespace 为 <code>com.mybatis3.mappers. StudentDao</code> 下面 <code>id = findStudentById</code> 的 <code>MappedStatement</code> 。在 MyBatis 中，每一个 <code>&lt;select&gt;</code>、 <code>&lt;insert&gt;</code>、 <code>&lt;update&gt;</code>、 <code>&lt;delete&gt;</code> 标签，都会被解析为一个 <code>MappedStatement</code> 对象。</p>
<p>Dao 接口里的方法，是不能重载的，因为是全限名+方法名的保存和寻找策略。</p>
<p>Dao 接口里的方法可以重载，但是 Mybatis 的 xml 里面的 ID 不允许重复。</p>
<p>Mybatis 版本 3.3.0，亲测如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * Mapper接口里面方法重载
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> StuMapper {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> List&lt;Student&gt; getAllStu();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> List&lt;Student&gt; getAllStu(@Param(<span style="color:#0ff;font-weight:bold">&#34;id&#34;</span>) Integer id);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后在 <code>StuMapper.xml</code> 中利用 Mybatis 的动态 sql 就可以实现。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;select</span> <span style="color:#007f7f">id=</span><span style="color:#0ff;font-weight:bold">&#34;getAllStu&#34;</span> <span style="color:#007f7f">resultType=</span><span style="color:#0ff;font-weight:bold">&#34;com.pojo.Student&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  select * from student
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&lt;where&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;if</span> <span style="color:#007f7f">test=</span><span style="color:#0ff;font-weight:bold">&#34;id != null&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>      id = #{id}
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/if&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&lt;/where&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/select&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>能正常运行，并能得到相应的结果，这样就实现了在 Dao 接口中写重载方法。</p>
<p><strong>Mybatis 的 Dao 接口可以有多个重载方法，但是多个接口对应的映射必须只有一个，否则启动会报错。</strong></p>
<p>相关 issue：<a href="https://github.com/Snailclimb/JavaGuide/issues/1122">更正：Dao 接口里的方法可以重载，但是 Mybatis 的 xml 里面的 ID 不允许重复！</a>。</p>
<p>Dao 接口的工作原理是 JDK 动态代理，MyBatis 运行时会使用 JDK 动态代理为 Dao 接口生成代理 proxy 对象，代理对象 proxy 会拦截接口方法，转而执行 <code>MappedStatement</code> 所代表的 sql，然后将 sql 执行结果返回。</p>
<p><strong>补充</strong>：</p>
<p>Dao 接口方法可以重载，但是需要满足以下条件：</p>
<ol>
<li>仅有一个无参方法和一个有参方法</li>
<li>多个有参方法时，参数数量必须一致。且使用相同的 <code>@Param</code> ，或者使用 <code>param1</code> 这种</li>
</ol>
<p><strong>测试如下</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>PersonDao.java
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Person queryById();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Person queryById(@Param(<span style="color:#0ff;font-weight:bold">&#34;id&#34;</span>) Long id);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Person queryById(@Param(<span style="color:#0ff;font-weight:bold">&#34;id&#34;</span>) Long id, @Param(<span style="color:#0ff;font-weight:bold">&#34;name&#34;</span>) String name);
</span></span><span style="display:flex;"><span>PersonMapper.<span style="color:#007f7f">xml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;select</span> <span style="color:#007f7f">id=</span><span style="color:#0ff;font-weight:bold">&#34;queryById&#34;</span> <span style="color:#007f7f">resultMap=</span><span style="color:#0ff;font-weight:bold">&#34;PersonMap&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    select
</span></span><span style="display:flex;"><span>      id, name, age, address
</span></span><span style="display:flex;"><span>    from person
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;where&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;if</span> <span style="color:#007f7f">test=</span><span style="color:#0ff;font-weight:bold">&#34;id != null&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>            id = #{id}
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/if&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;if</span> <span style="color:#007f7f">test=</span><span style="color:#0ff;font-weight:bold">&#34;name != null and name != &#39;&#39;&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>            name = #{name}
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/if&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/where&gt;</span>
</span></span><span style="display:flex;"><span>    limit 1
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/select&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>org.apache.ibatis.scripting.xmltags. DynamicContext. ContextAccessor#getProperty</code> 方法用于获取 <code>&lt;if&gt;</code> 标签中的条件值</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object getProperty(Map context, Object target, Object name) {
</span></span><span style="display:flex;"><span>  Map map = (Map) target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Object result = map.<span style="color:#007f7f">get</span>(name);
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">if</span> (map.<span style="color:#007f7f">containsKey</span>(name) || result != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Object parameterObject = map.<span style="color:#007f7f">get</span>(PARAMETER_OBJECT_KEY);
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">if</span> (parameterObject <span style="color:#fff;font-weight:bold">instanceof</span> Map) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> ((Map)parameterObject).<span style="color:#007f7f">get</span>(name);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>parameterObject</code> 为 map，存放的是 Dao 接口中参数相关信息。</p>
<p><code>((Map)parameterObject).get(name)</code> 方法如下</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> V get(Object key) {
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">if</span> (!<span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">containsKey</span>(key)) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BindingException(<span style="color:#0ff;font-weight:bold">&#34;Parameter &#39;&#34;</span> + key + <span style="color:#0ff;font-weight:bold">&#34;&#39; not found. Available parameters are &#34;</span> + keySet());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">get</span>(key);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>queryById()</code>方法执行时，<code>parameterObject</code>为 null，<code>getProperty</code>方法返回 null 值，<code>&lt;if&gt;</code>标签获取的所有条件值都为 null，所有条件不成立，动态 sql 可以正常执行。</li>
<li><code>queryById(1L)</code>方法执行时，<code>parameterObject</code>为 map，包含了<code>id</code>和<code>param1</code>两个 key 值。当获取<code>&lt;if&gt;</code>标签中<code>name</code>的属性值时，进入<code>((Map)parameterObject).get(name)</code>方法中，map 中 key 不包含<code>name</code>，所以抛出异常。</li>
<li><code>queryById(1L,&quot;1&quot;)</code>方法执行时，<code>parameterObject</code>中包含<code>id</code>,<code>param1</code>,<code>name</code>,<code>param2</code>四个 key 值，<code>id</code>和<code>name</code>属性都可以获取到，动态 sql 正常执行。</li>
</ol>
<h1 id="mybatis-是如何进行分页的分页插件的原理是什么">MyBatis 是如何进行分页的？分页插件的原理是什么？<a hidden class="anchor" aria-hidden="true" href="#mybatis-是如何进行分页的分页插件的原理是什么">#</a></h1>
<p><strong>(1)</strong> MyBatis 使用 RowBounds 对象进行分页，它是针对 ResultSet 结果集执行的内存分页，而非物理分页；</p>
<p><strong>(2)</strong> 可以在 sql 内直接书写带有物理分页的参数来完成物理分页功能，<strong>(3)</strong> 也可以使用分页插件来完成物理分页。</p>
<p>分页插件的基本原理是使用 MyBatis 提供的插件接口，实现自定义插件，在插件的拦截方法内拦截待执行的 sql，然后重写 sql，根据 dialect 方言，添加对应的物理分页语句和物理分页参数。</p>
<p>举例：<code>select _ from student</code> ，拦截 sql 后重写为：<code>select t._ from （select \* from student）t limit 0，10</code></p>
<h1 id="mybatis-执行批量插入能返回数据库主键列表吗">MyBatis 执行批量插入，能返回数据库主键列表吗？<a hidden class="anchor" aria-hidden="true" href="#mybatis-执行批量插入能返回数据库主键列表吗">#</a></h1>
<p>能，JDBC 都能，MyBatis 当然也能。</p>
<h1 id="mybatis-是如何将-sql-执行结果封装为目标对象并返回的都有哪些映射形式">MyBatis 是如何将 sql 执行结果封装为目标对象并返回的？都有哪些映射形式？<a hidden class="anchor" aria-hidden="true" href="#mybatis-是如何将-sql-执行结果封装为目标对象并返回的都有哪些映射形式">#</a></h1>
<p>第一种是使用 <code>&lt;resultMap&gt;</code> 标签，逐一定义列名和对象属性名之间的映射关系。</p>
<p>第二种是使用 sql 列的别名功能，将列别名书写为对象属性名，比如 T_NAME AS NAME，对象属性名一般是 name，小写，但是列名不区分大小写，MyBatis 会忽略列名大小写，智能找到与之对应对象属性名，你甚至可以写成 T_NAME AS NaMe，MyBatis 一样可以正常工作。</p>
<p>有了列名与属性名的映射关系后，MyBatis 通过反射创建对象，同时使用反射给对象的属性逐一赋值并返回，那些找不到映射关系的属性，是无法完成赋值的。</p>
<h1 id="mybatis-的-xml-映射文件中不同的-xml-映射文件id-是否可以重复">MyBatis 的 xml 映射文件中，不同的 xml 映射文件，id 是否可以重复？<a hidden class="anchor" aria-hidden="true" href="#mybatis-的-xml-映射文件中不同的-xml-映射文件id-是否可以重复">#</a></h1>
<p>不同的 xml 映射文件，如果配置了 namespace，那么 id 可以重复；如果没有配置 namespace，那么 id 不能重复；毕竟 namespace 不是必须的，只是最佳实践而已。</p>
<p>原因就是 namespace+id 是作为 <code>Map&lt;String, MappedStatement&gt;</code> 的 key 使用的，如果没有 namespace，就剩下 id，那么，id 重复会导致数据互相覆盖。有了 namespace，自然 id 就可以重复，namespace 不同，namespace+id 自然也就不同。</p>
<h1 id="mybatis-中如何执行批处理">MyBatis 中如何执行批处理？<a hidden class="anchor" aria-hidden="true" href="#mybatis-中如何执行批处理">#</a></h1>
<p>使用 <code>BatchExecutor</code> 完成批处理。</p>
<h1 id="mybatis-是否可以映射-enum-枚举类">MyBatis 是否可以映射 Enum 枚举类？<a hidden class="anchor" aria-hidden="true" href="#mybatis-是否可以映射-enum-枚举类">#</a></h1>
<p>MyBatis 可以映射枚举类，不单可以映射枚举类，MyBatis 可以映射任何对象到表的一列上。映射方式为自定义一个 <code>TypeHandler</code> ，实现 <code>TypeHandler</code> 的 <code>setParameter()</code> 和 <code>getResult()</code> 接口方法。 <code>TypeHandler</code> 有两个作用：</p>
<ul>
<li>一是完成从 javaType 至 jdbcType 的转换；</li>
<li>二是完成 jdbcType 至 javaType 的转换，体现为 <code>setParameter()</code> 和 <code>getResult()</code> 两个方法，分别代表设置 sql 问号占位符参数和获取列查询结果。</li>
</ul>
<h1 id="mybatis-映射文件中如果-a-标签通过-include-引用了-b-标签的内容请问b-标签能否定义在-a-标签的后面还是说必须定义在-a-标签的前面">MyBatis 映射文件中，如果 A 标签通过 include 引用了 B 标签的内容，请问，B 标签能否定义在 A 标签的后面，还是说必须定义在 A 标签的前面？<a hidden class="anchor" aria-hidden="true" href="#mybatis-映射文件中如果-a-标签通过-include-引用了-b-标签的内容请问b-标签能否定义在-a-标签的后面还是说必须定义在-a-标签的前面">#</a></h1>
<p>虽然 MyBatis 解析 xml 映射文件是按照顺序解析的，但是，被引用的 B 标签依然可以定义在任何地方，MyBatis 都可以正确识别。</p>
<p>原理是，MyBatis 解析 A 标签，发现 A 标签引用了 B 标签，但是 B 标签尚未解析到，尚不存在，此时，MyBatis 会将 A 标签标记为未解析状态，然后继续解析余下的标签，包含 B 标签，待所有标签解析完毕，MyBatis 会重新解析那些被标记为未解析的标签，此时再解析 A 标签时，B 标签已经存在，A 标签也就可以正常解析完成了。</p>
<h1 id="简述-mybatis-的-xml-映射文件和-mybatis-内部数据结构之间的映射关系">简述 MyBatis 的 xml 映射文件和 MyBatis 内部数据结构之间的映射关系？<a hidden class="anchor" aria-hidden="true" href="#简述-mybatis-的-xml-映射文件和-mybatis-内部数据结构之间的映射关系">#</a></h1>
<p>MyBatis 将所有 xml 配置信息都封装到 All-In-One 重量级对象 Configuration 内部。在 xml 映射文件中， <code>&lt;parameterMap&gt;</code> 标签会被解析为 <code>ParameterMap</code> 对象，其每个子元素会被解析为 ParameterMapping 对象。 <code>&lt;resultMap&gt;</code> 标签会被解析为 <code>ResultMap</code> 对象，其每个子元素会被解析为 <code>ResultMapping</code> 对象。每一个 <code>&lt;select&gt;、&lt;insert&gt;、&lt;update&gt;、&lt;delete&gt;</code> 标签均会被解析为 <code>MappedStatement</code> 对象，标签内的 sql 会被解析为 BoundSql 对象。</p>
<h1 id="为什么说-mybatis-是半自动-orm-映射工具它与全自动的区别在哪里">为什么说 MyBatis 是半自动 ORM 映射工具？它与全自动的区别在哪里？<a hidden class="anchor" aria-hidden="true" href="#为什么说-mybatis-是半自动-orm-映射工具它与全自动的区别在哪里">#</a></h1>
<p><strong>Mybaits</strong></p>
<p>Mybatis 相对于 Hibernate 称为半 ORM 框架，因为 Hibernate 不需要写 SQL，而 Mybatis 需要写 SQL。</p>
<p>也因为这点 Mybatis 更加的灵活且轻量。</p>
<p>能针对 SQL 进行优化，非常灵活地根据条件动态拼接 SQL 等，极端情况下性能占优。</p>
<p>不过也因为这点 Mybatis 和底层的数据库是强绑定的，如果更换底层数据库， 所有 SQL 需要重新过一遍（有些写法还是不一样的）。</p>
<p>比如我之前本地开发是 MySQL，后来客户特殊情况不用 saas，需要在他们那边部署一套，他们用的是 oracle，所以以前写的 SQL 都需要改一遍。</p>
<p>具体选择 Hibernate 还是 Mybatis，是看情况的。</p>
<p>比方一些项目很简单，QPS 又不高，快速解决战斗就选 Hibernate，无脑上就完了。</p>
<p>而一些核心服务，QPS很高，需要对 SQL 进行精细化定制，那就 Mybatis，就是追求极致用 Mybatis。</p>
<p><strong>Hibernate</strong></p>
<p>是一款完整形态的 ORM 框架，可以从纯面向对象的角度来操作数据库。</p>
<p>它不仅能帮助我们完成对象模型和数据库关系模型的映射，还能帮助我们屏蔽不同数据库不同 SQL 的差异，简单来说我们用 Hibernate 提供的 API 就能完成大部分 SQL 操作，不需要我们编写 SQL，Hibernate 会帮助我们生成 SQL。</p>
<p>且也提供了 HQL（Hibernate Query Language），面向对象的查询语句，和 SQL 类似但是不太相同，最终 HQL 会被转化成 SQL 执行</p>
<p>还提供了 Criteria 接口，也是一样，是一套面向对象的 API，一些复杂的 SQL 可以利用 Criteria 来实现，非常灵活。</p>
<p>总而言之，<strong>Hibernate 通过面向对象的思维让你操作数据库，屏蔽不同数据库的差异，它会根据底层不同数据库转化成对应的 SQL</strong>。</p>
<p>缺点就是屏蔽的太多了，例如因为自动生成 SQL，所以我们无法控制具体生成的语句，你无法直接决定它走哪个的索引，且又经过了一层转化 SQL 的操作，所以性能也会有所影响。</p>
<p><strong>总结</strong>：Hibernate 很好，基本上 ORM 要的它都有，包括一级、二级缓存等，且屏蔽底层数据库，提高了程序的可移植行。但由于它封装的太好了，使得我们无法精细化的控制执行的 SQL。</p>
<p>在国外几乎都用 Hibernate，在国内大家都用 Mybaits。</p>
<p>没有绝对的好坏，只有合适与不合适。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://009965.xyz/tags/interview/">Interview</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://009965.xyz/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
