<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>13_SQL面试题 | Wjy&#39;s Blog</title>
<meta name="keywords" content="interview">
<meta name="description" content="SQL面试题1 检索数据 SELECT 用于从数据库中查询数据。 从 Customers 表中检索所有的 ID 现有表 Customers 如下： cust_id A B C 编写 SQL 语句，从 Customers 表中检索所有的 cust_id。 答案">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/interview/13_sql%E9%9D%A2%E8%AF%95%E9%A2%98/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="13_SQL面试题" />
<meta property="og:description" content="SQL面试题1 检索数据 SELECT 用于从数据库中查询数据。 从 Customers 表中检索所有的 ID 现有表 Customers 如下： cust_id A B C 编写 SQL 语句，从 Customers 表中检索所有的 cust_id。 答案" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/interview/13_sql%E9%9D%A2%E8%AF%95%E9%A2%98/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-22T05:00:00+00:00" />
<meta property="article:modified_time" content="2023-07-22T05:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="13_SQL面试题"/>
<meta name="twitter:description" content="SQL面试题1 检索数据 SELECT 用于从数据库中查询数据。 从 Customers 表中检索所有的 ID 现有表 Customers 如下： cust_id A B C 编写 SQL 语句，从 Customers 表中检索所有的 cust_id。 答案"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "13_SQL面试题",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/interview/13_sql%E9%9D%A2%E8%AF%95%E9%A2%98/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "13_SQL面试题",
  "name": "13_SQL面试题",
  "description": "SQL面试题1 检索数据 SELECT 用于从数据库中查询数据。 从 Customers 表中检索所有的 ID 现有表 Customers 如下： cust_id A B C 编写 SQL 语句，从 Customers 表中检索所有的 cust_id。 答案",
  "keywords": [
    "interview"
  ],
  "articleBody": "SQL面试题1 检索数据 SELECT 用于从数据库中查询数据。\n从 Customers 表中检索所有的 ID 现有表 Customers 如下：\ncust_id A B C 编写 SQL 语句，从 Customers 表中检索所有的 cust_id。\n答案：\n1 2 SELECT cust_id FROM Customers 检索并列出已订购产品的清单 表 OrderItems 含有非空的列 prod_id 代表商品 id，包含了所有已订购的商品（有些已被订购多次）。\nprod_id a1 a2 a3 a4 a5 a6 a7 编写 SQL 语句，检索并列出所有已订购商品（prod_id）的去重后的清单。\n答案：\n1 2 SELECT DISTINCT prod_id FROM OrderItems 知识点：DISTINCT 用于返回列中的唯一不同值。\n检索所有列 现在有 Customers 表（表中含有列 cust_id 代表客户 id，cust_name 代表客户姓名）\ncust_id cust_name a1 andy a2 ben a3 tony a4 tom a5 an a6 lee a7 hex 需要编写 SQL 语句，检索所有列。\n答案：\n1 2 SELECT cust_id, cust_name FROM Customers 排序检索数据 ORDER BY 用于对结果集按照一个列或者多个列进行排序。默认按照升序对记录进行排序，如果需要按照降序对记录进行排序，可以使用 DESC 关键字。\n检索顾客名称并且排序 有表 Customers，cust_id 代表客户 id，cust_name 代表客户姓名。\ncust_id cust_name a1 andy a2 ben a3 tony a4 tom a5 an a6 lee a7 hex 从 Customers 中检索所有的顾客名称（cust_name），并按从 Z 到 A 的顺序显示结果。\n答案：\n1 2 3 SELECT cust_name FROM Customers ORDER BY cust_name DESC 对顾客 ID 和日期排序 有 Orders 表：\ncust_id order_num order_date andy aaaa 2021-01-01 00:00:00 andy bbbb 2021-01-01 12:00:00 bob cccc 2021-01-10 12:00:00 dick dddd 2021-01-11 00:00:00 编写 SQL 语句，从 Orders 表中检索顾客 ID（cust_id）和订单号（order_num），并先按顾客 ID 对结果进行排序，再按订单日期倒序排列。\n答案：\n1 2 3 4 5 # 根据列名排序 # 注意：是 order_date 降序，而不是 order_num SELECT cust_id, order_num FROM Orders ORDER BY cust_id,order_date DESC 知识点：order by 对多列排序的时候，先排序的列放前面，后排序的列放后面。并且，不同的列可以有不同的排序规则。\n按照数量和价格排序 假设有一个 OrderItems 表：\nquantity item_price 1 100 10 1003 2 500 编写 SQL 语句，显示 OrderItems 表中的数量（quantity）和价格（item_price），并按数量由多到少、价格由高到低排序。\n答案：\n1 2 3 SELECT quantity, item_price FROM OrderItems ORDER BY quantity DESC,item_price DESC 检查 SQL 语句 有 Vendors 表：\nvend_name 海底捞 小龙坎 大龙燚 下面的 SQL 语句有问题吗？尝试将它改正确，使之能够正确运行，并且返回结果根据vend_name 逆序排列。\n1 2 3 SELECT vend_name, FROM Vendors ORDER vend_name DESC 改正后：\n1 2 3 SELECT vend_name FROM Vendors ORDER BY vend_name DESC 知识点：\n逗号作用是用来隔开列与列之间的。 ORDER BY 是有 BY 的，需要撰写完整，且位置正确。 过滤数据 WHERE 可以过滤返回的数据。\n下面的运算符可以在 WHERE 子句中使用：\n运算符 描述 = 等于 \u003c\u003e 不等于。 注释： 在 SQL 的一些版本中，该操作符可被写成 != \u003e 大于 \u003c 小于 \u003e= 大于等于 \u003c= 小于等于 BETWEEN 在某个范围内 LIKE 搜索某种模式 IN 指定针对某个列的多个可能值 返回固定价格的产品 有表 Products：\nprod_id prod_name prod_price a0018 sockets 9.49 a0019 iphone13 600 b0018 gucci t-shirts 1000 【问题】从 Products 表中检索产品 ID（prod_id）和产品名称（prod_name），只返回价格为 9.49 美元的产品。\n答案：\n1 2 3 SELECT prod_id, prod_name FROM Products WHERE prod_price = 9.49 返回更高价格的产品 有表 Products：\nprod_id prod_name prod_price a0018 sockets 9.49 a0019 iphone13 600 b0019 gucci t-shirts 1000 【问题】编写 SQL 语句，从 Products 表中检索产品 ID（prod_id）和产品名称（prod_name），只返回价格为 9 美元或更高的产品。\n答案：\n1 2 3 SELECT prod_id, prod_name FROM Products WHERE prod_price \u003e= 9 返回产品并且按照价格排序 有表 Products：\nprod_id prod_name prod_price a0011 egg 3 a0019 sockets 4 b0019 coffee 15 【问题】编写 SQL 语句，返回 Products 表中所有价格在 3 美元到 6 美元之间的产品的名称（prod_name）和价格（prod_price），然后按价格对结果进行排序。\n答案：\n1 2 3 4 5 6 7 8 9 10 SELECT prod_name, prod_price FROM Products WHERE prod_price BETWEEN 3 AND 6 ORDER BY prod_price # 或者 SELECT prod_name, prod_price FROM Products WHERE prod_price \u003e= 3 AND prod_price \u003c= 6 ORDER BY prod_price 返回更多的产品 OrderItems 表含有：订单号 order_num，quantity产品数量\norder_num quantity a1 105 a2 1100 a2 200 a4 1121 a5 10 a2 19 a7 5 【问题】从 OrderItems 表中检索出所有不同且不重复的订单号（order_num），其中每个订单都要包含 100 个或更多的产品。\n答案：\n1 2 3 4 SELECT order_num FROM OrderItems GROUP BY order_num HAVING SUM(quantity) \u003e= 100 高级数据过滤 AND 和 OR 运算符用于基于一个以上的条件对记录进行过滤，两者可以结合使用。AND 必须 2 个条件都成立，OR只要 2 个条件中的一个成立即可。\n检索供应商名称 Vendors 表有字段供应商名称（vend_name）、供应商国家（vend_country）、供应商州（vend_state）\nvend_name vend_country vend_state apple USA CA vivo CNA shenzhen huawei CNA xian 【问题】编写 SQL 语句，从 Vendors 表中检索供应商名称（vend_name），仅返回加利福尼亚州的供应商（这需要按国家[USA]和州[CA]进行过滤，没准其他国家也存在一个 CA）\n答案：\n1 2 3 SELECT vend_name FROM Vendors WHERE vend_country = 'USA' AND vend_state = 'CA' 检索并列出已订购产品的清单 OrderItems 表包含了所有已订购的产品（有些已被订购多次）。\nprod_id order_num quantity BR01 a1 105 BR02 a2 1100 BR02 a2 200 BR03 a4 1121 BR017 a5 10 BR02 a2 19 BR017 a7 5 【问题】编写 SQL 语句，查找所有订购了数量至少 100 个的 BR01、BR02 或 BR03 的订单。你需要返回 OrderItems 表的订单号（order_num）、产品 ID（prod_id）和数量（quantity），并按产品 ID 和数量进行过滤。\n答案：\n1 2 3 SELECT order_num, prod_id, quantity FROM OrderItems WHERE prod_id IN ('BR01', 'BR02', 'BR03') AND quantity \u003e= 100 返回所有价格在 3 美元到 6 美元之间的产品的名称和价格 有表 Products：\nprod_id prod_name prod_price a0011 egg 3 a0019 sockets 4 b0019 coffee 15 【问题】编写 SQL 语句，返回所有价格在 3 美元到 6 美元之间的产品的名称（prod_name）和价格（prod_price），使用 AND 操作符，然后按价格对结果进行升序排序。\n答案：\n1 2 3 4 SELECT prod_name, prod_price FROM Products WHERE prod_price \u003e= 3 and prod_price \u003c= 6 ORDER BY prod_price 检查 SQL 语句 供应商表 Vendors 有字段供应商名称 vend_name、供应商国家 vend_country、供应商省份 vend_state\nvend_name vend_country vend_state apple USA CA vivo CNA shenzhen huawei CNA xian 【问题】修改正确下面 sql，使之正确返回。\n1 2 3 4 SELECT vend_name FROM Vendors ORDER BY vend_name WHERE vend_country = 'USA' AND vend_state = 'CA'; 修改后：\n1 2 3 4 SELECT vend_name FROM Vendors WHERE vend_country = 'USA' AND vend_state = 'CA' ORDER BY vend_name ORDER BY 语句必须放在 WHERE 之后。\n用通配符进行过滤 SQL 通配符必须与 LIKE 运算符一起使用\n在 SQL 中，可使用以下通配符：\n通配符 描述 % 代表零个或多个字符 _ 仅替代一个字符 [charlist] 字符列中的任何单一字符 [^charlist] 或者 [!charlist] 不在字符列中的任何单一字符 检索产品名称和描述（一） Products 表如下：\nprod_name prod_desc a0011 usb a0019 iphone13 b0019 gucci t-shirts c0019 gucci toy d0019 lego toy 【问题】编写 SQL 语句，从 Products 表中检索产品名称（prod_name）和描述（prod_desc），仅返回描述中包含 toy 一词的产品名称。\n答案：\n1 2 3 SELECT prod_name, prod_desc FROM Products WHERE prod_desc LIKE '%toy%' 检索产品名称和描述（二） Products 表如下：\nprod_name prod_desc a0011 usb a0019 iphone13 b0019 gucci t-shirts c0019 gucci toy d0019 lego toy 【问题】编写 SQL 语句，从 Products 表中检索产品名称（prod_name）和描述（prod_desc），仅返回描述中未出现 toy 一词的产品，最后按”产品名称“对结果进行排序。\n答案：\n1 2 3 4 SELECT prod_name, prod_desc FROM Products WHERE prod_desc NOT LIKE '%toy%' ORDER BY prod_name 检索产品名称和描述（三） Products 表如下：\nprod_name prod_desc a0011 usb a0019 iphone13 b0019 gucci t-shirts c0019 gucci toy d0019 lego carrots toy 【问题】编写 SQL 语句，从 Products 表中检索产品名称（prod_name）和描述（prod_desc），仅返回描述中同时出现 toy 和 carrots 的产品。有好几种方法可以执行此操作，但对于这个挑战题，请使用 AND 和两个 LIKE 比较。\n答案：\n1 2 3 SELECT prod_name, prod_desc FROM Products WHERE prod_desc LIKE '%toy%' AND prod_desc LIKE \"%carrots%\" 检索产品名称和描述（四） Products 表如下：\nprod_name prod_desc a0011 usb a0019 iphone13 b0019 gucci t-shirts c0019 gucci toy d0019 lego toy carrots 【问题】编写 SQL 语句，从 Products 表中检索产品名称（prod_name）和描述（prod_desc），仅返回在描述中以先后顺序同时出现 toy 和 carrots 的产品。提示：只需要用带有三个 % 符号的 LIKE 即可。\n答案：\n1 2 3 SELECT prod_name, prod_desc FROM Products WHERE prod_desc LIKE '%toy%carrots%' 创建计算字段 别名 别名的常见用法是在检索出的结果中重命名表的列字段（为了符合特定的报表要求或客户需求）。有表 Vendors 代表供应商信息，vend_id 供应商 id、vend_name 供应商名称、vend_address 供应商地址、vend_city 供应商城市。\nvend_id vend_name vend_address vend_city a001 tencent cloud address1 shenzhen a002 huawei cloud address2 dongguan a003 aliyun cloud address3 hangzhou a003 netease cloud address4 guangzhou 【问题】编写 SQL 语句，从 Vendors 表中检索 vend_id、vend_name、vend_address 和 vend_city，将 vend_name 重命名为 vname，将 vend_city 重命名为 vcity，将 vend_address 重命名为 vaddress，按供应商名称对结果进行升序排序。\n答案：\n1 2 3 4 5 6 7 SELECT vend_id, vend_name AS vname, vend_address AS vaddress, vend_city AS vcity FROM Vendors ORDER BY vname # as 可以省略 SELECT vend_id, vend_name vname, vend_address vaddress, vend_city vcity FROM Vendors ORDER BY vname 打折 我们的示例商店正在进行打折促销，所有产品均降价 10%。Products 表包含 prod_id 产品 id、prod_price 产品价格。\n【问题】编写 SQL 语句，从 Products 表中返回 prod_id、prod_price 和 sale_price。sale_price 是一个包含促销价格的计算字段。提示：可以乘以 0.9，得到原价的 90%（即 10%的折扣）。\n答案：\n1 2 SELECT prod_id, prod_price, prod_price * 0.9 AS sale_price FROM Products 注意：sale_price 是对计算结果的命名，而不是原有的列名。\n使用函数处理数据 顾客登录名 我们的商店已经上线了，正在创建顾客账户。所有用户都需要登录名，默认登录名是其名称和所在城市的组合。\n给出 Customers 表 如下：\ncust_id cust_name cust_contact cust_city a1 Andy Li Andy Li Oak Park a2 Ben Liu Ben Liu Oak Park a3 Tony Dai Tony Dai Oak Park a4 Tom Chen Tom Chen Oak Park a5 An Li An Li Oak Park a6 Lee Chen Lee Chen Oak Park a7 Hex Liu Hex Liu Oak Park 【问题】编写 SQL 语句，返回顾客 ID（cust_id）、顾客名称（cust_name）和登录名（user_login），其中登录名全部为大写字母，并由顾客联系人的前两个字符（cust_contact）和其所在城市的前三个字符（cust_city）组成。提示：需要使用函数、拼接和别名。\n答案：\n1 2 SELECT cust_id, cust_name, UPPER(CONCAT(SUBSTRING(cust_contact, 1, 2), SUBSTRING(cust_city, 1, 3))) AS user_login FROM Customers 知识点：\n截取函数SUBSTRING()：截取字符串，substring(str ,n ,m)（n 表示起始截取位置，m 表示要截取的字符个数）表示返回字符串 str 从第 n 个字符开始截取 m 个字符； 拼接函数CONCAT()：将两个或多个字符串连接成一个字符串，select concat(A,B)：连接字符串 A 和 B。 大写函数 UPPER()：将指定字符串转换为大写。 返回 2020 年 1 月的所有订单的订单号和订单日期 Orders 订单表如下：\norder_num order_date a0001 2020-01-01 00:00:00 a0002 2020-01-02 00:00:00 a0003 2020-01-01 12:00:00 a0004 2020-02-01 00:00:00 a0005 2020-03-01 00:00:00 【问题】编写 SQL 语句，返回 2020 年 1 月的所有订单的订单号（order_num）和订单日期（order_date），并按订单日期升序排序\n答案：\n1 2 3 4 SELECT order_num, order_date FROM Orders WHERE month(order_date) = '01' AND YEAR(order_date) = '2020' ORDER BY order_date 也可以用通配符来做：\n1 2 3 4 SELECT order_num, order_date FROM Orders WHERE order_date LIKE '2020-01%' ORDER BY order_date 知识点：\n日期格式：YYYY-MM-DD 时间格式：HH:MM:SS 日期和时间处理相关的常用函数：\n函 数 说 明 ADDDATE() 增加一个日期（天、周等） ADDTIME() 增加一个时间（时、分等） CURDATE() 返回当前日期 CURTIME() 返回当前时间 DATE() 返回日期时间的日期部分 DATEDIFF 计算两个日期之差 DATE_FORMAT() 返回一个格式化的日期或时间串 DAY() 返回一个日期的天数部分 DAYOFWEEK() 对于一个日期，返回对应的星期几 HOUR() 返回一个时间的小时部分 MINUTE() 返回一个时间的分钟部分 MONTH() 返回一个日期的月份部分 NOW() 返回当前日期和时间 SECOND() 返回一个时间的秒部分 TIME() 返回一个日期时间的时间部分 YEAR() 返回一个日期的年份部分 汇总数据 汇总数据相关的函数：\n函 数 说 明 AVG() 返回某列的平均值 COUNT() 返回某列的行数 MAX() 返回某列的最大值 MIN() 返回某列的最小值 SUM() 返回某列值之和 确定已售出产品的总数 OrderItems 表代表售出的产品，quantity 代表售出商品数量。\nquantity 10 100 1000 10001 2 15 【问题】编写 SQL 语句，确定已售出产品的总数。\n答案：\n1 2 SELECT Sum(quantity) AS items_ordered FROM OrderItems 确定已售出产品项 BR01 的总数 OrderItems 表代表售出的产品，quantity 代表售出商品数量，产品项为 prod_id。\nquantity prod_id 10 AR01 100 AR10 1000 BR01 10001 BR010 【问题】修改创建的语句，确定已售出产品项（prod_id）为\"BR01\"的总数。\n答案：\n1 2 3 SELECT Sum(quantity) AS items_ordered FROM OrderItems WHERE prod_id = 'BR01' 确定 Products 表中价格不超过 10 美元的最贵产品的价格 Products 表如下，prod_price 代表商品的价格。\nprod_price 9.49 600 1000 【问题】编写 SQL 语句，确定 Products 表中价格不超过 10 美元的最贵产品的价格（prod_price）。将计算所得的字段命名为 max_price。\n答案：\n1 2 3 SELECT Max(prod_price) AS max_price FROM Products WHERE prod_price \u003c= 10 分组数据 GROUP BY：\nGROUP BY 子句将记录分组到汇总行中。 GROUP BY 为每个组返回一个记录。 GROUP BY 通常还涉及聚合COUNT，MAX，SUM，AVG 等。 GROUP BY 可以按一列或多列进行分组。 GROUP BY 按分组字段进行排序后，ORDER BY 可以以汇总字段来进行排序。 HAVING：\nHAVING 用于对汇总的 GROUP BY 结果进行过滤。 HAVING 必须要与 GROUP BY 连用。 WHERE 和 HAVING 可以在相同的查询中。 HAVING vs WHERE：\nWHERE：过滤指定的行，后面不能加聚合函数（分组函数）。 HAVING：过滤分组，必须要与 GROUP BY 连用，不能单独使用。 返回每个订单号各有多少行数 OrderItems 表包含每个订单的每个产品\norder_num a002 a002 a002 a004 a007 【问题】编写 SQL 语句，返回每个订单号（order_num）各有多少行数（order_lines），并按 order_lines 对结果进行升序排序。\n答案：\n1 2 3 4 SELECT order_num, Count(order_num) AS order_lines FROM OrderItems GROUP BY order_num ORDER BY order_lines 知识点：\ncount(*),count(列名)都可以，区别在于，count(列名)是统计非 NULL 的行数； order by 最后执行，所以可以使用列别名； 分组聚合一定不要忘记加上 group by ,不然只会有一行结果。 每个供应商成本最低的产品 有 Products 表，含有字段 prod_price 代表产品价格，vend_id 代表供应商 id\nvend_id prod_price a0011 100 a0019 0.1 b0019 1000 b0019 6980 b0019 20 【问题】编写 SQL 语句，返回名为 cheapest_item 的字段，该字段包含每个供应商成本最低的产品（使用 Products 表中的 prod_price），然后从最低成本到最高成本对结果进行升序排序。\n答案：\n1 2 3 4 SELECT vend_id, Min(prod_price) AS cheapest_item FROM Products GROUP BY vend_id ORDER BY cheapest_item 返回订单数量总和不小于 100 的所有订单的订单号 OrderItems 代表订单商品表，包括：订单号 order_num 和订单数量 quantity。\norder_num quantity a1 105 a2 1100 a2 200 a4 1121 a5 10 a2 19 a7 5 【问题】请编写 SQL 语句，返回订单数量总和不小于 100 的所有订单号，最后结果按照订单号升序排序。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # 直接聚合 SELECT order_num FROM OrderItems GROUP BY order_num HAVING Sum(quantity) \u003e= 100 ORDER BY order_num # 子查询 SELECT a.order_num FROM (SELECT order_num, Sum(quantity) AS sum_num FROM OrderItems GROUP BY order_num HAVING sum_num \u003e= 100) a ORDER BY a.order_num 知识点：\nwhere：过滤过滤指定的行，后面不能加聚合函数（分组函数）。 having：过滤分组，与 group by 连用，不能单独使用。 计算总和 OrderItems 表代表订单信息，包括字段：订单号 order_num 和 item_price 商品售出价格、quantity 商品数量。\norder_num item_price quantity a1 10 105 a2 1 1100 a2 1 200 a4 2 1121 a5 5 10 a2 1 19 a7 7 5 【问题】编写 SQL 语句，根据订单号聚合，返回订单总价不小于 1000 的所有订单号，最后的结果按订单号进行升序排序。\n提示：总价 = item_price 乘以 quantity\n答案：\n1 2 3 4 5 SELECT order_num, Sum(item_price * quantity) AS total_price FROM OrderItems GROUP BY order_num HAVING total_price \u003e= 1000 ORDER BY order_num 检查 SQL 语句 OrderItems 表含有 order_num 订单号\norder_num a002 a002 a002 a004 a007 【问题】将下面代码修改正确后执行\n1 2 3 4 5 SELECT order_num, COUNT(*) AS items FROM OrderItems GROUP BY items HAVING COUNT(*) \u003e= 3 ORDER BY items, order_num; 修改后：\n1 2 3 4 5 SELECT order_num, COUNT(*) AS items FROM OrderItems GROUP BY order_num HAVING items \u003e= 3 ORDER BY items, order_num; 使用子查询 子查询是嵌套在较大查询中的 SQL 查询，也称内部查询或内部选择，包含子查询的语句也称为外部查询或外部选择。简单来说，子查询就是指将一个 SELECT 查询（子查询）的结果作为另一个 SQL 语句（主查询）的数据来源或者判断条件。\n子查询可以嵌入 SELECT、INSERT、UPDATE 和 DELETE 语句中，也可以和 =、\u003c、\u003e、IN、BETWEEN、EXISTS 等运算符一起使用。\n子查询常用在 WHERE 子句和 FROM 子句后边：\n当用于 WHERE 子句时，根据不同的运算符，子查询可以返回单行单列、多行单列、单行多列数据。子查询就是要返回能够作为 WHERE 子句查询条件的值。 当用于 FROM 子句时，一般返回多行多列数据，相当于返回一张临时表，这样才符合 FROM 后面是表的规则。这种做法能够实现多表联合查询。 注意：MySQL 数据库从 4.1 版本才开始支持子查询，早期版本是不支持的。\n用于 WHERE 子句的子查询的基本语法如下：\n1 2 3 4 5 6 SELECT column_name [, column_name ] FROM table1 [, table2 ] WHERE column_name operator (SELECT column_name [, column_name ] FROM table1 [, table2 ] [WHERE]) 子查询需要放在括号( )内。 operator 表示用于 WHERE 子句的运算符，可以是比较运算符（如 =, \u003c, \u003e, \u003c\u003e 等）或逻辑运算符（如 IN, NOT IN, EXISTS, NOT EXISTS 等），具体根据需求来确定。 用于 FROM 子句的子查询的基本语法如下：\n1 2 3 4 5 6 SELECT column_name [, column_name ] FROM (SELECT column_name [, column_name ] FROM table1 [, table2 ] [WHERE]) AS temp_table_name [, ...] [JOIN type JOIN table_name ON condition] WHERE condition; 用于 FROM 的子查询返回的结果相当于一张临时表，所以需要使用 AS 关键字为该临时表起一个名字。 子查询需要放在括号 ( ) 内。 可以指定多个临时表名，并使用 JOIN 语句连接这些表。 返回购买价格为 10 美元或以上产品的顾客列表 1 OrderItems` 表示订单商品表，含有字段订单号：`order_num`、订单价格：`item_price`；`Orders` 表代表订单信息表，含有顾客 `id：cust_id` 和订单号：`order_num OrderItems 表:\norder_num item_price a1 10 a2 1 a2 1 a4 2 a5 5 a2 1 a7 7 Orders 表：\norder_num cust_id a1 cust10 a2 cust1 a2 cust1 a4 cust2 a5 cust5 a2 cust1 a7 cust7 【问题】使用子查询，返回购买价格为 10 美元或以上产品的顾客列表，结果无需排序。\n答案：\n1 2 3 4 5 6 SELECT cust_id FROM Orders WHERE order_num IN (SELECT order_num FROM OrderItems GROUP BY order_num HAVING Sum(item_price) \u003e= 10) 确定哪些订单购买了 prod_id 为 BR01 的产品（一） 表 OrderItems 代表订单商品信息表，prod_id 为产品 id；Orders 表代表订单表有 cust_id 代表顾客 id 和订单日期 order_date\nOrderItems 表：\nprod_id order_num BR01 a0001 BR01 a0002 BR02 a0003 BR02 a0013 Orders 表：\norder_num cust_id order_date a0001 cust10 2022-01-01 00:00:00 a0002 cust1 2022-01-01 00:01:00 a0003 cust1 2022-01-02 00:00:00 a0013 cust2 2022-01-01 00:20:00 【问题】\n编写 SQL 语句，使用子查询来确定哪些订单（在 OrderItems 中）购买了 prod_id 为 “BR01” 的产品，然后从 Orders 表中返回每个产品对应的顾客 ID（cust_id）和订单日期（order_date），按订购日期对结果进行升序排序。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # 写法 1：子查询 SELECT cust_id,order_date FROM Orders WHERE order_num IN (SELECT order_num FROM OrderItems WHERE prod_id = 'BR01' ) ORDER BY order_date; # 写法 2: 连接表 SELECT b.cust_id, b.order_date FROM OrderItems a,Orders b WHERE a.order_num = b.order_num AND a.prod_id = 'BR01' ORDER BY order_date 返回购买 prod_id 为 BR01 的产品的所有顾客的电子邮件（一） 你想知道订购 BR01 产品的日期，有表 OrderItems 代表订单商品信息表，prod_id 为产品 id；Orders 表代表订单表有 cust_id 代表顾客 id 和订单日期 order_date；Customers 表含有 cust_email 顾客邮件和 cust_id 顾客 id\nOrderItems 表：\nprod_id order_num BR01 a0001 BR01 a0002 BR02 a0003 BR02 a0013 Orders 表：\norder_num cust_id order_date a0001 cust10 2022-01-01 00:00:00 a0002 cust1 2022-01-01 00:01:00 a0003 cust1 2022-01-02 00:00:00 a0013 cust2 2022-01-01 00:20:00 Customers 表代表顾客信息，cust_id 为顾客 id，cust_email 为顾客 email\ncust_id cust_email cust10 cust10@cust.com cust1 cust1@cust.com cust2 cust2@cust.com 【问题】返回购买 prod_id 为 BR01 的产品的所有顾客的电子邮件（Customers 表中的 cust_email），结果无需排序。\n提示：这涉及 SELECT 语句，最内层的从 OrderItems 表返回 order_num，中间的从 Customers 表返回 cust_id。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # 写法 1：子查询 SELECT cust_email FROM Customers WHERE cust_id IN (SELECT cust_id FROM Orders WHERE order_num IN (SELECT order_num FROM OrderItems WHERE prod_id = 'BR01')) # 写法 2: 连接表（inner join） SELECT c.cust_email FROM OrderItems a,Orders b,Customers c WHERE a.order_num = b.order_num AND b.cust_id = c.cust_id AND a.prod_id = 'BR01' # 写法 3：连接表（left join） SELECT c.cust_email FROM Orders a LEFT JOIN OrderItems b ON a.order_num = b.order_num LEFT JOIN Customers c ON a.cust_id = c.cust_id WHERE b.prod_id = 'BR01' 返回每个顾客不同订单的总金额 我们需要一个顾客 ID 列表，其中包含他们已订购的总金额。\nOrderItems 表代表订单信息，OrderItems 表有订单号：order_num 和商品售出价格：item_price、商品数量：quantity。\norder_num item_price quantity a0001 10 105 a0002 1 1100 a0002 1 200 a0013 2 1121 a0003 5 10 a0003 1 19 a0003 7 5 1 Orders` 表订单号：`order_num`、顾客 id：`cust_id order_num cust_id a0001 cust10 a0002 cust1 a0003 cust1 a0013 cust2 【问题】\n编写 SQL 语句，返回顾客 ID（Orders 表中的 cust_id），并使用子查询返回 total_ordered 以便返回每个顾客的订单总数，将结果按金额从大到小排序。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # 写法 1：子查询 SELECT o.cust_id AS cust_id, tb.total_ordered AS total_ordered FROM (SELECT order_num, Sum(item_price * quantity) AS total_ordered FROM OrderItems GROUP BY order_num) AS tb, Orders o WHERE tb.order_num = o.order_num ORDER BY total_ordered DESC # 写法 2：连接表 SELECT b.cust_id, Sum(a.quantity * a.item_price) AS total_ordered FROM OrderItems a,Orders b WHERE a.order_num = b.order_num GROUP BY cust_id ORDER BY total_ordered DESC 从 Products 表中检索所有的产品名称以及对应的销售总数 1 Products` 表中检索所有的产品名称：`prod_name`、产品 id：`prod_id prod_id prod_name a0001 egg a0002 sockets a0013 coffee a0003 cola 1 OrderItems` 代表订单商品表，订单产品：`prod_id`、售出数量：`quantity prod_id quantity a0001 105 a0002 1100 a0002 200 a0013 1121 a0003 10 a0003 19 a0003 5 【问题】\n编写 SQL 语句，从 Products 表中检索所有的产品名称（prod_name），以及名为 quant_sold 的计算列，其中包含所售产品的总数（在 OrderItems 表上使用子查询和 SUM(quantity) 检索）。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # 写法 1：子查询 SELECT p.prod_name, tb.quant_sold FROM (SELECT prod_id, Sum(quantity) AS quant_sold FROM OrderItems GROUP BY prod_id) AS tb, Products p WHERE tb.prod_id = p.prod_id # 写法 2：连接表 SELECT p.prod_name, Sum(o.quantity) AS quant_sold FROM Products p, OrderItems o WHERE p.prod_id = o.prod_id GROUP BY p.prod_name（这里不能用 p.prod_id，会报错） 连接表 JOIN 是“连接”的意思，顾名思义，SQL JOIN 子句用于将两个或者多个表联合起来进行查询。\n连接表时需要在每个表中选择一个字段，并对这些字段的值进行比较，值相同的两条记录将合并为一条。连接表的本质就是将不同表的记录合并起来，形成一张新表。当然，这张新表只是临时的，它仅存在于本次查询期间。\n使用 JOIN 连接两个表的基本语法如下：\n1 2 3 4 SELECT table1.column1, table2.column2... FROM table1 JOIN table2 ON table1.common_column1 = table2.common_column2; table1.common_column1 = table2.common_column2 是连接条件，只有满足此条件的记录才会合并为一行。您可以使用多个运算符来连接表，例如 =、\u003e、\u003c、\u003c\u003e、\u003c=、\u003e=、!=、between、like 或者 not，但是最常见的是使用 =。\n当两个表中有同名的字段时，为了帮助数据库引擎区分是哪个表的字段，在书写同名字段名时需要加上表名。当然，如果书写的字段名在两个表中是唯一的，也可以不使用以上格式，只写字段名即可。\n另外，如果两张表的关联字段名相同，也可以使用 USING子句来代替 ON，举个例子：\n1 2 3 4 5 6 7 8 9 10 11 12 13 # join....on SELECT c.cust_name, o.order_num FROM Customers c INNER JOIN Orders o ON c.cust_id = o.cust_id ORDER BY c.cust_name # 如果两张表的关联字段名相同，也可以使用USING子句：JOIN....USING() SELECT c.cust_name, o.order_num FROM Customers c INNER JOIN Orders o USING(cust_id) ORDER BY c.cust_name ON 和 WHERE 的区别：\n连接表时，SQL 会根据连接条件生成一张新的临时表。ON 就是连接条件，它决定临时表的生成。 WHERE 是在临时表生成以后，再对临时表中的数据进行过滤，生成最终的结果集，这个时候已经没有 JOIN-ON 了。 所以总结来说就是：SQL 先根据 ON 生成一张临时表，然后再根据 WHERE 对临时表进行筛选。\nSQL 允许在 JOIN 左边加上一些修饰性的关键词，从而形成不同类型的连接，如下表所示：\n连接类型 说明 INNER JOIN 内连接 （默认连接方式）只有当两个表都存在满足条件的记录时才会返回行。 LEFT JOIN / LEFT OUTER JOIN 左(外)连接 返回左表中的所有行，即使右表中没有满足条件的行也是如此。 RIGHT JOIN / RIGHT OUTER JOIN 右(外)连接 返回右表中的所有行，即使左表中没有满足条件的行也是如此。 FULL JOIN / FULL OUTER JOIN 全(外)连接 只要其中有一个表存在满足条件的记录，就返回行。 SELF JOIN 将一个表连接到自身，就像该表是两个表一样。为了区分两个表，在 SQL 语句中需要至少重命名一个表。 CROSS JOIN 交叉连接，从两个或者多个连接表中返回记录集的笛卡尔积。 如果不加任何修饰词，只写 JOIN，那么默认为 INNER JOIN\n对于 INNER JOIN 来说，还有一种隐式的写法，称为 “隐式内连接”，也就是没有 INNER JOIN 关键字，使用 WHERE 语句实现内连接的功能\n1 2 3 4 5 6 7 8 9 10 11 12 # 隐式内连接 SELECT c.cust_name, o.order_num FROM Customers c,Orders o WHERE c.cust_id = o.cust_id ORDER BY c.cust_name # 显式内连接 SELECT c.cust_name, o.order_num FROM Customers c INNER JOIN Orders o USING(cust_id) ORDER BY c.cust_name; 返回顾客名称和相关订单号 1 Customers` 表有字段顾客名称 `cust_name`、顾客 id `cust_id cust_id cust_name cust10 andy cust1 ben cust2 tony cust22 tom cust221 an cust2217 hex Orders 订单信息表，含有字段 order_num 订单号、cust_id 顾客 id\norder_num cust_id a1 cust10 a2 cust1 a3 cust2 a4 cust22 a5 cust221 a7 cust2217 【问题】编写 SQL 语句，返回 Customers 表中的顾客名称（cust_name）和 Orders 表中的相关订单号（order_num），并按顾客名称再按订单号对结果进行升序排序。你可以尝试用两个不同的写法，一个使用简单的等连接语法，另外一个使用 INNER JOIN。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 # 隐式内连接 SELECT c.cust_name, o.order_num FROM Customers c,Orders o WHERE c.cust_id = o.cust_id ORDER BY c.cust_name,o.order_num # 显式内连接 SELECT c.cust_name, o.order_num FROM Customers c INNER JOIN Orders o USING(cust_id) ORDER BY c.cust_name,o.order_num; 返回顾客名称和相关订单号以及每个订单的总价 1 Customers` 表有字段，顾客名称：`cust_name`、顾客 id：`cust_id cust_id cust_name cust10 andy cust1 ben cust2 tony cust22 tom cust221 an cust2217 hex 1 Orders` 订单信息表，含有字段，订单号：`order_num`、顾客 id：`cust_id order_num cust_id a1 cust10 a2 cust1 a3 cust2 a4 cust22 a5 cust221 a7 cust2217 1 OrderItems` 表有字段，商品订单号：`order_num`、商品数量：`quantity`、商品价格：`item_price order_num quantity item_price a1 1000 10 a2 200 10 a3 10 15 a4 25 50 a5 15 25 a7 7 7 【问题】除了返回顾客名称和订单号，返回 Customers 表中的顾客名称（cust_name）和 Orders 表中的相关订单号（order_num），添加第三列 OrderTotal，其中包含每个订单的总价，并按顾客名称再按订单号对结果进行升序排序。\n1 2 3 4 5 6 # 简单的等连接语法 SELECT c.cust_name, o.order_num, SUM(quantity * item_price) AS OrderTotal FROM Customers c,Orders o,OrderItems oi WHERE c.cust_id = o.cust_id AND o.order_num = oi.order_num GROUP BY c.cust_name, o.order_num ORDER BY c.cust_name, o.order_num 注意，可能有小伙伴会这样写：\n1 2 3 4 5 SELECT c.cust_name, o.order_num, SUM(quantity * item_price) AS OrderTotal FROM Customers c,Orders o,OrderItems oi WHERE c.cust_id = o.cust_id AND o.order_num = oi.order_num GROUP BY c.cust_name ORDER BY c.cust_name,o.order_num 这是错误的！只对 cust_name 进行聚类确实符合题意，但是不符合 GROUP BY 的语法。\nselect 语句中，如果没有 GROUP BY 语句，那么 cust_name、order_num 会返回若干个值，而 sum(quantity * item_price) 只返回一个值，通过 group by cust_name 可以让 cust_name 和 sum(quantity * item_price) 一一对应起来，或者说聚类，所以同样的，也要对 order_num 进行聚类。\n一句话，select 中的字段要么都聚类，要么都不聚类\n确定哪些订单购买了 prod_id 为 BR01 的产品（二） 表 OrderItems 代表订单商品信息表，prod_id 为产品 id；Orders 表代表订单表有 cust_id 代表顾客 id 和订单日期 order_date\nOrderItems 表：\nprod_id order_num BR01 a0001 BR01 a0002 BR02 a0003 BR02 a0013 Orders 表：\norder_num cust_id order_date a0001 cust10 2022-01-01 00:00:00 a0002 cust1 2022-01-01 00:01:00 a0003 cust1 2022-01-02 00:00:00 a0013 cust2 2022-01-01 00:20:00 【问题】\n编写 SQL 语句，使用子查询来确定哪些订单（在 OrderItems 中）购买了 prod_id 为 “BR01” 的产品，然后从 Orders 表中返回每个产品对应的顾客 ID（cust_id）和订单日期（order_date），按订购日期对结果进行升序排序。\n提示：这一次使用连接和简单的等连接语法。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # 写法 1：子查询 SELECT cust_id, order_date FROM Orders WHERE order_num IN (SELECT order_num FROM OrderItems WHERE prod_id = 'BR01') ORDER BY order_date # 写法 2：连接表 inner join SELECT cust_id, order_date FROM Orders o INNER JOIN (SELECT order_num FROM OrderItems WHERE prod_id = 'BR01') tb ON o.order_num = tb.order_num ORDER BY order_date # 写法 3：写法 2 的简化版 SELECT cust_id, order_date FROM Orders INNER JOIN OrderItems USING(order_num) WHERE OrderItems.prod_id = 'BR01' ORDER BY order_date 返回购买 prod_id 为 BR01 的产品的所有顾客的电子邮件（二） 有表 OrderItems 代表订单商品信息表，prod_id 为产品 id；Orders 表代表订单表有 cust_id 代表顾客 id 和订单日期 order_date；Customers 表含有 cust_email 顾客邮件和 cust_id 顾客 id\nOrderItems 表：\nprod_id order_num BR01 a0001 BR01 a0002 BR02 a0003 BR02 a0013 Orders 表：\norder_num cust_id order_date a0001 cust10 2022-01-01 00:00:00 a0002 cust1 2022-01-01 00:01:00 a0003 cust1 2022-01-02 00:00:00 a0013 cust2 2022-01-01 00:20:00 Customers 表代表顾客信息，cust_id 为顾客 id，cust_email 为顾客 email\ncust_id cust_email cust10 cust10@cust.com cust1 cust1@cust.com cust2 cust2@cust.com 【问题】返回购买 prod_id 为 BR01 的产品的所有顾客的电子邮件（Customers 表中的 cust_email），结果无需排序。\n提示：涉及到 SELECT 语句，最内层的从 OrderItems 表返回 order_num，中间的从 Customers 表返回 cust_id，但是必须使用 INNER JOIN 语法。\n1 2 3 4 5 SELECT cust_email FROM Customers INNER JOIN Orders using(cust_id) INNER JOIN OrderItems using(order_num) WHERE OrderItems.prod_id = 'BR01' 确定最佳顾客的另一种方式（二） OrderItems 表代表订单信息，确定最佳顾客的另一种方式是看他们花了多少钱，OrderItems 表有订单号 order_num 和 item_price 商品售出价格、quantity 商品数量\norder_num item_price quantity a1 10 105 a2 1 1100 a2 1 200 a4 2 1121 a5 5 10 a2 1 19 a7 7 5 Orders 表含有字段 order_num 订单号、cust_id 顾客 id\norder_num cust_id a1 cust10 a2 cust1 a3 cust2 a4 cust22 a5 cust221 a7 cust2217 顾客表 Customers 有字段 cust_id 客户 id、cust_name 客户姓名\ncust_id cust_name cust10 andy cust1 ben cust2 tony cust22 tom cust221 an cust2217 hex 【问题】编写 SQL 语句，返回订单总价不小于 1000 的客户名称和总额（OrderItems 表中的 order_num）。\n提示：需要计算总和（item_price 乘以 quantity）。按总额对结果进行排序，请使用 INNER JOIN语法。\n1 2 3 4 5 6 7 SELECT cust_name, SUM(item_price * quantity) AS total_price FROM Customers INNER JOIN Orders USING(cust_id) INNER JOIN OrderItems USING(order_num) GROUP BY cust_name HAVING total_price \u003e= 1000 ORDER BY total_price 创建高级连接 检索每个顾客的名称和所有的订单号（一） 1 Customers` 表代表顾客信息含有顾客 id `cust_id` 和 顾客名称 `cust_name cust_id cust_name cust10 andy cust1 ben cust2 tony cust22 tom cust221 an cust2217 hex 1 Orders` 表代表订单信息含有订单号 `order_num` 和顾客 id `cust_id order_num cust_id a1 cust10 a2 cust1 a3 cust2 a4 cust22 a5 cust221 a7 cust2217 【问题】使用 INNER JOIN 编写 SQL 语句，检索每个顾客的名称（Customers 表中的 cust_name）和所有的订单号（Orders 表中的 order_num），最后根据顾客姓名 cust_name 升序返回。\n1 2 3 4 5 SELECT cust_name, order_num FROM Customers INNER JOIN Orders USING(cust_id) ORDER BY cust_name 检索每个顾客的名称和所有的订单号（二） 1 Orders` 表代表订单信息含有订单号 `order_num` 和顾客 id `cust_id order_num cust_id a1 cust10 a2 cust1 a3 cust2 a4 cust22 a5 cust221 a7 cust2217 1 Customers` 表代表顾客信息含有顾客 id `cust_id` 和 顾客名称 `cust_name cust_id cust_name cust10 andy cust1 ben cust2 tony cust22 tom cust221 an cust2217 hex cust40 ace 【问题】检索每个顾客的名称（Customers 表中的 cust_name）和所有的订单号（Orders 表中的 order_num），列出所有的顾客，即使他们没有下过订单。最后根据顾客姓名 cust_name 升序返回。\n1 2 3 4 5 SELECT cust_name, order_num FROM Customers LEFT JOIN Orders USING(cust_id) ORDER BY cust_name 返回产品名称和与之相关的订单号 Products 表为产品信息表含有字段 prod_id 产品 id、prod_name 产品名称\nprod_id prod_name a0001 egg a0002 sockets a0013 coffee a0003 cola a0023 soda 1 OrderItems` 表为订单信息表含有字段 `order_num` 订单号和产品 id `prod_id prod_id order_num a0001 a105 a0002 a1100 a0002 a200 a0013 a1121 a0003 a10 a0003 a19 a0003 a5 【问题】使用外连接（left join、 right join、full join）联结 Products 表和 OrderItems 表，返回产品名称（prod_name）和与之相关的订单号（order_num）的列表，并按照产品名称升序排序。\n1 2 3 4 5 SELECT prod_name, order_num FROM Products LEFT JOIN OrderItems USING(prod_id) ORDER BY prod_name 返回产品名称和每一项产品的总订单数 Products 表为产品信息表含有字段 prod_id 产品 id、prod_name 产品名称\nprod_id prod_name a0001 egg a0002 sockets a0013 coffee a0003 cola a0023 soda 1 OrderItems` 表为订单信息表含有字段 `order_num` 订单号和产品 id `prod_id prod_id order_num a0001 a105 a0002 a1100 a0002 a200 a0013 a1121 a0003 a10 a0003 a19 a0003 a5 【问题】\n使用 OUTER JOIN 联结 Products 表和 OrderItems 表，返回产品名称（prod_name）和每一项产品的总订单数（不是订单号），并按产品名称升序排序。\n1 2 3 4 5 6 SELECT prod_name, COUNT(order_num) AS orders FROM Products LEFT JOIN OrderItems USING(prod_id) GROUP BY prod_name ORDER BY prod_name 列出供应商及其可供产品的数量 有 Vendors 表含有 vend_id （供应商 id）\nvend_id a0002 a0013 a0003 a0010 有 Products 表含有 vend_id（供应商 id）和 prod_id（供应产品 id）\nvend_id prod_id a0001 egg a0002 prod_id_iphone a00113 prod_id_tea a0003 prod_id_vivo phone a0010 prod_id_huawei phone 【问题】列出供应商（Vendors 表中的 vend_id）及其可供产品的数量，包括没有产品的供应商。你需要使用 OUTER JOIN 和 COUNT()聚合函数来计算 Products 表中每种产品的数量，最后根据 vend_id 升序排序。\n注意：vend_id 列会显示在多个表中，因此在每次引用它时都需要完全限定它。\n1 2 3 4 5 6 SELECT vend_id, COUNT(prod_id) AS prod_id FROM Vendors LEFT JOIN Products USING(vend_id) GROUP BY vend_id ORDER BY vend_id 组合查询 UNION 运算符将两个或更多查询的结果组合起来，并生成一个结果集，其中包含来自 UNION 中参与查询的提取行。\nUNION 基本规则：\n所有查询的列数和列顺序必须相同。 每个查询中涉及表的列的数据类型必须相同或兼容。 通常返回的列名取自第一个查询。 默认地，UNION 操作符选取不同的值。如果允许重复的值，请使用 UNION ALL。\n1 2 3 SELECT column_name(s) FROM table1 UNION ALL SELECT column_name(s) FROM table2; UNION 结果集中的列名总是等于 UNION 中第一个 SELECT 语句中的列名。\nJOIN vs UNION：\nJOIN 中连接表的列可能不同，但在 UNION 中，所有查询的列数和列顺序必须相同。 UNION 将查询之后的行放在一起（垂直放置），但 JOIN 将查询之后的列放在一起（水平放置），即它构成一个笛卡尔积。 将两个 SELECT 语句结合起来（一） 表 OrderItems 包含订单产品信息，字段 prod_id 代表产品 id、quantity 代表产品数量\nprod_id quantity a0001 105 a0002 100 a0002 200 a0013 1121 a0003 10 a0003 19 a0003 5 BNBG 10002 【问题】将两个 SELECT 语句结合起来，以便从 OrderItems 表中检索产品 id（prod_id）和 quantity。其中，一个 SELECT 语句过滤数量为 100 的行，另一个 SELECT 语句过滤 id 以 BNBG 开头的产品，最后按产品 id 对结果进行升序排序。\n1 2 3 4 5 6 7 SELECT prod_id, quantity FROM OrderItems WHERE quantity = 100 UNION SELECT prod_id, quantity FROM OrderItems WHERE prod_id LIKE 'BNBG%' 将两个 SELECT 语句结合起来（二） 表 OrderItems 包含订单产品信息，字段 prod_id 代表产品 id、quantity 代表产品数量。\nprod_id quantity a0001 105 a0002 100 a0002 200 a0013 1121 a0003 10 a0003 19 a0003 5 BNBG 10002 【问题】将两个 SELECT 语句结合起来，以便从 OrderItems 表中检索产品 id（prod_id）和 quantity。其中，一个 SELECT 语句过滤数量为 100 的行，另一个 SELECT 语句过滤 id 以 BNBG 开头的产品，最后按产品 id 对结果进行升序排序。 注意：这次仅使用单个 SELECT 语句。\n答案：\n要求只用一条 select 语句，那就用 or 不用 union 了。\n1 2 3 SELECT prod_id, quantity FROM OrderItems WHERE quantity = 100 OR prod_id LIKE 'BNBG%' 组合 Products 表中的产品名称和 Customers 表中的顾客名称 Products 表含有字段 prod_name 代表产品名称\nprod_name flower rice ring umbrella Customers 表代表顾客信息，cust_name 代表顾客名称\ncust_name andy ben tony tom an lee hex 【问题】编写 SQL 语句，组合 Products 表中的产品名称（prod_name）和 Customers 表中的顾客名称（cust_name）并返回，然后按产品名称对结果进行升序排序。\n1 2 3 4 5 6 7 # UNION 结果集中的列名总是等于 UNION 中第一个 SELECT 语句中的列名。 SELECT prod_name FROM Products UNION SELECT cust_name FROM Customers ORDER BY prod_name 检查 SQL 语句 表 Customers 含有字段 cust_name 顾客名、cust_contact 顾客联系方式、cust_state 顾客州、cust_email 顾客 email\ncust_name cust_contact cust_state cust_email cust10 8695192 MI cust10@cust.com cust1 8695193 MI cust1@cust.com cust2 8695194 IL cust2@cust.com 【问题】修正下面错误的 SQL\n1 2 3 4 5 6 7 8 SELECT cust_name, cust_contact, cust_email FROM Customers WHERE cust_state = 'MI' ORDER BY cust_name; UNION SELECT cust_name, cust_contact, cust_email FROM Customers WHERE cust_state = 'IL'ORDER BY cust_name; 修正后：\n1 2 3 4 5 6 7 8 SELECT cust_name, cust_contact, cust_email FROM Customers WHERE cust_state = 'MI' UNION SELECT cust_name, cust_contact, cust_email FROM Customers WHERE cust_state = 'IL' ORDER BY cust_name; 使用 union 组合查询时，只能使用一条 order by 字句，他必须位于最后一条 select 语句之后\n或者直接用 or 来做：\n1 2 3 4 SELECT cust_name, cust_contact, cust_email FROM Customers WHERE cust_state = 'MI' or cust_state = 'IL' ORDER BY cust_name; SQL面试题2 增删改操作 SQL 插入记录的方式汇总：\n普通插入（全字段） ：INSERT INTO table_name VALUES (value1, value2, ...) 普通插入（限定字段） ：INSERT INTO table_name (column1, column2, ...) VALUES (value1, value2, ...) 多条一次性插入 ：INSERT INTO table_name (column1, column2, ...) VALUES (value1_1, value1_2, ...), (value2_1, value2_2, ...), ... 从另一个表导入 ：INSERT INTO table_name SELECT * FROM table_name2 [WHERE key=value] 带更新的插入 ：REPLACE INTO table_name VALUES (value1, value2, ...)（注意这种原理是检测到主键或唯一性索引键重复就删除原记录后重新插入） 插入记录（一） 描述：牛客后台会记录每个用户的试卷作答记录到 exam_record 表，现在有两个用户的作答记录详情如下：\n用户 1001 在 2021 年 9 月 1 日晚上 10 点 11 分 12 秒开始作答试卷 9001，并在 50 分钟后提交，得了 90 分； 用户 1002 在 2021 年 9 月 4 日上午 7 点 1 分 2 秒开始作答试卷 9002，并在 10 分钟后退出了平台。 试卷作答记录表exam_record中，表已建好，其结构如下，请用一条语句将这两条记录插入表中。\nFiled Type Null Key Extra Default Comment id int(11) NO PRI auto_increment (NULL) 自增 ID uid int(11) NO (NULL) 用户 ID exam_id int(11) NO (NULL) 试卷 ID start_time datetime NO (NULL) 开始时间 submit_time datetime YES (NULL) 提交时间 score tinyint(4) YES (NULL) 得分 答案：\n1 2 3 4 // 存在自增主键，无需手动赋值 INSERT INTO exam_record (uid, exam_id, start_time, submit_time, score) VALUES (1001, 9001, '2021-09-01 22:11:12', '2021-09-01 23:01:12', 90), (1002, 9002, '2021-09-04 07:01:02', NULL, NULL); 插入记录（二） 描述：现有一张试卷作答记录表exam_record，结构如下表，其中包含多年来的用户作答试卷记录，由于数据越来越多，维护难度越来越大，需要对数据表内容做精简，历史数据做备份。\n表exam_record：\nFiled Type Null Key Extra Default Comment id int(11) NO PRI auto_increment (NULL) 自增 ID uid int(11) NO (NULL) 用户 ID exam_id int(11) NO (NULL) 试卷 ID start_time datetime NO (NULL) 开始时间 submit_time datetime YES (NULL) 提交时间 score tinyint(4) YES (NULL) 得分 我们已经创建了一张新表exam_record_before_2021用来备份 2021 年之前的试题作答记录，结构和exam_record表一致，请将 2021 年之前的已完成了的试题作答纪录导入到该表。\n答案：\n1 2 3 4 INSERT INTO exam_record_before_2021 (uid, exam_id, start_time, submit_time, score) SELECT uid,exam_id,start_time,submit_time,score FROM exam_record WHERE YEAR(submit_time) \u003c 2021; 插入记录（三） 描述：现在有一套 ID 为 9003 的高难度 SQL 试卷，时长为一个半小时，请你将 2021-01-01 00:00:00 作为发布时间插入到试题信息表examination_info，不管该 ID 试卷是否存在，都要插入成功，请尝试插入它。\n试题信息表examination_info：\nFiled Type Null Key Extra Default Comment id int(11) NO PRI auto_increment (NULL) 自增 ID exam_id int(11) NO UNI (NULL) 试卷 ID tag varchar(32) YES (NULL) 类别标签 difficulty varchar(8) YES (NULL) 难度 duration int(11) NO (NULL) 时长(分钟数) release_time datetime YES (NULL) 发布时间 答案：\n1 2 REPLACE INTO examination_info VALUES (NULL, 9003, \"SQL\", \"hard\", 90, \"2021-01-01 00:00:00\"); 更新记录（一） 描述：现在有一张试卷信息表 examination_info, 表结构如下图所示：\nFiled Type Null Key Extra Default Comment id int(11) NO PRI auto_increment (NULL) 自增 ID exam_id int(11) NO UNI (NULL) 试卷 ID tag char(32) YES (NULL) 类别标签 difficulty char(8) YES (NULL) 难度 duration int(11) NO (NULL) 时长 release_time datetime YES (NULL) 发布时间 请把examination_info表中tag为PYTHON的tag字段全部修改为Python。\n思路：这题有两种解题思路，最容易想到的是直接update + where来指定条件更新，第二种就是根据要修改的字段进行查找替换\n答案一：\n1 UPDATE examination_info SET tag = 'Python' WHERE tag='PYTHON' 答案二：\n1 2 3 4 UPDATE examination_info SET tag = REPLACE(tag,'PYTHON','Python') # REPLACE (目标字段，\"查找内容\",\"替换内容\") 更新记录（二） 描述：现有一张试卷作答记录表 exam_record，其中包含多年来的用户作答试卷记录，结构如下表：作答记录表 exam_record： submit_time 为 完成时间 （注意这句话）\nFiled Type Null Key Extra Default Comment id int(11) NO PRI auto_increment (NULL) 自增 ID uid int(11) NO (NULL) 用户 ID exam_id int(11) NO (NULL) 试卷 ID start_time datetime NO (NULL) 开始时间 submit_time datetime YES (NULL) 提交时间 score tinyint(4) YES (NULL) 得分 题目要求：请把 exam_record 表中 2021 年 9 月 1 日==之前==开始作答的==未完成==记录全部改为被动完成，即：将完成时间改为'2099-01-01 00:00:00’，分数改为 0。\n思路：注意题干中的关键字(已经高亮) \" xxx 时间 \"之前这个条件， 那么这里马上就要想到要进行时间的比较 可以直接 xxx_time \u003c \"2021-09-01 00:00:00\", 也可以采用date()函数来进行比较；第二个条件就是 \"未完成\"， 即完成时间为 NULL，也就是题目中的提交时间 —– submit_time 为 NULL。\n答案：\n1 UPDATE exam_record SET submit_time = '2099-01-01 00:00:00', score = 0 WHERE DATE(start_time) \u003c \"2021-09-01\" AND submit_time IS null 删除记录（一） 描述：现有一张试卷作答记录表 exam_record，其中包含多年来的用户作答试卷记录，结构如下表：\n作答记录表exam_record： start_time 是试卷开始时间submit_time 是交卷，即结束时间。\nFiled Type Null Key Extra Default Comment id int(11) NO PRI auto_increment (NULL) 自增 ID uid int(11) NO (NULL) 用户 ID exam_id int(11) NO (NULL) 试卷 ID start_time datetime NO (NULL) 开始时间 submit_time datetime YES (NULL) 提交时间 score tinyint(4) YES (NULL) 得分 要求：请删除exam_record表中作答时间小于 5 分钟整且分数不及格（及格线为 60 分）的记录；\n思路：这一题虽然是练习删除，仔细看确是考察对时间函数的用法，这里提及的分钟数比较，常用的函数有 TIMEDIFF*和*TIMESTAMPDIFF ，两者用法稍有区别，后者更为灵活，这都是看个人习惯。\n1.　TIMEDIFF：两个时间之间的差值\n1 TIMEDIFF(time1, time2) 两者参数都是必须的，都是一个时间或者日期时间表达式。如果指定的参数不合法或者是 NULL，那么函数将返回 NULL。\n对于这题而言，可以用在 minute 函数里面，因为 TIMEDIFF 计算出来的是时间的差值，在外面套一个 MINUTE 函数，计算出来的就是分钟数。\nTIMESTAMPDIFF：用于计算两个日期的时间差 1 2 3 4 5 6 7 8 9 10 11 12 TIMESTAMPDIFF(unit,datetime_expr1,datetime_expr2) # 参数说明 #unit: 日期比较返回的时间差单位，常用可选值如下: SECOND：秒 MINUTE：分钟 HOUR：小时 DAY：天 WEEK：星期 MONTH：月 QUARTER：季度 YEAR：年 # TIMESTAMPDIFF函数返回datetime_expr2 - datetime_expr1的结果（人话： 后面的 - 前面的 即2-1），其中datetime_expr1和datetime_expr2可以是DATE或DATETIME类型值（人话：可以是“2023-01-01”， 也可以是“2023-01-01- 00:00:00”） 这题需要进行分钟的比较，那么就是 TIMESTAMPDIFF(MINUTE, 开始时间， 结束时间) \u003c 5\n答案：\n1 DELETE FROM exam_record WHERE MINUTE (TIMEDIFF(submit_time , start_time)) \u003c 5 AND score \u003c 60 1 DELETE FROM exam_record WHERE TIMESTAMPDIFF(MINUTE, start_time, submit_time) \u003c 5 AND score \u003c 60 删除记录（二） 描述：现有一张试卷作答记录表exam_record，其中包含多年来的用户作答试卷记录，结构如下表：\n作答记录表exam_record：start_time 是试卷开始时间，submit_time 是交卷时间，即结束时间，如果未完成的话，则为空。\nFiled Type Null Key Extra Default Comment id int(11) NO PRI auto_increment (NULL) 自增 ID uid int(11) NO (NULL) 用户 ID exam_id int(11) NO (NULL) 试卷 ID start_time datetime NO (NULL) 开始时间 submit_time datetime YES (NULL) 提交时间 score tinyint(4) YES (NULL) 分数 要求：请删除exam_record表中未完成作答==或==作答时间小于 5 分钟整的记录中，开始作答时间最早的 3 条记录。\n思路：这题比较简单，但是要注意题干中给出的信息，结束时间，如果未完成的话，则为空，这个其实就是一个条件\n还有一个条件就是小于 5 分钟，跟上题类似，但是这里是或，即两个条件满足一个就行；另外就是稍微考察到了排序和 limit 的用法。\n答案：\n1 2 3 4 DELETE FROM exam_record WHERE submit_time IS null OR TIMESTAMPDIFF(MINUTE, start_time, submit_time) \u003c 5 ORDER BY start_time LIMIT 3 # 默认就是asc， desc是降序排列 删除记录（三） 描述：现有一张试卷作答记录表 exam_record，其中包含多年来的用户作答试卷记录，结构如下表：\nFiled Type Null Key Extra Default Comment id int(11) NO PRI auto_increment (NULL) 自增 ID uid int(11) NO (NULL) 用户 ID exam_id int(11) NO (NULL) 试卷 ID start_time datetime NO (NULL) 开始时间 submit_time datetime YES (NULL) 提交时间 score tinyint(4) YES (NULL) 分数 要求：请删除exam_record表中所有记录，==并重置自增主键==\n思路：这题考察对三种删除语句的区别，注意高亮部分，要求重置主键；\nDROP: 清空表，删除表结构，不可逆 TRUNCATE: 格式化表，不删除表结构，不可逆 DELETE：删除数据，可逆 这里选用TRUNCATE的原因是：TRUNCATE 只能作用于表；TRUNCATE会清空表中的所有行，但表结构及其约束、索引等保持不变；TRUNCATE会重置表的自增值；使用TRUNCATE后会使表和索引所占用的空间会恢复到初始大小。\n这题也可以采用DELETE来做，但是在删除后，还需要手动ALTER表结构来设置主键初始值；\n同理也可以采用DROP来做，直接删除整张表，包括表结构，然后再新建表即可。\n答案：\n1 TRUNCATE exam_record; 表与索引操作 创建一张新表 描述：现有一张用户信息表，其中包含多年来在平台注册过的用户信息，随着牛客平台的不断壮大，用户量飞速增长，为了高效地为高活跃用户提供服务，现需要将部分用户拆分出一张新表。\n原来的用户信息表：\nFiled Type Null Key Default Extra Comment id int(11) NO PRI (NULL) auto_increment 自增 ID uid int(11) NO UNI (NULL) 用户 ID nick_name varchar(64) YES (NULL) 昵称 achievement int(11) YES 0 成就值 level int(11) YES (NULL) 用户等级 job varchar(32) YES (NULL) 职业方向 register_time datetime YES CURRENT_TIMESTAMP 注册时间 作为数据分析师，请创建一张优质用户信息表 user_info_vip，表结构和用户信息表一致。\n你应该返回的输出如下表格所示，请写出建表语句将表格中所有限制和说明记录到表里。\nFiled Type Null Key Default Extra Comment id int(11) NO PRI (NULL) auto_increment 自增 ID uid int(11) NO UNI (NULL) 用户 ID nick_name varchar(64) YES (NULL) 昵称 achievement int(11) YES 0 成就值 level int(11) YES (NULL) 用户等级 job varchar(32) YES (NULL) 职业方向 register_time datetime YES CURRENT_TIMESTAMP 注册时间 思路：如果这题给出了旧表的名称，可直接create table 新表 as select * from 旧表; 但是这题并没有给出旧表名称，所以需要自己创建，注意默认值和键的创建即可，比较简单。（注意：如果是在牛客网上面执行，请注意 comment 中要和题目中的 comment 保持一致，包括大小写，否则不通过，还有字符也要设置）\n答案：\n1 2 3 4 5 6 7 8 9 CREATE TABLE IF NOT EXISTS user_info_vip( id INT(11) PRIMARY KEY AUTO_INCREMENT COMMENT'自增ID', uid INT(11) UNIQUE NOT NULL COMMENT '用户ID', nick_name VARCHAR(64) COMMENT'昵称', achievement INT(11) DEFAULT 0 COMMENT '成就值', level INT(11) COMMENT '用户等级', job VARCHAR(32) COMMENT '职业方向', register_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间' )CHARACTER SET UTF8 修改表 描述： 现有一张用户信息表user_info，其中包含多年来在平台注册过的用户信息。\n用户信息表 user_info：\nFiled Type Null Key Default Extra Comment id int(11) NO PRI (NULL) auto_increment 自增 ID uid int(11) NO UNI (NULL) 用户 ID nick_name varchar(64) YES (NULL) 昵称 achievement int(11) YES 0 成就值 level int(11) YES (NULL) 用户等级 job varchar(32) YES (NULL) 职业方向 register_time datetime YES CURRENT_TIMESTAMP 注册时间 **要求：**请在用户信息表，字段 level 的后面增加一列最多可保存 15 个汉字的字段 school；并将表中 job 列名改为 profession，同时 varchar 字段长度变为 10；achievement 的默认值设置为 0。\n思路：首先做这题之前，需要了解 ALTER 语句的基本用法：\n添加一列：ALTER TABLE 表名 ADD COLUMN 列名 类型 【first | after 字段名】;（first ： 在某列之前添加，after 反之） 修改列的类型或约束：ALTER TABLE 表名 MODIFY COLUMN 列名 新类型 【新约束】; 修改列名：ALTER TABLE 表名 change COLUMN 旧列名 新列名 类型; 删除列：ALTER TABLE 表名 drop COLUMN 列名; 修改表名：ALTER TABLE 表名 rename 【to】 新表名; 将某一列放到第一列：ALTER TABLE 表名 MODIFY COLUMN 列名 类型 first; COLUMN 关键字其实可以省略不写，这里基于规范还是罗列出来了。\n在修改时，如果有多个修改项，可以写到一起，但要注意格式\n答案：\n1 2 3 4 ALTER TABLE user_info ADD school VARCHAR(15) AFTER level, CHANGE job profession VARCHAR(10), MODIFY achievement INT(11) DEFAULT 0; 删除表 描述：现有一张试卷作答记录表 exam_record，其中包含多年来的用户作答试卷记录。一般每年都会为 exam_record 表建立一张备份表 exam_record_{YEAR}，{YEAR} 为对应年份。\n现在随着数据越来越多，存储告急，请你把很久前的（2011 到 2014 年）备份表都删掉（如果存在的话）。\n思路：这题很简单，直接删就行，如果嫌麻烦，可以将要删除的表用逗号隔开，写到一行；这里肯定会有小伙伴问：如果要删除很多张表呢？放心，如果要删除很多张表，可以写脚本来进行删除。\n答案：\n1 2 3 4 DROP TABLE IF EXISTS exam_record_2011; DROP TABLE IF EXISTS exam_record_2012; DROP TABLE IF EXISTS exam_record_2013; DROP TABLE IF EXISTS exam_record_2014; 创建索引 描述：现有一张试卷信息表 examination_info，其中包含各种类型试卷的信息。为了对表更方便快捷地查询，需要在 examination_info 表创建以下索引，\n规则如下：在 duration 列创建普通索引 idx_duration、在 exam_id 列创建唯一性索引 uniq_idx_exam_id、在 tag 列创建全文索引 full_idx_tag。\n根据题意，将返回如下结果：\nexamination_info 0 PRIMARY 1 id A 0 BTREE examination_info 0 uniq_idx_exam_id 1 exam_id A 0 YES BTREE examination_info 1 idx_duration 1 duration A 0 BTREE examination_info 1 full_idx_tag 1 tag 0 YES FULLTEXT 备注：后台会通过 SHOW INDEX FROM examination_info 语句来对比输出结果\n思路：做这题首先需要了解常见的索引类型：\nB-Tree 索引：B-Tree（或称为平衡树）索引是最常见和默认的索引类型。它适用于各种查询条件，可以快速定位到符合条件的数据。B-Tree 索引适用于普通的查找操作，支持等值查询、范围查询和排序。 唯一索引：唯一索引与普通的 B-Tree 索引类似，不同之处在于它要求被索引的列的值是唯一的。这意味着在插入或更新数据时，MySQL 会验证索引列的唯一性。 主键索引：主键索引是一种特殊的唯一索引，它用于唯一标识表中的每一行数据。每个表只能有一个主键索引，它可以帮助提高数据的访问速度和数据完整性。 全文索引：全文索引用于在文本数据中进行全文搜索。它支持在文本字段中进行关键字搜索，而不仅仅是简单的等值或范围查找。全文索引适用于需要进行全文搜索的应用场景。 1 2 3 4 5 6 7 8 9 10 11 -- 示例： -- 添加B-Tree索引： CREATE INDEX idx_name(索引名) ON 表名 (字段名); -- idx_name为索引名，以下都是 -- 创建唯一索引： CREATE UNIQUE INDEX idx_name ON 表名 (字段名); -- 创建一个主键索引： ALTER TABLE 表名 ADD PRIMARY KEY (字段名); -- 创建一个全文索引 ALTER TABLE 表名 ADD FULLTEXT INDEX idx_name (字段名); -- 通过以上示例，可以看出create 和 alter 都可以添加索引 有了以上的基础知识之后，该题答案也就浮出水面了。\n答案：\n1 2 3 4 ALTER TABLE examination_info ADD INDEX idx_duration(duration), ADD UNIQUE INDEX uniq_idx_exam_id(exam_id), ADD FULLTEXT INDEX full_idx_tag(tag); 删除索引 描述：请删除examination_info表上的唯一索引 uniq_idx_exam_id 和全文索引 full_idx_tag。\n思路：该题考察删除索引的基本语法：\n1 2 3 4 5 -- 使用 DROP INDEX 删除索引 DROP INDEX idx_name ON 表名; -- 使用 ALTER TABLE 删除索引 ALTER TABLE employees DROP INDEX idx_email; 这里需要注意的是：在 MySQL 中，一次删除多个索引的操作是不支持的。每次删除索引时，只能指定一个索引名称进行删除。\n而且 DROP 命令需要慎用！！！\n答案：\n1 2 DROP INDEX uniq_idx_exam_id ON examination_info; DROP INDEX full_idx_tag ON examination_info; SQL面试题3 聚合函数 SQL 类别高难度试卷得分的截断平均值（较难） 描述： 牛客的运营同学想要查看大家在 SQL 类别中高难度试卷的得分情况。\n请你帮她从exam_record数据表中计算所有用户完成 SQL 类别高难度试卷得分的截断平均值（去掉一个最大值和一个最小值后的平均值）。\n示例数据：examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2020-01-01 10:00:00 2 9002 算法 medium 80 2020-08-02 10:00:00 示例数据：exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-02 09:01:01 2020-01-02 09:21:01 80 2 1001 9001 2021-05-02 10:01:01 2021-05-02 10:30:01 81 3 1001 9001 2021-06-02 19:01:01 2021-06-02 19:31:01 84 4 1001 9002 2021-09-05 19:01:01 2021-09-05 19:40:01 89 5 1001 9001 2021-09-02 12:01:01 (NULL) (NULL) 6 1001 9002 2021-09-01 12:01:01 (NULL) (NULL) 7 1002 9002 2021-02-02 19:01:01 2021-02-02 19:30:01 87 8 1002 9001 2021-05-05 18:01:01 2021-05-05 18:59:02 90 9 1003 9001 2021-09-07 12:01:01 2021-09-07 10:31:01 50 10 1004 9001 2021-09-06 10:01:01 (NULL) (NULL) 根据输入你的查询结果如下：\ntag difficulty clip_avg_score SQL hard 81.7 从examination_info表可知，试卷 9001 为高难度 SQL 试卷，该试卷被作答的得分有[80,81,84,90,50]，去除最高分和最低分后为[80,81,84]，平均分为 81.6666667，保留一位小数后为 81.7\n输入描述：\n输入数据中至少有 3 个有效分数\n思路一： 要找出高难度 sql 试卷，肯定需要联 examination_info 这张表，然后找出高难度的课程，由 examination_info 得知，高难度 sql 的 exam_id 为 9001，那么等下就以 exam_id = 9001 作为条件去查询；\n先找出 9001 号考试 select * from exam_record where exam_id = 9001\n然后，找出最高分 select max(score) 最高分 from exam_record where exam_id = 9001\n接着，找出最低分 select min(score) 最低分 from exam_record where exam_id = 9001\n在查询出来的分数结果集当中，去掉最高分和最低分，最直观能想到的就是 NOT IN 或者 用 NOT EXISTS 也行，这里以 NOT IN 来做\n首先将主体写出来select tag, difficulty, round(avg(score), 1) clip_avg_score from examination_info info INNER JOIN exam_record record\n小 tips : MYSQL 的 ROUND() 函数 ,ROUND(X)返回参数 X 最近似的整数 ROUND(X,D)返回 X ,其值保留到小数点后 D 位,第 D 位的保留方式为四舍五入。\n再将上面的 “碎片” 语句拼凑起来即可， 注意在 NOT IN 中两个子查询用 UNION ALL 来关联，用 union 把 max 和 min 的结果集中在一行当中，这样形成一列多行的效果。\n答案一：\n1 2 3 4 5 6 7 8 9 10 11 12 13 SELECT tag, difficulty, ROUND(AVG(score), 1) clip_avg_score FROM examination_info info INNER JOIN exam_record record WHERE info.exam_id = record.exam_id AND record.exam_id = 9001 AND record.score NOT IN( SELECT MAX(score) FROM exam_record WHERE exam_id = 9001 UNION ALL SELECT MIN(score) FROM exam_record WHERE exam_id = 9001 ) 这是最直观，也是最容易想到的解法，但是还有待改进，这算是投机取巧过关，其实严格按照题目要求应该这么写：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 SELECT tag, difficulty, ROUND(AVG(score), 1) clip_avg_score FROM examination_info info INNER JOIN exam_record record WHERE info.exam_id = record.exam_id AND record.exam_id = (SELECT examination_info.exam_id FROM examination_info WHERE tag = 'SQL' AND difficulty = 'hard' ) AND record.score NOT IN (SELECT MAX(score) FROM exam_record WHERE exam_id = (SELECT examination_info.exam_id FROM examination_info WHERE tag = 'SQL' AND difficulty = 'hard' ) UNION ALL SELECT MIN(score) FROM exam_record WHERE exam_id = (SELECT examination_info.exam_id FROM examination_info WHERE tag = 'SQL' AND difficulty = 'hard' ) ) 然而你会发现，重复的语句非常多，所以可以利用WITH来抽取公共部分\nWITH 子句介绍：\nWITH 子句，也称为公共表表达式（Common Table Expression，CTE），是在 SQL 查询中定义临时表的方式。它可以让我们在查询中创建一个临时命名的结果集，并且可以在同一查询中引用该结果集。\n基本用法：\n1 2 3 4 5 6 7 8 9 10 WITH cte_name (column1, column2, ..., columnN) AS ( -- 查询体 SELECT ... FROM ... WHERE ... ) -- 主查询 SELECT ... FROM cte_name WHERE ... WITH 子句由以下几个部分组成：\ncte_name: 给临时表起一个名称，可以在主查询中引用。 (column1, column2, ..., columnN): 可选，指定临时表的列名。 AS: 必需，表示开始定义临时表。 CTE 查询体: 实际的查询语句，用于定义临时表中的数据。 WITH 子句的主要用途之一是增强查询的可读性和可维护性，尤其在涉及多个嵌套子查询或需要重复使用相同的查询逻辑时。通过将这些逻辑放在一个命名的临时表中，我们可以更清晰地组织查询，并消除重复代码。\n此外，WITH 子句还可以在复杂的查询中实现递归查询。递归查询允许我们在单个查询中执行对同一表的多次迭代，逐步构建结果集。这在处理层次结构数据、组织结构和树状结构等场景中非常有用。\n小细节：MySQL 5.7 版本以及之前的版本不支持在 WITH 子句中直接使用别名。\n下面是改进后的答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 WITH t1 AS (SELECT record.*, info.tag, info.difficulty FROM exam_record record INNER JOIN examination_info info ON record.exam_id = info.exam_id WHERE info.tag = \"SQL\" AND info.difficulty = \"hard\" ) SELECT tag, difficulty, ROUND(AVG(score), 1) FROM t1 WHERE score NOT IN (SELECT max(score) FROM t1 UNION SELECT min(score) FROM t1) 思路二：\n筛选 SQL 高难度试卷：where tag=\"SQL\" and difficulty=\"hard\" 计算截断平均值：(和-最大值-最小值) / (总个数-2): (sum(score) - max(score) - min(score)) / (count(score) - 2) 有一个缺点就是，如果最大值和最小值有多个，这个方法就很难筛选出来, 但是题目中说了—–\u003e去掉一个最大值和一个最小值后的平均值, 所以这里可以用这个公式。 答案二：\n1 2 3 4 5 6 7 8 SELECT info.tag, info.difficulty, ROUND((SUM(record.score)- MIN(record.score)- MAX(record.score)) / (COUNT(record.score)- 2), 1) AS clip_avg_score FROM examination_info info, exam_record record WHERE info.exam_id = record.exam_id AND info.tag = \"SQL\" AND info.difficulty = \"hard\"; 统计作答次数 有一个试卷作答记录表 exam_record，请从中统计出总作答次数 total_pv、试卷已完成作答数 complete_pv、已完成的试卷数 complete_exam_cnt。\n示例数据 exam_record 表（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-02 09:01:01 2020-01-02 09:21:01 80 2 1001 9001 2021-05-02 10:01:01 2021-05-02 10:30:01 81 3 1001 9001 2021-06-02 19:01:01 2021-06-02 19:31:01 84 4 1001 9002 2021-09-05 19:01:01 2021-09-05 19:40:01 89 5 1001 9001 2021-09-02 12:01:01 (NULL) (NULL) 6 1001 9002 2021-09-01 12:01:01 (NULL) (NULL) 7 1002 9002 2021-02-02 19:01:01 2021-02-02 19:30:01 87 8 1002 9001 2021-05-05 18:01:01 2021-05-05 18:59:02 90 9 1003 9001 2021-09-07 12:01:01 2021-09-07 10:31:01 50 10 1004 9001 2021-09-06 10:01:01 (NULL) (NULL) 示例输出：\ntotal_pv complete_pv complete_exam_cnt 11 7 2 解释：表示截止当前，有 11 次试卷作答记录，已完成的作答次数为 7 次（中途退出的为未完成状态，其交卷时间和份数为 NULL），已完成的试卷有 9001 和 9002 两份。\n思路： 这题一看到统计次数，肯定第一时间就要想到用COUNT这个函数来解决，问题是要统计不同的记录，该怎么来写？使用子查询就能解决这个题目(这题用 case when 也能写出来，解法类似，逻辑不同而已)；首先在做这个题之前，让我们先来了解一下COUNT的基本用法；\nCOUNT() 函数的基本语法如下所示：\n1 COUNT(expression) 其中，expression 可以是列名、表达式、常量或通配符。下面是一些常见的用法示例：\n计算表中所有行的数量： 1 SELECT COUNT(*) FROM table_name; 计算特定列非空（不为 NULL）值的数量： 1 SELECT COUNT(column_name) FROM table_name; 计算满足条件的行数： 1 SELECT COUNT(*) FROM table_name WHERE condition; 结合 GROUP BY 使用，计算分组后每个组的行数： 1 SELECT column_name, COUNT(*) FROM table_name GROUP BY column_name; 计算不同列组合的唯一组合数： 1 SELECT COUNT(DISTINCT column_name1, column_name2) FROM table_name; 在使用 COUNT() 函数时，如果不指定任何参数或者使用 COUNT(*)，将会计算所有行的数量。而如果使用列名，则只会计算该列非空值的数量。\n另外，COUNT() 函数的结果是一个整数值。即使结果是零，也不会返回 NULL，这点需要谨记。\n答案：\n1 2 3 4 5 6 SELECT count(*) total_pv, ( SELECT count(*) FROM exam_record WHERE submit_time IS NOT NULL ) complete_pv, ( SELECT COUNT( DISTINCT exam_id, score IS NOT NULL OR NULL ) FROM exam_record ) complete_exam_cnt FROM exam_record 这里着重说一下COUNT( DISTINCT exam_id, score IS NOT NULL OR NULL )这一句，判断 score 是否为 null ，如果是即为真，如果不是返回 null；注意这里如果不加 or null 在不是 null 的情况下只会返回 false 也就是返回 0；\nCOUNT本身是不可以对多列求行数的，distinct的加入是的多列成为一个整体，可以求出现的行数了;count distinct在计算时只返回非 null 的行, 这个也要注意；\n另外通过本题 get 到了——\u003ecount 加条件常用句式count( 列判断 or null)\n得分不小于平均分的最低分 描述： 请从试卷作答记录表中找到 SQL 试卷得分不小于该类试卷平均得分的用户最低得分。\n示例数据 exam_record 表（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-02 09:01:01 2020-01-02 09:21:01 80 2 1002 9001 2021-09-05 19:01:01 2021-09-05 19:40:01 89 3 1002 9002 2021-09-02 12:01:01 (NULL) (NULL) 4 1002 9003 2021-09-01 12:01:01 (NULL) (NULL) 5 1002 9001 2021-02-02 19:01:01 2021-02-02 19:30:01 87 6 1002 9002 2021-05-05 18:01:01 2021-05-05 18:59:02 90 7 1003 9002 2021-02-06 12:01:01 (NULL) (NULL) 8 1003 9003 2021-09-07 10:01:01 2021-09-07 10:31:01 86 9 1004 9003 2021-09-06 12:01:01 (NULL) (NULL) examination_info 表（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2020-01-01 10:00:00 2 9002 SQL easy 60 2020-02-01 10:00:00 3 9003 算法 medium 80 2020-08-02 10:00:00 示例输出数据：\nmin_score_over_avg 87 解释：试卷 9001 和 9002 为 SQL 类别，作答这两份试卷的得分有[80,89,87,90]，平均分为 86.5，不小于平均分的最小分数为 87\n思路：这类题目第一眼看确实很复杂， 因为不知道从哪入手，但是当我们仔细读题审题后，要学会抓住题干中的关键信息。以本题为例：请从试卷作答记录表中找到SQL试卷得分不小于该类试卷平均得分的用户最低得分。你能一眼从中提取哪些有效信息来作为解题思路？\n第一条：找到==SQL==试卷得分\n第二条：该类试卷==平均得分==\n第三条：该类试卷的==用户最低得分==\n然后中间的 “桥梁” 就是==不小于==\n将条件拆分后，先逐步完成\n1 2 3 4 5 -- 找出tag为‘SQL’的得分 【80, 89,87,90】 -- 再算出这一组的平均得分 select ROUND(AVG(score), 1) from examination_info info INNER JOIN exam_record record where info.exam_id = record.exam_id and tag= 'SQL' 然后再找出该类试卷的最低得分，接着将结果集【80, 89,87,90】 去和平均分数作比较，方可得出最终答案。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 SELECT MIN(score) AS min_score_over_avg FROM examination_info info INNER JOIN exam_record record WHERE info.exam_id = record.exam_id AND tag= 'SQL' AND score \u003e= (SELECT ROUND(AVG(score), 1) FROM examination_info info INNER JOIN exam_record record WHERE info.exam_id = record.exam_id AND tag= 'SQL' ) 其实这类题目给出的要求看似很 “绕”，但其实仔细梳理一遍，将大条件拆分成小条件，逐个拆分完以后，最后将所有条件拼凑起来。反正只要记住：抓主干，理分支，问题便迎刃而解。\n分组查询 平均活跃天数和月活人数 描述：用户在牛客试卷作答区作答记录存储在表 exam_record 中，内容如下：\nexam_record 表（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）\nid uid exam_id start_time submit_time score 1 1001 9001 2021-07-02 09:01:01 2021-07-02 09:21:01 80 2 1002 9001 2021-09-05 19:01:01 2021-09-05 19:40:01 81 3 1002 9002 2021-09-02 12:01:01 (NULL) (NULL) 4 1002 9003 2021-09-01 12:01:01 (NULL) (NULL) 5 1002 9001 2021-07-02 19:01:01 2021-07-02 19:30:01 82 6 1002 9002 2021-07-05 18:01:01 2021-07-05 18:59:02 90 7 1003 9002 2021-07-06 12:01:01 (NULL) (NULL) 8 1003 9003 2021-09-07 10:01:01 2021-09-07 10:31:01 86 9 1004 9003 2021-09-06 12:01:01 (NULL) (NULL) 10 1002 9003 2021-09-01 12:01:01 2021-09-01 12:31:01 81 11 1005 9001 2021-09-01 12:01:01 2021-09-01 12:31:01 88 12 1006 9002 2021-09-02 12:11:01 2021-09-02 12:31:01 89 13 1007 9002 2020-09-02 12:11:01 2020-09-02 12:31:01 89 请计算 2021 年每个月里试卷作答区用户平均月活跃天数 avg_active_days 和月度活跃人数 mau，上面数据的示例输出如下：\nmonth avg_active_days mau 202107 1.50 2 202109 1.25 4 解释：2021 年 7 月有 2 人活跃，共活跃了 3 天（1001 活跃 1 天，1002 活跃 2 天），平均活跃天数 1.5；2021 年 9 月有 4 人活跃，共活跃了 5 天，平均活跃天数 1.25，结果保留 2 位小数。\n注：此处活跃指有==交卷==行为。\n思路：读完题先注意高亮部分；一般求天数和月活跃人数马上就要想到相关的日期函数；这一题我们同样来进行拆分，把问题细化再解决；首先求活跃人数，肯定要用到COUNT()，那这里首先就有一个坑，不知道大家注意了没有？用户 1002 在 9 月份做了两种不同的试卷，所以这里要注意去重，不然在统计的时候，活跃人数是错的；第二个就是要知道日期的格式化，如上表，题目要求以202107这种日期格式展现，要用到DATE_FORMAT来进行格式化。\n基本用法：\n1 DATE_FORMAT(date_value, format) date_value 参数是待格式化的日期或时间值。 format 参数是指定的日期或时间格式（这个和 Java 里面的日期格式一样）。 答案：\n1 2 3 4 5 6 SELECT DATE_FORMAT(submit_time, '%Y%m') MONTH, round(count(DISTINCT UID, DATE_FORMAT(submit_time, '%Y%m%d')) / count(DISTINCT UID), 2) avg_active_days, COUNT(DISTINCT UID) mau FROM exam_record WHERE YEAR (submit_time) = 2021 GROUP BY MONTH 这里多说一句, 使用COUNT(DISTINCT uid, DATE_FORMAT(submit_time, '%Y%m%d')) 可以统计在 uid 列和 submit_time 列按照年份、月份和日期进行格式化后的组合值的数量。\n月总刷题数和日均刷题数 描述：现有一张题目练习记录表 practice_record，示例内容如下：\nid uid question_id submit_time score 1 1001 8001 2021-08-02 11:41:01 60 2 1002 8001 2021-09-02 19:30:01 50 3 1002 8001 2021-09-02 19:20:01 70 4 1002 8002 2021-09-02 19:38:01 70 5 1003 8002 2021-08-01 19:38:01 80 请从中统计出 2021 年每个月里用户的月总刷题数 month_q_cnt 和日均刷题数 avg_day_q_cnt（按月份升序排序）以及该年的总体情况，示例数据输出如下：\nsubmit_month month_q_cnt avg_day_q_cnt 202108 2 0.065 202109 3 0.100 2021 汇总 5 0.161 解释：2021 年 8 月共有 2 次刷题记录，日均刷题数为 2/31=0.065（保留 3 位小数）；2021 年 9 月共有 3 次刷题记录，日均刷题数为 3/30=0.100；2021 年共有 5 次刷题记录（年度汇总平均无实际意义，这里我们按照 31 天来算 5/31=0.161）\n牛客已经采用最新的 Mysql 版本，如果您运行结果出现错误：ONLY_FULL_GROUP_BY，意思是：对于 GROUP BY 聚合操作，如果在 SELECT 中的列，没有在 GROUP BY 中出现，那么这个 SQL 是不合法的，因为列不在 GROUP BY 从句中，也就是说查出来的列必须在 group by 后面出现否则就会报错，或者这个字段出现在聚合函数里面。\n思路：\n看到实例数据就要马上联想到相关的函数，比如submit_month就要用到DATE_FORMAT来格式化日期。然后查出每月的刷题数量。\n每月的刷题数量\n1 2 3 4 5 SELECT MONTH ( submit_time ), COUNT( question_id ) FROM practice_record GROUP BY MONTH (submit_time) 接着第三列这里要用到DAY(LAST_DAY(date_value))函数来查找给定日期的月份中的天数。\n示例代码如下：\n1 2 3 4 5 6 7 8 SELECT DAY(LAST_DAY('2023-07-08')) AS days_in_month; -- 输出：31 SELECT DAY(LAST_DAY('2023-02-01')) AS days_in_month; -- 输出：28 (闰年中的二月份) SELECT DAY(LAST_DAY(NOW())) AS days_in_current_month; -- 输出：31 （当前月份的天数） 使用 LAST_DAY() 函数获取给定日期的当月最后一天，然后使用 DAY() 函数提取该日期的天数。这样就能获得指定月份的天数。\n需要注意的是，LAST_DAY() 函数返回的是日期值，而 DAY() 函数用于提取日期值中的天数部分。\n有了上述的分析之后，即可马上写出答案，这题复杂就复杂在处理日期上，其中的逻辑并不难。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 SELECT DATE_FORMAT(submit_time, '%Y%m') submit_month, count(question_id) month_q_cnt, ROUND(COUNT(question_id) / DAY (LAST_DAY(submit_time)), 3) avg_day_q_cnt FROM practice_record WHERE DATE_FORMAT(submit_time, '%Y') = '2021' GROUP BY submit_month UNION ALL SELECT '2021汇总' AS submit_month, count(question_id) month_q_cnt, ROUND(COUNT(question_id) / 31, 3) avg_day_q_cnt FROM practice_record WHERE DATE_FORMAT(submit_time, '%Y') = '2021' ORDER BY submit_month 在实例数据输出中因为最后一行需要得出汇总数据，所以这里要 UNION ALL加到结果集中；别忘了最后要排序！\n未完成试卷数大于 1 的有效用户（较难） 描述：现有试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分），示例数据如下：\nid uid exam_id start_time submit_time score 1 1001 9001 2021-07-02 09:01:01 2021-07-02 09:21:01 80 2 1002 9001 2021-09-05 19:01:01 2021-09-05 19:40:01 81 3 1002 9002 2021-09-02 12:01:01 (NULL) (NULL) 4 1002 9003 2021-09-01 12:01:01 (NULL) (NULL) 5 1002 9001 2021-07-02 19:01:01 2021-07-02 19:30:01 82 6 1002 9002 2021-07-05 18:01:01 2021-07-05 18:59:02 90 7 1003 9002 2021-07-06 12:01:01 (NULL) (NULL) 8 1003 9003 2021-09-07 10:01:01 2021-09-07 10:31:01 86 9 1004 9003 2021-09-06 12:01:01 (NULL) (NULL) 10 1002 9003 2021-09-01 12:01:01 2021-09-01 12:31:01 81 11 1005 9001 2021-09-01 12:01:01 2021-09-01 12:31:01 88 12 1006 9002 2021-09-02 12:11:01 2021-09-02 12:31:01 89 13 1007 9002 2020-09-02 12:11:01 2020-09-02 12:31:01 89 还有一张试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间），示例数据如下：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2020-01-01 10:00:00 2 9002 SQL easy 60 2020-02-01 10:00:00 3 9003 算法 medium 80 2020-08-02 10:00:00 请统计 2021 年每个未完成试卷作答数大于 1 的有效用户的数据（有效用户指完成试卷作答数至少为 1 且未完成数小于 5），输出用户 ID、未完成试卷作答数、完成试卷作答数、作答过的试卷 tag 集合，按未完成试卷数量由多到少排序。示例数据的输出结果如下：\nuid incomplete_cnt complete_cnt detail 1002 2 4 2021-09-01:算法;2021-07-02:SQL;2021-09-02:SQL;2021-09-05:SQL;2021-07-05:SQL 解释：2021 年的作答记录中，除了 1004，其他用户均满足有效用户定义，但只有 1002 未完成试卷数大于 1，因此只输出 1002，detail 中是 1002 作答过的试卷{日期:tag}集合，日期和 tag 间用 : 连接，多元素间用 ; 连接。\n思路：\n仔细读题后，分析出：首先要联表，因为后面要输出tag；\n筛选出 2021 年的数据\n1 2 3 4 SELECT * FROM exam_record er LEFT JOIN examination_info ei ON er.exam_id = ei.exam_id WHERE YEAR (er.start_time)= 2021 根据 uid 进行分组，然后对每个用户进行条件进行判断，题目中要求完成试卷数至少为1,未完成试卷数要大于1，小于5\n那么等会儿写 sql 的时候条件应该是：未完成 \u003e 1 and 已完成 \u003e=1 and 未完成 \u003c 5\n因为最后要用到字符串的拼接，而且还要组合拼接，这个可以用GROUP_CONCAT函数，下面简单介绍一下该函数的用法：\n基本格式：\n1 GROUP_CONCAT([DISTINCT] expr [ORDER BY {unsigned_integer | col_name | expr} [ASC | DESC] [, ...]] [SEPARATOR sep]) expr：要连接的列或表达式。 DISTINCT：可选参数，用于去重。当指定了 DISTINCT，相同的值只会出现一次。 ORDER BY：可选参数，用于排序连接后的值。可以选择升序 (ASC) 或降序 (DESC) 排序。 SEPARATOR sep：可选参数，用于设置连接后的值的分隔符。（本题要用这个参数设置 ; 号 ） GROUP_CONCAT() 函数常用于 GROUP BY 子句中，将一组行的值连接为一个字符串，并在结果集中以聚合的形式返回。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 SELECT a.uid, SUM(CASE WHEN a.submit_time IS NULL THEN 1 END) AS incomplete_cnt, SUM(CASE WHEN a.submit_time IS NOT NULL THEN 1 END) AS complete_cnt, GROUP_CONCAT(DISTINCT CONCAT(DATE_FORMAT(a.start_time, '%Y-%m-%d'), ':', b.tag) ORDER BY start_time SEPARATOR \";\") AS detail FROM exam_record a LEFT JOIN examination_info b ON a.exam_id = b.exam_id WHERE YEAR (a.start_time)= 2021 GROUP BY a.uid HAVING incomplete_cnt \u003e 1 AND complete_cnt \u003e= 1 AND incomplete_cnt \u003c 5 ORDER BY incomplete_cnt DESC SUM(CASE WHEN a.submit_time IS NULL THEN 1 END) 统计了每个用户未完成的记录数量。 SUM(CASE WHEN a.submit_time IS NOT NULL THEN 1 END) 统计了每个用户已完成的记录数量。 GROUP_CONCAT(DISTINCT CONCAT(DATE_FORMAT(a.start_time, '%Y-%m-%d'), ':', b.tag) ORDER BY a.start_time SEPARATOR ';') 将每个用户的考试日期和标签以逗号分隔的形式连接成一个字符串，并按考试开始时间进行排序。 嵌套子查询 月均完成试卷数不小于 3 的用户爱作答的类别（较难） 描述：现有试卷作答记录表 exam_record（uid：用户 ID, exam_id：试卷 ID, start_time：开始作答时间, submit_time：交卷时间，没提交的话为 NULL, score：得分），示例数据如下：\nid uid exam_id start_time submit_time score 1 1001 9001 2021-07-02 09:01:01 (NULL) (NULL) 2 1002 9003 2021-09-01 12:01:01 2021-09-01 12:21:01 60 3 1002 9002 2021-09-02 12:01:01 2021-09-02 12:31:01 70 4 1002 9001 2021-09-05 19:01:01 2021-09-05 19:40:01 81 5 1002 9002 2021-07-06 12:01:01 (NULL) (NULL) 6 1003 9003 2021-09-07 10:01:01 2021-09-07 10:31:01 86 7 1003 9003 2021-09-08 12:01:01 2021-09-08 12:11:01 40 8 1003 9001 2021-09-08 13:01:01 (NULL) (NULL) 9 1003 9002 2021-09-08 14:01:01 (NULL) (NULL) 10 1003 9003 2021-09-08 15:01:01 (NULL) (NULL) 11 1005 9001 2021-09-01 12:01:01 2021-09-01 12:31:01 88 12 1005 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 88 13 1005 9002 2021-09-02 12:11:01 2021-09-02 12:31:01 89 试卷信息表 examination_info（exam_id：试卷 ID, tag：试卷类别, difficulty：试卷难度, duration：考试时长, release_time：发布时间），示例数据如下：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2020-01-01 10:00:00 2 9002 C++ easy 60 2020-02-01 10:00:00 3 9003 算法 medium 80 2020-08-02 10:00:00 请从表中统计出 “当月均完成试卷数”不小于 3 的用户们爱作答的类别及作答次数，按次数降序输出，示例输出如下：\ntag tag_cnt C++ 4 SQL 2 算法 1 解释：用户 1002 和 1005 在 2021 年 09 月的完成试卷数目均为 3，其他用户均小于 3；然后用户 1002 和 1005 作答过的试卷 tag 分布结果按作答次数降序排序依次为 C++、SQL、算法。\n思路：这题考察联合子查询，重点在于月均回答\u003e=3, 但是个人认为这里没有表述清楚，应该直接说查 9 月的就容易理解多了；这里不是每个月都要\u003e=3 或者是所有答题次数/答题月份。不要理解错误了。\n先查询出哪些用户月均答题大于三次\n1 2 3 4 5 SELECT UID FROM exam_record record GROUP BY UID, MONTH (start_time) HAVING count(submit_time) \u003e= 3 有了这一步之后再进行深入，只要能理解上一步(我的意思是不被题目中的月均所困扰)，然后再套一个子查询，查哪些用户包含其中，然后查出题目中所需的列即可。记得排序！！\n1 2 3 4 5 6 7 8 9 10 11 12 SELECT tag, count(start_time) AS tag_cnt FROM exam_record record INNER JOIN examination_info info ON record.exam_id = info.exam_id WHERE UID IN (SELECT UID FROM exam_record record GROUP BY UID, MONTH (start_time) HAVING count(submit_time) \u003e= 3) GROUP BY tag ORDER BY tag_cnt DESC 试卷发布当天作答人数和平均分 描述：现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间），示例数据如下：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 号 3100 7 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 2100 6 算法 2020-01-01 10:00:00 3 1003 牛客 3 号 1500 5 算法 2020-01-01 10:00:00 4 1004 牛客 4 号 1100 4 算法 2020-01-01 10:00:00 5 1005 牛客 5 号 1600 6 C++ 2020-01-01 10:00:00 6 1006 牛客 6 号 3000 6 C++ 2020-01-01 10:00:00 释义：用户 1001 昵称为牛客 1 号，成就值为 3100，用户等级是 7 级，职业方向为算法，注册时间 2020-01-01 10:00:00\n试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间） 示例数据如下：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2021-09-01 06:00:00 2 9002 C++ easy 60 2020-02-01 10:00:00 3 9003 算法 medium 80 2020-08-02 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分） 示例数据如下：\nid uid exam_id start_time submit_time score 1 1001 9001 2021-07-02 09:01:01 2021-09-01 09:41:01 70 2 1002 9003 2021-09-01 12:01:01 2021-09-01 12:21:01 60 3 1002 9002 2021-09-02 12:01:01 2021-09-02 12:31:01 70 4 1002 9001 2021-09-01 19:01:01 2021-09-01 19:40:01 80 5 1002 9003 2021-08-01 12:01:01 2021-08-01 12:21:01 60 6 1002 9002 2021-08-02 12:01:01 2021-08-02 12:31:01 70 7 1002 9001 2021-09-01 19:01:01 2021-09-01 19:40:01 85 8 1002 9002 2021-07-06 12:01:01 (NULL) (NULL) 9 1003 9002 2021-09-07 10:01:01 2021-09-07 10:31:01 86 10 1003 9003 2021-09-08 12:01:01 2021-09-08 12:11:01 40 11 1003 9003 2021-09-01 13:01:01 2021-09-01 13:41:01 70 12 1003 9001 2021-09-08 14:01:01 (NULL) (NULL) 13 1003 9002 2021-09-08 15:01:01 (NULL) (NULL) 14 1005 9001 2021-09-01 12:01:01 2021-09-01 12:31:01 90 15 1005 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 88 16 1005 9002 2021-09-02 12:11:01 2021-09-02 12:31:01 89 请计算每张 SQL 类别试卷发布后，当天 5 级以上的用户作答的人数 uv 和平均分 avg_score，按人数降序，相同人数的按平均分升序，示例数据结果输出如下：\nexam_id uv avg_score 9001 3 81.3 解释：只有一张 SQL 类别的试卷，试卷 ID 为 9001，发布当天（2021-09-01）有 1001、1002、1003、1005 作答过，但是 1003 是 5 级用户，其他 3 位为 5 级以上，他们三的得分有[70,80,85,90]，平均分为 81.3（保留 1 位小数）。\n思路：这题看似很复杂，但是先逐步将“外边”条件拆分，然后合拢到一起，答案就出来，多表查询反正记住：由外向里，抽丝剥茧。\n先把三种表连起来，同时给定一些条件，比如题目中要求等级\u003e 5的用户，那么可以先查出来\n1 2 3 4 5 6 7 SELECT DISTINCT u_info.uid FROM examination_info e_info INNER JOIN exam_record record INNER JOIN user_info u_info WHERE e_info.exam_id = record.exam_id AND u_info.uid = record.uid AND u_info.LEVEL \u003e 5 接着注意题目中要求：每张sql类别试卷发布后，当天作答用户，注意其中的==当天==，那我们马上就要想到要用到时间的比较。\n对试卷发布日期和开始考试日期进行比较：DATE(e_info.release_time) = DATE(record.start_time)；不用担心submit_time 为 null 的问题，后续在 where 中会给过滤掉。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 SELECT record.exam_id AS exam_id, COUNT(DISTINCT u_info.uid) AS uv, ROUND(SUM(record.score) / COUNT(u_info.uid), 1) AS avg_score FROM examination_info e_info INNER JOIN exam_record record INNER JOIN user_info u_info WHERE e_info.exam_id = record.exam_id AND u_info.uid = record.uid AND DATE (e_info.release_time) = DATE (record.start_time) AND submit_time IS NOT NULL AND tag = 'SQL' AND u_info.LEVEL \u003e 5 GROUP BY record.exam_id ORDER BY uv DESC, avg_score ASC 注意最后的分组排序！先按人数排，若一致，按平均分排。\n作答试卷得分大于过 80 的人的用户等级分布 描述：\n现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 号 3100 7 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 2100 6 算法 2020-01-01 10:00:00 3 1003 牛客 3 号 1500 5 算法 2020-01-01 10:00:00 4 1004 牛客 4 号 1100 4 算法 2020-01-01 10:00:00 5 1005 牛客 5 号 1600 6 C++ 2020-01-01 10:00:00 6 1006 牛客 6 号 3000 6 C++ 2020-01-01 10:00:00 试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2021-09-01 06:00:00 2 9002 C++ easy 60 2021-09-01 06:00:00 3 9003 算法 medium 80 2021-09-01 10:00:00 试卷作答信息表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2021-09-01 09:01:01 2021-09-01 09:41:01 79 2 1002 9003 2021-09-01 12:01:01 2021-09-01 12:21:01 60 3 1002 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 70 4 1002 9001 2021-09-01 19:01:01 2021-09-01 19:40:01 80 5 1002 9003 2021-08-01 12:01:01 2021-08-01 12:21:01 60 6 1002 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 70 7 1002 9001 2021-09-01 19:01:01 2021-09-01 19:40:01 85 8 1002 9002 2021-09-01 12:01:01 (NULL) (NULL) 9 1003 9002 2021-09-07 10:01:01 2021-09-07 10:31:01 86 10 1003 9003 2021-09-08 12:01:01 2021-09-08 12:11:01 40 11 1003 9003 2021-09-01 13:01:01 2021-09-01 13:41:01 81 12 1003 9001 2021-09-01 14:01:01 (NULL) (NULL) 13 1003 9002 2021-09-08 15:01:01 (NULL) (NULL) 14 1005 9001 2021-09-01 12:01:01 2021-09-01 12:31:01 90 15 1005 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 88 16 1005 9002 2021-09-02 12:11:01 2021-09-02 12:31:01 89 统计作答 SQL 类别的试卷得分大于过 80 的人的用户等级分布，按数量降序排序（保证数量都不同）。示例数据结果输出如下：\nlevel level_cnt 6 2 5 1 解释：9001 为 SQL 类试卷，作答该试卷大于 80 分的人有 1002、1003、1005 共 3 人，6 级两人，5 级一人。\n**思路：**这题和上一题都是一样的数据，只是查询条件改变了而已，上一题理解了，这题分分钟做出来。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 SELECT u_info.LEVEL AS LEVEL, count(u_info.uid) AS level_cnt FROM examination_info e_info INNER JOIN exam_record record INNER JOIN user_info u_info WHERE e_info.exam_id = record.exam_id AND u_info.uid = record.uid AND record.score \u003e 80 AND submit_time IS NOT NULL AND tag = 'SQL' GROUP BY LEVEL ORDER BY level_cnt DESC 合并查询 每个题目和每份试卷被作答的人数和次数 描述：\n现有试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2021-09-01 09:01:01 2021-09-01 09:41:01 81 2 1002 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 70 3 1002 9001 2021-09-01 19:01:01 2021-09-01 19:40:01 80 4 1002 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 70 5 1004 9001 2021-09-01 19:01:01 2021-09-01 19:40:01 85 6 1002 9002 2021-09-01 12:01:01 (NULL) (NULL) 题目练习表 practice_record（uid 用户 ID, question_id 题目 ID, submit_time 提交时间, score 得分）：\nid uid question_id submit_time score 1 1001 8001 2021-08-02 11:41:01 60 2 1002 8001 2021-09-02 19:30:01 50 3 1002 8001 2021-09-02 19:20:01 70 4 1002 8002 2021-09-02 19:38:01 70 5 1003 8001 2021-08-02 19:38:01 70 6 1003 8001 2021-08-02 19:48:01 90 7 1003 8002 2021-08-01 19:38:01 80 请统计每个题目和每份试卷被作答的人数和次数，分别按照\"试卷\"和\"题目\"的 uv \u0026 pv 降序显示，示例数据结果输出如下：\ntid uv pv 9001 3 3 9002 1 3 8001 3 5 8002 2 2 解释：“试卷”有 3 人共练习 3 次试卷 9001，1 人作答 3 次 9002；“刷题”有 3 人刷 5 次 8001，有 2 人刷 2 次 8002\n思路：这题的难点和易错点在于UNOIN和ORDER BY 同时使用的问题\n有以下几种情况：使用union和多个order by不加括号，报错！\norder by在union连接的子句中不起作用；\n比如不加括号：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 SELECT exam_id AS tid, COUNT(DISTINCT UID) AS uv, COUNT(UID) AS pv FROM exam_record GROUP BY exam_id ORDER BY uv DESC, pv DESC UNION SELECT question_id AS tid, COUNT(DISTINCT UID) AS uv, COUNT(UID) AS pv FROM practice_record GROUP BY question_id ORDER BY uv DESC, pv DESC 直接报语法错误，如果没有括号，只能有一个order by\n还有一种order by不起作用的情况，但是能在子句的子句中起作用，这里的解决方案就是在外面再套一层查询。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 SELECT * FROM (SELECT exam_id AS tid, COUNT(DISTINCT exam_record.uid) uv, COUNT(*) pv FROM exam_record GROUP BY exam_id ORDER BY uv DESC, pv DESC) t1 UNION SELECT * FROM (SELECT question_id AS tid, COUNT(DISTINCT practice_record.uid) uv, COUNT(*) pv FROM practice_record GROUP BY question_id ORDER BY uv DESC, pv DESC) t2; 分别满足两个活动的人 描述： 为了促进更多用户在牛客平台学习和刷题进步，我们会经常给一些既活跃又表现不错的用户发放福利。假使以前我们有两拨运营活动，分别给每次试卷得分都能到 85 分的人（activity1）、至少有一次用了一半时间就完成高难度试卷且分数大于 80 的人（activity2）发了福利券。\n现在，需要你一次性将这两个活动满足的人筛选出来，交给运营同学。请写出一个 SQL 实现：输出 2021 年里，所有每次试卷得分都能到 85 分的人以及至少有一次用了一半时间就完成高难度试卷且分数大于 80 的人的 id 和活动号，按用户 ID 排序输出。\n现有试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2021-09-01 06:00:00 2 9002 C++ easy 60 2021-09-01 06:00:00 3 9003 算法 medium 80 2021-09-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2021-09-01 09:01:01 2021-09-01 09:31:00 81 2 1002 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 70 3 1003 9001 2021-09-01 19:01:01 2021-09-01 19:40:01 86 4 1003 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 89 5 1004 9001 2021-09-01 19:01:01 2021-09-01 19:30:01 85 示例数据输出结果：\nuid activity 1001 activity2 1003 activity1 1004 activity1 1004 activity2 解释：用户 1001 最小分数 81 不满足活动 1，但 29 分 59 秒完成了 60 分钟长的试卷得分 81，满足活动 2；1003 最小分数 86 满足活动 1，完成时长都大于试卷时长的一半，不满足活动 2；用户 1004 刚好用了一半时间（30 分钟整）完成了试卷得分 85，满足活动 1 和活动 2。\n思路： 这一题需要涉及到时间的减法，需要用到 TIMESTAMPDIFF() 函数计算两个时间戳之间的分钟差值。\n下面我们来看一下基本用法\n示例：\n1 TIMESTAMPDIFF(MINUTE, start_time, end_time) TIMESTAMPDIFF() 函数的第一个参数是时间单位，这里我们选择 MINUTE 表示返回分钟差值。第二个参数是较早的时间戳，第三个参数是较晚的时间戳。函数会返回它们之间的分钟差值\n了解了这个函数的用法之后，我们再回过头来看activity1的要求，求分数大于 85 即可，那我们还是先把这个写出来，后续思路就会清晰很多\n1 2 3 4 SELECT DISTINCT UID FROM exam_record WHERE score \u003e= 85 AND YEAR (start_time) = '2021' 根据条件 2，接着写出在一半时间内完成高难度试卷且分数大于80的人\n1 2 3 4 5 6 7 SELECT UID FROM examination_info info INNER JOIN exam_record record WHERE info.exam_id = record.exam_id AND (TIMESTAMPDIFF(MINUTE, start_time, submit_time)) \u003c (info.duration / 2) AND difficulty = 'hard' AND score \u003e= 80 然后再把两者UNION 起来即可。（这里特别要注意括号问题和order by位置，具体用法在上一篇中已提及）\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 SELECT DISTINCT UID UID, 'activity1' activity FROM exam_record WHERE UID not in (SELECT UID FROM exam_record WHERE score\u003c85 AND YEAR(submit_time) = 2021 ) UNION SELECT DISTINCT UID UID, 'activity2' activity FROM exam_record e_r LEFT JOIN examination_info e_i ON e_r.exam_id = e_i.exam_id WHERE YEAR(submit_time) = 2021 AND difficulty = 'hard' AND TIMESTAMPDIFF(SECOND, start_time, submit_time) \u003c= duration *30 AND score\u003e80 ORDER BY UID 连接查询 满足条件的用户的试卷完成数和题目练习数（困难） 描述：\n现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 号 3100 7 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 2300 7 算法 2020-01-01 10:00:00 3 1003 牛客 3 号 2500 7 算法 2020-01-01 10:00:00 4 1004 牛客 4 号 1200 5 算法 2020-01-01 10:00:00 5 1005 牛客 5 号 1600 6 C++ 2020-01-01 10:00:00 6 1006 牛客 6 号 2000 6 C++ 2020-01-01 10:00:00 试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2021-09-01 06:00:00 2 9002 C++ hard 60 2021-09-01 06:00:00 3 9003 算法 medium 80 2021-09-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2021-09-01 09:01:01 2021-09-01 09:31:00 81 2 1002 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 81 3 1003 9001 2021-09-01 19:01:01 2021-09-01 19:40:01 86 4 1003 9002 2021-09-01 12:01:01 2021-09-01 12:31:51 89 5 1004 9001 2021-09-01 19:01:01 2021-09-01 19:30:01 85 6 1005 9002 2021-09-01 12:01:01 2021-09-01 12:31:02 85 7 1006 9003 2021-09-07 10:01:01 2021-09-07 10:21:01 84 8 1006 9001 2021-09-07 10:01:01 2021-09-07 10:21:01 80 题目练习记录表 practice_record（uid 用户 ID, question_id 题目 ID, submit_time 提交时间, score 得分）：\nid uid question_id submit_time score 1 1001 8001 2021-08-02 11:41:01 60 2 1002 8001 2021-09-02 19:30:01 50 3 1002 8001 2021-09-02 19:20:01 70 4 1002 8002 2021-09-02 19:38:01 70 5 1004 8001 2021-08-02 19:38:01 70 6 1004 8002 2021-08-02 19:48:01 90 7 1001 8002 2021-08-02 19:38:01 70 8 1004 8002 2021-08-02 19:48:01 90 9 1004 8002 2021-08-02 19:58:01 94 10 1004 8003 2021-08-02 19:38:01 70 11 1004 8003 2021-08-02 19:48:01 90 12 1004 8003 2021-08-01 19:38:01 80 请你找到高难度 SQL 试卷得分平均值大于 80 并且是 7 级的红名大佬，统计他们的 2021 年试卷总完成次数和题目总练习次数，只保留 2021 年有试卷完成记录的用户。结果按试卷完成数升序，按题目练习数降序。\n示例数据输出如下：\nuid exam_cnt question_cnt 1001 1 2 1003 2 0 解释：用户 1001、1003、1004、1006 满足高难度 SQL 试卷得分平均值大于 80，但只有 1001、1003 是 7 级红名大佬；1001 完成了 1 次试卷 1001，练习了 2 次题目；1003 完成了 2 次试卷 9001、9002，未练习题目（因此计数为 0）\n思路：\n先将条件进行初步筛选，比如先查出做过高难度 sql 试卷的用户\n1 2 3 4 5 6 7 8 9 SELECT record.uid FROM exam_record record INNER JOIN examination_info e_info ON record.exam_id = e_info.exam_id JOIN user_info u_info ON record.uid = u_info.uid WHERE e_info.tag = 'SQL' AND e_info.difficulty = 'hard' 然后根据题目要求，接着再往里叠条件即可；\n但是这里又要注意：\n第一：不能YEAR(submit_time)= 2021这个条件放到最后，要在ON条件里，因为左连接存在返回左表全部行，右表为 null 的情形，放在 JOIN条件的 ON 子句中的目的是为了确保在连接两个表时，只有满足年份条件的记录会进行连接。这样可以避免其他年份的记录被包含在结果中。即 1001 做过 2021 年的试卷，但没有练习过，如果把条件放到最后，就会排除掉这种情况。\n第二，必须是COUNT(distinct er.exam_id) exam_cnt, COUNT(distinct pr.id) question_cnt，要加 distinct，因为有左连接产生很多重复值。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 SELECT er.uid AS UID, count(DISTINCT er.exam_id) AS exam_cnt, count(DISTINCT pr.id) AS question_cnt FROM exam_record er LEFT JOIN practice_record pr ON er.uid = pr.uid AND YEAR (er.submit_time)= 2021 AND YEAR (pr.submit_time)= 2021 WHERE er.uid IN (SELECT er.uid FROM exam_record er LEFT JOIN examination_info ei ON er.exam_id = ei.exam_id LEFT JOIN user_info ui ON er.uid = ui.uid WHERE tag = 'SQL' AND difficulty = 'hard' AND LEVEL = 7 GROUP BY er.uid HAVING avg(score) \u003e 80) GROUP BY er.uid ORDER BY exam_cnt, question_cnt DESC 可能细心的小伙伴会发现，为什么明明将条件限制了tag = 'SQL' AND difficulty = 'hard'，但是用户 1003 仍然能查出两条考试记录，其中一条的考试tag为 C++; 这是由于LEFT JOIN的特性，即使没有与右表匹配的行，左表的所有记录仍然会被保留。\n每个 6/7 级用户活跃情况（困难） 描述：\n现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 号 3100 7 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 2300 7 算法 2020-01-01 10:00:00 3 1003 牛客 3 号 2500 7 算法 2020-01-01 10:00:00 4 1004 牛客 4 号 1200 5 算法 2020-01-01 10:00:00 5 1005 牛客 5 号 1600 6 C++ 2020-01-01 10:00:00 6 1006 牛客 6 号 2600 7 C++ 2020-01-01 10:00:00 试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2021-09-01 06:00:00 2 9002 C++ easy 60 2021-09-01 06:00:00 3 9003 算法 medium 80 2021-09-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nuid exam_id start_time submit_time score 1001 9001 2021-09-01 09:01:01 2021-09-01 09:31:00 78 1001 9001 2021-09-01 09:01:01 2021-09-01 09:31:00 81 1005 9001 2021-09-01 19:01:01 2021-09-01 19:30:01 85 1005 9002 2021-09-01 12:01:01 2021-09-01 12:31:02 85 1006 9003 2021-09-07 10:01:01 2021-09-07 10:21:59 84 1006 9001 2021-09-07 10:01:01 2021-09-07 10:21:01 81 1002 9001 2020-09-01 13:01:01 2020-09-01 13:41:01 81 1005 9001 2021-09-01 14:01:01 (NULL) (NULL) 题目练习记录表 practice_record（uid 用户 ID, question_id 题目 ID, submit_time 提交时间, score 得分）：\nuid question_id submit_time score 1001 8001 2021-08-02 11:41:01 60 1004 8001 2021-08-02 19:38:01 70 1004 8002 2021-08-02 19:48:01 90 1001 8002 2021-08-02 19:38:01 70 1004 8002 2021-08-02 19:48:01 90 1006 8002 2021-08-04 19:58:01 94 1006 8003 2021-08-03 19:38:01 70 1006 8003 2021-08-02 19:48:01 90 1006 8003 2020-08-01 19:38:01 80 请统计每个 6/7 级用户总活跃月份数、2021 年活跃天数、2021 年试卷作答活跃天数、2021 年答题活跃天数，按照总活跃月份数、2021 年活跃天数降序排序。由示例数据结果输出如下：\nuid act_month_total act_days_2021 act_days_2021_exam 1006 3 4 1 1001 2 2 1 1005 1 1 1 1002 1 0 0 1003 0 0 0 解释：6/7 级用户共有 5 个，其中 1006 在 202109、202108、202008 共 3 个月活跃过，2021 年活跃的日期有 20210907、20210804、20210803、20210802 共 4 天，2021 年在试卷作答区 20210907 活跃 1 天，在题目练习区活跃了 3 天。\n思路：\n这题的关键在于CASE WHEN THEN的使用，不然要写很多的left join 因为会产生很多的结果集。\nCASE WHEN THEN语句是一种条件表达式，用于在 SQL 中根据条件执行不同的操作或返回不同的结果。\n语法结构如下：\n1 2 3 4 5 6 CASE WHEN condition1 THEN result1 WHEN condition2 THEN result2 ... ELSE result END 在这个结构中，可以根据需要添加多个WHEN子句，每个WHEN子句后面跟着一个条件（condition）和一个结果（result）。条件可以是任何逻辑表达式，如果满足条件，将返回对应的结果。\n最后的ELSE子句是可选的，用于指定当所有前面的条件都不满足时的默认返回结果。如果没有提供ELSE子句，则默认返回NULL。\n例如：\n1 2 3 4 5 6 7 8 SELECT score, CASE WHEN score \u003e= 90 THEN '优秀' WHEN score \u003e= 80 THEN '良好' WHEN score \u003e= 60 THEN '及格' ELSE '不及格' END AS grade FROM student_scores; 在上述示例中，根据学生成绩（score）的不同范围，使用 CASE WHEN THEN 语句返回相应的等级（grade）。如果成绩大于等于 90，则返回\"优秀\"；如果成绩大于等于 80，则返回\"良好\"；如果成绩大于等于 60，则返回\"及格\"；否则返回\"不及格\"。\n那了解到了上述的用法之后，回过头看看该题，要求列出不同的活跃天数。\n1 2 3 4 count(distinct act_month) as act_month_total, count(distinct case when year(act_time)='2021'then act_day end) as act_days_2021, count(distinct case when year(act_time)='2021' and tag='exam' then act_day end) as act_days_2021_exam, count(distinct case when year(act_time)='2021' and tag='question'then act_day end) as act_days_2021_question 这里的 tag 是先给标记，方便对查询进行区分，将考试和答题分开。\n找出试卷作答区的用户\n1 2 3 4 5 6 7 8 9 SELECT uid, exam_id AS ans_id, start_time AS act_time, date_format( start_time, '%Y%m' ) AS act_month, date_format( start_time, '%Y%m%d' ) AS act_day, 'exam' AS tag FROM exam_record 紧接着就是答题作答区的用户\n1 2 3 4 5 6 7 8 9 SELECT uid, question_id AS ans_id, submit_time AS act_time, date_format( submit_time, '%Y%m' ) AS act_month, date_format( submit_time, '%Y%m%d' ) AS act_day, 'question' AS tag FROM practice_record 最后将两个结果进行UNION 最后别忘了将结果进行排序 （这题有点类似于分治法的思想）\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 SELECT user_info.uid, count(DISTINCT act_month) AS act_month_total, count(DISTINCT CASE WHEN YEAR (act_time)= '2021' THEN act_day END) AS act_days_2021, count(DISTINCT CASE WHEN YEAR (act_time)= '2021' AND tag = 'exam' THEN act_day END) AS act_days_2021_exam, count(DISTINCT CASE WHEN YEAR (act_time)= '2021' AND tag = 'question' THEN act_day END) AS act_days_2021_question FROM (SELECT UID, exam_id AS ans_id, start_time AS act_time, date_format(start_time, '%Y%m') AS act_month, date_format(start_time, '%Y%m%d') AS act_day, 'exam' AS tag FROM exam_record UNION ALL SELECT UID, question_id AS ans_id, submit_time AS act_time, date_format(submit_time, '%Y%m') AS act_month, date_format(submit_time, '%Y%m%d') AS act_day, 'question' AS tag FROM practice_record) total RIGHT JOIN user_info ON total.uid = user_info.uid WHERE user_info.LEVEL IN (6, 7) GROUP BY user_info.uid ORDER BY act_month_total DESC, act_days_2021 DESC SQL面试题4 专用窗口函数 MySQL 8.0 版本引入了窗口函数的支持，下面是 MySQL 中常见的窗口函数及其用法：\nROW_NUMBER(): 为查询结果集中的每一行分配一个唯一的整数值。 1 2 SELECT col1, col2, ROW_NUMBER() OVER (ORDER BY col1) AS row_num FROM table; RANK(): 计算每一行在排序结果中的排名。 1 2 SELECT col1, col2, RANK() OVER (ORDER BY col1 DESC) AS ranking FROM table; DENSE_RANK(): 计算每一行在排序结果中的排名，保留相同的排名。 1 2 SELECT col1, col2, DENSE_RANK() OVER (ORDER BY col1 DESC) AS ranking FROM table; NTILE(n): 将结果分成 n 个基本均匀的桶，并为每个桶分配一个标识号。 1 2 SELECT col1, col2, NTILE(4) OVER (ORDER BY col1) AS bucket FROM table; SUM(), AVG(),COUNT(), MIN(), MAX(): 这些聚合函数也可以与窗口函数结合使用，计算窗口内指定列的汇总、平均值、计数、最小值和最大值。 1 2 SELECT col1, col2, SUM(col1) OVER () AS sum_col FROM table; LEAD() 和 LAG(): LEAD 函数用于获取当前行之后的某个偏移量的行的值，而 LAG 函数用于获取当前行之前的某个偏移量的行的值。 1 2 3 SELECT col1, col2, LEAD(col1, 1) OVER (ORDER BY col1) AS next_col1, LAG(col1, 1) OVER (ORDER BY col1) AS prev_col1 FROM table; FIRST_VALUE() 和 LAST_VALUE(): FIRST_VALUE 函数用于获取窗口内指定列的第一个值，LAST_VALUE 函数用于获取窗口内指定列的最后一个值。 1 2 3 SELECT col1, col2, FIRST_VALUE(col2) OVER (PARTITION BY col1 ORDER BY col2) AS first_val, LAST_VALUE(col2) OVER (PARTITION BY col1 ORDER BY col2) AS last_val FROM table; 窗口函数通常需要配合 OVER 子句一起使用，用于定义窗口的大小、排序规则和分组方式。\n每类试卷得分前三名 描述：\n现有试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2021-09-01 06:00:00 2 9002 SQL hard 60 2021-09-01 06:00:00 3 9003 算法 medium 80 2021-09-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2021-09-01 09:01:01 2021-09-01 09:31:00 78 2 1002 9001 2021-09-01 09:01:01 2021-09-01 09:31:00 81 3 1002 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 81 4 1003 9001 2021-09-01 19:01:01 2021-09-01 19:40:01 86 5 1003 9002 2021-09-01 12:01:01 2021-09-01 12:31:51 89 6 1004 9001 2021-09-01 19:01:01 2021-09-01 19:30:01 85 7 1005 9003 2021-09-01 12:01:01 2021-09-01 12:31:02 85 8 1006 9003 2021-09-07 10:01:01 2021-09-07 10:21:01 84 9 1003 9003 2021-09-08 12:01:01 2021-09-08 12:11:01 40 10 1003 9002 2021-09-01 14:01:01 (NULL) (NULL) 找到每类试卷得分的前 3 名，如果两人最大分数相同，选择最小分数大者，如果还相同，选择 uid 大者。由示例数据结果输出如下：\ntid uid ranking SQL 1003 1 SQL 1004 2 SQL 1002 3 算法 1005 1 算法 1006 2 算法 1003 3 解释：有作答得分记录的试卷 tag 有 SQL 和算法，SQL 试卷用户 1001、1002、1003、1004 有作答得分，最高得分分别为 81、81、89、85，最低得分分别为 78、81、86、40，因此先按最高得分排名再按最低得分排名取前三为 1003、1004、1002。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 SELECT tag, UID, ranking FROM (SELECT b.tag AS tag, a.uid AS UID, ROW_NUMBER() OVER (PARTITION BY b.tag ORDER BY b.tag, max(a.score) DESC, min(a.score) DESC, a.uid DESC) AS ranking FROM exam_record a LEFT JOIN examination_info b ON a.exam_id = b.exam_id GROUP BY b.tag, a.uid) t WHERE ranking \u003c= 3 第二快/慢用时之差大于试卷时长一半的试卷（较难） 描述：\n现有试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2021-09-01 06:00:00 2 9002 C++ hard 60 2021-09-01 06:00:00 3 9003 算法 medium 80 2021-09-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2021-09-01 09:01:01 2021-09-01 09:51:01 78 2 1001 9002 2021-09-01 09:01:01 2021-09-01 09:31:00 81 3 1002 9002 2021-09-01 12:01:01 2021-09-01 12:31:01 81 4 1003 9001 2021-09-01 19:01:01 2021-09-01 19:59:01 86 5 1003 9002 2021-09-01 12:01:01 2021-09-01 12:31:51 89 6 1004 9002 2021-09-01 19:01:01 2021-09-01 19:30:01 85 7 1005 9001 2021-09-01 12:01:01 2021-09-01 12:31:02 85 8 1006 9001 2021-09-07 10:01:01 2021-09-07 10:21:01 84 9 1003 9001 2021-09-08 12:01:01 2021-09-08 12:11:01 40 10 1003 9002 2021-09-01 14:01:01 (NULL) (NULL) 11 1005 9001 2021-09-01 14:01:01 (NULL) (NULL) 12 1003 9003 2021-09-08 15:01:01 (NULL) (NULL) 找到第二快和第二慢用时之差大于试卷时长的一半的试卷信息，按试卷 ID 降序排序。由示例数据结果输出如下：\nexam_id duration release_time 9001 60 2021-09-01 06:00:00 解释：试卷 9001 被作答用时有 50 分钟、50 分钟、30 分 1 秒、11 分钟、10 分钟，第二快和第二慢用时之差为 50 分钟-11 分钟=39 分钟，试卷时长为 60 分钟，因此满足大于试卷时长一半的条件，输出试卷 ID、时长、发布时间。\n思路：\n第一步，找到每张试卷完成时间的顺序排名和倒序排名 也就是表 a；\n第二步，与通过试卷信息表 b 建立内连接，并根据试卷 id 分组，利用having筛选排名为第二个数据，将秒转化为分钟并进行比较，最后再根据试卷 id 倒序排序就行\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 SELECT a.exam_id, b.duration, b.release_time FROM (SELECT exam_id, row_number() OVER (PARTITION BY exam_id ORDER BY timestampdiff(SECOND, start_time, submit_time) DESC) rn1, row_number() OVER (PARTITION BY exam_id ORDER BY timestampdiff(SECOND, start_time, submit_time) ASC) rn2, timestampdiff(SECOND, start_time, submit_time) timex FROM exam_record WHERE score IS NOT NULL ) a INNER JOIN examination_info b ON a.exam_id = b.exam_id GROUP BY a.exam_id HAVING (max(IF (rn1 = 2, a.timex, 0))- max(IF (rn2 = 2, a.timex, 0)))/ 60 \u003e b.duration / 2 ORDER BY a.exam_id DESC 连续两次作答试卷的最大时间窗（较难） 描述\n现有试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1006 9003 2021-09-07 10:01:01 2021-09-07 10:21:02 84 2 1006 9001 2021-09-01 12:11:01 2021-09-01 12:31:01 89 3 1006 9002 2021-09-06 10:01:01 2021-09-06 10:21:01 81 4 1005 9002 2021-09-05 10:01:01 2021-09-05 10:21:01 81 5 1005 9001 2021-09-05 10:31:01 2021-09-05 10:51:01 81 请计算在 2021 年至少有两天作答过试卷的人中，计算该年连续两次作答试卷的最大时间窗 days_window，那么根据该年的历史规律他在 days_window 天里平均会做多少套试卷，按最大时间窗和平均做答试卷套数倒序排序。由示例数据结果输出如下：\nuid days_window avg_exam_cnt 1006 6 2.57 解释：用户 1006 分别在 20210901、20210906、20210907 作答过 3 次试卷，连续两次作答最大时间窗为 6 天（1 号到 6 号），他 1 号到 7 号这 7 天里共做了 3 张试卷，平均每天 3/7=0.428571 张，那么 6 天里平均会做 0.428571*6=2.57 张试卷（保留两位小数）；用户 1005 在 20210905 做了两张试卷，但是只有一天的作答记录，过滤掉。\n思路：\n上面这个解释中提示要对作答记录去重，千万别被骗了，不要去重！去重就通不过测试用例。注意限制时间是 2021 年；\n而且要注意时间差要+1 天；还要注意==没交卷也算在内==！！！！ （反正感觉这题描述不清，出的不是很好）\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 SELECT UID, max(datediff(next_time, start_time)) + 1 AS days_window, round(count(start_time)/(datediff(max(start_time), min(start_time))+ 1) * (max(datediff(next_time, start_time))+ 1), 2) AS avg_exam_cnt FROM (SELECT UID, start_time, lead(start_time, 1) OVER (PARTITION BY UID ORDER BY start_time) AS next_time FROM exam_record WHERE YEAR (start_time) = '2021' ) a GROUP BY UID HAVING count(DISTINCT date(start_time)) \u003e 1 ORDER BY days_window DESC, avg_exam_cnt DESC 近三个月未完成为 0 的用户完成情况 描述：\n现有试卷作答记录表 exam_record（uid:用户 ID, exam_id:试卷 ID, start_time:开始作答时间, submit_time:交卷时间，为空的话则代表未完成, score:得分）：\nid uid exam_id start_time submit_time score 1 1006 9003 2021-09-06 10:01:01 2021-09-06 10:21:02 84 2 1006 9001 2021-08-02 12:11:01 2021-08-02 12:31:01 89 3 1006 9002 2021-06-06 10:01:01 2021-06-06 10:21:01 81 4 1006 9002 2021-05-06 10:01:01 2021-05-06 10:21:01 81 5 1006 9001 2021-05-01 12:01:01 (NULL) (NULL) 6 1001 9001 2021-09-05 10:31:01 2021-09-05 10:51:01 81 7 1001 9003 2021-08-01 09:01:01 2021-08-01 09:51:11 78 8 1001 9002 2021-07-01 09:01:01 2021-07-01 09:31:00 81 9 1001 9002 2021-07-01 12:01:01 2021-07-01 12:31:01 81 10 1001 9002 2021-07-01 12:01:01 (NULL) (NULL) 找到每个人近三个有试卷作答记录的月份中没有试卷是未完成状态的用户的试卷作答完成数，按试卷完成数和用户 ID 降序排名。由示例数据结果输出如下：\nuid exam_complete_cnt 1006 3 解释：用户 1006 近三个有作答试卷的月份为 202109、202108、202106，作答试卷数为 3，全部完成；用户 1001 近三个有作答试卷的月份为 202109、202108、202107，作答试卷数为 5，完成试卷数为 4，因为有未完成试卷，故过滤掉。\n思路:\n找到每个人近三个有试卷作答记录的月份中没有试卷是未完成状态的用户的试卷作答完成数首先看这句话，肯定要先根据人进行分组 最近三个月，可以采用连续重复排名，倒序排列，排名\u003c=3 统计作答数 拼装剩余条件 排序 答案：\n1 2 3 4 5 6 7 8 9 10 11 SELECT UID, count(score) exam_complete_cnt FROM (SELECT *, DENSE_RANK() OVER (PARTITION BY UID ORDER BY date_format(start_time, '%Y%m') DESC) dr FROM exam_record) t1 WHERE dr \u003c= 3 GROUP BY UID HAVING count(dr)= count(score) ORDER BY exam_complete_cnt DESC, UID DESC 未完成率较高的 50%用户近三个月答卷情况（困难） 描述：\n现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 号 3200 7 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 2500 6 算法 2020-01-01 10:00:00 3 1003 牛客 3 号 ♂ 2200 5 算法 2020-01-01 10:00:00 试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2020-01-01 10:00:00 2 9002 SQL hard 80 2020-01-01 10:00:00 3 9003 算法 hard 80 2020-01-01 10:00:00 4 9004 PYTHON medium 70 2020-01-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-01 09:01:01 2020-01-01 09:21:59 90 15 1002 9001 2020-01-01 18:01:01 2020-01-01 18:59:02 90 13 1001 9001 2020-01-02 10:01:01 2020-01-02 10:31:01 89 2 1002 9001 2020-01-20 10:01:01 3 1002 9001 2020-02-01 12:11:01 5 1001 9001 2020-03-01 12:01:01 6 1002 9001 2020-03-01 12:01:01 2020-03-01 12:41:01 90 4 1003 9001 2020-03-01 19:01:01 7 1002 9001 2020-05-02 19:01:01 2020-05-02 19:32:00 90 14 1001 9002 2020-01-01 12:11:01 8 1001 9002 2020-01-02 19:01:01 2020-01-02 19:59:01 69 9 1001 9002 2020-02-02 12:01:01 2020-02-02 12:20:01 99 10 1002 9002 2020-02-02 12:01:01 11 1002 9002 2020-02-02 12:01:01 2020-02-02 12:43:01 81 12 1002 9002 2020-03-02 12:11:01 17 1001 9002 2020-05-05 18:01:01 16 1002 9003 2020-05-06 12:01:01 请统计 SQL 试卷上未完成率较高的 50%用户中，6 级和 7 级用户在有试卷作答记录的近三个月中，每个月的答卷数目和完成数目。按用户 ID、月份升序排序。\n由示例数据结果输出如下：\nuid start_month total_cnt complete_cnt 1002 202002 3 1 1002 202003 2 1 1002 202005 2 1 解释：各个用户对 SQL 试卷的未完成数、作答总数、未完成率如下：\nuid incomplete_cnt total_cnt incomplete_rate 1001 3 7 0.4286 1002 4 8 0.5000 1003 1 1 1.0000 1001、1002、1003 分别排在 1.0、0.5、0.0 的位置，因此较高的 50%用户（排位\u003c=0.5）为 1002、1003；\n1003 不是 6 级或 7 级；\n有试卷作答记录的近三个月为 202005、202003、202002；\n这三个月里 1002 的作答题数分别为 3、2、2，完成数目分别为 1、1、1。\n思路：\n注意点：这题注意求的是所有的答题次数和完成次数，而 sql 类别的试卷是限制未完成率排名，6, 7 级用户限制的是做题记录。\n先求出未完成率的排名\n1 2 3 4 5 6 7 8 9 10 SELECT UID, count(submit_time IS NULL OR NULL)/ count(start_time) AS num, PERCENT_RANK() OVER ( ORDER BY count(submit_time IS NULL OR NULL)/ count(start_time)) AS ranking FROM exam_record LEFT JOIN examination_info USING (exam_id) WHERE tag = 'SQL' GROUP BY UID 再求出最近三个月的练习记录\n1 2 3 4 5 6 7 8 9 SELECT UID, date_format(start_time, '%Y%m') AS month_d, submit_time, exam_id, dense_rank() OVER (PARTITION BY UID ORDER BY date_format(start_time, '%Y%m') DESC) AS ranking FROM exam_record LEFT JOIN user_info USING (UID) WHERE LEVEL IN (6,7) 答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 SELECT t1.uid, t1.month_d, count(*) AS total_cnt, count(t1.submit_time) AS complete_cnt FROM-- 先求出未完成率的排名 (SELECT UID, count(submit_time IS NULL OR NULL)/ count(start_time) AS num, PERCENT_RANK() OVER ( ORDER BY count(submit_time IS NULL OR NULL)/ count(start_time)) AS ranking FROM exam_record LEFT JOIN examination_info USING (exam_id) WHERE tag = 'SQL' GROUP BY UID) t INNER JOIN (-- 再求出近三个月的练习记录 SELECT UID, date_format(start_time, '%Y%m') AS month_d, submit_time, exam_id, dense_rank() OVER (PARTITION BY UID ORDER BY date_format(start_time, '%Y%m') DESC) AS ranking FROM exam_record LEFT JOIN user_info USING (UID) WHERE LEVEL IN (6,7) ) t1 USING (UID) WHERE t1.ranking \u003c= 3 AND t.ranking \u003e= 0.5 -- 使用限制找到符合条件的记录 GROUP BY t1.uid, t1.month_d ORDER BY t1.uid, t1.month_d 试卷完成数同比 2020 年的增长率及排名变化（困难） 描述：\n现有试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2021-01-01 10:00:00 2 9002 C++ hard 80 2021-01-01 10:00:00 3 9003 算法 hard 80 2021-01-01 10:00:00 4 9004 PYTHON medium 70 2021-01-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-08-02 10:01:01 2020-08-02 10:31:01 89 2 1002 9001 2020-04-01 18:01:01 2020-04-01 18:59:02 90 3 1001 9001 2020-04-01 09:01:01 2020-04-01 09:21:59 80 5 1002 9001 2021-03-02 19:01:01 2021-03-02 19:32:00 20 8 1003 9001 2021-05-02 12:01:01 2021-05-02 12:31:01 98 13 1003 9001 2020-01-02 10:01:01 2020-01-02 10:31:01 89 9 1001 9002 2020-02-02 12:01:01 2020-02-02 12:20:01 99 10 1002 9002 2021-02-02 12:01:01 2020-02-02 12:43:01 81 11 1001 9002 2020-01-02 19:01:01 2020-01-02 19:59:01 69 16 1002 9002 2020-02-02 12:01:01 17 1002 9002 2020-03-02 12:11:01 18 1001 9002 2021-05-05 18:01:01 4 1002 9003 2021-01-20 10:01:01 2021-01-20 10:10:01 81 6 1001 9003 2021-04-02 19:01:01 2021-04-02 19:40:01 89 15 1002 9003 2021-01-01 18:01:01 2021-01-01 18:59:02 90 7 1004 9004 2020-05-02 12:01:01 2020-05-02 12:20:01 99 12 1001 9004 2021-09-02 12:11:01 14 1002 9004 2020-01-01 12:11:01 2020-01-01 12:31:01 83 请计算 2021 年上半年各类试卷的做完次数相比 2020 年上半年同期的增长率（百分比格式，保留 1 位小数），以及做完次数排名变化，按增长率和 21 年排名降序输出。\n由示例数据结果输出如下：\ntag exam_cnt_20 exam_cnt_21 growth_rate exam_cnt_rank_20 exam_cnt_rank_21 rank_delta SQL 3 2 -33.3% 1 2 1 解释：2020 年上半年有 3 个 tag 有作答完成的记录，分别是 C++、SQL、PYTHON，它们被做完的次数分别是 3、3、2，做完次数排名为 1、1（并列）、3；\n2021 年上半年有 2 个 tag 有作答完成的记录，分别是算法、SQL，它们被做完的次数分别是 3、2，做完次数排名为 1、2；具体如下：\ntag start_year exam_cnt exam_cnt_rank C++ 2020 3 1 SQL 2020 3 1 PYTHON 2020 2 3 算法 2021 3 1 SQL 2021 2 2 因此能输出同比结果的 tag 只有 SQL，从 2020 到 2021 年，做完次数 3=\u003e2，减少 33.3%（保留 1 位小数）；排名 1=\u003e2，后退 1 名。\n思路：\n本题难点在于长整型的数据类型要求不能有负号产生，用 cast 函数转换数据类型为 signed。\n以及用到的增长率计算公式：(exam_cnt_21-exam_cnt_20)/exam_cnt_20\n做完次数排名变化（2021 年和 2020 年比排名升了或者降了多少）\n计算公式：exam_cnt_rank_21 - exam_cnt_rank_20\n在 MySQL 中，CAST() 函数用于将一个表达式的数据类型转换为另一个数据类型。它的基本语法如下：\n1 2 3 4 CAST(expression AS data_type) -- 将一个字符串转换成整数 SELECT CAST('123' AS INT); 示例就不一一举例了，这个函数很简单\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 SELECT tag, exam_cnt_20, exam_cnt_21, concat( round( 100 * (exam_cnt_21 - exam_cnt_20) / exam_cnt_20, 1 ), '%' ) AS growth_rate, exam_cnt_rank_20, exam_cnt_rank_21, cast(exam_cnt_rank_21 AS signed) - cast(exam_cnt_rank_20 AS signed) AS rank_delta FROM ( #2020年、2021年上半年各类试卷的做完次数和做完次数排名 SELECT tag, count( IF ( date_format(start_time, '%Y%m%d') BETWEEN '20200101' AND '20200630', start_time, NULL ) ) AS exam_cnt_20, count( IF ( substring(start_time, 1, 10) BETWEEN '2021-01-01' AND '2021-06-30', start_time, NULL ) ) AS exam_cnt_21, rank() over ( ORDER BY count( IF ( date_format(start_time, '%Y%m%d') BETWEEN '20200101' AND '20200630', start_time, NULL ) ) DESC ) AS exam_cnt_rank_20, rank() over ( ORDER BY count( IF ( substring(start_time, 1, 10) BETWEEN '2021-01-01' AND '2021-06-30', start_time, NULL ) ) DESC ) AS exam_cnt_rank_21 FROM examination_info JOIN exam_record USING (exam_id) WHERE submit_time IS NOT NULL GROUP BY tag ) main WHERE exam_cnt_21 * exam_cnt_20 \u003c\u003e 0 ORDER BY growth_rate DESC, exam_cnt_rank_21 DESC 聚合窗口函数 对试卷得分做 min-max 归一化 描述：\n现有试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2020-01-01 10:00:00 2 9002 C++ hard 80 2020-01-01 10:00:00 3 9003 算法 hard 80 2020-01-01 10:00:00 4 9004 PYTHON medium 70 2020-01-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 6 1003 9001 2020-01-02 12:01:01 2020-01-02 12:31:01 68 9 1001 9001 2020-01-02 10:01:01 2020-01-02 10:31:01 89 1 1001 9001 2020-01-01 09:01:01 2020-01-01 09:21:59 90 12 1002 9002 2021-05-05 18:01:01 (NULL) (NULL) 3 1004 9002 2020-01-01 12:01:01 2020-01-01 12:11:01 60 2 1003 9002 2020-01-01 19:01:01 2020-01-01 19:30:01 75 7 1001 9002 2020-01-02 12:01:01 2020-01-02 12:43:01 81 10 1002 9002 2020-01-01 12:11:01 2020-01-01 12:31:01 83 4 1003 9002 2020-01-01 12:01:01 2020-01-01 12:41:01 90 5 1002 9002 2020-01-02 19:01:01 2020-01-02 19:32:00 90 11 1002 9004 2021-09-06 12:01:01 (NULL) (NULL) 8 1001 9005 2020-01-02 12:11:01 (NULL) (NULL) 在物理学及统计学数据计算时，有个概念叫 min-max 标准化，也被称为离差标准化，是对原始数据的线性变换，使结果值映射到[0 - 1]之间。\n转换函数为：\n1 2 3 Xi - min(xi) ----------------- max(xi) - min(xi) 请你将用户作答高难度试卷的得分在每份试卷作答记录内执行 min-max 归一化后缩放到[0,100]区间，并输出用户 ID、试卷 ID、归一化后分数平均值；最后按照试卷 ID 升序、归一化分数降序输出。（注：得分区间默认为[0,100]，如果某个试卷作答记录中只有一个得分，那么无需使用公式，归一化并缩放后分数仍为原分数）。\n由示例数据结果输出如下：\nuid exam_id avg_new_score 1001 9001 98 1003 9001 0 1002 9002 88 1003 9002 75 1001 9002 70 1004 9002 0 解释：高难度试卷有 9001、9002、9003；\n作答了 9001 的记录有 3 条，分数分别为 68、89、90，按给定公式归一化后分数为：0、95、100，而后两个得分都是用户 1001 作答的，因此用户 1001 对试卷 9001 的新得分为(95+100)/2≈98（只保留整数部分），用户 1003 对于试卷 9001 的新得分为 0。最后结果按照试卷 ID 升序、归一化分数降序输出。\n思路：\n注意点：\n将高难度的试卷，按每类试卷的得分，利用 max/min (col) over()窗口函数求得各组内最大最小值，然后进行归一化公式计算，缩放区间为[0,100]，即 min_max*100 若某类试卷只有一个得分，则无需使用归一化公式，因只有一个分 max_score=min_score,score，公式后结果可能会变成 0。 最后结果按 uid、exam_id 分组求归一化后均值，score 为 NULL 的要过滤掉。 最后就是仔细看上面公式 （说实话，这题看起来就很绕）\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 SELECT uid, exam_id, round(sum(min_max) / count(score), 0) AS avg_new_score FROM ( SELECT *, IF ( max_score = min_score, score, (score - min_score) / (max_score - min_score) * 100 ) AS min_max FROM ( SELECT uid, a.exam_id, score, max(score) over (PARTITION BY a.exam_id) AS max_score, min(score) over (PARTITION BY a.exam_id) AS min_score FROM exam_record a LEFT JOIN examination_info b USING (exam_id) WHERE difficulty = 'hard' ) t WHERE score IS NOT NULL ) t1 GROUP BY uid, exam_id ORDER BY exam_id ASC, avg_new_score DESC; 每份试卷每月作答数和截止当月的作答总数 描述:\n现有试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-01 09:01:01 2020-01-01 09:21:59 90 2 1002 9001 2020-01-20 10:01:01 2020-01-20 10:10:01 89 3 1002 9001 2020-02-01 12:11:01 2020-02-01 12:31:01 83 4 1003 9001 2020-03-01 19:01:01 2020-03-01 19:30:01 75 5 1004 9001 2020-03-01 12:01:01 2020-03-01 12:11:01 60 6 1003 9001 2020-03-01 12:01:01 2020-03-01 12:41:01 90 7 1002 9001 2020-05-02 19:01:01 2020-05-02 19:32:00 90 8 1001 9002 2020-01-02 19:01:01 2020-01-02 19:59:01 69 9 1004 9002 2020-02-02 12:01:01 2020-02-02 12:20:01 99 10 1003 9002 2020-02-02 12:01:01 2020-02-02 12:31:01 68 11 1001 9002 2020-02-02 12:01:01 2020-02-02 12:43:01 81 12 1001 9002 2020-03-02 12:11:01 (NULL) (NULL) 请输出每份试卷每月作答数和截止当月的作答总数。 由示例数据结果输出如下：\nexam_id start_month month_cnt cum_exam_cnt 9001 202001 2 2 9001 202002 1 3 9001 202003 3 6 9001 202005 1 7 9002 202001 1 1 9002 202002 3 4 9002 202003 1 5 解释：试卷 9001 在 202001、202002、202003、202005 共 4 个月有被作答记录，每个月被作答数分别为 2、1、3、1，截止当月累积作答总数为 2、3、6、7。\n思路：\n这题就两个关键点：统计截止当月的作答总数、输出每份试卷每月作答数和截止当月的作答总数\n这个是关键**sum(count(*)) over(partition by exam_id order by date_format(start_time,'%Y%m'))**\n答案：\n1 2 3 4 5 6 7 8 SELECT exam_id, date_format(start_time, '%Y%m') AS start_month, count(*) AS month_cnt, sum(count(*)) OVER (PARTITION BY exam_id ORDER BY date_format(start_time, '%Y%m')) AS cum_exam_cnt FROM exam_record GROUP BY exam_id, start_month 每月及截止当月的答题情况（较难） 描述：现有试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-01 09:01:01 2020-01-01 09:21:59 90 2 1002 9001 2020-01-20 10:01:01 2020-01-20 10:10:01 89 3 1002 9001 2020-02-01 12:11:01 2020-02-01 12:31:01 83 4 1003 9001 2020-03-01 19:01:01 2020-03-01 19:30:01 75 5 1004 9001 2020-03-01 12:01:01 2020-03-01 12:11:01 60 6 1003 9001 2020-03-01 12:01:01 2020-03-01 12:41:01 90 7 1002 9001 2020-05-02 19:01:01 2020-05-02 19:32:00 90 8 1001 9002 2020-01-02 19:01:01 2020-01-02 19:59:01 69 9 1004 9002 2020-02-02 12:01:01 2020-02-02 12:20:01 99 10 1003 9002 2020-02-02 12:01:01 2020-02-02 12:31:01 68 11 1001 9002 2020-01-02 19:01:01 2020-02-02 12:43:01 81 12 1001 9002 2020-03-02 12:11:01 (NULL) (NULL) 请输出自从有用户作答记录以来，每月的试卷作答记录中月活用户数、新增用户数、截止当月的单月最大新增用户数、截止当月的累积用户数。结果按月份升序输出。\n由示例数据结果输出如下：\nstart_month mau month_add_uv max_month_add_uv cum_sum_uv 202001 2 2 2 2 202002 4 2 2 4 202003 3 0 2 4 202005 1 0 2 4 month 1001 1002 1003 1004 202001 1 1 202002 1 1 1 1 202003 1 1 1 202005 1 由上述矩阵可以看出，2020 年 1 月有 2 个用户活跃（mau=2），当月新增用户数为 2；\n2020 年 2 月有 4 个用户活跃，当月新增用户数为 2，最大单月新增用户数为 2，当前累积用户数为 4。\n思路：\n难点：\n1.如何求每月新增用户\n2.截至当月的答题情况\n大致流程：\n（1）统计每个人的首次登陆月份 min()\n（2）统计每月的月活和新增用户数：先得到每个人的首次登陆月份，再对首次登陆月份分组求和是该月份的新增人数\n（3）统计截止当月的单月最大新增用户数、截止当月的累积用户数 ，最终按照按月份升序输出\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 -- 截止当月的单月最大新增用户数、截止当月的累积用户数，按月份升序输出 SELECT start_month, mau, month_add_uv, max( month_add_uv ) over ( ORDER BY start_month ), sum( month_add_uv ) over ( ORDER BY start_month ) FROM ( -- 统计每月的月活和新增用户数 SELECT date_format( a.start_time, '%Y%m' ) AS start_month, count( DISTINCT a.uid ) AS mau, count( DISTINCT b.uid ) AS month_add_uv FROM exam_record a LEFT JOIN ( -- 统计每个人的首次登陆月份 SELECT uid, min( date_format( start_time, '%Y%m' )) AS first_month FROM exam_record GROUP BY uid ) b ON date_format( a.start_time, '%Y%m' ) = b.first_month GROUP BY start_month ) main ORDER BY start_month SQL面试题5 空值处理 统计有未完成状态的试卷的未完成数和未完成率 描述：\n现有试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分），数据如下：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-02 09:01:01 2020-01-02 09:21:01 80 2 1001 9001 2021-05-02 10:01:01 2021-05-02 10:30:01 81 3 1001 9001 2021-09-02 12:01:01 (NULL) (NULL) 请统计有未完成状态的试卷的未完成数 incomplete_cnt 和未完成率 incomplete_rate。由示例数据结果输出如下：\nexam_id incomplete_cnt complete_rate 9001 1 0.333 解释：试卷 9001 有 3 次被作答的记录，其中两次完成，1 次未完成，因此未完成数为 1，未完成率为 0.333（保留 3 位小数）\n思路：\n这题只需要注意一个是有条件限制，一个是没条件限制的；要么分别查询条件，然后合并；要么直接在 select 里面进行条件判断。\n答案：\n写法 1：\n1 2 3 4 5 6 SELECT exam_id, count(submit_time IS NULL OR NULL) incomplete_cnt, ROUND(count(submit_time IS NULL OR NULL) / count(*), 3) complete_rate FROM exam_record GROUP BY exam_id HAVING incomplete_cnt \u003c\u003e 0 写法 2：\n1 2 3 4 5 6 SELECT exam_id, count(submit_time IS NULL OR NULL) incomplete_cnt, ROUND(count(submit_time IS NULL OR NULL) / count(*), 3) complete_rate FROM exam_record GROUP BY exam_id HAVING incomplete_cnt \u003c\u003e 0 两种写法都可以，只有中间的写法不一样，一个是对符合条件的才COUNT，一个是直接上IF,后者更为直观，最后这个having解释一下， 无论是 complete_rate 还是 incomplete_cnt，只要不为 0 即可，不为 0 就意味着有未完成的。\n0 级用户高难度试卷的平均用时和平均得分 描述：\n现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间），数据如下：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 号 10 0 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 2100 6 算法 2020-01-01 10:00:00 试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间），数据如下：\nid exam_id tag difficulty duration release_time 1 9001 SQL hard 60 2020-01-01 10:00:00 2 9002 SQL easy 60 2020-01-01 10:00:00 3 9004 算法 medium 80 2020-01-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分），数据如下：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-02 09:01:01 2020-01-02 09:21:59 80 2 1001 9001 2021-05-02 10:01:01 (NULL) (NULL) 3 1001 9002 2021-02-02 19:01:01 2021-02-02 19:30:01 87 4 1001 9001 2021-06-02 19:01:01 2021-06-02 19:32:00 20 5 1001 9002 2021-09-05 19:01:01 2021-09-05 19:40:01 89 6 1001 9002 2021-09-01 12:01:01 (NULL) (NULL) 7 1002 9002 2021-05-05 18:01:01 2021-05-05 18:59:02 90 请输出每个 0 级用户所有的高难度试卷考试平均用时和平均得分，未完成的默认试卷最大考试时长和 0 分处理。由示例数据结果输出如下：\nuid avg_score avg_time_took 1001 33 36.7 解释：0 级用户有 1001，高难度试卷有 9001，1001 作答 9001 的记录有 3 条，分别用时 20 分钟、未完成（试卷时长 60 分钟）、30 分钟（未满 31 分钟），分别得分为 80 分、未完成（0 分处理）、20 分。因此他的平均用时为 110/3=36.7（保留一位小数），平均得分为 33 分（取整）\n思路：这题用IF是判断的最方便的，因为涉及到 NULL 值的判断。当然 case when也可以，大同小异。这题的难点就在于空值的处理，其他的这些查询条件什么的，我相信难不倒大家。\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 SELECT UID, round(avg(new_socre)) AS avg_score, round(avg(time_diff), 1) AS avg_time_took FROM (SELECT er.uid, IF (er.submit_time IS NOT NULL, TIMESTAMPDIFF(MINUTE, start_time, submit_time), ef.duration) AS time_diff, IF (er.submit_time IS NOT NULL,er.score,0) AS new_socre FROM exam_record er LEFT JOIN user_info uf ON er.uid = uf.uid LEFT JOIN examination_info ef ON er.exam_id = ef.exam_id WHERE uf.LEVEL = 0 AND ef.difficulty = 'hard' ) t GROUP BY UID ORDER BY UID 高级条件语句 筛选限定昵称成就值活跃日期的用户（较难） 描述：\n现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 号 1000 2 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 1200 3 算法 2020-01-01 10:00:00 3 1003 进击的 3 号 2200 5 算法 2020-01-01 10:00:00 4 1004 牛客 4 号 2500 6 算法 2020-01-01 10:00:00 5 1005 牛客 5 号 3000 7 C++ 2020-01-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-02 09:01:01 2020-01-02 09:21:59 80 3 1001 9002 2021-02-02 19:01:01 2021-02-02 19:30:01 87 2 1001 9001 2021-05-02 10:01:01 (NULL) (NULL) 4 1001 9001 2021-06-02 19:01:01 2021-06-02 19:32:00 20 6 1001 9002 2021-09-01 12:01:01 (NULL) (NULL) 5 1001 9002 2021-09-05 19:01:01 2021-09-05 19:40:01 89 11 1002 9001 2020-01-01 12:01:01 2020-01-01 12:31:01 81 12 1002 9002 2020-02-01 12:01:01 2020-02-01 12:31:01 82 13 1002 9002 2020-02-02 12:11:01 2020-02-02 12:31:01 83 7 1002 9002 2021-05-05 18:01:01 2021-05-05 18:59:02 90 16 1002 9001 2021-09-06 12:01:01 2021-09-06 12:21:01 80 17 1002 9001 2021-09-06 12:01:01 (NULL) (NULL) 18 1002 9001 2021-09-07 12:01:01 (NULL) (NULL) 8 1003 9003 2021-02-06 12:01:01 (NULL) (NULL) 9 1003 9001 2021-09-07 10:01:01 2021-09-07 10:31:01 89 10 1004 9002 2021-08-06 12:01:01 (NULL) (NULL) 14 1005 9001 2021-02-01 11:01:01 2021-02-01 11:31:01 84 15 1006 9001 2021-02-01 11:01:01 2021-02-01 11:31:01 84 题目练习记录表 practice_record（uid 用户 ID, question_id 题目 ID, submit_time 提交时间, score 得分）：\nid uid question_id submit_time score 1 1001 8001 2021-08-02 11:41:01 60 2 1002 8001 2021-09-02 19:30:01 50 3 1002 8001 2021-09-02 19:20:01 70 4 1002 8002 2021-09-02 19:38:01 70 5 1003 8002 2021-09-01 19:38:01 80 请找到昵称以『牛客』开头『号』结尾、成就值在 1200~2500 之间，且最近一次活跃（答题或作答试卷）在 2021 年 9 月的用户信息。\n由示例数据结果输出如下：\nuid nick_name achievement 1002 牛客 2 号 1200 解释：昵称以『牛客』开头『号』结尾且成就值在 1200~2500 之间的有 1002、1004；\n1002 最近一次试卷区活跃为 2021 年 9 月，最近一次题目区活跃为 2021 年 9 月；1004 最近一次试卷区活跃为 2021 年 8 月，题目区未活跃。\n因此最终满足条件的只有 1002。\n思路：\n先根据条件列出主要查询语句\n昵称以『牛客』开头『号』结尾: nick_name LIKE \"牛客%号\"\n成就值在 1200~2500 之间：achievement BETWEEN 1200 AND 2500\n第三个条件因为限定了为 9 月，所以直接写就行：( date_format( record.submit_time, '%Y%m' )= 202109 OR date_format( pr.submit_time, '%Y%m' )= 202109 )\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 SELECT DISTINCT u_info.uid, u_info.nick_name, u_info.achievement FROM user_info u_info LEFT JOIN exam_record record ON record.uid = u_info.uid LEFT JOIN practice_record pr ON u_info.uid = pr.uid WHERE u_info.nick_name LIKE \"牛客%号\" AND u_info.achievement BETWEEN 1200 AND 2500 AND (date_format(record.submit_time, '%Y%m')= 202109 OR date_format(pr.submit_time, '%Y%m')= 202109) GROUP BY u_info.uid 筛选昵称规则和试卷规则的作答记录（较难） 描述：\n现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 号 1900 2 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 1200 3 算法 2020-01-01 10:00:00 3 1003 牛客 3 号 ♂ 2200 5 算法 2020-01-01 10:00:00 4 1004 牛客 4 号 2500 6 算法 2020-01-01 10:00:00 5 1005 牛客 555 号 2000 7 C++ 2020-01-01 10:00:00 6 1006 666666 3000 6 C++ 2020-01-01 10:00:00 试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 C++ hard 60 2020-01-01 10:00:00 2 9002 c# hard 80 2020-01-01 10:00:00 3 9003 SQL medium 70 2020-01-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-02 09:01:01 2020-01-02 09:21:59 80 2 1001 9001 2021-05-02 10:01:01 (NULL) (NULL) 4 1001 9001 2021-06-02 19:01:01 2021-06-02 19:32:00 20 3 1001 9002 2021-02-02 19:01:01 2021-02-02 19:30:01 87 5 1001 9002 2021-09-05 19:01:01 2021-09-05 19:40:01 89 6 1001 9002 2021-09-01 12:01:01 (NULL) (NULL) 11 1002 9001 2020-01-01 12:01:01 2020-01-01 12:31:01 81 16 1002 9001 2021-09-06 12:01:01 2021-09-06 12:21:01 80 17 1002 9001 2021-09-06 12:01:01 (NULL) (NULL) 18 1002 9001 2021-09-07 12:01:01 (NULL) (NULL) 7 1002 9002 2021-05-05 18:01:01 2021-05-05 18:59:02 90 12 1002 9002 2020-02-01 12:01:01 2020-02-01 12:31:01 82 13 1002 9002 2020-02-02 12:11:01 2020-02-02 12:31:01 83 9 1003 9001 2021-09-07 10:01:01 2021-09-07 10:31:01 89 8 1003 9003 2021-02-06 12:01:01 (NULL) (NULL) 10 1004 9002 2021-08-06 12:01:01 (NULL) (NULL) 14 1005 9001 2021-02-01 11:01:01 2021-02-01 11:31:01 84 15 1006 9001 2021-02-01 11:01:01 2021-09-01 11:31:01 84 找到昵称以\"牛客\"+纯数字+“号\"或者纯数字组成的用户对于字母 c 开头的试卷类别（如 C,C++,c#等）的已完成的试卷 ID 和平均得分，按用户 ID、平均分升序排序。由示例数据结果输出如下：\nuid exam_id avg_score 1002 9001 81 1002 9002 85 1005 9001 84 1006 9001 84 解释：昵称满足条件的用户有 1002、1004、1005、1006；\nc 开头的试卷有 9001、9002；\n满足上述条件的作答记录中，1002 完成 9001 的得分有 81、80，平均分为 81（80.5 取整四舍五入得 81）；\n1002 完成 9002 的得分有 90、82、83，平均分为 85；\n思路：\n还是老样子，既然给出了条件，就先把各个条件先写出来\n找到昵称以\"牛客”+纯数字+“号\"或者纯数字组成的用户： 我最开始是这么写的：nick_name LIKE '牛客%号' OR nick_name REGEXP '^[0-9]+$'，如果表中有个 “牛客 H 号” ，那也能通过。\n所以这里还得用正则： nick_name LIKE '^牛客[0-9]+号'\n对于字母 c 开头的试卷类别： e_info.tag LIKE 'c%' 或者 tag regexp '^c|^C' 第一个也能匹配到大写 C\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 SELECT UID, exam_id, ROUND(AVG(score), 0) avg_score FROM exam_record WHERE UID IN (SELECT UID FROM user_info WHERE nick_name RLIKE \"^牛客[0-9]+号 $\" OR nick_name RLIKE \"^[0-9]+$\") AND exam_id IN (SELECT exam_id FROM examination_info WHERE tag RLIKE \"^[cC]\") AND score IS NOT NULL GROUP BY UID,exam_id ORDER BY UID,avg_score; 根据指定记录是否存在输出不同情况（困难） 描述：\n现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 号 19 0 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 1200 3 算法 2020-01-01 10:00:00 3 1003 进击的 3 号 22 0 算法 2020-01-01 10:00:00 4 1004 牛客 4 号 25 0 算法 2020-01-01 10:00:00 5 1005 牛客 555 号 2000 7 C++ 2020-01-01 10:00:00 6 1006 666666 3000 6 C++ 2020-01-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-02 09:01:01 2020-01-02 09:21:59 80 2 1001 9001 2021-05-02 10:01:01 (NULL) (NULL) 3 1001 9002 2021-02-02 19:01:01 2021-02-02 19:30:01 87 4 1001 9002 2021-09-01 12:01:01 (NULL) (NULL) 5 1001 9003 2021-09-02 12:01:01 (NULL) (NULL) 6 1001 9004 2021-09-03 12:01:01 (NULL) (NULL) 7 1002 9001 2020-01-01 12:01:01 2020-01-01 12:31:01 99 8 1002 9003 2020-02-01 12:01:01 2020-02-01 12:31:01 82 9 1002 9003 2020-02-02 12:11:01 (NULL) (NULL) 10 1002 9002 2021-05-05 18:01:01 (NULL) (NULL) 11 1002 9001 2021-09-06 12:01:01 (NULL) (NULL) 12 1003 9003 2021-02-06 12:01:01 (NULL) (NULL) 13 1003 9001 2021-09-07 10:01:01 2021-09-07 10:31:01 89 请你筛选表中的数据，当有任意一个 0 级用户未完成试卷数大于 2 时，输出每个 0 级用户的试卷未完成数和未完成率（保留 3 位小数）；若不存在这样的用户，则输出所有有作答记录的用户的这两个指标。结果按未完成率升序排序。\n由示例数据结果输出如下：\nuid incomplete_cnt incomplete_rate 1004 0 0.000 1003 1 0.500 1001 4 0.667 解释：0 级用户有 1001、1003、1004；他们作答试卷数和未完成数分别为：6:4、2:1、0:0；\n存在 1001 这个 0 级用户未完成试卷数大于 2，因此输出这三个用户的未完成数和未完成率（1004 未作答过试卷，未完成率默认填 0，保留 3 位小数后是 0.000）；\n结果按照未完成率升序排序。\n附：如果 1001 不满足『未完成试卷数大于 2』，则需要输出 1001、1002、1003 的这两个指标，因为试卷作答记录表里只有这三个用户的作答记录。\n思路：\n先把可能满足条件**“0 级用户未完成试卷数大于 2”**的 SQL 写出来\n1 2 3 4 5 6 7 8 9 10 11 SELECT ui.uid UID FROM user_info ui LEFT JOIN exam_record er ON ui.uid = er.uid WHERE ui.uid IN (SELECT ui.uid FROM user_info ui LEFT JOIN exam_record er ON ui.uid = er.uid WHERE er.submit_time IS NULL AND ui.LEVEL = 0 ) GROUP BY ui.uid HAVING sum(IF(er.submit_time IS NULL, 1, 0)) \u003e 2 然后再分别写出两种情况的 SQL 查询语句：\n情况 1. 查询存在条件要求的 0 级用户的试卷未完成率\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 SELECT tmp1.uid uid, sum( IF ( er.submit_time IS NULL AND er.start_time IS NOT NULL, 1, 0 )) incomplete_cnt, round( sum( IF ( er.submit_time IS NULL AND er.start_time IS NOT NULL, 1, 0 ))/ count( tmp1.uid ), 3 ) incomplete_rate FROM ( SELECT DISTINCT ui.uid FROM user_info ui LEFT JOIN exam_record er ON ui.uid = er.uid WHERE er.submit_time IS NULL AND ui.LEVEL = 0 ) tmp1 LEFT JOIN exam_record er ON tmp1.uid = er.uid GROUP BY tmp1.uid ORDER BY incomplete_rate 情况 2. 查询不存在条件要求时所有有作答记录的 yong 用户的试卷未完成率\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 SELECT ui.uid uid, sum( CASE WHEN er.submit_time IS NULL AND er.start_time IS NOT NULL THEN 1 ELSE 0 END ) incomplete_cnt, round( sum( IF ( er.submit_time IS NULL AND er.start_time IS NOT NULL, 1, 0 ))/ count( ui.uid ), 3 ) incomplete_rate FROM user_info ui JOIN exam_record er ON ui.uid = er.uid GROUP BY ui.uid ORDER BY incomplete_rate 拼在一起，就是答案\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 WITH host_user AS (SELECT ui.uid UID FROM user_info ui LEFT JOIN exam_record er ON ui.uid = er.uid WHERE ui.uid IN (SELECT ui.uid FROM user_info ui LEFT JOIN exam_record er ON ui.uid = er.uid WHERE er.submit_time IS NULL AND ui.LEVEL = 0 ) GROUP BY ui.uid HAVING sum(IF (er.submit_time IS NULL, 1, 0))\u003e 2), tt1 AS (SELECT tmp1.uid UID, sum(IF (er.submit_time IS NULL AND er.start_time IS NOT NULL, 1, 0)) incomplete_cnt, round(sum(IF (er.submit_time IS NULL AND er.start_time IS NOT NULL, 1, 0))/ count(tmp1.uid), 3) incomplete_rate FROM (SELECT DISTINCT ui.uid FROM user_info ui LEFT JOIN exam_record er ON ui.uid = er.uid WHERE er.submit_time IS NULL AND ui.LEVEL = 0 ) tmp1 LEFT JOIN exam_record er ON tmp1.uid = er.uid GROUP BY tmp1.uid ORDER BY incomplete_rate), tt2 AS (SELECT ui.uid UID, sum(CASE WHEN er.submit_time IS NULL AND er.start_time IS NOT NULL THEN 1 ELSE 0 END) incomplete_cnt, round(sum(IF (er.submit_time IS NULL AND er.start_time IS NOT NULL, 1, 0))/ count(ui.uid), 3) incomplete_rate FROM user_info ui JOIN exam_record er ON ui.uid = er.uid GROUP BY ui.uid ORDER BY incomplete_rate) (SELECT tt1.* FROM tt1 LEFT JOIN (SELECT UID FROM host_user) t1 ON 1 = 1 WHERE t1.uid IS NOT NULL ) UNION ALL (SELECT tt2.* FROM tt2 LEFT JOIN (SELECT UID FROM host_user) t2 ON 1 = 1 WHERE t2.uid IS NULL) V2 版本（根据上面做出的改进，答案缩短了，逻辑更强）：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 SELECT ui.uid, SUM( IF ( start_time IS NOT NULL AND score IS NULL, 1, 0 )) AS incomplete_cnt,#3.试卷未完成数 ROUND( AVG( IF ( start_time IS NOT NULL AND score IS NULL, 1, 0 )), 3 ) AS incomplete_rate #4.未完成率 FROM user_info ui LEFT JOIN exam_record USING ( uid ) WHERE CASE WHEN (#1.当有任意一个0级用户未完成试卷数大于2时 SELECT MAX( lv0_incom_cnt ) FROM ( SELECT SUM( IF ( score IS NULL, 1, 0 )) AS lv0_incom_cnt FROM user_info JOIN exam_record USING ( uid ) WHERE LEVEL = 0 GROUP BY uid ) table1 )\u003e 2 THEN uid IN ( #1.1找出每个0级用户 SELECT uid FROM user_info WHERE LEVEL = 0 ) ELSE uid IN ( #2.若不存在这样的用户，找出有作答记录的用户 SELECT DISTINCT uid FROM exam_record ) END GROUP BY ui.uid ORDER BY incomplete_rate #5.结果按未完成率升序排序 各用户等级的不同得分表现占比（较难） 描述：\n现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 号 19 0 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 1200 3 算法 2020-01-01 10:00:00 3 1003 牛客 3 号 ♂ 22 0 算法 2020-01-01 10:00:00 4 1004 牛客 4 号 25 0 算法 2020-01-01 10:00:00 5 1005 牛客 555 号 2000 7 C++ 2020-01-01 10:00:00 6 1006 666666 3000 6 C++ 2020-01-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-02 09:01:01 2020-01-02 09:21:59 80 2 1001 9001 2021-05-02 10:01:01 (NULL) (NULL) 3 1001 9002 2021-02-02 19:01:01 2021-02-02 19:30:01 75 4 1001 9002 2021-09-01 12:01:01 2021-09-01 12:11:01 60 5 1001 9003 2021-09-02 12:01:01 2021-09-02 12:41:01 90 6 1001 9001 2021-06-02 19:01:01 2021-06-02 19:32:00 20 7 1001 9002 2021-09-05 19:01:01 2021-09-05 19:40:01 89 8 1001 9004 2021-09-03 12:01:01 (NULL) (NULL) 9 1002 9001 2020-01-01 12:01:01 2020-01-01 12:31:01 99 10 1002 9003 2020-02-01 12:01:01 2020-02-01 12:31:01 82 11 1002 9003 2020-02-02 12:11:01 2020-02-02 12:41:01 76 为了得到用户试卷作答的定性表现，我们将试卷得分按分界点[90,75,60]分为优良中差四个得分等级（分界点划分到左区间），请统计不同用户等级的人在完成过的试卷中各得分等级占比（结果保留 3 位小数），未完成过试卷的用户无需输出，结果按用户等级降序、占比降序排序。\n由示例数据结果输出如下：\nlevel score_grade ratio 3 良 0.667 3 优 0.333 0 良 0.500 0 中 0.167 0 优 0.167 0 差 0.167 解释：完成过试卷的用户有 1001、1002；完成了的试卷对应的用户等级和分数等级如下：\nuid exam_id score level score_grade 1001 9001 80 0 良 1001 9002 75 0 良 1001 9002 60 0 中 1001 9003 90 0 优 1001 9001 20 0 差 1001 9002 89 0 良 1002 9001 99 3 优 1002 9003 82 3 良 1002 9003 76 3 良 因此 0 级用户（只有 1001）的各分数等级比例为：优 1/6，良 1/6，中 1/6，差 3/6；3 级用户（只有 1002）各分数等级比例为：优 1/3，良 2/3。结果保留 3 位小数。\n思路：\n先把 **“将试卷得分按分界点[90,75,60]分为优良中差四个得分等级”**这个条件写出来，这里可以用到case when\n1 2 3 4 5 6 7 8 CASE WHEN a.score \u003e= 90 THEN '优' WHEN a.score \u003c 90 AND a.score \u003e= 75 THEN '良' WHEN a.score \u003c 75 AND a.score \u003e= 60 THEN '中' ELSE '差' END 这题的关键点就在于这，其他剩下的就是条件拼接了\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 SELECT a.LEVEL, a.score_grade, ROUND(a.cur_count / b.total_num, 3) AS ratio FROM (SELECT b.LEVEL AS LEVEL, (CASE WHEN a.score \u003e= 90 THEN '优' WHEN a.score \u003c 90 AND a.score \u003e= 75 THEN '良' WHEN a.score \u003c 75 AND a.score \u003e= 60 THEN '中' ELSE '差' END) AS score_grade, count(1) AS cur_count FROM exam_record a LEFT JOIN user_info b ON a.uid = b.uid WHERE a.submit_time IS NOT NULL GROUP BY b.LEVEL, score_grade) a LEFT JOIN (SELECT b.LEVEL AS LEVEL, count(b.LEVEL) AS total_num FROM exam_record a LEFT JOIN user_info b ON a.uid = b.uid WHERE a.submit_time IS NOT NULL GROUP BY b.LEVEL) b ON a.LEVEL = b.LEVEL ORDER BY a.LEVEL DESC, ratio DESC 限量查询 注册时间最早的三个人 描述：\n现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 号 19 0 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 1200 3 算法 2020-02-01 10:00:00 3 1003 牛客 3 号 ♂ 22 0 算法 2020-01-02 10:00:00 4 1004 牛客 4 号 25 0 算法 2020-01-02 11:00:00 5 1005 牛客 555 号 4000 7 C++ 2020-01-11 10:00:00 6 1006 666666 3000 6 C++ 2020-11-01 10:00:00 请从中找到注册时间最早的 3 个人。由示例数据结果输出如下：\nuid nick_name register_time 1001 牛客 1 2020-01-01 10:00:00 1003 牛客 3 号 ♂ 2020-01-02 10:00:00 1004 牛客 4 号 2020-01-02 11:00:00 解释：按注册时间排序后选取前三名，输出其用户 ID、昵称、注册时间。\n答案：\n1 2 3 4 SELECT uid, nick_name, register_time FROM user_info ORDER BY register_time LIMIT 3 注册当天就完成了试卷的名单第三页（较难） 描述：现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 19 0 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 1200 3 算法 2020-01-01 10:00:00 3 1003 牛客 3 号 ♂ 22 0 算法 2020-01-01 10:00:00 4 1004 牛客 4 号 25 0 算法 2020-01-01 10:00:00 5 1005 牛客 555 号 4000 7 算法 2020-01-11 10:00:00 6 1006 牛客 6 号 25 0 算法 2020-01-02 11:00:00 7 1007 牛客 7 号 25 0 算法 2020-01-02 11:00:00 8 1008 牛客 8 号 25 0 算法 2020-01-02 11:00:00 9 1009 牛客 9 号 25 0 算法 2020-01-02 11:00:00 10 1010 牛客 10 号 25 0 算法 2020-01-02 11:00:00 11 1011 666666 3000 6 C++ 2020-01-02 10:00:00 试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 算法 hard 60 2020-01-01 10:00:00 2 9002 算法 hard 80 2020-01-01 10:00:00 3 9003 SQL medium 70 2020-01-01 10:00:00 试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-02 09:01:01 2020-01-02 09:21:59 80 2 1002 9003 2020-01-20 10:01:01 2020-01-20 10:10:01 81 3 1002 9002 2020-01-01 12:11:01 2020-01-01 12:31:01 83 4 1003 9002 2020-01-01 19:01:01 2020-01-01 19:30:01 75 5 1004 9002 2020-01-01 12:01:01 2020-01-01 12:11:01 60 6 1005 9002 2020-01-01 12:01:01 2020-01-01 12:41:01 90 7 1006 9001 2020-01-02 19:01:01 2020-01-02 19:32:00 20 8 1007 9002 2020-01-02 19:01:01 2020-01-02 19:40:01 89 9 1008 9003 2020-01-02 12:01:01 2020-01-02 12:20:01 99 10 1008 9001 2020-01-02 12:01:01 2020-01-02 12:31:01 98 11 1009 9002 2020-01-02 12:01:01 2020-01-02 12:31:01 82 12 1010 9002 2020-01-02 12:11:01 2020-01-02 12:41:01 76 13 1011 9001 2020-01-02 10:01:01 2020-01-02 10:31:01 89 找到求职方向为算法工程师，且注册当天就完成了算法类试卷的人，按参加过的所有考试最高得分排名。排名榜很长，我们将采用分页展示，每页 3 条，现在需要你取出第 3 页（页码从 1 开始）的人的信息。\n由示例数据结果输出如下：\nuid level register_time max_score 1010 0 2020-01-02 11:00:00 76 1003 0 2020-01-01 10:00:00 75 1004 0 2020-01-01 11:00:00 60 解释：除了 1011 其他用户的求职方向都为算法工程师；算法类试卷有 9001 和 9002，11 个用户注册当天都完成了算法类试卷；计算他们的所有考试最大分时，只有 1002 和 1008 完成了两次考试，其他人只完成了一场考试，1002 两场考试最高分为 81，1008 最高分为 99。\n按最高分排名如下：\nuid level register_time max_score 1008 0 2020-01-02 11:00:00 99 1005 7 2020-01-01 10:00:00 90 1007 0 2020-01-02 11:00:00 89 1002 3 2020-01-01 10:00:00 83 1009 0 2020-01-02 11:00:00 82 1001 0 2020-01-01 10:00:00 80 1010 0 2020-01-02 11:00:00 76 1003 0 2020-01-01 10:00:00 75 1004 0 2020-01-01 11:00:00 60 1006 0 2020-01-02 11:00:00 20 每页 3 条，第三页也就是第 7~9 条，返回 1010、1003、1004 的行记录即可。\n思路：\n每页三条，即需要取出第三页的人的信息，要用到limit 统计求职方向为算法工程师且注册当天就完成了算法类试卷的人的信息和每次记录的得分，先求满足条件的用户，后用 left join 做连接查找信息和每次记录的得分 答案：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 SELECT t1.uid, LEVEL, register_time, max(score) AS max_score FROM exam_record t JOIN examination_info USING (exam_id) JOIN user_info t1 ON t.uid = t1.uid AND date(t.submit_time) = date(t1.register_time) WHERE job = '算法' AND tag = '算法' GROUP BY t1.uid, LEVEL, register_time ORDER BY max_score DESC LIMIT 6,3 文本转换函数 修复串列了的记录 描述：现有试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 算法 hard 60 2021-01-01 10:00:00 2 9002 算法 hard 80 2021-01-01 10:00:00 3 9003 SQL medium 70 2021-01-01 10:00:00 4 9004 算法,medium,80 0 2021-01-01 10:00:00 录题同学有一次手误将部分记录的试题类别 tag、难度、时长同时录入到了 tag 字段，请帮忙找出这些录错了的记录，并拆分后按正确的列类型输出。\n由示例数据结果输出如下：\nexam_id tag difficulty duration 9004 算法 medium 80 思路：\n先来学习下本题要用到的函数\nSUBSTRING_INDEX 函数用于提取字符串中指定分隔符的部分。它接受三个参数：原始字符串、分隔符和指定要返回的部分的数量。\n以下是 SUBSTRING_INDEX 函数的语法：\n1 SUBSTRING_INDEX(str, delimiter, count) str：要进行分割的原始字符串。\ndelimiter：用作分割的字符串或字符。\ncount：指定要返回的部分的数量。\n如果 count 大于 0，则返回从左边开始的前 count 个部分（以分隔符为界）。 如果 count 小于 0，则返回从右边开始的前 count 个部分（以分隔符为界），即从右侧向左计数。 下面是一些示例，演示了 SUBSTRING_INDEX 函数的使用：\n提取字符串中的第一个部分：\n1 2 SELECT SUBSTRING_INDEX('apple,banana,cherry', ',', 1); -- 输出结果：'apple' 提取字符串中的最后一个部分：\n1 2 SELECT SUBSTRING_INDEX('apple,banana,cherry', ',', -1); -- 输出结果：'cherry' 提取字符串中的前两个部分：\n1 2 SELECT SUBSTRING_INDEX('apple,banana,cherry', ',', 2); -- 输出结果：'apple,banana' 提取字符串中的最后两个部分：\n1 2 SELECT SUBSTRING_INDEX('apple,banana,cherry', ',', -2); -- 输出结果：'banana,cherry' 答案：\n1 2 3 4 5 6 7 8 9 SELECT exam_id, substring_index( tag, ',', 1 ) tag, substring_index( substring_index( tag, ',', 2 ), ',',- 1 ) difficulty, substring_index( tag, ',',- 1 ) duration FROM examination_info WHERE difficulty = '' 对过长的昵称截取处理 描述：现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：\nid uid nick_name achievement level job register_time 1 1001 牛客 1 19 0 算法 2020-01-01 10:00:00 2 1002 牛客 2 号 1200 3 算法 2020-01-01 10:00:00 3 1003 牛客 3 号 ♂ 22 0 算法 2020-01-01 10:00:00 4 1004 牛客 4 号 25 0 算法 2020-01-01 11:00:00 5 1005 牛客 5678901234 号 4000 7 算法 2020-01-11 10:00:00 6 1006 牛客 67890123456789 号 25 0 算法 2020-01-02 11:00:00 有的用户的昵称特别长，在一些展示场景会导致样式混乱，因此需要将特别长的昵称转换一下再输出，请输出字符数大于 10 的用户信息，对于字符数大于 13 的用户输出前 10 个字符然后加上三个点号：『…』。\n由示例数据结果输出如下：\nuid nick_name 1005 牛客 5678901234 号 1006 牛客 67890123… 解释：字符数大于 10 的用户有 1005 和 1006，长度分别为 13、17；因此需要对 1006 的昵称截断输出。\n思路：\n这题涉及到字符的计算，要计算字符串的字符数（即字符串的长度），可以使用 LENGTH 函数或 CHAR_LENGTH 函数。这两个函数的区别在于对待多字节字符的方式。\nLENGTH 函数：它返回给定字符串的字节数。对于包含多字节字符的字符串，每个字符都会被当作一个字节来计算。 示例：\n1 SELECT LENGTH('你好'); -- 输出结果：6，因为 '你好' 中的每个汉字每个占3个字节 CHAR_LENGTH 函数：它返回给定字符串的字符数。对于包含多字节字符的字符串，每个字符会被当作一个字符来计算。 示例：\n1 SELECT CHAR_LENGTH('你好'); -- 输出结果：2，因为 '你好' 中有两个字符，即两个汉字 答案：\n1 2 3 4 5 6 7 8 9 10 11 12 SELECT uid, CASE WHEN CHAR_LENGTH( nick_name ) \u003e 13 THEN CONCAT( SUBSTR( nick_name, 1, 10 ), '...' ) ELSE nick_name END AS nick_name FROM user_info WHERE CHAR_LENGTH( nick_name ) \u003e 10 GROUP BY uid; 大小写混乱时的筛选统计（较难） 描述：\n现有试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：\nid exam_id tag difficulty duration release_time 1 9001 算法 hard 60 2021-01-01 10:00:00 2 9002 C++ hard 80 2021-01-01 10:00:00 3 9003 C++ hard 80 2021-01-01 10:00:00 4 9004 sql medium 70 2021-01-01 10:00:00 5 9005 C++ hard 80 2021-01-01 10:00:00 6 9006 C++ hard 80 2021-01-01 10:00:00 7 9007 C++ hard 80 2021-01-01 10:00:00 8 9008 SQL medium 70 2021-01-01 10:00:00 9 9009 SQL medium 70 2021-01-01 10:00:00 10 9010 SQL medium 70 2021-01-01 10:00:00 试卷作答信息表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：\nid uid exam_id start_time submit_time score 1 1001 9001 2020-01-01 09:01:01 2020-01-01 09:21:59 80 2 1002 9003 2020-01-20 10:01:01 2020-01-20 10:10:01 81 3 1002 9002 2020-02-01 12:11:01 2020-02-01 12:31:01 83 4 1003 9002 2020-03-01 19:01:01 2020-03-01 19:30:01 75 5 1004 9002 2020-03-01 12:01:01 2020-03-01 12:11:01 60 6 1005 9002 2020-03-01 12:01:01 2020-03-01 12:41:01 90 7 1006 9001 2020-05-02 19:01:01 2020-05-02 19:32:00 20 8 1007 9003 2020-01-02 19:01:01 2020-01-02 19:40:01 89 9 1008 9004 2020-02-02 12:01:01 2020-02-02 12:20:01 99 10 1008 9001 2020-02-02 12:01:01 2020-02-02 12:31:01 98 11 1009 9002 2020-02-02 12:01:01 2020-01-02 12:43:01 81 12 1010 9001 2020-01-02 12:11:01 (NULL) (NULL) 13 1010 9001 2020-02-02 12:01:01 2020-01-02 10:31:01 89 试卷的类别 tag 可能出现大小写混乱的情况，请先筛选出试卷作答数小于 3 的类别 tag，统计将其转换为大写后对应的原本试卷作答数。\n如果转换后 tag 并没有发生变化，不输出该条结果。\n由示例数据结果输出如下：\ntag answer_cnt C++ 6 解释：被作答过的试卷有 9001、9002、9003、9004，他们的 tag 和被作答次数如下：\nexam_id tag answer_cnt 9001 算法 4 9002 C++ 6 9003 c++ 2 9004 sql 2 作答次数小于 3 的 tag 有 c++和 sql，而转为大写后只有 C++本来就有作答数，于是输出 c++转化大写后的作答次数为 6。\n思路：\n首先，这题有点混乱，9004 根据示例数据查出来只有 1 次，这里显示有 2 次。\n先看一下大小写转换函数：\n1.UPPER(s)或UCASE(s)函数可以将字符串 s 中的字母字符全部转换成大写字母；\n2.LOWER(s)或者LCASE(s)函数可以将字符串 s 中的字母字符全部转换成小写字母。\n难点在于相同表做连接要查询不同的值\n答案：\n1 2 3 4 5 6 7 8 9 10 11 12 WITH a AS (SELECT tag, COUNT(start_time) AS answer_cnt FROM exam_record er JOIN examination_info ei ON er.exam_id = ei.exam_id GROUP BY tag) SELECT a.tag, b.answer_cnt FROM a INNER JOIN a AS b ON UPPER(a.tag)= b.tag #a小写 b大写 AND a.tag != b.tag WHERE a.answer_cnt \u003c 3; ",
  "wordCount" : "46992",
  "inLanguage": "en",
  "datePublished": "2023-07-22T05:00:00Z",
  "dateModified": "2023-07-22T05:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/interview/13_sql%E9%9D%A2%E8%AF%95%E9%A2%98/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

  <script id="MathJax-script" async src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-chtml.min.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath:  [['\\(', '\\)'], ['$', '$']],  
    }
  };
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      13_SQL面试题
    </h1>
    <div class="post-meta"><span title='2023-07-22 05:00:00 +0000 UTC'>2023-07-22</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#sql%e9%9d%a2%e8%af%95%e9%a2%981" aria-label="SQL面试题1">SQL面试题1</a><ul>
                        
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e6%95%b0%e6%8d%ae" aria-label="检索数据">检索数据</a><ul>
                        
                <li>
                    <a href="#%e4%bb%8e-customers-%e8%a1%a8%e4%b8%ad%e6%a3%80%e7%b4%a2%e6%89%80%e6%9c%89%e7%9a%84-id" aria-label="从 Customers 表中检索所有的 ID">从 Customers 表中检索所有的 ID</a></li>
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e5%b9%b6%e5%88%97%e5%87%ba%e5%b7%b2%e8%ae%a2%e8%b4%ad%e4%ba%a7%e5%93%81%e7%9a%84%e6%b8%85%e5%8d%95" aria-label="检索并列出已订购产品的清单">检索并列出已订购产品的清单</a></li>
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e6%89%80%e6%9c%89%e5%88%97" aria-label="检索所有列">检索所有列</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%8e%92%e5%ba%8f%e6%a3%80%e7%b4%a2%e6%95%b0%e6%8d%ae" aria-label="排序检索数据">排序检索数据</a><ul>
                        
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e9%a1%be%e5%ae%a2%e5%90%8d%e7%a7%b0%e5%b9%b6%e4%b8%94%e6%8e%92%e5%ba%8f" aria-label="检索顾客名称并且排序">检索顾客名称并且排序</a></li>
                <li>
                    <a href="#%e5%af%b9%e9%a1%be%e5%ae%a2-id-%e5%92%8c%e6%97%a5%e6%9c%9f%e6%8e%92%e5%ba%8f" aria-label="对顾客 ID 和日期排序">对顾客 ID 和日期排序</a></li>
                <li>
                    <a href="#%e6%8c%89%e7%85%a7%e6%95%b0%e9%87%8f%e5%92%8c%e4%bb%b7%e6%a0%bc%e6%8e%92%e5%ba%8f" aria-label="按照数量和价格排序">按照数量和价格排序</a></li>
                <li>
                    <a href="#%e6%a3%80%e6%9f%a5-sql-%e8%af%ad%e5%8f%a5" aria-label="检查 SQL 语句">检查 SQL 语句</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%bf%87%e6%bb%a4%e6%95%b0%e6%8d%ae" aria-label="过滤数据">过滤数据</a><ul>
                        
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e5%9b%ba%e5%ae%9a%e4%bb%b7%e6%a0%bc%e7%9a%84%e4%ba%a7%e5%93%81" aria-label="返回固定价格的产品">返回固定价格的产品</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e6%9b%b4%e9%ab%98%e4%bb%b7%e6%a0%bc%e7%9a%84%e4%ba%a7%e5%93%81" aria-label="返回更高价格的产品">返回更高价格的产品</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e4%ba%a7%e5%93%81%e5%b9%b6%e4%b8%94%e6%8c%89%e7%85%a7%e4%bb%b7%e6%a0%bc%e6%8e%92%e5%ba%8f" aria-label="返回产品并且按照价格排序">返回产品并且按照价格排序</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e6%9b%b4%e5%a4%9a%e7%9a%84%e4%ba%a7%e5%93%81" aria-label="返回更多的产品">返回更多的产品</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%ab%98%e7%ba%a7%e6%95%b0%e6%8d%ae%e8%bf%87%e6%bb%a4" aria-label="高级数据过滤">高级数据过滤</a><ul>
                        
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e4%be%9b%e5%ba%94%e5%95%86%e5%90%8d%e7%a7%b0" aria-label="检索供应商名称">检索供应商名称</a></li>
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e5%b9%b6%e5%88%97%e5%87%ba%e5%b7%b2%e8%ae%a2%e8%b4%ad%e4%ba%a7%e5%93%81%e7%9a%84%e6%b8%85%e5%8d%95-1" aria-label="检索并列出已订购产品的清单">检索并列出已订购产品的清单</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e6%89%80%e6%9c%89%e4%bb%b7%e6%a0%bc%e5%9c%a8-3-%e7%be%8e%e5%85%83%e5%88%b0-6-%e7%be%8e%e5%85%83%e4%b9%8b%e9%97%b4%e7%9a%84%e4%ba%a7%e5%93%81%e7%9a%84%e5%90%8d%e7%a7%b0%e5%92%8c%e4%bb%b7%e6%a0%bc" aria-label="返回所有价格在 3 美元到 6 美元之间的产品的名称和价格">返回所有价格在 3 美元到 6 美元之间的产品的名称和价格</a></li>
                <li>
                    <a href="#%e6%a3%80%e6%9f%a5-sql-%e8%af%ad%e5%8f%a5-1" aria-label="检查 SQL 语句">检查 SQL 语句</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%94%a8%e9%80%9a%e9%85%8d%e7%ac%a6%e8%bf%9b%e8%a1%8c%e8%bf%87%e6%bb%a4" aria-label="用通配符进行过滤">用通配符进行过滤</a><ul>
                        
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e4%ba%a7%e5%93%81%e5%90%8d%e7%a7%b0%e5%92%8c%e6%8f%8f%e8%bf%b0%e4%b8%80" aria-label="检索产品名称和描述（一）">检索产品名称和描述（一）</a></li>
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e4%ba%a7%e5%93%81%e5%90%8d%e7%a7%b0%e5%92%8c%e6%8f%8f%e8%bf%b0%e4%ba%8c" aria-label="检索产品名称和描述（二）">检索产品名称和描述（二）</a></li>
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e4%ba%a7%e5%93%81%e5%90%8d%e7%a7%b0%e5%92%8c%e6%8f%8f%e8%bf%b0%e4%b8%89" aria-label="检索产品名称和描述（三）">检索产品名称和描述（三）</a></li>
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e4%ba%a7%e5%93%81%e5%90%8d%e7%a7%b0%e5%92%8c%e6%8f%8f%e8%bf%b0%e5%9b%9b" aria-label="检索产品名称和描述（四）">检索产品名称和描述（四）</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e8%ae%a1%e7%ae%97%e5%ad%97%e6%ae%b5" aria-label="创建计算字段">创建计算字段</a><ul>
                        
                <li>
                    <a href="#%e5%88%ab%e5%90%8d" aria-label="别名">别名</a></li>
                <li>
                    <a href="#%e6%89%93%e6%8a%98" aria-label="打折">打折</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e5%87%bd%e6%95%b0%e5%a4%84%e7%90%86%e6%95%b0%e6%8d%ae" aria-label="使用函数处理数据">使用函数处理数据</a><ul>
                        
                <li>
                    <a href="#%e9%a1%be%e5%ae%a2%e7%99%bb%e5%bd%95%e5%90%8d" aria-label="顾客登录名">顾客登录名</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e-2020-%e5%b9%b4-1-%e6%9c%88%e7%9a%84%e6%89%80%e6%9c%89%e8%ae%a2%e5%8d%95%e7%9a%84%e8%ae%a2%e5%8d%95%e5%8f%b7%e5%92%8c%e8%ae%a2%e5%8d%95%e6%97%a5%e6%9c%9f" aria-label="返回 2020 年 1 月的所有订单的订单号和订单日期">返回 2020 年 1 月的所有订单的订单号和订单日期</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%b1%87%e6%80%bb%e6%95%b0%e6%8d%ae" aria-label="汇总数据">汇总数据</a><ul>
                        
                <li>
                    <a href="#%e7%a1%ae%e5%ae%9a%e5%b7%b2%e5%94%ae%e5%87%ba%e4%ba%a7%e5%93%81%e7%9a%84%e6%80%bb%e6%95%b0" aria-label="确定已售出产品的总数">确定已售出产品的总数</a></li>
                <li>
                    <a href="#%e7%a1%ae%e5%ae%9a%e5%b7%b2%e5%94%ae%e5%87%ba%e4%ba%a7%e5%93%81%e9%a1%b9-br01-%e7%9a%84%e6%80%bb%e6%95%b0" aria-label="确定已售出产品项 BR01 的总数">确定已售出产品项 BR01 的总数</a></li>
                <li>
                    <a href="#%e7%a1%ae%e5%ae%9a-products-%e8%a1%a8%e4%b8%ad%e4%bb%b7%e6%a0%bc%e4%b8%8d%e8%b6%85%e8%bf%87-10-%e7%be%8e%e5%85%83%e7%9a%84%e6%9c%80%e8%b4%b5%e4%ba%a7%e5%93%81%e7%9a%84%e4%bb%b7%e6%a0%bc" aria-label="确定 Products 表中价格不超过 10 美元的最贵产品的价格">确定 Products 表中价格不超过 10 美元的最贵产品的价格</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%86%e7%bb%84%e6%95%b0%e6%8d%ae" aria-label="分组数据">分组数据</a><ul>
                        
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e6%af%8f%e4%b8%aa%e8%ae%a2%e5%8d%95%e5%8f%b7%e5%90%84%e6%9c%89%e5%a4%9a%e5%b0%91%e8%a1%8c%e6%95%b0" aria-label="返回每个订单号各有多少行数">返回每个订单号各有多少行数</a></li>
                <li>
                    <a href="#%e6%af%8f%e4%b8%aa%e4%be%9b%e5%ba%94%e5%95%86%e6%88%90%e6%9c%ac%e6%9c%80%e4%bd%8e%e7%9a%84%e4%ba%a7%e5%93%81" aria-label="每个供应商成本最低的产品">每个供应商成本最低的产品</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e8%ae%a2%e5%8d%95%e6%95%b0%e9%87%8f%e6%80%bb%e5%92%8c%e4%b8%8d%e5%b0%8f%e4%ba%8e-100-%e7%9a%84%e6%89%80%e6%9c%89%e8%ae%a2%e5%8d%95%e7%9a%84%e8%ae%a2%e5%8d%95%e5%8f%b7" aria-label="返回订单数量总和不小于 100 的所有订单的订单号">返回订单数量总和不小于 100 的所有订单的订单号</a></li>
                <li>
                    <a href="#%e8%ae%a1%e7%ae%97%e6%80%bb%e5%92%8c" aria-label="计算总和">计算总和</a></li>
                <li>
                    <a href="#%e6%a3%80%e6%9f%a5-sql-%e8%af%ad%e5%8f%a5-2" aria-label="检查 SQL 语句">检查 SQL 语句</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e5%ad%90%e6%9f%a5%e8%af%a2" aria-label="使用子查询">使用子查询</a><ul>
                        
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e8%b4%ad%e4%b9%b0%e4%bb%b7%e6%a0%bc%e4%b8%ba-10-%e7%be%8e%e5%85%83%e6%88%96%e4%bb%a5%e4%b8%8a%e4%ba%a7%e5%93%81%e7%9a%84%e9%a1%be%e5%ae%a2%e5%88%97%e8%a1%a8" aria-label="返回购买价格为 10 美元或以上产品的顾客列表">返回购买价格为 10 美元或以上产品的顾客列表</a></li>
                <li>
                    <a href="#%e7%a1%ae%e5%ae%9a%e5%93%aa%e4%ba%9b%e8%ae%a2%e5%8d%95%e8%b4%ad%e4%b9%b0%e4%ba%86-prod_id-%e4%b8%ba-br01-%e7%9a%84%e4%ba%a7%e5%93%81%e4%b8%80" aria-label="确定哪些订单购买了 prod_id 为 BR01 的产品（一）">确定哪些订单购买了 prod_id 为 BR01 的产品（一）</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e8%b4%ad%e4%b9%b0-prod_id-%e4%b8%ba-br01-%e7%9a%84%e4%ba%a7%e5%93%81%e7%9a%84%e6%89%80%e6%9c%89%e9%a1%be%e5%ae%a2%e7%9a%84%e7%94%b5%e5%ad%90%e9%82%ae%e4%bb%b6%e4%b8%80" aria-label="返回购买 prod_id 为 BR01 的产品的所有顾客的电子邮件（一）">返回购买 prod_id 为 BR01 的产品的所有顾客的电子邮件（一）</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e6%af%8f%e4%b8%aa%e9%a1%be%e5%ae%a2%e4%b8%8d%e5%90%8c%e8%ae%a2%e5%8d%95%e7%9a%84%e6%80%bb%e9%87%91%e9%a2%9d" aria-label="返回每个顾客不同订单的总金额">返回每个顾客不同订单的总金额</a></li>
                <li>
                    <a href="#%e4%bb%8e-products-%e8%a1%a8%e4%b8%ad%e6%a3%80%e7%b4%a2%e6%89%80%e6%9c%89%e7%9a%84%e4%ba%a7%e5%93%81%e5%90%8d%e7%a7%b0%e4%bb%a5%e5%8f%8a%e5%af%b9%e5%ba%94%e7%9a%84%e9%94%80%e5%94%ae%e6%80%bb%e6%95%b0" aria-label="从 Products 表中检索所有的产品名称以及对应的销售总数">从 Products 表中检索所有的产品名称以及对应的销售总数</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%bf%9e%e6%8e%a5%e8%a1%a8" aria-label="连接表">连接表</a><ul>
                        
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e9%a1%be%e5%ae%a2%e5%90%8d%e7%a7%b0%e5%92%8c%e7%9b%b8%e5%85%b3%e8%ae%a2%e5%8d%95%e5%8f%b7" aria-label="返回顾客名称和相关订单号">返回顾客名称和相关订单号</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e9%a1%be%e5%ae%a2%e5%90%8d%e7%a7%b0%e5%92%8c%e7%9b%b8%e5%85%b3%e8%ae%a2%e5%8d%95%e5%8f%b7%e4%bb%a5%e5%8f%8a%e6%af%8f%e4%b8%aa%e8%ae%a2%e5%8d%95%e7%9a%84%e6%80%bb%e4%bb%b7" aria-label="返回顾客名称和相关订单号以及每个订单的总价">返回顾客名称和相关订单号以及每个订单的总价</a></li>
                <li>
                    <a href="#%e7%a1%ae%e5%ae%9a%e5%93%aa%e4%ba%9b%e8%ae%a2%e5%8d%95%e8%b4%ad%e4%b9%b0%e4%ba%86-prod_id-%e4%b8%ba-br01-%e7%9a%84%e4%ba%a7%e5%93%81%e4%ba%8c" aria-label="确定哪些订单购买了 prod_id 为 BR01 的产品（二）">确定哪些订单购买了 prod_id 为 BR01 的产品（二）</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e8%b4%ad%e4%b9%b0-prod_id-%e4%b8%ba-br01-%e7%9a%84%e4%ba%a7%e5%93%81%e7%9a%84%e6%89%80%e6%9c%89%e9%a1%be%e5%ae%a2%e7%9a%84%e7%94%b5%e5%ad%90%e9%82%ae%e4%bb%b6%e4%ba%8c" aria-label="返回购买 prod_id 为 BR01 的产品的所有顾客的电子邮件（二）">返回购买 prod_id 为 BR01 的产品的所有顾客的电子邮件（二）</a></li>
                <li>
                    <a href="#%e7%a1%ae%e5%ae%9a%e6%9c%80%e4%bd%b3%e9%a1%be%e5%ae%a2%e7%9a%84%e5%8f%a6%e4%b8%80%e7%a7%8d%e6%96%b9%e5%bc%8f%e4%ba%8c" aria-label="确定最佳顾客的另一种方式（二）">确定最佳顾客的另一种方式（二）</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e9%ab%98%e7%ba%a7%e8%bf%9e%e6%8e%a5" aria-label="创建高级连接">创建高级连接</a><ul>
                        
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e6%af%8f%e4%b8%aa%e9%a1%be%e5%ae%a2%e7%9a%84%e5%90%8d%e7%a7%b0%e5%92%8c%e6%89%80%e6%9c%89%e7%9a%84%e8%ae%a2%e5%8d%95%e5%8f%b7%e4%b8%80" aria-label="检索每个顾客的名称和所有的订单号（一）">检索每个顾客的名称和所有的订单号（一）</a></li>
                <li>
                    <a href="#%e6%a3%80%e7%b4%a2%e6%af%8f%e4%b8%aa%e9%a1%be%e5%ae%a2%e7%9a%84%e5%90%8d%e7%a7%b0%e5%92%8c%e6%89%80%e6%9c%89%e7%9a%84%e8%ae%a2%e5%8d%95%e5%8f%b7%e4%ba%8c" aria-label="检索每个顾客的名称和所有的订单号（二）">检索每个顾客的名称和所有的订单号（二）</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e4%ba%a7%e5%93%81%e5%90%8d%e7%a7%b0%e5%92%8c%e4%b8%8e%e4%b9%8b%e7%9b%b8%e5%85%b3%e7%9a%84%e8%ae%a2%e5%8d%95%e5%8f%b7" aria-label="返回产品名称和与之相关的订单号">返回产品名称和与之相关的订单号</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e4%ba%a7%e5%93%81%e5%90%8d%e7%a7%b0%e5%92%8c%e6%af%8f%e4%b8%80%e9%a1%b9%e4%ba%a7%e5%93%81%e7%9a%84%e6%80%bb%e8%ae%a2%e5%8d%95%e6%95%b0" aria-label="返回产品名称和每一项产品的总订单数">返回产品名称和每一项产品的总订单数</a></li>
                <li>
                    <a href="#%e5%88%97%e5%87%ba%e4%be%9b%e5%ba%94%e5%95%86%e5%8f%8a%e5%85%b6%e5%8f%af%e4%be%9b%e4%ba%a7%e5%93%81%e7%9a%84%e6%95%b0%e9%87%8f" aria-label="列出供应商及其可供产品的数量">列出供应商及其可供产品的数量</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bb%84%e5%90%88%e6%9f%a5%e8%af%a2" aria-label="组合查询">组合查询</a><ul>
                        
                <li>
                    <a href="#%e5%b0%86%e4%b8%a4%e4%b8%aa-select-%e8%af%ad%e5%8f%a5%e7%bb%93%e5%90%88%e8%b5%b7%e6%9d%a5%e4%b8%80" aria-label="将两个 SELECT 语句结合起来（一）">将两个 SELECT 语句结合起来（一）</a></li>
                <li>
                    <a href="#%e5%b0%86%e4%b8%a4%e4%b8%aa-select-%e8%af%ad%e5%8f%a5%e7%bb%93%e5%90%88%e8%b5%b7%e6%9d%a5%e4%ba%8c" aria-label="将两个 SELECT 语句结合起来（二）">将两个 SELECT 语句结合起来（二）</a></li>
                <li>
                    <a href="#%e7%bb%84%e5%90%88-products-%e8%a1%a8%e4%b8%ad%e7%9a%84%e4%ba%a7%e5%93%81%e5%90%8d%e7%a7%b0%e5%92%8c-customers-%e8%a1%a8%e4%b8%ad%e7%9a%84%e9%a1%be%e5%ae%a2%e5%90%8d%e7%a7%b0" aria-label="组合 Products 表中的产品名称和 Customers 表中的顾客名称">组合 Products 表中的产品名称和 Customers 表中的顾客名称</a></li>
                <li>
                    <a href="#%e6%a3%80%e6%9f%a5-sql-%e8%af%ad%e5%8f%a5-3" aria-label="检查 SQL 语句">检查 SQL 语句</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#sql%e9%9d%a2%e8%af%95%e9%a2%982" aria-label="SQL面试题2">SQL面试题2</a><ul>
                        
                <li>
                    <a href="#%e5%a2%9e%e5%88%a0%e6%94%b9%e6%93%8d%e4%bd%9c" aria-label="增删改操作">增删改操作</a><ul>
                        
                <li>
                    <a href="#%e6%8f%92%e5%85%a5%e8%ae%b0%e5%bd%95%e4%b8%80" aria-label="插入记录（一）">插入记录（一）</a></li>
                <li>
                    <a href="#%e6%8f%92%e5%85%a5%e8%ae%b0%e5%bd%95%e4%ba%8c" aria-label="插入记录（二）">插入记录（二）</a></li>
                <li>
                    <a href="#%e6%8f%92%e5%85%a5%e8%ae%b0%e5%bd%95%e4%b8%89" aria-label="插入记录（三）">插入记录（三）</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0%e8%ae%b0%e5%bd%95%e4%b8%80" aria-label="更新记录（一）">更新记录（一）</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0%e8%ae%b0%e5%bd%95%e4%ba%8c" aria-label="更新记录（二）">更新记录（二）</a></li>
                <li>
                    <a href="#%e5%88%a0%e9%99%a4%e8%ae%b0%e5%bd%95%e4%b8%80" aria-label="删除记录（一）">删除记录（一）</a></li>
                <li>
                    <a href="#%e5%88%a0%e9%99%a4%e8%ae%b0%e5%bd%95%e4%ba%8c" aria-label="删除记录（二）">删除记录（二）</a></li>
                <li>
                    <a href="#%e5%88%a0%e9%99%a4%e8%ae%b0%e5%bd%95%e4%b8%89" aria-label="删除记录（三）">删除记录（三）</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%a1%a8%e4%b8%8e%e7%b4%a2%e5%bc%95%e6%93%8d%e4%bd%9c" aria-label="表与索引操作">表与索引操作</a><ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e4%b8%80%e5%bc%a0%e6%96%b0%e8%a1%a8" aria-label="创建一张新表">创建一张新表</a></li>
                <li>
                    <a href="#%e4%bf%ae%e6%94%b9%e8%a1%a8" aria-label="修改表">修改表</a></li>
                <li>
                    <a href="#%e5%88%a0%e9%99%a4%e8%a1%a8" aria-label="删除表">删除表</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95" aria-label="创建索引">创建索引</a></li>
                <li>
                    <a href="#%e5%88%a0%e9%99%a4%e7%b4%a2%e5%bc%95" aria-label="删除索引">删除索引</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#sql%e9%9d%a2%e8%af%95%e9%a2%983" aria-label="SQL面试题3">SQL面试题3</a><ul>
                        
                <li>
                    <a href="#%e8%81%9a%e5%90%88%e5%87%bd%e6%95%b0" aria-label="聚合函数">聚合函数</a><ul>
                        
                <li>
                    <a href="#sql-%e7%b1%bb%e5%88%ab%e9%ab%98%e9%9a%be%e5%ba%a6%e8%af%95%e5%8d%b7%e5%be%97%e5%88%86%e7%9a%84%e6%88%aa%e6%96%ad%e5%b9%b3%e5%9d%87%e5%80%bc%e8%be%83%e9%9a%be" aria-label="SQL 类别高难度试卷得分的截断平均值（较难）">SQL 类别高难度试卷得分的截断平均值（较难）</a></li>
                <li>
                    <a href="#%e7%bb%9f%e8%ae%a1%e4%bd%9c%e7%ad%94%e6%ac%a1%e6%95%b0" aria-label="统计作答次数">统计作答次数</a></li>
                <li>
                    <a href="#%e5%be%97%e5%88%86%e4%b8%8d%e5%b0%8f%e4%ba%8e%e5%b9%b3%e5%9d%87%e5%88%86%e7%9a%84%e6%9c%80%e4%bd%8e%e5%88%86" aria-label="得分不小于平均分的最低分">得分不小于平均分的最低分</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%86%e7%bb%84%e6%9f%a5%e8%af%a2" aria-label="分组查询">分组查询</a><ul>
                        
                <li>
                    <a href="#%e5%b9%b3%e5%9d%87%e6%b4%bb%e8%b7%83%e5%a4%a9%e6%95%b0%e5%92%8c%e6%9c%88%e6%b4%bb%e4%ba%ba%e6%95%b0" aria-label="平均活跃天数和月活人数">平均活跃天数和月活人数</a></li>
                <li>
                    <a href="#%e6%9c%88%e6%80%bb%e5%88%b7%e9%a2%98%e6%95%b0%e5%92%8c%e6%97%a5%e5%9d%87%e5%88%b7%e9%a2%98%e6%95%b0" aria-label="月总刷题数和日均刷题数">月总刷题数和日均刷题数</a></li>
                <li>
                    <a href="#%e6%9c%aa%e5%ae%8c%e6%88%90%e8%af%95%e5%8d%b7%e6%95%b0%e5%a4%a7%e4%ba%8e-1-%e7%9a%84%e6%9c%89%e6%95%88%e7%94%a8%e6%88%b7%e8%be%83%e9%9a%be" aria-label="未完成试卷数大于 1 的有效用户（较难）">未完成试卷数大于 1 的有效用户（较难）</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b5%8c%e5%a5%97%e5%ad%90%e6%9f%a5%e8%af%a2" aria-label="嵌套子查询">嵌套子查询</a><ul>
                        
                <li>
                    <a href="#%e6%9c%88%e5%9d%87%e5%ae%8c%e6%88%90%e8%af%95%e5%8d%b7%e6%95%b0%e4%b8%8d%e5%b0%8f%e4%ba%8e-3-%e7%9a%84%e7%94%a8%e6%88%b7%e7%88%b1%e4%bd%9c%e7%ad%94%e7%9a%84%e7%b1%bb%e5%88%ab%e8%be%83%e9%9a%be" aria-label="月均完成试卷数不小于 3 的用户爱作答的类别（较难）">月均完成试卷数不小于 3 的用户爱作答的类别（较难）</a></li>
                <li>
                    <a href="#%e8%af%95%e5%8d%b7%e5%8f%91%e5%b8%83%e5%bd%93%e5%a4%a9%e4%bd%9c%e7%ad%94%e4%ba%ba%e6%95%b0%e5%92%8c%e5%b9%b3%e5%9d%87%e5%88%86" aria-label="试卷发布当天作答人数和平均分">试卷发布当天作答人数和平均分</a></li>
                <li>
                    <a href="#%e4%bd%9c%e7%ad%94%e8%af%95%e5%8d%b7%e5%be%97%e5%88%86%e5%a4%a7%e4%ba%8e%e8%bf%87-80-%e7%9a%84%e4%ba%ba%e7%9a%84%e7%94%a8%e6%88%b7%e7%ad%89%e7%ba%a7%e5%88%86%e5%b8%83" aria-label="作答试卷得分大于过 80 的人的用户等级分布">作答试卷得分大于过 80 的人的用户等级分布</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%90%88%e5%b9%b6%e6%9f%a5%e8%af%a2" aria-label="合并查询">合并查询</a><ul>
                        
                <li>
                    <a href="#%e6%af%8f%e4%b8%aa%e9%a2%98%e7%9b%ae%e5%92%8c%e6%af%8f%e4%bb%bd%e8%af%95%e5%8d%b7%e8%a2%ab%e4%bd%9c%e7%ad%94%e7%9a%84%e4%ba%ba%e6%95%b0%e5%92%8c%e6%ac%a1%e6%95%b0" aria-label="每个题目和每份试卷被作答的人数和次数">每个题目和每份试卷被作答的人数和次数</a></li>
                <li>
                    <a href="#%e5%88%86%e5%88%ab%e6%bb%a1%e8%b6%b3%e4%b8%a4%e4%b8%aa%e6%b4%bb%e5%8a%a8%e7%9a%84%e4%ba%ba" aria-label="分别满足两个活动的人">分别满足两个活动的人</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%bf%9e%e6%8e%a5%e6%9f%a5%e8%af%a2" aria-label="连接查询">连接查询</a><ul>
                        
                <li>
                    <a href="#%e6%bb%a1%e8%b6%b3%e6%9d%a1%e4%bb%b6%e7%9a%84%e7%94%a8%e6%88%b7%e7%9a%84%e8%af%95%e5%8d%b7%e5%ae%8c%e6%88%90%e6%95%b0%e5%92%8c%e9%a2%98%e7%9b%ae%e7%bb%83%e4%b9%a0%e6%95%b0%e5%9b%b0%e9%9a%be" aria-label="满足条件的用户的试卷完成数和题目练习数（困难）">满足条件的用户的试卷完成数和题目练习数（困难）</a></li>
                <li>
                    <a href="#%e6%af%8f%e4%b8%aa-67-%e7%ba%a7%e7%94%a8%e6%88%b7%e6%b4%bb%e8%b7%83%e6%83%85%e5%86%b5%e5%9b%b0%e9%9a%be" aria-label="每个 6/7 级用户活跃情况（困难）">每个 6/7 级用户活跃情况（困难）</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#sql%e9%9d%a2%e8%af%95%e9%a2%984" aria-label="SQL面试题4">SQL面试题4</a><ul>
                        
                <li>
                    <a href="#%e4%b8%93%e7%94%a8%e7%aa%97%e5%8f%a3%e5%87%bd%e6%95%b0" aria-label="专用窗口函数">专用窗口函数</a><ul>
                        
                <li>
                    <a href="#%e6%af%8f%e7%b1%bb%e8%af%95%e5%8d%b7%e5%be%97%e5%88%86%e5%89%8d%e4%b8%89%e5%90%8d" aria-label="每类试卷得分前三名">每类试卷得分前三名</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%ba%8c%e5%bf%ab%e6%85%a2%e7%94%a8%e6%97%b6%e4%b9%8b%e5%b7%ae%e5%a4%a7%e4%ba%8e%e8%af%95%e5%8d%b7%e6%97%b6%e9%95%bf%e4%b8%80%e5%8d%8a%e7%9a%84%e8%af%95%e5%8d%b7%e8%be%83%e9%9a%be" aria-label="第二快/慢用时之差大于试卷时长一半的试卷（较难）">第二快/慢用时之差大于试卷时长一半的试卷（较难）</a></li>
                <li>
                    <a href="#%e8%bf%9e%e7%bb%ad%e4%b8%a4%e6%ac%a1%e4%bd%9c%e7%ad%94%e8%af%95%e5%8d%b7%e7%9a%84%e6%9c%80%e5%a4%a7%e6%97%b6%e9%97%b4%e7%aa%97%e8%be%83%e9%9a%be" aria-label="连续两次作答试卷的最大时间窗（较难）">连续两次作答试卷的最大时间窗（较难）</a></li>
                <li>
                    <a href="#%e8%bf%91%e4%b8%89%e4%b8%aa%e6%9c%88%e6%9c%aa%e5%ae%8c%e6%88%90%e4%b8%ba-0-%e7%9a%84%e7%94%a8%e6%88%b7%e5%ae%8c%e6%88%90%e6%83%85%e5%86%b5" aria-label="近三个月未完成为 0 的用户完成情况">近三个月未完成为 0 的用户完成情况</a></li>
                <li>
                    <a href="#%e6%9c%aa%e5%ae%8c%e6%88%90%e7%8e%87%e8%be%83%e9%ab%98%e7%9a%84-50%e7%94%a8%e6%88%b7%e8%bf%91%e4%b8%89%e4%b8%aa%e6%9c%88%e7%ad%94%e5%8d%b7%e6%83%85%e5%86%b5%e5%9b%b0%e9%9a%be" aria-label="未完成率较高的 50%用户近三个月答卷情况（困难）">未完成率较高的 50%用户近三个月答卷情况（困难）</a></li>
                <li>
                    <a href="#%e8%af%95%e5%8d%b7%e5%ae%8c%e6%88%90%e6%95%b0%e5%90%8c%e6%af%94-2020-%e5%b9%b4%e7%9a%84%e5%a2%9e%e9%95%bf%e7%8e%87%e5%8f%8a%e6%8e%92%e5%90%8d%e5%8f%98%e5%8c%96%e5%9b%b0%e9%9a%be" aria-label="试卷完成数同比 2020 年的增长率及排名变化（困难）">试卷完成数同比 2020 年的增长率及排名变化（困难）</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%81%9a%e5%90%88%e7%aa%97%e5%8f%a3%e5%87%bd%e6%95%b0" aria-label="聚合窗口函数">聚合窗口函数</a><ul>
                        
                <li>
                    <a href="#%e5%af%b9%e8%af%95%e5%8d%b7%e5%be%97%e5%88%86%e5%81%9a-min-max-%e5%bd%92%e4%b8%80%e5%8c%96" aria-label="对试卷得分做 min-max 归一化">对试卷得分做 min-max 归一化</a></li>
                <li>
                    <a href="#%e6%af%8f%e4%bb%bd%e8%af%95%e5%8d%b7%e6%af%8f%e6%9c%88%e4%bd%9c%e7%ad%94%e6%95%b0%e5%92%8c%e6%88%aa%e6%ad%a2%e5%bd%93%e6%9c%88%e7%9a%84%e4%bd%9c%e7%ad%94%e6%80%bb%e6%95%b0" aria-label="每份试卷每月作答数和截止当月的作答总数">每份试卷每月作答数和截止当月的作答总数</a></li>
                <li>
                    <a href="#%e6%af%8f%e6%9c%88%e5%8f%8a%e6%88%aa%e6%ad%a2%e5%bd%93%e6%9c%88%e7%9a%84%e7%ad%94%e9%a2%98%e6%83%85%e5%86%b5%e8%be%83%e9%9a%be" aria-label="每月及截止当月的答题情况（较难）">每月及截止当月的答题情况（较难）</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#sql%e9%9d%a2%e8%af%95%e9%a2%985" aria-label="SQL面试题5">SQL面试题5</a><ul>
                        
                <li>
                    <a href="#%e7%a9%ba%e5%80%bc%e5%a4%84%e7%90%86" aria-label="空值处理">空值处理</a><ul>
                        
                <li>
                    <a href="#%e7%bb%9f%e8%ae%a1%e6%9c%89%e6%9c%aa%e5%ae%8c%e6%88%90%e7%8a%b6%e6%80%81%e7%9a%84%e8%af%95%e5%8d%b7%e7%9a%84%e6%9c%aa%e5%ae%8c%e6%88%90%e6%95%b0%e5%92%8c%e6%9c%aa%e5%ae%8c%e6%88%90%e7%8e%87" aria-label="统计有未完成状态的试卷的未完成数和未完成率">统计有未完成状态的试卷的未完成数和未完成率</a></li>
                <li>
                    <a href="#0-%e7%ba%a7%e7%94%a8%e6%88%b7%e9%ab%98%e9%9a%be%e5%ba%a6%e8%af%95%e5%8d%b7%e7%9a%84%e5%b9%b3%e5%9d%87%e7%94%a8%e6%97%b6%e5%92%8c%e5%b9%b3%e5%9d%87%e5%be%97%e5%88%86" aria-label="0 级用户高难度试卷的平均用时和平均得分">0 级用户高难度试卷的平均用时和平均得分</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%ab%98%e7%ba%a7%e6%9d%a1%e4%bb%b6%e8%af%ad%e5%8f%a5" aria-label="高级条件语句">高级条件语句</a><ul>
                        
                <li>
                    <a href="#%e7%ad%9b%e9%80%89%e9%99%90%e5%ae%9a%e6%98%b5%e7%a7%b0%e6%88%90%e5%b0%b1%e5%80%bc%e6%b4%bb%e8%b7%83%e6%97%a5%e6%9c%9f%e7%9a%84%e7%94%a8%e6%88%b7%e8%be%83%e9%9a%be" aria-label="筛选限定昵称成就值活跃日期的用户（较难）">筛选限定昵称成就值活跃日期的用户（较难）</a></li>
                <li>
                    <a href="#%e7%ad%9b%e9%80%89%e6%98%b5%e7%a7%b0%e8%a7%84%e5%88%99%e5%92%8c%e8%af%95%e5%8d%b7%e8%a7%84%e5%88%99%e7%9a%84%e4%bd%9c%e7%ad%94%e8%ae%b0%e5%bd%95%e8%be%83%e9%9a%be" aria-label="筛选昵称规则和试卷规则的作答记录（较难）">筛选昵称规则和试卷规则的作答记录（较难）</a></li>
                <li>
                    <a href="#%e6%a0%b9%e6%8d%ae%e6%8c%87%e5%ae%9a%e8%ae%b0%e5%bd%95%e6%98%af%e5%90%a6%e5%ad%98%e5%9c%a8%e8%be%93%e5%87%ba%e4%b8%8d%e5%90%8c%e6%83%85%e5%86%b5%e5%9b%b0%e9%9a%be" aria-label="根据指定记录是否存在输出不同情况（困难）">根据指定记录是否存在输出不同情况（困难）</a></li>
                <li>
                    <a href="#%e5%90%84%e7%94%a8%e6%88%b7%e7%ad%89%e7%ba%a7%e7%9a%84%e4%b8%8d%e5%90%8c%e5%be%97%e5%88%86%e8%a1%a8%e7%8e%b0%e5%8d%a0%e6%af%94%e8%be%83%e9%9a%be" aria-label="各用户等级的不同得分表现占比（较难）">各用户等级的不同得分表现占比（较难）</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%99%90%e9%87%8f%e6%9f%a5%e8%af%a2" aria-label="限量查询">限量查询</a><ul>
                        
                <li>
                    <a href="#%e6%b3%a8%e5%86%8c%e6%97%b6%e9%97%b4%e6%9c%80%e6%97%a9%e7%9a%84%e4%b8%89%e4%b8%aa%e4%ba%ba" aria-label="注册时间最早的三个人">注册时间最早的三个人</a></li>
                <li>
                    <a href="#%e6%b3%a8%e5%86%8c%e5%bd%93%e5%a4%a9%e5%b0%b1%e5%ae%8c%e6%88%90%e4%ba%86%e8%af%95%e5%8d%b7%e7%9a%84%e5%90%8d%e5%8d%95%e7%ac%ac%e4%b8%89%e9%a1%b5%e8%be%83%e9%9a%be" aria-label="注册当天就完成了试卷的名单第三页（较难）">注册当天就完成了试卷的名单第三页（较难）</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%96%87%e6%9c%ac%e8%bd%ac%e6%8d%a2%e5%87%bd%e6%95%b0" aria-label="文本转换函数">文本转换函数</a><ul>
                        
                <li>
                    <a href="#%e4%bf%ae%e5%a4%8d%e4%b8%b2%e5%88%97%e4%ba%86%e7%9a%84%e8%ae%b0%e5%bd%95" aria-label="修复串列了的记录">修复串列了的记录</a></li>
                <li>
                    <a href="#%e5%af%b9%e8%bf%87%e9%95%bf%e7%9a%84%e6%98%b5%e7%a7%b0%e6%88%aa%e5%8f%96%e5%a4%84%e7%90%86" aria-label="对过长的昵称截取处理">对过长的昵称截取处理</a></li>
                <li>
                    <a href="#%e5%a4%a7%e5%b0%8f%e5%86%99%e6%b7%b7%e4%b9%b1%e6%97%b6%e7%9a%84%e7%ad%9b%e9%80%89%e7%bb%9f%e8%ae%a1%e8%be%83%e9%9a%be" aria-label="大小写混乱时的筛选统计（较难）">大小写混乱时的筛选统计（较难）</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="sql面试题1">SQL面试题1<a hidden class="anchor" aria-hidden="true" href="#sql面试题1">#</a></h1>
<h2 id="检索数据">检索数据<a hidden class="anchor" aria-hidden="true" href="#检索数据">#</a></h2>
<p><code>SELECT</code> 用于从数据库中查询数据。</p>
<h3 id="从-customers-表中检索所有的-id">从 Customers 表中检索所有的 ID<a hidden class="anchor" aria-hidden="true" href="#从-customers-表中检索所有的-id">#</a></h3>
<p>现有表 <code>Customers</code> 如下：</p>
<table>
<thead>
<tr>
<th>cust_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
</tr>
<tr>
<td>B</td>
</tr>
<tr>
<td>C</td>
</tr>
</tbody>
</table>
<p>编写 SQL 语句，从 <code>Customers</code> 表中检索所有的 <code>cust_id</code>。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="检索并列出已订购产品的清单">检索并列出已订购产品的清单<a hidden class="anchor" aria-hidden="true" href="#检索并列出已订购产品的清单">#</a></h3>
<p>表 <code>OrderItems</code> 含有非空的列 <code>prod_id</code> 代表商品 id，包含了所有已订购的商品（有些已被订购多次）。</p>
<table>
<thead>
<tr>
<th>prod_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
</tr>
<tr>
<td>a2</td>
</tr>
<tr>
<td>a3</td>
</tr>
<tr>
<td>a4</td>
</tr>
<tr>
<td>a5</td>
</tr>
<tr>
<td>a6</td>
</tr>
<tr>
<td>a7</td>
</tr>
</tbody>
</table>
<p>编写 SQL 语句，检索并列出所有已订购商品（<code>prod_id</code>）的去重后的清单。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DISTINCT</span> prod_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span></code></pre></td></tr></table>
</div>
</div><p>知识点：<code>DISTINCT</code> 用于返回列中的唯一不同值。</p>
<h3 id="检索所有列">检索所有列<a hidden class="anchor" aria-hidden="true" href="#检索所有列">#</a></h3>
<p>现在有 <code>Customers</code> 表（表中含有列 <code>cust_id</code> 代表客户 id，<code>cust_name</code> 代表客户姓名）</p>
<table>
<thead>
<tr>
<th>cust_id</th>
<th>cust_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>andy</td>
</tr>
<tr>
<td>a2</td>
<td>ben</td>
</tr>
<tr>
<td>a3</td>
<td>tony</td>
</tr>
<tr>
<td>a4</td>
<td>tom</td>
</tr>
<tr>
<td>a5</td>
<td>an</td>
</tr>
<tr>
<td>a6</td>
<td>lee</td>
</tr>
<tr>
<td>a7</td>
<td>hex</td>
</tr>
</tbody>
</table>
<p>需要编写 SQL 语句，检索所有列。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_id, cust_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="排序检索数据">排序检索数据<a hidden class="anchor" aria-hidden="true" href="#排序检索数据">#</a></h2>
<p><code>ORDER BY</code> 用于对结果集按照一个列或者多个列进行排序。默认按照升序对记录进行排序，如果需要按照降序对记录进行排序，可以使用 <code>DESC</code> 关键字。</p>
<h3 id="检索顾客名称并且排序">检索顾客名称并且排序<a hidden class="anchor" aria-hidden="true" href="#检索顾客名称并且排序">#</a></h3>
<p>有表 <code>Customers</code>，<code>cust_id</code> 代表客户 id，<code>cust_name</code> 代表客户姓名。</p>
<table>
<thead>
<tr>
<th>cust_id</th>
<th>cust_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>andy</td>
</tr>
<tr>
<td>a2</td>
<td>ben</td>
</tr>
<tr>
<td>a3</td>
<td>tony</td>
</tr>
<tr>
<td>a4</td>
<td>tom</td>
</tr>
<tr>
<td>a5</td>
<td>an</td>
</tr>
<tr>
<td>a6</td>
<td>lee</td>
</tr>
<tr>
<td>a7</td>
<td>hex</td>
</tr>
</tbody>
</table>
<p>从 <code>Customers</code> 中检索所有的顾客名称（<code>cust_name</code>），并按从 Z 到 A 的顺序显示结果。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> cust_name <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="对顾客-id-和日期排序">对顾客 ID 和日期排序<a hidden class="anchor" aria-hidden="true" href="#对顾客-id-和日期排序">#</a></h3>
<p>有 <code>Orders</code> 表：</p>
<table>
<thead>
<tr>
<th>cust_id</th>
<th>order_num</th>
<th>order_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>andy</td>
<td>aaaa</td>
<td>2021-01-01 00:00:00</td>
</tr>
<tr>
<td>andy</td>
<td>bbbb</td>
<td>2021-01-01 12:00:00</td>
</tr>
<tr>
<td>bob</td>
<td>cccc</td>
<td>2021-01-10 12:00:00</td>
</tr>
<tr>
<td>dick</td>
<td>dddd</td>
<td>2021-01-11 00:00:00</td>
</tr>
</tbody>
</table>
<p>编写 SQL 语句，从 <code>Orders</code> 表中检索顾客 ID（<code>cust_id</code>）和订单号（<code>order_num</code>），并先按顾客 ID 对结果进行排序，再按订单日期倒序排列。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#f00">根据列名排序</span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">注意：是</span> order_date <span style="color:#f00">降序，而不是</span> order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_id, order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Orders
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> cust_id,order_date <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>知识点：<code>order by</code> 对多列排序的时候，先排序的列放前面，后排序的列放后面。并且，不同的列可以有不同的排序规则。</p>
<h3 id="按照数量和价格排序">按照数量和价格排序<a hidden class="anchor" aria-hidden="true" href="#按照数量和价格排序">#</a></h3>
<p>假设有一个 <code>OrderItems</code> 表：</p>
<table>
<thead>
<tr>
<th>quantity</th>
<th>item_price</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>100</td>
</tr>
<tr>
<td>10</td>
<td>1003</td>
</tr>
<tr>
<td>2</td>
<td>500</td>
</tr>
</tbody>
</table>
<p>编写 SQL 语句，显示 <code>OrderItems</code> 表中的数量（<code>quantity</code>）和价格（<code>item_price</code>），并按数量由多到少、价格由高到低排序。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> quantity, item_price
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> quantity <span style="color:#fff;font-weight:bold">DESC</span>,item_price <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="检查-sql-语句">检查 SQL 语句<a hidden class="anchor" aria-hidden="true" href="#检查-sql-语句">#</a></h3>
<p>有 <code>Vendors</code> 表：</p>
<table>
<thead>
<tr>
<th>vend_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>海底捞</td>
</tr>
<tr>
<td>小龙坎</td>
</tr>
<tr>
<td>大龙燚</td>
</tr>
</tbody>
</table>
<p>下面的 SQL 语句有问题吗？尝试将它改正确，使之能够正确运行，并且返回结果根据<code>vend_name</code> 逆序排列。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> vend_name,
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Vendors
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> vend_name <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>改正后：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> vend_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Vendors
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> vend_name <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>知识点：</p>
<ul>
<li>逗号作用是用来隔开列与列之间的。</li>
<li>ORDER BY 是有 BY 的，需要撰写完整，且位置正确。</li>
</ul>
<h2 id="过滤数据">过滤数据<a hidden class="anchor" aria-hidden="true" href="#过滤数据">#</a></h2>
<p><code>WHERE</code> 可以过滤返回的数据。</p>
<p>下面的运算符可以在 <code>WHERE</code> 子句中使用：</p>
<table>
<thead>
<tr>
<th style="text-align:left">运算符</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">=</td>
<td style="text-align:left">等于</td>
</tr>
<tr>
<td style="text-align:left">&lt;&gt;</td>
<td style="text-align:left">不等于。 <strong>注释：</strong> 在 SQL 的一些版本中，该操作符可被写成 !=</td>
</tr>
<tr>
<td style="text-align:left">&gt;</td>
<td style="text-align:left">大于</td>
</tr>
<tr>
<td style="text-align:left">&lt;</td>
<td style="text-align:left">小于</td>
</tr>
<tr>
<td style="text-align:left">&gt;=</td>
<td style="text-align:left">大于等于</td>
</tr>
<tr>
<td style="text-align:left">&lt;=</td>
<td style="text-align:left">小于等于</td>
</tr>
<tr>
<td style="text-align:left">BETWEEN</td>
<td style="text-align:left">在某个范围内</td>
</tr>
<tr>
<td style="text-align:left">LIKE</td>
<td style="text-align:left">搜索某种模式</td>
</tr>
<tr>
<td style="text-align:left">IN</td>
<td style="text-align:left">指定针对某个列的多个可能值</td>
</tr>
</tbody>
</table>
<h3 id="返回固定价格的产品">返回固定价格的产品<a hidden class="anchor" aria-hidden="true" href="#返回固定价格的产品">#</a></h3>
<p>有表 <code>Products</code>：</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>prod_name</th>
<th>prod_price</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0018</td>
<td>sockets</td>
<td>9.49</td>
</tr>
<tr>
<td>a0019</td>
<td>iphone13</td>
<td>600</td>
</tr>
<tr>
<td>b0018</td>
<td>gucci t-shirts</td>
<td>1000</td>
</tr>
</tbody>
</table>
<p>【问题】从 <code>Products</code> 表中检索产品 ID（<code>prod_id</code>）和产品名称（<code>prod_name</code>），只返回价格为 9.49 美元的产品。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_id, prod_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_price = <span style="color:#ff0;font-weight:bold">9</span>.<span style="color:#ff0;font-weight:bold">49</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回更高价格的产品">返回更高价格的产品<a hidden class="anchor" aria-hidden="true" href="#返回更高价格的产品">#</a></h3>
<p>有表 <code>Products</code>：</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>prod_name</th>
<th>prod_price</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0018</td>
<td>sockets</td>
<td>9.49</td>
</tr>
<tr>
<td>a0019</td>
<td>iphone13</td>
<td>600</td>
</tr>
<tr>
<td>b0019</td>
<td>gucci t-shirts</td>
<td>1000</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，从 <code>Products</code> 表中检索产品 ID（<code>prod_id</code>）和产品名称（<code>prod_name</code>），只返回价格为 9 美元或更高的产品。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_id, prod_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_price &gt;= <span style="color:#ff0;font-weight:bold">9</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回产品并且按照价格排序">返回产品并且按照价格排序<a hidden class="anchor" aria-hidden="true" href="#返回产品并且按照价格排序">#</a></h3>
<p>有表 <code>Products</code>：</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>prod_name</th>
<th>prod_price</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0011</td>
<td>egg</td>
<td>3</td>
</tr>
<tr>
<td>a0019</td>
<td>sockets</td>
<td>4</td>
</tr>
<tr>
<td>b0019</td>
<td>coffee</td>
<td>15</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，返回 <code>Products</code> 表中所有价格在 3 美元到 6 美元之间的产品的名称（<code>prod_name</code>）和价格（<code>prod_price</code>），然后按价格对结果进行排序。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_name, prod_price
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_price <span style="color:#fff;font-weight:bold">BETWEEN</span> <span style="color:#ff0;font-weight:bold">3</span> <span style="color:#fff;font-weight:bold">AND</span> <span style="color:#ff0;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> prod_price
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">或者</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_name, prod_price
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_price &gt;= <span style="color:#ff0;font-weight:bold">3</span> <span style="color:#fff;font-weight:bold">AND</span> prod_price &lt;= <span style="color:#ff0;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> prod_price
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回更多的产品">返回更多的产品<a hidden class="anchor" aria-hidden="true" href="#返回更多的产品">#</a></h3>
<p><code>OrderItems</code> 表含有：订单号 <code>order_num</code>，<code>quantity</code>产品数量</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>105</td>
</tr>
<tr>
<td>a2</td>
<td>1100</td>
</tr>
<tr>
<td>a2</td>
<td>200</td>
</tr>
<tr>
<td>a4</td>
<td>1121</td>
</tr>
<tr>
<td>a5</td>
<td>10</td>
</tr>
<tr>
<td>a2</td>
<td>19</td>
</tr>
<tr>
<td>a7</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>【问题】从 <code>OrderItems</code> 表中检索出所有不同且不重复的订单号（<code>order_num</code>），其中每个订单都要包含 100 个或更多的产品。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">SUM</span>(quantity) &gt;= <span style="color:#ff0;font-weight:bold">100</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="高级数据过滤">高级数据过滤<a hidden class="anchor" aria-hidden="true" href="#高级数据过滤">#</a></h2>
<p><code>AND</code> 和 <code>OR</code> 运算符用于基于一个以上的条件对记录进行过滤，两者可以结合使用。<code>AND</code> 必须 2 个条件都成立，<code>OR</code>只要 2 个条件中的一个成立即可。</p>
<h3 id="检索供应商名称">检索供应商名称<a hidden class="anchor" aria-hidden="true" href="#检索供应商名称">#</a></h3>
<p><code>Vendors</code> 表有字段供应商名称（<code>vend_name</code>）、供应商国家（<code>vend_country</code>）、供应商州（<code>vend_state</code>）</p>
<table>
<thead>
<tr>
<th>vend_name</th>
<th>vend_country</th>
<th>vend_state</th>
</tr>
</thead>
<tbody>
<tr>
<td>apple</td>
<td>USA</td>
<td>CA</td>
</tr>
<tr>
<td>vivo</td>
<td>CNA</td>
<td>shenzhen</td>
</tr>
<tr>
<td>huawei</td>
<td>CNA</td>
<td>xian</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，从 <code>Vendors</code> 表中检索供应商名称（<code>vend_name</code>），仅返回加利福尼亚州的供应商（这需要按国家[USA]和州[CA]进行过滤，没准其他国家也存在一个 CA）</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> vend_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Vendors
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> vend_country = <span style="color:#0ff;font-weight:bold">&#39;USA&#39;</span> <span style="color:#fff;font-weight:bold">AND</span> vend_state = <span style="color:#0ff;font-weight:bold">&#39;CA&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="检索并列出已订购产品的清单-1">检索并列出已订购产品的清单<a hidden class="anchor" aria-hidden="true" href="#检索并列出已订购产品的清单-1">#</a></h3>
<p><code>OrderItems</code> 表包含了所有已订购的产品（有些已被订购多次）。</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>order_num</th>
<th>quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>BR01</td>
<td>a1</td>
<td>105</td>
</tr>
<tr>
<td>BR02</td>
<td>a2</td>
<td>1100</td>
</tr>
<tr>
<td>BR02</td>
<td>a2</td>
<td>200</td>
</tr>
<tr>
<td>BR03</td>
<td>a4</td>
<td>1121</td>
</tr>
<tr>
<td>BR017</td>
<td>a5</td>
<td>10</td>
</tr>
<tr>
<td>BR02</td>
<td>a2</td>
<td>19</td>
</tr>
<tr>
<td>BR017</td>
<td>a7</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，查找所有订购了数量至少 100 个的 <code>BR01</code>、<code>BR02</code> 或 <code>BR03</code> 的订单。你需要返回 <code>OrderItems</code> 表的订单号（<code>order_num</code>）、产品 ID（<code>prod_id</code>）和数量（<code>quantity</code>），并按产品 ID 和数量进行过滤。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> order_num, prod_id, quantity
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_id <span style="color:#fff;font-weight:bold">IN</span> (<span style="color:#0ff;font-weight:bold">&#39;BR01&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;BR02&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;BR03&#39;</span>) <span style="color:#fff;font-weight:bold">AND</span> quantity &gt;= <span style="color:#ff0;font-weight:bold">100</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回所有价格在-3-美元到-6-美元之间的产品的名称和价格">返回所有价格在 3 美元到 6 美元之间的产品的名称和价格<a hidden class="anchor" aria-hidden="true" href="#返回所有价格在-3-美元到-6-美元之间的产品的名称和价格">#</a></h3>
<p>有表 <code>Products</code>：</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>prod_name</th>
<th>prod_price</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0011</td>
<td>egg</td>
<td>3</td>
</tr>
<tr>
<td>a0019</td>
<td>sockets</td>
<td>4</td>
</tr>
<tr>
<td>b0019</td>
<td>coffee</td>
<td>15</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，返回所有价格在 3 美元到 6 美元之间的产品的名称（<code>prod_name</code>）和价格（<code>prod_price</code>），使用 AND 操作符，然后按价格对结果进行升序排序。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_name, prod_price
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_price &gt;= <span style="color:#ff0;font-weight:bold">3</span> <span style="color:#fff;font-weight:bold">and</span> prod_price &lt;= <span style="color:#ff0;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> prod_price
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="检查-sql-语句-1">检查 SQL 语句<a hidden class="anchor" aria-hidden="true" href="#检查-sql-语句-1">#</a></h3>
<p>供应商表 <code>Vendors</code> 有字段供应商名称 <code>vend_name</code>、供应商国家 <code>vend_country</code>、供应商省份 <code>vend_state</code></p>
<table>
<thead>
<tr>
<th>vend_name</th>
<th>vend_country</th>
<th>vend_state</th>
</tr>
</thead>
<tbody>
<tr>
<td>apple</td>
<td>USA</td>
<td>CA</td>
</tr>
<tr>
<td>vivo</td>
<td>CNA</td>
<td>shenzhen</td>
</tr>
<tr>
<td>huawei</td>
<td>CNA</td>
<td>xian</td>
</tr>
</tbody>
</table>
<p>【问题】修改正确下面 sql，使之正确返回。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> vend_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Vendors
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> vend_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> vend_country = <span style="color:#0ff;font-weight:bold">&#39;USA&#39;</span> <span style="color:#fff;font-weight:bold">AND</span> vend_state = <span style="color:#0ff;font-weight:bold">&#39;CA&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改后：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> vend_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Vendors
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> vend_country = <span style="color:#0ff;font-weight:bold">&#39;USA&#39;</span> <span style="color:#fff;font-weight:bold">AND</span> vend_state = <span style="color:#0ff;font-weight:bold">&#39;CA&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> vend_name
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ORDER BY</code> 语句必须放在 <code>WHERE</code> 之后。</p>
<h2 id="用通配符进行过滤">用通配符进行过滤<a hidden class="anchor" aria-hidden="true" href="#用通配符进行过滤">#</a></h2>
<p>SQL 通配符必须与 <code>LIKE</code> 运算符一起使用</p>
<p>在 SQL 中，可使用以下通配符：</p>
<table>
<thead>
<tr>
<th style="text-align:left">通配符</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>%</code></td>
<td style="text-align:left">代表零个或多个字符</td>
</tr>
<tr>
<td style="text-align:left"><code>_</code></td>
<td style="text-align:left">仅替代一个字符</td>
</tr>
<tr>
<td style="text-align:left"><code>[charlist]</code></td>
<td style="text-align:left">字符列中的任何单一字符</td>
</tr>
<tr>
<td style="text-align:left"><code>[^charlist]</code> 或者 <code>[!charlist]</code></td>
<td style="text-align:left">不在字符列中的任何单一字符</td>
</tr>
</tbody>
</table>
<h3 id="检索产品名称和描述一">检索产品名称和描述（一）<a hidden class="anchor" aria-hidden="true" href="#检索产品名称和描述一">#</a></h3>
<p><code>Products</code> 表如下：</p>
<table>
<thead>
<tr>
<th>prod_name</th>
<th>prod_desc</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0011</td>
<td>usb</td>
</tr>
<tr>
<td>a0019</td>
<td>iphone13</td>
</tr>
<tr>
<td>b0019</td>
<td>gucci t-shirts</td>
</tr>
<tr>
<td>c0019</td>
<td>gucci toy</td>
</tr>
<tr>
<td>d0019</td>
<td>lego toy</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，从 <code>Products</code> 表中检索产品名称（<code>prod_name</code>）和描述（<code>prod_desc</code>），仅返回描述中包含 <code>toy</code> 一词的产品名称。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_name, prod_desc
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_desc <span style="color:#fff;font-weight:bold">LIKE</span> <span style="color:#0ff;font-weight:bold">&#39;%toy%&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="检索产品名称和描述二">检索产品名称和描述（二）<a hidden class="anchor" aria-hidden="true" href="#检索产品名称和描述二">#</a></h3>
<p><code>Products</code> 表如下：</p>
<table>
<thead>
<tr>
<th>prod_name</th>
<th>prod_desc</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0011</td>
<td>usb</td>
</tr>
<tr>
<td>a0019</td>
<td>iphone13</td>
</tr>
<tr>
<td>b0019</td>
<td>gucci t-shirts</td>
</tr>
<tr>
<td>c0019</td>
<td>gucci toy</td>
</tr>
<tr>
<td>d0019</td>
<td>lego toy</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，从 <code>Products</code> 表中检索产品名称（<code>prod_name</code>）和描述（<code>prod_desc</code>），仅返回描述中未出现 <code>toy</code> 一词的产品，最后按”产品名称“对结果进行排序。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_name, prod_desc
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_desc <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">LIKE</span> <span style="color:#0ff;font-weight:bold">&#39;%toy%&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> prod_name
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="检索产品名称和描述三">检索产品名称和描述（三）<a hidden class="anchor" aria-hidden="true" href="#检索产品名称和描述三">#</a></h3>
<p><code>Products</code> 表如下：</p>
<table>
<thead>
<tr>
<th>prod_name</th>
<th>prod_desc</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0011</td>
<td>usb</td>
</tr>
<tr>
<td>a0019</td>
<td>iphone13</td>
</tr>
<tr>
<td>b0019</td>
<td>gucci t-shirts</td>
</tr>
<tr>
<td>c0019</td>
<td>gucci toy</td>
</tr>
<tr>
<td>d0019</td>
<td>lego carrots toy</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，从 <code>Products</code> 表中检索产品名称（<code>prod_name</code>）和描述（<code>prod_desc</code>），仅返回描述中同时出现 <code>toy</code> 和 <code>carrots</code> 的产品。有好几种方法可以执行此操作，但对于这个挑战题，请使用 <code>AND</code> 和两个 <code>LIKE</code> 比较。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_name, prod_desc
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_desc <span style="color:#fff;font-weight:bold">LIKE</span> <span style="color:#0ff;font-weight:bold">&#39;%toy%&#39;</span> <span style="color:#fff;font-weight:bold">AND</span> prod_desc <span style="color:#fff;font-weight:bold">LIKE</span> <span style="color:#0ff;font-weight:bold">&#34;%carrots%&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="检索产品名称和描述四">检索产品名称和描述（四）<a hidden class="anchor" aria-hidden="true" href="#检索产品名称和描述四">#</a></h3>
<p><code>Products</code> 表如下：</p>
<table>
<thead>
<tr>
<th>prod_name</th>
<th>prod_desc</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0011</td>
<td>usb</td>
</tr>
<tr>
<td>a0019</td>
<td>iphone13</td>
</tr>
<tr>
<td>b0019</td>
<td>gucci t-shirts</td>
</tr>
<tr>
<td>c0019</td>
<td>gucci toy</td>
</tr>
<tr>
<td>d0019</td>
<td>lego toy carrots</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，从 Products 表中检索产品名称（prod_name）和描述（prod_desc），仅返回在描述中以<strong>先后顺序</strong>同时出现 toy 和 carrots 的产品。提示：只需要用带有三个 <code>%</code> 符号的 <code>LIKE</code> 即可。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_name, prod_desc
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_desc <span style="color:#fff;font-weight:bold">LIKE</span> <span style="color:#0ff;font-weight:bold">&#39;%toy%carrots%&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="创建计算字段">创建计算字段<a hidden class="anchor" aria-hidden="true" href="#创建计算字段">#</a></h2>
<h3 id="别名">别名<a hidden class="anchor" aria-hidden="true" href="#别名">#</a></h3>
<p>别名的常见用法是在检索出的结果中重命名表的列字段（为了符合特定的报表要求或客户需求）。有表 <code>Vendors</code> 代表供应商信息，<code>vend_id</code> 供应商 id、<code>vend_name</code> 供应商名称、<code>vend_address</code> 供应商地址、<code>vend_city</code> 供应商城市。</p>
<table>
<thead>
<tr>
<th>vend_id</th>
<th>vend_name</th>
<th>vend_address</th>
<th>vend_city</th>
</tr>
</thead>
<tbody>
<tr>
<td>a001</td>
<td>tencent cloud</td>
<td>address1</td>
<td>shenzhen</td>
</tr>
<tr>
<td>a002</td>
<td>huawei cloud</td>
<td>address2</td>
<td>dongguan</td>
</tr>
<tr>
<td>a003</td>
<td>aliyun cloud</td>
<td>address3</td>
<td>hangzhou</td>
</tr>
<tr>
<td>a003</td>
<td>netease cloud</td>
<td>address4</td>
<td>guangzhou</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，从 <code>Vendors</code> 表中检索 <code>vend_id</code>、<code>vend_name</code>、<code>vend_address</code> 和 <code>vend_city</code>，将 <code>vend_name</code> 重命名为 <code>vname</code>，将 <code>vend_city</code> 重命名为 <code>vcity</code>，将 <code>vend_address</code> 重命名为 <code>vaddress</code>，按供应商名称对结果进行升序排序。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> vend_id, vend_name <span style="color:#fff;font-weight:bold">AS</span> vname, vend_address <span style="color:#fff;font-weight:bold">AS</span> vaddress, vend_city <span style="color:#fff;font-weight:bold">AS</span> vcity
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Vendors
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> vname
</span></span><span style="display:flex;"><span># <span style="color:#fff;font-weight:bold">as</span> <span style="color:#f00">可以省略</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> vend_id, vend_name vname, vend_address vaddress, vend_city vcity
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Vendors
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> vname
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="打折">打折<a hidden class="anchor" aria-hidden="true" href="#打折">#</a></h3>
<p>我们的示例商店正在进行打折促销，所有产品均降价 10%。<code>Products</code> 表包含 <code>prod_id</code> 产品 id、<code>prod_price</code> 产品价格。</p>
<p>【问题】编写 SQL 语句，从 <code>Products</code> 表中返回 <code>prod_id</code>、<code>prod_price</code> 和 <code>sale_price</code>。<code>sale_price</code> 是一个包含促销价格的计算字段。提示：可以乘以 0.9，得到原价的 90%（即 10%的折扣）。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_id, prod_price, prod_price * <span style="color:#ff0;font-weight:bold">0</span>.<span style="color:#ff0;font-weight:bold">9</span> <span style="color:#fff;font-weight:bold">AS</span> sale_price
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意：<code>sale_price</code> 是对计算结果的命名，而不是原有的列名。</p>
<h2 id="使用函数处理数据">使用函数处理数据<a hidden class="anchor" aria-hidden="true" href="#使用函数处理数据">#</a></h2>
<h3 id="顾客登录名">顾客登录名<a hidden class="anchor" aria-hidden="true" href="#顾客登录名">#</a></h3>
<p>我们的商店已经上线了，正在创建顾客账户。所有用户都需要登录名，默认登录名是其名称和所在城市的组合。</p>
<p>给出 <code>Customers</code> 表 如下：</p>
<table>
<thead>
<tr>
<th>cust_id</th>
<th>cust_name</th>
<th>cust_contact</th>
<th>cust_city</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>Andy Li</td>
<td>Andy Li</td>
<td>Oak Park</td>
</tr>
<tr>
<td>a2</td>
<td>Ben Liu</td>
<td>Ben Liu</td>
<td>Oak Park</td>
</tr>
<tr>
<td>a3</td>
<td>Tony Dai</td>
<td>Tony Dai</td>
<td>Oak Park</td>
</tr>
<tr>
<td>a4</td>
<td>Tom Chen</td>
<td>Tom Chen</td>
<td>Oak Park</td>
</tr>
<tr>
<td>a5</td>
<td>An Li</td>
<td>An Li</td>
<td>Oak Park</td>
</tr>
<tr>
<td>a6</td>
<td>Lee Chen</td>
<td>Lee Chen</td>
<td>Oak Park</td>
</tr>
<tr>
<td>a7</td>
<td>Hex Liu</td>
<td>Hex Liu</td>
<td>Oak Park</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，返回顾客 ID（<code>cust_id</code>）、顾客名称（<code>cust_name</code>）和登录名（<code>user_login</code>），其中登录名全部为大写字母，并由顾客联系人的前两个字符（<code>cust_contact</code>）和其所在城市的前三个字符（<code>cust_city</code>）组成。提示：需要使用函数、拼接和别名。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_id, cust_name, <span style="color:#fff;font-weight:bold">UPPER</span>(CONCAT(<span style="color:#fff;font-weight:bold">SUBSTRING</span>(cust_contact, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">2</span>), <span style="color:#fff;font-weight:bold">SUBSTRING</span>(cust_city, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">3</span>))) <span style="color:#fff;font-weight:bold">AS</span> user_login
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span></code></pre></td></tr></table>
</div>
</div><p>知识点：</p>
<ul>
<li>截取函数<code>SUBSTRING()</code>：截取字符串，<code>substring(str ,n ,m)</code>（n 表示起始截取位置，m 表示要截取的字符个数）表示返回字符串 str 从第 n 个字符开始截取 m 个字符；</li>
<li>拼接函数<code>CONCAT()</code>：将两个或多个字符串连接成一个字符串，select concat(A,B)：连接字符串 A 和 B。</li>
<li>大写函数 <code>UPPER()</code>：将指定字符串转换为大写。</li>
</ul>
<h3 id="返回-2020-年-1-月的所有订单的订单号和订单日期">返回 2020 年 1 月的所有订单的订单号和订单日期<a hidden class="anchor" aria-hidden="true" href="#返回-2020-年-1-月的所有订单的订单号和订单日期">#</a></h3>
<p><code>Orders</code> 订单表如下：</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>order_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>2020-01-01 00:00:00</td>
</tr>
<tr>
<td>a0002</td>
<td>2020-01-02 00:00:00</td>
</tr>
<tr>
<td>a0003</td>
<td>2020-01-01 12:00:00</td>
</tr>
<tr>
<td>a0004</td>
<td>2020-02-01 00:00:00</td>
</tr>
<tr>
<td>a0005</td>
<td>2020-03-01 00:00:00</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，返回 2020 年 1 月的所有订单的订单号（<code>order_num</code>）和订单日期（<code>order_date</code>），并按订单日期升序排序</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> order_num, order_date
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Orders
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">month</span>(order_date) = <span style="color:#0ff;font-weight:bold">&#39;01&#39;</span> <span style="color:#fff;font-weight:bold">AND</span> <span style="color:#fff;font-weight:bold">YEAR</span>(order_date) = <span style="color:#0ff;font-weight:bold">&#39;2020&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> order_date
</span></span></code></pre></td></tr></table>
</div>
</div><p>也可以用通配符来做：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> order_num, order_date
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Orders
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> order_date <span style="color:#fff;font-weight:bold">LIKE</span> <span style="color:#0ff;font-weight:bold">&#39;2020-01%&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> order_date
</span></span></code></pre></td></tr></table>
</div>
</div><p>知识点：</p>
<ul>
<li>日期格式：<code>YYYY-MM-DD</code></li>
<li>时间格式：<code>HH:MM:SS</code></li>
</ul>
<p>日期和时间处理相关的常用函数：</p>
<table>
<thead>
<tr>
<th>函 数</th>
<th>说 明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ADDDATE()</code></td>
<td>增加一个日期（天、周等）</td>
</tr>
<tr>
<td><code>ADDTIME()</code></td>
<td>增加一个时间（时、分等）</td>
</tr>
<tr>
<td><code>CURDATE()</code></td>
<td>返回当前日期</td>
</tr>
<tr>
<td><code>CURTIME()</code></td>
<td>返回当前时间</td>
</tr>
<tr>
<td><code>DATE()</code></td>
<td>返回日期时间的日期部分</td>
</tr>
<tr>
<td><code>DATEDIFF</code></td>
<td>计算两个日期之差</td>
</tr>
<tr>
<td><code>DATE_FORMAT()</code></td>
<td>返回一个格式化的日期或时间串</td>
</tr>
<tr>
<td><code>DAY()</code></td>
<td>返回一个日期的天数部分</td>
</tr>
<tr>
<td><code>DAYOFWEEK()</code></td>
<td>对于一个日期，返回对应的星期几</td>
</tr>
<tr>
<td><code>HOUR()</code></td>
<td>返回一个时间的小时部分</td>
</tr>
<tr>
<td><code>MINUTE()</code></td>
<td>返回一个时间的分钟部分</td>
</tr>
<tr>
<td><code>MONTH()</code></td>
<td>返回一个日期的月份部分</td>
</tr>
<tr>
<td><code>NOW()</code></td>
<td>返回当前日期和时间</td>
</tr>
<tr>
<td><code>SECOND()</code></td>
<td>返回一个时间的秒部分</td>
</tr>
<tr>
<td><code>TIME()</code></td>
<td>返回一个日期时间的时间部分</td>
</tr>
<tr>
<td><code>YEAR()</code></td>
<td>返回一个日期的年份部分</td>
</tr>
</tbody>
</table>
<h2 id="汇总数据">汇总数据<a hidden class="anchor" aria-hidden="true" href="#汇总数据">#</a></h2>
<p>汇总数据相关的函数：</p>
<table>
<thead>
<tr>
<th>函 数</th>
<th>说 明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AVG()</code></td>
<td>返回某列的平均值</td>
</tr>
<tr>
<td><code>COUNT()</code></td>
<td>返回某列的行数</td>
</tr>
<tr>
<td><code>MAX()</code></td>
<td>返回某列的最大值</td>
</tr>
<tr>
<td><code>MIN()</code></td>
<td>返回某列的最小值</td>
</tr>
<tr>
<td><code>SUM()</code></td>
<td>返回某列值之和</td>
</tr>
</tbody>
</table>
<h3 id="确定已售出产品的总数">确定已售出产品的总数<a hidden class="anchor" aria-hidden="true" href="#确定已售出产品的总数">#</a></h3>
<p><code>OrderItems</code> 表代表售出的产品，<code>quantity</code> 代表售出商品数量。</p>
<table>
<thead>
<tr>
<th>quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
</tr>
<tr>
<td>100</td>
</tr>
<tr>
<td>1000</td>
</tr>
<tr>
<td>10001</td>
</tr>
<tr>
<td>2</td>
</tr>
<tr>
<td>15</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，确定已售出产品的总数。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">Sum</span>(quantity) <span style="color:#fff;font-weight:bold">AS</span> items_ordered
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="确定已售出产品项-br01-的总数">确定已售出产品项 BR01 的总数<a hidden class="anchor" aria-hidden="true" href="#确定已售出产品项-br01-的总数">#</a></h3>
<p><code>OrderItems</code> 表代表售出的产品，<code>quantity</code> 代表售出商品数量，产品项为 <code>prod_id</code>。</p>
<table>
<thead>
<tr>
<th>quantity</th>
<th>prod_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>AR01</td>
</tr>
<tr>
<td>100</td>
<td>AR10</td>
</tr>
<tr>
<td>1000</td>
<td>BR01</td>
</tr>
<tr>
<td>10001</td>
<td>BR010</td>
</tr>
</tbody>
</table>
<p>【问题】修改创建的语句，确定已售出产品项（<code>prod_id</code>）为&quot;BR01&quot;的总数。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">Sum</span>(quantity) <span style="color:#fff;font-weight:bold">AS</span> items_ordered
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_id = <span style="color:#0ff;font-weight:bold">&#39;BR01&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="确定-products-表中价格不超过-10-美元的最贵产品的价格">确定 Products 表中价格不超过 10 美元的最贵产品的价格<a hidden class="anchor" aria-hidden="true" href="#确定-products-表中价格不超过-10-美元的最贵产品的价格">#</a></h3>
<p><code>Products</code> 表如下，<code>prod_price</code> 代表商品的价格。</p>
<table>
<thead>
<tr>
<th>prod_price</th>
</tr>
</thead>
<tbody>
<tr>
<td>9.49</td>
</tr>
<tr>
<td>600</td>
</tr>
<tr>
<td>1000</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，确定 <code>Products</code> 表中价格不超过 10 美元的最贵产品的价格（<code>prod_price</code>）。将计算所得的字段命名为 <code>max_price</code>。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">Max</span>(prod_price) <span style="color:#fff;font-weight:bold">AS</span> max_price
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_price &lt;= <span style="color:#ff0;font-weight:bold">10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="分组数据">分组数据<a hidden class="anchor" aria-hidden="true" href="#分组数据">#</a></h2>
<p><code>GROUP BY</code>：</p>
<ul>
<li><code>GROUP BY</code> 子句将记录分组到汇总行中。</li>
<li><code>GROUP BY</code> 为每个组返回一个记录。</li>
<li><code>GROUP BY</code> 通常还涉及聚合<code>COUNT</code>，<code>MAX</code>，<code>SUM</code>，<code>AVG</code> 等。</li>
<li><code>GROUP BY</code> 可以按一列或多列进行分组。</li>
<li><code>GROUP BY</code> 按分组字段进行排序后，<code>ORDER BY</code> 可以以汇总字段来进行排序。</li>
</ul>
<p><code>HAVING</code>：</p>
<ul>
<li><code>HAVING</code> 用于对汇总的 <code>GROUP BY</code> 结果进行过滤。</li>
<li><code>HAVING</code> 必须要与 <code>GROUP BY</code> 连用。</li>
<li><code>WHERE</code> 和 <code>HAVING</code> 可以在相同的查询中。</li>
</ul>
<p><code>HAVING</code> vs <code>WHERE</code>：</p>
<ul>
<li><code>WHERE</code>：过滤指定的行，后面不能加聚合函数（分组函数）。</li>
<li><code>HAVING</code>：过滤分组，必须要与 <code>GROUP BY</code> 连用，不能单独使用。</li>
</ul>
<h3 id="返回每个订单号各有多少行数">返回每个订单号各有多少行数<a hidden class="anchor" aria-hidden="true" href="#返回每个订单号各有多少行数">#</a></h3>
<p><code>OrderItems</code> 表包含每个订单的每个产品</p>
<table>
<thead>
<tr>
<th>order_num</th>
</tr>
</thead>
<tbody>
<tr>
<td>a002</td>
</tr>
<tr>
<td>a002</td>
</tr>
<tr>
<td>a002</td>
</tr>
<tr>
<td>a004</td>
</tr>
<tr>
<td>a007</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，返回每个订单号（<code>order_num</code>）各有多少行数（<code>order_lines</code>），并按 <code>order_lines</code> 对结果进行升序排序。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> order_num, <span style="color:#fff;font-weight:bold">Count</span>(order_num) <span style="color:#fff;font-weight:bold">AS</span> order_lines
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> order_lines
</span></span></code></pre></td></tr></table>
</div>
</div><p>知识点：</p>
<ol>
<li><code>count(*)</code>,<code>count(列名)</code>都可以，区别在于，<code>count(列名)</code>是统计非 NULL 的行数；</li>
<li><code>order by</code> 最后执行，所以可以使用列别名；</li>
<li>分组聚合一定不要忘记加上 <code>group by</code> ,不然只会有一行结果。</li>
</ol>
<h3 id="每个供应商成本最低的产品">每个供应商成本最低的产品<a hidden class="anchor" aria-hidden="true" href="#每个供应商成本最低的产品">#</a></h3>
<p>有 <code>Products</code> 表，含有字段 <code>prod_price</code> 代表产品价格，<code>vend_id</code> 代表供应商 id</p>
<table>
<thead>
<tr>
<th>vend_id</th>
<th>prod_price</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0011</td>
<td>100</td>
</tr>
<tr>
<td>a0019</td>
<td>0.1</td>
</tr>
<tr>
<td>b0019</td>
<td>1000</td>
</tr>
<tr>
<td>b0019</td>
<td>6980</td>
</tr>
<tr>
<td>b0019</td>
<td>20</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，返回名为 <code>cheapest_item</code> 的字段，该字段包含每个供应商成本最低的产品（使用 <code>Products</code> 表中的 <code>prod_price</code>），然后从最低成本到最高成本对结果进行升序排序。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> vend_id, <span style="color:#fff;font-weight:bold">Min</span>(prod_price) <span style="color:#fff;font-weight:bold">AS</span> cheapest_item
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> vend_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> cheapest_item
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回订单数量总和不小于-100-的所有订单的订单号">返回订单数量总和不小于 100 的所有订单的订单号<a hidden class="anchor" aria-hidden="true" href="#返回订单数量总和不小于-100-的所有订单的订单号">#</a></h3>
<p><code>OrderItems</code> 代表订单商品表，包括：订单号 <code>order_num</code> 和订单数量 <code>quantity</code>。</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>105</td>
</tr>
<tr>
<td>a2</td>
<td>1100</td>
</tr>
<tr>
<td>a2</td>
<td>200</td>
</tr>
<tr>
<td>a4</td>
<td>1121</td>
</tr>
<tr>
<td>a5</td>
<td>10</td>
</tr>
<tr>
<td>a2</td>
<td>19</td>
</tr>
<tr>
<td>a7</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>【问题】请编写 SQL 语句，返回订单数量总和不小于 100 的所有订单号，最后结果按照订单号升序排序。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#f00">直接聚合</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">Sum</span>(quantity) &gt;= <span style="color:#ff0;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> order_num
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">子查询</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> a.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> (<span style="color:#fff;font-weight:bold">SELECT</span> order_num, <span style="color:#fff;font-weight:bold">Sum</span>(quantity) <span style="color:#fff;font-weight:bold">AS</span> sum_num
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> order_num
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">HAVING</span> sum_num &gt;= <span style="color:#ff0;font-weight:bold">100</span>) a
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> a.order_num
</span></span></code></pre></td></tr></table>
</div>
</div><p>知识点：</p>
<ul>
<li><code>where</code>：过滤过滤指定的行，后面不能加聚合函数（分组函数）。</li>
<li><code>having</code>：过滤分组，与 <code>group by</code> 连用，不能单独使用。</li>
</ul>
<h3 id="计算总和">计算总和<a hidden class="anchor" aria-hidden="true" href="#计算总和">#</a></h3>
<p><code>OrderItems</code> 表代表订单信息，包括字段：订单号 <code>order_num</code> 和 <code>item_price</code> 商品售出价格、<code>quantity</code> 商品数量。</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>item_price</th>
<th>quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>10</td>
<td>105</td>
</tr>
<tr>
<td>a2</td>
<td>1</td>
<td>1100</td>
</tr>
<tr>
<td>a2</td>
<td>1</td>
<td>200</td>
</tr>
<tr>
<td>a4</td>
<td>2</td>
<td>1121</td>
</tr>
<tr>
<td>a5</td>
<td>5</td>
<td>10</td>
</tr>
<tr>
<td>a2</td>
<td>1</td>
<td>19</td>
</tr>
<tr>
<td>a7</td>
<td>7</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，根据订单号聚合，返回订单总价不小于 1000 的所有订单号，最后的结果按订单号进行升序排序。</p>
<p>提示：总价 = item_price 乘以 quantity</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> order_num, <span style="color:#fff;font-weight:bold">Sum</span>(item_price * quantity) <span style="color:#fff;font-weight:bold">AS</span> total_price
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> total_price &gt;= <span style="color:#ff0;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> order_num
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="检查-sql-语句-2">检查 SQL 语句<a hidden class="anchor" aria-hidden="true" href="#检查-sql-语句-2">#</a></h3>
<p><code>OrderItems</code> 表含有 <code>order_num</code> 订单号</p>
<table>
<thead>
<tr>
<th>order_num</th>
</tr>
</thead>
<tbody>
<tr>
<td>a002</td>
</tr>
<tr>
<td>a002</td>
</tr>
<tr>
<td>a002</td>
</tr>
<tr>
<td>a004</td>
</tr>
<tr>
<td>a007</td>
</tr>
</tbody>
</table>
<p>【问题】将下面代码修改正确后执行</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> order_num, <span style="color:#fff;font-weight:bold">COUNT</span>(*) <span style="color:#fff;font-weight:bold">AS</span> items
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> items
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">COUNT</span>(*) &gt;= <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> items, order_num;
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改后：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> order_num, <span style="color:#fff;font-weight:bold">COUNT</span>(*) <span style="color:#fff;font-weight:bold">AS</span> items
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> items &gt;= <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> items, order_num;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="使用子查询">使用子查询<a hidden class="anchor" aria-hidden="true" href="#使用子查询">#</a></h2>
<p>子查询是嵌套在较大查询中的 SQL 查询，也称内部查询或内部选择，包含子查询的语句也称为外部查询或外部选择。简单来说，子查询就是指将一个 <code>SELECT</code> 查询（子查询）的结果作为另一个 SQL 语句（主查询）的数据来源或者判断条件。</p>
<p>子查询可以嵌入 <code>SELECT</code>、<code>INSERT</code>、<code>UPDATE</code> 和 <code>DELETE</code> 语句中，也可以和 <code>=</code>、<code>&lt;</code>、<code>&gt;</code>、<code>IN</code>、<code>BETWEEN</code>、<code>EXISTS</code> 等运算符一起使用。</p>
<p>子查询常用在 <code>WHERE</code> 子句和 <code>FROM</code> 子句后边：</p>
<ul>
<li>当用于 <code>WHERE</code> 子句时，根据不同的运算符，子查询可以返回单行单列、多行单列、单行多列数据。子查询就是要返回能够作为 WHERE 子句查询条件的值。</li>
<li>当用于 <code>FROM</code> 子句时，一般返回多行多列数据，相当于返回一张临时表，这样才符合 <code>FROM</code> 后面是表的规则。这种做法能够实现多表联合查询。</li>
</ul>
<blockquote>
<p>注意：MySQL 数据库从 4.1 版本才开始支持子查询，早期版本是不支持的。</p>
</blockquote>
<p>用于 <code>WHERE</code> 子句的子查询的基本语法如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">column_name</span> [, <span style="color:#fff;font-weight:bold">column_name</span> ]
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> table1 [, table2 ]
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">column_name</span> <span style="color:#fff;font-weight:bold">operator</span>
</span></span><span style="display:flex;"><span>(<span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">column_name</span> [, <span style="color:#fff;font-weight:bold">column_name</span> ]
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> table1 [, table2 ]
</span></span><span style="display:flex;"><span>[<span style="color:#fff;font-weight:bold">WHERE</span>])
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>子查询需要放在括号<code>( )</code>内。</li>
<li><code>operator</code> 表示用于 <code>WHERE</code> 子句的运算符，可以是比较运算符（如 <code>=</code>, <code>&lt;</code>, <code>&gt;</code>, <code>&lt;&gt;</code> 等）或逻辑运算符（如 <code>IN</code>, <code>NOT IN</code>, <code>EXISTS</code>, <code>NOT EXISTS</code> 等），具体根据需求来确定。</li>
</ul>
<p>用于 <code>FROM</code> 子句的子查询的基本语法如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">column_name</span> [, <span style="color:#fff;font-weight:bold">column_name</span> ]
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> (<span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">column_name</span> [, <span style="color:#fff;font-weight:bold">column_name</span> ]
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">FROM</span> table1 [, table2 ]
</span></span><span style="display:flex;"><span>      [<span style="color:#fff;font-weight:bold">WHERE</span>]) <span style="color:#fff;font-weight:bold">AS</span> temp_table_name [, ...]
</span></span><span style="display:flex;"><span>[<span style="color:#fff;font-weight:bold">JOIN</span> <span style="color:#fff;font-weight:bold">type</span> <span style="color:#fff;font-weight:bold">JOIN</span> <span style="color:#fff;font-weight:bold">table_name</span> <span style="color:#fff;font-weight:bold">ON</span> condition]
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> condition;
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>用于 <code>FROM</code> 的子查询返回的结果相当于一张临时表，所以需要使用 AS 关键字为该临时表起一个名字。</li>
<li>子查询需要放在括号 <code>( )</code> 内。</li>
<li>可以指定多个临时表名，并使用 <code>JOIN</code> 语句连接这些表。</li>
</ul>
<h3 id="返回购买价格为-10-美元或以上产品的顾客列表">返回购买价格为 10 美元或以上产品的顾客列表<a hidden class="anchor" aria-hidden="true" href="#返回购买价格为-10-美元或以上产品的顾客列表">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>OrderItems` <span style="color:#f00">表示订单商品表，含有字段订单号：</span>`order_num`<span style="color:#f00">、订单价格：</span>`item_price`<span style="color:#f00">；</span>`Orders` <span style="color:#f00">表代表订单信息表，含有顾客</span> `id<span style="color:#f00">：</span>cust_id` <span style="color:#f00">和订单号：</span>`order_num
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>OrderItems</code> 表:</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>item_price</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>10</td>
</tr>
<tr>
<td>a2</td>
<td>1</td>
</tr>
<tr>
<td>a2</td>
<td>1</td>
</tr>
<tr>
<td>a4</td>
<td>2</td>
</tr>
<tr>
<td>a5</td>
<td>5</td>
</tr>
<tr>
<td>a2</td>
<td>1</td>
</tr>
<tr>
<td>a7</td>
<td>7</td>
</tr>
</tbody>
</table>
<p><code>Orders</code> 表：</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>cust_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>cust10</td>
</tr>
<tr>
<td>a2</td>
<td>cust1</td>
</tr>
<tr>
<td>a2</td>
<td>cust1</td>
</tr>
<tr>
<td>a4</td>
<td>cust2</td>
</tr>
<tr>
<td>a5</td>
<td>cust5</td>
</tr>
<tr>
<td>a2</td>
<td>cust1</td>
</tr>
<tr>
<td>a7</td>
<td>cust7</td>
</tr>
</tbody>
</table>
<p>【问题】使用子查询，返回购买价格为 10 美元或以上产品的顾客列表，结果无需排序。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Orders
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> order_num <span style="color:#fff;font-weight:bold">IN</span> (<span style="color:#fff;font-weight:bold">SELECT</span> order_num
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> order_num
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">Sum</span>(item_price) &gt;= <span style="color:#ff0;font-weight:bold">10</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="确定哪些订单购买了-prod_id-为-br01-的产品一">确定哪些订单购买了 prod_id 为 BR01 的产品（一）<a hidden class="anchor" aria-hidden="true" href="#确定哪些订单购买了-prod_id-为-br01-的产品一">#</a></h3>
<p>表 <code>OrderItems</code> 代表订单商品信息表，<code>prod_id</code> 为产品 id；<code>Orders</code> 表代表订单表有 <code>cust_id</code> 代表顾客 id 和订单日期 <code>order_date</code></p>
<p><code>OrderItems</code> 表：</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>order_num</th>
</tr>
</thead>
<tbody>
<tr>
<td>BR01</td>
<td>a0001</td>
</tr>
<tr>
<td>BR01</td>
<td>a0002</td>
</tr>
<tr>
<td>BR02</td>
<td>a0003</td>
</tr>
<tr>
<td>BR02</td>
<td>a0013</td>
</tr>
</tbody>
</table>
<p><code>Orders</code> 表：</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>cust_id</th>
<th>order_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>cust10</td>
<td>2022-01-01 00:00:00</td>
</tr>
<tr>
<td>a0002</td>
<td>cust1</td>
<td>2022-01-01 00:01:00</td>
</tr>
<tr>
<td>a0003</td>
<td>cust1</td>
<td>2022-01-02 00:00:00</td>
</tr>
<tr>
<td>a0013</td>
<td>cust2</td>
<td>2022-01-01 00:20:00</td>
</tr>
</tbody>
</table>
<p>【问题】</p>
<p>编写 SQL 语句，使用子查询来确定哪些订单（在 <code>OrderItems</code> 中）购买了 <code>prod_id</code> 为 &ldquo;BR01&rdquo; 的产品，然后从 <code>Orders</code> 表中返回每个产品对应的顾客 ID（<code>cust_id</code>）和订单日期（<code>order_date</code>），按订购日期对结果进行升序排序。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">1</span><span style="color:#f00">：子查询</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_id,order_date
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Orders
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> order_num <span style="color:#fff;font-weight:bold">IN</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#fff;font-weight:bold">SELECT</span> order_num
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">WHERE</span> prod_id = <span style="color:#0ff;font-weight:bold">&#39;BR01&#39;</span> )
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> order_date;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">2</span>: <span style="color:#f00">连接表</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> b.cust_id, b.order_date
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems a,Orders b
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> a.order_num = b.order_num <span style="color:#fff;font-weight:bold">AND</span> a.prod_id = <span style="color:#0ff;font-weight:bold">&#39;BR01&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> order_date
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回购买-prod_id-为-br01-的产品的所有顾客的电子邮件一">返回购买 prod_id 为 BR01 的产品的所有顾客的电子邮件（一）<a hidden class="anchor" aria-hidden="true" href="#返回购买-prod_id-为-br01-的产品的所有顾客的电子邮件一">#</a></h3>
<p>你想知道订购 BR01 产品的日期，有表 <code>OrderItems</code> 代表订单商品信息表，<code>prod_id</code> 为产品 id；<code>Orders</code> 表代表订单表有 <code>cust_id</code> 代表顾客 id 和订单日期 <code>order_date</code>；<code>Customers</code> 表含有 <code>cust_email</code> 顾客邮件和 <code>cust_id</code> 顾客 id</p>
<p><code>OrderItems</code> 表：</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>order_num</th>
</tr>
</thead>
<tbody>
<tr>
<td>BR01</td>
<td>a0001</td>
</tr>
<tr>
<td>BR01</td>
<td>a0002</td>
</tr>
<tr>
<td>BR02</td>
<td>a0003</td>
</tr>
<tr>
<td>BR02</td>
<td>a0013</td>
</tr>
</tbody>
</table>
<p><code>Orders</code> 表：</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>cust_id</th>
<th>order_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>cust10</td>
<td>2022-01-01 00:00:00</td>
</tr>
<tr>
<td>a0002</td>
<td>cust1</td>
<td>2022-01-01 00:01:00</td>
</tr>
<tr>
<td>a0003</td>
<td>cust1</td>
<td>2022-01-02 00:00:00</td>
</tr>
<tr>
<td>a0013</td>
<td>cust2</td>
<td>2022-01-01 00:20:00</td>
</tr>
</tbody>
</table>
<p><code>Customers</code> 表代表顾客信息，<code>cust_id</code> 为顾客 id，<code>cust_email</code> 为顾客 email</p>
<table>
<thead>
<tr>
<th>cust_id</th>
<th>cust_email</th>
</tr>
</thead>
<tbody>
<tr>
<td>cust10</td>
<td><a href="mailto:cust10@cust.com">cust10@cust.com</a></td>
</tr>
<tr>
<td>cust1</td>
<td><a href="mailto:cust1@cust.com">cust1@cust.com</a></td>
</tr>
<tr>
<td>cust2</td>
<td><a href="mailto:cust2@cust.com">cust2@cust.com</a></td>
</tr>
</tbody>
</table>
<p>【问题】返回购买 <code>prod_id</code> 为 <code>BR01</code> 的产品的所有顾客的电子邮件（<code>Customers</code> 表中的 <code>cust_email</code>），结果无需排序。</p>
<p>提示：这涉及 <code>SELECT</code> 语句，最内层的从 <code>OrderItems</code> 表返回 <code>order_num</code>，中间的从 <code>Customers</code> 表返回 <code>cust_id</code>。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">1</span><span style="color:#f00">：子查询</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_email
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> cust_id <span style="color:#fff;font-weight:bold">IN</span> (<span style="color:#fff;font-weight:bold">SELECT</span> cust_id
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">FROM</span> Orders
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">WHERE</span> order_num <span style="color:#fff;font-weight:bold">IN</span> (<span style="color:#fff;font-weight:bold">SELECT</span> order_num
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHERE</span> prod_id = <span style="color:#0ff;font-weight:bold">&#39;BR01&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">2</span>: <span style="color:#f00">连接表（</span><span style="color:#fff;font-weight:bold">inner</span> <span style="color:#fff;font-weight:bold">join</span><span style="color:#f00">）</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">c</span>.cust_email
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems a,Orders b,Customers <span style="color:#fff;font-weight:bold">c</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> a.order_num = b.order_num <span style="color:#fff;font-weight:bold">AND</span> b.cust_id = <span style="color:#fff;font-weight:bold">c</span>.cust_id <span style="color:#fff;font-weight:bold">AND</span> a.prod_id = <span style="color:#0ff;font-weight:bold">&#39;BR01&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">3</span><span style="color:#f00">：连接表（</span><span style="color:#fff;font-weight:bold">left</span> <span style="color:#fff;font-weight:bold">join</span><span style="color:#f00">）</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">c</span>.cust_email
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Orders a <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span>
</span></span><span style="display:flex;"><span>  OrderItems b <span style="color:#fff;font-weight:bold">ON</span> a.order_num = b.order_num <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span>
</span></span><span style="display:flex;"><span>  Customers <span style="color:#fff;font-weight:bold">c</span> <span style="color:#fff;font-weight:bold">ON</span> a.cust_id = <span style="color:#fff;font-weight:bold">c</span>.cust_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> b.prod_id = <span style="color:#0ff;font-weight:bold">&#39;BR01&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回每个顾客不同订单的总金额">返回每个顾客不同订单的总金额<a hidden class="anchor" aria-hidden="true" href="#返回每个顾客不同订单的总金额">#</a></h3>
<p>我们需要一个顾客 ID 列表，其中包含他们已订购的总金额。</p>
<p><code>OrderItems</code> 表代表订单信息，<code>OrderItems</code> 表有订单号：<code>order_num</code> 和商品售出价格：<code>item_price</code>、商品数量：<code>quantity</code>。</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>item_price</th>
<th>quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>10</td>
<td>105</td>
</tr>
<tr>
<td>a0002</td>
<td>1</td>
<td>1100</td>
</tr>
<tr>
<td>a0002</td>
<td>1</td>
<td>200</td>
</tr>
<tr>
<td>a0013</td>
<td>2</td>
<td>1121</td>
</tr>
<tr>
<td>a0003</td>
<td>5</td>
<td>10</td>
</tr>
<tr>
<td>a0003</td>
<td>1</td>
<td>19</td>
</tr>
<tr>
<td>a0003</td>
<td>7</td>
<td>5</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>Orders` <span style="color:#f00">表订单号：</span>`order_num`<span style="color:#f00">、顾客</span> id<span style="color:#f00">：</span>`cust_id
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>order_num</th>
<th>cust_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>cust10</td>
</tr>
<tr>
<td>a0002</td>
<td>cust1</td>
</tr>
<tr>
<td>a0003</td>
<td>cust1</td>
</tr>
<tr>
<td>a0013</td>
<td>cust2</td>
</tr>
</tbody>
</table>
<p>【问题】</p>
<p>编写 SQL 语句，返回顾客 ID（<code>Orders</code> 表中的 <code>cust_id</code>），并使用子查询返回 <code>total_ordered</code> 以便返回每个顾客的订单总数，将结果按金额从大到小排序。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">1</span><span style="color:#f00">：子查询</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> o.cust_id <span style="color:#fff;font-weight:bold">AS</span> cust_id, tb.total_ordered <span style="color:#fff;font-weight:bold">AS</span> total_ordered
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> (<span style="color:#fff;font-weight:bold">SELECT</span> order_num, <span style="color:#fff;font-weight:bold">Sum</span>(item_price * quantity) <span style="color:#fff;font-weight:bold">AS</span> total_ordered
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> order_num) <span style="color:#fff;font-weight:bold">AS</span> tb,
</span></span><span style="display:flex;"><span>  Orders o
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> tb.order_num = o.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> total_ordered <span style="color:#fff;font-weight:bold">DESC</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">2</span><span style="color:#f00">：连接表</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> b.cust_id, <span style="color:#fff;font-weight:bold">Sum</span>(a.quantity * a.item_price) <span style="color:#fff;font-weight:bold">AS</span> total_ordered
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems a,Orders b
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> a.order_num = b.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> cust_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> total_ordered <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="从-products-表中检索所有的产品名称以及对应的销售总数">从 Products 表中检索所有的产品名称以及对应的销售总数<a hidden class="anchor" aria-hidden="true" href="#从-products-表中检索所有的产品名称以及对应的销售总数">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>Products` <span style="color:#f00">表中检索所有的产品名称：</span>`prod_name`<span style="color:#f00">、产品</span> id<span style="color:#f00">：</span>`prod_id
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>prod_id</th>
<th>prod_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>egg</td>
</tr>
<tr>
<td>a0002</td>
<td>sockets</td>
</tr>
<tr>
<td>a0013</td>
<td>coffee</td>
</tr>
<tr>
<td>a0003</td>
<td>cola</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>OrderItems` <span style="color:#f00">代表订单商品表，订单产品：</span>`prod_id`<span style="color:#f00">、售出数量：</span>`quantity
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>prod_id</th>
<th>quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>105</td>
</tr>
<tr>
<td>a0002</td>
<td>1100</td>
</tr>
<tr>
<td>a0002</td>
<td>200</td>
</tr>
<tr>
<td>a0013</td>
<td>1121</td>
</tr>
<tr>
<td>a0003</td>
<td>10</td>
</tr>
<tr>
<td>a0003</td>
<td>19</td>
</tr>
<tr>
<td>a0003</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>【问题】</p>
<p>编写 SQL 语句，从 <code>Products</code> 表中检索所有的产品名称（<code>prod_name</code>），以及名为 <code>quant_sold</code> 的计算列，其中包含所售产品的总数（在 <code>OrderItems</code> 表上使用子查询和 <code>SUM(quantity)</code> 检索）。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">1</span><span style="color:#f00">：子查询</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> p.prod_name, tb.quant_sold
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> (<span style="color:#fff;font-weight:bold">SELECT</span> prod_id, <span style="color:#fff;font-weight:bold">Sum</span>(quantity) <span style="color:#fff;font-weight:bold">AS</span> quant_sold
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> prod_id) <span style="color:#fff;font-weight:bold">AS</span> tb,
</span></span><span style="display:flex;"><span>  Products p
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> tb.prod_id = p.prod_id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">2</span><span style="color:#f00">：连接表</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> p.prod_name, <span style="color:#fff;font-weight:bold">Sum</span>(o.quantity) <span style="color:#fff;font-weight:bold">AS</span> quant_sold
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products p,
</span></span><span style="display:flex;"><span>  OrderItems o
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> p.prod_id = o.prod_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> p.prod_name<span style="color:#f00">（这里不能用</span> p.prod_id<span style="color:#f00">，会报错）</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="连接表">连接表<a hidden class="anchor" aria-hidden="true" href="#连接表">#</a></h2>
<p>JOIN 是“连接”的意思，顾名思义，SQL JOIN 子句用于将两个或者多个表联合起来进行查询。</p>
<p>连接表时需要在每个表中选择一个字段，并对这些字段的值进行比较，值相同的两条记录将合并为一条。<strong>连接表的本质就是将不同表的记录合并起来，形成一张新表。当然，这张新表只是临时的，它仅存在于本次查询期间</strong>。</p>
<p>使用 <code>JOIN</code> 连接两个表的基本语法如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> table1.column1, table2.column2...
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> table1
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">JOIN</span> table2
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ON</span> table1.common_column1 = table2.common_column2;
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>table1.common_column1 = table2.common_column2</code> 是连接条件，只有满足此条件的记录才会合并为一行。您可以使用多个运算符来连接表，例如 =、&gt;、&lt;、&lt;&gt;、&lt;=、&gt;=、!=、<code>between</code>、<code>like</code> 或者 <code>not</code>，但是最常见的是使用 =。</p>
<p>当两个表中有同名的字段时，为了帮助数据库引擎区分是哪个表的字段，在书写同名字段名时需要加上表名。当然，如果书写的字段名在两个表中是唯一的，也可以不使用以上格式，只写字段名即可。</p>
<p>另外，如果两张表的关联字段名相同，也可以使用 <code>USING</code>子句来代替 <code>ON</code>，举个例子：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#fff;font-weight:bold">join</span>....<span style="color:#fff;font-weight:bold">on</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name, o.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers <span style="color:#fff;font-weight:bold">c</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> Orders o
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ON</span> <span style="color:#fff;font-weight:bold">c</span>.cust_id = o.cust_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">如果两张表的关联字段名相同，也可以使用</span>USING<span style="color:#f00">子句：</span><span style="color:#fff;font-weight:bold">JOIN</span>....<span style="color:#fff;font-weight:bold">USING</span>()
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name, o.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers <span style="color:#fff;font-weight:bold">c</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> Orders o
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">USING</span>(cust_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong><code>ON</code> 和 <code>WHERE</code> 的区别</strong>：</p>
<ul>
<li>连接表时，SQL 会根据连接条件生成一张新的临时表。<code>ON</code> 就是连接条件，它决定临时表的生成。</li>
<li><code>WHERE</code> 是在临时表生成以后，再对临时表中的数据进行过滤，生成最终的结果集，这个时候已经没有 JOIN-ON 了。</li>
</ul>
<p>所以总结来说就是：<strong>SQL 先根据 ON 生成一张临时表，然后再根据 WHERE 对临时表进行筛选</strong>。</p>
<p>SQL 允许在 <code>JOIN</code> 左边加上一些修饰性的关键词，从而形成不同类型的连接，如下表所示：</p>
<table>
<thead>
<tr>
<th>连接类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>INNER JOIN 内连接</td>
<td>（默认连接方式）只有当两个表都存在满足条件的记录时才会返回行。</td>
</tr>
<tr>
<td>LEFT JOIN / LEFT OUTER JOIN 左(外)连接</td>
<td>返回左表中的所有行，即使右表中没有满足条件的行也是如此。</td>
</tr>
<tr>
<td>RIGHT JOIN / RIGHT OUTER JOIN 右(外)连接</td>
<td>返回右表中的所有行，即使左表中没有满足条件的行也是如此。</td>
</tr>
<tr>
<td>FULL JOIN / FULL OUTER JOIN 全(外)连接</td>
<td>只要其中有一个表存在满足条件的记录，就返回行。</td>
</tr>
<tr>
<td>SELF JOIN</td>
<td>将一个表连接到自身，就像该表是两个表一样。为了区分两个表，在 SQL 语句中需要至少重命名一个表。</td>
</tr>
<tr>
<td>CROSS JOIN</td>
<td>交叉连接，从两个或者多个连接表中返回记录集的笛卡尔积。</td>
</tr>
</tbody>
</table>
<p>如果不加任何修饰词，只写 <code>JOIN</code>，那么默认为 <code>INNER JOIN</code></p>
<p>对于 <code>INNER JOIN</code> 来说，还有一种隐式的写法，称为 “<strong>隐式内连接</strong>”，也就是没有 <code>INNER JOIN</code> 关键字，使用 <code>WHERE</code> 语句实现内连接的功能</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#f00">隐式内连接</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name, o.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers <span style="color:#fff;font-weight:bold">c</span>,Orders o
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">c</span>.cust_id = o.cust_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">显式内连接</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name, o.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers <span style="color:#fff;font-weight:bold">c</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> Orders o
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">USING</span>(cust_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回顾客名称和相关订单号">返回顾客名称和相关订单号<a hidden class="anchor" aria-hidden="true" href="#返回顾客名称和相关订单号">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>Customers` <span style="color:#f00">表有字段顾客名称</span> `cust_name`<span style="color:#f00">、顾客</span> id `cust_id
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>cust_id</th>
<th>cust_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>cust10</td>
<td>andy</td>
</tr>
<tr>
<td>cust1</td>
<td>ben</td>
</tr>
<tr>
<td>cust2</td>
<td>tony</td>
</tr>
<tr>
<td>cust22</td>
<td>tom</td>
</tr>
<tr>
<td>cust221</td>
<td>an</td>
</tr>
<tr>
<td>cust2217</td>
<td>hex</td>
</tr>
</tbody>
</table>
<p><code>Orders</code> 订单信息表，含有字段 <code>order_num</code> 订单号、<code>cust_id</code> 顾客 id</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>cust_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>cust10</td>
</tr>
<tr>
<td>a2</td>
<td>cust1</td>
</tr>
<tr>
<td>a3</td>
<td>cust2</td>
</tr>
<tr>
<td>a4</td>
<td>cust22</td>
</tr>
<tr>
<td>a5</td>
<td>cust221</td>
</tr>
<tr>
<td>a7</td>
<td>cust2217</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，返回 <code>Customers</code> 表中的顾客名称（<code>cust_name</code>）和 <code>Orders</code> 表中的相关订单号（<code>order_num</code>），并按顾客名称再按订单号对结果进行升序排序。你可以尝试用两个不同的写法，一个使用简单的等连接语法，另外一个使用 INNER JOIN。</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#f00">隐式内连接</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name, o.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers <span style="color:#fff;font-weight:bold">c</span>,Orders o
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">c</span>.cust_id = o.cust_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name,o.order_num
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">显式内连接</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name, o.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers <span style="color:#fff;font-weight:bold">c</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> Orders o
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">USING</span>(cust_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name,o.order_num;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回顾客名称和相关订单号以及每个订单的总价">返回顾客名称和相关订单号以及每个订单的总价<a hidden class="anchor" aria-hidden="true" href="#返回顾客名称和相关订单号以及每个订单的总价">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>Customers` <span style="color:#f00">表有字段，顾客名称：</span>`cust_name`<span style="color:#f00">、顾客</span> id<span style="color:#f00">：</span>`cust_id
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>cust_id</th>
<th>cust_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>cust10</td>
<td>andy</td>
</tr>
<tr>
<td>cust1</td>
<td>ben</td>
</tr>
<tr>
<td>cust2</td>
<td>tony</td>
</tr>
<tr>
<td>cust22</td>
<td>tom</td>
</tr>
<tr>
<td>cust221</td>
<td>an</td>
</tr>
<tr>
<td>cust2217</td>
<td>hex</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>Orders` <span style="color:#f00">订单信息表，含有字段，订单号：</span>`order_num`<span style="color:#f00">、顾客</span> id<span style="color:#f00">：</span>`cust_id
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>order_num</th>
<th>cust_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>cust10</td>
</tr>
<tr>
<td>a2</td>
<td>cust1</td>
</tr>
<tr>
<td>a3</td>
<td>cust2</td>
</tr>
<tr>
<td>a4</td>
<td>cust22</td>
</tr>
<tr>
<td>a5</td>
<td>cust221</td>
</tr>
<tr>
<td>a7</td>
<td>cust2217</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>OrderItems` <span style="color:#f00">表有字段，商品订单号：</span>`order_num`<span style="color:#f00">、商品数量：</span>`quantity`<span style="color:#f00">、商品价格：</span>`item_price
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>order_num</th>
<th>quantity</th>
<th>item_price</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>1000</td>
<td>10</td>
</tr>
<tr>
<td>a2</td>
<td>200</td>
<td>10</td>
</tr>
<tr>
<td>a3</td>
<td>10</td>
<td>15</td>
</tr>
<tr>
<td>a4</td>
<td>25</td>
<td>50</td>
</tr>
<tr>
<td>a5</td>
<td>15</td>
<td>25</td>
</tr>
<tr>
<td>a7</td>
<td>7</td>
<td>7</td>
</tr>
</tbody>
</table>
<p>【问题】除了返回顾客名称和订单号，返回 <code>Customers</code> 表中的顾客名称（<code>cust_name</code>）和 <code>Orders</code> 表中的相关订单号（<code>order_num</code>），添加第三列 <code>OrderTotal</code>，其中包含每个订单的总价，并按顾客名称再按订单号对结果进行升序排序。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#f00">简单的等连接语法</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name, o.order_num, <span style="color:#fff;font-weight:bold">SUM</span>(quantity * item_price) <span style="color:#fff;font-weight:bold">AS</span> OrderTotal
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers <span style="color:#fff;font-weight:bold">c</span>,Orders o,OrderItems oi
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">c</span>.cust_id = o.cust_id <span style="color:#fff;font-weight:bold">AND</span> o.order_num = oi.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name, o.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name, o.order_num
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意，可能有小伙伴会这样写：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name, o.order_num, <span style="color:#fff;font-weight:bold">SUM</span>(quantity * item_price) <span style="color:#fff;font-weight:bold">AS</span> OrderTotal
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers <span style="color:#fff;font-weight:bold">c</span>,Orders o,OrderItems oi
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">c</span>.cust_id = o.cust_id <span style="color:#fff;font-weight:bold">AND</span> o.order_num = oi.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">c</span>.cust_name,o.order_num
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是错误的！只对 <code>cust_name</code> 进行聚类确实符合题意，但是不符合 <code>GROUP BY</code> 的语法。</p>
<p>select 语句中，如果没有 <code>GROUP BY</code> 语句，那么 <code>cust_name</code>、<code>order_num</code> 会返回若干个值，而 <code>sum(quantity * item_price)</code> 只返回一个值，通过 <code>group by</code> <code>cust_name</code> 可以让 <code>cust_name</code> 和 <code>sum(quantity * item_price)</code> 一一对应起来，或者说<strong>聚类</strong>，所以同样的，也要对 <code>order_num</code> 进行聚类。</p>
<blockquote>
<p><strong>一句话，select 中的字段要么都聚类，要么都不聚类</strong></p>
</blockquote>
<h3 id="确定哪些订单购买了-prod_id-为-br01-的产品二">确定哪些订单购买了 prod_id 为 BR01 的产品（二）<a hidden class="anchor" aria-hidden="true" href="#确定哪些订单购买了-prod_id-为-br01-的产品二">#</a></h3>
<p>表 <code>OrderItems</code> 代表订单商品信息表，<code>prod_id</code> 为产品 id；<code>Orders</code> 表代表订单表有 <code>cust_id</code> 代表顾客 id 和订单日期 <code>order_date</code></p>
<p><code>OrderItems</code> 表：</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>order_num</th>
</tr>
</thead>
<tbody>
<tr>
<td>BR01</td>
<td>a0001</td>
</tr>
<tr>
<td>BR01</td>
<td>a0002</td>
</tr>
<tr>
<td>BR02</td>
<td>a0003</td>
</tr>
<tr>
<td>BR02</td>
<td>a0013</td>
</tr>
</tbody>
</table>
<p><code>Orders</code> 表：</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>cust_id</th>
<th>order_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>cust10</td>
<td>2022-01-01 00:00:00</td>
</tr>
<tr>
<td>a0002</td>
<td>cust1</td>
<td>2022-01-01 00:01:00</td>
</tr>
<tr>
<td>a0003</td>
<td>cust1</td>
<td>2022-01-02 00:00:00</td>
</tr>
<tr>
<td>a0013</td>
<td>cust2</td>
<td>2022-01-01 00:20:00</td>
</tr>
</tbody>
</table>
<p>【问题】</p>
<p>编写 SQL 语句，使用子查询来确定哪些订单（在 <code>OrderItems</code> 中）购买了 <code>prod_id</code> 为 &ldquo;BR01&rdquo; 的产品，然后从 <code>Orders</code> 表中返回每个产品对应的顾客 ID（<code>cust_id</code>）和订单日期（<code>order_date</code>），按订购日期对结果进行升序排序。</p>
<p>提示：这一次使用连接和简单的等连接语法。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">1</span><span style="color:#f00">：子查询</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_id, order_date
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Orders
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> order_num <span style="color:#fff;font-weight:bold">IN</span> (<span style="color:#fff;font-weight:bold">SELECT</span> order_num
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">WHERE</span> prod_id = <span style="color:#0ff;font-weight:bold">&#39;BR01&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> order_date
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">2</span><span style="color:#f00">：连接表</span> <span style="color:#fff;font-weight:bold">inner</span> <span style="color:#fff;font-weight:bold">join</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_id, order_date
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Orders o <span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> order_num
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">WHERE</span> prod_id = <span style="color:#0ff;font-weight:bold">&#39;BR01&#39;</span>) tb <span style="color:#fff;font-weight:bold">ON</span> o.order_num = tb.order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> order_date
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">写法</span> <span style="color:#ff0;font-weight:bold">3</span><span style="color:#f00">：写法</span> <span style="color:#ff0;font-weight:bold">2</span> <span style="color:#f00">的简化版</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_id, order_date
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Orders
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> OrderItems <span style="color:#fff;font-weight:bold">USING</span>(order_num)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> OrderItems.prod_id = <span style="color:#0ff;font-weight:bold">&#39;BR01&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> order_date
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回购买-prod_id-为-br01-的产品的所有顾客的电子邮件二">返回购买 prod_id 为 BR01 的产品的所有顾客的电子邮件（二）<a hidden class="anchor" aria-hidden="true" href="#返回购买-prod_id-为-br01-的产品的所有顾客的电子邮件二">#</a></h3>
<p>有表 <code>OrderItems</code> 代表订单商品信息表，<code>prod_id</code> 为产品 id；<code>Orders</code> 表代表订单表有 <code>cust_id</code> 代表顾客 id 和订单日期 <code>order_date</code>；<code>Customers</code> 表含有 <code>cust_email</code> 顾客邮件和 cust_id 顾客 id</p>
<p><code>OrderItems</code> 表：</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>order_num</th>
</tr>
</thead>
<tbody>
<tr>
<td>BR01</td>
<td>a0001</td>
</tr>
<tr>
<td>BR01</td>
<td>a0002</td>
</tr>
<tr>
<td>BR02</td>
<td>a0003</td>
</tr>
<tr>
<td>BR02</td>
<td>a0013</td>
</tr>
</tbody>
</table>
<p><code>Orders</code> 表：</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>cust_id</th>
<th>order_date</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>cust10</td>
<td>2022-01-01 00:00:00</td>
</tr>
<tr>
<td>a0002</td>
<td>cust1</td>
<td>2022-01-01 00:01:00</td>
</tr>
<tr>
<td>a0003</td>
<td>cust1</td>
<td>2022-01-02 00:00:00</td>
</tr>
<tr>
<td>a0013</td>
<td>cust2</td>
<td>2022-01-01 00:20:00</td>
</tr>
</tbody>
</table>
<p><code>Customers</code> 表代表顾客信息，<code>cust_id</code> 为顾客 id，<code>cust_email</code> 为顾客 email</p>
<table>
<thead>
<tr>
<th>cust_id</th>
<th>cust_email</th>
</tr>
</thead>
<tbody>
<tr>
<td>cust10</td>
<td><a href="mailto:cust10@cust.com">cust10@cust.com</a></td>
</tr>
<tr>
<td>cust1</td>
<td><a href="mailto:cust1@cust.com">cust1@cust.com</a></td>
</tr>
<tr>
<td>cust2</td>
<td><a href="mailto:cust2@cust.com">cust2@cust.com</a></td>
</tr>
</tbody>
</table>
<p>【问题】返回购买 <code>prod_id</code> 为 BR01 的产品的所有顾客的电子邮件（<code>Customers</code> 表中的 <code>cust_email</code>），结果无需排序。</p>
<p>提示：涉及到 <code>SELECT</code> 语句，最内层的从 <code>OrderItems</code> 表返回 <code>order_num</code>，中间的从 <code>Customers</code> 表返回 <code>cust_id</code>，但是必须使用 INNER JOIN 语法。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_email
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> Orders <span style="color:#fff;font-weight:bold">using</span>(cust_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> OrderItems <span style="color:#fff;font-weight:bold">using</span>(order_num)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> OrderItems.prod_id = <span style="color:#0ff;font-weight:bold">&#39;BR01&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="确定最佳顾客的另一种方式二">确定最佳顾客的另一种方式（二）<a hidden class="anchor" aria-hidden="true" href="#确定最佳顾客的另一种方式二">#</a></h3>
<p><code>OrderItems</code> 表代表订单信息，确定最佳顾客的另一种方式是看他们花了多少钱，<code>OrderItems</code> 表有订单号 <code>order_num</code> 和 <code>item_price</code> 商品售出价格、<code>quantity</code> 商品数量</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>item_price</th>
<th>quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>10</td>
<td>105</td>
</tr>
<tr>
<td>a2</td>
<td>1</td>
<td>1100</td>
</tr>
<tr>
<td>a2</td>
<td>1</td>
<td>200</td>
</tr>
<tr>
<td>a4</td>
<td>2</td>
<td>1121</td>
</tr>
<tr>
<td>a5</td>
<td>5</td>
<td>10</td>
</tr>
<tr>
<td>a2</td>
<td>1</td>
<td>19</td>
</tr>
<tr>
<td>a7</td>
<td>7</td>
<td>5</td>
</tr>
</tbody>
</table>
<p><code>Orders</code> 表含有字段 <code>order_num</code> 订单号、<code>cust_id</code> 顾客 id</p>
<table>
<thead>
<tr>
<th>order_num</th>
<th>cust_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>cust10</td>
</tr>
<tr>
<td>a2</td>
<td>cust1</td>
</tr>
<tr>
<td>a3</td>
<td>cust2</td>
</tr>
<tr>
<td>a4</td>
<td>cust22</td>
</tr>
<tr>
<td>a5</td>
<td>cust221</td>
</tr>
<tr>
<td>a7</td>
<td>cust2217</td>
</tr>
</tbody>
</table>
<p>顾客表 <code>Customers</code> 有字段 <code>cust_id</code> 客户 id、<code>cust_name</code> 客户姓名</p>
<table>
<thead>
<tr>
<th>cust_id</th>
<th>cust_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>cust10</td>
<td>andy</td>
</tr>
<tr>
<td>cust1</td>
<td>ben</td>
</tr>
<tr>
<td>cust2</td>
<td>tony</td>
</tr>
<tr>
<td>cust22</td>
<td>tom</td>
</tr>
<tr>
<td>cust221</td>
<td>an</td>
</tr>
<tr>
<td>cust2217</td>
<td>hex</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，返回订单总价不小于 1000 的客户名称和总额（<code>OrderItems</code> 表中的 <code>order_num</code>）。</p>
<p>提示：需要计算总和（<code>item_price</code> 乘以 <code>quantity</code>）。按总额对结果进行排序，请使用 <code>INNER JOIN</code>语法。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_name, <span style="color:#fff;font-weight:bold">SUM</span>(item_price * quantity) <span style="color:#fff;font-weight:bold">AS</span> total_price
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> Orders <span style="color:#fff;font-weight:bold">USING</span>(cust_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> OrderItems <span style="color:#fff;font-weight:bold">USING</span>(order_num)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> cust_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> total_price &gt;= <span style="color:#ff0;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> total_price
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="创建高级连接">创建高级连接<a hidden class="anchor" aria-hidden="true" href="#创建高级连接">#</a></h2>
<h3 id="检索每个顾客的名称和所有的订单号一">检索每个顾客的名称和所有的订单号（一）<a hidden class="anchor" aria-hidden="true" href="#检索每个顾客的名称和所有的订单号一">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>Customers` <span style="color:#f00">表代表顾客信息含有顾客</span> id `cust_id` <span style="color:#f00">和</span> <span style="color:#f00">顾客名称</span> `cust_name
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>cust_id</th>
<th>cust_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>cust10</td>
<td>andy</td>
</tr>
<tr>
<td>cust1</td>
<td>ben</td>
</tr>
<tr>
<td>cust2</td>
<td>tony</td>
</tr>
<tr>
<td>cust22</td>
<td>tom</td>
</tr>
<tr>
<td>cust221</td>
<td>an</td>
</tr>
<tr>
<td>cust2217</td>
<td>hex</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>Orders` <span style="color:#f00">表代表订单信息含有订单号</span> `order_num` <span style="color:#f00">和顾客</span> id `cust_id
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>order_num</th>
<th>cust_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>cust10</td>
</tr>
<tr>
<td>a2</td>
<td>cust1</td>
</tr>
<tr>
<td>a3</td>
<td>cust2</td>
</tr>
<tr>
<td>a4</td>
<td>cust22</td>
</tr>
<tr>
<td>a5</td>
<td>cust221</td>
</tr>
<tr>
<td>a7</td>
<td>cust2217</td>
</tr>
</tbody>
</table>
<p>【问题】使用 INNER JOIN 编写 SQL 语句，检索每个顾客的名称（<code>Customers</code> 表中的 <code>cust_name</code>）和所有的订单号（<code>Orders</code> 表中的 <code>order_num</code>），最后根据顾客姓名 <code>cust_name</code> 升序返回。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_name, order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> Orders
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">USING</span>(cust_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> cust_name
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="检索每个顾客的名称和所有的订单号二">检索每个顾客的名称和所有的订单号（二）<a hidden class="anchor" aria-hidden="true" href="#检索每个顾客的名称和所有的订单号二">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>Orders` <span style="color:#f00">表代表订单信息含有订单号</span> `order_num` <span style="color:#f00">和顾客</span> id `cust_id
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>order_num</th>
<th>cust_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>cust10</td>
</tr>
<tr>
<td>a2</td>
<td>cust1</td>
</tr>
<tr>
<td>a3</td>
<td>cust2</td>
</tr>
<tr>
<td>a4</td>
<td>cust22</td>
</tr>
<tr>
<td>a5</td>
<td>cust221</td>
</tr>
<tr>
<td>a7</td>
<td>cust2217</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>Customers` <span style="color:#f00">表代表顾客信息含有顾客</span> id `cust_id` <span style="color:#f00">和</span> <span style="color:#f00">顾客名称</span> `cust_name
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>cust_id</th>
<th>cust_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>cust10</td>
<td>andy</td>
</tr>
<tr>
<td>cust1</td>
<td>ben</td>
</tr>
<tr>
<td>cust2</td>
<td>tony</td>
</tr>
<tr>
<td>cust22</td>
<td>tom</td>
</tr>
<tr>
<td>cust221</td>
<td>an</td>
</tr>
<tr>
<td>cust2217</td>
<td>hex</td>
</tr>
<tr>
<td>cust40</td>
<td>ace</td>
</tr>
</tbody>
</table>
<p>【问题】检索每个顾客的名称（<code>Customers</code> 表中的 <code>cust_name</code>）和所有的订单号（Orders 表中的 <code>order_num</code>），列出所有的顾客，即使他们没有下过订单。最后根据顾客姓名 <code>cust_name</code> 升序返回。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_name, order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> Orders
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">USING</span>(cust_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> cust_name
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回产品名称和与之相关的订单号">返回产品名称和与之相关的订单号<a hidden class="anchor" aria-hidden="true" href="#返回产品名称和与之相关的订单号">#</a></h3>
<p><code>Products</code> 表为产品信息表含有字段 <code>prod_id</code> 产品 id、<code>prod_name</code> 产品名称</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>prod_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>egg</td>
</tr>
<tr>
<td>a0002</td>
<td>sockets</td>
</tr>
<tr>
<td>a0013</td>
<td>coffee</td>
</tr>
<tr>
<td>a0003</td>
<td>cola</td>
</tr>
<tr>
<td>a0023</td>
<td>soda</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>OrderItems` <span style="color:#f00">表为订单信息表含有字段</span> `order_num` <span style="color:#f00">订单号和产品</span> id `prod_id
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>prod_id</th>
<th>order_num</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>a105</td>
</tr>
<tr>
<td>a0002</td>
<td>a1100</td>
</tr>
<tr>
<td>a0002</td>
<td>a200</td>
</tr>
<tr>
<td>a0013</td>
<td>a1121</td>
</tr>
<tr>
<td>a0003</td>
<td>a10</td>
</tr>
<tr>
<td>a0003</td>
<td>a19</td>
</tr>
<tr>
<td>a0003</td>
<td>a5</td>
</tr>
</tbody>
</table>
<p>【问题】使用外连接（left join、 right join、full join）联结 <code>Products</code> 表和 <code>OrderItems</code> 表，返回产品名称（<code>prod_name</code>）和与之相关的订单号（<code>order_num</code>）的列表，并按照产品名称升序排序。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_name, order_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">USING</span>(prod_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> prod_name
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="返回产品名称和每一项产品的总订单数">返回产品名称和每一项产品的总订单数<a hidden class="anchor" aria-hidden="true" href="#返回产品名称和每一项产品的总订单数">#</a></h3>
<p><code>Products</code> 表为产品信息表含有字段 <code>prod_id</code> 产品 id、<code>prod_name</code> 产品名称</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>prod_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>egg</td>
</tr>
<tr>
<td>a0002</td>
<td>sockets</td>
</tr>
<tr>
<td>a0013</td>
<td>coffee</td>
</tr>
<tr>
<td>a0003</td>
<td>cola</td>
</tr>
<tr>
<td>a0023</td>
<td>soda</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>OrderItems` <span style="color:#f00">表为订单信息表含有字段</span> `order_num` <span style="color:#f00">订单号和产品</span> id `prod_id
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>prod_id</th>
<th>order_num</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>a105</td>
</tr>
<tr>
<td>a0002</td>
<td>a1100</td>
</tr>
<tr>
<td>a0002</td>
<td>a200</td>
</tr>
<tr>
<td>a0013</td>
<td>a1121</td>
</tr>
<tr>
<td>a0003</td>
<td>a10</td>
</tr>
<tr>
<td>a0003</td>
<td>a19</td>
</tr>
<tr>
<td>a0003</td>
<td>a5</td>
</tr>
</tbody>
</table>
<p>【问题】</p>
<p>使用 OUTER JOIN 联结 <code>Products</code> 表和 <code>OrderItems</code> 表，返回产品名称（<code>prod_name</code>）和每一项产品的总订单数（不是订单号），并按产品名称升序排序。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_name, <span style="color:#fff;font-weight:bold">COUNT</span>(order_num) <span style="color:#fff;font-weight:bold">AS</span> orders
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">USING</span>(prod_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> prod_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> prod_name
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="列出供应商及其可供产品的数量">列出供应商及其可供产品的数量<a hidden class="anchor" aria-hidden="true" href="#列出供应商及其可供产品的数量">#</a></h3>
<p>有 <code>Vendors</code> 表含有 <code>vend_id</code> （供应商 id）</p>
<table>
<thead>
<tr>
<th>vend_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0002</td>
</tr>
<tr>
<td>a0013</td>
</tr>
<tr>
<td>a0003</td>
</tr>
<tr>
<td>a0010</td>
</tr>
</tbody>
</table>
<p>有 <code>Products</code> 表含有 <code>vend_id</code>（供应商 id）和 prod_id（供应产品 id）</p>
<table>
<thead>
<tr>
<th>vend_id</th>
<th>prod_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>egg</td>
</tr>
<tr>
<td>a0002</td>
<td>prod_id_iphone</td>
</tr>
<tr>
<td>a00113</td>
<td>prod_id_tea</td>
</tr>
<tr>
<td>a0003</td>
<td>prod_id_vivo phone</td>
</tr>
<tr>
<td>a0010</td>
<td>prod_id_huawei phone</td>
</tr>
</tbody>
</table>
<p>【问题】列出供应商（<code>Vendors</code> 表中的 <code>vend_id</code>）及其可供产品的数量，包括没有产品的供应商。你需要使用 OUTER JOIN 和 COUNT()聚合函数来计算 <code>Products</code> 表中每种产品的数量，最后根据 vend_id 升序排序。</p>
<p>注意：<code>vend_id</code> 列会显示在多个表中，因此在每次引用它时都需要完全限定它。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> vend_id, <span style="color:#fff;font-weight:bold">COUNT</span>(prod_id) <span style="color:#fff;font-weight:bold">AS</span> prod_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Vendors
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">USING</span>(vend_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> vend_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> vend_id
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="组合查询">组合查询<a hidden class="anchor" aria-hidden="true" href="#组合查询">#</a></h2>
<p><code>UNION</code> 运算符将两个或更多查询的结果组合起来，并生成一个结果集，其中包含来自 <code>UNION</code> 中参与查询的提取行。</p>
<p><code>UNION</code> 基本规则：</p>
<ul>
<li>所有查询的列数和列顺序必须相同。</li>
<li>每个查询中涉及表的列的数据类型必须相同或兼容。</li>
<li>通常返回的列名取自第一个查询。</li>
</ul>
<p>默认地，<code>UNION</code> 操作符选取不同的值。如果允许重复的值，请使用 <code>UNION ALL</code>。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">column_name</span>(s) <span style="color:#fff;font-weight:bold">FROM</span> table1
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UNION</span> <span style="color:#fff;font-weight:bold">ALL</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">column_name</span>(s) <span style="color:#fff;font-weight:bold">FROM</span> table2;
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>UNION</code> 结果集中的列名总是等于 <code>UNION</code> 中第一个 <code>SELECT</code> 语句中的列名。</p>
<p><code>JOIN</code> vs <code>UNION</code>：</p>
<ul>
<li><code>JOIN</code> 中连接表的列可能不同，但在 <code>UNION</code> 中，所有查询的列数和列顺序必须相同。</li>
<li><code>UNION</code> 将查询之后的行放在一起（垂直放置），但 <code>JOIN</code> 将查询之后的列放在一起（水平放置），即它构成一个笛卡尔积。</li>
</ul>
<h3 id="将两个-select-语句结合起来一">将两个 SELECT 语句结合起来（一）<a hidden class="anchor" aria-hidden="true" href="#将两个-select-语句结合起来一">#</a></h3>
<p>表 <code>OrderItems</code> 包含订单产品信息，字段 <code>prod_id</code> 代表产品 id、<code>quantity</code> 代表产品数量</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>105</td>
</tr>
<tr>
<td>a0002</td>
<td>100</td>
</tr>
<tr>
<td>a0002</td>
<td>200</td>
</tr>
<tr>
<td>a0013</td>
<td>1121</td>
</tr>
<tr>
<td>a0003</td>
<td>10</td>
</tr>
<tr>
<td>a0003</td>
<td>19</td>
</tr>
<tr>
<td>a0003</td>
<td>5</td>
</tr>
<tr>
<td>BNBG</td>
<td>10002</td>
</tr>
</tbody>
</table>
<p>【问题】将两个 <code>SELECT</code> 语句结合起来，以便从 <code>OrderItems</code> 表中检索产品 id（<code>prod_id</code>）和 <code>quantity</code>。其中，一个 <code>SELECT</code> 语句过滤数量为 100 的行，另一个 <code>SELECT</code> 语句过滤 id 以 BNBG 开头的产品，最后按产品 id 对结果进行升序排序。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_id, quantity
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> quantity = <span style="color:#ff0;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UNION</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_id, quantity
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> prod_id <span style="color:#fff;font-weight:bold">LIKE</span> <span style="color:#0ff;font-weight:bold">&#39;BNBG%&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="将两个-select-语句结合起来二">将两个 SELECT 语句结合起来（二）<a hidden class="anchor" aria-hidden="true" href="#将两个-select-语句结合起来二">#</a></h3>
<p>表 <code>OrderItems</code> 包含订单产品信息，字段 <code>prod_id</code> 代表产品 id、<code>quantity</code> 代表产品数量。</p>
<table>
<thead>
<tr>
<th>prod_id</th>
<th>quantity</th>
</tr>
</thead>
<tbody>
<tr>
<td>a0001</td>
<td>105</td>
</tr>
<tr>
<td>a0002</td>
<td>100</td>
</tr>
<tr>
<td>a0002</td>
<td>200</td>
</tr>
<tr>
<td>a0013</td>
<td>1121</td>
</tr>
<tr>
<td>a0003</td>
<td>10</td>
</tr>
<tr>
<td>a0003</td>
<td>19</td>
</tr>
<tr>
<td>a0003</td>
<td>5</td>
</tr>
<tr>
<td>BNBG</td>
<td>10002</td>
</tr>
</tbody>
</table>
<p>【问题】将两个 <code>SELECT</code> 语句结合起来，以便从 <code>OrderItems</code> 表中检索产品 id（<code>prod_id</code>）和 <code>quantity</code>。其中，一个 <code>SELECT</code> 语句过滤数量为 100 的行，另一个 <code>SELECT</code> 语句过滤 id 以 BNBG 开头的产品，最后按产品 id 对结果进行升序排序。 注意：<strong>这次仅使用单个 SELECT 语句。</strong></p>
<p>答案：</p>
<p>要求只用一条 select 语句，那就用 <code>or</code> 不用 <code>union</code> 了。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_id, quantity
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> OrderItems
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> quantity = <span style="color:#ff0;font-weight:bold">100</span> <span style="color:#fff;font-weight:bold">OR</span> prod_id <span style="color:#fff;font-weight:bold">LIKE</span> <span style="color:#0ff;font-weight:bold">&#39;BNBG%&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="组合-products-表中的产品名称和-customers-表中的顾客名称">组合 Products 表中的产品名称和 Customers 表中的顾客名称<a hidden class="anchor" aria-hidden="true" href="#组合-products-表中的产品名称和-customers-表中的顾客名称">#</a></h3>
<p><code>Products</code> 表含有字段 <code>prod_name</code> 代表产品名称</p>
<table>
<thead>
<tr>
<th>prod_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>flower</td>
</tr>
<tr>
<td>rice</td>
</tr>
<tr>
<td>ring</td>
</tr>
<tr>
<td>umbrella</td>
</tr>
</tbody>
</table>
<p>Customers 表代表顾客信息，cust_name 代表顾客名称</p>
<table>
<thead>
<tr>
<th>cust_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>andy</td>
</tr>
<tr>
<td>ben</td>
</tr>
<tr>
<td>tony</td>
</tr>
<tr>
<td>tom</td>
</tr>
<tr>
<td>an</td>
</tr>
<tr>
<td>lee</td>
</tr>
<tr>
<td>hex</td>
</tr>
</tbody>
</table>
<p>【问题】编写 SQL 语句，组合 <code>Products</code> 表中的产品名称（<code>prod_name</code>）和 <code>Customers</code> 表中的顾客名称（<code>cust_name</code>）并返回，然后按产品名称对结果进行升序排序。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span># <span style="color:#fff;font-weight:bold">UNION</span> <span style="color:#f00">结果集中的列名总是等于</span> <span style="color:#fff;font-weight:bold">UNION</span> <span style="color:#f00">中第一个</span> <span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#f00">语句中的列名。</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> prod_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Products
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UNION</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> prod_name
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="检查-sql-语句-3">检查 SQL 语句<a hidden class="anchor" aria-hidden="true" href="#检查-sql-语句-3">#</a></h3>
<p>表 <code>Customers</code> 含有字段 <code>cust_name</code> 顾客名、<code>cust_contact</code> 顾客联系方式、<code>cust_state</code> 顾客州、<code>cust_email</code> 顾客 <code>email</code></p>
<table>
<thead>
<tr>
<th>cust_name</th>
<th>cust_contact</th>
<th>cust_state</th>
<th>cust_email</th>
</tr>
</thead>
<tbody>
<tr>
<td>cust10</td>
<td>8695192</td>
<td>MI</td>
<td><a href="mailto:cust10@cust.com">cust10@cust.com</a></td>
</tr>
<tr>
<td>cust1</td>
<td>8695193</td>
<td>MI</td>
<td><a href="mailto:cust1@cust.com">cust1@cust.com</a></td>
</tr>
<tr>
<td>cust2</td>
<td>8695194</td>
<td>IL</td>
<td><a href="mailto:cust2@cust.com">cust2@cust.com</a></td>
</tr>
</tbody>
</table>
<p>【问题】修正下面错误的 SQL</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_name, cust_contact, cust_email
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> cust_state = <span style="color:#0ff;font-weight:bold">&#39;MI&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> cust_name;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UNION</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_name, cust_contact, cust_email
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> cust_state = <span style="color:#0ff;font-weight:bold">&#39;IL&#39;</span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> cust_name;
</span></span></code></pre></td></tr></table>
</div>
</div><p>修正后：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_name, cust_contact, cust_email
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> cust_state = <span style="color:#0ff;font-weight:bold">&#39;MI&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UNION</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_name, cust_contact, cust_email
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> cust_state = <span style="color:#0ff;font-weight:bold">&#39;IL&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> cust_name;
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 <code>union</code> 组合查询时，只能使用一条 <code>order by</code> 字句，他必须位于最后一条 <code>select</code> 语句之后</p>
<p>或者直接用 <code>or</code> 来做：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> cust_name, cust_contact, cust_email
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> Customers
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> cust_state = <span style="color:#0ff;font-weight:bold">&#39;MI&#39;</span> <span style="color:#fff;font-weight:bold">or</span> cust_state = <span style="color:#0ff;font-weight:bold">&#39;IL&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> cust_name;
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="sql面试题2">SQL面试题2<a hidden class="anchor" aria-hidden="true" href="#sql面试题2">#</a></h1>
<h2 id="增删改操作">增删改操作<a hidden class="anchor" aria-hidden="true" href="#增删改操作">#</a></h2>
<p>SQL 插入记录的方式汇总：</p>
<ul>
<li><strong>普通插入（全字段）</strong> ：<code>INSERT INTO table_name VALUES (value1, value2, ...)</code></li>
<li><strong>普通插入（限定字段）</strong> ：<code>INSERT INTO table_name (column1, column2, ...) VALUES (value1, value2, ...)</code></li>
<li><strong>多条一次性插入</strong> ：<code>INSERT INTO table_name (column1, column2, ...) VALUES (value1_1, value1_2, ...), (value2_1, value2_2, ...), ...</code></li>
<li><strong>从另一个表导入</strong> ：<code>INSERT INTO table_name SELECT * FROM table_name2 [WHERE key=value]</code></li>
<li><strong>带更新的插入</strong> ：<code>REPLACE INTO table_name VALUES (value1, value2, ...)</code>（注意这种原理是检测到主键或唯一性索引键重复就删除原记录后重新插入）</li>
</ul>
<h3 id="插入记录一">插入记录（一）<a hidden class="anchor" aria-hidden="true" href="#插入记录一">#</a></h3>
<p><strong>描述</strong>：牛客后台会记录每个用户的试卷作答记录到 <code>exam_record</code> 表，现在有两个用户的作答记录详情如下：</p>
<ul>
<li>用户 1001 在 2021 年 9 月 1 日晚上 10 点 11 分 12 秒开始作答试卷 9001，并在 50 分钟后提交，得了 90 分；</li>
<li>用户 1002 在 2021 年 9 月 4 日上午 7 点 1 分 2 秒开始作答试卷 9002，并在 10 分钟后退出了平台。</li>
</ul>
<p>试卷作答记录表<code>exam_record</code>中，表已建好，其结构如下，请用一条语句将这两条记录插入表中。</p>
<table>
<thead>
<tr>
<th>Filed</th>
<th>Type</th>
<th>Null</th>
<th>Key</th>
<th>Extra</th>
<th>Default</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int(11)</td>
<td>NO</td>
<td>PRI</td>
<td>auto_increment</td>
<td>(NULL)</td>
<td>自增 ID</td>
</tr>
<tr>
<td>uid</td>
<td>int(11)</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>用户 ID</td>
</tr>
<tr>
<td>exam_id</td>
<td>int(11)</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>试卷 ID</td>
</tr>
<tr>
<td>start_time</td>
<td>datetime</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>开始时间</td>
</tr>
<tr>
<td>submit_time</td>
<td>datetime</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>提交时间</td>
</tr>
<tr>
<td>score</td>
<td>tinyint(4)</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>得分</td>
</tr>
</tbody>
</table>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>// <span style="color:#f00">存在自增主键，无需手动赋值</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> exam_record (uid, exam_id, start_time, submit_time, score) <span style="color:#fff;font-weight:bold">VALUES</span>
</span></span><span style="display:flex;"><span>(<span style="color:#ff0;font-weight:bold">1001</span>, <span style="color:#ff0;font-weight:bold">9001</span>, <span style="color:#0ff;font-weight:bold">&#39;2021-09-01 22:11:12&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;2021-09-01 23:01:12&#39;</span>, <span style="color:#ff0;font-weight:bold">90</span>),
</span></span><span style="display:flex;"><span>(<span style="color:#ff0;font-weight:bold">1002</span>, <span style="color:#ff0;font-weight:bold">9002</span>, <span style="color:#0ff;font-weight:bold">&#39;2021-09-04 07:01:02&#39;</span>, <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#fff;font-weight:bold">NULL</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="插入记录二">插入记录（二）<a hidden class="anchor" aria-hidden="true" href="#插入记录二">#</a></h3>
<p><strong>描述</strong>：现有一张试卷作答记录表<code>exam_record</code>，结构如下表，其中包含多年来的用户作答试卷记录，由于数据越来越多，维护难度越来越大，需要对数据表内容做精简，历史数据做备份。</p>
<p>表<code>exam_record</code>：</p>
<table>
<thead>
<tr>
<th>Filed</th>
<th>Type</th>
<th>Null</th>
<th>Key</th>
<th>Extra</th>
<th>Default</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int(11)</td>
<td>NO</td>
<td>PRI</td>
<td>auto_increment</td>
<td>(NULL)</td>
<td>自增 ID</td>
</tr>
<tr>
<td>uid</td>
<td>int(11)</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>用户 ID</td>
</tr>
<tr>
<td>exam_id</td>
<td>int(11)</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>试卷 ID</td>
</tr>
<tr>
<td>start_time</td>
<td>datetime</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>开始时间</td>
</tr>
<tr>
<td>submit_time</td>
<td>datetime</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>提交时间</td>
</tr>
<tr>
<td>score</td>
<td>tinyint(4)</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>得分</td>
</tr>
</tbody>
</table>
<p>我们已经创建了一张新表<code>exam_record_before_2021</code>用来备份 2021 年之前的试题作答记录，结构和<code>exam_record</code>表一致，请将 2021 年之前的已完成了的试题作答纪录导入到该表。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> exam_record_before_2021 (uid, exam_id, start_time, submit_time, score)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> uid,exam_id,start_time,submit_time,score
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">YEAR</span>(submit_time) &lt; <span style="color:#ff0;font-weight:bold">2021</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="插入记录三">插入记录（三）<a hidden class="anchor" aria-hidden="true" href="#插入记录三">#</a></h3>
<p><strong>描述</strong>：现在有一套 ID 为 9003 的高难度 SQL 试卷，时长为一个半小时，请你将 2021-01-01 00:00:00 作为发布时间插入到试题信息表<code>examination_info</code>，不管该 ID 试卷是否存在，都要插入成功，请尝试插入它。</p>
<p>试题信息表<code>examination_info</code>：</p>
<table>
<thead>
<tr>
<th>Filed</th>
<th>Type</th>
<th>Null</th>
<th>Key</th>
<th>Extra</th>
<th>Default</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int(11)</td>
<td>NO</td>
<td>PRI</td>
<td>auto_increment</td>
<td>(NULL)</td>
<td>自增 ID</td>
</tr>
<tr>
<td>exam_id</td>
<td>int(11)</td>
<td>NO</td>
<td>UNI</td>
<td></td>
<td>(NULL)</td>
<td>试卷 ID</td>
</tr>
<tr>
<td>tag</td>
<td>varchar(32)</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>类别标签</td>
</tr>
<tr>
<td>difficulty</td>
<td>varchar(8)</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>难度</td>
</tr>
<tr>
<td>duration</td>
<td>int(11)</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>时长(分钟数)</td>
</tr>
<tr>
<td>release_time</td>
<td>datetime</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>发布时间</td>
</tr>
</tbody>
</table>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">REPLACE</span> <span style="color:#fff;font-weight:bold">INTO</span> examination_info <span style="color:#fff;font-weight:bold">VALUES</span>
</span></span><span style="display:flex;"><span> (<span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">9003</span>, <span style="color:#0ff;font-weight:bold">&#34;SQL&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;hard&#34;</span>, <span style="color:#ff0;font-weight:bold">90</span>, <span style="color:#0ff;font-weight:bold">&#34;2021-01-01 00:00:00&#34;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="更新记录一">更新记录（一）<a hidden class="anchor" aria-hidden="true" href="#更新记录一">#</a></h3>
<p><strong>描述</strong>：现在有一张试卷信息表 <code>examination_info</code>, 表结构如下图所示：</p>
<table>
<thead>
<tr>
<th>Filed</th>
<th>Type</th>
<th>Null</th>
<th>Key</th>
<th>Extra</th>
<th>Default</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int(11)</td>
<td>NO</td>
<td>PRI</td>
<td>auto_increment</td>
<td>(NULL)</td>
<td>自增 ID</td>
</tr>
<tr>
<td>exam_id</td>
<td>int(11)</td>
<td>NO</td>
<td>UNI</td>
<td></td>
<td>(NULL)</td>
<td>试卷 ID</td>
</tr>
<tr>
<td>tag</td>
<td>char(32)</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>类别标签</td>
</tr>
<tr>
<td>difficulty</td>
<td>char(8)</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>难度</td>
</tr>
<tr>
<td>duration</td>
<td>int(11)</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>时长</td>
</tr>
<tr>
<td>release_time</td>
<td>datetime</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>发布时间</td>
</tr>
</tbody>
</table>
<p>请把<strong>examination_info</strong>表中<code>tag</code>为<code>PYTHON</code>的<code>tag</code>字段全部修改为<code>Python</code>。</p>
<p><strong>思路</strong>：这题有两种解题思路，最容易想到的是直接<code>update + where</code>来指定条件更新，第二种就是根据要修改的字段进行查找替换</p>
<p><strong>答案一</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UPDATE</span> examination_info <span style="color:#fff;font-weight:bold">SET</span> tag = <span style="color:#0ff;font-weight:bold">&#39;Python&#39;</span> <span style="color:#fff;font-weight:bold">WHERE</span> tag=<span style="color:#0ff;font-weight:bold">&#39;PYTHON&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>答案二</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UPDATE</span> examination_info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SET</span> tag = <span style="color:#fff;font-weight:bold">REPLACE</span>(tag,<span style="color:#0ff;font-weight:bold">&#39;PYTHON&#39;</span>,<span style="color:#0ff;font-weight:bold">&#39;Python&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># <span style="color:#fff;font-weight:bold">REPLACE</span> (<span style="color:#f00">目标字段，</span><span style="color:#0ff;font-weight:bold">&#34;查找内容&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;替换内容&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="更新记录二">更新记录（二）<a hidden class="anchor" aria-hidden="true" href="#更新记录二">#</a></h3>
<p><strong>描述</strong>：现有一张试卷作答记录表 exam_record，其中包含多年来的用户作答试卷记录，结构如下表：作答记录表 <code>exam_record</code>： <strong><code>submit_time</code></strong> 为 完成时间 （注意这句话）</p>
<table>
<thead>
<tr>
<th>Filed</th>
<th>Type</th>
<th>Null</th>
<th>Key</th>
<th>Extra</th>
<th>Default</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int(11)</td>
<td>NO</td>
<td>PRI</td>
<td>auto_increment</td>
<td>(NULL)</td>
<td>自增 ID</td>
</tr>
<tr>
<td>uid</td>
<td>int(11)</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>用户 ID</td>
</tr>
<tr>
<td>exam_id</td>
<td>int(11)</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>试卷 ID</td>
</tr>
<tr>
<td>start_time</td>
<td>datetime</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>开始时间</td>
</tr>
<tr>
<td>submit_time</td>
<td>datetime</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>提交时间</td>
</tr>
<tr>
<td>score</td>
<td>tinyint(4)</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>得分</td>
</tr>
</tbody>
</table>
<p><strong>题目要求</strong>：请把 <code>exam_record</code> 表中 2021 年 9 月 1 日==之前==开始作答的==未完成==记录全部改为被动完成，即：将完成时间改为'2099-01-01 00:00:00&rsquo;，分数改为 0。</p>
<p><strong>思路</strong>：注意题干中的关键字(已经高亮) <code>&quot; xxx 时间 &quot;</code>之前这个条件， 那么这里马上就要想到要进行时间的比较 可以直接 <code>xxx_time &lt; &quot;2021-09-01 00:00:00&quot;,</code> 也可以采用<code>date()</code>函数来进行比较；第二个条件就是 <code>&quot;未完成&quot;</code>， 即完成时间为 NULL，也就是题目中的提交时间 &mdash;&ndash; <code>submit_time 为 NULL</code>。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UPDATE</span> exam_record <span style="color:#fff;font-weight:bold">SET</span> submit_time = <span style="color:#0ff;font-weight:bold">&#39;2099-01-01 00:00:00&#39;</span>, score = <span style="color:#ff0;font-weight:bold">0</span> <span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">DATE</span>(start_time) &lt; <span style="color:#0ff;font-weight:bold">&#34;2021-09-01&#34;</span> <span style="color:#fff;font-weight:bold">AND</span> submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">null</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="删除记录一">删除记录（一）<a hidden class="anchor" aria-hidden="true" href="#删除记录一">#</a></h3>
<p><strong>描述</strong>：现有一张试卷作答记录表 <code>exam_record</code>，其中包含多年来的用户作答试卷记录，结构如下表：</p>
<p>作答记录表<code>exam_record：</code> <strong><code>start_time</code></strong> 是试卷开始时间<code>submit_time</code> 是交卷，即结束时间。</p>
<table>
<thead>
<tr>
<th>Filed</th>
<th>Type</th>
<th>Null</th>
<th>Key</th>
<th>Extra</th>
<th>Default</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int(11)</td>
<td>NO</td>
<td>PRI</td>
<td>auto_increment</td>
<td>(NULL)</td>
<td>自增 ID</td>
</tr>
<tr>
<td>uid</td>
<td>int(11)</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>用户 ID</td>
</tr>
<tr>
<td>exam_id</td>
<td>int(11)</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>试卷 ID</td>
</tr>
<tr>
<td>start_time</td>
<td>datetime</td>
<td>NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>开始时间</td>
</tr>
<tr>
<td>submit_time</td>
<td>datetime</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>提交时间</td>
</tr>
<tr>
<td>score</td>
<td>tinyint(4)</td>
<td>YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>得分</td>
</tr>
</tbody>
</table>
<p><strong>要求</strong>：请删除<code>exam_record</code>表中作答时间小于 5 分钟整且分数不及格（及格线为 60 分）的记录；</p>
<p><strong>思路</strong>：这一题虽然是练习删除，仔细看确是考察对时间函数的用法，这里提及的分钟数比较，常用的函数有 <strong><code>TIMEDIFF</code>*<em>和*</em><code>TIMESTAMPDIFF</code></strong> ，两者用法稍有区别，后者更为灵活，这都是看个人习惯。</p>
<p>1.　 <code>TIMEDIFF</code>：两个时间之间的差值</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>TIMEDIFF(time1, time2)
</span></span></code></pre></td></tr></table>
</div>
</div><p>两者参数都是必须的，都是一个时间或者日期时间表达式。如果指定的参数不合法或者是 NULL，那么函数将返回 NULL。</p>
<p>对于这题而言，可以用在 minute 函数里面，因为 TIMEDIFF 计算出来的是时间的差值，在外面套一个 MINUTE 函数，计算出来的就是分钟数。</p>
<ol>
<li><code>TIMESTAMPDIFF</code>：用于计算两个日期的时间差</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>TIMESTAMPDIFF(unit,datetime_expr1,datetime_expr2)
</span></span><span style="display:flex;"><span># <span style="color:#f00">参数说明</span>
</span></span><span style="display:flex;"><span>#unit: <span style="color:#f00">日期比较返回的时间差单位，常用可选值如下</span>:
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SECOND</span><span style="color:#f00">：秒</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">MINUTE</span><span style="color:#f00">：分钟</span>
</span></span><span style="display:flex;"><span>HOUR<span style="color:#f00">：小时</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DAY</span><span style="color:#f00">：天</span>
</span></span><span style="display:flex;"><span>WEEK<span style="color:#f00">：星期</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">MONTH</span><span style="color:#f00">：月</span>
</span></span><span style="display:flex;"><span>QUARTER<span style="color:#f00">：季度</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">YEAR</span><span style="color:#f00">：年</span>
</span></span><span style="display:flex;"><span># TIMESTAMPDIFF<span style="color:#f00">函数返回</span>datetime_expr2 - datetime_expr1<span style="color:#f00">的结果（人话：</span> <span style="color:#f00">后面的</span> - <span style="color:#f00">前面的</span>  <span style="color:#f00">即</span><span style="color:#ff0;font-weight:bold">2</span>-<span style="color:#ff0;font-weight:bold">1</span><span style="color:#f00">），其中</span>datetime_expr1<span style="color:#f00">和</span>datetime_expr2<span style="color:#f00">可以是</span>DATE<span style="color:#f00">或</span>DATETIME<span style="color:#f00">类型值（人话：可以是“</span><span style="color:#ff0;font-weight:bold">2023</span>-<span style="color:#ff0;font-weight:bold">01</span>-<span style="color:#ff0;font-weight:bold">01</span><span style="color:#f00">”，</span> <span style="color:#f00">也可以是“</span><span style="color:#ff0;font-weight:bold">2023</span>-<span style="color:#ff0;font-weight:bold">01</span>-<span style="color:#ff0;font-weight:bold">01</span>- <span style="color:#ff0;font-weight:bold">00</span>:<span style="color:#ff0;font-weight:bold">00</span>:<span style="color:#ff0;font-weight:bold">00</span><span style="color:#f00">”）</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这题需要进行分钟的比较，那么就是 TIMESTAMPDIFF(MINUTE, 开始时间， 结束时间) &lt; 5</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DELETE</span> <span style="color:#fff;font-weight:bold">FROM</span> exam_record <span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">MINUTE</span> (TIMEDIFF(submit_time , start_time)) &lt; <span style="color:#ff0;font-weight:bold">5</span> <span style="color:#fff;font-weight:bold">AND</span> score &lt; <span style="color:#ff0;font-weight:bold">60</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DELETE</span> <span style="color:#fff;font-weight:bold">FROM</span> exam_record <span style="color:#fff;font-weight:bold">WHERE</span> TIMESTAMPDIFF(<span style="color:#fff;font-weight:bold">MINUTE</span>, start_time, submit_time) &lt; <span style="color:#ff0;font-weight:bold">5</span> <span style="color:#fff;font-weight:bold">AND</span> score &lt; <span style="color:#ff0;font-weight:bold">60</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="删除记录二">删除记录（二）<a hidden class="anchor" aria-hidden="true" href="#删除记录二">#</a></h3>
<p><strong>描述</strong>：现有一张试卷作答记录表<code>exam_record</code>，其中包含多年来的用户作答试卷记录，结构如下表：</p>
<p>作答记录表<code>exam_record</code>：<code>start_time</code> 是试卷开始时间，<code>submit_time</code> 是交卷时间，即结束时间，如果未完成的话，则为空。</p>
<table>
<thead>
<tr>
<th>Filed</th>
<th>Type</th>
<th style="text-align:center">Null</th>
<th>Key</th>
<th>Extra</th>
<th>Default</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int(11)</td>
<td style="text-align:center">NO</td>
<td>PRI</td>
<td>auto_increment</td>
<td>(NULL)</td>
<td>自增 ID</td>
</tr>
<tr>
<td>uid</td>
<td>int(11)</td>
<td style="text-align:center">NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>用户 ID</td>
</tr>
<tr>
<td>exam_id</td>
<td>int(11)</td>
<td style="text-align:center">NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>试卷 ID</td>
</tr>
<tr>
<td>start_time</td>
<td>datetime</td>
<td style="text-align:center">NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>开始时间</td>
</tr>
<tr>
<td>submit_time</td>
<td>datetime</td>
<td style="text-align:center">YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>提交时间</td>
</tr>
<tr>
<td>score</td>
<td>tinyint(4)</td>
<td style="text-align:center">YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>分数</td>
</tr>
</tbody>
</table>
<p><strong>要求</strong>：请删除<code>exam_record</code>表中未完成作答==或==作答时间小于 5 分钟整的记录中，开始作答时间最早的 3 条记录。</p>
<p><strong>思路</strong>：这题比较简单，但是要注意题干中给出的信息，结束时间，如果未完成的话，则为空，这个其实就是一个条件</p>
<p>还有一个条件就是小于 5 分钟，跟上题类似，但是这里是<strong>或</strong>，即两个条件满足一个就行；另外就是稍微考察到了排序和 limit 的用法。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DELETE</span> <span style="color:#fff;font-weight:bold">FROM</span> exam_record <span style="color:#fff;font-weight:bold">WHERE</span> submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">null</span> <span style="color:#fff;font-weight:bold">OR</span> TIMESTAMPDIFF(<span style="color:#fff;font-weight:bold">MINUTE</span>, start_time, submit_time) &lt; <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> start_time
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LIMIT</span> <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span># <span style="color:#f00">默认就是</span><span style="color:#fff;font-weight:bold">asc</span><span style="color:#f00">，</span> desc<span style="color:#f00">是降序排列</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="删除记录三">删除记录（三）<a hidden class="anchor" aria-hidden="true" href="#删除记录三">#</a></h3>
<p><strong>描述</strong>：现有一张试卷作答记录表 exam_record，其中包含多年来的用户作答试卷记录，结构如下表：</p>
<table>
<thead>
<tr>
<th>Filed</th>
<th>Type</th>
<th style="text-align:center">Null</th>
<th>Key</th>
<th>Extra</th>
<th>Default</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int(11)</td>
<td style="text-align:center">NO</td>
<td>PRI</td>
<td>auto_increment</td>
<td>(NULL)</td>
<td>自增 ID</td>
</tr>
<tr>
<td>uid</td>
<td>int(11)</td>
<td style="text-align:center">NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>用户 ID</td>
</tr>
<tr>
<td>exam_id</td>
<td>int(11)</td>
<td style="text-align:center">NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>试卷 ID</td>
</tr>
<tr>
<td>start_time</td>
<td>datetime</td>
<td style="text-align:center">NO</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>开始时间</td>
</tr>
<tr>
<td>submit_time</td>
<td>datetime</td>
<td style="text-align:center">YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>提交时间</td>
</tr>
<tr>
<td>score</td>
<td>tinyint(4)</td>
<td style="text-align:center">YES</td>
<td></td>
<td></td>
<td>(NULL)</td>
<td>分数</td>
</tr>
</tbody>
</table>
<p><strong>要求</strong>：请删除<code>exam_record</code>表中所有记录，==并重置自增主键==</p>
<p><strong>思路</strong>：这题考察对三种删除语句的区别，注意高亮部分，要求重置主键；</p>
<ul>
<li><code>DROP</code>: 清空表，删除表结构，不可逆</li>
<li><code>TRUNCATE</code>: 格式化表，不删除表结构，不可逆</li>
<li><code>DELETE</code>：删除数据，可逆</li>
</ul>
<p>这里选用<code>TRUNCATE</code>的原因是：TRUNCATE 只能作用于表；<code>TRUNCATE</code>会清空表中的所有行，但表结构及其约束、索引等保持不变；<code>TRUNCATE</code>会重置表的自增值；使用<code>TRUNCATE</code>后会使表和索引所占用的空间会恢复到初始大小。</p>
<p>这题也可以采用<code>DELETE</code>来做，但是在删除后，还需要手动<code>ALTER</code>表结构来设置主键初始值；</p>
<p>同理也可以采用<code>DROP</code>来做，直接删除整张表，包括表结构，然后再新建表即可。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">TRUNCATE</span>  exam_record;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="表与索引操作">表与索引操作<a hidden class="anchor" aria-hidden="true" href="#表与索引操作">#</a></h2>
<h3 id="创建一张新表">创建一张新表<a hidden class="anchor" aria-hidden="true" href="#创建一张新表">#</a></h3>
<p><strong>描述</strong>：现有一张用户信息表，其中包含多年来在平台注册过的用户信息，随着牛客平台的不断壮大，用户量飞速增长，为了高效地为高活跃用户提供服务，现需要将部分用户拆分出一张新表。</p>
<p>原来的用户信息表：</p>
<table>
<thead>
<tr>
<th>Filed</th>
<th>Type</th>
<th>Null</th>
<th>Key</th>
<th>Default</th>
<th>Extra</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int(11)</td>
<td>NO</td>
<td>PRI</td>
<td>(NULL)</td>
<td>auto_increment</td>
<td>自增 ID</td>
</tr>
<tr>
<td>uid</td>
<td>int(11)</td>
<td>NO</td>
<td>UNI</td>
<td>(NULL)</td>
<td></td>
<td>用户 ID</td>
</tr>
<tr>
<td>nick_name</td>
<td>varchar(64)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>昵称</td>
</tr>
<tr>
<td>achievement</td>
<td>int(11)</td>
<td>YES</td>
<td></td>
<td>0</td>
<td></td>
<td>成就值</td>
</tr>
<tr>
<td>level</td>
<td>int(11)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>用户等级</td>
</tr>
<tr>
<td>job</td>
<td>varchar(32)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>职业方向</td>
</tr>
<tr>
<td>register_time</td>
<td>datetime</td>
<td>YES</td>
<td></td>
<td>CURRENT_TIMESTAMP</td>
<td></td>
<td>注册时间</td>
</tr>
</tbody>
</table>
<p>作为数据分析师，请<strong>创建一张优质用户信息表 user_info_vip</strong>，表结构和用户信息表一致。</p>
<p>你应该返回的输出如下表格所示，请写出建表语句将表格中所有限制和说明记录到表里。</p>
<table>
<thead>
<tr>
<th>Filed</th>
<th>Type</th>
<th>Null</th>
<th>Key</th>
<th>Default</th>
<th>Extra</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int(11)</td>
<td>NO</td>
<td>PRI</td>
<td>(NULL)</td>
<td>auto_increment</td>
<td>自增 ID</td>
</tr>
<tr>
<td>uid</td>
<td>int(11)</td>
<td>NO</td>
<td>UNI</td>
<td>(NULL)</td>
<td></td>
<td>用户 ID</td>
</tr>
<tr>
<td>nick_name</td>
<td>varchar(64)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>昵称</td>
</tr>
<tr>
<td>achievement</td>
<td>int(11)</td>
<td>YES</td>
<td></td>
<td>0</td>
<td></td>
<td>成就值</td>
</tr>
<tr>
<td>level</td>
<td>int(11)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>用户等级</td>
</tr>
<tr>
<td>job</td>
<td>varchar(32)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>职业方向</td>
</tr>
<tr>
<td>register_time</td>
<td>datetime</td>
<td>YES</td>
<td></td>
<td>CURRENT_TIMESTAMP</td>
<td></td>
<td>注册时间</td>
</tr>
</tbody>
</table>
<p><strong>思路</strong>：如果这题给出了旧表的名称，可直接<code>create table 新表 as select * from 旧表;</code> 但是这题并没有给出旧表名称，所以需要自己创建，注意默认值和键的创建即可，比较简单。（注意：如果是在牛客网上面执行，请注意 comment 中要和题目中的 comment 保持一致，包括大小写，否则不通过，还有字符也要设置）</p>
<p>答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> <span style="color:#fff;font-weight:bold">IF</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">EXISTS</span> user_info_vip(
</span></span><span style="display:flex;"><span>    id <span style="color:#fff;font-weight:bold">INT</span>(<span style="color:#ff0;font-weight:bold">11</span>) <span style="color:#fff;font-weight:bold">PRIMARY</span> <span style="color:#fff;font-weight:bold">KEY</span> AUTO_INCREMENT <span style="color:#fff;font-weight:bold">COMMENT</span><span style="color:#0ff;font-weight:bold">&#39;自增ID&#39;</span>,
</span></span><span style="display:flex;"><span>    uid <span style="color:#fff;font-weight:bold">INT</span>(<span style="color:#ff0;font-weight:bold">11</span>) <span style="color:#fff;font-weight:bold">UNIQUE</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">COMMENT</span> <span style="color:#0ff;font-weight:bold">&#39;用户ID&#39;</span>,
</span></span><span style="display:flex;"><span>    nick_name <span style="color:#fff;font-weight:bold">VARCHAR</span>(<span style="color:#ff0;font-weight:bold">64</span>) <span style="color:#fff;font-weight:bold">COMMENT</span><span style="color:#0ff;font-weight:bold">&#39;昵称&#39;</span>,
</span></span><span style="display:flex;"><span>    achievement <span style="color:#fff;font-weight:bold">INT</span>(<span style="color:#ff0;font-weight:bold">11</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#ff0;font-weight:bold">0</span> <span style="color:#fff;font-weight:bold">COMMENT</span> <span style="color:#0ff;font-weight:bold">&#39;成就值&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">level</span> <span style="color:#fff;font-weight:bold">INT</span>(<span style="color:#ff0;font-weight:bold">11</span>) <span style="color:#fff;font-weight:bold">COMMENT</span> <span style="color:#0ff;font-weight:bold">&#39;用户等级&#39;</span>,
</span></span><span style="display:flex;"><span>    job <span style="color:#fff;font-weight:bold">VARCHAR</span>(<span style="color:#ff0;font-weight:bold">32</span>) <span style="color:#fff;font-weight:bold">COMMENT</span> <span style="color:#0ff;font-weight:bold">&#39;职业方向&#39;</span>,
</span></span><span style="display:flex;"><span>    register_time DATETIME <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#fff;font-weight:bold">CURRENT_TIMESTAMP</span> <span style="color:#fff;font-weight:bold">COMMENT</span> <span style="color:#0ff;font-weight:bold">&#39;注册时间&#39;</span>
</span></span><span style="display:flex;"><span>)<span style="color:#fff;font-weight:bold">CHARACTER</span> <span style="color:#fff;font-weight:bold">SET</span> UTF8
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="修改表">修改表<a hidden class="anchor" aria-hidden="true" href="#修改表">#</a></h3>
<p><strong>描述</strong>： 现有一张用户信息表<code>user_info</code>，其中包含多年来在平台注册过的用户信息。</p>
<p><strong>用户信息表 <code>user_info</code>：</strong></p>
<table>
<thead>
<tr>
<th>Filed</th>
<th>Type</th>
<th>Null</th>
<th>Key</th>
<th>Default</th>
<th>Extra</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int(11)</td>
<td>NO</td>
<td>PRI</td>
<td>(NULL)</td>
<td>auto_increment</td>
<td>自增 ID</td>
</tr>
<tr>
<td>uid</td>
<td>int(11)</td>
<td>NO</td>
<td>UNI</td>
<td>(NULL)</td>
<td></td>
<td>用户 ID</td>
</tr>
<tr>
<td>nick_name</td>
<td>varchar(64)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>昵称</td>
</tr>
<tr>
<td>achievement</td>
<td>int(11)</td>
<td>YES</td>
<td></td>
<td>0</td>
<td></td>
<td>成就值</td>
</tr>
<tr>
<td>level</td>
<td>int(11)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>用户等级</td>
</tr>
<tr>
<td>job</td>
<td>varchar(32)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>职业方向</td>
</tr>
<tr>
<td>register_time</td>
<td>datetime</td>
<td>YES</td>
<td></td>
<td>CURRENT_TIMESTAMP</td>
<td></td>
<td>注册时间</td>
</tr>
</tbody>
</table>
<p>**要求：**请在用户信息表，字段 <code>level</code> 的后面增加一列最多可保存 15 个汉字的字段 <code>school</code>；并将表中 <code>job</code> 列名改为 <code>profession</code>，同时 <code>varchar</code> 字段长度变为 10；<code>achievement</code> 的默认值设置为 0。</p>
<p><strong>思路</strong>：首先做这题之前，需要了解 ALTER 语句的基本用法：</p>
<ul>
<li>添加一列：<code>ALTER TABLE 表名 ADD COLUMN 列名 类型 【first | after 字段名】;</code>（first ： 在某列之前添加，after 反之）</li>
<li>修改列的类型或约束：<code>ALTER TABLE 表名 MODIFY COLUMN 列名 新类型 【新约束】;</code></li>
<li>修改列名：<code>ALTER TABLE 表名 change COLUMN 旧列名 新列名 类型;</code></li>
<li>删除列：<code>ALTER TABLE 表名 drop COLUMN 列名;</code></li>
<li>修改表名：<code>ALTER TABLE 表名 rename 【to】 新表名;</code></li>
<li>将某一列放到第一列：<code>ALTER TABLE 表名 MODIFY COLUMN 列名 类型 first;</code></li>
</ul>
<p><code>COLUMN</code> 关键字其实可以省略不写，这里基于规范还是罗列出来了。</p>
<p>在修改时，如果有多个修改项，可以写到一起，但要注意格式</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ALTER</span> <span style="color:#fff;font-weight:bold">TABLE</span> user_info
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">ADD</span> school <span style="color:#fff;font-weight:bold">VARCHAR</span>(<span style="color:#ff0;font-weight:bold">15</span>) <span style="color:#fff;font-weight:bold">AFTER</span> <span style="color:#fff;font-weight:bold">level</span>,
</span></span><span style="display:flex;"><span>    CHANGE job profession <span style="color:#fff;font-weight:bold">VARCHAR</span>(<span style="color:#ff0;font-weight:bold">10</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">MODIFY</span> achievement <span style="color:#fff;font-weight:bold">INT</span>(<span style="color:#ff0;font-weight:bold">11</span>) <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#ff0;font-weight:bold">0</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="删除表">删除表<a hidden class="anchor" aria-hidden="true" href="#删除表">#</a></h3>
<p><strong>描述</strong>：现有一张试卷作答记录表 <code>exam_record</code>，其中包含多年来的用户作答试卷记录。一般每年都会为 <code>exam_record</code> 表建立一张备份表 <code>exam_record_{YEAR}，{YEAR}</code> 为对应年份。</p>
<p>现在随着数据越来越多，存储告急，请你把很久前的（2011 到 2014 年）备份表都删掉（如果存在的话）。</p>
<p><strong>思路</strong>：这题很简单，直接删就行，如果嫌麻烦，可以将要删除的表用逗号隔开，写到一行；这里肯定会有小伙伴问：如果要删除很多张表呢？放心，如果要删除很多张表，可以写脚本来进行删除。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DROP</span> <span style="color:#fff;font-weight:bold">TABLE</span> <span style="color:#fff;font-weight:bold">IF</span> <span style="color:#fff;font-weight:bold">EXISTS</span> exam_record_2011;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DROP</span> <span style="color:#fff;font-weight:bold">TABLE</span> <span style="color:#fff;font-weight:bold">IF</span> <span style="color:#fff;font-weight:bold">EXISTS</span> exam_record_2012;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DROP</span> <span style="color:#fff;font-weight:bold">TABLE</span> <span style="color:#fff;font-weight:bold">IF</span> <span style="color:#fff;font-weight:bold">EXISTS</span> exam_record_2013;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DROP</span> <span style="color:#fff;font-weight:bold">TABLE</span> <span style="color:#fff;font-weight:bold">IF</span> <span style="color:#fff;font-weight:bold">EXISTS</span> exam_record_2014;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="创建索引">创建索引<a hidden class="anchor" aria-hidden="true" href="#创建索引">#</a></h3>
<p><strong>描述</strong>：现有一张试卷信息表 <code>examination_info</code>，其中包含各种类型试卷的信息。为了对表更方便快捷地查询，需要在 <code>examination_info</code> 表创建以下索引，</p>
<p>规则如下：在 <code>duration</code> 列创建普通索引 <code>idx_duration</code>、在 <code>exam_id</code> 列创建唯一性索引 <code>uniq_idx_exam_id</code>、在 <code>tag</code> 列创建全文索引 <code>full_idx_tag</code>。</p>
<p>根据题意，将返回如下结果：</p>
<table>
<thead>
<tr>
<th>examination_info</th>
<th>0</th>
<th>PRIMARY</th>
<th>1</th>
<th>id</th>
<th>A</th>
<th>0</th>
<th></th>
<th></th>
<th></th>
<th>BTREE</th>
</tr>
</thead>
<tbody>
<tr>
<td>examination_info</td>
<td>0</td>
<td>uniq_idx_exam_id</td>
<td>1</td>
<td>exam_id</td>
<td>A</td>
<td>0</td>
<td></td>
<td></td>
<td>YES</td>
<td>BTREE</td>
</tr>
<tr>
<td>examination_info</td>
<td>1</td>
<td>idx_duration</td>
<td>1</td>
<td>duration</td>
<td>A</td>
<td>0</td>
<td></td>
<td></td>
<td></td>
<td>BTREE</td>
</tr>
<tr>
<td>examination_info</td>
<td>1</td>
<td>full_idx_tag</td>
<td>1</td>
<td>tag</td>
<td></td>
<td>0</td>
<td></td>
<td></td>
<td>YES</td>
<td>FULLTEXT</td>
</tr>
</tbody>
</table>
<p>备注：后台会通过 <code>SHOW INDEX FROM examination_info</code> 语句来对比输出结果</p>
<p><strong>思路</strong>：做这题首先需要了解常见的索引类型：</p>
<ul>
<li>B-Tree 索引：B-Tree（或称为平衡树）索引是最常见和默认的索引类型。它适用于各种查询条件，可以快速定位到符合条件的数据。B-Tree 索引适用于普通的查找操作，支持等值查询、范围查询和排序。</li>
<li>唯一索引：唯一索引与普通的 B-Tree 索引类似，不同之处在于它要求被索引的列的值是唯一的。这意味着在插入或更新数据时，MySQL 会验证索引列的唯一性。</li>
<li>主键索引：主键索引是一种特殊的唯一索引，它用于唯一标识表中的每一行数据。每个表只能有一个主键索引，它可以帮助提高数据的访问速度和数据完整性。</li>
<li>全文索引：全文索引用于在文本数据中进行全文搜索。它支持在文本字段中进行关键字搜索，而不仅仅是简单的等值或范围查找。全文索引适用于需要进行全文搜索的应用场景。</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#007f7f">-- 示例：
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 添加B-Tree索引：
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">INDEX</span> idx_name(<span style="color:#f00">索引名</span>) <span style="color:#fff;font-weight:bold">ON</span> <span style="color:#f00">表名</span> (<span style="color:#f00">字段名</span>);   <span style="color:#007f7f">-- idx_name为索引名，以下都是
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 创建唯一索引：
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">UNIQUE</span> <span style="color:#fff;font-weight:bold">INDEX</span> idx_name <span style="color:#fff;font-weight:bold">ON</span> <span style="color:#f00">表名</span> (<span style="color:#f00">字段名</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 创建一个主键索引：
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">ALTER</span> <span style="color:#fff;font-weight:bold">TABLE</span> <span style="color:#f00">表名</span> <span style="color:#fff;font-weight:bold">ADD</span> <span style="color:#fff;font-weight:bold">PRIMARY</span> <span style="color:#fff;font-weight:bold">KEY</span> (<span style="color:#f00">字段名</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 创建一个全文索引
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">ALTER</span> <span style="color:#fff;font-weight:bold">TABLE</span> <span style="color:#f00">表名</span> <span style="color:#fff;font-weight:bold">ADD</span> FULLTEXT <span style="color:#fff;font-weight:bold">INDEX</span> idx_name (<span style="color:#f00">字段名</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 通过以上示例，可以看出create 和 alter 都可以添加索引
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>有了以上的基础知识之后，该题答案也就浮出水面了。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ALTER</span> <span style="color:#fff;font-weight:bold">TABLE</span> examination_info
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">ADD</span> <span style="color:#fff;font-weight:bold">INDEX</span> idx_duration(duration),
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">ADD</span> <span style="color:#fff;font-weight:bold">UNIQUE</span> <span style="color:#fff;font-weight:bold">INDEX</span> uniq_idx_exam_id(exam_id),
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">ADD</span> FULLTEXT <span style="color:#fff;font-weight:bold">INDEX</span> full_idx_tag(tag);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="删除索引">删除索引<a hidden class="anchor" aria-hidden="true" href="#删除索引">#</a></h3>
<p><strong>描述</strong>：请删除<code>examination_info</code>表上的唯一索引 uniq_idx_exam_id 和全文索引 full_idx_tag。</p>
<p><strong>思路</strong>：该题考察删除索引的基本语法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#007f7f">-- 使用 DROP INDEX 删除索引
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">DROP</span> <span style="color:#fff;font-weight:bold">INDEX</span> idx_name <span style="color:#fff;font-weight:bold">ON</span> <span style="color:#f00">表名</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 使用 ALTER TABLE 删除索引
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">ALTER</span> <span style="color:#fff;font-weight:bold">TABLE</span> employees <span style="color:#fff;font-weight:bold">DROP</span> <span style="color:#fff;font-weight:bold">INDEX</span> idx_email;
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里需要注意的是：在 MySQL 中，一次删除多个索引的操作是不支持的。每次删除索引时，只能指定一个索引名称进行删除。</p>
<p>而且 <strong>DROP</strong> 命令需要慎用！！！</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DROP</span> <span style="color:#fff;font-weight:bold">INDEX</span> uniq_idx_exam_id <span style="color:#fff;font-weight:bold">ON</span> examination_info;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DROP</span> <span style="color:#fff;font-weight:bold">INDEX</span> full_idx_tag <span style="color:#fff;font-weight:bold">ON</span> examination_info;
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="sql面试题3">SQL面试题3<a hidden class="anchor" aria-hidden="true" href="#sql面试题3">#</a></h1>
<h2 id="聚合函数">聚合函数<a hidden class="anchor" aria-hidden="true" href="#聚合函数">#</a></h2>
<h3 id="sql-类别高难度试卷得分的截断平均值较难">SQL 类别高难度试卷得分的截断平均值（较难）<a hidden class="anchor" aria-hidden="true" href="#sql-类别高难度试卷得分的截断平均值较难">#</a></h3>
<p><strong>描述</strong>： 牛客的运营同学想要查看大家在 SQL 类别中高难度试卷的得分情况。</p>
<p>请你帮她从<code>exam_record</code>数据表中计算所有用户完成 SQL 类别高难度试卷得分的截断平均值（去掉一个最大值和一个最小值后的平均值）。</p>
<p>示例数据：<code>examination_info</code>（<code>exam_id</code> 试卷 ID, tag 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2020-08-02 10:00:00</td>
</tr>
</tbody>
</table>
<p>示例数据：<code>exam_record</code>（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 09:01:01</td>
<td>2020-01-02 09:21:01</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1001</td>
<td>9001</td>
<td>2021-05-02 10:01:01</td>
<td>2021-05-02 10:30:01</td>
<td>81</td>
</tr>
<tr>
<td>3</td>
<td>1001</td>
<td>9001</td>
<td>2021-06-02 19:01:01</td>
<td>2021-06-02 19:31:01</td>
<td>84</td>
</tr>
<tr>
<td>4</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-05 19:01:01</td>
<td>2021-09-05 19:40:01</td>
<td>89</td>
</tr>
<tr>
<td>5</td>
<td>1001</td>
<td>9001</td>
<td>2021-09-02 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>6</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>7</td>
<td>1002</td>
<td>9002</td>
<td>2021-02-02 19:01:01</td>
<td>2021-02-02 19:30:01</td>
<td>87</td>
</tr>
<tr>
<td>8</td>
<td>1002</td>
<td>9001</td>
<td>2021-05-05 18:01:01</td>
<td>2021-05-05 18:59:02</td>
<td>90</td>
</tr>
<tr>
<td>9</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-07 12:01:01</td>
<td>2021-09-07 10:31:01</td>
<td>50</td>
</tr>
<tr>
<td>10</td>
<td>1004</td>
<td>9001</td>
<td>2021-09-06 10:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p>根据输入你的查询结果如下：</p>
<table>
<thead>
<tr>
<th>tag</th>
<th>difficulty</th>
<th>clip_avg_score</th>
</tr>
</thead>
<tbody>
<tr>
<td>SQL</td>
<td>hard</td>
<td>81.7</td>
</tr>
</tbody>
</table>
<p>从<code>examination_info</code>表可知，试卷 9001 为高难度 SQL 试卷，该试卷被作答的得分有[80,81,84,90,50]，去除最高分和最低分后为[80,81,84]，平均分为 81.6666667，保留一位小数后为 81.7</p>
<p><strong>输入描述：</strong></p>
<p>输入数据中至少有 3 个有效分数</p>
<p><strong>思路一：</strong> 要找出高难度 sql 试卷，肯定需要联 examination_info 这张表，然后找出高难度的课程，由 examination_info 得知，高难度 sql 的 exam_id 为 9001，那么等下就以 exam_id = 9001 作为条件去查询；</p>
<p>先找出 9001 号考试 <code>select * from exam_record where exam_id = 9001</code></p>
<p>然后，找出最高分 <code>select max(score) 最高分 from exam_record where exam_id = 9001</code></p>
<p>接着，找出最低分 <code>select min(score) 最低分 from exam_record where exam_id = 9001</code></p>
<p>在查询出来的分数结果集当中，去掉最高分和最低分，最直观能想到的就是 NOT IN 或者 用 NOT EXISTS 也行，这里以 NOT IN 来做</p>
<p>首先将主体写出来<code>select tag, difficulty, round(avg(score), 1) clip_avg_score from examination_info info INNER JOIN exam_record record</code></p>
<p><strong>小 tips</strong> : MYSQL 的 <code>ROUND()</code> 函数 ,<code>ROUND(X)</code>返回参数 X 最近似的整数 <code>ROUND(X,D)</code>返回 X ,其值保留到小数点后 D 位,第 D 位的保留方式为四舍五入。</p>
<p>再将上面的 &ldquo;碎片&rdquo; 语句拼凑起来即可， 注意在 NOT IN 中两个子查询用 UNION ALL 来关联，用 union 把 max 和 min 的结果集中在一行当中，这样形成一列多行的效果。</p>
<p><strong>答案一：</strong></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> tag, difficulty, ROUND(<span style="color:#fff;font-weight:bold">AVG</span>(score), <span style="color:#ff0;font-weight:bold">1</span>) clip_avg_score
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span> examination_info info  <span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record record
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">WHERE</span> info.exam_id = record.exam_id
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">AND</span>  record.exam_id = <span style="color:#ff0;font-weight:bold">9001</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fff;font-weight:bold">AND</span> record.score <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">IN</span>(
</span></span><span style="display:flex;"><span>					<span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">MAX</span>(score)
</span></span><span style="display:flex;"><span>						<span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span>							<span style="color:#fff;font-weight:bold">WHERE</span> exam_id = <span style="color:#ff0;font-weight:bold">9001</span>
</span></span><span style="display:flex;"><span>								<span style="color:#fff;font-weight:bold">UNION</span> <span style="color:#fff;font-weight:bold">ALL</span>
</span></span><span style="display:flex;"><span>					<span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">MIN</span>(score)
</span></span><span style="display:flex;"><span>						<span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span>							<span style="color:#fff;font-weight:bold">WHERE</span> exam_id = <span style="color:#ff0;font-weight:bold">9001</span>
</span></span><span style="display:flex;"><span>				)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是最直观，也是最容易想到的解法，但是还有待改进，这算是投机取巧过关，其实严格按照题目要求应该这么写：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> tag,
</span></span><span style="display:flex;"><span>       difficulty,
</span></span><span style="display:flex;"><span>       ROUND(<span style="color:#fff;font-weight:bold">AVG</span>(score), <span style="color:#ff0;font-weight:bold">1</span>) clip_avg_score
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> examination_info info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> info.exam_id = record.exam_id
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> record.exam_id =
</span></span><span style="display:flex;"><span>    (<span style="color:#fff;font-weight:bold">SELECT</span> examination_info.exam_id
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> examination_info
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">WHERE</span> tag = <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">AND</span> difficulty = <span style="color:#0ff;font-weight:bold">&#39;hard&#39;</span> )
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> record.score <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">IN</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">MAX</span>(score)
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">WHERE</span> exam_id =
</span></span><span style="display:flex;"><span>         (<span style="color:#fff;font-weight:bold">SELECT</span> examination_info.exam_id
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">FROM</span> examination_info
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">WHERE</span> tag = <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">AND</span> difficulty = <span style="color:#0ff;font-weight:bold">&#39;hard&#39;</span> )
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">UNION</span> <span style="color:#fff;font-weight:bold">ALL</span> <span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">MIN</span>(score)
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">WHERE</span> exam_id =
</span></span><span style="display:flex;"><span>         (<span style="color:#fff;font-weight:bold">SELECT</span> examination_info.exam_id
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">FROM</span> examination_info
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">WHERE</span> tag = <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">AND</span> difficulty = <span style="color:#0ff;font-weight:bold">&#39;hard&#39;</span> ) )
</span></span></code></pre></td></tr></table>
</div>
</div><p>然而你会发现，重复的语句非常多，所以可以利用<code>WITH</code>来抽取公共部分</p>
<p><strong><code>WITH</code> 子句介绍</strong>：</p>
<p><code>WITH</code> 子句，也称为公共表表达式（Common Table Expression，CTE），是在 SQL 查询中定义临时表的方式。它可以让我们在查询中创建一个临时命名的结果集，并且可以在同一查询中引用该结果集。</p>
<p>基本用法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WITH</span> cte_name (column1, column2, ..., columnN) <span style="color:#fff;font-weight:bold">AS</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">-- 查询体
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">SELECT</span> ...
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">FROM</span> ...
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">WHERE</span> ...
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 主查询
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">SELECT</span> ...
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> cte_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> ...
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>WITH</code> 子句由以下几个部分组成：</p>
<ul>
<li><code>cte_name</code>: 给临时表起一个名称，可以在主查询中引用。</li>
<li><code>(column1, column2, ..., columnN)</code>: 可选，指定临时表的列名。</li>
<li><code>AS</code>: 必需，表示开始定义临时表。</li>
<li><code>CTE 查询体</code>: 实际的查询语句，用于定义临时表中的数据。</li>
</ul>
<p><code>WITH</code> 子句的主要用途之一是增强查询的可读性和可维护性，尤其在涉及多个嵌套子查询或需要重复使用相同的查询逻辑时。通过将这些逻辑放在一个命名的临时表中，我们可以更清晰地组织查询，并消除重复代码。</p>
<p>此外，<code>WITH</code> 子句还可以在复杂的查询中实现递归查询。递归查询允许我们在单个查询中执行对同一表的多次迭代，逐步构建结果集。这在处理层次结构数据、组织结构和树状结构等场景中非常有用。</p>
<p><strong>小细节</strong>：MySQL 5.7 版本以及之前的版本不支持在 <code>WITH</code> 子句中直接使用别名。</p>
<p>下面是改进后的答案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WITH</span> t1 <span style="color:#fff;font-weight:bold">AS</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> record.*,
</span></span><span style="display:flex;"><span>          info.tag,
</span></span><span style="display:flex;"><span>          info.difficulty
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record record
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info info <span style="color:#fff;font-weight:bold">ON</span> record.exam_id = info.exam_id
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> info.tag = <span style="color:#0ff;font-weight:bold">&#34;SQL&#34;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">AND</span> info.difficulty = <span style="color:#0ff;font-weight:bold">&#34;hard&#34;</span> )
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> tag,
</span></span><span style="display:flex;"><span>       difficulty,
</span></span><span style="display:flex;"><span>       ROUND(<span style="color:#fff;font-weight:bold">AVG</span>(score), <span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> t1
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> score <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">IN</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">max</span>(score)
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> t1
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">UNION</span> <span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">min</span>(score)
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> t1)
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>思路二：</strong></p>
<ul>
<li>筛选 SQL 高难度试卷：<code>where tag=&quot;SQL&quot; and difficulty=&quot;hard&quot;</code></li>
<li>计算截断平均值：<code>(和-最大值-最小值) / (总个数-2):</code>
<ul>
<li><code>(sum(score) - max(score) - min(score)) / (count(score) - 2)</code></li>
<li>有一个缺点就是，如果最大值和最小值有多个，这个方法就很难筛选出来, 但是题目中说了&mdash;&ndash;&gt;<strong><code>去掉一个最大值和一个最小值后的平均值</code></strong>, 所以这里可以用这个公式。</li>
</ul>
</li>
</ul>
<p><strong>答案二：</strong></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> info.tag,
</span></span><span style="display:flex;"><span>       info.difficulty,
</span></span><span style="display:flex;"><span>       ROUND((<span style="color:#fff;font-weight:bold">SUM</span>(record.score)- <span style="color:#fff;font-weight:bold">MIN</span>(record.score)- <span style="color:#fff;font-weight:bold">MAX</span>(record.score)) / (<span style="color:#fff;font-weight:bold">COUNT</span>(record.score)- <span style="color:#ff0;font-weight:bold">2</span>), <span style="color:#ff0;font-weight:bold">1</span>) <span style="color:#fff;font-weight:bold">AS</span> clip_avg_score
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> examination_info info,
</span></span><span style="display:flex;"><span>     exam_record record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> info.exam_id = record.exam_id
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> info.tag = <span style="color:#0ff;font-weight:bold">&#34;SQL&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> info.difficulty = <span style="color:#0ff;font-weight:bold">&#34;hard&#34;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="统计作答次数">统计作答次数<a hidden class="anchor" aria-hidden="true" href="#统计作答次数">#</a></h3>
<p>有一个试卷作答记录表 <code>exam_record</code>，请从中统计出总作答次数 <code>total_pv</code>、试卷已完成作答数 <code>complete_pv</code>、已完成的试卷数 <code>complete_exam_cnt</code>。</p>
<p>示例数据 <code>exam_record</code> 表（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 09:01:01</td>
<td>2020-01-02 09:21:01</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1001</td>
<td>9001</td>
<td>2021-05-02 10:01:01</td>
<td>2021-05-02 10:30:01</td>
<td>81</td>
</tr>
<tr>
<td>3</td>
<td>1001</td>
<td>9001</td>
<td>2021-06-02 19:01:01</td>
<td>2021-06-02 19:31:01</td>
<td>84</td>
</tr>
<tr>
<td>4</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-05 19:01:01</td>
<td>2021-09-05 19:40:01</td>
<td>89</td>
</tr>
<tr>
<td>5</td>
<td>1001</td>
<td>9001</td>
<td>2021-09-02 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>6</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>7</td>
<td>1002</td>
<td>9002</td>
<td>2021-02-02 19:01:01</td>
<td>2021-02-02 19:30:01</td>
<td>87</td>
</tr>
<tr>
<td>8</td>
<td>1002</td>
<td>9001</td>
<td>2021-05-05 18:01:01</td>
<td>2021-05-05 18:59:02</td>
<td>90</td>
</tr>
<tr>
<td>9</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-07 12:01:01</td>
<td>2021-09-07 10:31:01</td>
<td>50</td>
</tr>
<tr>
<td>10</td>
<td>1004</td>
<td>9001</td>
<td>2021-09-06 10:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p>示例输出：</p>
<table>
<thead>
<tr>
<th>total_pv</th>
<th>complete_pv</th>
<th>complete_exam_cnt</th>
</tr>
</thead>
<tbody>
<tr>
<td>11</td>
<td>7</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>解释：表示截止当前，有 11 次试卷作答记录，已完成的作答次数为 7 次（中途退出的为未完成状态，其交卷时间和份数为 NULL），已完成的试卷有 9001 和 9002 两份。</p>
<p><strong>思路</strong>： 这题一看到统计次数，肯定第一时间就要想到用<code>COUNT</code>这个函数来解决，问题是要统计不同的记录，该怎么来写？使用子查询就能解决这个题目(这题用 case when 也能写出来，解法类似，逻辑不同而已)；首先在做这个题之前，让我们先来了解一下<code>COUNT</code>的基本用法；</p>
<p><code>COUNT()</code> 函数的基本语法如下所示：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">COUNT</span>(expression)
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中，<code>expression</code> 可以是列名、表达式、常量或通配符。下面是一些常见的用法示例：</p>
<ol>
<li>计算表中所有行的数量：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">COUNT</span>(*) <span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table_name</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>计算特定列非空（不为 NULL）值的数量：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">COUNT</span>(<span style="color:#fff;font-weight:bold">column_name</span>) <span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table_name</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>计算满足条件的行数：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">COUNT</span>(*) <span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table_name</span> <span style="color:#fff;font-weight:bold">WHERE</span> condition;
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>结合 <code>GROUP BY</code> 使用，计算分组后每个组的行数：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">column_name</span>, <span style="color:#fff;font-weight:bold">COUNT</span>(*) <span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table_name</span> <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">column_name</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>计算不同列组合的唯一组合数：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">COUNT</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> column_name1, column_name2) <span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table_name</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>在使用 <code>COUNT()</code> 函数时，如果不指定任何参数或者使用 <code>COUNT(*)</code>，将会计算所有行的数量。而如果使用列名，则只会计算该列非空值的数量。</p>
<p>另外，<code>COUNT()</code> 函数的结果是一个整数值。即使结果是零，也不会返回 NULL，这点需要谨记。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">count</span>(*) total_pv,
</span></span><span style="display:flex;"><span>	( <span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">FROM</span> exam_record <span style="color:#fff;font-weight:bold">WHERE</span> submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span> ) complete_pv,
</span></span><span style="display:flex;"><span>	( <span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">COUNT</span>( <span style="color:#fff;font-weight:bold">DISTINCT</span> exam_id, score <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">OR</span> <span style="color:#fff;font-weight:bold">NULL</span> ) <span style="color:#fff;font-weight:bold">FROM</span> exam_record ) complete_exam_cnt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	exam_record
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里着重说一下<code>COUNT( DISTINCT exam_id, score IS NOT NULL OR NULL )</code>这一句，判断 score 是否为 null ，如果是即为真，如果不是返回 null；注意这里如果不加 <code>or null</code> 在不是 null 的情况下只会返回 false 也就是返回 0；</p>
<p><code>COUNT</code>本身是不可以对多列求行数的，<code>distinct</code>的加入是的多列成为一个整体，可以求出现的行数了;<code>count distinct</code>在计算时只返回非 null 的行, 这个也要注意；</p>
<p>另外通过本题 get 到了&mdash;&mdash;&gt;count 加条件常用句式<code>count( 列判断 or null)</code></p>
<h3 id="得分不小于平均分的最低分">得分不小于平均分的最低分<a hidden class="anchor" aria-hidden="true" href="#得分不小于平均分的最低分">#</a></h3>
<p><strong>描述</strong>： 请从试卷作答记录表中找到 SQL 试卷得分不小于该类试卷平均得分的用户最低得分。</p>
<p>示例数据 exam_record 表（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 09:01:01</td>
<td>2020-01-02 09:21:01</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-05 19:01:01</td>
<td>2021-09-05 19:40:01</td>
<td>89</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-02 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>9003</td>
<td>2021-09-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>5</td>
<td>1002</td>
<td>9001</td>
<td>2021-02-02 19:01:01</td>
<td>2021-02-02 19:30:01</td>
<td>87</td>
</tr>
<tr>
<td>6</td>
<td>1002</td>
<td>9002</td>
<td>2021-05-05 18:01:01</td>
<td>2021-05-05 18:59:02</td>
<td>90</td>
</tr>
<tr>
<td>7</td>
<td>1003</td>
<td>9002</td>
<td>2021-02-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>8</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:31:01</td>
<td>86</td>
</tr>
<tr>
<td>9</td>
<td>1004</td>
<td>9003</td>
<td>2021-09-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p><code>examination_info</code> 表（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>SQL</td>
<td>easy</td>
<td>60</td>
<td>2020-02-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2020-08-02 10:00:00</td>
</tr>
</tbody>
</table>
<p>示例输出数据：</p>
<table>
<thead>
<tr>
<th>min_score_over_avg</th>
</tr>
</thead>
<tbody>
<tr>
<td>87</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：试卷 9001 和 9002 为 SQL 类别，作答这两份试卷的得分有[80,89,87,90]，平均分为 86.5，不小于平均分的最小分数为 87</p>
<p><strong>思路</strong>：这类题目第一眼看确实很复杂， 因为不知道从哪入手，但是当我们仔细读题审题后，要学会抓住题干中的关键信息。以本题为例：<code>请从试卷作答记录表中找到SQL试卷得分不小于该类试卷平均得分的用户最低得分。</code>你能一眼从中提取哪些有效信息来作为解题思路？</p>
<p>第一条：找到==SQL==试卷得分</p>
<p>第二条：该类试卷==平均得分==</p>
<p>第三条：该类试卷的==用户最低得分==</p>
<p>然后中间的 “桥梁” 就是==不小于==</p>
<p>将条件拆分后，先逐步完成</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#007f7f">-- 找出tag为‘SQL’的得分   【80, 89,87,90】
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 再算出这一组的平均得分
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">select</span>  ROUND(<span style="color:#fff;font-weight:bold">AVG</span>(score), <span style="color:#ff0;font-weight:bold">1</span>) <span style="color:#fff;font-weight:bold">from</span>  examination_info info <span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record record
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">where</span> info.exam_id = record.exam_id
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">and</span> tag= <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后再找出该类试卷的最低得分，接着将结果集<code>【80, 89,87,90】</code> 去和平均分数作比较，方可得出最终答案。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">MIN</span>(score) <span style="color:#fff;font-weight:bold">AS</span> min_score_over_avg
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> examination_info info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> info.exam_id = record.exam_id
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> tag= <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> score &gt;=
</span></span><span style="display:flex;"><span>    (<span style="color:#fff;font-weight:bold">SELECT</span> ROUND(<span style="color:#fff;font-weight:bold">AVG</span>(score), <span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> examination_info info
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record record
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">WHERE</span> info.exam_id = record.exam_id
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">AND</span> tag= <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span> )
</span></span></code></pre></td></tr></table>
</div>
</div><p>其实这类题目给出的要求看似很 “绕”，但其实仔细梳理一遍，将大条件拆分成小条件，逐个拆分完以后，最后将所有条件拼凑起来。反正只要记住：<strong>抓主干，理分支</strong>，问题便迎刃而解。</p>
<h2 id="分组查询">分组查询<a hidden class="anchor" aria-hidden="true" href="#分组查询">#</a></h2>
<h3 id="平均活跃天数和月活人数">平均活跃天数和月活人数<a hidden class="anchor" aria-hidden="true" href="#平均活跃天数和月活人数">#</a></h3>
<p><strong>描述</strong>：用户在牛客试卷作答区作答记录存储在表 <code>exam_record</code> 中，内容如下：</p>
<p><code>exam_record</code> 表（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2021-07-02 09:01:01</td>
<td>2021-07-02 09:21:01</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-05 19:01:01</td>
<td>2021-09-05 19:40:01</td>
<td>81</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-02 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>9003</td>
<td>2021-09-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>5</td>
<td>1002</td>
<td>9001</td>
<td>2021-07-02 19:01:01</td>
<td>2021-07-02 19:30:01</td>
<td>82</td>
</tr>
<tr>
<td>6</td>
<td>1002</td>
<td>9002</td>
<td>2021-07-05 18:01:01</td>
<td>2021-07-05 18:59:02</td>
<td>90</td>
</tr>
<tr>
<td>7</td>
<td>1003</td>
<td>9002</td>
<td>2021-07-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>8</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:31:01</td>
<td>86</td>
</tr>
<tr>
<td>9</td>
<td>1004</td>
<td>9003</td>
<td>2021-09-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>10</td>
<td>1002</td>
<td>9003</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>81</td>
</tr>
<tr>
<td>11</td>
<td>1005</td>
<td>9001</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>88</td>
</tr>
<tr>
<td>12</td>
<td>1006</td>
<td>9002</td>
<td>2021-09-02 12:11:01</td>
<td>2021-09-02 12:31:01</td>
<td>89</td>
</tr>
<tr>
<td>13</td>
<td>1007</td>
<td>9002</td>
<td>2020-09-02 12:11:01</td>
<td>2020-09-02 12:31:01</td>
<td>89</td>
</tr>
</tbody>
</table>
<p>请计算 2021 年每个月里试卷作答区用户平均月活跃天数 <code>avg_active_days</code> 和月度活跃人数 <code>mau</code>，上面数据的示例输出如下：</p>
<table>
<thead>
<tr>
<th>month</th>
<th>avg_active_days</th>
<th>mau</th>
</tr>
</thead>
<tbody>
<tr>
<td>202107</td>
<td>1.50</td>
<td>2</td>
</tr>
<tr>
<td>202109</td>
<td>1.25</td>
<td>4</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：2021 年 7 月有 2 人活跃，共活跃了 3 天（1001 活跃 1 天，1002 活跃 2 天），平均活跃天数 1.5；2021 年 9 月有 4 人活跃，共活跃了 5 天，平均活跃天数 1.25，结果保留 2 位小数。</p>
<p>注：此处活跃指有==交卷==行为。</p>
<p><strong>思路</strong>：读完题先注意高亮部分；一般求天数和月活跃人数马上就要想到相关的日期函数；这一题我们同样来进行拆分，把问题细化再解决；首先求活跃人数，肯定要用到<code>COUNT()</code>，那这里首先就有一个坑，不知道大家注意了没有？用户 1002 在 9 月份做了两种不同的试卷，所以这里要注意去重，不然在统计的时候，活跃人数是错的；第二个就是要知道日期的格式化，如上表，题目要求以<code>202107</code>这种日期格式展现，要用到<code>DATE_FORMAT</code>来进行格式化。</p>
<p>基本用法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DATE_FORMAT(date_value, format)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>date_value</code> 参数是待格式化的日期或时间值。</li>
<li><code>format</code> 参数是指定的日期或时间格式（这个和 Java 里面的日期格式一样）。</li>
</ul>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> DATE_FORMAT(submit_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) <span style="color:#fff;font-weight:bold">MONTH</span>,
</span></span><span style="display:flex;"><span>                                        round(<span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> UID, DATE_FORMAT(submit_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m%d&#39;</span>)) / <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> UID), <span style="color:#ff0;font-weight:bold">2</span>) avg_active_days,
</span></span><span style="display:flex;"><span>                                        <span style="color:#fff;font-weight:bold">COUNT</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> UID) mau
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">YEAR</span> (submit_time) = <span style="color:#ff0;font-weight:bold">2021</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">MONTH</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里多说一句, 使用<code>COUNT(DISTINCT uid, DATE_FORMAT(submit_time, '%Y%m%d'))</code> 可以统计在 <code>uid</code> 列和 <code>submit_time</code> 列按照年份、月份和日期进行格式化后的组合值的数量。</p>
<h3 id="月总刷题数和日均刷题数">月总刷题数和日均刷题数<a hidden class="anchor" aria-hidden="true" href="#月总刷题数和日均刷题数">#</a></h3>
<p><strong>描述</strong>：现有一张题目练习记录表 <code>practice_record</code>，示例内容如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>question_id</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>8001</td>
<td>2021-08-02 11:41:01</td>
<td>60</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>8001</td>
<td>2021-09-02 19:30:01</td>
<td>50</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>8001</td>
<td>2021-09-02 19:20:01</td>
<td>70</td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>8002</td>
<td>2021-09-02 19:38:01</td>
<td>70</td>
</tr>
<tr>
<td>5</td>
<td>1003</td>
<td>8002</td>
<td>2021-08-01 19:38:01</td>
<td>80</td>
</tr>
</tbody>
</table>
<p>请从中统计出 2021 年每个月里用户的月总刷题数 <code>month_q_cnt</code> 和日均刷题数 <code>avg_day_q_cnt</code>（按月份升序排序）以及该年的总体情况，示例数据输出如下：</p>
<table>
<thead>
<tr>
<th>submit_month</th>
<th>month_q_cnt</th>
<th>avg_day_q_cnt</th>
</tr>
</thead>
<tbody>
<tr>
<td>202108</td>
<td>2</td>
<td>0.065</td>
</tr>
<tr>
<td>202109</td>
<td>3</td>
<td>0.100</td>
</tr>
<tr>
<td>2021 汇总</td>
<td>5</td>
<td>0.161</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：2021 年 8 月共有 2 次刷题记录，日均刷题数为 2/31=0.065（保留 3 位小数）；2021 年 9 月共有 3 次刷题记录，日均刷题数为 3/30=0.100；2021 年共有 5 次刷题记录（年度汇总平均无实际意义，这里我们按照 31 天来算 5/31=0.161）</p>
<blockquote>
<p>牛客已经采用最新的 Mysql 版本，如果您运行结果出现错误：ONLY_FULL_GROUP_BY，意思是：对于 GROUP BY 聚合操作，如果在 SELECT 中的列，没有在 GROUP BY 中出现，那么这个 SQL 是不合法的，因为列不在 GROUP BY 从句中，也就是说查出来的列必须在 group by 后面出现否则就会报错，或者这个字段出现在聚合函数里面。</p>
</blockquote>
<p><strong>思路：</strong></p>
<p>看到实例数据就要马上联想到相关的函数，比如<code>submit_month</code>就要用到<code>DATE_FORMAT</code>来格式化日期。然后查出每月的刷题数量。</p>
<p>每月的刷题数量</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">MONTH</span> ( submit_time ), <span style="color:#fff;font-weight:bold">COUNT</span>( question_id )
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	practice_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">MONTH</span> (submit_time)
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着第三列这里要用到<code>DAY(LAST_DAY(date_value))</code>函数来查找给定日期的月份中的天数。</p>
<p>示例代码如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DAY</span>(LAST_DAY(<span style="color:#0ff;font-weight:bold">&#39;2023-07-08&#39;</span>)) <span style="color:#fff;font-weight:bold">AS</span> days_in_month;
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 输出：31
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DAY</span>(LAST_DAY(<span style="color:#0ff;font-weight:bold">&#39;2023-02-01&#39;</span>)) <span style="color:#fff;font-weight:bold">AS</span> days_in_month;
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 输出：28 (闰年中的二月份)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DAY</span>(LAST_DAY(NOW())) <span style="color:#fff;font-weight:bold">AS</span> days_in_current_month;
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 输出：31 （当前月份的天数）
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>使用 <code>LAST_DAY()</code> 函数获取给定日期的当月最后一天，然后使用 <code>DAY()</code> 函数提取该日期的天数。这样就能获得指定月份的天数。</p>
<p>需要注意的是，<code>LAST_DAY()</code> 函数返回的是日期值，而 <code>DAY()</code> 函数用于提取日期值中的天数部分。</p>
<p>有了上述的分析之后，即可马上写出答案，这题复杂就复杂在处理日期上，其中的逻辑并不难。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> DATE_FORMAT(submit_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) submit_month,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(question_id) month_q_cnt,
</span></span><span style="display:flex;"><span>       ROUND(<span style="color:#fff;font-weight:bold">COUNT</span>(question_id) / <span style="color:#fff;font-weight:bold">DAY</span> (LAST_DAY(submit_time)), <span style="color:#ff0;font-weight:bold">3</span>) avg_day_q_cnt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> practice_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> DATE_FORMAT(submit_time, <span style="color:#0ff;font-weight:bold">&#39;%Y&#39;</span>) = <span style="color:#0ff;font-weight:bold">&#39;2021&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> submit_month
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UNION</span> <span style="color:#fff;font-weight:bold">ALL</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#0ff;font-weight:bold">&#39;2021汇总&#39;</span> <span style="color:#fff;font-weight:bold">AS</span> submit_month,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(question_id) month_q_cnt,
</span></span><span style="display:flex;"><span>       ROUND(<span style="color:#fff;font-weight:bold">COUNT</span>(question_id) / <span style="color:#ff0;font-weight:bold">31</span>, <span style="color:#ff0;font-weight:bold">3</span>) avg_day_q_cnt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> practice_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> DATE_FORMAT(submit_time, <span style="color:#0ff;font-weight:bold">&#39;%Y&#39;</span>) = <span style="color:#0ff;font-weight:bold">&#39;2021&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> submit_month
</span></span></code></pre></td></tr></table>
</div>
</div><p>在实例数据输出中因为最后一行需要得出汇总数据，所以这里要 <code>UNION ALL</code>加到结果集中；别忘了最后要排序！</p>
<h3 id="未完成试卷数大于-1-的有效用户较难">未完成试卷数大于 1 的有效用户（较难）<a hidden class="anchor" aria-hidden="true" href="#未完成试卷数大于-1-的有效用户较难">#</a></h3>
<p><strong>描述</strong>：现有试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分），示例数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2021-07-02 09:01:01</td>
<td>2021-07-02 09:21:01</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-05 19:01:01</td>
<td>2021-09-05 19:40:01</td>
<td>81</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-02 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>9003</td>
<td>2021-09-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>5</td>
<td>1002</td>
<td>9001</td>
<td>2021-07-02 19:01:01</td>
<td>2021-07-02 19:30:01</td>
<td>82</td>
</tr>
<tr>
<td>6</td>
<td>1002</td>
<td>9002</td>
<td>2021-07-05 18:01:01</td>
<td>2021-07-05 18:59:02</td>
<td>90</td>
</tr>
<tr>
<td>7</td>
<td>1003</td>
<td>9002</td>
<td>2021-07-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>8</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:31:01</td>
<td>86</td>
</tr>
<tr>
<td>9</td>
<td>1004</td>
<td>9003</td>
<td>2021-09-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>10</td>
<td>1002</td>
<td>9003</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>81</td>
</tr>
<tr>
<td>11</td>
<td>1005</td>
<td>9001</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>88</td>
</tr>
<tr>
<td>12</td>
<td>1006</td>
<td>9002</td>
<td>2021-09-02 12:11:01</td>
<td>2021-09-02 12:31:01</td>
<td>89</td>
</tr>
<tr>
<td>13</td>
<td>1007</td>
<td>9002</td>
<td>2020-09-02 12:11:01</td>
<td>2020-09-02 12:31:01</td>
<td>89</td>
</tr>
</tbody>
</table>
<p>还有一张试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间），示例数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>SQL</td>
<td>easy</td>
<td>60</td>
<td>2020-02-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2020-08-02 10:00:00</td>
</tr>
</tbody>
</table>
<p>请统计 2021 年每个未完成试卷作答数大于 1 的有效用户的数据（有效用户指完成试卷作答数至少为 1 且未完成数小于 5），输出用户 ID、未完成试卷作答数、完成试卷作答数、作答过的试卷 tag 集合，按未完成试卷数量由多到少排序。示例数据的输出结果如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>incomplete_cnt</th>
<th>complete_cnt</th>
<th>detail</th>
</tr>
</thead>
<tbody>
<tr>
<td>1002</td>
<td>2</td>
<td>4</td>
<td>2021-09-01:算法;2021-07-02:SQL;2021-09-02:SQL;2021-09-05:SQL;2021-07-05:SQL</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：2021 年的作答记录中，除了 1004，其他用户均满足有效用户定义，但只有 1002 未完成试卷数大于 1，因此只输出 1002，detail 中是 1002 作答过的试卷{日期:tag}集合，日期和 tag 间用 <strong>:</strong> 连接，多元素间用 <strong>;</strong> 连接。</p>
<p><strong>思路：</strong></p>
<p>仔细读题后，分析出：首先要联表，因为后面要输出<code>tag</code>；</p>
<p>筛选出 2021 年的数据</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> *
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record er
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info ei <span style="color:#fff;font-weight:bold">ON</span> er.exam_id = ei.exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">YEAR</span> (er.start_time)= <span style="color:#ff0;font-weight:bold">2021</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据 uid 进行分组，然后对每个用户进行条件进行判断，题目中要求<code>完成试卷数至少为1,未完成试卷数要大于1，小于5</code></p>
<p>那么等会儿写 sql 的时候条件应该是：<code>未完成 &gt; 1 and 已完成 &gt;=1 and 未完成 &lt; 5</code></p>
<p>因为最后要用到字符串的拼接，而且还要组合拼接，这个可以用<code>GROUP_CONCAT</code>函数，下面简单介绍一下该函数的用法：</p>
<p>基本格式：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>GROUP_CONCAT([<span style="color:#fff;font-weight:bold">DISTINCT</span>] expr [<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#f00">{</span>unsigned_integer | col_name | expr<span style="color:#f00">}</span> [<span style="color:#fff;font-weight:bold">ASC</span> | <span style="color:#fff;font-weight:bold">DESC</span>] [, ...]]             [SEPARATOR sep])
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>expr</code>：要连接的列或表达式。</li>
<li><code>DISTINCT</code>：可选参数，用于去重。当指定了 <code>DISTINCT</code>，相同的值只会出现一次。</li>
<li><code>ORDER BY</code>：可选参数，用于排序连接后的值。可以选择升序 (<code>ASC</code>) 或降序 (<code>DESC</code>) 排序。</li>
<li><code>SEPARATOR sep</code>：可选参数，用于设置连接后的值的分隔符。（本题要用这个参数设置 ; 号 ）</li>
</ul>
<p><code>GROUP_CONCAT()</code> 函数常用于 <code>GROUP BY</code> 子句中，将一组行的值连接为一个字符串，并在结果集中以聚合的形式返回。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> a.uid,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">SUM</span>(<span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">WHEN</span> a.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">THEN</span> <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>           <span style="color:#fff;font-weight:bold">END</span>) <span style="color:#fff;font-weight:bold">AS</span> incomplete_cnt,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">SUM</span>(<span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">WHEN</span> a.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">THEN</span> <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>           <span style="color:#fff;font-weight:bold">END</span>) <span style="color:#fff;font-weight:bold">AS</span> complete_cnt,
</span></span><span style="display:flex;"><span>       GROUP_CONCAT(<span style="color:#fff;font-weight:bold">DISTINCT</span> CONCAT(DATE_FORMAT(a.start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y-%m-%d&#39;</span>), <span style="color:#0ff;font-weight:bold">&#39;:&#39;</span>, b.tag)
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> start_time SEPARATOR <span style="color:#0ff;font-weight:bold">&#34;;&#34;</span>) <span style="color:#fff;font-weight:bold">AS</span> detail
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record a
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info b <span style="color:#fff;font-weight:bold">ON</span> a.exam_id = b.exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">YEAR</span> (a.start_time)= <span style="color:#ff0;font-weight:bold">2021</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> a.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> incomplete_cnt &gt; <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">AND</span> complete_cnt &gt;= <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">AND</span> incomplete_cnt &lt; <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> incomplete_cnt <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>SUM(CASE WHEN a.submit_time IS NULL THEN 1 END)</code> 统计了每个用户未完成的记录数量。</li>
<li><code>SUM(CASE WHEN a.submit_time IS NOT NULL THEN 1 END)</code> 统计了每个用户已完成的记录数量。</li>
<li><code>GROUP_CONCAT(DISTINCT CONCAT(DATE_FORMAT(a.start_time, '%Y-%m-%d'), ':', b.tag) ORDER BY a.start_time SEPARATOR ';')</code> 将每个用户的考试日期和标签以逗号分隔的形式连接成一个字符串，并按考试开始时间进行排序。</li>
</ul>
<h2 id="嵌套子查询">嵌套子查询<a hidden class="anchor" aria-hidden="true" href="#嵌套子查询">#</a></h2>
<h3 id="月均完成试卷数不小于-3-的用户爱作答的类别较难">月均完成试卷数不小于 3 的用户爱作答的类别（较难）<a hidden class="anchor" aria-hidden="true" href="#月均完成试卷数不小于-3-的用户爱作答的类别较难">#</a></h3>
<p><strong>描述</strong>：现有试卷作答记录表 <code>exam_record</code>（<code>uid</code>：用户 ID, <code>exam_id</code>：试卷 ID, <code>start_time</code>：开始作答时间, <code>submit_time</code>：交卷时间，没提交的话为 NULL, <code>score</code>：得分），示例数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2021-07-02 09:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9003</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:21:01</td>
<td>60</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-02 12:01:01</td>
<td>2021-09-02 12:31:01</td>
<td>70</td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-05 19:01:01</td>
<td>2021-09-05 19:40:01</td>
<td>81</td>
</tr>
<tr>
<td>5</td>
<td>1002</td>
<td>9002</td>
<td>2021-07-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>6</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:31:01</td>
<td>86</td>
</tr>
<tr>
<td>7</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-08 12:01:01</td>
<td>2021-09-08 12:11:01</td>
<td>40</td>
</tr>
<tr>
<td>8</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-08 13:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>9</td>
<td>1003</td>
<td>9002</td>
<td>2021-09-08 14:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>10</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-08 15:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>11</td>
<td>1005</td>
<td>9001</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>88</td>
</tr>
<tr>
<td>12</td>
<td>1005</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>88</td>
</tr>
<tr>
<td>13</td>
<td>1005</td>
<td>9002</td>
<td>2021-09-02 12:11:01</td>
<td>2021-09-02 12:31:01</td>
<td>89</td>
</tr>
</tbody>
</table>
<p>试卷信息表 <code>examination_info</code>（<code>exam_id</code>：试卷 ID, <code>tag</code>：试卷类别, <code>difficulty</code>：试卷难度, <code>duration</code>：考试时长, <code>release_time</code>：发布时间），示例数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>C++</td>
<td>easy</td>
<td>60</td>
<td>2020-02-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2020-08-02 10:00:00</td>
</tr>
</tbody>
</table>
<p>请从表中统计出 “当月均完成试卷数”不小于 3 的用户们爱作答的类别及作答次数，按次数降序输出，示例输出如下：</p>
<table>
<thead>
<tr>
<th>tag</th>
<th>tag_cnt</th>
</tr>
</thead>
<tbody>
<tr>
<td>C++</td>
<td>4</td>
</tr>
<tr>
<td>SQL</td>
<td>2</td>
</tr>
<tr>
<td>算法</td>
<td>1</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：用户 1002 和 1005 在 2021 年 09 月的完成试卷数目均为 3，其他用户均小于 3；然后用户 1002 和 1005 作答过的试卷 tag 分布结果按作答次数降序排序依次为 C++、SQL、算法。</p>
<p><strong>思路</strong>：这题考察联合子查询，重点在于<code>月均回答&gt;=3</code>, 但是个人认为这里没有表述清楚，应该直接说查 9 月的就容易理解多了；这里不是每个月都要&gt;=3 或者是所有答题次数/答题月份。不要理解错误了。</p>
<p>先查询出哪些用户月均答题大于三次</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> UID
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> UID,
</span></span><span style="display:flex;"><span>         <span style="color:#fff;font-weight:bold">MONTH</span> (start_time)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">count</span>(submit_time) &gt;= <span style="color:#ff0;font-weight:bold">3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>有了这一步之后再进行深入，只要能理解上一步(我的意思是不被题目中的月均所困扰)，然后再套一个子查询，查哪些用户包含其中，然后查出题目中所需的列即可。记得排序！！</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> tag,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(start_time) <span style="color:#fff;font-weight:bold">AS</span> tag_cnt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info info <span style="color:#fff;font-weight:bold">ON</span> record.exam_id = info.exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> UID <span style="color:#fff;font-weight:bold">IN</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#fff;font-weight:bold">SELECT</span> UID
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> exam_record record
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> UID,
</span></span><span style="display:flex;"><span>              <span style="color:#fff;font-weight:bold">MONTH</span> (start_time)
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">count</span>(submit_time) &gt;= <span style="color:#ff0;font-weight:bold">3</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> tag
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> tag_cnt <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="试卷发布当天作答人数和平均分">试卷发布当天作答人数和平均分<a hidden class="anchor" aria-hidden="true" href="#试卷发布当天作答人数和平均分">#</a></h3>
<p><strong>描述</strong>：现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间），示例数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1 号</td>
<td>3100</td>
<td>7</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>2100</td>
<td>6</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>牛客 3 号</td>
<td>1500</td>
<td>5</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1004</td>
<td>牛客 4 号</td>
<td>1100</td>
<td>4</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>牛客 5 号</td>
<td>1600</td>
<td>6</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>6</td>
<td>1006</td>
<td>牛客 6 号</td>
<td>3000</td>
<td>6</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p><strong>释义</strong>：用户 1001 昵称为牛客 1 号，成就值为 3100，用户等级是 7 级，职业方向为算法，注册时间 2020-01-01 10:00:00</p>
<p>试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间） 示例数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>C++</td>
<td>easy</td>
<td>60</td>
<td>2020-02-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2020-08-02 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分） 示例数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2021-07-02 09:01:01</td>
<td>2021-09-01 09:41:01</td>
<td>70</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9003</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:21:01</td>
<td>60</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-02 12:01:01</td>
<td>2021-09-02 12:31:01</td>
<td>70</td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:40:01</td>
<td>80</td>
</tr>
<tr>
<td>5</td>
<td>1002</td>
<td>9003</td>
<td>2021-08-01 12:01:01</td>
<td>2021-08-01 12:21:01</td>
<td>60</td>
</tr>
<tr>
<td>6</td>
<td>1002</td>
<td>9002</td>
<td>2021-08-02 12:01:01</td>
<td>2021-08-02 12:31:01</td>
<td>70</td>
</tr>
<tr>
<td>7</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:40:01</td>
<td>85</td>
</tr>
<tr>
<td>8</td>
<td>1002</td>
<td>9002</td>
<td>2021-07-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>9</td>
<td>1003</td>
<td>9002</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:31:01</td>
<td>86</td>
</tr>
<tr>
<td>10</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-08 12:01:01</td>
<td>2021-09-08 12:11:01</td>
<td>40</td>
</tr>
<tr>
<td>11</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-01 13:01:01</td>
<td>2021-09-01 13:41:01</td>
<td>70</td>
</tr>
<tr>
<td>12</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-08 14:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>13</td>
<td>1003</td>
<td>9002</td>
<td>2021-09-08 15:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>14</td>
<td>1005</td>
<td>9001</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>90</td>
</tr>
<tr>
<td>15</td>
<td>1005</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>88</td>
</tr>
<tr>
<td>16</td>
<td>1005</td>
<td>9002</td>
<td>2021-09-02 12:11:01</td>
<td>2021-09-02 12:31:01</td>
<td>89</td>
</tr>
</tbody>
</table>
<p>请计算每张 SQL 类别试卷发布后，当天 5 级以上的用户作答的人数 <code>uv</code> 和平均分 <code>avg_score</code>，按人数降序，相同人数的按平均分升序，示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>exam_id</th>
<th>uv</th>
<th>avg_score</th>
</tr>
</thead>
<tbody>
<tr>
<td>9001</td>
<td>3</td>
<td>81.3</td>
</tr>
</tbody>
</table>
<p>解释：只有一张 SQL 类别的试卷，试卷 ID 为 9001，发布当天（2021-09-01）有 1001、1002、1003、1005 作答过，但是 1003 是 5 级用户，其他 3 位为 5 级以上，他们三的得分有[70,80,85,90]，平均分为 81.3（保留 1 位小数）。</p>
<p><strong>思路</strong>：这题看似很复杂，但是先逐步将“外边”条件拆分，然后合拢到一起，答案就出来，多表查询反正记住：由外向里，抽丝剥茧。</p>
<p>先把三种表连起来，同时给定一些条件，比如题目中要求<code>等级&gt; 5</code>的用户，那么可以先查出来</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DISTINCT</span> u_info.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> examination_info e_info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> user_info u_info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> e_info.exam_id = record.exam_id
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> u_info.uid = record.uid
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> u_info.<span style="color:#fff;font-weight:bold">LEVEL</span> &gt; <span style="color:#ff0;font-weight:bold">5</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着注意题目中要求：<code>每张sql类别试卷发布后，当天作答用户</code>，注意其中的==当天==，那我们马上就要想到要用到时间的比较。</p>
<p>对试卷发布日期和开始考试日期进行比较：<code>DATE(e_info.release_time) = DATE(record.start_time)</code>；不用担心<code>submit_time</code> 为 null 的问题，后续在 where 中会给过滤掉。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> record.exam_id <span style="color:#fff;font-weight:bold">AS</span> exam_id,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">COUNT</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> u_info.uid) <span style="color:#fff;font-weight:bold">AS</span> uv,
</span></span><span style="display:flex;"><span>       ROUND(<span style="color:#fff;font-weight:bold">SUM</span>(record.score) / <span style="color:#fff;font-weight:bold">COUNT</span>(u_info.uid), <span style="color:#ff0;font-weight:bold">1</span>) <span style="color:#fff;font-weight:bold">AS</span> avg_score
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> examination_info e_info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> user_info u_info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> e_info.exam_id = record.exam_id
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> u_info.uid = record.uid
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> <span style="color:#fff;font-weight:bold">DATE</span> (e_info.release_time) = <span style="color:#fff;font-weight:bold">DATE</span> (record.start_time)
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> tag = <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> u_info.<span style="color:#fff;font-weight:bold">LEVEL</span> &gt; <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> record.exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> uv <span style="color:#fff;font-weight:bold">DESC</span>,
</span></span><span style="display:flex;"><span>         avg_score <span style="color:#fff;font-weight:bold">ASC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意最后的分组排序！先按人数排，若一致，按平均分排。</p>
<h3 id="作答试卷得分大于过-80-的人的用户等级分布">作答试卷得分大于过 80 的人的用户等级分布<a hidden class="anchor" aria-hidden="true" href="#作答试卷得分大于过-80-的人的用户等级分布">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1 号</td>
<td>3100</td>
<td>7</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>2100</td>
<td>6</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>牛客 3 号</td>
<td>1500</td>
<td>5</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1004</td>
<td>牛客 4 号</td>
<td>1100</td>
<td>4</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>牛客 5 号</td>
<td>1600</td>
<td>6</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>6</td>
<td>1006</td>
<td>牛客 6 号</td>
<td>3000</td>
<td>6</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>C++</td>
<td>easy</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2021-09-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答信息表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2021-09-01 09:01:01</td>
<td>2021-09-01 09:41:01</td>
<td>79</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9003</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:21:01</td>
<td>60</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>70</td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:40:01</td>
<td>80</td>
</tr>
<tr>
<td>5</td>
<td>1002</td>
<td>9003</td>
<td>2021-08-01 12:01:01</td>
<td>2021-08-01 12:21:01</td>
<td>60</td>
</tr>
<tr>
<td>6</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>70</td>
</tr>
<tr>
<td>7</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:40:01</td>
<td>85</td>
</tr>
<tr>
<td>8</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>9</td>
<td>1003</td>
<td>9002</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:31:01</td>
<td>86</td>
</tr>
<tr>
<td>10</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-08 12:01:01</td>
<td>2021-09-08 12:11:01</td>
<td>40</td>
</tr>
<tr>
<td>11</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-01 13:01:01</td>
<td>2021-09-01 13:41:01</td>
<td>81</td>
</tr>
<tr>
<td>12</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-01 14:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>13</td>
<td>1003</td>
<td>9002</td>
<td>2021-09-08 15:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>14</td>
<td>1005</td>
<td>9001</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>90</td>
</tr>
<tr>
<td>15</td>
<td>1005</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>88</td>
</tr>
<tr>
<td>16</td>
<td>1005</td>
<td>9002</td>
<td>2021-09-02 12:11:01</td>
<td>2021-09-02 12:31:01</td>
<td>89</td>
</tr>
</tbody>
</table>
<p>统计作答 SQL 类别的试卷得分大于过 80 的人的用户等级分布，按数量降序排序（保证数量都不同）。示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>level</th>
<th>level_cnt</th>
</tr>
</thead>
<tbody>
<tr>
<td>6</td>
<td>2</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>解释：9001 为 SQL 类试卷，作答该试卷大于 80 分的人有 1002、1003、1005 共 3 人，6 级两人，5 级一人。</p>
<p>**思路：**这题和上一题都是一样的数据，只是查询条件改变了而已，上一题理解了，这题分分钟做出来。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> u_info.<span style="color:#fff;font-weight:bold">LEVEL</span> <span style="color:#fff;font-weight:bold">AS</span> <span style="color:#fff;font-weight:bold">LEVEL</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(u_info.uid) <span style="color:#fff;font-weight:bold">AS</span> level_cnt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> examination_info e_info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> user_info u_info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> e_info.exam_id = record.exam_id
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> u_info.uid = record.uid
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> record.score &gt; <span style="color:#ff0;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> tag = <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">LEVEL</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> level_cnt <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="合并查询">合并查询<a hidden class="anchor" aria-hidden="true" href="#合并查询">#</a></h2>
<h3 id="每个题目和每份试卷被作答的人数和次数">每个题目和每份试卷被作答的人数和次数<a hidden class="anchor" aria-hidden="true" href="#每个题目和每份试卷被作答的人数和次数">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2021-09-01 09:01:01</td>
<td>2021-09-01 09:41:01</td>
<td>81</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>70</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:40:01</td>
<td>80</td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>70</td>
</tr>
<tr>
<td>5</td>
<td>1004</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:40:01</td>
<td>85</td>
</tr>
<tr>
<td>6</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p>题目练习表 practice_record（uid 用户 ID, question_id 题目 ID, submit_time 提交时间, score 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>question_id</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>8001</td>
<td>2021-08-02 11:41:01</td>
<td>60</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>8001</td>
<td>2021-09-02 19:30:01</td>
<td>50</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>8001</td>
<td>2021-09-02 19:20:01</td>
<td>70</td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>8002</td>
<td>2021-09-02 19:38:01</td>
<td>70</td>
</tr>
<tr>
<td>5</td>
<td>1003</td>
<td>8001</td>
<td>2021-08-02 19:38:01</td>
<td>70</td>
</tr>
<tr>
<td>6</td>
<td>1003</td>
<td>8001</td>
<td>2021-08-02 19:48:01</td>
<td>90</td>
</tr>
<tr>
<td>7</td>
<td>1003</td>
<td>8002</td>
<td>2021-08-01 19:38:01</td>
<td>80</td>
</tr>
</tbody>
</table>
<p>请统计每个题目和每份试卷被作答的人数和次数，分别按照&quot;试卷&quot;和&quot;题目&quot;的 uv &amp; pv 降序显示，示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>tid</th>
<th>uv</th>
<th>pv</th>
</tr>
</thead>
<tbody>
<tr>
<td>9001</td>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>9002</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>8001</td>
<td>3</td>
<td>5</td>
</tr>
<tr>
<td>8002</td>
<td>2</td>
<td>2</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：“试卷”有 3 人共练习 3 次试卷 9001，1 人作答 3 次 9002；“刷题”有 3 人刷 5 次 8001，有 2 人刷 2 次 8002</p>
<p><strong>思路</strong>：这题的难点和易错点在于<code>UNOIN</code>和<code>ORDER BY</code> 同时使用的问题</p>
<p>有以下几种情况：使用<code>union</code>和多个<code>order by</code>不加括号，报错！</p>
<p><code>order by</code>在<code>union</code>连接的子句中不起作用；</p>
<p>比如不加括号：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> exam_id <span style="color:#fff;font-weight:bold">AS</span> tid,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">COUNT</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> UID) <span style="color:#fff;font-weight:bold">AS</span> uv,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">COUNT</span>(UID) <span style="color:#fff;font-weight:bold">AS</span> pv
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> uv <span style="color:#fff;font-weight:bold">DESC</span>,
</span></span><span style="display:flex;"><span>         pv <span style="color:#fff;font-weight:bold">DESC</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UNION</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> question_id <span style="color:#fff;font-weight:bold">AS</span> tid,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">COUNT</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> UID) <span style="color:#fff;font-weight:bold">AS</span> uv,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">COUNT</span>(UID) <span style="color:#fff;font-weight:bold">AS</span> pv
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> practice_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> question_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> uv <span style="color:#fff;font-weight:bold">DESC</span>,
</span></span><span style="display:flex;"><span>         pv <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>直接报语法错误，如果没有括号，只能有一个<code>order by</code></p>
<p>还有一种<code>order by</code>不起作用的情况，但是能在子句的子句中起作用，这里的解决方案就是在外面再套一层查询。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> *
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> exam_id <span style="color:#fff;font-weight:bold">AS</span> tid,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">COUNT</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> exam_record.uid) uv,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">COUNT</span>(*) pv
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> exam_id
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> uv <span style="color:#fff;font-weight:bold">DESC</span>, pv <span style="color:#fff;font-weight:bold">DESC</span>) t1
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UNION</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> *
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> question_id <span style="color:#fff;font-weight:bold">AS</span> tid,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">COUNT</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> practice_record.uid) uv,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">COUNT</span>(*) pv
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> practice_record
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> question_id
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> uv <span style="color:#fff;font-weight:bold">DESC</span>, pv <span style="color:#fff;font-weight:bold">DESC</span>) t2;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="分别满足两个活动的人">分别满足两个活动的人<a hidden class="anchor" aria-hidden="true" href="#分别满足两个活动的人">#</a></h3>
<p><strong>描述</strong>： 为了促进更多用户在牛客平台学习和刷题进步，我们会经常给一些既活跃又表现不错的用户发放福利。假使以前我们有两拨运营活动，分别给每次试卷得分都能到 85 分的人（activity1）、至少有一次用了一半时间就完成高难度试卷且分数大于 80 的人（activity2）发了福利券。</p>
<p>现在，需要你一次性将这两个活动满足的人筛选出来，交给运营同学。请写出一个 SQL 实现：输出 2021 年里，所有每次试卷得分都能到 85 分的人以及至少有一次用了一半时间就完成高难度试卷且分数大于 80 的人的 id 和活动号，按用户 ID 排序输出。</p>
<p>现有试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>C++</td>
<td>easy</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2021-09-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2021-09-01 09:01:01</td>
<td>2021-09-01 09:31:00</td>
<td>81</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>70</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:40:01</td>
<td><strong>86</strong></td>
</tr>
<tr>
<td>4</td>
<td>1003</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>89</td>
</tr>
<tr>
<td>5</td>
<td>1004</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:30:01</td>
<td>85</td>
</tr>
</tbody>
</table>
<p>示例数据输出结果：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>activity</th>
</tr>
</thead>
<tbody>
<tr>
<td>1001</td>
<td>activity2</td>
</tr>
<tr>
<td>1003</td>
<td>activity1</td>
</tr>
<tr>
<td>1004</td>
<td>activity1</td>
</tr>
<tr>
<td>1004</td>
<td>activity2</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：用户 1001 最小分数 81 不满足活动 1，但 29 分 59 秒完成了 60 分钟长的试卷得分 81，满足活动 2；1003 最小分数 86 满足活动 1，完成时长都大于试卷时长的一半，不满足活动 2；用户 1004 刚好用了一半时间（30 分钟整）完成了试卷得分 85，满足活动 1 和活动 2。</p>
<p><strong>思路</strong>： 这一题需要涉及到时间的减法，需要用到 <code>TIMESTAMPDIFF()</code> 函数计算两个时间戳之间的分钟差值。</p>
<p>下面我们来看一下基本用法</p>
<p>示例：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>TIMESTAMPDIFF(<span style="color:#fff;font-weight:bold">MINUTE</span>, start_time, end_time)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>TIMESTAMPDIFF()</code> 函数的第一个参数是时间单位，这里我们选择 <code>MINUTE</code> 表示返回分钟差值。第二个参数是较早的时间戳，第三个参数是较晚的时间戳。函数会返回它们之间的分钟差值</p>
<p>了解了这个函数的用法之后，我们再回过头来看<code>activity1</code>的要求，求分数大于 85 即可，那我们还是先把这个写出来，后续思路就会清晰很多</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DISTINCT</span> UID
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> score &gt;= <span style="color:#ff0;font-weight:bold">85</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> <span style="color:#fff;font-weight:bold">YEAR</span> (start_time) = <span style="color:#0ff;font-weight:bold">&#39;2021&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据条件 2，接着写出<code>在一半时间内完成高难度试卷且分数大于80的人</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> UID
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> examination_info info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> info.exam_id = record.exam_id
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> (TIMESTAMPDIFF(<span style="color:#fff;font-weight:bold">MINUTE</span>, start_time, submit_time)) &lt; (info.duration / <span style="color:#ff0;font-weight:bold">2</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> difficulty = <span style="color:#0ff;font-weight:bold">&#39;hard&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> score &gt;= <span style="color:#ff0;font-weight:bold">80</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后再把两者<code>UNION</code> 起来即可。（这里特别要注意括号问题和<code>order by</code>位置，具体用法在上一篇中已提及）</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DISTINCT</span> UID UID,
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#39;activity1&#39;</span> activity
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> UID <span style="color:#fff;font-weight:bold">not</span> <span style="color:#fff;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#fff;font-weight:bold">SELECT</span> UID
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">WHERE</span> score&lt;<span style="color:#ff0;font-weight:bold">85</span>
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">AND</span> <span style="color:#fff;font-weight:bold">YEAR</span>(submit_time) = <span style="color:#ff0;font-weight:bold">2021</span> )
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UNION</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DISTINCT</span> UID UID,
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#39;activity2&#39;</span> activity
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record e_r
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info e_i <span style="color:#fff;font-weight:bold">ON</span> e_r.exam_id = e_i.exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">YEAR</span>(submit_time) = <span style="color:#ff0;font-weight:bold">2021</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> difficulty = <span style="color:#0ff;font-weight:bold">&#39;hard&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> TIMESTAMPDIFF(<span style="color:#fff;font-weight:bold">SECOND</span>, start_time, submit_time) &lt;= duration *<span style="color:#ff0;font-weight:bold">30</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> score&gt;<span style="color:#ff0;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> UID
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="连接查询">连接查询<a hidden class="anchor" aria-hidden="true" href="#连接查询">#</a></h2>
<h3 id="满足条件的用户的试卷完成数和题目练习数困难">满足条件的用户的试卷完成数和题目练习数（困难）<a hidden class="anchor" aria-hidden="true" href="#满足条件的用户的试卷完成数和题目练习数困难">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有用户信息表 user_info（uid 用户 ID，nick_name 昵称, achievement 成就值, level 等级, job 职业方向, register_time 注册时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1 号</td>
<td>3100</td>
<td>7</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>2300</td>
<td>7</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>牛客 3 号</td>
<td>2500</td>
<td>7</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1004</td>
<td>牛客 4 号</td>
<td>1200</td>
<td>5</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>牛客 5 号</td>
<td>1600</td>
<td>6</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>6</td>
<td>1006</td>
<td>牛客 6 号</td>
<td>2000</td>
<td>6</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>C++</td>
<td>hard</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2021-09-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2021-09-01 09:01:01</td>
<td>2021-09-01 09:31:00</td>
<td>81</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>81</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:40:01</td>
<td>86</td>
</tr>
<tr>
<td>4</td>
<td>1003</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:51</td>
<td>89</td>
</tr>
<tr>
<td>5</td>
<td>1004</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:30:01</td>
<td>85</td>
</tr>
<tr>
<td>6</td>
<td>1005</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:02</td>
<td>85</td>
</tr>
<tr>
<td>7</td>
<td>1006</td>
<td>9003</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:21:01</td>
<td>84</td>
</tr>
<tr>
<td>8</td>
<td>1006</td>
<td>9001</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:21:01</td>
<td>80</td>
</tr>
</tbody>
</table>
<p>题目练习记录表 practice_record（uid 用户 ID, question_id 题目 ID, submit_time 提交时间, score 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>question_id</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>8001</td>
<td>2021-08-02 11:41:01</td>
<td>60</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>8001</td>
<td>2021-09-02 19:30:01</td>
<td>50</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>8001</td>
<td>2021-09-02 19:20:01</td>
<td>70</td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>8002</td>
<td>2021-09-02 19:38:01</td>
<td>70</td>
</tr>
<tr>
<td>5</td>
<td>1004</td>
<td>8001</td>
<td>2021-08-02 19:38:01</td>
<td>70</td>
</tr>
<tr>
<td>6</td>
<td>1004</td>
<td>8002</td>
<td>2021-08-02 19:48:01</td>
<td>90</td>
</tr>
<tr>
<td>7</td>
<td>1001</td>
<td>8002</td>
<td>2021-08-02 19:38:01</td>
<td>70</td>
</tr>
<tr>
<td>8</td>
<td>1004</td>
<td>8002</td>
<td>2021-08-02 19:48:01</td>
<td>90</td>
</tr>
<tr>
<td>9</td>
<td>1004</td>
<td>8002</td>
<td>2021-08-02 19:58:01</td>
<td>94</td>
</tr>
<tr>
<td>10</td>
<td>1004</td>
<td>8003</td>
<td>2021-08-02 19:38:01</td>
<td>70</td>
</tr>
<tr>
<td>11</td>
<td>1004</td>
<td>8003</td>
<td>2021-08-02 19:48:01</td>
<td>90</td>
</tr>
<tr>
<td>12</td>
<td>1004</td>
<td>8003</td>
<td>2021-08-01 19:38:01</td>
<td>80</td>
</tr>
</tbody>
</table>
<p>请你找到高难度 SQL 试卷得分平均值大于 80 并且是 7 级的红名大佬，统计他们的 2021 年试卷总完成次数和题目总练习次数，只保留 2021 年有试卷完成记录的用户。结果按试卷完成数升序，按题目练习数降序。</p>
<p>示例数据输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>exam_cnt</th>
<th>question_cnt</th>
</tr>
</thead>
<tbody>
<tr>
<td>1001</td>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>1003</td>
<td>2</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>解释：用户 1001、1003、1004、1006 满足高难度 SQL 试卷得分平均值大于 80，但只有 1001、1003 是 7 级红名大佬；1001 完成了 1 次试卷 1001，练习了 2 次题目；1003 完成了 2 次试卷 9001、9002，未练习题目（因此计数为 0）</p>
<p><strong>思路：</strong></p>
<p>先将条件进行初步筛选，比如先查出做过高难度 sql 试卷的用户</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	record.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	exam_record record
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info e_info <span style="color:#fff;font-weight:bold">ON</span> record.exam_id = e_info.exam_id
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">JOIN</span> user_info u_info <span style="color:#fff;font-weight:bold">ON</span> record.uid = u_info.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>	e_info.tag = <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">AND</span> e_info.difficulty = <span style="color:#0ff;font-weight:bold">&#39;hard&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后根据题目要求，接着再往里叠条件即可；</p>
<p>但是这里又要注意：</p>
<p>第一：不能<code>YEAR(submit_time)= 2021</code>这个条件放到最后，要在<code>ON</code>条件里，因为左连接存在返回左表全部行，右表为 null 的情形，放在 <code>JOIN</code>条件的 <code>ON</code> 子句中的目的是为了确保在连接两个表时，只有满足年份条件的记录会进行连接。这样可以避免其他年份的记录被包含在结果中。即 1001 做过 2021 年的试卷，但没有练习过，如果把条件放到最后，就会排除掉这种情况。</p>
<p>第二，必须是<code>COUNT(distinct er.exam_id) exam_cnt, COUNT(distinct pr.id) question_cnt，</code>要加 distinct，因为有左连接产生很多重复值。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> er.uid <span style="color:#fff;font-weight:bold">AS</span> UID,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> er.exam_id) <span style="color:#fff;font-weight:bold">AS</span> exam_cnt,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> pr.id) <span style="color:#fff;font-weight:bold">AS</span> question_cnt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record er
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> practice_record pr <span style="color:#fff;font-weight:bold">ON</span> er.uid = pr.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">AND</span> <span style="color:#fff;font-weight:bold">YEAR</span> (er.submit_time)= <span style="color:#ff0;font-weight:bold">2021</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">AND</span> <span style="color:#fff;font-weight:bold">YEAR</span> (pr.submit_time)= <span style="color:#ff0;font-weight:bold">2021</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> er.uid <span style="color:#fff;font-weight:bold">IN</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#fff;font-weight:bold">SELECT</span> er.uid
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> exam_record er
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info ei <span style="color:#fff;font-weight:bold">ON</span> er.exam_id = ei.exam_id
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> user_info ui <span style="color:#fff;font-weight:bold">ON</span> er.uid = ui.uid
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">WHERE</span> tag = <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">AND</span> difficulty = <span style="color:#0ff;font-weight:bold">&#39;hard&#39;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">AND</span> <span style="color:#fff;font-weight:bold">LEVEL</span> = <span style="color:#ff0;font-weight:bold">7</span>
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> er.uid
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">avg</span>(score) &gt; <span style="color:#ff0;font-weight:bold">80</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> er.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> exam_cnt,
</span></span><span style="display:flex;"><span>         question_cnt <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可能细心的小伙伴会发现，为什么明明将条件限制了<code>tag = 'SQL' AND difficulty = 'hard'</code>，但是用户 1003 仍然能查出两条考试记录，其中一条的考试<code>tag</code>为 <code>C++</code>; 这是由于<code>LEFT JOIN</code>的特性，即使没有与右表匹配的行，左表的所有记录仍然会被保留。</p>
<h3 id="每个-67-级用户活跃情况困难">每个 6/7 级用户活跃情况（困难）<a hidden class="anchor" aria-hidden="true" href="#每个-67-级用户活跃情况困难">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1 号</td>
<td>3100</td>
<td>7</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>2300</td>
<td>7</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>牛客 3 号</td>
<td>2500</td>
<td>7</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1004</td>
<td>牛客 4 号</td>
<td>1200</td>
<td>5</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>牛客 5 号</td>
<td>1600</td>
<td>6</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>6</td>
<td>1006</td>
<td>牛客 6 号</td>
<td>2600</td>
<td>7</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>C++</td>
<td>easy</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2021-09-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1001</td>
<td>9001</td>
<td>2021-09-01 09:01:01</td>
<td>2021-09-01 09:31:00</td>
<td>78</td>
</tr>
<tr>
<td>1001</td>
<td>9001</td>
<td>2021-09-01 09:01:01</td>
<td>2021-09-01 09:31:00</td>
<td>81</td>
</tr>
<tr>
<td>1005</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:30:01</td>
<td>85</td>
</tr>
<tr>
<td>1005</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:02</td>
<td>85</td>
</tr>
<tr>
<td>1006</td>
<td>9003</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:21:59</td>
<td>84</td>
</tr>
<tr>
<td>1006</td>
<td>9001</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:21:01</td>
<td>81</td>
</tr>
<tr>
<td>1002</td>
<td>9001</td>
<td>2020-09-01 13:01:01</td>
<td>2020-09-01 13:41:01</td>
<td>81</td>
</tr>
<tr>
<td>1005</td>
<td>9001</td>
<td>2021-09-01 14:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p>题目练习记录表 <code>practice_record</code>（<code>uid</code> 用户 ID, <code>question_id</code> 题目 ID, <code>submit_time</code> 提交时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>question_id</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1001</td>
<td>8001</td>
<td>2021-08-02 11:41:01</td>
<td>60</td>
</tr>
<tr>
<td>1004</td>
<td>8001</td>
<td>2021-08-02 19:38:01</td>
<td>70</td>
</tr>
<tr>
<td>1004</td>
<td>8002</td>
<td>2021-08-02 19:48:01</td>
<td>90</td>
</tr>
<tr>
<td>1001</td>
<td>8002</td>
<td>2021-08-02 19:38:01</td>
<td>70</td>
</tr>
<tr>
<td>1004</td>
<td>8002</td>
<td>2021-08-02 19:48:01</td>
<td>90</td>
</tr>
<tr>
<td>1006</td>
<td>8002</td>
<td>2021-08-04 19:58:01</td>
<td>94</td>
</tr>
<tr>
<td>1006</td>
<td>8003</td>
<td>2021-08-03 19:38:01</td>
<td>70</td>
</tr>
<tr>
<td>1006</td>
<td>8003</td>
<td>2021-08-02 19:48:01</td>
<td>90</td>
</tr>
<tr>
<td>1006</td>
<td>8003</td>
<td>2020-08-01 19:38:01</td>
<td>80</td>
</tr>
</tbody>
</table>
<p>请统计每个 6/7 级用户总活跃月份数、2021 年活跃天数、2021 年试卷作答活跃天数、2021 年答题活跃天数，按照总活跃月份数、2021 年活跃天数降序排序。由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>act_month_total</th>
<th>act_days_2021</th>
<th>act_days_2021_exam</th>
</tr>
</thead>
<tbody>
<tr>
<td>1006</td>
<td>3</td>
<td>4</td>
<td>1</td>
</tr>
<tr>
<td>1001</td>
<td>2</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>1005</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>1002</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1003</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：6/7 级用户共有 5 个，其中 1006 在 202109、202108、202008 共 3 个月活跃过，2021 年活跃的日期有 20210907、20210804、20210803、20210802 共 4 天，2021 年在试卷作答区 20210907 活跃 1 天，在题目练习区活跃了 3 天。</p>
<p><strong>思路：</strong></p>
<p>这题的关键在于<code>CASE WHEN THEN</code>的使用，不然要写很多的<code>left join</code> 因为会产生很多的结果集。</p>
<p><code>CASE WHEN THEN</code>语句是一种条件表达式，用于在 SQL 中根据条件执行不同的操作或返回不同的结果。</p>
<p>语法结构如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">WHEN</span> condition1 <span style="color:#fff;font-weight:bold">THEN</span> result1
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">WHEN</span> condition2 <span style="color:#fff;font-weight:bold">THEN</span> result2
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">ELSE</span> <span style="color:#fff;font-weight:bold">result</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">END</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个结构中，可以根据需要添加多个<code>WHEN</code>子句，每个<code>WHEN</code>子句后面跟着一个条件（condition）和一个结果（result）。条件可以是任何逻辑表达式，如果满足条件，将返回对应的结果。</p>
<p>最后的<code>ELSE</code>子句是可选的，用于指定当所有前面的条件都不满足时的默认返回结果。如果没有提供<code>ELSE</code>子句，则默认返回<code>NULL</code>。</p>
<p>例如：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> score,
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHEN</span> score &gt;= <span style="color:#ff0;font-weight:bold">90</span> <span style="color:#fff;font-weight:bold">THEN</span> <span style="color:#0ff;font-weight:bold">&#39;优秀&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHEN</span> score &gt;= <span style="color:#ff0;font-weight:bold">80</span> <span style="color:#fff;font-weight:bold">THEN</span> <span style="color:#0ff;font-weight:bold">&#39;良好&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHEN</span> score &gt;= <span style="color:#ff0;font-weight:bold">60</span> <span style="color:#fff;font-weight:bold">THEN</span> <span style="color:#0ff;font-weight:bold">&#39;及格&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">ELSE</span> <span style="color:#0ff;font-weight:bold">&#39;不及格&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">END</span> <span style="color:#fff;font-weight:bold">AS</span> grade
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> student_scores;
</span></span></code></pre></td></tr></table>
</div>
</div><p>在上述示例中，根据学生成绩（score）的不同范围，使用 CASE WHEN THEN 语句返回相应的等级（grade）。如果成绩大于等于 90，则返回&quot;优秀&quot;；如果成绩大于等于 80，则返回&quot;良好&quot;；如果成绩大于等于 60，则返回&quot;及格&quot;；否则返回&quot;不及格&quot;。</p>
<p>那了解到了上述的用法之后，回过头看看该题，要求列出不同的活跃天数。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">distinct</span> act_month) <span style="color:#fff;font-weight:bold">as</span> act_month_total,
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">distinct</span> <span style="color:#fff;font-weight:bold">case</span> <span style="color:#fff;font-weight:bold">when</span> <span style="color:#fff;font-weight:bold">year</span>(act_time)=<span style="color:#0ff;font-weight:bold">&#39;2021&#39;</span><span style="color:#fff;font-weight:bold">then</span> act_day <span style="color:#fff;font-weight:bold">end</span>) <span style="color:#fff;font-weight:bold">as</span> act_days_2021,
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">distinct</span> <span style="color:#fff;font-weight:bold">case</span> <span style="color:#fff;font-weight:bold">when</span> <span style="color:#fff;font-weight:bold">year</span>(act_time)=<span style="color:#0ff;font-weight:bold">&#39;2021&#39;</span> <span style="color:#fff;font-weight:bold">and</span> tag=<span style="color:#0ff;font-weight:bold">&#39;exam&#39;</span> <span style="color:#fff;font-weight:bold">then</span> act_day <span style="color:#fff;font-weight:bold">end</span>) <span style="color:#fff;font-weight:bold">as</span> act_days_2021_exam,
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">distinct</span> <span style="color:#fff;font-weight:bold">case</span> <span style="color:#fff;font-weight:bold">when</span> <span style="color:#fff;font-weight:bold">year</span>(act_time)=<span style="color:#0ff;font-weight:bold">&#39;2021&#39;</span> <span style="color:#fff;font-weight:bold">and</span> tag=<span style="color:#0ff;font-weight:bold">&#39;question&#39;</span><span style="color:#fff;font-weight:bold">then</span> act_day <span style="color:#fff;font-weight:bold">end</span>) <span style="color:#fff;font-weight:bold">as</span> act_days_2021_question
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里的 tag 是先给标记，方便对查询进行区分，将考试和答题分开。</p>
<p>找出试卷作答区的用户</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>		uid,
</span></span><span style="display:flex;"><span>		exam_id <span style="color:#fff;font-weight:bold">AS</span> ans_id,
</span></span><span style="display:flex;"><span>		start_time <span style="color:#fff;font-weight:bold">AS</span> act_time,
</span></span><span style="display:flex;"><span>		date_format( start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span> ) <span style="color:#fff;font-weight:bold">AS</span> act_month,
</span></span><span style="display:flex;"><span>		date_format( start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m%d&#39;</span> ) <span style="color:#fff;font-weight:bold">AS</span> act_day,
</span></span><span style="display:flex;"><span>		<span style="color:#0ff;font-weight:bold">&#39;exam&#39;</span> <span style="color:#fff;font-weight:bold">AS</span> tag
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>		exam_record
</span></span></code></pre></td></tr></table>
</div>
</div><p>紧接着就是答题作答区的用户</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>		uid,
</span></span><span style="display:flex;"><span>		question_id <span style="color:#fff;font-weight:bold">AS</span> ans_id,
</span></span><span style="display:flex;"><span>		submit_time <span style="color:#fff;font-weight:bold">AS</span> act_time,
</span></span><span style="display:flex;"><span>		date_format( submit_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span> ) <span style="color:#fff;font-weight:bold">AS</span> act_month,
</span></span><span style="display:flex;"><span>		date_format( submit_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m%d&#39;</span> ) <span style="color:#fff;font-weight:bold">AS</span> act_day,
</span></span><span style="display:flex;"><span>		<span style="color:#0ff;font-weight:bold">&#39;question&#39;</span> <span style="color:#fff;font-weight:bold">AS</span> tag
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>		practice_record
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后将两个结果进行<code>UNION</code> 最后别忘了将结果进行排序 （这题有点类似于分治法的思想）</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> user_info.uid,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> act_month) <span style="color:#fff;font-weight:bold">AS</span> act_month_total,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> <span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">WHEN</span> <span style="color:#fff;font-weight:bold">YEAR</span> (act_time)= <span style="color:#0ff;font-weight:bold">&#39;2021&#39;</span> <span style="color:#fff;font-weight:bold">THEN</span> act_day
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">END</span>) <span style="color:#fff;font-weight:bold">AS</span> act_days_2021,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> <span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">WHEN</span> <span style="color:#fff;font-weight:bold">YEAR</span> (act_time)= <span style="color:#0ff;font-weight:bold">&#39;2021&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">AND</span> tag = <span style="color:#0ff;font-weight:bold">&#39;exam&#39;</span> <span style="color:#fff;font-weight:bold">THEN</span> act_day
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">END</span>) <span style="color:#fff;font-weight:bold">AS</span> act_days_2021_exam,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> <span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">WHEN</span> <span style="color:#fff;font-weight:bold">YEAR</span> (act_time)= <span style="color:#0ff;font-weight:bold">&#39;2021&#39;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">AND</span> tag = <span style="color:#0ff;font-weight:bold">&#39;question&#39;</span> <span style="color:#fff;font-weight:bold">THEN</span> act_day
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">END</span>) <span style="color:#fff;font-weight:bold">AS</span> act_days_2021_question
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> UID,
</span></span><span style="display:flex;"><span>   exam_id <span style="color:#fff;font-weight:bold">AS</span> ans_id,
</span></span><span style="display:flex;"><span>   start_time <span style="color:#fff;font-weight:bold">AS</span> act_time,
</span></span><span style="display:flex;"><span>   date_format(start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) <span style="color:#fff;font-weight:bold">AS</span> act_month,
</span></span><span style="display:flex;"><span>   date_format(start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m%d&#39;</span>) <span style="color:#fff;font-weight:bold">AS</span> act_day,
</span></span><span style="display:flex;"><span>   <span style="color:#0ff;font-weight:bold">&#39;exam&#39;</span> <span style="color:#fff;font-weight:bold">AS</span> tag
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">UNION</span> <span style="color:#fff;font-weight:bold">ALL</span> <span style="color:#fff;font-weight:bold">SELECT</span> UID,
</span></span><span style="display:flex;"><span>   question_id <span style="color:#fff;font-weight:bold">AS</span> ans_id,
</span></span><span style="display:flex;"><span>   submit_time <span style="color:#fff;font-weight:bold">AS</span> act_time,
</span></span><span style="display:flex;"><span>   date_format(submit_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) <span style="color:#fff;font-weight:bold">AS</span> act_month,
</span></span><span style="display:flex;"><span>   date_format(submit_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m%d&#39;</span>) <span style="color:#fff;font-weight:bold">AS</span> act_day,
</span></span><span style="display:flex;"><span>   <span style="color:#0ff;font-weight:bold">&#39;question&#39;</span> <span style="color:#fff;font-weight:bold">AS</span> tag
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> practice_record) total
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">RIGHT</span> <span style="color:#fff;font-weight:bold">JOIN</span> user_info <span style="color:#fff;font-weight:bold">ON</span> total.uid = user_info.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> user_info.<span style="color:#fff;font-weight:bold">LEVEL</span> <span style="color:#fff;font-weight:bold">IN</span> (<span style="color:#ff0;font-weight:bold">6</span>,
</span></span><span style="display:flex;"><span>                          <span style="color:#ff0;font-weight:bold">7</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> user_info.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> act_month_total <span style="color:#fff;font-weight:bold">DESC</span>,
</span></span><span style="display:flex;"><span>         act_days_2021 <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="sql面试题4">SQL面试题4<a hidden class="anchor" aria-hidden="true" href="#sql面试题4">#</a></h1>
<h2 id="专用窗口函数">专用窗口函数<a hidden class="anchor" aria-hidden="true" href="#专用窗口函数">#</a></h2>
<p>MySQL 8.0 版本引入了窗口函数的支持，下面是 MySQL 中常见的窗口函数及其用法：</p>
<ol>
<li><code>ROW_NUMBER()</code>: 为查询结果集中的每一行分配一个唯一的整数值。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> col1, col2, ROW_NUMBER() OVER (<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> col1) <span style="color:#fff;font-weight:bold">AS</span> row_num
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>RANK()</code>: 计算每一行在排序结果中的排名。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> col1, col2, RANK() OVER (<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> col1 <span style="color:#fff;font-weight:bold">DESC</span>) <span style="color:#fff;font-weight:bold">AS</span> ranking
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>DENSE_RANK()</code>: 计算每一行在排序结果中的排名，保留相同的排名。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> col1, col2, DENSE_RANK() OVER (<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> col1 <span style="color:#fff;font-weight:bold">DESC</span>) <span style="color:#fff;font-weight:bold">AS</span> ranking
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>NTILE(n)</code>: 将结果分成 n 个基本均匀的桶，并为每个桶分配一个标识号。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> col1, col2, NTILE(<span style="color:#ff0;font-weight:bold">4</span>) OVER (<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> col1) <span style="color:#fff;font-weight:bold">AS</span> bucket
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>SUM()</code>, <code>AVG()</code>,<code>COUNT()</code>, <code>MIN()</code>, <code>MAX()</code>: 这些聚合函数也可以与窗口函数结合使用，计算窗口内指定列的汇总、平均值、计数、最小值和最大值。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> col1, col2, <span style="color:#fff;font-weight:bold">SUM</span>(col1) OVER () <span style="color:#fff;font-weight:bold">AS</span> sum_col
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>LEAD()</code> 和 <code>LAG()</code>: LEAD 函数用于获取当前行之后的某个偏移量的行的值，而 LAG 函数用于获取当前行之前的某个偏移量的行的值。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> col1, col2, LEAD(col1, <span style="color:#ff0;font-weight:bold">1</span>) OVER (<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> col1) <span style="color:#fff;font-weight:bold">AS</span> next_col1,
</span></span><span style="display:flex;"><span>                 LAG(col1, <span style="color:#ff0;font-weight:bold">1</span>) OVER (<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> col1) <span style="color:#fff;font-weight:bold">AS</span> prev_col1
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>FIRST_VALUE()</code> 和 <code>LAST_VALUE()</code>: FIRST_VALUE 函数用于获取窗口内指定列的第一个值，LAST_VALUE 函数用于获取窗口内指定列的最后一个值。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> col1, col2, FIRST_VALUE(col2) OVER (PARTITION <span style="color:#fff;font-weight:bold">BY</span> col1 <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> col2) <span style="color:#fff;font-weight:bold">AS</span> first_val,
</span></span><span style="display:flex;"><span>                 LAST_VALUE(col2) OVER (PARTITION <span style="color:#fff;font-weight:bold">BY</span> col1 <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> col2) <span style="color:#fff;font-weight:bold">AS</span> last_val
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>窗口函数通常需要配合 OVER 子句一起使用，用于定义窗口的大小、排序规则和分组方式。</p>
<h3 id="每类试卷得分前三名">每类试卷得分前三名<a hidden class="anchor" aria-hidden="true" href="#每类试卷得分前三名">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2021-09-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, score 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2021-09-01 09:01:01</td>
<td>2021-09-01 09:31:00</td>
<td>78</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-01 09:01:01</td>
<td>2021-09-01 09:31:00</td>
<td>81</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>81</td>
</tr>
<tr>
<td>4</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:40:01</td>
<td>86</td>
</tr>
<tr>
<td>5</td>
<td>1003</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:51</td>
<td>89</td>
</tr>
<tr>
<td>6</td>
<td>1004</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:30:01</td>
<td>85</td>
</tr>
<tr>
<td>7</td>
<td>1005</td>
<td>9003</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:02</td>
<td>85</td>
</tr>
<tr>
<td>8</td>
<td>1006</td>
<td>9003</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:21:01</td>
<td>84</td>
</tr>
<tr>
<td>9</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-08 12:01:01</td>
<td>2021-09-08 12:11:01</td>
<td>40</td>
</tr>
<tr>
<td>10</td>
<td>1003</td>
<td>9002</td>
<td>2021-09-01 14:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p>找到每类试卷得分的前 3 名，如果两人最大分数相同，选择最小分数大者，如果还相同，选择 uid 大者。由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>tid</th>
<th>uid</th>
<th>ranking</th>
</tr>
</thead>
<tbody>
<tr>
<td>SQL</td>
<td>1003</td>
<td>1</td>
</tr>
<tr>
<td>SQL</td>
<td>1004</td>
<td>2</td>
</tr>
<tr>
<td>SQL</td>
<td>1002</td>
<td>3</td>
</tr>
<tr>
<td>算法</td>
<td>1005</td>
<td>1</td>
</tr>
<tr>
<td>算法</td>
<td>1006</td>
<td>2</td>
</tr>
<tr>
<td>算法</td>
<td>1003</td>
<td>3</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：有作答得分记录的试卷 tag 有 SQL 和算法，SQL 试卷用户 1001、1002、1003、1004 有作答得分，最高得分分别为 81、81、89、85，最低得分分别为 78、81、86、40，因此先按最高得分排名再按最低得分排名取前三为 1003、1004、1002。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> tag,
</span></span><span style="display:flex;"><span>       UID,
</span></span><span style="display:flex;"><span>       ranking
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> b.tag <span style="color:#fff;font-weight:bold">AS</span> tag,
</span></span><span style="display:flex;"><span>          a.uid <span style="color:#fff;font-weight:bold">AS</span> UID,
</span></span><span style="display:flex;"><span>          ROW_NUMBER() OVER (PARTITION <span style="color:#fff;font-weight:bold">BY</span> b.tag
</span></span><span style="display:flex;"><span>                             <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> b.tag,
</span></span><span style="display:flex;"><span>                                      <span style="color:#fff;font-weight:bold">max</span>(a.score) <span style="color:#fff;font-weight:bold">DESC</span>, 
</span></span><span style="display:flex;"><span>                                      <span style="color:#fff;font-weight:bold">min</span>(a.score) <span style="color:#fff;font-weight:bold">DESC</span>, 
</span></span><span style="display:flex;"><span>                                      a.uid <span style="color:#fff;font-weight:bold">DESC</span>) <span style="color:#fff;font-weight:bold">AS</span> ranking
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record a
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info b <span style="color:#fff;font-weight:bold">ON</span> a.exam_id = b.exam_id
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> b.tag,
</span></span><span style="display:flex;"><span>            a.uid) t
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> ranking &lt;= <span style="color:#ff0;font-weight:bold">3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="第二快慢用时之差大于试卷时长一半的试卷较难">第二快/慢用时之差大于试卷时长一半的试卷（较难）<a hidden class="anchor" aria-hidden="true" href="#第二快慢用时之差大于试卷时长一半的试卷较难">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>C++</td>
<td>hard</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2021-09-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2021-09-01 09:01:01</td>
<td>2021-09-01 09:51:01</td>
<td>78</td>
</tr>
<tr>
<td>2</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-01 09:01:01</td>
<td>2021-09-01 09:31:00</td>
<td>81</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:01</td>
<td>81</td>
</tr>
<tr>
<td>4</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:59:01</td>
<td>86</td>
</tr>
<tr>
<td>5</td>
<td>1003</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:51</td>
<td>89</td>
</tr>
<tr>
<td>6</td>
<td>1004</td>
<td>9002</td>
<td>2021-09-01 19:01:01</td>
<td>2021-09-01 19:30:01</td>
<td>85</td>
</tr>
<tr>
<td>7</td>
<td>1005</td>
<td>9001</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:31:02</td>
<td>85</td>
</tr>
<tr>
<td>8</td>
<td>1006</td>
<td>9001</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:21:01</td>
<td>84</td>
</tr>
<tr>
<td>9</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-08 12:01:01</td>
<td>2021-09-08 12:11:01</td>
<td>40</td>
</tr>
<tr>
<td>10</td>
<td>1003</td>
<td>9002</td>
<td>2021-09-01 14:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>11</td>
<td>1005</td>
<td>9001</td>
<td>2021-09-01 14:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>12</td>
<td>1003</td>
<td>9003</td>
<td>2021-09-08 15:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p>找到第二快和第二慢用时之差大于试卷时长的一半的试卷信息，按试卷 ID 降序排序。由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>exam_id</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>9001</td>
<td>60</td>
<td>2021-09-01 06:00:00</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：试卷 9001 被作答用时有 50 分钟、50 分钟、30 分 1 秒、11 分钟、10 分钟，第二快和第二慢用时之差为 50 分钟-11 分钟=39 分钟，试卷时长为 60 分钟，因此满足大于试卷时长一半的条件，输出试卷 ID、时长、发布时间。</p>
<p><strong>思路：</strong></p>
<p>第一步，找到每张试卷完成时间的顺序排名和倒序排名 也就是表 a；</p>
<p>第二步，与通过试卷信息表 b 建立内连接，并根据试卷 id 分组，利用<code>having</code>筛选排名为第二个数据，将秒转化为分钟并进行比较，最后再根据试卷 id 倒序排序就行</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> a.exam_id,
</span></span><span style="display:flex;"><span>       b.duration,
</span></span><span style="display:flex;"><span>       b.release_time
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> exam_id,
</span></span><span style="display:flex;"><span>          row_number() OVER (PARTITION <span style="color:#fff;font-weight:bold">BY</span> exam_id
</span></span><span style="display:flex;"><span>                             <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> timestampdiff(<span style="color:#fff;font-weight:bold">SECOND</span>, start_time, submit_time) <span style="color:#fff;font-weight:bold">DESC</span>) rn1,
</span></span><span style="display:flex;"><span>          row_number() OVER (PARTITION <span style="color:#fff;font-weight:bold">BY</span> exam_id
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> timestampdiff(<span style="color:#fff;font-weight:bold">SECOND</span>, start_time, submit_time) <span style="color:#fff;font-weight:bold">ASC</span>) rn2,
</span></span><span style="display:flex;"><span>                                              timestampdiff(<span style="color:#fff;font-weight:bold">SECOND</span>, start_time, submit_time) timex
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> score <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span> ) a
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info b <span style="color:#fff;font-weight:bold">ON</span> a.exam_id = b.exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> a.exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> (<span style="color:#fff;font-weight:bold">max</span>(<span style="color:#fff;font-weight:bold">IF</span> (rn1 = <span style="color:#ff0;font-weight:bold">2</span>, a.timex, <span style="color:#ff0;font-weight:bold">0</span>))- <span style="color:#fff;font-weight:bold">max</span>(<span style="color:#fff;font-weight:bold">IF</span> (rn2 = <span style="color:#ff0;font-weight:bold">2</span>, a.timex, <span style="color:#ff0;font-weight:bold">0</span>)))/ <span style="color:#ff0;font-weight:bold">60</span> &gt; b.duration / <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> a.exam_id <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="连续两次作答试卷的最大时间窗较难">连续两次作答试卷的最大时间窗（较难）<a hidden class="anchor" aria-hidden="true" href="#连续两次作答试卷的最大时间窗较难">#</a></h3>
<p><strong>描述</strong></p>
<p>现有试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1006</td>
<td>9003</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:21:02</td>
<td>84</td>
</tr>
<tr>
<td>2</td>
<td>1006</td>
<td>9001</td>
<td>2021-09-01 12:11:01</td>
<td>2021-09-01 12:31:01</td>
<td>89</td>
</tr>
<tr>
<td>3</td>
<td>1006</td>
<td>9002</td>
<td>2021-09-06 10:01:01</td>
<td>2021-09-06 10:21:01</td>
<td>81</td>
</tr>
<tr>
<td>4</td>
<td>1005</td>
<td>9002</td>
<td>2021-09-05 10:01:01</td>
<td>2021-09-05 10:21:01</td>
<td>81</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>9001</td>
<td>2021-09-05 10:31:01</td>
<td>2021-09-05 10:51:01</td>
<td>81</td>
</tr>
</tbody>
</table>
<p>请计算在 2021 年至少有两天作答过试卷的人中，计算该年连续两次作答试卷的最大时间窗 <code>days_window</code>，那么根据该年的历史规律他在 <code>days_window</code> 天里平均会做多少套试卷，按最大时间窗和平均做答试卷套数倒序排序。由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>days_window</th>
<th>avg_exam_cnt</th>
</tr>
</thead>
<tbody>
<tr>
<td>1006</td>
<td>6</td>
<td>2.57</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：用户 1006 分别在 20210901、20210906、20210907 作答过 3 次试卷，连续两次作答最大时间窗为 6 天（1 号到 6 号），他 1 号到 7 号这 7 天里共做了 3 张试卷，平均每天 3/7=0.428571 张，那么 6 天里平均会做 0.428571*6=2.57 张试卷（保留两位小数）；用户 1005 在 20210905 做了两张试卷，但是只有一天的作答记录，过滤掉。</p>
<p><strong>思路：</strong></p>
<p>上面这个解释中提示要对作答记录去重，千万别被骗了，不要去重！去重就通不过测试用例。注意限制时间是 2021 年；</p>
<p>而且要注意时间差要+1 天；还要注意==没交卷也算在内==！！！！ （反正感觉这题描述不清，出的不是很好）</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> UID,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">max</span>(datediff(next_time, start_time)) + <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#fff;font-weight:bold">AS</span> days_window,
</span></span><span style="display:flex;"><span>       round(<span style="color:#fff;font-weight:bold">count</span>(start_time)/(datediff(<span style="color:#fff;font-weight:bold">max</span>(start_time), <span style="color:#fff;font-weight:bold">min</span>(start_time))+ <span style="color:#ff0;font-weight:bold">1</span>) * (<span style="color:#fff;font-weight:bold">max</span>(datediff(next_time, start_time))+ <span style="color:#ff0;font-weight:bold">1</span>), <span style="color:#ff0;font-weight:bold">2</span>) <span style="color:#fff;font-weight:bold">AS</span> avg_exam_cnt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> UID,
</span></span><span style="display:flex;"><span>          start_time,
</span></span><span style="display:flex;"><span>          lead(start_time, <span style="color:#ff0;font-weight:bold">1</span>) OVER (PARTITION <span style="color:#fff;font-weight:bold">BY</span> UID
</span></span><span style="display:flex;"><span>                                    <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> start_time) <span style="color:#fff;font-weight:bold">AS</span> next_time
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">YEAR</span> (start_time) = <span style="color:#0ff;font-weight:bold">&#39;2021&#39;</span> ) a
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> UID
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">DISTINCT</span> <span style="color:#fff;font-weight:bold">date</span>(start_time)) &gt; <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> days_window <span style="color:#fff;font-weight:bold">DESC</span>,
</span></span><span style="display:flex;"><span>         avg_exam_cnt <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="近三个月未完成为-0-的用户完成情况">近三个月未完成为 0 的用户完成情况<a hidden class="anchor" aria-hidden="true" href="#近三个月未完成为-0-的用户完成情况">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有试卷作答记录表 <code>exam_record</code>（<code>uid</code>:用户 ID, <code>exam_id</code>:试卷 ID, <code>start_time</code>:开始作答时间, <code>submit_time</code>:交卷时间，为空的话则代表未完成, <code>score</code>:得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1006</td>
<td>9003</td>
<td>2021-09-06 10:01:01</td>
<td>2021-09-06 10:21:02</td>
<td>84</td>
</tr>
<tr>
<td>2</td>
<td>1006</td>
<td>9001</td>
<td>2021-08-02 12:11:01</td>
<td>2021-08-02 12:31:01</td>
<td>89</td>
</tr>
<tr>
<td>3</td>
<td>1006</td>
<td>9002</td>
<td>2021-06-06 10:01:01</td>
<td>2021-06-06 10:21:01</td>
<td>81</td>
</tr>
<tr>
<td>4</td>
<td>1006</td>
<td>9002</td>
<td>2021-05-06 10:01:01</td>
<td>2021-05-06 10:21:01</td>
<td>81</td>
</tr>
<tr>
<td>5</td>
<td>1006</td>
<td>9001</td>
<td>2021-05-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>6</td>
<td>1001</td>
<td>9001</td>
<td>2021-09-05 10:31:01</td>
<td>2021-09-05 10:51:01</td>
<td>81</td>
</tr>
<tr>
<td>7</td>
<td>1001</td>
<td>9003</td>
<td>2021-08-01 09:01:01</td>
<td>2021-08-01 09:51:11</td>
<td>78</td>
</tr>
<tr>
<td>8</td>
<td>1001</td>
<td>9002</td>
<td>2021-07-01 09:01:01</td>
<td>2021-07-01 09:31:00</td>
<td>81</td>
</tr>
<tr>
<td>9</td>
<td>1001</td>
<td>9002</td>
<td>2021-07-01 12:01:01</td>
<td>2021-07-01 12:31:01</td>
<td>81</td>
</tr>
<tr>
<td>10</td>
<td>1001</td>
<td>9002</td>
<td>2021-07-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p>找到每个人近三个有试卷作答记录的月份中没有试卷是未完成状态的用户的试卷作答完成数，按试卷完成数和用户 ID 降序排名。由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>exam_complete_cnt</th>
</tr>
</thead>
<tbody>
<tr>
<td>1006</td>
<td>3</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：用户 1006 近三个有作答试卷的月份为 202109、202108、202106，作答试卷数为 3，全部完成；用户 1001 近三个有作答试卷的月份为 202109、202108、202107，作答试卷数为 5，完成试卷数为 4，因为有未完成试卷，故过滤掉。</p>
<p><strong>思路:</strong></p>
<ol>
<li><code>找到每个人近三个有试卷作答记录的月份中没有试卷是未完成状态的用户的试卷作答完成数</code>首先看这句话，肯定要先根据人进行分组</li>
<li>最近三个月，可以采用连续重复排名，倒序排列，排名&lt;=3</li>
<li>统计作答数</li>
<li>拼装剩余条件</li>
<li>排序</li>
</ol>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> UID,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(score) exam_complete_cnt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> *, DENSE_RANK() OVER (PARTITION <span style="color:#fff;font-weight:bold">BY</span> UID
</span></span><span style="display:flex;"><span>                             <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> date_format(start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) <span style="color:#fff;font-weight:bold">DESC</span>) dr
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record) t1
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> dr &lt;= <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> UID
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">count</span>(dr)= <span style="color:#fff;font-weight:bold">count</span>(score)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> exam_complete_cnt <span style="color:#fff;font-weight:bold">DESC</span>,
</span></span><span style="display:flex;"><span>         UID <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="未完成率较高的-50用户近三个月答卷情况困难">未完成率较高的 50%用户近三个月答卷情况（困难）<a hidden class="anchor" aria-hidden="true" href="#未完成率较高的-50用户近三个月答卷情况困难">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1 号</td>
<td>3200</td>
<td>7</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>2500</td>
<td>6</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>牛客 3 号 ♂</td>
<td>2200</td>
<td>5</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>SQL</td>
<td>hard</td>
<td>80</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>hard</td>
<td>80</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>9004</td>
<td>PYTHON</td>
<td>medium</td>
<td>70</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-01 09:01:01</td>
<td>2020-01-01 09:21:59</td>
<td>90</td>
</tr>
<tr>
<td>15</td>
<td>1002</td>
<td>9001</td>
<td>2020-01-01 18:01:01</td>
<td>2020-01-01 18:59:02</td>
<td>90</td>
</tr>
<tr>
<td>13</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 10:01:01</td>
<td>2020-01-02 10:31:01</td>
<td>89</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9001</td>
<td>2020-01-20 10:01:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9001</td>
<td>2020-02-01 12:11:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>1001</td>
<td>9001</td>
<td>2020-03-01 12:01:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>1002</td>
<td>9001</td>
<td>2020-03-01 12:01:01</td>
<td>2020-03-01 12:41:01</td>
<td>90</td>
</tr>
<tr>
<td>4</td>
<td>1003</td>
<td>9001</td>
<td>2020-03-01 19:01:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>1002</td>
<td>9001</td>
<td>2020-05-02 19:01:01</td>
<td>2020-05-02 19:32:00</td>
<td>90</td>
</tr>
<tr>
<td>14</td>
<td>1001</td>
<td>9002</td>
<td>2020-01-01 12:11:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>1001</td>
<td>9002</td>
<td>2020-01-02 19:01:01</td>
<td>2020-01-02 19:59:01</td>
<td>69</td>
</tr>
<tr>
<td>9</td>
<td>1001</td>
<td>9002</td>
<td>2020-02-02 12:01:01</td>
<td>2020-02-02 12:20:01</td>
<td>99</td>
</tr>
<tr>
<td>10</td>
<td>1002</td>
<td>9002</td>
<td>2020-02-02 12:01:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>1002</td>
<td>9002</td>
<td>2020-02-02 12:01:01</td>
<td>2020-02-02 12:43:01</td>
<td>81</td>
</tr>
<tr>
<td>12</td>
<td>1002</td>
<td>9002</td>
<td>2020-03-02 12:11:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>17</td>
<td>1001</td>
<td>9002</td>
<td>2020-05-05 18:01:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>16</td>
<td>1002</td>
<td>9003</td>
<td>2020-05-06 12:01:01</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>请统计 SQL 试卷上未完成率较高的 50%用户中，6 级和 7 级用户在有试卷作答记录的近三个月中，每个月的答卷数目和完成数目。按用户 ID、月份升序排序。</p>
<p>由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>start_month</th>
<th>total_cnt</th>
<th>complete_cnt</th>
</tr>
</thead>
<tbody>
<tr>
<td>1002</td>
<td>202002</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>1002</td>
<td>202003</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>1002</td>
<td>202005</td>
<td>2</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>解释：各个用户对 SQL 试卷的未完成数、作答总数、未完成率如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>incomplete_cnt</th>
<th>total_cnt</th>
<th>incomplete_rate</th>
</tr>
</thead>
<tbody>
<tr>
<td>1001</td>
<td>3</td>
<td>7</td>
<td>0.4286</td>
</tr>
<tr>
<td>1002</td>
<td>4</td>
<td>8</td>
<td>0.5000</td>
</tr>
<tr>
<td>1003</td>
<td>1</td>
<td>1</td>
<td>1.0000</td>
</tr>
</tbody>
</table>
<p>1001、1002、1003 分别排在 1.0、0.5、0.0 的位置，因此较高的 50%用户（排位&lt;=0.5）为 1002、1003；</p>
<p>1003 不是 6 级或 7 级；</p>
<p>有试卷作答记录的近三个月为 202005、202003、202002；</p>
<p>这三个月里 1002 的作答题数分别为 3、2、2，完成数目分别为 1、1、1。</p>
<p><strong>思路：</strong></p>
<p>注意点：这题注意求的是所有的答题次数和完成次数，而 sql 类别的试卷是限制未完成率排名，6, 7 级用户限制的是做题记录。</p>
<p>先求出未完成率的排名</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> UID,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">OR</span> <span style="color:#fff;font-weight:bold">NULL</span>)/ <span style="color:#fff;font-weight:bold">count</span>(start_time) <span style="color:#fff;font-weight:bold">AS</span> num,
</span></span><span style="display:flex;"><span>       PERCENT_RANK() OVER (
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">count</span>(submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>                                           <span style="color:#fff;font-weight:bold">OR</span> <span style="color:#fff;font-weight:bold">NULL</span>)/ <span style="color:#fff;font-weight:bold">count</span>(start_time)) <span style="color:#fff;font-weight:bold">AS</span> ranking
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info <span style="color:#fff;font-weight:bold">USING</span> (exam_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> tag = <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> UID
</span></span></code></pre></td></tr></table>
</div>
</div><p>再求出最近三个月的练习记录</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> UID,
</span></span><span style="display:flex;"><span>       date_format(start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) <span style="color:#fff;font-weight:bold">AS</span> month_d,
</span></span><span style="display:flex;"><span>       submit_time,
</span></span><span style="display:flex;"><span>       exam_id,
</span></span><span style="display:flex;"><span>       dense_rank() OVER (PARTITION <span style="color:#fff;font-weight:bold">BY</span> UID
</span></span><span style="display:flex;"><span>                          <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> date_format(start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) <span style="color:#fff;font-weight:bold">DESC</span>) <span style="color:#fff;font-weight:bold">AS</span> ranking
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> user_info <span style="color:#fff;font-weight:bold">USING</span> (UID)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">LEVEL</span> <span style="color:#fff;font-weight:bold">IN</span> (<span style="color:#ff0;font-weight:bold">6</span>,<span style="color:#ff0;font-weight:bold">7</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> t1.uid,
</span></span><span style="display:flex;"><span>       t1.month_d,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">AS</span> total_cnt,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(t1.submit_time) <span style="color:#fff;font-weight:bold">AS</span> complete_cnt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span><span style="color:#007f7f">-- 先求出未完成率的排名
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> UID,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">count</span>(submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">OR</span> <span style="color:#fff;font-weight:bold">NULL</span>)/ <span style="color:#fff;font-weight:bold">count</span>(start_time) <span style="color:#fff;font-weight:bold">AS</span> num,
</span></span><span style="display:flex;"><span>          PERCENT_RANK() OVER (
</span></span><span style="display:flex;"><span>                               <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> <span style="color:#fff;font-weight:bold">count</span>(submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">OR</span> <span style="color:#fff;font-weight:bold">NULL</span>)/ <span style="color:#fff;font-weight:bold">count</span>(start_time)) <span style="color:#fff;font-weight:bold">AS</span> ranking
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info <span style="color:#fff;font-weight:bold">USING</span> (exam_id)
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> tag = <span style="color:#0ff;font-weight:bold">&#39;SQL&#39;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> UID) t
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#007f7f">-- 再求出近三个月的练习记录
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span> <span style="color:#fff;font-weight:bold">SELECT</span> UID,
</span></span><span style="display:flex;"><span>        date_format(start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) <span style="color:#fff;font-weight:bold">AS</span> month_d,
</span></span><span style="display:flex;"><span>        submit_time,
</span></span><span style="display:flex;"><span>        exam_id,
</span></span><span style="display:flex;"><span>        dense_rank() OVER (PARTITION <span style="color:#fff;font-weight:bold">BY</span> UID
</span></span><span style="display:flex;"><span>                           <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> date_format(start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) <span style="color:#fff;font-weight:bold">DESC</span>) <span style="color:#fff;font-weight:bold">AS</span> ranking
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> user_info <span style="color:#fff;font-weight:bold">USING</span> (UID)
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">LEVEL</span> <span style="color:#fff;font-weight:bold">IN</span> (<span style="color:#ff0;font-weight:bold">6</span>,<span style="color:#ff0;font-weight:bold">7</span>) ) t1 <span style="color:#fff;font-weight:bold">USING</span> (UID)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> t1.ranking &lt;= <span style="color:#ff0;font-weight:bold">3</span> <span style="color:#fff;font-weight:bold">AND</span> t.ranking &gt;= <span style="color:#ff0;font-weight:bold">0</span>.<span style="color:#ff0;font-weight:bold">5</span> <span style="color:#007f7f">-- 使用限制找到符合条件的记录
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> t1.uid,
</span></span><span style="display:flex;"><span>         t1.month_d
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> t1.uid,
</span></span><span style="display:flex;"><span>         t1.month_d
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="试卷完成数同比-2020-年的增长率及排名变化困难">试卷完成数同比 2020 年的增长率及排名变化（困难）<a hidden class="anchor" aria-hidden="true" href="#试卷完成数同比-2020-年的增长率及排名变化困难">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>C++</td>
<td>hard</td>
<td>80</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>hard</td>
<td>80</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>9004</td>
<td>PYTHON</td>
<td>medium</td>
<td>70</td>
<td>2021-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-08-02 10:01:01</td>
<td>2020-08-02 10:31:01</td>
<td>89</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9001</td>
<td>2020-04-01 18:01:01</td>
<td>2020-04-01 18:59:02</td>
<td>90</td>
</tr>
<tr>
<td>3</td>
<td>1001</td>
<td>9001</td>
<td>2020-04-01 09:01:01</td>
<td>2020-04-01 09:21:59</td>
<td>80</td>
</tr>
<tr>
<td>5</td>
<td>1002</td>
<td>9001</td>
<td>2021-03-02 19:01:01</td>
<td>2021-03-02 19:32:00</td>
<td>20</td>
</tr>
<tr>
<td>8</td>
<td>1003</td>
<td>9001</td>
<td>2021-05-02 12:01:01</td>
<td>2021-05-02 12:31:01</td>
<td>98</td>
</tr>
<tr>
<td>13</td>
<td>1003</td>
<td>9001</td>
<td>2020-01-02 10:01:01</td>
<td>2020-01-02 10:31:01</td>
<td>89</td>
</tr>
<tr>
<td>9</td>
<td>1001</td>
<td>9002</td>
<td>2020-02-02 12:01:01</td>
<td>2020-02-02 12:20:01</td>
<td>99</td>
</tr>
<tr>
<td>10</td>
<td>1002</td>
<td>9002</td>
<td>2021-02-02 12:01:01</td>
<td>2020-02-02 12:43:01</td>
<td>81</td>
</tr>
<tr>
<td>11</td>
<td>1001</td>
<td>9002</td>
<td>2020-01-02 19:01:01</td>
<td>2020-01-02 19:59:01</td>
<td>69</td>
</tr>
<tr>
<td>16</td>
<td>1002</td>
<td>9002</td>
<td>2020-02-02 12:01:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>17</td>
<td>1002</td>
<td>9002</td>
<td>2020-03-02 12:11:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>18</td>
<td>1001</td>
<td>9002</td>
<td>2021-05-05 18:01:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>9003</td>
<td>2021-01-20 10:01:01</td>
<td>2021-01-20 10:10:01</td>
<td>81</td>
</tr>
<tr>
<td>6</td>
<td>1001</td>
<td>9003</td>
<td>2021-04-02 19:01:01</td>
<td>2021-04-02 19:40:01</td>
<td>89</td>
</tr>
<tr>
<td>15</td>
<td>1002</td>
<td>9003</td>
<td>2021-01-01 18:01:01</td>
<td>2021-01-01 18:59:02</td>
<td>90</td>
</tr>
<tr>
<td>7</td>
<td>1004</td>
<td>9004</td>
<td>2020-05-02 12:01:01</td>
<td>2020-05-02 12:20:01</td>
<td>99</td>
</tr>
<tr>
<td>12</td>
<td>1001</td>
<td>9004</td>
<td>2021-09-02 12:11:01</td>
<td></td>
<td></td>
</tr>
<tr>
<td>14</td>
<td>1002</td>
<td>9004</td>
<td>2020-01-01 12:11:01</td>
<td>2020-01-01 12:31:01</td>
<td>83</td>
</tr>
</tbody>
</table>
<p>请计算 2021 年上半年各类试卷的做完次数相比 2020 年上半年同期的增长率（百分比格式，保留 1 位小数），以及做完次数排名变化，按增长率和 21 年排名降序输出。</p>
<p>由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>tag</th>
<th>exam_cnt_20</th>
<th>exam_cnt_21</th>
<th>growth_rate</th>
<th>exam_cnt_rank_20</th>
<th>exam_cnt_rank_21</th>
<th>rank_delta</th>
</tr>
</thead>
<tbody>
<tr>
<td>SQL</td>
<td>3</td>
<td>2</td>
<td>-33.3%</td>
<td>1</td>
<td>2</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>解释：2020 年上半年有 3 个 tag 有作答完成的记录，分别是 C++、SQL、PYTHON，它们被做完的次数分别是 3、3、2，做完次数排名为 1、1（并列）、3；</p>
<p>2021 年上半年有 2 个 tag 有作答完成的记录，分别是算法、SQL，它们被做完的次数分别是 3、2，做完次数排名为 1、2；具体如下：</p>
<table>
<thead>
<tr>
<th>tag</th>
<th>start_year</th>
<th>exam_cnt</th>
<th>exam_cnt_rank</th>
</tr>
</thead>
<tbody>
<tr>
<td>C++</td>
<td>2020</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>SQL</td>
<td>2020</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>PYTHON</td>
<td>2020</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>算法</td>
<td>2021</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>SQL</td>
<td>2021</td>
<td>2</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>因此能输出同比结果的 tag 只有 SQL，从 2020 到 2021 年，做完次数 3=&gt;2，减少 33.3%（保留 1 位小数）；排名 1=&gt;2，后退 1 名。</p>
<p><strong>思路：</strong></p>
<p>本题难点在于长整型的数据类型要求不能有负号产生，用 cast 函数转换数据类型为 signed。</p>
<p>以及用到的<code>增长率计算公式：(exam_cnt_21-exam_cnt_20)/exam_cnt_20</code></p>
<p>做完次数排名变化（2021 年和 2020 年比排名升了或者降了多少）</p>
<p>计算公式：<code>exam_cnt_rank_21 - exam_cnt_rank_20</code></p>
<p>在 MySQL 中，<code>CAST()</code> 函数用于将一个表达式的数据类型转换为另一个数据类型。它的基本语法如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CAST</span>(expression <span style="color:#fff;font-weight:bold">AS</span> data_type)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 将一个字符串转换成整数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">CAST</span>(<span style="color:#0ff;font-weight:bold">&#39;123&#39;</span> <span style="color:#fff;font-weight:bold">AS</span> <span style="color:#fff;font-weight:bold">INT</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>示例就不一一举例了，这个函数很简单</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>  tag,
</span></span><span style="display:flex;"><span>  exam_cnt_20,
</span></span><span style="display:flex;"><span>  exam_cnt_21,
</span></span><span style="display:flex;"><span>  concat(
</span></span><span style="display:flex;"><span>    round(
</span></span><span style="display:flex;"><span>      <span style="color:#ff0;font-weight:bold">100</span> * (exam_cnt_21 - exam_cnt_20) / exam_cnt_20,
</span></span><span style="display:flex;"><span>      <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#39;%&#39;</span>
</span></span><span style="display:flex;"><span>  ) <span style="color:#fff;font-weight:bold">AS</span> growth_rate,
</span></span><span style="display:flex;"><span>  exam_cnt_rank_20,
</span></span><span style="display:flex;"><span>  exam_cnt_rank_21,
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">cast</span>(exam_cnt_rank_21 <span style="color:#fff;font-weight:bold">AS</span> signed) - <span style="color:#fff;font-weight:bold">cast</span>(exam_cnt_rank_20 <span style="color:#fff;font-weight:bold">AS</span> signed) <span style="color:#fff;font-weight:bold">AS</span> rank_delta
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>  (
</span></span><span style="display:flex;"><span>    #<span style="color:#ff0;font-weight:bold">2020</span><span style="color:#f00">年、</span><span style="color:#ff0;font-weight:bold">2021</span><span style="color:#f00">年上半年各类试卷的做完次数和做完次数排名</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>      tag,
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">count</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">IF</span> (
</span></span><span style="display:flex;"><span>          date_format(start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m%d&#39;</span>) <span style="color:#fff;font-weight:bold">BETWEEN</span> <span style="color:#0ff;font-weight:bold">&#39;20200101&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">AND</span> <span style="color:#0ff;font-weight:bold">&#39;20200630&#39;</span>,
</span></span><span style="display:flex;"><span>          start_time,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>      ) <span style="color:#fff;font-weight:bold">AS</span> exam_cnt_20,
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">count</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">IF</span> (
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">substring</span>(start_time, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">10</span>) <span style="color:#fff;font-weight:bold">BETWEEN</span> <span style="color:#0ff;font-weight:bold">&#39;2021-01-01&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">AND</span> <span style="color:#0ff;font-weight:bold">&#39;2021-06-30&#39;</span>,
</span></span><span style="display:flex;"><span>          start_time,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>      ) <span style="color:#fff;font-weight:bold">AS</span> exam_cnt_21,
</span></span><span style="display:flex;"><span>      rank() over (
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">count</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">IF</span> (
</span></span><span style="display:flex;"><span>              date_format(start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m%d&#39;</span>) <span style="color:#fff;font-weight:bold">BETWEEN</span> <span style="color:#0ff;font-weight:bold">&#39;20200101&#39;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#fff;font-weight:bold">AND</span> <span style="color:#0ff;font-weight:bold">&#39;20200630&#39;</span>,
</span></span><span style="display:flex;"><span>              start_time,
</span></span><span style="display:flex;"><span>              <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>          ) <span style="color:#fff;font-weight:bold">DESC</span>
</span></span><span style="display:flex;"><span>      ) <span style="color:#fff;font-weight:bold">AS</span> exam_cnt_rank_20,
</span></span><span style="display:flex;"><span>      rank() over (
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">count</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">IF</span> (
</span></span><span style="display:flex;"><span>              <span style="color:#fff;font-weight:bold">substring</span>(start_time, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">10</span>) <span style="color:#fff;font-weight:bold">BETWEEN</span> <span style="color:#0ff;font-weight:bold">&#39;2021-01-01&#39;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#fff;font-weight:bold">AND</span> <span style="color:#0ff;font-weight:bold">&#39;2021-06-30&#39;</span>,
</span></span><span style="display:flex;"><span>              start_time,
</span></span><span style="display:flex;"><span>              <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>          ) <span style="color:#fff;font-weight:bold">DESC</span>
</span></span><span style="display:flex;"><span>      ) <span style="color:#fff;font-weight:bold">AS</span> exam_cnt_rank_21
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>      examination_info
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">JOIN</span> exam_record <span style="color:#fff;font-weight:bold">USING</span> (exam_id)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>      submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>      tag
</span></span><span style="display:flex;"><span>  ) main
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>  exam_cnt_21 * exam_cnt_20 &lt;&gt; <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>  growth_rate <span style="color:#fff;font-weight:bold">DESC</span>,
</span></span><span style="display:flex;"><span>  exam_cnt_rank_21 <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="聚合窗口函数">聚合窗口函数<a hidden class="anchor" aria-hidden="true" href="#聚合窗口函数">#</a></h2>
<h3 id="对试卷得分做-min-max-归一化">对试卷得分做 min-max 归一化<a hidden class="anchor" aria-hidden="true" href="#对试卷得分做-min-max-归一化">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>C++</td>
<td>hard</td>
<td>80</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>算法</td>
<td>hard</td>
<td>80</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>9004</td>
<td>PYTHON</td>
<td>medium</td>
<td>70</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>6</td>
<td>1003</td>
<td>9001</td>
<td>2020-01-02 12:01:01</td>
<td>2020-01-02 12:31:01</td>
<td>68</td>
</tr>
<tr>
<td>9</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 10:01:01</td>
<td>2020-01-02 10:31:01</td>
<td>89</td>
</tr>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-01 09:01:01</td>
<td>2020-01-01 09:21:59</td>
<td>90</td>
</tr>
<tr>
<td>12</td>
<td>1002</td>
<td>9002</td>
<td>2021-05-05 18:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>3</td>
<td>1004</td>
<td>9002</td>
<td>2020-01-01 12:01:01</td>
<td>2020-01-01 12:11:01</td>
<td>60</td>
</tr>
<tr>
<td>2</td>
<td>1003</td>
<td>9002</td>
<td>2020-01-01 19:01:01</td>
<td>2020-01-01 19:30:01</td>
<td>75</td>
</tr>
<tr>
<td>7</td>
<td>1001</td>
<td>9002</td>
<td>2020-01-02 12:01:01</td>
<td>2020-01-02 12:43:01</td>
<td>81</td>
</tr>
<tr>
<td>10</td>
<td>1002</td>
<td>9002</td>
<td>2020-01-01 12:11:01</td>
<td>2020-01-01 12:31:01</td>
<td>83</td>
</tr>
<tr>
<td>4</td>
<td>1003</td>
<td>9002</td>
<td>2020-01-01 12:01:01</td>
<td>2020-01-01 12:41:01</td>
<td>90</td>
</tr>
<tr>
<td>5</td>
<td>1002</td>
<td>9002</td>
<td>2020-01-02 19:01:01</td>
<td>2020-01-02 19:32:00</td>
<td>90</td>
</tr>
<tr>
<td>11</td>
<td>1002</td>
<td>9004</td>
<td>2021-09-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>8</td>
<td>1001</td>
<td>9005</td>
<td>2020-01-02 12:11:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p>在物理学及统计学数据计算时，有个概念叫 min-max 标准化，也被称为离差标准化，是对原始数据的线性变换，使结果值映射到[0 - 1]之间。</p>
<p>转换函数为：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Xi - min(xi)
</span></span><span style="display:flex;"><span>-----------------
</span></span><span style="display:flex;"><span>max(xi) - min(xi)
</span></span></code></pre></td></tr></table>
</div>
</div><p>请你将用户作答高难度试卷的得分在每份试卷作答记录内执行 min-max 归一化后缩放到[0,100]区间，并输出用户 ID、试卷 ID、归一化后分数平均值；最后按照试卷 ID 升序、归一化分数降序输出。（注：得分区间默认为[0,100]，如果某个试卷作答记录中只有一个得分，那么无需使用公式，归一化并缩放后分数仍为原分数）。</p>
<p>由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>exam_id</th>
<th>avg_new_score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1001</td>
<td>9001</td>
<td>98</td>
</tr>
<tr>
<td>1003</td>
<td>9001</td>
<td>0</td>
</tr>
<tr>
<td>1002</td>
<td>9002</td>
<td>88</td>
</tr>
<tr>
<td>1003</td>
<td>9002</td>
<td>75</td>
</tr>
<tr>
<td>1001</td>
<td>9002</td>
<td>70</td>
</tr>
<tr>
<td>1004</td>
<td>9002</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>解释：高难度试卷有 9001、9002、9003；</p>
<p>作答了 9001 的记录有 3 条，分数分别为 68、89、90，按给定公式归一化后分数为：0、95、100，而后两个得分都是用户 1001 作答的，因此用户 1001 对试卷 9001 的新得分为(95+100)/2≈98（只保留整数部分），用户 1003 对于试卷 9001 的新得分为 0。最后结果按照试卷 ID 升序、归一化分数降序输出。</p>
<p><strong>思路：</strong></p>
<p>注意点：</p>
<ol>
<li>将高难度的试卷，按每类试卷的得分，利用 max/min (col) over()窗口函数求得各组内最大最小值，然后进行归一化公式计算，缩放区间为[0,100]，即 min_max*100</li>
<li>若某类试卷只有一个得分，则无需使用归一化公式，因只有一个分 max_score=min_score,score，公式后结果可能会变成 0。</li>
<li>最后结果按 uid、exam_id 分组求归一化后均值，score 为 NULL 的要过滤掉。</li>
</ol>
<p>最后就是仔细看上面公式 （说实话，这题看起来就很绕）</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>  uid,
</span></span><span style="display:flex;"><span>  exam_id,
</span></span><span style="display:flex;"><span>  round(<span style="color:#fff;font-weight:bold">sum</span>(min_max) / <span style="color:#fff;font-weight:bold">count</span>(score), <span style="color:#ff0;font-weight:bold">0</span>) <span style="color:#fff;font-weight:bold">AS</span> avg_new_score
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>  (
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>      *,
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">IF</span> (
</span></span><span style="display:flex;"><span>        max_score = min_score,
</span></span><span style="display:flex;"><span>        score,
</span></span><span style="display:flex;"><span>        (score - min_score) / (max_score - min_score) * <span style="color:#ff0;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>      ) <span style="color:#fff;font-weight:bold">AS</span> min_max
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>      (
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>          uid,
</span></span><span style="display:flex;"><span>          a.exam_id,
</span></span><span style="display:flex;"><span>          score,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">max</span>(score) over (PARTITION <span style="color:#fff;font-weight:bold">BY</span> a.exam_id) <span style="color:#fff;font-weight:bold">AS</span> max_score,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">min</span>(score) over (PARTITION <span style="color:#fff;font-weight:bold">BY</span> a.exam_id) <span style="color:#fff;font-weight:bold">AS</span> min_score
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>          exam_record a
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info b <span style="color:#fff;font-weight:bold">USING</span> (exam_id)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>          difficulty = <span style="color:#0ff;font-weight:bold">&#39;hard&#39;</span>
</span></span><span style="display:flex;"><span>      ) t
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>      score <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>  ) t1
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>  uid,
</span></span><span style="display:flex;"><span>  exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>  exam_id <span style="color:#fff;font-weight:bold">ASC</span>,
</span></span><span style="display:flex;"><span>  avg_new_score <span style="color:#fff;font-weight:bold">DESC</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="每份试卷每月作答数和截止当月的作答总数">每份试卷每月作答数和截止当月的作答总数<a hidden class="anchor" aria-hidden="true" href="#每份试卷每月作答数和截止当月的作答总数">#</a></h3>
<p><strong>描述:</strong></p>
<p>现有试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-01 09:01:01</td>
<td>2020-01-01 09:21:59</td>
<td>90</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9001</td>
<td>2020-01-20 10:01:01</td>
<td>2020-01-20 10:10:01</td>
<td>89</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9001</td>
<td>2020-02-01 12:11:01</td>
<td>2020-02-01 12:31:01</td>
<td>83</td>
</tr>
<tr>
<td>4</td>
<td>1003</td>
<td>9001</td>
<td>2020-03-01 19:01:01</td>
<td>2020-03-01 19:30:01</td>
<td>75</td>
</tr>
<tr>
<td>5</td>
<td>1004</td>
<td>9001</td>
<td>2020-03-01 12:01:01</td>
<td>2020-03-01 12:11:01</td>
<td>60</td>
</tr>
<tr>
<td>6</td>
<td>1003</td>
<td>9001</td>
<td>2020-03-01 12:01:01</td>
<td>2020-03-01 12:41:01</td>
<td>90</td>
</tr>
<tr>
<td>7</td>
<td>1002</td>
<td>9001</td>
<td>2020-05-02 19:01:01</td>
<td>2020-05-02 19:32:00</td>
<td>90</td>
</tr>
<tr>
<td>8</td>
<td>1001</td>
<td>9002</td>
<td>2020-01-02 19:01:01</td>
<td>2020-01-02 19:59:01</td>
<td>69</td>
</tr>
<tr>
<td>9</td>
<td>1004</td>
<td>9002</td>
<td>2020-02-02 12:01:01</td>
<td>2020-02-02 12:20:01</td>
<td>99</td>
</tr>
<tr>
<td>10</td>
<td>1003</td>
<td>9002</td>
<td>2020-02-02 12:01:01</td>
<td>2020-02-02 12:31:01</td>
<td>68</td>
</tr>
<tr>
<td>11</td>
<td>1001</td>
<td>9002</td>
<td>2020-02-02 12:01:01</td>
<td>2020-02-02 12:43:01</td>
<td>81</td>
</tr>
<tr>
<td>12</td>
<td>1001</td>
<td>9002</td>
<td>2020-03-02 12:11:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p>请输出每份试卷每月作答数和截止当月的作答总数。 由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>exam_id</th>
<th>start_month</th>
<th>month_cnt</th>
<th>cum_exam_cnt</th>
</tr>
</thead>
<tbody>
<tr>
<td>9001</td>
<td>202001</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>9001</td>
<td>202002</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>9001</td>
<td>202003</td>
<td>3</td>
<td>6</td>
</tr>
<tr>
<td>9001</td>
<td>202005</td>
<td>1</td>
<td>7</td>
</tr>
<tr>
<td>9002</td>
<td>202001</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>9002</td>
<td>202002</td>
<td>3</td>
<td>4</td>
</tr>
<tr>
<td>9002</td>
<td>202003</td>
<td>1</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>解释：试卷 9001 在 202001、202002、202003、202005 共 4 个月有被作答记录，每个月被作答数分别为 2、1、3、1，截止当月累积作答总数为 2、3、6、7。</p>
<p><strong>思路：</strong></p>
<p>这题就两个关键点：统计截止当月的作答总数、输出每份试卷每月作答数和截止当月的作答总数</p>
<p>这个是关键<code>**sum(count(*)) over(partition by exam_id order by date_format(start_time,'%Y%m'))**</code></p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> exam_id,
</span></span><span style="display:flex;"><span>       date_format(start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) <span style="color:#fff;font-weight:bold">AS</span> start_month,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">AS</span> month_cnt,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">sum</span>(<span style="color:#fff;font-weight:bold">count</span>(*)) OVER (PARTITION <span style="color:#fff;font-weight:bold">BY</span> exam_id
</span></span><span style="display:flex;"><span>                           <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> date_format(start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>)) <span style="color:#fff;font-weight:bold">AS</span> cum_exam_cnt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> exam_id,
</span></span><span style="display:flex;"><span>         start_month
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="每月及截止当月的答题情况较难">每月及截止当月的答题情况（较难）<a hidden class="anchor" aria-hidden="true" href="#每月及截止当月的答题情况较难">#</a></h3>
<p><strong>描述</strong>：现有试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-01 09:01:01</td>
<td>2020-01-01 09:21:59</td>
<td>90</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9001</td>
<td>2020-01-20 10:01:01</td>
<td>2020-01-20 10:10:01</td>
<td>89</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9001</td>
<td>2020-02-01 12:11:01</td>
<td>2020-02-01 12:31:01</td>
<td>83</td>
</tr>
<tr>
<td>4</td>
<td>1003</td>
<td>9001</td>
<td>2020-03-01 19:01:01</td>
<td>2020-03-01 19:30:01</td>
<td>75</td>
</tr>
<tr>
<td>5</td>
<td>1004</td>
<td>9001</td>
<td>2020-03-01 12:01:01</td>
<td>2020-03-01 12:11:01</td>
<td>60</td>
</tr>
<tr>
<td>6</td>
<td>1003</td>
<td>9001</td>
<td>2020-03-01 12:01:01</td>
<td>2020-03-01 12:41:01</td>
<td>90</td>
</tr>
<tr>
<td>7</td>
<td>1002</td>
<td>9001</td>
<td>2020-05-02 19:01:01</td>
<td>2020-05-02 19:32:00</td>
<td>90</td>
</tr>
<tr>
<td>8</td>
<td>1001</td>
<td>9002</td>
<td>2020-01-02 19:01:01</td>
<td>2020-01-02 19:59:01</td>
<td>69</td>
</tr>
<tr>
<td>9</td>
<td>1004</td>
<td>9002</td>
<td>2020-02-02 12:01:01</td>
<td>2020-02-02 12:20:01</td>
<td>99</td>
</tr>
<tr>
<td>10</td>
<td>1003</td>
<td>9002</td>
<td>2020-02-02 12:01:01</td>
<td>2020-02-02 12:31:01</td>
<td>68</td>
</tr>
<tr>
<td>11</td>
<td>1001</td>
<td>9002</td>
<td>2020-01-02 19:01:01</td>
<td>2020-02-02 12:43:01</td>
<td>81</td>
</tr>
<tr>
<td>12</td>
<td>1001</td>
<td>9002</td>
<td>2020-03-02 12:11:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p>请输出自从有用户作答记录以来，每月的试卷作答记录中月活用户数、新增用户数、截止当月的单月最大新增用户数、截止当月的累积用户数。结果按月份升序输出。</p>
<p>由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>start_month</th>
<th>mau</th>
<th>month_add_uv</th>
<th>max_month_add_uv</th>
<th>cum_sum_uv</th>
</tr>
</thead>
<tbody>
<tr>
<td>202001</td>
<td>2</td>
<td>2</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>202002</td>
<td>4</td>
<td>2</td>
<td>2</td>
<td>4</td>
</tr>
<tr>
<td>202003</td>
<td>3</td>
<td>0</td>
<td>2</td>
<td>4</td>
</tr>
<tr>
<td>202005</td>
<td>1</td>
<td>0</td>
<td>2</td>
<td>4</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>month</th>
<th>1001</th>
<th>1002</th>
<th>1003</th>
<th>1004</th>
</tr>
</thead>
<tbody>
<tr>
<td>202001</td>
<td>1</td>
<td>1</td>
<td></td>
<td></td>
</tr>
<tr>
<td>202002</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>202003</td>
<td>1</td>
<td></td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>202005</td>
<td></td>
<td>1</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>由上述矩阵可以看出，2020 年 1 月有 2 个用户活跃（mau=2），当月新增用户数为 2；</p>
<p>2020 年 2 月有 4 个用户活跃，当月新增用户数为 2，最大单月新增用户数为 2，当前累积用户数为 4。</p>
<p><strong>思路：</strong></p>
<p>难点：</p>
<p>1.如何求每月新增用户</p>
<p>2.截至当月的答题情况</p>
<p>大致流程：</p>
<p>（1）统计每个人的首次登陆月份 <code>min()</code></p>
<p>（2）统计每月的月活和新增用户数：先得到每个人的首次登陆月份，再对首次登陆月份分组求和是该月份的新增人数</p>
<p>（3）统计截止当月的单月最大新增用户数、截止当月的累积用户数 ，最终按照按月份升序输出</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#007f7f">-- 截止当月的单月最大新增用户数、截止当月的累积用户数，按月份升序输出
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	start_month,
</span></span><span style="display:flex;"><span>	mau,
</span></span><span style="display:flex;"><span>	month_add_uv,
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">max</span>( month_add_uv ) over ( <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> start_month ),
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">sum</span>( month_add_uv ) over ( <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> start_month )
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	(
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">-- 统计每月的月活和新增用户数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>		date_format( a.start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span> ) <span style="color:#fff;font-weight:bold">AS</span> start_month,
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">count</span>( <span style="color:#fff;font-weight:bold">DISTINCT</span> a.uid ) <span style="color:#fff;font-weight:bold">AS</span> mau,
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">count</span>( <span style="color:#fff;font-weight:bold">DISTINCT</span> b.uid ) <span style="color:#fff;font-weight:bold">AS</span> month_add_uv
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>		exam_record a
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> (
</span></span><span style="display:flex;"><span>         <span style="color:#007f7f">-- 统计每个人的首次登陆月份
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">SELECT</span> uid, <span style="color:#fff;font-weight:bold">min</span>( date_format( start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span> )) <span style="color:#fff;font-weight:bold">AS</span> first_month <span style="color:#fff;font-weight:bold">FROM</span> exam_record <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> uid ) b <span style="color:#fff;font-weight:bold">ON</span> date_format( a.start_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span> ) = b.first_month
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>		start_month
</span></span><span style="display:flex;"><span>	) main
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	start_month
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="sql面试题5">SQL面试题5<a hidden class="anchor" aria-hidden="true" href="#sql面试题5">#</a></h1>
<h2 id="空值处理">空值处理<a hidden class="anchor" aria-hidden="true" href="#空值处理">#</a></h2>
<h3 id="统计有未完成状态的试卷的未完成数和未完成率">统计有未完成状态的试卷的未完成数和未完成率<a hidden class="anchor" aria-hidden="true" href="#统计有未完成状态的试卷的未完成数和未完成率">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分），数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 09:01:01</td>
<td>2020-01-02 09:21:01</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1001</td>
<td>9001</td>
<td>2021-05-02 10:01:01</td>
<td>2021-05-02 10:30:01</td>
<td>81</td>
</tr>
<tr>
<td>3</td>
<td>1001</td>
<td>9001</td>
<td>2021-09-02 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
</tbody>
</table>
<p>请统计有未完成状态的试卷的未完成数 incomplete_cnt 和未完成率 incomplete_rate。由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>exam_id</th>
<th>incomplete_cnt</th>
<th>complete_rate</th>
</tr>
</thead>
<tbody>
<tr>
<td>9001</td>
<td>1</td>
<td>0.333</td>
</tr>
</tbody>
</table>
<p>解释：试卷 9001 有 3 次被作答的记录，其中两次完成，1 次未完成，因此未完成数为 1，未完成率为 0.333（保留 3 位小数）</p>
<p><strong>思路</strong>：</p>
<p>这题只需要注意一个是有条件限制，一个是没条件限制的；要么分别查询条件，然后合并；要么直接在 select 里面进行条件判断。</p>
<p><strong>答案</strong>：</p>
<p>写法 1：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> exam_id,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">OR</span> <span style="color:#fff;font-weight:bold">NULL</span>) incomplete_cnt,
</span></span><span style="display:flex;"><span>       ROUND(<span style="color:#fff;font-weight:bold">count</span>(submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">OR</span> <span style="color:#fff;font-weight:bold">NULL</span>) / <span style="color:#fff;font-weight:bold">count</span>(*), <span style="color:#ff0;font-weight:bold">3</span>) complete_rate
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> incomplete_cnt &lt;&gt; <span style="color:#ff0;font-weight:bold">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>写法 2：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> exam_id,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">count</span>(submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">OR</span> <span style="color:#fff;font-weight:bold">NULL</span>) incomplete_cnt,
</span></span><span style="display:flex;"><span>       ROUND(<span style="color:#fff;font-weight:bold">count</span>(submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">OR</span> <span style="color:#fff;font-weight:bold">NULL</span>) / <span style="color:#fff;font-weight:bold">count</span>(*), <span style="color:#ff0;font-weight:bold">3</span>) complete_rate
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> incomplete_cnt &lt;&gt; <span style="color:#ff0;font-weight:bold">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>两种写法都可以，只有中间的写法不一样，一个是对符合条件的才<code>COUNT</code>，一个是直接上<code>IF</code>,后者更为直观，最后这个<code>having</code>解释一下， 无论是 <code>complete_rate</code> 还是 <code>incomplete_cnt</code>，只要不为 0 即可，不为 0 就意味着有未完成的。</p>
<h3 id="0-级用户高难度试卷的平均用时和平均得分">0 级用户高难度试卷的平均用时和平均得分<a hidden class="anchor" aria-hidden="true" href="#0-级用户高难度试卷的平均用时和平均得分">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间），数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1 号</td>
<td>10</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>2100</td>
<td>6</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间），数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>SQL</td>
<td>hard</td>
<td>60</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>SQL</td>
<td>easy</td>
<td>60</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9004</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分），数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 09:01:01</td>
<td>2020-01-02 09:21:59</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1001</td>
<td>9001</td>
<td>2021-05-02 10:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>3</td>
<td>1001</td>
<td>9002</td>
<td>2021-02-02 19:01:01</td>
<td>2021-02-02 19:30:01</td>
<td>87</td>
</tr>
<tr>
<td>4</td>
<td>1001</td>
<td>9001</td>
<td>2021-06-02 19:01:01</td>
<td>2021-06-02 19:32:00</td>
<td>20</td>
</tr>
<tr>
<td>5</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-05 19:01:01</td>
<td>2021-09-05 19:40:01</td>
<td>89</td>
</tr>
<tr>
<td>6</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>7</td>
<td>1002</td>
<td>9002</td>
<td>2021-05-05 18:01:01</td>
<td>2021-05-05 18:59:02</td>
<td>90</td>
</tr>
</tbody>
</table>
<p>请输出每个 0 级用户所有的高难度试卷考试平均用时和平均得分，未完成的默认试卷最大考试时长和 0 分处理。由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>avg_score</th>
<th>avg_time_took</th>
</tr>
</thead>
<tbody>
<tr>
<td>1001</td>
<td>33</td>
<td>36.7</td>
</tr>
</tbody>
</table>
<p>解释：0 级用户有 1001，高难度试卷有 9001，1001 作答 9001 的记录有 3 条，分别用时 20 分钟、未完成（试卷时长 60 分钟）、30 分钟（未满 31 分钟），分别得分为 80 分、未完成（0 分处理）、20 分。因此他的平均用时为 110/3=36.7（保留一位小数），平均得分为 33 分（取整）</p>
<p><strong>思路</strong>：这题用<code>IF</code>是判断的最方便的，因为涉及到 NULL 值的判断。当然 <code>case when</code>也可以，大同小异。这题的难点就在于空值的处理，其他的这些查询条件什么的，我相信难不倒大家。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> UID,
</span></span><span style="display:flex;"><span>       round(<span style="color:#fff;font-weight:bold">avg</span>(new_socre)) <span style="color:#fff;font-weight:bold">AS</span> avg_score,
</span></span><span style="display:flex;"><span>       round(<span style="color:#fff;font-weight:bold">avg</span>(time_diff), <span style="color:#ff0;font-weight:bold">1</span>) <span style="color:#fff;font-weight:bold">AS</span> avg_time_took
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> er.uid,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">IF</span> (er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>, TIMESTAMPDIFF(<span style="color:#fff;font-weight:bold">MINUTE</span>, start_time, submit_time), ef.duration) <span style="color:#fff;font-weight:bold">AS</span> time_diff,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">IF</span> (er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>,er.score,<span style="color:#ff0;font-weight:bold">0</span>) <span style="color:#fff;font-weight:bold">AS</span> new_socre
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record er
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> user_info uf <span style="color:#fff;font-weight:bold">ON</span> er.uid = uf.uid
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> examination_info ef <span style="color:#fff;font-weight:bold">ON</span> er.exam_id = ef.exam_id
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> uf.<span style="color:#fff;font-weight:bold">LEVEL</span> = <span style="color:#ff0;font-weight:bold">0</span> <span style="color:#fff;font-weight:bold">AND</span> ef.difficulty = <span style="color:#0ff;font-weight:bold">&#39;hard&#39;</span> ) t
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> UID
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> UID
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="高级条件语句">高级条件语句<a hidden class="anchor" aria-hidden="true" href="#高级条件语句">#</a></h2>
<h3 id="筛选限定昵称成就值活跃日期的用户较难">筛选限定昵称成就值活跃日期的用户（较难）<a hidden class="anchor" aria-hidden="true" href="#筛选限定昵称成就值活跃日期的用户较难">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1 号</td>
<td>1000</td>
<td>2</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>1200</td>
<td>3</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>进击的 3 号</td>
<td>2200</td>
<td>5</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1004</td>
<td>牛客 4 号</td>
<td>2500</td>
<td>6</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>牛客 5 号</td>
<td>3000</td>
<td>7</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 09:01:01</td>
<td>2020-01-02 09:21:59</td>
<td>80</td>
</tr>
<tr>
<td>3</td>
<td>1001</td>
<td>9002</td>
<td>2021-02-02 19:01:01</td>
<td>2021-02-02 19:30:01</td>
<td>87</td>
</tr>
<tr>
<td>2</td>
<td>1001</td>
<td>9001</td>
<td>2021-05-02 10:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>4</td>
<td>1001</td>
<td>9001</td>
<td>2021-06-02 19:01:01</td>
<td>2021-06-02 19:32:00</td>
<td>20</td>
</tr>
<tr>
<td>6</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>5</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-05 19:01:01</td>
<td>2021-09-05 19:40:01</td>
<td>89</td>
</tr>
<tr>
<td>11</td>
<td>1002</td>
<td>9001</td>
<td>2020-01-01 12:01:01</td>
<td>2020-01-01 12:31:01</td>
<td>81</td>
</tr>
<tr>
<td>12</td>
<td>1002</td>
<td>9002</td>
<td>2020-02-01 12:01:01</td>
<td>2020-02-01 12:31:01</td>
<td>82</td>
</tr>
<tr>
<td>13</td>
<td>1002</td>
<td>9002</td>
<td>2020-02-02 12:11:01</td>
<td>2020-02-02 12:31:01</td>
<td>83</td>
</tr>
<tr>
<td>7</td>
<td>1002</td>
<td>9002</td>
<td>2021-05-05 18:01:01</td>
<td>2021-05-05 18:59:02</td>
<td>90</td>
</tr>
<tr>
<td>16</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-06 12:01:01</td>
<td>2021-09-06 12:21:01</td>
<td>80</td>
</tr>
<tr>
<td>17</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>18</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-07 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>8</td>
<td>1003</td>
<td>9003</td>
<td>2021-02-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>9</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:31:01</td>
<td>89</td>
</tr>
<tr>
<td>10</td>
<td>1004</td>
<td>9002</td>
<td>2021-08-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>14</td>
<td>1005</td>
<td>9001</td>
<td>2021-02-01 11:01:01</td>
<td>2021-02-01 11:31:01</td>
<td>84</td>
</tr>
<tr>
<td>15</td>
<td>1006</td>
<td>9001</td>
<td>2021-02-01 11:01:01</td>
<td>2021-02-01 11:31:01</td>
<td>84</td>
</tr>
</tbody>
</table>
<p>题目练习记录表 <code>practice_record</code>（<code>uid</code> 用户 ID, <code>question_id</code> 题目 ID, <code>submit_time</code> 提交时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>question_id</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>8001</td>
<td>2021-08-02 11:41:01</td>
<td>60</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>8001</td>
<td>2021-09-02 19:30:01</td>
<td>50</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>8001</td>
<td>2021-09-02 19:20:01</td>
<td>70</td>
</tr>
<tr>
<td>4</td>
<td>1002</td>
<td>8002</td>
<td>2021-09-02 19:38:01</td>
<td>70</td>
</tr>
<tr>
<td>5</td>
<td>1003</td>
<td>8002</td>
<td>2021-09-01 19:38:01</td>
<td>80</td>
</tr>
</tbody>
</table>
<p>请找到昵称以『牛客』开头『号』结尾、成就值在 1200~2500 之间，且最近一次活跃（答题或作答试卷）在 2021 年 9 月的用户信息。</p>
<p>由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
</tr>
</thead>
<tbody>
<tr>
<td>1002</td>
<td>牛客 2 号</td>
<td>1200</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：昵称以『牛客』开头『号』结尾且成就值在 1200~2500 之间的有 1002、1004；</p>
<p>1002 最近一次试卷区活跃为 2021 年 9 月，最近一次题目区活跃为 2021 年 9 月；1004 最近一次试卷区活跃为 2021 年 8 月，题目区未活跃。</p>
<p>因此最终满足条件的只有 1002。</p>
<p><strong>思路</strong>：</p>
<p>先根据条件列出主要查询语句</p>
<p>昵称以『牛客』开头『号』结尾: <code>nick_name LIKE &quot;牛客%号&quot;</code></p>
<p>成就值在 1200~2500 之间：<code>achievement BETWEEN 1200 AND 2500</code></p>
<p>第三个条件因为限定了为 9 月，所以直接写就行：<code>( date_format( record.submit_time, '%Y%m' )= 202109 OR date_format( pr.submit_time, '%Y%m' )= 202109 )</code></p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DISTINCT</span> u_info.uid,
</span></span><span style="display:flex;"><span>                u_info.nick_name,
</span></span><span style="display:flex;"><span>                u_info.achievement
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> user_info u_info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record record <span style="color:#fff;font-weight:bold">ON</span> record.uid = u_info.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> practice_record pr <span style="color:#fff;font-weight:bold">ON</span> u_info.uid = pr.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> u_info.nick_name <span style="color:#fff;font-weight:bold">LIKE</span> <span style="color:#0ff;font-weight:bold">&#34;牛客%号&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> u_info.achievement <span style="color:#fff;font-weight:bold">BETWEEN</span> <span style="color:#ff0;font-weight:bold">1200</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> <span style="color:#ff0;font-weight:bold">2500</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> (date_format(record.submit_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>)= <span style="color:#ff0;font-weight:bold">202109</span>
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">OR</span> date_format(pr.submit_time, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>)= <span style="color:#ff0;font-weight:bold">202109</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> u_info.uid
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="筛选昵称规则和试卷规则的作答记录较难">筛选昵称规则和试卷规则的作答记录（较难）<a hidden class="anchor" aria-hidden="true" href="#筛选昵称规则和试卷规则的作答记录较难">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1 号</td>
<td>1900</td>
<td>2</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>1200</td>
<td>3</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>牛客 3 号 ♂</td>
<td>2200</td>
<td>5</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1004</td>
<td>牛客 4 号</td>
<td>2500</td>
<td>6</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>牛客 555 号</td>
<td>2000</td>
<td>7</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>6</td>
<td>1006</td>
<td>666666</td>
<td>3000</td>
<td>6</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>C++</td>
<td>hard</td>
<td>60</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>c#</td>
<td>hard</td>
<td>80</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>SQL</td>
<td>medium</td>
<td>70</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 09:01:01</td>
<td>2020-01-02 09:21:59</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1001</td>
<td>9001</td>
<td>2021-05-02 10:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>4</td>
<td>1001</td>
<td>9001</td>
<td>2021-06-02 19:01:01</td>
<td>2021-06-02 19:32:00</td>
<td>20</td>
</tr>
<tr>
<td>3</td>
<td>1001</td>
<td>9002</td>
<td>2021-02-02 19:01:01</td>
<td>2021-02-02 19:30:01</td>
<td>87</td>
</tr>
<tr>
<td>5</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-05 19:01:01</td>
<td>2021-09-05 19:40:01</td>
<td>89</td>
</tr>
<tr>
<td>6</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>11</td>
<td>1002</td>
<td>9001</td>
<td>2020-01-01 12:01:01</td>
<td>2020-01-01 12:31:01</td>
<td>81</td>
</tr>
<tr>
<td>16</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-06 12:01:01</td>
<td>2021-09-06 12:21:01</td>
<td>80</td>
</tr>
<tr>
<td>17</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>18</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-07 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>7</td>
<td>1002</td>
<td>9002</td>
<td>2021-05-05 18:01:01</td>
<td>2021-05-05 18:59:02</td>
<td>90</td>
</tr>
<tr>
<td>12</td>
<td>1002</td>
<td>9002</td>
<td>2020-02-01 12:01:01</td>
<td>2020-02-01 12:31:01</td>
<td>82</td>
</tr>
<tr>
<td>13</td>
<td>1002</td>
<td>9002</td>
<td>2020-02-02 12:11:01</td>
<td>2020-02-02 12:31:01</td>
<td>83</td>
</tr>
<tr>
<td>9</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:31:01</td>
<td>89</td>
</tr>
<tr>
<td>8</td>
<td>1003</td>
<td>9003</td>
<td>2021-02-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>10</td>
<td>1004</td>
<td>9002</td>
<td>2021-08-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>14</td>
<td>1005</td>
<td>9001</td>
<td>2021-02-01 11:01:01</td>
<td>2021-02-01 11:31:01</td>
<td>84</td>
</tr>
<tr>
<td>15</td>
<td>1006</td>
<td>9001</td>
<td>2021-02-01 11:01:01</td>
<td>2021-09-01 11:31:01</td>
<td>84</td>
</tr>
</tbody>
</table>
<p>找到昵称以&quot;牛客&quot;+纯数字+&ldquo;号&quot;或者纯数字组成的用户对于字母 c 开头的试卷类别（如 C,C++,c#等）的已完成的试卷 ID 和平均得分，按用户 ID、平均分升序排序。由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>exam_id</th>
<th>avg_score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1002</td>
<td>9001</td>
<td>81</td>
</tr>
<tr>
<td>1002</td>
<td>9002</td>
<td>85</td>
</tr>
<tr>
<td>1005</td>
<td>9001</td>
<td>84</td>
</tr>
<tr>
<td>1006</td>
<td>9001</td>
<td>84</td>
</tr>
</tbody>
</table>
<p>解释：昵称满足条件的用户有 1002、1004、1005、1006；</p>
<p>c 开头的试卷有 9001、9002；</p>
<p>满足上述条件的作答记录中，1002 完成 9001 的得分有 81、80，平均分为 81（80.5 取整四舍五入得 81）；</p>
<p>1002 完成 9002 的得分有 90、82、83，平均分为 85；</p>
<p><strong>思路</strong>：</p>
<p>还是老样子，既然给出了条件，就先把各个条件先写出来</p>
<p>找到昵称以&quot;牛客&rdquo;+纯数字+&ldquo;号&quot;或者纯数字组成的用户： 我最开始是这么写的：<code>nick_name LIKE '牛客%号' OR nick_name REGEXP '^[0-9]+$'</code>，如果表中有个 “牛客 H 号” ，那也能通过。</p>
<p>所以这里还得用正则： <code>nick_name LIKE '^牛客[0-9]+号'</code></p>
<p>对于字母 c 开头的试卷类别： <code>e_info.tag LIKE 'c%'</code> 或者 <code>tag regexp '^c|^C'</code> 第一个也能匹配到大写 C</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> UID,
</span></span><span style="display:flex;"><span>       exam_id,
</span></span><span style="display:flex;"><span>       ROUND(<span style="color:#fff;font-weight:bold">AVG</span>(score), <span style="color:#ff0;font-weight:bold">0</span>) avg_score
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> UID <span style="color:#fff;font-weight:bold">IN</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#fff;font-weight:bold">SELECT</span> UID
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> user_info
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">WHERE</span> nick_name RLIKE <span style="color:#0ff;font-weight:bold">&#34;^牛客[0-9]+号 $&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">OR</span> nick_name RLIKE <span style="color:#0ff;font-weight:bold">&#34;^[0-9]+$&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> exam_id <span style="color:#fff;font-weight:bold">IN</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#fff;font-weight:bold">SELECT</span> exam_id
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> examination_info
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">WHERE</span> tag RLIKE <span style="color:#0ff;font-weight:bold">&#34;^[cC]&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> score <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> UID,exam_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> UID,avg_score;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="根据指定记录是否存在输出不同情况困难">根据指定记录是否存在输出不同情况（困难）<a hidden class="anchor" aria-hidden="true" href="#根据指定记录是否存在输出不同情况困难">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1 号</td>
<td>19</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>1200</td>
<td>3</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>进击的 3 号</td>
<td>22</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1004</td>
<td>牛客 4 号</td>
<td>25</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>牛客 555 号</td>
<td>2000</td>
<td>7</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>6</td>
<td>1006</td>
<td>666666</td>
<td>3000</td>
<td>6</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 09:01:01</td>
<td>2020-01-02 09:21:59</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1001</td>
<td>9001</td>
<td>2021-05-02 10:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>3</td>
<td>1001</td>
<td>9002</td>
<td>2021-02-02 19:01:01</td>
<td>2021-02-02 19:30:01</td>
<td>87</td>
</tr>
<tr>
<td>4</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>5</td>
<td>1001</td>
<td>9003</td>
<td>2021-09-02 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>6</td>
<td>1001</td>
<td>9004</td>
<td>2021-09-03 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>7</td>
<td>1002</td>
<td>9001</td>
<td>2020-01-01 12:01:01</td>
<td>2020-01-01 12:31:01</td>
<td>99</td>
</tr>
<tr>
<td>8</td>
<td>1002</td>
<td>9003</td>
<td>2020-02-01 12:01:01</td>
<td>2020-02-01 12:31:01</td>
<td>82</td>
</tr>
<tr>
<td>9</td>
<td>1002</td>
<td>9003</td>
<td>2020-02-02 12:11:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>10</td>
<td>1002</td>
<td>9002</td>
<td>2021-05-05 18:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>11</td>
<td>1002</td>
<td>9001</td>
<td>2021-09-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>12</td>
<td>1003</td>
<td>9003</td>
<td>2021-02-06 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>13</td>
<td>1003</td>
<td>9001</td>
<td>2021-09-07 10:01:01</td>
<td>2021-09-07 10:31:01</td>
<td>89</td>
</tr>
</tbody>
</table>
<p>请你筛选表中的数据，当有任意一个 0 级用户未完成试卷数大于 2 时，输出每个 0 级用户的试卷未完成数和未完成率（保留 3 位小数）；若不存在这样的用户，则输出所有有作答记录的用户的这两个指标。结果按未完成率升序排序。</p>
<p>由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>incomplete_cnt</th>
<th>incomplete_rate</th>
</tr>
</thead>
<tbody>
<tr>
<td>1004</td>
<td>0</td>
<td>0.000</td>
</tr>
<tr>
<td>1003</td>
<td>1</td>
<td>0.500</td>
</tr>
<tr>
<td>1001</td>
<td>4</td>
<td>0.667</td>
</tr>
</tbody>
</table>
<p><strong>解释</strong>：0 级用户有 1001、1003、1004；他们作答试卷数和未完成数分别为：6:4、2:1、0:0；</p>
<p>存在 1001 这个 0 级用户未完成试卷数大于 2，因此输出这三个用户的未完成数和未完成率（1004 未作答过试卷，未完成率默认填 0，保留 3 位小数后是 0.000）；</p>
<p>结果按照未完成率升序排序。</p>
<p>附：如果 1001 不满足『未完成试卷数大于 2』，则需要输出 1001、1002、1003 的这两个指标，因为试卷作答记录表里只有这三个用户的作答记录。</p>
<p><strong>思路</strong>：</p>
<p>先把可能满足条件**“0 级用户未完成试卷数大于 2”**的 SQL 写出来</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> ui.uid UID
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> user_info ui
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record er <span style="color:#fff;font-weight:bold">ON</span> ui.uid = er.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> ui.uid <span style="color:#fff;font-weight:bold">IN</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#fff;font-weight:bold">SELECT</span> ui.uid
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">FROM</span> user_info ui
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record er <span style="color:#fff;font-weight:bold">ON</span> ui.uid = er.uid
</span></span><span style="display:flex;"><span>     <span style="color:#fff;font-weight:bold">WHERE</span> er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">AND</span> ui.<span style="color:#fff;font-weight:bold">LEVEL</span> = <span style="color:#ff0;font-weight:bold">0</span> )
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> ui.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">sum</span>(<span style="color:#fff;font-weight:bold">IF</span>(er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>)) &gt; <span style="color:#ff0;font-weight:bold">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后再分别写出两种情况的 SQL 查询语句：</p>
<p>情况 1. 查询存在条件要求的 0 级用户的试卷未完成率</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	tmp1.uid uid,
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">sum</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">IF</span>
</span></span><span style="display:flex;"><span>	( er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">AND</span> er.start_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span> )) incomplete_cnt,
</span></span><span style="display:flex;"><span>	round(
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">sum</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">IF</span>
</span></span><span style="display:flex;"><span>		( er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">AND</span> er.start_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span> ))/ <span style="color:#fff;font-weight:bold">count</span>( tmp1.uid ),
</span></span><span style="display:flex;"><span>		<span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>	) incomplete_rate
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	(
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DISTINCT</span>
</span></span><span style="display:flex;"><span>		ui.uid
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>		user_info ui
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record er <span style="color:#fff;font-weight:bold">ON</span> ui.uid = er.uid
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>		er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">AND</span> ui.<span style="color:#fff;font-weight:bold">LEVEL</span> = <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	) tmp1
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record er <span style="color:#fff;font-weight:bold">ON</span> tmp1.uid = er.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	tmp1.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	incomplete_rate
</span></span></code></pre></td></tr></table>
</div>
</div><p>情况 2. 查询不存在条件要求时所有有作答记录的 yong 用户的试卷未完成率</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	ui.uid uid,
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">sum</span>( <span style="color:#fff;font-weight:bold">CASE</span> <span style="color:#fff;font-weight:bold">WHEN</span> er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">AND</span> er.start_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">THEN</span> <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#fff;font-weight:bold">ELSE</span> <span style="color:#ff0;font-weight:bold">0</span> <span style="color:#fff;font-weight:bold">END</span> ) incomplete_cnt,
</span></span><span style="display:flex;"><span>	round(
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">sum</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">IF</span>
</span></span><span style="display:flex;"><span>		( er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">AND</span> er.start_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span> ))/ <span style="color:#fff;font-weight:bold">count</span>( ui.uid ),
</span></span><span style="display:flex;"><span>		<span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>	) incomplete_rate
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	user_info ui
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">JOIN</span> exam_record er <span style="color:#fff;font-weight:bold">ON</span> ui.uid = er.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	ui.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	incomplete_rate
</span></span></code></pre></td></tr></table>
</div>
</div><p>拼在一起，就是答案</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WITH</span> host_user <span style="color:#fff;font-weight:bold">AS</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> ui.uid UID
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> user_info ui
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record er <span style="color:#fff;font-weight:bold">ON</span> ui.uid = er.uid
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> ui.uid <span style="color:#fff;font-weight:bold">IN</span>
</span></span><span style="display:flex;"><span>       (<span style="color:#fff;font-weight:bold">SELECT</span> ui.uid
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">FROM</span> user_info ui
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record er <span style="color:#fff;font-weight:bold">ON</span> ui.uid = er.uid
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHERE</span> er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">AND</span> ui.<span style="color:#fff;font-weight:bold">LEVEL</span> = <span style="color:#ff0;font-weight:bold">0</span> )
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> ui.uid
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">sum</span>(<span style="color:#fff;font-weight:bold">IF</span> (er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>))&gt; <span style="color:#ff0;font-weight:bold">2</span>),
</span></span><span style="display:flex;"><span>     tt1 <span style="color:#fff;font-weight:bold">AS</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> tmp1.uid UID,
</span></span><span style="display:flex;"><span>                   <span style="color:#fff;font-weight:bold">sum</span>(<span style="color:#fff;font-weight:bold">IF</span> (er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>                           <span style="color:#fff;font-weight:bold">AND</span> er.start_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>)) incomplete_cnt,
</span></span><span style="display:flex;"><span>                   round(<span style="color:#fff;font-weight:bold">sum</span>(<span style="color:#fff;font-weight:bold">IF</span> (er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>                                 <span style="color:#fff;font-weight:bold">AND</span> er.start_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>))/ <span style="color:#fff;font-weight:bold">count</span>(tmp1.uid), <span style="color:#ff0;font-weight:bold">3</span>) incomplete_rate
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>     (<span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DISTINCT</span> ui.uid
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">FROM</span> user_info ui
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record er <span style="color:#fff;font-weight:bold">ON</span> ui.uid = er.uid
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">WHERE</span> er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">AND</span> ui.<span style="color:#fff;font-weight:bold">LEVEL</span> = <span style="color:#ff0;font-weight:bold">0</span> ) tmp1
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record er <span style="color:#fff;font-weight:bold">ON</span> tmp1.uid = er.uid
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> tmp1.uid
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> incomplete_rate),
</span></span><span style="display:flex;"><span>     tt2 <span style="color:#fff;font-weight:bold">AS</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> ui.uid UID,
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">sum</span>(<span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#fff;font-weight:bold">WHEN</span> er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#fff;font-weight:bold">AND</span> er.start_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">THEN</span> <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#fff;font-weight:bold">ELSE</span> <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#fff;font-weight:bold">END</span>) incomplete_cnt,
</span></span><span style="display:flex;"><span>                 round(<span style="color:#fff;font-weight:bold">sum</span>(<span style="color:#fff;font-weight:bold">IF</span> (er.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#fff;font-weight:bold">AND</span> er.start_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span>))/ <span style="color:#fff;font-weight:bold">count</span>(ui.uid), <span style="color:#ff0;font-weight:bold">3</span>) incomplete_rate
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> user_info ui
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">JOIN</span> exam_record er <span style="color:#fff;font-weight:bold">ON</span> ui.uid = er.uid
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> ui.uid
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> incomplete_rate)
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> tt1.*
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> tt1
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span>
</span></span><span style="display:flex;"><span>     (<span style="color:#fff;font-weight:bold">SELECT</span> UID
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">FROM</span> host_user) t1 <span style="color:#fff;font-weight:bold">ON</span> <span style="color:#ff0;font-weight:bold">1</span> = <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> t1.uid <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span> )
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">UNION</span> <span style="color:#fff;font-weight:bold">ALL</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> tt2.*
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> tt2
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span>
</span></span><span style="display:flex;"><span>     (<span style="color:#fff;font-weight:bold">SELECT</span> UID
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">FROM</span> host_user) t2 <span style="color:#fff;font-weight:bold">ON</span> <span style="color:#ff0;font-weight:bold">1</span> = <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> t2.uid <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>V2 版本（根据上面做出的改进，答案缩短了，逻辑更强）：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	ui.uid,
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">SUM</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">IF</span>
</span></span><span style="display:flex;"><span>	( start_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">AND</span> score <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span> )) <span style="color:#fff;font-weight:bold">AS</span> incomplete_cnt,#<span style="color:#ff0;font-weight:bold">3</span>.<span style="color:#f00">试卷未完成数</span>
</span></span><span style="display:flex;"><span>	ROUND( <span style="color:#fff;font-weight:bold">AVG</span>( <span style="color:#fff;font-weight:bold">IF</span> ( start_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">AND</span> score <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span> )), <span style="color:#ff0;font-weight:bold">3</span> ) <span style="color:#fff;font-weight:bold">AS</span> incomplete_rate #<span style="color:#ff0;font-weight:bold">4</span>.<span style="color:#f00">未完成率</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	user_info ui
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> exam_record <span style="color:#fff;font-weight:bold">USING</span> ( uid )
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">WHEN</span> (#<span style="color:#ff0;font-weight:bold">1</span>.<span style="color:#f00">当有任意一个</span><span style="color:#ff0;font-weight:bold">0</span><span style="color:#f00">级用户未完成试卷数大于</span><span style="color:#ff0;font-weight:bold">2</span><span style="color:#f00">时</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">MAX</span>( lv0_incom_cnt )
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>			(
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fff;font-weight:bold">SUM</span>(
</span></span><span style="display:flex;"><span>				<span style="color:#fff;font-weight:bold">IF</span>
</span></span><span style="display:flex;"><span>				( score <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NULL</span>, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">0</span> )) <span style="color:#fff;font-weight:bold">AS</span> lv0_incom_cnt
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>				user_info
</span></span><span style="display:flex;"><span>				<span style="color:#fff;font-weight:bold">JOIN</span> exam_record <span style="color:#fff;font-weight:bold">USING</span> ( uid )
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fff;font-weight:bold">LEVEL</span> = <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>				uid
</span></span><span style="display:flex;"><span>			) table1
</span></span><span style="display:flex;"><span>			)&gt; <span style="color:#ff0;font-weight:bold">2</span> <span style="color:#fff;font-weight:bold">THEN</span>
</span></span><span style="display:flex;"><span>			uid <span style="color:#fff;font-weight:bold">IN</span> ( #<span style="color:#ff0;font-weight:bold">1</span>.<span style="color:#ff0;font-weight:bold">1</span><span style="color:#f00">找出每个</span><span style="color:#ff0;font-weight:bold">0</span><span style="color:#f00">级用户</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">SELECT</span> uid <span style="color:#fff;font-weight:bold">FROM</span> user_info <span style="color:#fff;font-weight:bold">WHERE</span> <span style="color:#fff;font-weight:bold">LEVEL</span> = <span style="color:#ff0;font-weight:bold">0</span> ) <span style="color:#fff;font-weight:bold">ELSE</span> uid <span style="color:#fff;font-weight:bold">IN</span> ( #<span style="color:#ff0;font-weight:bold">2</span>.<span style="color:#f00">若不存在这样的用户，找出有作答记录的用户</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">DISTINCT</span> uid <span style="color:#fff;font-weight:bold">FROM</span> exam_record )
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">END</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>			ui.uid
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	incomplete_rate #<span style="color:#ff0;font-weight:bold">5</span>.<span style="color:#f00">结果按未完成率升序排序</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="各用户等级的不同得分表现占比较难">各用户等级的不同得分表现占比（较难）<a hidden class="anchor" aria-hidden="true" href="#各用户等级的不同得分表现占比较难">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1 号</td>
<td>19</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>1200</td>
<td>3</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>牛客 3 号 ♂</td>
<td>22</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1004</td>
<td>牛客 4 号</td>
<td>25</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>牛客 555 号</td>
<td>2000</td>
<td>7</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>6</td>
<td>1006</td>
<td>666666</td>
<td>3000</td>
<td>6</td>
<td>C++</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 exam_record（uid 用户 ID, exam_id 试卷 ID, start_time 开始作答时间, submit_time 交卷时间, score 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 09:01:01</td>
<td>2020-01-02 09:21:59</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1001</td>
<td>9001</td>
<td>2021-05-02 10:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>3</td>
<td>1001</td>
<td>9002</td>
<td>2021-02-02 19:01:01</td>
<td>2021-02-02 19:30:01</td>
<td>75</td>
</tr>
<tr>
<td>4</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-01 12:01:01</td>
<td>2021-09-01 12:11:01</td>
<td>60</td>
</tr>
<tr>
<td>5</td>
<td>1001</td>
<td>9003</td>
<td>2021-09-02 12:01:01</td>
<td>2021-09-02 12:41:01</td>
<td>90</td>
</tr>
<tr>
<td>6</td>
<td>1001</td>
<td>9001</td>
<td>2021-06-02 19:01:01</td>
<td>2021-06-02 19:32:00</td>
<td>20</td>
</tr>
<tr>
<td>7</td>
<td>1001</td>
<td>9002</td>
<td>2021-09-05 19:01:01</td>
<td>2021-09-05 19:40:01</td>
<td>89</td>
</tr>
<tr>
<td>8</td>
<td>1001</td>
<td>9004</td>
<td>2021-09-03 12:01:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>9</td>
<td>1002</td>
<td>9001</td>
<td>2020-01-01 12:01:01</td>
<td>2020-01-01 12:31:01</td>
<td>99</td>
</tr>
<tr>
<td>10</td>
<td>1002</td>
<td>9003</td>
<td>2020-02-01 12:01:01</td>
<td>2020-02-01 12:31:01</td>
<td>82</td>
</tr>
<tr>
<td>11</td>
<td>1002</td>
<td>9003</td>
<td>2020-02-02 12:11:01</td>
<td>2020-02-02 12:41:01</td>
<td>76</td>
</tr>
</tbody>
</table>
<p>为了得到用户试卷作答的定性表现，我们将试卷得分按分界点[90,75,60]分为优良中差四个得分等级（分界点划分到左区间），请统计不同用户等级的人在完成过的试卷中各得分等级占比（结果保留 3 位小数），未完成过试卷的用户无需输出，结果按用户等级降序、占比降序排序。</p>
<p>由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>level</th>
<th>score_grade</th>
<th>ratio</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>良</td>
<td>0.667</td>
</tr>
<tr>
<td>3</td>
<td>优</td>
<td>0.333</td>
</tr>
<tr>
<td>0</td>
<td>良</td>
<td>0.500</td>
</tr>
<tr>
<td>0</td>
<td>中</td>
<td>0.167</td>
</tr>
<tr>
<td>0</td>
<td>优</td>
<td>0.167</td>
</tr>
<tr>
<td>0</td>
<td>差</td>
<td>0.167</td>
</tr>
</tbody>
</table>
<p>解释：完成过试卷的用户有 1001、1002；完成了的试卷对应的用户等级和分数等级如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>exam_id</th>
<th>score</th>
<th>level</th>
<th>score_grade</th>
</tr>
</thead>
<tbody>
<tr>
<td>1001</td>
<td>9001</td>
<td>80</td>
<td>0</td>
<td>良</td>
</tr>
<tr>
<td>1001</td>
<td>9002</td>
<td>75</td>
<td>0</td>
<td>良</td>
</tr>
<tr>
<td>1001</td>
<td>9002</td>
<td>60</td>
<td>0</td>
<td>中</td>
</tr>
<tr>
<td>1001</td>
<td>9003</td>
<td>90</td>
<td>0</td>
<td>优</td>
</tr>
<tr>
<td>1001</td>
<td>9001</td>
<td>20</td>
<td>0</td>
<td>差</td>
</tr>
<tr>
<td>1001</td>
<td>9002</td>
<td>89</td>
<td>0</td>
<td>良</td>
</tr>
<tr>
<td>1002</td>
<td>9001</td>
<td>99</td>
<td>3</td>
<td>优</td>
</tr>
<tr>
<td>1002</td>
<td>9003</td>
<td>82</td>
<td>3</td>
<td>良</td>
</tr>
<tr>
<td>1002</td>
<td>9003</td>
<td>76</td>
<td>3</td>
<td>良</td>
</tr>
</tbody>
</table>
<p>因此 0 级用户（只有 1001）的各分数等级比例为：优 1/6，良 1/6，中 1/6，差 3/6；3 级用户（只有 1002）各分数等级比例为：优 1/3，良 2/3。结果保留 3 位小数。</p>
<p><strong>思路</strong>：</p>
<p>先把 **“将试卷得分按分界点[90,75,60]分为优良中差四个得分等级”**这个条件写出来，这里可以用到<code>case when</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">WHEN</span> a.score &gt;= <span style="color:#ff0;font-weight:bold">90</span> <span style="color:#fff;font-weight:bold">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#0ff;font-weight:bold">&#39;优&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">WHEN</span> a.score &lt; <span style="color:#ff0;font-weight:bold">90</span> <span style="color:#fff;font-weight:bold">AND</span> a.score &gt;= <span style="color:#ff0;font-weight:bold">75</span> <span style="color:#fff;font-weight:bold">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#0ff;font-weight:bold">&#39;良&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">WHEN</span> a.score &lt; <span style="color:#ff0;font-weight:bold">75</span> <span style="color:#fff;font-weight:bold">AND</span> a.score &gt;= <span style="color:#ff0;font-weight:bold">60</span> <span style="color:#fff;font-weight:bold">THEN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#39;中&#39;</span> <span style="color:#fff;font-weight:bold">ELSE</span> <span style="color:#0ff;font-weight:bold">&#39;差&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">END</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这题的关键点就在于这，其他剩下的就是条件拼接了</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> a.<span style="color:#fff;font-weight:bold">LEVEL</span>,
</span></span><span style="display:flex;"><span>       a.score_grade,
</span></span><span style="display:flex;"><span>       ROUND(a.cur_count / b.total_num, <span style="color:#ff0;font-weight:bold">3</span>) <span style="color:#fff;font-weight:bold">AS</span> ratio
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> b.<span style="color:#fff;font-weight:bold">LEVEL</span> <span style="color:#fff;font-weight:bold">AS</span> <span style="color:#fff;font-weight:bold">LEVEL</span>,
</span></span><span style="display:flex;"><span>          (<span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">WHEN</span> a.score &gt;= <span style="color:#ff0;font-weight:bold">90</span> <span style="color:#fff;font-weight:bold">THEN</span> <span style="color:#0ff;font-weight:bold">&#39;优&#39;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">WHEN</span> a.score &lt; <span style="color:#ff0;font-weight:bold">90</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">AND</span> a.score &gt;= <span style="color:#ff0;font-weight:bold">75</span> <span style="color:#fff;font-weight:bold">THEN</span> <span style="color:#0ff;font-weight:bold">&#39;良&#39;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">WHEN</span> a.score &lt; <span style="color:#ff0;font-weight:bold">75</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">AND</span> a.score &gt;= <span style="color:#ff0;font-weight:bold">60</span> <span style="color:#fff;font-weight:bold">THEN</span> <span style="color:#0ff;font-weight:bold">&#39;中&#39;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">ELSE</span> <span style="color:#0ff;font-weight:bold">&#39;差&#39;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#fff;font-weight:bold">END</span>) <span style="color:#fff;font-weight:bold">AS</span> score_grade,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#ff0;font-weight:bold">1</span>) <span style="color:#fff;font-weight:bold">AS</span> cur_count
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record a
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> user_info b <span style="color:#fff;font-weight:bold">ON</span> a.uid = b.uid
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> a.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> b.<span style="color:#fff;font-weight:bold">LEVEL</span>,
</span></span><span style="display:flex;"><span>            score_grade) a
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> b.<span style="color:#fff;font-weight:bold">LEVEL</span> <span style="color:#fff;font-weight:bold">AS</span> <span style="color:#fff;font-weight:bold">LEVEL</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#fff;font-weight:bold">count</span>(b.<span style="color:#fff;font-weight:bold">LEVEL</span>) <span style="color:#fff;font-weight:bold">AS</span> total_num
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record a
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> user_info b <span style="color:#fff;font-weight:bold">ON</span> a.uid = b.uid
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> a.submit_time <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span>
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> b.<span style="color:#fff;font-weight:bold">LEVEL</span>) b <span style="color:#fff;font-weight:bold">ON</span> a.<span style="color:#fff;font-weight:bold">LEVEL</span> = b.<span style="color:#fff;font-weight:bold">LEVEL</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> a.<span style="color:#fff;font-weight:bold">LEVEL</span> <span style="color:#fff;font-weight:bold">DESC</span>,
</span></span><span style="display:flex;"><span>         ratio <span style="color:#fff;font-weight:bold">DESC</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="限量查询">限量查询<a hidden class="anchor" aria-hidden="true" href="#限量查询">#</a></h2>
<h3 id="注册时间最早的三个人">注册时间最早的三个人<a hidden class="anchor" aria-hidden="true" href="#注册时间最早的三个人">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1 号</td>
<td>19</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>1200</td>
<td>3</td>
<td>算法</td>
<td>2020-02-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>牛客 3 号 ♂</td>
<td>22</td>
<td>0</td>
<td>算法</td>
<td>2020-01-02 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1004</td>
<td>牛客 4 号</td>
<td>25</td>
<td>0</td>
<td>算法</td>
<td>2020-01-02 11:00:00</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>牛客 555 号</td>
<td>4000</td>
<td>7</td>
<td>C++</td>
<td>2020-01-11 10:00:00</td>
</tr>
<tr>
<td>6</td>
<td>1006</td>
<td>666666</td>
<td>3000</td>
<td>6</td>
<td>C++</td>
<td>2020-11-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>请从中找到注册时间最早的 3 个人。由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>nick_name</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1001</td>
<td>牛客 1</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>1003</td>
<td>牛客 3 号 ♂</td>
<td>2020-01-02 10:00:00</td>
</tr>
<tr>
<td>1004</td>
<td>牛客 4 号</td>
<td>2020-01-02 11:00:00</td>
</tr>
</tbody>
</table>
<p>解释：按注册时间排序后选取前三名，输出其用户 ID、昵称、注册时间。</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> uid, nick_name, register_time
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">FROM</span> user_info
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> register_time
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">LIMIT</span> <span style="color:#ff0;font-weight:bold">3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="注册当天就完成了试卷的名单第三页较难">注册当天就完成了试卷的名单第三页（较难）<a hidden class="anchor" aria-hidden="true" href="#注册当天就完成了试卷的名单第三页较难">#</a></h3>
<p><strong>描述</strong>：现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1</td>
<td>19</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>1200</td>
<td>3</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>牛客 3 号 ♂</td>
<td>22</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1004</td>
<td>牛客 4 号</td>
<td>25</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>牛客 555 号</td>
<td>4000</td>
<td>7</td>
<td>算法</td>
<td>2020-01-11 10:00:00</td>
</tr>
<tr>
<td>6</td>
<td>1006</td>
<td>牛客 6 号</td>
<td>25</td>
<td>0</td>
<td>算法</td>
<td>2020-01-02 11:00:00</td>
</tr>
<tr>
<td>7</td>
<td>1007</td>
<td>牛客 7 号</td>
<td>25</td>
<td>0</td>
<td>算法</td>
<td>2020-01-02 11:00:00</td>
</tr>
<tr>
<td>8</td>
<td>1008</td>
<td>牛客 8 号</td>
<td>25</td>
<td>0</td>
<td>算法</td>
<td>2020-01-02 11:00:00</td>
</tr>
<tr>
<td>9</td>
<td>1009</td>
<td>牛客 9 号</td>
<td>25</td>
<td>0</td>
<td>算法</td>
<td>2020-01-02 11:00:00</td>
</tr>
<tr>
<td>10</td>
<td>1010</td>
<td>牛客 10 号</td>
<td>25</td>
<td>0</td>
<td>算法</td>
<td>2020-01-02 11:00:00</td>
</tr>
<tr>
<td>11</td>
<td>1011</td>
<td>666666</td>
<td>3000</td>
<td>6</td>
<td>C++</td>
<td>2020-01-02 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷信息表 examination_info（exam_id 试卷 ID, tag 试卷类别, difficulty 试卷难度, duration 考试时长, release_time 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>算法</td>
<td>hard</td>
<td>60</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>算法</td>
<td>hard</td>
<td>80</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>SQL</td>
<td>medium</td>
<td>70</td>
<td>2020-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答记录表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-02 09:01:01</td>
<td>2020-01-02 09:21:59</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9003</td>
<td>2020-01-20 10:01:01</td>
<td>2020-01-20 10:10:01</td>
<td>81</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9002</td>
<td>2020-01-01 12:11:01</td>
<td>2020-01-01 12:31:01</td>
<td>83</td>
</tr>
<tr>
<td>4</td>
<td>1003</td>
<td>9002</td>
<td>2020-01-01 19:01:01</td>
<td>2020-01-01 19:30:01</td>
<td>75</td>
</tr>
<tr>
<td>5</td>
<td>1004</td>
<td>9002</td>
<td>2020-01-01 12:01:01</td>
<td>2020-01-01 12:11:01</td>
<td>60</td>
</tr>
<tr>
<td>6</td>
<td>1005</td>
<td>9002</td>
<td>2020-01-01 12:01:01</td>
<td>2020-01-01 12:41:01</td>
<td>90</td>
</tr>
<tr>
<td>7</td>
<td>1006</td>
<td>9001</td>
<td>2020-01-02 19:01:01</td>
<td>2020-01-02 19:32:00</td>
<td>20</td>
</tr>
<tr>
<td>8</td>
<td>1007</td>
<td>9002</td>
<td>2020-01-02 19:01:01</td>
<td>2020-01-02 19:40:01</td>
<td>89</td>
</tr>
<tr>
<td>9</td>
<td>1008</td>
<td>9003</td>
<td>2020-01-02 12:01:01</td>
<td>2020-01-02 12:20:01</td>
<td>99</td>
</tr>
<tr>
<td>10</td>
<td>1008</td>
<td>9001</td>
<td>2020-01-02 12:01:01</td>
<td>2020-01-02 12:31:01</td>
<td>98</td>
</tr>
<tr>
<td>11</td>
<td>1009</td>
<td>9002</td>
<td>2020-01-02 12:01:01</td>
<td>2020-01-02 12:31:01</td>
<td>82</td>
</tr>
<tr>
<td>12</td>
<td>1010</td>
<td>9002</td>
<td>2020-01-02 12:11:01</td>
<td>2020-01-02 12:41:01</td>
<td>76</td>
</tr>
<tr>
<td>13</td>
<td>1011</td>
<td>9001</td>
<td>2020-01-02 10:01:01</td>
<td>2020-01-02 10:31:01</td>
<td>89</td>
</tr>
</tbody>
</table>
<p>找到求职方向为算法工程师，且注册当天就完成了算法类试卷的人，按参加过的所有考试最高得分排名。排名榜很长，我们将采用分页展示，每页 3 条，现在需要你取出第 3 页（页码从 1 开始）的人的信息。</p>
<p>由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>level</th>
<th>register_time</th>
<th>max_score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1010</td>
<td>0</td>
<td>2020-01-02 11:00:00</td>
<td>76</td>
</tr>
<tr>
<td>1003</td>
<td>0</td>
<td>2020-01-01 10:00:00</td>
<td>75</td>
</tr>
<tr>
<td>1004</td>
<td>0</td>
<td>2020-01-01 11:00:00</td>
<td>60</td>
</tr>
</tbody>
</table>
<p>解释：除了 1011 其他用户的求职方向都为算法工程师；算法类试卷有 9001 和 9002，11 个用户注册当天都完成了算法类试卷；计算他们的所有考试最大分时，只有 1002 和 1008 完成了两次考试，其他人只完成了一场考试，1002 两场考试最高分为 81，1008 最高分为 99。</p>
<p>按最高分排名如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>level</th>
<th>register_time</th>
<th>max_score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1008</td>
<td>0</td>
<td>2020-01-02 11:00:00</td>
<td>99</td>
</tr>
<tr>
<td>1005</td>
<td>7</td>
<td>2020-01-01 10:00:00</td>
<td>90</td>
</tr>
<tr>
<td>1007</td>
<td>0</td>
<td>2020-01-02 11:00:00</td>
<td>89</td>
</tr>
<tr>
<td>1002</td>
<td>3</td>
<td>2020-01-01 10:00:00</td>
<td>83</td>
</tr>
<tr>
<td>1009</td>
<td>0</td>
<td>2020-01-02 11:00:00</td>
<td>82</td>
</tr>
<tr>
<td>1001</td>
<td>0</td>
<td>2020-01-01 10:00:00</td>
<td>80</td>
</tr>
<tr>
<td>1010</td>
<td>0</td>
<td>2020-01-02 11:00:00</td>
<td>76</td>
</tr>
<tr>
<td>1003</td>
<td>0</td>
<td>2020-01-01 10:00:00</td>
<td>75</td>
</tr>
<tr>
<td>1004</td>
<td>0</td>
<td>2020-01-01 11:00:00</td>
<td>60</td>
</tr>
<tr>
<td>1006</td>
<td>0</td>
<td>2020-01-02 11:00:00</td>
<td>20</td>
</tr>
</tbody>
</table>
<p>每页 3 条，第三页也就是第 7~9 条，返回 1010、1003、1004 的行记录即可。</p>
<p><strong>思路</strong>：</p>
<ol>
<li>每页三条，即需要取出第三页的人的信息，要用到<code>limit</code></li>
<li>统计求职方向为算法工程师且注册当天就完成了算法类试卷的人的<strong>信息和每次记录的得分</strong>，先求满足条件的用户，后用 left join 做连接查找信息和每次记录的得分</li>
</ol>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> t1.uid,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">LEVEL</span>,
</span></span><span style="display:flex;"><span>       register_time,
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">max</span>(score) <span style="color:#fff;font-weight:bold">AS</span> max_score
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> exam_record t
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">JOIN</span> examination_info <span style="color:#fff;font-weight:bold">USING</span> (exam_id)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">JOIN</span> user_info t1 <span style="color:#fff;font-weight:bold">ON</span> t.uid = t1.uid
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">AND</span> <span style="color:#fff;font-weight:bold">date</span>(t.submit_time) = <span style="color:#fff;font-weight:bold">date</span>(t1.register_time)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> job = <span style="color:#0ff;font-weight:bold">&#39;算法&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">AND</span> tag = <span style="color:#0ff;font-weight:bold">&#39;算法&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> t1.uid,
</span></span><span style="display:flex;"><span>         <span style="color:#fff;font-weight:bold">LEVEL</span>,
</span></span><span style="display:flex;"><span>         register_time
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> max_score <span style="color:#fff;font-weight:bold">DESC</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">LIMIT</span> <span style="color:#ff0;font-weight:bold">6</span>,<span style="color:#ff0;font-weight:bold">3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="文本转换函数">文本转换函数<a hidden class="anchor" aria-hidden="true" href="#文本转换函数">#</a></h2>
<h3 id="修复串列了的记录">修复串列了的记录<a hidden class="anchor" aria-hidden="true" href="#修复串列了的记录">#</a></h3>
<p><strong>描述</strong>：现有试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>算法</td>
<td>hard</td>
<td>60</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>算法</td>
<td>hard</td>
<td>80</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>SQL</td>
<td>medium</td>
<td>70</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>9004</td>
<td>算法,medium,80</td>
<td></td>
<td>0</td>
<td>2021-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>录题同学有一次手误将部分记录的试题类别 tag、难度、时长同时录入到了 tag 字段，请帮忙找出这些录错了的记录，并拆分后按正确的列类型输出。</p>
<p>由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>9004</td>
<td>算法</td>
<td>medium</td>
<td>80</td>
</tr>
</tbody>
</table>
<p><strong>思路</strong>：</p>
<p>先来学习下本题要用到的函数</p>
<p><code>SUBSTRING_INDEX</code> 函数用于提取字符串中指定分隔符的部分。它接受三个参数：原始字符串、分隔符和指定要返回的部分的数量。</p>
<p>以下是 <code>SUBSTRING_INDEX</code> 函数的语法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>SUBSTRING_INDEX(str, <span style="color:#fff;font-weight:bold">delimiter</span>, <span style="color:#fff;font-weight:bold">count</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>str</code>：要进行分割的原始字符串。</p>
</li>
<li>
<p><code>delimiter</code>：用作分割的字符串或字符。</p>
</li>
<li>
<p><code>count</code>：指定要返回的部分的数量。</p>
<ul>
<li>如果 <code>count</code> 大于 0，则返回从左边开始的前 <code>count</code> 个部分（以分隔符为界）。</li>
<li>如果 <code>count</code> 小于 0，则返回从右边开始的前 <code>count</code> 个部分（以分隔符为界），即从右侧向左计数。</li>
</ul>
</li>
</ul>
<p>下面是一些示例，演示了 <code>SUBSTRING_INDEX</code> 函数的使用：</p>
<p>提取字符串中的第一个部分：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> SUBSTRING_INDEX(<span style="color:#0ff;font-weight:bold">&#39;apple,banana,cherry&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;,&#39;</span>, <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 输出结果：&#39;apple&#39;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>提取字符串中的最后一个部分：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> SUBSTRING_INDEX(<span style="color:#0ff;font-weight:bold">&#39;apple,banana,cherry&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;,&#39;</span>, -<span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 输出结果：&#39;cherry&#39;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>提取字符串中的前两个部分：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> SUBSTRING_INDEX(<span style="color:#0ff;font-weight:bold">&#39;apple,banana,cherry&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;,&#39;</span>, <span style="color:#ff0;font-weight:bold">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 输出结果：&#39;apple,banana&#39;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>提取字符串中的最后两个部分：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> SUBSTRING_INDEX(<span style="color:#0ff;font-weight:bold">&#39;apple,banana,cherry&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;,&#39;</span>, -<span style="color:#ff0;font-weight:bold">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">-- 输出结果：&#39;banana,cherry&#39;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	exam_id,
</span></span><span style="display:flex;"><span>	substring_index( tag, <span style="color:#0ff;font-weight:bold">&#39;,&#39;</span>, <span style="color:#ff0;font-weight:bold">1</span> ) tag,
</span></span><span style="display:flex;"><span>	substring_index( substring_index( tag, <span style="color:#0ff;font-weight:bold">&#39;,&#39;</span>, <span style="color:#ff0;font-weight:bold">2</span> ), <span style="color:#0ff;font-weight:bold">&#39;,&#39;</span>,- <span style="color:#ff0;font-weight:bold">1</span> ) difficulty,
</span></span><span style="display:flex;"><span>	substring_index( tag, <span style="color:#0ff;font-weight:bold">&#39;,&#39;</span>,- <span style="color:#ff0;font-weight:bold">1</span> ) duration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	examination_info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>	difficulty = <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="对过长的昵称截取处理">对过长的昵称截取处理<a hidden class="anchor" aria-hidden="true" href="#对过长的昵称截取处理">#</a></h3>
<p><strong>描述</strong>：现有用户信息表 <code>user_info</code>（<code>uid</code> 用户 ID，<code>nick_name</code> 昵称, <code>achievement</code> 成就值, <code>level</code> 等级, <code>job</code> 职业方向, <code>register_time</code> 注册时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>nick_name</th>
<th>achievement</th>
<th>level</th>
<th>job</th>
<th>register_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>牛客 1</td>
<td>19</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>牛客 2 号</td>
<td>1200</td>
<td>3</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>1003</td>
<td>牛客 3 号 ♂</td>
<td>22</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>1004</td>
<td>牛客 4 号</td>
<td>25</td>
<td>0</td>
<td>算法</td>
<td>2020-01-01 11:00:00</td>
</tr>
<tr>
<td>5</td>
<td>1005</td>
<td>牛客 5678901234 号</td>
<td>4000</td>
<td>7</td>
<td>算法</td>
<td>2020-01-11 10:00:00</td>
</tr>
<tr>
<td>6</td>
<td>1006</td>
<td>牛客 67890123456789 号</td>
<td>25</td>
<td>0</td>
<td>算法</td>
<td>2020-01-02 11:00:00</td>
</tr>
</tbody>
</table>
<p>有的用户的昵称特别长，在一些展示场景会导致样式混乱，因此需要将特别长的昵称转换一下再输出，请输出字符数大于 10 的用户信息，对于字符数大于 13 的用户输出前 10 个字符然后加上三个点号：『&hellip;』。</p>
<p>由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>uid</th>
<th>nick_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>1005</td>
<td>牛客 5678901234 号</td>
</tr>
<tr>
<td>1006</td>
<td>牛客 67890123&hellip;</td>
</tr>
</tbody>
</table>
<p>解释：字符数大于 10 的用户有 1005 和 1006，长度分别为 13、17；因此需要对 1006 的昵称截断输出。</p>
<p><strong>思路</strong>：</p>
<p>这题涉及到字符的计算，要计算字符串的字符数（即字符串的长度），可以使用 <code>LENGTH</code> 函数或 <code>CHAR_LENGTH</code> 函数。这两个函数的区别在于对待多字节字符的方式。</p>
<ol>
<li><code>LENGTH</code> 函数：它返回给定字符串的字节数。对于包含多字节字符的字符串，每个字符都会被当作一个字节来计算。</li>
</ol>
<p>示例：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">LENGTH</span>(<span style="color:#0ff;font-weight:bold">&#39;你好&#39;</span>); <span style="color:#007f7f">-- 输出结果：6，因为 &#39;你好&#39; 中的每个汉字每个占3个字节
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>CHAR_LENGTH</code> 函数：它返回给定字符串的字符数。对于包含多字节字符的字符串，每个字符会被当作一个字符来计算。</li>
</ol>
<p>示例：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">CHAR_LENGTH</span>(<span style="color:#0ff;font-weight:bold">&#39;你好&#39;</span>); <span style="color:#007f7f">-- 输出结果：2，因为 &#39;你好&#39; 中有两个字符，即两个汉字
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	uid,
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">WHEN</span> <span style="color:#fff;font-weight:bold">CHAR_LENGTH</span>( nick_name ) &gt; <span style="color:#ff0;font-weight:bold">13</span> <span style="color:#fff;font-weight:bold">THEN</span>
</span></span><span style="display:flex;"><span>		CONCAT( SUBSTR( nick_name, <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">10</span> ), <span style="color:#0ff;font-weight:bold">&#39;...&#39;</span> ) <span style="color:#fff;font-weight:bold">ELSE</span> nick_name
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">END</span> <span style="color:#fff;font-weight:bold">AS</span> nick_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	user_info
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">CHAR_LENGTH</span>( nick_name ) &gt; <span style="color:#ff0;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	uid;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="大小写混乱时的筛选统计较难">大小写混乱时的筛选统计（较难）<a hidden class="anchor" aria-hidden="true" href="#大小写混乱时的筛选统计较难">#</a></h3>
<p><strong>描述</strong>：</p>
<p>现有试卷信息表 <code>examination_info</code>（<code>exam_id</code> 试卷 ID, <code>tag</code> 试卷类别, <code>difficulty</code> 试卷难度, <code>duration</code> 考试时长, <code>release_time</code> 发布时间）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>exam_id</th>
<th>tag</th>
<th>difficulty</th>
<th>duration</th>
<th>release_time</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>9001</td>
<td>算法</td>
<td>hard</td>
<td>60</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>2</td>
<td>9002</td>
<td>C++</td>
<td>hard</td>
<td>80</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>3</td>
<td>9003</td>
<td>C++</td>
<td>hard</td>
<td>80</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>4</td>
<td>9004</td>
<td>sql</td>
<td>medium</td>
<td>70</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>5</td>
<td>9005</td>
<td>C++</td>
<td>hard</td>
<td>80</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>6</td>
<td>9006</td>
<td>C++</td>
<td>hard</td>
<td>80</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>7</td>
<td>9007</td>
<td>C++</td>
<td>hard</td>
<td>80</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>8</td>
<td>9008</td>
<td>SQL</td>
<td>medium</td>
<td>70</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>9</td>
<td>9009</td>
<td>SQL</td>
<td>medium</td>
<td>70</td>
<td>2021-01-01 10:00:00</td>
</tr>
<tr>
<td>10</td>
<td>9010</td>
<td>SQL</td>
<td>medium</td>
<td>70</td>
<td>2021-01-01 10:00:00</td>
</tr>
</tbody>
</table>
<p>试卷作答信息表 <code>exam_record</code>（<code>uid</code> 用户 ID, <code>exam_id</code> 试卷 ID, <code>start_time</code> 开始作答时间, <code>submit_time</code> 交卷时间, <code>score</code> 得分）：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>uid</th>
<th>exam_id</th>
<th>start_time</th>
<th>submit_time</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1001</td>
<td>9001</td>
<td>2020-01-01 09:01:01</td>
<td>2020-01-01 09:21:59</td>
<td>80</td>
</tr>
<tr>
<td>2</td>
<td>1002</td>
<td>9003</td>
<td>2020-01-20 10:01:01</td>
<td>2020-01-20 10:10:01</td>
<td>81</td>
</tr>
<tr>
<td>3</td>
<td>1002</td>
<td>9002</td>
<td>2020-02-01 12:11:01</td>
<td>2020-02-01 12:31:01</td>
<td>83</td>
</tr>
<tr>
<td>4</td>
<td>1003</td>
<td>9002</td>
<td>2020-03-01 19:01:01</td>
<td>2020-03-01 19:30:01</td>
<td>75</td>
</tr>
<tr>
<td>5</td>
<td>1004</td>
<td>9002</td>
<td>2020-03-01 12:01:01</td>
<td>2020-03-01 12:11:01</td>
<td>60</td>
</tr>
<tr>
<td>6</td>
<td>1005</td>
<td>9002</td>
<td>2020-03-01 12:01:01</td>
<td>2020-03-01 12:41:01</td>
<td>90</td>
</tr>
<tr>
<td>7</td>
<td>1006</td>
<td>9001</td>
<td>2020-05-02 19:01:01</td>
<td>2020-05-02 19:32:00</td>
<td>20</td>
</tr>
<tr>
<td>8</td>
<td>1007</td>
<td>9003</td>
<td>2020-01-02 19:01:01</td>
<td>2020-01-02 19:40:01</td>
<td>89</td>
</tr>
<tr>
<td>9</td>
<td>1008</td>
<td>9004</td>
<td>2020-02-02 12:01:01</td>
<td>2020-02-02 12:20:01</td>
<td>99</td>
</tr>
<tr>
<td>10</td>
<td>1008</td>
<td>9001</td>
<td>2020-02-02 12:01:01</td>
<td>2020-02-02 12:31:01</td>
<td>98</td>
</tr>
<tr>
<td>11</td>
<td>1009</td>
<td>9002</td>
<td>2020-02-02 12:01:01</td>
<td>2020-01-02 12:43:01</td>
<td>81</td>
</tr>
<tr>
<td>12</td>
<td>1010</td>
<td>9001</td>
<td>2020-01-02 12:11:01</td>
<td>(NULL)</td>
<td>(NULL)</td>
</tr>
<tr>
<td>13</td>
<td>1010</td>
<td>9001</td>
<td>2020-02-02 12:01:01</td>
<td>2020-01-02 10:31:01</td>
<td>89</td>
</tr>
</tbody>
</table>
<p>试卷的类别 tag 可能出现大小写混乱的情况，请先筛选出试卷作答数小于 3 的类别 tag，统计将其转换为大写后对应的原本试卷作答数。</p>
<p>如果转换后 tag 并没有发生变化，不输出该条结果。</p>
<p>由示例数据结果输出如下：</p>
<table>
<thead>
<tr>
<th>tag</th>
<th>answer_cnt</th>
</tr>
</thead>
<tbody>
<tr>
<td>C++</td>
<td>6</td>
</tr>
</tbody>
</table>
<p>解释：被作答过的试卷有 9001、9002、9003、9004，他们的 tag 和被作答次数如下：</p>
<table>
<thead>
<tr>
<th>exam_id</th>
<th>tag</th>
<th>answer_cnt</th>
</tr>
</thead>
<tbody>
<tr>
<td>9001</td>
<td>算法</td>
<td>4</td>
</tr>
<tr>
<td>9002</td>
<td>C++</td>
<td>6</td>
</tr>
<tr>
<td>9003</td>
<td>c++</td>
<td>2</td>
</tr>
<tr>
<td>9004</td>
<td>sql</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>作答次数小于 3 的 tag 有 c++和 sql，而转为大写后只有 C++本来就有作答数，于是输出 c++转化大写后的作答次数为 6。</p>
<p><strong>思路</strong>：</p>
<p>首先，这题有点混乱，9004 根据示例数据查出来只有 1 次，这里显示有 2 次。</p>
<p>先看一下大小写转换函数：</p>
<p>1.<code>UPPER(s)</code>或<code>UCASE(s)</code>函数可以将字符串 s 中的字母字符全部转换成大写字母；</p>
<p>2.<code>LOWER(s)</code>或者<code>LCASE(s)</code>函数可以将字符串 s 中的字母字符全部转换成小写字母。</p>
<p>难点在于相同表做连接要查询不同的值</p>
<p><strong>答案</strong>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WITH</span> a <span style="color:#fff;font-weight:bold">AS</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#fff;font-weight:bold">SELECT</span> tag,
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">COUNT</span>(start_time) <span style="color:#fff;font-weight:bold">AS</span> answer_cnt
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">FROM</span> exam_record er
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">JOIN</span> examination_info ei <span style="color:#fff;font-weight:bold">ON</span> er.exam_id = ei.exam_id
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> tag)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> a.tag,
</span></span><span style="display:flex;"><span>       b.answer_cnt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> a
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INNER</span> <span style="color:#fff;font-weight:bold">JOIN</span> a <span style="color:#fff;font-weight:bold">AS</span> b <span style="color:#fff;font-weight:bold">ON</span> <span style="color:#fff;font-weight:bold">UPPER</span>(a.tag)= b.tag #a<span style="color:#f00">小写</span> b<span style="color:#f00">大写</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">AND</span> a.tag != b.tag
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> a.answer_cnt &lt; <span style="color:#ff0;font-weight:bold">3</span>;
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/interview/">interview</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>