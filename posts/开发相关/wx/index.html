<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>wx | Wjy&#39;s Blog</title>
<meta name="keywords" content="other">
<meta name="description" content="æ¦‚è¿°
å…¬ä¼—å·ç±»å‹åŠŸèƒ½ä»‹ç»
å¾®ä¿¡å®˜æ–¹ä»‹ç»
å…¬ä¼—å·ï¼Œæ˜¯è®¢é˜…å·å’ŒæœåŠ¡å·çš„ç»Ÿç§°ã€‚è®¢é˜…å·æ˜¯å…¬ä¼—å·ã€æœåŠ¡å·ä¹Ÿæ˜¯å…¬ä¼—å·ã€‚">
<meta name="author" content="Me, You">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/wx/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="wx" />
<meta property="og:description" content="æ¦‚è¿°
å…¬ä¼—å·ç±»å‹åŠŸèƒ½ä»‹ç»
å¾®ä¿¡å®˜æ–¹ä»‹ç»
å…¬ä¼—å·ï¼Œæ˜¯è®¢é˜…å·å’ŒæœåŠ¡å·çš„ç»Ÿç§°ã€‚è®¢é˜…å·æ˜¯å…¬ä¼—å·ã€æœåŠ¡å·ä¹Ÿæ˜¯å…¬ä¼—å·ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/wx/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-04-25T10:04:49+00:00" />
<meta property="article:modified_time" content="2019-04-25T10:04:49+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="wx"/>
<meta name="twitter:description" content="æ¦‚è¿°
å…¬ä¼—å·ç±»å‹åŠŸèƒ½ä»‹ç»
å¾®ä¿¡å®˜æ–¹ä»‹ç»
å…¬ä¼—å·ï¼Œæ˜¯è®¢é˜…å·å’ŒæœåŠ¡å·çš„ç»Ÿç§°ã€‚è®¢é˜…å·æ˜¯å…¬ä¼—å·ã€æœåŠ¡å·ä¹Ÿæ˜¯å…¬ä¼—å·ã€‚"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "wx",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/wx/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "wx",
  "name": "wx",
  "description": "æ¦‚è¿° å…¬ä¼—å·ç±»å‹åŠŸèƒ½ä»‹ç» å¾®ä¿¡å®˜æ–¹ä»‹ç» å…¬ä¼—å·ï¼Œæ˜¯è®¢é˜…å·å’ŒæœåŠ¡å·çš„ç»Ÿç§°ã€‚è®¢é˜…å·æ˜¯å…¬ä¼—å·ã€æœåŠ¡å·ä¹Ÿæ˜¯å…¬ä¼—å·ã€‚\n",
  "keywords": [
    "other"
  ],
  "articleBody": "æ¦‚è¿° å…¬ä¼—å·ç±»å‹åŠŸèƒ½ä»‹ç» å¾®ä¿¡å®˜æ–¹ä»‹ç» å…¬ä¼—å·ï¼Œæ˜¯è®¢é˜…å·å’ŒæœåŠ¡å·çš„ç»Ÿç§°ã€‚è®¢é˜…å·æ˜¯å…¬ä¼—å·ã€æœåŠ¡å·ä¹Ÿæ˜¯å…¬ä¼—å·ã€‚\nè®¢é˜…å·ï¼šåäºä¸ºç”¨æˆ·ä¼ è¾¾èµ„è®¯ï¼Œæ¯å¤©åªå¯ä»¥å‘é€ä¸€æ¡ç¾¤å‘ï¼Œç”¨æˆ·ä¸ä¼šæ”¶åˆ°å³æ—¶æ¶ˆæ¯æé†’ï¼Œå› ä¸ºæ‰€æœ‰çš„è®¢é˜…å·éƒ½è¢«æ”¶åœ¨äº†è®¢é˜…å·æ–‡ä»¶å¤¹ä¸­ã€‚è®¢é˜…å·é€‚ç”¨äºä¸ªäººå’Œç»„ç»‡ã€‚ æƒ³çœ‹ä¸€ä¸ªè®¢é˜…å·çš„æ¶ˆæ¯ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š\næ‰“å¼€è®¢é˜…å·æ–‡ä»¶å¤¹æŸ¥çœ‹è®¢é˜…å·æœ‰æ²¡æœ‰æ›´æ–°æ¶ˆæ¯ï¼› æ‰“å¼€å¾®ä¿¡æ‰‹æœºé€šè®¯å½•ï¼Œç‚¹å¼€å…¬ä¼—å·é€‰é¡¹ï¼Œæ˜¯ä½ å…³æ³¨çš„æ‰€æœ‰å…¬ä¼—å·(åŒ…æ‹¬è®¢é˜…å·å’ŒæœåŠ¡å·)ã€‚ æœåŠ¡å·ï¼šåäºæœåŠ¡äº¤äº’(å¦‚ï¼šæ‹›å•†é“¶è¡Œä¿¡ç”¨å¡ã€å¾®ä¿¡è¯»ä¹¦ã€äº¬ä¸œç™½æ¡)ï¼Œæ¯æœˆå¯ç¾¤å‘å››æ¡æ¶ˆæ¯ï¼Œæ”¶è´¹ï¼Œä¸é€‚ç”¨äºä¸ªäººï¼Œå¾®ä¿¡æ”¯ä»˜éœ€è¦å¾®ä¿¡è®¤è¯æœåŠ¡å·æ‰å¯ä»¥ã€‚\né€‰æ‹©ï¼š æƒ³ç®€å•çš„å‘é€æ¶ˆæ¯ï¼Œè¾¾åˆ°å®£ä¼ æ•ˆæœï¼Œå»ºè®®é€‰æ‹©è®¢é˜…å·ã€‚ æƒ³ç”¨å…¬ä¼—å·è·å¾—æ›´å¤šåŠŸèƒ½ï¼Œå¦‚å¼€é€šå¾®ä¿¡æ”¯ä»˜ï¼Œå»ºè®®é€‰æ‹©æœåŠ¡å·ã€‚\næœåŠ¡å·ã€è®¢é˜…å·åŠŸèƒ½å¯¹æ¯”ï¼š å¾®ä¿¡å¼€æ”¾å¹³å°ã€å…¬ä¼—å¹³å°åŒºåˆ« å…¬ä¼—å¹³å° å®˜ç½‘ æŠ€æœ¯æ–‡æ¡£ å¾®ä¿¡å…¬ä¼—å¹³å°æ˜¯è¿è¥è€…é€šè¿‡å…¬ä¼—å·ä¸ºå¾®ä¿¡ç”¨æˆ·æä¾›èµ„è®¯å’ŒæœåŠ¡çš„å¹³å°ï¼Œç™»å½•å…¬ä¼—å¹³å°è´¦å·åï¼Œå¯ä»¥çœ‹åˆ°å®ƒæœ‰ä¸€ä¸ªä¸é”™çš„äº¤äº’ç•Œé¢ã€‚å¯ä»¥æä¾›ç»™å…¬å¸çš„è¿è¥äººå‘˜ä½¿ç”¨ï¼Œç”¨æ¥å‘å¸ƒæ¶ˆæ¯å’Œæä¾›æœåŠ¡ã€‚\nå¼€æ”¾å¹³å° å®˜ç½‘ æ˜¯ä¸ºå¼€å‘è€…ï¼ˆç¨‹åºå‘˜ï¼‰æä¾›çš„ä¸€ä¸ªå¹³å°ï¼Œåœ¨è¿™é‡Œä½ å¯ä»¥å°†ä½ çš„å…¬ä¼—å¹³å°ä¸‹çš„å…¬ä¼—å·ï¼ˆè®¢é˜…å·ã€æœåŠ¡å·ï¼‰ç»‘å®šåˆ°ä½ çš„å¼€æ”¾å¹³å°è´¦å·ä¸‹ï¼Œä»è€Œå¯ä»¥åŸºäºè®¢é˜…å·ã€æœåŠ¡å·åšæ›´å¤šçš„å¼€å‘ã€‚å…¬ä¼—å·ä¸­çš„è®¢é˜…å·æ¥å£æƒé™æ˜¯æœ‰é™çš„ï¼Œæ¯”å¦‚å®ƒæ— æ³•è·å¾—ç½‘é¡µæˆæƒçš„æƒé™ï¼Œä¹Ÿå°±æ— æ³•é€šè¿‡ç½‘é¡µæˆæƒè·å–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼ˆæ¯”å¦‚openIDã€unionIDç­‰ï¼‰ã€‚\nåŠŸèƒ½å®ç° å¾®ä¿¡h5åˆ†äº« å‚è€ƒåœ°å€\næµç¨‹å›¾ï¼š å‡†å¤‡ï¼šå…¬ä¼—å·ã€å·²ç»å¤‡æ¡ˆå¥½çš„åŸŸå\næ­¥éª¤ï¼š\né…ç½®JSå›è°ƒåŸŸåå’Œipç™½åå• è·å–appIdå’Œsecret ä»å®˜æ–¹ä»£ç copyç­¾åå‡½æ•° è·å–access_tokenã€ticket è·å–urlï¼Œå¹¶è¿›è¡Œç­¾å é›†æˆè¿›java web å‰ç«¯configå‡½æ•°é…ç½® è·å–appIdå’Œsecret å¯ä»¥åœ¨åŸºæœ¬é…ç½®ä¸­æ‰¾åˆ°AppIDå’ŒAppSecretã€‚\né…ç½®JSå›è°ƒåŸŸåï¼š ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°-\u003eå…¬ä¼—å·è®¾ç½®-\u003eåŠŸèƒ½è®¾ç½®-\u003eJSæ¥å£å®‰å…¨åŸŸåã€‚å¡«å†™ä½ è¦åˆ†äº«çš„ç½‘é¡µæ‰€åœ¨çš„åŸŸåã€‚\né…ç½®ipç™½åå•ï¼š ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°-\u003eåŸºæœ¬é…ç½®-\u003eIPç™½åå•ã€‚ å¿…é¡»é…ç½®ipç™½åå•ï¼Œå¦åˆ™æ— æ³•è·å–access_token\nä»å®˜æ–¹ä»£ç copyç­¾åå‡½æ•° æ‰“å¼€å¾®ä¿¡åˆ†äº«å®˜æ–¹æ–‡æ¡£ï¼Œåœ¨é¡µé¢æœ€ä¸‹é¢æ‰¾åˆ°å¹¶ä¸‹è½½ç¤ºä¾‹ä»£ç  æˆ‘ä»¬å°†javaä¸­çš„sign.javaç›´æ¥æ”¾åˆ°é¡¹ç›®ä¸­å¤‡ç”¨ã€‚\nå…¬ä¼—å·è·å–access_tokenå®˜æ–¹æ–‡æ¡£ å°ç¨‹åºè·å–access_tokenå®˜æ–¹æ–‡æ¡£\nè·å–access_tokenã€ticket 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 public static WxShare getWxEntity(String url,StringRedisTemplate template) { String access_token = template.opsForValue().get(\"wx_base_access_token\"); String ticket = template.opsForValue().get(\"wx_jsapi_ticket\"); if(StringUtils.isEmpty(access_token)){ System.out.println(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003eé‡æ–°è·å–access_tokenå’Œticket\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\"); //å·²ç»è¶…æ—¶ï¼Œé‡æ–°è·å– access_token = getAccessToken(template); //å¦‚æœé‡æ–°è·å–äº†access_tokenï¼Œticketä¹Ÿè¦é‡æ–°è·å– ticket = getTicket(access_token,template); } Map resultMap = Sign.sign(ticket, url); WxShare wx = new WxShare(); wx.setTicket(resultMap.get(\"jsapi_ticket\")); wx.setSignature(resultMap.get(\"signature\")); wx.setNoncestr(resultMap.get(\"nonceStr\")); wx.setTimestamp(resultMap.get(\"timestamp\")); return wx; } //è·å–token private static String getAccessToken(StringRedisTemplate template) { String access_token = \"\"; //è·å–access_tokenå¡«å†™client_credential String grant_type = \"client_credential\"; //ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯ String AppId= PayConstant.WX_H5_APPID; //ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯å¯†é’¥ï¼Œå³appsecret String secret=PayConstant.WX_H5_APPSECRET; //è®¿é—®é“¾æ¥,è¿™ä¸ªurlé“¾æ¥åœ°å€å’Œå‚æ•°çš†ä¸èƒ½å˜ String url = \"https://api.weixin.qq.com/cgi-bin/token?grant_type=\"+grant_type+\"\u0026appid=\"+AppId+\"\u0026secret=\"+secret; try { URL urlGet = new URL(url); HttpURLConnection http = (HttpURLConnection) urlGet.openConnection(); http.setRequestMethod(\"GET\"); // å¿…é¡»æ˜¯getæ–¹å¼è¯·æ±‚ http.setRequestProperty(\"Content-Type\",\"application/x-www-form-urlencoded\"); http.setDoOutput(true); http.setDoInput(true); /*System.setProperty(\"sun.net.client.defaultConnectTimeout\", \"30000\");// è¿æ¥è¶…æ—¶30ç§’ System.setProperty(\"sun.net.client.defaultReadTimeout\", \"30000\"); // è¯»å–è¶…æ—¶30ç§’ */ http.connect(); InputStream is = http.getInputStream(); int size = is.available(); byte[] jsonBytes = new byte[size]; is.read(jsonBytes); String message = new String(jsonBytes, \"UTF-8\"); JSONObject demoJson = JSONObject.fromObject(message); access_token = demoJson.getString(\"access_token\"); //ç¼“å­˜åˆ°redisï¼Œä¸€å®šè¦ç¼“å­˜ï¼Œæ¯å¤©åªèƒ½è¯·æ±‚2000æ¬¡ template.opsForValue().set(\"wx_base_access_token\",access_token,2, TimeUnit.HOURS); is.close(); } catch (Exception e) { e.printStackTrace(); } return access_token; } //è·å–ticket private static String getTicket(String access_token,StringRedisTemplate template) { String ticket = null; //è¿™ä¸ªurlé“¾æ¥å’Œå‚æ•°ä¸èƒ½å˜ String url = \"https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=\"+ access_token +\"\u0026type=jsapi\"; try { URL urlGet = new URL(url); HttpURLConnection http = (HttpURLConnection) urlGet.openConnection(); http.setRequestMethod(\"GET\"); // å¿…é¡»æ˜¯getæ–¹å¼è¯·æ±‚ http.setRequestProperty(\"Content-Type\",\"application/x-www-form-urlencoded\"); http.setDoOutput(true); http.setDoInput(true); System.setProperty(\"sun.net.client.defaultConnectTimeout\", \"30000\");// è¿æ¥è¶…æ—¶30ç§’ System.setProperty(\"sun.net.client.defaultReadTimeout\", \"30000\"); // è¯»å–è¶…æ—¶30ç§’ http.connect(); InputStream is = http.getInputStream(); int size = is.available(); byte[] jsonBytes = new byte[size]; is.read(jsonBytes); String message = new String(jsonBytes, \"UTF-8\"); JSONObject demoJson = JSONObject.fromObject(message); ticket = demoJson.getString(\"ticket\"); //ç¼“å­˜åˆ°redisï¼Œä¸€å®šè¦ç¼“å­˜ï¼Œæ¯å¤©åªèƒ½è¯·æ±‚2000æ¬¡ template.opsForValue().set(\"wx_jsapi_ticket\",ticket,2, TimeUnit.HOURS); is.close(); } catch (Exception e) { e.printStackTrace(); } return ticket; } è·å–urlï¼Œå¹¶è¿›è¡Œç­¾å urlçš„è·å–è¦ç‰¹åˆ«æ³¨æ„ï¼Œå› ä¸ºå¾®ä¿¡åœ¨åˆ†äº«æ—¶ä¼šåœ¨åŸæ¥çš„urlä¸ŠåŠ ä¸Šä¸€äº›\u0026from=singlemessageã€\u0026from=â€¦çš„ï¼Œæ‰€ä»¥urlå¿…é¡»è¦åŠ¨æ€è·å–ï¼Œç½‘ä¸Šæœ‰äº›ç”¨ajaxï¼Œåœ¨ç½‘é¡µé€šè¿‡â€œlocation.href.split(â€˜#â€™)â€œ è·å–urlï¼Œåœ¨ç”¨ajaxä¼ ç»™åå°ï¼Œè¿™ç§æ–¹æ³•å¯è¡Œï¼Œä½†æ˜¯ä¸æ¨èï¼Œä¸€æ–¹é¢ç”¨ajaxè¿”å›ï¼Œå°±è¦è®¿é—®åˆ†äº«çš„é€»è¾‘ï¼Œè¿™æ ·åå°åˆ†äº«çš„é€»è¾‘å¢åŠ å¤æ‚åº¦ï¼Œå¸¦æ¥ä¸ä¾¿ï¼Œæ˜¯ä»£ç ä¸æ˜“äºç»´æŠ¤ï¼Œå¯è¯»æ€§ä½ï¼å¦ä¸€æ–¹é¢åˆ†äº«æ˜¯è¿”å›é¡µé¢ï¼Œè€Œajaxæ˜¯è¿”å›jsonï¼Œåˆå¢åŠ äº†å¤æ‚åº¦ã€‚æ‰€ä»¥ï¼Œä¸€ä¸ªjavaç¨‹åºå‘˜æ˜¯ä¸ä¼šé€šè¿‡ajaxä»å‰å°è·å–urlçš„ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨HttpRequestçš„æ–¹æ³•å³å¯ï¼Œä¸ç®¡å¾®ä¿¡åŠ å¤šå°‘åç¼€ï¼Œéƒ½å¯ä»¥è·å–åˆ°å®Œæ•´çš„å½“å‰urlã€‚\nè·å–urlçš„controllerå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @PostMapping(\"/share\") public ResponseUtil getQuestionList(@RequestBody Map paramMap){ LOGGER.info( \"\\n***************************************\" + \"\\n\" + \"start share\" + \"\\n\" + \"åˆ†äº«\" + \"\\n\" + \"\\n********************************************\" ); ResponseUtil response = ResponseUtil.success(); CodeEnum code = CodeEnum.FAIL; try { LOGGER.info(\"å‰ç«¯ä¼ è¿‡æ¥çš„\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003cï¼š\" + paramMap.get(\"strUrl\")); LOGGER.info(\"URIè§£ç \u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003cï¼š\" + URI.create(paramMap.get(\"strUrl\")).getPath()); response.setData(wxUtil.getWxEntity(URI.create(paramMap.get(\"strUrl\")).getPath(),redisTemplate)); } catch (Exception e) { e.printStackTrace(); response.setCode(code); response.setMessage(e.getMessage()); } return response; } éœ€è¦æ³¨æ„ï¼šè¿™ä¸ªurlæ˜¯å‰ç«¯åŠ¨æ€è·å–çš„ï¼Œä¸èƒ½å†™æ­»ã€‚å¦‚æœå¸¦å‚æ•°ï¼Œæˆ–æ˜¯ä¸­æ–‡ï¼Œå‰ç«¯è¦å¯¹urlåšencodeURIComponentè½¬ç ï¼Œåå°å†ä½¿ç”¨URI.create(paramMap.get(\"strUrl\")).getPath()è¿›è¡Œè§£ç ã€‚\næˆ‘ä»¬å†æ–°å»ºä¸€ä¸ªå­˜æ”¾å¾®ä¿¡ä¿¡æ¯çš„å®ä½“ç±»ï¼šwx.java\n1 2 3 4 5 6 7 8 9 10 11 public class wx { private String access_token; private String ticket ; private String noncestr; private String timestamp; private String str; private String signature; ...setter and getter... } signç±»é‡Œé¢æœ‰ä¸€ä¸ªç­¾åçš„æ–¹æ³•signï¼Œä¼ å…¥ticketå’Œurlå³å¯ã€‚ä¹Ÿå°±æ˜¯WeinXinUtilçš„getWinXinEntityæ–¹æ³•ï¼Œå¹¶å°†è¿”å›çš„mapçš„ä¿¡æ¯è¯»å–å­˜å…¥WinXinEntityä¸­ã€‚ åœ¨è°ƒè¯•æ—¶ï¼ŒæŠŠsignè¿”å›çš„mapæ‰“å°å‡ºæ¥ï¼Œä¸»è¦çœ‹çœ‹ç”Ÿæˆçš„signatureã€‚ç„¶åï¼ŒæŠŠjsapi_ticketã€noncestrã€timestampã€url å¤åˆ¶åˆ°å¾®ä¿¡æä¾›çš„å¾®ä¿¡ JS æ¥å£ç­¾åæ ¡éªŒå·¥å…·ï¼Œ æ¯”è¾ƒä»£ç ç­¾åç”Ÿæˆçš„signatureä¸æ ¡éªŒå·¥å…·ç”Ÿæˆçš„ç­¾åsignatureæ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œè¯´æ˜å‰é¢çš„æ­¥éª¤éƒ½æ˜¯æ­£ç¡®çš„ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œä»”ç»†æ£€æŸ¥ã€‚\ncontroller æˆ‘ä»¬æŠŠå¾®ä¿¡åˆ†äº«åˆ†è§£æˆ3ä¸ªå·¥å…·ç±»ï¼Œç°åœ¨åœ¨å¤„ç†åˆ†äº«çš„controllerï¼Œåªè¦ä¸¤å¥è¯å°±å¯ä»¥è°ƒç”¨å¾®ä¿¡åˆ†äº«ï¼Œä¸€å¥è·å–urlï¼Œä¸€å¥è·å–WinXinEntityï¼Œä»£ç å·²ç»åœ¨ä¸Šè¾¹ç»™å‡ºäº†ã€‚\nå‰ç«¯configå‡½æ•°é…ç½® ä¸‹é¢çš„ä»£ç æ”¾åœ¨ç½‘é¡µjsä»£ç çš„æœ€å‰é¢ï¼ â€var url = location.href.split(â€˜#â€™)[0];â€œ é¡µé¢çš„urlä¹Ÿå¯ä»¥ä»åå°ä¼ è¿‡æ¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡location.href.split(â€˜#â€™)[0]è·å–ã€‚ ä¸ºäº†ä¸€ç‚¹å¾®ä¸è¶³é“çš„é€Ÿåº¦ï¼Œè¿™é‡Œæ‰ç”¨ç½‘é¡µè·å–æ–¹å¼ã€‚ï¼ˆç½‘é¡µçš„urlè·Ÿå‰é¢çš„åå°ç­¾åæ—¶å¾—urlæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯ç»•è¿‡äº†ajaxï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 ",
  "wordCount" : "13884",
  "inLanguage": "en",
  "datePublished": "2019-04-25T10:04:49Z",
  "dateModified": "2019-04-25T10:04:49Z",
  "author":[{
    "@type": "Person",
    "name": "Me"
  }, {
    "@type": "Person",
    "name": "You"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/wx/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;Â»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title">
      wx
    </h1>
    <div class="post-meta"><span title='2019-04-25 10:04:49 +0000 UTC'>2019-04-25</span>&nbsp;Â·&nbsp;Me, You

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%a6%82%e8%bf%b0" aria-label="æ¦‚è¿°">æ¦‚è¿°</a><ul>
                        
                <li>
                    <a href="#%e5%85%ac%e4%bc%97%e5%8f%b7%e7%b1%bb%e5%9e%8b%e5%8a%9f%e8%83%bd%e4%bb%8b%e7%bb%8d" aria-label="å…¬ä¼—å·ç±»å‹åŠŸèƒ½ä»‹ç»">å…¬ä¼—å·ç±»å‹åŠŸèƒ½ä»‹ç»</a></li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e5%bc%80%e6%94%be%e5%b9%b3%e5%8f%b0%e5%85%ac%e4%bc%97%e5%b9%b3%e5%8f%b0%e5%8c%ba%e5%88%ab" aria-label="å¾®ä¿¡å¼€æ”¾å¹³å°ã€å…¬ä¼—å¹³å°åŒºåˆ«">å¾®ä¿¡å¼€æ”¾å¹³å°ã€å…¬ä¼—å¹³å°åŒºåˆ«</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8a%9f%e8%83%bd%e5%ae%9e%e7%8e%b0" aria-label="åŠŸèƒ½å®ç°">åŠŸèƒ½å®ç°</a><ul>
                        
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1h5%e5%88%86%e4%ba%ab" aria-label="å¾®ä¿¡h5åˆ†äº«">å¾®ä¿¡h5åˆ†äº«</a><ul>
                        
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96appid%e5%92%8csecret" aria-label="è·å–appIdå’Œsecret">è·å–appIdå’Œsecret</a></li>
                <li>
                    <a href="#%e4%bb%8e%e5%ae%98%e6%96%b9%e4%bb%a3%e7%a0%81copy%e7%ad%be%e5%90%8d%e5%87%bd%e6%95%b0" aria-label="ä»å®˜æ–¹ä»£ç copyç­¾åå‡½æ•°">ä»å®˜æ–¹ä»£ç copyç­¾åå‡½æ•°</a></li>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96access_tokenticket" aria-label="è·å–access_tokenã€ticket">è·å–access_tokenã€ticket</a></li>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96url%e5%b9%b6%e8%bf%9b%e8%a1%8c%e7%ad%be%e5%90%8d" aria-label="è·å–urlï¼Œå¹¶è¿›è¡Œç­¾å">è·å–urlï¼Œå¹¶è¿›è¡Œç­¾å</a></li>
                <li>
                    <a href="#controller" aria-label="controller">controller</a></li>
                <li>
                    <a href="#%e5%89%8d%e7%ab%afconfig%e5%87%bd%e6%95%b0%e9%85%8d%e7%bd%ae" aria-label="å‰ç«¯configå‡½æ•°é…ç½®">å‰ç«¯configå‡½æ•°é…ç½®</a></li>
                <li>
                    <a href="#%e5%88%86%e4%ba%ab%e9%93%be%e6%8e%a5%e5%b8%a6%e5%8f%82%e6%95%b0%e7%9a%84%e6%83%85%e5%86%b5" aria-label="åˆ†äº«é“¾æ¥å¸¦å‚æ•°çš„æƒ…å†µ">åˆ†äº«é“¾æ¥å¸¦å‚æ•°çš„æƒ…å†µ</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e5%b0%8f%e7%a8%8b%e5%ba%8f%e7%99%bb%e5%bd%95" aria-label="å¾®ä¿¡å°ç¨‹åºç™»å½•">å¾®ä¿¡å°ç¨‹åºç™»å½•</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%a8%8b%e5%ba%8f%e8%8e%b7%e5%8f%96%e6%89%8b%e6%9c%ba%e5%8f%b7" aria-label="å°ç¨‹åºè·å–æ‰‹æœºå·">å°ç¨‹åºè·å–æ‰‹æœºå·</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%8f%91%e9%80%81%e6%b6%88%e6%81%af" aria-label="å°ç¨‹åºå‘é€æ¶ˆæ¯">å°ç¨‹åºå‘é€æ¶ˆæ¯</a><ul>
                        
                <li>
                    <a href="#%e4%bc%a0%e5%aa%92%e4%bd%93%e6%96%87%e4%bb%b6%e5%88%b0%e5%be%ae%e4%bf%a1%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="ä¼ åª’ä½“æ–‡ä»¶åˆ°å¾®ä¿¡æœåŠ¡å™¨">ä¼ åª’ä½“æ–‡ä»¶åˆ°å¾®ä¿¡æœåŠ¡å™¨</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bf%a1%e5%85%ac%e4%bc%97%e5%8f%b7%e5%8f%91%e9%80%81%e6%a8%a1%e6%9d%bf%e6%b6%88%e6%81%af" aria-label="ä¿¡å…¬ä¼—å·å‘é€æ¨¡æ¿æ¶ˆæ¯">ä¿¡å…¬ä¼—å·å‘é€æ¨¡æ¿æ¶ˆæ¯</a><ul>
                        
                <li>
                    <a href="#%e5%87%bb%e6%8e%a8%e9%80%81%e6%b6%88%e6%81%af%e8%b7%b3%e8%bd%ac%e5%88%b0%e7%bd%91%e9%a1%b5%e6%88%96%e8%80%85%e5%b0%8f%e7%a8%8b%e5%ba%8f" aria-label="å‡»æ¨é€æ¶ˆæ¯è·³è½¬åˆ°ç½‘é¡µæˆ–è€…å°ç¨‹åº">å‡»æ¨é€æ¶ˆæ¯è·³è½¬åˆ°ç½‘é¡µæˆ–è€…å°ç¨‹åº</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96" aria-label="å…¶ä»–">å…¶ä»–</a><ul>
                        
                <li>
                    <a href="#%e5%85%a8%e5%b1%80%e8%bf%94%e5%9b%9e%e7%a0%81%e8%af%b4%e6%98%8e" aria-label="å…¨å±€è¿”å›ç è¯´æ˜">å…¨å±€è¿”å›ç è¯´æ˜</a></li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e5%88%86%e4%ba%abjssdk-invalid-signature%e7%ad%be%e5%90%8d%e9%94%99%e8%af%af%e7%9a%84%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88" aria-label="å¾®ä¿¡åˆ†äº«JSSDK-invalid signatureç­¾åé”™è¯¯çš„è§£å†³æ–¹æ¡ˆ">å¾®ä¿¡åˆ†äº«JSSDK-invalid signatureç­¾åé”™è¯¯çš„è§£å†³æ–¹æ¡ˆ</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%a8%8b%e5%ba%8f%e6%8a%a5%e9%94%99" aria-label="å°ç¨‹åºæŠ¥é”™">å°ç¨‹åºæŠ¥é”™</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="æ¦‚è¿°">æ¦‚è¿°<a hidden class="anchor" aria-hidden="true" href="#æ¦‚è¿°">#</a></h1>
<h2 id="å…¬ä¼—å·ç±»å‹åŠŸèƒ½ä»‹ç»">å…¬ä¼—å·ç±»å‹åŠŸèƒ½ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#å…¬ä¼—å·ç±»å‹åŠŸèƒ½ä»‹ç»">#</a></h2>
<p><a href="http://kf.qq.com/faq/170815aUZjeQ170815mU7bI7.html">å¾®ä¿¡å®˜æ–¹ä»‹ç»</a>
å…¬ä¼—å·ï¼Œæ˜¯è®¢é˜…å·å’ŒæœåŠ¡å·çš„ç»Ÿç§°ã€‚è®¢é˜…å·æ˜¯å…¬ä¼—å·ã€æœåŠ¡å·ä¹Ÿæ˜¯å…¬ä¼—å·ã€‚</p>
<p>è®¢é˜…å·ï¼šåäºä¸ºç”¨æˆ·ä¼ è¾¾èµ„è®¯ï¼Œæ¯å¤©åªå¯ä»¥å‘é€ä¸€æ¡ç¾¤å‘ï¼Œç”¨æˆ·ä¸ä¼šæ”¶åˆ°å³æ—¶æ¶ˆæ¯æé†’ï¼Œå› ä¸ºæ‰€æœ‰çš„è®¢é˜…å·éƒ½è¢«æ”¶åœ¨äº†è®¢é˜…å·æ–‡ä»¶å¤¹ä¸­ã€‚è®¢é˜…å·é€‚ç”¨äºä¸ªäººå’Œç»„ç»‡ã€‚
æƒ³çœ‹ä¸€ä¸ªè®¢é˜…å·çš„æ¶ˆæ¯ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li>æ‰“å¼€è®¢é˜…å·æ–‡ä»¶å¤¹æŸ¥çœ‹è®¢é˜…å·æœ‰æ²¡æœ‰æ›´æ–°æ¶ˆæ¯ï¼›</li>
<li>æ‰“å¼€å¾®ä¿¡æ‰‹æœºé€šè®¯å½•ï¼Œç‚¹å¼€å…¬ä¼—å·é€‰é¡¹ï¼Œæ˜¯ä½ å…³æ³¨çš„æ‰€æœ‰å…¬ä¼—å·(åŒ…æ‹¬è®¢é˜…å·å’ŒæœåŠ¡å·)ã€‚</li>
</ul>
<p>æœåŠ¡å·ï¼šåäºæœåŠ¡äº¤äº’(å¦‚ï¼šæ‹›å•†é“¶è¡Œä¿¡ç”¨å¡ã€å¾®ä¿¡è¯»ä¹¦ã€äº¬ä¸œç™½æ¡)ï¼Œæ¯æœˆå¯ç¾¤å‘å››æ¡æ¶ˆæ¯ï¼Œæ”¶è´¹ï¼Œä¸é€‚ç”¨äºä¸ªäººï¼Œå¾®ä¿¡æ”¯ä»˜éœ€è¦<strong>å¾®ä¿¡è®¤è¯æœåŠ¡å·</strong>æ‰å¯ä»¥ã€‚</p>
<p>é€‰æ‹©ï¼š
æƒ³ç®€å•çš„å‘é€æ¶ˆæ¯ï¼Œè¾¾åˆ°å®£ä¼ æ•ˆæœï¼Œå»ºè®®é€‰æ‹©è®¢é˜…å·ã€‚
æƒ³ç”¨å…¬ä¼—å·è·å¾—æ›´å¤šåŠŸèƒ½ï¼Œå¦‚å¼€é€šå¾®ä¿¡æ”¯ä»˜ï¼Œå»ºè®®é€‰æ‹©æœåŠ¡å·ã€‚</p>
<p>æœåŠ¡å·ã€è®¢é˜…å·åŠŸèƒ½å¯¹æ¯”ï¼š
<img loading="lazy" src="1.jpg" alt=""  />
</p>
<h2 id="å¾®ä¿¡å¼€æ”¾å¹³å°å…¬ä¼—å¹³å°åŒºåˆ«">å¾®ä¿¡å¼€æ”¾å¹³å°ã€å…¬ä¼—å¹³å°åŒºåˆ«<a hidden class="anchor" aria-hidden="true" href="#å¾®ä¿¡å¼€æ”¾å¹³å°å…¬ä¼—å¹³å°åŒºåˆ«">#</a></h2>
<ul>
<li>
<p>å…¬ä¼—å¹³å°
<a href="https://mp.weixin.qq.com/">å®˜ç½‘</a>
<a href="https://mp.weixin.qq.com/wiki">æŠ€æœ¯æ–‡æ¡£</a>
å¾®ä¿¡å…¬ä¼—å¹³å°æ˜¯è¿è¥è€…é€šè¿‡å…¬ä¼—å·ä¸ºå¾®ä¿¡ç”¨æˆ·æä¾›èµ„è®¯å’ŒæœåŠ¡çš„å¹³å°ï¼Œç™»å½•å…¬ä¼—å¹³å°è´¦å·åï¼Œå¯ä»¥çœ‹åˆ°å®ƒæœ‰ä¸€ä¸ªä¸é”™çš„äº¤äº’ç•Œé¢ã€‚å¯ä»¥æä¾›ç»™å…¬å¸çš„è¿è¥äººå‘˜ä½¿ç”¨ï¼Œç”¨æ¥å‘å¸ƒæ¶ˆæ¯å’Œæä¾›æœåŠ¡ã€‚</p>
</li>
<li>
<p>å¼€æ”¾å¹³å°
<a href="https://open.weixin.qq.com/">å®˜ç½‘</a>
æ˜¯ä¸ºå¼€å‘è€…ï¼ˆç¨‹åºå‘˜ï¼‰æä¾›çš„ä¸€ä¸ªå¹³å°ï¼Œåœ¨è¿™é‡Œä½ å¯ä»¥å°†ä½ çš„å…¬ä¼—å¹³å°ä¸‹çš„å…¬ä¼—å·ï¼ˆè®¢é˜…å·ã€æœåŠ¡å·ï¼‰ç»‘å®šåˆ°ä½ çš„å¼€æ”¾å¹³å°è´¦å·ä¸‹ï¼Œä»è€Œå¯ä»¥åŸºäºè®¢é˜…å·ã€æœåŠ¡å·åšæ›´å¤šçš„å¼€å‘ã€‚å…¬ä¼—å·ä¸­çš„è®¢é˜…å·æ¥å£æƒé™æ˜¯æœ‰é™çš„ï¼Œæ¯”å¦‚å®ƒæ— æ³•è·å¾—ç½‘é¡µæˆæƒçš„æƒé™ï¼Œä¹Ÿå°±æ— æ³•é€šè¿‡ç½‘é¡µæˆæƒè·å–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼ˆæ¯”å¦‚openIDã€unionIDç­‰ï¼‰ã€‚</p>
</li>
</ul>
<h1 id="åŠŸèƒ½å®ç°">åŠŸèƒ½å®ç°<a hidden class="anchor" aria-hidden="true" href="#åŠŸèƒ½å®ç°">#</a></h1>
<h2 id="å¾®ä¿¡h5åˆ†äº«">å¾®ä¿¡h5åˆ†äº«<a hidden class="anchor" aria-hidden="true" href="#å¾®ä¿¡h5åˆ†äº«">#</a></h2>
<p><a href="https://blog.csdn.net/change_on/article/details/75264843">å‚è€ƒåœ°å€</a></p>
<p>æµç¨‹å›¾ï¼š
<img loading="lazy" src="2.png" alt=""  />
</p>
<p>å‡†å¤‡ï¼šå…¬ä¼—å·ã€å·²ç»å¤‡æ¡ˆå¥½çš„åŸŸå</p>
<p>æ­¥éª¤ï¼š</p>
<ol>
<li>é…ç½®JSå›è°ƒåŸŸåå’Œipç™½åå•</li>
<li>è·å–appIdå’Œsecret</li>
<li>ä»å®˜æ–¹ä»£ç copyç­¾åå‡½æ•°</li>
<li>è·å–access_tokenã€ticket</li>
<li>è·å–urlï¼Œå¹¶è¿›è¡Œç­¾å</li>
<li>é›†æˆè¿›java web</li>
<li>å‰ç«¯configå‡½æ•°é…ç½®</li>
</ol>
<h3 id="è·å–appidå’Œsecret">è·å–appIdå’Œsecret<a hidden class="anchor" aria-hidden="true" href="#è·å–appidå’Œsecret">#</a></h3>
<p>å¯ä»¥åœ¨åŸºæœ¬é…ç½®ä¸­æ‰¾åˆ°AppIDå’ŒAppSecretã€‚</p>
<p>é…ç½®JSå›è°ƒåŸŸåï¼š
ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°-&gt;å…¬ä¼—å·è®¾ç½®-&gt;åŠŸèƒ½è®¾ç½®-&gt;JSæ¥å£å®‰å…¨åŸŸåã€‚å¡«å†™ä½ è¦åˆ†äº«çš„ç½‘é¡µæ‰€åœ¨çš„åŸŸåã€‚</p>
<p>é…ç½®ipç™½åå•ï¼š
ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°-&gt;åŸºæœ¬é…ç½®-&gt;IPç™½åå•ã€‚
å¿…é¡»é…ç½®ipç™½åå•ï¼Œå¦åˆ™æ— æ³•è·å–access_token</p>
<h3 id="ä»å®˜æ–¹ä»£ç copyç­¾åå‡½æ•°">ä»å®˜æ–¹ä»£ç copyç­¾åå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#ä»å®˜æ–¹ä»£ç copyç­¾åå‡½æ•°">#</a></h3>
<p>æ‰“å¼€<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141115">å¾®ä¿¡åˆ†äº«å®˜æ–¹æ–‡æ¡£</a>ï¼Œåœ¨é¡µé¢æœ€ä¸‹é¢æ‰¾åˆ°å¹¶ä¸‹è½½<a href="http://demo.open.weixin.qq.com/jssdk/sample.zip">ç¤ºä¾‹ä»£ç </a>
æˆ‘ä»¬å°†javaä¸­çš„<code>sign.java</code>ç›´æ¥æ”¾åˆ°é¡¹ç›®ä¸­å¤‡ç”¨ã€‚</p>
<p><a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html">å…¬ä¼—å·è·å–access_tokenå®˜æ–¹æ–‡æ¡£</a>
<a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html">å°ç¨‹åºè·å–access_tokenå®˜æ–¹æ–‡æ¡£</a></p>
<h3 id="è·å–access_tokenticket">è·å–access_tokenã€ticket<a hidden class="anchor" aria-hidden="true" href="#è·å–access_tokenticket">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">86
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> WxShare getWxEntity(String url,StringRedisTemplate template) {
</span></span><span style="display:flex;"><span>        String access_token = template.<span style="color:#007f7f">opsForValue</span>().<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;wx_base_access_token&#34;</span>);
</span></span><span style="display:flex;"><span>        String ticket = template.<span style="color:#007f7f">opsForValue</span>().<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;wx_jsapi_ticket&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(StringUtils.<span style="color:#007f7f">isEmpty</span>(access_token)){
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;é‡æ–°è·å–access_tokenå’Œticket&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å·²ç»è¶…æ—¶ï¼Œé‡æ–°è·å–
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            access_token = getAccessToken(template);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¦‚æœé‡æ–°è·å–äº†access_tokenï¼Œticketä¹Ÿè¦é‡æ–°è·å–
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ticket = getTicket(access_token,template);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Map&lt;String,String&gt; resultMap = Sign.<span style="color:#007f7f">sign</span>(ticket, url);
</span></span><span style="display:flex;"><span>        WxShare wx = <span style="color:#fff;font-weight:bold">new</span> WxShare();
</span></span><span style="display:flex;"><span>        wx.<span style="color:#007f7f">setTicket</span>(resultMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;jsapi_ticket&#34;</span>));
</span></span><span style="display:flex;"><span>        wx.<span style="color:#007f7f">setSignature</span>(resultMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;signature&#34;</span>));
</span></span><span style="display:flex;"><span>        wx.<span style="color:#007f7f">setNoncestr</span>(resultMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;nonceStr&#34;</span>));
</span></span><span style="display:flex;"><span>        wx.<span style="color:#007f7f">setTimestamp</span>(resultMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;timestamp&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> wx;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è·å–token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> String getAccessToken(StringRedisTemplate template) {
</span></span><span style="display:flex;"><span>        String access_token = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è·å–access_tokenå¡«å†™client_credential
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String grant_type = <span style="color:#0ff;font-weight:bold">&#34;client_credential&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String AppId= PayConstant.<span style="color:#007f7f">WX_H5_APPID</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯å¯†é’¥ï¼Œå³appsecret
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String secret=PayConstant.<span style="color:#007f7f">WX_H5_APPSECRET</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¿é—®é“¾æ¥,è¿™ä¸ªurlé“¾æ¥åœ°å€å’Œå‚æ•°çš†ä¸èƒ½å˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String url = <span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/cgi-bin/token?grant_type=&#34;</span>+grant_type+<span style="color:#0ff;font-weight:bold">&#34;&amp;appid=&#34;</span>+AppId+<span style="color:#0ff;font-weight:bold">&#34;&amp;secret=&#34;</span>+secret;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            URL urlGet = <span style="color:#fff;font-weight:bold">new</span> URL(url);
</span></span><span style="display:flex;"><span>            HttpURLConnection http = (HttpURLConnection) urlGet.<span style="color:#007f7f">openConnection</span>();
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setRequestMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;GET&#34;</span>); <span style="color:#007f7f">// å¿…é¡»æ˜¯getæ–¹å¼è¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            http.<span style="color:#007f7f">setRequestProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;Content-Type&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;application/x-www-form-urlencoded&#34;</span>);
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setDoOutput</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setDoInput</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">/*System.setProperty(&#34;sun.net.client.defaultConnectTimeout&#34;, &#34;30000&#34;);// è¿æ¥è¶…æ—¶30ç§’
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            System.setProperty(&#34;sun.net.client.defaultReadTimeout&#34;, &#34;30000&#34;); // è¯»å–è¶…æ—¶30ç§’ */</span>
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">connect</span>();
</span></span><span style="display:flex;"><span>            InputStream is = http.<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> size = is.<span style="color:#007f7f">available</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">byte</span>[] jsonBytes = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[size];
</span></span><span style="display:flex;"><span>            is.<span style="color:#007f7f">read</span>(jsonBytes);
</span></span><span style="display:flex;"><span>            String message = <span style="color:#fff;font-weight:bold">new</span> String(jsonBytes, <span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>            JSONObject demoJson = JSONObject.<span style="color:#007f7f">fromObject</span>(message);
</span></span><span style="display:flex;"><span>            access_token = demoJson.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;access_token&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ç¼“å­˜åˆ°redisï¼Œä¸€å®šè¦ç¼“å­˜ï¼Œæ¯å¤©åªèƒ½è¯·æ±‚2000æ¬¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            template.<span style="color:#007f7f">opsForValue</span>().<span style="color:#007f7f">set</span>(<span style="color:#0ff;font-weight:bold">&#34;wx_base_access_token&#34;</span>,access_token,<span style="color:#ff0;font-weight:bold">2</span>, TimeUnit.<span style="color:#007f7f">HOURS</span>);
</span></span><span style="display:flex;"><span>            is.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> access_token;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è·å–ticket
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> String getTicket(String access_token,StringRedisTemplate template) {
</span></span><span style="display:flex;"><span>        String ticket = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è¿™ä¸ªurlé“¾æ¥å’Œå‚æ•°ä¸èƒ½å˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String url = <span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=&#34;</span>+ access_token +<span style="color:#0ff;font-weight:bold">&#34;&amp;type=jsapi&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            URL urlGet = <span style="color:#fff;font-weight:bold">new</span> URL(url);
</span></span><span style="display:flex;"><span>            HttpURLConnection http = (HttpURLConnection) urlGet.<span style="color:#007f7f">openConnection</span>();
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setRequestMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;GET&#34;</span>); <span style="color:#007f7f">// å¿…é¡»æ˜¯getæ–¹å¼è¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            http.<span style="color:#007f7f">setRequestProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;Content-Type&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;application/x-www-form-urlencoded&#34;</span>);
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setDoOutput</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setDoInput</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;sun.net.client.defaultConnectTimeout&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;30000&#34;</span>);<span style="color:#007f7f">// è¿æ¥è¶…æ—¶30ç§’
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;sun.net.client.defaultReadTimeout&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;30000&#34;</span>); <span style="color:#007f7f">// è¯»å–è¶…æ—¶30ç§’
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            http.<span style="color:#007f7f">connect</span>();
</span></span><span style="display:flex;"><span>            InputStream is = http.<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> size = is.<span style="color:#007f7f">available</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">byte</span>[] jsonBytes = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[size];
</span></span><span style="display:flex;"><span>            is.<span style="color:#007f7f">read</span>(jsonBytes);
</span></span><span style="display:flex;"><span>            String message = <span style="color:#fff;font-weight:bold">new</span> String(jsonBytes, <span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>            JSONObject demoJson = JSONObject.<span style="color:#007f7f">fromObject</span>(message);
</span></span><span style="display:flex;"><span>            ticket = demoJson.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;ticket&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ç¼“å­˜åˆ°redisï¼Œä¸€å®šè¦ç¼“å­˜ï¼Œæ¯å¤©åªèƒ½è¯·æ±‚2000æ¬¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            template.<span style="color:#007f7f">opsForValue</span>().<span style="color:#007f7f">set</span>(<span style="color:#0ff;font-weight:bold">&#34;wx_jsapi_ticket&#34;</span>,ticket,<span style="color:#ff0;font-weight:bold">2</span>, TimeUnit.<span style="color:#007f7f">HOURS</span>);
</span></span><span style="display:flex;"><span>            is.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ticket;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è·å–urlå¹¶è¿›è¡Œç­¾å">è·å–urlï¼Œå¹¶è¿›è¡Œç­¾å<a hidden class="anchor" aria-hidden="true" href="#è·å–urlå¹¶è¿›è¡Œç­¾å">#</a></h3>
<p>urlçš„è·å–è¦ç‰¹åˆ«æ³¨æ„ï¼Œå› ä¸ºå¾®ä¿¡åœ¨åˆ†äº«æ—¶ä¼šåœ¨åŸæ¥çš„urlä¸ŠåŠ ä¸Šä¸€äº›<code>&amp;from=singlemessageã€&amp;from=â€¦</code>çš„ï¼Œæ‰€ä»¥urlå¿…é¡»è¦åŠ¨æ€è·å–ï¼Œç½‘ä¸Šæœ‰äº›ç”¨ajaxï¼Œåœ¨ç½‘é¡µé€šè¿‡â€œlocation.href.split(â€˜#â€™)â€œ è·å–urlï¼Œåœ¨ç”¨ajaxä¼ ç»™åå°ï¼Œè¿™ç§æ–¹æ³•å¯è¡Œï¼Œä½†æ˜¯ä¸æ¨èï¼Œä¸€æ–¹é¢ç”¨ajaxè¿”å›ï¼Œå°±è¦è®¿é—®åˆ†äº«çš„é€»è¾‘ï¼Œè¿™æ ·åå°åˆ†äº«çš„é€»è¾‘å¢åŠ å¤æ‚åº¦ï¼Œå¸¦æ¥ä¸ä¾¿ï¼Œæ˜¯ä»£ç ä¸æ˜“äºç»´æŠ¤ï¼Œå¯è¯»æ€§ä½ï¼å¦ä¸€æ–¹é¢åˆ†äº«æ˜¯è¿”å›é¡µé¢ï¼Œè€Œajaxæ˜¯è¿”å›jsonï¼Œåˆå¢åŠ äº†å¤æ‚åº¦ã€‚æ‰€ä»¥ï¼Œä¸€ä¸ªjavaç¨‹åºå‘˜æ˜¯ä¸ä¼šé€šè¿‡ajaxä»å‰å°è·å–urlçš„ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨HttpRequestçš„æ–¹æ³•å³å¯ï¼Œä¸ç®¡å¾®ä¿¡åŠ å¤šå°‘åç¼€ï¼Œéƒ½å¯ä»¥è·å–åˆ°å®Œæ•´çš„å½“å‰urlã€‚</p>
<p>è·å–urlçš„controllerå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@PostMapping(&#34;/share&#34;)
</span></span><span style="display:flex;"><span>public ResponseUtil getQuestionList(@RequestBody Map&lt;String,String&gt; paramMap){
</span></span><span style="display:flex;"><span>	LOGGER.info(
</span></span><span style="display:flex;"><span>	&#34;\n***************************************&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>			&#34;start share&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>			&#34;åˆ†äº«&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>			&#34;\n********************************************&#34;
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	ResponseUtil response = ResponseUtil.success();
</span></span><span style="display:flex;"><span>	CodeEnum code = CodeEnum.FAIL;
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;å‰ç«¯ä¼ è¿‡æ¥çš„&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;ï¼š&#34; + paramMap.get(&#34;strUrl&#34;));
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;URIè§£ç &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;ï¼š&#34; + URI.create(paramMap.get(&#34;strUrl&#34;)).getPath());
</span></span><span style="display:flex;"><span>		response.setData(wxUtil.getWxEntity(URI.create(paramMap.get(&#34;strUrl&#34;)).getPath(),redisTemplate));
</span></span><span style="display:flex;"><span>	} catch (Exception e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		response.setCode(code);
</span></span><span style="display:flex;"><span>		response.setMessage(e.getMessage());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return response;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>éœ€è¦æ³¨æ„ï¼šè¿™ä¸ªurlæ˜¯å‰ç«¯åŠ¨æ€è·å–çš„ï¼Œä¸èƒ½å†™æ­»ã€‚å¦‚æœå¸¦å‚æ•°ï¼Œæˆ–æ˜¯ä¸­æ–‡ï¼Œå‰ç«¯è¦å¯¹urlåš<code>encodeURIComponent</code>è½¬ç ï¼Œåå°å†ä½¿ç”¨<code>URI.create(paramMap.get(&quot;strUrl&quot;)).getPath()</code>è¿›è¡Œè§£ç ã€‚</p>
<p>æˆ‘ä»¬å†æ–°å»ºä¸€ä¸ªå­˜æ”¾å¾®ä¿¡ä¿¡æ¯çš„å®ä½“ç±»ï¼šwx.java</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> wx {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String access_token;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String ticket ;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String noncestr;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String timestamp;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String str;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String signature;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   ...<span style="color:#007f7f">setter</span> and getter...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>signç±»é‡Œé¢æœ‰ä¸€ä¸ªç­¾åçš„æ–¹æ³•<code>sign</code>ï¼Œä¼ å…¥ticketå’Œurlå³å¯ã€‚ä¹Ÿå°±æ˜¯WeinXinUtilçš„getWinXinEntityæ–¹æ³•ï¼Œå¹¶å°†è¿”å›çš„mapçš„ä¿¡æ¯è¯»å–å­˜å…¥WinXinEntityä¸­ã€‚
åœ¨è°ƒè¯•æ—¶ï¼ŒæŠŠsignè¿”å›çš„mapæ‰“å°å‡ºæ¥ï¼Œä¸»è¦çœ‹çœ‹ç”Ÿæˆçš„signatureã€‚ç„¶åï¼ŒæŠŠjsapi_ticketã€noncestrã€timestampã€url å¤åˆ¶åˆ°å¾®ä¿¡æä¾›çš„<a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign">å¾®ä¿¡ JS æ¥å£ç­¾åæ ¡éªŒå·¥å…·</a>ï¼Œ
æ¯”è¾ƒä»£ç ç­¾åç”Ÿæˆçš„signatureä¸æ ¡éªŒå·¥å…·ç”Ÿæˆçš„ç­¾åsignatureæ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œè¯´æ˜å‰é¢çš„æ­¥éª¤éƒ½æ˜¯æ­£ç¡®çš„ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œä»”ç»†æ£€æŸ¥ã€‚</p>
<h3 id="controller">controller<a hidden class="anchor" aria-hidden="true" href="#controller">#</a></h3>
<p>æˆ‘ä»¬æŠŠå¾®ä¿¡åˆ†äº«åˆ†è§£æˆ3ä¸ªå·¥å…·ç±»ï¼Œç°åœ¨åœ¨å¤„ç†åˆ†äº«çš„controllerï¼Œåªè¦ä¸¤å¥è¯å°±å¯ä»¥è°ƒç”¨å¾®ä¿¡åˆ†äº«ï¼Œä¸€å¥è·å–urlï¼Œä¸€å¥è·å–WinXinEntityï¼Œä»£ç å·²ç»åœ¨ä¸Šè¾¹ç»™å‡ºäº†ã€‚</p>
<h3 id="å‰ç«¯configå‡½æ•°é…ç½®">å‰ç«¯configå‡½æ•°é…ç½®<a hidden class="anchor" aria-hidden="true" href="#å‰ç«¯configå‡½æ•°é…ç½®">#</a></h3>
<p>ä¸‹é¢çš„ä»£ç æ”¾åœ¨ç½‘é¡µjsä»£ç çš„æœ€å‰é¢ï¼
â€var url = location.href.split(â€˜#â€™)[0];â€œ é¡µé¢çš„urlä¹Ÿå¯ä»¥ä»åå°ä¼ è¿‡æ¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡location.href.split(â€˜#â€™)[0]è·å–ã€‚
ä¸ºäº†ä¸€ç‚¹å¾®ä¸è¶³é“çš„é€Ÿåº¦ï¼Œè¿™é‡Œæ‰ç”¨ç½‘é¡µè·å–æ–¹å¼ã€‚ï¼ˆç½‘é¡µçš„urlè·Ÿå‰é¢çš„åå°ç­¾åæ—¶å¾—urlæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯ç»•è¿‡äº†ajaxï¼‰</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>&lt;script src=<span style="color:#0ff;font-weight:bold">&#34;http://res.wx.qq.com/open/js/jweixin-1.2.0.js&#34;</span>&gt;&lt;<span style="color:#f00">/script&gt;</span>
</span></span><span style="display:flex;"><span>&lt;script&gt;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">var</span> url = location.href.split(<span style="color:#0ff;font-weight:bold">&#39;#&#39;</span>)[<span style="color:#ff0;font-weight:bold">0</span>];
</span></span><span style="display:flex;"><span>    wx.config({
</span></span><span style="display:flex;"><span>    debug: <span style="color:#fff;font-weight:bold">false</span>,
</span></span><span style="display:flex;"><span>    appId: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxxxxxx&#39;</span>,
</span></span><span style="display:flex;"><span>    timestamp: <span style="color:#0ff;font-weight:bold">&#34;${wx.timestamp}&#34;</span>,
</span></span><span style="display:flex;"><span>    nonceStr: <span style="color:#0ff;font-weight:bold">&#34;${wx.noncestr}&#34;</span>,
</span></span><span style="display:flex;"><span>    signature: <span style="color:#0ff;font-weight:bold">&#34;${wx.signature}&#34;</span>,
</span></span><span style="display:flex;"><span>    jsApiList: [
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">// æ‰€æœ‰è¦è°ƒç”¨çš„ API éƒ½è¦åŠ åˆ°è¿™ä¸ªåˆ—è¡¨ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>       <span style="color:#0ff;font-weight:bold">&#39;checkJsApi&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#0ff;font-weight:bold">&#39;onMenuShareTimeline&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#0ff;font-weight:bold">&#39;onMenuShareAppMessage&#39;</span>,
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  wx.ready(<span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åœ¨è¿™é‡Œè°ƒç”¨ API
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>     wx.onMenuShareTimeline({
</span></span><span style="display:flex;"><span>    title: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxx&#39;</span>, <span style="color:#007f7f">// åˆ†äº«æ ‡é¢˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    link: url, <span style="color:#007f7f">// åˆ†äº«é“¾æ¥ï¼Œè¯¥é“¾æ¥åŸŸåæˆ–è·¯å¾„å¿…é¡»ä¸å½“å‰é¡µé¢å¯¹åº”çš„å…¬ä¼—å·JSå®‰å…¨åŸŸåä¸€è‡´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    imgUrl: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxxxxxx&#39;</span>, <span style="color:#007f7f">// åˆ†äº«å›¾æ ‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    success: <span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç”¨æˆ·ç¡®è®¤åˆ†äº«åæ‰§è¡Œçš„å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    },
</span></span><span style="display:flex;"><span>    cancel: <span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç”¨æˆ·å–æ¶ˆåˆ†äº«åæ‰§è¡Œçš„å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>wx.onMenuShareAppMessage({
</span></span><span style="display:flex;"><span>   title: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxxx&#39;</span>, <span style="color:#007f7f">// åˆ†äº«æ ‡é¢˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    desc: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxxx&#39;</span>, <span style="color:#007f7f">// åˆ†äº«æè¿°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    link: url, <span style="color:#007f7f">// åˆ†äº«é“¾æ¥ï¼Œè¯¥é“¾æ¥åŸŸåæˆ–è·¯å¾„å¿…é¡»ä¸å½“å‰é¡µé¢å¯¹åº”çš„å…¬ä¼—å·JSå®‰å…¨åŸŸåä¸€è‡´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    imgUrl: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxx&#39;</span>, <span style="color:#007f7f">// åˆ†äº«å›¾æ ‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    type: <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>, <span style="color:#007f7f">// åˆ†äº«ç±»å‹,musicã€videoæˆ–linkï¼Œä¸å¡«é»˜è®¤ä¸ºlink
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    dataUrl: <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>, <span style="color:#007f7f">// å¦‚æœtypeæ˜¯musicæˆ–videoï¼Œåˆ™è¦æä¾›æ•°æ®é“¾æ¥ï¼Œé»˜è®¤ä¸ºç©º
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    success: <span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç”¨æˆ·ç¡®è®¤åˆ†äº«åæ‰§è¡Œçš„å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    },
</span></span><span style="display:flex;"><span>    cancel: <span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç”¨æˆ·å–æ¶ˆåˆ†äº«åæ‰§è¡Œçš„å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f00">/script&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="åˆ†äº«é“¾æ¥å¸¦å‚æ•°çš„æƒ…å†µ">åˆ†äº«é“¾æ¥å¸¦å‚æ•°çš„æƒ…å†µ<a hidden class="anchor" aria-hidden="true" href="#åˆ†äº«é“¾æ¥å¸¦å‚æ•°çš„æƒ…å†µ">#</a></h3>
<p>å‰ç«¯çš„é“¾æ¥å¦‚æœå¸¦å‚æ•°ï¼Œ<code>www.xxx.com/xxx?a=1&amp;b=2</code>ï¼Œä¼ ç»™åå°å¿…é¡»ä½¿ç”¨<code>encodeURIComponent</code>è½¬ç ï¼Œ<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141115">å‚è€ƒå®˜æ–¹æ–‡æ¡£</a>ï¼Œ
ä½†æ˜¯å®˜æ–¹æ–‡æ¡£å¹¶æ²¡æœ‰è¯´ï¼Œåå°è¦æŠŠå‰ç«¯ä¼ çš„urlå†è§£ç ï¼å³ï¼š
<code>URI.create(paramMap.get(&quot;strUrl&quot;)).getPath()</code>
ä¸è¦ä½¿ç”¨<code>URLDecoder.decode(paramMap.get(&quot;strUrl&quot;))</code>ï¼Œè¯¥æ–¹æ³•å°†è¦è¢«åºŸå¼ƒã€‚</p>
<p>ä¸å¸¦å‚æ•°å¯ä»¥ä¸è½¬ç ï¼Œè‹¥å¸¦å‚æ•°å¿…é¡»è½¬ç ï¼Œåå°å†è§£ç ï¼ï¼
<a href="https://www.cnblogs.com/vipstone/p/6732660.html">å‚è€ƒåœ°å€</a></p>
<h2 id="å¾®ä¿¡å°ç¨‹åºç™»å½•">å¾®ä¿¡å°ç¨‹åºç™»å½•<a hidden class="anchor" aria-hidden="true" href="#å¾®ä¿¡å°ç¨‹åºç™»å½•">#</a></h2>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">å®˜æ–¹æ–‡æ¡£</a>
ç™»å½•æµç¨‹æ—¶åºå›¾
<img loading="lazy" src="3.jpg" alt=""  />

å¾®ä¿¡çš„æ–‡æ¡£å†™çš„åƒç‹—å±ï¼Œæ‰€ä»¥æˆ‘æŠ„äº†ä¸€ä»½æ—¶åºå›¾ï¼š
<img loading="lazy" src="4.jpg" alt=""  />
</p>
<p>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç¨‹åºå®¢æˆ·ç«¯è°ƒç”¨wx.loginï¼Œå›è°ƒé‡Œé¢åŒ…å«js_codeã€‚</li>
<li>ç„¶åå°†js_codeå‘é€åˆ°æœåŠ¡å™¨Aï¼ˆå¼€å‘è€…æœåŠ¡å™¨ï¼‰,æœåŠ¡å™¨Aå‘å¾®ä¿¡æœåŠ¡å™¨å‘èµ·è¯·æ±‚é™„å¸¦js_codeã€appIdã€secretkeyå’Œgrant_typeå‚æ•°ï¼Œä»¥æ¢å–ç”¨æˆ·çš„openidå’Œsession_keyï¼ˆä¼šè¯å¯†é’¥ï¼‰ã€‚</li>
<li>æœåŠ¡å™¨Aæ‹¿åˆ°session_keyåï¼Œç”Ÿæˆä¸€ä¸ªéšæœºæ•°æˆ‘ä»¬å«3rd_session,ä»¥3rdSessionIdä¸ºkey,ä»¥session_key + openidä¸ºvalueç¼“å­˜åˆ°redisæˆ–memcachedä¸­ï¼›å› ä¸ºå¾®ä¿¡å›¢é˜Ÿä¸å»ºè®®ç›´æ¥å°†session_keyåœ¨ç½‘ç»œä¸Šä¼ è¾“ï¼Œç”±å¼€å‘è€…è‡ªè¡Œç”Ÿæˆå”¯ä¸€é”®ä¸session_keyå…³è”ã€‚å…¶ä½œç”¨æ˜¯ï¼š
<ul>
<li>å°†3rdSessionIdè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œç»´æŠ¤å°ç¨‹åºç™»å½•æ€ã€‚</li>
<li>é€šè¿‡3rdSessionIdæ‰¾åˆ°ç”¨æˆ·session_keyå’Œopenidã€‚</li>
</ul>
</li>
<li>å®¢æˆ·ç«¯æ‹¿åˆ°3rdSessionIdåç¼“å­˜åˆ°storageã€‚</li>
<li>å®¢æˆ·ç«¯é€šè¿‡wx.getUserIinfoå¯ä»¥è·å–åˆ°ç”¨æˆ·æ•æ„Ÿæ•°æ®encryptedDataã€‚</li>
<li>å®¢æˆ·ç«¯å°†encryptedDataã€3rdSessionIdå’Œåç§»é‡ä¸€èµ·å‘é€åˆ°æœåŠ¡å™¨A</li>
<li>æœåŠ¡å™¨Aæ ¹æ®3rdSessionIdä»ç¼“å­˜ä¸­è·å–session_key</li>
<li>åœ¨æœåŠ¡å™¨Aä½¿ç”¨AESè§£å¯†encryptedDataï¼Œä»è€Œå®ç°ç”¨æˆ·æ•æ„Ÿæ•°æ®è§£å¯†</li>
</ul>
<p>é‡ç‚¹åœ¨6ã€7ã€8ä¸‰ä¸ªç¯èŠ‚ã€‚
AESè§£å¯†ä¸‰ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>å¯†æ–‡ encryptedData</li>
<li>å¯†é’¥ aesKey</li>
<li>åç§»å‘é‡ iv</li>
</ul>
<p>æœåŠ¡ç«¯è§£å¯†æµç¨‹ï¼š</p>
<ul>
<li>å¯†æ–‡å’Œåç§»å‘é‡ç”±å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡ç«¯ï¼Œå¯¹è¿™ä¸¤ä¸ªå‚æ•°åœ¨æœåŠ¡ç«¯è¿›è¡ŒBase64_decodeè§£ç¼–ç æ“ä½œã€‚</li>
<li>æ ¹æ®3rdSessionIdä»ç¼“å­˜ä¸­è·å–session_keyï¼Œå¯¹session_keyè¿›è¡ŒBase64_decodeå¯ä»¥å¾—åˆ°aesKeyï¼Œaeså¯†é’¥ã€‚</li>
<li>è°ƒç”¨aesè§£å¯†æ–¹æ³•ï¼Œç®—æ³•ä¸º AES-128-CBCï¼Œæ•°æ®é‡‡ç”¨PKCS#7å¡«å……ã€‚</li>
</ul>
<p>ä¸‹é¢ç»“åˆå°ç¨‹åºå®ä¾‹è¯´æ˜è§£å¯†æµç¨‹ï¼š</p>
<ol>
<li>å¾®ä¿¡ç™»å½•ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">var</span> that = <span style="color:#fff;font-weight:bold">this</span>;
</span></span><span style="display:flex;"><span>wx.login({
</span></span><span style="display:flex;"><span>success: <span style="color:#fff;font-weight:bold">function</span> (res) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å¾®ä¿¡js_code
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    that.setData({wxcode: res.code});
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è·å–ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    wx.getUserInfo({
</span></span><span style="display:flex;"><span>        success: <span style="color:#fff;font-weight:bold">function</span> (res) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è·å–ç”¨æˆ·æ•æ„Ÿæ•°æ®å¯†æ–‡å’Œåç§»å‘é‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            that.setData({encryptedData: res.encryptedData})
</span></span><span style="display:flex;"><span>            that.setData({iv: res.iv})
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>ä½¿ç”¨codeæ¢å–3rdSessionId</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">var</span> httpclient = require(<span style="color:#0ff;font-weight:bold">&#39;../../utils/httpclient.js&#39;</span>)
</span></span><span style="display:flex;"><span>VAR that = <span style="color:#fff;font-weight:bold">this</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//httpclient.req(url, data, method, success, fail)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>httpclient.req(
</span></span><span style="display:flex;"><span>  <span style="color:#0ff;font-weight:bold">&#39;http://localhost:8090/wxappservice/api/v1/wx/getSession&#39;</span>,
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      apiName: <span style="color:#0ff;font-weight:bold">&#39;WX_CODE&#39;</span>,
</span></span><span style="display:flex;"><span>      code: <span style="color:#fff;font-weight:bold">this</span>.data.wxcode
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#0ff;font-weight:bold">&#39;GET&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">function</span>(result){
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">var</span> thirdSessionId = result.data.data.sessionId;
</span></span><span style="display:flex;"><span>    that.setData({thirdSessionId: thirdSessionId})
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å°†thirdSessionIdæ”¾å…¥å°ç¨‹åºç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    wx.setStorageSync(<span style="color:#0ff;font-weight:bold">&#39;thirdSessionId&#39;</span>, thirdSessionId)
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">function</span>(result){
</span></span><span style="display:flex;"><span>    console.log(result)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>å‘èµ·è§£å¯†è¯·æ±‚</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#007f7f">//httpclient.req(url, data, method, success, fail)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>httpclient.req(
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#39;http://localhost:8090/wxappservice/api/v1/wx/decodeUserInfo&#39;</span>,
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    apiName: <span style="color:#0ff;font-weight:bold">&#39;WX_DECODE_USERINFO&#39;</span>,
</span></span><span style="display:flex;"><span>    encryptedData: <span style="color:#fff;font-weight:bold">this</span>.data.encryptedData,
</span></span><span style="display:flex;"><span>    iv: <span style="color:#fff;font-weight:bold">this</span>.data.iv,
</span></span><span style="display:flex;"><span>    sessionId: wx.getStorageSync(<span style="color:#0ff;font-weight:bold">&#39;thirdSessionId&#39;</span>)
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#0ff;font-weight:bold">&#39;GET&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">function</span>(result){
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f">//è§£å¯†åçš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    console.log(result.data)
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">function</span>(result){
</span></span><span style="display:flex;"><span>    console.log(result)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>é€šè¿‡å‰ç«¯è·å–çš„codeï¼Œè·å–openidå’Œsession_key</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * @author: wjy
</span></span><span style="display:flex;"><span> * @description: å°ç¨‹åºï¼Œé€šè¿‡codeè·å–session_keyå’Œopenid
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@PostMapping(&#34;getSessionId&#34;)
</span></span><span style="display:flex;"><span>public ResponseUtil getSessionId(@RequestBody Map&lt;String,String&gt; paramMap){
</span></span><span style="display:flex;"><span>	LOGGER.info(
</span></span><span style="display:flex;"><span>			&#34;\n***************************************&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;start getSessionId&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;é€šè¿‡codeè·å–session_keyå’Œopenid&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;paramMap&#34; + paramMap +&#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;\n********************************************&#34;
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	ResponseUtil response = ResponseUtil.success();
</span></span><span style="display:flex;"><span>	CodeEnum code = CodeEnum.FAIL;
</span></span><span style="display:flex;"><span>	JSONObject jsonObject;
</span></span><span style="display:flex;"><span>	try{
</span></span><span style="display:flex;"><span>		AssertUtil.assertValidate(code,CodeEnum.ERROR_2001.getCode(),&#34;codeä¸èƒ½ä¸ºç©º&#34;,StringUtils.isNotEmpty(paramMap.get(&#34;code&#34;)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//å®Œæ•´åœ°å€ç¤ºä¾‹
</span></span><span style="display:flex;"><span>		//https://api.weixin.qq.com/sns/jscode2session?appid=APPID&amp;secret=SECRET&amp;js_code=JSCODE&amp;grant_type=authorization_code
</span></span><span style="display:flex;"><span>		String url = &#34;https://api.weixin.qq.com/sns/jscode2session&#34;;
</span></span><span style="display:flex;"><span>		String param =
</span></span><span style="display:flex;"><span>				&#34;appid=&#34; + PayConstant.XCX_APPID +
</span></span><span style="display:flex;"><span>				&#34;&amp;secret=&#34; + PayConstant.XCX_APPSECRET +
</span></span><span style="display:flex;"><span>				&#34;&amp;js_code=&#34; + paramMap.get(&#34;code&#34;) +
</span></span><span style="display:flex;"><span>				&#34;&amp;grant_type=authorization_code&#34;;
</span></span><span style="display:flex;"><span>		//å‘å¾®ä¿¡æœåŠ¡å™¨å‘é€getè¯·æ±‚,è·å–session_keyå’Œopenid
</span></span><span style="display:flex;"><span>		String sessionKeyAndOpenid = HttpUtil.sendGet(url, param);
</span></span><span style="display:flex;"><span>		jsonObject = JSONObject.parseObject(sessionKeyAndOpenid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		String uuid = UUID.randomUUID().toString().replaceAll(&#34;-&#34;,&#34;&#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;session_keyæ˜¯ï¼š~~~~~~~~~~~~~~~~&#34; + jsonObject.getString(&#34;session_key&#34;));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//å°†è·å–åˆ°çš„session_keyå­˜å…¥redisï¼Œè¿™é‡Œä¸ç”¨è®¾ç½®è¿‡æœŸæ—¶é—´
</span></span><span style="display:flex;"><span>		stringRedisTemplate.opsForValue().set(uuid,jsonObject.getString(&#34;session_key&#34;));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//æŠŠuuidè¿”å›ç»™å‰ç«¯
</span></span><span style="display:flex;"><span>		response.setData(uuid);
</span></span><span style="display:flex;"><span>	}catch (Exception e){
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		response.setCode(code);
</span></span><span style="display:flex;"><span>		response.setMessage(e.getMessage());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return response;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>åç«¯ç”¨session_keyï¼ŒencryptedDataï¼Œivè§£å¯†è·å–ç”¨æˆ·ä¿¡æ¯userinfoã€‚
åç«¯è§£å¯†å…¶å®å°±è¿™ä¹ˆç®€å•ï¼Œåªè¦æµç¨‹å¯¹äº†å°±å¯ä»¥è§£å¯†ï¼Œå¦‚æœè§£å¯†å‡ºé”™ï¼ŒåŸºæœ¬å°±æ˜¯æµç¨‹å‡ºé”™äº†ã€‚ä¸ç”¨å†å»æ¢ä»€ä¹ˆè§£å¯†ç®—æ³•ã€‚</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public Object getPhoneNumber(String encryptedData, String session_key, String iv) {
</span></span><span style="display:flex;"><span>		 // è¢«åŠ å¯†çš„æ•°æ®
</span></span><span style="display:flex;"><span>		byte[] dataByte = Base64.decode(encryptedData);
</span></span><span style="display:flex;"><span>		// åŠ å¯†ç§˜é’¥
</span></span><span style="display:flex;"><span>		byte[] keyByte = Base64.decode(session_key);
</span></span><span style="display:flex;"><span>		// åç§»é‡
</span></span><span style="display:flex;"><span>		byte[] ivByte = Base64.decode(iv);
</span></span><span style="display:flex;"><span>		try {
</span></span><span style="display:flex;"><span>			// å¦‚æœå¯†é’¥ä¸è¶³16ä½ï¼Œé‚£ä¹ˆå°±è¡¥è¶³.  è¿™ä¸ªif ä¸­çš„å†…å®¹å¾ˆé‡è¦
</span></span><span style="display:flex;"><span>			int base = 16;
</span></span><span style="display:flex;"><span>			if (keyByte.length % base != 0) {
</span></span><span style="display:flex;"><span>				int groups = keyByte.length / base + (keyByte.length % base != 0 ? 1 : 0);
</span></span><span style="display:flex;"><span>				byte[] temp = new byte[groups * base];
</span></span><span style="display:flex;"><span>				Arrays.fill(temp, (byte) 0);
</span></span><span style="display:flex;"><span>				System.arraycopy(keyByte, 0, temp, 0, keyByte.length);
</span></span><span style="display:flex;"><span>				keyByte = temp;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			// åˆå§‹åŒ–
</span></span><span style="display:flex;"><span>			Security.addProvider(new BouncyCastleProvider());
</span></span><span style="display:flex;"><span>			Cipher cipher = Cipher.getInstance(&#34;AES/CBC/PKCS5Padding&#34;);
</span></span><span style="display:flex;"><span>			SecretKeySpec spec = new SecretKeySpec(keyByte, &#34;AES&#34;);
</span></span><span style="display:flex;"><span>			AlgorithmParameters parameters = AlgorithmParameters.getInstance(&#34;AES&#34;);
</span></span><span style="display:flex;"><span>			parameters.init(new IvParameterSpec(ivByte));
</span></span><span style="display:flex;"><span>			cipher.init(Cipher.DECRYPT_MODE, spec, parameters);// åˆå§‹åŒ–
</span></span><span style="display:flex;"><span>			byte[] resultByte = cipher.doFinal(dataByte);
</span></span><span style="display:flex;"><span>			if (null != resultByte &amp;&amp; resultByte.length &gt; 0) {
</span></span><span style="display:flex;"><span>				String result = new String(resultByte, &#34;UTF-8&#34;);
</span></span><span style="display:flex;"><span>				return JSONObject.parseObject(result);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		} catch (Exception e) {
</span></span><span style="display:flex;"><span>			e.printStackTrace();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	return null;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¾¹åˆ†åˆ«è¯·æ±‚äº†ä¸¤æ¬¡åå°æ¥å£ï¼Œå…¶å®å®Œå…¨å¯ä»¥åˆå¹¶æˆä¸€æ¬¡è¯·æ±‚ï¼Œå‚è€ƒä¸‹è¾¹è·å–æ‰‹æœºå·çš„å†…å®¹ã€‚</p>
<p><a href="https://www.cnblogs.com/cangqinglang/p/8944681.html">å‚è€ƒ1</a>
<a href="https://blog.csdn.net/qi923701/article/details/81534820">å‚è€ƒ2</a>
<a href="https://blog.csdn.net/weixin_38429587/article/details/82814325">å‚è€ƒ3</a></p>
<h2 id="å°ç¨‹åºè·å–æ‰‹æœºå·">å°ç¨‹åºè·å–æ‰‹æœºå·<a hidden class="anchor" aria-hidden="true" href="#å°ç¨‹åºè·å–æ‰‹æœºå·">#</a></h2>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html">å®˜æ–¹æ–‡æ¡£</a></p>
<ol>
<li>å‰ç«¯è°ƒç”¨ wx.login() è·å–code</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>wx.login({
</span></span><span style="display:flex;"><span>    success:function(res){
</span></span><span style="display:flex;"><span>        console.log(&#39;loginCode:&#39;, res.code)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>åç«¯æ‹¿åˆ°è¯¥codeå‘é€getè¯·æ±‚å¾®ä¿¡æ¥å£è·å– session_keyå’Œopenidï¼Œè¿”å›ç»“æœç±»ä¼¼ï¼š</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	&#34;session_key&#34;: &#34;kI+3ookOAYC9olOcGzYPmQ&#34;,
</span></span><span style="display:flex;"><span>	&#34;openid&#34;: &#34;oNZE65Pu0XfTg2yFP-dFks&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åå°æ‹¿åˆ°æ•°æ®åï¼Œæˆ‘ä»¬æŠŠsession_keyå­˜åˆ°redisï¼Œç„¶åæŠŠsession_keyå­˜åœ¨redisä¸­çš„keyè¿”å›ç»™å‰ç«¯ã€‚å› ä¸ºå¾®ä¿¡å®˜æ–¹è¯´ï¼š
<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">ä¸ºäº†åº”ç”¨è‡ªèº«çš„æ•°æ®å®‰å…¨ï¼Œå¼€å‘è€…æœåŠ¡å™¨ä¸åº”è¯¥æŠŠä¼šè¯å¯†é’¥ä¸‹å‘åˆ°å°ç¨‹åºï¼Œä¹Ÿä¸åº”è¯¥å¯¹å¤–æä¾›è¿™ä¸ªå¯†é’¥</a></p>
<ol start="3">
<li>å‰ç«¯è°ƒç”¨ getPhoneNumberç»„ä»¶ï¼Œç”¨æˆ·ç¡®è®¤æˆæƒã€‚æ‹¿åˆ°encryptedDataå’Œivã€‚å¹¶ä¼ ç»™åç«¯ã€‚
<code>&lt;button open-type=&quot;getPhoneNumber&quot; bindgetphonenumber=&quot;getPhoneNumber&quot;&gt; &lt;/button&gt;</code></li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>getPhoneNumber: function(e) { 
</span></span><span style="display:flex;"><span>    console.log(e.detail.errMsg) 
</span></span><span style="display:flex;"><span>    console.log(e.detail.iv) 
</span></span><span style="display:flex;"><span>    console.log(e.detail.encryptedData) 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>åç«¯ç”¨session_keyï¼ŒencryptedDataï¼Œivè§£å¯†è·å–æ‰‹æœºå·ã€‚
åç«¯è§£å¯†å…¶å®å°±è¿™ä¹ˆç®€å•ï¼Œåªè¦æµç¨‹å¯¹äº†å°±å¯ä»¥è§£å¯†ï¼Œå¦‚æœè§£å¯†å‡ºé”™ï¼ŒåŸºæœ¬å°±æ˜¯æµç¨‹å‡ºé”™äº†ã€‚ä¸ç”¨å†å»æ¢ä»€ä¹ˆè§£å¯†ç®—æ³•ã€‚</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public Object getPhoneNumber(String encryptedData, String session_key, String iv) {
</span></span><span style="display:flex;"><span>		 // è¢«åŠ å¯†çš„æ•°æ®
</span></span><span style="display:flex;"><span>		byte[] dataByte = Base64.decode(encryptedData);
</span></span><span style="display:flex;"><span>		// åŠ å¯†ç§˜é’¥
</span></span><span style="display:flex;"><span>		byte[] keyByte = Base64.decode(session_key);
</span></span><span style="display:flex;"><span>		// åç§»é‡
</span></span><span style="display:flex;"><span>		byte[] ivByte = Base64.decode(iv);
</span></span><span style="display:flex;"><span>		try {
</span></span><span style="display:flex;"><span>			// å¦‚æœå¯†é’¥ä¸è¶³16ä½ï¼Œé‚£ä¹ˆå°±è¡¥è¶³.  è¿™ä¸ªif ä¸­çš„å†…å®¹å¾ˆé‡è¦
</span></span><span style="display:flex;"><span>			int base = 16;
</span></span><span style="display:flex;"><span>			if (keyByte.length % base != 0) {
</span></span><span style="display:flex;"><span>				int groups = keyByte.length / base + (keyByte.length % base != 0 ? 1 : 0);
</span></span><span style="display:flex;"><span>				byte[] temp = new byte[groups * base];
</span></span><span style="display:flex;"><span>				Arrays.fill(temp, (byte) 0);
</span></span><span style="display:flex;"><span>				System.arraycopy(keyByte, 0, temp, 0, keyByte.length);
</span></span><span style="display:flex;"><span>				keyByte = temp;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			// åˆå§‹åŒ–
</span></span><span style="display:flex;"><span>			Security.addProvider(new BouncyCastleProvider());
</span></span><span style="display:flex;"><span>			Cipher cipher = Cipher.getInstance(&#34;AES/CBC/PKCS5Padding&#34;);
</span></span><span style="display:flex;"><span>			SecretKeySpec spec = new SecretKeySpec(keyByte, &#34;AES&#34;);
</span></span><span style="display:flex;"><span>			AlgorithmParameters parameters = AlgorithmParameters.getInstance(&#34;AES&#34;);
</span></span><span style="display:flex;"><span>			parameters.init(new IvParameterSpec(ivByte));
</span></span><span style="display:flex;"><span>			cipher.init(Cipher.DECRYPT_MODE, spec, parameters);// åˆå§‹åŒ–
</span></span><span style="display:flex;"><span>			byte[] resultByte = cipher.doFinal(dataByte);
</span></span><span style="display:flex;"><span>			if (null != resultByte &amp;&amp; resultByte.length &gt; 0) {
</span></span><span style="display:flex;"><span>				String result = new String(resultByte, &#34;UTF-8&#34;);
</span></span><span style="display:flex;"><span>				return JSONObject.parseObject(result);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		} catch (Exception e) {
</span></span><span style="display:flex;"><span>			e.printStackTrace();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	return null;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¾¹æ˜¯è¯·æ±‚äº†ä¸¤æ¬¡æ¥å£ï¼Œå…¶å®å®Œå…¨å¯ä»¥åªè¯·æ±‚ä¸€æ¬¡æ¥å£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * @author: wjy
</span></span><span style="display:flex;"><span> * @description: å°ç¨‹åºç™»å½•ï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@PostMapping(&#34;xcxRegisterOrLogin&#34;)
</span></span><span style="display:flex;"><span>public ResponseUtil xcxRegisterOrLogin(@RequestBody Map&lt;String,String&gt; paramMap){
</span></span><span style="display:flex;"><span>	LOGGER.info(
</span></span><span style="display:flex;"><span>			&#34;\n***************************************&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;start xcxRegisterOrLogin&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;å°ç¨‹åºç™»å½•ï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;paramMap&#34; + paramMap +&#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;\n********************************************&#34;
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	ResponseUtil response = ResponseUtil.success();
</span></span><span style="display:flex;"><span>	CodeEnum code = CodeEnum.FAIL;
</span></span><span style="display:flex;"><span>	JSONObject jsonObject;
</span></span><span style="display:flex;"><span>	try{
</span></span><span style="display:flex;"><span>		AssertUtil.assertValidate(code,CodeEnum.ERROR_2001.getCode(),&#34;ivä¸èƒ½ä¸ºç©º&#34;,StringUtils.isNotEmpty(paramMap.get(&#34;iv&#34;)));
</span></span><span style="display:flex;"><span>		AssertUtil.assertValidate(code,CodeEnum.ERROR_2001.getCode(),&#34;codeä¸èƒ½ä¸ºç©º&#34;,StringUtils.isNotEmpty(paramMap.get(&#34;code&#34;)));
</span></span><span style="display:flex;"><span>		AssertUtil.assertValidate(code,CodeEnum.ERROR_2003.getCode(),&#34;encryptedDataä¸èƒ½ä¸ºç©º&#34;,StringUtils.isNotEmpty(paramMap.get(&#34;encryptedData&#34;)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//å®Œæ•´åœ°å€ç¤ºä¾‹
</span></span><span style="display:flex;"><span>		//https://api.weixin.qq.com/sns/jscode2session?appid=APPID&amp;secret=SECRET&amp;js_code=JSCODE&amp;grant_type=authorization_code
</span></span><span style="display:flex;"><span>		String url = &#34;https://api.weixin.qq.com/sns/jscode2session&#34;;
</span></span><span style="display:flex;"><span>		String param = &#34;appid=&#34; + PayConstant.XCX_APPID +
</span></span><span style="display:flex;"><span>				&#34;&amp;secret=&#34; + PayConstant.XCX_APPSECRET +
</span></span><span style="display:flex;"><span>				&#34;&amp;js_code=&#34; + paramMap.get(&#34;code&#34;) +
</span></span><span style="display:flex;"><span>				&#34;&amp;grant_type=authorization_code&#34;;
</span></span><span style="display:flex;"><span>		//å‘å¾®ä¿¡æœåŠ¡å™¨å‘é€getè¯·æ±‚,è·å–session_keyå’Œopenid
</span></span><span style="display:flex;"><span>		String wxReturnJson = HttpUtil.sendGet(url, param);
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;å¾®ä¿¡è¿”å›ç»“æœæ˜¯ï¼š~~~~~~~~~~~~~~~~&#34; + wxReturnJson);
</span></span><span style="display:flex;"><span>		jsonObject = JSONObject.parseObject(wxReturnJson);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//è§£å¯†ç”¨æˆ·ä¿¡æ¯
</span></span><span style="display:flex;"><span>		JSONObject userinfo = XcxUtil.decodeUserInfo(paramMap.get(&#34;encryptedData&#34;),jsonObject.getString(&#34;session_key&#34;),paramMap.get(&#34;iv&#34;));
</span></span><span style="display:flex;"><span>		//ç”¨æˆ·æ‰‹æœºå·
</span></span><span style="display:flex;"><span>		String phoneNum = userinfo.getString(&#34;purePhoneNumber&#34;);
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;ç”¨æˆ·æ‰‹æœºå·æ˜¯ï¼š~~~~~~~~~~~~~~~~&#34; + phoneNum);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		paramMap.put(&#34;mobile&#34;,phoneNum);
</span></span><span style="display:flex;"><span>		//æ ¹æ®æ‰‹æœºå·ï¼Œæ³¨å†Œæˆ–ç™»å½•
</span></span><span style="display:flex;"><span>		response = usersService.registerOrLogin(paramMap,response);
</span></span><span style="display:flex;"><span>	}catch (Exception e){
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		response.setCode(code);
</span></span><span style="display:flex;"><span>		response.setMessage(e.getMessage());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return response;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªæ¥å£ï¼Œæˆ‘æ¥æ”¶äº†codeã€ivã€encryptedDataä¸‰ä¸ªå‚æ•°ã€‚
å…¶ä¸­codeæ˜¯å‰ç«¯è¯·æ±‚<code>wx.login()</code>è¿”å›çš„ï¼Œ<code>ivã€encryptedData</code>æ˜¯å‰ç«¯è¯·æ±‚<code>wx.userinfo()</code>è¿”å›çš„ã€‚
æˆ‘çš„æ¥å£ä¸­ï¼Œå…ˆé€šè¿‡codeè¯·æ±‚å¾®ä¿¡æœåŠ¡å™¨ï¼Œè·å–<code>session_key</code>å’Œ<code>openid</code>ï¼Œç„¶åé€šè¿‡<code>session_keyã€ivã€encryptedData</code>è¿›è¡Œè§£å¯†ï¼Œå°±å¾—åˆ°äº†ç”¨æˆ·æ‰‹æœºå·ã€‚
åç»­æ˜¯è‡ªå·±ä¸šåŠ¡çš„é€»è¾‘ï¼Œå³é€šè¿‡æ‰‹æœºå·åˆ¤æ–­è‡ªå·±çš„æ•°æ®åº“æ˜¯å¦æœ‰è¿™ä¸ªç”¨æˆ·ï¼Œæœ‰-&gt;è¿”å›ç”¨æˆ·ä¿¡æ¯(å³ç™»å½•)ï¼Œæ²¡æœ‰-&gt;æ³¨å†Œå¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p><a href="https://blog.csdn.net/qq_36466653/article/details/83374485">å‚è€ƒ1</a>
<a href="https://blog.csdn.net/Lonely_Devil/article/details/90024579">å‚è€ƒ2</a></p>
<p>è·å–æ‰‹æœºå·å’Œè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä¸¤å¥—æµç¨‹çš„åŒºåˆ«ï¼Œåªåœ¨äºå‰ç«¯ç¬¬äºŒæ¬¡è¯·æ±‚å¾®ä¿¡æ¥å£çš„ä¸åŒã€‚æ¯ä¸ªæ­¥éª¤ï¼Œå¯¹äºåå°æ¥è¯´éƒ½æ˜¯ä¸€æ ·çš„ã€‚
åå°åªéœ€è¦é€šè¿‡å‰ç«¯è·å–çš„codeï¼Œè·å–session_idå’Œopenidï¼Œç„¶åå†ç”¨ä¸‰ä¸ªå‚æ•°<code>session_keyï¼Œivï¼ŒencryptedData</code>è¿›è¡Œè§£å¯†å³å¯ã€‚</p>
<ul>
<li>è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå‰ç«¯è°ƒç”¨<code>wx.getUserInfo(Object object)</code><a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html">å®˜æ–¹æ–‡æ¡£</a></li>
<li>è·å–æ‰‹æœºå·ï¼Œå‰ç«¯è°ƒç”¨<code>getPhoneNumber</code><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html">å®˜æ–¹æ–‡æ¡£</a></li>
</ul>
<p>æ‰€ä»¥ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯å’Œè·å–ç”¨æˆ·æ‰‹æœºå·ï¼Œåå°åªéœ€ä¸€ä¸ªæ¥å£å³å¯ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œè§£å¯†å‡ºæ¥çš„ï¼Œä¸€ä¸ªæ˜¯æ‰‹æœºå·ï¼Œä¸€ä¸ªæ˜¯ç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥å¯èƒ½è¿˜éœ€è¦åœ¨è‡ªå·±çš„ä¸šåŠ¡ä¸­ï¼Œå¯¹ä¸¤ç§ä¸åŒçš„å‚æ•°é‡‡å–ä¸åŒçš„å¤„ç†ã€‚</p>
<p><strong>åå°è¯·æ±‚å¾®ä¿¡æˆæƒï¼Œåœ¨æœ¬åœ°å³å¯ä»¥æµ‹è¯•ï¼Œåªè¦æœ‰codeæˆ–encryptedDataå’Œiv(è¿™ä¸‰ä¸ªå‚æ•°éœ€è¦å‰ç«¯ç»™ä½ )ï¼Œä¸ç”¨éæ‹¿åˆ°çº¿ä¸Šå»æµ‹ã€‚è€Œä¸”ï¼Œå°ç¨‹åºåå°ï¼Œä¹Ÿæ— éœ€é…ç½®æœåŠ¡å™¨åŸŸåå•¥çš„ã€‚</strong></p>
<h2 id="å°ç¨‹åºå‘é€æ¶ˆæ¯">å°ç¨‹åºå‘é€æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#å°ç¨‹åºå‘é€æ¶ˆæ¯">#</a></h2>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/server-ability/message-push.html">å®˜æ–¹æ–‡æ¡£</a>
<a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/customer-message/customerServiceMessage.send.html">æ–‡æ¡£2</a>
å¾®ä¿¡çš„å®˜æ–¹æ–‡æ¡£çœŸçš„æ˜¯å±ä¸€æ ·ï¼Œæ¯«æ— é€»è¾‘è°ƒç†ã€‚æ¯æ¬¡è¦å†™å’Œå¾®ä¿¡ç›¸å…³çš„åŠŸèƒ½å¤´éƒ½å¾ˆå¤§ã€‚</p>
<p>åŠŸèƒ½ä»‹ç»ï¼š
å‰ç«¯æ·»åŠ æŒ‰é’®åï¼Œç”¨æˆ·ç‚¹å‡»æŒ‰é’®ï¼Œå³å¯è·³è½¬åˆ°å°ç¨‹åºå®¢æœç•Œé¢ã€‚
æ­¤æ—¶æœ‰ä¸‰ç§åšæ³•ï¼š
1.å‰ç«¯ç›´æ¥è¯·æ±‚å¾®ä¿¡æ¥å£ç»™å®¢æœå‘é€æ¶ˆæ¯ã€‚
2.å‰ç«¯è¯·æ±‚å¼€å‘è€…çš„æœåŠ¡å™¨æ¥å£ï¼Œç”±å¼€å‘è€…æœåŠ¡å™¨è¯·æ±‚å¾®ä¿¡æœåŠ¡å™¨ï¼Œå‘é€æ¶ˆæ¯ã€‚
3.é€šè¿‡å°ç¨‹åºåå°çš„é…ç½®ï¼Œç”±å¾®ä¿¡æœåŠ¡å™¨è¯·æ±‚å¼€å‘è€…æœåŠ¡å™¨ï¼Œå‘é€æ¶ˆæ¯ã€‚
è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç¬¬ä¸‰ç§æ–¹æ³•ã€‚</p>
<ul>
<li>ç™»å½•<a href="https://mp.weixin.qq.com/">å¾®ä¿¡å…¬ä¼—å¹³å°</a>
å°ç¨‹åºç®¡ç†åå°-&gt;å¼€å‘-&gt;å¼€å‘è®¾ç½®-&gt;æ¶ˆæ¯æ¨é€-&gt;å¯ç”¨ã€‚
å‡ ä¸ªéœ€è¦å¡«å†™çš„å‚æ•°ï¼š
URL(æœåŠ¡å™¨åœ°å€)ï¼šå¡«å†™æˆ‘ä»¬è‡ªå·±æœåŠ¡å™¨å¯ä»¥getè¯·æ±‚çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¿…é¡»æ˜¯æ–¹æ³•çš„å…¨è·¯å¾„ï¼Œå¦‚ï¼š<code>http://test.api.zjxk12.com/zjx/api/pay/checkSignature</code>
tokenä»¤ç‰Œï¼šéšä¾¿å†™ï¼Œä½†æ˜¯è¦ä¿å­˜åœ¨ç¨‹åºä¸­ï¼Œç”¨äºéªŒè¯ä¸€è‡´æ€§ã€‚
EncodingAESKey(æ¶ˆæ¯åŠ å¯†å¯†é’¥)ï¼šåœ¨å½“å‰é¡µé¢è‡ªåŠ¨ç”Ÿæˆã€‚
æ¶ˆæ¯åŠ å¯†æ–¹å¼ï¼šæ¨èå…¼å®¹æ¨¡å¼ã€‚
æ•°æ®æ ¼å¼ï¼šæˆ‘é€‰çš„jsonã€‚</li>
</ul>
<p>æ­¤æ—¶ç‚¹ç¡®å®šè¿˜æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„æœåŠ¡ç«¯è¿˜æ²¡æœ‰æ¥å£ï¼Œè¿™ä¸ªæ¥å£å°±æ˜¯ä¸Šè¾¹æˆ‘ä»¬å¡«å†™çš„åœ°å€ï¼Œç‚¹å‡»ç¡®å®šçš„æ—¶å€™ï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šè°ƒç”¨è¿™ä¸ªæ¥å£ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@GetMapping(&#34;checkSignature&#34;)
</span></span><span style="display:flex;"><span>public void checkSignature(HttpServletRequest request, HttpServletResponse response) throws Exception{
</span></span><span style="display:flex;"><span>	// å¾®ä¿¡åŠ å¯†ç­¾åï¼Œsignatureç»“åˆäº†å¼€å‘è€…å¡«å†™çš„tokenå‚æ•°å’Œè¯·æ±‚ä¸­çš„timestampå‚æ•°ã€nonceå‚æ•°ã€‚
</span></span><span style="display:flex;"><span>	String signature = request.getParameter(&#34;signature&#34;);
</span></span><span style="display:flex;"><span>	// æ—¶é—´æˆ³
</span></span><span style="display:flex;"><span>	String timestamp = request.getParameter(&#34;timestamp&#34;);
</span></span><span style="display:flex;"><span>	// éšæœºæ•°
</span></span><span style="display:flex;"><span>	String nonce = request.getParameter(&#34;nonce&#34;);
</span></span><span style="display:flex;"><span>	// éšæœºå­—ç¬¦ä¸²
</span></span><span style="display:flex;"><span>	String echostr = request.getParameter(&#34;echostr&#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	PrintWriter out = null;
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		out = response.getWriter();
</span></span><span style="display:flex;"><span>		// é€šè¿‡æ£€éªŒsignatureå¯¹è¯·æ±‚è¿›è¡Œæ ¡éªŒï¼Œè‹¥æ ¡éªŒæˆåŠŸåˆ™åŸæ ·è¿”å›echostrï¼Œå¦åˆ™æ¥å…¥å¤±è´¥
</span></span><span style="display:flex;"><span>		if (XcxUtil.checkSignature(signature, timestamp, nonce)) {
</span></span><span style="display:flex;"><span>			out.print(echostr);
</span></span><span style="display:flex;"><span>			out.flush();   //è¿™ä¸ªåœ°æ–¹å¿…é¡»ç”»é‡ç‚¹ï¼Œæ¶ˆæ¯æ¨é€é…ç½®Tokenä»¤ç‰Œé”™è¯¯æ ¡éªŒå¤±è´¥ï¼Œæäº†æˆ‘å¾ˆä¹…ï¼Œå¿…é¡»è¦åˆ·æ–°ï¼ï¼ï¼ï¼ï¼ï¼ï¼
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} catch (IOException e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>	} finally {
</span></span><span style="display:flex;"><span>		out.close();
</span></span><span style="display:flex;"><span>		out = null;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†…éƒ¨è°ƒç”¨çš„æ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * éªŒè¯ç­¾å
</span></span><span style="display:flex;"><span> * @param signature
</span></span><span style="display:flex;"><span> * @param timestamp
</span></span><span style="display:flex;"><span> * @param nonce
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>public static boolean checkSignature(String signature, String timestamp, String nonce) {
</span></span><span style="display:flex;"><span>	private static final String XCX_TONEN = &#34;zjx666888&#34;;
</span></span><span style="display:flex;"><span>	//ä¸token æ¯”è¾ƒ
</span></span><span style="display:flex;"><span>	String[] arr = new String[] { XCX_TONEN, timestamp, nonce };
</span></span><span style="display:flex;"><span>	// å°†tokenã€timestampã€nonceä¸‰ä¸ªå‚æ•°è¿›è¡Œå­—å…¸æ’åº
</span></span><span style="display:flex;"><span>	Arrays.sort(arr);
</span></span><span style="display:flex;"><span>	StringBuilder content = new StringBuilder();
</span></span><span style="display:flex;"><span>	for (int i = 0; i &lt; arr.length; i++) {
</span></span><span style="display:flex;"><span>		content.append(arr[i]);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	MessageDigest md = null;
</span></span><span style="display:flex;"><span>	String tmpStr = null;
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		md = MessageDigest.getInstance(&#34;SHA-1&#34;);
</span></span><span style="display:flex;"><span>		// å°†ä¸‰ä¸ªå‚æ•°å­—ç¬¦ä¸²æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œsha1åŠ å¯†
</span></span><span style="display:flex;"><span>		byte[] digest = md.digest(content.toString().getBytes());
</span></span><span style="display:flex;"><span>		tmpStr = byteToStr(digest);
</span></span><span style="display:flex;"><span>	} catch (NoSuchAlgorithmException e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	content = null;
</span></span><span style="display:flex;"><span>	// å°†sha1åŠ å¯†åçš„å­—ç¬¦ä¸²å¯ä¸signatureå¯¹æ¯”
</span></span><span style="display:flex;"><span>	return tmpStr != null ? tmpStr.equals(signature.toUpperCase()) : false;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªæ¥å£å†™å¥½ï¼Œä¼ åˆ°æœåŠ¡å™¨ä¸Šï¼Œç‚¹ç¡®å®šï¼Œå°±å¯ä»¥éªŒè¯æˆåŠŸäº†ã€‚</p>
<p>å› ä¸ºå¾®ä¿¡å‘é€æ¶ˆæ¯è°ƒç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªæ¥å£ï¼Œæ‰€ä»¥è¿˜éœ€è¦æ”¹è¿™ä¸ªæ¥å£ï¼Œå¦åˆ™å°±éœ€è¦æ”¹å°ç¨‹åºçš„é…ç½®ã€‚æ¥å£æ›´æ”¹åå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">119
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * @author: wjy
</span></span><span style="display:flex;"><span> * @description: å¾®ä¿¡æœåŠ¡å™¨å‘é€å°ç¨‹åºæ¶ˆæ¯
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@RequestMapping(value= {&#34;/checkSignature&#34;},method= {RequestMethod.GET, RequestMethod.POST})
</span></span><span style="display:flex;"><span>public void checkSignature(HttpServletRequest request, HttpServletResponse response,@RequestBody Map&lt;String,String&gt; map) throws Exception{
</span></span><span style="display:flex;"><span>	LOGGER.info(
</span></span><span style="display:flex;"><span>			&#34;\n***************************************&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;start xcxGetPhoneNum&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;å¾®ä¿¡æœåŠ¡å™¨å‘é€å°ç¨‹åºæ¶ˆæ¯&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;\n********************************************&#34;
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	final String kf_url = &#34;https://api.weixin.qq.com/cgi-bin/message/custom/send&#34;;
</span></span><span style="display:flex;"><span>	boolean isGet=request.getMethod().toLowerCase().equals(&#34;get&#34;);
</span></span><span style="display:flex;"><span>	LOGGER.info(isGet+&#34;---------------&#34;);
</span></span><span style="display:flex;"><span>	if(isGet){//é¦–æ¬¡éªŒè¯token
</span></span><span style="display:flex;"><span>		// å¾®ä¿¡åŠ å¯†ç­¾åï¼Œsignatureç»“åˆäº†å¼€å‘è€…å¡«å†™çš„tokenå‚æ•°å’Œè¯·æ±‚ä¸­çš„timestampå‚æ•°ã€nonceå‚æ•°ã€‚
</span></span><span style="display:flex;"><span>		String signature = request.getParameter(&#34;signature&#34;);
</span></span><span style="display:flex;"><span>		// æ—¶é—´æˆ³
</span></span><span style="display:flex;"><span>		String timestamp = request.getParameter(&#34;timestamp&#34;);
</span></span><span style="display:flex;"><span>		// éšæœºæ•°
</span></span><span style="display:flex;"><span>		String nonce = request.getParameter(&#34;nonce&#34;);
</span></span><span style="display:flex;"><span>		// éšæœºå­—ç¬¦ä¸²
</span></span><span style="display:flex;"><span>		String echostr = request.getParameter(&#34;echostr&#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		PrintWriter out = null;
</span></span><span style="display:flex;"><span>		try {
</span></span><span style="display:flex;"><span>			out = response.getWriter();
</span></span><span style="display:flex;"><span>			// é€šè¿‡æ£€éªŒsignatureå¯¹è¯·æ±‚è¿›è¡Œæ ¡éªŒï¼Œè‹¥æ ¡éªŒæˆåŠŸåˆ™åŸæ ·è¿”å›echostrï¼Œå¦åˆ™æ¥å…¥å¤±è´¥
</span></span><span style="display:flex;"><span>			if (XcxUtil.checkSignature(signature, timestamp, nonce)) {
</span></span><span style="display:flex;"><span>				out.print(echostr);
</span></span><span style="display:flex;"><span>				out.flush();   //è¿™ä¸ªåœ°æ–¹å¿…é¡»ç”»é‡ç‚¹ï¼Œæ¶ˆæ¯æ¨é€é…ç½®Tokenä»¤ç‰Œé”™è¯¯æ ¡éªŒå¤±è´¥ï¼Œæäº†æˆ‘å¾ˆä¹…ï¼Œå¿…é¡»è¦åˆ·æ–°ï¼ï¼ï¼ï¼ï¼ï¼ï¼
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		} catch (IOException e) {
</span></span><span style="display:flex;"><span>			e.printStackTrace();
</span></span><span style="display:flex;"><span>		} finally {
</span></span><span style="display:flex;"><span>			out.close();
</span></span><span style="display:flex;"><span>			out = null;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}else{// è¿›å…¥POSTèŠå¤©å¤„ç†
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;è¿›å…¥äº†èŠå¤©ç•Œé¢&#34;);
</span></span><span style="display:flex;"><span>		// æ¥æ”¶æ¶ˆæ¯å¹¶è¿”å›æ¶ˆæ¯ Â 
</span></span><span style="display:flex;"><span>		try {
</span></span><span style="display:flex;"><span>			// æ¥æ”¶æ¶ˆæ¯å¹¶è¿”å›æ¶ˆæ¯
</span></span><span style="display:flex;"><span>			JSONObject json = null;
</span></span><span style="display:flex;"><span>			//è¿™æ˜¯é€šè¿‡é€šè¿‡getæ–¹å¼å»url æ‹¼æ¥çš„é”®å€¼å¯¹ï¼Œpostæ–¹å¼å–ä¸åˆ°å€¼ã€‚
</span></span><span style="display:flex;"><span>//                String openid=request.getParameter(&#34;FromUserName&#34;);
</span></span><span style="display:flex;"><span>			String openid = map.get(&#34;FromUserName&#34;);
</span></span><span style="display:flex;"><span>			System.out.println(&#34;openidæ˜¯ï¼š&#34; + openid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			//è¿”å›é¡µé¢é˜²æ­¢å‡ºç°ä¸­æ–‡ä¹±ç 
</span></span><span style="display:flex;"><span>			request.setCharacterEncoding(&#34;UTF-8&#34;);
</span></span><span style="display:flex;"><span>			//postæ–¹å¼ä¼ é€’è¯»å–å­—ç¬¦æµ
</span></span><span style="display:flex;"><span>			BufferedReader reader = new BufferedReader(new InputStreamReader(request.getInputStream()));
</span></span><span style="display:flex;"><span>			String jsonStr = null;
</span></span><span style="display:flex;"><span>			StringBuilder result = new StringBuilder();
</span></span><span style="display:flex;"><span>			try {
</span></span><span style="display:flex;"><span>				while ((jsonStr = reader.readLine()) != null) {
</span></span><span style="display:flex;"><span>					result.append(jsonStr);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			} catch (IOException e) {
</span></span><span style="display:flex;"><span>				e.printStackTrace();
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			reader.close();// å…³é—­è¾“å…¥æµ
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			//è·å–å°ç¨‹åºaccess_token
</span></span><span style="display:flex;"><span>			String access_token = stringRedisTemplate.opsForValue().get(&#34;xcx_access_token&#34;);
</span></span><span style="display:flex;"><span>			if(StringUtils.isEmpty(access_token)){
</span></span><span style="display:flex;"><span>				LOGGER.info(&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;é‡æ–°è·å–å°ç¨‹åºaccess_token&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&#34;);
</span></span><span style="display:flex;"><span>				//å·²ç»è¶…æ—¶ï¼Œé‡æ–°è·å–
</span></span><span style="display:flex;"><span>				access_token = getXcxAccessToken(stringRedisTemplate);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			PrintWriter out=null;
</span></span><span style="display:flex;"><span>			BufferedReader in=null;
</span></span><span style="display:flex;"><span>			try {
</span></span><span style="display:flex;"><span>				String media_id = stringRedisTemplate.opsForValue().get(&#34;media_id&#34;);
</span></span><span style="display:flex;"><span>				if(null == media_id){
</span></span><span style="display:flex;"><span>					//é‡æ–°è·å–media_id
</span></span><span style="display:flex;"><span>					media_id = XcxUtil.uploadMedia(access_token, &#34;image&#34;,&#34;http://file.zjxk12.com/jpg/1587005725424.jpg&#34;,stringRedisTemplate);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				//ç»„è£…å‚æ•°ä½“1ï¼Œå›¾ç‰‡
</span></span><span style="display:flex;"><span>				Map&lt;String,Object&gt; picMap = new HashMap&lt;&gt;(4);
</span></span><span style="display:flex;"><span>				picMap.put(&#34;msgtype&#34;,&#34;image&#34;);
</span></span><span style="display:flex;"><span>				picMap.put(&#34;touser&#34;,openid);
</span></span><span style="display:flex;"><span>				Map&lt;String,String&gt; inPicMap = new HashMap&lt;&gt;(1);
</span></span><span style="display:flex;"><span>				inPicMap.put(&#34;media_id&#34;,media_id);
</span></span><span style="display:flex;"><span>				picMap.put(&#34;image&#34;,inPicMap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				JSONObject param1 = new JSONObject(picMap);
</span></span><span style="display:flex;"><span>				JSONObject result1 = HttpUtil.sendPost(kf_url + &#34;?access_token=&#34; + access_token,param1);
</span></span><span style="display:flex;"><span>				log.info(&#34;å¾®ä¿¡è¿”å›çš„ç»“æœ2: {}&#34;, result1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				//ç»„è£…å‚æ•°2ï¼Œæ–‡å­—
</span></span><span style="display:flex;"><span>				Map&lt;String,Object&gt; wordMap = new HashMap&lt;&gt;(4);
</span></span><span style="display:flex;"><span>				wordMap.put(&#34;msgtype&#34;,&#34;text&#34;);
</span></span><span style="display:flex;"><span>				wordMap.put(&#34;touser&#34;,openid);
</span></span><span style="display:flex;"><span>				Map&lt;String,String&gt; inMap = new HashMap&lt;&gt;(1);
</span></span><span style="display:flex;"><span>				inMap.put(&#34;content&#34;,&#34;ç”±äºå¾®ä¿¡è§„åˆ™å˜åŠ¨ï¼Œæ‚¨éœ€è¦ç‚¹å‡»ä¸Šæ–¹äºŒç»´ç ï¼Œç„¶åé•¿æŒ‰è¯†åˆ«ï¼Œå…³æ³¨ã€æœ€ç¾è¯¾æœ¬å®¶é•¿ã€‘å…¬ä¼—å·ï¼Œæ³¨å†Œå®¶é•¿ç«¯ï¼Œå¹¶ç»‘å®šå­¦ç”Ÿç«¯APPæ‰‹æœºå·ï¼Œå°±å¯ä»¥åœ¨æœ€ç¾è¯¾æœ¬APPå†…å­¦ä¹ å…¨éƒ¨å†…å®¹ï¼&#34;);
</span></span><span style="display:flex;"><span>				wordMap.put(&#34;text&#34;,inMap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				//å‚æ•°ä½“2
</span></span><span style="display:flex;"><span>				JSONObject param2 = new JSONObject(wordMap);
</span></span><span style="display:flex;"><span>				JSONObject result2 = HttpUtil.sendPost(kf_url + &#34;?access_token=&#34; + access_token,param2);
</span></span><span style="display:flex;"><span>				log.info(&#34;å¾®ä¿¡è¿”å›çš„ç»“æœ2: {}&#34;, result2);
</span></span><span style="display:flex;"><span>			} catch (Exception e) {
</span></span><span style="display:flex;"><span>				System.out.println(&#34;å‘é€postè¯·æ±‚å¼‚å¸¸&#34;);
</span></span><span style="display:flex;"><span>				e.printStackTrace();
</span></span><span style="display:flex;"><span>			}finally{
</span></span><span style="display:flex;"><span>				if(out!=null)out.close();
</span></span><span style="display:flex;"><span>				if(in!=null)in.close();
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		} catch (Exception e) {
</span></span><span style="display:flex;"><span>			e.printStackTrace();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¼ åˆ°æœåŠ¡å™¨ä¸Šï¼Œå°ç¨‹åºå®¢æœå°±å¯ä»¥å‘é€æ¶ˆæ¯äº†ã€‚</p>
<h3 id="ä¼ åª’ä½“æ–‡ä»¶åˆ°å¾®ä¿¡æœåŠ¡å™¨">ä¼ åª’ä½“æ–‡ä»¶åˆ°å¾®ä¿¡æœåŠ¡å™¨<a hidden class="anchor" aria-hidden="true" href="#ä¼ åª’ä½“æ–‡ä»¶åˆ°å¾®ä¿¡æœåŠ¡å™¨">#</a></h3>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/customer-message/customerServiceMessage.uploadTempMedia.html">å®˜æ–¹æ–‡æ¡£</a>
å¦‚æœæƒ³å‘é€å›¾ç‰‡æ¶ˆæ¯ï¼Œæ ¹æ®å®˜æ–¹æ–‡æ¡£æç¤ºï¼Œæˆ‘ä»¬éœ€è¦<code>media_id</code>ã€‚ç°åœ¨è®²å¦‚ä½•è·å–è¿™ä¸ªmedia_idã€‚
é¦–å…ˆéœ€è¦å‡†å¤‡3ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>access_tokenï¼šå°ç¨‹åºçš„access_tokenï¼ˆæ³¨æ„å’Œå…¬ä¼—å·çš„access_tokenåŒºåˆ†ï¼‰</li>
<li>typeï¼šæ–‡ä»¶ç±»å‹ï¼Œåˆæ³•å€¼ï¼šimageï¼Œå°±æ˜¯è¯´åªèƒ½å†™imageã€‚å†™æ­»å¥½äº†</li>
<li>mediaï¼šform-data ä¸­åª’ä½“æ–‡ä»¶æ ‡è¯†ï¼Œæœ‰filenameã€filelengthã€content-typeç­‰ä¿¡æ¯</li>
</ul>
<p>è°ƒç”¨å¾®ä¿¡çš„æ¥å£æˆåŠŸï¼Œå¾®ä¿¡ä¼šè¿”å›ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;errcode&#34;: 0,
</span></span><span style="display:flex;"><span>  &#34;errmsg&#34;: &#34;ok&#34;,
</span></span><span style="display:flex;"><span>  &#34;type&#34;: &#34;image&#34;,
</span></span><span style="display:flex;"><span>  &#34;media_id&#34;: &#34;MEDIA_ID&#34;,
</span></span><span style="display:flex;"><span>  &#34;created_at&#34;: &#34;xxx&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªmedia_idå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ã€‚</p>
<p>ç„¶åç¼–å†™ä¸Šä¼ æ–¹æ³•</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">87
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * ä¸Šä¼ å¤šåª’ä½“æ•°æ®åˆ°å¾®ä¿¡æœåŠ¡å™¨
</span></span><span style="display:flex;"><span> * @param accessToken ä»å¾®ä¿¡è·å–åˆ°çš„access_token
</span></span><span style="display:flex;"><span> * @param mediaFileUrl æ¥è‡ªç½‘ç»œä¸Šé¢çš„åª’ä½“æ–‡ä»¶åœ°å€
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>public static String uploadMedia(String accessToken, String type, String mediaFileUrl, StringRedisTemplate stringRedisTemplate) {
</span></span><span style="display:flex;"><span>	//æ—§åœ°å€ï¼Œå¾®ä¿¡å®˜æ–¹å·²ç»åºŸå¼ƒï¼Œç‹—æ¯”ä¹Ÿæ²¡æœ‰é€šçŸ¥
</span></span><span style="display:flex;"><span>	//String MEDIA_URL = &#34;http://file.api.weixin.qq.com/cgi-bin/media/upload?access_token=ACCESS_TOKEN&amp;type=TYPE&#34;;
</span></span><span style="display:flex;"><span>	//æ–°åœ°å€
</span></span><span style="display:flex;"><span>	String MEDIA_URL = &#34;https://api.weixin.qq.com/cgi-bin/media/upload?access_token=ACCESS_TOKEN&amp;type=TYPE&#34;;
</span></span><span style="display:flex;"><span>	StringBuffer resultStr = null;
</span></span><span style="display:flex;"><span>	//æ‹¼è£…urlåœ°å€
</span></span><span style="display:flex;"><span>	String mediaStr = MEDIA_URL.replace(&#34;ACCESS_TOKEN&#34;, accessToken).replace(&#34;TYPE&#34;, type);
</span></span><span style="display:flex;"><span>	System.out.println(&#34;mediaStr:&#34; + mediaStr);
</span></span><span style="display:flex;"><span>	URL mediaUrl;
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		String boundary = &#34;----WebKitFormBoundaryOYXo8heIv9pgpGjT&#34;;
</span></span><span style="display:flex;"><span>		URL url = new URL(mediaStr);
</span></span><span style="display:flex;"><span>		HttpURLConnection urlConn = (HttpURLConnection)url.openConnection();
</span></span><span style="display:flex;"><span>		//è®©è¾“å…¥è¾“å‡ºæµå¼€å¯
</span></span><span style="display:flex;"><span>		urlConn.setDoInput(true);
</span></span><span style="display:flex;"><span>		urlConn.setDoOutput(true);
</span></span><span style="display:flex;"><span>		//ä½¿ç”¨postæ–¹å¼è¯·æ±‚çš„æ—¶å€™å¿…é¡»å…³é—­ç¼“å­˜
</span></span><span style="display:flex;"><span>		urlConn.setUseCaches(false);
</span></span><span style="display:flex;"><span>		//è®¾ç½®è¯·æ±‚å¤´çš„Content-Typeå±æ€§
</span></span><span style="display:flex;"><span>		urlConn.setRequestProperty(&#34;Content-Type&#34;, &#34;multipart/form-data; boundary=&#34;+boundary);
</span></span><span style="display:flex;"><span>		urlConn.setRequestMethod(&#34;POST&#34;);
</span></span><span style="display:flex;"><span>		//è·å–è¾“å‡ºæµï¼Œä½¿ç”¨è¾“å‡ºæµæ‹¼æ¥è¯·æ±‚ä½“
</span></span><span style="display:flex;"><span>		OutputStream out = urlConn.getOutputStream();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//è¯»å–æ–‡ä»¶çš„æ•°æ®,æ„å»ºä¸€ä¸ªGETè¯·æ±‚ï¼Œç„¶åè¯»å–æŒ‡å®šåœ°å€ä¸­çš„æ•°æ®
</span></span><span style="display:flex;"><span>		mediaUrl = new URL(mediaFileUrl);
</span></span><span style="display:flex;"><span>		HttpURLConnection mediaConn = (HttpURLConnection)mediaUrl.openConnection();
</span></span><span style="display:flex;"><span>		//è®¾ç½®è¯·æ±‚æ–¹å¼
</span></span><span style="display:flex;"><span>		mediaConn.setRequestMethod(&#34;GET&#34;);
</span></span><span style="display:flex;"><span>		//è®¾ç½®å¯ä»¥æ‰“å¼€è¾“å…¥æµ
</span></span><span style="display:flex;"><span>		mediaConn.setDoInput(true);
</span></span><span style="display:flex;"><span>		//è·å–ä¼ è¾“çš„æ•°æ®ç±»å‹
</span></span><span style="display:flex;"><span>		String contentType = mediaConn.getHeaderField(&#34;Content-Type&#34;);
</span></span><span style="display:flex;"><span>		//å°†è·å–å¤§åˆ°çš„ç±»å‹è½¬æ¢æˆæ‰©å±•å
</span></span><span style="display:flex;"><span>		String fileExt = judgeType(contentType);
</span></span><span style="display:flex;"><span>		//è·å–è¾“å…¥æµï¼Œä»mediaURLé‡Œé¢è¯»å–æ•°æ®
</span></span><span style="display:flex;"><span>		InputStream in = mediaConn.getInputStream();
</span></span><span style="display:flex;"><span>		BufferedInputStream bufferedIn = new BufferedInputStream(in);
</span></span><span style="display:flex;"><span>		//æ•°æ®è¯»å–åˆ°è¿™ä¸ªæ•°ç»„é‡Œé¢
</span></span><span style="display:flex;"><span>		byte[] bytes = new byte[1024];
</span></span><span style="display:flex;"><span>		int size = 0;
</span></span><span style="display:flex;"><span>		//ä½¿ç”¨outputStreamæµè¾“å‡ºä¿¡æ¯åˆ°è¯·æ±‚ä½“å½“ä¸­å»
</span></span><span style="display:flex;"><span>		out.write((&#34;--&#34;+boundary+&#34;\r\n&#34;).getBytes());
</span></span><span style="display:flex;"><span>		out.write((&#34;Content-Disposition: form-data; name=\&#34;media\&#34;;\r\n&#34;
</span></span><span style="display:flex;"><span>				+ &#34;filename=\&#34;&#34;+(new Date().getTime())+fileExt+&#34;\&#34;\r\n&#34;
</span></span><span style="display:flex;"><span>				+ &#34;Content-Type: &#34;+contentType+&#34;\r\n\r\n&#34;).getBytes());
</span></span><span style="display:flex;"><span>		while( (size = bufferedIn.read(bytes)) != -1) {
</span></span><span style="display:flex;"><span>			out.write(bytes, 0, size);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		//åˆ‡è®°ï¼Œè¿™é‡Œçš„æ¢è¡Œç¬¦ä¸èƒ½å°‘ï¼Œå¦åˆ™å°†ä¼šæŠ¥41005é”™è¯¯
</span></span><span style="display:flex;"><span>		out.write((&#34;\r\n--&#34;+boundary+&#34;--\r\n&#34;).getBytes());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		bufferedIn.close();
</span></span><span style="display:flex;"><span>		in.close();
</span></span><span style="display:flex;"><span>		mediaConn.disconnect();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		InputStream resultIn = urlConn.getInputStream();
</span></span><span style="display:flex;"><span>		InputStreamReader reader = new InputStreamReader(resultIn);
</span></span><span style="display:flex;"><span>		BufferedReader bufferedReader = new BufferedReader(reader);
</span></span><span style="display:flex;"><span>		String tempStr = null;
</span></span><span style="display:flex;"><span>		resultStr = new StringBuffer();
</span></span><span style="display:flex;"><span>		while((tempStr = bufferedReader.readLine()) != null) {
</span></span><span style="display:flex;"><span>			resultStr.append(tempStr);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		bufferedReader.close();
</span></span><span style="display:flex;"><span>		reader.close();
</span></span><span style="display:flex;"><span>		resultIn.close();
</span></span><span style="display:flex;"><span>		urlConn.disconnect();
</span></span><span style="display:flex;"><span>	} catch (MalformedURLException e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>	} catch (IOException e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	JSONObject jo = JSON.parseObject(resultStr.toString());
</span></span><span style="display:flex;"><span>	log.info(&#34;ä¸Šä¼ åª’ä½“æ–‡ä»¶åˆ°å¾®ä¿¡ï¼Œè¿”å›çš„å†…å®¹æ˜¯ï¼š&#34; + jo);
</span></span><span style="display:flex;"><span>	String media_id = jo.get(&#34;media_id&#34;).toString();
</span></span><span style="display:flex;"><span>	//ç¼“å­˜åˆ°redis
</span></span><span style="display:flex;"><span>	stringRedisTemplate.opsForValue().set(&#34;media_id&#34;,media_id,72, TimeUnit.HOURS);
</span></span><span style="display:flex;"><span>	return media_id;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>media_idçš„æœ‰æ¶ˆæ¯ä¸º3å¤©ï¼Œå³72å°æ—¶ï¼Œä¸€å®šè¦ç¼“å­˜åˆ°redisï¼Œæ—¶é—´ä¹Ÿæ˜¯72å°æ—¶å³å¯ï¼Œé¿å…é‡å¤ä¸Šä¼ ã€‚è¶…æ—¶ä¹‹åï¼Œå†é‡æ–°ä¸Šä¼ ï¼Œé‡æ–°è·å–media_idã€‚
æœ‰äº†media_idï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å‘å®¢æœæ¶ˆæ¯æ—¶ï¼Œä½¿ç”¨media_idæ¥å‘é€å›¾ç‰‡äº†ã€‚</p>
<h2 id="ä¿¡å…¬ä¼—å·å‘é€æ¨¡æ¿æ¶ˆæ¯">ä¿¡å…¬ä¼—å·å‘é€æ¨¡æ¿æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#ä¿¡å…¬ä¼—å·å‘é€æ¨¡æ¿æ¶ˆæ¯">#</a></h2>
<p><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1433751277">å…¬ä¼—å·å‘é€æ¶ˆæ¯å®˜æ–¹æ–‡æ¡£</a>
è¦æ¨é€å¾®ä¿¡çš„æ¨¡æ¿æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡çš„æ¡ä»¶æœ‰ï¼š
1ã€æœ‰æ•ˆçš„access_token
2ã€å¾®ä¿¡å…¬ä¼—å·æä¾›çš„æ¶ˆæ¯æ¨¡æ¿çš„Template_id
access_tokenï¼š
å…¬ä¼—å¹³å°ä»¥access_tokenä¸ºæ¥å£è°ƒç”¨å‡­æ®ï¼Œæ¥è°ƒç”¨æ¥å£ï¼Œæ‰€æœ‰æ¥å£çš„è°ƒç”¨éœ€è¦å…ˆè·å–access_tokenï¼Œaccess_tokenåœ¨2å°æ—¶å†…æœ‰æ•ˆï¼Œè¿‡æœŸéœ€è¦é‡æ–°è·å–ï¼Œä½†1å¤©å†…è·å–æ¬¡æ•°æœ‰é™ï¼Œå¼€å‘è€…éœ€è‡ªè¡Œå­˜å‚¨ï¼Œè¯¦è§è·å–æ¥å£è°ƒç”¨å‡­æ®ï¼ˆaccess_tokenï¼‰æ–‡æ¡£ã€‚
æˆ‘å°†access_tokenå­˜åˆ°äº†redisä¸­ï¼Œæœ‰æ•ˆæœŸä¸¤å°æ—¶ï¼Œä¸¤å°æ—¶è¿‡æœŸåï¼Œå†åˆ°å¾®ä¿¡æœåŠ¡å™¨é‡æ–°è·å–access_tokenã€‚
Template_idï¼š
Template_idæ˜¯æˆ‘ä»¬éœ€è¦æ¨é€çš„æ¨¡æ¿æ¶ˆæ¯çš„æ¨¡æ¿çš„å”¯ä¸€æ ‡è¯†ï¼Œå¾®ä¿¡å…¬ä¼—å¹³å°æä¾›äº†å¾ˆå¤šæ¨¡æ¿ï¼Œä¹Ÿæ”¯æŒè‡ªå®šä¹‰æ ¼å¼ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ°å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·å¼€å¯æ¨¡æ¿æ¶ˆæ¯åŠŸèƒ½ã€‚åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°çš„é¦–é¡µï¼Œå·¦ä¾§èœå•æœ‰ä¸€ä¸ªâ€œæ·»åŠ åŠŸèƒ½æ’ä»¶â€ï¼Œé€‰æ‹©æ¨¡æ¿æ¶ˆæ¯ï¼Œå¾®ä¿¡å¹³å°å®¡æ ¸éœ€è¦ä¸€å®šæ—¶é—´ã€‚</p>
<p>æ¶ˆæ¯æ¨¡æ¿ä¸¾ä¾‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{{first.DATA}}
</span></span><span style="display:flex;"><span>å‘Šè­¦å†…å®¹ï¼š{{keyword1.DATA}}
</span></span><span style="display:flex;"><span>å‘Šè­¦å‘ç”Ÿæ—¶é—´ï¼š{{keyword2.DATA}}
</span></span><span style="display:flex;"><span>{{keyword3.DATA}}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸ºäº†æ–¹ä¾¿å°è£…æ•°æ®ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡æ¿ç±»æ¥åŒ…è£…è¦å‘é€çš„ä¿¡æ¯ï¼š
TemplateParam ç±»å°è£…äº†æ¨¡æ¿æ¶ˆæ¯ä¸­çš„ä¸€ä¸ªæ•°æ®ï¼Œæ¯”å¦‚ä¸Šé¢çš„â€œ{{first.DATA}} â€ï¼Œå…·ä½“å±æ€§å¯é˜…è¯»æ³¨é‡Šï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public class TemplateParam {
</span></span><span style="display:flex;"><span>    // å‚æ•°åç§°
</span></span><span style="display:flex;"><span>    private String name;
</span></span><span style="display:flex;"><span>    // å‚æ•°å€¼
</span></span><span style="display:flex;"><span>    private String value;
</span></span><span style="display:flex;"><span>    // é¢œè‰²
</span></span><span style="display:flex;"><span>    private String color;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public TemplateParam(String name, String value, String color) {
</span></span><span style="display:flex;"><span>        this.name = name;
</span></span><span style="display:flex;"><span>        this.value = value;
</span></span><span style="display:flex;"><span>        this.color = color;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getName() {
</span></span><span style="display:flex;"><span>        return name;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setName(String name) {
</span></span><span style="display:flex;"><span>        this.name = name;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getValue() {
</span></span><span style="display:flex;"><span>        return value;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setValue(String value) {
</span></span><span style="display:flex;"><span>        this.value = value;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getColor() {
</span></span><span style="display:flex;"><span>        return color;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setColor(String color) {
</span></span><span style="display:flex;"><span>        this.color = color;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Templateç±»ä»£è¡¨äº†æ•´ä¸ªå¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨äº†ç‰¹å®šçš„toJSON()æ–¹æ³•ç”Ÿæˆè¦å‘é€ç»™å¾®ä¿¡äº‘å¹³å°çš„jsonæ•°æ®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public class Template {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // æ¶ˆæ¯æ¥æ”¶æ–¹
</span></span><span style="display:flex;"><span>    private String toUser;
</span></span><span style="display:flex;"><span>    // æ¨¡æ¿id
</span></span><span style="display:flex;"><span>    private String templateId;
</span></span><span style="display:flex;"><span>    // æ¨¡æ¿æ¶ˆæ¯è¯¦æƒ…é“¾æ¥
</span></span><span style="display:flex;"><span>    private String url;
</span></span><span style="display:flex;"><span>    // æ¶ˆæ¯é¡¶éƒ¨çš„é¢œè‰²
</span></span><span style="display:flex;"><span>//    private String topColor;
</span></span><span style="display:flex;"><span>    // å‚æ•°åˆ—è¡¨
</span></span><span style="display:flex;"><span>    private List&lt;TemplateParam&gt; templateParamList;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getToUser() {
</span></span><span style="display:flex;"><span>        return toUser;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setToUser(String toUser) {
</span></span><span style="display:flex;"><span>        this.toUser = toUser;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getTemplateId() {
</span></span><span style="display:flex;"><span>        return templateId;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setTemplateId(String templateId) {
</span></span><span style="display:flex;"><span>        this.templateId = templateId;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getUrl() {
</span></span><span style="display:flex;"><span>        return url;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setUrl(String url) {
</span></span><span style="display:flex;"><span>        this.url = url;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>//    public String getTopColor() {
</span></span><span style="display:flex;"><span>//        return topColor;
</span></span><span style="display:flex;"><span>//    }
</span></span><span style="display:flex;"><span>//
</span></span><span style="display:flex;"><span>//    public void setTopColor(String topColor) {
</span></span><span style="display:flex;"><span>//        this.topColor = topColor;
</span></span><span style="display:flex;"><span>//    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String toJSON() {
</span></span><span style="display:flex;"><span>        StringBuffer buffer = new StringBuffer();
</span></span><span style="display:flex;"><span>        buffer.append(&#34;{&#34;);
</span></span><span style="display:flex;"><span>        buffer.append(String.format(&#34;\&#34;touser\&#34;:\&#34;%s\&#34;&#34;, this.toUser)).append(&#34;,&#34;);
</span></span><span style="display:flex;"><span>        buffer.append(String.format(&#34;\&#34;template_id\&#34;:\&#34;%s\&#34;&#34;, this.templateId)).append(&#34;,&#34;);
</span></span><span style="display:flex;"><span>		buffer.append(String.format(&#34;\&#34;url\&#34;:\&#34;%s\&#34;&#34;, this.url)).append(&#34;,&#34;);
</span></span><span style="display:flex;"><span>//        buffer.append(String.format(&#34;\&#34;topcolor\&#34;:\&#34;%s\&#34;&#34;, this.topColor)).append(&#34;,&#34;);
</span></span><span style="display:flex;"><span>        buffer.append(&#34;\&#34;data\&#34;:{&#34;);
</span></span><span style="display:flex;"><span>        TemplateParam param = null;
</span></span><span style="display:flex;"><span>        for (int i = 0; i &lt; this.templateParamList.size(); i++) {
</span></span><span style="display:flex;"><span>            param = templateParamList.get(i);
</span></span><span style="display:flex;"><span>            // åˆ¤æ–­æ˜¯å¦è¿½åŠ é€—å·
</span></span><span style="display:flex;"><span>            if (i &lt; this.templateParamList.size() - 1) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                buffer.append(String.format(&#34;\&#34;%s\&#34;: {\&#34;value\&#34;:\&#34;%s\&#34;,\&#34;color\&#34;:\&#34;%s\&#34;},&#34;, param.getName(), param.getValue(), param.getColor()));
</span></span><span style="display:flex;"><span>            } else {
</span></span><span style="display:flex;"><span>                buffer.append(String.format(&#34;\&#34;%s\&#34;: {\&#34;value\&#34;:\&#34;%s\&#34;,\&#34;color\&#34;:\&#34;%s\&#34;}&#34;, param.getName(), param.getValue(), param.getColor()));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        buffer.append(&#34;}&#34;);
</span></span><span style="display:flex;"><span>        buffer.append(&#34;}&#34;);
</span></span><span style="display:flex;"><span>        return buffer.toString();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public List&lt;TemplateParam&gt; getTemplateParamList() {
</span></span><span style="display:flex;"><span>        return templateParamList;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setTemplateParamList(List&lt;TemplateParam&gt; templateParamList) {
</span></span><span style="display:flex;"><span>        this.templateParamList = templateParamList;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡†å¤‡å¥½äº†æ¨¡æ¿æ¶ˆæ¯å®ä½“ï¼Œå°±å¯ä»¥å°è£…æ•°æ®å¹¶å‘é€äº†ã€‚å…³æ³¨å…¬ä¼—å·çš„å¾®ä¿¡ç”¨æˆ·ï¼Œä¼šä½¿ç”¨openidæ¥å”¯ä¸€æ ‡è¯†ï¼Œä¸‹é¢çš„æ–¹æ³•æ˜¯å®ç°äº†å¤šç”¨æˆ·ç¾¤å‘ï¼Œforå¾ªç¯é€ä¸€å‘é€ï¼Œç›®å‰æ²¡æœ‰æ‰¾åˆ°æ›´å¥½çš„ç¾¤å‘æ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@RequestMapping(&#34;/sendWarningByWechat&#34;)
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>public ResultMap sendWarningByWechat(String openIds, String content, String alarmDescriptions, String sendDateTime) {
</span></span><span style="display:flex;"><span>	ResultMap res = new ResultMap();
</span></span><span style="display:flex;"><span>	StringBuffer resBuff = new StringBuffer();
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		String templateMsgUrl = &#34;https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=ACCESS_TOKEN&#34;;
</span></span><span style="display:flex;"><span>		templateMsgUrl = templateMsgUrl.replace(&#34;ACCESS_TOKEN&#34;, MemoryData.access_token);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//å°è£…è¯·æ±‚ä½“
</span></span><span style="display:flex;"><span>		Template template = new Template();
</span></span><span style="display:flex;"><span>		template.setTemplateId(&#34;0ZUeqUJQ7jxB3G-fxgKyP17SPoo44wFuxnYBqLu5zA4E&#34;);
</span></span><span style="display:flex;"><span>		List&lt;TemplateParam&gt; templateParams = new ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>		String[] failures = alarmDescriptions.split(&#34;\\|\\|&#34;);
</span></span><span style="display:flex;"><span>		String alarmDescStr = &#34;\\r\\n&#34;;
</span></span><span style="display:flex;"><span>		if (failures != null &amp;&amp; failures.length &gt; 0) {
</span></span><span style="display:flex;"><span>			for (String failure : failures) {
</span></span><span style="display:flex;"><span>				alarmDescStr += failure + &#34;\\r\\n&#34;;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			//å»æ‰æœ€åçš„æ¢è¡Œç¬¦å·
</span></span><span style="display:flex;"><span>			alarmDescStr = alarmDescStr.substring(0, alarmDescStr.lastIndexOf(&#34;\\r\\n&#34;));
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		String allStr = content + alarmDescStr;
</span></span><span style="display:flex;"><span>		while (allStr.length() &gt; 180) {
</span></span><span style="display:flex;"><span>			alarmDescStr = alarmDescStr.substring(0, alarmDescStr.lastIndexOf(&#34;\\r\\n&#34;))+&#34;...&#34;;
</span></span><span style="display:flex;"><span>			allStr = content + alarmDescStr;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		TemplateParam first = new TemplateParam(&#34;first&#34;, content + &#34;\\r\\n&#34;, &#34;#DB1A1B&#34;);
</span></span><span style="display:flex;"><span>		TemplateParam keyword1 = new TemplateParam(&#34;keyword1&#34;, alarmDescStr + &#34;\\r\\n&#34;, &#34;#DB1A1B&#34;);
</span></span><span style="display:flex;"><span>		TemplateParam keyword2 = new TemplateParam(&#34;keyword2&#34;, sendDateTime + &#34;&#34;, &#34;#DB1A1B&#34;);
</span></span><span style="display:flex;"><span>		TemplateParam keyword3 = new TemplateParam(&#34;keyword3&#34;, &#34;&#34;, &#34;#DB1A1B&#34;);
</span></span><span style="display:flex;"><span>		templateParams.add(first);
</span></span><span style="display:flex;"><span>		templateParams.add(keyword1);
</span></span><span style="display:flex;"><span>		templateParams.add(keyword2);
</span></span><span style="display:flex;"><span>		templateParams.add(keyword3);
</span></span><span style="display:flex;"><span>		template.setTemplateParamList(templateParams);
</span></span><span style="display:flex;"><span>		String[] openIdArr = openIds.split(&#34;,&#34;);
</span></span><span style="display:flex;"><span>		if (openIdArr.length &gt; 0) {
</span></span><span style="display:flex;"><span>			for (String openID : openIdArr) {
</span></span><span style="display:flex;"><span>				template.setToUser(openID);
</span></span><span style="display:flex;"><span>				String resJson = HttpClientUtil.doTemplateMsgPost(templateMsgUrl, template.toJSON());
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} catch (Exception e) {
</span></span><span style="display:flex;"><span>		log.error(e.getMessage());
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		res.setFailureResult();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return res;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å‡»æ¨é€æ¶ˆæ¯è·³è½¬åˆ°ç½‘é¡µæˆ–è€…å°ç¨‹åº">å‡»æ¨é€æ¶ˆæ¯è·³è½¬åˆ°ç½‘é¡µæˆ–è€…å°ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#å‡»æ¨é€æ¶ˆæ¯è·³è½¬åˆ°ç½‘é¡µæˆ–è€…å°ç¨‹åº">#</a></h3>
<p>éœ€æ±‚ï¼šæ¶ˆæ¯æ¨é€åï¼Œç‚¹å‡»æ¨é€çš„æ¶ˆæ¯ï¼Œå¯ä»¥è·³è½¬åˆ°å…¬ä¼—å·å†…éƒ¨çš„æŸäº›é¡µé¢ï¼Œè¿™ä¸ªé¡µé¢æ˜¯æˆ‘ä»¬è‡ªå·±çš„ã€‚
<a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Template_Message_Interface.html">æ¨¡æ¿æ¶ˆæ¯å®˜æ–¹æ–‡æ¡£</a>ä¸€å®šä»”ç»†é˜…è¯»å®˜æ–¹æ–‡æ¡£ã€‚
æ ¹æ®å¾®ä¿¡å®˜ç½‘æä¾›çš„æ¥å£æ–‡æ¡£ï¼Œå¯ä»¥çŸ¥é“è¦è·³è½¬çš„æ¡ä»¶æœ‰ä»¥ä¸‹å››ä¸ªå‚æ•°ï¼š
urlï¼šæ¨¡æ¿è·³è½¬é“¾æ¥ï¼ˆæµ·å¤–å¸å·æ²¡æœ‰è·³è½¬èƒ½åŠ›ï¼‰
miniprogramï¼šè·³å°ç¨‹åºæ‰€éœ€æ•°æ®ï¼Œä¸éœ€è·³å°ç¨‹åºå¯ä¸ç”¨ä¼ è¯¥æ•°æ®
appidï¼šæ‰€éœ€è·³è½¬åˆ°çš„å°ç¨‹åºappidï¼ˆè¯¥å°ç¨‹åºappidå¿…é¡»ä¸å‘æ¨¡æ¿æ¶ˆæ¯çš„å…¬ä¼—å·æ˜¯ç»‘å®šå…³è”å…³ç³»ï¼Œæš‚ä¸æ”¯æŒå°æ¸¸æˆï¼‰
pagepathï¼šæ‰€éœ€è·³è½¬åˆ°å°ç¨‹åºçš„å…·ä½“é¡µé¢è·¯å¾„ï¼Œæ”¯æŒå¸¦å‚æ•°,ï¼ˆç¤ºä¾‹index?foo=barï¼‰ï¼Œè¦æ±‚è¯¥å°ç¨‹åºå·²å‘å¸ƒï¼Œæš‚ä¸æ”¯æŒå°æ¸¸æˆ
<a href="https://blog.csdn.net/qq_27185879/article/details/103385345">å‚è€ƒ</a></p>
<h1 id="å…¶ä»–">å…¶ä»–<a hidden class="anchor" aria-hidden="true" href="#å…¶ä»–">#</a></h1>
<h2 id="å…¨å±€è¿”å›ç è¯´æ˜">å…¨å±€è¿”å›ç è¯´æ˜<a hidden class="anchor" aria-hidden="true" href="#å…¨å±€è¿”å›ç è¯´æ˜">#</a></h2>
<p><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1433747234">å®˜æ–¹è¯´æ˜</a></p>
<h2 id="å¾®ä¿¡åˆ†äº«jssdk-invalid-signatureç­¾åé”™è¯¯çš„è§£å†³æ–¹æ¡ˆ">å¾®ä¿¡åˆ†äº«JSSDK-invalid signatureç­¾åé”™è¯¯çš„è§£å†³æ–¹æ¡ˆ<a hidden class="anchor" aria-hidden="true" href="#å¾®ä¿¡åˆ†äº«jssdk-invalid-signatureç­¾åé”™è¯¯çš„è§£å†³æ–¹æ¡ˆ">#</a></h2>
<p>æ ¸å¯¹å®˜æ–¹æ­¥éª¤ï¼Œç¡®è®¤ç­¾åç®—æ³•ã€‚</p>
<ul>
<li>ç¡®è®¤ç­¾åç®—æ³•æ­£ç¡®ï¼Œå¯ç”¨ <a href="http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign">http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign</a> é¡µé¢å·¥å…·è¿›è¡Œæ ¡éªŒã€‚</li>
<li>ç¡®è®¤configä¸­nonceStrï¼ˆjsä¸­é©¼å³°æ ‡å‡†å¤§å†™Sï¼‰, timestampä¸ç”¨ä»¥ç­¾åä¸­çš„å¯¹åº”noncestr, timestampä¸€è‡´ã€‚</li>
<li>ç¡®è®¤urlæ˜¯é¡µé¢å®Œæ•´çš„url(è¯·åœ¨å½“å‰é¡µé¢alert(location.href.split(&rsquo;#&rsquo;)[0])ç¡®è®¤)ï¼ŒåŒ…æ‹¬&rsquo;http(s)://&lsquo;éƒ¨åˆ†ï¼Œä»¥åŠ&rsquo;ï¼Ÿ&lsquo;åé¢çš„GETå‚æ•°éƒ¨åˆ†,ä½†ä¸åŒ…æ‹¬&rsquo;#&lsquo;hashåé¢çš„éƒ¨åˆ†ã€‚</li>
<li>ç¡®è®¤ config ä¸­çš„ appid ä¸ç”¨æ¥è·å– jsapi_ticket çš„ appid ä¸€è‡´ã€‚</li>
<li>ç¡®ä¿ä¸€å®šç¼“å­˜access_tokenå’Œjsapi_ticketã€‚</li>
<li>ç¡®ä¿ä½ è·å–ç”¨æ¥ç­¾åçš„urlæ˜¯åŠ¨æ€è·å–çš„ï¼ŒåŠ¨æ€é¡µé¢å¯å‚è§å®ä¾‹ä»£ç ä¸­phpçš„å®ç°æ–¹å¼ã€‚å¦‚æœæ˜¯htmlçš„é™æ€é¡µé¢åœ¨å‰ç«¯é€šè¿‡ajaxå°†urlä¼ åˆ°åå°ç­¾åï¼Œå‰ç«¯éœ€è¦ç”¨jsè·å–å½“å‰é¡µé¢é™¤å»&rsquo;#&lsquo;hashéƒ¨åˆ†çš„é“¾æ¥ï¼ˆå¯ç”¨location.href.split(&rsquo;#&rsquo;)[0]è·å–,è€Œä¸”éœ€è¦encodeURIComponentï¼Œåå°decodeURIComponentè§£ç ï¼‰ï¼Œå› ä¸ºé¡µé¢ä¸€æ—¦åˆ†äº«ï¼Œå¾®ä¿¡å®¢æˆ·ç«¯ä¼šåœ¨ä½ çš„é“¾æ¥æœ«å°¾åŠ å…¥å…¶å®ƒå‚æ•°ï¼Œå¦‚æœä¸æ˜¯åŠ¨æ€è·å–å½“å‰é“¾æ¥ï¼Œå°†å¯¼è‡´åˆ†äº«åçš„é¡µé¢ç­¾åå¤±è´¥ã€‚</li>
</ul>
<h2 id="å°ç¨‹åºæŠ¥é”™">å°ç¨‹åºæŠ¥é”™<a hidden class="anchor" aria-hidden="true" href="#å°ç¨‹åºæŠ¥é”™">#</a></h2>
<p><code>{&quot;errcode&quot;:40163,&quot;errmsg&quot;:&quot;code been used, hints: [ req_id: UGKfDXXBe-rIpWva ]&quot;}</code>
å‰ç«¯è·å–codeï¼Œé€šè¿‡codeè¯·æ±‚åå°æ¥å£ï¼Œåå°é€šè¿‡codeè·å–openidå’Œsession_keyã€‚å¶å°”ä¼šæŠ¥ä¸Šè¾¹çš„é”™ã€‚åŸå› ï¼šå‰ç«¯ä¼ äº†é‡å¤çš„codeï¼Œå°ç¨‹åºçš„codeåªèƒ½ç”¨ä¸€æ¬¡ï¼Œæ¯æ¬¡ä½¿ç”¨éƒ½è¦é‡æ–°è·å–ï¼Œä¸èƒ½ç¼“å­˜ã€‚</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/other/">other</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://funny-toffee-4aa7c3.netlify.app/posts/java/comparable%E5%92%8Ccomparator/">
    <span class="title">Â« Prev</span>
    <br>
    <span>comparableå’Œcomparator</span>
  </a>
  <a class="next" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%85%B6%E4%BB%96%E5%9F%BA%E7%A1%80/dubbo/">
    <span class="title">Next Â»</span>
    <br>
    <span>dubbo</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>