<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>wx | Wjy&#39;s Blog</title>
<meta name="keywords" content="other">
<meta name="description" content="概述
公众号类型功能介绍
微信官方介绍
公众号，是订阅号和服务号的统称。订阅号是公众号、服务号也是公众号。">
<meta name="author" content="Me, You">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/wx/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="wx" />
<meta property="og:description" content="概述
公众号类型功能介绍
微信官方介绍
公众号，是订阅号和服务号的统称。订阅号是公众号、服务号也是公众号。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/wx/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-04-25T10:04:49+00:00" />
<meta property="article:modified_time" content="2019-04-25T10:04:49+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="wx"/>
<meta name="twitter:description" content="概述
公众号类型功能介绍
微信官方介绍
公众号，是订阅号和服务号的统称。订阅号是公众号、服务号也是公众号。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "wx",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/wx/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "wx",
  "name": "wx",
  "description": "概述 公众号类型功能介绍 微信官方介绍 公众号，是订阅号和服务号的统称。订阅号是公众号、服务号也是公众号。\n",
  "keywords": [
    "other"
  ],
  "articleBody": "概述 公众号类型功能介绍 微信官方介绍 公众号，是订阅号和服务号的统称。订阅号是公众号、服务号也是公众号。\n订阅号：偏于为用户传达资讯，每天只可以发送一条群发，用户不会收到即时消息提醒，因为所有的订阅号都被收在了订阅号文件夹中。订阅号适用于个人和组织。 想看一个订阅号的消息，有两种方法：\n打开订阅号文件夹查看订阅号有没有更新消息； 打开微信手机通讯录，点开公众号选项，是你关注的所有公众号(包括订阅号和服务号)。 服务号：偏于服务交互(如：招商银行信用卡、微信读书、京东白条)，每月可群发四条消息，收费，不适用于个人，微信支付需要微信认证服务号才可以。\n选择： 想简单的发送消息，达到宣传效果，建议选择订阅号。 想用公众号获得更多功能，如开通微信支付，建议选择服务号。\n服务号、订阅号功能对比： 微信开放平台、公众平台区别 公众平台 官网 技术文档 微信公众平台是运营者通过公众号为微信用户提供资讯和服务的平台，登录公众平台账号后，可以看到它有一个不错的交互界面。可以提供给公司的运营人员使用，用来发布消息和提供服务。\n开放平台 官网 是为开发者（程序员）提供的一个平台，在这里你可以将你的公众平台下的公众号（订阅号、服务号）绑定到你的开放平台账号下，从而可以基于订阅号、服务号做更多的开发。公众号中的订阅号接口权限是有限的，比如它无法获得网页授权的权限，也就无法通过网页授权获取用户的基本信息（比如openID、unionID等）。\n功能实现 微信h5分享 参考地址\n流程图： 准备：公众号、已经备案好的域名\n步骤：\n配置JS回调域名和ip白名单 获取appId和secret 从官方代码copy签名函数 获取access_token、ticket 获取url，并进行签名 集成进java web 前端config函数配置 获取appId和secret 可以在基本配置中找到AppID和AppSecret。\n配置JS回调域名： 登录微信公众平台-\u003e公众号设置-\u003e功能设置-\u003eJS接口安全域名。填写你要分享的网页所在的域名。\n配置ip白名单： 登录微信公众平台-\u003e基本配置-\u003eIP白名单。 必须配置ip白名单，否则无法获取access_token\n从官方代码copy签名函数 打开微信分享官方文档，在页面最下面找到并下载示例代码 我们将java中的sign.java直接放到项目中备用。\n公众号获取access_token官方文档 小程序获取access_token官方文档\n获取access_token、ticket 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 public static WxShare getWxEntity(String url,StringRedisTemplate template) { String access_token = template.opsForValue().get(\"wx_base_access_token\"); String ticket = template.opsForValue().get(\"wx_jsapi_ticket\"); if(StringUtils.isEmpty(access_token)){ System.out.println(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e重新获取access_token和ticket\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\"); //已经超时，重新获取 access_token = getAccessToken(template); //如果重新获取了access_token，ticket也要重新获取 ticket = getTicket(access_token,template); } Map resultMap = Sign.sign(ticket, url); WxShare wx = new WxShare(); wx.setTicket(resultMap.get(\"jsapi_ticket\")); wx.setSignature(resultMap.get(\"signature\")); wx.setNoncestr(resultMap.get(\"nonceStr\")); wx.setTimestamp(resultMap.get(\"timestamp\")); return wx; } //获取token private static String getAccessToken(StringRedisTemplate template) { String access_token = \"\"; //获取access_token填写client_credential String grant_type = \"client_credential\"; //第三方用户唯一凭证 String AppId= PayConstant.WX_H5_APPID; //第三方用户唯一凭证密钥，即appsecret String secret=PayConstant.WX_H5_APPSECRET; //访问链接,这个url链接地址和参数皆不能变 String url = \"https://api.weixin.qq.com/cgi-bin/token?grant_type=\"+grant_type+\"\u0026appid=\"+AppId+\"\u0026secret=\"+secret; try { URL urlGet = new URL(url); HttpURLConnection http = (HttpURLConnection) urlGet.openConnection(); http.setRequestMethod(\"GET\"); // 必须是get方式请求 http.setRequestProperty(\"Content-Type\",\"application/x-www-form-urlencoded\"); http.setDoOutput(true); http.setDoInput(true); /*System.setProperty(\"sun.net.client.defaultConnectTimeout\", \"30000\");// 连接超时30秒 System.setProperty(\"sun.net.client.defaultReadTimeout\", \"30000\"); // 读取超时30秒 */ http.connect(); InputStream is = http.getInputStream(); int size = is.available(); byte[] jsonBytes = new byte[size]; is.read(jsonBytes); String message = new String(jsonBytes, \"UTF-8\"); JSONObject demoJson = JSONObject.fromObject(message); access_token = demoJson.getString(\"access_token\"); //缓存到redis，一定要缓存，每天只能请求2000次 template.opsForValue().set(\"wx_base_access_token\",access_token,2, TimeUnit.HOURS); is.close(); } catch (Exception e) { e.printStackTrace(); } return access_token; } //获取ticket private static String getTicket(String access_token,StringRedisTemplate template) { String ticket = null; //这个url链接和参数不能变 String url = \"https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=\"+ access_token +\"\u0026type=jsapi\"; try { URL urlGet = new URL(url); HttpURLConnection http = (HttpURLConnection) urlGet.openConnection(); http.setRequestMethod(\"GET\"); // 必须是get方式请求 http.setRequestProperty(\"Content-Type\",\"application/x-www-form-urlencoded\"); http.setDoOutput(true); http.setDoInput(true); System.setProperty(\"sun.net.client.defaultConnectTimeout\", \"30000\");// 连接超时30秒 System.setProperty(\"sun.net.client.defaultReadTimeout\", \"30000\"); // 读取超时30秒 http.connect(); InputStream is = http.getInputStream(); int size = is.available(); byte[] jsonBytes = new byte[size]; is.read(jsonBytes); String message = new String(jsonBytes, \"UTF-8\"); JSONObject demoJson = JSONObject.fromObject(message); ticket = demoJson.getString(\"ticket\"); //缓存到redis，一定要缓存，每天只能请求2000次 template.opsForValue().set(\"wx_jsapi_ticket\",ticket,2, TimeUnit.HOURS); is.close(); } catch (Exception e) { e.printStackTrace(); } return ticket; } 获取url，并进行签名 url的获取要特别注意，因为微信在分享时会在原来的url上加上一些\u0026from=singlemessage、\u0026from=…的，所以url必须要动态获取，网上有些用ajax，在网页通过“location.href.split(‘#’)“ 获取url，在用ajax传给后台，这种方法可行，但是不推荐，一方面用ajax返回，就要访问分享的逻辑，这样后台分享的逻辑增加复杂度，带来不便，是代码不易于维护，可读性低！另一方面分享是返回页面，而ajax是返回json，又增加了复杂度。所以，一个java程序员是不会通过ajax从前台获取url的，这里我们用HttpRequest的方法即可，不管微信加多少后缀，都可以获取到完整的当前url。\n获取url的controller如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @PostMapping(\"/share\") public ResponseUtil getQuestionList(@RequestBody Map paramMap){ LOGGER.info( \"\\n***************************************\" + \"\\n\" + \"start share\" + \"\\n\" + \"分享\" + \"\\n\" + \"\\n********************************************\" ); ResponseUtil response = ResponseUtil.success(); CodeEnum code = CodeEnum.FAIL; try { LOGGER.info(\"前端传过来的\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c：\" + paramMap.get(\"strUrl\")); LOGGER.info(\"URI解码\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c\u003c：\" + URI.create(paramMap.get(\"strUrl\")).getPath()); response.setData(wxUtil.getWxEntity(URI.create(paramMap.get(\"strUrl\")).getPath(),redisTemplate)); } catch (Exception e) { e.printStackTrace(); response.setCode(code); response.setMessage(e.getMessage()); } return response; } 需要注意：这个url是前端动态获取的，不能写死。如果带参数，或是中文，前端要对url做encodeURIComponent转码，后台再使用URI.create(paramMap.get(\"strUrl\")).getPath()进行解码。\n我们再新建一个存放微信信息的实体类：wx.java\n1 2 3 4 5 6 7 8 9 10 11 public class wx { private String access_token; private String ticket ; private String noncestr; private String timestamp; private String str; private String signature; ...setter and getter... } sign类里面有一个签名的方法sign，传入ticket和url即可。也就是WeinXinUtil的getWinXinEntity方法，并将返回的map的信息读取存入WinXinEntity中。 在调试时，把sign返回的map打印出来，主要看看生成的signature。然后，把jsapi_ticket、noncestr、timestamp、url 复制到微信提供的微信 JS 接口签名校验工具， 比较代码签名生成的signature与校验工具生成的签名signature是否一致，如果一致，说明前面的步骤都是正确的，如果不一致，仔细检查。\ncontroller 我们把微信分享分解成3个工具类，现在在处理分享的controller，只要两句话就可以调用微信分享，一句获取url，一句获取WinXinEntity，代码已经在上边给出了。\n前端config函数配置 下面的代码放在网页js代码的最前面！ ”var url = location.href.split(‘#’)[0];“ 页面的url也可以从后台传过来，也可以通过location.href.split(‘#’)[0]获取。 为了一点微不足道的速度，这里才用网页获取方式。（网页的url跟前面的后台签名时得url是一样的，只是绕过了ajax）\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 ",
  "wordCount" : "13884",
  "inLanguage": "en",
  "datePublished": "2019-04-25T10:04:49Z",
  "dateModified": "2019-04-25T10:04:49Z",
  "author":[{
    "@type": "Person",
    "name": "Me"
  }, {
    "@type": "Person",
    "name": "You"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/wx/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title">
      wx
    </h1>
    <div class="post-meta"><span title='2019-04-25 10:04:49 +0000 UTC'>2019-04-25</span>&nbsp;·&nbsp;Me, You

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%a6%82%e8%bf%b0" aria-label="概述">概述</a><ul>
                        
                <li>
                    <a href="#%e5%85%ac%e4%bc%97%e5%8f%b7%e7%b1%bb%e5%9e%8b%e5%8a%9f%e8%83%bd%e4%bb%8b%e7%bb%8d" aria-label="公众号类型功能介绍">公众号类型功能介绍</a></li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e5%bc%80%e6%94%be%e5%b9%b3%e5%8f%b0%e5%85%ac%e4%bc%97%e5%b9%b3%e5%8f%b0%e5%8c%ba%e5%88%ab" aria-label="微信开放平台、公众平台区别">微信开放平台、公众平台区别</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8a%9f%e8%83%bd%e5%ae%9e%e7%8e%b0" aria-label="功能实现">功能实现</a><ul>
                        
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1h5%e5%88%86%e4%ba%ab" aria-label="微信h5分享">微信h5分享</a><ul>
                        
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96appid%e5%92%8csecret" aria-label="获取appId和secret">获取appId和secret</a></li>
                <li>
                    <a href="#%e4%bb%8e%e5%ae%98%e6%96%b9%e4%bb%a3%e7%a0%81copy%e7%ad%be%e5%90%8d%e5%87%bd%e6%95%b0" aria-label="从官方代码copy签名函数">从官方代码copy签名函数</a></li>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96access_tokenticket" aria-label="获取access_token、ticket">获取access_token、ticket</a></li>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96url%e5%b9%b6%e8%bf%9b%e8%a1%8c%e7%ad%be%e5%90%8d" aria-label="获取url，并进行签名">获取url，并进行签名</a></li>
                <li>
                    <a href="#controller" aria-label="controller">controller</a></li>
                <li>
                    <a href="#%e5%89%8d%e7%ab%afconfig%e5%87%bd%e6%95%b0%e9%85%8d%e7%bd%ae" aria-label="前端config函数配置">前端config函数配置</a></li>
                <li>
                    <a href="#%e5%88%86%e4%ba%ab%e9%93%be%e6%8e%a5%e5%b8%a6%e5%8f%82%e6%95%b0%e7%9a%84%e6%83%85%e5%86%b5" aria-label="分享链接带参数的情况">分享链接带参数的情况</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e5%b0%8f%e7%a8%8b%e5%ba%8f%e7%99%bb%e5%bd%95" aria-label="微信小程序登录">微信小程序登录</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%a8%8b%e5%ba%8f%e8%8e%b7%e5%8f%96%e6%89%8b%e6%9c%ba%e5%8f%b7" aria-label="小程序获取手机号">小程序获取手机号</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%8f%91%e9%80%81%e6%b6%88%e6%81%af" aria-label="小程序发送消息">小程序发送消息</a><ul>
                        
                <li>
                    <a href="#%e4%bc%a0%e5%aa%92%e4%bd%93%e6%96%87%e4%bb%b6%e5%88%b0%e5%be%ae%e4%bf%a1%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="传媒体文件到微信服务器">传媒体文件到微信服务器</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bf%a1%e5%85%ac%e4%bc%97%e5%8f%b7%e5%8f%91%e9%80%81%e6%a8%a1%e6%9d%bf%e6%b6%88%e6%81%af" aria-label="信公众号发送模板消息">信公众号发送模板消息</a><ul>
                        
                <li>
                    <a href="#%e5%87%bb%e6%8e%a8%e9%80%81%e6%b6%88%e6%81%af%e8%b7%b3%e8%bd%ac%e5%88%b0%e7%bd%91%e9%a1%b5%e6%88%96%e8%80%85%e5%b0%8f%e7%a8%8b%e5%ba%8f" aria-label="击推送消息跳转到网页或者小程序">击推送消息跳转到网页或者小程序</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96" aria-label="其他">其他</a><ul>
                        
                <li>
                    <a href="#%e5%85%a8%e5%b1%80%e8%bf%94%e5%9b%9e%e7%a0%81%e8%af%b4%e6%98%8e" aria-label="全局返回码说明">全局返回码说明</a></li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e5%88%86%e4%ba%abjssdk-invalid-signature%e7%ad%be%e5%90%8d%e9%94%99%e8%af%af%e7%9a%84%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88" aria-label="微信分享JSSDK-invalid signature签名错误的解决方案">微信分享JSSDK-invalid signature签名错误的解决方案</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%a8%8b%e5%ba%8f%e6%8a%a5%e9%94%99" aria-label="小程序报错">小程序报错</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="概述">概述<a hidden class="anchor" aria-hidden="true" href="#概述">#</a></h1>
<h2 id="公众号类型功能介绍">公众号类型功能介绍<a hidden class="anchor" aria-hidden="true" href="#公众号类型功能介绍">#</a></h2>
<p><a href="http://kf.qq.com/faq/170815aUZjeQ170815mU7bI7.html">微信官方介绍</a>
公众号，是订阅号和服务号的统称。订阅号是公众号、服务号也是公众号。</p>
<p>订阅号：偏于为用户传达资讯，每天只可以发送一条群发，用户不会收到即时消息提醒，因为所有的订阅号都被收在了订阅号文件夹中。订阅号适用于个人和组织。
想看一个订阅号的消息，有两种方法：</p>
<ul>
<li>打开订阅号文件夹查看订阅号有没有更新消息；</li>
<li>打开微信手机通讯录，点开公众号选项，是你关注的所有公众号(包括订阅号和服务号)。</li>
</ul>
<p>服务号：偏于服务交互(如：招商银行信用卡、微信读书、京东白条)，每月可群发四条消息，收费，不适用于个人，微信支付需要<strong>微信认证服务号</strong>才可以。</p>
<p>选择：
想简单的发送消息，达到宣传效果，建议选择订阅号。
想用公众号获得更多功能，如开通微信支付，建议选择服务号。</p>
<p>服务号、订阅号功能对比：
<img loading="lazy" src="1.jpg" alt=""  />
</p>
<h2 id="微信开放平台公众平台区别">微信开放平台、公众平台区别<a hidden class="anchor" aria-hidden="true" href="#微信开放平台公众平台区别">#</a></h2>
<ul>
<li>
<p>公众平台
<a href="https://mp.weixin.qq.com/">官网</a>
<a href="https://mp.weixin.qq.com/wiki">技术文档</a>
微信公众平台是运营者通过公众号为微信用户提供资讯和服务的平台，登录公众平台账号后，可以看到它有一个不错的交互界面。可以提供给公司的运营人员使用，用来发布消息和提供服务。</p>
</li>
<li>
<p>开放平台
<a href="https://open.weixin.qq.com/">官网</a>
是为开发者（程序员）提供的一个平台，在这里你可以将你的公众平台下的公众号（订阅号、服务号）绑定到你的开放平台账号下，从而可以基于订阅号、服务号做更多的开发。公众号中的订阅号接口权限是有限的，比如它无法获得网页授权的权限，也就无法通过网页授权获取用户的基本信息（比如openID、unionID等）。</p>
</li>
</ul>
<h1 id="功能实现">功能实现<a hidden class="anchor" aria-hidden="true" href="#功能实现">#</a></h1>
<h2 id="微信h5分享">微信h5分享<a hidden class="anchor" aria-hidden="true" href="#微信h5分享">#</a></h2>
<p><a href="https://blog.csdn.net/change_on/article/details/75264843">参考地址</a></p>
<p>流程图：
<img loading="lazy" src="2.png" alt=""  />
</p>
<p>准备：公众号、已经备案好的域名</p>
<p>步骤：</p>
<ol>
<li>配置JS回调域名和ip白名单</li>
<li>获取appId和secret</li>
<li>从官方代码copy签名函数</li>
<li>获取access_token、ticket</li>
<li>获取url，并进行签名</li>
<li>集成进java web</li>
<li>前端config函数配置</li>
</ol>
<h3 id="获取appid和secret">获取appId和secret<a hidden class="anchor" aria-hidden="true" href="#获取appid和secret">#</a></h3>
<p>可以在基本配置中找到AppID和AppSecret。</p>
<p>配置JS回调域名：
登录微信公众平台-&gt;公众号设置-&gt;功能设置-&gt;JS接口安全域名。填写你要分享的网页所在的域名。</p>
<p>配置ip白名单：
登录微信公众平台-&gt;基本配置-&gt;IP白名单。
必须配置ip白名单，否则无法获取access_token</p>
<h3 id="从官方代码copy签名函数">从官方代码copy签名函数<a hidden class="anchor" aria-hidden="true" href="#从官方代码copy签名函数">#</a></h3>
<p>打开<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141115">微信分享官方文档</a>，在页面最下面找到并下载<a href="http://demo.open.weixin.qq.com/jssdk/sample.zip">示例代码</a>
我们将java中的<code>sign.java</code>直接放到项目中备用。</p>
<p><a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html">公众号获取access_token官方文档</a>
<a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html">小程序获取access_token官方文档</a></p>
<h3 id="获取access_tokenticket">获取access_token、ticket<a hidden class="anchor" aria-hidden="true" href="#获取access_tokenticket">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">86
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> WxShare getWxEntity(String url,StringRedisTemplate template) {
</span></span><span style="display:flex;"><span>        String access_token = template.<span style="color:#007f7f">opsForValue</span>().<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;wx_base_access_token&#34;</span>);
</span></span><span style="display:flex;"><span>        String ticket = template.<span style="color:#007f7f">opsForValue</span>().<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;wx_jsapi_ticket&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(StringUtils.<span style="color:#007f7f">isEmpty</span>(access_token)){
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;重新获取access_token和ticket&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//已经超时，重新获取
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            access_token = getAccessToken(template);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果重新获取了access_token，ticket也要重新获取
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ticket = getTicket(access_token,template);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Map&lt;String,String&gt; resultMap = Sign.<span style="color:#007f7f">sign</span>(ticket, url);
</span></span><span style="display:flex;"><span>        WxShare wx = <span style="color:#fff;font-weight:bold">new</span> WxShare();
</span></span><span style="display:flex;"><span>        wx.<span style="color:#007f7f">setTicket</span>(resultMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;jsapi_ticket&#34;</span>));
</span></span><span style="display:flex;"><span>        wx.<span style="color:#007f7f">setSignature</span>(resultMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;signature&#34;</span>));
</span></span><span style="display:flex;"><span>        wx.<span style="color:#007f7f">setNoncestr</span>(resultMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;nonceStr&#34;</span>));
</span></span><span style="display:flex;"><span>        wx.<span style="color:#007f7f">setTimestamp</span>(resultMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;timestamp&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> wx;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//获取token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> String getAccessToken(StringRedisTemplate template) {
</span></span><span style="display:flex;"><span>        String access_token = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//获取access_token填写client_credential
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String grant_type = <span style="color:#0ff;font-weight:bold">&#34;client_credential&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//第三方用户唯一凭证
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String AppId= PayConstant.<span style="color:#007f7f">WX_H5_APPID</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//第三方用户唯一凭证密钥，即appsecret
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String secret=PayConstant.<span style="color:#007f7f">WX_H5_APPSECRET</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//访问链接,这个url链接地址和参数皆不能变
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String url = <span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/cgi-bin/token?grant_type=&#34;</span>+grant_type+<span style="color:#0ff;font-weight:bold">&#34;&amp;appid=&#34;</span>+AppId+<span style="color:#0ff;font-weight:bold">&#34;&amp;secret=&#34;</span>+secret;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            URL urlGet = <span style="color:#fff;font-weight:bold">new</span> URL(url);
</span></span><span style="display:flex;"><span>            HttpURLConnection http = (HttpURLConnection) urlGet.<span style="color:#007f7f">openConnection</span>();
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setRequestMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;GET&#34;</span>); <span style="color:#007f7f">// 必须是get方式请求
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            http.<span style="color:#007f7f">setRequestProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;Content-Type&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;application/x-www-form-urlencoded&#34;</span>);
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setDoOutput</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setDoInput</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">/*System.setProperty(&#34;sun.net.client.defaultConnectTimeout&#34;, &#34;30000&#34;);// 连接超时30秒
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            System.setProperty(&#34;sun.net.client.defaultReadTimeout&#34;, &#34;30000&#34;); // 读取超时30秒 */</span>
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">connect</span>();
</span></span><span style="display:flex;"><span>            InputStream is = http.<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> size = is.<span style="color:#007f7f">available</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">byte</span>[] jsonBytes = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[size];
</span></span><span style="display:flex;"><span>            is.<span style="color:#007f7f">read</span>(jsonBytes);
</span></span><span style="display:flex;"><span>            String message = <span style="color:#fff;font-weight:bold">new</span> String(jsonBytes, <span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>            JSONObject demoJson = JSONObject.<span style="color:#007f7f">fromObject</span>(message);
</span></span><span style="display:flex;"><span>            access_token = demoJson.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;access_token&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//缓存到redis，一定要缓存，每天只能请求2000次
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            template.<span style="color:#007f7f">opsForValue</span>().<span style="color:#007f7f">set</span>(<span style="color:#0ff;font-weight:bold">&#34;wx_base_access_token&#34;</span>,access_token,<span style="color:#ff0;font-weight:bold">2</span>, TimeUnit.<span style="color:#007f7f">HOURS</span>);
</span></span><span style="display:flex;"><span>            is.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> access_token;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//获取ticket
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> String getTicket(String access_token,StringRedisTemplate template) {
</span></span><span style="display:flex;"><span>        String ticket = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//这个url链接和参数不能变
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String url = <span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=&#34;</span>+ access_token +<span style="color:#0ff;font-weight:bold">&#34;&amp;type=jsapi&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            URL urlGet = <span style="color:#fff;font-weight:bold">new</span> URL(url);
</span></span><span style="display:flex;"><span>            HttpURLConnection http = (HttpURLConnection) urlGet.<span style="color:#007f7f">openConnection</span>();
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setRequestMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;GET&#34;</span>); <span style="color:#007f7f">// 必须是get方式请求
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            http.<span style="color:#007f7f">setRequestProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;Content-Type&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;application/x-www-form-urlencoded&#34;</span>);
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setDoOutput</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            http.<span style="color:#007f7f">setDoInput</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;sun.net.client.defaultConnectTimeout&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;30000&#34;</span>);<span style="color:#007f7f">// 连接超时30秒
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;sun.net.client.defaultReadTimeout&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;30000&#34;</span>); <span style="color:#007f7f">// 读取超时30秒
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            http.<span style="color:#007f7f">connect</span>();
</span></span><span style="display:flex;"><span>            InputStream is = http.<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> size = is.<span style="color:#007f7f">available</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">byte</span>[] jsonBytes = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[size];
</span></span><span style="display:flex;"><span>            is.<span style="color:#007f7f">read</span>(jsonBytes);
</span></span><span style="display:flex;"><span>            String message = <span style="color:#fff;font-weight:bold">new</span> String(jsonBytes, <span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>            JSONObject demoJson = JSONObject.<span style="color:#007f7f">fromObject</span>(message);
</span></span><span style="display:flex;"><span>            ticket = demoJson.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;ticket&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//缓存到redis，一定要缓存，每天只能请求2000次
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            template.<span style="color:#007f7f">opsForValue</span>().<span style="color:#007f7f">set</span>(<span style="color:#0ff;font-weight:bold">&#34;wx_jsapi_ticket&#34;</span>,ticket,<span style="color:#ff0;font-weight:bold">2</span>, TimeUnit.<span style="color:#007f7f">HOURS</span>);
</span></span><span style="display:flex;"><span>            is.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ticket;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="获取url并进行签名">获取url，并进行签名<a hidden class="anchor" aria-hidden="true" href="#获取url并进行签名">#</a></h3>
<p>url的获取要特别注意，因为微信在分享时会在原来的url上加上一些<code>&amp;from=singlemessage、&amp;from=…</code>的，所以url必须要动态获取，网上有些用ajax，在网页通过“location.href.split(‘#’)“ 获取url，在用ajax传给后台，这种方法可行，但是不推荐，一方面用ajax返回，就要访问分享的逻辑，这样后台分享的逻辑增加复杂度，带来不便，是代码不易于维护，可读性低！另一方面分享是返回页面，而ajax是返回json，又增加了复杂度。所以，一个java程序员是不会通过ajax从前台获取url的，这里我们用HttpRequest的方法即可，不管微信加多少后缀，都可以获取到完整的当前url。</p>
<p>获取url的controller如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@PostMapping(&#34;/share&#34;)
</span></span><span style="display:flex;"><span>public ResponseUtil getQuestionList(@RequestBody Map&lt;String,String&gt; paramMap){
</span></span><span style="display:flex;"><span>	LOGGER.info(
</span></span><span style="display:flex;"><span>	&#34;\n***************************************&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>			&#34;start share&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>			&#34;分享&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>			&#34;\n********************************************&#34;
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	ResponseUtil response = ResponseUtil.success();
</span></span><span style="display:flex;"><span>	CodeEnum code = CodeEnum.FAIL;
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;前端传过来的&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;：&#34; + paramMap.get(&#34;strUrl&#34;));
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;URI解码&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;：&#34; + URI.create(paramMap.get(&#34;strUrl&#34;)).getPath());
</span></span><span style="display:flex;"><span>		response.setData(wxUtil.getWxEntity(URI.create(paramMap.get(&#34;strUrl&#34;)).getPath(),redisTemplate));
</span></span><span style="display:flex;"><span>	} catch (Exception e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		response.setCode(code);
</span></span><span style="display:flex;"><span>		response.setMessage(e.getMessage());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return response;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要注意：这个url是前端动态获取的，不能写死。如果带参数，或是中文，前端要对url做<code>encodeURIComponent</code>转码，后台再使用<code>URI.create(paramMap.get(&quot;strUrl&quot;)).getPath()</code>进行解码。</p>
<p>我们再新建一个存放微信信息的实体类：wx.java</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> wx {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String access_token;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String ticket ;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String noncestr;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String timestamp;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String str;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String signature;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   ...<span style="color:#007f7f">setter</span> and getter...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>sign类里面有一个签名的方法<code>sign</code>，传入ticket和url即可。也就是WeinXinUtil的getWinXinEntity方法，并将返回的map的信息读取存入WinXinEntity中。
在调试时，把sign返回的map打印出来，主要看看生成的signature。然后，把jsapi_ticket、noncestr、timestamp、url 复制到微信提供的<a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign">微信 JS 接口签名校验工具</a>，
比较代码签名生成的signature与校验工具生成的签名signature是否一致，如果一致，说明前面的步骤都是正确的，如果不一致，仔细检查。</p>
<h3 id="controller">controller<a hidden class="anchor" aria-hidden="true" href="#controller">#</a></h3>
<p>我们把微信分享分解成3个工具类，现在在处理分享的controller，只要两句话就可以调用微信分享，一句获取url，一句获取WinXinEntity，代码已经在上边给出了。</p>
<h3 id="前端config函数配置">前端config函数配置<a hidden class="anchor" aria-hidden="true" href="#前端config函数配置">#</a></h3>
<p>下面的代码放在网页js代码的最前面！
”var url = location.href.split(‘#’)[0];“ 页面的url也可以从后台传过来，也可以通过location.href.split(‘#’)[0]获取。
为了一点微不足道的速度，这里才用网页获取方式。（网页的url跟前面的后台签名时得url是一样的，只是绕过了ajax）</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>&lt;script src=<span style="color:#0ff;font-weight:bold">&#34;http://res.wx.qq.com/open/js/jweixin-1.2.0.js&#34;</span>&gt;&lt;<span style="color:#f00">/script&gt;</span>
</span></span><span style="display:flex;"><span>&lt;script&gt;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">var</span> url = location.href.split(<span style="color:#0ff;font-weight:bold">&#39;#&#39;</span>)[<span style="color:#ff0;font-weight:bold">0</span>];
</span></span><span style="display:flex;"><span>    wx.config({
</span></span><span style="display:flex;"><span>    debug: <span style="color:#fff;font-weight:bold">false</span>,
</span></span><span style="display:flex;"><span>    appId: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxxxxxx&#39;</span>,
</span></span><span style="display:flex;"><span>    timestamp: <span style="color:#0ff;font-weight:bold">&#34;${wx.timestamp}&#34;</span>,
</span></span><span style="display:flex;"><span>    nonceStr: <span style="color:#0ff;font-weight:bold">&#34;${wx.noncestr}&#34;</span>,
</span></span><span style="display:flex;"><span>    signature: <span style="color:#0ff;font-weight:bold">&#34;${wx.signature}&#34;</span>,
</span></span><span style="display:flex;"><span>    jsApiList: [
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">// 所有要调用的 API 都要加到这个列表中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>       <span style="color:#0ff;font-weight:bold">&#39;checkJsApi&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#0ff;font-weight:bold">&#39;onMenuShareTimeline&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#0ff;font-weight:bold">&#39;onMenuShareAppMessage&#39;</span>,
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  wx.ready(<span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 在这里调用 API
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>     wx.onMenuShareTimeline({
</span></span><span style="display:flex;"><span>    title: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxx&#39;</span>, <span style="color:#007f7f">// 分享标题
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    link: url, <span style="color:#007f7f">// 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    imgUrl: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxxxxxx&#39;</span>, <span style="color:#007f7f">// 分享图标
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    success: <span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 用户确认分享后执行的回调函数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    },
</span></span><span style="display:flex;"><span>    cancel: <span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 用户取消分享后执行的回调函数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>wx.onMenuShareAppMessage({
</span></span><span style="display:flex;"><span>   title: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxxx&#39;</span>, <span style="color:#007f7f">// 分享标题
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    desc: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxxx&#39;</span>, <span style="color:#007f7f">// 分享描述
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    link: url, <span style="color:#007f7f">// 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    imgUrl: <span style="color:#0ff;font-weight:bold">&#39;xxxxxxxxxx&#39;</span>, <span style="color:#007f7f">// 分享图标
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    type: <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>, <span style="color:#007f7f">// 分享类型,music、video或link，不填默认为link
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    dataUrl: <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>, <span style="color:#007f7f">// 如果type是music或video，则要提供数据链接，默认为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    success: <span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 用户确认分享后执行的回调函数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    },
</span></span><span style="display:flex;"><span>    cancel: <span style="color:#fff;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 用户取消分享后执行的回调函数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f00">/script&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="分享链接带参数的情况">分享链接带参数的情况<a hidden class="anchor" aria-hidden="true" href="#分享链接带参数的情况">#</a></h3>
<p>前端的链接如果带参数，<code>www.xxx.com/xxx?a=1&amp;b=2</code>，传给后台必须使用<code>encodeURIComponent</code>转码，<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141115">参考官方文档</a>，
但是官方文档并没有说，后台要把前端传的url再解码！即：
<code>URI.create(paramMap.get(&quot;strUrl&quot;)).getPath()</code>
不要使用<code>URLDecoder.decode(paramMap.get(&quot;strUrl&quot;))</code>，该方法将要被废弃。</p>
<p>不带参数可以不转码，若带参数必须转码，后台再解码！！
<a href="https://www.cnblogs.com/vipstone/p/6732660.html">参考地址</a></p>
<h2 id="微信小程序登录">微信小程序登录<a hidden class="anchor" aria-hidden="true" href="#微信小程序登录">#</a></h2>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">官方文档</a>
登录流程时序图
<img loading="lazy" src="3.jpg" alt=""  />

微信的文档写的像狗屎，所以我抄了一份时序图：
<img loading="lazy" src="4.jpg" alt=""  />
</p>
<p>大致流程如下：</p>
<ul>
<li>程序客户端调用wx.login，回调里面包含js_code。</li>
<li>然后将js_code发送到服务器A（开发者服务器）,服务器A向微信服务器发起请求附带js_code、appId、secretkey和grant_type参数，以换取用户的openid和session_key（会话密钥）。</li>
<li>服务器A拿到session_key后，生成一个随机数我们叫3rd_session,以3rdSessionId为key,以session_key + openid为value缓存到redis或memcached中；因为微信团队不建议直接将session_key在网络上传输，由开发者自行生成唯一键与session_key关联。其作用是：
<ul>
<li>将3rdSessionId返回给客户端，维护小程序登录态。</li>
<li>通过3rdSessionId找到用户session_key和openid。</li>
</ul>
</li>
<li>客户端拿到3rdSessionId后缓存到storage。</li>
<li>客户端通过wx.getUserIinfo可以获取到用户敏感数据encryptedData。</li>
<li>客户端将encryptedData、3rdSessionId和偏移量一起发送到服务器A</li>
<li>服务器A根据3rdSessionId从缓存中获取session_key</li>
<li>在服务器A使用AES解密encryptedData，从而实现用户敏感数据解密</li>
</ul>
<p>重点在6、7、8三个环节。
AES解密三个参数：</p>
<ul>
<li>密文 encryptedData</li>
<li>密钥 aesKey</li>
<li>偏移向量 iv</li>
</ul>
<p>服务端解密流程：</p>
<ul>
<li>密文和偏移向量由客户端发送给服务端，对这两个参数在服务端进行Base64_decode解编码操作。</li>
<li>根据3rdSessionId从缓存中获取session_key，对session_key进行Base64_decode可以得到aesKey，aes密钥。</li>
<li>调用aes解密方法，算法为 AES-128-CBC，数据采用PKCS#7填充。</li>
</ul>
<p>下面结合小程序实例说明解密流程：</p>
<ol>
<li>微信登录，获取用户信息</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">var</span> that = <span style="color:#fff;font-weight:bold">this</span>;
</span></span><span style="display:flex;"><span>wx.login({
</span></span><span style="display:flex;"><span>success: <span style="color:#fff;font-weight:bold">function</span> (res) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//微信js_code
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    that.setData({wxcode: res.code});
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//获取用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    wx.getUserInfo({
</span></span><span style="display:flex;"><span>        success: <span style="color:#fff;font-weight:bold">function</span> (res) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//获取用户敏感数据密文和偏移向量
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            that.setData({encryptedData: res.encryptedData})
</span></span><span style="display:flex;"><span>            that.setData({iv: res.iv})
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>使用code换取3rdSessionId</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">var</span> httpclient = require(<span style="color:#0ff;font-weight:bold">&#39;../../utils/httpclient.js&#39;</span>)
</span></span><span style="display:flex;"><span>VAR that = <span style="color:#fff;font-weight:bold">this</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//httpclient.req(url, data, method, success, fail)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>httpclient.req(
</span></span><span style="display:flex;"><span>  <span style="color:#0ff;font-weight:bold">&#39;http://localhost:8090/wxappservice/api/v1/wx/getSession&#39;</span>,
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      apiName: <span style="color:#0ff;font-weight:bold">&#39;WX_CODE&#39;</span>,
</span></span><span style="display:flex;"><span>      code: <span style="color:#fff;font-weight:bold">this</span>.data.wxcode
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#0ff;font-weight:bold">&#39;GET&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">function</span>(result){
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">var</span> thirdSessionId = result.data.data.sessionId;
</span></span><span style="display:flex;"><span>    that.setData({thirdSessionId: thirdSessionId})
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//将thirdSessionId放入小程序缓存
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    wx.setStorageSync(<span style="color:#0ff;font-weight:bold">&#39;thirdSessionId&#39;</span>, thirdSessionId)
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">function</span>(result){
</span></span><span style="display:flex;"><span>    console.log(result)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>发起解密请求</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#007f7f">//httpclient.req(url, data, method, success, fail)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>httpclient.req(
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#39;http://localhost:8090/wxappservice/api/v1/wx/decodeUserInfo&#39;</span>,
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    apiName: <span style="color:#0ff;font-weight:bold">&#39;WX_DECODE_USERINFO&#39;</span>,
</span></span><span style="display:flex;"><span>    encryptedData: <span style="color:#fff;font-weight:bold">this</span>.data.encryptedData,
</span></span><span style="display:flex;"><span>    iv: <span style="color:#fff;font-weight:bold">this</span>.data.iv,
</span></span><span style="display:flex;"><span>    sessionId: wx.getStorageSync(<span style="color:#0ff;font-weight:bold">&#39;thirdSessionId&#39;</span>)
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#0ff;font-weight:bold">&#39;GET&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">function</span>(result){
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f">//解密后的数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    console.log(result.data)
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">function</span>(result){
</span></span><span style="display:flex;"><span>    console.log(result)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>通过前端获取的code，获取openid和session_key</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * @author: wjy
</span></span><span style="display:flex;"><span> * @description: 小程序，通过code获取session_key和openid
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@PostMapping(&#34;getSessionId&#34;)
</span></span><span style="display:flex;"><span>public ResponseUtil getSessionId(@RequestBody Map&lt;String,String&gt; paramMap){
</span></span><span style="display:flex;"><span>	LOGGER.info(
</span></span><span style="display:flex;"><span>			&#34;\n***************************************&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;start getSessionId&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;通过code获取session_key和openid&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;paramMap&#34; + paramMap +&#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;\n********************************************&#34;
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	ResponseUtil response = ResponseUtil.success();
</span></span><span style="display:flex;"><span>	CodeEnum code = CodeEnum.FAIL;
</span></span><span style="display:flex;"><span>	JSONObject jsonObject;
</span></span><span style="display:flex;"><span>	try{
</span></span><span style="display:flex;"><span>		AssertUtil.assertValidate(code,CodeEnum.ERROR_2001.getCode(),&#34;code不能为空&#34;,StringUtils.isNotEmpty(paramMap.get(&#34;code&#34;)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//完整地址示例
</span></span><span style="display:flex;"><span>		//https://api.weixin.qq.com/sns/jscode2session?appid=APPID&amp;secret=SECRET&amp;js_code=JSCODE&amp;grant_type=authorization_code
</span></span><span style="display:flex;"><span>		String url = &#34;https://api.weixin.qq.com/sns/jscode2session&#34;;
</span></span><span style="display:flex;"><span>		String param =
</span></span><span style="display:flex;"><span>				&#34;appid=&#34; + PayConstant.XCX_APPID +
</span></span><span style="display:flex;"><span>				&#34;&amp;secret=&#34; + PayConstant.XCX_APPSECRET +
</span></span><span style="display:flex;"><span>				&#34;&amp;js_code=&#34; + paramMap.get(&#34;code&#34;) +
</span></span><span style="display:flex;"><span>				&#34;&amp;grant_type=authorization_code&#34;;
</span></span><span style="display:flex;"><span>		//向微信服务器发送get请求,获取session_key和openid
</span></span><span style="display:flex;"><span>		String sessionKeyAndOpenid = HttpUtil.sendGet(url, param);
</span></span><span style="display:flex;"><span>		jsonObject = JSONObject.parseObject(sessionKeyAndOpenid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		String uuid = UUID.randomUUID().toString().replaceAll(&#34;-&#34;,&#34;&#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;session_key是：~~~~~~~~~~~~~~~~&#34; + jsonObject.getString(&#34;session_key&#34;));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//将获取到的session_key存入redis，这里不用设置过期时间
</span></span><span style="display:flex;"><span>		stringRedisTemplate.opsForValue().set(uuid,jsonObject.getString(&#34;session_key&#34;));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//把uuid返回给前端
</span></span><span style="display:flex;"><span>		response.setData(uuid);
</span></span><span style="display:flex;"><span>	}catch (Exception e){
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		response.setCode(code);
</span></span><span style="display:flex;"><span>		response.setMessage(e.getMessage());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return response;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>后端用session_key，encryptedData，iv解密获取用户信息userinfo。
后端解密其实就这么简单，只要流程对了就可以解密，如果解密出错，基本就是流程出错了。不用再去换什么解密算法。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public Object getPhoneNumber(String encryptedData, String session_key, String iv) {
</span></span><span style="display:flex;"><span>		 // 被加密的数据
</span></span><span style="display:flex;"><span>		byte[] dataByte = Base64.decode(encryptedData);
</span></span><span style="display:flex;"><span>		// 加密秘钥
</span></span><span style="display:flex;"><span>		byte[] keyByte = Base64.decode(session_key);
</span></span><span style="display:flex;"><span>		// 偏移量
</span></span><span style="display:flex;"><span>		byte[] ivByte = Base64.decode(iv);
</span></span><span style="display:flex;"><span>		try {
</span></span><span style="display:flex;"><span>			// 如果密钥不足16位，那么就补足.  这个if 中的内容很重要
</span></span><span style="display:flex;"><span>			int base = 16;
</span></span><span style="display:flex;"><span>			if (keyByte.length % base != 0) {
</span></span><span style="display:flex;"><span>				int groups = keyByte.length / base + (keyByte.length % base != 0 ? 1 : 0);
</span></span><span style="display:flex;"><span>				byte[] temp = new byte[groups * base];
</span></span><span style="display:flex;"><span>				Arrays.fill(temp, (byte) 0);
</span></span><span style="display:flex;"><span>				System.arraycopy(keyByte, 0, temp, 0, keyByte.length);
</span></span><span style="display:flex;"><span>				keyByte = temp;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			// 初始化
</span></span><span style="display:flex;"><span>			Security.addProvider(new BouncyCastleProvider());
</span></span><span style="display:flex;"><span>			Cipher cipher = Cipher.getInstance(&#34;AES/CBC/PKCS5Padding&#34;);
</span></span><span style="display:flex;"><span>			SecretKeySpec spec = new SecretKeySpec(keyByte, &#34;AES&#34;);
</span></span><span style="display:flex;"><span>			AlgorithmParameters parameters = AlgorithmParameters.getInstance(&#34;AES&#34;);
</span></span><span style="display:flex;"><span>			parameters.init(new IvParameterSpec(ivByte));
</span></span><span style="display:flex;"><span>			cipher.init(Cipher.DECRYPT_MODE, spec, parameters);// 初始化
</span></span><span style="display:flex;"><span>			byte[] resultByte = cipher.doFinal(dataByte);
</span></span><span style="display:flex;"><span>			if (null != resultByte &amp;&amp; resultByte.length &gt; 0) {
</span></span><span style="display:flex;"><span>				String result = new String(resultByte, &#34;UTF-8&#34;);
</span></span><span style="display:flex;"><span>				return JSONObject.parseObject(result);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		} catch (Exception e) {
</span></span><span style="display:flex;"><span>			e.printStackTrace();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	return null;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上边分别请求了两次后台接口，其实完全可以合并成一次请求，参考下边获取手机号的内容。</p>
<p><a href="https://www.cnblogs.com/cangqinglang/p/8944681.html">参考1</a>
<a href="https://blog.csdn.net/qi923701/article/details/81534820">参考2</a>
<a href="https://blog.csdn.net/weixin_38429587/article/details/82814325">参考3</a></p>
<h2 id="小程序获取手机号">小程序获取手机号<a hidden class="anchor" aria-hidden="true" href="#小程序获取手机号">#</a></h2>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html">官方文档</a></p>
<ol>
<li>前端调用 wx.login() 获取code</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>wx.login({
</span></span><span style="display:flex;"><span>    success:function(res){
</span></span><span style="display:flex;"><span>        console.log(&#39;loginCode:&#39;, res.code)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>后端拿到该code发送get请求微信接口获取 session_key和openid，返回结果类似：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	&#34;session_key&#34;: &#34;kI+3ookOAYC9olOcGzYPmQ&#34;,
</span></span><span style="display:flex;"><span>	&#34;openid&#34;: &#34;oNZE65Pu0XfTg2yFP-dFks&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>后台拿到数据后，我们把session_key存到redis，然后把session_key存在redis中的key返回给前端。因为微信官方说：
<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">为了应用自身的数据安全，开发者服务器不应该把会话密钥下发到小程序，也不应该对外提供这个密钥</a></p>
<ol start="3">
<li>前端调用 getPhoneNumber组件，用户确认授权。拿到encryptedData和iv。并传给后端。
<code>&lt;button open-type=&quot;getPhoneNumber&quot; bindgetphonenumber=&quot;getPhoneNumber&quot;&gt; &lt;/button&gt;</code></li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>getPhoneNumber: function(e) { 
</span></span><span style="display:flex;"><span>    console.log(e.detail.errMsg) 
</span></span><span style="display:flex;"><span>    console.log(e.detail.iv) 
</span></span><span style="display:flex;"><span>    console.log(e.detail.encryptedData) 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>后端用session_key，encryptedData，iv解密获取手机号。
后端解密其实就这么简单，只要流程对了就可以解密，如果解密出错，基本就是流程出错了。不用再去换什么解密算法。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public Object getPhoneNumber(String encryptedData, String session_key, String iv) {
</span></span><span style="display:flex;"><span>		 // 被加密的数据
</span></span><span style="display:flex;"><span>		byte[] dataByte = Base64.decode(encryptedData);
</span></span><span style="display:flex;"><span>		// 加密秘钥
</span></span><span style="display:flex;"><span>		byte[] keyByte = Base64.decode(session_key);
</span></span><span style="display:flex;"><span>		// 偏移量
</span></span><span style="display:flex;"><span>		byte[] ivByte = Base64.decode(iv);
</span></span><span style="display:flex;"><span>		try {
</span></span><span style="display:flex;"><span>			// 如果密钥不足16位，那么就补足.  这个if 中的内容很重要
</span></span><span style="display:flex;"><span>			int base = 16;
</span></span><span style="display:flex;"><span>			if (keyByte.length % base != 0) {
</span></span><span style="display:flex;"><span>				int groups = keyByte.length / base + (keyByte.length % base != 0 ? 1 : 0);
</span></span><span style="display:flex;"><span>				byte[] temp = new byte[groups * base];
</span></span><span style="display:flex;"><span>				Arrays.fill(temp, (byte) 0);
</span></span><span style="display:flex;"><span>				System.arraycopy(keyByte, 0, temp, 0, keyByte.length);
</span></span><span style="display:flex;"><span>				keyByte = temp;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			// 初始化
</span></span><span style="display:flex;"><span>			Security.addProvider(new BouncyCastleProvider());
</span></span><span style="display:flex;"><span>			Cipher cipher = Cipher.getInstance(&#34;AES/CBC/PKCS5Padding&#34;);
</span></span><span style="display:flex;"><span>			SecretKeySpec spec = new SecretKeySpec(keyByte, &#34;AES&#34;);
</span></span><span style="display:flex;"><span>			AlgorithmParameters parameters = AlgorithmParameters.getInstance(&#34;AES&#34;);
</span></span><span style="display:flex;"><span>			parameters.init(new IvParameterSpec(ivByte));
</span></span><span style="display:flex;"><span>			cipher.init(Cipher.DECRYPT_MODE, spec, parameters);// 初始化
</span></span><span style="display:flex;"><span>			byte[] resultByte = cipher.doFinal(dataByte);
</span></span><span style="display:flex;"><span>			if (null != resultByte &amp;&amp; resultByte.length &gt; 0) {
</span></span><span style="display:flex;"><span>				String result = new String(resultByte, &#34;UTF-8&#34;);
</span></span><span style="display:flex;"><span>				return JSONObject.parseObject(result);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		} catch (Exception e) {
</span></span><span style="display:flex;"><span>			e.printStackTrace();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	return null;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上边是请求了两次接口，其实完全可以只请求一次接口：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * @author: wjy
</span></span><span style="display:flex;"><span> * @description: 小程序登录，返回用户信息
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@PostMapping(&#34;xcxRegisterOrLogin&#34;)
</span></span><span style="display:flex;"><span>public ResponseUtil xcxRegisterOrLogin(@RequestBody Map&lt;String,String&gt; paramMap){
</span></span><span style="display:flex;"><span>	LOGGER.info(
</span></span><span style="display:flex;"><span>			&#34;\n***************************************&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;start xcxRegisterOrLogin&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;小程序登录，返回用户信息&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;paramMap&#34; + paramMap +&#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;\n********************************************&#34;
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	ResponseUtil response = ResponseUtil.success();
</span></span><span style="display:flex;"><span>	CodeEnum code = CodeEnum.FAIL;
</span></span><span style="display:flex;"><span>	JSONObject jsonObject;
</span></span><span style="display:flex;"><span>	try{
</span></span><span style="display:flex;"><span>		AssertUtil.assertValidate(code,CodeEnum.ERROR_2001.getCode(),&#34;iv不能为空&#34;,StringUtils.isNotEmpty(paramMap.get(&#34;iv&#34;)));
</span></span><span style="display:flex;"><span>		AssertUtil.assertValidate(code,CodeEnum.ERROR_2001.getCode(),&#34;code不能为空&#34;,StringUtils.isNotEmpty(paramMap.get(&#34;code&#34;)));
</span></span><span style="display:flex;"><span>		AssertUtil.assertValidate(code,CodeEnum.ERROR_2003.getCode(),&#34;encryptedData不能为空&#34;,StringUtils.isNotEmpty(paramMap.get(&#34;encryptedData&#34;)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//完整地址示例
</span></span><span style="display:flex;"><span>		//https://api.weixin.qq.com/sns/jscode2session?appid=APPID&amp;secret=SECRET&amp;js_code=JSCODE&amp;grant_type=authorization_code
</span></span><span style="display:flex;"><span>		String url = &#34;https://api.weixin.qq.com/sns/jscode2session&#34;;
</span></span><span style="display:flex;"><span>		String param = &#34;appid=&#34; + PayConstant.XCX_APPID +
</span></span><span style="display:flex;"><span>				&#34;&amp;secret=&#34; + PayConstant.XCX_APPSECRET +
</span></span><span style="display:flex;"><span>				&#34;&amp;js_code=&#34; + paramMap.get(&#34;code&#34;) +
</span></span><span style="display:flex;"><span>				&#34;&amp;grant_type=authorization_code&#34;;
</span></span><span style="display:flex;"><span>		//向微信服务器发送get请求,获取session_key和openid
</span></span><span style="display:flex;"><span>		String wxReturnJson = HttpUtil.sendGet(url, param);
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;微信返回结果是：~~~~~~~~~~~~~~~~&#34; + wxReturnJson);
</span></span><span style="display:flex;"><span>		jsonObject = JSONObject.parseObject(wxReturnJson);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//解密用户信息
</span></span><span style="display:flex;"><span>		JSONObject userinfo = XcxUtil.decodeUserInfo(paramMap.get(&#34;encryptedData&#34;),jsonObject.getString(&#34;session_key&#34;),paramMap.get(&#34;iv&#34;));
</span></span><span style="display:flex;"><span>		//用户手机号
</span></span><span style="display:flex;"><span>		String phoneNum = userinfo.getString(&#34;purePhoneNumber&#34;);
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;用户手机号是：~~~~~~~~~~~~~~~~&#34; + phoneNum);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		paramMap.put(&#34;mobile&#34;,phoneNum);
</span></span><span style="display:flex;"><span>		//根据手机号，注册或登录
</span></span><span style="display:flex;"><span>		response = usersService.registerOrLogin(paramMap,response);
</span></span><span style="display:flex;"><span>	}catch (Exception e){
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		response.setCode(code);
</span></span><span style="display:flex;"><span>		response.setMessage(e.getMessage());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return response;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个接口，我接收了code、iv、encryptedData三个参数。
其中code是前端请求<code>wx.login()</code>返回的，<code>iv、encryptedData</code>是前端请求<code>wx.userinfo()</code>返回的。
我的接口中，先通过code请求微信服务器，获取<code>session_key</code>和<code>openid</code>，然后通过<code>session_key、iv、encryptedData</code>进行解密，就得到了用户手机号。
后续是自己业务的逻辑，即通过手机号判断自己的数据库是否有这个用户，有-&gt;返回用户信息(即登录)，没有-&gt;注册并返回用户信息。</p>
<p><a href="https://blog.csdn.net/qq_36466653/article/details/83374485">参考1</a>
<a href="https://blog.csdn.net/Lonely_Devil/article/details/90024579">参考2</a></p>
<p>获取手机号和获取用户信息，两套流程的区别，只在于前端第二次请求微信接口的不同。每个步骤，对于后台来说都是一样的。
后台只需要通过前端获取的code，获取session_id和openid，然后再用三个参数<code>session_key，iv，encryptedData</code>进行解密即可。</p>
<ul>
<li>获取用户信息，前端调用<code>wx.getUserInfo(Object object)</code><a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html">官方文档</a></li>
<li>获取手机号，前端调用<code>getPhoneNumber</code><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html">官方文档</a></li>
</ul>
<p>所以，获取用户信息和获取用户手机号，后台只需一个接口即可，但是需要注意，解密出来的，一个是手机号，一个是用户信息，所以可能还需要在自己的业务中，对两种不同的参数采取不同的处理。</p>
<p><strong>后台请求微信授权，在本地即可以测试，只要有code或encryptedData和iv(这三个参数需要前端给你)，不用非拿到线上去测。而且，小程序后台，也无需配置服务器域名啥的。</strong></p>
<h2 id="小程序发送消息">小程序发送消息<a hidden class="anchor" aria-hidden="true" href="#小程序发送消息">#</a></h2>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/server-ability/message-push.html">官方文档</a>
<a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/customer-message/customerServiceMessage.send.html">文档2</a>
微信的官方文档真的是屎一样，毫无逻辑调理。每次要写和微信相关的功能头都很大。</p>
<p>功能介绍：
前端添加按钮后，用户点击按钮，即可跳转到小程序客服界面。
此时有三种做法：
1.前端直接请求微信接口给客服发送消息。
2.前端请求开发者的服务器接口，由开发者服务器请求微信服务器，发送消息。
3.通过小程序后台的配置，由微信服务器请求开发者服务器，发送消息。
这里我们使用第三种方法。</p>
<ul>
<li>登录<a href="https://mp.weixin.qq.com/">微信公众平台</a>
小程序管理后台-&gt;开发-&gt;开发设置-&gt;消息推送-&gt;启用。
几个需要填写的参数：
URL(服务器地址)：填写我们自己服务器可以get请求的一个方法，必须是方法的全路径，如：<code>http://test.api.zjxk12.com/zjx/api/pay/checkSignature</code>
token令牌：随便写，但是要保存在程序中，用于验证一致性。
EncodingAESKey(消息加密密钥)：在当前页面自动生成。
消息加密方式：推荐兼容模式。
数据格式：我选的json。</li>
</ul>
<p>此时点确定还是不行的，因为我们的服务端还没有接口，这个接口就是上边我们填写的地址，点击确定的时候，微信服务器会调用这个接口。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@GetMapping(&#34;checkSignature&#34;)
</span></span><span style="display:flex;"><span>public void checkSignature(HttpServletRequest request, HttpServletResponse response) throws Exception{
</span></span><span style="display:flex;"><span>	// 微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数。
</span></span><span style="display:flex;"><span>	String signature = request.getParameter(&#34;signature&#34;);
</span></span><span style="display:flex;"><span>	// 时间戳
</span></span><span style="display:flex;"><span>	String timestamp = request.getParameter(&#34;timestamp&#34;);
</span></span><span style="display:flex;"><span>	// 随机数
</span></span><span style="display:flex;"><span>	String nonce = request.getParameter(&#34;nonce&#34;);
</span></span><span style="display:flex;"><span>	// 随机字符串
</span></span><span style="display:flex;"><span>	String echostr = request.getParameter(&#34;echostr&#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	PrintWriter out = null;
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		out = response.getWriter();
</span></span><span style="display:flex;"><span>		// 通过检验signature对请求进行校验，若校验成功则原样返回echostr，否则接入失败
</span></span><span style="display:flex;"><span>		if (XcxUtil.checkSignature(signature, timestamp, nonce)) {
</span></span><span style="display:flex;"><span>			out.print(echostr);
</span></span><span style="display:flex;"><span>			out.flush();   //这个地方必须画重点，消息推送配置Token令牌错误校验失败，搞了我很久，必须要刷新！！！！！！！
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} catch (IOException e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>	} finally {
</span></span><span style="display:flex;"><span>		out.close();
</span></span><span style="display:flex;"><span>		out = null;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>内部调用的方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * 验证签名
</span></span><span style="display:flex;"><span> * @param signature
</span></span><span style="display:flex;"><span> * @param timestamp
</span></span><span style="display:flex;"><span> * @param nonce
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>public static boolean checkSignature(String signature, String timestamp, String nonce) {
</span></span><span style="display:flex;"><span>	private static final String XCX_TONEN = &#34;zjx666888&#34;;
</span></span><span style="display:flex;"><span>	//与token 比较
</span></span><span style="display:flex;"><span>	String[] arr = new String[] { XCX_TONEN, timestamp, nonce };
</span></span><span style="display:flex;"><span>	// 将token、timestamp、nonce三个参数进行字典排序
</span></span><span style="display:flex;"><span>	Arrays.sort(arr);
</span></span><span style="display:flex;"><span>	StringBuilder content = new StringBuilder();
</span></span><span style="display:flex;"><span>	for (int i = 0; i &lt; arr.length; i++) {
</span></span><span style="display:flex;"><span>		content.append(arr[i]);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	MessageDigest md = null;
</span></span><span style="display:flex;"><span>	String tmpStr = null;
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		md = MessageDigest.getInstance(&#34;SHA-1&#34;);
</span></span><span style="display:flex;"><span>		// 将三个参数字符串拼接成一个字符串进行sha1加密
</span></span><span style="display:flex;"><span>		byte[] digest = md.digest(content.toString().getBytes());
</span></span><span style="display:flex;"><span>		tmpStr = byteToStr(digest);
</span></span><span style="display:flex;"><span>	} catch (NoSuchAlgorithmException e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	content = null;
</span></span><span style="display:flex;"><span>	// 将sha1加密后的字符串可与signature对比
</span></span><span style="display:flex;"><span>	return tmpStr != null ? tmpStr.equals(signature.toUpperCase()) : false;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个接口写好，传到服务器上，点确定，就可以验证成功了。</p>
<p>因为微信发送消息调用的也是这个接口，所以还需要改这个接口，否则就需要改小程序的配置。接口更改后如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">119
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * @author: wjy
</span></span><span style="display:flex;"><span> * @description: 微信服务器发送小程序消息
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@RequestMapping(value= {&#34;/checkSignature&#34;},method= {RequestMethod.GET, RequestMethod.POST})
</span></span><span style="display:flex;"><span>public void checkSignature(HttpServletRequest request, HttpServletResponse response,@RequestBody Map&lt;String,String&gt; map) throws Exception{
</span></span><span style="display:flex;"><span>	LOGGER.info(
</span></span><span style="display:flex;"><span>			&#34;\n***************************************&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;start xcxGetPhoneNum&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;微信服务器发送小程序消息&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>					&#34;\n********************************************&#34;
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	final String kf_url = &#34;https://api.weixin.qq.com/cgi-bin/message/custom/send&#34;;
</span></span><span style="display:flex;"><span>	boolean isGet=request.getMethod().toLowerCase().equals(&#34;get&#34;);
</span></span><span style="display:flex;"><span>	LOGGER.info(isGet+&#34;---------------&#34;);
</span></span><span style="display:flex;"><span>	if(isGet){//首次验证token
</span></span><span style="display:flex;"><span>		// 微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数。
</span></span><span style="display:flex;"><span>		String signature = request.getParameter(&#34;signature&#34;);
</span></span><span style="display:flex;"><span>		// 时间戳
</span></span><span style="display:flex;"><span>		String timestamp = request.getParameter(&#34;timestamp&#34;);
</span></span><span style="display:flex;"><span>		// 随机数
</span></span><span style="display:flex;"><span>		String nonce = request.getParameter(&#34;nonce&#34;);
</span></span><span style="display:flex;"><span>		// 随机字符串
</span></span><span style="display:flex;"><span>		String echostr = request.getParameter(&#34;echostr&#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		PrintWriter out = null;
</span></span><span style="display:flex;"><span>		try {
</span></span><span style="display:flex;"><span>			out = response.getWriter();
</span></span><span style="display:flex;"><span>			// 通过检验signature对请求进行校验，若校验成功则原样返回echostr，否则接入失败
</span></span><span style="display:flex;"><span>			if (XcxUtil.checkSignature(signature, timestamp, nonce)) {
</span></span><span style="display:flex;"><span>				out.print(echostr);
</span></span><span style="display:flex;"><span>				out.flush();   //这个地方必须画重点，消息推送配置Token令牌错误校验失败，搞了我很久，必须要刷新！！！！！！！
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		} catch (IOException e) {
</span></span><span style="display:flex;"><span>			e.printStackTrace();
</span></span><span style="display:flex;"><span>		} finally {
</span></span><span style="display:flex;"><span>			out.close();
</span></span><span style="display:flex;"><span>			out = null;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}else{// 进入POST聊天处理
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;进入了聊天界面&#34;);
</span></span><span style="display:flex;"><span>		// 接收消息并返回消息  
</span></span><span style="display:flex;"><span>		try {
</span></span><span style="display:flex;"><span>			// 接收消息并返回消息
</span></span><span style="display:flex;"><span>			JSONObject json = null;
</span></span><span style="display:flex;"><span>			//这是通过通过get方式去url 拼接的键值对，post方式取不到值。
</span></span><span style="display:flex;"><span>//                String openid=request.getParameter(&#34;FromUserName&#34;);
</span></span><span style="display:flex;"><span>			String openid = map.get(&#34;FromUserName&#34;);
</span></span><span style="display:flex;"><span>			System.out.println(&#34;openid是：&#34; + openid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			//返回页面防止出现中文乱码
</span></span><span style="display:flex;"><span>			request.setCharacterEncoding(&#34;UTF-8&#34;);
</span></span><span style="display:flex;"><span>			//post方式传递读取字符流
</span></span><span style="display:flex;"><span>			BufferedReader reader = new BufferedReader(new InputStreamReader(request.getInputStream()));
</span></span><span style="display:flex;"><span>			String jsonStr = null;
</span></span><span style="display:flex;"><span>			StringBuilder result = new StringBuilder();
</span></span><span style="display:flex;"><span>			try {
</span></span><span style="display:flex;"><span>				while ((jsonStr = reader.readLine()) != null) {
</span></span><span style="display:flex;"><span>					result.append(jsonStr);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			} catch (IOException e) {
</span></span><span style="display:flex;"><span>				e.printStackTrace();
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			reader.close();// 关闭输入流
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			//获取小程序access_token
</span></span><span style="display:flex;"><span>			String access_token = stringRedisTemplate.opsForValue().get(&#34;xcx_access_token&#34;);
</span></span><span style="display:flex;"><span>			if(StringUtils.isEmpty(access_token)){
</span></span><span style="display:flex;"><span>				LOGGER.info(&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;重新获取小程序access_token&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&#34;);
</span></span><span style="display:flex;"><span>				//已经超时，重新获取
</span></span><span style="display:flex;"><span>				access_token = getXcxAccessToken(stringRedisTemplate);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			PrintWriter out=null;
</span></span><span style="display:flex;"><span>			BufferedReader in=null;
</span></span><span style="display:flex;"><span>			try {
</span></span><span style="display:flex;"><span>				String media_id = stringRedisTemplate.opsForValue().get(&#34;media_id&#34;);
</span></span><span style="display:flex;"><span>				if(null == media_id){
</span></span><span style="display:flex;"><span>					//重新获取media_id
</span></span><span style="display:flex;"><span>					media_id = XcxUtil.uploadMedia(access_token, &#34;image&#34;,&#34;http://file.zjxk12.com/jpg/1587005725424.jpg&#34;,stringRedisTemplate);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				//组装参数体1，图片
</span></span><span style="display:flex;"><span>				Map&lt;String,Object&gt; picMap = new HashMap&lt;&gt;(4);
</span></span><span style="display:flex;"><span>				picMap.put(&#34;msgtype&#34;,&#34;image&#34;);
</span></span><span style="display:flex;"><span>				picMap.put(&#34;touser&#34;,openid);
</span></span><span style="display:flex;"><span>				Map&lt;String,String&gt; inPicMap = new HashMap&lt;&gt;(1);
</span></span><span style="display:flex;"><span>				inPicMap.put(&#34;media_id&#34;,media_id);
</span></span><span style="display:flex;"><span>				picMap.put(&#34;image&#34;,inPicMap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				JSONObject param1 = new JSONObject(picMap);
</span></span><span style="display:flex;"><span>				JSONObject result1 = HttpUtil.sendPost(kf_url + &#34;?access_token=&#34; + access_token,param1);
</span></span><span style="display:flex;"><span>				log.info(&#34;微信返回的结果2: {}&#34;, result1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				//组装参数2，文字
</span></span><span style="display:flex;"><span>				Map&lt;String,Object&gt; wordMap = new HashMap&lt;&gt;(4);
</span></span><span style="display:flex;"><span>				wordMap.put(&#34;msgtype&#34;,&#34;text&#34;);
</span></span><span style="display:flex;"><span>				wordMap.put(&#34;touser&#34;,openid);
</span></span><span style="display:flex;"><span>				Map&lt;String,String&gt; inMap = new HashMap&lt;&gt;(1);
</span></span><span style="display:flex;"><span>				inMap.put(&#34;content&#34;,&#34;由于微信规则变动，您需要点击上方二维码，然后长按识别，关注【最美课本家长】公众号，注册家长端，并绑定学生端APP手机号，就可以在最美课本APP内学习全部内容！&#34;);
</span></span><span style="display:flex;"><span>				wordMap.put(&#34;text&#34;,inMap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				//参数体2
</span></span><span style="display:flex;"><span>				JSONObject param2 = new JSONObject(wordMap);
</span></span><span style="display:flex;"><span>				JSONObject result2 = HttpUtil.sendPost(kf_url + &#34;?access_token=&#34; + access_token,param2);
</span></span><span style="display:flex;"><span>				log.info(&#34;微信返回的结果2: {}&#34;, result2);
</span></span><span style="display:flex;"><span>			} catch (Exception e) {
</span></span><span style="display:flex;"><span>				System.out.println(&#34;发送post请求异常&#34;);
</span></span><span style="display:flex;"><span>				e.printStackTrace();
</span></span><span style="display:flex;"><span>			}finally{
</span></span><span style="display:flex;"><span>				if(out!=null)out.close();
</span></span><span style="display:flex;"><span>				if(in!=null)in.close();
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		} catch (Exception e) {
</span></span><span style="display:flex;"><span>			e.printStackTrace();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>传到服务器上，小程序客服就可以发送消息了。</p>
<h3 id="传媒体文件到微信服务器">传媒体文件到微信服务器<a hidden class="anchor" aria-hidden="true" href="#传媒体文件到微信服务器">#</a></h3>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/customer-message/customerServiceMessage.uploadTempMedia.html">官方文档</a>
如果想发送图片消息，根据官方文档提示，我们需要<code>media_id</code>。现在讲如何获取这个media_id。
首先需要准备3个参数：</p>
<ul>
<li>access_token：小程序的access_token（注意和公众号的access_token区分）</li>
<li>type：文件类型，合法值：image，就是说只能写image。写死好了</li>
<li>media：form-data 中媒体文件标识，有filename、filelength、content-type等信息</li>
</ul>
<p>调用微信的接口成功，微信会返回：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;errcode&#34;: 0,
</span></span><span style="display:flex;"><span>  &#34;errmsg&#34;: &#34;ok&#34;,
</span></span><span style="display:flex;"><span>  &#34;type&#34;: &#34;image&#34;,
</span></span><span style="display:flex;"><span>  &#34;media_id&#34;: &#34;MEDIA_ID&#34;,
</span></span><span style="display:flex;"><span>  &#34;created_at&#34;: &#34;xxx&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个media_id就是我们需要的。</p>
<p>然后编写上传方法</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">87
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * 上传多媒体数据到微信服务器
</span></span><span style="display:flex;"><span> * @param accessToken 从微信获取到的access_token
</span></span><span style="display:flex;"><span> * @param mediaFileUrl 来自网络上面的媒体文件地址
</span></span><span style="display:flex;"><span> * @return
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>public static String uploadMedia(String accessToken, String type, String mediaFileUrl, StringRedisTemplate stringRedisTemplate) {
</span></span><span style="display:flex;"><span>	//旧地址，微信官方已经废弃，狗比也没有通知
</span></span><span style="display:flex;"><span>	//String MEDIA_URL = &#34;http://file.api.weixin.qq.com/cgi-bin/media/upload?access_token=ACCESS_TOKEN&amp;type=TYPE&#34;;
</span></span><span style="display:flex;"><span>	//新地址
</span></span><span style="display:flex;"><span>	String MEDIA_URL = &#34;https://api.weixin.qq.com/cgi-bin/media/upload?access_token=ACCESS_TOKEN&amp;type=TYPE&#34;;
</span></span><span style="display:flex;"><span>	StringBuffer resultStr = null;
</span></span><span style="display:flex;"><span>	//拼装url地址
</span></span><span style="display:flex;"><span>	String mediaStr = MEDIA_URL.replace(&#34;ACCESS_TOKEN&#34;, accessToken).replace(&#34;TYPE&#34;, type);
</span></span><span style="display:flex;"><span>	System.out.println(&#34;mediaStr:&#34; + mediaStr);
</span></span><span style="display:flex;"><span>	URL mediaUrl;
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		String boundary = &#34;----WebKitFormBoundaryOYXo8heIv9pgpGjT&#34;;
</span></span><span style="display:flex;"><span>		URL url = new URL(mediaStr);
</span></span><span style="display:flex;"><span>		HttpURLConnection urlConn = (HttpURLConnection)url.openConnection();
</span></span><span style="display:flex;"><span>		//让输入输出流开启
</span></span><span style="display:flex;"><span>		urlConn.setDoInput(true);
</span></span><span style="display:flex;"><span>		urlConn.setDoOutput(true);
</span></span><span style="display:flex;"><span>		//使用post方式请求的时候必须关闭缓存
</span></span><span style="display:flex;"><span>		urlConn.setUseCaches(false);
</span></span><span style="display:flex;"><span>		//设置请求头的Content-Type属性
</span></span><span style="display:flex;"><span>		urlConn.setRequestProperty(&#34;Content-Type&#34;, &#34;multipart/form-data; boundary=&#34;+boundary);
</span></span><span style="display:flex;"><span>		urlConn.setRequestMethod(&#34;POST&#34;);
</span></span><span style="display:flex;"><span>		//获取输出流，使用输出流拼接请求体
</span></span><span style="display:flex;"><span>		OutputStream out = urlConn.getOutputStream();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//读取文件的数据,构建一个GET请求，然后读取指定地址中的数据
</span></span><span style="display:flex;"><span>		mediaUrl = new URL(mediaFileUrl);
</span></span><span style="display:flex;"><span>		HttpURLConnection mediaConn = (HttpURLConnection)mediaUrl.openConnection();
</span></span><span style="display:flex;"><span>		//设置请求方式
</span></span><span style="display:flex;"><span>		mediaConn.setRequestMethod(&#34;GET&#34;);
</span></span><span style="display:flex;"><span>		//设置可以打开输入流
</span></span><span style="display:flex;"><span>		mediaConn.setDoInput(true);
</span></span><span style="display:flex;"><span>		//获取传输的数据类型
</span></span><span style="display:flex;"><span>		String contentType = mediaConn.getHeaderField(&#34;Content-Type&#34;);
</span></span><span style="display:flex;"><span>		//将获取大到的类型转换成扩展名
</span></span><span style="display:flex;"><span>		String fileExt = judgeType(contentType);
</span></span><span style="display:flex;"><span>		//获取输入流，从mediaURL里面读取数据
</span></span><span style="display:flex;"><span>		InputStream in = mediaConn.getInputStream();
</span></span><span style="display:flex;"><span>		BufferedInputStream bufferedIn = new BufferedInputStream(in);
</span></span><span style="display:flex;"><span>		//数据读取到这个数组里面
</span></span><span style="display:flex;"><span>		byte[] bytes = new byte[1024];
</span></span><span style="display:flex;"><span>		int size = 0;
</span></span><span style="display:flex;"><span>		//使用outputStream流输出信息到请求体当中去
</span></span><span style="display:flex;"><span>		out.write((&#34;--&#34;+boundary+&#34;\r\n&#34;).getBytes());
</span></span><span style="display:flex;"><span>		out.write((&#34;Content-Disposition: form-data; name=\&#34;media\&#34;;\r\n&#34;
</span></span><span style="display:flex;"><span>				+ &#34;filename=\&#34;&#34;+(new Date().getTime())+fileExt+&#34;\&#34;\r\n&#34;
</span></span><span style="display:flex;"><span>				+ &#34;Content-Type: &#34;+contentType+&#34;\r\n\r\n&#34;).getBytes());
</span></span><span style="display:flex;"><span>		while( (size = bufferedIn.read(bytes)) != -1) {
</span></span><span style="display:flex;"><span>			out.write(bytes, 0, size);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		//切记，这里的换行符不能少，否则将会报41005错误
</span></span><span style="display:flex;"><span>		out.write((&#34;\r\n--&#34;+boundary+&#34;--\r\n&#34;).getBytes());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		bufferedIn.close();
</span></span><span style="display:flex;"><span>		in.close();
</span></span><span style="display:flex;"><span>		mediaConn.disconnect();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		InputStream resultIn = urlConn.getInputStream();
</span></span><span style="display:flex;"><span>		InputStreamReader reader = new InputStreamReader(resultIn);
</span></span><span style="display:flex;"><span>		BufferedReader bufferedReader = new BufferedReader(reader);
</span></span><span style="display:flex;"><span>		String tempStr = null;
</span></span><span style="display:flex;"><span>		resultStr = new StringBuffer();
</span></span><span style="display:flex;"><span>		while((tempStr = bufferedReader.readLine()) != null) {
</span></span><span style="display:flex;"><span>			resultStr.append(tempStr);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		bufferedReader.close();
</span></span><span style="display:flex;"><span>		reader.close();
</span></span><span style="display:flex;"><span>		resultIn.close();
</span></span><span style="display:flex;"><span>		urlConn.disconnect();
</span></span><span style="display:flex;"><span>	} catch (MalformedURLException e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>	} catch (IOException e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	JSONObject jo = JSON.parseObject(resultStr.toString());
</span></span><span style="display:flex;"><span>	log.info(&#34;上传媒体文件到微信，返回的内容是：&#34; + jo);
</span></span><span style="display:flex;"><span>	String media_id = jo.get(&#34;media_id&#34;).toString();
</span></span><span style="display:flex;"><span>	//缓存到redis
</span></span><span style="display:flex;"><span>	stringRedisTemplate.opsForValue().set(&#34;media_id&#34;,media_id,72, TimeUnit.HOURS);
</span></span><span style="display:flex;"><span>	return media_id;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>media_id的有消息为3天，即72小时，一定要缓存到redis，时间也是72小时即可，避免重复上传。超时之后，再重新上传，重新获取media_id。
有了media_id，我们就可以在发客服消息时，使用media_id来发送图片了。</p>
<h2 id="信公众号发送模板消息">信公众号发送模板消息<a hidden class="anchor" aria-hidden="true" href="#信公众号发送模板消息">#</a></h2>
<p><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1433751277">公众号发送消息官方文档</a>
要推送微信的模板消息，我们需要准备的条件有：
1、有效的access_token
2、微信公众号提供的消息模板的Template_id
access_token：
公众平台以access_token为接口调用凭据，来调用接口，所有接口的调用需要先获取access_token，access_token在2小时内有效，过期需要重新获取，但1天内获取次数有限，开发者需自行存储，详见获取接口调用凭据（access_token）文档。
我将access_token存到了redis中，有效期两小时，两小时过期后，再到微信服务器重新获取access_token。
Template_id：
Template_id是我们需要推送的模板消息的模板的唯一标识，微信公众平台提供了很多模板，也支持自定义格式。在实际使用时，我们需要到微信公众平台申请开启模板消息功能。在微信公众平台的首页，左侧菜单有一个“添加功能插件”，选择模板消息，微信平台审核需要一定时间。</p>
<p>消息模板举例：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{{first.DATA}}
</span></span><span style="display:flex;"><span>告警内容：{{keyword1.DATA}}
</span></span><span style="display:flex;"><span>告警发生时间：{{keyword2.DATA}}
</span></span><span style="display:flex;"><span>{{keyword3.DATA}}
</span></span></code></pre></td></tr></table>
</div>
</div><p>为了方便封装数据，我们使用模板类来包装要发送的信息：
TemplateParam 类封装了模板消息中的一个数据，比如上面的“{{first.DATA}} ”，具体属性可阅读注释：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public class TemplateParam {
</span></span><span style="display:flex;"><span>    // 参数名称
</span></span><span style="display:flex;"><span>    private String name;
</span></span><span style="display:flex;"><span>    // 参数值
</span></span><span style="display:flex;"><span>    private String value;
</span></span><span style="display:flex;"><span>    // 颜色
</span></span><span style="display:flex;"><span>    private String color;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public TemplateParam(String name, String value, String color) {
</span></span><span style="display:flex;"><span>        this.name = name;
</span></span><span style="display:flex;"><span>        this.value = value;
</span></span><span style="display:flex;"><span>        this.color = color;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getName() {
</span></span><span style="display:flex;"><span>        return name;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setName(String name) {
</span></span><span style="display:flex;"><span>        this.name = name;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getValue() {
</span></span><span style="display:flex;"><span>        return value;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setValue(String value) {
</span></span><span style="display:flex;"><span>        this.value = value;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getColor() {
</span></span><span style="display:flex;"><span>        return color;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setColor(String color) {
</span></span><span style="display:flex;"><span>        this.color = color;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Template类代表了整个微信模板消息，这里我使用了特定的toJSON()方法生成要发送给微信云平台的json数据：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public class Template {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // 消息接收方
</span></span><span style="display:flex;"><span>    private String toUser;
</span></span><span style="display:flex;"><span>    // 模板id
</span></span><span style="display:flex;"><span>    private String templateId;
</span></span><span style="display:flex;"><span>    // 模板消息详情链接
</span></span><span style="display:flex;"><span>    private String url;
</span></span><span style="display:flex;"><span>    // 消息顶部的颜色
</span></span><span style="display:flex;"><span>//    private String topColor;
</span></span><span style="display:flex;"><span>    // 参数列表
</span></span><span style="display:flex;"><span>    private List&lt;TemplateParam&gt; templateParamList;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getToUser() {
</span></span><span style="display:flex;"><span>        return toUser;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setToUser(String toUser) {
</span></span><span style="display:flex;"><span>        this.toUser = toUser;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getTemplateId() {
</span></span><span style="display:flex;"><span>        return templateId;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setTemplateId(String templateId) {
</span></span><span style="display:flex;"><span>        this.templateId = templateId;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String getUrl() {
</span></span><span style="display:flex;"><span>        return url;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setUrl(String url) {
</span></span><span style="display:flex;"><span>        this.url = url;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>//    public String getTopColor() {
</span></span><span style="display:flex;"><span>//        return topColor;
</span></span><span style="display:flex;"><span>//    }
</span></span><span style="display:flex;"><span>//
</span></span><span style="display:flex;"><span>//    public void setTopColor(String topColor) {
</span></span><span style="display:flex;"><span>//        this.topColor = topColor;
</span></span><span style="display:flex;"><span>//    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public String toJSON() {
</span></span><span style="display:flex;"><span>        StringBuffer buffer = new StringBuffer();
</span></span><span style="display:flex;"><span>        buffer.append(&#34;{&#34;);
</span></span><span style="display:flex;"><span>        buffer.append(String.format(&#34;\&#34;touser\&#34;:\&#34;%s\&#34;&#34;, this.toUser)).append(&#34;,&#34;);
</span></span><span style="display:flex;"><span>        buffer.append(String.format(&#34;\&#34;template_id\&#34;:\&#34;%s\&#34;&#34;, this.templateId)).append(&#34;,&#34;);
</span></span><span style="display:flex;"><span>		buffer.append(String.format(&#34;\&#34;url\&#34;:\&#34;%s\&#34;&#34;, this.url)).append(&#34;,&#34;);
</span></span><span style="display:flex;"><span>//        buffer.append(String.format(&#34;\&#34;topcolor\&#34;:\&#34;%s\&#34;&#34;, this.topColor)).append(&#34;,&#34;);
</span></span><span style="display:flex;"><span>        buffer.append(&#34;\&#34;data\&#34;:{&#34;);
</span></span><span style="display:flex;"><span>        TemplateParam param = null;
</span></span><span style="display:flex;"><span>        for (int i = 0; i &lt; this.templateParamList.size(); i++) {
</span></span><span style="display:flex;"><span>            param = templateParamList.get(i);
</span></span><span style="display:flex;"><span>            // 判断是否追加逗号
</span></span><span style="display:flex;"><span>            if (i &lt; this.templateParamList.size() - 1) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                buffer.append(String.format(&#34;\&#34;%s\&#34;: {\&#34;value\&#34;:\&#34;%s\&#34;,\&#34;color\&#34;:\&#34;%s\&#34;},&#34;, param.getName(), param.getValue(), param.getColor()));
</span></span><span style="display:flex;"><span>            } else {
</span></span><span style="display:flex;"><span>                buffer.append(String.format(&#34;\&#34;%s\&#34;: {\&#34;value\&#34;:\&#34;%s\&#34;,\&#34;color\&#34;:\&#34;%s\&#34;}&#34;, param.getName(), param.getValue(), param.getColor()));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        buffer.append(&#34;}&#34;);
</span></span><span style="display:flex;"><span>        buffer.append(&#34;}&#34;);
</span></span><span style="display:flex;"><span>        return buffer.toString();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public List&lt;TemplateParam&gt; getTemplateParamList() {
</span></span><span style="display:flex;"><span>        return templateParamList;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void setTemplateParamList(List&lt;TemplateParam&gt; templateParamList) {
</span></span><span style="display:flex;"><span>        this.templateParamList = templateParamList;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>准备好了模板消息实体，就可以封装数据并发送了。关注公众号的微信用户，会使用openid来唯一标识，下面的方法是实现了多用户群发，for循环逐一发送，目前没有找到更好的群发方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@RequestMapping(&#34;/sendWarningByWechat&#34;)
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>public ResultMap sendWarningByWechat(String openIds, String content, String alarmDescriptions, String sendDateTime) {
</span></span><span style="display:flex;"><span>	ResultMap res = new ResultMap();
</span></span><span style="display:flex;"><span>	StringBuffer resBuff = new StringBuffer();
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		String templateMsgUrl = &#34;https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=ACCESS_TOKEN&#34;;
</span></span><span style="display:flex;"><span>		templateMsgUrl = templateMsgUrl.replace(&#34;ACCESS_TOKEN&#34;, MemoryData.access_token);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//封装请求体
</span></span><span style="display:flex;"><span>		Template template = new Template();
</span></span><span style="display:flex;"><span>		template.setTemplateId(&#34;0ZUeqUJQ7jxB3G-fxgKyP17SPoo44wFuxnYBqLu5zA4E&#34;);
</span></span><span style="display:flex;"><span>		List&lt;TemplateParam&gt; templateParams = new ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>		String[] failures = alarmDescriptions.split(&#34;\\|\\|&#34;);
</span></span><span style="display:flex;"><span>		String alarmDescStr = &#34;\\r\\n&#34;;
</span></span><span style="display:flex;"><span>		if (failures != null &amp;&amp; failures.length &gt; 0) {
</span></span><span style="display:flex;"><span>			for (String failure : failures) {
</span></span><span style="display:flex;"><span>				alarmDescStr += failure + &#34;\\r\\n&#34;;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			//去掉最后的换行符号
</span></span><span style="display:flex;"><span>			alarmDescStr = alarmDescStr.substring(0, alarmDescStr.lastIndexOf(&#34;\\r\\n&#34;));
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		String allStr = content + alarmDescStr;
</span></span><span style="display:flex;"><span>		while (allStr.length() &gt; 180) {
</span></span><span style="display:flex;"><span>			alarmDescStr = alarmDescStr.substring(0, alarmDescStr.lastIndexOf(&#34;\\r\\n&#34;))+&#34;...&#34;;
</span></span><span style="display:flex;"><span>			allStr = content + alarmDescStr;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		TemplateParam first = new TemplateParam(&#34;first&#34;, content + &#34;\\r\\n&#34;, &#34;#DB1A1B&#34;);
</span></span><span style="display:flex;"><span>		TemplateParam keyword1 = new TemplateParam(&#34;keyword1&#34;, alarmDescStr + &#34;\\r\\n&#34;, &#34;#DB1A1B&#34;);
</span></span><span style="display:flex;"><span>		TemplateParam keyword2 = new TemplateParam(&#34;keyword2&#34;, sendDateTime + &#34;&#34;, &#34;#DB1A1B&#34;);
</span></span><span style="display:flex;"><span>		TemplateParam keyword3 = new TemplateParam(&#34;keyword3&#34;, &#34;&#34;, &#34;#DB1A1B&#34;);
</span></span><span style="display:flex;"><span>		templateParams.add(first);
</span></span><span style="display:flex;"><span>		templateParams.add(keyword1);
</span></span><span style="display:flex;"><span>		templateParams.add(keyword2);
</span></span><span style="display:flex;"><span>		templateParams.add(keyword3);
</span></span><span style="display:flex;"><span>		template.setTemplateParamList(templateParams);
</span></span><span style="display:flex;"><span>		String[] openIdArr = openIds.split(&#34;,&#34;);
</span></span><span style="display:flex;"><span>		if (openIdArr.length &gt; 0) {
</span></span><span style="display:flex;"><span>			for (String openID : openIdArr) {
</span></span><span style="display:flex;"><span>				template.setToUser(openID);
</span></span><span style="display:flex;"><span>				String resJson = HttpClientUtil.doTemplateMsgPost(templateMsgUrl, template.toJSON());
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} catch (Exception e) {
</span></span><span style="display:flex;"><span>		log.error(e.getMessage());
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		res.setFailureResult();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return res;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="击推送消息跳转到网页或者小程序">击推送消息跳转到网页或者小程序<a hidden class="anchor" aria-hidden="true" href="#击推送消息跳转到网页或者小程序">#</a></h3>
<p>需求：消息推送后，点击推送的消息，可以跳转到公众号内部的某些页面，这个页面是我们自己的。
<a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Template_Message_Interface.html">模板消息官方文档</a>一定仔细阅读官方文档。
根据微信官网提供的接口文档，可以知道要跳转的条件有以下四个参数：
url：模板跳转链接（海外帐号没有跳转能力）
miniprogram：跳小程序所需数据，不需跳小程序可不用传该数据
appid：所需跳转到的小程序appid（该小程序appid必须与发模板消息的公众号是绑定关联关系，暂不支持小游戏）
pagepath：所需跳转到小程序的具体页面路径，支持带参数,（示例index?foo=bar），要求该小程序已发布，暂不支持小游戏
<a href="https://blog.csdn.net/qq_27185879/article/details/103385345">参考</a></p>
<h1 id="其他">其他<a hidden class="anchor" aria-hidden="true" href="#其他">#</a></h1>
<h2 id="全局返回码说明">全局返回码说明<a hidden class="anchor" aria-hidden="true" href="#全局返回码说明">#</a></h2>
<p><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1433747234">官方说明</a></p>
<h2 id="微信分享jssdk-invalid-signature签名错误的解决方案">微信分享JSSDK-invalid signature签名错误的解决方案<a hidden class="anchor" aria-hidden="true" href="#微信分享jssdk-invalid-signature签名错误的解决方案">#</a></h2>
<p>核对官方步骤，确认签名算法。</p>
<ul>
<li>确认签名算法正确，可用 <a href="http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign">http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign</a> 页面工具进行校验。</li>
<li>确认config中nonceStr（js中驼峰标准大写S）, timestamp与用以签名中的对应noncestr, timestamp一致。</li>
<li>确认url是页面完整的url(请在当前页面alert(location.href.split(&rsquo;#&rsquo;)[0])确认)，包括&rsquo;http(s)://&lsquo;部分，以及&rsquo;？&lsquo;后面的GET参数部分,但不包括&rsquo;#&lsquo;hash后面的部分。</li>
<li>确认 config 中的 appid 与用来获取 jsapi_ticket 的 appid 一致。</li>
<li>确保一定缓存access_token和jsapi_ticket。</li>
<li>确保你获取用来签名的url是动态获取的，动态页面可参见实例代码中php的实现方式。如果是html的静态页面在前端通过ajax将url传到后台签名，前端需要用js获取当前页面除去&rsquo;#&lsquo;hash部分的链接（可用location.href.split(&rsquo;#&rsquo;)[0]获取,而且需要encodeURIComponent，后台decodeURIComponent解码），因为页面一旦分享，微信客户端会在你的链接末尾加入其它参数，如果不是动态获取当前链接，将导致分享后的页面签名失败。</li>
</ul>
<h2 id="小程序报错">小程序报错<a hidden class="anchor" aria-hidden="true" href="#小程序报错">#</a></h2>
<p><code>{&quot;errcode&quot;:40163,&quot;errmsg&quot;:&quot;code been used, hints: [ req_id: UGKfDXXBe-rIpWva ]&quot;}</code>
前端获取code，通过code请求后台接口，后台通过code获取openid和session_key。偶尔会报上边的错。原因：前端传了重复的code，小程序的code只能用一次，每次使用都要重新获取，不能缓存。</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/other/">other</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://funny-toffee-4aa7c3.netlify.app/posts/java/comparable%E5%92%8Ccomparator/">
    <span class="title">« Prev</span>
    <br>
    <span>comparable和comparator</span>
  </a>
  <a class="next" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%85%B6%E4%BB%96%E5%9F%BA%E7%A1%80/dubbo/">
    <span class="title">Next »</span>
    <br>
    <span>dubbo</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>