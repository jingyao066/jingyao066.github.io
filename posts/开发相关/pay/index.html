<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>pay | Wjy&#39;s Blog</title>
<meta name="keywords" content="other">
<meta name="description" content="支付宝支付官网：
https://docs.open.alipay.com/catalog
微信支付官网：
V2：https://pay.weixin.qq.com/wiki/doc/api/index.html
V3：https://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/pay/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="pay" />
<meta property="og:description" content="支付宝支付官网：
https://docs.open.alipay.com/catalog
微信支付官网：
V2：https://pay.weixin.qq.com/wiki/doc/api/index.html
V3：https://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/pay/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-11-24T13:50:44+00:00" />
<meta property="article:modified_time" content="2019-11-24T13:50:44+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="pay"/>
<meta name="twitter:description" content="支付宝支付官网：
https://docs.open.alipay.com/catalog
微信支付官网：
V2：https://pay.weixin.qq.com/wiki/doc/api/index.html
V3：https://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "pay",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/pay/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "pay",
  "name": "pay",
  "description": "支付宝支付官网： https://docs.open.alipay.com/catalog 微信支付官网： V2：https://pay.weixin.qq.com/wiki/doc/api/index.html V3：https://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml\n",
  "keywords": [
    "other"
  ],
  "articleBody": "支付宝支付官网： https://docs.open.alipay.com/catalog 微信支付官网： V2：https://pay.weixin.qq.com/wiki/doc/api/index.html V3：https://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml\n微信支付 微信JSAPI支付 官方文档 微信网页支付时序图： 准备工作 微信公众平台已认证的服务号，并且需要开通微信支付该能。登录页https://mp.weixin.qq.com/ 微信商户平台账号。https://pay.weixin.qq.com 一个正式的应用服务器，并且注册域名。 微信支付涉及的私密数据比较多，不允许使用natapp，花生壳之类的内网穿透工具实现，需要有正式的服务器环境，并且要注册域名，不能使用IP。正确的地址示例：http://www.wjy.com 配置准备 公众号配置 配置网页授权域名，登录公众平台——\u003e公众号设置——\u003e功能设置 配置前端根目录即可，例如：pre-zj.stzy.com。不要https:// 该配置主要用于获取用户的code，需要识别这是哪个人。注：是前端页面的地址。 然后按照提示，将文件下载并上传到网页授权域名目录下，并且在浏览器，测试访问，http://www.baidu.com/你的文件名.txt看到一串字符串，证明成功。(可以通过nginx访问该文件)\n配置JS接口安全域名：要让我们的页面中弹出输入密码的窗口，需要使用微信提供的JS-SDK工具，如果不配置JS接口安全域名，你的页面无法使用JS-SDK。 配置前端根目录即可：pre-zj.stzy.com 注意：一个自然月内最多可修改并保存五次，本月剩余保存次数：5。所以建议测试环境和生产环境的地址一块添加，免的多次添加浪费次数。\n获取公众号的 AppID 和 AppSecret 登录微信公众平台-\u003e拉到页面最下边-\u003e在左侧找到开发一栏-\u003e点击基本配置-\u003e需要点击确认申请开通，然后就可以看到AppID和其他配置信息。 AppSecret需要向该公众号的管理员申请开通，30分钟内通过即可，然后输入该公众号密码，即可查看到AppSecret，按照页面提示存储好AppSecret，并进行后续操作。（注意公众号的 AppID，测试环境和生产环境的切换）\n商户平台配置 配置支付授权目录，登录商户平台-\u003e产品中心-\u003e开发配置-\u003e支付配置-\u003eJSAPI支付 这里需要填写前端页面的地址，不在该路径的页面，则无法调用支付功能。 可以填写前端的根目录：http://pay.xxxx.com/ 或只填写支付目录：http://mywexx.xxxx.com/pay 注意第一次添加时，会让输入操作密码，输入完操作密码，需要再添加一次才能添加成功。\n设置API密钥，登录商户平台——\u003e账户中心——\u003eAPI安全——\u003e往下拉找到 API密钥 现在有两个密钥需要设置，V2和V3的密钥，分别对应V2和V3两种支付方式。\n将公众号和商户平台关联 公众号开通微信支付，是在微信商户平台完成的，绑定完成后，可以在公众号看到绑定的商户号。官方绑定教程 可以先找商户平台所有者(超级管理员)，把自己的微信绑定为管理员：顶部点击账号中心-\u003e左侧找到员工账号管理-\u003e右侧找到管理员，点击新增账号-\u003e然后可能需要安装安全控件。 安装控件之后，可能需要重启浏览器，才能检测到安全控件，所以需要重新登录，然后发送验证，就成功在本机上安装安全控件了。安装好控件之后，就可以将自己的微信号绑定为管理员了。 注意提交的时候，需要输入操作密码，该密码不是商户平台的登录密码，是操作密码。 根据绑定教程，输入公众号的appID后，可以在绑定的公众号-\u003e商户号管理，看到待关联商户号，可以确认以及后续步骤，即可成功关联。\n此处是账号模板,请参考：\n1 2 3 4 5 6 微信公众平台：账户：con*******om 登录密码 ****** 公众APPID：wx15*********a8 APPSECEPT : c210***************892d7 微信商户平台：账户：149**********6742 登录密码：****** 商户ID：14******42 API密钥：5d5************b35b 至此，需要的四大参数都找到了。可以通过官网的工具测试我们的配置是否有问题： https://mp.weixin.qq.com/debug\n如果返回Request successful，以及access_token和expires_in，说明配置没问题。\n我们直接把微信官方提供的一堆util，放到项目中。\n获取用户code（前端获取code，推荐） 在确保微信公众账号拥有授权作用域（scope参数）的权限的前提下（服务号获得高级接口后，默认拥有scope参数中的snsapi_base和snsapi_userinfo），让前端请求如下url：\n1 2 3 4 5 6 https://open.weixin.qq.com/connect/oauth2/authorize ?appid=APPID \u0026redirect_uri=REDIRECT_URI \u0026response_type=code \u0026scope=SCOPE \u0026state=STATE#wechat_redirect 参数解析： appid：公众号的唯一标识。 redirect_uri：授权后重定向的回调链接地址。微信会重定向到这个页面，并带上code参数。 注意：需要对链接进行urlEncode处理。注意这个回调地址只能是域名，不能带端口号。 response_type：返回类型，请填写code，写死。 scope：应用授权作用域。 snsapi_base：不弹出授权页面，直接跳转，只能获取用户openid。 snsapi_userinfo：弹出授权页面，可通过 openid 拿到昵称、性别、所在地。并且，即使在未关注的情况下，只要用户授权，也能获取其信息。\nstate：重定向后会带上state参数，开发者可以填写a-zA-Z0-9的参数值，最多128字节。 #wechat_redirect：无论直接打开还是做页面302重定向时候，必须带此参数。\n若提示该链接无法访问，请检查参数是否填写错误，是否拥有scope参数对应的授权作用域权限。尤其注意，由于授权操作安全等级较高，所以在发起授权请求时，微信会对授权链接做正则强匹配校验，如果链接的参数顺序不对，授权页面将无法正常访问。\n这一步就是获取用户的code。整体流程是：\n前端请求授权url 微信重定向到我们指定的redirect_uri，即我们自己的页面，并带上code参数，redirect_uri/?code=CODE\u0026state=STATE。 现在前端就可以获取到链接上的code，然后传递给后端。 后端通过code获取openid，然后请求微信预支付接口。 code说明：code 是换取openid的票据，只能使用一次，5分钟未被使用自动过期。\n后端获取code（不推荐，比较麻烦） 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /** * 获取code */ @GetMapping(\"getWxCode\") public ModelAndView getWxCode() { LOGGER.debug(\"获取code开始\"); ModelAndView mv = new ModelAndView(); String rediretUrl = PayUtil.getProjectUrl(this.request) + \"zjx/api/pay/perPay\"; try { String url = \"https://open.weixin.qq.com/connect/oauth2/authorize?\" + \"appid=\" + PayConstant.WX_H5_APPID + \"\u0026redirect_uri=\" + URLEncoder.encode(rediretUrl, PayConstant.DEFAULT_CHARSET) + \"\u0026response_type=code\u0026scope=snsapi_base\u0026state=123#wechat_redirect\"; //这里必须是重定向 mv.setViewName(\"redirect:\" + url); } catch (UnsupportedEncodingException e) { e.printStackTrace(); } return mv; } 流程：\n前端请求上边的接口，不用带参数。 后端请求微信，带参数，redirect_uri需要指定为后台的接口地址。 微信重定向到我们指定的redirect_uri，会带上code参数。 编写redirect_uri指定的后台接口，在接口上用@requestParam获取code参数，然后通过code换取access_token和openid。 然后或者把openid返回给前端，获取直接用openid请求微信的预支付接口。 预支付接口只需要用户的openid，一个用户对于一个公众号的openid是不会变的，所以没必要非要在请求预支付的时候才通过code换取openid，可以在进入公众号就获取授权，然后获取openid，然后让前端缓存在本地，或是通过接口存到数据库中，这样在请求预支付接口时，直接传递存储好的openid就好了。\n通过code获取openid 前端请求这个接口，后台给前端返回openid，然后前端缓存openid。这样就不用每次刷新页面都需要重新通过code获取openid了。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @ApiOperation(value = \"通过code获取openid\") @RequestMapping(\"getWxOpenid\") public String getWxOpenid(@RequestParam(\"code\") String code) { // 获取openId地址 String getOpenidUrl = \"https://api.weixin.qq.com/sns/oauth2/access_token\"; // 参数 String param = \"?appid=\" + weChatConfig.getAppId() + \"\u0026secret=\" + weChatConfig.getApSecret() + \"\u0026code=\" + code + \"\u0026grant_type=authorization_code\"; //向微信服务器发送get请求获取openIdStr String openIdStr = HttpUtil.get(getOpenidUrl + param); JsonNode jsonNode = JacksonUtils.jsonToJsonNode(openIdStr); return jsonNode.get(\"openid\").asText(); } 调用微信统一下单接口 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 /** * 微信JSAPI 预支付，返回前端拉起支付需要的参数 */ @ResponseBody @GetMapping(\"perPay\") public Map perPay(@RequestParam(\"openid\") String openid) { LOGGER.info(\"openid是 \" + openid); Map resultMap = new HashMap\u003c\u003e(); try { //生成订单编号 int number = (int)((Math.random()*9)*1000);//随机数 DateFormat dateFormat = new SimpleDateFormat(\"yyyyMMddHHmmss\");//时间 String orderNo = dateFormat.format(new Date()) + number; //拼接统一下单地址参数 Map paraMap = new HashMap\u003c\u003e(); paraMap.put(\"appid\", PayConstant.WX_H5_APPID); paraMap.put(\"mch_id\", PayConstant.WX_H5_MCHID); paraMap.put(\"body\", \"最美课本支付测试\"); paraMap.put(\"nonce_str\",WXPayUtil.generateNonceStr()); paraMap.put(\"openid\", openid); paraMap.put(\"out_trade_no\", orderNo); paraMap.put(\"spbill_create_ip\",HttpUtil.getIpAddr(this.request)); // 价格，单位分 paraMap.put(\"total_fee\",\"1\"); paraMap.put(\"trade_type\", \"JSAPI\"); // 支付成功，微信回调服务器的接口地址，注意添加白名单 paraMap.put(\"notify_url\", PayUtil.getProjectUrl(this.request) + \"zjx/api/wxNotify\"); // 需要和下面sign方法一致，不是说参数一致。 paraMap.put(\"sign\", WXPayUtil.generateSignature(paraMap, PayConstant.WX_H5_APP_KEY)); //将所有参数(map)转xml格式 String xml = WXPayUtil.mapToXml(paraMap); LOGGER.info(\"请求微信参数\"+xml); //发送post请求\"统一下单接口\"返回预支付id：prepay_id String wxReturnStr = PayUtil.post(PayConstant.WX_UNIFIEDORDER_URL, xml, ContentTypeEnum.TextXml.getContentType()); Map wxXmlMap = WXPayUtil.xmlToMap(wxReturnStr); LOGGER.info(\"微信统一下单接口返回数据:\" + wxXmlMap); //组装返回给前端的数据 resultMap.put(\"appId\", PayConstant.WX_H5_APPID); resultMap.put(\"timeStamp\", WXPayUtil.getCurrentTimestamp()+\"\"); resultMap.put(\"nonceStr\", WXPayUtil.generateNonceStr()); resultMap.put(\"signType\", \"MD5\"); resultMap.put(\"package\", \"prepay_id=\" + wxXmlMap.get(\"prepay_id\")); //注意这里的签名方法需要和上边paramMap中sign的方法一致，app_key也必须一致 resultMap.put(\"paySign\", WXPayUtil.generateSignature(resultMap, PayConstant.WX_H5_APP_KEY)); LOGGER.info(\"返回给前端的数据:\" + resultMap); } catch (Exception e) { e.printStackTrace(); } return resultMap; } 支付成功的回调 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 @RequestMapping(\"wxBuySpaceNotify\") public void wxBuySpaceNotify() { try { Map map = PayUtil.resolveWXPayResponse(this.request, PayConstant.WX_H5_APP_KEY); LOGGER.info(\"=============微信支付回调参数:\" + JSONObject.toJSONString(map)); if (map.size() \u003e= 2) { //执行回调逻辑 map = payService.buySpaceCallback(map); //内部逻辑是否执行成功 int resultCode = Integer.valueOf(map.get(\"dealSuccess\")); map.clear(); if (resultCode == 1) { //处理成功 map.put(\"return_code\", \"SUCCESS\"); LOGGER.info(\"===============微信支付回调成功===========\"); } else { map.put(\"return_code\", \"FAIL\"); map.put(\"return_msg\", \"业务处理失败\"); } response.getWriter().write(WXPayUtil.mapToXml(map)); response.getWriter().flush(); response.getWriter().close(); } } catch (Exception e) { //告诉微信业务失败 try { Map map = new HashMap\u003c\u003e(); map.put(\"return_code\", \"FAIL\"); map.put(\"return_msg\", \"业务处理失败\"); response.getWriter().write(WXPayUtil.mapToXml(map)); response.getWriter().flush(); response.getWriter().close(); } catch (Exception e1) { LOGGER.info(\"==============微信支付回调响应异常==============\", e); } LOGGER.info(\"==============微信支付回调异常==============\", e); } } 关键就这两个方法，一个预支付，微信返回perpay_id，你返回给前端，前端通过perpay_id调起支付组件，若完成支付，微信会回调你设置的notify_url地址，这就是你支付成功的回调地址。你要在回调方法里写一些业务相关的逻辑，比如：更改订单状态为已支付，以及赠送会员等后续操作。\n公众号支付参考1 公众号支付参考2\n2020/8/4 微信支付重试机制： 如果回调方法给微信服务器返回失败，微信服务器会间按时间段调用商户服务器，直到成功。 今天发现，线上的回调方法报错了。我修复了报错的代码，把代码更上去之后，之前报错的订单也正常了，才发现这个事。\nJSAPI最佳实践 前端获取code。 前端通过code请求后台接口，获取openid，并缓存openid。 前端通过openid请求后台预支付接口，后台请求微信，然后给前端返回prepay_id等拉起支付需要的参数。 用户支付成功后，微信服务器会回调后台接口，告诉我们支付成功。 后台接口接收到微信的通知，开始处理我们的业务（修改订单状态，增加积分等业务逻辑）。然后给微信返回处理成功，然后微信才不会一直回调我们的接口。 前端循环调用后台的检查订单状态接口，成功后跳转支付成功页面。 微信app支付 官网 开发文档\n微信这图做的，老子真想骂街，做个白底的不好么。\n必要参数： appid：微信开放平台审核通过的应用APPID（请登录open.weixin.qq.com查看，注意与公众号的APPID不同） mch_id：微信支付分配的商户号 nonce_str：随机字符串 body：内容 out_trade_no：商户订单号 fee_type：货币类型 total_fee：总金额 spbill_create_ip：终端IP(一般为服务器本机:127.0.0.1) notify_url：回调url trade_type：交易类型(APP) 这些参数生成签名，参数注释参考官方文档。 将生成的签名连同这些参数一起生成xml报文请求统一下单api。\n统一下单api成功后会返回prepayid(预支付交易会话标识)，将 appid，prepayid，partnerid(商户号)，package(Sign=WXPay)，noncestr，timestamp 这些参数再次进行签名，再将签名，连同这些参数发送到app端供其调用完成。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 @ResponseBody @PostMapping(\"appBuySapcePerPay\") public ResponseUtil appBuySapcePerPay(@RequestBody Map paramMap) { LOGGER.info(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e前端请求参数是 \" + paramMap +\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\"); Map resultMap = new HashMap\u003c\u003e(); ResponseUtil response = ResponseUtil.success(); CodeEnum code = CodeEnum.FAIL; try { Token token = TokenUtil.getToken(request.getHeader(\"token\")); //验证前端传的价格是否正确 Integer price = Integer.parseInt(paramMap.get(\"price\")); AssertUtil.assertValidate(code,CodeEnum.ERROR_2001.getCode(),\"购买空间价格错误\",price.equals(sapcePrice)); //前端传过来的订单号 String orderNo = paramMap.get(\"order_no\"); //生成订单 orderNo = generateSpaceOrder(paramMap, token, price, orderNo, 1); //拼接统一下单地址参数(共10个必须参数) Map toWxMap = new HashMap\u003c\u003e(); toWxMap.put(\"appid\", PayConstant.PARENT_APP_WX_APPID); toWxMap.put(\"mch_id\", PayConstant.WX_H5_MCHID); toWxMap.put(\"nonce_str\",WXPayUtil.generateNonceStr()); toWxMap.put(\"body\", \"最美课本-孩子空间VIP\"); toWxMap.put(\"out_trade_no\", orderNo); toWxMap.put(\"spbill_create_ip\",HttpUtil.getIpAddr(this.request)); toWxMap.put(\"total_fee\",new BigDecimal(price).multiply(new BigDecimal(\"100\")).intValue() + \"\"); toWxMap.put(\"trade_type\", \"APP\"); //接收微信支付异步通知回调地址，通知url必须为直接可访问的url，不能携带参数。 toWxMap.put(\"notify_url\", PayUtil.getProjectUrl(this.request) + \"zjx/api/pay/wxBuySpaceNotify\"); LOGGER.info(\"************支付成功回调地址是:\"+PayUtil.getProjectUrl(this.request) + \"zjx/api/pay/wxBuySpaceNotify\"); toWxMap.put(\"sign\", WXPayUtil.generateSignature(toWxMap, PayConstant.WX_H5_APP_KEY)); //将所有参数(map)转xml格式 String xml = WXPayUtil.mapToXml(toWxMap); LOGGER.info(\"*******************请求微信参数\"+xml); //调用微信统一下单接口，返回预支付id：prepay_id String wxReturnStr = PayUtil.post(PayConstant.WX_UNIFIEDORDER_URL, xml, ContentTypeEnum.TextXml.getContentType()); //将微信返回数据格式化成map Map wxXmlMap = WXPayUtil.xmlToMap(wxReturnStr); LOGGER.info(\"**********************微信统一下单接口返回数据:\" + wxXmlMap + \"*****************************************\"); // todo //组装返回给前端的数据 resultMap.put(\"appid\", PayConstant.PARENT_APP_WX_APPID); resultMap.put(\"partnerid\", PayConstant.WX_H5_MCHID); resultMap.put(\"prepayid\", wxXmlMap.get(\"prepay_id\")); resultMap.put(\"package\", \"Sign=WXPay\"); resultMap.put(\"nonceStr\", WXPayUtil.generateNonceStr()); resultMap.put(\"timeStamp\", WXPayUtil.getCurrentTimestamp()+\"\"); resultMap.put(\"sign\", WXPayUtil.generateSignature(resultMap, PayConstant.WX_H5_APP_KEY)); resultMap.put(\"order_no\", orderNo); LOGGER.info(\"**********************返回给前端的数据:\" + resultMap + \"*****************************************\"); response.setData(resultMap); //订单记录redis，12小时自动过期 stringRedisTemplate.opsForValue().set(orderNo, \"sapceOrder\", 60 * 60 * 12, TimeUnit.SECONDS); } catch (Exception e) { e.printStackTrace(); response.setCode(code); response.setMessage(e.getMessage()); } return response; } 预支付接口就是这样，和公众号支付基本一致，只是参数有些不同。 预支付接口调用成功后，需要编写支付成功回调接口，微信会主动调用我们在预支付接口中设置好的url，即notify_url。 微信会将：商户订单号,微信支付订单号发送给我们，我们可以通过这些来完成业务逻辑。\n参考1 参考2 参考3 参考4\n微信扫码支付 扫码支付官方文档 扫码支付，需要在微信商户平台开通Native支付。 登录微信商户平台-\u003e产品中心-\u003eNative支付-\u003e开通\n微信扫码支付有两种模式， 模式一：要是针对商品固定的场景，可以先生成固定的二维码，此二维码是永久有效的，用户扫码后再通过产品编号查询商品信息来下单。 而模式二得先下单生成一个临时的二维码，一般两小时内有效。\n获取微信二维码实现类代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 @Override public Map wxPrePayAndGetQrcode(int userId, int payType,String ip) { Orders orders = getOrderNo(userId, payType); String orderNo = orders.getOrderNo(); try { //拼接统一下单地址参数 Map toWxMap = new HashMap\u003c\u003e(11); toWxMap.put(\"appid\", WxUtil.getAppid(environment, WxPlatformConstant.PARTNER_GZH)); toWxMap.put(\"mch_id\", PayConstant.WX_H5_MCHID); toWxMap.put(\"body\", \"商品\"); toWxMap.put(\"nonce_str\", WXPayUtil.generateNonceStr()); toWxMap.put(\"out_trade_no\", orderNo); toWxMap.put(\"spbill_create_ip\", ip); toWxMap.put(\"total_fee\", orders.getOrderPrice().toString()); toWxMap.put(\"trade_type\", \"NATIVE\"); if(\"prod\".equals(environment)){ toWxMap.put(\"notify_url\", PayConstant.WX_NOTIFY_URL); }else{ toWxMap.put(\"notify_url\", PayConstant.WX_NOTIFY_URL_TEST); } toWxMap.put(\"sign\", WXPayUtil.generateSignature(toWxMap, PayConstant.WX_H5_APP_KEY)); //将所有参数(map)转xml格式 String xml = WXPayUtil.mapToXml(toWxMap); log.info(\"*******************请求微信参数\" + xml); //发送post请求\"统一下单接口\" String wxReturnStr = PayUtil.post(PayConstant.WX_UNIFIEDORDER_URL, xml, ContentTypeEnum.TextXml.getContentType()); Map wxXmlMap = WXPayUtil.xmlToMap(wxReturnStr); log.info(\"**********************微信统一下单接口返回数据:\" + wxXmlMap + \"*****************************************\"); String qrcode = wxXmlMap.get(\"code_url\"); Map map = new HashMap(); map.put(\"qrcode\",qrcode); map.put(\"orderNo\",orderNo); map.put(\"oneYearVipPrice\",PayConstant.pad端一年学习权益价格); return map; } catch (Exception e) { throw new RuntimeException(e); } } 异步回调\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 /** * @author: wjy * @description: 微信扫码支付异步回调 */ @ResponseBody @PostMapping(\"padBuyVipWxPayCallback\") public void padBuyVipWxPayCallback(HttpServletRequest request,HttpServletResponse response) throws Exception { log.info( \"\\n***************************************\" + \"\\n\" + \"start padBuyVipWxPayCallback\" + \"\\n\" + \"微信扫码支付异步回调\" + \"\\n\" + \"\\n********************************************\" ); try { ByteArrayOutputStream outSteam = new ByteArrayOutputStream(); InputStream inStream = request.getInputStream(); byte[] buffer = new byte[1024]; int len = 0; while ((len = inStream.read(buffer)) != -1) { outSteam.write(buffer, 0, len); } outSteam.close(); inStream.close(); String result = new String(outSteam.toByteArray(), PayConstant.DEFAULT_CHARSET); log.info(\"***************************************微信返回结果xml:\" + result + \"********************************************\"); Map resultMap = new HashMap\u003c\u003e(); String out_trade_no = \"\"; if (!StringUtils.isEmpty(result)) { //将微信返回的xml转成map Map map = WXPayUtil.xmlToMap(result); //验签 if (WXPayUtil.isSignatureValid(map, PayConstant.WX_H5_APP_KEY, WXPayConstants.SignType.MD5)) { String attach = map.get(\"attach\"); log.info(\"***************************************微信自定义参数:\" + attach + \"********************************************\"); log.info(\"***************************************商户订单号:\" + map.get(\"out_trade_no\") + \"******************************\"); out_trade_no = map.get(\"out_trade_no\"); } else { resultMap.put(\"return_code\", \"FAIL\"); resultMap.put(\"return_msg\", \"验签失败\"); response.getWriter().write(WXPayUtil.mapToXml(map)); response.getWriter().flush(); response.getWriter().close(); return; } } String finalOut_trade_no = out_trade_no; executorService.execute(() -\u003e { payService.padBuyVipCallback(finalOut_trade_no); }); // 如果签名验证正确，立即返回success，后续业务另起线程单独处理 Map map = new HashMap\u003c\u003e(); map.put(\"return_code\", \"SUCCESS\"); response.getWriter().write(WXPayUtil.mapToXml(map)); response.getWriter().flush(); response.getWriter().close(); } catch (Exception e) { e.printStackTrace(); Map map = new HashMap\u003c\u003e(); map.put(\"return_code\", \"FAIL\"); map.put(\"return_msg\", \"业务处理失败\"); response.getWriter().write(WXPayUtil.mapToXml(map)); response.getWriter().flush(); response.getWriter().close(); } } 支付宝支付 支付宝app支付 官方文档 支付宝的文档真的一目了然，比微信强太多… 参考\n支付宝-手机网站支付 手机网站支付官方文档 一定要仔细看官方文档，根据文档提示，一步一步来。 需要注意的是官方文档的这句话： 支付宝会为开发者生成前台页面请求需要的完整 form 表单的 html（包含自动提交脚本），商家直接将这个表单的 String 输出到 http response 中即可。 就是说后台请求支付宝接口后，支付宝会返回一个表单字符串，类似这种：\n1 2 3 4 5 6 7 8 ",
  "wordCount" : "20568",
  "inLanguage": "en",
  "datePublished": "2019-11-24T13:50:44Z",
  "dateModified": "2019-11-24T13:50:44Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/pay/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

  <script id="MathJax-script" async src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-chtml.min.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath:  [['\\(', '\\)'], ['$', '$']],  
    }
  };
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      pay
    </h1>
    <div class="post-meta"><span title='2019-11-24 13:50:44 +0000 UTC'>2019-11-24</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98" aria-label="微信支付">微信支付</a><ul>
                        
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1jsapi%e6%94%af%e4%bb%98" aria-label="微信JSAPI支付">微信JSAPI支付</a><ul>
                        
                <li>
                    <a href="#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c" aria-label="准备工作">准备工作</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e5%87%86%e5%a4%87" aria-label="配置准备">配置准备</a><ul>
                        
                <li>
                    <a href="#%e5%85%ac%e4%bc%97%e5%8f%b7%e9%85%8d%e7%bd%ae" aria-label="公众号配置">公众号配置</a></li>
                <li>
                    <a href="#%e5%95%86%e6%88%b7%e5%b9%b3%e5%8f%b0%e9%85%8d%e7%bd%ae" aria-label="商户平台配置">商户平台配置</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96%e7%94%a8%e6%88%b7code%e5%89%8d%e7%ab%af%e8%8e%b7%e5%8f%96code%e6%8e%a8%e8%8d%90" aria-label="获取用户code（前端获取code，推荐）">获取用户code（前端获取code，推荐）</a></li>
                <li>
                    <a href="#%e5%90%8e%e7%ab%af%e8%8e%b7%e5%8f%96code%e4%b8%8d%e6%8e%a8%e8%8d%90%e6%af%94%e8%be%83%e9%ba%bb%e7%83%a6" aria-label="后端获取code（不推荐，比较麻烦）">后端获取code（不推荐，比较麻烦）</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87code%e8%8e%b7%e5%8f%96openid" aria-label="通过code获取openid">通过code获取openid</a></li>
                <li>
                    <a href="#%e8%b0%83%e7%94%a8%e5%be%ae%e4%bf%a1%e7%bb%9f%e4%b8%80%e4%b8%8b%e5%8d%95%e6%8e%a5%e5%8f%a3" aria-label="调用微信统一下单接口">调用微信统一下单接口</a></li>
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e6%88%90%e5%8a%9f%e7%9a%84%e5%9b%9e%e8%b0%83" aria-label="支付成功的回调">支付成功的回调</a></li>
                <li>
                    <a href="#jsapi%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" aria-label="JSAPI最佳实践">JSAPI最佳实践</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1app%e6%94%af%e4%bb%98" aria-label="微信app支付">微信app支付</a></li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98" aria-label="微信扫码支付">微信扫码支付</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e5%ae%9d%e6%94%af%e4%bb%98" aria-label="支付宝支付">支付宝支付</a><ul>
                        
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e5%ae%9dapp%e6%94%af%e4%bb%98" aria-label="支付宝app支付">支付宝app支付</a></li>
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e5%ae%9d-%e6%89%8b%e6%9c%ba%e7%bd%91%e7%ab%99%e6%94%af%e4%bb%98" aria-label="支付宝-手机网站支付">支付宝-手机网站支付</a></li>
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e5%ae%9d%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98%e5%bd%93%e9%9d%a2%e4%bb%98" aria-label="支付宝扫码支付（当面付）">支付宝扫码支付（当面付）</a></li>
                <li>
                    <a href="#%e5%bc%82%e6%ad%a5%e5%9b%9e%e8%b0%83%e5%bc%82%e5%b8%b8%e9%97%ae%e9%a2%98" aria-label="异步回调异常问题">异步回调异常问题</a><ul>
                        
                <li>
                    <a href="#%e4%b8%80%e5%b9%b4%e5%90%8e%e6%94%b6%e5%88%b0%e6%94%af%e4%bb%98%e5%ae%9d%e7%9a%84%e5%bc%82%e6%ad%a5%e5%9b%9e%e8%b0%83%e9%80%9a%e7%9f%a5" aria-label="一年后收到支付宝的异步回调通知">一年后收到支付宝的异步回调通知</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e8%8b%b9%e6%9e%9c%e6%94%af%e4%bb%98" aria-label="苹果支付">苹果支付</a></li>
                <li>
                    <a href="#%e7%ad%96%e7%95%a5%e6%a8%a1%e5%bc%8f%e5%ae%9e%e7%8e%b0%e5%a4%9a%e6%94%af%e4%bb%98" aria-label="策略模式实现多支付">策略模式实现多支付</a><ul>
                        
                <li>
                    <a href="#%e8%ae%be%e8%ae%a1%e6%80%9d%e8%b7%af" aria-label="设计思路">设计思路</a></li>
                <li>
                    <a href="#maven%e4%be%9d%e8%b5%96" aria-label="maven依赖">maven依赖</a></li>
                <li>
                    <a href="#%e5%85%b3%e9%94%ae%e7%b1%bb" aria-label="关键类">关键类</a><ul>
                        
                <li>
                    <a href="#%e7%ad%96%e7%95%a5%e6%8e%a5%e5%8f%a3" aria-label="策略接口">策略接口</a></li>
                <li>
                    <a href="#%e4%b8%9a%e5%8a%a1%e5%8f%82%e6%95%b0%e7%b1%bb" aria-label="业务参数类">业务参数类</a></li>
                <li>
                    <a href="#%e5%9b%9b%e7%a7%8d%e6%94%af%e4%bb%98%e7%ad%96%e7%95%a5" aria-label="四种支付策略">四种支付策略</a><ul>
                        
                <li>
                    <a href="#aliapppaystrategy" aria-label="AliAppPayStrategy">AliAppPayStrategy</a></li>
                <li>
                    <a href="#aliwebpaystrategy" aria-label="AliWebPayStrategy">AliWebPayStrategy</a></li>
                <li>
                    <a href="#wxapppaystrategy" aria-label="WxAppPayStrategy">WxAppPayStrategy</a></li>
                <li>
                    <a href="#wxwebpaystrategy" aria-label="WxWebPayStrategy">WxWebPayStrategy</a></li></ul>
                </li>
                <li>
                    <a href="#http%e8%af%b7%e6%b1%82" aria-label="Http请求">Http请求</a></li>
                <li>
                    <a href="#%e7%ad%96%e7%95%a5%e6%9e%9a%e4%b8%be" aria-label="策略枚举">策略枚举</a></li>
                <li>
                    <a href="#%e7%ad%96%e7%95%a5%e5%b7%a5%e5%8e%82" aria-label="策略工厂">策略工厂</a></li>
                <li>
                    <a href="#%e5%9c%ba%e6%99%af%e8%b0%83%e7%94%a8" aria-label="场景调用">场景调用</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%89%8d%e7%ab%af%e4%bb%a3%e7%a0%81" aria-label="前端代码">前端代码</a><ul>
                        
                <li>
                    <a href="#%e5%85%ac%e4%bc%97%e5%8f%b7%e5%86%85%e6%94%af%e4%bb%98" aria-label="公众号内支付">公众号内支付</a><ul>
                        
                <li>
                    <a href="#%e7%ac%ac%e4%b8%80%e7%a7%8d%e6%96%b9%e5%bc%8f" aria-label="第一种方式">第一种方式</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%ba%8c%e7%a7%8d%e6%96%b9%e5%bc%8f" aria-label="第二种方式">第二种方式</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%9e%e8%b0%83%e5%87%bd%e6%95%b0" aria-label="回调函数">回调函数</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bf%83%e8%84%8f%e7%8a%b6%e6%80%81%e6%9c%ba" aria-label="支付系统的心脏：状态机">支付系统的心脏：状态机</a><ul>
                        
                <li>
                    <a href="#%e7%8a%b6%e6%80%81%e6%9c%ba%e8%ae%be%e8%ae%a1%e5%9f%ba%e6%9c%ac%e5%8e%9f%e5%88%99" aria-label="状态机设计基本原则：">状态机设计基本原则：</a></li>
                <li>
                    <a href="#%e7%8a%b6%e6%80%81%e6%9c%ba%e5%b8%b8%e8%a7%81%e8%ae%be%e8%ae%a1%e8%af%af%e5%8c%ba" aria-label="状态机常见设计误区">状态机常见设计误区</a></li>
                <li>
                    <a href="#%e7%8a%b6%e6%80%81%e6%9c%ba%e8%ae%be%e8%ae%a1%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" aria-label="状态机设计的最佳实践">状态机设计的最佳实践</a></li>
                <li>
                    <a href="#%e5%b8%b8%e8%a7%81%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0%e8%af%af%e5%8c%ba" aria-label="常见代码实现误区">常见代码实现误区</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0" aria-label="代码实现">代码实现</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>支付宝支付官网：
<a href="https://docs.open.alipay.com/catalog">https://docs.open.alipay.com/catalog</a>
微信支付官网：
V2：https://pay.weixin.qq.com/wiki/doc/api/index.html
V3：https://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml</p>
<h1 id="微信支付">微信支付<a hidden class="anchor" aria-hidden="true" href="#微信支付">#</a></h1>
<h2 id="微信jsapi支付">微信JSAPI支付<a hidden class="anchor" aria-hidden="true" href="#微信jsapi支付">#</a></h2>
<p><a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_1">官方文档</a>
微信网页支付时序图：
<img loading="lazy" src="3.png" alt=""  />
</p>
<h3 id="准备工作">准备工作<a hidden class="anchor" aria-hidden="true" href="#准备工作">#</a></h3>
<ul>
<li>微信公众平台已认证的服务号，并且需要开通微信支付该能。登录页https://mp.weixin.qq.com/</li>
<li>微信商户平台账号。https://pay.weixin.qq.com</li>
<li>一个正式的应用服务器，并且注册域名。
微信支付涉及的私密数据比较多，不允许使用natapp，花生壳之类的内网穿透工具实现，需要有正式的服务器环境，并且要注册域名，不能使用IP。正确的地址示例：<code>http://www.wjy.com</code></li>
</ul>
<h3 id="配置准备">配置准备<a hidden class="anchor" aria-hidden="true" href="#配置准备">#</a></h3>
<h4 id="公众号配置">公众号配置<a hidden class="anchor" aria-hidden="true" href="#公众号配置">#</a></h4>
<ul>
<li>
<p>配置网页授权域名，登录公众平台——&gt;公众号设置——&gt;功能设置
配置前端根目录即可，例如：<code>pre-zj.stzy.com</code>。不要<code>https://</code>
该配置主要用于获取用户的code，需要识别这是哪个人。注：是前端页面的地址。
然后按照提示，将文件下载并上传到<code>网页授权域名</code>目录下，并且在浏览器，测试访问，<code>http://www.baidu.com/你的文件名.txt</code>看到一串字符串，证明成功。(可以通过nginx访问该文件)</p>
</li>
<li>
<p>配置JS接口安全域名：要让我们的页面中弹出输入密码的窗口，需要使用微信提供的JS-SDK工具，如果不配置JS接口安全域名，你的页面无法使用JS-SDK。
配置前端根目录即可：<code>pre-zj.stzy.com</code>
注意：一个自然月内最多可修改并保存五次，本月剩余保存次数：5。所以建议测试环境和生产环境的地址一块添加，免的多次添加浪费次数。</p>
</li>
<li>
<p>获取公众号的 AppID 和 AppSecret
登录微信公众平台-&gt;拉到页面最下边-&gt;在左侧找到开发一栏-&gt;点击基本配置-&gt;需要点击确认申请开通，然后就可以看到AppID和其他配置信息。
AppSecret需要向该公众号的管理员申请开通，30分钟内通过即可，然后输入该公众号密码，即可查看到AppSecret，按照页面提示存储好AppSecret，并进行后续操作。（注意公众号的 AppID，测试环境和生产环境的切换）</p>
</li>
</ul>
<h4 id="商户平台配置">商户平台配置<a hidden class="anchor" aria-hidden="true" href="#商户平台配置">#</a></h4>
<ul>
<li>配置支付授权目录，登录商户平台-&gt;产品中心-&gt;开发配置-&gt;支付配置-&gt;JSAPI支付
这里需要填写前端页面的地址，不在该路径的页面，则无法调用支付功能。
可以填写前端的根目录：<code>http://pay.xxxx.com/</code>
或只填写支付目录：<code>http://mywexx.xxxx.com/pay</code></li>
</ul>
<p>注意第一次添加时，会让输入操作密码，输入完操作密码，需要再添加一次才能添加成功。</p>
<ul>
<li>
<p>设置API密钥，登录商户平台——&gt;账户中心——&gt;API安全——&gt;往下拉找到 API密钥
现在有两个密钥需要设置，V2和V3的密钥，分别对应V2和V3两种支付方式。</p>
</li>
<li>
<p>将公众号和商户平台关联
公众号开通微信支付，是在微信商户平台完成的，绑定完成后，可以在公众号看到绑定的商户号。<a href="https://pay.weixin.qq.com/static/pay_setting/appid_protocol.shtml">官方绑定教程</a>
可以先找商户平台所有者(超级管理员)，把自己的微信绑定为管理员：顶部点击账号中心-&gt;左侧找到员工账号管理-&gt;右侧找到管理员，点击新增账号-&gt;然后可能需要安装安全控件。
安装控件之后，可能需要重启浏览器，才能检测到安全控件，所以需要重新登录，然后发送验证，就成功在本机上安装安全控件了。安装好控件之后，就可以将自己的微信号绑定为管理员了。
注意提交的时候，需要输入<code>操作密码</code>，该密码不是商户平台的登录密码，是操作密码。
根据绑定教程，输入公众号的appID后，可以在绑定的公众号-&gt;商户号管理，看到待关联商户号，可以确认以及后续步骤，即可成功关联。</p>
</li>
</ul>
<p>此处是账号模板,请参考：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>微信公众平台：账户：con*******om 登录密码 ******
</span></span><span style="display:flex;"><span>公众APPID：wx15*********a8
</span></span><span style="display:flex;"><span>APPSECEPT : c210***************892d7
</span></span><span style="display:flex;"><span>微信商户平台：账户：149**********6742 登录密码：******
</span></span><span style="display:flex;"><span>商户ID：14******42
</span></span><span style="display:flex;"><span>API密钥：5d5************b35b
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，需要的四大参数都找到了。可以通过官网的工具测试我们的配置是否有问题：
<a href="https://mp.weixin.qq.com/debug">https://mp.weixin.qq.com/debug</a></p>
<p>如果返回<code>Request successful</code>，以及<code>access_token</code>和<code>expires_in</code>，说明配置没问题。</p>
<p>我们直接把微信官方提供的一堆util，放到项目中。</p>
<h3 id="获取用户code前端获取code推荐">获取用户code（前端获取code，推荐）<a hidden class="anchor" aria-hidden="true" href="#获取用户code前端获取code推荐">#</a></h3>
<p>在确保微信公众账号拥有授权作用域（scope参数）的权限的前提下（服务号获得高级接口后，默认拥有scope参数中的snsapi_base和snsapi_userinfo），让前端请求如下url：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://open.weixin.qq.com/connect/oauth2/authorize
</span></span><span style="display:flex;"><span>?appid=APPID
</span></span><span style="display:flex;"><span>&amp;redirect_uri=REDIRECT_URI
</span></span><span style="display:flex;"><span>&amp;response_type=code
</span></span><span style="display:flex;"><span>&amp;scope=SCOPE
</span></span><span style="display:flex;"><span>&amp;state=STATE#wechat_redirect
</span></span></code></pre></td></tr></table>
</div>
</div><p>参数解析：
appid：公众号的唯一标识。
redirect_uri：授权后重定向的回调链接地址。微信会重定向到这个页面，并带上code参数。
注意：需要对链接进行urlEncode处理。注意这个回调地址只能是域名，不能带端口号。
response_type：返回类型，请填写code，写死。
scope：应用授权作用域。
<code>snsapi_base</code>：不弹出授权页面，直接跳转，只能获取用户openid。
<code>snsapi_userinfo</code>：弹出授权页面，可通过 openid 拿到昵称、性别、所在地。并且，即使在未关注的情况下，只要用户授权，也能获取其信息。</p>
<p>state：重定向后会带上state参数，开发者可以填写a-zA-Z0-9的参数值，最多128字节。
<code>#wechat_redirect</code>：无论直接打开还是做页面302重定向时候，必须带此参数。</p>
<p>若提示<code>该链接无法访问</code>，请检查参数是否填写错误，是否拥有scope参数对应的授权作用域权限。尤其注意，由于授权操作安全等级较高，所以在发起授权请求时，微信会对授权链接做正则强匹配校验，如果链接的参数顺序不对，授权页面将无法正常访问。</p>
<p>这一步就是获取用户的code。整体流程是：</p>
<ol>
<li>前端请求授权url</li>
<li>微信重定向到我们指定的<code>redirect_uri</code>，即我们自己的页面，并带上code参数，<code>redirect_uri/?code=CODE&amp;state=STATE</code>。</li>
<li>现在前端就可以获取到链接上的code，然后传递给后端。</li>
<li>后端通过code获取openid，然后请求微信预支付接口。</li>
</ol>
<p>code说明：code 是换取openid的票据，只能使用一次，5分钟未被使用自动过期。</p>
<h3 id="后端获取code不推荐比较麻烦">后端获取code（不推荐，比较麻烦）<a hidden class="anchor" aria-hidden="true" href="#后端获取code不推荐比较麻烦">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 获取code
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@GetMapping(<span style="color:#0ff;font-weight:bold">&#34;getWxCode&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ModelAndView getWxCode() {
</span></span><span style="display:flex;"><span>	LOGGER.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;获取code开始&#34;</span>);
</span></span><span style="display:flex;"><span>	ModelAndView mv = <span style="color:#fff;font-weight:bold">new</span> ModelAndView();
</span></span><span style="display:flex;"><span>	String rediretUrl = PayUtil.<span style="color:#007f7f">getProjectUrl</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">request</span>) + <span style="color:#0ff;font-weight:bold">&#34;zjx/api/pay/perPay&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>		String url = <span style="color:#0ff;font-weight:bold">&#34;https://open.weixin.qq.com/connect/oauth2/authorize?&#34;</span>
</span></span><span style="display:flex;"><span>				+ <span style="color:#0ff;font-weight:bold">&#34;appid=&#34;</span> + PayConstant.<span style="color:#007f7f">WX_H5_APPID</span>
</span></span><span style="display:flex;"><span>				+ <span style="color:#0ff;font-weight:bold">&#34;&amp;redirect_uri=&#34;</span> + URLEncoder.<span style="color:#007f7f">encode</span>(rediretUrl, PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>)
</span></span><span style="display:flex;"><span>				+ <span style="color:#0ff;font-weight:bold">&#34;&amp;response_type=code&amp;scope=snsapi_base&amp;state=123#wechat_redirect&#34;</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#007f7f">//这里必须是重定向
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		mv.<span style="color:#007f7f">setViewName</span>(<span style="color:#0ff;font-weight:bold">&#34;redirect:&#34;</span> + url);
</span></span><span style="display:flex;"><span>	} <span style="color:#fff;font-weight:bold">catch</span> (UnsupportedEncodingException e) {
</span></span><span style="display:flex;"><span>		e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">return</span> mv;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>流程：</p>
<ol>
<li>前端请求上边的接口，不用带参数。</li>
<li>后端请求微信，带参数，<code>redirect_uri</code>需要指定为后台的接口地址。</li>
<li>微信重定向到我们指定的<code>redirect_uri</code>，会带上code参数。</li>
<li>编写<code>redirect_uri</code>指定的后台接口，在接口上用<code>@requestParam</code>获取code参数，然后通过code换取<code>access_token</code>和<code>openid</code>。</li>
<li>然后或者把openid返回给前端，获取直接用openid请求微信的预支付接口。</li>
</ol>
<p>预支付接口只需要用户的openid，一个用户对于一个公众号的openid是不会变的，所以没必要非要在请求预支付的时候才通过code换取openid，可以在进入公众号就获取授权，然后获取openid，然后让前端缓存在本地，或是通过接口存到数据库中，这样在请求预支付接口时，直接传递存储好的openid就好了。</p>
<h3 id="通过code获取openid">通过code获取openid<a hidden class="anchor" aria-hidden="true" href="#通过code获取openid">#</a></h3>
<p>前端请求这个接口，后台给前端返回openid，然后前端缓存openid。这样就不用每次刷新页面都需要重新通过code获取openid了。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@ApiOperation(value = <span style="color:#0ff;font-weight:bold">&#34;通过code获取openid&#34;</span>)
</span></span><span style="display:flex;"><span>@RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;getWxOpenid&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> String getWxOpenid(@RequestParam(<span style="color:#0ff;font-weight:bold">&#34;code&#34;</span>) String code) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 获取openId地址
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String getOpenidUrl = <span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/sns/oauth2/access_token&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 参数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String param = <span style="color:#0ff;font-weight:bold">&#34;?appid=&#34;</span> + weChatConfig.<span style="color:#007f7f">getAppId</span>() +
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;secret=&#34;</span> + weChatConfig.<span style="color:#007f7f">getApSecret</span>() +
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;code=&#34;</span> + code +
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;grant_type=authorization_code&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//向微信服务器发送get请求获取openIdStr
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String openIdStr = HttpUtil.<span style="color:#007f7f">get</span>(getOpenidUrl + param);
</span></span><span style="display:flex;"><span>    JsonNode jsonNode = JacksonUtils.<span style="color:#007f7f">jsonToJsonNode</span>(openIdStr);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> jsonNode.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;openid&#34;</span>).<span style="color:#007f7f">asText</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="调用微信统一下单接口">调用微信统一下单接口<a hidden class="anchor" aria-hidden="true" href="#调用微信统一下单接口">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 微信JSAPI 预支付，返回前端拉起支付需要的参数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@GetMapping(<span style="color:#0ff;font-weight:bold">&#34;perPay&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Map perPay(@RequestParam(<span style="color:#0ff;font-weight:bold">&#34;openid&#34;</span>) String openid) {
</span></span><span style="display:flex;"><span>    LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;openid是 &#34;</span> + openid);
</span></span><span style="display:flex;"><span>    Map&lt;String, String&gt; resultMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//生成订单编号
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">int</span> number = (<span style="color:#fff;font-weight:bold">int</span>)((Math.<span style="color:#007f7f">random</span>()*<span style="color:#ff0;font-weight:bold">9</span>)*<span style="color:#ff0;font-weight:bold">1000</span>);<span style="color:#007f7f">//随机数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        DateFormat dateFormat = <span style="color:#fff;font-weight:bold">new</span> SimpleDateFormat(<span style="color:#0ff;font-weight:bold">&#34;yyyyMMddHHmmss&#34;</span>);<span style="color:#007f7f">//时间
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String orderNo = dateFormat.<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> Date()) + number;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//拼接统一下单地址参数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Map&lt;String, String&gt; paraMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appid&#34;</span>, PayConstant.<span style="color:#007f7f">WX_H5_APPID</span>);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;mch_id&#34;</span>, PayConstant.<span style="color:#007f7f">WX_H5_MCHID</span>);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;body&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;最美课本支付测试&#34;</span>);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonce_str&#34;</span>,WXPayUtil.<span style="color:#007f7f">generateNonceStr</span>());
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;openid&#34;</span>, openid);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, orderNo);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;spbill_create_ip&#34;</span>,HttpUtil.<span style="color:#007f7f">getIpAddr</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">request</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 价格，单位分
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;total_fee&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;1&#34;</span>);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;trade_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;JSAPI&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 支付成功，微信回调服务器的接口地址，注意添加白名单
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;notify_url&#34;</span>, PayUtil.<span style="color:#007f7f">getProjectUrl</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">request</span>) + <span style="color:#0ff;font-weight:bold">&#34;zjx/api/wxNotify&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 需要和下面sign方法一致，不是说参数一致。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(paraMap, PayConstant.<span style="color:#007f7f">WX_H5_APP_KEY</span>));
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将所有参数(map)转xml格式
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String xml = WXPayUtil.<span style="color:#007f7f">mapToXml</span>(paraMap);
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;请求微信参数&#34;</span>+xml);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//发送post请求&#34;统一下单接口&#34;返回预支付id：prepay_id
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String wxReturnStr = PayUtil.<span style="color:#007f7f">post</span>(PayConstant.<span style="color:#007f7f">WX_UNIFIEDORDER_URL</span>, xml, ContentTypeEnum.<span style="color:#007f7f">TextXml</span>.<span style="color:#007f7f">getContentType</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; wxXmlMap = WXPayUtil.<span style="color:#007f7f">xmlToMap</span>(wxReturnStr);
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;微信统一下单接口返回数据:&#34;</span> + wxXmlMap);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//组装返回给前端的数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appId&#34;</span>, PayConstant.<span style="color:#007f7f">WX_H5_APPID</span>);
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;timeStamp&#34;</span>, WXPayUtil.<span style="color:#007f7f">getCurrentTimestamp</span>()+<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonceStr&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateNonceStr</span>());
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;signType&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;MD5&#34;</span>);
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;package&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;prepay_id=&#34;</span> + wxXmlMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;prepay_id&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//注意这里的签名方法需要和上边paramMap中sign的方法一致，app_key也必须一致
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;paySign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(resultMap, PayConstant.<span style="color:#007f7f">WX_H5_APP_KEY</span>));
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;返回给前端的数据:&#34;</span> + resultMap);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> resultMap;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="支付成功的回调">支付成功的回调<a hidden class="anchor" aria-hidden="true" href="#支付成功的回调">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;wxBuySpaceNotify&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> wxBuySpaceNotify() {
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; map = PayUtil.<span style="color:#007f7f">resolveWXPayResponse</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">request</span>, PayConstant.<span style="color:#007f7f">WX_H5_APP_KEY</span>);
</span></span><span style="display:flex;"><span>		LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;=============微信支付回调参数:&#34;</span> + JSONObject.<span style="color:#007f7f">toJSONString</span>(map));
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">if</span> (map.<span style="color:#007f7f">size</span>() &gt;= <span style="color:#ff0;font-weight:bold">2</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//执行回调逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			map = payService.<span style="color:#007f7f">buySpaceCallback</span>(map);
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//内部逻辑是否执行成功
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			<span style="color:#fff;font-weight:bold">int</span> resultCode = Integer.<span style="color:#007f7f">valueOf</span>(map.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;dealSuccess&#34;</span>));
</span></span><span style="display:flex;"><span>			map.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">if</span> (resultCode == <span style="color:#ff0;font-weight:bold">1</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#007f7f">//处理成功
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>				map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_code&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;SUCCESS&#34;</span>);
</span></span><span style="display:flex;"><span>				LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;===============微信支付回调成功===========&#34;</span>);
</span></span><span style="display:flex;"><span>			} <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>				map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_code&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;FAIL&#34;</span>);
</span></span><span style="display:flex;"><span>				map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_msg&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;业务处理失败&#34;</span>);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">write</span>(WXPayUtil.<span style="color:#007f7f">mapToXml</span>(map));
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//告诉微信业务失败
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>			Map&lt;String, String&gt; map = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>			map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_code&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;FAIL&#34;</span>);
</span></span><span style="display:flex;"><span>			map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_msg&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;业务处理失败&#34;</span>);
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">write</span>(WXPayUtil.<span style="color:#007f7f">mapToXml</span>(map));
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>		} <span style="color:#fff;font-weight:bold">catch</span> (Exception e1) {
</span></span><span style="display:flex;"><span>			LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;==============微信支付回调响应异常==============&#34;</span>, e);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;==============微信支付回调异常==============&#34;</span>, e);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>关键就这两个方法，一个预支付，微信返回perpay_id，你返回给前端，前端通过perpay_id调起支付组件，若完成支付，微信会回调你设置的notify_url地址，这就是你支付成功的回调地址。你要在回调方法里写一些业务相关的逻辑，比如：更改订单状态为已支付，以及赠送会员等后续操作。</p>
<p><a href="https://www.jianshu.com/p/9c322b1a5274">公众号支付参考1</a>
<a href="https://blog.csdn.net/javaYouCome/article/details/79473743">公众号支付参考2</a></p>
<p>2020/8/4
微信支付重试机制：
如果回调方法给微信服务器返回失败，微信服务器会间按时间段调用商户服务器，直到成功。
今天发现，线上的回调方法报错了。我修复了报错的代码，把代码更上去之后，之前报错的订单也正常了，才发现这个事。</p>
<h3 id="jsapi最佳实践">JSAPI最佳实践<a hidden class="anchor" aria-hidden="true" href="#jsapi最佳实践">#</a></h3>
<ol>
<li>前端获取code。</li>
<li>前端通过code请求后台接口，获取openid，并缓存openid。</li>
<li>前端通过openid请求后台预支付接口，后台请求微信，然后给前端返回<code>prepay_id</code>等拉起支付需要的参数。</li>
<li>用户支付成功后，微信服务器会回调后台接口，告诉我们支付成功。</li>
<li>后台接口接收到微信的通知，开始处理我们的业务（修改订单状态，增加积分等业务逻辑）。然后给微信返回处理成功，然后微信才不会一直回调我们的接口。</li>
<li>前端循环调用后台的<code>检查订单状态</code>接口，成功后跳转支付成功页面。</li>
</ol>
<h2 id="微信app支付">微信app支付<a hidden class="anchor" aria-hidden="true" href="#微信app支付">#</a></h2>
<p><a href="https://pay.weixin.qq.com/index.php/core/home/login?return_url=%2F">官网</a>
<a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_1">开发文档</a></p>
<p><img loading="lazy" src="pay/4.png" alt="微信支付时序图"  />

微信这图做的，老子真想骂街，做个白底的不好么。</p>
<p>必要参数：
appid：微信开放平台审核通过的应用APPID（请登录open.weixin.qq.com查看，注意与公众号的APPID不同）
mch_id：微信支付分配的商户号
nonce_str：随机字符串
body：内容
out_trade_no：商户订单号
fee_type：货币类型
total_fee：总金额
spbill_create_ip：终端IP(一般为服务器本机:127.0.0.1)
notify_url：回调url
trade_type：交易类型(APP)
这些参数生成签名，参数注释参考官方文档。
将生成的签名连同这些参数一起生成xml报文请求统一下单api。</p>
<p>统一下单api成功后会返回prepayid(预支付交易会话标识)，将
<code>appid，prepayid，partnerid(商户号)，package(Sign=WXPay)，noncestr，timestamp</code>
这些参数再次进行签名，再将签名，连同这些参数发送到app端供其调用完成。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@PostMapping(&#34;appBuySapcePerPay&#34;)
</span></span><span style="display:flex;"><span>public ResponseUtil appBuySapcePerPay(@RequestBody Map&lt;String,String&gt; paramMap) {
</span></span><span style="display:flex;"><span>	LOGGER.info(&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;前端请求参数是 &#34; + paramMap +&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&#34;);
</span></span><span style="display:flex;"><span>	Map&lt;String, String&gt; resultMap = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>	ResponseUtil response = ResponseUtil.success();
</span></span><span style="display:flex;"><span>	CodeEnum code = CodeEnum.FAIL;
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		Token token = TokenUtil.getToken(request.getHeader(&#34;token&#34;));
</span></span><span style="display:flex;"><span>		//验证前端传的价格是否正确
</span></span><span style="display:flex;"><span>		Integer price = Integer.parseInt(paramMap.get(&#34;price&#34;));
</span></span><span style="display:flex;"><span>		AssertUtil.assertValidate(code,CodeEnum.ERROR_2001.getCode(),&#34;购买空间价格错误&#34;,price.equals(sapcePrice));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//前端传过来的订单号
</span></span><span style="display:flex;"><span>		String orderNo = paramMap.get(&#34;order_no&#34;);
</span></span><span style="display:flex;"><span>		//生成订单
</span></span><span style="display:flex;"><span>		orderNo = generateSpaceOrder(paramMap, token, price, orderNo, 1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//拼接统一下单地址参数(共10个必须参数)
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; toWxMap = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;appid&#34;, PayConstant.PARENT_APP_WX_APPID);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;mch_id&#34;, PayConstant.WX_H5_MCHID);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;nonce_str&#34;,WXPayUtil.generateNonceStr());
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;body&#34;, &#34;最美课本-孩子空间VIP&#34;);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;out_trade_no&#34;, orderNo);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;spbill_create_ip&#34;,HttpUtil.getIpAddr(this.request));
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;total_fee&#34;,new BigDecimal(price).multiply(new BigDecimal(&#34;100&#34;)).intValue() + &#34;&#34;);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;trade_type&#34;, &#34;APP&#34;);
</span></span><span style="display:flex;"><span>		//接收微信支付异步通知回调地址，通知url必须为直接可访问的url，不能携带参数。
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;notify_url&#34;, PayUtil.getProjectUrl(this.request) + &#34;zjx/api/pay/wxBuySpaceNotify&#34;);
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;************支付成功回调地址是:&#34;+PayUtil.getProjectUrl(this.request) + &#34;zjx/api/pay/wxBuySpaceNotify&#34;);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;sign&#34;, WXPayUtil.generateSignature(toWxMap, PayConstant.WX_H5_APP_KEY));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//将所有参数(map)转xml格式
</span></span><span style="display:flex;"><span>		String xml = WXPayUtil.mapToXml(toWxMap);
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;*******************请求微信参数&#34;+xml);
</span></span><span style="display:flex;"><span>		//调用微信统一下单接口，返回预支付id：prepay_id
</span></span><span style="display:flex;"><span>		String wxReturnStr = PayUtil.post(PayConstant.WX_UNIFIEDORDER_URL, xml, ContentTypeEnum.TextXml.getContentType());
</span></span><span style="display:flex;"><span>		//将微信返回数据格式化成map
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; wxXmlMap = WXPayUtil.xmlToMap(wxReturnStr);
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;**********************微信统一下单接口返回数据:&#34; + wxXmlMap + &#34;*****************************************&#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		// todo
</span></span><span style="display:flex;"><span>		//组装返回给前端的数据
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;appid&#34;, PayConstant.PARENT_APP_WX_APPID);
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;partnerid&#34;, PayConstant.WX_H5_MCHID);
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;prepayid&#34;, wxXmlMap.get(&#34;prepay_id&#34;));
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;package&#34;, &#34;Sign=WXPay&#34;);
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;nonceStr&#34;, WXPayUtil.generateNonceStr());
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;timeStamp&#34;, WXPayUtil.getCurrentTimestamp()+&#34;&#34;);
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;sign&#34;, WXPayUtil.generateSignature(resultMap, PayConstant.WX_H5_APP_KEY));
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;order_no&#34;, orderNo);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;**********************返回给前端的数据:&#34; + resultMap + &#34;*****************************************&#34;);
</span></span><span style="display:flex;"><span>		response.setData(resultMap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//订单记录redis，12小时自动过期
</span></span><span style="display:flex;"><span>		stringRedisTemplate.opsForValue().set(orderNo, &#34;sapceOrder&#34;, 60 * 60 * 12, TimeUnit.SECONDS);
</span></span><span style="display:flex;"><span>	} catch (Exception e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		response.setCode(code);
</span></span><span style="display:flex;"><span>		response.setMessage(e.getMessage());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return response;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>预支付接口就是这样，和公众号支付基本一致，只是参数有些不同。
预支付接口调用成功后，需要编写支付成功回调接口，微信会主动调用我们在预支付接口中设置好的url，即<code>notify_url</code>。
微信会将：商户订单号,微信支付订单号发送给我们，我们可以通过这些来完成业务逻辑。</p>
<p><a href="https://www.jianshu.com/p/54f73fea5986">参考1</a>
<a href="https://blog.csdn.net/u012552275/article/details/78758571">参考2</a>
<a href="https://www.cnblogs.com/zhanglingbing/p/9073217.html">参考3</a>
<a href="https://www.cnblogs.com/xxss/p/10244513.html">参考4</a></p>
<h2 id="微信扫码支付">微信扫码支付<a hidden class="anchor" aria-hidden="true" href="#微信扫码支付">#</a></h2>
<p><a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=6_1">扫码支付官方文档</a>
扫码支付，需要在微信商户平台开通Native支付。
登录微信商户平台-&gt;产品中心-&gt;Native支付-&gt;开通</p>
<p>微信扫码支付有两种模式，
模式一：要是针对商品固定的场景，可以先生成固定的二维码，此二维码是永久有效的，用户扫码后再通过产品编号查询商品信息来下单。
而模式二得先下单生成一个临时的二维码，一般两小时内有效。</p>
<p>获取微信二维码实现类代码</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Map wxPrePayAndGetQrcode(<span style="color:#fff;font-weight:bold">int</span> userId, <span style="color:#fff;font-weight:bold">int</span> payType,String ip) {
</span></span><span style="display:flex;"><span>        Orders orders = getOrderNo(userId, payType);
</span></span><span style="display:flex;"><span>        String orderNo = orders.<span style="color:#007f7f">getOrderNo</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//拼接统一下单地址参数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Map&lt;String, String&gt; toWxMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;(<span style="color:#ff0;font-weight:bold">11</span>);
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appid&#34;</span>, WxUtil.<span style="color:#007f7f">getAppid</span>(environment, WxPlatformConstant.<span style="color:#007f7f">PARTNER_GZH</span>));
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;mch_id&#34;</span>, PayConstant.<span style="color:#007f7f">WX_H5_MCHID</span>);
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;body&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;商品&#34;</span>);
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonce_str&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateNonceStr</span>());
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, orderNo);
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;spbill_create_ip&#34;</span>, ip);
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;total_fee&#34;</span>, orders.<span style="color:#007f7f">getOrderPrice</span>().<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;trade_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;NATIVE&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(<span style="color:#0ff;font-weight:bold">&#34;prod&#34;</span>.<span style="color:#007f7f">equals</span>(environment)){
</span></span><span style="display:flex;"><span>                toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;notify_url&#34;</span>, PayConstant.<span style="color:#007f7f">WX_NOTIFY_URL</span>);
</span></span><span style="display:flex;"><span>            }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>                toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;notify_url&#34;</span>, PayConstant.<span style="color:#007f7f">WX_NOTIFY_URL_TEST</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(toWxMap, PayConstant.<span style="color:#007f7f">WX_H5_APP_KEY</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//将所有参数(map)转xml格式
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String xml = WXPayUtil.<span style="color:#007f7f">mapToXml</span>(toWxMap);
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;*******************请求微信参数&#34;</span> + xml);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//发送post请求&#34;统一下单接口&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String wxReturnStr = PayUtil.<span style="color:#007f7f">post</span>(PayConstant.<span style="color:#007f7f">WX_UNIFIEDORDER_URL</span>, xml, ContentTypeEnum.<span style="color:#007f7f">TextXml</span>.<span style="color:#007f7f">getContentType</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            Map&lt;String, String&gt; wxXmlMap = WXPayUtil.<span style="color:#007f7f">xmlToMap</span>(wxReturnStr);
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************微信统一下单接口返回数据:&#34;</span> + wxXmlMap + <span style="color:#0ff;font-weight:bold">&#34;*****************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            String qrcode = wxXmlMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;code_url&#34;</span>);
</span></span><span style="display:flex;"><span>            Map map = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>            map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;qrcode&#34;</span>,qrcode);
</span></span><span style="display:flex;"><span>            map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;orderNo&#34;</span>,orderNo);
</span></span><span style="display:flex;"><span>            map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;oneYearVipPrice&#34;</span>,PayConstant.<span style="color:#007f7f">pad</span><span style="color:#f00">端一年学习权益价格</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> map;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>异步回调</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * @author: wjy
</span></span><span style="display:flex;"><span> * @description: 微信扫码支付异步回调
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@PostMapping(&#34;padBuyVipWxPayCallback&#34;)
</span></span><span style="display:flex;"><span>public void padBuyVipWxPayCallback(HttpServletRequest request,HttpServletResponse response) throws Exception {
</span></span><span style="display:flex;"><span>	log.info(
</span></span><span style="display:flex;"><span>	&#34;\n***************************************&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>		&#34;start padBuyVipWxPayCallback&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>		&#34;微信扫码支付异步回调&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>		&#34;\n********************************************&#34;
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		ByteArrayOutputStream outSteam = new ByteArrayOutputStream();
</span></span><span style="display:flex;"><span>		InputStream inStream = request.getInputStream();
</span></span><span style="display:flex;"><span>		byte[] buffer = new byte[1024];
</span></span><span style="display:flex;"><span>		int len = 0;
</span></span><span style="display:flex;"><span>		while ((len = inStream.read(buffer)) != -1) {
</span></span><span style="display:flex;"><span>			outSteam.write(buffer, 0, len);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		outSteam.close();
</span></span><span style="display:flex;"><span>		inStream.close();
</span></span><span style="display:flex;"><span>		String result = new String(outSteam.toByteArray(), PayConstant.DEFAULT_CHARSET);
</span></span><span style="display:flex;"><span>		log.info(&#34;***************************************微信返回结果xml:&#34; + result + &#34;********************************************&#34;);
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; resultMap = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>		String out_trade_no = &#34;&#34;;
</span></span><span style="display:flex;"><span>		if (!StringUtils.isEmpty(result)) {
</span></span><span style="display:flex;"><span>			//将微信返回的xml转成map
</span></span><span style="display:flex;"><span>			Map&lt;String, String&gt; map = WXPayUtil.xmlToMap(result);
</span></span><span style="display:flex;"><span>			//验签
</span></span><span style="display:flex;"><span>			if (WXPayUtil.isSignatureValid(map, PayConstant.WX_H5_APP_KEY, WXPayConstants.SignType.MD5)) {
</span></span><span style="display:flex;"><span>				String attach = map.get(&#34;attach&#34;);
</span></span><span style="display:flex;"><span>				log.info(&#34;***************************************微信自定义参数:&#34; + attach + &#34;********************************************&#34;);
</span></span><span style="display:flex;"><span>				log.info(&#34;***************************************商户订单号:&#34; + map.get(&#34;out_trade_no&#34;) + &#34;******************************&#34;);
</span></span><span style="display:flex;"><span>				out_trade_no = map.get(&#34;out_trade_no&#34;);
</span></span><span style="display:flex;"><span>			} else {
</span></span><span style="display:flex;"><span>				resultMap.put(&#34;return_code&#34;, &#34;FAIL&#34;);
</span></span><span style="display:flex;"><span>				resultMap.put(&#34;return_msg&#34;, &#34;验签失败&#34;);
</span></span><span style="display:flex;"><span>				response.getWriter().write(WXPayUtil.mapToXml(map));
</span></span><span style="display:flex;"><span>				response.getWriter().flush();
</span></span><span style="display:flex;"><span>				response.getWriter().close();
</span></span><span style="display:flex;"><span>				return;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		String finalOut_trade_no = out_trade_no;
</span></span><span style="display:flex;"><span>		executorService.execute(() -&gt; {
</span></span><span style="display:flex;"><span>			payService.padBuyVipCallback(finalOut_trade_no);
</span></span><span style="display:flex;"><span>		});
</span></span><span style="display:flex;"><span>		// 如果签名验证正确，立即返回success，后续业务另起线程单独处理
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>		map.put(&#34;return_code&#34;, &#34;SUCCESS&#34;);
</span></span><span style="display:flex;"><span>		response.getWriter().write(WXPayUtil.mapToXml(map));
</span></span><span style="display:flex;"><span>		response.getWriter().flush();
</span></span><span style="display:flex;"><span>		response.getWriter().close();
</span></span><span style="display:flex;"><span>	} catch (Exception e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>		map.put(&#34;return_code&#34;, &#34;FAIL&#34;);
</span></span><span style="display:flex;"><span>		map.put(&#34;return_msg&#34;, &#34;业务处理失败&#34;);
</span></span><span style="display:flex;"><span>		response.getWriter().write(WXPayUtil.mapToXml(map));
</span></span><span style="display:flex;"><span>		response.getWriter().flush();
</span></span><span style="display:flex;"><span>		response.getWriter().close();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="支付宝支付">支付宝支付<a hidden class="anchor" aria-hidden="true" href="#支付宝支付">#</a></h1>
<h2 id="支付宝app支付">支付宝app支付<a hidden class="anchor" aria-hidden="true" href="#支付宝app支付">#</a></h2>
<p><a href="https://docs.open.alipay.com/204">官方文档</a>
支付宝的文档真的一目了然，比微信强太多&hellip;
<a href="https://blog.csdn.net/shuaishuaidewo/article/details/88641913">参考</a></p>
<h2 id="支付宝-手机网站支付">支付宝-手机网站支付<a hidden class="anchor" aria-hidden="true" href="#支付宝-手机网站支付">#</a></h2>
<p><a href="https://opendocs.alipay.com/open/203/105288">手机网站支付官方文档</a>
一定要仔细看官方文档，根据文档提示，一步一步来。
需要注意的是官方文档的这句话：
支付宝会为开发者生成前台页面请求需要的完整 form 表单的 html（包含自动提交脚本），商家直接将这个表单的 String 输出到 http response 中即可。
就是说后台请求支付宝接口后，支付宝会返回一个表单字符串，类似这种：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;form name=&#34;punchout_form&#34; method=&#34;post&#34;
</span></span><span style="display:flex;"><span> action=&#34;https://openapi.alipay.com/gateway.do?charset=GBK&amp;method=alipay.trade.wap.pay&amp;sign=XXXXXXXX&#34;&gt;
</span></span><span style="display:flex;"><span> &lt;input type=&#34;hidden&#34; name=&#34;biz_content&#34; value=&#34;{&amp;quot;out_trade_no&amp;quot;:&amp;quot;468281ee-cc38-4a83-96f9-608538b80799&amp;quot;,&amp;quot;total_amount&amp;quot;:0.01,&amp;quot;subject&amp;quot;:&amp;quot;biaoti&amp;quot;,&amp;quot;product_code&amp;quot;:&amp;quot;QUICK_WAP_WAY&amp;quot;}&#34;&gt;
</span></span><span style="display:flex;"><span> &lt;input type=&#34;submit&#34; value=&#34;立即支付&#34; style=&#34;display:none&#34; &gt;
</span></span><span style="display:flex;"><span>&lt;/form&gt;
</span></span><span style="display:flex;"><span> &lt;script&gt;
</span></span><span style="display:flex;"><span>  document.forms[0].submit();
</span></span><span style="display:flex;"><span> &lt;/script&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们把这个表单直接返回给前端，让前端直接展示就可以拉起支付宝的支付界面了。是不需要预支付的。
需要注意：这段html代码返回给前端时，有两种方式，1是通过<code>HttpServletResponse</code>返回给前端，2是直接将字符串返回给前端，而不能通过带key的 json 返回给前端，因为带 key 的 json值是带双引号的，而表单里也有双引号，所以表单里的双引号前端会自动带上<code>/</code> 转义符，导致前端无法识别。</p>
<p>另外，通过这个网页：https://www.w3school.com.cn/tiy/t.asp?f=eg_html_basic</p>
<p>我们可以在线预览html的样式，所以可以把支付宝返回的form表单直接放到这个网页上，可以看到支付宝的支付页的效果。注意：需要去掉表单中的特殊字符，例如<code>\</code></p>
<h2 id="支付宝扫码支付当面付">支付宝扫码支付（当面付）<a hidden class="anchor" aria-hidden="true" href="#支付宝扫码支付当面付">#</a></h2>
<p>扫码支付属于支付宝<code>当面付</code>的一种，需要商户在自己的服务器生成支付二维码，用户扫码，完成支付，并不是支付宝的web网页支付。
<a href="https://opendocs.alipay.com/open/194/105072">参考官方文档</a></p>
<p>首先登录<a href="https://open.alipay.com/platform/home.htm">支付宝开放平台</a>
参考<a href="https://opendocs.alipay.com/open/200/105310">官方流程</a>创建并配置应用。
创建应用-&gt;网页&amp;移动应用-&gt;支付接入-&gt;网页应用
网址和应用简介可以不填，然后开始配置应用环境。
接口加签方式：必填，<a href="https://opendocs.alipay.com/open/291/105971#LDsXr">参考官方文档填写</a>
推荐使用<a href="https://miniu.alipay.com/keytool/create">官方密钥生成工具</a>
点击生成密钥，会生成<code>应用私钥</code>和<code>应用公钥</code>。应用私钥需要妥善保存在代码中，不能泄露。然后复制应用公钥，填写到公钥字符串，点确定，会同时生成<code>支付宝公钥</code>，此时把支付宝公钥写到代码中，而不是应用公钥，注意：代码中要使用<code>应用私钥</code>和<code>支付宝公钥</code>，应用公钥是生成支付宝公钥用的。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AlipayConfig {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//支付宝网关（固定）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String GATEWAY_URL = <span style="color:#0ff;font-weight:bold">&#34;https://openapi.alipay.com/gateway.do&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//支付宝appId，APPID 即创建应用后生成
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ALI_APP_ID = <span style="color:#0ff;font-weight:bold">&#34;2019080666125207&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 商户的私钥,使用支付宝自带的openssl工具生成。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String ALI_APP_PRIVATE_KEY = <span style="color:#0ff;font-weight:bold">&#34;你的私钥&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 应用的公钥，无需修改该值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String ali_public_key = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 支付宝的公钥，去open.alipay.com对应应用下查看。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String ALIPAY_PUBLIC_KEY=<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 字符编码格式 目前支持 gbk 或 utf-8
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String input_charset = <span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//参数返回格式，只支持 json
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String FORMAT = <span style="color:#0ff;font-weight:bold">&#34;json&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//商户生成签名字符串所使用的签名算法类型，目前支持 RSA2 和 RSA，推荐使用 RSA2
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String SIGN_TYPE = <span style="color:#0ff;font-weight:bold">&#34;RSA2&#34;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>service</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public interface AlipayService {
</span></span><span style="display:flex;"><span>    String prePayAndGetQrcode();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>实现类</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span>@Slf4j
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AliPayServiceImpl <span style="color:#fff;font-weight:bold">implements</span> AlipayService {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> AlipayClient alipayClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init() {
</span></span><span style="display:flex;"><span>        alipayClient = <span style="color:#fff;font-weight:bold">new</span> DefaultAlipayClient(
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">GATEWAY_URL</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">ALI_APP_ID</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">ALI_APP_PRIVATE_KEY</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">FORMAT</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">ALIPAY_PUBLIC_KEY</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">SIGN_TYPE</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 预支付，并生成支付二维码
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String prePayAndGetQrcode() {
</span></span><span style="display:flex;"><span>        String orderNo = OrderCodeFactory.<span style="color:#007f7f">getOrderCode</span>(<span style="color:#ff0;font-weight:bold">675</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;预支付，并生成支付二维码&#34;</span>);
</span></span><span style="display:flex;"><span>        AlipayTradePrecreateRequest request = <span style="color:#fff;font-weight:bold">new</span> AlipayTradePrecreateRequest();
</span></span><span style="display:flex;"><span>        AlipayTradePrecreateModel model = <span style="color:#fff;font-weight:bold">new</span> AlipayTradePrecreateModel();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setSubject</span>(<span style="color:#0ff;font-weight:bold">&#34;支付测试&#34;</span>);
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setOutTradeNo</span>(orderNo);
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setTimeoutExpress</span>(<span style="color:#0ff;font-weight:bold">&#34;30m&#34;</span>);
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setTotalAmount</span>(MoneyUtil.<span style="color:#007f7f">fen2Yuan</span>(<span style="color:#ff0;font-weight:bold">1</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        request.<span style="color:#007f7f">setBizModel</span>(model);
</span></span><span style="display:flex;"><span>        request.<span style="color:#007f7f">setNotifyUrl</span>(PayConstant.<span style="color:#007f7f">ALI_NOTIFY_URL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        AlipayTradePrecreateResponse response;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//注意，这里是execute，而不是sdkExecute，和app支付不同
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            response = alipayClient.<span style="color:#007f7f">execute</span>(request);
</span></span><span style="display:flex;"><span>            String qr_code = response.<span style="color:#007f7f">getQrCode</span>();
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;qr_code是：&#34;</span> + qr_code);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//可以将二维码生成到本地，也可以将qr_code字符串返回给前端，让前端生成
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            String filePath = String.format(&#34;C:\\Users\\wjy\\Desktop\\qr-%s.png&#34;, response.getOutTradeNo());
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            log.info(&#34;filePath:&#34; + filePath);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            ZxingUtils.getQRCodeImge(response.getQrCode(), 256, filePath);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        } <span style="color:#fff;font-weight:bold">catch</span> (AlipayApiException e) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;支付宝支付失败{}&#34;</span>, e.<span style="color:#007f7f">getErrMsg</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ServiceException(e.<span style="color:#007f7f">getErrMsg</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (response.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;调用成功&#34;</span> + response.<span style="color:#007f7f">getBody</span>());
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//把二维码字符串返回给前端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> response.<span style="color:#007f7f">getQrCode</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;调用失败&#34;</span> + response.<span style="color:#007f7f">getBody</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>也可以使用[沙箱环境]测试(<a href="https://opendocs.alipay.com/open/200/105311">https://opendocs.alipay.com/open/200/105311</a>)</p>
<p>回调方法</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">93
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author: wjy
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @description: 支付宝异步回调地址，扫码付
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@PostMapping(<span style="color:#0ff;font-weight:bold">&#34;padBuyVipAliPayCallback&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> String padBuyVipAliPayCallback(HttpServletRequest request) {
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//将异步通知中收到的待验证所有参数都存放到map中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	Map&lt;String, String&gt; params = convertRequestParamsToMap(request);
</span></span><span style="display:flex;"><span>	String paramsJson = JSON.<span style="color:#007f7f">toJSONString</span>(params);
</span></span><span style="display:flex;"><span>	log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;支付宝回调，{}&#34;</span>, paramsJson);
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// 调用SDK验证签名
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">boolean</span> signVerified = AlipaySignature.<span style="color:#007f7f">rsaCheckV1</span>(params, PayConstant.<span style="color:#007f7f">ALIPAY_PUBLIC_KEY</span>,
</span></span><span style="display:flex;"><span>				PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>, PayConstant.<span style="color:#007f7f">SIGN_TYPE</span>);
</span></span><span style="display:flex;"><span>		log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;signVerified={}&#34;</span>, signVerified);
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">if</span> (!signVerified) {
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;支付宝回调签名认证失败, paramsJson:{}&#34;</span>, paramsJson);
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;failure&#34;</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;支付宝回调签名认证成功&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// 按照支付结果异步通知中的描述，对支付结果中的业务内容进行1\2\3\4二次校验，校验成功后在response中返回success，校验失败返回failure
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		check(params);
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// 另起线程处理业务
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;另起线程处理业务&#34;</span>);
</span></span><span style="display:flex;"><span>		executorService.<span style="color:#007f7f">execute</span>(() -&gt; {
</span></span><span style="display:flex;"><span>			AlipayNotifyParam param = buildAlipayNotifyParam(params);
</span></span><span style="display:flex;"><span>			String tradeStatus = param.<span style="color:#007f7f">getTradeStatus</span>();
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">// 支付成功
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			<span style="color:#fff;font-weight:bold">if</span> (tradeStatus.<span style="color:#007f7f">equals</span>(<span style="color:#0ff;font-weight:bold">&#34;TRADE_SUCCESS&#34;</span>)) {
</span></span><span style="display:flex;"><span>				log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;支付成功&#34;</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#007f7f">//TODO 支付成功回调
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>				alipayService.<span style="color:#007f7f">padBuyVipCallback</span>(param.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>			} <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>				log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;支付失败&#34;</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#007f7f">//TODO 用户处理自己逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			}
</span></span><span style="display:flex;"><span>		});
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// 如果签名验证正确，立即返回success，后续业务另起线程单独处理
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;success&#34;</span>;
</span></span><span style="display:flex;"><span>	} <span style="color:#fff;font-weight:bold">catch</span> (AlipayApiException e) {
</span></span><span style="display:flex;"><span>		log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;支付宝回调发生异常{}&#34;</span>, e.<span style="color:#007f7f">getLocalizedMessage</span>());
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;failure&#34;</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 将request中的参数转换成Map
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> Map&lt;String, String&gt; convertRequestParamsToMap(HttpServletRequest request) {
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; retMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//1.从支付宝回调的request域中取值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Map&lt;String, String[]&gt; requestParams = request.<span style="color:#007f7f">getParameterMap</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (Iterator&lt;String&gt; iter = requestParams.<span style="color:#007f7f">keySet</span>().<span style="color:#007f7f">iterator</span>(); iter.<span style="color:#007f7f">hasNext</span>(); ) {
</span></span><span style="display:flex;"><span>            String name = iter.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>            String[] values = requestParams.<span style="color:#007f7f">get</span>(name);
</span></span><span style="display:flex;"><span>            String valueStr = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; values.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>                valueStr = (i == values.<span style="color:#007f7f">length</span> - <span style="color:#ff0;font-weight:bold">1</span>) ? valueStr + values[i] : valueStr + values[i] + <span style="color:#0ff;font-weight:bold">&#34;,&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// valueStr = new String(valueStr.getBytes(&#34;ISO-8859-1&#34;), &#34;gbk&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            retMap.<span style="color:#007f7f">put</span>(name, valueStr);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> retMap;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> AlipayNotifyParam buildAlipayNotifyParam(Map&lt;String, String&gt; params) {
</span></span><span style="display:flex;"><span>        String json = JSON.<span style="color:#007f7f">toJSONString</span>(params);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> JSON.<span style="color:#007f7f">parseObject</span>(json, AlipayNotifyParam.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">void</span> check(Map&lt;String, String&gt; params) <span style="color:#fff;font-weight:bold">throws</span> AlipayApiException {
</span></span><span style="display:flex;"><span>        String outTradeNo = params.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号，
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Orders order = <span style="color:#fff;font-weight:bold">new</span> Orders();
</span></span><span style="display:flex;"><span>        order.<span style="color:#007f7f">setOrderNo</span>(outTradeNo);
</span></span><span style="display:flex;"><span>        order = orderService.<span style="color:#007f7f">getOrderByOrderNo</span>(order);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (order == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AlipayApiException(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no错误&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额），
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Integer totalAmount = MoneyUtil.<span style="color:#007f7f">yuan2Fen</span>(<span style="color:#fff;font-weight:bold">new</span> BigDecimal(params.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;total_amount&#34;</span>)));
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;totalAmount{}&#34;</span>, totalAmount);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!totalAmount.<span style="color:#007f7f">equals</span>(order.<span style="color:#007f7f">getOrderPrice</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AlipayApiException(<span style="color:#0ff;font-weight:bold">&#34;error total_amount&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 3、验证app_id是否为该商户本身。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (!params.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;app_id&#34;</span>).<span style="color:#007f7f">equals</span>(PayConstant.<span style="color:#007f7f">ALI_APP_ID</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AlipayApiException(<span style="color:#0ff;font-weight:bold">&#34;app_id不一致&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="异步回调异常问题">异步回调异常问题<a hidden class="anchor" aria-hidden="true" href="#异步回调异常问题">#</a></h2>
<ul>
<li>检查预支付时，<code>request.setNotifyUrl(PayConstant.ALI_NOTIFY_URL);</code>，是否设置正确</li>
<li>检查是否项目的接口有访问限制。比如系统做了登录拦截</li>
<li>检查接口是否可以公网访问</li>
</ul>
<p>通过<a href="https://opendocs.alipay.com/open/194/103296">异步通知官方文档</a>排查问题。
通过<a href="https://openmonitor.alipay.com/acceptance/cloudparse.htm">蚂蚁金服开发平台</a>排查问题。</p>
<p>注意：支付码只能一个人扫，如果多个人扫一个码，后扫码的人，会提示<code>交易买家不匹配</code>。</p>
<h3 id="一年后收到支付宝的异步回调通知">一年后收到支付宝的异步回调通知<a hidden class="anchor" aria-hidden="true" href="#一年后收到支付宝的异步回调通知">#</a></h3>
<p>服务器收到了一年前支付成功订单的异步回调通知，还好后面的逻辑有对订单状态进行校验，所以没有流程上的漏洞。</p>
<p>查看官方文档：</p>
<p><a href="https://opendocs.alipay.com/open/203/105286?pathHash=022a439c#%E9%80%9A%E7%9F%A5%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6">https://opendocs.alipay.com/open/203/105286?pathHash=022a439c#%E9%80%9A%E7%9F%A5%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6</a></p>
<p><a href="https://opendocs.alipay.com/support/01ray9">https://opendocs.alipay.com/support/01ray9</a></p>
<p>已知支付宝会在TRADE_FINISHED、TRADE_SUCCESS和TRADE_CLOSED三种情况下出发异步通知，通过分析支付宝发送的报文：</p>
<p><code>trade_status=TRADE_FINISHED&amp;refund_fee=0.00</code>，得知通知类型为TRADE_FINISHED。</p>
<p>TRADE_FINISHED 的通知触发条件是：
一、商户签约的产品不支持退款功能的前提下，买家付款成功；
二、商户签约的产品支持退款功能的前提下，交易已经成功并且已经超过可退款期限。
所以这种情况属于TRADE_FINISHED的第二种。</p>
<p>查验后台设置的可退款期限：<strong>一年</strong></p>
<p>所以这并不是支付成功的异步通知，而是<code>交易已经成功并且已经超过可退款期限</code>的异步通知。</p>
<p>支付宝方面的问题：</p>
<ol>
<li><code>alipay.trade.refund</code> <a href="https://link.segmentfault.com/?enc=8ys3UWusjx0hxFxd4%2BYZXw%3D%3D.MtOKOgMQVXIHIrl1yx835epiLI0X8AEloW2RPwNYD%2FJtpRYImRkfmbT1HrU8saTq0UbT%2BNH%2Fg90tK6S50xB4UA%3D%3D">统一收单交易退款接口</a> 没有提及退款存在回调的情况。而事实上退款之后(无论是全额还是部分)，都会触发一次异步通知</li>
<li>支付宝的回调通知数据结构非常像，如果这次我们不是在自身的订单状态上预先做判断，可能这次我们遇到的问题会导致财务风险</li>
</ol>
<p>本部分参考：https://segmentfault.com/a/1190000040058734</p>
<h1 id="苹果支付">苹果支付<a hidden class="anchor" aria-hidden="true" href="#苹果支付">#</a></h1>
<p><a href="https://developer.apple.com/library/archive/releasenotes/General/ValidateAppStoreReceipt/Chapters/ValidateRemotely.html#//apple_ref/doc/uid/TP40010573-CH104-SW4">苹果支付官方文档</a>
只要你在苹果系统购买APP中虚拟物品（虚拟货币，VIP充值等），必须通过内购方式进行支付，苹果和商家进行三七开。
<img loading="lazy" src="5.png" alt=""  />
</p>
<p>和支付宝、微信支付不同，唤起支付到付款完成，这个动作，都是由前端自己处理就可以了，不需要在支付前通过服务端拿到签名等信息。
支付成功后，苹果服务器会给前端一串东西，前端再把这串东西，传给自己的服务端，服务端拿到这串东西再到苹果服务器验证，根据返回内容验证是否通过，如果通过证明前端是真的有支付发生。服务端根据和前端约定好的支付内容解析获取自己的数据，处理自己的业务逻辑就可以了。</p>
<p>需要注意：<code>TransactionID</code>是前端向苹果查询<code>product_id</code>是否存在时，苹果就把<code>TransactionID</code>返回给前端了。该参数必须由前端传过来。后端通过该参数验证订单的正确情况。前端支付成功后，拿到参数：{&ldquo;receipt-data&rdquo; : &ldquo;MIIVDAYJKoZIhvcNAQcCoIIU/T&hellip;&quot;}，将参数传给我们自己的服务器，由我们向苹果服务器发送post请求。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RequestMapping(value = <span style="color:#0ff;font-weight:bold">&#34;/apple/verify&#34;</span>, method = RequestMethod.<span style="color:#007f7f">POST</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> BaseResponse&lt;Object&gt; appleVerify(String data) {
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//data = {&#34;receipt-data&#34; : &#34;MIIVDAYJKoZIhvcNAQcCoIIU/T...&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">// 苹果支付沙箱验证地址
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	String url = <span style="color:#0ff;font-weight:bold">&#34;https://sandbox.itunes.apple.com/verifyReceipt&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// 苹果支付正式验证地址
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">// String url = &#34;https://buy.itunes.apple.com/verifyReceipt&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	JSONObject param = JSON.<span style="color:#007f7f">parseObject</span>(data);
</span></span><span style="display:flex;"><span>	JSONObject result = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">sendPost</span>(url, param);
</span></span><span style="display:flex;"><span>	log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;order apple notify result: {}&#34;</span>, result);
</span></span><span style="display:flex;"><span>	Integer status = result.<span style="color:#007f7f">getInteger</span>(<span style="color:#0ff;font-weight:bold">&#34;status&#34;</span>);<span style="color:#007f7f">//0 成功的
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//处理自己的订单业务逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//返回
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> BaseResponse&lt;Object&gt;(status == <span style="color:#ff0;font-weight:bold">0</span> ? <span style="color:#0ff;font-weight:bold">&#34;SUCCESS&#34;</span> : <span style="color:#0ff;font-weight:bold">&#34;FAIL&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>status状态码</p>
<ul>
<li>0 SUCCESS</li>
<li>21000 App Store不能读取你提供的JSON对象</li>
<li>21002 receipt-data域的数据有问题</li>
<li>21003 receipt无法通过验证</li>
<li>21004 提供的shared secret不匹配你账号中的shared secret</li>
<li>21005 receipt服务器当前不可用</li>
<li>21006 receipt合法，但是订阅已过期。服务器接收到这个状态码时，receipt数据仍然会解码并一起发送</li>
<li>21007 receipt是Sandbox receipt，但却发送至生产系统的验证服务</li>
<li>21008 receipt是生产receipt，但却发送至Sandbox环境的验证服务</li>
</ul>
<p>status为0(成功)时，返回的数据：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;environment&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Sandbox&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;receipt&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;in_app&#34;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;transaction_id&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1000000514154331&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;original_purchase_date&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 06:40:18 Etc/GMT&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;quantity&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;original_transaction_id&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1000000514154331&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;purchase_date_pst&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-27 23:40:18 America/Los_Angeles&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;original_purchase_date_ms&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1553755218000&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;purchase_date_ms&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1553755218000&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;product_id&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;ERSHUAI18&#34;</span>,<span style="color:#007f7f">//18是钱，具体格式和前端约定。服务端把约定字符串（ERSHUAI）去掉，剩下的数字（18）就是业务逻辑需要的金额
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="font-weight:bold">&#34;original_purchase_date_pst&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-27 23:40:18 America/Los_Angeles&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;is_trial_period&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;false&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;purchase_date&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 06:40:18 Etc/GMT&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;adam_id&#34;</span>: <span style="color:#ff0;font-weight:bold">0</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;receipt_creation_date&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 08:21:40 Etc/GMT&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;original_application_version&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1.0&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;app_item_id&#34;</span>: <span style="color:#ff0;font-weight:bold">0</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;original_purchase_date_ms&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1375340400000&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;request_date_ms&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1553761302654&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;original_purchase_date_pst&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2013-08-01 00:00:00 America/Los_Angeles&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;original_purchase_date&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2013-08-01 07:00:00 Etc/GMT&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;receipt_creation_date_pst&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 01:21:40 America/Los_Angeles&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;receipt_type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;ProductionSandbox&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;bundle_id&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.ershuai.blog&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;receipt_creation_date_ms&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1553761300000&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;request_date&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 08:21:42 Etc/GMT&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;version_external_identifier&#34;</span>: <span style="color:#ff0;font-weight:bold">0</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;request_date_pst&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 01:21:42 America/Los_Angeles&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;download_id&#34;</span>: <span style="color:#ff0;font-weight:bold">0</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;application_version&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1.0.1&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;status&#34;</span>: <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://www.jianshu.com/p/976fc6090cfa">参考</a>
<a href="https://blog.csdn.net/shuai825644975/article/details/88872103">参考</a>
<a href="https://blog.csdn.net/jianzhonghao/article/details/79343887">参考</a></p>
<h1 id="策略模式实现多支付">策略模式实现多支付<a hidden class="anchor" aria-hidden="true" href="#策略模式实现多支付">#</a></h1>
<h2 id="设计思路">设计思路<a hidden class="anchor" aria-hidden="true" href="#设计思路">#</a></h2>
<p>策略模式+工厂模式，工厂方法用于创建不同场景下的策略。类图如下：
<img loading="lazy" src="1.jpg" alt=""  />

策略接口<code>IPayStrategy</code>定义了需要子类实现的方法 ，每一种支付方式为一种策略。
场景类通过枚举类获取策略类型，通过PayFactory创建场景类需要的支付策略。
工厂方法可以创建默认商户的支付策略，也可以在工厂方法里再写一个使用指定商户id或第三方支付的沙箱环境的方法 ，payBaseModel为一些业务参数，例如标题，描述，回调接口以及支付完的跳转页面等。</p>
<h2 id="maven依赖">maven依赖<a hidden class="anchor" aria-hidden="true" href="#maven依赖">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>com.alipay.sdk<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>alipay-sdk-java<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.0.52.ALL<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>com.wxpay.sdk<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>wxpay-sdk<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.0.9<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.httpcomponents<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>httpclient<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>4.5<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.commons<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>commons-lang3<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.3.1<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.commons<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>commons-lang3<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.3.1<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于微信最新的支付sdk在maven仓库里已经没有，合并为了weixin-java-tools里的一个模块，详见
<a href="https://github.com/wechat-group/WxJava">https://github.com/wechat-group/WxJava</a>
本文所使用的微信支付sdk是官网下载后自己编译的。</p>
<h2 id="关键类">关键类<a hidden class="anchor" aria-hidden="true" href="#关键类">#</a></h2>
<h3 id="策略接口">策略接口<a hidden class="anchor" aria-hidden="true" href="#策略接口">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public interface IPayStrategy {
</span></span><span style="display:flex;"><span>    public Map&lt;String,String&gt; excutePayOrder(PayBaseModel model) throws Exception;
</span></span><span style="display:flex;"><span>    public int excuteQueryStatus(String orderNo) throws Exception;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="业务参数类">业务参数类<a hidden class="anchor" aria-hidden="true" href="#业务参数类">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PayBaseModel <span style="color:#fff;font-weight:bold">implements</span> Serializable {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> serialVersionUID = <span style="color:#ff0;font-weight:bold">1L</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//商品标题
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String title;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//商品描述
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String desc;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//回调地址
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String notifyUrl;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//交易金额
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String tradeMoney;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//商户订单号
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String outTradeNo;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//自定义参数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String attach;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//网页支付完成后的跳转地址
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String returnUrl;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//用户ip
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String realIp;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//请求头
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String referer;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//get set方法自己实现 也可以不用实现，因为构造函数里传入了
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> PayBaseModel(String title, String notifyUrl, String tradeMoney, String outTradeNo, String returnUrl) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">title</span> = title;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">notifyUrl</span> = notifyUrl;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">tradeMoney</span> = tradeMoney;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">outTradeNo</span> = outTradeNo;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">returnUrl</span> = returnUrl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> PayBaseModel(String title, String notifyUrl, String tradeMoney, String outTradeNo) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">title</span> = title;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">notifyUrl</span> = notifyUrl;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">tradeMoney</span> = tradeMoney;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">outTradeNo</span> = outTradeNo;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="四种支付策略">四种支付策略<a hidden class="anchor" aria-hidden="true" href="#四种支付策略">#</a></h3>
<h4 id="aliapppaystrategy">AliAppPayStrategy<a hidden class="anchor" aria-hidden="true" href="#aliapppaystrategy">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.AlipayApiException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.AlipayClient;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.AlipayResponse;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.DefaultAlipayClient;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.domain.AlipayTradeAppPayModel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.request.AlipayTradeAppPayRequest;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.IPayStrategy;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.PayConstant;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.model.PayBaseModel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.lang3.StringUtils;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.math.BigDecimal;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.text.DecimalFormat;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//支付宝APP支付
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AliAppPayStrategy <span style="color:#fff;font-weight:bold">implements</span> IPayStrategy {
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String url;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String appId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String privateKey;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String publicKey;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> orderTimeOUt;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> Logger LOGGER = LoggerFactory.<span style="color:#007f7f">getLogger</span>(AliAppPayStrategy.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> AliAppPayStrategy(String url, String appId, String privateKey, String publicKey, <span style="color:#fff;font-weight:bold">int</span> orderTimeOUt) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span> = url;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span> = appId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">privateKey</span> = privateKey;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">publicKey</span> = publicKey;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOUt</span> = orderTimeOUt;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Map&lt;String, String&gt; excutePayOrder(PayBaseModel payBaseModel) <span style="color:#fff;font-weight:bold">throws</span> AlipayApiException {
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************获取支付宝APP支付模板&#34;</span> + payBaseModel.<span style="color:#007f7f">toString</span>()
</span></span><span style="display:flex;"><span>                + <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; resultMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        AlipayTradeAppPayRequest payRequest = <span style="color:#fff;font-weight:bold">new</span> AlipayTradeAppPayRequest();
</span></span><span style="display:flex;"><span>        AlipayTradeAppPayModel model = <span style="color:#fff;font-weight:bold">new</span> AlipayTradeAppPayModel();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//组装必填参数：订单标题 商家交易订单号 交易金额
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        model.<span style="color:#007f7f">setSubject</span>(payBaseModel.<span style="color:#007f7f">getTitle</span>());
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setOutTradeNo</span>(payBaseModel.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!StringUtils.<span style="color:#007f7f">isEmpty</span>(payBaseModel.<span style="color:#007f7f">getDesc</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//交易详情
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            model.<span style="color:#007f7f">setBody</span>(payBaseModel.<span style="color:#007f7f">getDesc</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setTotalAmount</span>(<span style="color:#fff;font-weight:bold">new</span> DecimalFormat(<span style="color:#0ff;font-weight:bold">&#34;0.00&#34;</span>).<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> BigDecimal(payBaseModel.<span style="color:#007f7f">getTradeMoney</span>())));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!StringUtils.<span style="color:#007f7f">isEmpty</span>(payBaseModel.<span style="color:#007f7f">getAttach</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//自定义参数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            model.<span style="color:#007f7f">setPassbackParams</span>(payBaseModel.<span style="color:#007f7f">getAttach</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//非必填参数 订单过期时间
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        model.<span style="color:#007f7f">setTimeoutExpress</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOUt</span> + <span style="color:#0ff;font-weight:bold">&#34;m&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//app支付交易码-固定值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        model.<span style="color:#007f7f">setProductCode</span>(<span style="color:#0ff;font-weight:bold">&#34;QUICK_MSECURITY_PAY&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//回调通知
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        payRequest.<span style="color:#007f7f">setNotifyUrl</span>(payBaseModel.<span style="color:#007f7f">getNotifyUrl</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//业务参数模板
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        payRequest.<span style="color:#007f7f">setBizModel</span>(model);
</span></span><span style="display:flex;"><span>        AlipayClient alipayClient = <span style="color:#fff;font-weight:bold">new</span> DefaultAlipayClient(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">privateKey</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">ALI_DEFAULT_FORMAT</span>, PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">publicKey</span>, PayConstant.<span style="color:#007f7f">ALI_DEFAULT_SIGNTYPE</span>);
</span></span><span style="display:flex;"><span>        AlipayResponse response = alipayClient.<span style="color:#007f7f">sdkExecute</span>(payRequest);
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;payContent&#34;</span>, response.<span style="color:#007f7f">getBody</span>());
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, payBaseModel.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************阿里支付下单接口返回数据:&#34;</span> + resultMap + <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> resultMap;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="aliwebpaystrategy">AliWebPayStrategy<a hidden class="anchor" aria-hidden="true" href="#aliwebpaystrategy">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>import com.alibaba.fastjson.JSONObject;
</span></span><span style="display:flex;"><span>import com.alipay.api.AlipayApiException;
</span></span><span style="display:flex;"><span>import com.alipay.api.AlipayClient;
</span></span><span style="display:flex;"><span>import com.alipay.api.DefaultAlipayClient;
</span></span><span style="display:flex;"><span>import com.alipay.api.request.AlipayTradeWapPayRequest;
</span></span><span style="display:flex;"><span>import com.tubitu.util.pay.IPayStrategy;
</span></span><span style="display:flex;"><span>import com.tubitu.util.pay.PayConstant;
</span></span><span style="display:flex;"><span>import com.tubitu.util.pay.model.PayBaseModel;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>import java.math.BigDecimal;
</span></span><span style="display:flex;"><span>import java.text.DecimalFormat;
</span></span><span style="display:flex;"><span>import java.util.HashMap;
</span></span><span style="display:flex;"><span>import java.util.Map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>//支付宝网页支付
</span></span><span style="display:flex;"><span>public class AliWebPayStrategy implements IPayStrategy {
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    private String url;
</span></span><span style="display:flex;"><span>    private String appId;
</span></span><span style="display:flex;"><span>    private String privateKey;
</span></span><span style="display:flex;"><span>    private String publicKey;
</span></span><span style="display:flex;"><span>    private int orderTimeOut;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public AliWebPayStrategy(String url, String appId, String privateKey, String publicKey, int orderTimeOUt) {
</span></span><span style="display:flex;"><span>        this.url = url;
</span></span><span style="display:flex;"><span>        this.appId = appId;
</span></span><span style="display:flex;"><span>        this.privateKey = privateKey;
</span></span><span style="display:flex;"><span>        this.publicKey = publicKey;
</span></span><span style="display:flex;"><span>        this.orderTimeOut = orderTimeOUt;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    public Map&lt;String, String&gt; excutePayOrder(PayBaseModel payBaseModel) throws AlipayApiException {
</span></span><span style="display:flex;"><span>        Map&lt;String,String&gt; resultMap = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        //创建API对应的request
</span></span><span style="display:flex;"><span>        AlipayTradeWapPayRequest alipayRequest = new AlipayTradeWapPayRequest();
</span></span><span style="display:flex;"><span>        //支付完成阿里回跳转到该页面
</span></span><span style="display:flex;"><span>        alipayRequest.setReturnUrl(payBaseModel.getReturnUrl());
</span></span><span style="display:flex;"><span>        //判断传入的地址是否为http或者https开头  支付结果通知接口
</span></span><span style="display:flex;"><span>        alipayRequest.setNotifyUrl(payBaseModel.getNotifyUrl());
</span></span><span style="display:flex;"><span>        JSONObject json = new JSONObject();
</span></span><span style="display:flex;"><span>        json.put(&#34;out_trade_no&#34;, payBaseModel.getOutTradeNo());
</span></span><span style="display:flex;"><span>        json.put(&#34;total_amount&#34;, new DecimalFormat(&#34;0.00&#34;).format(new BigDecimal(payBaseModel.getTradeMoney())));
</span></span><span style="display:flex;"><span>        json.put(&#34;subject&#34;, payBaseModel.getTitle());
</span></span><span style="display:flex;"><span>        json.put(&#34;passback_params&#34;, payBaseModel.getAttach());
</span></span><span style="display:flex;"><span>        json.put(&#34;product_code&#34;, &#34;QUICK_WAP_PAY&#34;);
</span></span><span style="display:flex;"><span>        json.put(&#34;timeout_express&#34;,this.orderTimeOut+&#34;&#34;);
</span></span><span style="display:flex;"><span>        //填充业务参数
</span></span><span style="display:flex;"><span>        alipayRequest.setBizContent(json.toJSONString());
</span></span><span style="display:flex;"><span>        String form = &#34;&#34;;
</span></span><span style="display:flex;"><span>        AlipayClient alipayClient = new DefaultAlipayClient(this.url, this.appId,this.privateKey, 
</span></span><span style="display:flex;"><span>                PayConstant.ALI_DEFAULT_FORMAT, PayConstant.DEFAULT_CHARSET, this.publicKey, PayConstant.ALI_DEFAULT_SIGNTYPE);
</span></span><span style="display:flex;"><span>        //调用SDK生成表单
</span></span><span style="display:flex;"><span>        form = alipayClient.pageExecute(alipayRequest).getBody();
</span></span><span style="display:flex;"><span>        resultMap.put(&#34;form&#34;,form);
</span></span><span style="display:flex;"><span>        return resultMap;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="wxapppaystrategy">WxAppPayStrategy<a hidden class="anchor" aria-hidden="true" href="#wxapppaystrategy">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.github.wxpay.sdk.WXPayConstants;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.github.wxpay.sdk.WXPayUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.date.DateUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.http.ContentTypeEnum;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.IPayStrategy;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.PayUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.model.PayBaseModel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.lang3.StringUtils;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.math.BigDecimal;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Calendar;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Date;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//微信APP支付
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WxAppPayStrategy <span style="color:#fff;font-weight:bold">implements</span> IPayStrategy {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String url;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String appId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String mchId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String appKey;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String partnerId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> orderTimeOut;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> WxAppPayStrategy(String url, String appId, String mchId, String appKey, String partnerId, <span style="color:#fff;font-weight:bold">int</span> orderTimeOut) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span> = url;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span> = appId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">mchId</span> = mchId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appKey</span> = appKey;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">partnerId</span> = partnerId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOut</span> = orderTimeOut;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> Logger LOGGER = LoggerFactory.<span style="color:#007f7f">getLogger</span>(WxAppPayStrategy.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Map&lt;String, String&gt; excutePayOrder(PayBaseModel payBaseModel) {
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************获取微信APP支付模板&#34;</span> + payBaseModel.<span style="color:#007f7f">toString</span>() + 
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; resultMap = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//返回结果
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            resultMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">/*
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">        1 拼接参数向微信请求，获取prepare_id
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>            Map&lt;String, String&gt; paramMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appid&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span>);
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;body&#34;</span>, payBaseModel.<span style="color:#007f7f">getTitle</span>());
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;mch_id&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">mchId</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//后面返回给app时的nonceStr需要与这里的一致
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String nonceStr = WXPayUtil.<span style="color:#007f7f">generateNonceStr</span>();
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonce_str&#34;</span>, nonceStr);
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign_type&#34;</span>, WXPayConstants.<span style="color:#007f7f">MD5</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (!StringUtils.<span style="color:#007f7f">isEmpty</span>(payBaseModel.<span style="color:#007f7f">getAttach</span>())) {
</span></span><span style="display:flex;"><span>                paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;attach&#34;</span>, payBaseModel.<span style="color:#007f7f">getAttach</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, payBaseModel.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//微信支付必须乘以100
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;total_fee&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> BigDecimal(payBaseModel.<span style="color:#007f7f">getTradeMoney</span>()).<span style="color:#007f7f">multiply</span>(<span style="color:#fff;font-weight:bold">new</span> BigDecimal(<span style="color:#0ff;font-weight:bold">&#34;100&#34;</span>)).<span style="color:#007f7f">intValue</span>() + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//获取用户真实ip
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;spbill_create_ip&#34;</span>, payBaseModel.<span style="color:#007f7f">getRealIp</span>());
</span></span><span style="display:flex;"><span>            Date currDate = <span style="color:#fff;font-weight:bold">new</span> Date();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//订单生成时间
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;time_start&#34;</span>, DateUtil.<span style="color:#007f7f">formatDate</span>(currDate, <span style="color:#0ff;font-weight:bold">&#34;yyyyMMddHHmmss&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//订单失效时间
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;time_expire&#34;</span>, DateUtil.<span style="color:#007f7f">formatDate</span>(DateUtil.<span style="color:#007f7f">addDate</span>(currDate, Calendar.<span style="color:#007f7f">MINUTE</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOut</span>), 
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;yyyyMMddHHmmss&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//异步回调
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;notify_url&#34;</span>, payBaseModel.<span style="color:#007f7f">getNotifyUrl</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//支付类型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//app支付
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;trade_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;APP&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(paramMap, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appKey</span>, WXPayConstants.<span style="color:#007f7f">SignType</span>.<span style="color:#007f7f">MD5</span>));
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************微信支付参数集合:&#34;</span> + paramMap + <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            String xmlString = WXPayUtil.<span style="color:#007f7f">mapToXml</span>(paramMap);
</span></span><span style="display:flex;"><span>            String entityString = PayUtil.<span style="color:#007f7f">post</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span>,xmlString,ContentTypeEnum.<span style="color:#007f7f">TextXml</span>.<span style="color:#007f7f">getContentType</span>());
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************微信支付统一下单接口返回数据:&#34;</span> + entityString + <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            Map&lt;String, String&gt; wxXmlMap = WXPayUtil.<span style="color:#007f7f">xmlToMap</span>(entityString);
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">/*
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                2  此处组装返回给前端的参数集合
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//组装返回给前端的数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//app支付   服务端返回App所需数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appid&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span>);
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;noncestr&#34;</span>, nonceStr);
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;partnerid&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">partnerId</span>);
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;prepayid&#34;</span>, wxXmlMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;prepay_id&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//官方暂时规定为固定值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;package&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;Sign=WXPay&#34;</span>);
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;timestamp&#34;</span>, System.<span style="color:#007f7f">currentTimeMillis</span>() / <span style="color:#ff0;font-weight:bold">1000</span> + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//再次生成签名
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(resultMap, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appKey</span>, WXPayConstants.<span style="color:#007f7f">SignType</span>.<span style="color:#007f7f">MD5</span>));
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, payBaseModel.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;\n********************请求微信统一下单接口异常********************&#34;</span>,e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> resultMap;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="wxwebpaystrategy">WxWebPayStrategy<a hidden class="anchor" aria-hidden="true" href="#wxwebpaystrategy">#</a></h4>
<p>由于微信小程序支付的请求逻辑和公众号内支付基本一致，唯一不同的就是appid和appSecret不同(appSecret用于公众号内和小程序内或者用户的openId，即使同一商家，公众号和小程序的appID和appSecret也不一致，而由此获得的同一个用户的openID也不一致），因此可以和公众号内使用相同的逻辑。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.github.wxpay.sdk.WXPayConstants;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.github.wxpay.sdk.WXPayUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.date.DateUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.http.ContentTypeEnum;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.IPayStrategy;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.PayConstant;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.PayUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.model.PayBaseModel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.lang3.StringUtils;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.math.BigDecimal;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.net.URLEncoder;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Calendar;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Date;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//微信公众号/网页支付
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WxWebPayStrategy <span style="color:#fff;font-weight:bold">implements</span> IPayStrategy {
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String url;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String appId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String mchId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String appKey;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String openId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> orderTimeOut;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> WxWebPayStrategy(String url, String appId, String mchId, String appKey, String openId, <span style="color:#fff;font-weight:bold">int</span> orderTimeOut) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span> = url;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span> = appId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">mchId</span> = mchId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appKey</span> = appKey;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">openId</span> = openId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOut</span> = orderTimeOut;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> Logger LOGGER = LoggerFactory.<span style="color:#007f7f">getLogger</span>(WxWebPayStrategy.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Map&lt;String, String&gt; excutePayOrder(PayBaseModel payBaseModel) {
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;\n********************微信网页支付参数\n&#34;</span> + payBaseModel.<span style="color:#007f7f">toString</span>() + <span style="color:#0ff;font-weight:bold">&#34;\n********************&#34;</span>);
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; resultMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; preParamMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        String nonceStr = WXPayUtil.<span style="color:#007f7f">generateNonceStr</span>();
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appid&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span>);
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;mch_id&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">mchId</span>);
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonce_str&#34;</span>, nonceStr);
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;body&#34;</span>, payBaseModel.<span style="color:#007f7f">getTitle</span>());
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, payBaseModel.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>        Date currDate = <span style="color:#fff;font-weight:bold">new</span> Date();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//订单生成时间
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;time_start&#34;</span>, DateUtil.<span style="color:#007f7f">formatDate</span>(currDate, <span style="color:#0ff;font-weight:bold">&#34;yyyyMMddHHmmss&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//订单失效时间
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;time_expire&#34;</span>, DateUtil.<span style="color:#007f7f">formatDate</span>(DateUtil.<span style="color:#007f7f">addDate</span>(currDate, Calendar.<span style="color:#007f7f">MINUTE</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOut</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;yyyyMMddHHmmss&#34;</span>));
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;total_fee&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> BigDecimal(payBaseModel.<span style="color:#007f7f">getTradeMoney</span>()).<span style="color:#007f7f">multiply</span>(<span style="color:#fff;font-weight:bold">new</span> BigDecimal(<span style="color:#0ff;font-weight:bold">&#34;100&#34;</span>)).<span style="color:#007f7f">intValue</span>() + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;spbill_create_ip&#34;</span>, payBaseModel.<span style="color:#007f7f">getRealIp</span>());
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;************************spbill_create_ip&#34;</span> + preParamMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;spbill_create_ip&#34;</span>) + <span style="color:#0ff;font-weight:bold">&#34;************************************&#34;</span>);
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;notify_url&#34;</span>, payBaseModel.<span style="color:#007f7f">getNotifyUrl</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (StringUtils.<span style="color:#007f7f">isNotEmpty</span>(payBaseModel.<span style="color:#007f7f">getAttach</span>())) {
</span></span><span style="display:flex;"><span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;attach&#34;</span>, payBaseModel.<span style="color:#007f7f">getAttach</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (StringUtils.<span style="color:#007f7f">isNotEmpty</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">openId</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//公众号支付 或者 小程序
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;openid&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">openId</span>);
</span></span><span style="display:flex;"><span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;trade_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;JSAPI&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//h5 页面支付
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;trade_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;MWEB&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//需要注意的是H5 页面支付微信需要下面的场景信息，在最终页面提交支付请求的时候拿此处的referer里的数据与提交状态比对
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;scene_info&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;{\&#34;h5_info\&#34;: {\&#34;type\&#34;:\&#34;Wap\&#34;,\&#34;wap_url\&#34;: &#34;</span> + payBaseModel.<span style="color:#007f7f">getReferer</span>() + <span style="color:#0ff;font-weight:bold">&#34;,&#34;</span> + <span style="color:#0ff;font-weight:bold">&#34;\&#34;wap_name\&#34;:&#34;</span> + <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> + <span style="color:#0ff;font-weight:bold">&#34;\&#34;兔比兔\&#34;}}&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(preParamMap, PayConstant.<span style="color:#007f7f">WX_APP_KEY</span>));
</span></span><span style="display:flex;"><span>            String entityString = PayUtil.<span style="color:#007f7f">post</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span>, WXPayUtil.<span style="color:#007f7f">mapToXml</span>(preParamMap), ContentTypeEnum.<span style="color:#007f7f">TextXml</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">getContentType</span>());
</span></span><span style="display:flex;"><span>            Map&lt;String, String&gt; wxXmlMap = WXPayUtil.<span style="color:#007f7f">xmlToMap</span>(entityString);
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">/*
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                    2  此处组装返回给前端的参数集合
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                    */</span>
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************微信支付统一下单接口返回数据:&#34;</span> + wxXmlMap +
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (StringUtils.<span style="color:#007f7f">isEmpty</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">openId</span>)) {
</span></span><span style="display:flex;"><span>                String mwebUrl = wxXmlMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;mweb_url&#34;</span>) + <span style="color:#0ff;font-weight:bold">&#34;&amp;redirect_url=&#34;</span> + URLEncoder.<span style="color:#007f7f">encode</span>(payBaseModel.<span style="color:#007f7f">getReturnUrl</span>(),
</span></span><span style="display:flex;"><span>                        PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>);
</span></span><span style="display:flex;"><span>                LOGGER.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;*****************  mweb_url = &#34;</span> + mwebUrl + <span style="color:#0ff;font-weight:bold">&#34; ************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>                wxXmlMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;mweb_url&#34;</span>, mwebUrl);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">putAll</span>(wxXmlMap);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;code&#34;</span>, <span style="color:#ff0;font-weight:bold">100000</span> + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appId&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span>);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;timeStamp&#34;</span>, System.<span style="color:#007f7f">currentTimeMillis</span>() / <span style="color:#ff0;font-weight:bold">1000</span> + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonceStr&#34;</span>, nonceStr);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;package&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;prepay_id=&#34;</span> + wxXmlMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;prepay_id&#34;</span>));
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;signType&#34;</span>, WXPayConstants.<span style="color:#007f7f">MD5</span>);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;paySign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(resultMap, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appKey</span>));
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;code&#34;</span>, <span style="color:#ff0;font-weight:bold">100000</span> + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;\n********************请求微信统一下单接口异常********************&#34;</span>,e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> resultMap;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="http请求">Http请求<a hidden class="anchor" aria-hidden="true" href="#http请求">#</a></h3>
<p>自己封装的用HttpClient发送Http请求的工具类：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String post(String url, String stringEntity, String ContentType){
</span></span><span style="display:flex;"><span>    String result = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    CloseableHttpClient httpClient = HttpClients.<span style="color:#007f7f">createDefault</span>();
</span></span><span style="display:flex;"><span>    CloseableHttpResponse response = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        HttpPost httpPost = <span style="color:#fff;font-weight:bold">new</span> HttpPost(url);
</span></span><span style="display:flex;"><span>        RequestConfig requestConfig = RequestConfig.<span style="color:#007f7f">custom</span>().<span style="color:#007f7f">setSocketTimeout</span>(<span style="color:#ff0;font-weight:bold">8000</span>).<span style="color:#007f7f">setConnectTimeout</span>(<span style="color:#ff0;font-weight:bold">6000</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>        httpPost.<span style="color:#007f7f">setConfig</span>(requestConfig);
</span></span><span style="display:flex;"><span>        StringEntity entity = <span style="color:#fff;font-weight:bold">new</span> StringEntity(stringEntity, PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>);
</span></span><span style="display:flex;"><span>        httpPost.<span style="color:#007f7f">addHeader</span>(<span style="color:#0ff;font-weight:bold">&#34;Content-Type&#34;</span>, ContentType);
</span></span><span style="display:flex;"><span>        httpPost.<span style="color:#007f7f">addHeader</span>(<span style="color:#0ff;font-weight:bold">&#34;User-Agent&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)&#34;</span>);
</span></span><span style="display:flex;"><span>        httpPost.<span style="color:#007f7f">setEntity</span>(entity);
</span></span><span style="display:flex;"><span>        response = httpClient.<span style="color:#007f7f">execute</span>(httpPost);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//读取响应体转化为字符串  建议：确定目标地址发出有限长度的响应时，使用该方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        HttpEntity responseEntiry = response.<span style="color:#007f7f">getEntity</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//不然使用流的方式好些
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">/* if (entity != null) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            InputStream inputStream = entity.getContent();
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream));
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            String line = &#34;&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            while ((line = bufferedReader.readLine()) != null) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                System.out.println(line);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">        }*/</span>
</span></span><span style="display:flex;"><span>        result = EntityUtils.<span style="color:#007f7f">toString</span>(responseEntiry, PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;\n******************http post error**********************&#34;</span>,e);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            httpClient.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;\n********************close httpclient/response error********************&#34;</span>,e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="策略枚举">策略枚举<a hidden class="anchor" aria-hidden="true" href="#策略枚举">#</a></h3>
<p>枚举暴露给客户端，以生成不同策略。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">enum</span> PayAlgorithm {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//支付宝客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ALI_APP,
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//支付宝页面端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ALI_WEB,
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//微信客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    WX_APP,
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//微信页面端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    WX_WEB,
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//微信小程序
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    WX_XCX;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="策略工厂">策略工厂<a hidden class="anchor" aria-hidden="true" href="#策略工厂">#</a></h3>
<p>工厂创建策略时，需要传入策略所需的一些配置参数，本文中商户只有一个，因此只有一个创建默认商户的支付策略。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//支付工厂类，可以创建默认支付客户端，也可以创建自定义账户客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PayFactory {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//创建默认支付客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> IPayStrategy createDefaultTubituStrategy(PayAlgorithm algorithm, String openId){
</span></span><span style="display:flex;"><span>        IPayStrategy iPayStrategy = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">switch</span> (algorithm){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ALI_APP:
</span></span><span style="display:flex;"><span>                iPayStrategy = <span style="color:#fff;font-weight:bold">new</span> AliAppPayStrategy(PayConstant.<span style="color:#007f7f">ALI_ORDER_URL</span>,PayConstant.<span style="color:#007f7f">ALI_APP_ID</span>,PayConstant
</span></span><span style="display:flex;"><span>                        .<span style="color:#007f7f">ALI_PRIVATE_KEY</span>,PayConstant.<span style="color:#007f7f">ALI_PUBLIC_KEY</span>,<span style="color:#ff0;font-weight:bold">30</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ALI_WEB:
</span></span><span style="display:flex;"><span>                iPayStrategy = <span style="color:#fff;font-weight:bold">new</span> AliWebPayStrategy(PayConstant.<span style="color:#007f7f">ALI_ORDER_URL</span>,PayConstant.<span style="color:#007f7f">ALI_APP_ID</span>,PayConstant
</span></span><span style="display:flex;"><span>                        .<span style="color:#007f7f">ALI_PRIVATE_KEY</span>,PayConstant.<span style="color:#007f7f">ALI_PUBLIC_KEY</span>,<span style="color:#ff0;font-weight:bold">30</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> WX_APP:
</span></span><span style="display:flex;"><span>                iPayStrategy = <span style="color:#fff;font-weight:bold">new</span> WxAppPayStrategy(PayConstant.<span style="color:#007f7f">WX_UNIFIEDORDER_URL</span>,PayConstant.<span style="color:#007f7f">WX_APP_ID</span>,
</span></span><span style="display:flex;"><span>                        PayConstant.<span style="color:#007f7f">WX_MCH_ID</span>,PayConstant.<span style="color:#007f7f">WX_APP_KEY</span>,PayConstant.<span style="color:#007f7f">WX_PARTNER_ID</span>,<span style="color:#ff0;font-weight:bold">30</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> WX_WEB:
</span></span><span style="display:flex;"><span>                iPayStrategy = <span style="color:#fff;font-weight:bold">new</span> WxWebPayStrategy(PayConstant.<span style="color:#007f7f">WX_UNIFIEDORDER_URL</span>,PayConstant.<span style="color:#007f7f">WX_H5_APPID</span>,
</span></span><span style="display:flex;"><span>                        PayConstant.<span style="color:#007f7f">WX_H5_MCHID</span>,PayConstant.<span style="color:#007f7f">WX_APP_KEY</span>,openId,<span style="color:#ff0;font-weight:bold">30</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> WX_XCX:
</span></span><span style="display:flex;"><span>                iPayStrategy = <span style="color:#fff;font-weight:bold">new</span> WxWebPayStrategy(PayConstant.<span style="color:#007f7f">WX_UNIFIEDORDER_URL</span>,PayConstant.<span style="color:#007f7f">WX_XCX_APPID</span>,
</span></span><span style="display:flex;"><span>                        PayConstant.<span style="color:#007f7f">WX_H5_MCHID</span>,PayConstant.<span style="color:#007f7f">WX_APP_KEY</span>,openId,<span style="color:#ff0;font-weight:bold">30</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> iPayStrategy;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="场景调用">场景调用<a hidden class="anchor" aria-hidden="true" href="#场景调用">#</a></h3>
<p>首先通过工厂创建指定策略，然后执行接口里的方法，Java能够动态绑定对应实现类。
以下代码适用于在controller里调用策略返回支付参数。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>IPayStrategy strategy = PayFactory.createDefaultTubituStrategy(PayAlgorithm.WX_WEB,&#34;&#34;);
</span></span><span style="display:flex;"><span>PayBaseModel payBaseModel = new PayBaseModel(商品描述,回调接口,交易金额,商户订单编号,支付完跳转页面);
</span></span><span style="display:flex;"><span>Map&lt;String,String&gt; resultMap = strategy.excutePayOrder(payBaseModel);
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要注意的是，小程序支付和公众号内支付需要首先获取openId，所以中间需要一系列重定向和参数。
<img loading="lazy" src="2.jpg" alt=""  />
</p>
<p>由于设置<code>redirect_url</code>后,回跳指定页面的操作可能发生在：</p>
<ol>
<li>微信支付中间页调起微信收银台后超过5秒</li>
<li>用户点击“取消支付“或支付完成后点“完成”按钮。因此无法保证页面回跳时，支付流程已结束，所以商户设置的redirect_url地址不能自动执行查单操作，应让用户去点击按钮触发查单操作。</li>
</ol>
<h2 id="前端代码">前端代码<a hidden class="anchor" aria-hidden="true" href="#前端代码">#</a></h2>
<h3 id="公众号内支付">公众号内支付<a hidden class="anchor" aria-hidden="true" href="#公众号内支付">#</a></h3>
<h4 id="第一种方式">第一种方式<a hidden class="anchor" aria-hidden="true" href="#第一种方式">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">function</span> onBridgeReady(){
</span></span><span style="display:flex;"><span>   WeixinJSBridge.invoke(
</span></span><span style="display:flex;"><span>      <span style="color:#0ff;font-weight:bold">&#39;getBrandWCPayRequest&#39;</span>, {
</span></span><span style="display:flex;"><span>         <span style="color:#0ff;font-weight:bold">&#34;appId&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;wx2421b1c4370ec43b&#34;</span>,     <span style="color:#007f7f">//公众号名称，由商户传入     
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>         <span style="color:#0ff;font-weight:bold">&#34;timeStamp&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;1395712654&#34;</span>,         <span style="color:#007f7f">//时间戳，自1970年以来的秒数     
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>         <span style="color:#0ff;font-weight:bold">&#34;nonceStr&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;e61463f8efa94090b1f366cccfbbb444&#34;</span>, <span style="color:#007f7f">//随机串     
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>         <span style="color:#0ff;font-weight:bold">&#34;package&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;prepay_id=u802345jgfjsdfgsdg888&#34;</span>,     
</span></span><span style="display:flex;"><span>         <span style="color:#0ff;font-weight:bold">&#34;signType&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;MD5&#34;</span>,         <span style="color:#007f7f">//微信签名方式：     
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>         <span style="color:#0ff;font-weight:bold">&#34;paySign&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;70EA570631E4BB79628FBCA90534C63FF7FADD89&#34;</span> <span style="color:#007f7f">//微信签名 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">function</span>(res){
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">if</span>(res.err_msg == <span style="color:#0ff;font-weight:bold">&#34;get_brand_wcpay_request:ok&#34;</span> ){
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">// 使用以上方式判断前端返回,微信团队郑重提示：
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//此处可看作支付可能成功，跳转到成功页面
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">window</span>.location.replace(<span style="color:#0ff;font-weight:bold">&#34;index.html&#34;</span>);
</span></span><span style="display:flex;"><span>      } 
</span></span><span style="display:flex;"><span>   }); 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">typeof</span> WeixinJSBridge == <span style="color:#0ff;font-weight:bold">&#34;undefined&#34;</span>){
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">if</span>( <span style="color:#fff;font-weight:bold">document</span>.addEventListener ){
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">document</span>.addEventListener(<span style="color:#0ff;font-weight:bold">&#39;WeixinJSBridgeReady&#39;</span>, onBridgeReady, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>   }<span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">document</span>.attachEvent){
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">document</span>.attachEvent(<span style="color:#0ff;font-weight:bold">&#39;WeixinJSBridgeReady&#39;</span>, onBridgeReady); 
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">document</span>.attachEvent(<span style="color:#0ff;font-weight:bold">&#39;onWeixinJSBridgeReady&#39;</span>, onBridgeReady);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>   onBridgeReady();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="第二种方式">第二种方式<a hidden class="anchor" aria-hidden="true" href="#第二种方式">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>wx.config({
</span></span><span style="display:flex;"><span>    debug: <span style="color:#fff;font-weight:bold">true</span>, <span style="color:#007f7f">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    appId: <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>, <span style="color:#007f7f">// 必填，企业号的唯一标识，此处填写企业号corpid
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    timestamp: , <span style="color:#007f7f">// 必填，生成签名的时间戳
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    nonceStr: <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>, <span style="color:#007f7f">// 必填，生成签名的随机串
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    signature: <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>,<span style="color:#007f7f">// 必填，签名，见附录1
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    jsApiList: [] <span style="color:#007f7f">// 必填，需要使用的JS接口列表，所有JS接口列表见附录2
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>});
</span></span><span style="display:flex;"><span>wx.ready(<span style="color:#fff;font-weight:bold">function</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>});
</span></span><span style="display:flex;"><span>wx.chooseWXPay({
</span></span><span style="display:flex;"><span>    appId: <span style="color:#0ff;font-weight:bold">&#39;wx23841cce7185b550&#39;</span>,
</span></span><span style="display:flex;"><span>    timestamp: <span style="color:#0ff;font-weight:bold">&#39;1461300911&#39;</span>, <span style="color:#007f7f">// 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    nonceStr: <span style="color:#0ff;font-weight:bold">&#39;5719aeafb587f&#39;</span>, <span style="color:#007f7f">// 支付签名随机串，不长于 32 位
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">package</span>: <span style="color:#0ff;font-weight:bold">&#39;prepay_id=wx20160422125512b7d2205c9c0913643939&#39;</span>, <span style="color:#007f7f">// 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    signType: <span style="color:#0ff;font-weight:bold">&#39;MD5&#39;</span>, <span style="color:#007f7f">// 签名方式，默认为&#39;SHA1&#39;，使用新版支付需传入&#39;MD5&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    paySign: <span style="color:#0ff;font-weight:bold">&#39;5DAB1DDABE1AD34E8FF3386AE971B727&#39;</span>, <span style="color:#007f7f">// 支付签名
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    success: <span style="color:#fff;font-weight:bold">function</span>(res) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 支付成功后的回调函数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (res.errMsg == <span style="color:#0ff;font-weight:bold">&#34;chooseWXPay:ok&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//支付成功
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    alert(<span style="color:#0ff;font-weight:bold">&#39;支付成功&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>    alert(res.errMsg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>        },  
</span></span><span style="display:flex;"><span>    cancel: <span style="color:#fff;font-weight:bold">function</span>(res) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//支付取消
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    alert(<span style="color:#0ff;font-weight:bold">&#39;支付取消&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>        }); 
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里可以看到公众号内支付实际上有两种方式，第一种是jsapi的模式，微信浏览器内部有jsapi直接可以调用，第二种为js-sdk的方式，但是两种方式都需要引入微信的js。
http：//res.wx.qq.com/js/jwexin-1.2.0.js</p>
<p>第二种方式可以看到多了一个signature的签名参数，大概提一下如何获取：</p>
<ol>
<li>获取AccessToken</li>
<li>获取jsapi_ticket</li>
<li>生成signature</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//获取微信token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String getAccessToken(){
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//获取token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String tokenParam = <span style="color:#0ff;font-weight:bold">&#34;grant_type=client_credential&amp;appid=&#34;</span> + WxPayConfig.<span style="color:#007f7f">APPID</span> + <span style="color:#0ff;font-weight:bold">&#34;&amp;secret=&#34;</span>
</span></span><span style="display:flex;"><span>            + WxPayConfig.<span style="color:#007f7f">APPSECRET</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//这一步的发送请求工具类请自己实现
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String tokenJsonStr = HttpUtil.<span style="color:#007f7f">sendGET</span>(<span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/cgi-bin/token&#34;</span>, tokenParam);
</span></span><span style="display:flex;"><span>    Map&lt;String,String&gt; tokenMap = JSONObject.<span style="color:#007f7f">fromObject</span>(tokenJsonStr);
</span></span><span style="display:flex;"><span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(tokenMap);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 获取access_token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String access_token = (String) tokenMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;access_token&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> access_token;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//获取jsapi_ticket
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String getJsApiTicket(String accessToken){
</span></span><span style="display:flex;"><span>    String ticketParam = <span style="color:#0ff;font-weight:bold">&#34;access_token=&#34;</span> + accessToken + <span style="color:#0ff;font-weight:bold">&#34;&amp;type=jsapi&#34;</span>;
</span></span><span style="display:flex;"><span>    String ticketJsonStr = HttpUtil.<span style="color:#007f7f">sendGET</span>(<span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/cgi-bin/ticket/getticket&#34;</span>, ticketParam);
</span></span><span style="display:flex;"><span>    Map&lt;String,String&gt; ticketMap = JSONObject.<span style="color:#007f7f">fromObject</span>(ticketJsonStr);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 获取jsapi_ticket
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String ticket = (String) ticketMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;ticket&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> ticket;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//生成signature
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>String url = PayConstant.<span style="color:#007f7f">PAY_DOMAIN</span>;<span style="color:#007f7f">//微信授权的网址 这个要看微信公众号设置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>String signValue = <span style="color:#0ff;font-weight:bold">&#34;jsapi_ticket=&#34;</span> + ticket + <span style="color:#0ff;font-weight:bold">&#34;&amp;noncestr=&#34;</span> + noncestr + <span style="color:#0ff;font-weight:bold">&#34;×tamp=&#34;</span> + timestamp
</span></span><span style="display:flex;"><span>            + <span style="color:#0ff;font-weight:bold">&#34;&amp;url=&#34;</span> + url;
</span></span><span style="display:flex;"><span>String signature = Sha1Util.<span style="color:#007f7f">getSha1</span>((signValue))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String getSha1(String str) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (str == <span style="color:#fff;font-weight:bold">null</span> || str.<span style="color:#007f7f">length</span>() == <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>	    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">char</span> hexDigits[] = {<span style="color:#0ff;font-weight:bold">&#39;0&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;2&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;3&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;4&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;5&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;6&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;7&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;8&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;9&#39;</span>,<span style="color:#0ff;font-weight:bold">&#39;a&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;b&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;c&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;d&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;e&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;f&#39;</span>};
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>		MessageDigest mdTemp = MessageDigest.<span style="color:#007f7f">getInstance</span>(<span style="color:#0ff;font-weight:bold">&#34;SHA1&#34;</span>);
</span></span><span style="display:flex;"><span>		mdTemp.<span style="color:#007f7f">update</span>(str.<span style="color:#007f7f">getBytes</span>(<span style="color:#0ff;font-weight:bold">&#34;GBK&#34;</span>));
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">byte</span>[] md = mdTemp.<span style="color:#007f7f">digest</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">int</span> j = md.<span style="color:#007f7f">length</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">char</span> buf[] = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">char</span>[j * <span style="color:#ff0;font-weight:bold">2</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">int</span> k = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; j; i++) {
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">byte</span> byte0 = md[i];
</span></span><span style="display:flex;"><span>			buf[k++] = hexDigits[byte0 &gt;&gt;&gt; <span style="color:#ff0;font-weight:bold">4</span> &amp; <span style="color:#ff0;font-weight:bold">0xf</span>];
</span></span><span style="display:flex;"><span>			buf[k++] = hexDigits[byte0 &amp; <span style="color:#ff0;font-weight:bold">0xf</span>];
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> String(buf);
</span></span><span style="display:flex;"><span>	} <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="回调函数">回调函数<a hidden class="anchor" aria-hidden="true" href="#回调函数">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//处理微信回调请求
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Map&lt;String, String&gt; resolveWXPayResponse(HttpServletRequest request, String appkey) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;***************************************处理微信回调request域********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>    ByteArrayOutputStream outSteam = <span style="color:#fff;font-weight:bold">new</span> ByteArrayOutputStream();
</span></span><span style="display:flex;"><span>    InputStream inStream = request.<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">byte</span>[] buffer = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[<span style="color:#ff0;font-weight:bold">1024</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> len = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">while</span> ((len = inStream.<span style="color:#007f7f">read</span>(buffer)) != -<span style="color:#ff0;font-weight:bold">1</span>) {
</span></span><span style="display:flex;"><span>        outSteam.<span style="color:#007f7f">write</span>(buffer, <span style="color:#ff0;font-weight:bold">0</span>, len);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    outSteam.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    inStream.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    String result = <span style="color:#fff;font-weight:bold">new</span> String(outSteam.<span style="color:#007f7f">toByteArray</span>(), PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>);
</span></span><span style="display:flex;"><span>    LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;***************************************微信返回结果&#34;</span> + result + <span style="color:#0ff;font-weight:bold">&#34;********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>    Map&lt;String, String&gt; resultMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!StringUtils.<span style="color:#007f7f">isEmpty</span>(result)) {
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; map = WXPayUtil.<span style="color:#007f7f">xmlToMap</span>(result);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//验签
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (WXPayUtil.<span style="color:#007f7f">isSignatureValid</span>(map, appkey, WXPayConstants.<span style="color:#007f7f">SignType</span>.<span style="color:#007f7f">MD5</span>)) {
</span></span><span style="display:flex;"><span>            String attach = map.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;attach&#34;</span>);
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;***************************************微信自定义参数&#34;</span> + attach + <span style="color:#0ff;font-weight:bold">&#34;********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;***************************************商户订单号    ：&#34;</span> + map.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>) + <span style="color:#0ff;font-weight:bold">&#34;********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            resultMap = map;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_code&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;FAIL&#34;</span>);
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_msg&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;验签失败&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> resultMap;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//处理支付宝回调请求
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Map&lt;String, String&gt; resolveAliPayResponse(HttpServletRequest request) <span style="color:#fff;font-weight:bold">throws</span> UnsupportedEncodingException, AlipayApiException {
</span></span><span style="display:flex;"><span>    Map&lt;String, String&gt; result = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>    LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;***************************************处理支付宝回调request域********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//1.从支付宝回调的request域中取值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Map&lt;String, String[]&gt; requestParams = request.<span style="color:#007f7f">getParameterMap</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (Iterator&lt;String&gt; iter = requestParams.<span style="color:#007f7f">keySet</span>().<span style="color:#007f7f">iterator</span>(); iter.<span style="color:#007f7f">hasNext</span>(); ) {
</span></span><span style="display:flex;"><span>        String name = iter.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>        String[] values = requestParams.<span style="color:#007f7f">get</span>(name);
</span></span><span style="display:flex;"><span>        String valueStr = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; values.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>            valueStr = (i == values.<span style="color:#007f7f">length</span> - <span style="color:#ff0;font-weight:bold">1</span>) ? valueStr + values[i] : valueStr + values[i] + <span style="color:#0ff;font-weight:bold">&#34;,&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        result.<span style="color:#007f7f">put</span>(name, valueStr);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//2.签名验证(对支付宝返回的数据验证，确定是支付宝返回的)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">boolean</span> signVerified;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//2.1调用SDK验证签名
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    signVerified = AlipaySignature.<span style="color:#007f7f">rsaCheckV1</span>(result, PayConstant.<span style="color:#007f7f">ALI_PUBLIC_KEY</span>, PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>, PayConstant.<span style="color:#007f7f">ALI_DEFAULT_SIGNTYPE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (signVerified) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于设置<code>redirect_url</code>后，回跳指定页面的操作可能发生在：</p>
<ol>
<li>微信支付中间页调起微信收银台后超过5秒</li>
<li>用户点击“取消支付“或支付完成后点“完成”按钮。因此无法保证页面回跳时，支付流程已结束，所以
商户设置的redirect_url地址不能自动执行查单操作，应让用户去点击按钮触发查单操作</li>
</ol>
<h1 id="支付系统的心脏状态机">支付系统的心脏：状态机<a hidden class="anchor" aria-hidden="true" href="#支付系统的心脏状态机">#</a></h1>
<p>参考：https://juejin.cn/post/7321569896453521419</p>
<p>状态机，也称为有限状态机（FSM, Finite State Machine），是一种行为模型，由一组定义良好的状态、状态之间的转换规则和一个初始状态组成。它根据当前的状态和输入的事件，从一个状态转移到另一个状态。</p>
<h2 id="状态机设计基本原则">状态机设计基本原则：<a hidden class="anchor" aria-hidden="true" href="#状态机设计基本原则">#</a></h2>
<p>无论是设计支付类的系统，还是电商类的系统，在设计状态机时，都建议遵循以下原则：
<strong>明确性：</strong> 状态和转换必须清晰定义，避免含糊不清的状态。
<strong>完备性：</strong> 为所有可能的事件-状态组合定义转换逻辑。
<strong>可预测性：</strong> 系统应根据当前状态和给定事件可预测地响应。
<strong>最小化：</strong> 状态数应保持最小，避免不必要的复杂性。</p>
<h2 id="状态机常见设计误区">状态机常见设计误区<a hidden class="anchor" aria-hidden="true" href="#状态机常见设计误区">#</a></h2>
<p>工作多年，见过很多设计得不好的状态机，导致运维特别麻烦，还容易出故障，总结出来一共有这么几条：</p>
<p><strong>过度设计：</strong> 引入不必要的状态和复杂性，使系统难以理解和维护。
<strong>不完备的处理：</strong> 未能处理所有可能的状态转换，导致系统行为不确定。
<strong>硬编码逻辑：</strong> 过多的硬编码转换逻辑，使系统不具备灵活性和可扩展性。</p>
<h2 id="状态机设计的最佳实践">状态机设计的最佳实践<a hidden class="anchor" aria-hidden="true" href="#状态机设计的最佳实践">#</a></h2>
<p>在代码实现层面，需要做到以下几点：</p>
<p><strong>分离状态和处理逻辑</strong>：使用状态模式，将每个状态的行为封装在各自的类中。
<strong>使用事件驱动模型</strong>：通过事件来触发状态转换，而不是直接调用状态方法。
<strong>确保可追踪性</strong>：状态转换应该能被记录和追踪，以便于故障排查和审计。</p>
<h2 id="常见代码实现误区">常见代码实现误区<a hidden class="anchor" aria-hidden="true" href="#常见代码实现误区">#</a></h2>
<p>经常看到工作几年的同学实现状态机时，仍然使用if else或switch case来写。这是不对的，会让实现变得复杂，且容易出现问题。</p>
<p>甚至直接在订单的领域模型里面使用String来定义，而不是把状态模式封装单独的类。
还有就是直接调用领域模型更新状态，而不是通过事件来驱动。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 错误的代码示例1：
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">if</span> (status.<span style="color:#007f7f">equals</span>(<span style="color:#0ff;font-weight:bold">&#34;PAYING&#34;</span>) {
</span></span><span style="display:flex;"><span>    status = <span style="color:#0ff;font-weight:bold">&#34;SUCCESS&#34;</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//    ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 错误的代码示例2：
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> notify(PaymentNotifyMessage message) {
</span></span><span style="display:flex;"><span>    PaymentModel paymentModel = loadPaymentModel(message.<span style="color:#007f7f">getPaymentId</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 直接设置状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    paymentModel.<span style="color:#007f7f">setStatus</span>(PaymentStatus.<span style="color:#007f7f">valueOf</span>(message.<span style="color:#007f7f">status</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 其它业务处理
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#007f7f">// 错误的代码示例3：
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transition(Event event) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">switch</span> (currentState) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">case</span> INIT:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (event == Event.<span style="color:#007f7f">PAYING</span>) {
</span></span><span style="display:flex;"><span>                currentState = State.<span style="color:#007f7f">PAYING</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (event == Event.<span style="color:#007f7f">SUCESS</span>) {
</span></span><span style="display:flex;"><span>                currentState = State.<span style="color:#007f7f">SUCESS</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (event == Event.<span style="color:#007f7f">FAIL</span>) {
</span></span><span style="display:flex;"><span>                currentState = State.<span style="color:#007f7f">FAIL</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="代码实现">代码实现<a hidden class="anchor" aria-hidden="true" href="#代码实现">#</a></h2>
<p>定义状态基类</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 状态基类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> BaseStatus {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义事件基类</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 事件基类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> BaseEvent {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义“状态-事件对”，<strong>指定的状态只能接受指定的事件</strong></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 状态事件对，指定的状态只能接受指定的事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> StatusEventPair&lt;S <span style="color:#fff;font-weight:bold">extends</span> BaseStatus, E <span style="color:#fff;font-weight:bold">extends</span> BaseEvent&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 指定的状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> S status;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 可接受的事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> E event;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> StatusEventPair(S status, E event) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">status</span> = status;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">event</span> = event;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> equals(Object obj) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (obj <span style="color:#fff;font-weight:bold">instanceof</span> StatusEventPair) {
</span></span><span style="display:flex;"><span>            StatusEventPair&lt;S, E&gt; other = (StatusEventPair&lt;S, E&gt;)obj;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">status</span>.<span style="color:#007f7f">equals</span>(other.<span style="color:#007f7f">status</span>) &amp;&amp; <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">event</span>.<span style="color:#007f7f">equals</span>(other.<span style="color:#007f7f">event</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">int</span> hashCode() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 这里使用的是google的guava包。com.google.common.base.Objects
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> Objects.<span style="color:#007f7f">hashCode</span>(status, event);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义状态机</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 状态机
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> StateMachine&lt;S <span style="color:#fff;font-weight:bold">extends</span> BaseStatus, E <span style="color:#fff;font-weight:bold">extends</span> BaseEvent&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;StatusEventPair&lt;S, E&gt;, S&gt; statusEventMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 只接受指定的当前状态下，指定的事件触发，可以到达的指定目标状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> accept(S sourceStatus, E event, S targetStatus) {
</span></span><span style="display:flex;"><span>        statusEventMap.<span style="color:#007f7f">put</span>(<span style="color:#fff;font-weight:bold">new</span> StatusEventPair&lt;&gt;(sourceStatus, event), targetStatus);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 通过源状态和事件，获取目标状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> S getTargetStatus(S sourceStatus, E event) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> statusEventMap.<span style="color:#007f7f">get</span>(<span style="color:#fff;font-weight:bold">new</span> StatusEventPair&lt;&gt;(sourceStatus, event));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义支付的状态机。注：<strong>支付、退款等不同的业务状态机是独立的</strong>。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 支付状态机
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">enum</span> PaymentStatus <span style="color:#fff;font-weight:bold">implements</span> BaseStatus {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    INIT(<span style="color:#0ff;font-weight:bold">&#34;INIT&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;初始化&#34;</span>),
</span></span><span style="display:flex;"><span>    PAYING(<span style="color:#0ff;font-weight:bold">&#34;PAYING&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;支付中&#34;</span>),
</span></span><span style="display:flex;"><span>    PAID(<span style="color:#0ff;font-weight:bold">&#34;PAID&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;支付成功&#34;</span>),
</span></span><span style="display:flex;"><span>    FAILED(<span style="color:#0ff;font-weight:bold">&#34;FAILED&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;支付失败&#34;</span>),
</span></span><span style="display:flex;"><span>    ;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 支付状态机内容
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> StateMachine&lt;PaymentStatus, PaymentEvent&gt; STATE_MACHINE = <span style="color:#fff;font-weight:bold">new</span> StateMachine&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 初始状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        STATE_MACHINE.<span style="color:#007f7f">accept</span>(<span style="color:#fff;font-weight:bold">null</span>, PaymentEvent.<span style="color:#007f7f">PAY_CREATE</span>, INIT);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 支付中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        STATE_MACHINE.<span style="color:#007f7f">accept</span>(INIT, PaymentEvent.<span style="color:#007f7f">PAY_PROCESS</span>, PAYING);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 支付成功
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        STATE_MACHINE.<span style="color:#007f7f">accept</span>(PAYING, PaymentEvent.<span style="color:#007f7f">PAY_SUCCESS</span>, PAID);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 支付失败
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        STATE_MACHINE.<span style="color:#007f7f">accept</span>(PAYING, PaymentEvent.<span style="color:#007f7f">PAY_FAIL</span>, FAILED);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String status;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 描述
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String description;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PaymentStatus(String status, String description) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">status</span> = status;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">description</span> = description;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 通过源状态和事件类型获取目标状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> PaymentStatus getTargetStatus(PaymentStatus sourceStatus, PaymentEvent event) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> STATE_MACHINE.<span style="color:#007f7f">getTargetStatus</span>(sourceStatus, event);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义支付事件。注：<strong>支付、退款等不同业务的事件是不一样的</strong>。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 支付事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">enum</span> PaymentEvent <span style="color:#fff;font-weight:bold">implements</span> BaseEvent {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 支付创建
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    PAY_CREATE(<span style="color:#0ff;font-weight:bold">&#34;PAY_CREATE&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;支付创建&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 支付中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    PAY_PROCESS(<span style="color:#0ff;font-weight:bold">&#34;PAY_PROCESS&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;支付中&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 支付成功
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    PAY_SUCCESS(<span style="color:#0ff;font-weight:bold">&#34;PAY_SUCCESS&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;支付成功&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 支付失败
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    PAY_FAIL(<span style="color:#0ff;font-weight:bold">&#34;PAY_FAIL&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;支付失败&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String event;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 事件描述
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String description;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PaymentEvent(String event, String description) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">event</span> = event;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">description</span> = description;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在支付单模型中声明状态和根据事件推进状态的方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 支付单模型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PaymentModel {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 其它所有字段省略
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 上次状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> PaymentStatus lastStatus;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 当前状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> PaymentStatus currentStatus;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 根据事件推进状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transferStatusByEvent(PaymentEvent event) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 根据当前状态和事件，去获取目标状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        PaymentStatus targetStatus = PaymentStatus.<span style="color:#007f7f">getTargetStatus</span>(currentStatus, event);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 如果目标状态不为空，说明是可以推进的
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (targetStatus != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            lastStatus = currentStatus;
</span></span><span style="display:flex;"><span>            currentStatus = targetStatus;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 目标状态为空，说明是非法推进，进入异常处理，这里只是抛出去，由调用者去具体处理
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> StateMachineException(currentStatus, event, <span style="color:#0ff;font-weight:bold">&#34;状态转换失败&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码注释已经写得很清楚，其中StateMachineException是自定义，不想定义的话，直接使用RuntimeException也是可以的。</p>
<p>在支付业务代码中的使用：<strong>只需要paymentModel.transferStatusByEvent(PaymentEvent.valueOf(message.getEvent()))</strong></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 支付领域域服务
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PaymentDomainServiceImpl <span style="color:#fff;font-weight:bold">implements</span> PaymentDomainService {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 支付结果通知
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> notify(PaymentNotifyMessage message) {
</span></span><span style="display:flex;"><span>        PaymentModel paymentModel = loadPaymentModel(message.<span style="color:#007f7f">getPaymentId</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 状态推进
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paymentModel.<span style="color:#007f7f">transferStatusByEvent</span>(PaymentEvent.<span style="color:#007f7f">valueOf</span>(message.<span style="color:#007f7f">getEvent</span>()));
</span></span><span style="display:flex;"><span>            savePaymentModel(paymentModel);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 其它业务处理
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ... ...
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (StateMachineException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 异常处理
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ... ...
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 异常处理
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ... ...
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的代码只需要加完善异常处理，优化一下注释，就可以直接用起来。</p>
<p>好处：</p>
<ol>
<li>定义了明确的状态、事件。</li>
<li>状态机的推进，<strong>只能通过“当前状态、事件、目标状态”来推进</strong>，不能通过if else 或case switch来直接写。比如：STATE_MACHINE.accept(INIT, PaymentEvent.PAY_PROCESS, PAYING);</li>
<li>避免终态变更。比如线上碰到if else写状态机，渠道异步通知比同步返回还快，异步通知回来把订单更新为“PAIED”，然后同步返回的代码把单据重新推进到PAYING。</li>
</ol>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/other/">other</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>