<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>pay | Wjy&#39;s Blog</title>
<meta name="keywords" content="other">
<meta name="description" content="æ”¯ä»˜å®æ”¯ä»˜å®˜ç½‘ï¼š
https://docs.open.alipay.com/catalog
å¾®ä¿¡æ”¯ä»˜å®˜ç½‘ï¼š
V2ï¼šhttps://pay.weixin.qq.com/wiki/doc/api/index.html
V3ï¼šhttps://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/pay/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="pay" />
<meta property="og:description" content="æ”¯ä»˜å®æ”¯ä»˜å®˜ç½‘ï¼š
https://docs.open.alipay.com/catalog
å¾®ä¿¡æ”¯ä»˜å®˜ç½‘ï¼š
V2ï¼šhttps://pay.weixin.qq.com/wiki/doc/api/index.html
V3ï¼šhttps://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/pay/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-11-24T13:50:44+00:00" />
<meta property="article:modified_time" content="2019-11-24T13:50:44+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="pay"/>
<meta name="twitter:description" content="æ”¯ä»˜å®æ”¯ä»˜å®˜ç½‘ï¼š
https://docs.open.alipay.com/catalog
å¾®ä¿¡æ”¯ä»˜å®˜ç½‘ï¼š
V2ï¼šhttps://pay.weixin.qq.com/wiki/doc/api/index.html
V3ï¼šhttps://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "pay",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/pay/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "pay",
  "name": "pay",
  "description": "æ”¯ä»˜å®æ”¯ä»˜å®˜ç½‘ï¼š https://docs.open.alipay.com/catalog å¾®ä¿¡æ”¯ä»˜å®˜ç½‘ï¼š V2ï¼šhttps://pay.weixin.qq.com/wiki/doc/api/index.html V3ï¼šhttps://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml\n",
  "keywords": [
    "other"
  ],
  "articleBody": "æ”¯ä»˜å®æ”¯ä»˜å®˜ç½‘ï¼š https://docs.open.alipay.com/catalog å¾®ä¿¡æ”¯ä»˜å®˜ç½‘ï¼š V2ï¼šhttps://pay.weixin.qq.com/wiki/doc/api/index.html V3ï¼šhttps://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml\nå¾®ä¿¡æ”¯ä»˜ å¾®ä¿¡JSAPIæ”¯ä»˜ å®˜æ–¹æ–‡æ¡£ å¾®ä¿¡ç½‘é¡µæ”¯ä»˜æ—¶åºå›¾ï¼š å‡†å¤‡å·¥ä½œ å¾®ä¿¡å…¬ä¼—å¹³å°å·²è®¤è¯çš„æœåŠ¡å·ï¼Œå¹¶ä¸”éœ€è¦å¼€é€šå¾®ä¿¡æ”¯ä»˜è¯¥èƒ½ã€‚ç™»å½•é¡µhttps://mp.weixin.qq.com/ å¾®ä¿¡å•†æˆ·å¹³å°è´¦å·ã€‚https://pay.weixin.qq.com ä¸€ä¸ªæ­£å¼çš„åº”ç”¨æœåŠ¡å™¨ï¼Œå¹¶ä¸”æ³¨å†ŒåŸŸåã€‚ å¾®ä¿¡æ”¯ä»˜æ¶‰åŠçš„ç§å¯†æ•°æ®æ¯”è¾ƒå¤šï¼Œä¸å…è®¸ä½¿ç”¨natappï¼ŒèŠ±ç”Ÿå£³ä¹‹ç±»çš„å†…ç½‘ç©¿é€å·¥å…·å®ç°ï¼Œéœ€è¦æœ‰æ­£å¼çš„æœåŠ¡å™¨ç¯å¢ƒï¼Œå¹¶ä¸”è¦æ³¨å†ŒåŸŸåï¼Œä¸èƒ½ä½¿ç”¨IPã€‚æ­£ç¡®çš„åœ°å€ç¤ºä¾‹ï¼šhttp://www.wjy.com é…ç½®å‡†å¤‡ å…¬ä¼—å·é…ç½® é…ç½®ç½‘é¡µæˆæƒåŸŸåï¼Œç™»å½•å…¬ä¼—å¹³å°â€”â€”\u003eå…¬ä¼—å·è®¾ç½®â€”â€”\u003eåŠŸèƒ½è®¾ç½® é…ç½®å‰ç«¯æ ¹ç›®å½•å³å¯ï¼Œä¾‹å¦‚ï¼špre-zj.stzy.comã€‚ä¸è¦https:// è¯¥é…ç½®ä¸»è¦ç”¨äºè·å–ç”¨æˆ·çš„codeï¼Œéœ€è¦è¯†åˆ«è¿™æ˜¯å“ªä¸ªäººã€‚æ³¨ï¼šæ˜¯å‰ç«¯é¡µé¢çš„åœ°å€ã€‚ ç„¶åæŒ‰ç…§æç¤ºï¼Œå°†æ–‡ä»¶ä¸‹è½½å¹¶ä¸Šä¼ åˆ°ç½‘é¡µæˆæƒåŸŸåç›®å½•ä¸‹ï¼Œå¹¶ä¸”åœ¨æµè§ˆå™¨ï¼Œæµ‹è¯•è®¿é—®ï¼Œhttp://www.baidu.com/ä½ çš„æ–‡ä»¶å.txtçœ‹åˆ°ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œè¯æ˜æˆåŠŸã€‚(å¯ä»¥é€šè¿‡nginxè®¿é—®è¯¥æ–‡ä»¶)\né…ç½®JSæ¥å£å®‰å…¨åŸŸåï¼šè¦è®©æˆ‘ä»¬çš„é¡µé¢ä¸­å¼¹å‡ºè¾“å…¥å¯†ç çš„çª—å£ï¼Œéœ€è¦ä½¿ç”¨å¾®ä¿¡æä¾›çš„JS-SDKå·¥å…·ï¼Œå¦‚æœä¸é…ç½®JSæ¥å£å®‰å…¨åŸŸåï¼Œä½ çš„é¡µé¢æ— æ³•ä½¿ç”¨JS-SDKã€‚ é…ç½®å‰ç«¯æ ¹ç›®å½•å³å¯ï¼špre-zj.stzy.com æ³¨æ„ï¼šä¸€ä¸ªè‡ªç„¶æœˆå†…æœ€å¤šå¯ä¿®æ”¹å¹¶ä¿å­˜äº”æ¬¡ï¼Œæœ¬æœˆå‰©ä½™ä¿å­˜æ¬¡æ•°ï¼š5ã€‚æ‰€ä»¥å»ºè®®æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„åœ°å€ä¸€å—æ·»åŠ ï¼Œå…çš„å¤šæ¬¡æ·»åŠ æµªè´¹æ¬¡æ•°ã€‚\nè·å–å…¬ä¼—å·çš„ AppID å’Œ AppSecret ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°-\u003eæ‹‰åˆ°é¡µé¢æœ€ä¸‹è¾¹-\u003eåœ¨å·¦ä¾§æ‰¾åˆ°å¼€å‘ä¸€æ -\u003eç‚¹å‡»åŸºæœ¬é…ç½®-\u003eéœ€è¦ç‚¹å‡»ç¡®è®¤ç”³è¯·å¼€é€šï¼Œç„¶åå°±å¯ä»¥çœ‹åˆ°AppIDå’Œå…¶ä»–é…ç½®ä¿¡æ¯ã€‚ AppSecretéœ€è¦å‘è¯¥å…¬ä¼—å·çš„ç®¡ç†å‘˜ç”³è¯·å¼€é€šï¼Œ30åˆ†é’Ÿå†…é€šè¿‡å³å¯ï¼Œç„¶åè¾“å…¥è¯¥å…¬ä¼—å·å¯†ç ï¼Œå³å¯æŸ¥çœ‹åˆ°AppSecretï¼ŒæŒ‰ç…§é¡µé¢æç¤ºå­˜å‚¨å¥½AppSecretï¼Œå¹¶è¿›è¡Œåç»­æ“ä½œã€‚ï¼ˆæ³¨æ„å…¬ä¼—å·çš„ AppIDï¼Œæµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„åˆ‡æ¢ï¼‰\nå•†æˆ·å¹³å°é…ç½® é…ç½®æ”¯ä»˜æˆæƒç›®å½•ï¼Œç™»å½•å•†æˆ·å¹³å°-\u003eäº§å“ä¸­å¿ƒ-\u003eå¼€å‘é…ç½®-\u003eæ”¯ä»˜é…ç½®-\u003eJSAPIæ”¯ä»˜ è¿™é‡Œéœ€è¦å¡«å†™å‰ç«¯é¡µé¢çš„åœ°å€ï¼Œä¸åœ¨è¯¥è·¯å¾„çš„é¡µé¢ï¼Œåˆ™æ— æ³•è°ƒç”¨æ”¯ä»˜åŠŸèƒ½ã€‚ å¯ä»¥å¡«å†™å‰ç«¯çš„æ ¹ç›®å½•ï¼šhttp://pay.xxxx.com/ æˆ–åªå¡«å†™æ”¯ä»˜ç›®å½•ï¼šhttp://mywexx.xxxx.com/pay æ³¨æ„ç¬¬ä¸€æ¬¡æ·»åŠ æ—¶ï¼Œä¼šè®©è¾“å…¥æ“ä½œå¯†ç ï¼Œè¾“å…¥å®Œæ“ä½œå¯†ç ï¼Œéœ€è¦å†æ·»åŠ ä¸€æ¬¡æ‰èƒ½æ·»åŠ æˆåŠŸã€‚\nè®¾ç½®APIå¯†é’¥ï¼Œç™»å½•å•†æˆ·å¹³å°â€”â€”\u003eè´¦æˆ·ä¸­å¿ƒâ€”â€”\u003eAPIå®‰å…¨â€”â€”\u003eå¾€ä¸‹æ‹‰æ‰¾åˆ° APIå¯†é’¥ ç°åœ¨æœ‰ä¸¤ä¸ªå¯†é’¥éœ€è¦è®¾ç½®ï¼ŒV2å’ŒV3çš„å¯†é’¥ï¼Œåˆ†åˆ«å¯¹åº”V2å’ŒV3ä¸¤ç§æ”¯ä»˜æ–¹å¼ã€‚\nå°†å…¬ä¼—å·å’Œå•†æˆ·å¹³å°å…³è” å…¬ä¼—å·å¼€é€šå¾®ä¿¡æ”¯ä»˜ï¼Œæ˜¯åœ¨å¾®ä¿¡å•†æˆ·å¹³å°å®Œæˆçš„ï¼Œç»‘å®šå®Œæˆåï¼Œå¯ä»¥åœ¨å…¬ä¼—å·çœ‹åˆ°ç»‘å®šçš„å•†æˆ·å·ã€‚å®˜æ–¹ç»‘å®šæ•™ç¨‹ å¯ä»¥å…ˆæ‰¾å•†æˆ·å¹³å°æ‰€æœ‰è€…(è¶…çº§ç®¡ç†å‘˜)ï¼ŒæŠŠè‡ªå·±çš„å¾®ä¿¡ç»‘å®šä¸ºç®¡ç†å‘˜ï¼šé¡¶éƒ¨ç‚¹å‡»è´¦å·ä¸­å¿ƒ-\u003eå·¦ä¾§æ‰¾åˆ°å‘˜å·¥è´¦å·ç®¡ç†-\u003eå³ä¾§æ‰¾åˆ°ç®¡ç†å‘˜ï¼Œç‚¹å‡»æ–°å¢è´¦å·-\u003eç„¶åå¯èƒ½éœ€è¦å®‰è£…å®‰å…¨æ§ä»¶ã€‚ å®‰è£…æ§ä»¶ä¹‹åï¼Œå¯èƒ½éœ€è¦é‡å¯æµè§ˆå™¨ï¼Œæ‰èƒ½æ£€æµ‹åˆ°å®‰å…¨æ§ä»¶ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç™»å½•ï¼Œç„¶åå‘é€éªŒè¯ï¼Œå°±æˆåŠŸåœ¨æœ¬æœºä¸Šå®‰è£…å®‰å…¨æ§ä»¶äº†ã€‚å®‰è£…å¥½æ§ä»¶ä¹‹åï¼Œå°±å¯ä»¥å°†è‡ªå·±çš„å¾®ä¿¡å·ç»‘å®šä¸ºç®¡ç†å‘˜äº†ã€‚ æ³¨æ„æäº¤çš„æ—¶å€™ï¼Œéœ€è¦è¾“å…¥æ“ä½œå¯†ç ï¼Œè¯¥å¯†ç ä¸æ˜¯å•†æˆ·å¹³å°çš„ç™»å½•å¯†ç ï¼Œæ˜¯æ“ä½œå¯†ç ã€‚ æ ¹æ®ç»‘å®šæ•™ç¨‹ï¼Œè¾“å…¥å…¬ä¼—å·çš„appIDåï¼Œå¯ä»¥åœ¨ç»‘å®šçš„å…¬ä¼—å·-\u003eå•†æˆ·å·ç®¡ç†ï¼Œçœ‹åˆ°å¾…å…³è”å•†æˆ·å·ï¼Œå¯ä»¥ç¡®è®¤ä»¥åŠåç»­æ­¥éª¤ï¼Œå³å¯æˆåŠŸå…³è”ã€‚\næ­¤å¤„æ˜¯è´¦å·æ¨¡æ¿,è¯·å‚è€ƒï¼š\n1 2 3 4 5 6 å¾®ä¿¡å…¬ä¼—å¹³å°ï¼šè´¦æˆ·ï¼šcon*******om ç™»å½•å¯†ç  ****** å…¬ä¼—APPIDï¼šwx15*********a8 APPSECEPT : c210***************892d7 å¾®ä¿¡å•†æˆ·å¹³å°ï¼šè´¦æˆ·ï¼š149**********6742 ç™»å½•å¯†ç ï¼š****** å•†æˆ·IDï¼š14******42 APIå¯†é’¥ï¼š5d5************b35b è‡³æ­¤ï¼Œéœ€è¦çš„å››å¤§å‚æ•°éƒ½æ‰¾åˆ°äº†ã€‚å¯ä»¥é€šè¿‡å®˜ç½‘çš„å·¥å…·æµ‹è¯•æˆ‘ä»¬çš„é…ç½®æ˜¯å¦æœ‰é—®é¢˜ï¼š https://mp.weixin.qq.com/debug\nå¦‚æœè¿”å›Request successfulï¼Œä»¥åŠaccess_tokenå’Œexpires_inï¼Œè¯´æ˜é…ç½®æ²¡é—®é¢˜ã€‚\næˆ‘ä»¬ç›´æ¥æŠŠå¾®ä¿¡å®˜æ–¹æä¾›çš„ä¸€å †utilï¼Œæ”¾åˆ°é¡¹ç›®ä¸­ã€‚\nè·å–ç”¨æˆ·codeï¼ˆå‰ç«¯è·å–codeï¼Œæ¨èï¼‰ åœ¨ç¡®ä¿å¾®ä¿¡å…¬ä¼—è´¦å·æ‹¥æœ‰æˆæƒä½œç”¨åŸŸï¼ˆscopeå‚æ•°ï¼‰çš„æƒé™çš„å‰æä¸‹ï¼ˆæœåŠ¡å·è·å¾—é«˜çº§æ¥å£åï¼Œé»˜è®¤æ‹¥æœ‰scopeå‚æ•°ä¸­çš„snsapi_baseå’Œsnsapi_userinfoï¼‰ï¼Œè®©å‰ç«¯è¯·æ±‚å¦‚ä¸‹urlï¼š\n1 2 3 4 5 6 https://open.weixin.qq.com/connect/oauth2/authorize ?appid=APPID \u0026redirect_uri=REDIRECT_URI \u0026response_type=code \u0026scope=SCOPE \u0026state=STATE#wechat_redirect å‚æ•°è§£æï¼š appidï¼šå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†ã€‚ redirect_uriï¼šæˆæƒåé‡å®šå‘çš„å›è°ƒé“¾æ¥åœ°å€ã€‚å¾®ä¿¡ä¼šé‡å®šå‘åˆ°è¿™ä¸ªé¡µé¢ï¼Œå¹¶å¸¦ä¸Šcodeå‚æ•°ã€‚ æ³¨æ„ï¼šéœ€è¦å¯¹é“¾æ¥è¿›è¡ŒurlEncodeå¤„ç†ã€‚æ³¨æ„è¿™ä¸ªå›è°ƒåœ°å€åªèƒ½æ˜¯åŸŸåï¼Œä¸èƒ½å¸¦ç«¯å£å·ã€‚ response_typeï¼šè¿”å›ç±»å‹ï¼Œè¯·å¡«å†™codeï¼Œå†™æ­»ã€‚ scopeï¼šåº”ç”¨æˆæƒä½œç”¨åŸŸã€‚ snsapi_baseï¼šä¸å¼¹å‡ºæˆæƒé¡µé¢ï¼Œç›´æ¥è·³è½¬ï¼Œåªèƒ½è·å–ç”¨æˆ·openidã€‚ snsapi_userinfoï¼šå¼¹å‡ºæˆæƒé¡µé¢ï¼Œå¯é€šè¿‡ openid æ‹¿åˆ°æ˜µç§°ã€æ€§åˆ«ã€æ‰€åœ¨åœ°ã€‚å¹¶ä¸”ï¼Œå³ä½¿åœ¨æœªå…³æ³¨çš„æƒ…å†µä¸‹ï¼Œåªè¦ç”¨æˆ·æˆæƒï¼Œä¹Ÿèƒ½è·å–å…¶ä¿¡æ¯ã€‚\nstateï¼šé‡å®šå‘åä¼šå¸¦ä¸Šstateå‚æ•°ï¼Œå¼€å‘è€…å¯ä»¥å¡«å†™a-zA-Z0-9çš„å‚æ•°å€¼ï¼Œæœ€å¤š128å­—èŠ‚ã€‚ #wechat_redirectï¼šæ— è®ºç›´æ¥æ‰“å¼€è¿˜æ˜¯åšé¡µé¢302é‡å®šå‘æ—¶å€™ï¼Œå¿…é¡»å¸¦æ­¤å‚æ•°ã€‚\nè‹¥æç¤ºè¯¥é“¾æ¥æ— æ³•è®¿é—®ï¼Œè¯·æ£€æŸ¥å‚æ•°æ˜¯å¦å¡«å†™é”™è¯¯ï¼Œæ˜¯å¦æ‹¥æœ‰scopeå‚æ•°å¯¹åº”çš„æˆæƒä½œç”¨åŸŸæƒé™ã€‚å°¤å…¶æ³¨æ„ï¼Œç”±äºæˆæƒæ“ä½œå®‰å…¨ç­‰çº§è¾ƒé«˜ï¼Œæ‰€ä»¥åœ¨å‘èµ·æˆæƒè¯·æ±‚æ—¶ï¼Œå¾®ä¿¡ä¼šå¯¹æˆæƒé“¾æ¥åšæ­£åˆ™å¼ºåŒ¹é…æ ¡éªŒï¼Œå¦‚æœé“¾æ¥çš„å‚æ•°é¡ºåºä¸å¯¹ï¼Œæˆæƒé¡µé¢å°†æ— æ³•æ­£å¸¸è®¿é—®ã€‚\nè¿™ä¸€æ­¥å°±æ˜¯è·å–ç”¨æˆ·çš„codeã€‚æ•´ä½“æµç¨‹æ˜¯ï¼š\nå‰ç«¯è¯·æ±‚æˆæƒurl å¾®ä¿¡é‡å®šå‘åˆ°æˆ‘ä»¬æŒ‡å®šçš„redirect_uriï¼Œå³æˆ‘ä»¬è‡ªå·±çš„é¡µé¢ï¼Œå¹¶å¸¦ä¸Šcodeå‚æ•°ï¼Œredirect_uri/?code=CODE\u0026state=STATEã€‚ ç°åœ¨å‰ç«¯å°±å¯ä»¥è·å–åˆ°é“¾æ¥ä¸Šçš„codeï¼Œç„¶åä¼ é€’ç»™åç«¯ã€‚ åç«¯é€šè¿‡codeè·å–openidï¼Œç„¶åè¯·æ±‚å¾®ä¿¡é¢„æ”¯ä»˜æ¥å£ã€‚ codeè¯´æ˜ï¼šcode æ˜¯æ¢å–openidçš„ç¥¨æ®ï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œ5åˆ†é’Ÿæœªè¢«ä½¿ç”¨è‡ªåŠ¨è¿‡æœŸã€‚\nåç«¯è·å–codeï¼ˆä¸æ¨èï¼Œæ¯”è¾ƒéº»çƒ¦ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /** * è·å–code */ @GetMapping(\"getWxCode\") public ModelAndView getWxCode() { LOGGER.debug(\"è·å–codeå¼€å§‹\"); ModelAndView mv = new ModelAndView(); String rediretUrl = PayUtil.getProjectUrl(this.request) + \"zjx/api/pay/perPay\"; try { String url = \"https://open.weixin.qq.com/connect/oauth2/authorize?\" + \"appid=\" + PayConstant.WX_H5_APPID + \"\u0026redirect_uri=\" + URLEncoder.encode(rediretUrl, PayConstant.DEFAULT_CHARSET) + \"\u0026response_type=code\u0026scope=snsapi_base\u0026state=123#wechat_redirect\"; //è¿™é‡Œå¿…é¡»æ˜¯é‡å®šå‘ mv.setViewName(\"redirect:\" + url); } catch (UnsupportedEncodingException e) { e.printStackTrace(); } return mv; } æµç¨‹ï¼š\nå‰ç«¯è¯·æ±‚ä¸Šè¾¹çš„æ¥å£ï¼Œä¸ç”¨å¸¦å‚æ•°ã€‚ åç«¯è¯·æ±‚å¾®ä¿¡ï¼Œå¸¦å‚æ•°ï¼Œredirect_uriéœ€è¦æŒ‡å®šä¸ºåå°çš„æ¥å£åœ°å€ã€‚ å¾®ä¿¡é‡å®šå‘åˆ°æˆ‘ä»¬æŒ‡å®šçš„redirect_uriï¼Œä¼šå¸¦ä¸Šcodeå‚æ•°ã€‚ ç¼–å†™redirect_uriæŒ‡å®šçš„åå°æ¥å£ï¼Œåœ¨æ¥å£ä¸Šç”¨@requestParamè·å–codeå‚æ•°ï¼Œç„¶åé€šè¿‡codeæ¢å–access_tokenå’Œopenidã€‚ ç„¶åæˆ–è€…æŠŠopenidè¿”å›ç»™å‰ç«¯ï¼Œè·å–ç›´æ¥ç”¨openidè¯·æ±‚å¾®ä¿¡çš„é¢„æ”¯ä»˜æ¥å£ã€‚ é¢„æ”¯ä»˜æ¥å£åªéœ€è¦ç”¨æˆ·çš„openidï¼Œä¸€ä¸ªç”¨æˆ·å¯¹äºä¸€ä¸ªå…¬ä¼—å·çš„openidæ˜¯ä¸ä¼šå˜çš„ï¼Œæ‰€ä»¥æ²¡å¿…è¦éè¦åœ¨è¯·æ±‚é¢„æ”¯ä»˜çš„æ—¶å€™æ‰é€šè¿‡codeæ¢å–openidï¼Œå¯ä»¥åœ¨è¿›å…¥å…¬ä¼—å·å°±è·å–æˆæƒï¼Œç„¶åè·å–openidï¼Œç„¶åè®©å‰ç«¯ç¼“å­˜åœ¨æœ¬åœ°ï¼Œæˆ–æ˜¯é€šè¿‡æ¥å£å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™æ ·åœ¨è¯·æ±‚é¢„æ”¯ä»˜æ¥å£æ—¶ï¼Œç›´æ¥ä¼ é€’å­˜å‚¨å¥½çš„openidå°±å¥½äº†ã€‚\né€šè¿‡codeè·å–openid å‰ç«¯è¯·æ±‚è¿™ä¸ªæ¥å£ï¼Œåå°ç»™å‰ç«¯è¿”å›openidï¼Œç„¶åå‰ç«¯ç¼“å­˜openidã€‚è¿™æ ·å°±ä¸ç”¨æ¯æ¬¡åˆ·æ–°é¡µé¢éƒ½éœ€è¦é‡æ–°é€šè¿‡codeè·å–openidäº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @ApiOperation(value = \"é€šè¿‡codeè·å–openid\") @RequestMapping(\"getWxOpenid\") public String getWxOpenid(@RequestParam(\"code\") String code) { // è·å–openIdåœ°å€ String getOpenidUrl = \"https://api.weixin.qq.com/sns/oauth2/access_token\"; // å‚æ•° String param = \"?appid=\" + weChatConfig.getAppId() + \"\u0026secret=\" + weChatConfig.getApSecret() + \"\u0026code=\" + code + \"\u0026grant_type=authorization_code\"; //å‘å¾®ä¿¡æœåŠ¡å™¨å‘é€getè¯·æ±‚è·å–openIdStr String openIdStr = HttpUtil.get(getOpenidUrl + param); JsonNode jsonNode = JacksonUtils.jsonToJsonNode(openIdStr); return jsonNode.get(\"openid\").asText(); } è°ƒç”¨å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 /** * å¾®ä¿¡JSAPI é¢„æ”¯ä»˜ï¼Œè¿”å›å‰ç«¯æ‹‰èµ·æ”¯ä»˜éœ€è¦çš„å‚æ•° */ @ResponseBody @GetMapping(\"perPay\") public Map perPay(@RequestParam(\"openid\") String openid) { LOGGER.info(\"openidæ˜¯ \" + openid); Map resultMap = new HashMap\u003c\u003e(); try { //ç”Ÿæˆè®¢å•ç¼–å· int number = (int)((Math.random()*9)*1000);//éšæœºæ•° DateFormat dateFormat = new SimpleDateFormat(\"yyyyMMddHHmmss\");//æ—¶é—´ String orderNo = dateFormat.format(new Date()) + number; //æ‹¼æ¥ç»Ÿä¸€ä¸‹å•åœ°å€å‚æ•° Map paraMap = new HashMap\u003c\u003e(); paraMap.put(\"appid\", PayConstant.WX_H5_APPID); paraMap.put(\"mch_id\", PayConstant.WX_H5_MCHID); paraMap.put(\"body\", \"æœ€ç¾è¯¾æœ¬æ”¯ä»˜æµ‹è¯•\"); paraMap.put(\"nonce_str\",WXPayUtil.generateNonceStr()); paraMap.put(\"openid\", openid); paraMap.put(\"out_trade_no\", orderNo); paraMap.put(\"spbill_create_ip\",HttpUtil.getIpAddr(this.request)); // ä»·æ ¼ï¼Œå•ä½åˆ† paraMap.put(\"total_fee\",\"1\"); paraMap.put(\"trade_type\", \"JSAPI\"); // æ”¯ä»˜æˆåŠŸï¼Œå¾®ä¿¡å›è°ƒæœåŠ¡å™¨çš„æ¥å£åœ°å€ï¼Œæ³¨æ„æ·»åŠ ç™½åå• paraMap.put(\"notify_url\", PayUtil.getProjectUrl(this.request) + \"zjx/api/wxNotify\"); // éœ€è¦å’Œä¸‹é¢signæ–¹æ³•ä¸€è‡´ï¼Œä¸æ˜¯è¯´å‚æ•°ä¸€è‡´ã€‚ paraMap.put(\"sign\", WXPayUtil.generateSignature(paraMap, PayConstant.WX_H5_APP_KEY)); //å°†æ‰€æœ‰å‚æ•°(map)è½¬xmlæ ¼å¼ String xml = WXPayUtil.mapToXml(paraMap); LOGGER.info(\"è¯·æ±‚å¾®ä¿¡å‚æ•°\"+xml); //å‘é€postè¯·æ±‚\"ç»Ÿä¸€ä¸‹å•æ¥å£\"è¿”å›é¢„æ”¯ä»˜idï¼šprepay_id String wxReturnStr = PayUtil.post(PayConstant.WX_UNIFIEDORDER_URL, xml, ContentTypeEnum.TextXml.getContentType()); Map wxXmlMap = WXPayUtil.xmlToMap(wxReturnStr); LOGGER.info(\"å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£è¿”å›æ•°æ®:\" + wxXmlMap); //ç»„è£…è¿”å›ç»™å‰ç«¯çš„æ•°æ® resultMap.put(\"appId\", PayConstant.WX_H5_APPID); resultMap.put(\"timeStamp\", WXPayUtil.getCurrentTimestamp()+\"\"); resultMap.put(\"nonceStr\", WXPayUtil.generateNonceStr()); resultMap.put(\"signType\", \"MD5\"); resultMap.put(\"package\", \"prepay_id=\" + wxXmlMap.get(\"prepay_id\")); //æ³¨æ„è¿™é‡Œçš„ç­¾åæ–¹æ³•éœ€è¦å’Œä¸Šè¾¹paramMapä¸­signçš„æ–¹æ³•ä¸€è‡´ï¼Œapp_keyä¹Ÿå¿…é¡»ä¸€è‡´ resultMap.put(\"paySign\", WXPayUtil.generateSignature(resultMap, PayConstant.WX_H5_APP_KEY)); LOGGER.info(\"è¿”å›ç»™å‰ç«¯çš„æ•°æ®:\" + resultMap); } catch (Exception e) { e.printStackTrace(); } return resultMap; } æ”¯ä»˜æˆåŠŸçš„å›è°ƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 @RequestMapping(\"wxBuySpaceNotify\") public void wxBuySpaceNotify() { try { Map map = PayUtil.resolveWXPayResponse(this.request, PayConstant.WX_H5_APP_KEY); LOGGER.info(\"=============å¾®ä¿¡æ”¯ä»˜å›è°ƒå‚æ•°:\" + JSONObject.toJSONString(map)); if (map.size() \u003e= 2) { //æ‰§è¡Œå›è°ƒé€»è¾‘ map = payService.buySpaceCallback(map); //å†…éƒ¨é€»è¾‘æ˜¯å¦æ‰§è¡ŒæˆåŠŸ int resultCode = Integer.valueOf(map.get(\"dealSuccess\")); map.clear(); if (resultCode == 1) { //å¤„ç†æˆåŠŸ map.put(\"return_code\", \"SUCCESS\"); LOGGER.info(\"===============å¾®ä¿¡æ”¯ä»˜å›è°ƒæˆåŠŸ===========\"); } else { map.put(\"return_code\", \"FAIL\"); map.put(\"return_msg\", \"ä¸šåŠ¡å¤„ç†å¤±è´¥\"); } response.getWriter().write(WXPayUtil.mapToXml(map)); response.getWriter().flush(); response.getWriter().close(); } } catch (Exception e) { //å‘Šè¯‰å¾®ä¿¡ä¸šåŠ¡å¤±è´¥ try { Map map = new HashMap\u003c\u003e(); map.put(\"return_code\", \"FAIL\"); map.put(\"return_msg\", \"ä¸šåŠ¡å¤„ç†å¤±è´¥\"); response.getWriter().write(WXPayUtil.mapToXml(map)); response.getWriter().flush(); response.getWriter().close(); } catch (Exception e1) { LOGGER.info(\"==============å¾®ä¿¡æ”¯ä»˜å›è°ƒå“åº”å¼‚å¸¸==============\", e); } LOGGER.info(\"==============å¾®ä¿¡æ”¯ä»˜å›è°ƒå¼‚å¸¸==============\", e); } } å…³é”®å°±è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªé¢„æ”¯ä»˜ï¼Œå¾®ä¿¡è¿”å›perpay_idï¼Œä½ è¿”å›ç»™å‰ç«¯ï¼Œå‰ç«¯é€šè¿‡perpay_idè°ƒèµ·æ”¯ä»˜ç»„ä»¶ï¼Œè‹¥å®Œæˆæ”¯ä»˜ï¼Œå¾®ä¿¡ä¼šå›è°ƒä½ è®¾ç½®çš„notify_urlåœ°å€ï¼Œè¿™å°±æ˜¯ä½ æ”¯ä»˜æˆåŠŸçš„å›è°ƒåœ°å€ã€‚ä½ è¦åœ¨å›è°ƒæ–¹æ³•é‡Œå†™ä¸€äº›ä¸šåŠ¡ç›¸å…³çš„é€»è¾‘ï¼Œæ¯”å¦‚ï¼šæ›´æ”¹è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜ï¼Œä»¥åŠèµ é€ä¼šå‘˜ç­‰åç»­æ“ä½œã€‚\nå…¬ä¼—å·æ”¯ä»˜å‚è€ƒ1 å…¬ä¼—å·æ”¯ä»˜å‚è€ƒ2\n2020/8/4 å¾®ä¿¡æ”¯ä»˜é‡è¯•æœºåˆ¶ï¼š å¦‚æœå›è°ƒæ–¹æ³•ç»™å¾®ä¿¡æœåŠ¡å™¨è¿”å›å¤±è´¥ï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šé—´æŒ‰æ—¶é—´æ®µè°ƒç”¨å•†æˆ·æœåŠ¡å™¨ï¼Œç›´åˆ°æˆåŠŸã€‚ ä»Šå¤©å‘ç°ï¼Œçº¿ä¸Šçš„å›è°ƒæ–¹æ³•æŠ¥é”™äº†ã€‚æˆ‘ä¿®å¤äº†æŠ¥é”™çš„ä»£ç ï¼ŒæŠŠä»£ç æ›´ä¸Šå»ä¹‹åï¼Œä¹‹å‰æŠ¥é”™çš„è®¢å•ä¹Ÿæ­£å¸¸äº†ï¼Œæ‰å‘ç°è¿™ä¸ªäº‹ã€‚\nJSAPIæœ€ä½³å®è·µ å‰ç«¯è·å–codeã€‚ å‰ç«¯é€šè¿‡codeè¯·æ±‚åå°æ¥å£ï¼Œè·å–openidï¼Œå¹¶ç¼“å­˜openidã€‚ å‰ç«¯é€šè¿‡openidè¯·æ±‚åå°é¢„æ”¯ä»˜æ¥å£ï¼Œåå°è¯·æ±‚å¾®ä¿¡ï¼Œç„¶åç»™å‰ç«¯è¿”å›prepay_idç­‰æ‹‰èµ·æ”¯ä»˜éœ€è¦çš„å‚æ•°ã€‚ ç”¨æˆ·æ”¯ä»˜æˆåŠŸåï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šå›è°ƒåå°æ¥å£ï¼Œå‘Šè¯‰æˆ‘ä»¬æ”¯ä»˜æˆåŠŸã€‚ åå°æ¥å£æ¥æ”¶åˆ°å¾®ä¿¡çš„é€šçŸ¥ï¼Œå¼€å§‹å¤„ç†æˆ‘ä»¬çš„ä¸šåŠ¡ï¼ˆä¿®æ”¹è®¢å•çŠ¶æ€ï¼Œå¢åŠ ç§¯åˆ†ç­‰ä¸šåŠ¡é€»è¾‘ï¼‰ã€‚ç„¶åç»™å¾®ä¿¡è¿”å›å¤„ç†æˆåŠŸï¼Œç„¶åå¾®ä¿¡æ‰ä¸ä¼šä¸€ç›´å›è°ƒæˆ‘ä»¬çš„æ¥å£ã€‚ å‰ç«¯å¾ªç¯è°ƒç”¨åå°çš„æ£€æŸ¥è®¢å•çŠ¶æ€æ¥å£ï¼ŒæˆåŠŸåè·³è½¬æ”¯ä»˜æˆåŠŸé¡µé¢ã€‚ å¾®ä¿¡appæ”¯ä»˜ å®˜ç½‘ å¼€å‘æ–‡æ¡£\nå¾®ä¿¡è¿™å›¾åšçš„ï¼Œè€å­çœŸæƒ³éª‚è¡—ï¼Œåšä¸ªç™½åº•çš„ä¸å¥½ä¹ˆã€‚\nå¿…è¦å‚æ•°ï¼š appidï¼šå¾®ä¿¡å¼€æ”¾å¹³å°å®¡æ ¸é€šè¿‡çš„åº”ç”¨APPIDï¼ˆè¯·ç™»å½•open.weixin.qq.comæŸ¥çœ‹ï¼Œæ³¨æ„ä¸å…¬ä¼—å·çš„APPIDä¸åŒï¼‰ mch_idï¼šå¾®ä¿¡æ”¯ä»˜åˆ†é…çš„å•†æˆ·å· nonce_strï¼šéšæœºå­—ç¬¦ä¸² bodyï¼šå†…å®¹ out_trade_noï¼šå•†æˆ·è®¢å•å· fee_typeï¼šè´§å¸ç±»å‹ total_feeï¼šæ€»é‡‘é¢ spbill_create_ipï¼šç»ˆç«¯IP(ä¸€èˆ¬ä¸ºæœåŠ¡å™¨æœ¬æœº:127.0.0.1) notify_urlï¼šå›è°ƒurl trade_typeï¼šäº¤æ˜“ç±»å‹(APP) è¿™äº›å‚æ•°ç”Ÿæˆç­¾åï¼Œå‚æ•°æ³¨é‡Šå‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ å°†ç”Ÿæˆçš„ç­¾åè¿åŒè¿™äº›å‚æ•°ä¸€èµ·ç”ŸæˆxmlæŠ¥æ–‡è¯·æ±‚ç»Ÿä¸€ä¸‹å•apiã€‚\nç»Ÿä¸€ä¸‹å•apiæˆåŠŸåä¼šè¿”å›prepayid(é¢„æ”¯ä»˜äº¤æ˜“ä¼šè¯æ ‡è¯†)ï¼Œå°† appidï¼Œprepayidï¼Œpartnerid(å•†æˆ·å·)ï¼Œpackage(Sign=WXPay)ï¼Œnoncestrï¼Œtimestamp è¿™äº›å‚æ•°å†æ¬¡è¿›è¡Œç­¾åï¼Œå†å°†ç­¾åï¼Œè¿åŒè¿™äº›å‚æ•°å‘é€åˆ°appç«¯ä¾›å…¶è°ƒç”¨å®Œæˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 @ResponseBody @PostMapping(\"appBuySapcePerPay\") public ResponseUtil appBuySapcePerPay(@RequestBody Map paramMap) { LOGGER.info(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003eå‰ç«¯è¯·æ±‚å‚æ•°æ˜¯ \" + paramMap +\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\"); Map resultMap = new HashMap\u003c\u003e(); ResponseUtil response = ResponseUtil.success(); CodeEnum code = CodeEnum.FAIL; try { Token token = TokenUtil.getToken(request.getHeader(\"token\")); //éªŒè¯å‰ç«¯ä¼ çš„ä»·æ ¼æ˜¯å¦æ­£ç¡® Integer price = Integer.parseInt(paramMap.get(\"price\")); AssertUtil.assertValidate(code,CodeEnum.ERROR_2001.getCode(),\"è´­ä¹°ç©ºé—´ä»·æ ¼é”™è¯¯\",price.equals(sapcePrice)); //å‰ç«¯ä¼ è¿‡æ¥çš„è®¢å•å· String orderNo = paramMap.get(\"order_no\"); //ç”Ÿæˆè®¢å• orderNo = generateSpaceOrder(paramMap, token, price, orderNo, 1); //æ‹¼æ¥ç»Ÿä¸€ä¸‹å•åœ°å€å‚æ•°(å…±10ä¸ªå¿…é¡»å‚æ•°) Map toWxMap = new HashMap\u003c\u003e(); toWxMap.put(\"appid\", PayConstant.PARENT_APP_WX_APPID); toWxMap.put(\"mch_id\", PayConstant.WX_H5_MCHID); toWxMap.put(\"nonce_str\",WXPayUtil.generateNonceStr()); toWxMap.put(\"body\", \"æœ€ç¾è¯¾æœ¬-å­©å­ç©ºé—´VIP\"); toWxMap.put(\"out_trade_no\", orderNo); toWxMap.put(\"spbill_create_ip\",HttpUtil.getIpAddr(this.request)); toWxMap.put(\"total_fee\",new BigDecimal(price).multiply(new BigDecimal(\"100\")).intValue() + \"\"); toWxMap.put(\"trade_type\", \"APP\"); //æ¥æ”¶å¾®ä¿¡æ”¯ä»˜å¼‚æ­¥é€šçŸ¥å›è°ƒåœ°å€ï¼Œé€šçŸ¥urlå¿…é¡»ä¸ºç›´æ¥å¯è®¿é—®çš„urlï¼Œä¸èƒ½æºå¸¦å‚æ•°ã€‚ toWxMap.put(\"notify_url\", PayUtil.getProjectUrl(this.request) + \"zjx/api/pay/wxBuySpaceNotify\"); LOGGER.info(\"************æ”¯ä»˜æˆåŠŸå›è°ƒåœ°å€æ˜¯:\"+PayUtil.getProjectUrl(this.request) + \"zjx/api/pay/wxBuySpaceNotify\"); toWxMap.put(\"sign\", WXPayUtil.generateSignature(toWxMap, PayConstant.WX_H5_APP_KEY)); //å°†æ‰€æœ‰å‚æ•°(map)è½¬xmlæ ¼å¼ String xml = WXPayUtil.mapToXml(toWxMap); LOGGER.info(\"*******************è¯·æ±‚å¾®ä¿¡å‚æ•°\"+xml); //è°ƒç”¨å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£ï¼Œè¿”å›é¢„æ”¯ä»˜idï¼šprepay_id String wxReturnStr = PayUtil.post(PayConstant.WX_UNIFIEDORDER_URL, xml, ContentTypeEnum.TextXml.getContentType()); //å°†å¾®ä¿¡è¿”å›æ•°æ®æ ¼å¼åŒ–æˆmap Map wxXmlMap = WXPayUtil.xmlToMap(wxReturnStr); LOGGER.info(\"**********************å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£è¿”å›æ•°æ®:\" + wxXmlMap + \"*****************************************\"); // todo //ç»„è£…è¿”å›ç»™å‰ç«¯çš„æ•°æ® resultMap.put(\"appid\", PayConstant.PARENT_APP_WX_APPID); resultMap.put(\"partnerid\", PayConstant.WX_H5_MCHID); resultMap.put(\"prepayid\", wxXmlMap.get(\"prepay_id\")); resultMap.put(\"package\", \"Sign=WXPay\"); resultMap.put(\"nonceStr\", WXPayUtil.generateNonceStr()); resultMap.put(\"timeStamp\", WXPayUtil.getCurrentTimestamp()+\"\"); resultMap.put(\"sign\", WXPayUtil.generateSignature(resultMap, PayConstant.WX_H5_APP_KEY)); resultMap.put(\"order_no\", orderNo); LOGGER.info(\"**********************è¿”å›ç»™å‰ç«¯çš„æ•°æ®:\" + resultMap + \"*****************************************\"); response.setData(resultMap); //è®¢å•è®°å½•redisï¼Œ12å°æ—¶è‡ªåŠ¨è¿‡æœŸ stringRedisTemplate.opsForValue().set(orderNo, \"sapceOrder\", 60 * 60 * 12, TimeUnit.SECONDS); } catch (Exception e) { e.printStackTrace(); response.setCode(code); response.setMessage(e.getMessage()); } return response; } é¢„æ”¯ä»˜æ¥å£å°±æ˜¯è¿™æ ·ï¼Œå’Œå…¬ä¼—å·æ”¯ä»˜åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯å‚æ•°æœ‰äº›ä¸åŒã€‚ é¢„æ”¯ä»˜æ¥å£è°ƒç”¨æˆåŠŸåï¼Œéœ€è¦ç¼–å†™æ”¯ä»˜æˆåŠŸå›è°ƒæ¥å£ï¼Œå¾®ä¿¡ä¼šä¸»åŠ¨è°ƒç”¨æˆ‘ä»¬åœ¨é¢„æ”¯ä»˜æ¥å£ä¸­è®¾ç½®å¥½çš„urlï¼Œå³notify_urlã€‚ å¾®ä¿¡ä¼šå°†ï¼šå•†æˆ·è®¢å•å·,å¾®ä¿¡æ”¯ä»˜è®¢å•å·å‘é€ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›æ¥å®Œæˆä¸šåŠ¡é€»è¾‘ã€‚\nå‚è€ƒ1 å‚è€ƒ2 å‚è€ƒ3 å‚è€ƒ4\nå¾®ä¿¡æ‰«ç æ”¯ä»˜ æ‰«ç æ”¯ä»˜å®˜æ–¹æ–‡æ¡£ æ‰«ç æ”¯ä»˜ï¼Œéœ€è¦åœ¨å¾®ä¿¡å•†æˆ·å¹³å°å¼€é€šNativeæ”¯ä»˜ã€‚ ç™»å½•å¾®ä¿¡å•†æˆ·å¹³å°-\u003eäº§å“ä¸­å¿ƒ-\u003eNativeæ”¯ä»˜-\u003eå¼€é€š\nå¾®ä¿¡æ‰«ç æ”¯ä»˜æœ‰ä¸¤ç§æ¨¡å¼ï¼Œ æ¨¡å¼ä¸€ï¼šè¦æ˜¯é’ˆå¯¹å•†å“å›ºå®šçš„åœºæ™¯ï¼Œå¯ä»¥å…ˆç”Ÿæˆå›ºå®šçš„äºŒç»´ç ï¼Œæ­¤äºŒç»´ç æ˜¯æ°¸ä¹…æœ‰æ•ˆçš„ï¼Œç”¨æˆ·æ‰«ç åå†é€šè¿‡äº§å“ç¼–å·æŸ¥è¯¢å•†å“ä¿¡æ¯æ¥ä¸‹å•ã€‚ è€Œæ¨¡å¼äºŒå¾—å…ˆä¸‹å•ç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„äºŒç»´ç ï¼Œä¸€èˆ¬ä¸¤å°æ—¶å†…æœ‰æ•ˆã€‚\nè·å–å¾®ä¿¡äºŒç»´ç å®ç°ç±»ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 @Override public Map wxPrePayAndGetQrcode(int userId, int payType,String ip) { Orders orders = getOrderNo(userId, payType); String orderNo = orders.getOrderNo(); try { //æ‹¼æ¥ç»Ÿä¸€ä¸‹å•åœ°å€å‚æ•° Map toWxMap = new HashMap\u003c\u003e(11); toWxMap.put(\"appid\", WxUtil.getAppid(environment, WxPlatformConstant.PARTNER_GZH)); toWxMap.put(\"mch_id\", PayConstant.WX_H5_MCHID); toWxMap.put(\"body\", \"å•†å“\"); toWxMap.put(\"nonce_str\", WXPayUtil.generateNonceStr()); toWxMap.put(\"out_trade_no\", orderNo); toWxMap.put(\"spbill_create_ip\", ip); toWxMap.put(\"total_fee\", orders.getOrderPrice().toString()); toWxMap.put(\"trade_type\", \"NATIVE\"); if(\"prod\".equals(environment)){ toWxMap.put(\"notify_url\", PayConstant.WX_NOTIFY_URL); }else{ toWxMap.put(\"notify_url\", PayConstant.WX_NOTIFY_URL_TEST); } toWxMap.put(\"sign\", WXPayUtil.generateSignature(toWxMap, PayConstant.WX_H5_APP_KEY)); //å°†æ‰€æœ‰å‚æ•°(map)è½¬xmlæ ¼å¼ String xml = WXPayUtil.mapToXml(toWxMap); log.info(\"*******************è¯·æ±‚å¾®ä¿¡å‚æ•°\" + xml); //å‘é€postè¯·æ±‚\"ç»Ÿä¸€ä¸‹å•æ¥å£\" String wxReturnStr = PayUtil.post(PayConstant.WX_UNIFIEDORDER_URL, xml, ContentTypeEnum.TextXml.getContentType()); Map wxXmlMap = WXPayUtil.xmlToMap(wxReturnStr); log.info(\"**********************å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£è¿”å›æ•°æ®:\" + wxXmlMap + \"*****************************************\"); String qrcode = wxXmlMap.get(\"code_url\"); Map map = new HashMap(); map.put(\"qrcode\",qrcode); map.put(\"orderNo\",orderNo); map.put(\"oneYearVipPrice\",PayConstant.padç«¯ä¸€å¹´å­¦ä¹ æƒç›Šä»·æ ¼); return map; } catch (Exception e) { throw new RuntimeException(e); } } å¼‚æ­¥å›è°ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 /** * @author: wjy * @description: å¾®ä¿¡æ‰«ç æ”¯ä»˜å¼‚æ­¥å›è°ƒ */ @ResponseBody @PostMapping(\"padBuyVipWxPayCallback\") public void padBuyVipWxPayCallback(HttpServletRequest request,HttpServletResponse response) throws Exception { log.info( \"\\n***************************************\" + \"\\n\" + \"start padBuyVipWxPayCallback\" + \"\\n\" + \"å¾®ä¿¡æ‰«ç æ”¯ä»˜å¼‚æ­¥å›è°ƒ\" + \"\\n\" + \"\\n********************************************\" ); try { ByteArrayOutputStream outSteam = new ByteArrayOutputStream(); InputStream inStream = request.getInputStream(); byte[] buffer = new byte[1024]; int len = 0; while ((len = inStream.read(buffer)) != -1) { outSteam.write(buffer, 0, len); } outSteam.close(); inStream.close(); String result = new String(outSteam.toByteArray(), PayConstant.DEFAULT_CHARSET); log.info(\"***************************************å¾®ä¿¡è¿”å›ç»“æœxml:\" + result + \"********************************************\"); Map resultMap = new HashMap\u003c\u003e(); String out_trade_no = \"\"; if (!StringUtils.isEmpty(result)) { //å°†å¾®ä¿¡è¿”å›çš„xmlè½¬æˆmap Map map = WXPayUtil.xmlToMap(result); //éªŒç­¾ if (WXPayUtil.isSignatureValid(map, PayConstant.WX_H5_APP_KEY, WXPayConstants.SignType.MD5)) { String attach = map.get(\"attach\"); log.info(\"***************************************å¾®ä¿¡è‡ªå®šä¹‰å‚æ•°:\" + attach + \"********************************************\"); log.info(\"***************************************å•†æˆ·è®¢å•å·:\" + map.get(\"out_trade_no\") + \"******************************\"); out_trade_no = map.get(\"out_trade_no\"); } else { resultMap.put(\"return_code\", \"FAIL\"); resultMap.put(\"return_msg\", \"éªŒç­¾å¤±è´¥\"); response.getWriter().write(WXPayUtil.mapToXml(map)); response.getWriter().flush(); response.getWriter().close(); return; } } String finalOut_trade_no = out_trade_no; executorService.execute(() -\u003e { payService.padBuyVipCallback(finalOut_trade_no); }); // å¦‚æœç­¾åéªŒè¯æ­£ç¡®ï¼Œç«‹å³è¿”å›successï¼Œåç»­ä¸šåŠ¡å¦èµ·çº¿ç¨‹å•ç‹¬å¤„ç† Map map = new HashMap\u003c\u003e(); map.put(\"return_code\", \"SUCCESS\"); response.getWriter().write(WXPayUtil.mapToXml(map)); response.getWriter().flush(); response.getWriter().close(); } catch (Exception e) { e.printStackTrace(); Map map = new HashMap\u003c\u003e(); map.put(\"return_code\", \"FAIL\"); map.put(\"return_msg\", \"ä¸šåŠ¡å¤„ç†å¤±è´¥\"); response.getWriter().write(WXPayUtil.mapToXml(map)); response.getWriter().flush(); response.getWriter().close(); } } æ”¯ä»˜å®æ”¯ä»˜ æ”¯ä»˜å®appæ”¯ä»˜ å®˜æ–¹æ–‡æ¡£ æ”¯ä»˜å®çš„æ–‡æ¡£çœŸçš„ä¸€ç›®äº†ç„¶ï¼Œæ¯”å¾®ä¿¡å¼ºå¤ªå¤šâ€¦ å‚è€ƒ\næ”¯ä»˜å®-æ‰‹æœºç½‘ç«™æ”¯ä»˜ æ‰‹æœºç½‘ç«™æ”¯ä»˜å®˜æ–¹æ–‡æ¡£ ä¸€å®šè¦ä»”ç»†çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œæ ¹æ®æ–‡æ¡£æç¤ºï¼Œä¸€æ­¥ä¸€æ­¥æ¥ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯å®˜æ–¹æ–‡æ¡£çš„è¿™å¥è¯ï¼š æ”¯ä»˜å®ä¼šä¸ºå¼€å‘è€…ç”Ÿæˆå‰å°é¡µé¢è¯·æ±‚éœ€è¦çš„å®Œæ•´ form è¡¨å•çš„ htmlï¼ˆåŒ…å«è‡ªåŠ¨æäº¤è„šæœ¬ï¼‰ï¼Œå•†å®¶ç›´æ¥å°†è¿™ä¸ªè¡¨å•çš„ String è¾“å‡ºåˆ° http response ä¸­å³å¯ã€‚ å°±æ˜¯è¯´åå°è¯·æ±‚æ”¯ä»˜å®æ¥å£åï¼Œæ”¯ä»˜å®ä¼šè¿”å›ä¸€ä¸ªè¡¨å•å­—ç¬¦ä¸²ï¼Œç±»ä¼¼è¿™ç§ï¼š\n1 2 3 4 5 6 7 8 ",
  "wordCount" : "20568",
  "inLanguage": "en",
  "datePublished": "2019-11-24T13:50:44Z",
  "dateModified": "2019-11-24T13:50:44Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/pay/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

  <script id="MathJax-script" async src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-chtml.min.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath:  [['\\(', '\\)'], ['$', '$']],  
    }
  };
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;Â»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      pay
    </h1>
    <div class="post-meta"><span title='2019-11-24 13:50:44 +0000 UTC'>2019-11-24</span>&nbsp;Â·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98" aria-label="å¾®ä¿¡æ”¯ä»˜">å¾®ä¿¡æ”¯ä»˜</a><ul>
                        
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1jsapi%e6%94%af%e4%bb%98" aria-label="å¾®ä¿¡JSAPIæ”¯ä»˜">å¾®ä¿¡JSAPIæ”¯ä»˜</a><ul>
                        
                <li>
                    <a href="#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c" aria-label="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e5%87%86%e5%a4%87" aria-label="é…ç½®å‡†å¤‡">é…ç½®å‡†å¤‡</a><ul>
                        
                <li>
                    <a href="#%e5%85%ac%e4%bc%97%e5%8f%b7%e9%85%8d%e7%bd%ae" aria-label="å…¬ä¼—å·é…ç½®">å…¬ä¼—å·é…ç½®</a></li>
                <li>
                    <a href="#%e5%95%86%e6%88%b7%e5%b9%b3%e5%8f%b0%e9%85%8d%e7%bd%ae" aria-label="å•†æˆ·å¹³å°é…ç½®">å•†æˆ·å¹³å°é…ç½®</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96%e7%94%a8%e6%88%b7code%e5%89%8d%e7%ab%af%e8%8e%b7%e5%8f%96code%e6%8e%a8%e8%8d%90" aria-label="è·å–ç”¨æˆ·codeï¼ˆå‰ç«¯è·å–codeï¼Œæ¨èï¼‰">è·å–ç”¨æˆ·codeï¼ˆå‰ç«¯è·å–codeï¼Œæ¨èï¼‰</a></li>
                <li>
                    <a href="#%e5%90%8e%e7%ab%af%e8%8e%b7%e5%8f%96code%e4%b8%8d%e6%8e%a8%e8%8d%90%e6%af%94%e8%be%83%e9%ba%bb%e7%83%a6" aria-label="åç«¯è·å–codeï¼ˆä¸æ¨èï¼Œæ¯”è¾ƒéº»çƒ¦ï¼‰">åç«¯è·å–codeï¼ˆä¸æ¨èï¼Œæ¯”è¾ƒéº»çƒ¦ï¼‰</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87code%e8%8e%b7%e5%8f%96openid" aria-label="é€šè¿‡codeè·å–openid">é€šè¿‡codeè·å–openid</a></li>
                <li>
                    <a href="#%e8%b0%83%e7%94%a8%e5%be%ae%e4%bf%a1%e7%bb%9f%e4%b8%80%e4%b8%8b%e5%8d%95%e6%8e%a5%e5%8f%a3" aria-label="è°ƒç”¨å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£">è°ƒç”¨å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£</a></li>
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e6%88%90%e5%8a%9f%e7%9a%84%e5%9b%9e%e8%b0%83" aria-label="æ”¯ä»˜æˆåŠŸçš„å›è°ƒ">æ”¯ä»˜æˆåŠŸçš„å›è°ƒ</a></li>
                <li>
                    <a href="#jsapi%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" aria-label="JSAPIæœ€ä½³å®è·µ">JSAPIæœ€ä½³å®è·µ</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1app%e6%94%af%e4%bb%98" aria-label="å¾®ä¿¡appæ”¯ä»˜">å¾®ä¿¡appæ”¯ä»˜</a></li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98" aria-label="å¾®ä¿¡æ‰«ç æ”¯ä»˜">å¾®ä¿¡æ‰«ç æ”¯ä»˜</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e5%ae%9d%e6%94%af%e4%bb%98" aria-label="æ”¯ä»˜å®æ”¯ä»˜">æ”¯ä»˜å®æ”¯ä»˜</a><ul>
                        
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e5%ae%9dapp%e6%94%af%e4%bb%98" aria-label="æ”¯ä»˜å®appæ”¯ä»˜">æ”¯ä»˜å®appæ”¯ä»˜</a></li>
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e5%ae%9d-%e6%89%8b%e6%9c%ba%e7%bd%91%e7%ab%99%e6%94%af%e4%bb%98" aria-label="æ”¯ä»˜å®-æ‰‹æœºç½‘ç«™æ”¯ä»˜">æ”¯ä»˜å®-æ‰‹æœºç½‘ç«™æ”¯ä»˜</a></li>
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e5%ae%9d%e6%89%ab%e7%a0%81%e6%94%af%e4%bb%98%e5%bd%93%e9%9d%a2%e4%bb%98" aria-label="æ”¯ä»˜å®æ‰«ç æ”¯ä»˜ï¼ˆå½“é¢ä»˜ï¼‰">æ”¯ä»˜å®æ‰«ç æ”¯ä»˜ï¼ˆå½“é¢ä»˜ï¼‰</a></li>
                <li>
                    <a href="#%e5%bc%82%e6%ad%a5%e5%9b%9e%e8%b0%83%e5%bc%82%e5%b8%b8%e9%97%ae%e9%a2%98" aria-label="å¼‚æ­¥å›è°ƒå¼‚å¸¸é—®é¢˜">å¼‚æ­¥å›è°ƒå¼‚å¸¸é—®é¢˜</a><ul>
                        
                <li>
                    <a href="#%e4%b8%80%e5%b9%b4%e5%90%8e%e6%94%b6%e5%88%b0%e6%94%af%e4%bb%98%e5%ae%9d%e7%9a%84%e5%bc%82%e6%ad%a5%e5%9b%9e%e8%b0%83%e9%80%9a%e7%9f%a5" aria-label="ä¸€å¹´åæ”¶åˆ°æ”¯ä»˜å®çš„å¼‚æ­¥å›è°ƒé€šçŸ¥">ä¸€å¹´åæ”¶åˆ°æ”¯ä»˜å®çš„å¼‚æ­¥å›è°ƒé€šçŸ¥</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e8%8b%b9%e6%9e%9c%e6%94%af%e4%bb%98" aria-label="è‹¹æœæ”¯ä»˜">è‹¹æœæ”¯ä»˜</a></li>
                <li>
                    <a href="#%e7%ad%96%e7%95%a5%e6%a8%a1%e5%bc%8f%e5%ae%9e%e7%8e%b0%e5%a4%9a%e6%94%af%e4%bb%98" aria-label="ç­–ç•¥æ¨¡å¼å®ç°å¤šæ”¯ä»˜">ç­–ç•¥æ¨¡å¼å®ç°å¤šæ”¯ä»˜</a><ul>
                        
                <li>
                    <a href="#%e8%ae%be%e8%ae%a1%e6%80%9d%e8%b7%af" aria-label="è®¾è®¡æ€è·¯">è®¾è®¡æ€è·¯</a></li>
                <li>
                    <a href="#maven%e4%be%9d%e8%b5%96" aria-label="mavenä¾èµ–">mavenä¾èµ–</a></li>
                <li>
                    <a href="#%e5%85%b3%e9%94%ae%e7%b1%bb" aria-label="å…³é”®ç±»">å…³é”®ç±»</a><ul>
                        
                <li>
                    <a href="#%e7%ad%96%e7%95%a5%e6%8e%a5%e5%8f%a3" aria-label="ç­–ç•¥æ¥å£">ç­–ç•¥æ¥å£</a></li>
                <li>
                    <a href="#%e4%b8%9a%e5%8a%a1%e5%8f%82%e6%95%b0%e7%b1%bb" aria-label="ä¸šåŠ¡å‚æ•°ç±»">ä¸šåŠ¡å‚æ•°ç±»</a></li>
                <li>
                    <a href="#%e5%9b%9b%e7%a7%8d%e6%94%af%e4%bb%98%e7%ad%96%e7%95%a5" aria-label="å››ç§æ”¯ä»˜ç­–ç•¥">å››ç§æ”¯ä»˜ç­–ç•¥</a><ul>
                        
                <li>
                    <a href="#aliapppaystrategy" aria-label="AliAppPayStrategy">AliAppPayStrategy</a></li>
                <li>
                    <a href="#aliwebpaystrategy" aria-label="AliWebPayStrategy">AliWebPayStrategy</a></li>
                <li>
                    <a href="#wxapppaystrategy" aria-label="WxAppPayStrategy">WxAppPayStrategy</a></li>
                <li>
                    <a href="#wxwebpaystrategy" aria-label="WxWebPayStrategy">WxWebPayStrategy</a></li></ul>
                </li>
                <li>
                    <a href="#http%e8%af%b7%e6%b1%82" aria-label="Httpè¯·æ±‚">Httpè¯·æ±‚</a></li>
                <li>
                    <a href="#%e7%ad%96%e7%95%a5%e6%9e%9a%e4%b8%be" aria-label="ç­–ç•¥æšä¸¾">ç­–ç•¥æšä¸¾</a></li>
                <li>
                    <a href="#%e7%ad%96%e7%95%a5%e5%b7%a5%e5%8e%82" aria-label="ç­–ç•¥å·¥å‚">ç­–ç•¥å·¥å‚</a></li>
                <li>
                    <a href="#%e5%9c%ba%e6%99%af%e8%b0%83%e7%94%a8" aria-label="åœºæ™¯è°ƒç”¨">åœºæ™¯è°ƒç”¨</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%89%8d%e7%ab%af%e4%bb%a3%e7%a0%81" aria-label="å‰ç«¯ä»£ç ">å‰ç«¯ä»£ç </a><ul>
                        
                <li>
                    <a href="#%e5%85%ac%e4%bc%97%e5%8f%b7%e5%86%85%e6%94%af%e4%bb%98" aria-label="å…¬ä¼—å·å†…æ”¯ä»˜">å…¬ä¼—å·å†…æ”¯ä»˜</a><ul>
                        
                <li>
                    <a href="#%e7%ac%ac%e4%b8%80%e7%a7%8d%e6%96%b9%e5%bc%8f" aria-label="ç¬¬ä¸€ç§æ–¹å¼">ç¬¬ä¸€ç§æ–¹å¼</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%ba%8c%e7%a7%8d%e6%96%b9%e5%bc%8f" aria-label="ç¬¬äºŒç§æ–¹å¼">ç¬¬äºŒç§æ–¹å¼</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%9e%e8%b0%83%e5%87%bd%e6%95%b0" aria-label="å›è°ƒå‡½æ•°">å›è°ƒå‡½æ•°</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%94%af%e4%bb%98%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bf%83%e8%84%8f%e7%8a%b6%e6%80%81%e6%9c%ba" aria-label="æ”¯ä»˜ç³»ç»Ÿçš„å¿ƒè„ï¼šçŠ¶æ€æœº">æ”¯ä»˜ç³»ç»Ÿçš„å¿ƒè„ï¼šçŠ¶æ€æœº</a><ul>
                        
                <li>
                    <a href="#%e7%8a%b6%e6%80%81%e6%9c%ba%e8%ae%be%e8%ae%a1%e5%9f%ba%e6%9c%ac%e5%8e%9f%e5%88%99" aria-label="çŠ¶æ€æœºè®¾è®¡åŸºæœ¬åŸåˆ™ï¼š">çŠ¶æ€æœºè®¾è®¡åŸºæœ¬åŸåˆ™ï¼š</a></li>
                <li>
                    <a href="#%e7%8a%b6%e6%80%81%e6%9c%ba%e5%b8%b8%e8%a7%81%e8%ae%be%e8%ae%a1%e8%af%af%e5%8c%ba" aria-label="çŠ¶æ€æœºå¸¸è§è®¾è®¡è¯¯åŒº">çŠ¶æ€æœºå¸¸è§è®¾è®¡è¯¯åŒº</a></li>
                <li>
                    <a href="#%e7%8a%b6%e6%80%81%e6%9c%ba%e8%ae%be%e8%ae%a1%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" aria-label="çŠ¶æ€æœºè®¾è®¡çš„æœ€ä½³å®è·µ">çŠ¶æ€æœºè®¾è®¡çš„æœ€ä½³å®è·µ</a></li>
                <li>
                    <a href="#%e5%b8%b8%e8%a7%81%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0%e8%af%af%e5%8c%ba" aria-label="å¸¸è§ä»£ç å®ç°è¯¯åŒº">å¸¸è§ä»£ç å®ç°è¯¯åŒº</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0" aria-label="ä»£ç å®ç°">ä»£ç å®ç°</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>æ”¯ä»˜å®æ”¯ä»˜å®˜ç½‘ï¼š
<a href="https://docs.open.alipay.com/catalog">https://docs.open.alipay.com/catalog</a>
å¾®ä¿¡æ”¯ä»˜å®˜ç½‘ï¼š
V2ï¼šhttps://pay.weixin.qq.com/wiki/doc/api/index.html
V3ï¼šhttps://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml</p>
<h1 id="å¾®ä¿¡æ”¯ä»˜">å¾®ä¿¡æ”¯ä»˜<a hidden class="anchor" aria-hidden="true" href="#å¾®ä¿¡æ”¯ä»˜">#</a></h1>
<h2 id="å¾®ä¿¡jsapiæ”¯ä»˜">å¾®ä¿¡JSAPIæ”¯ä»˜<a hidden class="anchor" aria-hidden="true" href="#å¾®ä¿¡jsapiæ”¯ä»˜">#</a></h2>
<p><a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_1">å®˜æ–¹æ–‡æ¡£</a>
å¾®ä¿¡ç½‘é¡µæ”¯ä»˜æ—¶åºå›¾ï¼š
<img loading="lazy" src="3.png" alt=""  />
</p>
<h3 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ<a hidden class="anchor" aria-hidden="true" href="#å‡†å¤‡å·¥ä½œ">#</a></h3>
<ul>
<li>å¾®ä¿¡å…¬ä¼—å¹³å°å·²è®¤è¯çš„æœåŠ¡å·ï¼Œå¹¶ä¸”éœ€è¦å¼€é€šå¾®ä¿¡æ”¯ä»˜è¯¥èƒ½ã€‚ç™»å½•é¡µhttps://mp.weixin.qq.com/</li>
<li>å¾®ä¿¡å•†æˆ·å¹³å°è´¦å·ã€‚https://pay.weixin.qq.com</li>
<li>ä¸€ä¸ªæ­£å¼çš„åº”ç”¨æœåŠ¡å™¨ï¼Œå¹¶ä¸”æ³¨å†ŒåŸŸåã€‚
å¾®ä¿¡æ”¯ä»˜æ¶‰åŠçš„ç§å¯†æ•°æ®æ¯”è¾ƒå¤šï¼Œä¸å…è®¸ä½¿ç”¨natappï¼ŒèŠ±ç”Ÿå£³ä¹‹ç±»çš„å†…ç½‘ç©¿é€å·¥å…·å®ç°ï¼Œéœ€è¦æœ‰æ­£å¼çš„æœåŠ¡å™¨ç¯å¢ƒï¼Œå¹¶ä¸”è¦æ³¨å†ŒåŸŸåï¼Œä¸èƒ½ä½¿ç”¨IPã€‚æ­£ç¡®çš„åœ°å€ç¤ºä¾‹ï¼š<code>http://www.wjy.com</code></li>
</ul>
<h3 id="é…ç½®å‡†å¤‡">é…ç½®å‡†å¤‡<a hidden class="anchor" aria-hidden="true" href="#é…ç½®å‡†å¤‡">#</a></h3>
<h4 id="å…¬ä¼—å·é…ç½®">å…¬ä¼—å·é…ç½®<a hidden class="anchor" aria-hidden="true" href="#å…¬ä¼—å·é…ç½®">#</a></h4>
<ul>
<li>
<p>é…ç½®ç½‘é¡µæˆæƒåŸŸåï¼Œç™»å½•å…¬ä¼—å¹³å°â€”â€”&gt;å…¬ä¼—å·è®¾ç½®â€”â€”&gt;åŠŸèƒ½è®¾ç½®
é…ç½®å‰ç«¯æ ¹ç›®å½•å³å¯ï¼Œä¾‹å¦‚ï¼š<code>pre-zj.stzy.com</code>ã€‚ä¸è¦<code>https://</code>
è¯¥é…ç½®ä¸»è¦ç”¨äºè·å–ç”¨æˆ·çš„codeï¼Œéœ€è¦è¯†åˆ«è¿™æ˜¯å“ªä¸ªäººã€‚æ³¨ï¼šæ˜¯å‰ç«¯é¡µé¢çš„åœ°å€ã€‚
ç„¶åæŒ‰ç…§æç¤ºï¼Œå°†æ–‡ä»¶ä¸‹è½½å¹¶ä¸Šä¼ åˆ°<code>ç½‘é¡µæˆæƒåŸŸå</code>ç›®å½•ä¸‹ï¼Œå¹¶ä¸”åœ¨æµè§ˆå™¨ï¼Œæµ‹è¯•è®¿é—®ï¼Œ<code>http://www.baidu.com/ä½ çš„æ–‡ä»¶å.txt</code>çœ‹åˆ°ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œè¯æ˜æˆåŠŸã€‚(å¯ä»¥é€šè¿‡nginxè®¿é—®è¯¥æ–‡ä»¶)</p>
</li>
<li>
<p>é…ç½®JSæ¥å£å®‰å…¨åŸŸåï¼šè¦è®©æˆ‘ä»¬çš„é¡µé¢ä¸­å¼¹å‡ºè¾“å…¥å¯†ç çš„çª—å£ï¼Œéœ€è¦ä½¿ç”¨å¾®ä¿¡æä¾›çš„JS-SDKå·¥å…·ï¼Œå¦‚æœä¸é…ç½®JSæ¥å£å®‰å…¨åŸŸåï¼Œä½ çš„é¡µé¢æ— æ³•ä½¿ç”¨JS-SDKã€‚
é…ç½®å‰ç«¯æ ¹ç›®å½•å³å¯ï¼š<code>pre-zj.stzy.com</code>
æ³¨æ„ï¼šä¸€ä¸ªè‡ªç„¶æœˆå†…æœ€å¤šå¯ä¿®æ”¹å¹¶ä¿å­˜äº”æ¬¡ï¼Œæœ¬æœˆå‰©ä½™ä¿å­˜æ¬¡æ•°ï¼š5ã€‚æ‰€ä»¥å»ºè®®æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„åœ°å€ä¸€å—æ·»åŠ ï¼Œå…çš„å¤šæ¬¡æ·»åŠ æµªè´¹æ¬¡æ•°ã€‚</p>
</li>
<li>
<p>è·å–å…¬ä¼—å·çš„ AppID å’Œ AppSecret
ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°-&gt;æ‹‰åˆ°é¡µé¢æœ€ä¸‹è¾¹-&gt;åœ¨å·¦ä¾§æ‰¾åˆ°å¼€å‘ä¸€æ -&gt;ç‚¹å‡»åŸºæœ¬é…ç½®-&gt;éœ€è¦ç‚¹å‡»ç¡®è®¤ç”³è¯·å¼€é€šï¼Œç„¶åå°±å¯ä»¥çœ‹åˆ°AppIDå’Œå…¶ä»–é…ç½®ä¿¡æ¯ã€‚
AppSecretéœ€è¦å‘è¯¥å…¬ä¼—å·çš„ç®¡ç†å‘˜ç”³è¯·å¼€é€šï¼Œ30åˆ†é’Ÿå†…é€šè¿‡å³å¯ï¼Œç„¶åè¾“å…¥è¯¥å…¬ä¼—å·å¯†ç ï¼Œå³å¯æŸ¥çœ‹åˆ°AppSecretï¼ŒæŒ‰ç…§é¡µé¢æç¤ºå­˜å‚¨å¥½AppSecretï¼Œå¹¶è¿›è¡Œåç»­æ“ä½œã€‚ï¼ˆæ³¨æ„å…¬ä¼—å·çš„ AppIDï¼Œæµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„åˆ‡æ¢ï¼‰</p>
</li>
</ul>
<h4 id="å•†æˆ·å¹³å°é…ç½®">å•†æˆ·å¹³å°é…ç½®<a hidden class="anchor" aria-hidden="true" href="#å•†æˆ·å¹³å°é…ç½®">#</a></h4>
<ul>
<li>é…ç½®æ”¯ä»˜æˆæƒç›®å½•ï¼Œç™»å½•å•†æˆ·å¹³å°-&gt;äº§å“ä¸­å¿ƒ-&gt;å¼€å‘é…ç½®-&gt;æ”¯ä»˜é…ç½®-&gt;JSAPIæ”¯ä»˜
è¿™é‡Œéœ€è¦å¡«å†™å‰ç«¯é¡µé¢çš„åœ°å€ï¼Œä¸åœ¨è¯¥è·¯å¾„çš„é¡µé¢ï¼Œåˆ™æ— æ³•è°ƒç”¨æ”¯ä»˜åŠŸèƒ½ã€‚
å¯ä»¥å¡«å†™å‰ç«¯çš„æ ¹ç›®å½•ï¼š<code>http://pay.xxxx.com/</code>
æˆ–åªå¡«å†™æ”¯ä»˜ç›®å½•ï¼š<code>http://mywexx.xxxx.com/pay</code></li>
</ul>
<p>æ³¨æ„ç¬¬ä¸€æ¬¡æ·»åŠ æ—¶ï¼Œä¼šè®©è¾“å…¥æ“ä½œå¯†ç ï¼Œè¾“å…¥å®Œæ“ä½œå¯†ç ï¼Œéœ€è¦å†æ·»åŠ ä¸€æ¬¡æ‰èƒ½æ·»åŠ æˆåŠŸã€‚</p>
<ul>
<li>
<p>è®¾ç½®APIå¯†é’¥ï¼Œç™»å½•å•†æˆ·å¹³å°â€”â€”&gt;è´¦æˆ·ä¸­å¿ƒâ€”â€”&gt;APIå®‰å…¨â€”â€”&gt;å¾€ä¸‹æ‹‰æ‰¾åˆ° APIå¯†é’¥
ç°åœ¨æœ‰ä¸¤ä¸ªå¯†é’¥éœ€è¦è®¾ç½®ï¼ŒV2å’ŒV3çš„å¯†é’¥ï¼Œåˆ†åˆ«å¯¹åº”V2å’ŒV3ä¸¤ç§æ”¯ä»˜æ–¹å¼ã€‚</p>
</li>
<li>
<p>å°†å…¬ä¼—å·å’Œå•†æˆ·å¹³å°å…³è”
å…¬ä¼—å·å¼€é€šå¾®ä¿¡æ”¯ä»˜ï¼Œæ˜¯åœ¨å¾®ä¿¡å•†æˆ·å¹³å°å®Œæˆçš„ï¼Œç»‘å®šå®Œæˆåï¼Œå¯ä»¥åœ¨å…¬ä¼—å·çœ‹åˆ°ç»‘å®šçš„å•†æˆ·å·ã€‚<a href="https://pay.weixin.qq.com/static/pay_setting/appid_protocol.shtml">å®˜æ–¹ç»‘å®šæ•™ç¨‹</a>
å¯ä»¥å…ˆæ‰¾å•†æˆ·å¹³å°æ‰€æœ‰è€…(è¶…çº§ç®¡ç†å‘˜)ï¼ŒæŠŠè‡ªå·±çš„å¾®ä¿¡ç»‘å®šä¸ºç®¡ç†å‘˜ï¼šé¡¶éƒ¨ç‚¹å‡»è´¦å·ä¸­å¿ƒ-&gt;å·¦ä¾§æ‰¾åˆ°å‘˜å·¥è´¦å·ç®¡ç†-&gt;å³ä¾§æ‰¾åˆ°ç®¡ç†å‘˜ï¼Œç‚¹å‡»æ–°å¢è´¦å·-&gt;ç„¶åå¯èƒ½éœ€è¦å®‰è£…å®‰å…¨æ§ä»¶ã€‚
å®‰è£…æ§ä»¶ä¹‹åï¼Œå¯èƒ½éœ€è¦é‡å¯æµè§ˆå™¨ï¼Œæ‰èƒ½æ£€æµ‹åˆ°å®‰å…¨æ§ä»¶ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç™»å½•ï¼Œç„¶åå‘é€éªŒè¯ï¼Œå°±æˆåŠŸåœ¨æœ¬æœºä¸Šå®‰è£…å®‰å…¨æ§ä»¶äº†ã€‚å®‰è£…å¥½æ§ä»¶ä¹‹åï¼Œå°±å¯ä»¥å°†è‡ªå·±çš„å¾®ä¿¡å·ç»‘å®šä¸ºç®¡ç†å‘˜äº†ã€‚
æ³¨æ„æäº¤çš„æ—¶å€™ï¼Œéœ€è¦è¾“å…¥<code>æ“ä½œå¯†ç </code>ï¼Œè¯¥å¯†ç ä¸æ˜¯å•†æˆ·å¹³å°çš„ç™»å½•å¯†ç ï¼Œæ˜¯æ“ä½œå¯†ç ã€‚
æ ¹æ®ç»‘å®šæ•™ç¨‹ï¼Œè¾“å…¥å…¬ä¼—å·çš„appIDåï¼Œå¯ä»¥åœ¨ç»‘å®šçš„å…¬ä¼—å·-&gt;å•†æˆ·å·ç®¡ç†ï¼Œçœ‹åˆ°å¾…å…³è”å•†æˆ·å·ï¼Œå¯ä»¥ç¡®è®¤ä»¥åŠåç»­æ­¥éª¤ï¼Œå³å¯æˆåŠŸå…³è”ã€‚</p>
</li>
</ul>
<p>æ­¤å¤„æ˜¯è´¦å·æ¨¡æ¿,è¯·å‚è€ƒï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>å¾®ä¿¡å…¬ä¼—å¹³å°ï¼šè´¦æˆ·ï¼šcon*******om ç™»å½•å¯†ç  ******
</span></span><span style="display:flex;"><span>å…¬ä¼—APPIDï¼šwx15*********a8
</span></span><span style="display:flex;"><span>APPSECEPT : c210***************892d7
</span></span><span style="display:flex;"><span>å¾®ä¿¡å•†æˆ·å¹³å°ï¼šè´¦æˆ·ï¼š149**********6742 ç™»å½•å¯†ç ï¼š******
</span></span><span style="display:flex;"><span>å•†æˆ·IDï¼š14******42
</span></span><span style="display:flex;"><span>APIå¯†é’¥ï¼š5d5************b35b
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‡³æ­¤ï¼Œéœ€è¦çš„å››å¤§å‚æ•°éƒ½æ‰¾åˆ°äº†ã€‚å¯ä»¥é€šè¿‡å®˜ç½‘çš„å·¥å…·æµ‹è¯•æˆ‘ä»¬çš„é…ç½®æ˜¯å¦æœ‰é—®é¢˜ï¼š
<a href="https://mp.weixin.qq.com/debug">https://mp.weixin.qq.com/debug</a></p>
<p>å¦‚æœè¿”å›<code>Request successful</code>ï¼Œä»¥åŠ<code>access_token</code>å’Œ<code>expires_in</code>ï¼Œè¯´æ˜é…ç½®æ²¡é—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬ç›´æ¥æŠŠå¾®ä¿¡å®˜æ–¹æä¾›çš„ä¸€å †utilï¼Œæ”¾åˆ°é¡¹ç›®ä¸­ã€‚</p>
<h3 id="è·å–ç”¨æˆ·codeå‰ç«¯è·å–codeæ¨è">è·å–ç”¨æˆ·codeï¼ˆå‰ç«¯è·å–codeï¼Œæ¨èï¼‰<a hidden class="anchor" aria-hidden="true" href="#è·å–ç”¨æˆ·codeå‰ç«¯è·å–codeæ¨è">#</a></h3>
<p>åœ¨ç¡®ä¿å¾®ä¿¡å…¬ä¼—è´¦å·æ‹¥æœ‰æˆæƒä½œç”¨åŸŸï¼ˆscopeå‚æ•°ï¼‰çš„æƒé™çš„å‰æä¸‹ï¼ˆæœåŠ¡å·è·å¾—é«˜çº§æ¥å£åï¼Œé»˜è®¤æ‹¥æœ‰scopeå‚æ•°ä¸­çš„snsapi_baseå’Œsnsapi_userinfoï¼‰ï¼Œè®©å‰ç«¯è¯·æ±‚å¦‚ä¸‹urlï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://open.weixin.qq.com/connect/oauth2/authorize
</span></span><span style="display:flex;"><span>?appid=APPID
</span></span><span style="display:flex;"><span>&amp;redirect_uri=REDIRECT_URI
</span></span><span style="display:flex;"><span>&amp;response_type=code
</span></span><span style="display:flex;"><span>&amp;scope=SCOPE
</span></span><span style="display:flex;"><span>&amp;state=STATE#wechat_redirect
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‚æ•°è§£æï¼š
appidï¼šå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†ã€‚
redirect_uriï¼šæˆæƒåé‡å®šå‘çš„å›è°ƒé“¾æ¥åœ°å€ã€‚å¾®ä¿¡ä¼šé‡å®šå‘åˆ°è¿™ä¸ªé¡µé¢ï¼Œå¹¶å¸¦ä¸Šcodeå‚æ•°ã€‚
æ³¨æ„ï¼šéœ€è¦å¯¹é“¾æ¥è¿›è¡ŒurlEncodeå¤„ç†ã€‚æ³¨æ„è¿™ä¸ªå›è°ƒåœ°å€åªèƒ½æ˜¯åŸŸåï¼Œä¸èƒ½å¸¦ç«¯å£å·ã€‚
response_typeï¼šè¿”å›ç±»å‹ï¼Œè¯·å¡«å†™codeï¼Œå†™æ­»ã€‚
scopeï¼šåº”ç”¨æˆæƒä½œç”¨åŸŸã€‚
<code>snsapi_base</code>ï¼šä¸å¼¹å‡ºæˆæƒé¡µé¢ï¼Œç›´æ¥è·³è½¬ï¼Œåªèƒ½è·å–ç”¨æˆ·openidã€‚
<code>snsapi_userinfo</code>ï¼šå¼¹å‡ºæˆæƒé¡µé¢ï¼Œå¯é€šè¿‡ openid æ‹¿åˆ°æ˜µç§°ã€æ€§åˆ«ã€æ‰€åœ¨åœ°ã€‚å¹¶ä¸”ï¼Œå³ä½¿åœ¨æœªå…³æ³¨çš„æƒ…å†µä¸‹ï¼Œåªè¦ç”¨æˆ·æˆæƒï¼Œä¹Ÿèƒ½è·å–å…¶ä¿¡æ¯ã€‚</p>
<p>stateï¼šé‡å®šå‘åä¼šå¸¦ä¸Šstateå‚æ•°ï¼Œå¼€å‘è€…å¯ä»¥å¡«å†™a-zA-Z0-9çš„å‚æ•°å€¼ï¼Œæœ€å¤š128å­—èŠ‚ã€‚
<code>#wechat_redirect</code>ï¼šæ— è®ºç›´æ¥æ‰“å¼€è¿˜æ˜¯åšé¡µé¢302é‡å®šå‘æ—¶å€™ï¼Œå¿…é¡»å¸¦æ­¤å‚æ•°ã€‚</p>
<p>è‹¥æç¤º<code>è¯¥é“¾æ¥æ— æ³•è®¿é—®</code>ï¼Œè¯·æ£€æŸ¥å‚æ•°æ˜¯å¦å¡«å†™é”™è¯¯ï¼Œæ˜¯å¦æ‹¥æœ‰scopeå‚æ•°å¯¹åº”çš„æˆæƒä½œç”¨åŸŸæƒé™ã€‚å°¤å…¶æ³¨æ„ï¼Œç”±äºæˆæƒæ“ä½œå®‰å…¨ç­‰çº§è¾ƒé«˜ï¼Œæ‰€ä»¥åœ¨å‘èµ·æˆæƒè¯·æ±‚æ—¶ï¼Œå¾®ä¿¡ä¼šå¯¹æˆæƒé“¾æ¥åšæ­£åˆ™å¼ºåŒ¹é…æ ¡éªŒï¼Œå¦‚æœé“¾æ¥çš„å‚æ•°é¡ºåºä¸å¯¹ï¼Œæˆæƒé¡µé¢å°†æ— æ³•æ­£å¸¸è®¿é—®ã€‚</p>
<p>è¿™ä¸€æ­¥å°±æ˜¯è·å–ç”¨æˆ·çš„codeã€‚æ•´ä½“æµç¨‹æ˜¯ï¼š</p>
<ol>
<li>å‰ç«¯è¯·æ±‚æˆæƒurl</li>
<li>å¾®ä¿¡é‡å®šå‘åˆ°æˆ‘ä»¬æŒ‡å®šçš„<code>redirect_uri</code>ï¼Œå³æˆ‘ä»¬è‡ªå·±çš„é¡µé¢ï¼Œå¹¶å¸¦ä¸Šcodeå‚æ•°ï¼Œ<code>redirect_uri/?code=CODE&amp;state=STATE</code>ã€‚</li>
<li>ç°åœ¨å‰ç«¯å°±å¯ä»¥è·å–åˆ°é“¾æ¥ä¸Šçš„codeï¼Œç„¶åä¼ é€’ç»™åç«¯ã€‚</li>
<li>åç«¯é€šè¿‡codeè·å–openidï¼Œç„¶åè¯·æ±‚å¾®ä¿¡é¢„æ”¯ä»˜æ¥å£ã€‚</li>
</ol>
<p>codeè¯´æ˜ï¼šcode æ˜¯æ¢å–openidçš„ç¥¨æ®ï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œ5åˆ†é’Ÿæœªè¢«ä½¿ç”¨è‡ªåŠ¨è¿‡æœŸã€‚</p>
<h3 id="åç«¯è·å–codeä¸æ¨èæ¯”è¾ƒéº»çƒ¦">åç«¯è·å–codeï¼ˆä¸æ¨èï¼Œæ¯”è¾ƒéº»çƒ¦ï¼‰<a hidden class="anchor" aria-hidden="true" href="#åç«¯è·å–codeä¸æ¨èæ¯”è¾ƒéº»çƒ¦">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * è·å–code
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@GetMapping(<span style="color:#0ff;font-weight:bold">&#34;getWxCode&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ModelAndView getWxCode() {
</span></span><span style="display:flex;"><span>	LOGGER.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;è·å–codeå¼€å§‹&#34;</span>);
</span></span><span style="display:flex;"><span>	ModelAndView mv = <span style="color:#fff;font-weight:bold">new</span> ModelAndView();
</span></span><span style="display:flex;"><span>	String rediretUrl = PayUtil.<span style="color:#007f7f">getProjectUrl</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">request</span>) + <span style="color:#0ff;font-weight:bold">&#34;zjx/api/pay/perPay&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>		String url = <span style="color:#0ff;font-weight:bold">&#34;https://open.weixin.qq.com/connect/oauth2/authorize?&#34;</span>
</span></span><span style="display:flex;"><span>				+ <span style="color:#0ff;font-weight:bold">&#34;appid=&#34;</span> + PayConstant.<span style="color:#007f7f">WX_H5_APPID</span>
</span></span><span style="display:flex;"><span>				+ <span style="color:#0ff;font-weight:bold">&#34;&amp;redirect_uri=&#34;</span> + URLEncoder.<span style="color:#007f7f">encode</span>(rediretUrl, PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>)
</span></span><span style="display:flex;"><span>				+ <span style="color:#0ff;font-weight:bold">&#34;&amp;response_type=code&amp;scope=snsapi_base&amp;state=123#wechat_redirect&#34;</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#007f7f">//è¿™é‡Œå¿…é¡»æ˜¯é‡å®šå‘
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		mv.<span style="color:#007f7f">setViewName</span>(<span style="color:#0ff;font-weight:bold">&#34;redirect:&#34;</span> + url);
</span></span><span style="display:flex;"><span>	} <span style="color:#fff;font-weight:bold">catch</span> (UnsupportedEncodingException e) {
</span></span><span style="display:flex;"><span>		e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">return</span> mv;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æµç¨‹ï¼š</p>
<ol>
<li>å‰ç«¯è¯·æ±‚ä¸Šè¾¹çš„æ¥å£ï¼Œä¸ç”¨å¸¦å‚æ•°ã€‚</li>
<li>åç«¯è¯·æ±‚å¾®ä¿¡ï¼Œå¸¦å‚æ•°ï¼Œ<code>redirect_uri</code>éœ€è¦æŒ‡å®šä¸ºåå°çš„æ¥å£åœ°å€ã€‚</li>
<li>å¾®ä¿¡é‡å®šå‘åˆ°æˆ‘ä»¬æŒ‡å®šçš„<code>redirect_uri</code>ï¼Œä¼šå¸¦ä¸Šcodeå‚æ•°ã€‚</li>
<li>ç¼–å†™<code>redirect_uri</code>æŒ‡å®šçš„åå°æ¥å£ï¼Œåœ¨æ¥å£ä¸Šç”¨<code>@requestParam</code>è·å–codeå‚æ•°ï¼Œç„¶åé€šè¿‡codeæ¢å–<code>access_token</code>å’Œ<code>openid</code>ã€‚</li>
<li>ç„¶åæˆ–è€…æŠŠopenidè¿”å›ç»™å‰ç«¯ï¼Œè·å–ç›´æ¥ç”¨openidè¯·æ±‚å¾®ä¿¡çš„é¢„æ”¯ä»˜æ¥å£ã€‚</li>
</ol>
<p>é¢„æ”¯ä»˜æ¥å£åªéœ€è¦ç”¨æˆ·çš„openidï¼Œä¸€ä¸ªç”¨æˆ·å¯¹äºä¸€ä¸ªå…¬ä¼—å·çš„openidæ˜¯ä¸ä¼šå˜çš„ï¼Œæ‰€ä»¥æ²¡å¿…è¦éè¦åœ¨è¯·æ±‚é¢„æ”¯ä»˜çš„æ—¶å€™æ‰é€šè¿‡codeæ¢å–openidï¼Œå¯ä»¥åœ¨è¿›å…¥å…¬ä¼—å·å°±è·å–æˆæƒï¼Œç„¶åè·å–openidï¼Œç„¶åè®©å‰ç«¯ç¼“å­˜åœ¨æœ¬åœ°ï¼Œæˆ–æ˜¯é€šè¿‡æ¥å£å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™æ ·åœ¨è¯·æ±‚é¢„æ”¯ä»˜æ¥å£æ—¶ï¼Œç›´æ¥ä¼ é€’å­˜å‚¨å¥½çš„openidå°±å¥½äº†ã€‚</p>
<h3 id="é€šè¿‡codeè·å–openid">é€šè¿‡codeè·å–openid<a hidden class="anchor" aria-hidden="true" href="#é€šè¿‡codeè·å–openid">#</a></h3>
<p>å‰ç«¯è¯·æ±‚è¿™ä¸ªæ¥å£ï¼Œåå°ç»™å‰ç«¯è¿”å›openidï¼Œç„¶åå‰ç«¯ç¼“å­˜openidã€‚è¿™æ ·å°±ä¸ç”¨æ¯æ¬¡åˆ·æ–°é¡µé¢éƒ½éœ€è¦é‡æ–°é€šè¿‡codeè·å–openidäº†ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@ApiOperation(value = <span style="color:#0ff;font-weight:bold">&#34;é€šè¿‡codeè·å–openid&#34;</span>)
</span></span><span style="display:flex;"><span>@RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;getWxOpenid&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> String getWxOpenid(@RequestParam(<span style="color:#0ff;font-weight:bold">&#34;code&#34;</span>) String code) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è·å–openIdåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String getOpenidUrl = <span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/sns/oauth2/access_token&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String param = <span style="color:#0ff;font-weight:bold">&#34;?appid=&#34;</span> + weChatConfig.<span style="color:#007f7f">getAppId</span>() +
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;secret=&#34;</span> + weChatConfig.<span style="color:#007f7f">getApSecret</span>() +
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;code=&#34;</span> + code +
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#34;&amp;grant_type=authorization_code&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å‘å¾®ä¿¡æœåŠ¡å™¨å‘é€getè¯·æ±‚è·å–openIdStr
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String openIdStr = HttpUtil.<span style="color:#007f7f">get</span>(getOpenidUrl + param);
</span></span><span style="display:flex;"><span>    JsonNode jsonNode = JacksonUtils.<span style="color:#007f7f">jsonToJsonNode</span>(openIdStr);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> jsonNode.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;openid&#34;</span>).<span style="color:#007f7f">asText</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è°ƒç”¨å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£">è°ƒç”¨å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£<a hidden class="anchor" aria-hidden="true" href="#è°ƒç”¨å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * å¾®ä¿¡JSAPI é¢„æ”¯ä»˜ï¼Œè¿”å›å‰ç«¯æ‹‰èµ·æ”¯ä»˜éœ€è¦çš„å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@GetMapping(<span style="color:#0ff;font-weight:bold">&#34;perPay&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Map perPay(@RequestParam(<span style="color:#0ff;font-weight:bold">&#34;openid&#34;</span>) String openid) {
</span></span><span style="display:flex;"><span>    LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;openidæ˜¯ &#34;</span> + openid);
</span></span><span style="display:flex;"><span>    Map&lt;String, String&gt; resultMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç”Ÿæˆè®¢å•ç¼–å·
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">int</span> number = (<span style="color:#fff;font-weight:bold">int</span>)((Math.<span style="color:#007f7f">random</span>()*<span style="color:#ff0;font-weight:bold">9</span>)*<span style="color:#ff0;font-weight:bold">1000</span>);<span style="color:#007f7f">//éšæœºæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        DateFormat dateFormat = <span style="color:#fff;font-weight:bold">new</span> SimpleDateFormat(<span style="color:#0ff;font-weight:bold">&#34;yyyyMMddHHmmss&#34;</span>);<span style="color:#007f7f">//æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String orderNo = dateFormat.<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> Date()) + number;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ‹¼æ¥ç»Ÿä¸€ä¸‹å•åœ°å€å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Map&lt;String, String&gt; paraMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appid&#34;</span>, PayConstant.<span style="color:#007f7f">WX_H5_APPID</span>);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;mch_id&#34;</span>, PayConstant.<span style="color:#007f7f">WX_H5_MCHID</span>);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;body&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;æœ€ç¾è¯¾æœ¬æ”¯ä»˜æµ‹è¯•&#34;</span>);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonce_str&#34;</span>,WXPayUtil.<span style="color:#007f7f">generateNonceStr</span>());
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;openid&#34;</span>, openid);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, orderNo);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;spbill_create_ip&#34;</span>,HttpUtil.<span style="color:#007f7f">getIpAddr</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">request</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ä»·æ ¼ï¼Œå•ä½åˆ†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;total_fee&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;1&#34;</span>);
</span></span><span style="display:flex;"><span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;trade_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;JSAPI&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ”¯ä»˜æˆåŠŸï¼Œå¾®ä¿¡å›è°ƒæœåŠ¡å™¨çš„æ¥å£åœ°å€ï¼Œæ³¨æ„æ·»åŠ ç™½åå•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;notify_url&#34;</span>, PayUtil.<span style="color:#007f7f">getProjectUrl</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">request</span>) + <span style="color:#0ff;font-weight:bold">&#34;zjx/api/wxNotify&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// éœ€è¦å’Œä¸‹é¢signæ–¹æ³•ä¸€è‡´ï¼Œä¸æ˜¯è¯´å‚æ•°ä¸€è‡´ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        paraMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(paraMap, PayConstant.<span style="color:#007f7f">WX_H5_APP_KEY</span>));
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å°†æ‰€æœ‰å‚æ•°(map)è½¬xmlæ ¼å¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String xml = WXPayUtil.<span style="color:#007f7f">mapToXml</span>(paraMap);
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;è¯·æ±‚å¾®ä¿¡å‚æ•°&#34;</span>+xml);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å‘é€postè¯·æ±‚&#34;ç»Ÿä¸€ä¸‹å•æ¥å£&#34;è¿”å›é¢„æ”¯ä»˜idï¼šprepay_id
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String wxReturnStr = PayUtil.<span style="color:#007f7f">post</span>(PayConstant.<span style="color:#007f7f">WX_UNIFIEDORDER_URL</span>, xml, ContentTypeEnum.<span style="color:#007f7f">TextXml</span>.<span style="color:#007f7f">getContentType</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; wxXmlMap = WXPayUtil.<span style="color:#007f7f">xmlToMap</span>(wxReturnStr);
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£è¿”å›æ•°æ®:&#34;</span> + wxXmlMap);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç»„è£…è¿”å›ç»™å‰ç«¯çš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appId&#34;</span>, PayConstant.<span style="color:#007f7f">WX_H5_APPID</span>);
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;timeStamp&#34;</span>, WXPayUtil.<span style="color:#007f7f">getCurrentTimestamp</span>()+<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonceStr&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateNonceStr</span>());
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;signType&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;MD5&#34;</span>);
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;package&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;prepay_id=&#34;</span> + wxXmlMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;prepay_id&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ³¨æ„è¿™é‡Œçš„ç­¾åæ–¹æ³•éœ€è¦å’Œä¸Šè¾¹paramMapä¸­signçš„æ–¹æ³•ä¸€è‡´ï¼Œapp_keyä¹Ÿå¿…é¡»ä¸€è‡´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;paySign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(resultMap, PayConstant.<span style="color:#007f7f">WX_H5_APP_KEY</span>));
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;è¿”å›ç»™å‰ç«¯çš„æ•°æ®:&#34;</span> + resultMap);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> resultMap;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ”¯ä»˜æˆåŠŸçš„å›è°ƒ">æ”¯ä»˜æˆåŠŸçš„å›è°ƒ<a hidden class="anchor" aria-hidden="true" href="#æ”¯ä»˜æˆåŠŸçš„å›è°ƒ">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;wxBuySpaceNotify&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> wxBuySpaceNotify() {
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; map = PayUtil.<span style="color:#007f7f">resolveWXPayResponse</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">request</span>, PayConstant.<span style="color:#007f7f">WX_H5_APP_KEY</span>);
</span></span><span style="display:flex;"><span>		LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;=============å¾®ä¿¡æ”¯ä»˜å›è°ƒå‚æ•°:&#34;</span> + JSONObject.<span style="color:#007f7f">toJSONString</span>(map));
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">if</span> (map.<span style="color:#007f7f">size</span>() &gt;= <span style="color:#ff0;font-weight:bold">2</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//æ‰§è¡Œå›è°ƒé€»è¾‘
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			map = payService.<span style="color:#007f7f">buySpaceCallback</span>(map);
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//å†…éƒ¨é€»è¾‘æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			<span style="color:#fff;font-weight:bold">int</span> resultCode = Integer.<span style="color:#007f7f">valueOf</span>(map.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;dealSuccess&#34;</span>));
</span></span><span style="display:flex;"><span>			map.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">if</span> (resultCode == <span style="color:#ff0;font-weight:bold">1</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#007f7f">//å¤„ç†æˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>				map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_code&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;SUCCESS&#34;</span>);
</span></span><span style="display:flex;"><span>				LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;===============å¾®ä¿¡æ”¯ä»˜å›è°ƒæˆåŠŸ===========&#34;</span>);
</span></span><span style="display:flex;"><span>			} <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>				map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_code&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;FAIL&#34;</span>);
</span></span><span style="display:flex;"><span>				map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_msg&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;ä¸šåŠ¡å¤„ç†å¤±è´¥&#34;</span>);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">write</span>(WXPayUtil.<span style="color:#007f7f">mapToXml</span>(map));
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//å‘Šè¯‰å¾®ä¿¡ä¸šåŠ¡å¤±è´¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>			Map&lt;String, String&gt; map = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>			map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_code&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;FAIL&#34;</span>);
</span></span><span style="display:flex;"><span>			map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_msg&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;ä¸šåŠ¡å¤„ç†å¤±è´¥&#34;</span>);
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">write</span>(WXPayUtil.<span style="color:#007f7f">mapToXml</span>(map));
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>			response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>		} <span style="color:#fff;font-weight:bold">catch</span> (Exception e1) {
</span></span><span style="display:flex;"><span>			LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;==============å¾®ä¿¡æ”¯ä»˜å›è°ƒå“åº”å¼‚å¸¸==============&#34;</span>, e);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;==============å¾®ä¿¡æ”¯ä»˜å›è°ƒå¼‚å¸¸==============&#34;</span>, e);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…³é”®å°±è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªé¢„æ”¯ä»˜ï¼Œå¾®ä¿¡è¿”å›perpay_idï¼Œä½ è¿”å›ç»™å‰ç«¯ï¼Œå‰ç«¯é€šè¿‡perpay_idè°ƒèµ·æ”¯ä»˜ç»„ä»¶ï¼Œè‹¥å®Œæˆæ”¯ä»˜ï¼Œå¾®ä¿¡ä¼šå›è°ƒä½ è®¾ç½®çš„notify_urlåœ°å€ï¼Œè¿™å°±æ˜¯ä½ æ”¯ä»˜æˆåŠŸçš„å›è°ƒåœ°å€ã€‚ä½ è¦åœ¨å›è°ƒæ–¹æ³•é‡Œå†™ä¸€äº›ä¸šåŠ¡ç›¸å…³çš„é€»è¾‘ï¼Œæ¯”å¦‚ï¼šæ›´æ”¹è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜ï¼Œä»¥åŠèµ é€ä¼šå‘˜ç­‰åç»­æ“ä½œã€‚</p>
<p><a href="https://www.jianshu.com/p/9c322b1a5274">å…¬ä¼—å·æ”¯ä»˜å‚è€ƒ1</a>
<a href="https://blog.csdn.net/javaYouCome/article/details/79473743">å…¬ä¼—å·æ”¯ä»˜å‚è€ƒ2</a></p>
<p>2020/8/4
å¾®ä¿¡æ”¯ä»˜é‡è¯•æœºåˆ¶ï¼š
å¦‚æœå›è°ƒæ–¹æ³•ç»™å¾®ä¿¡æœåŠ¡å™¨è¿”å›å¤±è´¥ï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šé—´æŒ‰æ—¶é—´æ®µè°ƒç”¨å•†æˆ·æœåŠ¡å™¨ï¼Œç›´åˆ°æˆåŠŸã€‚
ä»Šå¤©å‘ç°ï¼Œçº¿ä¸Šçš„å›è°ƒæ–¹æ³•æŠ¥é”™äº†ã€‚æˆ‘ä¿®å¤äº†æŠ¥é”™çš„ä»£ç ï¼ŒæŠŠä»£ç æ›´ä¸Šå»ä¹‹åï¼Œä¹‹å‰æŠ¥é”™çš„è®¢å•ä¹Ÿæ­£å¸¸äº†ï¼Œæ‰å‘ç°è¿™ä¸ªäº‹ã€‚</p>
<h3 id="jsapiæœ€ä½³å®è·µ">JSAPIæœ€ä½³å®è·µ<a hidden class="anchor" aria-hidden="true" href="#jsapiæœ€ä½³å®è·µ">#</a></h3>
<ol>
<li>å‰ç«¯è·å–codeã€‚</li>
<li>å‰ç«¯é€šè¿‡codeè¯·æ±‚åå°æ¥å£ï¼Œè·å–openidï¼Œå¹¶ç¼“å­˜openidã€‚</li>
<li>å‰ç«¯é€šè¿‡openidè¯·æ±‚åå°é¢„æ”¯ä»˜æ¥å£ï¼Œåå°è¯·æ±‚å¾®ä¿¡ï¼Œç„¶åç»™å‰ç«¯è¿”å›<code>prepay_id</code>ç­‰æ‹‰èµ·æ”¯ä»˜éœ€è¦çš„å‚æ•°ã€‚</li>
<li>ç”¨æˆ·æ”¯ä»˜æˆåŠŸåï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šå›è°ƒåå°æ¥å£ï¼Œå‘Šè¯‰æˆ‘ä»¬æ”¯ä»˜æˆåŠŸã€‚</li>
<li>åå°æ¥å£æ¥æ”¶åˆ°å¾®ä¿¡çš„é€šçŸ¥ï¼Œå¼€å§‹å¤„ç†æˆ‘ä»¬çš„ä¸šåŠ¡ï¼ˆä¿®æ”¹è®¢å•çŠ¶æ€ï¼Œå¢åŠ ç§¯åˆ†ç­‰ä¸šåŠ¡é€»è¾‘ï¼‰ã€‚ç„¶åç»™å¾®ä¿¡è¿”å›å¤„ç†æˆåŠŸï¼Œç„¶åå¾®ä¿¡æ‰ä¸ä¼šä¸€ç›´å›è°ƒæˆ‘ä»¬çš„æ¥å£ã€‚</li>
<li>å‰ç«¯å¾ªç¯è°ƒç”¨åå°çš„<code>æ£€æŸ¥è®¢å•çŠ¶æ€</code>æ¥å£ï¼ŒæˆåŠŸåè·³è½¬æ”¯ä»˜æˆåŠŸé¡µé¢ã€‚</li>
</ol>
<h2 id="å¾®ä¿¡appæ”¯ä»˜">å¾®ä¿¡appæ”¯ä»˜<a hidden class="anchor" aria-hidden="true" href="#å¾®ä¿¡appæ”¯ä»˜">#</a></h2>
<p><a href="https://pay.weixin.qq.com/index.php/core/home/login?return_url=%2F">å®˜ç½‘</a>
<a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_1">å¼€å‘æ–‡æ¡£</a></p>
<p><img loading="lazy" src="pay/4.png" alt="å¾®ä¿¡æ”¯ä»˜æ—¶åºå›¾"  />

å¾®ä¿¡è¿™å›¾åšçš„ï¼Œè€å­çœŸæƒ³éª‚è¡—ï¼Œåšä¸ªç™½åº•çš„ä¸å¥½ä¹ˆã€‚</p>
<p>å¿…è¦å‚æ•°ï¼š
appidï¼šå¾®ä¿¡å¼€æ”¾å¹³å°å®¡æ ¸é€šè¿‡çš„åº”ç”¨APPIDï¼ˆè¯·ç™»å½•open.weixin.qq.comæŸ¥çœ‹ï¼Œæ³¨æ„ä¸å…¬ä¼—å·çš„APPIDä¸åŒï¼‰
mch_idï¼šå¾®ä¿¡æ”¯ä»˜åˆ†é…çš„å•†æˆ·å·
nonce_strï¼šéšæœºå­—ç¬¦ä¸²
bodyï¼šå†…å®¹
out_trade_noï¼šå•†æˆ·è®¢å•å·
fee_typeï¼šè´§å¸ç±»å‹
total_feeï¼šæ€»é‡‘é¢
spbill_create_ipï¼šç»ˆç«¯IP(ä¸€èˆ¬ä¸ºæœåŠ¡å™¨æœ¬æœº:127.0.0.1)
notify_urlï¼šå›è°ƒurl
trade_typeï¼šäº¤æ˜“ç±»å‹(APP)
è¿™äº›å‚æ•°ç”Ÿæˆç­¾åï¼Œå‚æ•°æ³¨é‡Šå‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚
å°†ç”Ÿæˆçš„ç­¾åè¿åŒè¿™äº›å‚æ•°ä¸€èµ·ç”ŸæˆxmlæŠ¥æ–‡è¯·æ±‚ç»Ÿä¸€ä¸‹å•apiã€‚</p>
<p>ç»Ÿä¸€ä¸‹å•apiæˆåŠŸåä¼šè¿”å›prepayid(é¢„æ”¯ä»˜äº¤æ˜“ä¼šè¯æ ‡è¯†)ï¼Œå°†
<code>appidï¼Œprepayidï¼Œpartnerid(å•†æˆ·å·)ï¼Œpackage(Sign=WXPay)ï¼Œnoncestrï¼Œtimestamp</code>
è¿™äº›å‚æ•°å†æ¬¡è¿›è¡Œç­¾åï¼Œå†å°†ç­¾åï¼Œè¿åŒè¿™äº›å‚æ•°å‘é€åˆ°appç«¯ä¾›å…¶è°ƒç”¨å®Œæˆã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@PostMapping(&#34;appBuySapcePerPay&#34;)
</span></span><span style="display:flex;"><span>public ResponseUtil appBuySapcePerPay(@RequestBody Map&lt;String,String&gt; paramMap) {
</span></span><span style="display:flex;"><span>	LOGGER.info(&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;å‰ç«¯è¯·æ±‚å‚æ•°æ˜¯ &#34; + paramMap +&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&#34;);
</span></span><span style="display:flex;"><span>	Map&lt;String, String&gt; resultMap = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>	ResponseUtil response = ResponseUtil.success();
</span></span><span style="display:flex;"><span>	CodeEnum code = CodeEnum.FAIL;
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		Token token = TokenUtil.getToken(request.getHeader(&#34;token&#34;));
</span></span><span style="display:flex;"><span>		//éªŒè¯å‰ç«¯ä¼ çš„ä»·æ ¼æ˜¯å¦æ­£ç¡®
</span></span><span style="display:flex;"><span>		Integer price = Integer.parseInt(paramMap.get(&#34;price&#34;));
</span></span><span style="display:flex;"><span>		AssertUtil.assertValidate(code,CodeEnum.ERROR_2001.getCode(),&#34;è´­ä¹°ç©ºé—´ä»·æ ¼é”™è¯¯&#34;,price.equals(sapcePrice));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//å‰ç«¯ä¼ è¿‡æ¥çš„è®¢å•å·
</span></span><span style="display:flex;"><span>		String orderNo = paramMap.get(&#34;order_no&#34;);
</span></span><span style="display:flex;"><span>		//ç”Ÿæˆè®¢å•
</span></span><span style="display:flex;"><span>		orderNo = generateSpaceOrder(paramMap, token, price, orderNo, 1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//æ‹¼æ¥ç»Ÿä¸€ä¸‹å•åœ°å€å‚æ•°(å…±10ä¸ªå¿…é¡»å‚æ•°)
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; toWxMap = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;appid&#34;, PayConstant.PARENT_APP_WX_APPID);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;mch_id&#34;, PayConstant.WX_H5_MCHID);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;nonce_str&#34;,WXPayUtil.generateNonceStr());
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;body&#34;, &#34;æœ€ç¾è¯¾æœ¬-å­©å­ç©ºé—´VIP&#34;);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;out_trade_no&#34;, orderNo);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;spbill_create_ip&#34;,HttpUtil.getIpAddr(this.request));
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;total_fee&#34;,new BigDecimal(price).multiply(new BigDecimal(&#34;100&#34;)).intValue() + &#34;&#34;);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;trade_type&#34;, &#34;APP&#34;);
</span></span><span style="display:flex;"><span>		//æ¥æ”¶å¾®ä¿¡æ”¯ä»˜å¼‚æ­¥é€šçŸ¥å›è°ƒåœ°å€ï¼Œé€šçŸ¥urlå¿…é¡»ä¸ºç›´æ¥å¯è®¿é—®çš„urlï¼Œä¸èƒ½æºå¸¦å‚æ•°ã€‚
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;notify_url&#34;, PayUtil.getProjectUrl(this.request) + &#34;zjx/api/pay/wxBuySpaceNotify&#34;);
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;************æ”¯ä»˜æˆåŠŸå›è°ƒåœ°å€æ˜¯:&#34;+PayUtil.getProjectUrl(this.request) + &#34;zjx/api/pay/wxBuySpaceNotify&#34;);
</span></span><span style="display:flex;"><span>		toWxMap.put(&#34;sign&#34;, WXPayUtil.generateSignature(toWxMap, PayConstant.WX_H5_APP_KEY));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//å°†æ‰€æœ‰å‚æ•°(map)è½¬xmlæ ¼å¼
</span></span><span style="display:flex;"><span>		String xml = WXPayUtil.mapToXml(toWxMap);
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;*******************è¯·æ±‚å¾®ä¿¡å‚æ•°&#34;+xml);
</span></span><span style="display:flex;"><span>		//è°ƒç”¨å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£ï¼Œè¿”å›é¢„æ”¯ä»˜idï¼šprepay_id
</span></span><span style="display:flex;"><span>		String wxReturnStr = PayUtil.post(PayConstant.WX_UNIFIEDORDER_URL, xml, ContentTypeEnum.TextXml.getContentType());
</span></span><span style="display:flex;"><span>		//å°†å¾®ä¿¡è¿”å›æ•°æ®æ ¼å¼åŒ–æˆmap
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; wxXmlMap = WXPayUtil.xmlToMap(wxReturnStr);
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;**********************å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£è¿”å›æ•°æ®:&#34; + wxXmlMap + &#34;*****************************************&#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		// todo
</span></span><span style="display:flex;"><span>		//ç»„è£…è¿”å›ç»™å‰ç«¯çš„æ•°æ®
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;appid&#34;, PayConstant.PARENT_APP_WX_APPID);
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;partnerid&#34;, PayConstant.WX_H5_MCHID);
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;prepayid&#34;, wxXmlMap.get(&#34;prepay_id&#34;));
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;package&#34;, &#34;Sign=WXPay&#34;);
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;nonceStr&#34;, WXPayUtil.generateNonceStr());
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;timeStamp&#34;, WXPayUtil.getCurrentTimestamp()+&#34;&#34;);
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;sign&#34;, WXPayUtil.generateSignature(resultMap, PayConstant.WX_H5_APP_KEY));
</span></span><span style="display:flex;"><span>		resultMap.put(&#34;order_no&#34;, orderNo);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		LOGGER.info(&#34;**********************è¿”å›ç»™å‰ç«¯çš„æ•°æ®:&#34; + resultMap + &#34;*****************************************&#34;);
</span></span><span style="display:flex;"><span>		response.setData(resultMap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		//è®¢å•è®°å½•redisï¼Œ12å°æ—¶è‡ªåŠ¨è¿‡æœŸ
</span></span><span style="display:flex;"><span>		stringRedisTemplate.opsForValue().set(orderNo, &#34;sapceOrder&#34;, 60 * 60 * 12, TimeUnit.SECONDS);
</span></span><span style="display:flex;"><span>	} catch (Exception e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		response.setCode(code);
</span></span><span style="display:flex;"><span>		response.setMessage(e.getMessage());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	return response;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é¢„æ”¯ä»˜æ¥å£å°±æ˜¯è¿™æ ·ï¼Œå’Œå…¬ä¼—å·æ”¯ä»˜åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯å‚æ•°æœ‰äº›ä¸åŒã€‚
é¢„æ”¯ä»˜æ¥å£è°ƒç”¨æˆåŠŸåï¼Œéœ€è¦ç¼–å†™æ”¯ä»˜æˆåŠŸå›è°ƒæ¥å£ï¼Œå¾®ä¿¡ä¼šä¸»åŠ¨è°ƒç”¨æˆ‘ä»¬åœ¨é¢„æ”¯ä»˜æ¥å£ä¸­è®¾ç½®å¥½çš„urlï¼Œå³<code>notify_url</code>ã€‚
å¾®ä¿¡ä¼šå°†ï¼šå•†æˆ·è®¢å•å·,å¾®ä¿¡æ”¯ä»˜è®¢å•å·å‘é€ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›æ¥å®Œæˆä¸šåŠ¡é€»è¾‘ã€‚</p>
<p><a href="https://www.jianshu.com/p/54f73fea5986">å‚è€ƒ1</a>
<a href="https://blog.csdn.net/u012552275/article/details/78758571">å‚è€ƒ2</a>
<a href="https://www.cnblogs.com/zhanglingbing/p/9073217.html">å‚è€ƒ3</a>
<a href="https://www.cnblogs.com/xxss/p/10244513.html">å‚è€ƒ4</a></p>
<h2 id="å¾®ä¿¡æ‰«ç æ”¯ä»˜">å¾®ä¿¡æ‰«ç æ”¯ä»˜<a hidden class="anchor" aria-hidden="true" href="#å¾®ä¿¡æ‰«ç æ”¯ä»˜">#</a></h2>
<p><a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=6_1">æ‰«ç æ”¯ä»˜å®˜æ–¹æ–‡æ¡£</a>
æ‰«ç æ”¯ä»˜ï¼Œéœ€è¦åœ¨å¾®ä¿¡å•†æˆ·å¹³å°å¼€é€šNativeæ”¯ä»˜ã€‚
ç™»å½•å¾®ä¿¡å•†æˆ·å¹³å°-&gt;äº§å“ä¸­å¿ƒ-&gt;Nativeæ”¯ä»˜-&gt;å¼€é€š</p>
<p>å¾®ä¿¡æ‰«ç æ”¯ä»˜æœ‰ä¸¤ç§æ¨¡å¼ï¼Œ
æ¨¡å¼ä¸€ï¼šè¦æ˜¯é’ˆå¯¹å•†å“å›ºå®šçš„åœºæ™¯ï¼Œå¯ä»¥å…ˆç”Ÿæˆå›ºå®šçš„äºŒç»´ç ï¼Œæ­¤äºŒç»´ç æ˜¯æ°¸ä¹…æœ‰æ•ˆçš„ï¼Œç”¨æˆ·æ‰«ç åå†é€šè¿‡äº§å“ç¼–å·æŸ¥è¯¢å•†å“ä¿¡æ¯æ¥ä¸‹å•ã€‚
è€Œæ¨¡å¼äºŒå¾—å…ˆä¸‹å•ç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„äºŒç»´ç ï¼Œä¸€èˆ¬ä¸¤å°æ—¶å†…æœ‰æ•ˆã€‚</p>
<p>è·å–å¾®ä¿¡äºŒç»´ç å®ç°ç±»ä»£ç </p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Map wxPrePayAndGetQrcode(<span style="color:#fff;font-weight:bold">int</span> userId, <span style="color:#fff;font-weight:bold">int</span> payType,String ip) {
</span></span><span style="display:flex;"><span>        Orders orders = getOrderNo(userId, payType);
</span></span><span style="display:flex;"><span>        String orderNo = orders.<span style="color:#007f7f">getOrderNo</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ‹¼æ¥ç»Ÿä¸€ä¸‹å•åœ°å€å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Map&lt;String, String&gt; toWxMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;(<span style="color:#ff0;font-weight:bold">11</span>);
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appid&#34;</span>, WxUtil.<span style="color:#007f7f">getAppid</span>(environment, WxPlatformConstant.<span style="color:#007f7f">PARTNER_GZH</span>));
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;mch_id&#34;</span>, PayConstant.<span style="color:#007f7f">WX_H5_MCHID</span>);
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;body&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;å•†å“&#34;</span>);
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonce_str&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateNonceStr</span>());
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, orderNo);
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;spbill_create_ip&#34;</span>, ip);
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;total_fee&#34;</span>, orders.<span style="color:#007f7f">getOrderPrice</span>().<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;trade_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;NATIVE&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(<span style="color:#0ff;font-weight:bold">&#34;prod&#34;</span>.<span style="color:#007f7f">equals</span>(environment)){
</span></span><span style="display:flex;"><span>                toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;notify_url&#34;</span>, PayConstant.<span style="color:#007f7f">WX_NOTIFY_URL</span>);
</span></span><span style="display:flex;"><span>            }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>                toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;notify_url&#34;</span>, PayConstant.<span style="color:#007f7f">WX_NOTIFY_URL_TEST</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            toWxMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(toWxMap, PayConstant.<span style="color:#007f7f">WX_H5_APP_KEY</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å°†æ‰€æœ‰å‚æ•°(map)è½¬xmlæ ¼å¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String xml = WXPayUtil.<span style="color:#007f7f">mapToXml</span>(toWxMap);
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;*******************è¯·æ±‚å¾®ä¿¡å‚æ•°&#34;</span> + xml);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å‘é€postè¯·æ±‚&#34;ç»Ÿä¸€ä¸‹å•æ¥å£&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String wxReturnStr = PayUtil.<span style="color:#007f7f">post</span>(PayConstant.<span style="color:#007f7f">WX_UNIFIEDORDER_URL</span>, xml, ContentTypeEnum.<span style="color:#007f7f">TextXml</span>.<span style="color:#007f7f">getContentType</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            Map&lt;String, String&gt; wxXmlMap = WXPayUtil.<span style="color:#007f7f">xmlToMap</span>(wxReturnStr);
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£è¿”å›æ•°æ®:&#34;</span> + wxXmlMap + <span style="color:#0ff;font-weight:bold">&#34;*****************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            String qrcode = wxXmlMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;code_url&#34;</span>);
</span></span><span style="display:flex;"><span>            Map map = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>            map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;qrcode&#34;</span>,qrcode);
</span></span><span style="display:flex;"><span>            map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;orderNo&#34;</span>,orderNo);
</span></span><span style="display:flex;"><span>            map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;oneYearVipPrice&#34;</span>,PayConstant.<span style="color:#007f7f">pad</span><span style="color:#f00">ç«¯ä¸€å¹´å­¦ä¹ æƒç›Šä»·æ ¼</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> map;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¼‚æ­¥å›è°ƒ</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * @author: wjy
</span></span><span style="display:flex;"><span> * @description: å¾®ä¿¡æ‰«ç æ”¯ä»˜å¼‚æ­¥å›è°ƒ
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@PostMapping(&#34;padBuyVipWxPayCallback&#34;)
</span></span><span style="display:flex;"><span>public void padBuyVipWxPayCallback(HttpServletRequest request,HttpServletResponse response) throws Exception {
</span></span><span style="display:flex;"><span>	log.info(
</span></span><span style="display:flex;"><span>	&#34;\n***************************************&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>		&#34;start padBuyVipWxPayCallback&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>		&#34;å¾®ä¿¡æ‰«ç æ”¯ä»˜å¼‚æ­¥å›è°ƒ&#34; + &#34;\n&#34; +
</span></span><span style="display:flex;"><span>		&#34;\n********************************************&#34;
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		ByteArrayOutputStream outSteam = new ByteArrayOutputStream();
</span></span><span style="display:flex;"><span>		InputStream inStream = request.getInputStream();
</span></span><span style="display:flex;"><span>		byte[] buffer = new byte[1024];
</span></span><span style="display:flex;"><span>		int len = 0;
</span></span><span style="display:flex;"><span>		while ((len = inStream.read(buffer)) != -1) {
</span></span><span style="display:flex;"><span>			outSteam.write(buffer, 0, len);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		outSteam.close();
</span></span><span style="display:flex;"><span>		inStream.close();
</span></span><span style="display:flex;"><span>		String result = new String(outSteam.toByteArray(), PayConstant.DEFAULT_CHARSET);
</span></span><span style="display:flex;"><span>		log.info(&#34;***************************************å¾®ä¿¡è¿”å›ç»“æœxml:&#34; + result + &#34;********************************************&#34;);
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; resultMap = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>		String out_trade_no = &#34;&#34;;
</span></span><span style="display:flex;"><span>		if (!StringUtils.isEmpty(result)) {
</span></span><span style="display:flex;"><span>			//å°†å¾®ä¿¡è¿”å›çš„xmlè½¬æˆmap
</span></span><span style="display:flex;"><span>			Map&lt;String, String&gt; map = WXPayUtil.xmlToMap(result);
</span></span><span style="display:flex;"><span>			//éªŒç­¾
</span></span><span style="display:flex;"><span>			if (WXPayUtil.isSignatureValid(map, PayConstant.WX_H5_APP_KEY, WXPayConstants.SignType.MD5)) {
</span></span><span style="display:flex;"><span>				String attach = map.get(&#34;attach&#34;);
</span></span><span style="display:flex;"><span>				log.info(&#34;***************************************å¾®ä¿¡è‡ªå®šä¹‰å‚æ•°:&#34; + attach + &#34;********************************************&#34;);
</span></span><span style="display:flex;"><span>				log.info(&#34;***************************************å•†æˆ·è®¢å•å·:&#34; + map.get(&#34;out_trade_no&#34;) + &#34;******************************&#34;);
</span></span><span style="display:flex;"><span>				out_trade_no = map.get(&#34;out_trade_no&#34;);
</span></span><span style="display:flex;"><span>			} else {
</span></span><span style="display:flex;"><span>				resultMap.put(&#34;return_code&#34;, &#34;FAIL&#34;);
</span></span><span style="display:flex;"><span>				resultMap.put(&#34;return_msg&#34;, &#34;éªŒç­¾å¤±è´¥&#34;);
</span></span><span style="display:flex;"><span>				response.getWriter().write(WXPayUtil.mapToXml(map));
</span></span><span style="display:flex;"><span>				response.getWriter().flush();
</span></span><span style="display:flex;"><span>				response.getWriter().close();
</span></span><span style="display:flex;"><span>				return;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		String finalOut_trade_no = out_trade_no;
</span></span><span style="display:flex;"><span>		executorService.execute(() -&gt; {
</span></span><span style="display:flex;"><span>			payService.padBuyVipCallback(finalOut_trade_no);
</span></span><span style="display:flex;"><span>		});
</span></span><span style="display:flex;"><span>		// å¦‚æœç­¾åéªŒè¯æ­£ç¡®ï¼Œç«‹å³è¿”å›successï¼Œåç»­ä¸šåŠ¡å¦èµ·çº¿ç¨‹å•ç‹¬å¤„ç†
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>		map.put(&#34;return_code&#34;, &#34;SUCCESS&#34;);
</span></span><span style="display:flex;"><span>		response.getWriter().write(WXPayUtil.mapToXml(map));
</span></span><span style="display:flex;"><span>		response.getWriter().flush();
</span></span><span style="display:flex;"><span>		response.getWriter().close();
</span></span><span style="display:flex;"><span>	} catch (Exception e) {
</span></span><span style="display:flex;"><span>		e.printStackTrace();
</span></span><span style="display:flex;"><span>		Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>		map.put(&#34;return_code&#34;, &#34;FAIL&#34;);
</span></span><span style="display:flex;"><span>		map.put(&#34;return_msg&#34;, &#34;ä¸šåŠ¡å¤„ç†å¤±è´¥&#34;);
</span></span><span style="display:flex;"><span>		response.getWriter().write(WXPayUtil.mapToXml(map));
</span></span><span style="display:flex;"><span>		response.getWriter().flush();
</span></span><span style="display:flex;"><span>		response.getWriter().close();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="æ”¯ä»˜å®æ”¯ä»˜">æ”¯ä»˜å®æ”¯ä»˜<a hidden class="anchor" aria-hidden="true" href="#æ”¯ä»˜å®æ”¯ä»˜">#</a></h1>
<h2 id="æ”¯ä»˜å®appæ”¯ä»˜">æ”¯ä»˜å®appæ”¯ä»˜<a hidden class="anchor" aria-hidden="true" href="#æ”¯ä»˜å®appæ”¯ä»˜">#</a></h2>
<p><a href="https://docs.open.alipay.com/204">å®˜æ–¹æ–‡æ¡£</a>
æ”¯ä»˜å®çš„æ–‡æ¡£çœŸçš„ä¸€ç›®äº†ç„¶ï¼Œæ¯”å¾®ä¿¡å¼ºå¤ªå¤š&hellip;
<a href="https://blog.csdn.net/shuaishuaidewo/article/details/88641913">å‚è€ƒ</a></p>
<h2 id="æ”¯ä»˜å®-æ‰‹æœºç½‘ç«™æ”¯ä»˜">æ”¯ä»˜å®-æ‰‹æœºç½‘ç«™æ”¯ä»˜<a hidden class="anchor" aria-hidden="true" href="#æ”¯ä»˜å®-æ‰‹æœºç½‘ç«™æ”¯ä»˜">#</a></h2>
<p><a href="https://opendocs.alipay.com/open/203/105288">æ‰‹æœºç½‘ç«™æ”¯ä»˜å®˜æ–¹æ–‡æ¡£</a>
ä¸€å®šè¦ä»”ç»†çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œæ ¹æ®æ–‡æ¡£æç¤ºï¼Œä¸€æ­¥ä¸€æ­¥æ¥ã€‚
éœ€è¦æ³¨æ„çš„æ˜¯å®˜æ–¹æ–‡æ¡£çš„è¿™å¥è¯ï¼š
æ”¯ä»˜å®ä¼šä¸ºå¼€å‘è€…ç”Ÿæˆå‰å°é¡µé¢è¯·æ±‚éœ€è¦çš„å®Œæ•´ form è¡¨å•çš„ htmlï¼ˆåŒ…å«è‡ªåŠ¨æäº¤è„šæœ¬ï¼‰ï¼Œå•†å®¶ç›´æ¥å°†è¿™ä¸ªè¡¨å•çš„ String è¾“å‡ºåˆ° http response ä¸­å³å¯ã€‚
å°±æ˜¯è¯´åå°è¯·æ±‚æ”¯ä»˜å®æ¥å£åï¼Œæ”¯ä»˜å®ä¼šè¿”å›ä¸€ä¸ªè¡¨å•å­—ç¬¦ä¸²ï¼Œç±»ä¼¼è¿™ç§ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;form name=&#34;punchout_form&#34; method=&#34;post&#34;
</span></span><span style="display:flex;"><span> action=&#34;https://openapi.alipay.com/gateway.do?charset=GBK&amp;method=alipay.trade.wap.pay&amp;sign=XXXXXXXX&#34;&gt;
</span></span><span style="display:flex;"><span> &lt;input type=&#34;hidden&#34; name=&#34;biz_content&#34; value=&#34;{&amp;quot;out_trade_no&amp;quot;:&amp;quot;468281ee-cc38-4a83-96f9-608538b80799&amp;quot;,&amp;quot;total_amount&amp;quot;:0.01,&amp;quot;subject&amp;quot;:&amp;quot;biaoti&amp;quot;,&amp;quot;product_code&amp;quot;:&amp;quot;QUICK_WAP_WAY&amp;quot;}&#34;&gt;
</span></span><span style="display:flex;"><span> &lt;input type=&#34;submit&#34; value=&#34;ç«‹å³æ”¯ä»˜&#34; style=&#34;display:none&#34; &gt;
</span></span><span style="display:flex;"><span>&lt;/form&gt;
</span></span><span style="display:flex;"><span> &lt;script&gt;
</span></span><span style="display:flex;"><span>  document.forms[0].submit();
</span></span><span style="display:flex;"><span> &lt;/script&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬æŠŠè¿™ä¸ªè¡¨å•ç›´æ¥è¿”å›ç»™å‰ç«¯ï¼Œè®©å‰ç«¯ç›´æ¥å±•ç¤ºå°±å¯ä»¥æ‹‰èµ·æ”¯ä»˜å®çš„æ”¯ä»˜ç•Œé¢äº†ã€‚æ˜¯ä¸éœ€è¦é¢„æ”¯ä»˜çš„ã€‚
éœ€è¦æ³¨æ„ï¼šè¿™æ®µhtmlä»£ç è¿”å›ç»™å‰ç«¯æ—¶ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œ1æ˜¯é€šè¿‡<code>HttpServletResponse</code>è¿”å›ç»™å‰ç«¯ï¼Œ2æ˜¯ç›´æ¥å°†å­—ç¬¦ä¸²è¿”å›ç»™å‰ç«¯ï¼Œè€Œä¸èƒ½é€šè¿‡å¸¦keyçš„ json è¿”å›ç»™å‰ç«¯ï¼Œå› ä¸ºå¸¦ key çš„ jsonå€¼æ˜¯å¸¦åŒå¼•å·çš„ï¼Œè€Œè¡¨å•é‡Œä¹Ÿæœ‰åŒå¼•å·ï¼Œæ‰€ä»¥è¡¨å•é‡Œçš„åŒå¼•å·å‰ç«¯ä¼šè‡ªåŠ¨å¸¦ä¸Š<code>/</code> è½¬ä¹‰ç¬¦ï¼Œå¯¼è‡´å‰ç«¯æ— æ³•è¯†åˆ«ã€‚</p>
<p>å¦å¤–ï¼Œé€šè¿‡è¿™ä¸ªç½‘é¡µï¼šhttps://www.w3school.com.cn/tiy/t.asp?f=eg_html_basic</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨çº¿é¢„è§ˆhtmlçš„æ ·å¼ï¼Œæ‰€ä»¥å¯ä»¥æŠŠæ”¯ä»˜å®è¿”å›çš„formè¡¨å•ç›´æ¥æ”¾åˆ°è¿™ä¸ªç½‘é¡µä¸Šï¼Œå¯ä»¥çœ‹åˆ°æ”¯ä»˜å®çš„æ”¯ä»˜é¡µçš„æ•ˆæœã€‚æ³¨æ„ï¼šéœ€è¦å»æ‰è¡¨å•ä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼Œä¾‹å¦‚<code>\</code></p>
<h2 id="æ”¯ä»˜å®æ‰«ç æ”¯ä»˜å½“é¢ä»˜">æ”¯ä»˜å®æ‰«ç æ”¯ä»˜ï¼ˆå½“é¢ä»˜ï¼‰<a hidden class="anchor" aria-hidden="true" href="#æ”¯ä»˜å®æ‰«ç æ”¯ä»˜å½“é¢ä»˜">#</a></h2>
<p>æ‰«ç æ”¯ä»˜å±äºæ”¯ä»˜å®<code>å½“é¢ä»˜</code>çš„ä¸€ç§ï¼Œéœ€è¦å•†æˆ·åœ¨è‡ªå·±çš„æœåŠ¡å™¨ç”Ÿæˆæ”¯ä»˜äºŒç»´ç ï¼Œç”¨æˆ·æ‰«ç ï¼Œå®Œæˆæ”¯ä»˜ï¼Œå¹¶ä¸æ˜¯æ”¯ä»˜å®çš„webç½‘é¡µæ”¯ä»˜ã€‚
<a href="https://opendocs.alipay.com/open/194/105072">å‚è€ƒå®˜æ–¹æ–‡æ¡£</a></p>
<p>é¦–å…ˆç™»å½•<a href="https://open.alipay.com/platform/home.htm">æ”¯ä»˜å®å¼€æ”¾å¹³å°</a>
å‚è€ƒ<a href="https://opendocs.alipay.com/open/200/105310">å®˜æ–¹æµç¨‹</a>åˆ›å»ºå¹¶é…ç½®åº”ç”¨ã€‚
åˆ›å»ºåº”ç”¨-&gt;ç½‘é¡µ&amp;ç§»åŠ¨åº”ç”¨-&gt;æ”¯ä»˜æ¥å…¥-&gt;ç½‘é¡µåº”ç”¨
ç½‘å€å’Œåº”ç”¨ç®€ä»‹å¯ä»¥ä¸å¡«ï¼Œç„¶åå¼€å§‹é…ç½®åº”ç”¨ç¯å¢ƒã€‚
æ¥å£åŠ ç­¾æ–¹å¼ï¼šå¿…å¡«ï¼Œ<a href="https://opendocs.alipay.com/open/291/105971#LDsXr">å‚è€ƒå®˜æ–¹æ–‡æ¡£å¡«å†™</a>
æ¨èä½¿ç”¨<a href="https://miniu.alipay.com/keytool/create">å®˜æ–¹å¯†é’¥ç”Ÿæˆå·¥å…·</a>
ç‚¹å‡»ç”Ÿæˆå¯†é’¥ï¼Œä¼šç”Ÿæˆ<code>åº”ç”¨ç§é’¥</code>å’Œ<code>åº”ç”¨å…¬é’¥</code>ã€‚åº”ç”¨ç§é’¥éœ€è¦å¦¥å–„ä¿å­˜åœ¨ä»£ç ä¸­ï¼Œä¸èƒ½æ³„éœ²ã€‚ç„¶åå¤åˆ¶åº”ç”¨å…¬é’¥ï¼Œå¡«å†™åˆ°å…¬é’¥å­—ç¬¦ä¸²ï¼Œç‚¹ç¡®å®šï¼Œä¼šåŒæ—¶ç”Ÿæˆ<code>æ”¯ä»˜å®å…¬é’¥</code>ï¼Œæ­¤æ—¶æŠŠæ”¯ä»˜å®å…¬é’¥å†™åˆ°ä»£ç ä¸­ï¼Œè€Œä¸æ˜¯åº”ç”¨å…¬é’¥ï¼Œæ³¨æ„ï¼šä»£ç ä¸­è¦ä½¿ç”¨<code>åº”ç”¨ç§é’¥</code>å’Œ<code>æ”¯ä»˜å®å…¬é’¥</code>ï¼Œåº”ç”¨å…¬é’¥æ˜¯ç”Ÿæˆæ”¯ä»˜å®å…¬é’¥ç”¨çš„ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AlipayConfig {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ”¯ä»˜å®ç½‘å…³ï¼ˆå›ºå®šï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String GATEWAY_URL = <span style="color:#0ff;font-weight:bold">&#34;https://openapi.alipay.com/gateway.do&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ”¯ä»˜å®appIdï¼ŒAPPID å³åˆ›å»ºåº”ç”¨åç”Ÿæˆ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String ALI_APP_ID = <span style="color:#0ff;font-weight:bold">&#34;2019080666125207&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å•†æˆ·çš„ç§é’¥,ä½¿ç”¨æ”¯ä»˜å®è‡ªå¸¦çš„opensslå·¥å…·ç”Ÿæˆã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String ALI_APP_PRIVATE_KEY = <span style="color:#0ff;font-weight:bold">&#34;ä½ çš„ç§é’¥&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åº”ç”¨çš„å…¬é’¥ï¼Œæ— éœ€ä¿®æ”¹è¯¥å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String ali_public_key = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ”¯ä»˜å®çš„å…¬é’¥ï¼Œå»open.alipay.comå¯¹åº”åº”ç”¨ä¸‹æŸ¥çœ‹ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String ALIPAY_PUBLIC_KEY=<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å­—ç¬¦ç¼–ç æ ¼å¼ ç›®å‰æ”¯æŒ gbk æˆ– utf-8
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String input_charset = <span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å‚æ•°è¿”å›æ ¼å¼ï¼Œåªæ”¯æŒ json
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String FORMAT = <span style="color:#0ff;font-weight:bold">&#34;json&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å•†æˆ·ç”Ÿæˆç­¾åå­—ç¬¦ä¸²æ‰€ä½¿ç”¨çš„ç­¾åç®—æ³•ç±»å‹ï¼Œç›®å‰æ”¯æŒ RSA2 å’Œ RSAï¼Œæ¨èä½¿ç”¨ RSA2
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String SIGN_TYPE = <span style="color:#0ff;font-weight:bold">&#34;RSA2&#34;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>service</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public interface AlipayService {
</span></span><span style="display:flex;"><span>    String prePayAndGetQrcode();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ç°ç±»</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span>@Slf4j
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AliPayServiceImpl <span style="color:#fff;font-weight:bold">implements</span> AlipayService {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> AlipayClient alipayClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init() {
</span></span><span style="display:flex;"><span>        alipayClient = <span style="color:#fff;font-weight:bold">new</span> DefaultAlipayClient(
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">GATEWAY_URL</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">ALI_APP_ID</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">ALI_APP_PRIVATE_KEY</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">FORMAT</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">ALIPAY_PUBLIC_KEY</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">SIGN_TYPE</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * é¢„æ”¯ä»˜ï¼Œå¹¶ç”Ÿæˆæ”¯ä»˜äºŒç»´ç 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String prePayAndGetQrcode() {
</span></span><span style="display:flex;"><span>        String orderNo = OrderCodeFactory.<span style="color:#007f7f">getOrderCode</span>(<span style="color:#ff0;font-weight:bold">675</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;é¢„æ”¯ä»˜ï¼Œå¹¶ç”Ÿæˆæ”¯ä»˜äºŒç»´ç &#34;</span>);
</span></span><span style="display:flex;"><span>        AlipayTradePrecreateRequest request = <span style="color:#fff;font-weight:bold">new</span> AlipayTradePrecreateRequest();
</span></span><span style="display:flex;"><span>        AlipayTradePrecreateModel model = <span style="color:#fff;font-weight:bold">new</span> AlipayTradePrecreateModel();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setSubject</span>(<span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜æµ‹è¯•&#34;</span>);
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setOutTradeNo</span>(orderNo);
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setTimeoutExpress</span>(<span style="color:#0ff;font-weight:bold">&#34;30m&#34;</span>);
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setTotalAmount</span>(MoneyUtil.<span style="color:#007f7f">fen2Yuan</span>(<span style="color:#ff0;font-weight:bold">1</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        request.<span style="color:#007f7f">setBizModel</span>(model);
</span></span><span style="display:flex;"><span>        request.<span style="color:#007f7f">setNotifyUrl</span>(PayConstant.<span style="color:#007f7f">ALI_NOTIFY_URL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        AlipayTradePrecreateResponse response;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ³¨æ„ï¼Œè¿™é‡Œæ˜¯executeï¼Œè€Œä¸æ˜¯sdkExecuteï¼Œå’Œappæ”¯ä»˜ä¸åŒ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            response = alipayClient.<span style="color:#007f7f">execute</span>(request);
</span></span><span style="display:flex;"><span>            String qr_code = response.<span style="color:#007f7f">getQrCode</span>();
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;qr_codeæ˜¯ï¼š&#34;</span> + qr_code);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¯ä»¥å°†äºŒç»´ç ç”Ÿæˆåˆ°æœ¬åœ°ï¼Œä¹Ÿå¯ä»¥å°†qr_codeå­—ç¬¦ä¸²è¿”å›ç»™å‰ç«¯ï¼Œè®©å‰ç«¯ç”Ÿæˆ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            String filePath = String.format(&#34;C:\\Users\\wjy\\Desktop\\qr-%s.png&#34;, response.getOutTradeNo());
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            log.info(&#34;filePath:&#34; + filePath);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            ZxingUtils.getQRCodeImge(response.getQrCode(), 256, filePath);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        } <span style="color:#fff;font-weight:bold">catch</span> (AlipayApiException e) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜å®æ”¯ä»˜å¤±è´¥{}&#34;</span>, e.<span style="color:#007f7f">getErrMsg</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ServiceException(e.<span style="color:#007f7f">getErrMsg</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (response.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;è°ƒç”¨æˆåŠŸ&#34;</span> + response.<span style="color:#007f7f">getBody</span>());
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//æŠŠäºŒç»´ç å­—ç¬¦ä¸²è¿”å›ç»™å‰ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> response.<span style="color:#007f7f">getQrCode</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;è°ƒç”¨å¤±è´¥&#34;</span> + response.<span style="color:#007f7f">getBody</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¹Ÿå¯ä»¥ä½¿ç”¨[æ²™ç®±ç¯å¢ƒ]æµ‹è¯•(<a href="https://opendocs.alipay.com/open/200/105311">https://opendocs.alipay.com/open/200/105311</a>)</p>
<p>å›è°ƒæ–¹æ³•</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">93
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author: wjy
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @description: æ”¯ä»˜å®å¼‚æ­¥å›è°ƒåœ°å€ï¼Œæ‰«ç ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@ResponseBody
</span></span><span style="display:flex;"><span>@PostMapping(<span style="color:#0ff;font-weight:bold">&#34;padBuyVipAliPayCallback&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> String padBuyVipAliPayCallback(HttpServletRequest request) {
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//å°†å¼‚æ­¥é€šçŸ¥ä¸­æ”¶åˆ°çš„å¾…éªŒè¯æ‰€æœ‰å‚æ•°éƒ½å­˜æ”¾åˆ°mapä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	Map&lt;String, String&gt; params = convertRequestParamsToMap(request);
</span></span><span style="display:flex;"><span>	String paramsJson = JSON.<span style="color:#007f7f">toJSONString</span>(params);
</span></span><span style="display:flex;"><span>	log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜å®å›è°ƒï¼Œ{}&#34;</span>, paramsJson);
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// è°ƒç”¨SDKéªŒè¯ç­¾å
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">boolean</span> signVerified = AlipaySignature.<span style="color:#007f7f">rsaCheckV1</span>(params, PayConstant.<span style="color:#007f7f">ALIPAY_PUBLIC_KEY</span>,
</span></span><span style="display:flex;"><span>				PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>, PayConstant.<span style="color:#007f7f">SIGN_TYPE</span>);
</span></span><span style="display:flex;"><span>		log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;signVerified={}&#34;</span>, signVerified);
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">if</span> (!signVerified) {
</span></span><span style="display:flex;"><span>			log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜å®å›è°ƒç­¾åè®¤è¯å¤±è´¥, paramsJson:{}&#34;</span>, paramsJson);
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;failure&#34;</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜å®å›è°ƒç­¾åè®¤è¯æˆåŠŸ&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// æŒ‰ç…§æ”¯ä»˜ç»“æœå¼‚æ­¥é€šçŸ¥ä¸­çš„æè¿°ï¼Œå¯¹æ”¯ä»˜ç»“æœä¸­çš„ä¸šåŠ¡å†…å®¹è¿›è¡Œ1\2\3\4äºŒæ¬¡æ ¡éªŒï¼Œæ ¡éªŒæˆåŠŸååœ¨responseä¸­è¿”å›successï¼Œæ ¡éªŒå¤±è´¥è¿”å›failure
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		check(params);
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// å¦èµ·çº¿ç¨‹å¤„ç†ä¸šåŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;å¦èµ·çº¿ç¨‹å¤„ç†ä¸šåŠ¡&#34;</span>);
</span></span><span style="display:flex;"><span>		executorService.<span style="color:#007f7f">execute</span>(() -&gt; {
</span></span><span style="display:flex;"><span>			AlipayNotifyParam param = buildAlipayNotifyParam(params);
</span></span><span style="display:flex;"><span>			String tradeStatus = param.<span style="color:#007f7f">getTradeStatus</span>();
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">// æ”¯ä»˜æˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			<span style="color:#fff;font-weight:bold">if</span> (tradeStatus.<span style="color:#007f7f">equals</span>(<span style="color:#0ff;font-weight:bold">&#34;TRADE_SUCCESS&#34;</span>)) {
</span></span><span style="display:flex;"><span>				log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜æˆåŠŸ&#34;</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#007f7f">//TODO æ”¯ä»˜æˆåŠŸå›è°ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>				alipayService.<span style="color:#007f7f">padBuyVipCallback</span>(param.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>			} <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>				log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜å¤±è´¥&#34;</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#007f7f">//TODO ç”¨æˆ·å¤„ç†è‡ªå·±é€»è¾‘
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			}
</span></span><span style="display:flex;"><span>		});
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// å¦‚æœç­¾åéªŒè¯æ­£ç¡®ï¼Œç«‹å³è¿”å›successï¼Œåç»­ä¸šåŠ¡å¦èµ·çº¿ç¨‹å•ç‹¬å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;success&#34;</span>;
</span></span><span style="display:flex;"><span>	} <span style="color:#fff;font-weight:bold">catch</span> (AlipayApiException e) {
</span></span><span style="display:flex;"><span>		log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜å®å›è°ƒå‘ç”Ÿå¼‚å¸¸{}&#34;</span>, e.<span style="color:#007f7f">getLocalizedMessage</span>());
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;failure&#34;</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// å°†requestä¸­çš„å‚æ•°è½¬æ¢æˆMap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> Map&lt;String, String&gt; convertRequestParamsToMap(HttpServletRequest request) {
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; retMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//1.ä»æ”¯ä»˜å®å›è°ƒçš„requeståŸŸä¸­å–å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Map&lt;String, String[]&gt; requestParams = request.<span style="color:#007f7f">getParameterMap</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (Iterator&lt;String&gt; iter = requestParams.<span style="color:#007f7f">keySet</span>().<span style="color:#007f7f">iterator</span>(); iter.<span style="color:#007f7f">hasNext</span>(); ) {
</span></span><span style="display:flex;"><span>            String name = iter.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>            String[] values = requestParams.<span style="color:#007f7f">get</span>(name);
</span></span><span style="display:flex;"><span>            String valueStr = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; values.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>                valueStr = (i == values.<span style="color:#007f7f">length</span> - <span style="color:#ff0;font-weight:bold">1</span>) ? valueStr + values[i] : valueStr + values[i] + <span style="color:#0ff;font-weight:bold">&#34;,&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// ä¹±ç è§£å†³ï¼Œè¿™æ®µä»£ç åœ¨å‡ºç°ä¹±ç æ—¶ä½¿ç”¨ã€‚å¦‚æœmysignå’Œsignä¸ç›¸ç­‰ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™æ®µä»£ç è½¬åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// valueStr = new String(valueStr.getBytes(&#34;ISO-8859-1&#34;), &#34;gbk&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            retMap.<span style="color:#007f7f">put</span>(name, valueStr);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> retMap;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> AlipayNotifyParam buildAlipayNotifyParam(Map&lt;String, String&gt; params) {
</span></span><span style="display:flex;"><span>        String json = JSON.<span style="color:#007f7f">toJSONString</span>(params);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> JSON.<span style="color:#007f7f">parseObject</span>(json, AlipayNotifyParam.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">void</span> check(Map&lt;String, String&gt; params) <span style="color:#fff;font-weight:bold">throws</span> AlipayApiException {
</span></span><span style="display:flex;"><span>        String outTradeNo = params.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 1ã€å•†æˆ·éœ€è¦éªŒè¯è¯¥é€šçŸ¥æ•°æ®ä¸­çš„out_trade_noæ˜¯å¦ä¸ºå•†æˆ·ç³»ç»Ÿä¸­åˆ›å»ºçš„è®¢å•å·ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Orders order = <span style="color:#fff;font-weight:bold">new</span> Orders();
</span></span><span style="display:flex;"><span>        order.<span style="color:#007f7f">setOrderNo</span>(outTradeNo);
</span></span><span style="display:flex;"><span>        order = orderService.<span style="color:#007f7f">getOrderByOrderNo</span>(order);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (order == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AlipayApiException(<span style="color:#0ff;font-weight:bold">&#34;out_trade_noé”™è¯¯&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 2ã€åˆ¤æ–­total_amountæ˜¯å¦ç¡®å®ä¸ºè¯¥è®¢å•çš„å®é™…é‡‘é¢ï¼ˆå³å•†æˆ·è®¢å•åˆ›å»ºæ—¶çš„é‡‘é¢ï¼‰ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Integer totalAmount = MoneyUtil.<span style="color:#007f7f">yuan2Fen</span>(<span style="color:#fff;font-weight:bold">new</span> BigDecimal(params.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;total_amount&#34;</span>)));
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;totalAmount{}&#34;</span>, totalAmount);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!totalAmount.<span style="color:#007f7f">equals</span>(order.<span style="color:#007f7f">getOrderPrice</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AlipayApiException(<span style="color:#0ff;font-weight:bold">&#34;error total_amount&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 3ã€éªŒè¯app_idæ˜¯å¦ä¸ºè¯¥å•†æˆ·æœ¬èº«ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (!params.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;app_id&#34;</span>).<span style="color:#007f7f">equals</span>(PayConstant.<span style="color:#007f7f">ALI_APP_ID</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AlipayApiException(<span style="color:#0ff;font-weight:bold">&#34;app_idä¸ä¸€è‡´&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å¼‚æ­¥å›è°ƒå¼‚å¸¸é—®é¢˜">å¼‚æ­¥å›è°ƒå¼‚å¸¸é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#å¼‚æ­¥å›è°ƒå¼‚å¸¸é—®é¢˜">#</a></h2>
<ul>
<li>æ£€æŸ¥é¢„æ”¯ä»˜æ—¶ï¼Œ<code>request.setNotifyUrl(PayConstant.ALI_NOTIFY_URL);</code>ï¼Œæ˜¯å¦è®¾ç½®æ­£ç¡®</li>
<li>æ£€æŸ¥æ˜¯å¦é¡¹ç›®çš„æ¥å£æœ‰è®¿é—®é™åˆ¶ã€‚æ¯”å¦‚ç³»ç»Ÿåšäº†ç™»å½•æ‹¦æˆª</li>
<li>æ£€æŸ¥æ¥å£æ˜¯å¦å¯ä»¥å…¬ç½‘è®¿é—®</li>
</ul>
<p>é€šè¿‡<a href="https://opendocs.alipay.com/open/194/103296">å¼‚æ­¥é€šçŸ¥å®˜æ–¹æ–‡æ¡£</a>æ’æŸ¥é—®é¢˜ã€‚
é€šè¿‡<a href="https://openmonitor.alipay.com/acceptance/cloudparse.htm">èš‚èšé‡‘æœå¼€å‘å¹³å°</a>æ’æŸ¥é—®é¢˜ã€‚</p>
<p>æ³¨æ„ï¼šæ”¯ä»˜ç åªèƒ½ä¸€ä¸ªäººæ‰«ï¼Œå¦‚æœå¤šä¸ªäººæ‰«ä¸€ä¸ªç ï¼Œåæ‰«ç çš„äººï¼Œä¼šæç¤º<code>äº¤æ˜“ä¹°å®¶ä¸åŒ¹é…</code>ã€‚</p>
<h3 id="ä¸€å¹´åæ”¶åˆ°æ”¯ä»˜å®çš„å¼‚æ­¥å›è°ƒé€šçŸ¥">ä¸€å¹´åæ”¶åˆ°æ”¯ä»˜å®çš„å¼‚æ­¥å›è°ƒé€šçŸ¥<a hidden class="anchor" aria-hidden="true" href="#ä¸€å¹´åæ”¶åˆ°æ”¯ä»˜å®çš„å¼‚æ­¥å›è°ƒé€šçŸ¥">#</a></h3>
<p>æœåŠ¡å™¨æ”¶åˆ°äº†ä¸€å¹´å‰æ”¯ä»˜æˆåŠŸè®¢å•çš„å¼‚æ­¥å›è°ƒé€šçŸ¥ï¼Œè¿˜å¥½åé¢çš„é€»è¾‘æœ‰å¯¹è®¢å•çŠ¶æ€è¿›è¡Œæ ¡éªŒï¼Œæ‰€ä»¥æ²¡æœ‰æµç¨‹ä¸Šçš„æ¼æ´ã€‚</p>
<p>æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š</p>
<p><a href="https://opendocs.alipay.com/open/203/105286?pathHash=022a439c#%E9%80%9A%E7%9F%A5%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6">https://opendocs.alipay.com/open/203/105286?pathHash=022a439c#%E9%80%9A%E7%9F%A5%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6</a></p>
<p><a href="https://opendocs.alipay.com/support/01ray9">https://opendocs.alipay.com/support/01ray9</a></p>
<p>å·²çŸ¥æ”¯ä»˜å®ä¼šåœ¨TRADE_FINISHEDã€TRADE_SUCCESSå’ŒTRADE_CLOSEDä¸‰ç§æƒ…å†µä¸‹å‡ºå‘å¼‚æ­¥é€šçŸ¥ï¼Œé€šè¿‡åˆ†ææ”¯ä»˜å®å‘é€çš„æŠ¥æ–‡ï¼š</p>
<p><code>trade_status=TRADE_FINISHED&amp;refund_fee=0.00</code>ï¼Œå¾—çŸ¥é€šçŸ¥ç±»å‹ä¸ºTRADE_FINISHEDã€‚</p>
<p>TRADE_FINISHED çš„é€šçŸ¥è§¦å‘æ¡ä»¶æ˜¯ï¼š
ä¸€ã€å•†æˆ·ç­¾çº¦çš„äº§å“ä¸æ”¯æŒé€€æ¬¾åŠŸèƒ½çš„å‰æä¸‹ï¼Œä¹°å®¶ä»˜æ¬¾æˆåŠŸï¼›
äºŒã€å•†æˆ·ç­¾çº¦çš„äº§å“æ”¯æŒé€€æ¬¾åŠŸèƒ½çš„å‰æä¸‹ï¼Œäº¤æ˜“å·²ç»æˆåŠŸå¹¶ä¸”å·²ç»è¶…è¿‡å¯é€€æ¬¾æœŸé™ã€‚
æ‰€ä»¥è¿™ç§æƒ…å†µå±äºTRADE_FINISHEDçš„ç¬¬äºŒç§ã€‚</p>
<p>æŸ¥éªŒåå°è®¾ç½®çš„å¯é€€æ¬¾æœŸé™ï¼š<strong>ä¸€å¹´</strong></p>
<p>æ‰€ä»¥è¿™å¹¶ä¸æ˜¯æ”¯ä»˜æˆåŠŸçš„å¼‚æ­¥é€šçŸ¥ï¼Œè€Œæ˜¯<code>äº¤æ˜“å·²ç»æˆåŠŸå¹¶ä¸”å·²ç»è¶…è¿‡å¯é€€æ¬¾æœŸé™</code>çš„å¼‚æ­¥é€šçŸ¥ã€‚</p>
<p>æ”¯ä»˜å®æ–¹é¢çš„é—®é¢˜ï¼š</p>
<ol>
<li><code>alipay.trade.refund</code> <a href="https://link.segmentfault.com/?enc=8ys3UWusjx0hxFxd4%2BYZXw%3D%3D.MtOKOgMQVXIHIrl1yx835epiLI0X8AEloW2RPwNYD%2FJtpRYImRkfmbT1HrU8saTq0UbT%2BNH%2Fg90tK6S50xB4UA%3D%3D">ç»Ÿä¸€æ”¶å•äº¤æ˜“é€€æ¬¾æ¥å£</a> æ²¡æœ‰æåŠé€€æ¬¾å­˜åœ¨å›è°ƒçš„æƒ…å†µã€‚è€Œäº‹å®ä¸Šé€€æ¬¾ä¹‹å(æ— è®ºæ˜¯å…¨é¢è¿˜æ˜¯éƒ¨åˆ†)ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡å¼‚æ­¥é€šçŸ¥</li>
<li>æ”¯ä»˜å®çš„å›è°ƒé€šçŸ¥æ•°æ®ç»“æ„éå¸¸åƒï¼Œå¦‚æœè¿™æ¬¡æˆ‘ä»¬ä¸æ˜¯åœ¨è‡ªèº«çš„è®¢å•çŠ¶æ€ä¸Šé¢„å…ˆåšåˆ¤æ–­ï¼Œå¯èƒ½è¿™æ¬¡æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜ä¼šå¯¼è‡´è´¢åŠ¡é£é™©</li>
</ol>
<p>æœ¬éƒ¨åˆ†å‚è€ƒï¼šhttps://segmentfault.com/a/1190000040058734</p>
<h1 id="è‹¹æœæ”¯ä»˜">è‹¹æœæ”¯ä»˜<a hidden class="anchor" aria-hidden="true" href="#è‹¹æœæ”¯ä»˜">#</a></h1>
<p><a href="https://developer.apple.com/library/archive/releasenotes/General/ValidateAppStoreReceipt/Chapters/ValidateRemotely.html#//apple_ref/doc/uid/TP40010573-CH104-SW4">è‹¹æœæ”¯ä»˜å®˜æ–¹æ–‡æ¡£</a>
åªè¦ä½ åœ¨è‹¹æœç³»ç»Ÿè´­ä¹°APPä¸­è™šæ‹Ÿç‰©å“ï¼ˆè™šæ‹Ÿè´§å¸ï¼ŒVIPå……å€¼ç­‰ï¼‰ï¼Œå¿…é¡»é€šè¿‡å†…è´­æ–¹å¼è¿›è¡Œæ”¯ä»˜ï¼Œè‹¹æœå’Œå•†å®¶è¿›è¡Œä¸‰ä¸ƒå¼€ã€‚
<img loading="lazy" src="5.png" alt=""  />
</p>
<p>å’Œæ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ä¸åŒï¼Œå”¤èµ·æ”¯ä»˜åˆ°ä»˜æ¬¾å®Œæˆï¼Œè¿™ä¸ªåŠ¨ä½œï¼Œéƒ½æ˜¯ç”±å‰ç«¯è‡ªå·±å¤„ç†å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦åœ¨æ”¯ä»˜å‰é€šè¿‡æœåŠ¡ç«¯æ‹¿åˆ°ç­¾åç­‰ä¿¡æ¯ã€‚
æ”¯ä»˜æˆåŠŸåï¼Œè‹¹æœæœåŠ¡å™¨ä¼šç»™å‰ç«¯ä¸€ä¸²ä¸œè¥¿ï¼Œå‰ç«¯å†æŠŠè¿™ä¸²ä¸œè¥¿ï¼Œä¼ ç»™è‡ªå·±çš„æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ‹¿åˆ°è¿™ä¸²ä¸œè¥¿å†åˆ°è‹¹æœæœåŠ¡å™¨éªŒè¯ï¼Œæ ¹æ®è¿”å›å†…å®¹éªŒè¯æ˜¯å¦é€šè¿‡ï¼Œå¦‚æœé€šè¿‡è¯æ˜å‰ç«¯æ˜¯çœŸçš„æœ‰æ”¯ä»˜å‘ç”Ÿã€‚æœåŠ¡ç«¯æ ¹æ®å’Œå‰ç«¯çº¦å®šå¥½çš„æ”¯ä»˜å†…å®¹è§£æè·å–è‡ªå·±çš„æ•°æ®ï¼Œå¤„ç†è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘å°±å¯ä»¥äº†ã€‚</p>
<p>éœ€è¦æ³¨æ„ï¼š<code>TransactionID</code>æ˜¯å‰ç«¯å‘è‹¹æœæŸ¥è¯¢<code>product_id</code>æ˜¯å¦å­˜åœ¨æ—¶ï¼Œè‹¹æœå°±æŠŠ<code>TransactionID</code>è¿”å›ç»™å‰ç«¯äº†ã€‚è¯¥å‚æ•°å¿…é¡»ç”±å‰ç«¯ä¼ è¿‡æ¥ã€‚åç«¯é€šè¿‡è¯¥å‚æ•°éªŒè¯è®¢å•çš„æ­£ç¡®æƒ…å†µã€‚å‰ç«¯æ”¯ä»˜æˆåŠŸåï¼Œæ‹¿åˆ°å‚æ•°ï¼š{&ldquo;receipt-data&rdquo; : &ldquo;MIIVDAYJKoZIhvcNAQcCoIIU/T&hellip;&quot;}ï¼Œå°†å‚æ•°ä¼ ç»™æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨ï¼Œç”±æˆ‘ä»¬å‘è‹¹æœæœåŠ¡å™¨å‘é€postè¯·æ±‚ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RequestMapping(value = <span style="color:#0ff;font-weight:bold">&#34;/apple/verify&#34;</span>, method = RequestMethod.<span style="color:#007f7f">POST</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> BaseResponse&lt;Object&gt; appleVerify(String data) {
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//data = {&#34;receipt-data&#34; : &#34;MIIVDAYJKoZIhvcNAQcCoIIU/T...&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">// è‹¹æœæ”¯ä»˜æ²™ç®±éªŒè¯åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	String url = <span style="color:#0ff;font-weight:bold">&#34;https://sandbox.itunes.apple.com/verifyReceipt&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// è‹¹æœæ”¯ä»˜æ­£å¼éªŒè¯åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">// String url = &#34;https://buy.itunes.apple.com/verifyReceipt&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	JSONObject param = JSON.<span style="color:#007f7f">parseObject</span>(data);
</span></span><span style="display:flex;"><span>	JSONObject result = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">sendPost</span>(url, param);
</span></span><span style="display:flex;"><span>	log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;order apple notify result: {}&#34;</span>, result);
</span></span><span style="display:flex;"><span>	Integer status = result.<span style="color:#007f7f">getInteger</span>(<span style="color:#0ff;font-weight:bold">&#34;status&#34;</span>);<span style="color:#007f7f">//0 æˆåŠŸçš„
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//å¤„ç†è‡ªå·±çš„è®¢å•ä¸šåŠ¡é€»è¾‘
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> BaseResponse&lt;Object&gt;(status == <span style="color:#ff0;font-weight:bold">0</span> ? <span style="color:#0ff;font-weight:bold">&#34;SUCCESS&#34;</span> : <span style="color:#0ff;font-weight:bold">&#34;FAIL&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>statusçŠ¶æ€ç </p>
<ul>
<li>0 SUCCESS</li>
<li>21000 App Storeä¸èƒ½è¯»å–ä½ æä¾›çš„JSONå¯¹è±¡</li>
<li>21002 receipt-dataåŸŸçš„æ•°æ®æœ‰é—®é¢˜</li>
<li>21003 receiptæ— æ³•é€šè¿‡éªŒè¯</li>
<li>21004 æä¾›çš„shared secretä¸åŒ¹é…ä½ è´¦å·ä¸­çš„shared secret</li>
<li>21005 receiptæœåŠ¡å™¨å½“å‰ä¸å¯ç”¨</li>
<li>21006 receiptåˆæ³•ï¼Œä½†æ˜¯è®¢é˜…å·²è¿‡æœŸã€‚æœåŠ¡å™¨æ¥æ”¶åˆ°è¿™ä¸ªçŠ¶æ€ç æ—¶ï¼Œreceiptæ•°æ®ä»ç„¶ä¼šè§£ç å¹¶ä¸€èµ·å‘é€</li>
<li>21007 receiptæ˜¯Sandbox receiptï¼Œä½†å´å‘é€è‡³ç”Ÿäº§ç³»ç»Ÿçš„éªŒè¯æœåŠ¡</li>
<li>21008 receiptæ˜¯ç”Ÿäº§receiptï¼Œä½†å´å‘é€è‡³Sandboxç¯å¢ƒçš„éªŒè¯æœåŠ¡</li>
</ul>
<p>statusä¸º0(æˆåŠŸ)æ—¶ï¼Œè¿”å›çš„æ•°æ®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;environment&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Sandbox&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;receipt&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;in_app&#34;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;transaction_id&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1000000514154331&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;original_purchase_date&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 06:40:18 Etc/GMT&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;quantity&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;original_transaction_id&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1000000514154331&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;purchase_date_pst&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-27 23:40:18 America/Los_Angeles&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;original_purchase_date_ms&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1553755218000&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;purchase_date_ms&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1553755218000&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;product_id&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;ERSHUAI18&#34;</span>,<span style="color:#007f7f">//18æ˜¯é’±ï¼Œå…·ä½“æ ¼å¼å’Œå‰ç«¯çº¦å®šã€‚æœåŠ¡ç«¯æŠŠçº¦å®šå­—ç¬¦ä¸²ï¼ˆERSHUAIï¼‰å»æ‰ï¼Œå‰©ä¸‹çš„æ•°å­—ï¼ˆ18ï¼‰å°±æ˜¯ä¸šåŠ¡é€»è¾‘éœ€è¦çš„é‡‘é¢
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="font-weight:bold">&#34;original_purchase_date_pst&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-27 23:40:18 America/Los_Angeles&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;is_trial_period&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;false&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&#34;purchase_date&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 06:40:18 Etc/GMT&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;adam_id&#34;</span>: <span style="color:#ff0;font-weight:bold">0</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;receipt_creation_date&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 08:21:40 Etc/GMT&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;original_application_version&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1.0&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;app_item_id&#34;</span>: <span style="color:#ff0;font-weight:bold">0</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;original_purchase_date_ms&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1375340400000&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;request_date_ms&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1553761302654&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;original_purchase_date_pst&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2013-08-01 00:00:00 America/Los_Angeles&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;original_purchase_date&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2013-08-01 07:00:00 Etc/GMT&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;receipt_creation_date_pst&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 01:21:40 America/Los_Angeles&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;receipt_type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;ProductionSandbox&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;bundle_id&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.ershuai.blog&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;receipt_creation_date_ms&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1553761300000&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;request_date&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 08:21:42 Etc/GMT&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;version_external_identifier&#34;</span>: <span style="color:#ff0;font-weight:bold">0</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;request_date_pst&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;2019-03-28 01:21:42 America/Los_Angeles&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;download_id&#34;</span>: <span style="color:#ff0;font-weight:bold">0</span>,
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;application_version&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;1.0.1&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;status&#34;</span>: <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://www.jianshu.com/p/976fc6090cfa">å‚è€ƒ</a>
<a href="https://blog.csdn.net/shuai825644975/article/details/88872103">å‚è€ƒ</a>
<a href="https://blog.csdn.net/jianzhonghao/article/details/79343887">å‚è€ƒ</a></p>
<h1 id="ç­–ç•¥æ¨¡å¼å®ç°å¤šæ”¯ä»˜">ç­–ç•¥æ¨¡å¼å®ç°å¤šæ”¯ä»˜<a hidden class="anchor" aria-hidden="true" href="#ç­–ç•¥æ¨¡å¼å®ç°å¤šæ”¯ä»˜">#</a></h1>
<h2 id="è®¾è®¡æ€è·¯">è®¾è®¡æ€è·¯<a hidden class="anchor" aria-hidden="true" href="#è®¾è®¡æ€è·¯">#</a></h2>
<p>ç­–ç•¥æ¨¡å¼+å·¥å‚æ¨¡å¼ï¼Œå·¥å‚æ–¹æ³•ç”¨äºåˆ›å»ºä¸åŒåœºæ™¯ä¸‹çš„ç­–ç•¥ã€‚ç±»å›¾å¦‚ä¸‹ï¼š
<img loading="lazy" src="1.jpg" alt=""  />

ç­–ç•¥æ¥å£<code>IPayStrategy</code>å®šä¹‰äº†éœ€è¦å­ç±»å®ç°çš„æ–¹æ³• ï¼Œæ¯ä¸€ç§æ”¯ä»˜æ–¹å¼ä¸ºä¸€ç§ç­–ç•¥ã€‚
åœºæ™¯ç±»é€šè¿‡æšä¸¾ç±»è·å–ç­–ç•¥ç±»å‹ï¼Œé€šè¿‡PayFactoryåˆ›å»ºåœºæ™¯ç±»éœ€è¦çš„æ”¯ä»˜ç­–ç•¥ã€‚
å·¥å‚æ–¹æ³•å¯ä»¥åˆ›å»ºé»˜è®¤å•†æˆ·çš„æ”¯ä»˜ç­–ç•¥ï¼Œä¹Ÿå¯ä»¥åœ¨å·¥å‚æ–¹æ³•é‡Œå†å†™ä¸€ä¸ªä½¿ç”¨æŒ‡å®šå•†æˆ·idæˆ–ç¬¬ä¸‰æ–¹æ”¯ä»˜çš„æ²™ç®±ç¯å¢ƒçš„æ–¹æ³• ï¼ŒpayBaseModelä¸ºä¸€äº›ä¸šåŠ¡å‚æ•°ï¼Œä¾‹å¦‚æ ‡é¢˜ï¼Œæè¿°ï¼Œå›è°ƒæ¥å£ä»¥åŠæ”¯ä»˜å®Œçš„è·³è½¬é¡µé¢ç­‰ã€‚</p>
<h2 id="mavenä¾èµ–">mavenä¾èµ–<a hidden class="anchor" aria-hidden="true" href="#mavenä¾èµ–">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>com.alipay.sdk<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>alipay-sdk-java<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.0.52.ALL<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>com.wxpay.sdk<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>wxpay-sdk<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.0.9<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.httpcomponents<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>httpclient<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>4.5<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.commons<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>commons-lang3<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.3.1<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.commons<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>commons-lang3<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.3.1<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±äºå¾®ä¿¡æœ€æ–°çš„æ”¯ä»˜sdkåœ¨mavenä»“åº“é‡Œå·²ç»æ²¡æœ‰ï¼Œåˆå¹¶ä¸ºäº†weixin-java-toolsé‡Œçš„ä¸€ä¸ªæ¨¡å—ï¼Œè¯¦è§
<a href="https://github.com/wechat-group/WxJava">https://github.com/wechat-group/WxJava</a>
æœ¬æ–‡æ‰€ä½¿ç”¨çš„å¾®ä¿¡æ”¯ä»˜sdkæ˜¯å®˜ç½‘ä¸‹è½½åè‡ªå·±ç¼–è¯‘çš„ã€‚</p>
<h2 id="å…³é”®ç±»">å…³é”®ç±»<a hidden class="anchor" aria-hidden="true" href="#å…³é”®ç±»">#</a></h2>
<h3 id="ç­–ç•¥æ¥å£">ç­–ç•¥æ¥å£<a hidden class="anchor" aria-hidden="true" href="#ç­–ç•¥æ¥å£">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public interface IPayStrategy {
</span></span><span style="display:flex;"><span>    public Map&lt;String,String&gt; excutePayOrder(PayBaseModel model) throws Exception;
</span></span><span style="display:flex;"><span>    public int excuteQueryStatus(String orderNo) throws Exception;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä¸šåŠ¡å‚æ•°ç±»">ä¸šåŠ¡å‚æ•°ç±»<a hidden class="anchor" aria-hidden="true" href="#ä¸šåŠ¡å‚æ•°ç±»">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PayBaseModel <span style="color:#fff;font-weight:bold">implements</span> Serializable {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> serialVersionUID = <span style="color:#ff0;font-weight:bold">1L</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å•†å“æ ‡é¢˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String title;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å•†å“æè¿°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String desc;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å›è°ƒåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String notifyUrl;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//äº¤æ˜“é‡‘é¢
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String tradeMoney;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å•†æˆ·è®¢å•å·
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String outTradeNo;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è‡ªå®šä¹‰å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String attach;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç½‘é¡µæ”¯ä»˜å®Œæˆåçš„è·³è½¬åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String returnUrl;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç”¨æˆ·ip
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String realIp;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è¯·æ±‚å¤´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> String referer;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//get setæ–¹æ³•è‡ªå·±å®ç° ä¹Ÿå¯ä»¥ä¸ç”¨å®ç°ï¼Œå› ä¸ºæ„é€ å‡½æ•°é‡Œä¼ å…¥äº†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> PayBaseModel(String title, String notifyUrl, String tradeMoney, String outTradeNo, String returnUrl) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">title</span> = title;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">notifyUrl</span> = notifyUrl;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">tradeMoney</span> = tradeMoney;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">outTradeNo</span> = outTradeNo;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">returnUrl</span> = returnUrl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> PayBaseModel(String title, String notifyUrl, String tradeMoney, String outTradeNo) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">title</span> = title;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">notifyUrl</span> = notifyUrl;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">tradeMoney</span> = tradeMoney;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">outTradeNo</span> = outTradeNo;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å››ç§æ”¯ä»˜ç­–ç•¥">å››ç§æ”¯ä»˜ç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#å››ç§æ”¯ä»˜ç­–ç•¥">#</a></h3>
<h4 id="aliapppaystrategy">AliAppPayStrategy<a hidden class="anchor" aria-hidden="true" href="#aliapppaystrategy">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.AlipayApiException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.AlipayClient;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.AlipayResponse;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.DefaultAlipayClient;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.domain.AlipayTradeAppPayModel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alipay.api.request.AlipayTradeAppPayRequest;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.IPayStrategy;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.PayConstant;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.model.PayBaseModel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.lang3.StringUtils;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.math.BigDecimal;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.text.DecimalFormat;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ”¯ä»˜å®APPæ”¯ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AliAppPayStrategy <span style="color:#fff;font-weight:bold">implements</span> IPayStrategy {
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String url;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String appId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String privateKey;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String publicKey;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> orderTimeOUt;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> Logger LOGGER = LoggerFactory.<span style="color:#007f7f">getLogger</span>(AliAppPayStrategy.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> AliAppPayStrategy(String url, String appId, String privateKey, String publicKey, <span style="color:#fff;font-weight:bold">int</span> orderTimeOUt) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span> = url;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span> = appId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">privateKey</span> = privateKey;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">publicKey</span> = publicKey;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOUt</span> = orderTimeOUt;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Map&lt;String, String&gt; excutePayOrder(PayBaseModel payBaseModel) <span style="color:#fff;font-weight:bold">throws</span> AlipayApiException {
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************è·å–æ”¯ä»˜å®APPæ”¯ä»˜æ¨¡æ¿&#34;</span> + payBaseModel.<span style="color:#007f7f">toString</span>()
</span></span><span style="display:flex;"><span>                + <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; resultMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        AlipayTradeAppPayRequest payRequest = <span style="color:#fff;font-weight:bold">new</span> AlipayTradeAppPayRequest();
</span></span><span style="display:flex;"><span>        AlipayTradeAppPayModel model = <span style="color:#fff;font-weight:bold">new</span> AlipayTradeAppPayModel();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç»„è£…å¿…å¡«å‚æ•°ï¼šè®¢å•æ ‡é¢˜ å•†å®¶äº¤æ˜“è®¢å•å· äº¤æ˜“é‡‘é¢
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        model.<span style="color:#007f7f">setSubject</span>(payBaseModel.<span style="color:#007f7f">getTitle</span>());
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setOutTradeNo</span>(payBaseModel.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!StringUtils.<span style="color:#007f7f">isEmpty</span>(payBaseModel.<span style="color:#007f7f">getDesc</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//äº¤æ˜“è¯¦æƒ…
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            model.<span style="color:#007f7f">setBody</span>(payBaseModel.<span style="color:#007f7f">getDesc</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        model.<span style="color:#007f7f">setTotalAmount</span>(<span style="color:#fff;font-weight:bold">new</span> DecimalFormat(<span style="color:#0ff;font-weight:bold">&#34;0.00&#34;</span>).<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> BigDecimal(payBaseModel.<span style="color:#007f7f">getTradeMoney</span>())));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!StringUtils.<span style="color:#007f7f">isEmpty</span>(payBaseModel.<span style="color:#007f7f">getAttach</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è‡ªå®šä¹‰å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            model.<span style="color:#007f7f">setPassbackParams</span>(payBaseModel.<span style="color:#007f7f">getAttach</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//éå¿…å¡«å‚æ•° è®¢å•è¿‡æœŸæ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        model.<span style="color:#007f7f">setTimeoutExpress</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOUt</span> + <span style="color:#0ff;font-weight:bold">&#34;m&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//appæ”¯ä»˜äº¤æ˜“ç -å›ºå®šå€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        model.<span style="color:#007f7f">setProductCode</span>(<span style="color:#0ff;font-weight:bold">&#34;QUICK_MSECURITY_PAY&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å›è°ƒé€šçŸ¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        payRequest.<span style="color:#007f7f">setNotifyUrl</span>(payBaseModel.<span style="color:#007f7f">getNotifyUrl</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä¸šåŠ¡å‚æ•°æ¨¡æ¿
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        payRequest.<span style="color:#007f7f">setBizModel</span>(model);
</span></span><span style="display:flex;"><span>        AlipayClient alipayClient = <span style="color:#fff;font-weight:bold">new</span> DefaultAlipayClient(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">privateKey</span>,
</span></span><span style="display:flex;"><span>                PayConstant.<span style="color:#007f7f">ALI_DEFAULT_FORMAT</span>, PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">publicKey</span>, PayConstant.<span style="color:#007f7f">ALI_DEFAULT_SIGNTYPE</span>);
</span></span><span style="display:flex;"><span>        AlipayResponse response = alipayClient.<span style="color:#007f7f">sdkExecute</span>(payRequest);
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;payContent&#34;</span>, response.<span style="color:#007f7f">getBody</span>());
</span></span><span style="display:flex;"><span>        resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, payBaseModel.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************é˜¿é‡Œæ”¯ä»˜ä¸‹å•æ¥å£è¿”å›æ•°æ®:&#34;</span> + resultMap + <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> resultMap;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="aliwebpaystrategy">AliWebPayStrategy<a hidden class="anchor" aria-hidden="true" href="#aliwebpaystrategy">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>import com.alibaba.fastjson.JSONObject;
</span></span><span style="display:flex;"><span>import com.alipay.api.AlipayApiException;
</span></span><span style="display:flex;"><span>import com.alipay.api.AlipayClient;
</span></span><span style="display:flex;"><span>import com.alipay.api.DefaultAlipayClient;
</span></span><span style="display:flex;"><span>import com.alipay.api.request.AlipayTradeWapPayRequest;
</span></span><span style="display:flex;"><span>import com.tubitu.util.pay.IPayStrategy;
</span></span><span style="display:flex;"><span>import com.tubitu.util.pay.PayConstant;
</span></span><span style="display:flex;"><span>import com.tubitu.util.pay.model.PayBaseModel;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>import java.math.BigDecimal;
</span></span><span style="display:flex;"><span>import java.text.DecimalFormat;
</span></span><span style="display:flex;"><span>import java.util.HashMap;
</span></span><span style="display:flex;"><span>import java.util.Map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>//æ”¯ä»˜å®ç½‘é¡µæ”¯ä»˜
</span></span><span style="display:flex;"><span>public class AliWebPayStrategy implements IPayStrategy {
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    private String url;
</span></span><span style="display:flex;"><span>    private String appId;
</span></span><span style="display:flex;"><span>    private String privateKey;
</span></span><span style="display:flex;"><span>    private String publicKey;
</span></span><span style="display:flex;"><span>    private int orderTimeOut;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public AliWebPayStrategy(String url, String appId, String privateKey, String publicKey, int orderTimeOUt) {
</span></span><span style="display:flex;"><span>        this.url = url;
</span></span><span style="display:flex;"><span>        this.appId = appId;
</span></span><span style="display:flex;"><span>        this.privateKey = privateKey;
</span></span><span style="display:flex;"><span>        this.publicKey = publicKey;
</span></span><span style="display:flex;"><span>        this.orderTimeOut = orderTimeOUt;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    public Map&lt;String, String&gt; excutePayOrder(PayBaseModel payBaseModel) throws AlipayApiException {
</span></span><span style="display:flex;"><span>        Map&lt;String,String&gt; resultMap = new HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        //åˆ›å»ºAPIå¯¹åº”çš„request
</span></span><span style="display:flex;"><span>        AlipayTradeWapPayRequest alipayRequest = new AlipayTradeWapPayRequest();
</span></span><span style="display:flex;"><span>        //æ”¯ä»˜å®Œæˆé˜¿é‡Œå›è·³è½¬åˆ°è¯¥é¡µé¢
</span></span><span style="display:flex;"><span>        alipayRequest.setReturnUrl(payBaseModel.getReturnUrl());
</span></span><span style="display:flex;"><span>        //åˆ¤æ–­ä¼ å…¥çš„åœ°å€æ˜¯å¦ä¸ºhttpæˆ–è€…httpså¼€å¤´  æ”¯ä»˜ç»“æœé€šçŸ¥æ¥å£
</span></span><span style="display:flex;"><span>        alipayRequest.setNotifyUrl(payBaseModel.getNotifyUrl());
</span></span><span style="display:flex;"><span>        JSONObject json = new JSONObject();
</span></span><span style="display:flex;"><span>        json.put(&#34;out_trade_no&#34;, payBaseModel.getOutTradeNo());
</span></span><span style="display:flex;"><span>        json.put(&#34;total_amount&#34;, new DecimalFormat(&#34;0.00&#34;).format(new BigDecimal(payBaseModel.getTradeMoney())));
</span></span><span style="display:flex;"><span>        json.put(&#34;subject&#34;, payBaseModel.getTitle());
</span></span><span style="display:flex;"><span>        json.put(&#34;passback_params&#34;, payBaseModel.getAttach());
</span></span><span style="display:flex;"><span>        json.put(&#34;product_code&#34;, &#34;QUICK_WAP_PAY&#34;);
</span></span><span style="display:flex;"><span>        json.put(&#34;timeout_express&#34;,this.orderTimeOut+&#34;&#34;);
</span></span><span style="display:flex;"><span>        //å¡«å……ä¸šåŠ¡å‚æ•°
</span></span><span style="display:flex;"><span>        alipayRequest.setBizContent(json.toJSONString());
</span></span><span style="display:flex;"><span>        String form = &#34;&#34;;
</span></span><span style="display:flex;"><span>        AlipayClient alipayClient = new DefaultAlipayClient(this.url, this.appId,this.privateKey, 
</span></span><span style="display:flex;"><span>                PayConstant.ALI_DEFAULT_FORMAT, PayConstant.DEFAULT_CHARSET, this.publicKey, PayConstant.ALI_DEFAULT_SIGNTYPE);
</span></span><span style="display:flex;"><span>        //è°ƒç”¨SDKç”Ÿæˆè¡¨å•
</span></span><span style="display:flex;"><span>        form = alipayClient.pageExecute(alipayRequest).getBody();
</span></span><span style="display:flex;"><span>        resultMap.put(&#34;form&#34;,form);
</span></span><span style="display:flex;"><span>        return resultMap;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="wxapppaystrategy">WxAppPayStrategy<a hidden class="anchor" aria-hidden="true" href="#wxapppaystrategy">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.github.wxpay.sdk.WXPayConstants;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.github.wxpay.sdk.WXPayUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.date.DateUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.http.ContentTypeEnum;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.IPayStrategy;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.PayUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.model.PayBaseModel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.lang3.StringUtils;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.math.BigDecimal;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Calendar;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Date;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//å¾®ä¿¡APPæ”¯ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WxAppPayStrategy <span style="color:#fff;font-weight:bold">implements</span> IPayStrategy {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String url;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String appId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String mchId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String appKey;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String partnerId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> orderTimeOut;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> WxAppPayStrategy(String url, String appId, String mchId, String appKey, String partnerId, <span style="color:#fff;font-weight:bold">int</span> orderTimeOut) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span> = url;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span> = appId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">mchId</span> = mchId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appKey</span> = appKey;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">partnerId</span> = partnerId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOut</span> = orderTimeOut;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> Logger LOGGER = LoggerFactory.<span style="color:#007f7f">getLogger</span>(WxAppPayStrategy.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Map&lt;String, String&gt; excutePayOrder(PayBaseModel payBaseModel) {
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************è·å–å¾®ä¿¡APPæ”¯ä»˜æ¨¡æ¿&#34;</span> + payBaseModel.<span style="color:#007f7f">toString</span>() + 
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; resultMap = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è¿”å›ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            resultMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">/*
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">        1 æ‹¼æ¥å‚æ•°å‘å¾®ä¿¡è¯·æ±‚ï¼Œè·å–prepare_id
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>            Map&lt;String, String&gt; paramMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appid&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span>);
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;body&#34;</span>, payBaseModel.<span style="color:#007f7f">getTitle</span>());
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;mch_id&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">mchId</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//åé¢è¿”å›ç»™appæ—¶çš„nonceStréœ€è¦ä¸è¿™é‡Œçš„ä¸€è‡´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String nonceStr = WXPayUtil.<span style="color:#007f7f">generateNonceStr</span>();
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonce_str&#34;</span>, nonceStr);
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign_type&#34;</span>, WXPayConstants.<span style="color:#007f7f">MD5</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (!StringUtils.<span style="color:#007f7f">isEmpty</span>(payBaseModel.<span style="color:#007f7f">getAttach</span>())) {
</span></span><span style="display:flex;"><span>                paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;attach&#34;</span>, payBaseModel.<span style="color:#007f7f">getAttach</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, payBaseModel.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¾®ä¿¡æ”¯ä»˜å¿…é¡»ä¹˜ä»¥100
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;total_fee&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> BigDecimal(payBaseModel.<span style="color:#007f7f">getTradeMoney</span>()).<span style="color:#007f7f">multiply</span>(<span style="color:#fff;font-weight:bold">new</span> BigDecimal(<span style="color:#0ff;font-weight:bold">&#34;100&#34;</span>)).<span style="color:#007f7f">intValue</span>() + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è·å–ç”¨æˆ·çœŸå®ip
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;spbill_create_ip&#34;</span>, payBaseModel.<span style="color:#007f7f">getRealIp</span>());
</span></span><span style="display:flex;"><span>            Date currDate = <span style="color:#fff;font-weight:bold">new</span> Date();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è®¢å•ç”Ÿæˆæ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;time_start&#34;</span>, DateUtil.<span style="color:#007f7f">formatDate</span>(currDate, <span style="color:#0ff;font-weight:bold">&#34;yyyyMMddHHmmss&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//è®¢å•å¤±æ•ˆæ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;time_expire&#34;</span>, DateUtil.<span style="color:#007f7f">formatDate</span>(DateUtil.<span style="color:#007f7f">addDate</span>(currDate, Calendar.<span style="color:#007f7f">MINUTE</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOut</span>), 
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;yyyyMMddHHmmss&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å¼‚æ­¥å›è°ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;notify_url&#34;</span>, payBaseModel.<span style="color:#007f7f">getNotifyUrl</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ”¯ä»˜ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//appæ”¯ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;trade_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;APP&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            paramMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(paramMap, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appKey</span>, WXPayConstants.<span style="color:#007f7f">SignType</span>.<span style="color:#007f7f">MD5</span>));
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************å¾®ä¿¡æ”¯ä»˜å‚æ•°é›†åˆ:&#34;</span> + paramMap + <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            String xmlString = WXPayUtil.<span style="color:#007f7f">mapToXml</span>(paramMap);
</span></span><span style="display:flex;"><span>            String entityString = PayUtil.<span style="color:#007f7f">post</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span>,xmlString,ContentTypeEnum.<span style="color:#007f7f">TextXml</span>.<span style="color:#007f7f">getContentType</span>());
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************å¾®ä¿¡æ”¯ä»˜ç»Ÿä¸€ä¸‹å•æ¥å£è¿”å›æ•°æ®:&#34;</span> + entityString + <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            Map&lt;String, String&gt; wxXmlMap = WXPayUtil.<span style="color:#007f7f">xmlToMap</span>(entityString);
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">/*
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                2  æ­¤å¤„ç»„è£…è¿”å›ç»™å‰ç«¯çš„å‚æ•°é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ç»„è£…è¿”å›ç»™å‰ç«¯çš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//appæ”¯ä»˜   æœåŠ¡ç«¯è¿”å›Appæ‰€éœ€æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appid&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span>);
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;noncestr&#34;</span>, nonceStr);
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;partnerid&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">partnerId</span>);
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;prepayid&#34;</span>, wxXmlMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;prepay_id&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å®˜æ–¹æš‚æ—¶è§„å®šä¸ºå›ºå®šå€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;package&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;Sign=WXPay&#34;</span>);
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;timestamp&#34;</span>, System.<span style="color:#007f7f">currentTimeMillis</span>() / <span style="color:#ff0;font-weight:bold">1000</span> + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å†æ¬¡ç”Ÿæˆç­¾å
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(resultMap, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appKey</span>, WXPayConstants.<span style="color:#007f7f">SignType</span>.<span style="color:#007f7f">MD5</span>));
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, payBaseModel.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;\n********************è¯·æ±‚å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£å¼‚å¸¸********************&#34;</span>,e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> resultMap;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="wxwebpaystrategy">WxWebPayStrategy<a hidden class="anchor" aria-hidden="true" href="#wxwebpaystrategy">#</a></h4>
<p>ç”±äºå¾®ä¿¡å°ç¨‹åºæ”¯ä»˜çš„è¯·æ±‚é€»è¾‘å’Œå…¬ä¼—å·å†…æ”¯ä»˜åŸºæœ¬ä¸€è‡´ï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯appidå’ŒappSecretä¸åŒ(appSecretç”¨äºå…¬ä¼—å·å†…å’Œå°ç¨‹åºå†…æˆ–è€…ç”¨æˆ·çš„openIdï¼Œå³ä½¿åŒä¸€å•†å®¶ï¼Œå…¬ä¼—å·å’Œå°ç¨‹åºçš„appIDå’ŒappSecretä¹Ÿä¸ä¸€è‡´ï¼Œè€Œç”±æ­¤è·å¾—çš„åŒä¸€ä¸ªç”¨æˆ·çš„openIDä¹Ÿä¸ä¸€è‡´ï¼‰ï¼Œå› æ­¤å¯ä»¥å’Œå…¬ä¼—å·å†…ä½¿ç”¨ç›¸åŒçš„é€»è¾‘ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.github.wxpay.sdk.WXPayConstants;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.github.wxpay.sdk.WXPayUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.date.DateUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.http.ContentTypeEnum;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.IPayStrategy;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.PayConstant;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.PayUtil;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.tubitu.util.pay.model.PayBaseModel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.lang3.StringUtils;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.math.BigDecimal;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.net.URLEncoder;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Calendar;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Date;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//å¾®ä¿¡å…¬ä¼—å·/ç½‘é¡µæ”¯ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WxWebPayStrategy <span style="color:#fff;font-weight:bold">implements</span> IPayStrategy {
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String url;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String appId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String mchId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String appKey;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String openId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> orderTimeOut;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> WxWebPayStrategy(String url, String appId, String mchId, String appKey, String openId, <span style="color:#fff;font-weight:bold">int</span> orderTimeOut) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span> = url;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span> = appId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">mchId</span> = mchId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appKey</span> = appKey;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">openId</span> = openId;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOut</span> = orderTimeOut;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> Logger LOGGER = LoggerFactory.<span style="color:#007f7f">getLogger</span>(WxWebPayStrategy.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Map&lt;String, String&gt; excutePayOrder(PayBaseModel payBaseModel) {
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;\n********************å¾®ä¿¡ç½‘é¡µæ”¯ä»˜å‚æ•°\n&#34;</span> + payBaseModel.<span style="color:#007f7f">toString</span>() + <span style="color:#0ff;font-weight:bold">&#34;\n********************&#34;</span>);
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; resultMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; preParamMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        String nonceStr = WXPayUtil.<span style="color:#007f7f">generateNonceStr</span>();
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appid&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span>);
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;mch_id&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">mchId</span>);
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonce_str&#34;</span>, nonceStr);
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;body&#34;</span>, payBaseModel.<span style="color:#007f7f">getTitle</span>());
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>, payBaseModel.<span style="color:#007f7f">getOutTradeNo</span>());
</span></span><span style="display:flex;"><span>        Date currDate = <span style="color:#fff;font-weight:bold">new</span> Date();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¢å•ç”Ÿæˆæ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;time_start&#34;</span>, DateUtil.<span style="color:#007f7f">formatDate</span>(currDate, <span style="color:#0ff;font-weight:bold">&#34;yyyyMMddHHmmss&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è®¢å•å¤±æ•ˆæ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;time_expire&#34;</span>, DateUtil.<span style="color:#007f7f">formatDate</span>(DateUtil.<span style="color:#007f7f">addDate</span>(currDate, Calendar.<span style="color:#007f7f">MINUTE</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">orderTimeOut</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;yyyyMMddHHmmss&#34;</span>));
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;total_fee&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> BigDecimal(payBaseModel.<span style="color:#007f7f">getTradeMoney</span>()).<span style="color:#007f7f">multiply</span>(<span style="color:#fff;font-weight:bold">new</span> BigDecimal(<span style="color:#0ff;font-weight:bold">&#34;100&#34;</span>)).<span style="color:#007f7f">intValue</span>() + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;spbill_create_ip&#34;</span>, payBaseModel.<span style="color:#007f7f">getRealIp</span>());
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;************************spbill_create_ip&#34;</span> + preParamMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;spbill_create_ip&#34;</span>) + <span style="color:#0ff;font-weight:bold">&#34;************************************&#34;</span>);
</span></span><span style="display:flex;"><span>        preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;notify_url&#34;</span>, payBaseModel.<span style="color:#007f7f">getNotifyUrl</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (StringUtils.<span style="color:#007f7f">isNotEmpty</span>(payBaseModel.<span style="color:#007f7f">getAttach</span>())) {
</span></span><span style="display:flex;"><span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;attach&#34;</span>, payBaseModel.<span style="color:#007f7f">getAttach</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (StringUtils.<span style="color:#007f7f">isNotEmpty</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">openId</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å…¬ä¼—å·æ”¯ä»˜ æˆ–è€… å°ç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;openid&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">openId</span>);
</span></span><span style="display:flex;"><span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;trade_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;JSAPI&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//h5 é¡µé¢æ”¯ä»˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;trade_type&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;MWEB&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//éœ€è¦æ³¨æ„çš„æ˜¯H5 é¡µé¢æ”¯ä»˜å¾®ä¿¡éœ€è¦ä¸‹é¢çš„åœºæ™¯ä¿¡æ¯ï¼Œåœ¨æœ€ç»ˆé¡µé¢æäº¤æ”¯ä»˜è¯·æ±‚çš„æ—¶å€™æ‹¿æ­¤å¤„çš„refereré‡Œçš„æ•°æ®ä¸æäº¤çŠ¶æ€æ¯”å¯¹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;scene_info&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;{\&#34;h5_info\&#34;: {\&#34;type\&#34;:\&#34;Wap\&#34;,\&#34;wap_url\&#34;: &#34;</span> + payBaseModel.<span style="color:#007f7f">getReferer</span>() + <span style="color:#0ff;font-weight:bold">&#34;,&#34;</span> + <span style="color:#0ff;font-weight:bold">&#34;\&#34;wap_name\&#34;:&#34;</span> + <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> + <span style="color:#0ff;font-weight:bold">&#34;\&#34;å…”æ¯”å…”\&#34;}}&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            preParamMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;sign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(preParamMap, PayConstant.<span style="color:#007f7f">WX_APP_KEY</span>));
</span></span><span style="display:flex;"><span>            String entityString = PayUtil.<span style="color:#007f7f">post</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">url</span>, WXPayUtil.<span style="color:#007f7f">mapToXml</span>(preParamMap), ContentTypeEnum.<span style="color:#007f7f">TextXml</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">getContentType</span>());
</span></span><span style="display:flex;"><span>            Map&lt;String, String&gt; wxXmlMap = WXPayUtil.<span style="color:#007f7f">xmlToMap</span>(entityString);
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">/*
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                    2  æ­¤å¤„ç»„è£…è¿”å›ç»™å‰ç«¯çš„å‚æ•°é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                    */</span>
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;**********************å¾®ä¿¡æ”¯ä»˜ç»Ÿä¸€ä¸‹å•æ¥å£è¿”å›æ•°æ®:&#34;</span> + wxXmlMap +
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;**************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (StringUtils.<span style="color:#007f7f">isEmpty</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">openId</span>)) {
</span></span><span style="display:flex;"><span>                String mwebUrl = wxXmlMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;mweb_url&#34;</span>) + <span style="color:#0ff;font-weight:bold">&#34;&amp;redirect_url=&#34;</span> + URLEncoder.<span style="color:#007f7f">encode</span>(payBaseModel.<span style="color:#007f7f">getReturnUrl</span>(),
</span></span><span style="display:flex;"><span>                        PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>);
</span></span><span style="display:flex;"><span>                LOGGER.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;*****************  mweb_url = &#34;</span> + mwebUrl + <span style="color:#0ff;font-weight:bold">&#34; ************************************************&#34;</span>);
</span></span><span style="display:flex;"><span>                wxXmlMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;mweb_url&#34;</span>, mwebUrl);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">putAll</span>(wxXmlMap);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;code&#34;</span>, <span style="color:#ff0;font-weight:bold">100000</span> + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;appId&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appId</span>);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;timeStamp&#34;</span>, System.<span style="color:#007f7f">currentTimeMillis</span>() / <span style="color:#ff0;font-weight:bold">1000</span> + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;nonceStr&#34;</span>, nonceStr);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;package&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;prepay_id=&#34;</span> + wxXmlMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;prepay_id&#34;</span>));
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;signType&#34;</span>, WXPayConstants.<span style="color:#007f7f">MD5</span>);
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;paySign&#34;</span>, WXPayUtil.<span style="color:#007f7f">generateSignature</span>(resultMap, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">appKey</span>));
</span></span><span style="display:flex;"><span>                resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;code&#34;</span>, <span style="color:#ff0;font-weight:bold">100000</span> + <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;\n********************è¯·æ±‚å¾®ä¿¡ç»Ÿä¸€ä¸‹å•æ¥å£å¼‚å¸¸********************&#34;</span>,e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> resultMap;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="httpè¯·æ±‚">Httpè¯·æ±‚<a hidden class="anchor" aria-hidden="true" href="#httpè¯·æ±‚">#</a></h3>
<p>è‡ªå·±å°è£…çš„ç”¨HttpClientå‘é€Httpè¯·æ±‚çš„å·¥å…·ç±»ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String post(String url, String stringEntity, String ContentType){
</span></span><span style="display:flex;"><span>    String result = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    CloseableHttpClient httpClient = HttpClients.<span style="color:#007f7f">createDefault</span>();
</span></span><span style="display:flex;"><span>    CloseableHttpResponse response = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        HttpPost httpPost = <span style="color:#fff;font-weight:bold">new</span> HttpPost(url);
</span></span><span style="display:flex;"><span>        RequestConfig requestConfig = RequestConfig.<span style="color:#007f7f">custom</span>().<span style="color:#007f7f">setSocketTimeout</span>(<span style="color:#ff0;font-weight:bold">8000</span>).<span style="color:#007f7f">setConnectTimeout</span>(<span style="color:#ff0;font-weight:bold">6000</span>).<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>        httpPost.<span style="color:#007f7f">setConfig</span>(requestConfig);
</span></span><span style="display:flex;"><span>        StringEntity entity = <span style="color:#fff;font-weight:bold">new</span> StringEntity(stringEntity, PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>);
</span></span><span style="display:flex;"><span>        httpPost.<span style="color:#007f7f">addHeader</span>(<span style="color:#0ff;font-weight:bold">&#34;Content-Type&#34;</span>, ContentType);
</span></span><span style="display:flex;"><span>        httpPost.<span style="color:#007f7f">addHeader</span>(<span style="color:#0ff;font-weight:bold">&#34;User-Agent&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)&#34;</span>);
</span></span><span style="display:flex;"><span>        httpPost.<span style="color:#007f7f">setEntity</span>(entity);
</span></span><span style="display:flex;"><span>        response = httpClient.<span style="color:#007f7f">execute</span>(httpPost);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è¯»å–å“åº”ä½“è½¬åŒ–ä¸ºå­—ç¬¦ä¸²  å»ºè®®ï¼šç¡®å®šç›®æ ‡åœ°å€å‘å‡ºæœ‰é™é•¿åº¦çš„å“åº”æ—¶ï¼Œä½¿ç”¨è¯¥æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        HttpEntity responseEntiry = response.<span style="color:#007f7f">getEntity</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä¸ç„¶ä½¿ç”¨æµçš„æ–¹å¼å¥½äº›
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">/* if (entity != null) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            InputStream inputStream = entity.getContent();
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream));
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            String line = &#34;&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            while ((line = bufferedReader.readLine()) != null) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                System.out.println(line);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">            }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">        }*/</span>
</span></span><span style="display:flex;"><span>        result = EntityUtils.<span style="color:#007f7f">toString</span>(responseEntiry, PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;\n******************http post error**********************&#34;</span>,e);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            httpClient.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;\n********************close httpclient/response error********************&#34;</span>,e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç­–ç•¥æšä¸¾">ç­–ç•¥æšä¸¾<a hidden class="anchor" aria-hidden="true" href="#ç­–ç•¥æšä¸¾">#</a></h3>
<p>æšä¸¾æš´éœ²ç»™å®¢æˆ·ç«¯ï¼Œä»¥ç”Ÿæˆä¸åŒç­–ç•¥ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">enum</span> PayAlgorithm {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ”¯ä»˜å®å®¢æˆ·ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ALI_APP,
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ”¯ä»˜å®é¡µé¢ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ALI_WEB,
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å¾®ä¿¡å®¢æˆ·ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    WX_APP,
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å¾®ä¿¡é¡µé¢ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    WX_WEB,
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å¾®ä¿¡å°ç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    WX_XCX;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç­–ç•¥å·¥å‚">ç­–ç•¥å·¥å‚<a hidden class="anchor" aria-hidden="true" href="#ç­–ç•¥å·¥å‚">#</a></h3>
<p>å·¥å‚åˆ›å»ºç­–ç•¥æ—¶ï¼Œéœ€è¦ä¼ å…¥ç­–ç•¥æ‰€éœ€çš„ä¸€äº›é…ç½®å‚æ•°ï¼Œæœ¬æ–‡ä¸­å•†æˆ·åªæœ‰ä¸€ä¸ªï¼Œå› æ­¤åªæœ‰ä¸€ä¸ªåˆ›å»ºé»˜è®¤å•†æˆ·çš„æ”¯ä»˜ç­–ç•¥ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//æ”¯ä»˜å·¥å‚ç±»ï¼Œå¯ä»¥åˆ›å»ºé»˜è®¤æ”¯ä»˜å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰è´¦æˆ·å®¢æˆ·ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PayFactory {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ›å»ºé»˜è®¤æ”¯ä»˜å®¢æˆ·ç«¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> IPayStrategy createDefaultTubituStrategy(PayAlgorithm algorithm, String openId){
</span></span><span style="display:flex;"><span>        IPayStrategy iPayStrategy = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">switch</span> (algorithm){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ALI_APP:
</span></span><span style="display:flex;"><span>                iPayStrategy = <span style="color:#fff;font-weight:bold">new</span> AliAppPayStrategy(PayConstant.<span style="color:#007f7f">ALI_ORDER_URL</span>,PayConstant.<span style="color:#007f7f">ALI_APP_ID</span>,PayConstant
</span></span><span style="display:flex;"><span>                        .<span style="color:#007f7f">ALI_PRIVATE_KEY</span>,PayConstant.<span style="color:#007f7f">ALI_PUBLIC_KEY</span>,<span style="color:#ff0;font-weight:bold">30</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ALI_WEB:
</span></span><span style="display:flex;"><span>                iPayStrategy = <span style="color:#fff;font-weight:bold">new</span> AliWebPayStrategy(PayConstant.<span style="color:#007f7f">ALI_ORDER_URL</span>,PayConstant.<span style="color:#007f7f">ALI_APP_ID</span>,PayConstant
</span></span><span style="display:flex;"><span>                        .<span style="color:#007f7f">ALI_PRIVATE_KEY</span>,PayConstant.<span style="color:#007f7f">ALI_PUBLIC_KEY</span>,<span style="color:#ff0;font-weight:bold">30</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> WX_APP:
</span></span><span style="display:flex;"><span>                iPayStrategy = <span style="color:#fff;font-weight:bold">new</span> WxAppPayStrategy(PayConstant.<span style="color:#007f7f">WX_UNIFIEDORDER_URL</span>,PayConstant.<span style="color:#007f7f">WX_APP_ID</span>,
</span></span><span style="display:flex;"><span>                        PayConstant.<span style="color:#007f7f">WX_MCH_ID</span>,PayConstant.<span style="color:#007f7f">WX_APP_KEY</span>,PayConstant.<span style="color:#007f7f">WX_PARTNER_ID</span>,<span style="color:#ff0;font-weight:bold">30</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> WX_WEB:
</span></span><span style="display:flex;"><span>                iPayStrategy = <span style="color:#fff;font-weight:bold">new</span> WxWebPayStrategy(PayConstant.<span style="color:#007f7f">WX_UNIFIEDORDER_URL</span>,PayConstant.<span style="color:#007f7f">WX_H5_APPID</span>,
</span></span><span style="display:flex;"><span>                        PayConstant.<span style="color:#007f7f">WX_H5_MCHID</span>,PayConstant.<span style="color:#007f7f">WX_APP_KEY</span>,openId,<span style="color:#ff0;font-weight:bold">30</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> WX_XCX:
</span></span><span style="display:flex;"><span>                iPayStrategy = <span style="color:#fff;font-weight:bold">new</span> WxWebPayStrategy(PayConstant.<span style="color:#007f7f">WX_UNIFIEDORDER_URL</span>,PayConstant.<span style="color:#007f7f">WX_XCX_APPID</span>,
</span></span><span style="display:flex;"><span>                        PayConstant.<span style="color:#007f7f">WX_H5_MCHID</span>,PayConstant.<span style="color:#007f7f">WX_APP_KEY</span>,openId,<span style="color:#ff0;font-weight:bold">30</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> iPayStrategy;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="åœºæ™¯è°ƒç”¨">åœºæ™¯è°ƒç”¨<a hidden class="anchor" aria-hidden="true" href="#åœºæ™¯è°ƒç”¨">#</a></h3>
<p>é¦–å…ˆé€šè¿‡å·¥å‚åˆ›å»ºæŒ‡å®šç­–ç•¥ï¼Œç„¶åæ‰§è¡Œæ¥å£é‡Œçš„æ–¹æ³•ï¼ŒJavaèƒ½å¤ŸåŠ¨æ€ç»‘å®šå¯¹åº”å®ç°ç±»ã€‚
ä»¥ä¸‹ä»£ç é€‚ç”¨äºåœ¨controlleré‡Œè°ƒç”¨ç­–ç•¥è¿”å›æ”¯ä»˜å‚æ•°ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>IPayStrategy strategy = PayFactory.createDefaultTubituStrategy(PayAlgorithm.WX_WEB,&#34;&#34;);
</span></span><span style="display:flex;"><span>PayBaseModel payBaseModel = new PayBaseModel(å•†å“æè¿°,å›è°ƒæ¥å£,äº¤æ˜“é‡‘é¢,å•†æˆ·è®¢å•ç¼–å·,æ”¯ä»˜å®Œè·³è½¬é¡µé¢);
</span></span><span style="display:flex;"><span>Map&lt;String,String&gt; resultMap = strategy.excutePayOrder(payBaseModel);
</span></span></code></pre></td></tr></table>
</div>
</div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°ç¨‹åºæ”¯ä»˜å’Œå…¬ä¼—å·å†…æ”¯ä»˜éœ€è¦é¦–å…ˆè·å–openIdï¼Œæ‰€ä»¥ä¸­é—´éœ€è¦ä¸€ç³»åˆ—é‡å®šå‘å’Œå‚æ•°ã€‚
<img loading="lazy" src="2.jpg" alt=""  />
</p>
<p>ç”±äºè®¾ç½®<code>redirect_url</code>å,å›è·³æŒ‡å®šé¡µé¢çš„æ“ä½œå¯èƒ½å‘ç”Ÿåœ¨ï¼š</p>
<ol>
<li>å¾®ä¿¡æ”¯ä»˜ä¸­é—´é¡µè°ƒèµ·å¾®ä¿¡æ”¶é“¶å°åè¶…è¿‡5ç§’</li>
<li>ç”¨æˆ·ç‚¹å‡»â€œå–æ¶ˆæ”¯ä»˜â€œæˆ–æ”¯ä»˜å®Œæˆåç‚¹â€œå®Œæˆâ€æŒ‰é’®ã€‚å› æ­¤æ— æ³•ä¿è¯é¡µé¢å›è·³æ—¶ï¼Œæ”¯ä»˜æµç¨‹å·²ç»“æŸï¼Œæ‰€ä»¥å•†æˆ·è®¾ç½®çš„redirect_urlåœ°å€ä¸èƒ½è‡ªåŠ¨æ‰§è¡ŒæŸ¥å•æ“ä½œï¼Œåº”è®©ç”¨æˆ·å»ç‚¹å‡»æŒ‰é’®è§¦å‘æŸ¥å•æ“ä½œã€‚</li>
</ol>
<h2 id="å‰ç«¯ä»£ç ">å‰ç«¯ä»£ç <a hidden class="anchor" aria-hidden="true" href="#å‰ç«¯ä»£ç ">#</a></h2>
<h3 id="å…¬ä¼—å·å†…æ”¯ä»˜">å…¬ä¼—å·å†…æ”¯ä»˜<a hidden class="anchor" aria-hidden="true" href="#å…¬ä¼—å·å†…æ”¯ä»˜">#</a></h3>
<h4 id="ç¬¬ä¸€ç§æ–¹å¼">ç¬¬ä¸€ç§æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#ç¬¬ä¸€ç§æ–¹å¼">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">function</span> onBridgeReady(){
</span></span><span style="display:flex;"><span>   WeixinJSBridge.invoke(
</span></span><span style="display:flex;"><span>      <span style="color:#0ff;font-weight:bold">&#39;getBrandWCPayRequest&#39;</span>, {
</span></span><span style="display:flex;"><span>         <span style="color:#0ff;font-weight:bold">&#34;appId&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;wx2421b1c4370ec43b&#34;</span>,     <span style="color:#007f7f">//å…¬ä¼—å·åç§°ï¼Œç”±å•†æˆ·ä¼ å…¥     
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>         <span style="color:#0ff;font-weight:bold">&#34;timeStamp&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;1395712654&#34;</span>,         <span style="color:#007f7f">//æ—¶é—´æˆ³ï¼Œè‡ª1970å¹´ä»¥æ¥çš„ç§’æ•°     
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>         <span style="color:#0ff;font-weight:bold">&#34;nonceStr&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;e61463f8efa94090b1f366cccfbbb444&#34;</span>, <span style="color:#007f7f">//éšæœºä¸²     
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>         <span style="color:#0ff;font-weight:bold">&#34;package&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;prepay_id=u802345jgfjsdfgsdg888&#34;</span>,     
</span></span><span style="display:flex;"><span>         <span style="color:#0ff;font-weight:bold">&#34;signType&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;MD5&#34;</span>,         <span style="color:#007f7f">//å¾®ä¿¡ç­¾åæ–¹å¼ï¼š     
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>         <span style="color:#0ff;font-weight:bold">&#34;paySign&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;70EA570631E4BB79628FBCA90534C63FF7FADD89&#34;</span> <span style="color:#007f7f">//å¾®ä¿¡ç­¾å 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">function</span>(res){
</span></span><span style="display:flex;"><span>      <span style="color:#fff;font-weight:bold">if</span>(res.err_msg == <span style="color:#0ff;font-weight:bold">&#34;get_brand_wcpay_request:ok&#34;</span> ){
</span></span><span style="display:flex;"><span>      <span style="color:#007f7f">// ä½¿ç”¨ä»¥ä¸Šæ–¹å¼åˆ¤æ–­å‰ç«¯è¿”å›,å¾®ä¿¡å›¢é˜Ÿéƒ‘é‡æç¤ºï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//res.err_msgå°†åœ¨ç”¨æˆ·æ”¯ä»˜æˆåŠŸåè¿”å›okï¼Œä½†å¹¶ä¸ä¿è¯å®ƒç»å¯¹å¯é ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//æ­¤å¤„å¯çœ‹ä½œæ”¯ä»˜å¯èƒ½æˆåŠŸï¼Œè·³è½¬åˆ°æˆåŠŸé¡µé¢
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">window</span>.location.replace(<span style="color:#0ff;font-weight:bold">&#34;index.html&#34;</span>);
</span></span><span style="display:flex;"><span>      } 
</span></span><span style="display:flex;"><span>   }); 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">typeof</span> WeixinJSBridge == <span style="color:#0ff;font-weight:bold">&#34;undefined&#34;</span>){
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">if</span>( <span style="color:#fff;font-weight:bold">document</span>.addEventListener ){
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">document</span>.addEventListener(<span style="color:#0ff;font-weight:bold">&#39;WeixinJSBridgeReady&#39;</span>, onBridgeReady, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>   }<span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">document</span>.attachEvent){
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">document</span>.attachEvent(<span style="color:#0ff;font-weight:bold">&#39;WeixinJSBridgeReady&#39;</span>, onBridgeReady); 
</span></span><span style="display:flex;"><span>       <span style="color:#fff;font-weight:bold">document</span>.attachEvent(<span style="color:#0ff;font-weight:bold">&#39;onWeixinJSBridgeReady&#39;</span>, onBridgeReady);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>   onBridgeReady();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ç¬¬äºŒç§æ–¹å¼">ç¬¬äºŒç§æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#ç¬¬äºŒç§æ–¹å¼">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>wx.config({
</span></span><span style="display:flex;"><span>    debug: <span style="color:#fff;font-weight:bold">true</span>, <span style="color:#007f7f">// å¼€å¯è°ƒè¯•æ¨¡å¼,è°ƒç”¨çš„æ‰€æœ‰apiçš„è¿”å›å€¼ä¼šåœ¨å®¢æˆ·ç«¯alertå‡ºæ¥ï¼Œè‹¥è¦æŸ¥çœ‹ä¼ å…¥çš„å‚æ•°ï¼Œå¯ä»¥åœ¨pcç«¯æ‰“å¼€ï¼Œå‚æ•°ä¿¡æ¯ä¼šé€šè¿‡logæ‰“å‡ºï¼Œä»…åœ¨pcç«¯æ—¶æ‰ä¼šæ‰“å°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    appId: <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>, <span style="color:#007f7f">// å¿…å¡«ï¼Œä¼ä¸šå·çš„å”¯ä¸€æ ‡è¯†ï¼Œæ­¤å¤„å¡«å†™ä¼ä¸šå·corpid
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    timestamp: , <span style="color:#007f7f">// å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    nonceStr: <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>, <span style="color:#007f7f">// å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    signature: <span style="color:#0ff;font-weight:bold">&#39;&#39;</span>,<span style="color:#007f7f">// å¿…å¡«ï¼Œç­¾åï¼Œè§é™„å½•1
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    jsApiList: [] <span style="color:#007f7f">// å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„JSæ¥å£åˆ—è¡¨ï¼Œæ‰€æœ‰JSæ¥å£åˆ—è¡¨è§é™„å½•2
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>});
</span></span><span style="display:flex;"><span>wx.ready(<span style="color:#fff;font-weight:bold">function</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// configä¿¡æ¯éªŒè¯åä¼šæ‰§è¡Œreadyæ–¹æ³•ï¼Œæ‰€æœ‰æ¥å£è°ƒç”¨éƒ½å¿…é¡»åœ¨configæ¥å£è·å¾—ç»“æœä¹‹åï¼Œconfigæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„å¼‚æ­¥æ“ä½œï¼Œæ‰€ä»¥å¦‚æœéœ€è¦åœ¨é¡µé¢åŠ è½½æ—¶å°±è°ƒç”¨ç›¸å…³æ¥å£ï¼Œåˆ™é¡»æŠŠç›¸å…³æ¥å£æ”¾åœ¨readyå‡½æ•°ä¸­è°ƒç”¨æ¥ç¡®ä¿æ­£ç¡®æ‰§è¡Œã€‚å¯¹äºç”¨æˆ·è§¦å‘æ—¶æ‰è°ƒç”¨çš„æ¥å£ï¼Œåˆ™å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œä¸éœ€è¦æ”¾åœ¨readyå‡½æ•°ä¸­ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>});
</span></span><span style="display:flex;"><span>wx.chooseWXPay({
</span></span><span style="display:flex;"><span>    appId: <span style="color:#0ff;font-weight:bold">&#39;wx23841cce7185b550&#39;</span>,
</span></span><span style="display:flex;"><span>    timestamp: <span style="color:#0ff;font-weight:bold">&#39;1461300911&#39;</span>, <span style="color:#007f7f">// æ”¯ä»˜ç­¾åæ—¶é—´æˆ³ï¼Œæ³¨æ„å¾®ä¿¡jssdkä¸­çš„æ‰€æœ‰ä½¿ç”¨timestampå­—æ®µå‡ä¸ºå°å†™ã€‚ä½†æœ€æ–°ç‰ˆçš„æ”¯ä»˜åå°ç”Ÿæˆç­¾åä½¿ç”¨çš„timeStampå­—æ®µåéœ€å¤§å†™å…¶ä¸­çš„Så­—ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    nonceStr: <span style="color:#0ff;font-weight:bold">&#39;5719aeafb587f&#39;</span>, <span style="color:#007f7f">// æ”¯ä»˜ç­¾åéšæœºä¸²ï¼Œä¸é•¿äº 32 ä½
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">package</span>: <span style="color:#0ff;font-weight:bold">&#39;prepay_id=wx20160422125512b7d2205c9c0913643939&#39;</span>, <span style="color:#007f7f">// ç»Ÿä¸€æ”¯ä»˜æ¥å£è¿”å›çš„prepay_idå‚æ•°å€¼ï¼Œæäº¤æ ¼å¼å¦‚ï¼šprepay_id=***ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    signType: <span style="color:#0ff;font-weight:bold">&#39;MD5&#39;</span>, <span style="color:#007f7f">// ç­¾åæ–¹å¼ï¼Œé»˜è®¤ä¸º&#39;SHA1&#39;ï¼Œä½¿ç”¨æ–°ç‰ˆæ”¯ä»˜éœ€ä¼ å…¥&#39;MD5&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    paySign: <span style="color:#0ff;font-weight:bold">&#39;5DAB1DDABE1AD34E8FF3386AE971B727&#39;</span>, <span style="color:#007f7f">// æ”¯ä»˜ç­¾å
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    success: <span style="color:#fff;font-weight:bold">function</span>(res) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ”¯ä»˜æˆåŠŸåçš„å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (res.errMsg == <span style="color:#0ff;font-weight:bold">&#34;chooseWXPay:ok&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ”¯ä»˜æˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    alert(<span style="color:#0ff;font-weight:bold">&#39;æ”¯ä»˜æˆåŠŸ&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>    alert(res.errMsg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>        },  
</span></span><span style="display:flex;"><span>    cancel: <span style="color:#fff;font-weight:bold">function</span>(res) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ”¯ä»˜å–æ¶ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    alert(<span style="color:#0ff;font-weight:bold">&#39;æ”¯ä»˜å–æ¶ˆ&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>        }); 
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å…¬ä¼—å·å†…æ”¯ä»˜å®é™…ä¸Šæœ‰ä¸¤ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯jsapiçš„æ¨¡å¼ï¼Œå¾®ä¿¡æµè§ˆå™¨å†…éƒ¨æœ‰jsapiç›´æ¥å¯ä»¥è°ƒç”¨ï¼Œç¬¬äºŒç§ä¸ºjs-sdkçš„æ–¹å¼ï¼Œä½†æ˜¯ä¸¤ç§æ–¹å¼éƒ½éœ€è¦å¼•å…¥å¾®ä¿¡çš„jsã€‚
httpï¼š//res.wx.qq.com/js/jwexin-1.2.0.js</p>
<p>ç¬¬äºŒç§æ–¹å¼å¯ä»¥çœ‹åˆ°å¤šäº†ä¸€ä¸ªsignatureçš„ç­¾åå‚æ•°ï¼Œå¤§æ¦‚æä¸€ä¸‹å¦‚ä½•è·å–ï¼š</p>
<ol>
<li>è·å–AccessToken</li>
<li>è·å–jsapi_ticket</li>
<li>ç”Ÿæˆsignature</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//è·å–å¾®ä¿¡token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String getAccessToken(){
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è·å–token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String tokenParam = <span style="color:#0ff;font-weight:bold">&#34;grant_type=client_credential&amp;appid=&#34;</span> + WxPayConfig.<span style="color:#007f7f">APPID</span> + <span style="color:#0ff;font-weight:bold">&#34;&amp;secret=&#34;</span>
</span></span><span style="display:flex;"><span>            + WxPayConfig.<span style="color:#007f7f">APPSECRET</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è¿™ä¸€æ­¥çš„å‘é€è¯·æ±‚å·¥å…·ç±»è¯·è‡ªå·±å®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String tokenJsonStr = HttpUtil.<span style="color:#007f7f">sendGET</span>(<span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/cgi-bin/token&#34;</span>, tokenParam);
</span></span><span style="display:flex;"><span>    Map&lt;String,String&gt; tokenMap = JSONObject.<span style="color:#007f7f">fromObject</span>(tokenJsonStr);
</span></span><span style="display:flex;"><span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(tokenMap);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è·å–access_token
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String access_token = (String) tokenMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;access_token&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> access_token;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//è·å–jsapi_ticket
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String getJsApiTicket(String accessToken){
</span></span><span style="display:flex;"><span>    String ticketParam = <span style="color:#0ff;font-weight:bold">&#34;access_token=&#34;</span> + accessToken + <span style="color:#0ff;font-weight:bold">&#34;&amp;type=jsapi&#34;</span>;
</span></span><span style="display:flex;"><span>    String ticketJsonStr = HttpUtil.<span style="color:#007f7f">sendGET</span>(<span style="color:#0ff;font-weight:bold">&#34;https://api.weixin.qq.com/cgi-bin/ticket/getticket&#34;</span>, ticketParam);
</span></span><span style="display:flex;"><span>    Map&lt;String,String&gt; ticketMap = JSONObject.<span style="color:#007f7f">fromObject</span>(ticketJsonStr);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è·å–jsapi_ticket
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String ticket = (String) ticketMap.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;ticket&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> ticket;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//ç”Ÿæˆsignature
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>String url = PayConstant.<span style="color:#007f7f">PAY_DOMAIN</span>;<span style="color:#007f7f">//å¾®ä¿¡æˆæƒçš„ç½‘å€ è¿™ä¸ªè¦çœ‹å¾®ä¿¡å…¬ä¼—å·è®¾ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>String signValue = <span style="color:#0ff;font-weight:bold">&#34;jsapi_ticket=&#34;</span> + ticket + <span style="color:#0ff;font-weight:bold">&#34;&amp;noncestr=&#34;</span> + noncestr + <span style="color:#0ff;font-weight:bold">&#34;Ã—tamp=&#34;</span> + timestamp
</span></span><span style="display:flex;"><span>            + <span style="color:#0ff;font-weight:bold">&#34;&amp;url=&#34;</span> + url;
</span></span><span style="display:flex;"><span>String signature = Sha1Util.<span style="color:#007f7f">getSha1</span>((signValue))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> String getSha1(String str) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (str == <span style="color:#fff;font-weight:bold">null</span> || str.<span style="color:#007f7f">length</span>() == <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>	    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">char</span> hexDigits[] = {<span style="color:#0ff;font-weight:bold">&#39;0&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;2&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;3&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;4&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;5&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;6&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;7&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;8&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;9&#39;</span>,<span style="color:#0ff;font-weight:bold">&#39;a&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;b&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;c&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;d&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;e&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;f&#39;</span>};
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>		MessageDigest mdTemp = MessageDigest.<span style="color:#007f7f">getInstance</span>(<span style="color:#0ff;font-weight:bold">&#34;SHA1&#34;</span>);
</span></span><span style="display:flex;"><span>		mdTemp.<span style="color:#007f7f">update</span>(str.<span style="color:#007f7f">getBytes</span>(<span style="color:#0ff;font-weight:bold">&#34;GBK&#34;</span>));
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">byte</span>[] md = mdTemp.<span style="color:#007f7f">digest</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">int</span> j = md.<span style="color:#007f7f">length</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">char</span> buf[] = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">char</span>[j * <span style="color:#ff0;font-weight:bold">2</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">int</span> k = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; j; i++) {
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">byte</span> byte0 = md[i];
</span></span><span style="display:flex;"><span>			buf[k++] = hexDigits[byte0 &gt;&gt;&gt; <span style="color:#ff0;font-weight:bold">4</span> &amp; <span style="color:#ff0;font-weight:bold">0xf</span>];
</span></span><span style="display:flex;"><span>			buf[k++] = hexDigits[byte0 &amp; <span style="color:#ff0;font-weight:bold">0xf</span>];
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> String(buf);
</span></span><span style="display:flex;"><span>	} <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å›è°ƒå‡½æ•°">å›è°ƒå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#å›è°ƒå‡½æ•°">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//å¤„ç†å¾®ä¿¡å›è°ƒè¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Map&lt;String, String&gt; resolveWXPayResponse(HttpServletRequest request, String appkey) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;***************************************å¤„ç†å¾®ä¿¡å›è°ƒrequeståŸŸ********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>    ByteArrayOutputStream outSteam = <span style="color:#fff;font-weight:bold">new</span> ByteArrayOutputStream();
</span></span><span style="display:flex;"><span>    InputStream inStream = request.<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">byte</span>[] buffer = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[<span style="color:#ff0;font-weight:bold">1024</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> len = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">while</span> ((len = inStream.<span style="color:#007f7f">read</span>(buffer)) != -<span style="color:#ff0;font-weight:bold">1</span>) {
</span></span><span style="display:flex;"><span>        outSteam.<span style="color:#007f7f">write</span>(buffer, <span style="color:#ff0;font-weight:bold">0</span>, len);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    outSteam.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    inStream.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    String result = <span style="color:#fff;font-weight:bold">new</span> String(outSteam.<span style="color:#007f7f">toByteArray</span>(), PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>);
</span></span><span style="display:flex;"><span>    LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;***************************************å¾®ä¿¡è¿”å›ç»“æœ&#34;</span> + result + <span style="color:#0ff;font-weight:bold">&#34;********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>    Map&lt;String, String&gt; resultMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!StringUtils.<span style="color:#007f7f">isEmpty</span>(result)) {
</span></span><span style="display:flex;"><span>        Map&lt;String, String&gt; map = WXPayUtil.<span style="color:#007f7f">xmlToMap</span>(result);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//éªŒç­¾
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (WXPayUtil.<span style="color:#007f7f">isSignatureValid</span>(map, appkey, WXPayConstants.<span style="color:#007f7f">SignType</span>.<span style="color:#007f7f">MD5</span>)) {
</span></span><span style="display:flex;"><span>            String attach = map.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;attach&#34;</span>);
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;***************************************å¾®ä¿¡è‡ªå®šä¹‰å‚æ•°&#34;</span> + attach + <span style="color:#0ff;font-weight:bold">&#34;********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;***************************************å•†æˆ·è®¢å•å·    ï¼š&#34;</span> + map.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;out_trade_no&#34;</span>) + <span style="color:#0ff;font-weight:bold">&#34;********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>            resultMap = map;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_code&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;FAIL&#34;</span>);
</span></span><span style="display:flex;"><span>            resultMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;return_msg&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;éªŒç­¾å¤±è´¥&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> resultMap;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//å¤„ç†æ”¯ä»˜å®å›è°ƒè¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Map&lt;String, String&gt; resolveAliPayResponse(HttpServletRequest request) <span style="color:#fff;font-weight:bold">throws</span> UnsupportedEncodingException, AlipayApiException {
</span></span><span style="display:flex;"><span>    Map&lt;String, String&gt; result = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>    LOGGER.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;***************************************å¤„ç†æ”¯ä»˜å®å›è°ƒrequeståŸŸ********************************************&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//1.ä»æ”¯ä»˜å®å›è°ƒçš„requeståŸŸä¸­å–å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Map&lt;String, String[]&gt; requestParams = request.<span style="color:#007f7f">getParameterMap</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (Iterator&lt;String&gt; iter = requestParams.<span style="color:#007f7f">keySet</span>().<span style="color:#007f7f">iterator</span>(); iter.<span style="color:#007f7f">hasNext</span>(); ) {
</span></span><span style="display:flex;"><span>        String name = iter.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>        String[] values = requestParams.<span style="color:#007f7f">get</span>(name);
</span></span><span style="display:flex;"><span>        String valueStr = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; values.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>            valueStr = (i == values.<span style="color:#007f7f">length</span> - <span style="color:#ff0;font-weight:bold">1</span>) ? valueStr + values[i] : valueStr + values[i] + <span style="color:#0ff;font-weight:bold">&#34;,&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        result.<span style="color:#007f7f">put</span>(name, valueStr);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//2.ç­¾åéªŒè¯(å¯¹æ”¯ä»˜å®è¿”å›çš„æ•°æ®éªŒè¯ï¼Œç¡®å®šæ˜¯æ”¯ä»˜å®è¿”å›çš„)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">boolean</span> signVerified;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//2.1è°ƒç”¨SDKéªŒè¯ç­¾å
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    signVerified = AlipaySignature.<span style="color:#007f7f">rsaCheckV1</span>(result, PayConstant.<span style="color:#007f7f">ALI_PUBLIC_KEY</span>, PayConstant.<span style="color:#007f7f">DEFAULT_CHARSET</span>, PayConstant.<span style="color:#007f7f">ALI_DEFAULT_SIGNTYPE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (signVerified) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±äºè®¾ç½®<code>redirect_url</code>åï¼Œå›è·³æŒ‡å®šé¡µé¢çš„æ“ä½œå¯èƒ½å‘ç”Ÿåœ¨ï¼š</p>
<ol>
<li>å¾®ä¿¡æ”¯ä»˜ä¸­é—´é¡µè°ƒèµ·å¾®ä¿¡æ”¶é“¶å°åè¶…è¿‡5ç§’</li>
<li>ç”¨æˆ·ç‚¹å‡»â€œå–æ¶ˆæ”¯ä»˜â€œæˆ–æ”¯ä»˜å®Œæˆåç‚¹â€œå®Œæˆâ€æŒ‰é’®ã€‚å› æ­¤æ— æ³•ä¿è¯é¡µé¢å›è·³æ—¶ï¼Œæ”¯ä»˜æµç¨‹å·²ç»“æŸï¼Œæ‰€ä»¥
å•†æˆ·è®¾ç½®çš„redirect_urlåœ°å€ä¸èƒ½è‡ªåŠ¨æ‰§è¡ŒæŸ¥å•æ“ä½œï¼Œåº”è®©ç”¨æˆ·å»ç‚¹å‡»æŒ‰é’®è§¦å‘æŸ¥å•æ“ä½œ</li>
</ol>
<h1 id="æ”¯ä»˜ç³»ç»Ÿçš„å¿ƒè„çŠ¶æ€æœº">æ”¯ä»˜ç³»ç»Ÿçš„å¿ƒè„ï¼šçŠ¶æ€æœº<a hidden class="anchor" aria-hidden="true" href="#æ”¯ä»˜ç³»ç»Ÿçš„å¿ƒè„çŠ¶æ€æœº">#</a></h1>
<p>å‚è€ƒï¼šhttps://juejin.cn/post/7321569896453521419</p>
<p>çŠ¶æ€æœºï¼Œä¹Ÿç§°ä¸ºæœ‰é™çŠ¶æ€æœºï¼ˆFSM, Finite State Machineï¼‰ï¼Œæ˜¯ä¸€ç§è¡Œä¸ºæ¨¡å‹ï¼Œç”±ä¸€ç»„å®šä¹‰è‰¯å¥½çš„çŠ¶æ€ã€çŠ¶æ€ä¹‹é—´çš„è½¬æ¢è§„åˆ™å’Œä¸€ä¸ªåˆå§‹çŠ¶æ€ç»„æˆã€‚å®ƒæ ¹æ®å½“å‰çš„çŠ¶æ€å’Œè¾“å…¥çš„äº‹ä»¶ï¼Œä»ä¸€ä¸ªçŠ¶æ€è½¬ç§»åˆ°å¦ä¸€ä¸ªçŠ¶æ€ã€‚</p>
<h2 id="çŠ¶æ€æœºè®¾è®¡åŸºæœ¬åŸåˆ™">çŠ¶æ€æœºè®¾è®¡åŸºæœ¬åŸåˆ™ï¼š<a hidden class="anchor" aria-hidden="true" href="#çŠ¶æ€æœºè®¾è®¡åŸºæœ¬åŸåˆ™">#</a></h2>
<p>æ— è®ºæ˜¯è®¾è®¡æ”¯ä»˜ç±»çš„ç³»ç»Ÿï¼Œè¿˜æ˜¯ç”µå•†ç±»çš„ç³»ç»Ÿï¼Œåœ¨è®¾è®¡çŠ¶æ€æœºæ—¶ï¼Œéƒ½å»ºè®®éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
<strong>æ˜ç¡®æ€§ï¼š</strong> çŠ¶æ€å’Œè½¬æ¢å¿…é¡»æ¸…æ™°å®šä¹‰ï¼Œé¿å…å«ç³Šä¸æ¸…çš„çŠ¶æ€ã€‚
<strong>å®Œå¤‡æ€§ï¼š</strong> ä¸ºæ‰€æœ‰å¯èƒ½çš„äº‹ä»¶-çŠ¶æ€ç»„åˆå®šä¹‰è½¬æ¢é€»è¾‘ã€‚
<strong>å¯é¢„æµ‹æ€§ï¼š</strong> ç³»ç»Ÿåº”æ ¹æ®å½“å‰çŠ¶æ€å’Œç»™å®šäº‹ä»¶å¯é¢„æµ‹åœ°å“åº”ã€‚
<strong>æœ€å°åŒ–ï¼š</strong> çŠ¶æ€æ•°åº”ä¿æŒæœ€å°ï¼Œé¿å…ä¸å¿…è¦çš„å¤æ‚æ€§ã€‚</p>
<h2 id="çŠ¶æ€æœºå¸¸è§è®¾è®¡è¯¯åŒº">çŠ¶æ€æœºå¸¸è§è®¾è®¡è¯¯åŒº<a hidden class="anchor" aria-hidden="true" href="#çŠ¶æ€æœºå¸¸è§è®¾è®¡è¯¯åŒº">#</a></h2>
<p>å·¥ä½œå¤šå¹´ï¼Œè§è¿‡å¾ˆå¤šè®¾è®¡å¾—ä¸å¥½çš„çŠ¶æ€æœºï¼Œå¯¼è‡´è¿ç»´ç‰¹åˆ«éº»çƒ¦ï¼Œè¿˜å®¹æ˜“å‡ºæ•…éšœï¼Œæ€»ç»“å‡ºæ¥ä¸€å…±æœ‰è¿™ä¹ˆå‡ æ¡ï¼š</p>
<p><strong>è¿‡åº¦è®¾è®¡ï¼š</strong> å¼•å…¥ä¸å¿…è¦çš„çŠ¶æ€å’Œå¤æ‚æ€§ï¼Œä½¿ç³»ç»Ÿéš¾ä»¥ç†è§£å’Œç»´æŠ¤ã€‚
<strong>ä¸å®Œå¤‡çš„å¤„ç†ï¼š</strong> æœªèƒ½å¤„ç†æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€è½¬æ¢ï¼Œå¯¼è‡´ç³»ç»Ÿè¡Œä¸ºä¸ç¡®å®šã€‚
<strong>ç¡¬ç¼–ç é€»è¾‘ï¼š</strong> è¿‡å¤šçš„ç¡¬ç¼–ç è½¬æ¢é€»è¾‘ï¼Œä½¿ç³»ç»Ÿä¸å…·å¤‡çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚</p>
<h2 id="çŠ¶æ€æœºè®¾è®¡çš„æœ€ä½³å®è·µ">çŠ¶æ€æœºè®¾è®¡çš„æœ€ä½³å®è·µ<a hidden class="anchor" aria-hidden="true" href="#çŠ¶æ€æœºè®¾è®¡çš„æœ€ä½³å®è·µ">#</a></h2>
<p>åœ¨ä»£ç å®ç°å±‚é¢ï¼Œéœ€è¦åšåˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<p><strong>åˆ†ç¦»çŠ¶æ€å’Œå¤„ç†é€»è¾‘</strong>ï¼šä½¿ç”¨çŠ¶æ€æ¨¡å¼ï¼Œå°†æ¯ä¸ªçŠ¶æ€çš„è¡Œä¸ºå°è£…åœ¨å„è‡ªçš„ç±»ä¸­ã€‚
<strong>ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å‹</strong>ï¼šé€šè¿‡äº‹ä»¶æ¥è§¦å‘çŠ¶æ€è½¬æ¢ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨çŠ¶æ€æ–¹æ³•ã€‚
<strong>ç¡®ä¿å¯è¿½è¸ªæ€§</strong>ï¼šçŠ¶æ€è½¬æ¢åº”è¯¥èƒ½è¢«è®°å½•å’Œè¿½è¸ªï¼Œä»¥ä¾¿äºæ•…éšœæ’æŸ¥å’Œå®¡è®¡ã€‚</p>
<h2 id="å¸¸è§ä»£ç å®ç°è¯¯åŒº">å¸¸è§ä»£ç å®ç°è¯¯åŒº<a hidden class="anchor" aria-hidden="true" href="#å¸¸è§ä»£ç å®ç°è¯¯åŒº">#</a></h2>
<p>ç»å¸¸çœ‹åˆ°å·¥ä½œå‡ å¹´çš„åŒå­¦å®ç°çŠ¶æ€æœºæ—¶ï¼Œä»ç„¶ä½¿ç”¨if elseæˆ–switch caseæ¥å†™ã€‚è¿™æ˜¯ä¸å¯¹çš„ï¼Œä¼šè®©å®ç°å˜å¾—å¤æ‚ï¼Œä¸”å®¹æ˜“å‡ºç°é—®é¢˜ã€‚</p>
<p>ç”šè‡³ç›´æ¥åœ¨è®¢å•çš„é¢†åŸŸæ¨¡å‹é‡Œé¢ä½¿ç”¨Stringæ¥å®šä¹‰ï¼Œè€Œä¸æ˜¯æŠŠçŠ¶æ€æ¨¡å¼å°è£…å•ç‹¬çš„ç±»ã€‚
è¿˜æœ‰å°±æ˜¯ç›´æ¥è°ƒç”¨é¢†åŸŸæ¨¡å‹æ›´æ–°çŠ¶æ€ï¼Œè€Œä¸æ˜¯é€šè¿‡äº‹ä»¶æ¥é©±åŠ¨ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// é”™è¯¯çš„ä»£ç ç¤ºä¾‹1ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">if</span> (status.<span style="color:#007f7f">equals</span>(<span style="color:#0ff;font-weight:bold">&#34;PAYING&#34;</span>) {
</span></span><span style="display:flex;"><span>    status = <span style="color:#0ff;font-weight:bold">&#34;SUCCESS&#34;</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//    ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// é”™è¯¯çš„ä»£ç ç¤ºä¾‹2ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> notify(PaymentNotifyMessage message) {
</span></span><span style="display:flex;"><span>    PaymentModel paymentModel = loadPaymentModel(message.<span style="color:#007f7f">getPaymentId</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ç›´æ¥è®¾ç½®çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    paymentModel.<span style="color:#007f7f">setStatus</span>(PaymentStatus.<span style="color:#007f7f">valueOf</span>(message.<span style="color:#007f7f">status</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å…¶å®ƒä¸šåŠ¡å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#007f7f">// é”™è¯¯çš„ä»£ç ç¤ºä¾‹3ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transition(Event event) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">switch</span> (currentState) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">case</span> INIT:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (event == Event.<span style="color:#007f7f">PAYING</span>) {
</span></span><span style="display:flex;"><span>                currentState = State.<span style="color:#007f7f">PAYING</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (event == Event.<span style="color:#007f7f">SUCESS</span>) {
</span></span><span style="display:flex;"><span>                currentState = State.<span style="color:#007f7f">SUCESS</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (event == Event.<span style="color:#007f7f">FAIL</span>) {
</span></span><span style="display:flex;"><span>                currentState = State.<span style="color:#007f7f">FAIL</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä»£ç å®ç°">ä»£ç å®ç°<a hidden class="anchor" aria-hidden="true" href="#ä»£ç å®ç°">#</a></h2>
<p>å®šä¹‰çŠ¶æ€åŸºç±»</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * çŠ¶æ€åŸºç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> BaseStatus {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®šä¹‰äº‹ä»¶åŸºç±»</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * äº‹ä»¶åŸºç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> BaseEvent {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®šä¹‰â€œçŠ¶æ€-äº‹ä»¶å¯¹â€ï¼Œ<strong>æŒ‡å®šçš„çŠ¶æ€åªèƒ½æ¥å—æŒ‡å®šçš„äº‹ä»¶</strong></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * çŠ¶æ€äº‹ä»¶å¯¹ï¼ŒæŒ‡å®šçš„çŠ¶æ€åªèƒ½æ¥å—æŒ‡å®šçš„äº‹ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> StatusEventPair&lt;S <span style="color:#fff;font-weight:bold">extends</span> BaseStatus, E <span style="color:#fff;font-weight:bold">extends</span> BaseEvent&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * æŒ‡å®šçš„çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> S status;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * å¯æ¥å—çš„äº‹ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> E event;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> StatusEventPair(S status, E event) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">status</span> = status;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">event</span> = event;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> equals(Object obj) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (obj <span style="color:#fff;font-weight:bold">instanceof</span> StatusEventPair) {
</span></span><span style="display:flex;"><span>            StatusEventPair&lt;S, E&gt; other = (StatusEventPair&lt;S, E&gt;)obj;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">status</span>.<span style="color:#007f7f">equals</span>(other.<span style="color:#007f7f">status</span>) &amp;&amp; <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">event</span>.<span style="color:#007f7f">equals</span>(other.<span style="color:#007f7f">event</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">int</span> hashCode() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è¿™é‡Œä½¿ç”¨çš„æ˜¯googleçš„guavaåŒ…ã€‚com.google.common.base.Objects
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> Objects.<span style="color:#007f7f">hashCode</span>(status, event);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®šä¹‰çŠ¶æ€æœº</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * çŠ¶æ€æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> StateMachine&lt;S <span style="color:#fff;font-weight:bold">extends</span> BaseStatus, E <span style="color:#fff;font-weight:bold">extends</span> BaseEvent&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;StatusEventPair&lt;S, E&gt;, S&gt; statusEventMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * åªæ¥å—æŒ‡å®šçš„å½“å‰çŠ¶æ€ä¸‹ï¼ŒæŒ‡å®šçš„äº‹ä»¶è§¦å‘ï¼Œå¯ä»¥åˆ°è¾¾çš„æŒ‡å®šç›®æ ‡çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> accept(S sourceStatus, E event, S targetStatus) {
</span></span><span style="display:flex;"><span>        statusEventMap.<span style="color:#007f7f">put</span>(<span style="color:#fff;font-weight:bold">new</span> StatusEventPair&lt;&gt;(sourceStatus, event), targetStatus);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * é€šè¿‡æºçŠ¶æ€å’Œäº‹ä»¶ï¼Œè·å–ç›®æ ‡çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> S getTargetStatus(S sourceStatus, E event) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> statusEventMap.<span style="color:#007f7f">get</span>(<span style="color:#fff;font-weight:bold">new</span> StatusEventPair&lt;&gt;(sourceStatus, event));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®šä¹‰æ”¯ä»˜çš„çŠ¶æ€æœºã€‚æ³¨ï¼š<strong>æ”¯ä»˜ã€é€€æ¬¾ç­‰ä¸åŒçš„ä¸šåŠ¡çŠ¶æ€æœºæ˜¯ç‹¬ç«‹çš„</strong>ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * æ”¯ä»˜çŠ¶æ€æœº
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">enum</span> PaymentStatus <span style="color:#fff;font-weight:bold">implements</span> BaseStatus {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    INIT(<span style="color:#0ff;font-weight:bold">&#34;INIT&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;åˆå§‹åŒ–&#34;</span>),
</span></span><span style="display:flex;"><span>    PAYING(<span style="color:#0ff;font-weight:bold">&#34;PAYING&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜ä¸­&#34;</span>),
</span></span><span style="display:flex;"><span>    PAID(<span style="color:#0ff;font-weight:bold">&#34;PAID&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜æˆåŠŸ&#34;</span>),
</span></span><span style="display:flex;"><span>    FAILED(<span style="color:#0ff;font-weight:bold">&#34;FAILED&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜å¤±è´¥&#34;</span>),
</span></span><span style="display:flex;"><span>    ;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ”¯ä»˜çŠ¶æ€æœºå†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> StateMachine&lt;PaymentStatus, PaymentEvent&gt; STATE_MACHINE = <span style="color:#fff;font-weight:bold">new</span> StateMachine&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åˆå§‹çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        STATE_MACHINE.<span style="color:#007f7f">accept</span>(<span style="color:#fff;font-weight:bold">null</span>, PaymentEvent.<span style="color:#007f7f">PAY_CREATE</span>, INIT);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ”¯ä»˜ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        STATE_MACHINE.<span style="color:#007f7f">accept</span>(INIT, PaymentEvent.<span style="color:#007f7f">PAY_PROCESS</span>, PAYING);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ”¯ä»˜æˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        STATE_MACHINE.<span style="color:#007f7f">accept</span>(PAYING, PaymentEvent.<span style="color:#007f7f">PAY_SUCCESS</span>, PAID);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ”¯ä»˜å¤±è´¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        STATE_MACHINE.<span style="color:#007f7f">accept</span>(PAYING, PaymentEvent.<span style="color:#007f7f">PAY_FAIL</span>, FAILED);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String status;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æè¿°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String description;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PaymentStatus(String status, String description) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">status</span> = status;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">description</span> = description;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * é€šè¿‡æºçŠ¶æ€å’Œäº‹ä»¶ç±»å‹è·å–ç›®æ ‡çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> PaymentStatus getTargetStatus(PaymentStatus sourceStatus, PaymentEvent event) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> STATE_MACHINE.<span style="color:#007f7f">getTargetStatus</span>(sourceStatus, event);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®šä¹‰æ”¯ä»˜äº‹ä»¶ã€‚æ³¨ï¼š<strong>æ”¯ä»˜ã€é€€æ¬¾ç­‰ä¸åŒä¸šåŠ¡çš„äº‹ä»¶æ˜¯ä¸ä¸€æ ·çš„</strong>ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * æ”¯ä»˜äº‹ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">enum</span> PaymentEvent <span style="color:#fff;font-weight:bold">implements</span> BaseEvent {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ”¯ä»˜åˆ›å»º
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    PAY_CREATE(<span style="color:#0ff;font-weight:bold">&#34;PAY_CREATE&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜åˆ›å»º&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ”¯ä»˜ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    PAY_PROCESS(<span style="color:#0ff;font-weight:bold">&#34;PAY_PROCESS&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜ä¸­&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ”¯ä»˜æˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    PAY_SUCCESS(<span style="color:#0ff;font-weight:bold">&#34;PAY_SUCCESS&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜æˆåŠŸ&#34;</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ”¯ä»˜å¤±è´¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    PAY_FAIL(<span style="color:#0ff;font-weight:bold">&#34;PAY_FAIL&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;æ”¯ä»˜å¤±è´¥&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * äº‹ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String event;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * äº‹ä»¶æè¿°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String description;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PaymentEvent(String event, String description) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">event</span> = event;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">description</span> = description;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æ”¯ä»˜å•æ¨¡å‹ä¸­å£°æ˜çŠ¶æ€å’Œæ ¹æ®äº‹ä»¶æ¨è¿›çŠ¶æ€çš„æ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * æ”¯ä»˜å•æ¨¡å‹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PaymentModel {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * å…¶å®ƒæ‰€æœ‰å­—æ®µçœç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ä¸Šæ¬¡çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> PaymentStatus lastStatus;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å½“å‰çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> PaymentStatus currentStatus;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * æ ¹æ®äº‹ä»¶æ¨è¿›çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transferStatusByEvent(PaymentEvent event) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ ¹æ®å½“å‰çŠ¶æ€å’Œäº‹ä»¶ï¼Œå»è·å–ç›®æ ‡çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        PaymentStatus targetStatus = PaymentStatus.<span style="color:#007f7f">getTargetStatus</span>(currentStatus, event);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å¦‚æœç›®æ ‡çŠ¶æ€ä¸ä¸ºç©ºï¼Œè¯´æ˜æ˜¯å¯ä»¥æ¨è¿›çš„
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (targetStatus != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            lastStatus = currentStatus;
</span></span><span style="display:flex;"><span>            currentStatus = targetStatus;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// ç›®æ ‡çŠ¶æ€ä¸ºç©ºï¼Œè¯´æ˜æ˜¯éæ³•æ¨è¿›ï¼Œè¿›å…¥å¼‚å¸¸å¤„ç†ï¼Œè¿™é‡Œåªæ˜¯æŠ›å‡ºå»ï¼Œç”±è°ƒç”¨è€…å»å…·ä½“å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> StateMachineException(currentStatus, event, <span style="color:#0ff;font-weight:bold">&#34;çŠ¶æ€è½¬æ¢å¤±è´¥&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»£ç æ³¨é‡Šå·²ç»å†™å¾—å¾ˆæ¸…æ¥šï¼Œå…¶ä¸­StateMachineExceptionæ˜¯è‡ªå®šä¹‰ï¼Œä¸æƒ³å®šä¹‰çš„è¯ï¼Œç›´æ¥ä½¿ç”¨RuntimeExceptionä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<p>åœ¨æ”¯ä»˜ä¸šåŠ¡ä»£ç ä¸­çš„ä½¿ç”¨ï¼š<strong>åªéœ€è¦paymentModel.transferStatusByEvent(PaymentEvent.valueOf(message.getEvent()))</strong></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * æ”¯ä»˜é¢†åŸŸåŸŸæœåŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PaymentDomainServiceImpl <span style="color:#fff;font-weight:bold">implements</span> PaymentDomainService {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * æ”¯ä»˜ç»“æœé€šçŸ¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> notify(PaymentNotifyMessage message) {
</span></span><span style="display:flex;"><span>        PaymentModel paymentModel = loadPaymentModel(message.<span style="color:#007f7f">getPaymentId</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// çŠ¶æ€æ¨è¿›
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            paymentModel.<span style="color:#007f7f">transferStatusByEvent</span>(PaymentEvent.<span style="color:#007f7f">valueOf</span>(message.<span style="color:#007f7f">getEvent</span>()));
</span></span><span style="display:flex;"><span>            savePaymentModel(paymentModel);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å…¶å®ƒä¸šåŠ¡å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ... ...
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (StateMachineException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å¼‚å¸¸å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ... ...
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å¼‚å¸¸å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ... ...
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„ä»£ç åªéœ€è¦åŠ å®Œå–„å¼‚å¸¸å¤„ç†ï¼Œä¼˜åŒ–ä¸€ä¸‹æ³¨é‡Šï¼Œå°±å¯ä»¥ç›´æ¥ç”¨èµ·æ¥ã€‚</p>
<p>å¥½å¤„ï¼š</p>
<ol>
<li>å®šä¹‰äº†æ˜ç¡®çš„çŠ¶æ€ã€äº‹ä»¶ã€‚</li>
<li>çŠ¶æ€æœºçš„æ¨è¿›ï¼Œ<strong>åªèƒ½é€šè¿‡â€œå½“å‰çŠ¶æ€ã€äº‹ä»¶ã€ç›®æ ‡çŠ¶æ€â€æ¥æ¨è¿›</strong>ï¼Œä¸èƒ½é€šè¿‡if else æˆ–case switchæ¥ç›´æ¥å†™ã€‚æ¯”å¦‚ï¼šSTATE_MACHINE.accept(INIT, PaymentEvent.PAY_PROCESS, PAYING);</li>
<li>é¿å…ç»ˆæ€å˜æ›´ã€‚æ¯”å¦‚çº¿ä¸Šç¢°åˆ°if elseå†™çŠ¶æ€æœºï¼Œæ¸ é“å¼‚æ­¥é€šçŸ¥æ¯”åŒæ­¥è¿”å›è¿˜å¿«ï¼Œå¼‚æ­¥é€šçŸ¥å›æ¥æŠŠè®¢å•æ›´æ–°ä¸ºâ€œPAIEDâ€ï¼Œç„¶ååŒæ­¥è¿”å›çš„ä»£ç æŠŠå•æ®é‡æ–°æ¨è¿›åˆ°PAYINGã€‚</li>
</ol>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/other/">other</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>