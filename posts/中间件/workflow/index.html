<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>workflow | Wjy&#39;s Blog</title>
<meta name="keywords" content="中间件">
<meta name="description" content="activiti
官网">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/">
  <meta property="og:site_name" content="Wjy&#39;s Blog">
  <meta property="og:title" content="workflow">
  <meta property="og:description" content="activiti 官网">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-10-23T10:53:04+00:00">
    <meta property="article:modified_time" content="2019-10-23T10:53:04+00:00">
    <meta property="article:tag" content="中间件">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="workflow">
<meta name="twitter:description" content="activiti
官网">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "workflow",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "workflow",
  "name": "workflow",
  "description": "activiti 官网\n",
  "keywords": [
    "中间件"
  ],
  "articleBody": "activiti 官网\n核心7大接口，28张表 7大接口 RepositoryService：提供一系列管理流程部署和流程定义的API。 RuntimeService：在流程运行时对流程实例进行管理与控制。 TaskService：对流程任务进行管理，例如任务提醒、任务完成和创建任务等。 IdentityService：提供对流程角色数据进行管理的API，这些角色数据包括用户组、用户及它们之间的关系。 ManagementService：提供对流程引擎进行管理和维护的服务。 HistoryService：对流程的历史数据进行操作，包括查询、删除这些历史数据。 FormService：表单服务。 28张表 act_ge_ 通用数据表，ge是general的缩写 act_hi_ 历史数据表，hi是history的缩写，对应HistoryService接口 act_id_ 身份数据表，id是identity的缩写，对应IdentityService接口 act_re_ 流程存储表，re是repository的缩写，对应RepositoryService接口，存储流程部署和流程定义等静态数据 act_ru_ 运行时数据表，ru是runtime的缩写，对应RuntimeService接口和TaskService接口，存储流程实例和用户任务等动态数据 创建BPMN业务流程模型 将Activiti提供的流程设计器应用activiti-app.war部署到Tomcat的webapps目录。 创建新的MySql数据库。修改activiti-app\\WEB-INF\\classes\\META-INF\\activiti-app目录下的activiti-app.properties配置文件，默认使用H2内存数据库，创建的模型重启后会丢失，改成使用MySql数据库。作者：jessehua 浏览器访问http://localhost:8080/activiti-app，登录账户：admin：test 创建一个请假审批流程图 给每个用户任务指派候选组（有权限执行当前任务的角色） 排他网关设置条件分支表达式 导出流程图为.bpmn20.xml文件 Spring Boot与Activiti 6.0整合 pom文件中添加依赖 1 2 3 4 5 org.activiti activiti-spring-boot-starter-basic 6.0.0 将导出的.bpmn20.xml文件拷贝到项目文件夹/resources/processes下 application.properties文件添加配置项 spring.activiti.database-schema-update=true databaseSchemaUpdate配置项可以设置流程引擎启动和关闭时数据库执行的策略。 databaseSchemaUpdate有以下四个值： false：false为默认值，设置为该值后，Activiti在启动时，会对比数据库表中保存的版本，如果没有表或者版本不匹配时，将在启动时抛出异常。 true：设置为该值后，Activiti会对数据库中所有的表进行更新，如果表不存在，则Activiti会自动创建。 create-drop：Activiti启动时，会执行数据库表的创建操作，在Activiti关闭时，执行数据库表的删除操作。 drop-create：Activiti启动时，执行数据库表的删除操作在Activiti关闭时，会执行数据库表的创建操作。 启动应用，会在数据库里创建28张表，表创建好之后停止应用。application.properties文件修改配置项 #每次应用启动不检查Activiti数据表是否存在及版本号是否匹配，提升应用启动速度 spring.activiti.database-schema-update=false\napplication.properties文件增加配置项 #保存历史数据级别设置为full最高级别，便于历史数据的追溯 spring.activiti.history-level=full 对于历史数据，保存到何种粒度，Activiti提供了history-level属性对其进行配置。history-level属性有点像log4j的日志输出级别，该属性有以下四个值：\nnone：不保存任何的历史数据，因此，在流程执行过程中，这是最高效的。 activity：级别高于none，保存流程实例与流程行为，其他数据不保存。 audit：除activity级别会保存的数据外，还会保存全部的流程任务及其属性。audit为history的默认值。 full：保存历史数据的最高级别，除了会保存audit级别的数据外，还会保存其他全部流程相关的细节数据，包括一些流程参数等。 完成以上步骤，就可以在程序中使用自动注入的方式，使用Activiti的7大接口。 1 2 3 4 5 6 7 8 9 10 11 12 @Autowired private RuntimeService runtimeService; @Autowired private TaskService taskService; @Autowired private IdentityService identityService; @Autowired private RepositoryService repositoryService; @Autowired private ProcessEngine processEngine; @Autowired private HistoryService historyService; 项目中的用户、角色与Activiti中的用户、用户组整合 每个项目都有自己的用户、角色表，Activiti也有自己的用户、用户组表。因此项目中的用户、角色与Activiti中的用户、用户组要做整合。\n1 2 3 4 5 6 7 8 9 10 11 12 13 //项目中每创建一个新用户，对应的要创建一个Activiti用户 //两者的userId和userName一致 User admin=identityService.newUser(\"1\"); admin.setLastName(\"admin\"); identityService.saveUser(admin); //项目中每创建一个角色，对应的要创建一个Activiti用户组 Group adminGroup=identityService.newGroup(\"1\"); adminGroup.setName(\"admin\"); identityService.saveGroup(adminGroup); //用户与用户组关系绑定 identityService.createMembership(\"1\",\"1\"); 请假审批流程 请假申请和请假审批数据库表设计 表设计原则：流程数据和业务数据相分离。Activiti相关表只负责流程的跳转、走向等。流程中产生的业务表单数据、审批意见、附件等存储在开发人员定义的业务表中。流程数据和业务数据之间通过processInstanceId(流程实例ID)和业务数据主键相互关联。 为什么不使用Activiti相关表来存储表单数据和附件？ Activiti为了应用的灵活性和通用性采用了纵表的方式存储表单数据。假设一条请假申请表单数据有10个字段，那就需要10条记录存储原本横表只需要一条记录存储的数据。采用纵表的方式会有如下问题： 会有大量的冗余数据并且数据量会急剧的增长 查询语句复杂，查询效率低 尤其不适合做后期的统计报表分析 Activiti存储附件使用Blob数据格式，文件存储在数据库里，数据库的数据文件会变得超大，不利于数据库备份和迁移。\n请假申请表：\n字段 类型 空 注释 form_id varchar(32) 否 表单id process_instance_id varchar(64) 否 activiti流程实例id user_id int(11) 否 用户id days tinyint(3) 否 请假天数 begin_date datetime 否 开始日期 end_date datetime 否 结束日期 vacation_type tinyint(3) 否 请假类型：0带薪假，1病假，2事假 reason varchar(200) 是 请假原因 process_status tinyint(3) 否 流程状态：0申请，1审批中，已完成 create_time datetime 否 创建时间 update_time datetime 否 更新时间 请假审批表：\n字段 类型 空 注释 audit_id varchar(32) 否 审批id process_instance_id varchar(64) 否 activiti流程实例id task_id varchar(64) 否 activiti任务id user_id int(11) 否 用户id audit_result tinyint(3) 否 审批结果：0不通过，1通过 comment varchar(500) 是 审批意见 audit_time datetime 否 审批日期 填写请假申请表单，启动流程实例 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 //启动流程实例，字符串\"vacation\"是BPMN模型文件里process元素的id ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(\"vacation\"); //流程实例启动后，流程会跳转到请假申请节点 Task vacationApply = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult(); //设置请假申请任务的执行人 taskService.setAssignee(vacationApply.getId(), req.getUserId().toString()); //设置流程参数：请假天数和表单ID //流程引擎会根据请假天数days\u003e3判断流程走向 //formId是用来将流程数据和表单数据关联起来 Map args = new HashMap\u003c\u003e(); args.put(\"days\", req.getDays()); args.put(\"formId\", formId); //完成请假申请任务 taskService.complete(vacationApply.getId(), args); 待审批列表 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 //查出当前登录用户所在的用户组 List groups = identityService.createGroupQuery() .groupMember(String.valueOf(userId)).list(); List groupNames = groups.stream() .map(group -\u003e group.getName()).collect(Collectors.toList()); //查询用户组的待审批请假流程列表 List tasks = taskService.createTaskQuery() .processDefinitionKey(\"vacation\") .taskCandidateGroupIn(groupNames) .listPage(pageNum - 1, pageSize); //根据流程实例ID查询请假申请表单数据 List processInstanceIds = tasks.stream() .map(task -\u003e task.getProcessInstanceId()) .collect(Collectors.toList()); List vacationApplyList = vacationRepository.getVacationApplyList(processInstanceIds); 请假审批功能 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 //查询当前审批节点 Task vacationAudit = taskService.createTaskQuery() .taskId(req.getTaskId()).singleResult(); if (req.getAuditResult() == 1) {//审批通过 //设置流程参数：审批ID Map args = new HashMap\u003c\u003e(); args.put(\"auditId\", auditId); //设置审批任务的执行人 taskService.claim(vacationAudit.getId(), req.getUserId().toString()); //完成审批任务 taskService.complete(vacationAudit.getId(), args); } else { //审批不通过，结束流程 runtimeService.deleteProcessInstance(vacationAudit.getProcessInstanceId(), auditId); } 查看流程图功能 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 //controller层代码 @RequestMapping(value = \"/image\", method = RequestMethod.GET) public void image(HttpServletResponse response, @RequestParam String processInstanceId) { try { InputStream is = vacationService.getDiagram(processInstanceId); if (is == null) return; response.setContentType(\"image/png\"); BufferedImage image = ImageIO.read(is); OutputStream out = response.getOutputStream(); ImageIO.write(image, \"png\", out); is.close(); out.close(); } catch (Exception ex) { logger.error(\"查看流程图失败\", ex); } } //service层代码 @Override public InputStream getDiagram(String processInstanceId) { //获得流程实例 ProcessInstance processInstance = runtimeService.createProcessInstanceQuery() .processInstanceId(processInstanceId).singleResult(); String processDefinitionId = StringUtils.EMPTY; if (processInstance == null) { //查询已经结束的流程实例 HistoricProcessInstance processInstanceHistory = historyService.createHistoricProcessInstanceQuery() .processInstanceId(processInstanceId).singleResult(); if (processInstanceHistory == null) return null; else processDefinitionId = processInstanceHistory.getProcessDefinitionId(); } else { processDefinitionId = processInstance.getProcessDefinitionId(); } //使用宋体 String fontName = \"宋体\"; //获取BPMN模型对象 BpmnModel model = repositoryService.getBpmnModel(processDefinitionId); //获取流程实例当前的节点，需要高亮显示 List currentActs = Collections.EMPTY_LIST; if (processInstance != null) currentActs = runtimeService.getActiveActivityIds(processInstance.getId()); return processEngine.getProcessEngineConfiguration() .getProcessDiagramGenerator() .generateDiagram(model, \"png\", currentActs, new ArrayList(), fontName, fontName, fontName, null, 1.0); } 参考地址\n其他学习activiti的博文 其他学习activiti的博文 其他学习activiti的博文\n",
  "wordCount" : "3438",
  "inLanguage": "en",
  "datePublished": "2019-10-23T10:53:04Z",
  "dateModified": "2019-10-23T10:53:04Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

  <script id="MathJax-script" async src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-chtml.min.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath:  [['\\(', '\\)'], ['$', '$']],  
    }
  };
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      workflow
    </h1>
    <div class="post-meta"><span title='2019-10-23 10:53:04 +0000 UTC'>2019-10-23</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#activiti" aria-label="activiti">activiti</a><ul>
                        
                <li>
                    <a href="#%e6%a0%b8%e5%bf%837%e5%a4%a7%e6%8e%a5%e5%8f%a328%e5%bc%a0%e8%a1%a8" aria-label="核心7大接口，28张表">核心7大接口，28张表</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%babpmn%e4%b8%9a%e5%8a%a1%e6%b5%81%e7%a8%8b%e6%a8%a1%e5%9e%8b" aria-label="创建BPMN业务流程模型">创建BPMN业务流程模型</a></li>
                <li>
                    <a href="#spring-boot%e4%b8%8eactiviti-60%e6%95%b4%e5%90%88" aria-label="Spring Boot与Activiti 6.0整合">Spring Boot与Activiti 6.0整合</a></li>
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae%e4%b8%ad%e7%9a%84%e7%94%a8%e6%88%b7%e8%a7%92%e8%89%b2%e4%b8%8eactiviti%e4%b8%ad%e7%9a%84%e7%94%a8%e6%88%b7%e7%94%a8%e6%88%b7%e7%bb%84%e6%95%b4%e5%90%88" aria-label="项目中的用户、角色与Activiti中的用户、用户组整合">项目中的用户、角色与Activiti中的用户、用户组整合</a></li>
                <li>
                    <a href="#%e8%af%b7%e5%81%87%e5%ae%a1%e6%89%b9%e6%b5%81%e7%a8%8b" aria-label="请假审批流程">请假审批流程</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="activiti">activiti<a hidden class="anchor" aria-hidden="true" href="#activiti">#</a></h1>
<p><a href="https://www.activiti.org/">官网</a></p>
<h2 id="核心7大接口28张表">核心7大接口，28张表<a hidden class="anchor" aria-hidden="true" href="#核心7大接口28张表">#</a></h2>
<p><strong>7大接口</strong>
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/1.jpg"></p>
<ul>
<li>RepositoryService：提供一系列管理流程部署和流程定义的API。</li>
<li>RuntimeService：在流程运行时对流程实例进行管理与控制。</li>
<li>TaskService：对流程任务进行管理，例如任务提醒、任务完成和创建任务等。</li>
<li>IdentityService：提供对流程角色数据进行管理的API，这些角色数据包括用户组、用户及它们之间的关系。</li>
<li>ManagementService：提供对流程引擎进行管理和维护的服务。</li>
<li>HistoryService：对流程的历史数据进行操作，包括查询、删除这些历史数据。</li>
<li>FormService：表单服务。</li>
</ul>
<p><strong>28张表</strong>
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/2.jpg"></p>
<ul>
<li>act_ge_ 通用数据表，ge是general的缩写</li>
<li>act_hi_ 历史数据表，hi是history的缩写，对应HistoryService接口</li>
<li>act_id_ 身份数据表，id是identity的缩写，对应IdentityService接口</li>
<li>act_re_ 流程存储表，re是repository的缩写，对应RepositoryService接口，存储流程部署和流程定义等静态数据</li>
<li>act_ru_ 运行时数据表，ru是runtime的缩写，对应RuntimeService接口和TaskService接口，存储流程实例和用户任务等动态数据</li>
</ul>
<h2 id="创建bpmn业务流程模型">创建BPMN业务流程模型<a hidden class="anchor" aria-hidden="true" href="#创建bpmn业务流程模型">#</a></h2>
<ol>
<li>将Activiti提供的流程设计器应用activiti-app.war部署到Tomcat的webapps目录。</li>
<li>创建新的MySql数据库。修改activiti-app\WEB-INF\classes\META-INF\activiti-app目录下的activiti-app.properties配置文件，默认使用H2内存数据库，创建的模型重启后会丢失，改成使用MySql数据库。作者：jessehua</li>
<li>浏览器访问http://localhost:8080/activiti-app，登录账户：admin：test</li>
<li>创建一个请假审批流程图
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/3.jpg">
给每个用户任务指派候选组（有权限执行当前任务的角色）
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/4.jpg">
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/5.jpg">
排他网关设置条件分支表达式
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/6.jpg">
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/7.jpg">
导出流程图为.bpmn20.xml文件
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/8.jpg"></li>
</ol>
<h2 id="spring-boot与activiti-60整合">Spring Boot与Activiti 6.0整合<a hidden class="anchor" aria-hidden="true" href="#spring-boot与activiti-60整合">#</a></h2>
<ol>
<li>pom文件中添加依赖</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;dependency&gt;
</span></span><span style="display:flex;"><span>    &lt;groupId&gt;org.activiti&lt;/groupId&gt;
</span></span><span style="display:flex;"><span>    &lt;artifactId&gt;activiti-spring-boot-starter-basic&lt;/artifactId&gt;
</span></span><span style="display:flex;"><span>    &lt;version&gt;6.0.0&lt;/version&gt;
</span></span><span style="display:flex;"><span>&lt;/dependency&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>将导出的.bpmn20.xml文件拷贝到项目文件夹/resources/processes下</li>
<li>application.properties文件添加配置项
<code>spring.activiti.database-schema-update=true</code>
databaseSchemaUpdate配置项可以设置流程引擎启动和关闭时数据库执行的策略。
databaseSchemaUpdate有以下四个值：</li>
</ol>
<ul>
<li>false：false为默认值，设置为该值后，Activiti在启动时，会对比数据库表中保存的版本，如果没有表或者版本不匹配时，将在启动时抛出异常。</li>
<li>true：设置为该值后，Activiti会对数据库中所有的表进行更新，如果表不存在，则Activiti会自动创建。</li>
<li>create-drop：Activiti启动时，会执行数据库表的创建操作，在Activiti关闭时，执行数据库表的删除操作。</li>
<li>drop-create：Activiti启动时，执行数据库表的删除操作在Activiti关闭时，会执行数据库表的创建操作。</li>
</ul>
<ol start="4">
<li>
<p>启动应用，会在数据库里创建28张表，表创建好之后停止应用。application.properties文件修改配置项
#每次应用启动不检查Activiti数据表是否存在及版本号是否匹配，提升应用启动速度
<code>spring.activiti.database-schema-update=false</code></p>
</li>
<li>
<p>application.properties文件增加配置项
#保存历史数据级别设置为full最高级别，便于历史数据的追溯
<code>spring.activiti.history-level=full</code>
对于历史数据，保存到何种粒度，Activiti提供了history-level属性对其进行配置。history-level属性有点像log4j的日志输出级别，该属性有以下四个值：</p>
</li>
</ol>
<ul>
<li>none：不保存任何的历史数据，因此，在流程执行过程中，这是最高效的。</li>
<li>activity：级别高于none，保存流程实例与流程行为，其他数据不保存。</li>
<li>audit：除activity级别会保存的数据外，还会保存全部的流程任务及其属性。audit为history的默认值。</li>
<li>full：保存历史数据的最高级别，除了会保存audit级别的数据外，还会保存其他全部流程相关的细节数据，包括一些流程参数等。</li>
</ul>
<ol start="6">
<li>完成以上步骤，就可以在程序中使用自动注入的方式，使用Activiti的7大接口。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span>private RuntimeService runtimeService;
</span></span><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span>private TaskService taskService;
</span></span><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span>private IdentityService identityService;
</span></span><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span>private RepositoryService repositoryService;
</span></span><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span>private ProcessEngine processEngine;
</span></span><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span>private HistoryService historyService;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="项目中的用户角色与activiti中的用户用户组整合">项目中的用户、角色与Activiti中的用户、用户组整合<a hidden class="anchor" aria-hidden="true" href="#项目中的用户角色与activiti中的用户用户组整合">#</a></h2>
<p>每个项目都有自己的用户、角色表，Activiti也有自己的用户、用户组表。因此项目中的用户、角色与Activiti中的用户、用户组要做整合。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>//项目中每创建一个新用户，对应的要创建一个Activiti用户
</span></span><span style="display:flex;"><span>//两者的userId和userName一致
</span></span><span style="display:flex;"><span>User admin=identityService.newUser(&#34;1&#34;);
</span></span><span style="display:flex;"><span>admin.setLastName(&#34;admin&#34;);
</span></span><span style="display:flex;"><span>identityService.saveUser(admin);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>//项目中每创建一个角色，对应的要创建一个Activiti用户组
</span></span><span style="display:flex;"><span>Group adminGroup=identityService.newGroup(&#34;1&#34;);
</span></span><span style="display:flex;"><span>adminGroup.setName(&#34;admin&#34;);
</span></span><span style="display:flex;"><span>identityService.saveGroup(adminGroup);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>//用户与用户组关系绑定
</span></span><span style="display:flex;"><span>identityService.createMembership(&#34;1&#34;,&#34;1&#34;);
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="请假审批流程">请假审批流程<a hidden class="anchor" aria-hidden="true" href="#请假审批流程">#</a></h2>
<ol>
<li>请假申请和请假审批数据库表设计
表设计原则：流程数据和业务数据相分离。Activiti相关表只负责流程的跳转、走向等。流程中产生的业务表单数据、审批意见、附件等存储在开发人员定义的业务表中。流程数据和业务数据之间通过processInstanceId(流程实例ID)和业务数据主键相互关联。
为什么不使用Activiti相关表来存储表单数据和附件？
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/9.jpg">
Activiti为了应用的灵活性和通用性采用了纵表的方式存储表单数据。假设一条请假申请表单数据有10个字段，那就需要10条记录存储原本横表只需要一条记录存储的数据。采用纵表的方式会有如下问题：</li>
</ol>
<ul>
<li>会有大量的冗余数据并且数据量会急剧的增长</li>
<li>查询语句复杂，查询效率低</li>
<li>尤其不适合做后期的统计报表分析
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/10.jpg"></li>
</ul>
<p>Activiti存储附件使用Blob数据格式，文件存储在数据库里，数据库的数据文件会变得超大，不利于数据库备份和迁移。</p>
<p>请假申请表：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>空</th>
<th>注释</th>
</tr>
</thead>
<tbody>
<tr>
<td>form_id</td>
<td>varchar(32)</td>
<td>否</td>
<td>表单id</td>
</tr>
<tr>
<td>process_instance_id</td>
<td>varchar(64)</td>
<td>否</td>
<td>activiti流程实例id</td>
</tr>
<tr>
<td>user_id</td>
<td>int(11)</td>
<td>否</td>
<td>用户id</td>
</tr>
<tr>
<td>days</td>
<td>tinyint(3)</td>
<td>否</td>
<td>请假天数</td>
</tr>
<tr>
<td>begin_date</td>
<td>datetime</td>
<td>否</td>
<td>开始日期</td>
</tr>
<tr>
<td>end_date</td>
<td>datetime</td>
<td>否</td>
<td>结束日期</td>
</tr>
<tr>
<td>vacation_type</td>
<td>tinyint(3)</td>
<td>否</td>
<td>请假类型：0带薪假，1病假，2事假</td>
</tr>
<tr>
<td>reason</td>
<td>varchar(200)</td>
<td>是</td>
<td>请假原因</td>
</tr>
<tr>
<td>process_status</td>
<td>tinyint(3)</td>
<td>否</td>
<td>流程状态：0申请，1审批中，已完成</td>
</tr>
<tr>
<td>create_time</td>
<td>datetime</td>
<td>否</td>
<td>创建时间</td>
</tr>
<tr>
<td>update_time</td>
<td>datetime</td>
<td>否</td>
<td>更新时间</td>
</tr>
</tbody>
</table>
<p>请假审批表：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>空</th>
<th>注释</th>
</tr>
</thead>
<tbody>
<tr>
<td>audit_id</td>
<td>varchar(32)</td>
<td>否</td>
<td>审批id</td>
</tr>
<tr>
<td>process_instance_id</td>
<td>varchar(64)</td>
<td>否</td>
<td>activiti流程实例id</td>
</tr>
<tr>
<td>task_id</td>
<td>varchar(64)</td>
<td>否</td>
<td>activiti任务id</td>
</tr>
<tr>
<td>user_id</td>
<td>int(11)</td>
<td>否</td>
<td>用户id</td>
</tr>
<tr>
<td>audit_result</td>
<td>tinyint(3)</td>
<td>否</td>
<td>审批结果：0不通过，1通过</td>
</tr>
<tr>
<td>comment</td>
<td>varchar(500)</td>
<td>是</td>
<td>审批意见</td>
</tr>
<tr>
<td>audit_time</td>
<td>datetime</td>
<td>否</td>
<td>审批日期</td>
</tr>
</tbody>
</table>
<ol start="2">
<li>填写请假申请表单，启动流程实例
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/11.jpg"></li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//启动流程实例，字符串&#34;vacation&#34;是BPMN模型文件里process元素的id</span>
</span></span><span style="display:flex;"><span>ProcessInstance processInstance = runtimeService.<span style="color:#007f7f">startProcessInstanceByKey</span>(<span style="color:#0ff;font-weight:bold">&#34;vacation&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//流程实例启动后，流程会跳转到请假申请节点</span>
</span></span><span style="display:flex;"><span>Task vacationApply = taskService.<span style="color:#007f7f">createTaskQuery</span>().<span style="color:#007f7f">processInstanceId</span>(processInstance.<span style="color:#007f7f">getId</span>()).<span style="color:#007f7f">singleResult</span>();
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//设置请假申请任务的执行人</span>
</span></span><span style="display:flex;"><span>taskService.<span style="color:#007f7f">setAssignee</span>(vacationApply.<span style="color:#007f7f">getId</span>(), req.<span style="color:#007f7f">getUserId</span>().<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//设置流程参数：请假天数和表单ID</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//流程引擎会根据请假天数days&gt;3判断流程走向</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//formId是用来将流程数据和表单数据关联起来</span>
</span></span><span style="display:flex;"><span>Map&lt;String, Object&gt; args = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>args.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;days&#34;</span>, req.<span style="color:#007f7f">getDays</span>());
</span></span><span style="display:flex;"><span>args.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;formId&#34;</span>, formId);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//完成请假申请任务</span>
</span></span><span style="display:flex;"><span>taskService.<span style="color:#007f7f">complete</span>(vacationApply.<span style="color:#007f7f">getId</span>(), args);
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>待审批列表
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/12.jpg"></li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//查出当前登录用户所在的用户组</span>
</span></span><span style="display:flex;"><span>List&lt;Group&gt; groups = identityService.<span style="color:#007f7f">createGroupQuery</span>()
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">groupMember</span>(String.<span style="color:#007f7f">valueOf</span>(userId)).<span style="color:#007f7f">list</span>();
</span></span><span style="display:flex;"><span>List&lt;String&gt; groupNames = groups.<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">map</span>(group -&gt; group.<span style="color:#007f7f">getName</span>()).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//查询用户组的待审批请假流程列表</span>
</span></span><span style="display:flex;"><span>List&lt;Task&gt; tasks = taskService.<span style="color:#007f7f">createTaskQuery</span>()
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">processDefinitionKey</span>(<span style="color:#0ff;font-weight:bold">&#34;vacation&#34;</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">taskCandidateGroupIn</span>(groupNames)
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">listPage</span>(pageNum - 1, pageSize);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//根据流程实例ID查询请假申请表单数据</span>
</span></span><span style="display:flex;"><span>List&lt;String&gt; processInstanceIds = tasks.<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">map</span>(task -&gt; task.<span style="color:#007f7f">getProcessInstanceId</span>())
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>List&lt;VacationApplyBasicPO&gt; vacationApplyList = 
</span></span><span style="display:flex;"><span>        vacationRepository.<span style="color:#007f7f">getVacationApplyList</span>(processInstanceIds);
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>请假审批功能
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/13.jpg"></li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//查询当前审批节点</span>
</span></span><span style="display:flex;"><span>Task vacationAudit = taskService.<span style="color:#007f7f">createTaskQuery</span>()
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">taskId</span>(req.<span style="color:#007f7f">getTaskId</span>()).<span style="color:#007f7f">singleResult</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> (req.<span style="color:#007f7f">getAuditResult</span>() == 1) {<span style="color:#007f7f">//审批通过</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//设置流程参数：审批ID</span>
</span></span><span style="display:flex;"><span>    Map&lt;String, Object&gt; args = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    args.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;auditId&#34;</span>, auditId);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//设置审批任务的执行人</span>
</span></span><span style="display:flex;"><span>    taskService.<span style="color:#007f7f">claim</span>(vacationAudit.<span style="color:#007f7f">getId</span>(), req.<span style="color:#007f7f">getUserId</span>().<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//完成审批任务</span>
</span></span><span style="display:flex;"><span>    taskService.<span style="color:#007f7f">complete</span>(vacationAudit.<span style="color:#007f7f">getId</span>(), args);
</span></span><span style="display:flex;"><span>} <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//审批不通过，结束流程</span>
</span></span><span style="display:flex;"><span>    runtimeService.<span style="color:#007f7f">deleteProcessInstance</span>(vacationAudit.<span style="color:#007f7f">getProcessInstanceId</span>(), auditId);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>查看流程图功能
<img loading="lazy" src="/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/workflow/14.jpg"></li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//controller层代码</span>
</span></span><span style="display:flex;"><span>@RequestMapping(value = <span style="color:#0ff;font-weight:bold">&#34;/image&#34;</span>, method = RequestMethod.<span style="color:#007f7f">GET</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> image(HttpServletResponse response,
</span></span><span style="display:flex;"><span> @RequestParam String processInstanceId) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        InputStream is = vacationService.<span style="color:#007f7f">getDiagram</span>(processInstanceId);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (is == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        response.<span style="color:#007f7f">setContentType</span>(<span style="color:#0ff;font-weight:bold">&#34;image/png&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        BufferedImage image = ImageIO.<span style="color:#007f7f">read</span>(is);
</span></span><span style="display:flex;"><span>        OutputStream out = response.<span style="color:#007f7f">getOutputStream</span>();
</span></span><span style="display:flex;"><span>        ImageIO.<span style="color:#007f7f">write</span>(image, <span style="color:#0ff;font-weight:bold">&#34;png&#34;</span>, out);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        is.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        out.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (Exception ex) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;查看流程图失败&#34;</span>, ex);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//service层代码</span>
</span></span><span style="display:flex;"><span>@Override
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> InputStream getDiagram(String processInstanceId) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//获得流程实例</span>
</span></span><span style="display:flex;"><span>    ProcessInstance processInstance = runtimeService.<span style="color:#007f7f">createProcessInstanceQuery</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">processInstanceId</span>(processInstanceId).<span style="color:#007f7f">singleResult</span>();
</span></span><span style="display:flex;"><span>    String processDefinitionId = StringUtils.<span style="color:#007f7f">EMPTY</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (processInstance == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//查询已经结束的流程实例</span>
</span></span><span style="display:flex;"><span>        HistoricProcessInstance processInstanceHistory =
</span></span><span style="display:flex;"><span>                historyService.<span style="color:#007f7f">createHistoricProcessInstanceQuery</span>()
</span></span><span style="display:flex;"><span>                        .<span style="color:#007f7f">processInstanceId</span>(processInstanceId).<span style="color:#007f7f">singleResult</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (processInstanceHistory == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            processDefinitionId = processInstanceHistory.<span style="color:#007f7f">getProcessDefinitionId</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        processDefinitionId = processInstance.<span style="color:#007f7f">getProcessDefinitionId</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//使用宋体</span>
</span></span><span style="display:flex;"><span>    String fontName = <span style="color:#0ff;font-weight:bold">&#34;宋体&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//获取BPMN模型对象</span>
</span></span><span style="display:flex;"><span>    BpmnModel model = repositoryService.<span style="color:#007f7f">getBpmnModel</span>(processDefinitionId);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//获取流程实例当前的节点，需要高亮显示</span>
</span></span><span style="display:flex;"><span>    List&lt;String&gt; currentActs = Collections.<span style="color:#007f7f">EMPTY_LIST</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (processInstance != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>        currentActs = runtimeService.<span style="color:#007f7f">getActiveActivityIds</span>(processInstance.<span style="color:#007f7f">getId</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> processEngine.<span style="color:#007f7f">getProcessEngineConfiguration</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">getProcessDiagramGenerator</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">generateDiagram</span>(model, <span style="color:#0ff;font-weight:bold">&#34;png&#34;</span>, currentActs, <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;String&gt;(),
</span></span><span style="display:flex;"><span>                    fontName, fontName, fontName, <span style="color:#fff;font-weight:bold">null</span>, 1.<span style="color:#007f7f">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://www.jianshu.com/p/701056e672a4">参考地址</a></p>
<p><a href="https://blog.csdn.net/Cs_hnu_scw/article/details/79059965">其他学习activiti的博文</a>
<a href="https://www.cnblogs.com/runtimeexception/p/8961395.html">其他学习activiti的博文</a>
<a href="https://www.jianshu.com/p/33085a975e47">其他学习activiti的博文</a></p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>