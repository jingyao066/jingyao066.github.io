<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>sharding | Wjy&#39;s Blog</title>
<meta name="keywords" content="ä¸­é—´ä»¶">
<meta name="description" content="å®˜ç½‘
github
Sharding-Sphereæ˜¯ä¸€å¥—å¼€æºçš„åˆ†å¸ƒå¼æ•°æ®åº“ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆç»„æˆçš„ç”Ÿæ€åœˆï¼Œå®ƒç”±Sharding-JDBCã€Sharding-Proxyå’ŒSharding-Sidecarè¿™3æ¬¾ç›¸äº’ç‹¬ç«‹çš„äº§å“ç»„æˆã€‚
ä»–ä»¬å‡æä¾›æ ‡å‡†åŒ–çš„æ•°æ®åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»ã€æŸ”æ€§äº‹åŠ¡å’Œæ•°æ®æ²»ç†åŠŸèƒ½ï¼Œå¯é€‚ç”¨äºå¦‚JavaåŒæ„ã€å¼‚æ„è¯­è¨€ã€å®¹å™¨ã€äº‘åŸç”Ÿç­‰å„ç§å¤šæ ·åŒ–çš„åº”ç”¨åœºæ™¯ã€‚
å…¶ä¸­Sharding-JDBCæœ€æ—©ç”±å½“å½“ç½‘åœ¨2016å¹´å¼€æºï¼Œåœ¨Sharding-JDBC 3.0ç‰ˆæœ¬ï¼Œæ›´åä¸ºSharding-Sphereï¼Œåæ¥åˆ›å§‹äººå¼ äº®å»äº†äº¬ä¸œã€‚åœ¨2018å¹´åº•ï¼Œé¡¹ç›®å¼€æºç»™äº†apacheåŸºé‡‘ä¼šã€‚
å‚è€ƒï¼šSharding-JDBCæºç è§£æä¸vivoçš„å®šåˆ¶å¼€å‘">
<meta name="author" content="Wjy">
<link rel="canonical" href="http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/sharding/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="sharding" />
<meta property="og:description" content="å®˜ç½‘
github
Sharding-Sphereæ˜¯ä¸€å¥—å¼€æºçš„åˆ†å¸ƒå¼æ•°æ®åº“ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆç»„æˆçš„ç”Ÿæ€åœˆï¼Œå®ƒç”±Sharding-JDBCã€Sharding-Proxyå’ŒSharding-Sidecarè¿™3æ¬¾ç›¸äº’ç‹¬ç«‹çš„äº§å“ç»„æˆã€‚
ä»–ä»¬å‡æä¾›æ ‡å‡†åŒ–çš„æ•°æ®åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»ã€æŸ”æ€§äº‹åŠ¡å’Œæ•°æ®æ²»ç†åŠŸèƒ½ï¼Œå¯é€‚ç”¨äºå¦‚JavaåŒæ„ã€å¼‚æ„è¯­è¨€ã€å®¹å™¨ã€äº‘åŸç”Ÿç­‰å„ç§å¤šæ ·åŒ–çš„åº”ç”¨åœºæ™¯ã€‚
å…¶ä¸­Sharding-JDBCæœ€æ—©ç”±å½“å½“ç½‘åœ¨2016å¹´å¼€æºï¼Œåœ¨Sharding-JDBC 3.0ç‰ˆæœ¬ï¼Œæ›´åä¸ºSharding-Sphereï¼Œåæ¥åˆ›å§‹äººå¼ äº®å»äº†äº¬ä¸œã€‚åœ¨2018å¹´åº•ï¼Œé¡¹ç›®å¼€æºç»™äº†apacheåŸºé‡‘ä¼šã€‚
å‚è€ƒï¼šSharding-JDBCæºç è§£æä¸vivoçš„å®šåˆ¶å¼€å‘" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/sharding/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-01-08T11:57:49+00:00" />
<meta property="article:modified_time" content="2020-01-08T11:57:49+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="sharding"/>
<meta name="twitter:description" content="å®˜ç½‘
github
Sharding-Sphereæ˜¯ä¸€å¥—å¼€æºçš„åˆ†å¸ƒå¼æ•°æ®åº“ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆç»„æˆçš„ç”Ÿæ€åœˆï¼Œå®ƒç”±Sharding-JDBCã€Sharding-Proxyå’ŒSharding-Sidecarè¿™3æ¬¾ç›¸äº’ç‹¬ç«‹çš„äº§å“ç»„æˆã€‚
ä»–ä»¬å‡æä¾›æ ‡å‡†åŒ–çš„æ•°æ®åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»ã€æŸ”æ€§äº‹åŠ¡å’Œæ•°æ®æ²»ç†åŠŸèƒ½ï¼Œå¯é€‚ç”¨äºå¦‚JavaåŒæ„ã€å¼‚æ„è¯­è¨€ã€å®¹å™¨ã€äº‘åŸç”Ÿç­‰å„ç§å¤šæ ·åŒ–çš„åº”ç”¨åœºæ™¯ã€‚
å…¶ä¸­Sharding-JDBCæœ€æ—©ç”±å½“å½“ç½‘åœ¨2016å¹´å¼€æºï¼Œåœ¨Sharding-JDBC 3.0ç‰ˆæœ¬ï¼Œæ›´åä¸ºSharding-Sphereï¼Œåæ¥åˆ›å§‹äººå¼ äº®å»äº†äº¬ä¸œã€‚åœ¨2018å¹´åº•ï¼Œé¡¹ç›®å¼€æºç»™äº†apacheåŸºé‡‘ä¼šã€‚
å‚è€ƒï¼šSharding-JDBCæºç è§£æä¸vivoçš„å®šåˆ¶å¼€å‘"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "sharding",
      "item": "http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/sharding/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "sharding",
  "name": "sharding",
  "description": "å®˜ç½‘ github Sharding-Sphereæ˜¯ä¸€å¥—å¼€æºçš„åˆ†å¸ƒå¼æ•°æ®åº“ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆç»„æˆçš„ç”Ÿæ€åœˆï¼Œå®ƒç”±Sharding-JDBCã€Sharding-Proxyå’ŒSharding-Sidecarè¿™3æ¬¾ç›¸äº’ç‹¬ç«‹çš„äº§å“ç»„æˆã€‚ ä»–ä»¬å‡æä¾›æ ‡å‡†åŒ–çš„æ•°æ®åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»ã€æŸ”æ€§äº‹åŠ¡å’Œæ•°æ®æ²»ç†åŠŸèƒ½ï¼Œå¯é€‚ç”¨äºå¦‚JavaåŒæ„ã€å¼‚æ„è¯­è¨€ã€å®¹å™¨ã€äº‘åŸç”Ÿç­‰å„ç§å¤šæ ·åŒ–çš„åº”ç”¨åœºæ™¯ã€‚ å…¶ä¸­Sharding-JDBCæœ€æ—©ç”±å½“å½“ç½‘åœ¨2016å¹´å¼€æºï¼Œåœ¨Sharding-JDBC 3.0ç‰ˆæœ¬ï¼Œæ›´åä¸ºSharding-Sphereï¼Œåæ¥åˆ›å§‹äººå¼ äº®å»äº†äº¬ä¸œã€‚åœ¨2018å¹´åº•ï¼Œé¡¹ç›®å¼€æºç»™äº†apacheåŸºé‡‘ä¼šã€‚\nå‚è€ƒï¼šSharding-JDBCæºç è§£æä¸vivoçš„å®šåˆ¶å¼€å‘\n",
  "keywords": [
    "ä¸­é—´ä»¶"
  ],
  "articleBody": "å®˜ç½‘ github Sharding-Sphereæ˜¯ä¸€å¥—å¼€æºçš„åˆ†å¸ƒå¼æ•°æ®åº“ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆç»„æˆçš„ç”Ÿæ€åœˆï¼Œå®ƒç”±Sharding-JDBCã€Sharding-Proxyå’ŒSharding-Sidecarè¿™3æ¬¾ç›¸äº’ç‹¬ç«‹çš„äº§å“ç»„æˆã€‚ ä»–ä»¬å‡æä¾›æ ‡å‡†åŒ–çš„æ•°æ®åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»ã€æŸ”æ€§äº‹åŠ¡å’Œæ•°æ®æ²»ç†åŠŸèƒ½ï¼Œå¯é€‚ç”¨äºå¦‚JavaåŒæ„ã€å¼‚æ„è¯­è¨€ã€å®¹å™¨ã€äº‘åŸç”Ÿç­‰å„ç§å¤šæ ·åŒ–çš„åº”ç”¨åœºæ™¯ã€‚ å…¶ä¸­Sharding-JDBCæœ€æ—©ç”±å½“å½“ç½‘åœ¨2016å¹´å¼€æºï¼Œåœ¨Sharding-JDBC 3.0ç‰ˆæœ¬ï¼Œæ›´åä¸ºSharding-Sphereï¼Œåæ¥åˆ›å§‹äººå¼ äº®å»äº†äº¬ä¸œã€‚åœ¨2018å¹´åº•ï¼Œé¡¹ç›®å¼€æºç»™äº†apacheåŸºé‡‘ä¼šã€‚\nå‚è€ƒï¼šSharding-JDBCæºç è§£æä¸vivoçš„å®šåˆ¶å¼€å‘\nä¸šåŠ¡èƒŒæ™¯ éšç€ä¸šåŠ¡å¹¶å‘è¯·æ±‚å’Œæ•°æ®è§„æ¨¡çš„ä¸æ–­æ‰©å¤§ï¼Œå•èŠ‚ç‚¹åº“è¡¨å‹åŠ›å¾€å¾€ä¼šæˆä¸ºç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚å…¬å¸ITå†…éƒ¨è¥é”€åº“å­˜ã€äº¤æ˜“è®¢å•ã€è´¢ç»å°è´¦ã€è€ƒå‹¤è®°å½•ç­‰å¤šé¢†åŸŸçš„ä¸šåŠ¡åœºæ™¯çš„æ—¥å¢æ•°æ®é‡å·¨å¤§ï¼Œå­˜åœ¨ç€æ•°æ®åº“èŠ‚ç‚¹å‹åŠ›è¿‡å¤§ã€è¿æ¥è¿‡å¤šã€æŸ¥è¯¢é€Ÿåº¦å˜æ…¢ç­‰æƒ…å†µï¼Œæ ¹æ®æ•°æ®æ¥æºã€æ—¶é—´ã€å·¥å·ç­‰ä¿¡æ¯æ¥å°†æ²¡æœ‰è”ç³»çš„æ•°æ®å°½é‡å‡åˆ†åˆ°ä¸åŒçš„åº“è¡¨ä¸­ï¼Œä»è€Œåœ¨ä¸å½±å“ä¸šåŠ¡éœ€æ±‚çš„å‰æä¸‹ï¼Œå‡è½»æ•°æ®åº“èŠ‚ç‚¹å‹åŠ›ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚\næŠ€æœ¯é€‰å‹ å¯¹æ¯”ç»´åº¦ Sharding-JDBC Sharding-Proxy MyCat æ¥å…¥å±‚ å®¢æˆ·ç«¯ æœåŠ¡ç«¯ æœåŠ¡ç«¯ åŠŸèƒ½å®Œæ•´æ€§ åˆ†åº“åˆ†è¡¨ï¼Œè¯»å†™åˆ†ç¦» åˆ†åº“åˆ†è¡¨ï¼Œè¯»å†™åˆ†ç¦» åˆ†åº“åˆ†è¡¨ï¼Œè¯»å†™åˆ†ç¦» èµ„æºæˆæœ¬ æ— éœ€éƒ¨ç½²å•ç‹¬çš„æœåŠ¡ éœ€è¦éƒ¨ç½²å•ç‹¬çš„æœåŠ¡ éœ€è¦éƒ¨ç½²å•ç‹¬çš„æœåŠ¡ æ€§èƒ½ å®¢æˆ·ç«¯ä¸æ•°æ®åº“ç›´è¿ï¼ŒæŸè€—ä½ å¤šä¸€å±‚ç½‘ç»œäº¤äº’ï¼ŒæŸè€—ç•¥é«˜ å¤šä¸€å±‚ç½‘ç»œäº¤äº’ï¼ŒæŸè€—ç•¥é«˜ è¿æ¥æ•° å¤š å°‘ å°‘ æˆç†Ÿåº¦ ç¤¾åŒºæ´»è·ƒåº¦é«˜ï¼Œåº”ç”¨æ¡ˆä¾‹å¤š ç¤¾åŒºæ´»è·ƒåº¦é«˜ï¼Œåº”ç”¨æ¡ˆä¾‹è¾ƒå°‘ ä¸æ´»è·ƒï¼Œå®˜æ–¹åŸºæœ¬å·²åœæ­¢ç»´æŠ¤ Sharding-JDBCä½œä¸ºè½»é‡åŒ–çš„å¢å¼ºç‰ˆçš„JDBCæ¡†æ¶ï¼Œç›¸è¾ƒå…¶ä»–ä¸­é—´ä»¶æ€§èƒ½æ›´å¥½ï¼Œæ¥å…¥éš¾åº¦æ›´ä½ï¼Œå…¶æ•°æ®åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»åŠŸèƒ½ä¹Ÿè¦†ç›–äº†æˆ‘ä»¬çš„ä¸šåŠ¡è¯‰æ±‚ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ä¸šåŠ¡ä¸­å¹¿æ³›ä½¿ç”¨äº†Sharding-JDBCã€‚ä½†åœ¨ä½¿ç”¨Sharding-JDBCçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå‘ç°äº†è¯¸å¤šé—®é¢˜ï¼Œä¸ºäº†ä¸šåŠ¡æ›´ä¾¿æ·çš„ä½¿ç”¨Sharding-JDBCï¼Œæˆ‘ä»¬å¯¹æºç åšäº†é’ˆå¯¹æ€§çš„å®šåˆ¶å¼€å‘å’Œç»„ä»¶å°è£…æ¥æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ã€‚\né—®é¢˜ ä¸šåŠ¡å½±å“ å®šåˆ¶åŠŸèƒ½ shardingè¯­æ³•é™åˆ¶ ä¸šåŠ¡æ”¹é€ sqlé£é™©å’Œæˆæœ¬é«˜ éåˆ†ç‰‡è¡¨è·³è¿‡shardingè¯­æ³•é™åˆ¶ï¼Œæ‰¹é‡updateè¯­æ³•æ”¯æŒ é…ç½®æ— æ³•åŠ¨æ€ç”Ÿæ•ˆ æ— æ³•åŠ¨æ€æ§åˆ¶ä¸»åº“è·¯ç”±ï¼Œä»åº“æ•…éšœæ—¶åªèƒ½é‡å¯åº”ç”¨ï¼Œæ‹–é•¿ä¸šåŠ¡æ•…éšœæ—¶é•¿ å¼ºåˆ¶è·¯ç”±ä¸»åº“ï¼Œé…ç½®åŠ¨æ€ç”Ÿæ•ˆ oræ¡ä»¶ä¸‹doShardingæ–¹æ³•é‡å¤è°ƒç”¨ æ–¹æ³•é‡å¤è°ƒç”¨å¯¹æ€§èƒ½æœ‰ä¸€å®šå½±å“ï¼Œä¸”æ–¹æ³•å†…æ—¥å¿—é‡å¤æ‰“å°ï¼Œå½±å“ç”Ÿäº§é—®é¢˜æ’æŸ¥æ•ˆç‡ shardingConditionå»é‡ æœªå¸¦åˆ†ç‰‡é”®æˆ–åˆ†ç‰‡é”®æœªèƒ½è§£æå¯¼è‡´å…¨è·¯ç”± å…¨è·¯ç”±äº§ç”Ÿä¸¥é‡çš„æ€§èƒ½é—®é¢˜ å…¨è·¯ç”±æ ¡éªŒ åŸºç¡€åŠŸèƒ½é‡å¤å»ºè®¾ä¸é…ç½®ç†Ÿæ‚‰ å½±å“å¼€å‘æ•ˆç‡ å°è£…å…¬å…±ç»„ä»¶ æºç åˆ†æ å¼•è¨€ Sharding-JDBCä½œä¸ºåŸºäºJDBCçš„æ•°æ®åº“ä¸­é—´ä»¶ï¼Œå®ç°äº†JDBCçš„æ ‡å‡†apiï¼ŒSharding-JDBCä¸åŸç”ŸJDBCçš„æ‰§è¡Œå¯¹æ¯”æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nç›¸å…³æ‰§è¡Œæµç¨‹çš„ä»£ç æ ·ä¾‹å¦‚ä¸‹ï¼š\nJDBCæ‰§è¡Œæ ·ä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 //è·å–æ•°æ®åº“è¿æ¥ try (Connection conn = DriverManager.getConnection(\"mysqlUrl\", \"userName\", \"password\")) { String sql = \"SELECT * FROM t_user WHERE name = ?\"; //é¢„ç¼–è¯‘SQL try (PreparedStatement preparedStatement = conn.prepareStatement(sql)) { //å‚æ•°è®¾ç½®ä¸æ‰§è¡Œ preparedStatement.setString(1, \"vivo\"); preparedStatement.execute(sql); //è·å–ç»“æœé›† try (ResultSet resultSet = preparedStatement.getResultSet()) { while (resultSet.next()) { //å¤„ç†ç»“æœ } } } } Sharding-JDBC æºç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // org.apache.shardingsphere.shardingjdbc.jdbc.core.statement#execute public boolean execute() throws SQLException { try { clearPrevious(); //è§£æ+è·¯ç”±+é‡å†™ å†…éƒ¨è°ƒç”¨BasePrepareEngine#prepareæ–¹æ³• prepare(); initPreparedStatementExecutor(); //æ‰§è¡Œ return preparedStatementExecutor.execute(); } finally { clearBatch(); } } // org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#prepare public ExecutionContext prepare(final String sql, final List parameters) { List clonedParameters = cloneParameters(parameters); //è§£æ+è·¯ç”±(executeRouteå†…éƒ¨å…ˆè¿›è¡Œè§£æå†æ‰§è¡Œè·¯ç”±) RouteContext routeContext = executeRoute(sql, clonedParameters); ExecutionContext result = new ExecutionContext(routeContext.getSqlStatementContext()); //é‡å†™ result.getExecutionUnits().addAll(executeRewrite(sql, clonedParameters, routeContext)); if (properties.getValue(ConfigurationPropertyKey.SQL_SHOW)) { SQLLogger.logSQL(sql, properties.getValue(ConfigurationPropertyKey.SQL_SIMPLE), result.getSqlStatementContext(), result.getExecutionUnits()); } return result; } // org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#getResultSet public ResultSet getResultSet() throws SQLException { if (null != currentResultSet) { return currentResultSet; } if (executionContext.getSqlStatementContext() instanceof SelectStatementContext || executionContext.getSqlStatementContext().getSqlStatement() instanceof DALStatement) { List resultSets = getResultSets(); //å½’å¹¶ç»“æœé›† MergedResult mergedResult = mergeQuery(getQueryResults(resultSets)); currentResultSet = new ShardingResultSet(resultSets, mergedResult, this, executionContext); } return currentResultSet; } ä»å¯¹æ¯”çš„æ‰§è¡Œæµç¨‹å›¾å¯è§ï¼š\nã€JDBCã€‘ï¼šæ‰§è¡Œçš„ä¸»è¦æµç¨‹æ˜¯é€šè¿‡Datasourceè·å–Connectionï¼Œå†æ³¨å…¥SQLè¯­å¥ç”ŸæˆPreparedStatementå¯¹è±¡ï¼ŒPreparedStatementè®¾ç½®å ä½ç¬¦å‚æ•°æ‰§è¡Œåå¾—åˆ°ç»“æœé›†ResultSetã€‚ ã€Sharding-JDBCã€‘ï¼šä¸»è¦æµç¨‹åŸºæœ¬ä¸€è‡´ï¼Œä½†ShardingåŸºäºPreparedStatementè¿›è¡Œäº†å®ç°ä¸æ‰©å±•ï¼Œå…·ä½“å®ç°ç±»ShardingPreparedStatementä¸­ä¼šæŠ½è±¡å‡ºè§£æã€è·¯ç”±ã€é‡å†™ã€å½’å¹¶ç­‰å¼•æ“ï¼Œä»è€Œå®ç°åˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»ç­‰èƒ½åŠ›ï¼Œæ¯ä¸ªå¼•æ“çš„ä½œç”¨è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š å¼•æ“ ä½œç”¨ è§£æå¼•æ“ å°†SQLæ‹†åˆ†æˆä¸å¯å†åˆ†çš„åŸå­ç¬¦å·(token),è§£ææˆè¯­æ³•æ ‘ï¼Œè¯­æ³•æ ‘æ˜¯åç»­è·¯ç”±ã€æ”¹å†™ã€å½’å¹¶çš„åŸºç¡€ä¾æ®ã€‚ è·¯ç”±å¼•æ“ æ ¹æ®è¯­æ³•æ ‘åŒ¹é…é…ç½®çš„è·¯ç”±ç­–ç•¥ï¼Œé€šè¿‡SQLå‚æ•°å’Œç­–ç•¥çš„æ‰§è¡Œåº“è¡¨ æ”¹å†™å¼•æ“ æ ¹æ®è¯­æ³•æ ‘å’Œè·¯ç”±ç»“æœå°†é€»è¾‘SQLæ”¹å†™æˆçœŸæ­£å¯æ‰§è¡Œçš„çœŸå®SQL,åŒ…æ‹¬é€»è¾‘è¡¨çš„æ›¿æ¢ã€åˆ†é¡µçš„ä¿®æ­£ã€æ’å…¥æ‹†åˆ†ç­‰ æ‰§è¡Œå¼•æ“ æ ¹æ®SQLæ‰§è¡Œå•å…ƒåˆ›å»ºåˆé€‚çš„è¿æ¥ï¼ˆéœ€å…¼é¡¾å†…å­˜å’Œè¿æ¥èµ„æºï¼‰ï¼Œå¹¶å°†çœŸå®SQLå‘é€è‡³æ•°æ®åº“æ‰§è¡Œ å½’å¹¶å¼•æ“ æ ¹æ®è¯­æ³•æ ‘å°†å„ä¸ªæ•°æ®èŠ‚ç‚¹çš„ç»“æœé›†å½’å¹¶æˆæœ€ç»ˆéœ€è¦çš„ç»“æœé›†ï¼ŒåŒ…æ‹¬åˆ†ç»„å½’å¹¶ã€æ’åºå½’å¹¶ã€åˆ†é¡µå½’å¹¶ã€èšåˆå½’å¹¶ç­‰ è§£æå¼•æ“ è§£æå¼•æ“ è§£æå¼•æ“æ˜¯Sharding-JDBCè¿›è¡Œåˆ†åº“åˆ†è¡¨é€»è¾‘çš„åŸºç¡€ï¼Œå…¶ä½œç”¨æ˜¯å°†SQLæ‹†è§£ä¸ºä¸å¯å†åˆ†çš„åŸå­ç¬¦å·ï¼ˆç§°ä¸ºtokenï¼‰ï¼Œå†æ ¹æ®æ•°æ®åº“ç±»å‹å°†è¿™äº›tokenåˆ†ç±»æˆå…³é”®å­—ã€è¡¨è¾¾å¼ã€æ“ä½œç¬¦ã€å­—é¢é‡ç­‰ä¸åŒç±»å‹ï¼Œè¿›è€Œç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œè€Œè¯­æ³•æ ‘æ˜¯åç»­è¿›è¡Œè·¯ç”±ã€æ”¹å†™æ“ä½œçš„å‰æï¼ˆè¿™ä¹Ÿæ­£æ˜¯è¯­æ³•æ ‘çš„å­˜åœ¨ä½¿å¾—Sharding-JDBCå­˜åœ¨å„å¼å„æ ·çš„è¯­æ³•é™åˆ¶çš„åŸå› ä¹‹ä¸€ï¼‰ã€‚\nå®˜æ–¹æ–‡æ¡£ï¼šè§£æå¼•æ“ :: ShardingSphere (apache.org)\n4.xçš„ç‰ˆæœ¬é‡‡ç”¨ANTLRï¼ˆANother Tool for Language Recognitionï¼‰ä½œä¸ºè§£æå¼•æ“ï¼Œåœ¨ShardingSphere-sql-parser-dialectæ¨¡å—ä¸­å®šä¹‰äº†é€‚ç”¨äºä¸åŒæ•°æ®åº“è¯­æ³•çš„è§£æè§„åˆ™ï¼ˆ.g4æ–‡ä»¶ï¼‰ï¼Œideaä¸­ä¹Ÿå¯ä»¥ä¸‹è½½ANTLR v4çš„æ’ä»¶ï¼Œè¾“å…¥SQLæŸ¥çœ‹è§£æåçš„è¯­æ³•æ ‘ç»“æœã€‚\nè§£ææ–¹æ³•çš„å…¥å£åœ¨DataNodeRouterçš„createRouteContextæ–¹æ³•ä¸­ï¼Œè§£æå¼•æ“æ ¹æ®æ•°æ®åº“ç±»å‹å’ŒSQLåˆ›å»ºSQLParserExecutoræ‰§è¡Œå¾—åˆ°è§£ææ ‘ï¼Œå†é€šè¿‡ParseTreeVisitor()çš„visitæ–¹æ³•ï¼Œå¯¹è§£ææ ‘è¿›è¡Œå¤„ç†å¾—åˆ°SQLStatementã€‚ANTLRæ”¯æŒlistenerå’Œvisitorä¸¤ç§æ¨¡å¼çš„æ¥å£ï¼Œvisitoræ–¹å¼å¯ä»¥æ›´çµæ´»çš„æ§åˆ¶è§£ææ ‘çš„éå†è¿‡ç¨‹ï¼Œæ›´é€‚ç”¨äºSQLè§£æçš„åœºæ™¯ã€‚\nè§£æå¼•æ“æ ¸å¿ƒä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // org.apache.shardingsphere.underlying.route.DataNodeRouter#createRouteContext#96 private RouteContext createRouteContext(final String sql, final List parameters, final boolean useCache) { //è§£æå¼•æ“è§£æSQL SQLStatement sqlStatement = parserEngine.parse(sql, useCache); try { SQLStatementContext sqlStatementContext = SQLStatementContextFactory.newInstance(metaData.getSchema(), sql, parameters, sqlStatement); return new RouteContext(sqlStatementContext, parameters, new RouteResult()); // TODO should pass parameters for master-slave } catch (final IndexOutOfBoundsException ex) { return new RouteContext(new CommonSQLStatementContext(sqlStatement), parameters, new RouteResult()); } } // org.apache.shardingsphere.sql.parser.SQLParserEngine#parse0#72 private SQLStatement parse0(final String sql, final boolean useCache) { //ç¼“å­˜ if (useCache) { Optional cachedSQLStatement = cache.getSQLStatement(sql); if (cachedSQLStatement.isPresent()) { return cachedSQLStatement.get(); } } //æ ¹æ®æ•°æ®åº“ç±»å‹å’Œsqlç”Ÿæˆè§£ææ ‘ ParseTree parseTree = new SQLParserExecutor(databaseTypeName, sql).execute().getRootNode(); //ParseTreeVisitorçš„visitæ–¹æ³•å¯¹è§£ææ ‘è¿›è¡Œå¤„ç†å¾—åˆ°SQLStatement SQLStatement result = (SQLStatement) ParseTreeVisitorFactory.newInstance(databaseTypeName, VisitorRule.valueOf(parseTree.getClass())).visit(parseTree); if (useCache) { cache.put(sql, result); } return result; } SQLStatementå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å®ç°å¯¹åº”ç€ä¸åŒçš„SQLç±»å‹ï¼Œå¦‚SelectStatement ç±»ä¸­å°±åŒ…æ‹¬æŸ¥è¯¢çš„å­—æ®µã€è¡¨åã€whereæ¡ä»¶ã€åˆ†ç»„ã€æ’åºã€åˆ†é¡µã€lockç­‰å˜é‡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œå¹¶æ²¡æœ‰å¯¹havingè¿™ç§å­—æ®µåšå®šä¹‰ï¼Œç›¸å½“äºSharding-JDBCæ— æ³•è¯†åˆ«åˆ°SQLä¸­çš„havingï¼Œè¿™ä½¿å¾—Sharding-JDBCå¯¹havingè¯­æ³•æœ‰ä¸€å®šçš„é™åˆ¶ã€‚\nSelectStatement\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public final class SelectStatement extends DMLStatement { // å­—æ®µ private ProjectionsSegment projections; // è¡¨ private final Collection tableReferences = new LinkedList\u003c\u003e(); // where private WhereSegment where; // groupBy private GroupBySegment groupBy; // orderBy private OrderBySegment orderBy; // limit private LimitSegment limit; // çˆ¶statement private SelectStatement parentStatement; // lock private LockSegment lock; } SQLStatementè¿˜ä¼šè¢«è¿›ä¸€æ­¥è½¬æ¢æˆSQLStatementContextï¼Œå¦‚SelectStatement ä¼šè¢«è½¬æ¢æˆSelectStatementContext ï¼Œå…¶ç»“æ„ä¸SelectStatement ç±»ä¼¼ä¸å†å¤šè¯´ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯è™½ç„¶è¿™é‡Œå®šä¹‰äº†containsSubqueryæ¥åˆ¤æ–­æ˜¯å¦åŒ…å«å­æŸ¥è¯¢ï¼Œä½†4.1.1æºç æ°¸è¿œæ˜¯è¿”å›çš„falseï¼Œä¸havingç±»ä¼¼ï¼Œè¿™æ„å‘³ç€Sharding-JDBCä¸ä¼šå¯¹å­æŸ¥è¯¢è¯­å¥åšç‰¹æ®Šå¤„ç†ã€‚\nSelectStatementContext\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 public final class SelectStatementContext extends CommonSQLStatementContext implements TableAvailable, WhereAvailable { private final TablesContext tablesContext; private final ProjectionsContext projectionsContext; private final GroupByContext groupByContext; private final OrderByContext orderByContext; private final PaginationContext paginationContext; private final boolean containsSubquery; } private boolean containsSubquery() { // FIXME process subquery // Collection subqueryPredicateSegments = getSqlStatement().findSQLSegments(SubqueryPredicateSegment.class); // for (SubqueryPredicateSegment each : subqueryPredicateSegments) { // if (!each.getAndPredicates().isEmpty()) { // return true; // } // } return false; } å¼•æ“æ€»ç»“ è§£æå¼•æ“æ˜¯è¿›è¡Œè·¯ç”±æ”¹å†™çš„å‰æåŸºç¡€ï¼Œå…¶ä½œç”¨å°±æ˜¯å°†SQLæŒ‰ç…§å®šä¹‰çš„è¯­æ³•è§„åˆ™æ‹†åˆ†æˆåŸå­ç¬¦å·(token)ï¼Œç”Ÿæˆè¯­æ³•æ ‘ï¼Œæ ¹æ®ä¸åŒçš„SQLç±»å‹ç”Ÿæˆå¯¹åº”çš„SQLStatementï¼ŒSQLStatementç”±å„è‡ªçš„Segmentç»„æˆï¼Œæ‰€æœ‰çš„Segmentéƒ½åŒ…å«startIndexå’ŒendIndexæ¥å®šä½tokenåœ¨SQLä¸­æ‰€å±çš„ä½ç½®ï¼Œä½†è§£æè¯­æ³•éš¾ä»¥æ¶µç›–æ‰€æœ‰çš„SQLåœºæ™¯ï¼Œä½¿å¾—éƒ¨åˆ†SQLæ— æ³•æŒ‰ç…§é¢„æœŸçš„ç»“æœè·¯ç”±æ‰§è¡Œã€‚\nè·¯ç”±å¼•æ“ è§£æ è·¯ç”±å¼•æ“æ˜¯Sharding-JDBCçš„æ ¸å¿ƒæ­¥éª¤ï¼Œä½œç”¨æ˜¯æ ¹æ®å®šä¹‰çš„åˆ†åº“åˆ†è¡¨è§„åˆ™å°†è§£æå¼•æ“ç”Ÿæˆçš„SQLä¸Šä¸‹æ–‡ç”Ÿæˆå¯¹åº”çš„è·¯ç”±ç»“æœï¼ŒRouteResult åŒ…æ‹¬DataNodeå’ŒRouteUnitï¼ŒDataNodeæ˜¯å®é™…çš„æ•°æ®æºèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬æ•°æ®æºåç§°å’Œå®é™…çš„ç‰©ç†è¡¨åï¼ŒRouteUnitåˆ™è®°å½•äº†é€»è¾‘è¡¨/åº“ä¸ç‰©ç†è¡¨/åº“çš„æ˜ å°„å…³ç³»ï¼Œåé¢çš„æ”¹å†™å¼•æ“ä¹Ÿæ˜¯æ ¹æ®è¿™ä¸ªæ˜ å°„å…³ç³»æ¥å†³å®šå¦‚ä½•æ›¿æ¢SQLä¸­çš„é€»è¾‘è¡¨ï¼ˆå®é™…ä¸ŠRouteResult å°±æ˜¯ç»´æŠ¤äº†ä¸€æ¡SQLéœ€è¦å¾€å“ªäº›åº“å“ªäº›è¡¨æ‰§è¡Œçš„å…³ç³»ï¼‰ã€‚\nRouteResult\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public final class RouteResult { private final Collection",
  "wordCount" : "22446",
  "inLanguage": "en",
  "datePublished": "2020-01-08T11:57:49Z",
  "dateModified": "2020-01-08T11:57:49Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/sharding/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      sharding
    </h1>
    <div class="post-meta"><span title='2020-01-08 11:57:49 +0000 UTC'>2020-01-08</span>&nbsp;Â·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e4%b8%9a%e5%8a%a1%e8%83%8c%e6%99%af" aria-label="ä¸šåŠ¡èƒŒæ™¯">ä¸šåŠ¡èƒŒæ™¯</a></li>
                <li>
                    <a href="#%e6%8a%80%e6%9c%af%e9%80%89%e5%9e%8b" aria-label="æŠ€æœ¯é€‰å‹">æŠ€æœ¯é€‰å‹</a></li>
                <li>
                    <a href="#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" aria-label="æºç åˆ†æ">æºç åˆ†æ</a><ul>
                        
                <li>
                    <a href="#%e5%bc%95%e8%a8%80" aria-label="å¼•è¨€">å¼•è¨€</a></li>
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90%e5%bc%95%e6%93%8e" aria-label="è§£æå¼•æ“">è§£æå¼•æ“</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90%e5%bc%95%e6%93%8e-1" aria-label="è§£æå¼•æ“">è§£æå¼•æ“</a></li>
                <li>
                    <a href="#%e5%bc%95%e6%93%8e%e6%80%bb%e7%bb%93" aria-label="å¼•æ“æ€»ç»“">å¼•æ“æ€»ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%b7%af%e7%94%b1%e5%bc%95%e6%93%8e" aria-label="è·¯ç”±å¼•æ“">è·¯ç”±å¼•æ“</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90" aria-label="è§£æ">è§£æ</a></li>
                <li>
                    <a href="#%e5%88%86%e7%89%87%e8%b7%af%e7%94%b1" aria-label="åˆ†ç‰‡è·¯ç”±">åˆ†ç‰‡è·¯ç”±</a></li>
                <li>
                    <a href="#%e4%b8%bb%e4%bb%8e%e8%b7%af%e7%94%b1" aria-label="ä¸»ä»è·¯ç”±">ä¸»ä»è·¯ç”±</a></li>
                <li>
                    <a href="#%e5%bc%95%e6%93%8e%e6%80%bb%e7%bb%93-1" aria-label="å¼•æ“æ€»ç»“">å¼•æ“æ€»ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%94%b9%e5%86%99%e5%bc%95%e6%93%8e" aria-label="æ”¹å†™å¼•æ“">æ”¹å†™å¼•æ“</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90-1" aria-label="è§£æ">è§£æ</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="æ€»ç»“">æ€»ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%89%a7%e8%a1%8c%e5%bc%95%e6%93%8e" aria-label="æ‰§è¡Œå¼•æ“">æ‰§è¡Œå¼•æ“</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90-2" aria-label="è§£æ">è§£æ</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-1" aria-label="æ€»ç»“">æ€»ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bd%92%e5%b9%b6%e5%bc%95%e6%93%8e" aria-label="å½’å¹¶å¼•æ“">å½’å¹¶å¼•æ“</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90-3" aria-label="è§£æ">è§£æ</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-2" aria-label="æ€»ç»“">æ€»ç»“</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9a%e5%88%b6%e7%a0%94%e5%8f%91" aria-label="å®šåˆ¶ç ”å‘">å®šåˆ¶ç ”å‘</a><ul>
                        
                <li>
                    <a href="#%e8%b7%b3%e8%bf%87sharding%e8%af%ad%e6%b3%95%e9%99%90%e5%88%b6" aria-label="è·³è¿‡Shardingè¯­æ³•é™åˆ¶">è·³è¿‡Shardingè¯­æ³•é™åˆ¶</a></li>
                <li>
                    <a href="#%e5%bc%ba%e5%88%b6%e8%b7%af%e7%94%b1%e4%b8%bb%e5%ba%93" aria-label="å¼ºåˆ¶è·¯ç”±ä¸»åº“">å¼ºåˆ¶è·¯ç”±ä¸»åº“</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e5%8a%a8%e6%80%81%e7%94%9f%e6%95%88" aria-label="é…ç½®åŠ¨æ€ç”Ÿæ•ˆ">é…ç½®åŠ¨æ€ç”Ÿæ•ˆ</a></li>
                <li>
                    <a href="#%e6%89%b9%e9%87%8fupdate%e8%af%ad%e6%b3%95%e6%94%af%e6%8c%81" aria-label="æ‰¹é‡updateè¯­æ³•æ”¯æŒ">æ‰¹é‡updateè¯­æ³•æ”¯æŒ</a></li>
                <li>
                    <a href="#shardingcondition%e5%8e%bb%e9%87%8d" aria-label="ShardingConditionå»é‡">ShardingConditionå»é‡</a></li>
                <li>
                    <a href="#%e5%85%a8%e8%b7%af%e7%94%b1%e6%a0%a1%e9%aa%8c" aria-label="å…¨è·¯ç”±æ ¡éªŒ">å…¨è·¯ç”±æ ¡éªŒ</a></li>
                <li>
                    <a href="#%e7%bb%84%e4%bb%b6%e5%b0%81%e8%a3%85" aria-label="ç»„ä»¶å°è£…">ç»„ä»¶å°è£…</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e5%bb%ba%e8%ae%ae" aria-label="ä½¿ç”¨å»ºè®®">ä½¿ç”¨å»ºè®®</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-3" aria-label="æ€»ç»“">æ€»ç»“</a></li>
                <li>
                    <a href="#%e4%b8%80%e4%ba%9b%e9%97%ae%e9%a2%98" aria-label="ä¸€äº›é—®é¢˜">ä¸€äº›é—®é¢˜</a><ul>
                        
                <li>
                    <a href="#%e4%b8%8d%e6%94%af%e6%8c%81%e7%9a%84%e5%85%b3%e9%94%ae%e5%ad%97" aria-label="ä¸æ”¯æŒçš„å…³é”®å­—">ä¸æ”¯æŒçš„å…³é”®å­—</a></li>
                <li>
                    <a href="#%e4%b8%8d%e6%94%af%e6%8c%81%e7%9a%84%e5%86%99%e6%b3%95" aria-label="ä¸æ”¯æŒçš„å†™æ³•">ä¸æ”¯æŒçš„å†™æ³•</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><a href="https://shardingsphere.apache.org/index_zh.html">å®˜ç½‘</a>
<a href="https://github.com/apache/incubator-shardingsphere">github</a>
Sharding-Sphereæ˜¯ä¸€å¥—å¼€æºçš„åˆ†å¸ƒå¼æ•°æ®åº“ä¸­é—´ä»¶è§£å†³æ–¹æ¡ˆç»„æˆçš„ç”Ÿæ€åœˆï¼Œå®ƒç”±Sharding-JDBCã€Sharding-Proxyå’ŒSharding-Sidecarè¿™3æ¬¾ç›¸äº’ç‹¬ç«‹çš„äº§å“ç»„æˆã€‚
ä»–ä»¬å‡æä¾›æ ‡å‡†åŒ–çš„æ•°æ®åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»ã€æŸ”æ€§äº‹åŠ¡å’Œæ•°æ®æ²»ç†åŠŸèƒ½ï¼Œå¯é€‚ç”¨äºå¦‚JavaåŒæ„ã€å¼‚æ„è¯­è¨€ã€å®¹å™¨ã€äº‘åŸç”Ÿç­‰å„ç§å¤šæ ·åŒ–çš„åº”ç”¨åœºæ™¯ã€‚
å…¶ä¸­<code>Sharding-JDBC</code>æœ€æ—©ç”±å½“å½“ç½‘åœ¨2016å¹´å¼€æºï¼Œåœ¨<code>Sharding-JDBC 3.0</code>ç‰ˆæœ¬ï¼Œæ›´åä¸º<code>Sharding-Sphere</code>ï¼Œåæ¥åˆ›å§‹äººå¼ äº®å»äº†äº¬ä¸œã€‚åœ¨2018å¹´åº•ï¼Œé¡¹ç›®å¼€æºç»™äº†apacheåŸºé‡‘ä¼šã€‚</p>
<p>å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s/GawVNXjCo8qni6w4yoW7SA">Sharding-JDBCæºç è§£æä¸vivoçš„å®šåˆ¶å¼€å‘</a></p>
<h1 id="ä¸šåŠ¡èƒŒæ™¯">ä¸šåŠ¡èƒŒæ™¯<a hidden class="anchor" aria-hidden="true" href="#ä¸šåŠ¡èƒŒæ™¯">#</a></h1>
<p>éšç€ä¸šåŠ¡å¹¶å‘è¯·æ±‚å’Œæ•°æ®è§„æ¨¡çš„ä¸æ–­æ‰©å¤§ï¼Œå•èŠ‚ç‚¹åº“è¡¨å‹åŠ›å¾€å¾€ä¼šæˆä¸ºç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚å…¬å¸ITå†…éƒ¨<strong>è¥é”€åº“å­˜ã€äº¤æ˜“è®¢å•ã€è´¢ç»å°è´¦ã€è€ƒå‹¤è®°å½•</strong>ç­‰å¤šé¢†åŸŸçš„ä¸šåŠ¡åœºæ™¯çš„æ—¥å¢æ•°æ®é‡å·¨å¤§ï¼Œå­˜åœ¨ç€<strong>æ•°æ®åº“èŠ‚ç‚¹å‹åŠ›è¿‡å¤§ã€è¿æ¥è¿‡å¤šã€æŸ¥è¯¢é€Ÿåº¦å˜æ…¢</strong>ç­‰æƒ…å†µï¼Œæ ¹æ®æ•°æ®æ¥æºã€æ—¶é—´ã€å·¥å·ç­‰ä¿¡æ¯æ¥å°†<strong>æ²¡æœ‰è”ç³»çš„æ•°æ®</strong>å°½é‡å‡åˆ†åˆ°ä¸åŒçš„åº“è¡¨ä¸­ï¼Œä»è€Œåœ¨ä¸å½±å“ä¸šåŠ¡éœ€æ±‚çš„å‰æä¸‹ï¼Œå‡è½»æ•°æ®åº“èŠ‚ç‚¹å‹åŠ›ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚</p>
<h1 id="æŠ€æœ¯é€‰å‹">æŠ€æœ¯é€‰å‹<a hidden class="anchor" aria-hidden="true" href="#æŠ€æœ¯é€‰å‹">#</a></h1>
<table>
<thead>
<tr>
<th>å¯¹æ¯”ç»´åº¦</th>
<th>Sharding-JDBC</th>
<th>Sharding-Proxy</th>
<th>MyCat</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¥å…¥å±‚</td>
<td>å®¢æˆ·ç«¯</td>
<td>æœåŠ¡ç«¯</td>
<td>æœåŠ¡ç«¯</td>
</tr>
<tr>
<td>åŠŸèƒ½å®Œæ•´æ€§</td>
<td>åˆ†åº“åˆ†è¡¨ï¼Œè¯»å†™åˆ†ç¦»</td>
<td>åˆ†åº“åˆ†è¡¨ï¼Œè¯»å†™åˆ†ç¦»</td>
<td>åˆ†åº“åˆ†è¡¨ï¼Œè¯»å†™åˆ†ç¦»</td>
</tr>
<tr>
<td>èµ„æºæˆæœ¬</td>
<td>æ— éœ€éƒ¨ç½²å•ç‹¬çš„æœåŠ¡</td>
<td>éœ€è¦éƒ¨ç½²å•ç‹¬çš„æœåŠ¡</td>
<td>éœ€è¦éƒ¨ç½²å•ç‹¬çš„æœåŠ¡</td>
</tr>
<tr>
<td>æ€§èƒ½</td>
<td>å®¢æˆ·ç«¯ä¸æ•°æ®åº“ç›´è¿ï¼ŒæŸè€—ä½</td>
<td>å¤šä¸€å±‚ç½‘ç»œäº¤äº’ï¼ŒæŸè€—ç•¥é«˜</td>
<td>å¤šä¸€å±‚ç½‘ç»œäº¤äº’ï¼ŒæŸè€—ç•¥é«˜</td>
</tr>
<tr>
<td>è¿æ¥æ•°</td>
<td>å¤š</td>
<td>å°‘</td>
<td>å°‘</td>
</tr>
<tr>
<td>æˆç†Ÿåº¦</td>
<td>ç¤¾åŒºæ´»è·ƒåº¦é«˜ï¼Œåº”ç”¨æ¡ˆä¾‹å¤š</td>
<td>ç¤¾åŒºæ´»è·ƒåº¦é«˜ï¼Œåº”ç”¨æ¡ˆä¾‹è¾ƒå°‘</td>
<td>ä¸æ´»è·ƒï¼Œå®˜æ–¹åŸºæœ¬å·²åœæ­¢ç»´æŠ¤</td>
</tr>
</tbody>
</table>
<p>Sharding-JDBCä½œä¸ºè½»é‡åŒ–çš„å¢å¼ºç‰ˆçš„JDBCæ¡†æ¶ï¼Œç›¸è¾ƒå…¶ä»–ä¸­é—´ä»¶æ€§èƒ½æ›´å¥½ï¼Œæ¥å…¥éš¾åº¦æ›´ä½ï¼Œå…¶æ•°æ®åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»åŠŸèƒ½ä¹Ÿè¦†ç›–äº†æˆ‘ä»¬çš„ä¸šåŠ¡è¯‰æ±‚ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ä¸šåŠ¡ä¸­å¹¿æ³›ä½¿ç”¨äº†Sharding-JDBCã€‚ä½†åœ¨ä½¿ç”¨Sharding-JDBCçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå‘ç°äº†è¯¸å¤šé—®é¢˜ï¼Œä¸ºäº†ä¸šåŠ¡æ›´ä¾¿æ·çš„ä½¿ç”¨Sharding-JDBCï¼Œæˆ‘ä»¬å¯¹æºç åšäº†é’ˆå¯¹æ€§çš„å®šåˆ¶å¼€å‘å’Œç»„ä»¶å°è£…æ¥æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ã€‚</p>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>ä¸šåŠ¡å½±å“</th>
<th>å®šåˆ¶åŠŸèƒ½</th>
</tr>
</thead>
<tbody>
<tr>
<td>shardingè¯­æ³•é™åˆ¶</td>
<td>ä¸šåŠ¡æ”¹é€ sqlé£é™©å’Œæˆæœ¬é«˜</td>
<td>éåˆ†ç‰‡è¡¨è·³è¿‡shardingè¯­æ³•é™åˆ¶ï¼Œæ‰¹é‡updateè¯­æ³•æ”¯æŒ</td>
</tr>
<tr>
<td>é…ç½®æ— æ³•åŠ¨æ€ç”Ÿæ•ˆ</td>
<td>æ— æ³•åŠ¨æ€æ§åˆ¶ä¸»åº“è·¯ç”±ï¼Œä»åº“æ•…éšœæ—¶åªèƒ½é‡å¯<br/>åº”ç”¨ï¼Œæ‹–é•¿ä¸šåŠ¡æ•…éšœæ—¶é•¿</td>
<td>å¼ºåˆ¶è·¯ç”±ä¸»åº“ï¼Œé…ç½®åŠ¨æ€ç”Ÿæ•ˆ</td>
</tr>
<tr>
<td>oræ¡ä»¶ä¸‹doShardingæ–¹æ³•é‡å¤è°ƒç”¨</td>
<td>æ–¹æ³•é‡å¤è°ƒç”¨å¯¹æ€§èƒ½æœ‰ä¸€å®šå½±å“ï¼Œä¸”æ–¹æ³•å†…æ—¥å¿—é‡å¤æ‰“å°ï¼Œå½±å“ç”Ÿäº§é—®é¢˜æ’æŸ¥æ•ˆç‡</td>
<td>shardingConditionå»é‡</td>
</tr>
<tr>
<td>æœªå¸¦åˆ†ç‰‡é”®æˆ–åˆ†ç‰‡é”®æœªèƒ½è§£æå¯¼è‡´å…¨è·¯ç”±</td>
<td>å…¨è·¯ç”±äº§ç”Ÿä¸¥é‡çš„æ€§èƒ½é—®é¢˜</td>
<td>å…¨è·¯ç”±æ ¡éªŒ</td>
</tr>
<tr>
<td>åŸºç¡€åŠŸèƒ½é‡å¤å»ºè®¾ä¸é…ç½®ç†Ÿæ‚‰</td>
<td>å½±å“å¼€å‘æ•ˆç‡</td>
<td>å°è£…å…¬å…±ç»„ä»¶</td>
</tr>
</tbody>
</table>
<h1 id="æºç åˆ†æ">æºç åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#æºç åˆ†æ">#</a></h1>
<h2 id="å¼•è¨€">å¼•è¨€<a hidden class="anchor" aria-hidden="true" href="#å¼•è¨€">#</a></h2>
<p>Sharding-JDBCä½œä¸ºåŸºäºJDBCçš„æ•°æ®åº“ä¸­é—´ä»¶ï¼Œå®ç°äº†JDBCçš„æ ‡å‡†apiï¼ŒSharding-JDBCä¸åŸç”ŸJDBCçš„æ‰§è¡Œå¯¹æ¯”æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img loading="lazy" src="1.png" alt=""  />
</p>
<p>ç›¸å…³æ‰§è¡Œæµç¨‹çš„ä»£ç æ ·ä¾‹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>JDBCæ‰§è¡Œæ ·ä¾‹</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//è·å–æ•°æ®åº“è¿æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">try</span> (Connection conn = DriverManager.<span style="color:#007f7f">getConnection</span>(<span style="color:#0ff;font-weight:bold">&#34;mysqlUrl&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;userName&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;password&#34;</span>)) {
</span></span><span style="display:flex;"><span>    String sql = <span style="color:#0ff;font-weight:bold">&#34;SELECT * FROM  t_user WHERE name = ?&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//é¢„ç¼–è¯‘SQL
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">try</span> (PreparedStatement preparedStatement = conn.<span style="color:#007f7f">prepareStatement</span>(sql)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å‚æ•°è®¾ç½®ä¸æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        preparedStatement.<span style="color:#007f7f">setString</span>(<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#0ff;font-weight:bold">&#34;vivo&#34;</span>);
</span></span><span style="display:flex;"><span>        preparedStatement.<span style="color:#007f7f">execute</span>(sql);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è·å–ç»“æœé›†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">try</span> (ResultSet resultSet = preparedStatement.<span style="color:#007f7f">getResultSet</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">while</span> (resultSet.<span style="color:#007f7f">next</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//å¤„ç†ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Sharding-JDBC æºç </p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.jdbc.core.statement#execute
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> execute() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        clearPrevious();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è§£æ+è·¯ç”±+é‡å†™ å†…éƒ¨è°ƒç”¨BasePrepareEngine#prepareæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        prepare();
</span></span><span style="display:flex;"><span>        initPreparedStatementExecutor();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> preparedStatementExecutor.<span style="color:#007f7f">execute</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>        clearBatch();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#prepare
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ExecutionContext prepare(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters) {
</span></span><span style="display:flex;"><span>    List&lt;Object&gt; clonedParameters = cloneParameters(parameters);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è§£æ+è·¯ç”±(executeRouteå†…éƒ¨å…ˆè¿›è¡Œè§£æå†æ‰§è¡Œè·¯ç”±)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    RouteContext routeContext = executeRoute(sql, clonedParameters);
</span></span><span style="display:flex;"><span>    ExecutionContext result = <span style="color:#fff;font-weight:bold">new</span> ExecutionContext(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//é‡å†™
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    result.<span style="color:#007f7f">getExecutionUnits</span>().<span style="color:#007f7f">addAll</span>(executeRewrite(sql, clonedParameters, routeContext));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SHOW</span>)) {
</span></span><span style="display:flex;"><span>        SQLLogger.<span style="color:#007f7f">logSQL</span>(sql, properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SIMPLE</span>), result.<span style="color:#007f7f">getSqlStatementContext</span>(), result.<span style="color:#007f7f">getExecutionUnits</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#getResultSet
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ResultSet getResultSet() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != currentResultSet) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> currentResultSet;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (executionContext.<span style="color:#007f7f">getSqlStatementContext</span>() <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatementContext || executionContext.<span style="color:#007f7f">getSqlStatementContext</span>().<span style="color:#007f7f">getSqlStatement</span>() <span style="color:#fff;font-weight:bold">instanceof</span> DALStatement) {
</span></span><span style="display:flex;"><span>        List&lt;ResultSet&gt; resultSets = getResultSets();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å½’å¹¶ç»“æœé›†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        MergedResult mergedResult = mergeQuery(getQueryResults(resultSets));
</span></span><span style="display:flex;"><span>        currentResultSet = <span style="color:#fff;font-weight:bold">new</span> ShardingResultSet(resultSets, mergedResult, <span style="color:#fff;font-weight:bold">this</span>, executionContext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> currentResultSet;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»å¯¹æ¯”çš„æ‰§è¡Œæµç¨‹å›¾å¯è§ï¼š</p>
<ul>
<li>ã€JDBCã€‘ï¼šæ‰§è¡Œçš„ä¸»è¦æµç¨‹æ˜¯é€šè¿‡Datasourceè·å–Connectionï¼Œå†æ³¨å…¥SQLè¯­å¥ç”ŸæˆPreparedStatementå¯¹è±¡ï¼ŒPreparedStatementè®¾ç½®å ä½ç¬¦å‚æ•°æ‰§è¡Œåå¾—åˆ°ç»“æœé›†ResultSetã€‚</li>
<li>ã€Sharding-JDBCã€‘ï¼šä¸»è¦æµç¨‹åŸºæœ¬ä¸€è‡´ï¼Œä½†ShardingåŸºäºPreparedStatementè¿›è¡Œäº†å®ç°ä¸æ‰©å±•ï¼Œå…·ä½“å®ç°ç±»<strong>ShardingPreparedStatementä¸­ä¼šæŠ½è±¡å‡ºè§£æã€è·¯ç”±ã€é‡å†™ã€å½’å¹¶ç­‰å¼•æ“ï¼Œä»è€Œå®ç°åˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»</strong>ç­‰èƒ½åŠ›ï¼Œæ¯ä¸ªå¼•æ“çš„ä½œç”¨è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</li>
</ul>
<table>
<thead>
<tr>
<th>å¼•æ“</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>è§£æå¼•æ“</td>
<td>å°†SQLæ‹†åˆ†æˆä¸å¯å†åˆ†çš„åŸå­ç¬¦å·(token),è§£ææˆè¯­æ³•æ ‘ï¼Œè¯­æ³•æ ‘æ˜¯åç»­è·¯ç”±ã€æ”¹å†™ã€å½’å¹¶çš„åŸºç¡€ä¾æ®ã€‚</td>
</tr>
<tr>
<td>è·¯ç”±å¼•æ“</td>
<td>æ ¹æ®è¯­æ³•æ ‘åŒ¹é…é…ç½®çš„è·¯ç”±ç­–ç•¥ï¼Œé€šè¿‡SQLå‚æ•°å’Œç­–ç•¥çš„æ‰§è¡Œåº“è¡¨</td>
</tr>
<tr>
<td>æ”¹å†™å¼•æ“</td>
<td>æ ¹æ®è¯­æ³•æ ‘å’Œè·¯ç”±ç»“æœå°†é€»è¾‘SQLæ”¹å†™æˆçœŸæ­£å¯æ‰§è¡Œçš„çœŸå®SQL,åŒ…æ‹¬é€»è¾‘è¡¨çš„æ›¿æ¢ã€åˆ†é¡µçš„ä¿®æ­£ã€æ’å…¥æ‹†åˆ†ç­‰</td>
</tr>
<tr>
<td>æ‰§è¡Œå¼•æ“</td>
<td>æ ¹æ®SQLæ‰§è¡Œå•å…ƒåˆ›å»ºåˆé€‚çš„è¿æ¥ï¼ˆéœ€å…¼é¡¾å†…å­˜å’Œè¿æ¥èµ„æºï¼‰ï¼Œå¹¶å°†çœŸå®SQLå‘é€è‡³æ•°æ®åº“æ‰§è¡Œ</td>
</tr>
<tr>
<td>å½’å¹¶å¼•æ“</td>
<td>æ ¹æ®è¯­æ³•æ ‘å°†å„ä¸ªæ•°æ®èŠ‚ç‚¹çš„ç»“æœé›†å½’å¹¶æˆæœ€ç»ˆéœ€è¦çš„ç»“æœé›†ï¼ŒåŒ…æ‹¬åˆ†ç»„å½’å¹¶ã€æ’åºå½’å¹¶ã€åˆ†é¡µå½’å¹¶ã€èšåˆå½’å¹¶ç­‰</td>
</tr>
</tbody>
</table>
<h2 id="è§£æå¼•æ“">è§£æå¼•æ“<a hidden class="anchor" aria-hidden="true" href="#è§£æå¼•æ“">#</a></h2>
<h3 id="è§£æå¼•æ“-1">è§£æå¼•æ“<a hidden class="anchor" aria-hidden="true" href="#è§£æå¼•æ“-1">#</a></h3>
<p>è§£æå¼•æ“æ˜¯Sharding-JDBCè¿›è¡Œåˆ†åº“åˆ†è¡¨é€»è¾‘çš„åŸºç¡€ï¼Œå…¶ä½œç”¨æ˜¯å°†SQLæ‹†è§£ä¸ºä¸å¯å†åˆ†çš„åŸå­ç¬¦å·ï¼ˆç§°ä¸ºtokenï¼‰ï¼Œå†æ ¹æ®æ•°æ®åº“ç±»å‹å°†è¿™äº›tokenåˆ†ç±»æˆå…³é”®å­—ã€è¡¨è¾¾å¼ã€æ“ä½œç¬¦ã€å­—é¢é‡ç­‰ä¸åŒç±»å‹ï¼Œè¿›è€Œç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œè€Œè¯­æ³•æ ‘æ˜¯åç»­è¿›è¡Œè·¯ç”±ã€æ”¹å†™æ“ä½œçš„å‰æï¼ˆè¿™ä¹Ÿæ­£æ˜¯è¯­æ³•æ ‘çš„å­˜åœ¨ä½¿å¾—Sharding-JDBCå­˜åœ¨å„å¼å„æ ·çš„è¯­æ³•é™åˆ¶çš„åŸå› ä¹‹ä¸€ï¼‰ã€‚</p>
<p><img loading="lazy" src="2.png" alt=""  />
</p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/parse/">è§£æå¼•æ“ :: ShardingSphere (apache.org)</a></p>
<p>4.xçš„ç‰ˆæœ¬é‡‡ç”¨ANTLRï¼ˆANother Tool for Language Recognitionï¼‰ä½œä¸ºè§£æå¼•æ“ï¼Œåœ¨ShardingSphere-sql-parser-dialectæ¨¡å—ä¸­å®šä¹‰äº†é€‚ç”¨äºä¸åŒæ•°æ®åº“è¯­æ³•çš„è§£æè§„åˆ™ï¼ˆ.g4æ–‡ä»¶ï¼‰ï¼Œideaä¸­ä¹Ÿå¯ä»¥ä¸‹è½½ANTLR v4çš„æ’ä»¶ï¼Œè¾“å…¥SQLæŸ¥çœ‹è§£æåçš„è¯­æ³•æ ‘ç»“æœã€‚</p>
<p>è§£ææ–¹æ³•çš„å…¥å£åœ¨DataNodeRouterçš„createRouteContextæ–¹æ³•ä¸­ï¼Œè§£æå¼•æ“æ ¹æ®æ•°æ®åº“ç±»å‹å’ŒSQLåˆ›å»ºSQLParserExecutoræ‰§è¡Œå¾—åˆ°è§£ææ ‘ï¼Œå†é€šè¿‡ParseTreeVisitor()çš„visitæ–¹æ³•ï¼Œå¯¹è§£ææ ‘è¿›è¡Œå¤„ç†å¾—åˆ°SQLStatementã€‚ANTLRæ”¯æŒlistenerå’Œvisitorä¸¤ç§æ¨¡å¼çš„æ¥å£ï¼Œvisitoræ–¹å¼å¯ä»¥æ›´çµæ´»çš„æ§åˆ¶è§£ææ ‘çš„éå†è¿‡ç¨‹ï¼Œæ›´é€‚ç”¨äºSQLè§£æçš„åœºæ™¯ã€‚</p>
<blockquote>
<p>è§£æå¼•æ“æ ¸å¿ƒä»£ç </p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.route.DataNodeRouter#createRouteContext#96
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> RouteContext createRouteContext(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters, <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> useCache) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è§£æå¼•æ“è§£æSQL
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    SQLStatement sqlStatement = parserEngine.<span style="color:#007f7f">parse</span>(sql, useCache);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        SQLStatementContext sqlStatementContext = SQLStatementContextFactory.<span style="color:#007f7f">newInstance</span>(metaData.<span style="color:#007f7f">getSchema</span>(), sql, parameters, sqlStatement);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(sqlStatementContext, parameters, <span style="color:#fff;font-weight:bold">new</span> RouteResult());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// TODO should pass parameters for master-slave
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    } <span style="color:#fff;font-weight:bold">catch</span> (<span style="color:#fff;font-weight:bold">final</span> IndexOutOfBoundsException ex) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(<span style="color:#fff;font-weight:bold">new</span> CommonSQLStatementContext(sqlStatement), parameters, <span style="color:#fff;font-weight:bold">new</span> RouteResult());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sql.parser.SQLParserEngine#parse0#72
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> SQLStatement parse0(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> useCache) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (useCache) {
</span></span><span style="display:flex;"><span>        Optional&lt;SQLStatement&gt; cachedSQLStatement = cache.<span style="color:#007f7f">getSQLStatement</span>(sql);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (cachedSQLStatement.<span style="color:#007f7f">isPresent</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> cachedSQLStatement.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ ¹æ®æ•°æ®åº“ç±»å‹å’Œsqlç”Ÿæˆè§£ææ ‘
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ParseTree parseTree = <span style="color:#fff;font-weight:bold">new</span> SQLParserExecutor(databaseTypeName, sql).<span style="color:#007f7f">execute</span>().<span style="color:#007f7f">getRootNode</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ParseTreeVisitorçš„visitæ–¹æ³•å¯¹è§£ææ ‘è¿›è¡Œå¤„ç†å¾—åˆ°SQLStatement
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    SQLStatement result = (SQLStatement) ParseTreeVisitorFactory.<span style="color:#007f7f">newInstance</span>(databaseTypeName, VisitorRule.<span style="color:#007f7f">valueOf</span>(parseTree.<span style="color:#007f7f">getClass</span>())).<span style="color:#007f7f">visit</span>(parseTree);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (useCache) {
</span></span><span style="display:flex;"><span>        cache.<span style="color:#007f7f">put</span>(sql, result);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>SQLStatementå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å®ç°å¯¹åº”ç€ä¸åŒçš„SQLç±»å‹ï¼Œå¦‚SelectStatement ç±»ä¸­å°±åŒ…æ‹¬æŸ¥è¯¢çš„å­—æ®µã€è¡¨åã€whereæ¡ä»¶ã€åˆ†ç»„ã€æ’åºã€åˆ†é¡µã€lockç­‰å˜é‡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œå¹¶æ²¡æœ‰å¯¹havingè¿™ç§å­—æ®µåšå®šä¹‰ï¼Œç›¸å½“äºSharding-JDBCæ— æ³•è¯†åˆ«åˆ°SQLä¸­çš„havingï¼Œè¿™ä½¿å¾—Sharding-JDBCå¯¹havingè¯­æ³•æœ‰ä¸€å®šçš„é™åˆ¶ã€‚</p>
<blockquote>
<p>SelectStatement</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SelectStatement <span style="color:#fff;font-weight:bold">extends</span> DMLStatement {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å­—æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> ProjectionsSegment projections;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;TableReferenceSegment&gt; tableReferences = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// where
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> WhereSegment where;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// groupBy
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> GroupBySegment groupBy;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// orderBy
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> OrderBySegment orderBy;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// limit
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> LimitSegment limit;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// çˆ¶statement
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> SelectStatement parentStatement;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// lock
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> LockSegment lock;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>SQLStatementè¿˜ä¼šè¢«è¿›ä¸€æ­¥è½¬æ¢æˆSQLStatementContextï¼Œå¦‚SelectStatement ä¼šè¢«è½¬æ¢æˆSelectStatementContext ï¼Œå…¶ç»“æ„ä¸SelectStatement ç±»ä¼¼ä¸å†å¤šè¯´ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯è™½ç„¶è¿™é‡Œå®šä¹‰äº†containsSubqueryæ¥åˆ¤æ–­æ˜¯å¦åŒ…å«å­æŸ¥è¯¢ï¼Œä½†4.1.1æºç æ°¸è¿œæ˜¯è¿”å›çš„falseï¼Œä¸havingç±»ä¼¼ï¼Œè¿™æ„å‘³ç€Sharding-JDBCä¸ä¼šå¯¹å­æŸ¥è¯¢è¯­å¥åšç‰¹æ®Šå¤„ç†ã€‚</p>
<blockquote>
<p>SelectStatementContext</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SelectStatementContext <span style="color:#fff;font-weight:bold">extends</span> CommonSQLStatementContext&lt;SelectStatement&gt; <span style="color:#fff;font-weight:bold">implements</span> TableAvailable, WhereAvailable {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> TablesContext tablesContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ProjectionsContext projectionsContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> GroupByContext groupByContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> OrderByContext orderByContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> PaginationContext paginationContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> containsSubquery;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> containsSubquery() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// FIXME process subquery
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//        Collection&lt;SubqueryPredicateSegment&gt; subqueryPredicateSegments = getSqlStatement().findSQLSegments(SubqueryPredicateSegment.class);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//        for (SubqueryPredicateSegment each : subqueryPredicateSegments) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//            if (!each.getAndPredicates().isEmpty()) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//                return true;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//            }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//        }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å¼•æ“æ€»ç»“"><strong>å¼•æ“æ€»ç»“</strong><a hidden class="anchor" aria-hidden="true" href="#å¼•æ“æ€»ç»“">#</a></h3>
<p>è§£æå¼•æ“æ˜¯è¿›è¡Œè·¯ç”±æ”¹å†™çš„å‰æåŸºç¡€ï¼Œå…¶ä½œç”¨å°±æ˜¯å°†SQLæŒ‰ç…§å®šä¹‰çš„è¯­æ³•è§„åˆ™æ‹†åˆ†æˆåŸå­ç¬¦å·(token)ï¼Œç”Ÿæˆè¯­æ³•æ ‘ï¼Œæ ¹æ®ä¸åŒçš„SQLç±»å‹ç”Ÿæˆå¯¹åº”çš„SQLStatementï¼ŒSQLStatementç”±å„è‡ªçš„Segmentç»„æˆï¼Œæ‰€æœ‰çš„Segmentéƒ½åŒ…å«startIndexå’ŒendIndexæ¥å®šä½tokenåœ¨SQLä¸­æ‰€å±çš„ä½ç½®ï¼Œä½†è§£æè¯­æ³•éš¾ä»¥æ¶µç›–æ‰€æœ‰çš„SQLåœºæ™¯ï¼Œä½¿å¾—éƒ¨åˆ†SQLæ— æ³•æŒ‰ç…§é¢„æœŸçš„ç»“æœè·¯ç”±æ‰§è¡Œã€‚</p>
<h2 id="è·¯ç”±å¼•æ“">è·¯ç”±å¼•æ“<a hidden class="anchor" aria-hidden="true" href="#è·¯ç”±å¼•æ“">#</a></h2>
<h3 id="è§£æ">è§£æ<a hidden class="anchor" aria-hidden="true" href="#è§£æ">#</a></h3>
<p>è·¯ç”±å¼•æ“æ˜¯Sharding-JDBCçš„æ ¸å¿ƒæ­¥éª¤ï¼Œä½œç”¨æ˜¯æ ¹æ®å®šä¹‰çš„åˆ†åº“åˆ†è¡¨è§„åˆ™å°†è§£æå¼•æ“ç”Ÿæˆçš„SQLä¸Šä¸‹æ–‡ç”Ÿæˆå¯¹åº”çš„è·¯ç”±ç»“æœï¼ŒRouteResult åŒ…æ‹¬DataNodeå’ŒRouteUnitï¼ŒDataNodeæ˜¯å®é™…çš„æ•°æ®æºèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬æ•°æ®æºåç§°å’Œå®é™…çš„ç‰©ç†è¡¨åï¼ŒRouteUnitåˆ™è®°å½•äº†é€»è¾‘è¡¨/åº“ä¸ç‰©ç†è¡¨/åº“çš„æ˜ å°„å…³ç³»ï¼Œåé¢çš„æ”¹å†™å¼•æ“ä¹Ÿæ˜¯æ ¹æ®è¿™ä¸ªæ˜ å°„å…³ç³»æ¥å†³å®šå¦‚ä½•æ›¿æ¢SQLä¸­çš„é€»è¾‘è¡¨ï¼ˆ<strong>å®é™…ä¸ŠRouteResult å°±æ˜¯ç»´æŠ¤äº†ä¸€æ¡SQLéœ€è¦å¾€å“ªäº›åº“å“ªäº›è¡¨æ‰§è¡Œçš„å…³ç³»</strong>ï¼‰ã€‚</p>
<blockquote>
<p>RouteResult</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> RouteResult {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;Collection&lt;DataNode&gt;&gt; originalDataNodes = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;RouteUnit&gt; routeUnits = <span style="color:#fff;font-weight:bold">new</span> LinkedHashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> DataNode {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String DELIMITER = <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String dataSourceName;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String tableName;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> RouteUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> RouteMapper dataSourceMapper;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;RouteMapper&gt; tableMappers;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> RouteMapper {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String logicName;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String actualName;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­ï¼Œè·¯ç”±æœ‰åˆ†ä¸º<strong>åˆ†ç‰‡è·¯ç”±</strong>å’Œ<strong>ä¸»ä»è·¯ç”±</strong>ï¼Œä¸¤è€…å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç»„åˆä½¿ç”¨ã€‚</p>
<h3 id="åˆ†ç‰‡è·¯ç”±">åˆ†ç‰‡è·¯ç”±<a hidden class="anchor" aria-hidden="true" href="#åˆ†ç‰‡è·¯ç”±">#</a></h3>
<p>ShardingRouteDecoratorçš„decorateæ–¹æ³•æ˜¯è·¯ç”±å¼•æ“çš„æ ¸å¿ƒé€»è¾‘ï¼Œç»è¿‡SQLæ ¡éªŒ-&gt;ç”Ÿæˆåˆ†ç‰‡æ¡ä»¶-&gt;åˆå¹¶åˆ†ç‰‡å€¼åå¾—åˆ°è·¯ç”±ç»“æœã€‚</p>
<blockquote>
<p>åˆ†ç‰‡è·¯ç”±decorateæ–¹æ³•</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.route.engine.ShardingRouteDecorator#decorate#57
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> RouteContext decorate(<span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext, <span style="color:#fff;font-weight:bold">final</span> ShardingSphereMetaData metaData, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    SQLStatementContext sqlStatementContext = routeContext.<span style="color:#007f7f">getSqlStatementContext</span>();
</span></span><span style="display:flex;"><span>    List&lt;Object&gt; parameters = routeContext.<span style="color:#007f7f">getParameters</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//SQLæ ¡éªŒ  æ ¡éªŒINSERT INTO .... ON DUPLICATE KEY UPDATE å’ŒUPDATEè¯­å¥ä¸­æ˜¯å¦å­˜åœ¨åˆ†ç‰‡é”®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ShardingStatementValidatorFactory.<span style="color:#007f7f">newInstance</span>(
</span></span><span style="display:flex;"><span>        sqlStatementContext.<span style="color:#007f7f">getSqlStatement</span>()).<span style="color:#007f7f">ifPresent</span>(validator -&gt; validator.<span style="color:#007f7f">validate</span>(shardingRule, sqlStatementContext.<span style="color:#007f7f">getSqlStatement</span>(), parameters));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç”Ÿæˆåˆ†ç‰‡æ¡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ShardingConditions shardingConditions = getShardingConditions(parameters, sqlStatementContext, metaData.<span style="color:#007f7f">getSchema</span>(), shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆå¹¶åˆ†ç‰‡å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">boolean</span> needMergeShardingValues = isNeedMergeShardingValues(sqlStatementContext, shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (sqlStatementContext.<span style="color:#007f7f">getSqlStatement</span>() <span style="color:#fff;font-weight:bold">instanceof</span> DMLStatement &amp;&amp; needMergeShardingValues) {
</span></span><span style="display:flex;"><span>        checkSubqueryShardingValues(sqlStatementContext, shardingRule, shardingConditions);
</span></span><span style="display:flex;"><span>        mergeShardingConditions(shardingConditions);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ShardingRouteEngine shardingRouteEngine = ShardingRouteEngineFactory.<span style="color:#007f7f">newInstance</span>(shardingRule, metaData, sqlStatementContext, shardingConditions, properties);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å¾—åˆ°è·¯ç”±ç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    RouteResult routeResult = shardingRouteEngine.<span style="color:#007f7f">route</span>(shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (needMergeShardingValues) {
</span></span><span style="display:flex;"><span>        Preconditions.<span style="color:#007f7f">checkState</span>(<span style="color:#ff0;font-weight:bold">1</span> == routeResult.<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">size</span>(), <span style="color:#0ff;font-weight:bold">&#34;Must have one sharding with subquery.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(sqlStatementContext, parameters, routeResult);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ShardingStatementValidatoræœ‰
ShardingInsertStatementValidatorå’Œ
ShardingUpdateStatementValidator
ä¸¤ç§å®ç°ï¼ŒINSERT INTO &hellip;. ON DUPLICATE KEY UPDATEå’ŒUPDATEè¯­æ³•éƒ½ä¼šæ¶‰åŠåˆ°å­—æ®µå€¼çš„æ›´æ–°ï¼ŒSharding-JDBCæ˜¯ä¸å…è®¸æ›´æ–°åˆ†ç‰‡å€¼çš„ï¼Œæ¯•ç«Ÿä¿®æ”¹åˆ†ç‰‡å€¼è¿˜éœ€è¦å°†æ•°æ®è¿ç§»è‡³æ–°åˆ†ç‰‡å€¼å¯¹åº”çš„åº“è¡¨ä¸­ï¼Œæ‰èƒ½ä¿è¯æ•°æ®åˆ†ç‰‡è§„åˆ™ä¸€è‡´ã€‚ä¸¤è€…çš„æ ¡éªŒç»†èŠ‚ä¹Ÿæœ‰æ‰€ä¸åŒï¼š</p>
<ul>
<li>INSERT INTO &hellip;. ON DUPLICATE KEY UPDATEä»…ä»…æ˜¯å¯¹UPDATEå­—æ®µçš„æ ¡éªŒï¼Œ ON DUPLICATE KEY UPDATEä¸­åŒ…å«åˆ†ç‰‡é”®å°±ä¼šæŠ¥é”™ï¼›</li>
<li>è€ŒUPDATEè¯­å¥åˆ™ä¼šé¢å¤–æ ¡éªŒWHEREæ¡ä»¶ä¸­åˆ†ç‰‡é”®çš„åŸå§‹å€¼å’ŒSETçš„å€¼æ˜¯å¦ä¸€æ ·ï¼Œä¸ä¸€æ ·åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li>
</ul>
<p><img loading="lazy" src="3.png" alt=""  />
</p>
<p>ShardingConditionä¸­åªæœ‰ä¸€ä¸ªå˜é‡routeValuesï¼ŒRouteValueæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰ListRouteValueå’ŒRangeRouteValueä¸¤ç§å®ç°ï¼Œå‰è€…è®°å½•äº†åˆ†ç‰‡é”®çš„inæˆ–=æ¡ä»¶çš„åˆ†ç‰‡å€¼ï¼Œåè€…åˆ™è®°å½•äº†èŒƒå›´æŸ¥è¯¢çš„åˆ†ç‰‡å€¼ï¼Œä¸¤è€…è¢«å°è£…ä¸ºShardingValueå¯¹è±¡åï¼Œå°†ä¼šé€ä¼ è‡³åˆ†ç‰‡ç®—æ³•ä¸­è®¡ç®—å¾—åˆ°åˆ†ç‰‡ç»“æœé›†ã€‚</p>
<blockquote>
<p>ShardingCondition</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ShardingConditions {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;ShardingCondition&gt; conditions;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ShardingCondition {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;RouteValue&gt; routeValues = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ListRouteValue&lt;T <span style="color:#fff;font-weight:bold">extends</span> Comparable&lt;?&gt;&gt; <span style="color:#fff;font-weight:bold">implements</span> RouteValue {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String columnName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String tableName;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//inæˆ–=æ¡ä»¶å¯¹åº”çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;T&gt; values;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String toString() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> tableName + <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span> + columnName + (<span style="color:#ff0;font-weight:bold">1</span> == values.<span style="color:#007f7f">size</span>() ? <span style="color:#0ff;font-weight:bold">&#34; = &#34;</span> + <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;(values).<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>) : <span style="color:#0ff;font-weight:bold">&#34; in (&#34;</span> + Joiner.<span style="color:#007f7f">on</span>(<span style="color:#0ff;font-weight:bold">&#34;,&#34;</span>).<span style="color:#007f7f">join</span>(values) + <span style="color:#0ff;font-weight:bold">&#34;)&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> RangeRouteValue&lt;T <span style="color:#fff;font-weight:bold">extends</span> Comparable&lt;?&gt;&gt; <span style="color:#fff;font-weight:bold">implements</span> RouteValue {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String columnName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String tableName;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//between and å¤§äºå°äºç­‰èŒƒå›´å€¼çš„ä¸Šä¸‹é™
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Range&lt;T&gt; valueRange;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”Ÿæˆåˆ†ç‰‡æ¡ä»¶åè¿˜ä¼šåˆå¹¶åˆ†ç‰‡æ¡ä»¶ï¼Œä½†æ˜¯å‰æ–‡æè¿‡åœ¨SelectStatementContextä¸­çš„containsSubqueryæ°¸è¿œæ˜¯falseï¼Œæ‰€ä»¥è¿™æ®µé€»è¾‘æ°¸è¿œè¿”å›falseï¼Œå³ä¸ä¼šåˆå¹¶åˆ†ç‰‡æ¡ä»¶ã€‚</p>
<blockquote>
<p>åˆ¤æ–­æ˜¯å¦éœ€è¦åˆå¹¶åˆ†ç‰‡æ¡ä»¶</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.route.enine.ShardingRouteDecorator#isNeedMergeShardingValues#87
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> isNeedMergeShardingValues(<span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> sqlStatementContext <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatementContext &amp;&amp; ((SelectStatementContext) sqlStatementContext).<span style="color:#007f7f">isContainsSubquery</span>()
</span></span><span style="display:flex;"><span>        &amp;&amp; !shardingRule.<span style="color:#007f7f">getShardingLogicTableNames</span>(sqlStatementContext.<span style="color:#007f7f">getTablesContext</span>().<span style="color:#007f7f">getTableNames</span>()).<span style="color:#007f7f">isEmpty</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åå°±æ˜¯é€šè¿‡åˆ†ç‰‡è·¯ç”±å¼•æ“è°ƒç”¨åˆ†ç‰‡ç®—æ³•è®¡ç®—è·¯ç”±ç»“æœäº†ï¼ŒShardingRouteEngineå®ç°è¾ƒå¤šï¼Œä»‹ç»èµ·æ¥ç¯‡å¹…è¾ƒå¤šï¼Œè¿™é‡Œå°±ä¸å±•å¼€è¯´æ˜äº†ï¼Œå¯ä»¥<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/route/">å‚è€ƒå®˜æ–¹æ–‡æ¡£æ¥äº†è§£è·¯ç”±å¼•æ“çš„é€‰æ‹©è§„åˆ™</a>ã€‚</p>
<p><img loading="lazy" src="4.png" alt=""  />
</p>
<p>Sharding-JDBCå®šä¹‰äº†å¤šç§åˆ†ç‰‡ç­–ç•¥å’Œç®—æ³•æ¥å£ï¼Œä¸»è¦çš„åˆ†é…ç­–ç•¥ä¸ç®—æ³•è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th>åˆ†ç‰‡ç­–ç•¥</th>
<th>åˆ†ç‰‡ç®—æ³•</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ ‡å‡†åˆ†ç‰‡ç­–ç•¥StandardShardingStrategy</td>
<td>ç²¾ç¡®åˆ†ç‰‡ç®—æ³•PreciseShardingAlgorithm<br /><br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br /><br />èŒƒå›´åˆ†ç‰‡ç®—æ³•RangeShardingAlgorithm</td>
<td>ç”¨äºå¤„ç†ä½¿ç”¨å•ä¸€é”®ä½œä¸ºåˆ†ç‰‡é”®çš„=ä¸Nè¿›è¡Œåˆ†ç‰‡çš„åœºæ™¯<br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br /><br />ç”¨äºå¤„ç†ä½¿ç”¨å•ä¸€é”®ä½œä¸ºåˆ†ç‰‡é”®çš„BETWEEN ANDã€&gt;ã€&lt;ã€&gt;=ã€&lt;=è¿›è¡Œåˆ†ç‰‡çš„åœºæ™¯</td>
</tr>
<tr>
<td>å¤åˆåˆ†ç‰‡ç­–ç•¥ComplexShardingStrategy</td>
<td>å¤åˆåˆ†ç‰‡ç®—æ³•<br />ComplexKeysShardingAlgorithm</td>
<td>ç”¨äºå¤„ç†ä½¿ç”¨å¤šé”®ä½œä¸ºåˆ†ç‰‡é”®è¿›è¡Œåˆ†ç‰‡çš„åœºæ™¯ï¼Œæä¾›å¯¹SQLè¯­å¥ä¸­çš„=ï¼Œ&gt;ï¼Œ&lt;ï¼Œ&gt;=ï¼Œ&lt;=ï¼ŒINå’ŒBETWEEN ANDçš„åˆ†ç‰‡æ“ä½œæ”¯æŒ</td>
</tr>
<tr>
<td>è¡Œè¡¨è¾¾å¼åˆ†ç‰‡ç­–ç•¥iInlineShardingStrategy</td>
<td>/</td>
<td>ä½¿ç”¨Gooyçš„è¡¨è¾¾å¼ï¼Œé»˜è®¤åªæ”¯æŒSQLè¯­å¥ä¸­çš„=å’ŒNçš„åˆ†ç‰‡æ“ä½œï¼Œåªæ”¯æŒå•åˆ†ç‰‡é”®</td>
</tr>
<tr>
<td>Hintåˆ†ç‰‡ç­–è·¯HintShardingStrategy</td>
<td>Hintåˆ†ç‰‡ç®—æ³•<br />HintShardingAlgorithm</td>
<td>é€šè¿‡HitæŒ‡å®šåˆ†ç‰‡å€¼è€Œéä»SQLä¸­æå–åˆ†ç‰‡å€¼çš„æ–¹å¼è¿›è¡Œåˆ†ç‰‡çš„ç­–ç•¥</td>
</tr>
</tbody>
</table>
<p><strong>è¡¥å……ä¸¤ä¸ªç»†èŠ‚ï¼š</strong></p>
<p>ï¼ˆ1ï¼‰å½“ALLOW_RANGE_QUERY_WITH_INLINE_SHARDINGé…ç½®è®¾ç½®trueæ—¶ï¼Œ</p>
<p>InlineShardingStrategyæ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ ¹æ®åˆ†ç‰‡å€¼è®¡ç®—èŒƒå›´ï¼Œè€Œæ˜¯<strong>ç›´æ¥å…¨è·¯ç”±è‡³é…ç½®çš„æ•°æ®èŠ‚ç‚¹ï¼Œä¼šå­˜åœ¨æ€§èƒ½éšæ‚£ã€‚</strong></p>
<blockquote>
<p>InlineShardingStrategy.doSharding</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.core.strategy.route.inline.InlineShardingStrategy#doSharding
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> Collection&lt;String&gt; doSharding(<span style="color:#fff;font-weight:bold">final</span> Collection&lt;String&gt; availableTargetNames, <span style="color:#fff;font-weight:bold">final</span> Collection&lt;RouteValue&gt; shardingValues, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    RouteValue shardingValue = shardingValues.<span style="color:#007f7f">iterator</span>().<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ALLOW_RANGE_QUERY_WITH_INLINE_SHARDINGè®¾ç½®ä¸ºtrueï¼Œç›´æ¥è¿”å›availableTargetNamesï¼Œè€Œä¸æ˜¯æ ¹æ®RangeRouteValueè®¡ç®—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">ALLOW_RANGE_QUERY_WITH_INLINE_SHARDING</span>) &amp;&amp; shardingValue <span style="color:#fff;font-weight:bold">instanceof</span> RangeRouteValue) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> availableTargetNames;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Preconditions.<span style="color:#007f7f">checkState</span>(shardingValue <span style="color:#fff;font-weight:bold">instanceof</span> ListRouteValue, <span style="color:#0ff;font-weight:bold">&#34;Inline strategy cannot support this type sharding:&#34;</span> + shardingValue.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>    Collection&lt;String&gt; shardingResult = doSharding((ListRouteValue) shardingValue);
</span></span><span style="display:flex;"><span>    Collection&lt;String&gt; result = <span style="color:#fff;font-weight:bold">new</span> TreeSet&lt;&gt;(String.<span style="color:#007f7f">CASE_INSENSITIVE_ORDER</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (String each : shardingResult) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (availableTargetNames.<span style="color:#007f7f">contains</span>(each)) {
</span></span><span style="display:flex;"><span>            result.<span style="color:#007f7f">add</span>(each);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ï¼ˆ2ï¼‰4.1.1çš„<a href="https://shardingsphere.apache.org/document/4.1.1/cn/manual/sharding-jdbc/usage/hint/">å®˜æ–¹æ–‡æ¡£è™½ç„¶è¯´Hintå¯ä»¥è·³è¿‡è§£æå’Œæ”¹å†™</a>ï¼Œä½†åœ¨æˆ‘ä»¬ä¸Šé¢è§£æå¼•æ“çš„æºç è§£æä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰çœ‹åˆ°æœ‰å¯¹Hintç­–ç•¥çš„é¢å¤–è·³è¿‡ã€‚äº‹å®ä¸Šï¼Œå³ä½¿ä½¿ç”¨äº†Hintåˆ†ç‰‡SQLä¹ŸåŒæ ·éœ€è¦è§£æé‡å†™ï¼Œä¹ŸåŒæ ·å—Sharding-JDBCçš„è¯­æ³•é™åˆ¶ï¼Œè¿™åœ¨<a href="https://github.com/apache/shardingsphere/issues/6458">å®˜æ–¹çš„issue</a>ä¸­ä¹Ÿæ›¾ç»è¢«æåŠã€‚</p>
<h3 id="ä¸»ä»è·¯ç”±">ä¸»ä»è·¯ç”±<a hidden class="anchor" aria-hidden="true" href="#ä¸»ä»è·¯ç”±">#</a></h3>
<p>ä¸»ä»è·¯ç”±çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯é€šè¿‡ MasterSlaveDataSourceRouter çš„routeæ–¹æ³•è¿›è¡Œåˆ¤å®šSQLèµ°ä¸»åº“è¿˜æ˜¯ä»åº“ã€‚ä¸»ä»æƒ…å†µä¸‹ï¼Œé…ç½®çš„æ•°æ®æºå®é™…æ˜¯ä¸€ç»„ä¸»ä»ï¼Œè€Œä¸æ˜¯å•ä¸ªçš„å®ä¾‹ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡masterSlaveRuleè·å–åˆ°å…·ä½“çš„ä¸»åº“æˆ–è€…ä»åº“åå­—ã€‚</p>
<blockquote>
<p>ä¸»ä»è·¯ç”±decorate</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.masterslave.route.engine.MasterSlaveRouteDecorator#decorate    
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> RouteContext decorate(<span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext, <span style="color:#fff;font-weight:bold">final</span> ShardingSphereMetaData metaData, <span style="color:#fff;font-weight:bold">final</span> MasterSlaveRule masterSlaveRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ä¸ºç©ºè¯æ˜æ²¡æœ‰ç»è¿‡åˆ†ç‰‡è·¯ç”±
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ ¹æ®SQLåˆ¤æ–­é€‰æ‹©èµ°ä¸»åº“è¿˜æ˜¯ä»åº“
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String dataSourceName = <span style="color:#fff;font-weight:bold">new</span> MasterSlaveDataSourceRouter(masterSlaveRule).<span style="color:#007f7f">route</span>(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>().<span style="color:#007f7f">getSqlStatement</span>());
</span></span><span style="display:flex;"><span>        RouteResult routeResult = <span style="color:#fff;font-weight:bold">new</span> RouteResult();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ ¹æ®å…·ä½“çš„ä¸»åº“/ä»åº“ååˆ›å»ºè·¯ç”±å•å…ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        routeResult.<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> RouteUnit(<span style="color:#fff;font-weight:bold">new</span> RouteMapper(dataSourceName, dataSourceName), Collections.<span style="color:#007f7f">emptyList</span>()));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>(), Collections.<span style="color:#007f7f">emptyList</span>(), routeResult);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Collection&lt;RouteUnit&gt; toBeRemoved = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    Collection&lt;RouteUnit&gt; toBeAdded = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ä¸ä¸ºç©ºè¯æ˜å·²ç»è¢«åˆ†ç‰‡è·¯ç”±å¤„ç†äº†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (RouteUnit each : routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (masterSlaveRule.<span style="color:#007f7f">getName</span>().<span style="color:#007f7f">equalsIgnoreCase</span>(each.<span style="color:#007f7f">getDataSourceMapper</span>().<span style="color:#007f7f">getActualName</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å…ˆæ ‡è®°ç§»é™¤ å› ä¸ºè¿™é‡Œæ˜¯ä¸€ç»„ä¸»ä»çš„åå­—è€Œä¸æ˜¯å®é™…çš„åº“
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            toBeRemoved.<span style="color:#007f7f">add</span>(each);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ ¹æ®SQLåˆ¤æ–­é€‰æ‹©èµ°ä¸»åº“è¿˜æ˜¯ä»åº“
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String actualDataSourceName = <span style="color:#fff;font-weight:bold">new</span> MasterSlaveDataSourceRouter(masterSlaveRule).<span style="color:#007f7f">route</span>(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>().<span style="color:#007f7f">getSqlStatement</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ ¹æ®å…·ä½“çš„ä¸»åº“/ä»åº“ååˆ›å»ºè·¯ç”±å•å…ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            toBeAdded.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> RouteUnit(<span style="color:#fff;font-weight:bold">new</span> RouteMapper(each.<span style="color:#007f7f">getDataSourceMapper</span>().<span style="color:#007f7f">getLogicName</span>(), actualDataSourceName), each.<span style="color:#007f7f">getTableMappers</span>()));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">removeAll</span>(toBeRemoved);
</span></span><span style="display:flex;"><span>    routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">addAll</span>(toBeAdded);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> routeContext;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>MasterSlaveDataSourceRouterä¸­isMasterRouteæ–¹æ³•ä¼šåˆ¤æ–­SQLæ˜¯å¦éœ€è¦èµ°ä¸»åº“ï¼Œå½“å‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶èµ°ä¸»åº“ï¼š</p>
<ul>
<li>selectè¯­å¥åŒ…å«é”ï¼Œå¦‚for updateè¯­å¥</li>
<li>ä¸æ˜¯selectè¯­å¥</li>
<li>MasterVisitedManager.isMasterVisited()è®¾ç½®ä¸ºtrue</li>
<li>HintManager.isMasterRouteOnly()è®¾ç½®ä¸ºtrue</li>
</ul>
<p>ä¸èµ°ä¸»åº“åˆ™é€šè¿‡è´Ÿè½½ç®—æ³•é€‰æ‹©ä»åº“ï¼ŒSharding-JDBCæä¾›äº†<strong>è½®è¯¢å’Œéšæœº</strong>ä¸¤ç§ç®—æ³•ã€‚</p>
<blockquote>
<p>MasterSlaveDataSourceRouter</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> MasterSlaveDataSourceRouter {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> MasterSlaveRule masterSlaveRule;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Route.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param sqlStatement SQL statement
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return data source name
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String route(<span style="color:#fff;font-weight:bold">final</span> SQLStatement sqlStatement) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (isMasterRoute(sqlStatement)) {
</span></span><span style="display:flex;"><span>            MasterVisitedManager.<span style="color:#007f7f">setMasterVisited</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> masterSlaveRule.<span style="color:#007f7f">getMasterDataSourceName</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> masterSlaveRule.<span style="color:#007f7f">getLoadBalanceAlgorithm</span>().<span style="color:#007f7f">getDataSource</span>(
</span></span><span style="display:flex;"><span>            masterSlaveRule.<span style="color:#007f7f">getName</span>(), masterSlaveRule.<span style="color:#007f7f">getMasterDataSourceName</span>(), <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;(masterSlaveRule.<span style="color:#007f7f">getSlaveDataSourceNames</span>()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> isMasterRoute(<span style="color:#fff;font-weight:bold">final</span> SQLStatement sqlStatement) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> containsLockSegment(sqlStatement) || !(sqlStatement <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatement) || MasterVisitedManager.<span style="color:#007f7f">isMasterVisited</span>() || HintManager.<span style="color:#007f7f">isMasterRouteOnly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> containsLockSegment(<span style="color:#fff;font-weight:bold">final</span> SQLStatement sqlStatement) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> sqlStatement <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatement &amp;&amp; ((SelectStatement) sqlStatement).<span style="color:#007f7f">getLock</span>().<span style="color:#007f7f">isPresent</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ˜¯å¦èµ°ä¸»åº“çš„ä¿¡æ¯å­˜åœ¨MasterVisitedManagerä¸­ï¼ŒMasterVisitedManageræ˜¯é€šè¿‡ThreadLocalå®ç°çš„ï¼Œä½†è¿™ç§å®ç°ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ<strong>å½“æˆ‘ä»¬ä½¿ç”¨äº‹åŠ¡å…ˆæŸ¥è¯¢å†æ›´æ–°/æ’å…¥æ—¶ï¼Œç¬¬ä¸€æ¡æŸ¥è¯¢SQLå¹¶ä¸ä¼šèµ°ä¸»åº“ï¼Œè€Œæ˜¯èµ°ä»åº“</strong>ï¼Œå¦‚æœä¸šåŠ¡éœ€è¦äº‹åŠ¡çš„ç¬¬ä¸€æ¡æŸ¥è¯¢ä¹Ÿèµ°ä¸»åº“ï¼Œäº‹åŠ¡æŸ¥è¯¢å‰éœ€è¦æ‰‹åŠ¨è°ƒç”¨ä¸€æ¬¡MasterVisitedManager.setMasterVisited()ã€‚</p>
<blockquote>
<p>MasterVisitedManager</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> MasterVisitedManager {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ThreadLocal&lt;Boolean&gt; MASTER_VISITED = ThreadLocal.<span style="color:#007f7f">withInitial</span>(() -&gt; <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Judge master data source visited in current thread.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return master data source visited or not in current thread
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">boolean</span> isMasterVisited() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> MASTER_VISITED.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Set master data source visited in current thread.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setMasterVisited() {
</span></span><span style="display:flex;"><span>        MASTER_VISITED.<span style="color:#007f7f">set</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Clear master data source visited.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> clear() {
</span></span><span style="display:flex;"><span>        MASTER_VISITED.<span style="color:#007f7f">remove</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å¼•æ“æ€»ç»“-1">å¼•æ“æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#å¼•æ“æ€»ç»“-1">#</a></h3>
<p>è·¯ç”±å¼•æ“çš„ä½œç”¨æ˜¯å°†SQLæ ¹æ®å‚æ•°é€šè¿‡å®ç°çš„ç­–ç•¥ç®—æ³•è®¡ç®—å‡ºå®é™…è¯¥åœ¨å“ªäº›åº“çš„å“ªäº›è¡¨æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è·¯ç”±ç»“æœã€‚è·¯ç”±å¼•æ“æœ‰ä¸¤ç§å®ç°ï¼Œåˆ†åˆ«æ˜¯åˆ†ç‰‡è·¯ç”±å’Œä¸»ä»è·¯ç”±ï¼Œä¸¤è€…éƒ½æä¾›äº†æ ‡å‡†åŒ–çš„ç­–ç•¥æ¥å£æ¥è®©ä¸šåŠ¡å®ç°è‡ªå·±çš„è·¯ç”±ç­–ç•¥ï¼Œåˆ†ç‰‡è·¯ç”±éœ€è¦æ³¨æ„è‡ªèº«SQLåœºæ™¯å’Œç­–ç•¥ç®—æ³•ç›¸åŒ¹é…ï¼Œä¸»ä»è·¯ç”±ä¸­åŒä¸€çº¿ç¨‹ä¸”åŒä¸€æ•°æ®åº“è¿æ¥å†…ï¼Œæœ‰å†™å…¥æ“ä½œåï¼Œä¹‹åçš„è¯»æ“ä½œä¼šä»ä¸»åº“è¯»å–ï¼Œå†™å…¥æ“ä½œå‰çš„è¯»æ“ä½œä¸ä¼šèµ°ä¸»åº“ã€‚</p>
<h2 id="æ”¹å†™å¼•æ“">æ”¹å†™å¼•æ“<a hidden class="anchor" aria-hidden="true" href="#æ”¹å†™å¼•æ“">#</a></h2>
<h3 id="è§£æ-1">è§£æ<a hidden class="anchor" aria-hidden="true" href="#è§£æ-1">#</a></h3>
<p>ç»è¿‡è§£æè·¯ç”±åè™½ç„¶ç¡®å®šäº†æ‰§è¡Œçš„å®é™…åº“è¡¨ï¼Œä½†SQLä¸­è¡¨åä¾æ—§æ˜¯é€»è¾‘è¡¨ï¼Œä¸èƒ½æ‰§è¡Œï¼Œæ”¹å†™å¼•æ“å¯ä»¥å°†é€»è¾‘è¡¨æ›¿æ¢ä¸ºç‰©ç†è¡¨ã€‚åŒæ—¶ï¼Œè·¯ç”±è‡³å¤šåº“è¡¨çš„SQLä¹Ÿéœ€è¦æ‹†åˆ†ä¸ºå¤šæ¡SQLæ‰§è¡Œã€‚</p>
<p>æ”¹å†™çš„å…¥å£ä»æ—§åœ¨BasePrepareEngineä¸­ï¼Œåˆ›å»ºé‡å†™ä¸Šä¸‹æ–‡createSQLRewriteContextï¼Œå†æ ¹æ®ä¸Šä¸‹æ–‡è¿›è¡Œæ”¹å†™rewriteï¼Œæœ€ç»ˆè¿”å›æ‰§è¡Œå•å…ƒExecutionUnitã€‚</p>
<blockquote>
<p>æ”¹å†™é€»è¾‘å…¥å£</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#executeRewrite
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> Collection&lt;ExecutionUnit&gt; executeRewrite(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters, <span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ³¨å†Œé‡å†™è£…é¥°å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    registerRewriteDecorator();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ›å»º SQLRewriteContext
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    SQLRewriteContext sqlRewriteContext = rewriter.<span style="color:#007f7f">createSQLRewriteContext</span>(sql, parameters, routeContext.<span style="color:#007f7f">getSqlStatementContext</span>(), routeContext);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//é‡å†™
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">isEmpty</span>() ? rewrite(sqlRewriteContext) : rewrite(routeContext, sqlRewriteContext);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œå•å…ƒåŒ…å«äº†æ•°æ®æºåç§°ï¼Œæ”¹å†™åçš„SQLï¼Œä»¥åŠå¯¹åº”çš„å‚æ•°ï¼ŒSQLä¸€æ ·çš„ä¸¤ä¸ªSQLUnitä¼šè¢«è§†ä¸ºç›¸ç­‰ã€‚</p>
<blockquote>
<p>ExecutionUnit</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span>@EqualsAndHashCode
</span></span><span style="display:flex;"><span>@ToString
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ExecutionUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String dataSourceName;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SQLUnit sqlUnit;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@AllArgsConstructor
</span></span><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span>@Setter
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ ¹æ®sqlåˆ¤æ–­æ˜¯å¦ç›¸ç­‰
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@EqualsAndHashCode(of = { <span style="color:#0ff;font-weight:bold">&#34;sql&#34;</span> })
</span></span><span style="display:flex;"><span>@ToString
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SQLUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String sql;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>createSQLRewriteContextå®Œæˆäº†ä¸¤ä»¶äº‹ï¼Œä¸€ä¸ªæ˜¯å¯¹SQLå‚æ•°è¿›è¡Œäº†é‡å†™ï¼Œä¸€ä¸ªæ˜¯ç”Ÿæˆäº†SQLTokenã€‚</p>
<blockquote>
<p>createSQLRewriteContext</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.rewrite.SQLRewriteEntry#createSQLRewriteContext
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> SQLRewriteContext createSQLRewriteContext(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters, <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext, <span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext) {
</span></span><span style="display:flex;"><span>    SQLRewriteContext result = <span style="color:#fff;font-weight:bold">new</span> SQLRewriteContext(schemaMetaData, sqlStatementContext, sql, parameters);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//sqlå‚æ•°é‡å†™
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    decorate(decorators, result, routeContext);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç”ŸæˆSQLToken
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    result.<span style="color:#007f7f">generateSQLTokens</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.rewrite.context.ShardingSQLRewriteContextDecorator#decorate
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decorate(<span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties, <span style="color:#fff;font-weight:bold">final</span> SQLRewriteContext sqlRewriteContext) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (ParameterRewriter each : <span style="color:#fff;font-weight:bold">new</span> ShardingParameterRewriterBuilder(shardingRule, routeContext).<span style="color:#007f7f">getParameterRewriters</span>(sqlRewriteContext.<span style="color:#007f7f">getSchemaMetaData</span>())) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!sqlRewriteContext.<span style="color:#007f7f">getParameters</span>().<span style="color:#007f7f">isEmpty</span>() &amp;&amp; each.<span style="color:#007f7f">isNeedRewrite</span>(sqlRewriteContext.<span style="color:#007f7f">getSqlStatementContext</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å‚æ•°é‡å†™
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            each.<span style="color:#007f7f">rewrite</span>(sqlRewriteContext.<span style="color:#007f7f">getParameterBuilder</span>(), sqlRewriteContext.<span style="color:#007f7f">getSqlStatementContext</span>(), sqlRewriteContext.<span style="color:#007f7f">getParameters</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//sqlTokenGenerators
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    sqlRewriteContext.<span style="color:#007f7f">addSQLTokenGenerators</span>(<span style="color:#fff;font-weight:bold">new</span> ShardingTokenGenerateBuilder(shardingRule, routeContext).<span style="color:#007f7f">getSQLTokenGenerators</span>());
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.rewrite.context.SQLRewriteContext#generateSQLTokens
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> generateSQLTokens() {
</span></span><span style="display:flex;"><span>    sqlTokens.<span style="color:#007f7f">addAll</span>(sqlTokenGenerators.<span style="color:#007f7f">generateSQLTokens</span>(sqlStatementContext, parameters, schemaMetaData));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ParameterRewriterä¸­ä¸åˆ†ç‰‡ç›¸å…³çš„å®ç°æœ‰ä¸¤ç§ã€‚</p>
<table>
<thead>
<tr>
<th>å®ç°ç±»</th>
<th>å¤„ç†è¯­å¥</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>ShardingPaginationParameterRewriter</td>
<td>selectè¯­å¥</td>
<td>åˆ†é¡µé‡å†™ï¼Œå‘ç”Ÿåœ¨RouteUnit&gt;1çš„æƒ…å†µä¸‹ï¼Œå› ä¸ºå¤šæ•°æ®æºçš„åˆ†é¡µéœ€è¦æ±‡æ€»æ¯å¼ è¡¨çš„æ•°æ®å†åˆ†é¡µ</td>
</tr>
<tr>
<td>ShardingGeneratedKeylnsertValueParameterRewrite</td>
<td>insertè¯­å¥</td>
<td>ä¸»é”®é‡å†™ï¼Œåœ¨ä¸ä½¿ç”¨æ•°æ®åº“è‡ªå¢ä¸»é”®çš„æƒ…å†µä¸‹ï¼Œæä¾›åˆ†å¸ƒå¼ä¸»é”®çš„æ”¹å†™ï¼Œé»˜è®¤æ˜¯é›ªèŠ±ç®—æ³•</td>
</tr>
</tbody>
</table>
<p><em>//*è¯¦ç»†çš„ä¾‹å­å¯ä»¥å‚è€ƒ<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/rewrite/">å®˜æ–¹æ–‡æ¡£ä¸­åˆ†é¡µä¿®æ­£å’Œè¡¥åˆ—éƒ¨åˆ†</a>ã€‚</em></p>
<p>SQLTokenè®°å½•äº†SQLä¸­æ¯ä¸ªtokenï¼ˆè§£æå¼•æ“ä¸­æè¿‡çš„ä¸å¯å†åˆ†çš„åŸå­ç¬¦å·ï¼‰çš„èµ·å§‹ä½ç½®ï¼Œä»è€Œæ–¹ä¾¿æ”¹å†™å¼•æ“çŸ¥é“å“ªäº›ä½ç½®éœ€è¦æ”¹å†™ã€‚</p>
<blockquote>
<p>SQLToken</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">class</span> SQLToken <span style="color:#fff;font-weight:bold">implements</span> Comparable&lt;SQLToken&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> startIndex;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> compareTo(<span style="color:#fff;font-weight:bold">final</span> SQLToken sqlToken) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> startIndex - sqlToken.<span style="color:#007f7f">getStartIndex</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºå®ŒSQLRewriteContextåå°±å¯¹æ•´æ¡SQLè¿›è¡Œé‡å†™å’Œç»„è£…å‚æ•°ï¼Œå¯ä»¥çœ‹å‡ºæ¯ä¸ªRouteUnitéƒ½ä¼šé‡å†™SQLå¹¶è·å–è‡ªå·±å¯¹åº”çš„å‚æ•°ã€‚</p>
<blockquote>
<p>SQLRouteRewriteEngine.rewrite</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.rewrite.engine.SQLRouteRewriteEngine#rewrite
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> Map&lt;RouteUnit, SQLRewriteResult&gt; rewrite(<span style="color:#fff;font-weight:bold">final</span> SQLRewriteContext sqlRewriteContext, <span style="color:#fff;font-weight:bold">final</span> RouteResult routeResult) {
</span></span><span style="display:flex;"><span>    Map&lt;RouteUnit, SQLRewriteResult&gt; result = <span style="color:#fff;font-weight:bold">new</span> LinkedHashMap&lt;&gt;(routeResult.<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">size</span>(), <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (RouteUnit each : routeResult.<span style="color:#007f7f">getRouteUnits</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//é‡å†™SQL+ç»„è£…å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        result.<span style="color:#007f7f">put</span>(each, <span style="color:#fff;font-weight:bold">new</span> SQLRewriteResult(<span style="color:#fff;font-weight:bold">new</span> RouteSQLBuilder(sqlRewriteContext, each).<span style="color:#007f7f">toSQL</span>(), getParameters(sqlRewriteContext.<span style="color:#007f7f">getParameterBuilder</span>(), routeResult, each)));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>toSQLæ ¸å¿ƒå°±æ˜¯æ ¹æ®SQLTokenå°†SQLæ‹†åˆ†æ”¹å†™å†æ‹¼è£…ï¼Œæ¯”å¦‚</p>
<p><code>select * from t_order where created_by = '123' </code></p>
<p>å°±ä¼šè¢«æ‹†åˆ†ä¸º <code>select * from | t_order | where created_by = '123'</code> ä¸‰éƒ¨åˆ†è¿›è¡Œæ”¹å†™æ‹¼è£…ã€‚</p>
<blockquote>
<p>toSQL</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.rewrite.sql.impl.AbstractSQLBuilder#toSQL
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> String toSQL() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (context.<span style="color:#007f7f">getSqlTokens</span>().<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> context.<span style="color:#007f7f">getSql</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Collections.<span style="color:#007f7f">sort</span>(context.<span style="color:#007f7f">getSqlTokens</span>());
</span></span><span style="display:flex;"><span>    StringBuilder result = <span style="color:#fff;font-weight:bold">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æˆªå–ç¬¬ä¸€ä¸ªSQLTokenä¹‹å‰çš„å†…å®¹  select * from
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    result.<span style="color:#007f7f">append</span>(context.<span style="color:#007f7f">getSql</span>().<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">0</span>, context.<span style="color:#007f7f">getSqlTokens</span>().<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>).<span style="color:#007f7f">getStartIndex</span>()));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (SQLToken each : context.<span style="color:#007f7f">getSqlTokens</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//é‡å†™æ‹¼æ¥æ¯ä¸ªSQLTokenå¯¹åº”çš„å†…å®¹  t_order -&gt;t_order_0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        result.<span style="color:#007f7f">append</span>(getSQLTokenText(each));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ‹¼æ¥SQLTokenä¸­é—´ä¸å˜çš„å†…å®¹ where created_by = &#39;123&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        result.<span style="color:#007f7f">append</span>(getConjunctionText(each));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result.<span style="color:#007f7f">toString</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ParameterBuilderæœ‰StandardParameterBuilderå’ŒGroupedParameterBuilderä¸¤ä¸ªå®ç°ã€‚</p>
<ul>
<li>**StandardParameterBuilderï¼š**é€‚ç”¨äºéinsertè¯­å¥ï¼ŒgetParametersæ— éœ€åˆ†ç»„å¤„ç†ç›´æ¥è¿”å›å³å¯</li>
<li>**GroupedParameterBuilderï¼š**é€‚ç”¨äºinsertè¯­å¥ï¼Œéœ€è¦æ ¹æ®è·¯ç”±æƒ…å†µå¯¹å‚æ•°è¿›è¡Œåˆ†ç»„ã€‚</li>
</ul>
<p>åŸå› å’Œæ ·ä¾‹å¯ä»¥å‚è€ƒ<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/rewrite/">å®˜æ–¹æ–‡æ¡£æ‰¹é‡æ‹†åˆ†éƒ¨åˆ†</a>ã€‚</p>
<blockquote>
<p>getParameters</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.rewrite.engine.SQLRouteRewriteEngine#getParameters
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> List&lt;Object&gt; getParameters(<span style="color:#fff;font-weight:bold">final</span> ParameterBuilder parameterBuilder, <span style="color:#fff;font-weight:bold">final</span> RouteResult routeResult, <span style="color:#fff;font-weight:bold">final</span> RouteUnit routeUnit) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (parameterBuilder <span style="color:#fff;font-weight:bold">instanceof</span> StandardParameterBuilder || routeResult.<span style="color:#007f7f">getOriginalDataNodes</span>().<span style="color:#007f7f">isEmpty</span>() || parameterBuilder.<span style="color:#007f7f">getParameters</span>().<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//éæ’å…¥è¯­å¥ç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> parameterBuilder.<span style="color:#007f7f">getParameters</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    List&lt;Object&gt; result = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> count = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (Collection&lt;DataNode&gt; each : routeResult.<span style="color:#007f7f">getOriginalDataNodes</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (isInSameDataNode(each, routeUnit)) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ’å…¥è¯­å¥å‚æ•°åˆ†ç»„æ„é€ 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            result.<span style="color:#007f7f">addAll</span>(((GroupedParameterBuilder) parameterBuilder).<span style="color:#007f7f">getParameters</span>(count));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        count++;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h3>
<p>æ”¹å†™å¼•æ“çš„ä½œç”¨æ˜¯å°†é€»è¾‘SQLè½¬æ¢ä¸ºå®é™…å¯æ‰§è¡Œçš„SQLï¼Œè¿™å…¶ä¸­æ—¢æœ‰é€»è¾‘è¡¨åçš„æ›¿æ¢ï¼Œä¹Ÿæœ‰å¤šè·¯ç”±çš„SQLæ‹†åˆ†ï¼Œè¿˜æœ‰ä¸ºäº†åç»­å½’å¹¶æ“ä½œè€Œè¿›è¡Œçš„åˆ†é¡µã€åˆ†ç»„ã€æ’åºç­‰æ”¹å†™ï¼Œselectè¯­å¥ä¸ä¼šå¯¹å‚æ•°è¿›è¡Œé‡ç»„ï¼Œè€Œinsertè¯­å¥ä¸ºäº†é¿å…æ’å…¥å¤šä½™æ•°æ®ï¼Œä¼šé€šè¿‡è·¯ç”±å•å…ƒå¯¹å‚æ•°è¿›è¡Œé‡ç»„ã€‚</p>
<h2 id="æ‰§è¡Œå¼•æ“">æ‰§è¡Œå¼•æ“<a hidden class="anchor" aria-hidden="true" href="#æ‰§è¡Œå¼•æ“">#</a></h2>
<h3 id="è§£æ-2">è§£æ<a hidden class="anchor" aria-hidden="true" href="#è§£æ-2">#</a></h3>
<p>æ”¹å†™å®Œæˆåçš„SQLå°±å¯ä»¥æ‰§è¡Œäº†ï¼Œæ‰§è¡Œå¼•æ“éœ€è¦å¹³è¡¡å¥½èµ„æºå’Œæ•ˆç‡ï¼Œå¦‚æœä¸ºæ¯æ¡çœŸå®SQLéƒ½åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿æ¥æ˜¾ç„¶ä¼šé€ æˆèµ„æºçš„æ»¥ç”¨ï¼Œä½†å¦‚æœå•çº¿ç¨‹ä¸²è¡Œä¹Ÿå¿…ç„¶ä¼šå½±å“æ‰§è¡Œæ•ˆç‡ã€‚</p>
<p>æ‰§è¡Œå¼•æ“ä¼šå…ˆå°†æ‰§è¡Œå•å…ƒä¸­éœ€è¦æ‰§è¡Œçš„SQLUnitæ ¹æ®æ•°æ®æºåˆ†ç»„ï¼ŒåŒä¸€ä¸ªæ•°æ®æºä¸‹çš„SQLUnitä¼šæ”¾å…¥ä¸€ä¸ªlistï¼Œç„¶åä¼šæ ¹æ®</p>
<p>maxConnectionsSizePerQueryå¯¹åŒä¸€ä¸ªæ•°æ®æºçš„SQLUnitç»§ç»­åˆ†ç»„ï¼Œåˆ›å»ºè¿æ¥å¹¶ç»‘å®šSQLUnit ã€‚</p>
<blockquote>
<p>æ‰§è¡Œç»„åˆ›å»º</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sharding.execute.sql.prepare.SQLExecutePrepareTemplate#getSynchronizedExecuteUnitGroups
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> Collection&lt;InputGroup&lt;StatementExecuteUnit&gt;&gt; getSynchronizedExecuteUnitGroups(
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Collection&lt;ExecutionUnit&gt; executionUnits, <span style="color:#fff;font-weight:bold">final</span> SQLExecutePrepareCallback callback) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ ¹æ®æ•°æ®æºå°†SQLUnitåˆ†ç»„ key=dataSourceName
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Map&lt;String, List&lt;SQLUnit&gt;&gt; sqlUnitGroups = getSQLUnitGroups(executionUnits);
</span></span><span style="display:flex;"><span>    Collection&lt;InputGroup&lt;StatementExecuteUnit&gt;&gt; result = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ›å»ºsqlæ‰§è¡Œç»„
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (Entry&lt;String, List&lt;SQLUnit&gt;&gt; entry : sqlUnitGroups.<span style="color:#007f7f">entrySet</span>()) {
</span></span><span style="display:flex;"><span>        result.<span style="color:#007f7f">addAll</span>(getSQLExecuteGroups(entry.<span style="color:#007f7f">getKey</span>(), entry.<span style="color:#007f7f">getValue</span>(), callback));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sharding.execute.sql.prepare.SQLExecutePrepareTemplate#getSQLExecuteGroups
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> List&lt;InputGroup&lt;StatementExecuteUnit&gt;&gt; getSQLExecuteGroups(<span style="color:#fff;font-weight:bold">final</span> String dataSourceName,
</span></span><span style="display:flex;"><span>                                                                   <span style="color:#fff;font-weight:bold">final</span> List&lt;SQLUnit&gt; sqlUnits, <span style="color:#fff;font-weight:bold">final</span> SQLExecutePrepareCallback callback) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    List&lt;InputGroup&lt;StatementExecuteUnit&gt;&gt; result = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ¯ä¸ªè¿æ¥éœ€è¦æ‰§è¡Œçš„æœ€å¤§sqlæ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">int</span> desiredPartitionSize = Math.<span style="color:#007f7f">max</span>(<span style="color:#ff0;font-weight:bold">0</span> == sqlUnits.<span style="color:#007f7f">size</span>() % maxConnectionsSizePerQuery ? sqlUnits.<span style="color:#007f7f">size</span>() / maxConnectionsSizePerQuery : sqlUnits.<span style="color:#007f7f">size</span>() / maxConnectionsSizePerQuery + <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ†ç»„ï¼Œæ¯ç»„å¯¹åº”ä¸€æ¡æ•°æ®åº“è¿æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;List&lt;SQLUnit&gt;&gt; sqlUnitPartitions = Lists.<span style="color:#007f7f">partition</span>(sqlUnits, desiredPartitionSize);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//é€‰æ‹©è¿æ¥æ¨¡å¼ è¿æ¥é™åˆ¶/å†…å­˜é™åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ConnectionMode connectionMode = maxConnectionsSizePerQuery &lt; sqlUnits.<span style="color:#007f7f">size</span>() ? ConnectionMode.<span style="color:#007f7f">CONNECTION_STRICTLY</span> : ConnectionMode.<span style="color:#007f7f">MEMORY_STRICTLY</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ›å»ºè¿æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;Connection&gt; connections = callback.<span style="color:#007f7f">getConnections</span>(connectionMode, dataSourceName, sqlUnitPartitions.<span style="color:#007f7f">size</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> count = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (List&lt;SQLUnit&gt; each : sqlUnitPartitions) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç»‘å®šè¿æ¥å’ŒSQLUnit åˆ›å»ºStatementExecuteUnit
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        result.<span style="color:#007f7f">add</span>(getSQLExecuteGroup(connectionMode, connections.<span style="color:#007f7f">get</span>(count++), dataSourceName, each, callback));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>SQLUnitåˆ†ç»„å’Œè¿æ¥æ¨¡å¼é€‰æ‹©æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œ<strong>è¿æ¥æ¨¡å¼çš„é€‰æ‹©åªå–å†³äºmaxConnectionsSizePerQueryå’ŒSQLUnitæ•°é‡çš„å¤§å°å…³ç³»</strong>ï¼Œ</p>
<p>maxConnectionsSizePerQueryä»£è¡¨äº†ä¸€ä¸ªæ•°æ®æºä¸€æ¬¡æŸ¥è¯¢å…è®¸çš„æœ€å¤§è¿æ¥æ•°ã€‚</p>
<ul>
<li>å½“maxConnectionsSizePerQuery&lt;sqlunitæ•°é‡æ—¶ï¼Œæ„å‘³ç€æ— æ³•åšåˆ°æ¯ä¸ªsqlunitç‹¬äº«ä¸€ä¸ªè¿æ¥ï¼Œéœ€è¦ç›´æ¥æŸ¥è¯¢å‡ºç»“æœé›†è‡³å†…å­˜ä¸­ï¼›&lt; li=&quot;&quot;&gt;</li>
<li>å½“maxConnectionsSizePerQuery&gt;=SQLUnitæ•°é‡æ—¶ï¼Œæ„å‘³ç€å¯ä»¥æ”¯æŒæ¯ä¸ªSQLUnitç‹¬äº«ä¸€ä¸ªè¿æ¥ï¼Œå¯ä»¥é€šè¿‡ResultSetæ¸¸æ ‡ä¸‹ç§»çš„æ–¹å¼æŸ¥è¯¢ç»“æœé›†ã€‚</li>
</ul>
<p>ä¸è¿‡maxConnectionsSizePerQueryé»˜è®¤å€¼ä¸º1ï¼Œæ‰€ä»¥å½“ä¸€æ¡SQLéœ€è¦è·¯ç”±è‡³å¤šå¼ è¡¨æ—¶ï¼ˆå³æœ‰å¤šä¸ªSQLUnitï¼‰ä¼šé‡‡ç”¨è¿æ¥é™åˆ¶ï¼Œå½“è·¯ç”±è‡³å•è¡¨æ—¶æ˜¯å†…å­˜é™åˆ¶æ¨¡å¼ã€‚</p>
<table>
<thead>
<tr>
<th>è¿æ¥æ¨¡å¼</th>
<th>ç‰¹ç‚¹</th>
<th>ä½¿ç”¨æ¡ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td>è¿æ¥é™åˆ¶CONNECTION STRICTLY</td>
<td>ä¸€æ¬¡æ€§è¯»å–ResultSetæ•°æ®åˆ°å†…å­˜ï¼Œå†…å­˜åˆå¹¶</td>
<td>maxConnectionsSizePerQuery&lt;SQLUnitæ•°é‡</td>
</tr>
<tr>
<td>å†…å­˜é™åˆ¶MEMORY STRICTLY</td>
<td>é€šè¿‡ResultSetiæ¸¸æ ‡ä¸‹ç§»è¿›è¡Œç»“æœæŸ¥è¯¢ï¼Œæµå¼åˆå¹¶</td>
<td>maxConnectionsSizePerQuery&gt;=SQLUnitæ•°é‡</td>
</tr>
</tbody>
</table>
<p>ä¸ºäº†é¿å…äº§ç”Ÿæ•°æ®åº“è¿æ¥æ­»é”é—®é¢˜ï¼Œ<strong>åœ¨å†…å­˜é™åˆ¶æ¨¡å¼æ—¶ï¼ŒSharding-JDBCé€šè¿‡é”ä½æ•°æ®æºå¯¹è±¡ä¸€æ¬¡æ€§åˆ›å»ºå‡ºæœ¬æ¡SQLéœ€è¦çš„æ‰€æœ‰æ•°æ®åº“è¿æ¥</strong>ã€‚è¿æ¥é™åˆ¶æ¨¡å¼ä¸‹ï¼Œå„è¿æ¥ä¸€æ¬¡æ€§æŸ¥å‡ºå„è‡ªçš„ç»“æœï¼Œä¸ä¼šå‡ºç°å¤šè¿æ¥ç›¸äº’ç­‰å¾…çš„æƒ…å†µï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿæ­»é”ï¼Œè€Œå†…å­˜é™åˆ¶æ¨¡å¼é€šè¿‡æ¸¸æ ‡è¯»å–ç»“æœé›†ï¼Œéœ€è¦å¤šæ¡è¿æ¥å»æŸ¥è¯¢ä¸åŒçš„è¡¨åšåˆå¹¶ï¼Œå¦‚æœä¸ä¸€æ¬¡æ€§æ‹¿åˆ°æ‰€æœ‰éœ€è¦çš„è¿æ¥ï¼Œåˆ™å¯èƒ½å­˜åœ¨è¿æ¥ç›¸äº’ç­‰å¾…çš„æƒ…å†µé€ æˆæ­»é”ã€‚å¯ä»¥å‚ç…§<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/execute/">å®˜æ–¹æ–‡æ¡£ä¸­æ‰§è¡Œå¼•æ“ç›¸å…³ä¾‹å­</a>ã€‚</p>
<blockquote>
<p>ä¸åŒè¿æ¥æ¨¡å¼åˆ›å»ºè¿æ¥</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> List&lt;Connection&gt; createConnections(<span style="color:#fff;font-weight:bold">final</span> String dataSourceName, <span style="color:#fff;font-weight:bold">final</span> ConnectionMode connectionMode, <span style="color:#fff;font-weight:bold">final</span> DataSource dataSource, <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> connectionSize) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#ff0;font-weight:bold">1</span> == connectionSize) {
</span></span><span style="display:flex;"><span>        Connection connection = createConnection(dataSourceName, dataSource);
</span></span><span style="display:flex;"><span>        replayMethodsInvocation(connection);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> Collections.<span style="color:#007f7f">singletonList</span>(connection);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (ConnectionMode.<span style="color:#007f7f">CONNECTION_STRICTLY</span> == connectionMode) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> createConnections(dataSourceName, dataSource, connectionSize);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å†…å­˜é™åˆ¶æ¨¡å¼åŠ é” ä¸€æ¬¡æ€§è·å–æ‰€æœ‰çš„è¿æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">synchronized</span> (dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> createConnections(dataSourceName, dataSource, connectionSize);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤–ï¼Œç»“æœé›†çš„å†…å­˜åˆå¹¶å’Œæµå¼åˆå¹¶åªåœ¨è°ƒç”¨JDBCçš„executeQueryçš„æƒ…å†µä¸‹ç”Ÿæ•ˆï¼Œ<strong>å¦‚æœä½¿ç”¨executeæ–¹å¼è¿›è¡ŒæŸ¥è¯¢ï¼Œéƒ½æ˜¯ç»Ÿä¸€ä½¿ç”¨æµå¼æ–¹å¼çš„æŸ¥è¯¢ã€‚</strong></p>
<blockquote>
<p>æŸ¥è¯¢ç»“æœå½’å¹¶å¯¹æ¯”</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.executor.PreparedStatementExecutor#executeQuery#101 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.shardingjdbc.executor.PreparedStatementExecutor#getQueryResult
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> QueryResult getQueryResult(<span style="color:#fff;font-weight:bold">final</span> Statement statement, <span style="color:#fff;font-weight:bold">final</span> ConnectionMode connectionMode) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    PreparedStatement preparedStatement = (PreparedStatement) statement;
</span></span><span style="display:flex;"><span>    ResultSet resultSet = preparedStatement.<span style="color:#007f7f">executeQuery</span>();
</span></span><span style="display:flex;"><span>    getResultSets().<span style="color:#007f7f">add</span>(resultSet);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//executeQuery ä¸­æ ¹æ®è¿æ¥æ¨¡å¼é€‰æ‹©æµå¼/å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> ConnectionMode.<span style="color:#007f7f">MEMORY_STRICTLY</span> == connectionMode ? <span style="color:#fff;font-weight:bold">new</span> StreamQueryResult(resultSet) : <span style="color:#fff;font-weight:bold">new</span> MemoryQueryResult(resultSet);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//execute å•ç‹¬è°ƒç”¨getResultSetä¸­åªä¼šä½¿ç”¨æµå¼åˆå¹¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#getResultSet#158
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#getQueryResults 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> List&lt;QueryResult&gt; getQueryResults(<span style="color:#fff;font-weight:bold">final</span> List&lt;ResultSet&gt; resultSets) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    List&lt;QueryResult&gt; result = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;(resultSets.<span style="color:#007f7f">size</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (ResultSet each : resultSets) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != each) {
</span></span><span style="display:flex;"><span>            result.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> StreamQueryResult(each));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¤šæ¡è¿æ¥çš„æ‰§è¡Œæ–¹å¼åˆ†ä¸ºä¸²è¡Œå’Œå¹¶è¡Œï¼Œåœ¨æœ¬åœ°äº‹åŠ¡å’ŒXAäº‹åŠ¡ä¸­æ˜¯ä¸²è¡Œçš„æ–¹å¼ï¼Œå…¶ä½™æƒ…å†µæ˜¯å¹¶è¡Œï¼Œå…·ä½“çš„æ‰§è¡Œé€»è¾‘è¿™é‡Œå°±ä¸å†å±•å¼€äº†ã€‚</p>
<blockquote>
<p>isHoldTransaction</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> isHoldTransaction() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> (TransactionType.<span style="color:#007f7f">LOCAL</span> == transactionType &amp;&amp; !getAutoCommit()) || (TransactionType.<span style="color:#007f7f">XA</span> == transactionType &amp;&amp; isInShardingTransaction());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ€»ç»“-1">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“-1">#</a></h3>
<p>æ‰§è¡Œå¼•æ“é€šè¿‡maxConnectionsSizePerQueryå’ŒåŒæ•°æ®æºçš„SQLUnitçš„æ•°é‡å¤§å°ç¡®å®šè¿æ¥æ¨¡å¼ï¼ŒmaxConnectionsSizePerQuery</p>
<p>=SQLUnitæ•°é‡ä½¿ç”¨å†…å­˜é™åˆ¶æ¨¡å¼ï¼Œå½“ä½¿ç”¨å†…å­˜é™åˆ¶æ¨¡å¼æ—¶ä¼šé€šè¿‡å¯¹æ•°æ®æºå¯¹è±¡åŠ é”æ¥ä¿è¯ä¸€æ¬¡æ€§è·å–æœ¬æ¡SQLéœ€è¦çš„è¿æ¥è€Œé¿å…æ­»é”ã€‚åœ¨ä½¿ç”¨executeQueryæŸ¥è¯¢æ—¶ï¼Œå¤„ç†ç»“æœé›†æ—¶ä¼šæ ¹æ®è¿æ¥æ¨¡å¼é€‰æ‹©æµå¼æˆ–è€…å†…å­˜åˆå¹¶ï¼Œä½†ä½¿ç”¨executeæ–¹æ³•æŸ¥è¯¢ï¼Œå¤„ç†ç»“æœé›†åªä¼šä½¿ç”¨æµå¼åˆå¹¶ã€‚</p>
<h2 id="å½’å¹¶å¼•æ“">å½’å¹¶å¼•æ“<a hidden class="anchor" aria-hidden="true" href="#å½’å¹¶å¼•æ“">#</a></h2>
<h3 id="è§£æ-3">è§£æ<a hidden class="anchor" aria-hidden="true" href="#è§£æ-3">#</a></h3>
<p>æŸ¥è¯¢å‡ºçš„ç»“æœé›†éœ€è¦ç»è¿‡å½’å¹¶å¼•æ“å½’å¹¶åæ‰æ˜¯æœ€ç»ˆçš„ç»“æœï¼Œå½’å¹¶çš„æ ¸å¿ƒå…¥å£åœ¨MergeEntryçš„processæ–¹æ³•ä¸­ï¼Œä¼˜å…ˆå¤„ç†åˆ†ç‰‡åœºæ™¯çš„åˆå¹¶ï¼Œå†è¿›è¡Œè„±æ•ï¼Œåªæœ‰è¯»å†™åˆ†ç¦»çš„æƒ…å†µä¸‹åˆ™ç›´æ¥è¿”å›TransparentMergedResultï¼ŒTransparentMergedResultå®é™…ä¸Šæ²¡åšåˆå¹¶çš„é¢å¤–å¤„ç†ï¼Œå…¶å†…éƒ¨å®ç°éƒ½æ˜¯å®Œå…¨è°ƒç”¨queryResultçš„å®ç°ã€‚</p>
<p><img loading="lazy" src="5.png" alt=""  />
</p>
<blockquote>
<p>å½’å¹¶é€»è¾‘å…¥å£</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#mergeQuery#190
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.merge.MergeEngine#merge#61
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.underlying.merge.MergeEntry#process
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> MergedResult process(<span style="color:#fff;font-weight:bold">final</span> List&lt;QueryResult&gt; queryResults, <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ†ç‰‡åˆå¹¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Optional&lt;MergedResult&gt; mergedResult = merge(queryResults, sqlStatementContext);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//è„±æ•å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Optional&lt;MergedResult&gt; result = mergedResult.<span style="color:#007f7f">isPresent</span>() ? Optional.<span style="color:#007f7f">of</span>(decorate(mergedResult.<span style="color:#007f7f">get</span>(), sqlStatementContext)) : decorate(queryResults.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>), sqlStatementContext);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åªæœ‰è¯»å†™åˆ†ç¦»çš„æƒ…å†µä¸‹ï¼ŒorElseGetä¼šä¸å­˜åœ¨ï¼ŒTransparentMergedResult
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> result.<span style="color:#007f7f">orElseGet</span>(() -&gt; <span style="color:#fff;font-weight:bold">new</span> TransparentMergedResult(queryResults.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>)));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>TransparentMergedResult</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> TransparentMergedResult <span style="color:#fff;font-weight:bold">implements</span> MergedResult {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> QueryResult queryResult;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> next() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> queryResult.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object getValue(<span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> columnIndex, <span style="color:#fff;font-weight:bold">final</span> Class&lt;?&gt; type) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> queryResult.<span style="color:#007f7f">getValue</span>(columnIndex, type);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object getCalendarValue(<span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> columnIndex, <span style="color:#fff;font-weight:bold">final</span> Class&lt;?&gt; type, <span style="color:#fff;font-weight:bold">final</span> Calendar calendar) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> queryResult.<span style="color:#007f7f">getCalendarValue</span>(columnIndex, type, calendar);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> InputStream getInputStream(<span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> columnIndex, <span style="color:#fff;font-weight:bold">final</span> String type) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> queryResult.<span style="color:#007f7f">getInputStream</span>(columnIndex, type);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> wasNull() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> queryResult.<span style="color:#007f7f">wasNull</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬åªçœ‹åˆ†ç‰‡ç›¸å…³çš„æ“ä½œï¼ŒResultMergerEngineåªæœ‰ä¸€ä¸ªå®ç°ç±»ShardingResultMergerEngineï¼Œæ‰€ä»¥åªæœ‰å­˜åœ¨åˆ†ç‰‡æƒ…å†µçš„æ—¶å€™ï¼Œä¸Šæ–‡çš„ç¬¬ä¸€ä¸ªmergeæ‰ä¼šæœ‰ç»“æœã€‚æ ¹æ®SQLç±»å‹çš„ä¸åŒé€‰æ‹©ResultMergerå®ç°ï¼ŒæŸ¥è¯¢ç±»çš„åˆå¹¶æ˜¯æœ€å¸¸ç”¨ä¹Ÿæ˜¯æœ€å¤æ‚çš„åˆå¹¶ã€‚</p>
<blockquote>
<p>MergeEntry.merge</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.merge.MergeEntry#merge
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> Optional&lt;MergedResult&gt; merge(<span style="color:#fff;font-weight:bold">final</span> List&lt;QueryResult&gt; queryResults, <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (Entry&lt;BaseRule, ResultProcessEngine&gt; entry : engines.<span style="color:#007f7f">entrySet</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (entry.<span style="color:#007f7f">getValue</span>() <span style="color:#fff;font-weight:bold">instanceof</span> ResultMergerEngine) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//é€‰æ‹©ä¸åŒç±»å‹çš„ resultMerger
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ResultMerger resultMerger = ((ResultMergerEngine) entry.<span style="color:#007f7f">getValue</span>()).<span style="color:#007f7f">newInstance</span>(databaseType, entry.<span style="color:#007f7f">getKey</span>(), properties, sqlStatementContext);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å½’å¹¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> Optional.<span style="color:#007f7f">of</span>(resultMerger.<span style="color:#007f7f">merge</span>(queryResults, sqlStatementContext, schemaMetaData));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> Optional.<span style="color:#007f7f">empty</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.merge.ShardingResultMergerEngine#newInstance
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ResultMerger newInstance(<span style="color:#fff;font-weight:bold">final</span> DatabaseType databaseType, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties, <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (sqlStatementContext <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatementContext) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ShardingDQLResultMerger(databaseType);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (sqlStatementContext.<span style="color:#007f7f">getSqlStatement</span>() <span style="color:#fff;font-weight:bold">instanceof</span> DALStatement) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ShardingDALResultMerger(shardingRule);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> TransparentResultMerger();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ShardingDQLResultMergerçš„mergeæ–¹æ³•å°±æ˜¯æ ¹æ®SQLè§£æç»“æœä¸­åŒ…å«çš„tokené€‰æ‹©åˆé€‚çš„å½’å¹¶æ–¹å¼ï¼ˆåˆ†ç»„èšåˆã€æ’åºã€éå†ï¼‰ï¼Œå½’å¹¶åçš„mergedResultç»Ÿä¸€ç»è¿‡decorateæ–¹æ³•è¿›è¡Œåˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†é¡µå½’å¹¶ï¼Œæ•´ä½“å¤„ç†æµç¨‹å›¾å¯ä»¥æ¦‚æ‹¬å¦‚ä¸‹ã€‚</p>
<blockquote>
<p>å½’å¹¶æ–¹å¼é€‰æ‹©</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.merge.dql.ShardingDQLResultMerger#merge
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> MergedResult merge(<span style="color:#fff;font-weight:bold">final</span> List&lt;QueryResult&gt; queryResults, <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext, <span style="color:#fff;font-weight:bold">final</span> SchemaMetaData schemaMetaData) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#ff0;font-weight:bold">1</span> == queryResults.<span style="color:#007f7f">size</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> IteratorStreamMergedResult(queryResults);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Map&lt;String, Integer&gt; columnLabelIndexMap = getColumnLabelIndexMap(queryResults.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>));
</span></span><span style="display:flex;"><span>    SelectStatementContext selectStatementContext = (SelectStatementContext) sqlStatementContext;
</span></span><span style="display:flex;"><span>    selectStatementContext.<span style="color:#007f7f">setIndexes</span>(columnLabelIndexMap);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ†ç»„èšåˆï¼Œæ’åºï¼Œéå†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    MergedResult mergedResult = build(queryResults, selectStatementContext, columnLabelIndexMap, schemaMetaData);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ†é¡µå½’å¹¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> decorate(queryResults, selectStatementContext, mergedResult);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.merge.dql.ShardingDQLResultMerger#build
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> MergedResult build(<span style="color:#fff;font-weight:bold">final</span> List&lt;QueryResult&gt; queryResults, <span style="color:#fff;font-weight:bold">final</span> SelectStatementContext selectStatementContext,
</span></span><span style="display:flex;"><span>                           <span style="color:#fff;font-weight:bold">final</span> Map&lt;String, Integer&gt; columnLabelIndexMap, <span style="color:#fff;font-weight:bold">final</span> SchemaMetaData schemaMetaData) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (isNeedProcessGroupBy(selectStatementContext)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ†ç»„èšåˆå½’å¹¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> getGroupByMergedResult(queryResults, selectStatementContext, columnLabelIndexMap, schemaMetaData);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (isNeedProcessDistinctRow(selectStatementContext)) {
</span></span><span style="display:flex;"><span>        setGroupByForDistinctRow(selectStatementContext);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åˆ†ç»„èšåˆå½’å¹¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> getGroupByMergedResult(queryResults, selectStatementContext, columnLabelIndexMap, schemaMetaData);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (isNeedProcessOrderBy(selectStatementContext)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ’åºå½’å¹¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> OrderByStreamMergedResult(queryResults, selectStatementContext, schemaMetaData);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//éå†å½’å¹¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> IteratorStreamMergedResult(queryResults);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.merge.dql.ShardingDQLResultMerger#decorate
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> MergedResult decorate(<span style="color:#fff;font-weight:bold">final</span> List&lt;QueryResult&gt; queryResults, <span style="color:#fff;font-weight:bold">final</span> SelectStatementContext selectStatementContext, <span style="color:#fff;font-weight:bold">final</span> MergedResult mergedResult) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    PaginationContext paginationContext = selectStatementContext.<span style="color:#007f7f">getPaginationContext</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!paginationContext.<span style="color:#007f7f">isHasPagination</span>() || <span style="color:#ff0;font-weight:bold">1</span> == queryResults.<span style="color:#007f7f">size</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mergedResult;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    String trunkDatabaseName = DatabaseTypes.<span style="color:#007f7f">getTrunkDatabaseType</span>(databaseType.<span style="color:#007f7f">getName</span>()).<span style="color:#007f7f">getName</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ ¹æ®æ•°æ®åº“ç±»å‹åˆ†é¡µå½’å¹¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#0ff;font-weight:bold">&#34;MySQL&#34;</span>.<span style="color:#007f7f">equals</span>(trunkDatabaseName) || <span style="color:#0ff;font-weight:bold">&#34;PostgreSQL&#34;</span>.<span style="color:#007f7f">equals</span>(trunkDatabaseName)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> LimitDecoratorMergedResult(mergedResult, paginationContext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#0ff;font-weight:bold">&#34;Oracle&#34;</span>.<span style="color:#007f7f">equals</span>(trunkDatabaseName)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RowNumberDecoratorMergedResult(mergedResult, paginationContext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#0ff;font-weight:bold">&#34;SQLServer&#34;</span>.<span style="color:#007f7f">equals</span>(trunkDatabaseName)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> TopAndRowNumberDecoratorMergedResult(mergedResult, paginationContext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> mergedResult;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯ç§å½’å¹¶æ–¹å¼çš„ä½œç”¨åœ¨<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/merge/">å®˜æ–¹æ–‡æ¡£æœ‰æ¯”è¾ƒè¯¦ç»†çš„æ¡ˆä¾‹</a>ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤ä»‹ç»äº†ã€‚</p>
<h3 id="æ€»ç»“-2">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“-2">#</a></h3>
<p>å½’å¹¶å¼•æ“æ˜¯Sharding-JDBCæ‰§è¡ŒSQLçš„æœ€åä¸€æ­¥ï¼Œå…¶ä½œç”¨æ˜¯å°†å¤šä¸ªæ•°èŠ‚ç‚¹çš„ç»“æœé›†ç»„åˆä¸ºä¸€ä¸ªæ­£ç¡®çš„ç»“æœé›†è¿”å›ï¼ŒæŸ¥è¯¢ç±»çš„å½’å¹¶æœ‰<strong>åˆ†ç»„å½’å¹¶ã€èšåˆå½’å¹¶ã€æ’åºå½’å¹¶ã€éå†å½’å¹¶ã€åˆ†é¡µå½’å¹¶</strong>äº”ç§ï¼Œè¿™äº”ç§å½’å¹¶æ–¹å¼å¹¶ä¸æ˜¯äº’æ–¥çš„ï¼Œè€Œæ˜¯ç›¸äº’ç»„åˆçš„ã€‚</p>
<h1 id="å®šåˆ¶ç ”å‘">å®šåˆ¶ç ”å‘<a hidden class="anchor" aria-hidden="true" href="#å®šåˆ¶ç ”å‘">#</a></h1>
<p>åœ¨ä½¿ç”¨Sharding-JDBCè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€äº›é—®é¢˜å¯ä»¥æ”¹è¿›ï¼Œæ¯”å¦‚å­˜é‡ç³»ç»Ÿæ•°æ®é‡åˆ°è¾¾ä¸€å®šè§„æ¨¡è€Œéœ€è¦åˆ†åº“åˆ†è¡¨å¼•å…¥Sharding-JDBCæ—¶ï¼Œå°±ä¼š<strong>å­˜åœ¨ä¸¤å¤§é—®é¢˜</strong>ã€‚</p>
<p><strong>ä¸€ä¸ªæ˜¯å­˜é‡æ•°æ®çš„è¿ç§»</strong>ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†ç‰‡ç®—æ³•å…¼å®¹ï¼Œå‰æ–‡å·²ç»æè¿‡åˆ†ç‰‡é”®çš„å€¼æ˜¯ä¸å…è®¸æ›´æ”¹çš„ï¼Œè€Œä¸”SQLå¦‚æœä¸åŒ…å«åˆ†ç‰‡é”®ï¼Œå¦‚æœè¿™ä¸ªåˆ†ç‰‡é”®å¯¹åº”çš„å€¼æ˜¯é€’å¢çš„ï¼ˆå¦‚idï¼Œæ—¶é—´ç­‰ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªé˜ˆå€¼ï¼Œåœ¨åˆ†ç‰‡ç®—æ³•çš„doShardingä¸­åˆ¤æ–­åˆ†ç‰‡å€¼ä¸é˜ˆå€¼çš„å¤§å°å†³å®šå°†æ•°æ®è·¯ç”±è‡³æ—§è¡¨æˆ–æ–°è¡¨ï¼Œé¿å…æ•°æ®è¿ç§»çš„éº»çƒ¦ã€‚å¦‚æœæ˜¯æ ¹æ®ç”¨æˆ·idå–æ¨¡åˆ†è¡¨ï¼Œè€Œæ–°å¢çš„æ•°æ®æ— æ³•åªé€šè¿‡ç”¨æˆ·idåˆ¤æ–­ï¼Œè¿™æ—¶å¯ä»¥è€ƒè™‘é‡‡ç”¨å¤åˆåˆ†ç‰‡ç®—æ³•ï¼Œå°†ç”¨æˆ·idä¸è®¢å•idæˆ–è€…æ—¶é—´ç­‰é€’å¢çš„å­—æ®µåŒæ—¶è®¾ç½®ä¸ºåˆ†ç‰‡é”®ï¼Œæ ¹æ®è®¢å•idæˆ–æ—¶é—´åˆ¤æ–­æ˜¯å¦æ˜¯æ–°æ•°æ®ï¼Œå†æ ¹æ®ç”¨æˆ·idå–æ¨¡å¾—åˆ°è·¯ç”±ç»“æœå³å¯ã€‚</p>
<p>å¦ä¸€ä¸ªæ˜¯<strong>Sharding-JDBC</strong>è¯­æ³•é™åˆ¶ä¼šä½¿å¾—å­˜é‡SQLé¢å¯¹å·¨å¤§çš„æ”¹é€ å‹åŠ›ï¼Œè€Œå®é™…ä¸Šä¸šåŠ¡æ›´å…³å¿ƒçš„æ˜¯éœ€è¦åˆ†ç‰‡çš„è¡¨ï¼Œéåˆ†ç‰‡çš„è¡¨ä¸åº”è¯¥å‘ç”Ÿæ”¹åŠ¨å’Œå½±å“ã€‚å®é™…ä¸Šï¼Œéåˆ†ç‰‡è¡¨ç†è®ºä¸Šæ— éœ€é€šè¿‡è§£æã€è·¯ç”±ã€é‡å†™ã€åˆå¹¶ï¼Œä¸ºæ­¤æˆ‘ä»¬åœ¨æºç å±‚é¢å¯¹è¿™æ®µé€»è¾‘è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ”¯æŒè·³è¿‡éƒ¨åˆ†è§£æï¼Œå®Œå…¨è·³è¿‡åˆ†ç‰‡è·¯ç”±ã€é‡å†™å’Œåˆå¹¶ï¼Œå°½å¯èƒ½å‡å°‘Sharding-JDBCå¯¹éåˆ†ç‰‡è¡¨çš„è¯­æ³•é™åˆ¶ï¼Œæ¥å‡å°‘ä¸šåŠ¡ç³»ç»Ÿçš„æ”¹é€ å‹åŠ›ä¸é£é™©ã€‚</p>
<table>
<thead>
<tr>
<th>å®šåˆ¶å¼€å‘</th>
<th>èƒŒæ™¯é—®é¢˜</th>
<th>ä¸»è¦æ”¹é€ ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ‰¹é‡updateè¯­æ³•æ”¯æŒ</td>
<td><foreach>æ ‡ç­¾çš„åˆ†ç‰‡è¡¨æ‰¹é‡updateiè¯­å¥ï¼Œæ— æ³•æ­£ç¡®è§£æè·¯ç”±ï¼Œé€ æˆSQLæ‰§è¡Œç»“æœä¸å¯¹</td>
<td>1.å¼€å‘prepareBatchæ–¹æ³•æ”¯æŒæ‰¹é‡updateè¯­å¥çš„å¾ªç¯è§£æè·¯ç”±ã€‚2.ExecutionContextå’ŒiInputGroupå…¼å®¹å¤„ç†æ‰¹é‡updateçš„æ‰§è¡Œå•å…ƒã€‚</td>
</tr>
<tr>
<td>shardingConditionå»é‡</td>
<td>oræ¡ä»¶ä¸‹å¯èƒ½ä¼šåˆ›å»ºé‡å¤çš„shardingCondition,é‡å¤è°ƒç”¨doShardingæ–¹æ³•ï¼Œé€ æˆæ€§èƒ½æµªè´¹å’Œæ–¹æ³•å†…æ—¥å¿—é‡å¤è¾“å‡º</td>
<td>1.ListRouteValueå’ŒRangeRouteValueiæ·»åŠ @EqualsAndHashCode<br />2.createShardingConditions:å»é‡</td>
</tr>
<tr>
<td>é…ç½®åŠ¨æ€ç”Ÿæ•ˆ</td>
<td>ä¸šåŠ¡æ— æ³•åŠ¨æ€æ§åˆ¶SQLæ‰“å°ï¼Œå½±å“é—®é¢˜æ’æŸ¥æ•ˆç‡</td>
<td>TypedPropertiesæ”¯æŒé…ç½®åŠ¨æ€åˆ·æ–°</td>
</tr>
<tr>
<td>ç»„ä»¶å°è£…(æœªæ¶‰åŠæºç çš„æ”¹é€ )</td>
<td>ä¸šåŠ¡éœ€è¦é‡å¤å¼€å‘ä¸ç†Ÿæ‚‰åŸç”Ÿé…ç½®</td>
<td>1.æä¾›äº†é»˜è®¤çš„æ•°æ®æºä¸è¿æ¥æ± é…ç½® 2.ç®€åŒ–åˆ†åº“åˆ†è¡¨é…ç½® 3.å°è£…å¸¸ç”¨çš„åˆ†ç‰‡ç®—æ³•ï¼ˆæ—¶é—´ã€ä¸šåŠ¡å­—æ®µå€¼ç­‰ï¼‰ 4.ç»Ÿä¸€çš„é…ç½®ç›‘å¬ä¸åŠ¨æ€ä¿®æ”¹(SQLæ‰“å°ã€å¼ºåˆ¶ä¸»ä»åˆ‡æ¢ç­‰)</td>
</tr>
<tr>
<td>å¼ºåˆ¶è·¯ç”±ä¸»åº“</td>
<td>åœ¨ä»åº“å»¶è¿Ÿè¿‡é«˜æˆ–æ•…éšœæ—¶ï¼Œæ— æ³•åŠ¨æ€å°†SQLåˆ‡æ¢è‡³ä¸»åº“æ‰§è¡Œï¼Œå½±å“ä¸šåŠ¡æ­£å¸¸è¿è¡Œ</td>
<td>MasterSlaveRouteDecoratoræ”¯æŒæ ¹æ®é…ç½®å¼ºåˆ¶è·¯ç”±ä¸»åº“</td>
</tr>
<tr>
<td>å…¨è·¯ç”±æ ¡éªŒ</td>
<td>æœªå¸¦åˆ†ç‰‡é”®çš„SQLå¯¼è‡´å…¨è·¯ç”±å´ä¸ä¼šæŠ¥é”™ï¼Œå¼€å‘æµ‹è¯•ä¸æ˜“å‘ç°ï¼Œéš¾ä»¥ä¿è¯SQLæ”¹é€ å½»åº•</td>
<td>ShardingConditionsåˆ¤ç©º</td>
</tr>
<tr>
<td>è·³è¿‡shardingè¯­æ³•é™åˆ¶</td>
<td>éåˆ†ç‰‡è¡¨åŒæ ·å—shardingè¯­æ³•é™åˆ¶ï¼Œä¸šåŠ¡æ”¹é€ æˆæœ¬å’Œé£é™©é«˜</td>
<td>1.SQLè¡¨ååˆ¤æ–­ 2.è·³è¿‡è§£æã€è·¯ç”±ã€æ”¹å†™ã€å½’å¹¶ 3.æ‰‹åŠ¨åˆ›å»ºæ‰§è¡Œå•å…ƒ</td>
</tr>
</tbody>
</table>
<h2 id="è·³è¿‡shardingè¯­æ³•é™åˆ¶">è·³è¿‡Shardingè¯­æ³•é™åˆ¶<a hidden class="anchor" aria-hidden="true" href="#è·³è¿‡shardingè¯­æ³•é™åˆ¶">#</a></h2>
<p>Sharding-JDBCæ‰§è¡Œè§£æè·¯ç”±é‡å†™çš„é€»è¾‘éƒ½æ˜¯åœ¨BasePrepareEngineä¸­ï¼Œæœ€ç»ˆæ„é€ ExecutionContextäº¤ç”±æ‰§è¡Œå¼•æ“æ‰§è¡Œï¼ŒExecutionContextä¸­åŒ…å«sqlStatementContextå’ŒexecutionUnitsï¼Œéåˆ†ç‰‡è¡¨ä¸æ¶‰åŠè·¯ç”±æ”¹å†™ï¼Œæ‰€ä»¥å…¶ExecutionUnitæˆ‘ä»¬éå¸¸å®¹æ˜“æ‰‹åŠ¨æ„é€ ï¼Œè€ŒæŸ¥çœ‹SQLStatementContextçš„ä½¿ç”¨æƒ…å†µï¼Œæˆ‘ä»¬å‘ç°SQLStatementContextåªä¼šå½±å“ç»“æœé›†çš„åˆå¹¶è€Œä¸ä¼šå½±å“å®é™…çš„æ‰§è¡Œï¼Œè€Œä¸åˆ†ç‰‡è¡¨ä¹Ÿæ— éœ€è¿›è¡Œç»“æœé›†çš„åˆå¹¶ï¼Œæ•´ä½“å®ç°æ€è·¯å¦‚å›¾ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sqlä¸­ä¸å«åˆ†ç‰‡è¡¨---&gt;è·³è¿‡è§£æè·¯ç”±---&gt;è·³è¿‡æ”¹å†™ï¼Œæ‰‹åŠ¨æ„é€ ExecutionUnit---&gt;æ‰§è¡Œ---&gt;è·³è¿‡ç»“æœåˆå¹¶
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ExecutionContextç›¸å…³å¯¹è±¡</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ExecutionContext {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;ExecutionUnit&gt; executionUnits = <span style="color:#fff;font-weight:bold">new</span> LinkedHashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ExecutionUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String dataSourceName;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SQLUnit sqlUnit;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SQLUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String sql;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ï¼ˆ1ï¼‰æ ¡éªŒSQLä¸­æ˜¯å¦åŒ…å«åˆ†ç‰‡è¡¨ï¼š**æˆ‘ä»¬æ˜¯é€šè¿‡æ­£åˆ™å°†SQLä¸­çš„å„ä¸ªå•è¯åˆ†éš”æˆSetï¼Œç„¶åå†éå†BaseRuleåˆ¤æ–­æ˜¯å¦å­˜åœ¨åˆ†ç‰‡è¡¨ã€‚å¤§å®¶å¯èƒ½ä¼šå¥‡æ€ªæ˜æ˜è§£æå¼•æ“å¯ä»¥å¸®æˆ‘ä»¬è§£æå‡ºSQLä¸­çš„è¡¨åï¼Œä¸ºä»€ä¹ˆè¿˜è¦è‡ªå·±æ¥è§£æã€‚å› ä¸ºæˆ‘ä»¬æµ‹è¯•çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œ<strong>å­˜é‡ä¸šåŠ¡ä¸Šçš„SQLå¾ˆå¤šåœ¨è§£æé˜¶æ®µå°±ä¼šæŠ¥é”™ï¼Œåªèƒ½æå‰åˆ¤æ–­</strong>ï¼Œå½“ç„¶è¿™ç§åˆ¤æ–­æ–¹å¼å¹¶ä¸ä¸¥è°¨ï¼Œæ¯”å¦‚ SELECT order_id FROM t_order_record WHERE order_id=1 AND remarks=&rsquo; t_order xxx&rsquo;;ï¼Œé…ç½®çš„åˆ†ç‰‡è¡¨t_orderæ—¶å°±ä¼šå­˜åœ¨è¯¯åˆ¤ï¼Œä½†è¿™ç§åœºæ™¯åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ä¸­æ²¡æœ‰ï¼Œæ‰€ä»¥æš‚æ—¶å¹¶æ²¡æœ‰å¤„ç†ã€‚ç”±äºè¿™ä¸ªä¿¡æ¯éœ€è¦åœ¨å¤šä¸ªå¯¹è±¡æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œä¸ºäº†é¿å…ä¿®æ”¹å¤§é‡çš„å¯¹è±¡å˜é‡å’Œæ–¹æ³•å…¥å‚ï¼Œè€Œåˆèƒ½æ–¹ä¾¿çš„é€ä¼ è¿™ä¸ªä¿¡æ¯ï¼Œåˆ¤æ–­çš„ç»“æœæˆ‘ä»¬é€‰æ‹©æ”¾åœ¨ThreadLocalé‡Œã€‚</p>
<blockquote>
<p>RuleContextManager</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> RuleContextManager {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ThreadLocal&lt;RuleContextManager&gt; SKIP_CONTEXT_HOLDER = ThreadLocal.<span style="color:#007f7f">withInitial</span>(RuleContextManager::<span style="color:#fff;font-weight:bold">new</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * æ˜¯å¦è·³è¿‡sharding
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> skipSharding;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * æ˜¯å¦è·¯ç”±è‡³ä¸»åº“
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> masterRoute;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">boolean</span> isSkipSharding() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> SKIP_CONTEXT_HOLDER.<span style="color:#007f7f">get</span>().<span style="color:#007f7f">skipSharding</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setSkipSharding(<span style="color:#fff;font-weight:bold">boolean</span> skipSharding) {
</span></span><span style="display:flex;"><span>        SKIP_CONTEXT_HOLDER.<span style="color:#007f7f">get</span>().<span style="color:#007f7f">skipSharding</span> = skipSharding;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">boolean</span> isMasterRoute() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> SKIP_CONTEXT_HOLDER.<span style="color:#007f7f">get</span>().<span style="color:#007f7f">masterRoute</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setMasterRoute(<span style="color:#fff;font-weight:bold">boolean</span> masterRoute) {
</span></span><span style="display:flex;"><span>        SKIP_CONTEXT_HOLDER.<span style="color:#007f7f">get</span>().<span style="color:#007f7f">masterRoute</span> = masterRoute;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> clear(){
</span></span><span style="display:flex;"><span>        SKIP_CONTEXT_HOLDER.<span style="color:#007f7f">remove</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>åˆ¤æ–­SQLæ˜¯å¦åŒ…å«åˆ†ç‰‡è¡¨</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#buildSkipContext
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// åˆ¤æ–­æ˜¯å¦å¯ä»¥è·³è¿‡sharding,æ„é€ RuleContextManagerçš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">void</span> buildSkipContext(<span style="color:#fff;font-weight:bold">final</span> String sql){
</span></span><span style="display:flex;"><span>    Set&lt;String&gt; sqlTokenSet = <span style="color:#fff;font-weight:bold">new</span> HashSet&lt;&gt;(Arrays.<span style="color:#007f7f">asList</span>(sql.<span style="color:#007f7f">split</span>(<span style="color:#0ff;font-weight:bold">&#34;[\\s]&#34;</span>)));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (CollectionUtils.<span style="color:#007f7f">isNotEmpty</span>(rules)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (BaseRule baseRule : rules) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//å®šåˆ¶æ–¹æ³•ï¼ŒShardingRuleå®ç°ï¼Œåˆ¤æ–­sqlTokenSetæ˜¯å¦åŒ…å«é€»è¾‘è¡¨å³å¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span>(baseRule.<span style="color:#007f7f">hasContainShardingTable</span>(sqlTokenSet)){
</span></span><span style="display:flex;"><span>                RuleContextManager.<span style="color:#007f7f">setSkipSharding</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                RuleContextManager.<span style="color:#007f7f">setSkipSharding</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.core.rule.ShardingRule#hasContainShardingTable
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> Boolean hasContainShardingTable(Set&lt;String&gt; sqlTokenSet) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//logicTableNameListé€šè¿‡éå†TableRuleå¯ä»¥å¾—åˆ°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (String logicTable : logicTableNameList) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (sqlTokenSet.<span style="color:#007f7f">contains</span>(logicTable)) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>**ï¼ˆ2ï¼‰è·³è¿‡è§£æè·¯ç”±ï¼š**é€šè¿‡RuleContextManagerä¸­çš„skipShardingåˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡Shardingè§£æè·¯ç”±ï¼Œä½†ä¸ºäº†å…¼å®¹è¯»å†™åˆ†ç¦»çš„åœºæ™¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“è¿™æ¡SQLåº”è¯¥èµ°ä¸»åº“è¿˜æ˜¯ä»åº“ï¼Œèµ°ä¸»åº“çš„åœºæ™¯åœ¨åé¢å¼ºåˆ¶è·¯ç”±ä¸»åº“éƒ¨åˆ†æœ‰è¯´æ˜ï¼ŒSQLèµ°ä¸»åº“å®é™…ä¸Šåªæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯éSELECTè¯­å¥ï¼Œå¦ä¸€ç§å°±æ˜¯SELECTè¯­å¥å¸¦é”ï¼Œå¦‚SELECT&hellip;FOR UPDATEï¼Œå› æ­¤æ•´ä½“å®ç°çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p>å¦‚æœæ ‡è®°äº†è·³è¿‡Shardingä¸”ä¸ä¸ºselectè¯­å¥ï¼Œç›´æ¥è¿”å›SkipShardingStatementï¼Œå•ç‹¬æ„é€ ä¸€ä¸ªSkipShardingStatementçš„ç›®çš„æ˜¯ä¸ºäº†èƒ½åˆ©ç”¨è§£æå¼•æ“ä¸­çš„ç¼“å­˜ï¼Œç¼“å­˜ä¸­ä¸èƒ½æ”¾å…¥nullå€¼ã€‚</p>
</li>
<li>
<p>å¦‚æœæ˜¯selectè¯­å¥éœ€è¦ç»§ç»­è§£æï¼Œåˆ¤æ–­æ˜¯å¦æœ‰é”åç›´æ¥è¿”å›ï¼Œé¿å…åç»­è§£æé€ æˆè¯­æ³•ä¸å…¼å®¹ï¼Œè¿™é‡Œä¹Ÿæ›¾å°è¯•ç”¨åå°„è·å–lockClauseæ¥åˆ¤æ–­æ˜¯å¦åŒ…å«é”ï¼Œä½†æœ€ç»ˆæ²¡æœ‰æˆåŠŸã€‚</p>
</li>
<li>
<p>ShardingRouteDecoratoræ ¹æ®</p>
<p>RuleContextManager.isSkipShardingåˆ¤æ–­æ˜¯å¦è·³è¿‡è·¯ç”±ã€‚</p>
</li>
</ul>
<blockquote>
<p>è·³è¿‡è§£æè·¯ç”±</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SkipShardingStatement <span style="color:#fff;font-weight:bold">implements</span> SQLStatement{
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">int</span> getParameterCount() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sql.parser.SQLParserEngine#parse0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> SQLStatement parse0(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> useCache) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (useCache) {
</span></span><span style="display:flex;"><span>        Optional&lt;SQLStatement&gt; cachedSQLStatement = cache.<span style="color:#007f7f">getSQLStatement</span>(sql);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (cachedSQLStatement.<span style="color:#007f7f">isPresent</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> cachedSQLStatement.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ParseTree parseTree = <span style="color:#fff;font-weight:bold">new</span> SQLParserExecutor(databaseTypeName, sql).<span style="color:#007f7f">execute</span>().<span style="color:#007f7f">getRootNode</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * è·³è¿‡sharding éœ€è¦åˆ¤æ–­æ˜¯å¦éœ€è¦è·¯ç”±è‡³ä¸»åº“ å¦‚æœä¸æ˜¯selectè¯­å¥ç›´æ¥è·³è¿‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * æ˜¯selectè¯­å¥åˆ™éœ€è¦é€šè¿‡ç»§ç»­è§£æåˆ¤æ–­æ˜¯å¦æœ‰é”
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>    SQLStatement result ;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span>(RuleContextManager.<span style="color:#007f7f">isSkipSharding</span>()&amp;&amp;!VisitorRule.<span style="color:#007f7f">SELECT</span>.<span style="color:#007f7f">equals</span>(VisitorRule.<span style="color:#007f7f">valueOf</span>(parseTree.<span style="color:#007f7f">getClass</span>()))){
</span></span><span style="display:flex;"><span>        RuleContextManager.<span style="color:#007f7f">setMasterRoute</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        result = <span style="color:#fff;font-weight:bold">new</span> SkipShardingStatement();
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        result = (SQLStatement) ParseTreeVisitorFactory.<span style="color:#007f7f">newInstance</span>(databaseTypeName, VisitorRule.<span style="color:#007f7f">valueOf</span>(parseTree.<span style="color:#007f7f">getClass</span>())).<span style="color:#007f7f">visit</span>(parseTree);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (useCache) {
</span></span><span style="display:flex;"><span>        cache.<span style="color:#007f7f">put</span>(sql, result);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sql.parser.mysql.visitor.impl.MySQLDMLVisitor#visitSelectClause
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ASTNode visitSelectClause(<span style="color:#fff;font-weight:bold">final</span> SelectClauseContext ctx) {
</span></span><span style="display:flex;"><span>    SelectStatement result = <span style="color:#fff;font-weight:bold">new</span> SelectStatement();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è·³è¿‡sharding åªéœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰é”æ¥å†³å®šæ˜¯å¦è·¯ç”±è‡³ä¸»åº“å³å¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(RuleContextManager.<span style="color:#007f7f">isSkipSharding</span>()){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != ctx.<span style="color:#007f7f">lockClause</span>()) {
</span></span><span style="display:flex;"><span>            result.<span style="color:#007f7f">setLock</span>((LockSegment) visit(ctx.<span style="color:#007f7f">lockClause</span>()));
</span></span><span style="display:flex;"><span>            RuleContextManager.<span style="color:#007f7f">setMasterRoute</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//...åç»­è§£æ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.underlying.route.DataNodeRouter#createRouteContext
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> RouteContext createRouteContext(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters, <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> useCache) {
</span></span><span style="display:flex;"><span>    SQLStatement sqlStatement = parserEngine.<span style="color:#007f7f">parse</span>(sql, useCache);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å¦‚æœéœ€è¦è·³è¿‡sharding ä¸è¿›è¡Œåç»­çš„è§£æç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (RuleContextManager.<span style="color:#007f7f">isSkipSharding</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(sqlStatement, parameters, <span style="color:#fff;font-weight:bold">new</span> RouteResult());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//...è§£æ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sharding.route.engine.ShardingRouteDecorator#decorate
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> RouteContext decorate(<span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext, <span style="color:#fff;font-weight:bold">final</span> ShardingSphereMetaData metaData, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è·³è¿‡shardingè·¯ç”±
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(RuleContextManager.<span style="color:#007f7f">isSkipSharding</span>()){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> routeContext;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//...è·¯ç”±
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>**ï¼ˆ3ï¼‰æ‰‹åŠ¨æ„é€ ExecutionUnitï¼š**ExecutionUnitä¸­æˆ‘ä»¬éœ€è¦ç¡®å®šçš„å†…å®¹å°±æ˜¯datasourceNameï¼Œè¿™é‡Œæˆ‘ä»¬è®¤ä¸ºè·³è¿‡Shardingçš„SQLæœ€ç»ˆæ‰§è¡Œçš„åº“ä¸€å®šåªæœ‰ä¸€ä¸ªã€‚å¦‚æœåªæ˜¯è·³è¿‡Shardingçš„æƒ…å†µï¼Œç›´æ¥ä»å…ƒæ•°æ®ä¸­è·å–æ•°æ®æºåç§°å³å¯ï¼Œå¦‚æœå­˜åœ¨è¯»å†™åˆ†ç¦»çš„æƒ…å†µï¼Œä¸»ä»è·¯ç”±çš„ç»“æœä¹Ÿä¸€å®šæ˜¯å”¯ä¸€çš„ã€‚åˆ›å»ºå®ŒExecutionUnitç›´æ¥æ”¾å…¥ExecutionContextè¿”å›å³å¯ï¼Œä»è€Œè·³è¿‡åç»­çš„æ”¹å†™é€»è¾‘ã€‚</p>
<blockquote>
<p>æ‰‹åŠ¨æ„é€ ExecutionUnit</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ExecutionContext prepare(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters) {
</span></span><span style="display:flex;"><span>    List&lt;Object&gt; clonedParameters = cloneParameters(parameters);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ¤æ–­æ˜¯å¦å¯ä»¥è·³è¿‡sharding,æ„é€ RuleContextManagerçš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    buildSkipContext(sql);  
</span></span><span style="display:flex;"><span>    RouteContext routeContext = executeRoute(sql, clonedParameters);
</span></span><span style="display:flex;"><span>    ExecutionContext result = <span style="color:#fff;font-weight:bold">new</span> ExecutionContext(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è·³è¿‡shardingçš„sqlæœ€åçš„è·¯ç”±ç»“æœä¸€å®šåªæœ‰ä¸€ä¸ªåº“
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(RuleContextManager.<span style="color:#007f7f">isSkipSharding</span>()){
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;å¯ä»¥è·³è¿‡shardingçš„åœºæ™¯ {}&#34;</span>, sql);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(!Objects.<span style="color:#007f7f">isNull</span>(routeContext.<span style="color:#007f7f">getRouteResult</span>())){
</span></span><span style="display:flex;"><span>            Collection&lt;String&gt; allInstanceDataSourceNames = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">metaData</span>.<span style="color:#007f7f">getDataSources</span>().<span style="color:#007f7f">getAllInstanceDataSourceNames</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> routeUnitsSize = routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">size</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">/*
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">             * 1. æ²¡æœ‰è¯»å†™åˆ†ç¦»çš„æƒ…å†µä¸‹  è·³è¿‡shardingè·¯ç”±ä¼šå¯¼è‡´routeUnitsSizeä¸º0 æ­¤æ—¶éœ€è¦åˆ¤æ–­æ•°æ®æºæ•°é‡æ˜¯å¦ä¸º1
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">             * 2. è¯»å†™åˆ†ç¦»æƒ…å†µä¸‹ åªä¼šè·¯ç”±è‡³å…·ä½“çš„ä¸»åº“æˆ–ä»åº“ routeUnitsSizeæ•°é‡åº”è¯¥ä¸º1
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">             */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(!(routeUnitsSize == <span style="color:#ff0;font-weight:bold">0</span> &amp;&amp; allInstanceDataSourceNames.<span style="color:#007f7f">size</span>()==<span style="color:#ff0;font-weight:bold">1</span>)|| routeUnitsSize&gt;<span style="color:#ff0;font-weight:bold">1</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ShardingSphereException(<span style="color:#0ff;font-weight:bold">&#34;å¯ä»¥è·³è¿‡sharding,ä½†æ˜¯è·¯ç”±ç»“æœä¸å”¯ä¸€,SQL= %s ,routeUnits= %s &#34;</span>,sql, routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            Collection&lt;String&gt; actualDataSourceNames = routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getActualDataSourceNames</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// æ‰‹åŠ¨åˆ›å»ºæ‰§è¡Œå•å…ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String datasourceName = CollectionUtils.<span style="color:#007f7f">isEmpty</span>(actualDataSourceNames)? allInstanceDataSourceNames.<span style="color:#007f7f">iterator</span>().<span style="color:#007f7f">next</span>():actualDataSourceNames.<span style="color:#007f7f">iterator</span>().<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>            ExecutionUnit executionUnit = <span style="color:#fff;font-weight:bold">new</span> ExecutionUnit(datasourceName, <span style="color:#fff;font-weight:bold">new</span> SQLUnit(sql, clonedParameters));
</span></span><span style="display:flex;"><span>            result.<span style="color:#007f7f">getExecutionUnits</span>().<span style="color:#007f7f">add</span>(executionUnit);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ ‡è®°è¯¥ç»“æœéœ€è¦è·³è¿‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            result.<span style="color:#007f7f">setSkipShardingScenarioFlag</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        result.<span style="color:#007f7f">getExecutionUnits</span>().<span style="color:#007f7f">addAll</span>(executeRewrite(sql, clonedParameters, routeContext));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SHOW</span>)) {
</span></span><span style="display:flex;"><span>        SQLLogger.<span style="color:#007f7f">logSQL</span>(sql, properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SIMPLE</span>), result.<span style="color:#007f7f">getSqlStatementContext</span>(), result.<span style="color:#007f7f">getExecutionUnits</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>**ï¼ˆ4ï¼‰è·³è¿‡åˆå¹¶ï¼š**è·³è¿‡æŸ¥è¯¢ç»“æœçš„åˆå¹¶å’Œå½±å“è¡Œæ•°è®¡ç®—çš„åˆå¹¶ï¼Œæ³¨æ„ShardingPreparedStatementå’ŒShardingStatementéƒ½éœ€è¦è·³è¿‡</p>
<blockquote>
<p>è·³è¿‡åˆå¹¶</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#executeQuery
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ResultSet executeQuery() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    ResultSet result;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        clearPrevious();
</span></span><span style="display:flex;"><span>        prepare();
</span></span><span style="display:flex;"><span>        initPreparedStatementExecutor();
</span></span><span style="display:flex;"><span>        List&lt;QueryResult&gt; queryResults = preparedStatementExecutor.<span style="color:#007f7f">executeQuery</span>();
</span></span><span style="display:flex;"><span>        List&lt;ResultSet&gt; resultSets = preparedStatementExecutor.<span style="color:#007f7f">getResultSets</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å®šåˆ¶å¼€å‘ï¼Œä¸åˆ†ç‰‡è·³è¿‡åˆå¹¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(executionContext.<span style="color:#007f7f">isSkipShardingScenarioFlag</span>()){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> CollectionUtils.<span style="color:#007f7f">isNotEmpty</span>(resultSets) ? resultSets.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>) : <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        MergedResult mergedResult = mergeQuery(queryResults);
</span></span><span style="display:flex;"><span>        result = <span style="color:#fff;font-weight:bold">new</span> ShardingResultSet(resultSets, mergedResult, <span style="color:#fff;font-weight:bold">this</span>, executionContext);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>        clearBatch();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    currentResultSet = result;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#getResultSet
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ResultSet getResultSet() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != currentResultSet) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> currentResultSet;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    List&lt;ResultSet&gt; resultSets = getResultSets();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å®šåˆ¶å¼€å‘ï¼Œä¸åˆ†ç‰‡è·³è¿‡åˆå¹¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(executionContext.<span style="color:#007f7f">isSkipShardingScenarioFlag</span>()){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> CollectionUtils.<span style="color:#007f7f">isNotEmpty</span>(resultSets) ? resultSets.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>) : <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (executionContext.<span style="color:#007f7f">getSqlStatementContext</span>() <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatementContext || executionContext.<span style="color:#007f7f">getSqlStatementContext</span>().<span style="color:#007f7f">getSqlStatement</span>() <span style="color:#fff;font-weight:bold">instanceof</span> DALStatement) {
</span></span><span style="display:flex;"><span>        MergedResult mergedResult = mergeQuery(getQueryResults(resultSets));
</span></span><span style="display:flex;"><span>        currentResultSet = <span style="color:#fff;font-weight:bold">new</span> ShardingResultSet(resultSets, mergedResult, <span style="color:#fff;font-weight:bold">this</span>, executionContext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> currentResultSet;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">shardingsphere</span>.<span style="color:#007f7f">shardingjdbc</span>.<span style="color:#007f7f">jdbc</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">statement</span>.<span style="color:#007f7f">ShardingPreparedStatement</span><span style="color:#f00">#</span>isAccumulate
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> isAccumulate() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å®šåˆ¶å¼€å‘ï¼Œä¸åˆ†ç‰‡è·³è¿‡è®¡ç®—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(executionContext.<span style="color:#007f7f">isSkipShardingScenarioFlag</span>()){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> !connection.<span style="color:#007f7f">getRuntimeContext</span>().<span style="color:#007f7f">getRule</span>().<span style="color:#007f7f">isAllBroadcastTables</span>(executionContext.<span style="color:#007f7f">getSqlStatementContext</span>().<span style="color:#007f7f">getTablesContext</span>().<span style="color:#007f7f">getTableNames</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>**ï¼ˆ5ï¼‰æ¸…ç©ºRuleContextManagerï¼š**æŸ¥çœ‹ä¸€ä¸‹Sharding-JDBCå…¶ä»–ThreadLocalçš„æ¸…ç©ºä½ç½®ï¼Œå¯¹åº”çš„æ¸…ç©ºRuleContextManagerå°±å¥½ã€‚</p>
<blockquote>
<p>æ¸…ç©ºThreadLocal</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.jdbc.adapter.AbstractConnectionAdapter#close
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">void</span> close() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    closed = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>    MasterVisitedManager.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>    TransactionTypeHolder.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>    RuleContextManager.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> connectionSize = cachedConnections.<span style="color:#007f7f">size</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        forceExecuteTemplateForClose.<span style="color:#007f7f">execute</span>(cachedConnections.<span style="color:#007f7f">entries</span>(), cachedConnections -&gt; cachedConnections.<span style="color:#007f7f">getValue</span>().<span style="color:#007f7f">close</span>());
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>        cachedConnections.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>        rootInvokeHook.<span style="color:#007f7f">finish</span>(connectionSize);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚Sharding-JDBCæœ¬èº«æ˜¯ä¸æ”¯æŒINSERT INTO tbl_name (col1, col2, â€¦) SELECT col1, col2, â€¦ FROM tbl_name WHERE col3 = ?   è¿™ç§è¯­æ³•çš„ï¼Œä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p>
<p><img loading="lazy" src="6.png" alt=""  />
</p>
<p>ç»è¿‡æˆ‘ä»¬ä¸Šè¿°æ”¹é€ éªŒè¯åï¼Œéåˆ†ç‰‡è¡¨æ˜¯å¯ä»¥è·³è¿‡è¯­æ³•é™åˆ¶æ‰§è¡Œå¦‚ä¸‹çš„SQLçš„ã€‚</p>
<p><img loading="lazy" src="7.png" alt=""  />
</p>
<p><strong>é€šè¿‡è¯¥åŠŸèƒ½çš„å®ç°ï¼Œä¸šåŠ¡å¯ä»¥æ›´å…³æ³¨ä¸åˆ†ç‰‡è¡¨çš„SQLæ”¹é€ ï¼Œè€Œæ— éœ€æ‹…å¿ƒå¼•å…¥Sharding-JDBCé€ æˆæ‰€æœ‰SQLçš„éªŒè¯æ”¹é€ ï¼Œå¤§å¹…å‡å°‘æ”¹é€ æˆæœ¬å’Œé£é™©ã€‚</strong></p>
<h2 id="å¼ºåˆ¶è·¯ç”±ä¸»åº“">å¼ºåˆ¶è·¯ç”±ä¸»åº“<a hidden class="anchor" aria-hidden="true" href="#å¼ºåˆ¶è·¯ç”±ä¸»åº“">#</a></h2>
<p>Sharding-JDBCå¯ä»¥é€šè¿‡é…ç½®ä¸»ä»åº“æ•°æ®æºæ–¹ä¾¿çš„å®ç°è¯»å†™åˆ†ç¦»çš„åŠŸèƒ½ï¼Œä½†ä½¿ç”¨è¯»å†™åˆ†ç¦»å°±å¿…é¡»é¢å¯¹ä¸»ä»å»¶è¿Ÿå’Œä»åº“å¤±è”çš„ç—›ç‚¹ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬å®ç°äº†å¼ºåˆ¶è·¯ç”±ä¸»åº“çš„åŠ¨æ€é…ç½®ï¼Œå½“ä¸»ä»å»¶è¿Ÿè¿‡å¤§æˆ–ä»åº“å¤±è”æ—¶ï¼Œé€šè¿‡ä¿®æ”¹é…ç½®æ¥å®ç°SQLè¯­å¥å¼ºåˆ¶èµ°ä¸»åº“çš„ä¸åœæœºè·¯ç”±åˆ‡æ¢ã€‚</p>
<p>åé¢ä¼šè¯´æ˜äº†é…ç½®çš„åŠ¨æ€ç”Ÿæ•ˆçš„å®ç°æ–¹å¼ï¼Œè¿™é‡Œåªè¯´æ˜å¼ºåˆ¶è·¯ç”±ä¸»åº“çš„å®ç°ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å‰æ–‡çš„RuleContextManagerå³å¯ï¼Œåœ¨ä¸»ä»è·¯ç”±å¼•æ“é‡Œåˆ¤æ–­ä¸‹æ˜¯å¦å¼€å¯äº†å¼ºåˆ¶ä¸»åº“è·¯ç”±ã€‚</p>
<blockquote>
<p>MasterSlaveRouteDecorator.decorateæ”¹é€ </p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.masterslave.route.engine.MasterSlaveRouteDecorator#decorate
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> RouteContext decorate(<span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext, <span style="color:#fff;font-weight:bold">final</span> ShardingSphereMetaData metaData, <span style="color:#fff;font-weight:bold">final</span> MasterSlaveRule masterSlaveRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * å¦‚æœé…ç½®äº†å¼ºåˆ¶ä¸»åº“ MasterVisitedManagerè®¾ç½®ä¸ºtrue
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * åç»­isMasterRouteä¸­ä¼šä¿è¯è·¯ç”±è‡³ä¸»åº“
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span>(properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">MASTER_ROUTE_ONLY</span>)){
</span></span><span style="display:flex;"><span>        MasterVisitedManager.<span style="color:#007f7f">setMasterVisited</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//...è·¯ç”±é€»è¾‘
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> routeContext;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸ºäº†å…¼å®¹ä¹‹å‰è·³è¿‡Shardingçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦åŒæ­¥ä¿®æ”¹ä¸‹isMasterRouteæ–¹æ³•ï¼Œå¦‚æœæ˜¯è·³è¿‡äº†Shardingè·¯ç”±éœ€è¦é€šè¿‡RuleContextManageræ¥åˆ¤æ–­æ˜¯å¦èµ°ä¸»åº“ã€‚</p>
<blockquote>
<p>isMasterRouteæ”¹é€ </p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.masterslave.route.engine.impl.MasterSlaveDataSourceRouter#isMasterRoute
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> isMasterRoute(<span style="color:#fff;font-weight:bold">final</span> SQLStatement sqlStatement) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span>(sqlStatement <span style="color:#fff;font-weight:bold">instanceof</span> SkipShardingStatement){
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ä¼˜å…ˆä»¥MasterVisitedManagerä¸­çš„å€¼ä¸ºå‡†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> MasterVisitedManager.<span style="color:#007f7f">isMasterVisited</span>()|| RuleContextManager.<span style="color:#007f7f">isMasterRoute</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> containsLockSegment(sqlStatement) || !(sqlStatement <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatement) || MasterVisitedManager.<span style="color:#007f7f">isMasterVisited</span>() || HintManager.<span style="color:#007f7f">isMasterRouteOnly</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å½“ç„¶ï¼Œæ›´ç†æƒ³çš„çŠ¶å†µæ˜¯é€šè¿‡ç›‘æ§ä¸»ä»åŒæ­¥å»¶è¿Ÿå’Œæ•°æ®åº“æ‹¨æµ‹ï¼Œå½“è¶…è¿‡é˜ˆå€¼æ—¶æˆ–ä»åº“å¤±è”æ—¶ç›´æ¥è‡ªåŠ¨ä¿®æ”¹é…ç½®ä¸­å¿ƒçš„åº“ï¼Œå®ç°è‡ªåŠ¨åˆ‡æ¢ä¸»åº“ï¼Œå‡å°‘ä¸šåŠ¡æ•…éšœæ—¶é—´å’Œè¿ç»´å‹åŠ›ã€‚</strong></p>
<h2 id="é…ç½®åŠ¨æ€ç”Ÿæ•ˆ">é…ç½®åŠ¨æ€ç”Ÿæ•ˆ<a hidden class="anchor" aria-hidden="true" href="#é…ç½®åŠ¨æ€ç”Ÿæ•ˆ">#</a></h2>
<p>Sharding-JDBCä¸­çš„ConfigurationPropertyKeyä¸­æä¾›äº†è®¸å¤šé…ç½®å±æ€§ï¼Œè€ŒSharding-JDBCBå¹¶æ²¡æœ‰ä¸ºè¿™äº›é…ç½®æä¾›åœ¨çº¿ä¿®æ”¹çš„æ–¹æ³•ï¼Œè€Œåœ¨å®é™…çš„åº”ç”¨åœºæ™¯ä¸­ï¼ŒåƒSQL_SHOWè¿™æ ·æ§åˆ¶SQLæ‰“å°çš„å¼€å…³é…ç½®ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›èƒ½å¤Ÿåœ¨çº¿ä¿®æ”¹é…ç½®å€¼æ¥æ§åˆ¶SQLæ—¥å¿—çš„æ‰“å°ï¼Œè€Œä¸æ˜¯ä¿®æ”¹å®Œé…ç½®å†é‡å¯æœåŠ¡ã€‚</p>
<p>ä»¥SQLæ‰“å°ä¸ºä¾‹ï¼ŒBasePrepareEngineä¸­å­˜åœ¨ConfigurationPropertieså¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨getValueæ–¹æ³•æ¥è·å–SQL_SHOWçš„å€¼ã€‚</p>
<blockquote>
<p>SQL æ‰“å°</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#prepare
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Prepare to execute.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param sql SQL
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param parameters SQL parameters
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return execution context
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ExecutionContext prepare(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters) {
</span></span><span style="display:flex;"><span>    List&lt;Object&gt; clonedParameters = cloneParameters(parameters);
</span></span><span style="display:flex;"><span>    RouteContext routeContext = executeRoute(sql, clonedParameters);
</span></span><span style="display:flex;"><span>    ExecutionContext result = <span style="color:#fff;font-weight:bold">new</span> ExecutionContext(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>());
</span></span><span style="display:flex;"><span>    result.<span style="color:#007f7f">getExecutionUnits</span>().<span style="color:#007f7f">addAll</span>(executeRewrite(sql, clonedParameters, routeContext));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//sqlæ‰“å°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SHOW</span>)) {
</span></span><span style="display:flex;"><span>        SQLLogger.<span style="color:#007f7f">logSQL</span>(sql, properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SIMPLE</span>), result.<span style="color:#007f7f">getSqlStatementContext</span>(), result.<span style="color:#007f7f">getExecutionUnits</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ConfigurationPropertiesç»§æ‰¿äº†æŠ½è±¡ç±»TypedPropertiesï¼Œå…¶getValueæ–¹æ³•å°±æ˜¯æ ¹æ®keyè·å–å¯¹åº”çš„é…ç½®å€¼ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥åœ¨TypedPropertiesä¸­å®ç°åˆ·æ–°ç¼“å­˜ä¸­çš„é…ç½®å€¼çš„æ–¹æ³•ã€‚</p>
<blockquote>
<p>TypedPropertiesåˆ·æ–°é…ç½®</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">class</span> TypedProperties&lt;E <span style="color:#fff;font-weight:bold">extends</span> Enum &amp; TypedPropertyKey&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String LINE_SEPARATOR = System.<span style="color:#007f7f">getProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;line.separator&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Getter
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Properties props;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;E, TypedPropertyValue&gt; cache;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TypedProperties(<span style="color:#fff;font-weight:bold">final</span> Class&lt;E&gt; keyClass, <span style="color:#fff;font-weight:bold">final</span> Properties props) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">props</span> = props;
</span></span><span style="display:flex;"><span>        cache = preload(keyClass);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Map&lt;E, TypedPropertyValue&gt; preload(<span style="color:#fff;font-weight:bold">final</span> Class&lt;E&gt; keyClass) {
</span></span><span style="display:flex;"><span>        E[] enumConstants = keyClass.<span style="color:#007f7f">getEnumConstants</span>();
</span></span><span style="display:flex;"><span>        Map&lt;E, TypedPropertyValue&gt; result = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;(enumConstants.<span style="color:#007f7f">length</span>, <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>        Collection&lt;String&gt; errorMessages = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (E each : enumConstants) {
</span></span><span style="display:flex;"><span>            TypedPropertyValue value = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                value = <span style="color:#fff;font-weight:bold">new</span> TypedPropertyValue(each, props.<span style="color:#007f7f">getOrDefault</span>(each.<span style="color:#007f7f">getKey</span>(), each.<span style="color:#007f7f">getDefaultValue</span>()).<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (<span style="color:#fff;font-weight:bold">final</span> TypedPropertyValueException ex) {
</span></span><span style="display:flex;"><span>                errorMessages.<span style="color:#007f7f">add</span>(ex.<span style="color:#007f7f">getMessage</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            result.<span style="color:#007f7f">put</span>(each, value);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!errorMessages.<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ShardingSphereConfigurationException(Joiner.<span style="color:#007f7f">on</span>(LINE_SEPARATOR).<span style="color:#007f7f">join</span>(errorMessages));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Get property value.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param key property key
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param &lt;T&gt; class type of return value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return property value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @SuppressWarnings(<span style="color:#0ff;font-weight:bold">&#34;unchecked&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T getValue(<span style="color:#fff;font-weight:bold">final</span> E key) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> (T) cache.<span style="color:#007f7f">get</span>(key).<span style="color:#007f7f">getValue</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * vivoå®šåˆ¶æ”¹é€ æ–¹æ³• refresh property value.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param key property key
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param value property value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return æ›´æ–°é…ç½®æ˜¯å¦æˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> refreshValue(String key, String value){
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//è·å–é…ç½®ç±»æ”¯æŒçš„é…ç½®é¡¹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        E[] enumConstants = targetKeyClass.<span style="color:#007f7f">getEnumConstants</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (E each : enumConstants) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//éå†æ–°çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span>(each.<span style="color:#007f7f">getKey</span>().<span style="color:#007f7f">equals</span>(key)){
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//ç©ºç™½valueè®¤ä¸ºæ— æ•ˆ,å–é»˜è®¤å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#fff;font-weight:bold">if</span>(!StringUtils.<span style="color:#007f7f">isBlank</span>(value)){
</span></span><span style="display:flex;"><span>                        value = each.<span style="color:#007f7f">getDefaultValue</span>();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//æ„é€ æ–°å±æ€§
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    TypedPropertyValue typedPropertyValue = <span style="color:#fff;font-weight:bold">new</span> TypedPropertyValue(each, value);
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//æ›¿æ¢ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    cache.<span style="color:#007f7f">put</span>(each, typedPropertyValue);
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//åŸå§‹å±æ€§ä¹Ÿæ›¿æ¢ä¸‹,æœ‰å¯èƒ½ä¼šé€šè¿‡RuntimeContextç›´æ¥è·å–Properties
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    props.<span style="color:#007f7f">put</span>(key,value);
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">catch</span> (<span style="color:#fff;font-weight:bold">final</span> TypedPropertyValueException ex) {
</span></span><span style="display:flex;"><span>                    log.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;refreshValue error. key={} , value={}&#34;</span>, key, value, ex);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ç°äº†åˆ·æ–°æ–¹æ³•åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†è¯¥æ–¹æ³•ä¸€æ­¥æ­¥æš´éœ²è‡³ä¸€ä¸ªå¤–éƒ¨å¯ä»¥è°ƒç”¨çš„ç±»ä¸­ï¼Œä»¥ä¾¿åœ¨æœåŠ¡ç›‘å¬é…ç½®çš„æ–¹æ³•ä¸­ï¼Œèƒ½å¤Ÿè°ƒç”¨è¿™ä¸ªåˆ·æ–°æ–¹æ³•ã€‚ConfigurationPropertiesç›´æ¥åœ¨</p>
<p>BasePrepareEngineçš„æ„é€ å‡½æ•°ä¸­ä¼ å…¥ï¼Œæˆ‘ä»¬é€šè¿‡æ„é€ å‡½æ•°é€æ­¥åæ¨æœ€å¤–å±‚çš„è¿™ä¸€å¯¹è±¡è°ƒç”¨æ¥æºï¼Œæœ€ç»ˆå¯ä»¥å®šä½åˆ°åœ¨AbstractDataSourceAdapterä¸­çš„getRuntimeContext()æ–¹æ³•ä¸­å¯ä»¥è·å–åˆ°è¿™ä¸ªé…ç½®ï¼Œè€Œè¿™ä¸ªå°±æ˜¯Sharding-JDBCå®ç°çš„JDBCä¸­Datasourceæ¥å£çš„æŠ½è±¡ç±»ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨è¿™ä¸ªç±»ä¸­è°ƒç”¨åˆšåˆšå®ç°çš„refreshValueæ–¹æ³•ï¼Œå‰©ä¸‹çš„å°±æ˜¯ç›‘å¬é…ç½®ï¼Œé€šè¿‡è‡ªå·±å®ç°çš„</p>
<p>AbstractDataSourceAdapteræ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±å¥½äº†ã€‚</p>
<p><img loading="lazy" src="8.png" alt=""  />
</p>
<p><strong>é€šè¿‡è¿™ä¸€åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„æ§åˆ¶ä¸€äº›å¼€å…³å±æ€§çš„åœ¨çº¿ä¿®æ”¹ï¼Œå¦‚SQLæ‰“å°ã€å¼ºåˆ¶è·¯ç”±ä¸»åº“ç­‰ï¼Œä¸šåŠ¡æ— éœ€é‡å¯æœåŠ¡å³å¯åšåˆ°é…ç½®çš„åŠ¨æ€ç”Ÿæ•ˆã€‚</strong></p>
<h2 id="æ‰¹é‡updateè¯­æ³•æ”¯æŒ">æ‰¹é‡updateè¯­æ³•æ”¯æŒ<a hidden class="anchor" aria-hidden="true" href="#æ‰¹é‡updateè¯­æ³•æ”¯æŒ">#</a></h2>
<p>ä¸šåŠ¡ä¸­å­˜åœ¨ä½¿ç”¨foreachæ ‡ç­¾æ¥æ‰¹é‡updateçš„è¯­å¥ï¼Œè¿™ç§SQLåœ¨Sharding-JDBCä¸­æ— æ³•è¢«æ­£ç¡®è·¯ç”±ï¼Œåªä¼šè·¯ç”±ç¬¬ä¸€ç»„å‚æ•°ï¼Œåé¢çš„æ— æ³•è¢«è·¯ç”±æ”¹å†™ï¼ŒåŸå› æ˜¯è§£æå¼•æ“æ— æ³•å°†è¯­å¥æ‹†åˆ†è§£æã€‚</p>
<blockquote>
<p>æ‰¹é‡updateæ ·ä¾‹</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;update</span> <span style="color:#007f7f">id=</span><span style="color:#0ff;font-weight:bold">&#34;batchUpdate&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;foreach</span> <span style="color:#007f7f">collection=</span><span style="color:#0ff;font-weight:bold">&#34;orderList&#34;</span> <span style="color:#007f7f">item=</span><span style="color:#0ff;font-weight:bold">&#34;item&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        update t_order set
</span></span><span style="display:flex;"><span>        status = 1,
</span></span><span style="display:flex;"><span>        updated_by = #{item.updatedBy}
</span></span><span style="display:flex;"><span>        WHERE created_by = #{item.createdBy};
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/foreach&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/update&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬é€šè¿‡å°†æ‰¹é‡updateæŒ‰ç…§;æ‹†åˆ†ä¸ºå¤šä¸ªè¯­å¥ï¼Œç„¶ååˆ†åˆ«è·¯ç”±ï¼Œæœ€åæ‰‹åŠ¨æ±‡æ€»è·¯æœ‰ç»“æœç”Ÿæˆæ‰§è¡Œå•å…ƒã€‚</p>
<p>ä¸ºäº†èƒ½æ­£ç¡®é‡å†™SQLï¼Œæ‰¹é‡updateæ‹†åˆ†åçš„è¯­å¥éœ€è¦å®Œå…¨ä¸€æ ·ï¼Œè¿™æ ·å°±ä¸èƒ½ä½¿ç”¨åŠ¨æ€æ‹¼æ¥setæ¡ä»¶ï¼Œè€Œæ˜¯ä½¿ç”¨ifnullè¯­æ³•æˆ–è€…å­—æ®µå€¼ä¸å‘ç”Ÿå˜åŒ–æ—¶ä¹Ÿå°†åŸæ¥çš„å€¼æ”¾å…¥setä¸­ï¼Œåªä¸è¿‡setå‰åçš„å€¼ä¿æŒä¸€è‡´ï¼Œæ•´ä½“æ€è·¯ä¸å®ç°å¦‚ä¸‹ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>æ ¹æ®åˆ†å·æ‹†åˆ†sql--&gt;æ ¹æ®sqlæ€»æ•°å¯¹å‚æ•°åˆ†ç»„--&gt;å¾ªç¯è§£æè·¯ç”±æ”¹å†™sql--&gt;è¿”å›ExecutionContext
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>prepareBatchå®ç°</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#prepareBatch
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> ExecutionContext prepareBatch(List&lt;String&gt; splitSqlList, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; allParameters) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//SQLå»é‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;String&gt; sqlList = splitSqlList.<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">distinct</span>().<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (sqlList.<span style="color:#007f7f">size</span>() &gt; <span style="color:#ff0;font-weight:bold">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ShardingSphereException(<span style="color:#0ff;font-weight:bold">&#34;ä¸æ”¯æŒå¤šæ¡SQL,è¯·æ£€æŸ¥SQL,&#34;</span> + sqlList.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ä»¥ç¬¬ä¸€æ¡SQLä¸ºæ ‡å‡†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String sql = sqlList.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ‰€æœ‰çš„æ‰§è¡Œå•å…ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Collection&lt;ExecutionUnit&gt; globalExecutionUnitList = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆå§‹åŒ–æœ€åçš„æ‰§è¡Œç»“æœ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ExecutionContext executionContextResult = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ ¹æ®æ‰€æœ‰å‚æ•°æ•°é‡å’ŒSQLè¯­å¥æ•°é‡ è®¡ç®—æ¯ç»„å‚æ•°çš„æ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">int</span> eachSqlParameterCount = allParameters.<span style="color:#007f7f">size</span>() / splitSqlList.<span style="color:#007f7f">size</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å¹³å‡åˆ†é…æ¯æ¡SQLçš„å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;List&lt;Object&gt;&gt; eachSqlParameterListList = Lists.<span style="color:#007f7f">partition</span>(allParameters, eachSqlParameterCount);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (List&lt;Object&gt; eachSqlParameterList : eachSqlParameterListList) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ¯æ¡SQLå‚æ•°ä¸åŒ éœ€è¦æ ¹æ®å‚æ•°è·¯ç”±ä¸åŒçš„ç»“æœ  å®é™…çš„SqlStatementContext æ˜¯ä¸€è‡´çš„
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        RouteContext routeContext = executeRoute(sql, eachSqlParameterList);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç”±äºSQLä¸€æ ·  å®é™…çš„SqlStatementContext æ˜¯ä¸€è‡´çš„ åªéœ€åˆå§‹åŒ–ä¸€æ¬¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (executionContextResult == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            executionContextResult = <span style="color:#fff;font-weight:bold">new</span> ExecutionContext(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        globalExecutionUnitList.<span style="color:#007f7f">addAll</span>(executeRewrite(sql, eachSqlParameterList, routeContext));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ’åºæ‰“å°æ—¥å¿—
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    executionContextResult.<span style="color:#007f7f">getExtendMap</span>().<span style="color:#007f7f">put</span>(EXECUTION_UNIT_LIST, globalExecutionUnitList.<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">sorted</span>(Comparator.<span style="color:#007f7f">comparing</span>(ExecutionUnit::getDataSourceName)).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>()));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SHOW</span>)) {
</span></span><span style="display:flex;"><span>        SQLLogger.<span style="color:#007f7f">logSQL</span>(sql, properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SIMPLE</span>),
</span></span><span style="display:flex;"><span>                         executionContextResult.<span style="color:#007f7f">getSqlStatementContext</span>(), (Collection&lt;ExecutionUnit&gt;) executionContextResult.<span style="color:#007f7f">getExtendMap</span>().<span style="color:#007f7f">get</span>(EXECUTION_UNIT_LIST));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> executionContextResult;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œæˆ‘ä»¬åœ¨ExecutionContextå•ç‹¬æ„é€ äº†ä¸€ä¸ªäº†ExtendMapæ¥å­˜æ”¾ExecutionUnitï¼ŒåŸå› æ˜¯ExecutionContextä¸­çš„executionUnitsæ˜¯HashSetï¼Œè€Œåˆ¤æ–­ExecutionUnitä¸­çš„SqlUnitåªä¼šæ ¹æ®SQLå»é‡ï¼Œæ‰¹é‡updateçš„SQLæ˜¯ä¸€è‡´çš„ï¼Œä½†parametersä¸åŒï¼Œä¸ºäº†ä¸å½±å“åŸæœ‰çš„é€»è¾‘ï¼Œå•ç‹¬ä½¿ç”¨äº†å¦å¤–çš„å˜é‡æ¥å­˜æ”¾ã€‚</p>
<blockquote>
<p>ExecutionContextæ”¹é€ </p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ExecutionContext {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;ExecutionUnit&gt; executionUnits = <span style="color:#fff;font-weight:bold">new</span> LinkedHashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * è‡ªå®šä¹‰æ‰©å±•å˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;ExtendEnum,Object&gt; extendMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * å®šåˆ¶æ‰©å±•ï¼Œæ˜¯å¦å¯ä»¥è·³è¿‡åˆ†ç‰‡é€»è¾‘
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Setter
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> skipShardingScenarioFlag = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span>@EqualsAndHashCode
</span></span><span style="display:flex;"><span>@ToString
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ExecutionUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String dataSourceName;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SQLUnit sqlUnit;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@AllArgsConstructor
</span></span><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span>@Setter
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æ ¹æ®SQLåˆ¤æ–­æ˜¯å¦ç›¸ç­‰
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@EqualsAndHashCode(of = { <span style="color:#0ff;font-weight:bold">&#34;sql&#34;</span> })
</span></span><span style="display:flex;"><span>@ToString
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SQLUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String sql;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬è¿˜éœ€è¦æ”¹é€ ä¸‹æ‰§è¡Œæ–¹æ³•ï¼Œåœ¨åˆå§‹åŒ–æ‰§è¡Œå™¨çš„æ—¶å€™ï¼Œåˆ¤æ–­ä¸‹ExtendMapä¸­å­˜åœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„EXECUTION_UNIT_LISTæ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ä½¿ç”¨ç”ŸæˆInputGroupï¼ŒåŒä¸€ä¸ªæ•°æ®æºä¸‹çš„ExecutionUnitä¼šè¢«æ”¾å…¥åŒä¸€ä¸ªInputGroupä¸­ã€‚</p>
<blockquote>
<p>InputGroupæ”¹é€ </p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.executor.PreparedStatementExecutor#init
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init(<span style="color:#fff;font-weight:bold">final</span> ExecutionContext executionContext) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    setSqlStatementContext(executionContext.<span style="color:#007f7f">getSqlStatementContext</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å…¼å®¹æ‰¹é‡update åˆ†åº“åˆ†è¡¨ååŒä¸€å¼ è¡¨çš„æƒ…å†µ åˆ¤æ–­æ˜¯å¦å­˜åœ¨EXECUTION_UNIT_LIST å­˜åœ¨åˆ™ä½¿ç”¨æœªå»é‡çš„Listè¿›è¡Œåç»­çš„æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (MapUtils.<span style="color:#007f7f">isNotEmpty</span>(executionContext.<span style="color:#007f7f">getExtendMap</span>())){
</span></span><span style="display:flex;"><span>        Collection&lt;ExecutionUnit&gt; executionUnitCollection = (Collection&lt;ExecutionUnit&gt;) executionContext.<span style="color:#007f7f">getExtendMap</span>().<span style="color:#007f7f">get</span>(EXECUTION_UNIT_LIST);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(CollectionUtils.<span style="color:#007f7f">isNotEmpty</span>(executionUnitCollection)){
</span></span><span style="display:flex;"><span>            getInputGroups().<span style="color:#007f7f">addAll</span>(obtainExecuteGroups(executionUnitCollection));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        getInputGroups().<span style="color:#007f7f">addAll</span>(obtainExecuteGroups(executionContext.<span style="color:#007f7f">getExecutionUnits</span>()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cacheStatements();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ”¹é€ å®Œæˆåï¼Œæ‰¹é‡updateä¸­çš„æ¯æ¡SQLéƒ½å¯ä»¥è¢«æ­£ç¡®è·¯ç”±æ‰§è¡Œã€‚</p>
<h2 id="shardingconditionå»é‡">ShardingConditionå»é‡<a hidden class="anchor" aria-hidden="true" href="#shardingconditionå»é‡">#</a></h2>
<p>å½“whereè¯­å¥åŒ…æ‹¬å¤šä¸ªoræ¡ä»¶æ—¶ï¼Œè€Œoræ¡ä»¶ä¸åŒ…å«åˆ†ç‰‡é”®æ—¶ï¼Œä¼šé€ æˆcreateShardingConditionsæ–¹æ³•ç”Ÿæˆé‡å¤çš„åˆ†ç‰‡æ¡ä»¶ï¼Œå¯¼è‡´é‡å¤è°ƒç”¨doShardingæ–¹æ³•ã€‚å¦‚è¿™ç§SQLï¼Œ</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> * <span style="color:#fff;font-weight:bold">FROM</span> t_order
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> created_by = ?
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">and</span> (  (status = ?) <span style="color:#fff;font-weight:bold">or</span>  (status = ?) <span style="color:#fff;font-weight:bold">or</span>  (status = ?) )
</span></span></code></pre></td></tr></table>
</div>
</div><p>å­˜åœ¨ä¸‰ä¸ªoræ¡ä»¶ï¼Œåˆ†ç‰‡é”®æ˜¯created_by ï¼Œå®é™…äº§ç”Ÿçš„shardingConditionä¼šæ˜¯ä¸‰ä¸ªä¸€æ ·çš„å€¼ï¼Œå¹¶ä¼šè°ƒç”¨ä¸‰æ¬¡doShardingçš„æ–¹æ³•ã€‚è™½ç„¶å®é™…æ‰§è¡Œè¿˜æ˜¯åªæœ‰ä¸€æ¬¡ï¼ˆæ‰¹é‡updateé‚£é‡Œè¯´æ˜è¿‡æ‰§è¡Œå•å…ƒä¼šå»é‡ï¼‰ï¼Œä½†ä¸ºäº†å‡å°‘æ–¹æ³•çš„é‡å¤è°ƒç”¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯¹è¿™é‡Œåšäº†ä¸€æ¬¡å»é‡ã€‚</p>
<p><img loading="lazy" src="9.png" alt=""  />
</p>
<p><img loading="lazy" src="10.png" alt=""  />
</p>
<p>å»é‡çš„æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ç²—æš´ï¼Œæˆ‘ä»¬å¯¹ListRouteValueå’ŒRangeRouteValueæ·»åŠ äº†@EqualsAndHashCodeæ³¨è§£ï¼Œç„¶ååœ¨WhereClauseShardingConditionEngineçš„createShardingConditionsæ–¹æ³•è¿”å›æœ€ç»ˆç»“æœå‰åŠ ä¸€æ¬¡å»é‡ï¼Œä»è€Œé¿å…ç”Ÿæˆé‡å¤çš„shardingConditioné€ æˆdoShardingæ–¹æ³•çš„é‡å¤è°ƒç”¨ã€‚</p>
<blockquote>
<p>createShardingConditionså»é‡</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sharding.route.engine.condition.engine.WhereClauseShardingConditionEngine#createShardingConditions
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> Collection&lt;ShardingCondition&gt; createShardingConditions(<span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext, <span style="color:#fff;font-weight:bold">final</span> Collection&lt;AndPredicate&gt; andPredicates, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters) {
</span></span><span style="display:flex;"><span>    Collection&lt;ShardingCondition&gt; result = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (AndPredicate each : andPredicates) {
</span></span><span style="display:flex;"><span>        Map&lt;Column, Collection&lt;RouteValue&gt;&gt; routeValueMap = createRouteValueMap(sqlStatementContext, each, parameters);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (routeValueMap.<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> Collections.<span style="color:#007f7f">emptyList</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        result.<span style="color:#007f7f">add</span>(createShardingCondition(routeValueMap));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//å»é‡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Collection&lt;ShardingCondition&gt; distinctResult = result.<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">distinct</span>().<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toCollection</span>(LinkedList::<span style="color:#fff;font-weight:bold">new</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> distinctResult;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å…¨è·¯ç”±æ ¡éªŒ">å…¨è·¯ç”±æ ¡éªŒ<a hidden class="anchor" aria-hidden="true" href="#å…¨è·¯ç”±æ ¡éªŒ">#</a></h2>
<p>åˆ†ç‰‡è¡¨çš„SQLä¸­å¦‚æœæ²¡æœ‰æºå¸¦åˆ†ç‰‡é”®ï¼ˆæˆ–è€…å¸¦ä¸Šäº†åˆ†ç‰‡é”®ç»“æœæ²¡æœ‰è¢«æ­£ç¡®è§£æï¼‰å°†ä¼šå¯¼è‡´å…¨è·¯ç”±ï¼Œäº§ç”Ÿæ€§èƒ½é—®é¢˜ï¼Œè€Œè¿™ç§SQLå¹¶ä¸ä¼šæŠ¥é”™ï¼Œè¿™å°±å¯¼è‡´åœ¨å®é™…çš„ä¸šåŠ¡æ”¹é€ ä¸­ï¼Œå¼€å‘å’Œæµ‹è¯•å¾ˆéš¾ä¿è¯ç™¾åˆ†ç™¾æ”¹é€ å½»åº•ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨æºç å±‚é¢å¯¹è¿™ç§æƒ…å†µåšäº†é¢å¤–çš„æ ¡éªŒï¼Œå½“äº§ç”Ÿå…¨è·¯ç”±ï¼Œä¹Ÿå°±æ˜¯ShardingConditionsä¸ºç©ºæ—¶ï¼Œä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œæ–¹ä¾¿å¼€å‘å’Œæµ‹è¯•èƒ½å¤Ÿå¿«é€Ÿå‘ç°å…¨è·¯ç”±SQLã€‚</p>
<p>å®ç°æ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ ¡éªŒä¸‹ShardingConditionsæ˜¯å¦ä¸ºç©ºå³å¯ï¼Œåªä¸è¿‡éœ€è¦é¢å¤–å…¼å®¹ä¸‹Hintç­–ç•¥ShardingConditionså§‹ç»ˆä¸ºç©ºçš„ç‰¹æ®Šæƒ…å†µã€‚</p>
<blockquote>
<p>å…¨è·¯ç”±æ ¡éªŒ</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.route.engine.ShardingRouteDecorator#decorate
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> RouteContext decorate(<span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext, <span style="color:#fff;font-weight:bold">final</span> ShardingSphereMetaData metaData, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//çœç•¥...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//è·å– ShardingConditions
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ShardingConditions shardingConditions = getShardingConditions(parameters, sqlStatementContext, metaData.<span style="color:#007f7f">getSchema</span>(), shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> hintAlgorithm = isHintAlgorithm(sqlStatementContext, shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//åˆ¤æ–­æ˜¯å¦å…è®¸å…¨è·¯ç”±
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (!properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">ALLOW_EMPTY_SHARDING_CONDITIONS</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//å¦‚æœä¸æ˜¯Hintç®—æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(!isHintAlgorithm(sqlStatementContext, shardingRule)){
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">/** å¦‚æœæ˜¯DMLè¯­å¥  åˆ™å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µ è¿™ä¸¤ç§æƒ…å†µæ˜¯æ ¹æ®getShardingConditionsæ–¹æ³•çš„å†…éƒ¨é€»è¾‘è€Œæ¥çš„
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                 *  ä¸€ç§æ˜¯éæ’å…¥è¯­å¥  shardingConditions.getConditions()ä¸ºç©ºå³å¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                 *  ä¸€ç§æ˜¯æ’å…¥è¯­å¥ æ’å…¥è¯­å¥shardingConditions.getConditions()ä¸ä¼šä¸ºç©º  ä½†æ˜¯ShardingConditionçš„routeValuesæ˜¯ç©ºçš„
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                 */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (sqlStatementContext.<span style="color:#007f7f">getSqlStatement</span>() <span style="color:#fff;font-weight:bold">instanceof</span> DMLStatement) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span>(shardingConditions.<span style="color:#007f7f">getConditions</span>().<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ShardingSphereException(<span style="color:#0ff;font-weight:bold">&#34;SQLä¸åŒ…å«åˆ†åº“åˆ†è¡¨é”®,è¯·æ£€æŸ¥SQL&#34;</span>);
</span></span><span style="display:flex;"><span>                }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (sqlStatementContext <span style="color:#fff;font-weight:bold">instanceof</span> InsertStatementContext) {
</span></span><span style="display:flex;"><span>                        List&lt;ShardingCondition&gt; routeValuesNotEmpty = shardingConditions.<span style="color:#007f7f">getConditions</span>().<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">filter</span>(r -&gt; CollectionUtils.<span style="color:#007f7f">isNotEmpty</span>(r.<span style="color:#007f7f">getRouteValues</span>())).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">if</span>(CollectionUtils.<span style="color:#007f7f">isEmpty</span>(routeValuesNotEmpty)){
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ShardingSphereException(<span style="color:#0ff;font-weight:bold">&#34;SQLä¸åŒ…å«åˆ†åº“åˆ†è¡¨é”®,è¯·æ£€æŸ¥SQL&#34;</span>);
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> needMergeShardingValues = isNeedMergeShardingValues(sqlStatementContext, shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//çœç•¥...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(sqlStatementContext, parameters, routeResult);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> isHintAlgorithm(<span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åœºæ™¯a å…¨å±€é»˜è®¤ç­–ç•¥æ˜¯å¦ä½¿ç”¨å¼ºåˆ¶è·¯ç”±ç­–ç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(shardingRule.<span style="color:#007f7f">getDefaultDatabaseShardingStrategy</span>() <span style="color:#fff;font-weight:bold">instanceof</span> HintShardingStrategy
</span></span><span style="display:flex;"><span>       || shardingRule.<span style="color:#007f7f">getDefaultTableShardingStrategy</span>() <span style="color:#fff;font-weight:bold">instanceof</span> HintShardingStrategy){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (String each : sqlStatementContext.<span style="color:#007f7f">getTablesContext</span>().<span style="color:#007f7f">getTableNames</span>()) {
</span></span><span style="display:flex;"><span>        Optional&lt;TableRule&gt; tableRule = shardingRule.<span style="color:#007f7f">findTableRule</span>(each);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//åœºæ™¯b æŒ‡å®šè¡¨æ˜¯å¦ä½¿ç”¨å¼ºåˆ¶è·¯ç”±ç­–ç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (tableRule.<span style="color:#007f7f">isPresent</span>() &amp;&amp; (shardingRule.<span style="color:#007f7f">getDatabaseShardingStrategy</span>(tableRule.<span style="color:#007f7f">get</span>()) <span style="color:#fff;font-weight:bold">instanceof</span> HintShardingStrategy
</span></span><span style="display:flex;"><span>                                      || shardingRule.<span style="color:#007f7f">getTableShardingStrategy</span>(tableRule.<span style="color:#007f7f">get</span>()) <span style="color:#fff;font-weight:bold">instanceof</span> HintShardingStrategy)) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“ç„¶è¿™å—åŠŸèƒ½ä¹Ÿå¯ä»¥åœ¨å®Œå–„äº›ï¼Œæ¯”å¦‚å¯¹åˆ†ç‰‡è·¯ç”±ç»“æœä¸­çš„æ•°æ®æºæ•°é‡è¿›è¡Œæ ¡éªŒï¼Œä»è€Œé¿å…è·¨åº“æ“ä½œï¼Œæˆ‘ä»¬è¿™è¾¹æ²¡æœ‰å®ç°ä¹Ÿå°±ä¸å†èµ˜è¿°äº†ã€‚</p>
<h2 id="ç»„ä»¶å°è£…">ç»„ä»¶å°è£…<a hidden class="anchor" aria-hidden="true" href="#ç»„ä»¶å°è£…">#</a></h2>
<p>ä¸šåŠ¡æ¥å…¥Sharding-JDBCçš„æ­¥éª¤æ˜¯ä¸€æ ·çš„ï¼Œéƒ½éœ€è¦é€šè¿‡Javaåˆ›å»ºæ•°æ®æºå’Œé…ç½®å¯¹è±¡æˆ–è€…ä½¿ç”¨SpringBootè¿›è¡Œé…ç½®ï¼Œå­˜åœ¨ä¸€å®šçš„ç†Ÿæ‚‰æˆæœ¬å’Œé‡å¤å¼€å‘çš„é—®é¢˜ï¼Œä¸ºæ­¤æˆ‘ä»¬ä¹Ÿå¯¹å®šåˆ¶å¼€å‘ç‰ˆæœ¬çš„Sharding-JDBCå°è£…äº†ä¸€ä¸ªå…¬å…±ç»„ä»¶ï¼Œä»è€Œç®€åŒ–ä¸šåŠ¡é…ç½®ï¼Œå‡å°‘é‡å¤å¼€å‘ï¼Œæå‡ä¸šåŠ¡çš„å¼€å‘æ•ˆç‡ï¼Œå…·ä½“åŠŸèƒ½å¯è§ä¸‹ã€‚è¿™å—æ²¡æœ‰æ¶‰åŠæºç çš„æ”¹é€ ï¼Œåªæ˜¯åœ¨å®šåˆ¶ç‰ˆæœ¬ä¸ŠåŒ…è£…çš„ä¸€ä¸ªå…¬å…±ç»„ä»¶ã€‚</p>
<ul>
<li>æä¾›äº†é»˜è®¤çš„æ•°æ®æºä¸è¿æ¥æ± é…ç½®</li>
<li>ç®€åŒ–åˆ†åº“åˆ†è¡¨é…ç½®ï¼Œä¸šåŠ¡é…ç½®é€»è¾‘è¡¨åå’Œåç¼€ï¼Œç»„ä»¶æ‹¼è£…è¡Œè¡¨è¾¾å¼å’Œactual-data-nodes</li>
<li>å°è£…å¸¸ç”¨çš„åˆ†ç‰‡ç®—æ³•ï¼ˆæ—¶é—´ã€ä¸šåŠ¡å­—æ®µå€¼ç­‰ï¼‰ï¼Œ</li>
<li>ç»Ÿä¸€çš„é…ç½®ç›‘å¬ä¸åŠ¨æ€ä¿®æ”¹ï¼ˆSQLæ‰“å°ã€å¼ºåˆ¶ä¸»ä»åˆ‡æ¢ç­‰ï¼‰</li>
</ul>
<blockquote>
<p>å¼€æºSharding-JDBCé…ç½®</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#f00">//æ•°æ®æºåç§°</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.names</span>=<span style="color:#0ff;font-weight:bold">ds0,ds1</span>
</span></span><span style="display:flex;"><span><span style="color:#f00">//ds0é…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds0.type</span>=<span style="color:#0ff;font-weight:bold">org.apache.commons.dbcp.BasicDataSource</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds0.driver-class-name</span>=<span style="color:#0ff;font-weight:bold">com.mysql.jdbc.Driver</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds0.url</span>=<span style="color:#0ff;font-weight:bold">jdbc:mysql://localhost:3306/ds0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds0.username</span>=<span style="color:#0ff;font-weight:bold">root</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds0.password</span>=
</span></span><span style="display:flex;"><span><span style="color:#f00">//ds1é…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds1.type</span>=<span style="color:#0ff;font-weight:bold">org.apache.commons.dbcp.BasicDataSource</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds1.driver-class-name</span>=<span style="color:#0ff;font-weight:bold">com.mysql.jdbc.Driver</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds1.url</span>=<span style="color:#0ff;font-weight:bold">jdbc:mysql://localhost:3306/ds1</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds1.username</span>=<span style="color:#0ff;font-weight:bold">root</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds1.password</span>=
</span></span><span style="display:flex;"><span><span style="color:#f00">//åˆ†è¡¨è§„åˆ™</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order.actual-data-nodes</span>=<span style="color:#0ff;font-weight:bold">ds$-&gt;{0..1}.t_order$-&gt;{0..1}</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.sharding-column</span>=<span style="color:#0ff;font-weight:bold">order_id</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.algorithm-expression</span>=<span style="color:#0ff;font-weight:bold">t_order$-&gt;{order_id % 2}</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order_item.actual-data-nodes</span>=<span style="color:#0ff;font-weight:bold">ds$-&gt;{0..1}.t_order_item$-&gt;{0..1}</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order_item.table-strategy.inline.sharding-column</span>=<span style="color:#0ff;font-weight:bold">order_id</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order_item.table-strategy.inline.algorithm-expression</span>=<span style="color:#0ff;font-weight:bold">t_order_item$-&gt;{order_id % 2}</span>
</span></span><span style="display:flex;"><span><span style="color:#f00">//é»˜è®¤åˆ†åº“è§„åˆ™</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column</span>=<span style="color:#0ff;font-weight:bold">user_id</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression</span>=<span style="color:#0ff;font-weight:bold">ds$-&gt;{user_id % 2}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ç»„ä»¶ç®€åŒ–é…ç½®</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#f00">//æ•°æ®æºåç§°</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.names</span> = <span style="color:#0ff;font-weight:bold">ds0,ds1</span>
</span></span><span style="display:flex;"><span><span style="color:#f00">//ds0é…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds0.url</span> = <span style="color:#0ff;font-weight:bold">jdbc:mysql://localhost:3306/ds1</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds0.username</span> = <span style="color:#0ff;font-weight:bold">root</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds0.password</span> =
</span></span><span style="display:flex;"><span><span style="color:#f00">//ds1é…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds1.url</span> = <span style="color:#0ff;font-weight:bold">jdbc:mysql://localhost:3306/ds1</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds1.username</span> = <span style="color:#0ff;font-weight:bold">root</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds1.password</span> =
</span></span><span style="display:flex;"><span><span style="color:#f00">//åˆ†è¡¨è§„åˆ™</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.table.rule.config</span> = <span style="color:#0ff;font-weight:bold">[{&#34;logicTable&#34;:&#34;t_order,t_order_item&#34;,&#34;tableRange&#34;:&#34;0..1&#34;,&#34;shardingColumn&#34;:&#34;order_id &#34;,&#34;algorithmExpression&#34;:&#34;order_id %2&#34;}]</span>
</span></span><span style="display:flex;"><span><span style="color:#f00">//é»˜è®¤åˆ†åº“è§„åˆ™</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.default.db.rule.config</span> = <span style="color:#0ff;font-weight:bold">{&#34;shardingColumn&#34;:&#34;user_id&#34;,&#34;algorithmExpression&#34;:&#34;user_id %2&#34;}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="ä½¿ç”¨å»ºè®®">ä½¿ç”¨å»ºè®®<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨å»ºè®®">#</a></h1>
<p>ç»“åˆå®˜æ–¹æ–‡æ¡£å’Œä¸šåŠ¡å®è·µç»éªŒï¼Œæˆ‘ä»¬ä¹Ÿæ¢³ç†äº†éƒ¨åˆ†ä½¿ç”¨Sharding-JDBCçš„å»ºè®®ä¾›å¤§å®¶å‚è€ƒï¼Œå®é™…å…·ä½“å¦‚ä½•ä¼˜åŒ–SQLå†™æ³•ï¼ˆæ¯”å¦‚å­æŸ¥è¯¢ã€åˆ†é¡µã€åˆ†ç»„æ’åºç­‰ï¼‰è¿˜éœ€è¦ç»“åˆä¸šåŠ¡çš„å®é™…åœºæ™¯æ¥è¿›è¡Œæµ‹è¯•å’Œè°ƒä¼˜ã€‚</p>
<p><strong>ï¼ˆ1ï¼‰å¼ºåˆ¶</strong></p>
<p><strong>å¼ºåˆ¶â‘ ï¼šæ¶‰åŠåˆ†ç‰‡è¡¨çš„SQLå¿…é¡»æºå¸¦åˆ†ç‰‡é”®</strong></p>
<p>åŸå› ï¼šæ— åˆ†ç‰‡é”®ä¼šå¯¼è‡´å…¨è·¯ç”±ï¼Œå­˜åœ¨ä¸¥é‡çš„æ€§èƒ½éšæ‚£</p>
<p><strong>å¼ºåˆ¶â‘¡ï¼šç¦æ­¢ä¸€æ¡SQLä¸­çš„åˆ†ç‰‡å€¼è·¯ç”±è‡³ä¸åŒçš„åº“</strong></p>
<p>åŸå› ï¼šè·¨åº“æ“ä½œå­˜åœ¨ä¸¥é‡çš„æ€§èƒ½éšæ‚£ï¼Œäº‹åŠ¡æ“ä½œä¼šå‡çº§ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¢åŠ ä¸šåŠ¡å¤æ‚åº¦</p>
<p><strong>å¼ºåˆ¶â‘¢ï¼šç¦æ­¢å¯¹åˆ†ç‰‡é”®ä½¿ç”¨è¿ç®—è¡¨è¾¾å¼æˆ–å‡½æ•°æ“ä½œ</strong></p>
<p>åŸå› ï¼šæ— æ³•æå‰è®¡ç®—è¡¨è¾¾å¼å’Œå‡½æ•°è·å–åˆ†ç‰‡å€¼ï¼Œå¯¼è‡´å…¨è·¯ç”±</p>
<p>è¯´æ˜ï¼š<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/use-norms/sql/">è¯¦è§å®˜æ–¹æ–‡æ¡£</a></p>
<p><img loading="lazy" src="11.png" alt="å›¾ç‰‡"  />
</p>
<p><strong>å¼ºåˆ¶â‘£ï¼šç¦æ­¢åœ¨å­æŸ¥è¯¢ä¸­ä½¿ç”¨åˆ†ç‰‡è¡¨</strong></p>
<p>åŸå› ï¼šæ— æ³•æ­£å¸¸è§£æå­æŸ¥è¯¢ä¸­çš„åˆ†ç‰‡è¡¨ï¼Œå¯¼è‡´ä¸šåŠ¡é”™è¯¯</p>
<p>è¯´æ˜ï¼šè™½ç„¶<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/use-norms/sql/">å®˜æ–¹æ–‡æ¡£ä¸­è¯´æœ‰é™æ”¯æŒå­æŸ¥è¯¢ </a>ï¼Œä½†åœ¨å®é™…çš„ä½¿ç”¨ä¸­å‘ç°4.1.1å¹¶ä¸æ”¯æŒå­æŸ¥è¯¢ï¼Œå¯è§å®˜æ–¹<a href="https://github.com/apache/shardingsphere/issues/6164">issue6164 </a>| <a href="https://github.com/apache/shardingsphere/issues/6228">issue 6228</a>ã€‚</p>
<p><img loading="lazy" src="12.png" alt="å›¾ç‰‡"  />
</p>
<p><strong>å»ºè®®â‘¤ï¼šåŒ…å«CASE WHENã€HAVINGã€UNION (ALL)è¯­æ³•çš„åˆ†ç‰‡SQLï¼Œä¸æ”¯æŒè·¯ç”±è‡³å¤šæ•°æ®èŠ‚ç‚¹</strong></p>
<p>è¯´æ˜ï¼š<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/use-norms/sql/">è¯¦è§å®˜æ–¹æ–‡æ¡£</a></p>
<p><strong>ï¼ˆ2ï¼‰å»ºè®®</strong></p>
<p><strong>â‘  å»ºè®®ä½¿ç”¨åˆ†å¸ƒå¼idæ¥ä¿è¯åˆ†ç‰‡è¡¨ä¸»é”®çš„å…¨å±€å”¯ä¸€æ€§</strong></p>
<p>åŸå› ï¼šæ–¹ä¾¿åˆ¤æ–­æ•°æ®çš„å”¯ä¸€æ€§å’Œåç»­çš„è¿ç§»æ‰©å®¹</p>
<p>è¯´æ˜ï¼š<a href="https://mp.weixin.qq.com/s?__biz=MzI4NjY4MTU5Nw==&amp;mid=2247496863&amp;idx=1&amp;sn=5aa18659b98346517ddeda80e42baf2a&amp;scene=21#wechat_redirect">è¯¦è§æ–‡ç« ã€Švivo è‡ªç ”é²ç­åˆ†å¸ƒå¼ ID æœåŠ¡å®è·µã€‹</a></p>
<p><strong>â‘¡ å»ºè®®è·¨å¤šè¡¨çš„åˆ†ç»„SQLçš„åˆ†ç»„å­—æ®µä¸æ’åºå­—æ®µä¿è¯ä¸€è‡´</strong></p>
<p>åŸå› ï¼šåˆ†ç»„å’Œæ’åºå­—æ®µä¸ä¸€è‡´åªèƒ½é€šè¿‡å†…å­˜åˆå¹¶ï¼Œå¤§æ•°æ®é‡æ—¶å­˜åœ¨æ€§èƒ½éšæ‚£</p>
<p>è¯´æ˜ï¼š<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/merge/">è¯¦è§å®˜æ–¹æ–‡æ¡£</a></p>
<p><strong>â‘¢ å»ºè®®é€šè¿‡å…¨å±€é€’å¢çš„åˆ†å¸ƒå¼idæ¥ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢</strong></p>
<p>åŸå› ï¼šSharding-JDBCçš„åˆ†é¡µä¼˜åŒ–ä¾§é‡äºç»“æœé›†çš„æµå¼åˆå¹¶æ¥é¿å…å†…å­˜çˆ†æ¶¨ï¼Œä½†æ·±åº¦åˆ†é¡µè‡ªèº«çš„æ€§èƒ½é—®é¢˜å¹¶ä¸èƒ½è§£å†³</p>
<p>è¯´æ˜ï¼š<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/use-norms/pagination/">è¯¦è§å®˜æ–¹æ–‡æ¡£</a></p>
<h1 id="æ€»ç»“-3">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“-3">#</a></h1>
<p>æœ¬æ–‡ç»“åˆä¸ªäººç†è§£æ¢³ç†äº†å„ä¸ªå¼•æ“çš„æºç å…¥å£å’Œå…³é”®é€»è¾‘ï¼Œè¯»è€…å¯ä»¥ç»“åˆæœ¬æ–‡å’Œå®˜æ–¹æ–‡æ¡£æ›´å¥½çš„å®šä½ç†è§£Sharding-JDBCçš„æºç å®ç°ã€‚<strong>å®šåˆ¶å¼€å‘çš„ç›®çš„æ˜¯ä¸ºäº†é™ä½ä¸šåŠ¡æ¥å…¥æˆæœ¬</strong>ï¼Œå°½å¯èƒ½å‡å°‘ä¸šåŠ¡å­˜é‡SQLçš„æ”¹é€ ï¼Œéƒ¨åˆ†æ”¹é€ æ€æƒ³å…¶å®ä¸å®˜æ–¹ç¤¾åŒºä¹Ÿå­˜åœ¨å·®å¼‚ï¼Œæ¯”å¦‚è·³è¿‡è¯­æ³•è§£æï¼Œå®˜æ–¹ç¤¾åŒºè‡´åŠ›äºé€šè¿‡ä¼˜åŒ–è§£æå¼•æ“æ¥é€‚é…å„ç§è¯­æ³•ï¼Œè€Œä¸æ˜¯è·³è¿‡è§£æé˜¶æ®µï¼Œå¯å‚è€ƒå®˜æ–¹<a href="https://github.com/apache/shardingsphere/issues/4806">issue</a>ã€‚æºç åˆ†æå’Œå®šåˆ¶æ”¹é€ åªæ¶‰åŠäº†Sharding-JDBCçš„æ•°æ®åˆ†ç‰‡å’Œè¯»å†™åˆ†ç¦»åŠŸèƒ½ï¼Œå®šåˆ¶å¼€å‘çš„åŠŸèƒ½ä¹Ÿåœ¨ç”Ÿäº§ç¯å¢ƒç»è¿‡äº†è€ƒéªŒï¼Œå¦‚æœ‰ä¸è¶³å’Œä¼˜åŒ–å»ºè®®ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚</p>
<h1 id="ä¸€äº›é—®é¢˜">ä¸€äº›é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#ä¸€äº›é—®é¢˜">#</a></h1>
<h2 id="ä¸æ”¯æŒçš„å…³é”®å­—">ä¸æ”¯æŒçš„å…³é”®å­—<a hidden class="anchor" aria-hidden="true" href="#ä¸æ”¯æŒçš„å…³é”®å­—">#</a></h2>
<p>DISTINCT
CASE WHEN
union
union all
having</p>
<h2 id="ä¸æ”¯æŒçš„å†™æ³•">ä¸æ”¯æŒçš„å†™æ³•<a hidden class="anchor" aria-hidden="true" href="#ä¸æ”¯æŒçš„å†™æ³•">#</a></h2>
<ul>
<li>æ¯æ¡INSERTè¯­å¥åªèƒ½æ’å…¥ä¸€æ¡æ•°æ®ï¼Œä¸æ”¯æŒVALUESåæœ‰å¤šè¡Œæ•°æ®çš„è¯­å¥</li>
<li>ç‰¹æ®Šinsert<code>insert select() ...</code></li>
<li>åˆ†è¡¨çš„è¡¨ï¼Œä¸æ”¯æŒå­æŸ¥è¯¢</li>
<li>å¤šæ¡ä»¶è¡¨è¿æ¥ï¼Œå¦‚left join table_a on a.id = b.id and a.user_id = b.user_id
è¿™æ—¶ä¼šæŠ¥é”™ï¼š
<code>io.shardingjdbc.core.parsing.parser.exception.SQLParsingException: SQL syntax error, expected token is â€˜EQâ€™, actual token is â€˜INTâ€™, literals is â€˜1â€™</code></li>
</ul>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">ä¸­é—´ä»¶</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Wjy&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>