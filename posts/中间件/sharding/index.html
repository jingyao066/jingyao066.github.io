<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>sharding | Wjy&#39;s Blog</title>
<meta name="keywords" content="中间件">
<meta name="description" content="官网
github
Sharding-Sphere是一套开源的分布式数据库中间件解决方案组成的生态圈，它由Sharding-JDBC、Sharding-Proxy和Sharding-Sidecar这3款相互独立的产品组成。
他们均提供标准化的数据分片、读写分离、柔性事务和数据治理功能，可适用于如Java同构、异构语言、容器、云原生等各种多样化的应用场景。
其中Sharding-JDBC最早由当当网在2016年开源，在Sharding-JDBC 3.0版本，更名为Sharding-Sphere，后来创始人张亮去了京东。在2018年底，项目开源给了apache基金会。
参考：Sharding-JDBC源码解析与vivo的定制开发">
<meta name="author" content="Wjy">
<link rel="canonical" href="http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/sharding/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="sharding" />
<meta property="og:description" content="官网
github
Sharding-Sphere是一套开源的分布式数据库中间件解决方案组成的生态圈，它由Sharding-JDBC、Sharding-Proxy和Sharding-Sidecar这3款相互独立的产品组成。
他们均提供标准化的数据分片、读写分离、柔性事务和数据治理功能，可适用于如Java同构、异构语言、容器、云原生等各种多样化的应用场景。
其中Sharding-JDBC最早由当当网在2016年开源，在Sharding-JDBC 3.0版本，更名为Sharding-Sphere，后来创始人张亮去了京东。在2018年底，项目开源给了apache基金会。
参考：Sharding-JDBC源码解析与vivo的定制开发" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/sharding/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-01-08T11:57:49+00:00" />
<meta property="article:modified_time" content="2020-01-08T11:57:49+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="sharding"/>
<meta name="twitter:description" content="官网
github
Sharding-Sphere是一套开源的分布式数据库中间件解决方案组成的生态圈，它由Sharding-JDBC、Sharding-Proxy和Sharding-Sidecar这3款相互独立的产品组成。
他们均提供标准化的数据分片、读写分离、柔性事务和数据治理功能，可适用于如Java同构、异构语言、容器、云原生等各种多样化的应用场景。
其中Sharding-JDBC最早由当当网在2016年开源，在Sharding-JDBC 3.0版本，更名为Sharding-Sphere，后来创始人张亮去了京东。在2018年底，项目开源给了apache基金会。
参考：Sharding-JDBC源码解析与vivo的定制开发"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "sharding",
      "item": "http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/sharding/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "sharding",
  "name": "sharding",
  "description": "官网 github Sharding-Sphere是一套开源的分布式数据库中间件解决方案组成的生态圈，它由Sharding-JDBC、Sharding-Proxy和Sharding-Sidecar这3款相互独立的产品组成。 他们均提供标准化的数据分片、读写分离、柔性事务和数据治理功能，可适用于如Java同构、异构语言、容器、云原生等各种多样化的应用场景。 其中Sharding-JDBC最早由当当网在2016年开源，在Sharding-JDBC 3.0版本，更名为Sharding-Sphere，后来创始人张亮去了京东。在2018年底，项目开源给了apache基金会。\n参考：Sharding-JDBC源码解析与vivo的定制开发\n",
  "keywords": [
    "中间件"
  ],
  "articleBody": "官网 github Sharding-Sphere是一套开源的分布式数据库中间件解决方案组成的生态圈，它由Sharding-JDBC、Sharding-Proxy和Sharding-Sidecar这3款相互独立的产品组成。 他们均提供标准化的数据分片、读写分离、柔性事务和数据治理功能，可适用于如Java同构、异构语言、容器、云原生等各种多样化的应用场景。 其中Sharding-JDBC最早由当当网在2016年开源，在Sharding-JDBC 3.0版本，更名为Sharding-Sphere，后来创始人张亮去了京东。在2018年底，项目开源给了apache基金会。\n参考：Sharding-JDBC源码解析与vivo的定制开发\n业务背景 随着业务并发请求和数据规模的不断扩大，单节点库表压力往往会成为系统的性能瓶颈。公司IT内部营销库存、交易订单、财经台账、考勤记录等多领域的业务场景的日增数据量巨大，存在着数据库节点压力过大、连接过多、查询速度变慢等情况，根据数据来源、时间、工号等信息来将没有联系的数据尽量均分到不同的库表中，从而在不影响业务需求的前提下，减轻数据库节点压力，提升查询效率和系统稳定性。\n技术选型 对比维度 Sharding-JDBC Sharding-Proxy MyCat 接入层 客户端 服务端 服务端 功能完整性 分库分表，读写分离 分库分表，读写分离 分库分表，读写分离 资源成本 无需部署单独的服务 需要部署单独的服务 需要部署单独的服务 性能 客户端与数据库直连，损耗低 多一层网络交互，损耗略高 多一层网络交互，损耗略高 连接数 多 少 少 成熟度 社区活跃度高，应用案例多 社区活跃度高，应用案例较少 不活跃，官方基本已停止维护 Sharding-JDBC作为轻量化的增强版的JDBC框架，相较其他中间件性能更好，接入难度更低，其数据分片、读写分离功能也覆盖了我们的业务诉求，因此我们在业务中广泛使用了Sharding-JDBC。但在使用Sharding-JDBC的过程中，我们也发现了诸多问题，为了业务更便捷的使用Sharding-JDBC，我们对源码做了针对性的定制开发和组件封装来满足业务需求。\n问题 业务影响 定制功能 sharding语法限制 业务改造sql风险和成本高 非分片表跳过sharding语法限制，批量update语法支持 配置无法动态生效 无法动态控制主库路由，从库故障时只能重启应用，拖长业务故障时长 强制路由主库，配置动态生效 or条件下doSharding方法重复调用 方法重复调用对性能有一定影响，且方法内日志重复打印，影响生产问题排查效率 shardingCondition去重 未带分片键或分片键未能解析导致全路由 全路由产生严重的性能问题 全路由校验 基础功能重复建设与配置熟悉 影响开发效率 封装公共组件 源码分析 引言 Sharding-JDBC作为基于JDBC的数据库中间件，实现了JDBC的标准api，Sharding-JDBC与原生JDBC的执行对比流程如下图所示：\n相关执行流程的代码样例如下：\nJDBC执行样例\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 //获取数据库连接 try (Connection conn = DriverManager.getConnection(\"mysqlUrl\", \"userName\", \"password\")) { String sql = \"SELECT * FROM t_user WHERE name = ?\"; //预编译SQL try (PreparedStatement preparedStatement = conn.prepareStatement(sql)) { //参数设置与执行 preparedStatement.setString(1, \"vivo\"); preparedStatement.execute(sql); //获取结果集 try (ResultSet resultSet = preparedStatement.getResultSet()) { while (resultSet.next()) { //处理结果 } } } } Sharding-JDBC 源码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // org.apache.shardingsphere.shardingjdbc.jdbc.core.statement#execute public boolean execute() throws SQLException { try { clearPrevious(); //解析+路由+重写 内部调用BasePrepareEngine#prepare方法 prepare(); initPreparedStatementExecutor(); //执行 return preparedStatementExecutor.execute(); } finally { clearBatch(); } } // org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#prepare public ExecutionContext prepare(final String sql, final List parameters) { List clonedParameters = cloneParameters(parameters); //解析+路由(executeRoute内部先进行解析再执行路由) RouteContext routeContext = executeRoute(sql, clonedParameters); ExecutionContext result = new ExecutionContext(routeContext.getSqlStatementContext()); //重写 result.getExecutionUnits().addAll(executeRewrite(sql, clonedParameters, routeContext)); if (properties.getValue(ConfigurationPropertyKey.SQL_SHOW)) { SQLLogger.logSQL(sql, properties.getValue(ConfigurationPropertyKey.SQL_SIMPLE), result.getSqlStatementContext(), result.getExecutionUnits()); } return result; } // org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#getResultSet public ResultSet getResultSet() throws SQLException { if (null != currentResultSet) { return currentResultSet; } if (executionContext.getSqlStatementContext() instanceof SelectStatementContext || executionContext.getSqlStatementContext().getSqlStatement() instanceof DALStatement) { List resultSets = getResultSets(); //归并结果集 MergedResult mergedResult = mergeQuery(getQueryResults(resultSets)); currentResultSet = new ShardingResultSet(resultSets, mergedResult, this, executionContext); } return currentResultSet; } 从对比的执行流程图可见：\n【JDBC】：执行的主要流程是通过Datasource获取Connection，再注入SQL语句生成PreparedStatement对象，PreparedStatement设置占位符参数执行后得到结果集ResultSet。 【Sharding-JDBC】：主要流程基本一致，但Sharding基于PreparedStatement进行了实现与扩展，具体实现类ShardingPreparedStatement中会抽象出解析、路由、重写、归并等引擎，从而实现分库分表、读写分离等能力，每个引擎的作用说明如下表所示： 引擎 作用 解析引擎 将SQL拆分成不可再分的原子符号(token),解析成语法树，语法树是后续路由、改写、归并的基础依据。 路由引擎 根据语法树匹配配置的路由策略，通过SQL参数和策略的执行库表 改写引擎 根据语法树和路由结果将逻辑SQL改写成真正可执行的真实SQL,包括逻辑表的替换、分页的修正、插入拆分等 执行引擎 根据SQL执行单元创建合适的连接（需兼顾内存和连接资源），并将真实SQL发送至数据库执行 归并引擎 根据语法树将各个数据节点的结果集归并成最终需要的结果集，包括分组归并、排序归并、分页归并、聚合归并等 解析引擎 解析引擎 解析引擎是Sharding-JDBC进行分库分表逻辑的基础，其作用是将SQL拆解为不可再分的原子符号（称为token），再根据数据库类型将这些token分类成关键字、表达式、操作符、字面量等不同类型，进而生成抽象语法树，而语法树是后续进行路由、改写操作的前提（这也正是语法树的存在使得Sharding-JDBC存在各式各样的语法限制的原因之一）。\n官方文档：解析引擎 :: ShardingSphere (apache.org)\n4.x的版本采用ANTLR（ANother Tool for Language Recognition）作为解析引擎，在ShardingSphere-sql-parser-dialect模块中定义了适用于不同数据库语法的解析规则（.g4文件），idea中也可以下载ANTLR v4的插件，输入SQL查看解析后的语法树结果。\n解析方法的入口在DataNodeRouter的createRouteContext方法中，解析引擎根据数据库类型和SQL创建SQLParserExecutor执行得到解析树，再通过ParseTreeVisitor()的visit方法，对解析树进行处理得到SQLStatement。ANTLR支持listener和visitor两种模式的接口，visitor方式可以更灵活的控制解析树的遍历过程，更适用于SQL解析的场景。\n解析引擎核心代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // org.apache.shardingsphere.underlying.route.DataNodeRouter#createRouteContext#96 private RouteContext createRouteContext(final String sql, final List parameters, final boolean useCache) { //解析引擎解析SQL SQLStatement sqlStatement = parserEngine.parse(sql, useCache); try { SQLStatementContext sqlStatementContext = SQLStatementContextFactory.newInstance(metaData.getSchema(), sql, parameters, sqlStatement); return new RouteContext(sqlStatementContext, parameters, new RouteResult()); // TODO should pass parameters for master-slave } catch (final IndexOutOfBoundsException ex) { return new RouteContext(new CommonSQLStatementContext(sqlStatement), parameters, new RouteResult()); } } // org.apache.shardingsphere.sql.parser.SQLParserEngine#parse0#72 private SQLStatement parse0(final String sql, final boolean useCache) { //缓存 if (useCache) { Optional cachedSQLStatement = cache.getSQLStatement(sql); if (cachedSQLStatement.isPresent()) { return cachedSQLStatement.get(); } } //根据数据库类型和sql生成解析树 ParseTree parseTree = new SQLParserExecutor(databaseTypeName, sql).execute().getRootNode(); //ParseTreeVisitor的visit方法对解析树进行处理得到SQLStatement SQLStatement result = (SQLStatement) ParseTreeVisitorFactory.newInstance(databaseTypeName, VisitorRule.valueOf(parseTree.getClass())).visit(parseTree); if (useCache) { cache.put(sql, result); } return result; } SQLStatement实际上是一个接口，其实现对应着不同的SQL类型，如SelectStatement 类中就包括查询的字段、表名、where条件、分组、排序、分页、lock等变量，可以看到这里并没有对having这种字段做定义，相当于Sharding-JDBC无法识别到SQL中的having，这使得Sharding-JDBC对having语法有一定的限制。\nSelectStatement\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public final class SelectStatement extends DMLStatement { // 字段 private ProjectionsSegment projections; // 表 private final Collection tableReferences = new LinkedList\u003c\u003e(); // where private WhereSegment where; // groupBy private GroupBySegment groupBy; // orderBy private OrderBySegment orderBy; // limit private LimitSegment limit; // 父statement private SelectStatement parentStatement; // lock private LockSegment lock; } SQLStatement还会被进一步转换成SQLStatementContext，如SelectStatement 会被转换成SelectStatementContext ，其结构与SelectStatement 类似不再多说，值得注意的是虽然这里定义了containsSubquery来判断是否包含子查询，但4.1.1源码永远是返回的false，与having类似，这意味着Sharding-JDBC不会对子查询语句做特殊处理。\nSelectStatementContext\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 public final class SelectStatementContext extends CommonSQLStatementContext implements TableAvailable, WhereAvailable { private final TablesContext tablesContext; private final ProjectionsContext projectionsContext; private final GroupByContext groupByContext; private final OrderByContext orderByContext; private final PaginationContext paginationContext; private final boolean containsSubquery; } private boolean containsSubquery() { // FIXME process subquery // Collection subqueryPredicateSegments = getSqlStatement().findSQLSegments(SubqueryPredicateSegment.class); // for (SubqueryPredicateSegment each : subqueryPredicateSegments) { // if (!each.getAndPredicates().isEmpty()) { // return true; // } // } return false; } 引擎总结 解析引擎是进行路由改写的前提基础，其作用就是将SQL按照定义的语法规则拆分成原子符号(token)，生成语法树，根据不同的SQL类型生成对应的SQLStatement，SQLStatement由各自的Segment组成，所有的Segment都包含startIndex和endIndex来定位token在SQL中所属的位置，但解析语法难以涵盖所有的SQL场景，使得部分SQL无法按照预期的结果路由执行。\n路由引擎 解析 路由引擎是Sharding-JDBC的核心步骤，作用是根据定义的分库分表规则将解析引擎生成的SQL上下文生成对应的路由结果，RouteResult 包括DataNode和RouteUnit，DataNode是实际的数据源节点，包括数据源名称和实际的物理表名，RouteUnit则记录了逻辑表/库与物理表/库的映射关系，后面的改写引擎也是根据这个映射关系来决定如何替换SQL中的逻辑表（实际上RouteResult 就是维护了一条SQL需要往哪些库哪些表执行的关系）。\nRouteResult\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public final class RouteResult { private final Collection",
  "wordCount" : "22446",
  "inLanguage": "en",
  "datePublished": "2020-01-08T11:57:49Z",
  "dateModified": "2020-01-08T11:57:49Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/sharding/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      sharding
    </h1>
    <div class="post-meta"><span title='2020-01-08 11:57:49 +0000 UTC'>2020-01-08</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e4%b8%9a%e5%8a%a1%e8%83%8c%e6%99%af" aria-label="业务背景">业务背景</a></li>
                <li>
                    <a href="#%e6%8a%80%e6%9c%af%e9%80%89%e5%9e%8b" aria-label="技术选型">技术选型</a></li>
                <li>
                    <a href="#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" aria-label="源码分析">源码分析</a><ul>
                        
                <li>
                    <a href="#%e5%bc%95%e8%a8%80" aria-label="引言">引言</a></li>
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90%e5%bc%95%e6%93%8e" aria-label="解析引擎">解析引擎</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90%e5%bc%95%e6%93%8e-1" aria-label="解析引擎">解析引擎</a></li>
                <li>
                    <a href="#%e5%bc%95%e6%93%8e%e6%80%bb%e7%bb%93" aria-label="引擎总结">引擎总结</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%b7%af%e7%94%b1%e5%bc%95%e6%93%8e" aria-label="路由引擎">路由引擎</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90" aria-label="解析">解析</a></li>
                <li>
                    <a href="#%e5%88%86%e7%89%87%e8%b7%af%e7%94%b1" aria-label="分片路由">分片路由</a></li>
                <li>
                    <a href="#%e4%b8%bb%e4%bb%8e%e8%b7%af%e7%94%b1" aria-label="主从路由">主从路由</a></li>
                <li>
                    <a href="#%e5%bc%95%e6%93%8e%e6%80%bb%e7%bb%93-1" aria-label="引擎总结">引擎总结</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%94%b9%e5%86%99%e5%bc%95%e6%93%8e" aria-label="改写引擎">改写引擎</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90-1" aria-label="解析">解析</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%89%a7%e8%a1%8c%e5%bc%95%e6%93%8e" aria-label="执行引擎">执行引擎</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90-2" aria-label="解析">解析</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-1" aria-label="总结">总结</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bd%92%e5%b9%b6%e5%bc%95%e6%93%8e" aria-label="归并引擎">归并引擎</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e6%9e%90-3" aria-label="解析">解析</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-2" aria-label="总结">总结</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9a%e5%88%b6%e7%a0%94%e5%8f%91" aria-label="定制研发">定制研发</a><ul>
                        
                <li>
                    <a href="#%e8%b7%b3%e8%bf%87sharding%e8%af%ad%e6%b3%95%e9%99%90%e5%88%b6" aria-label="跳过Sharding语法限制">跳过Sharding语法限制</a></li>
                <li>
                    <a href="#%e5%bc%ba%e5%88%b6%e8%b7%af%e7%94%b1%e4%b8%bb%e5%ba%93" aria-label="强制路由主库">强制路由主库</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e5%8a%a8%e6%80%81%e7%94%9f%e6%95%88" aria-label="配置动态生效">配置动态生效</a></li>
                <li>
                    <a href="#%e6%89%b9%e9%87%8fupdate%e8%af%ad%e6%b3%95%e6%94%af%e6%8c%81" aria-label="批量update语法支持">批量update语法支持</a></li>
                <li>
                    <a href="#shardingcondition%e5%8e%bb%e9%87%8d" aria-label="ShardingCondition去重">ShardingCondition去重</a></li>
                <li>
                    <a href="#%e5%85%a8%e8%b7%af%e7%94%b1%e6%a0%a1%e9%aa%8c" aria-label="全路由校验">全路由校验</a></li>
                <li>
                    <a href="#%e7%bb%84%e4%bb%b6%e5%b0%81%e8%a3%85" aria-label="组件封装">组件封装</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e5%bb%ba%e8%ae%ae" aria-label="使用建议">使用建议</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-3" aria-label="总结">总结</a></li>
                <li>
                    <a href="#%e4%b8%80%e4%ba%9b%e9%97%ae%e9%a2%98" aria-label="一些问题">一些问题</a><ul>
                        
                <li>
                    <a href="#%e4%b8%8d%e6%94%af%e6%8c%81%e7%9a%84%e5%85%b3%e9%94%ae%e5%ad%97" aria-label="不支持的关键字">不支持的关键字</a></li>
                <li>
                    <a href="#%e4%b8%8d%e6%94%af%e6%8c%81%e7%9a%84%e5%86%99%e6%b3%95" aria-label="不支持的写法">不支持的写法</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><a href="https://shardingsphere.apache.org/index_zh.html">官网</a>
<a href="https://github.com/apache/incubator-shardingsphere">github</a>
Sharding-Sphere是一套开源的分布式数据库中间件解决方案组成的生态圈，它由Sharding-JDBC、Sharding-Proxy和Sharding-Sidecar这3款相互独立的产品组成。
他们均提供标准化的数据分片、读写分离、柔性事务和数据治理功能，可适用于如Java同构、异构语言、容器、云原生等各种多样化的应用场景。
其中<code>Sharding-JDBC</code>最早由当当网在2016年开源，在<code>Sharding-JDBC 3.0</code>版本，更名为<code>Sharding-Sphere</code>，后来创始人张亮去了京东。在2018年底，项目开源给了apache基金会。</p>
<p>参考：<a href="https://mp.weixin.qq.com/s/GawVNXjCo8qni6w4yoW7SA">Sharding-JDBC源码解析与vivo的定制开发</a></p>
<h1 id="业务背景">业务背景<a hidden class="anchor" aria-hidden="true" href="#业务背景">#</a></h1>
<p>随着业务并发请求和数据规模的不断扩大，单节点库表压力往往会成为系统的性能瓶颈。公司IT内部<strong>营销库存、交易订单、财经台账、考勤记录</strong>等多领域的业务场景的日增数据量巨大，存在着<strong>数据库节点压力过大、连接过多、查询速度变慢</strong>等情况，根据数据来源、时间、工号等信息来将<strong>没有联系的数据</strong>尽量均分到不同的库表中，从而在不影响业务需求的前提下，减轻数据库节点压力，提升查询效率和系统稳定性。</p>
<h1 id="技术选型">技术选型<a hidden class="anchor" aria-hidden="true" href="#技术选型">#</a></h1>
<table>
<thead>
<tr>
<th>对比维度</th>
<th>Sharding-JDBC</th>
<th>Sharding-Proxy</th>
<th>MyCat</th>
</tr>
</thead>
<tbody>
<tr>
<td>接入层</td>
<td>客户端</td>
<td>服务端</td>
<td>服务端</td>
</tr>
<tr>
<td>功能完整性</td>
<td>分库分表，读写分离</td>
<td>分库分表，读写分离</td>
<td>分库分表，读写分离</td>
</tr>
<tr>
<td>资源成本</td>
<td>无需部署单独的服务</td>
<td>需要部署单独的服务</td>
<td>需要部署单独的服务</td>
</tr>
<tr>
<td>性能</td>
<td>客户端与数据库直连，损耗低</td>
<td>多一层网络交互，损耗略高</td>
<td>多一层网络交互，损耗略高</td>
</tr>
<tr>
<td>连接数</td>
<td>多</td>
<td>少</td>
<td>少</td>
</tr>
<tr>
<td>成熟度</td>
<td>社区活跃度高，应用案例多</td>
<td>社区活跃度高，应用案例较少</td>
<td>不活跃，官方基本已停止维护</td>
</tr>
</tbody>
</table>
<p>Sharding-JDBC作为轻量化的增强版的JDBC框架，相较其他中间件性能更好，接入难度更低，其数据分片、读写分离功能也覆盖了我们的业务诉求，因此我们在业务中广泛使用了Sharding-JDBC。但在使用Sharding-JDBC的过程中，我们也发现了诸多问题，为了业务更便捷的使用Sharding-JDBC，我们对源码做了针对性的定制开发和组件封装来满足业务需求。</p>
<table>
<thead>
<tr>
<th>问题</th>
<th>业务影响</th>
<th>定制功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>sharding语法限制</td>
<td>业务改造sql风险和成本高</td>
<td>非分片表跳过sharding语法限制，批量update语法支持</td>
</tr>
<tr>
<td>配置无法动态生效</td>
<td>无法动态控制主库路由，从库故障时只能重启<br/>应用，拖长业务故障时长</td>
<td>强制路由主库，配置动态生效</td>
</tr>
<tr>
<td>or条件下doSharding方法重复调用</td>
<td>方法重复调用对性能有一定影响，且方法内日志重复打印，影响生产问题排查效率</td>
<td>shardingCondition去重</td>
</tr>
<tr>
<td>未带分片键或分片键未能解析导致全路由</td>
<td>全路由产生严重的性能问题</td>
<td>全路由校验</td>
</tr>
<tr>
<td>基础功能重复建设与配置熟悉</td>
<td>影响开发效率</td>
<td>封装公共组件</td>
</tr>
</tbody>
</table>
<h1 id="源码分析">源码分析<a hidden class="anchor" aria-hidden="true" href="#源码分析">#</a></h1>
<h2 id="引言">引言<a hidden class="anchor" aria-hidden="true" href="#引言">#</a></h2>
<p>Sharding-JDBC作为基于JDBC的数据库中间件，实现了JDBC的标准api，Sharding-JDBC与原生JDBC的执行对比流程如下图所示：</p>
<p><img loading="lazy" src="1.png" alt=""  />
</p>
<p>相关执行流程的代码样例如下：</p>
<blockquote>
<p>JDBC执行样例</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//获取数据库连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">try</span> (Connection conn = DriverManager.<span style="color:#007f7f">getConnection</span>(<span style="color:#0ff;font-weight:bold">&#34;mysqlUrl&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;userName&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;password&#34;</span>)) {
</span></span><span style="display:flex;"><span>    String sql = <span style="color:#0ff;font-weight:bold">&#34;SELECT * FROM  t_user WHERE name = ?&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//预编译SQL
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">try</span> (PreparedStatement preparedStatement = conn.<span style="color:#007f7f">prepareStatement</span>(sql)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//参数设置与执行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        preparedStatement.<span style="color:#007f7f">setString</span>(<span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#0ff;font-weight:bold">&#34;vivo&#34;</span>);
</span></span><span style="display:flex;"><span>        preparedStatement.<span style="color:#007f7f">execute</span>(sql);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//获取结果集
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">try</span> (ResultSet resultSet = preparedStatement.<span style="color:#007f7f">getResultSet</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">while</span> (resultSet.<span style="color:#007f7f">next</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//处理结果
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Sharding-JDBC 源码</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.jdbc.core.statement#execute
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> execute() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        clearPrevious();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//解析+路由+重写 内部调用BasePrepareEngine#prepare方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        prepare();
</span></span><span style="display:flex;"><span>        initPreparedStatementExecutor();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//执行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> preparedStatementExecutor.<span style="color:#007f7f">execute</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>        clearBatch();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#prepare
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ExecutionContext prepare(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters) {
</span></span><span style="display:flex;"><span>    List&lt;Object&gt; clonedParameters = cloneParameters(parameters);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//解析+路由(executeRoute内部先进行解析再执行路由)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    RouteContext routeContext = executeRoute(sql, clonedParameters);
</span></span><span style="display:flex;"><span>    ExecutionContext result = <span style="color:#fff;font-weight:bold">new</span> ExecutionContext(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//重写
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    result.<span style="color:#007f7f">getExecutionUnits</span>().<span style="color:#007f7f">addAll</span>(executeRewrite(sql, clonedParameters, routeContext));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SHOW</span>)) {
</span></span><span style="display:flex;"><span>        SQLLogger.<span style="color:#007f7f">logSQL</span>(sql, properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SIMPLE</span>), result.<span style="color:#007f7f">getSqlStatementContext</span>(), result.<span style="color:#007f7f">getExecutionUnits</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#getResultSet
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ResultSet getResultSet() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != currentResultSet) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> currentResultSet;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (executionContext.<span style="color:#007f7f">getSqlStatementContext</span>() <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatementContext || executionContext.<span style="color:#007f7f">getSqlStatementContext</span>().<span style="color:#007f7f">getSqlStatement</span>() <span style="color:#fff;font-weight:bold">instanceof</span> DALStatement) {
</span></span><span style="display:flex;"><span>        List&lt;ResultSet&gt; resultSets = getResultSets();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//归并结果集
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        MergedResult mergedResult = mergeQuery(getQueryResults(resultSets));
</span></span><span style="display:flex;"><span>        currentResultSet = <span style="color:#fff;font-weight:bold">new</span> ShardingResultSet(resultSets, mergedResult, <span style="color:#fff;font-weight:bold">this</span>, executionContext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> currentResultSet;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>从对比的执行流程图可见：</p>
<ul>
<li>【JDBC】：执行的主要流程是通过Datasource获取Connection，再注入SQL语句生成PreparedStatement对象，PreparedStatement设置占位符参数执行后得到结果集ResultSet。</li>
<li>【Sharding-JDBC】：主要流程基本一致，但Sharding基于PreparedStatement进行了实现与扩展，具体实现类<strong>ShardingPreparedStatement中会抽象出解析、路由、重写、归并等引擎，从而实现分库分表、读写分离</strong>等能力，每个引擎的作用说明如下表所示：</li>
</ul>
<table>
<thead>
<tr>
<th>引擎</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>解析引擎</td>
<td>将SQL拆分成不可再分的原子符号(token),解析成语法树，语法树是后续路由、改写、归并的基础依据。</td>
</tr>
<tr>
<td>路由引擎</td>
<td>根据语法树匹配配置的路由策略，通过SQL参数和策略的执行库表</td>
</tr>
<tr>
<td>改写引擎</td>
<td>根据语法树和路由结果将逻辑SQL改写成真正可执行的真实SQL,包括逻辑表的替换、分页的修正、插入拆分等</td>
</tr>
<tr>
<td>执行引擎</td>
<td>根据SQL执行单元创建合适的连接（需兼顾内存和连接资源），并将真实SQL发送至数据库执行</td>
</tr>
<tr>
<td>归并引擎</td>
<td>根据语法树将各个数据节点的结果集归并成最终需要的结果集，包括分组归并、排序归并、分页归并、聚合归并等</td>
</tr>
</tbody>
</table>
<h2 id="解析引擎">解析引擎<a hidden class="anchor" aria-hidden="true" href="#解析引擎">#</a></h2>
<h3 id="解析引擎-1">解析引擎<a hidden class="anchor" aria-hidden="true" href="#解析引擎-1">#</a></h3>
<p>解析引擎是Sharding-JDBC进行分库分表逻辑的基础，其作用是将SQL拆解为不可再分的原子符号（称为token），再根据数据库类型将这些token分类成关键字、表达式、操作符、字面量等不同类型，进而生成抽象语法树，而语法树是后续进行路由、改写操作的前提（这也正是语法树的存在使得Sharding-JDBC存在各式各样的语法限制的原因之一）。</p>
<p><img loading="lazy" src="2.png" alt=""  />
</p>
<p>官方文档：<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/parse/">解析引擎 :: ShardingSphere (apache.org)</a></p>
<p>4.x的版本采用ANTLR（ANother Tool for Language Recognition）作为解析引擎，在ShardingSphere-sql-parser-dialect模块中定义了适用于不同数据库语法的解析规则（.g4文件），idea中也可以下载ANTLR v4的插件，输入SQL查看解析后的语法树结果。</p>
<p>解析方法的入口在DataNodeRouter的createRouteContext方法中，解析引擎根据数据库类型和SQL创建SQLParserExecutor执行得到解析树，再通过ParseTreeVisitor()的visit方法，对解析树进行处理得到SQLStatement。ANTLR支持listener和visitor两种模式的接口，visitor方式可以更灵活的控制解析树的遍历过程，更适用于SQL解析的场景。</p>
<blockquote>
<p>解析引擎核心代码</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.route.DataNodeRouter#createRouteContext#96
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> RouteContext createRouteContext(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters, <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> useCache) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//解析引擎解析SQL
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    SQLStatement sqlStatement = parserEngine.<span style="color:#007f7f">parse</span>(sql, useCache);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        SQLStatementContext sqlStatementContext = SQLStatementContextFactory.<span style="color:#007f7f">newInstance</span>(metaData.<span style="color:#007f7f">getSchema</span>(), sql, parameters, sqlStatement);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(sqlStatementContext, parameters, <span style="color:#fff;font-weight:bold">new</span> RouteResult());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// TODO should pass parameters for master-slave
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    } <span style="color:#fff;font-weight:bold">catch</span> (<span style="color:#fff;font-weight:bold">final</span> IndexOutOfBoundsException ex) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(<span style="color:#fff;font-weight:bold">new</span> CommonSQLStatementContext(sqlStatement), parameters, <span style="color:#fff;font-weight:bold">new</span> RouteResult());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sql.parser.SQLParserEngine#parse0#72
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> SQLStatement parse0(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> useCache) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//缓存
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (useCache) {
</span></span><span style="display:flex;"><span>        Optional&lt;SQLStatement&gt; cachedSQLStatement = cache.<span style="color:#007f7f">getSQLStatement</span>(sql);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (cachedSQLStatement.<span style="color:#007f7f">isPresent</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> cachedSQLStatement.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//根据数据库类型和sql生成解析树
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ParseTree parseTree = <span style="color:#fff;font-weight:bold">new</span> SQLParserExecutor(databaseTypeName, sql).<span style="color:#007f7f">execute</span>().<span style="color:#007f7f">getRootNode</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ParseTreeVisitor的visit方法对解析树进行处理得到SQLStatement
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    SQLStatement result = (SQLStatement) ParseTreeVisitorFactory.<span style="color:#007f7f">newInstance</span>(databaseTypeName, VisitorRule.<span style="color:#007f7f">valueOf</span>(parseTree.<span style="color:#007f7f">getClass</span>())).<span style="color:#007f7f">visit</span>(parseTree);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (useCache) {
</span></span><span style="display:flex;"><span>        cache.<span style="color:#007f7f">put</span>(sql, result);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>SQLStatement实际上是一个接口，其实现对应着不同的SQL类型，如SelectStatement 类中就包括查询的字段、表名、where条件、分组、排序、分页、lock等变量，可以看到这里并没有对having这种字段做定义，相当于Sharding-JDBC无法识别到SQL中的having，这使得Sharding-JDBC对having语法有一定的限制。</p>
<blockquote>
<p>SelectStatement</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SelectStatement <span style="color:#fff;font-weight:bold">extends</span> DMLStatement {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 字段
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> ProjectionsSegment projections;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 表
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;TableReferenceSegment&gt; tableReferences = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// where
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> WhereSegment where;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// groupBy
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> GroupBySegment groupBy;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// orderBy
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> OrderBySegment orderBy;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// limit
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> LimitSegment limit;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 父statement
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> SelectStatement parentStatement;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// lock
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> LockSegment lock;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>SQLStatement还会被进一步转换成SQLStatementContext，如SelectStatement 会被转换成SelectStatementContext ，其结构与SelectStatement 类似不再多说，值得注意的是虽然这里定义了containsSubquery来判断是否包含子查询，但4.1.1源码永远是返回的false，与having类似，这意味着Sharding-JDBC不会对子查询语句做特殊处理。</p>
<blockquote>
<p>SelectStatementContext</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SelectStatementContext <span style="color:#fff;font-weight:bold">extends</span> CommonSQLStatementContext&lt;SelectStatement&gt; <span style="color:#fff;font-weight:bold">implements</span> TableAvailable, WhereAvailable {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> TablesContext tablesContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ProjectionsContext projectionsContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> GroupByContext groupByContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> OrderByContext orderByContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> PaginationContext paginationContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> containsSubquery;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> containsSubquery() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// FIXME process subquery
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//        Collection&lt;SubqueryPredicateSegment&gt; subqueryPredicateSegments = getSqlStatement().findSQLSegments(SubqueryPredicateSegment.class);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//        for (SubqueryPredicateSegment each : subqueryPredicateSegments) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//            if (!each.getAndPredicates().isEmpty()) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//                return true;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//            }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//        }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="引擎总结"><strong>引擎总结</strong><a hidden class="anchor" aria-hidden="true" href="#引擎总结">#</a></h3>
<p>解析引擎是进行路由改写的前提基础，其作用就是将SQL按照定义的语法规则拆分成原子符号(token)，生成语法树，根据不同的SQL类型生成对应的SQLStatement，SQLStatement由各自的Segment组成，所有的Segment都包含startIndex和endIndex来定位token在SQL中所属的位置，但解析语法难以涵盖所有的SQL场景，使得部分SQL无法按照预期的结果路由执行。</p>
<h2 id="路由引擎">路由引擎<a hidden class="anchor" aria-hidden="true" href="#路由引擎">#</a></h2>
<h3 id="解析">解析<a hidden class="anchor" aria-hidden="true" href="#解析">#</a></h3>
<p>路由引擎是Sharding-JDBC的核心步骤，作用是根据定义的分库分表规则将解析引擎生成的SQL上下文生成对应的路由结果，RouteResult 包括DataNode和RouteUnit，DataNode是实际的数据源节点，包括数据源名称和实际的物理表名，RouteUnit则记录了逻辑表/库与物理表/库的映射关系，后面的改写引擎也是根据这个映射关系来决定如何替换SQL中的逻辑表（<strong>实际上RouteResult 就是维护了一条SQL需要往哪些库哪些表执行的关系</strong>）。</p>
<blockquote>
<p>RouteResult</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> RouteResult {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;Collection&lt;DataNode&gt;&gt; originalDataNodes = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;RouteUnit&gt; routeUnits = <span style="color:#fff;font-weight:bold">new</span> LinkedHashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> DataNode {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String DELIMITER = <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String dataSourceName;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String tableName;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> RouteUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> RouteMapper dataSourceMapper;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;RouteMapper&gt; tableMappers;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> RouteMapper {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String logicName;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String actualName;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中，路由有分为<strong>分片路由</strong>和<strong>主从路由</strong>，两者可以单独使用，也可以组合使用。</p>
<h3 id="分片路由">分片路由<a hidden class="anchor" aria-hidden="true" href="#分片路由">#</a></h3>
<p>ShardingRouteDecorator的decorate方法是路由引擎的核心逻辑，经过SQL校验-&gt;生成分片条件-&gt;合并分片值后得到路由结果。</p>
<blockquote>
<p>分片路由decorate方法</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.route.engine.ShardingRouteDecorator#decorate#57
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> RouteContext decorate(<span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext, <span style="color:#fff;font-weight:bold">final</span> ShardingSphereMetaData metaData, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    SQLStatementContext sqlStatementContext = routeContext.<span style="color:#007f7f">getSqlStatementContext</span>();
</span></span><span style="display:flex;"><span>    List&lt;Object&gt; parameters = routeContext.<span style="color:#007f7f">getParameters</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//SQL校验  校验INSERT INTO .... ON DUPLICATE KEY UPDATE 和UPDATE语句中是否存在分片键
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ShardingStatementValidatorFactory.<span style="color:#007f7f">newInstance</span>(
</span></span><span style="display:flex;"><span>        sqlStatementContext.<span style="color:#007f7f">getSqlStatement</span>()).<span style="color:#007f7f">ifPresent</span>(validator -&gt; validator.<span style="color:#007f7f">validate</span>(shardingRule, sqlStatementContext.<span style="color:#007f7f">getSqlStatement</span>(), parameters));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//生成分片条件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ShardingConditions shardingConditions = getShardingConditions(parameters, sqlStatementContext, metaData.<span style="color:#007f7f">getSchema</span>(), shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//合并分片值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">boolean</span> needMergeShardingValues = isNeedMergeShardingValues(sqlStatementContext, shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (sqlStatementContext.<span style="color:#007f7f">getSqlStatement</span>() <span style="color:#fff;font-weight:bold">instanceof</span> DMLStatement &amp;&amp; needMergeShardingValues) {
</span></span><span style="display:flex;"><span>        checkSubqueryShardingValues(sqlStatementContext, shardingRule, shardingConditions);
</span></span><span style="display:flex;"><span>        mergeShardingConditions(shardingConditions);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ShardingRouteEngine shardingRouteEngine = ShardingRouteEngineFactory.<span style="color:#007f7f">newInstance</span>(shardingRule, metaData, sqlStatementContext, shardingConditions, properties);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//得到路由结果
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    RouteResult routeResult = shardingRouteEngine.<span style="color:#007f7f">route</span>(shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (needMergeShardingValues) {
</span></span><span style="display:flex;"><span>        Preconditions.<span style="color:#007f7f">checkState</span>(<span style="color:#ff0;font-weight:bold">1</span> == routeResult.<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">size</span>(), <span style="color:#0ff;font-weight:bold">&#34;Must have one sharding with subquery.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(sqlStatementContext, parameters, routeResult);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ShardingStatementValidator有
ShardingInsertStatementValidator和
ShardingUpdateStatementValidator
两种实现，INSERT INTO &hellip;. ON DUPLICATE KEY UPDATE和UPDATE语法都会涉及到字段值的更新，Sharding-JDBC是不允许更新分片值的，毕竟修改分片值还需要将数据迁移至新分片值对应的库表中，才能保证数据分片规则一致。两者的校验细节也有所不同：</p>
<ul>
<li>INSERT INTO &hellip;. ON DUPLICATE KEY UPDATE仅仅是对UPDATE字段的校验， ON DUPLICATE KEY UPDATE中包含分片键就会报错；</li>
<li>而UPDATE语句则会额外校验WHERE条件中分片键的原始值和SET的值是否一样，不一样则会抛出异常。</li>
</ul>
<p><img loading="lazy" src="3.png" alt=""  />
</p>
<p>ShardingCondition中只有一个变量routeValues，RouteValue是一个接口，有ListRouteValue和RangeRouteValue两种实现，前者记录了分片键的in或=条件的分片值，后者则记录了范围查询的分片值，两者被封装为ShardingValue对象后，将会透传至分片算法中计算得到分片结果集。</p>
<blockquote>
<p>ShardingCondition</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ShardingConditions {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;ShardingCondition&gt; conditions;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ShardingCondition {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;RouteValue&gt; routeValues = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ListRouteValue&lt;T <span style="color:#fff;font-weight:bold">extends</span> Comparable&lt;?&gt;&gt; <span style="color:#fff;font-weight:bold">implements</span> RouteValue {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String columnName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String tableName;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//in或=条件对应的值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;T&gt; values;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String toString() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> tableName + <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span> + columnName + (<span style="color:#ff0;font-weight:bold">1</span> == values.<span style="color:#007f7f">size</span>() ? <span style="color:#0ff;font-weight:bold">&#34; = &#34;</span> + <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;(values).<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>) : <span style="color:#0ff;font-weight:bold">&#34; in (&#34;</span> + Joiner.<span style="color:#007f7f">on</span>(<span style="color:#0ff;font-weight:bold">&#34;,&#34;</span>).<span style="color:#007f7f">join</span>(values) + <span style="color:#0ff;font-weight:bold">&#34;)&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> RangeRouteValue&lt;T <span style="color:#fff;font-weight:bold">extends</span> Comparable&lt;?&gt;&gt; <span style="color:#fff;font-weight:bold">implements</span> RouteValue {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String columnName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String tableName;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//between and 大于小于等范围值的上下限
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Range&lt;T&gt; valueRange;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成分片条件后还会合并分片条件，但是前文提过在SelectStatementContext中的containsSubquery永远是false，所以这段逻辑永远返回false，即不会合并分片条件。</p>
<blockquote>
<p>判断是否需要合并分片条件</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.route.enine.ShardingRouteDecorator#isNeedMergeShardingValues#87
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> isNeedMergeShardingValues(<span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> sqlStatementContext <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatementContext &amp;&amp; ((SelectStatementContext) sqlStatementContext).<span style="color:#007f7f">isContainsSubquery</span>()
</span></span><span style="display:flex;"><span>        &amp;&amp; !shardingRule.<span style="color:#007f7f">getShardingLogicTableNames</span>(sqlStatementContext.<span style="color:#007f7f">getTablesContext</span>().<span style="color:#007f7f">getTableNames</span>()).<span style="color:#007f7f">isEmpty</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后就是通过分片路由引擎调用分片算法计算路由结果了，ShardingRouteEngine实现较多，介绍起来篇幅较多，这里就不展开说明了，可以<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/route/">参考官方文档来了解路由引擎的选择规则</a>。</p>
<p><img loading="lazy" src="4.png" alt=""  />
</p>
<p>Sharding-JDBC定义了多种分片策略和算法接口，主要的分配策略与算法说明如下表所示：</p>
<table>
<thead>
<tr>
<th>分片策略</th>
<th>分片算法</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>标准分片策略StandardShardingStrategy</td>
<td>精确分片算法PreciseShardingAlgorithm<br /><br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br /><br />范围分片算法RangeShardingAlgorithm</td>
<td>用于处理使用单一键作为分片键的=与N进行分片的场景<br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br /><br />用于处理使用单一键作为分片键的BETWEEN AND、&gt;、&lt;、&gt;=、&lt;=进行分片的场景</td>
</tr>
<tr>
<td>复合分片策略ComplexShardingStrategy</td>
<td>复合分片算法<br />ComplexKeysShardingAlgorithm</td>
<td>用于处理使用多键作为分片键进行分片的场景，提供对SQL语句中的=，&gt;，&lt;，&gt;=，&lt;=，IN和BETWEEN AND的分片操作支持</td>
</tr>
<tr>
<td>行表达式分片策略iInlineShardingStrategy</td>
<td>/</td>
<td>使用Gooy的表达式，默认只支持SQL语句中的=和N的分片操作，只支持单分片键</td>
</tr>
<tr>
<td>Hint分片策路HintShardingStrategy</td>
<td>Hint分片算法<br />HintShardingAlgorithm</td>
<td>通过Hit指定分片值而非从SQL中提取分片值的方式进行分片的策略</td>
</tr>
</tbody>
</table>
<p><strong>补充两个细节：</strong></p>
<p>（1）当ALLOW_RANGE_QUERY_WITH_INLINE_SHARDING配置设置true时，</p>
<p>InlineShardingStrategy支持范围查询，但是并不是根据分片值计算范围，而是<strong>直接全路由至配置的数据节点，会存在性能隐患。</strong></p>
<blockquote>
<p>InlineShardingStrategy.doSharding</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.core.strategy.route.inline.InlineShardingStrategy#doSharding
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> Collection&lt;String&gt; doSharding(<span style="color:#fff;font-weight:bold">final</span> Collection&lt;String&gt; availableTargetNames, <span style="color:#fff;font-weight:bold">final</span> Collection&lt;RouteValue&gt; shardingValues, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    RouteValue shardingValue = shardingValues.<span style="color:#007f7f">iterator</span>().<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ALLOW_RANGE_QUERY_WITH_INLINE_SHARDING设置为true，直接返回availableTargetNames，而不是根据RangeRouteValue计算
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">ALLOW_RANGE_QUERY_WITH_INLINE_SHARDING</span>) &amp;&amp; shardingValue <span style="color:#fff;font-weight:bold">instanceof</span> RangeRouteValue) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> availableTargetNames;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Preconditions.<span style="color:#007f7f">checkState</span>(shardingValue <span style="color:#fff;font-weight:bold">instanceof</span> ListRouteValue, <span style="color:#0ff;font-weight:bold">&#34;Inline strategy cannot support this type sharding:&#34;</span> + shardingValue.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>    Collection&lt;String&gt; shardingResult = doSharding((ListRouteValue) shardingValue);
</span></span><span style="display:flex;"><span>    Collection&lt;String&gt; result = <span style="color:#fff;font-weight:bold">new</span> TreeSet&lt;&gt;(String.<span style="color:#007f7f">CASE_INSENSITIVE_ORDER</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (String each : shardingResult) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (availableTargetNames.<span style="color:#007f7f">contains</span>(each)) {
</span></span><span style="display:flex;"><span>            result.<span style="color:#007f7f">add</span>(each);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>（2）4.1.1的<a href="https://shardingsphere.apache.org/document/4.1.1/cn/manual/sharding-jdbc/usage/hint/">官方文档虽然说Hint可以跳过解析和改写</a>，但在我们上面解析引擎的源码解析中，我们并没有看到有对Hint策略的额外跳过。事实上，即使使用了Hint分片SQL也同样需要解析重写，也同样受Sharding-JDBC的语法限制，这在<a href="https://github.com/apache/shardingsphere/issues/6458">官方的issue</a>中也曾经被提及。</p>
<h3 id="主从路由">主从路由<a hidden class="anchor" aria-hidden="true" href="#主从路由">#</a></h3>
<p>主从路由的核心逻辑就是通过 MasterSlaveDataSourceRouter 的route方法进行判定SQL走主库还是从库。主从情况下，配置的数据源实际是一组主从，而不是单个的实例，所以需要通过masterSlaveRule获取到具体的主库或者从库名字。</p>
<blockquote>
<p>主从路由decorate</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.masterslave.route.engine.MasterSlaveRouteDecorator#decorate    
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> RouteContext decorate(<span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext, <span style="color:#fff;font-weight:bold">final</span> ShardingSphereMetaData metaData, <span style="color:#fff;font-weight:bold">final</span> MasterSlaveRule masterSlaveRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//为空证明没有经过分片路由
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//根据SQL判断选择走主库还是从库
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String dataSourceName = <span style="color:#fff;font-weight:bold">new</span> MasterSlaveDataSourceRouter(masterSlaveRule).<span style="color:#007f7f">route</span>(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>().<span style="color:#007f7f">getSqlStatement</span>());
</span></span><span style="display:flex;"><span>        RouteResult routeResult = <span style="color:#fff;font-weight:bold">new</span> RouteResult();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//根据具体的主库/从库名创建路由单元
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        routeResult.<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> RouteUnit(<span style="color:#fff;font-weight:bold">new</span> RouteMapper(dataSourceName, dataSourceName), Collections.<span style="color:#007f7f">emptyList</span>()));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>(), Collections.<span style="color:#007f7f">emptyList</span>(), routeResult);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Collection&lt;RouteUnit&gt; toBeRemoved = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    Collection&lt;RouteUnit&gt; toBeAdded = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//不为空证明已经被分片路由处理了
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (RouteUnit each : routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (masterSlaveRule.<span style="color:#007f7f">getName</span>().<span style="color:#007f7f">equalsIgnoreCase</span>(each.<span style="color:#007f7f">getDataSourceMapper</span>().<span style="color:#007f7f">getActualName</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//先标记移除 因为这里是一组主从的名字而不是实际的库
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            toBeRemoved.<span style="color:#007f7f">add</span>(each);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//根据SQL判断选择走主库还是从库
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String actualDataSourceName = <span style="color:#fff;font-weight:bold">new</span> MasterSlaveDataSourceRouter(masterSlaveRule).<span style="color:#007f7f">route</span>(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>().<span style="color:#007f7f">getSqlStatement</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//根据具体的主库/从库名创建路由单元
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            toBeAdded.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> RouteUnit(<span style="color:#fff;font-weight:bold">new</span> RouteMapper(each.<span style="color:#007f7f">getDataSourceMapper</span>().<span style="color:#007f7f">getLogicName</span>(), actualDataSourceName), each.<span style="color:#007f7f">getTableMappers</span>()));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">removeAll</span>(toBeRemoved);
</span></span><span style="display:flex;"><span>    routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">addAll</span>(toBeAdded);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> routeContext;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>MasterSlaveDataSourceRouter中isMasterRoute方法会判断SQL是否需要走主库，当出现以下情况时走主库：</p>
<ul>
<li>select语句包含锁，如for update语句</li>
<li>不是select语句</li>
<li>MasterVisitedManager.isMasterVisited()设置为true</li>
<li>HintManager.isMasterRouteOnly()设置为true</li>
</ul>
<p>不走主库则通过负载算法选择从库，Sharding-JDBC提供了<strong>轮询和随机</strong>两种算法。</p>
<blockquote>
<p>MasterSlaveDataSourceRouter</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> MasterSlaveDataSourceRouter {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> MasterSlaveRule masterSlaveRule;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Route.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param sqlStatement SQL statement
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return data source name
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String route(<span style="color:#fff;font-weight:bold">final</span> SQLStatement sqlStatement) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (isMasterRoute(sqlStatement)) {
</span></span><span style="display:flex;"><span>            MasterVisitedManager.<span style="color:#007f7f">setMasterVisited</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> masterSlaveRule.<span style="color:#007f7f">getMasterDataSourceName</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> masterSlaveRule.<span style="color:#007f7f">getLoadBalanceAlgorithm</span>().<span style="color:#007f7f">getDataSource</span>(
</span></span><span style="display:flex;"><span>            masterSlaveRule.<span style="color:#007f7f">getName</span>(), masterSlaveRule.<span style="color:#007f7f">getMasterDataSourceName</span>(), <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;(masterSlaveRule.<span style="color:#007f7f">getSlaveDataSourceNames</span>()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> isMasterRoute(<span style="color:#fff;font-weight:bold">final</span> SQLStatement sqlStatement) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> containsLockSegment(sqlStatement) || !(sqlStatement <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatement) || MasterVisitedManager.<span style="color:#007f7f">isMasterVisited</span>() || HintManager.<span style="color:#007f7f">isMasterRouteOnly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> containsLockSegment(<span style="color:#fff;font-weight:bold">final</span> SQLStatement sqlStatement) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> sqlStatement <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatement &amp;&amp; ((SelectStatement) sqlStatement).<span style="color:#007f7f">getLock</span>().<span style="color:#007f7f">isPresent</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>是否走主库的信息存在MasterVisitedManager中，MasterVisitedManager是通过ThreadLocal实现的，但这种实现会有一个问题，<strong>当我们使用事务先查询再更新/插入时，第一条查询SQL并不会走主库，而是走从库</strong>，如果业务需要事务的第一条查询也走主库，事务查询前需要手动调用一次MasterVisitedManager.setMasterVisited()。</p>
<blockquote>
<p>MasterVisitedManager</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> MasterVisitedManager {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ThreadLocal&lt;Boolean&gt; MASTER_VISITED = ThreadLocal.<span style="color:#007f7f">withInitial</span>(() -&gt; <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Judge master data source visited in current thread.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return master data source visited or not in current thread
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">boolean</span> isMasterVisited() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> MASTER_VISITED.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Set master data source visited in current thread.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setMasterVisited() {
</span></span><span style="display:flex;"><span>        MASTER_VISITED.<span style="color:#007f7f">set</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Clear master data source visited.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> clear() {
</span></span><span style="display:flex;"><span>        MASTER_VISITED.<span style="color:#007f7f">remove</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="引擎总结-1">引擎总结<a hidden class="anchor" aria-hidden="true" href="#引擎总结-1">#</a></h3>
<p>路由引擎的作用是将SQL根据参数通过实现的策略算法计算出实际该在哪些库的哪些表执行，也就是路由结果。路由引擎有两种实现，分别是分片路由和主从路由，两者都提供了标准化的策略接口来让业务实现自己的路由策略，分片路由需要注意自身SQL场景和策略算法相匹配，主从路由中同一线程且同一数据库连接内，有写入操作后，之后的读操作会从主库读取，写入操作前的读操作不会走主库。</p>
<h2 id="改写引擎">改写引擎<a hidden class="anchor" aria-hidden="true" href="#改写引擎">#</a></h2>
<h3 id="解析-1">解析<a hidden class="anchor" aria-hidden="true" href="#解析-1">#</a></h3>
<p>经过解析路由后虽然确定了执行的实际库表，但SQL中表名依旧是逻辑表，不能执行，改写引擎可以将逻辑表替换为物理表。同时，路由至多库表的SQL也需要拆分为多条SQL执行。</p>
<p>改写的入口仍旧在BasePrepareEngine中，创建重写上下文createSQLRewriteContext，再根据上下文进行改写rewrite，最终返回执行单元ExecutionUnit。</p>
<blockquote>
<p>改写逻辑入口</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#executeRewrite
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> Collection&lt;ExecutionUnit&gt; executeRewrite(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters, <span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//注册重写装饰器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    registerRewriteDecorator();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//创建 SQLRewriteContext
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    SQLRewriteContext sqlRewriteContext = rewriter.<span style="color:#007f7f">createSQLRewriteContext</span>(sql, parameters, routeContext.<span style="color:#007f7f">getSqlStatementContext</span>(), routeContext);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//重写
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">isEmpty</span>() ? rewrite(sqlRewriteContext) : rewrite(routeContext, sqlRewriteContext);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行单元包含了数据源名称，改写后的SQL，以及对应的参数，SQL一样的两个SQLUnit会被视为相等。</p>
<blockquote>
<p>ExecutionUnit</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span>@EqualsAndHashCode
</span></span><span style="display:flex;"><span>@ToString
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ExecutionUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String dataSourceName;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SQLUnit sqlUnit;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@AllArgsConstructor
</span></span><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span>@Setter
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//根据sql判断是否相等
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@EqualsAndHashCode(of = { <span style="color:#0ff;font-weight:bold">&#34;sql&#34;</span> })
</span></span><span style="display:flex;"><span>@ToString
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SQLUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String sql;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>createSQLRewriteContext完成了两件事，一个是对SQL参数进行了重写，一个是生成了SQLToken。</p>
<blockquote>
<p>createSQLRewriteContext</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.rewrite.SQLRewriteEntry#createSQLRewriteContext
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> SQLRewriteContext createSQLRewriteContext(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters, <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext, <span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext) {
</span></span><span style="display:flex;"><span>    SQLRewriteContext result = <span style="color:#fff;font-weight:bold">new</span> SQLRewriteContext(schemaMetaData, sqlStatementContext, sql, parameters);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//sql参数重写
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    decorate(decorators, result, routeContext);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//生成SQLToken
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    result.<span style="color:#007f7f">generateSQLTokens</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.rewrite.context.ShardingSQLRewriteContextDecorator#decorate
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decorate(<span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties, <span style="color:#fff;font-weight:bold">final</span> SQLRewriteContext sqlRewriteContext) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (ParameterRewriter each : <span style="color:#fff;font-weight:bold">new</span> ShardingParameterRewriterBuilder(shardingRule, routeContext).<span style="color:#007f7f">getParameterRewriters</span>(sqlRewriteContext.<span style="color:#007f7f">getSchemaMetaData</span>())) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!sqlRewriteContext.<span style="color:#007f7f">getParameters</span>().<span style="color:#007f7f">isEmpty</span>() &amp;&amp; each.<span style="color:#007f7f">isNeedRewrite</span>(sqlRewriteContext.<span style="color:#007f7f">getSqlStatementContext</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//参数重写
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            each.<span style="color:#007f7f">rewrite</span>(sqlRewriteContext.<span style="color:#007f7f">getParameterBuilder</span>(), sqlRewriteContext.<span style="color:#007f7f">getSqlStatementContext</span>(), sqlRewriteContext.<span style="color:#007f7f">getParameters</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//sqlTokenGenerators
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    sqlRewriteContext.<span style="color:#007f7f">addSQLTokenGenerators</span>(<span style="color:#fff;font-weight:bold">new</span> ShardingTokenGenerateBuilder(shardingRule, routeContext).<span style="color:#007f7f">getSQLTokenGenerators</span>());
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.rewrite.context.SQLRewriteContext#generateSQLTokens
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> generateSQLTokens() {
</span></span><span style="display:flex;"><span>    sqlTokens.<span style="color:#007f7f">addAll</span>(sqlTokenGenerators.<span style="color:#007f7f">generateSQLTokens</span>(sqlStatementContext, parameters, schemaMetaData));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ParameterRewriter中与分片相关的实现有两种。</p>
<table>
<thead>
<tr>
<th>实现类</th>
<th>处理语句</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>ShardingPaginationParameterRewriter</td>
<td>select语句</td>
<td>分页重写，发生在RouteUnit&gt;1的情况下，因为多数据源的分页需要汇总每张表的数据再分页</td>
</tr>
<tr>
<td>ShardingGeneratedKeylnsertValueParameterRewrite</td>
<td>insert语句</td>
<td>主键重写，在不使用数据库自增主键的情况下，提供分布式主键的改写，默认是雪花算法</td>
</tr>
</tbody>
</table>
<p><em>//*详细的例子可以参考<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/rewrite/">官方文档中分页修正和补列部分</a>。</em></p>
<p>SQLToken记录了SQL中每个token（解析引擎中提过的不可再分的原子符号）的起始位置，从而方便改写引擎知道哪些位置需要改写。</p>
<blockquote>
<p>SQLToken</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">class</span> SQLToken <span style="color:#fff;font-weight:bold">implements</span> Comparable&lt;SQLToken&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> startIndex;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> compareTo(<span style="color:#fff;font-weight:bold">final</span> SQLToken sqlToken) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> startIndex - sqlToken.<span style="color:#007f7f">getStartIndex</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建完SQLRewriteContext后就对整条SQL进行重写和组装参数，可以看出每个RouteUnit都会重写SQL并获取自己对应的参数。</p>
<blockquote>
<p>SQLRouteRewriteEngine.rewrite</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.rewrite.engine.SQLRouteRewriteEngine#rewrite
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> Map&lt;RouteUnit, SQLRewriteResult&gt; rewrite(<span style="color:#fff;font-weight:bold">final</span> SQLRewriteContext sqlRewriteContext, <span style="color:#fff;font-weight:bold">final</span> RouteResult routeResult) {
</span></span><span style="display:flex;"><span>    Map&lt;RouteUnit, SQLRewriteResult&gt; result = <span style="color:#fff;font-weight:bold">new</span> LinkedHashMap&lt;&gt;(routeResult.<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">size</span>(), <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (RouteUnit each : routeResult.<span style="color:#007f7f">getRouteUnits</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//重写SQL+组装参数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        result.<span style="color:#007f7f">put</span>(each, <span style="color:#fff;font-weight:bold">new</span> SQLRewriteResult(<span style="color:#fff;font-weight:bold">new</span> RouteSQLBuilder(sqlRewriteContext, each).<span style="color:#007f7f">toSQL</span>(), getParameters(sqlRewriteContext.<span style="color:#007f7f">getParameterBuilder</span>(), routeResult, each)));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>toSQL核心就是根据SQLToken将SQL拆分改写再拼装，比如</p>
<p><code>select * from t_order where created_by = '123' </code></p>
<p>就会被拆分为 <code>select * from | t_order | where created_by = '123'</code> 三部分进行改写拼装。</p>
<blockquote>
<p>toSQL</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.rewrite.sql.impl.AbstractSQLBuilder#toSQL
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> String toSQL() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (context.<span style="color:#007f7f">getSqlTokens</span>().<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> context.<span style="color:#007f7f">getSql</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Collections.<span style="color:#007f7f">sort</span>(context.<span style="color:#007f7f">getSqlTokens</span>());
</span></span><span style="display:flex;"><span>    StringBuilder result = <span style="color:#fff;font-weight:bold">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//截取第一个SQLToken之前的内容  select * from
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    result.<span style="color:#007f7f">append</span>(context.<span style="color:#007f7f">getSql</span>().<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">0</span>, context.<span style="color:#007f7f">getSqlTokens</span>().<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>).<span style="color:#007f7f">getStartIndex</span>()));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (SQLToken each : context.<span style="color:#007f7f">getSqlTokens</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//重写拼接每个SQLToken对应的内容  t_order -&gt;t_order_0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        result.<span style="color:#007f7f">append</span>(getSQLTokenText(each));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//拼接SQLToken中间不变的内容 where created_by = &#39;123&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        result.<span style="color:#007f7f">append</span>(getConjunctionText(each));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result.<span style="color:#007f7f">toString</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ParameterBuilder有StandardParameterBuilder和GroupedParameterBuilder两个实现。</p>
<ul>
<li>**StandardParameterBuilder：**适用于非insert语句，getParameters无需分组处理直接返回即可</li>
<li>**GroupedParameterBuilder：**适用于insert语句，需要根据路由情况对参数进行分组。</li>
</ul>
<p>原因和样例可以参考<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/rewrite/">官方文档批量拆分部分</a>。</p>
<blockquote>
<p>getParameters</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.rewrite.engine.SQLRouteRewriteEngine#getParameters
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> List&lt;Object&gt; getParameters(<span style="color:#fff;font-weight:bold">final</span> ParameterBuilder parameterBuilder, <span style="color:#fff;font-weight:bold">final</span> RouteResult routeResult, <span style="color:#fff;font-weight:bold">final</span> RouteUnit routeUnit) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (parameterBuilder <span style="color:#fff;font-weight:bold">instanceof</span> StandardParameterBuilder || routeResult.<span style="color:#007f7f">getOriginalDataNodes</span>().<span style="color:#007f7f">isEmpty</span>() || parameterBuilder.<span style="color:#007f7f">getParameters</span>().<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//非插入语句直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> parameterBuilder.<span style="color:#007f7f">getParameters</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    List&lt;Object&gt; result = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> count = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (Collection&lt;DataNode&gt; each : routeResult.<span style="color:#007f7f">getOriginalDataNodes</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (isInSameDataNode(each, routeUnit)) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//插入语句参数分组构造
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            result.<span style="color:#007f7f">addAll</span>(((GroupedParameterBuilder) parameterBuilder).<span style="color:#007f7f">getParameters</span>(count));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        count++;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h3>
<p>改写引擎的作用是将逻辑SQL转换为实际可执行的SQL，这其中既有逻辑表名的替换，也有多路由的SQL拆分，还有为了后续归并操作而进行的分页、分组、排序等改写，select语句不会对参数进行重组，而insert语句为了避免插入多余数据，会通过路由单元对参数进行重组。</p>
<h2 id="执行引擎">执行引擎<a hidden class="anchor" aria-hidden="true" href="#执行引擎">#</a></h2>
<h3 id="解析-2">解析<a hidden class="anchor" aria-hidden="true" href="#解析-2">#</a></h3>
<p>改写完成后的SQL就可以执行了，执行引擎需要平衡好资源和效率，如果为每条真实SQL都创建一个数据库连接显然会造成资源的滥用，但如果单线程串行也必然会影响执行效率。</p>
<p>执行引擎会先将执行单元中需要执行的SQLUnit根据数据源分组，同一个数据源下的SQLUnit会放入一个list，然后会根据</p>
<p>maxConnectionsSizePerQuery对同一个数据源的SQLUnit继续分组，创建连接并绑定SQLUnit 。</p>
<blockquote>
<p>执行组创建</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sharding.execute.sql.prepare.SQLExecutePrepareTemplate#getSynchronizedExecuteUnitGroups
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> Collection&lt;InputGroup&lt;StatementExecuteUnit&gt;&gt; getSynchronizedExecuteUnitGroups(
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Collection&lt;ExecutionUnit&gt; executionUnits, <span style="color:#fff;font-weight:bold">final</span> SQLExecutePrepareCallback callback) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//根据数据源将SQLUnit分组 key=dataSourceName
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Map&lt;String, List&lt;SQLUnit&gt;&gt; sqlUnitGroups = getSQLUnitGroups(executionUnits);
</span></span><span style="display:flex;"><span>    Collection&lt;InputGroup&lt;StatementExecuteUnit&gt;&gt; result = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//创建sql执行组
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (Entry&lt;String, List&lt;SQLUnit&gt;&gt; entry : sqlUnitGroups.<span style="color:#007f7f">entrySet</span>()) {
</span></span><span style="display:flex;"><span>        result.<span style="color:#007f7f">addAll</span>(getSQLExecuteGroups(entry.<span style="color:#007f7f">getKey</span>(), entry.<span style="color:#007f7f">getValue</span>(), callback));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sharding.execute.sql.prepare.SQLExecutePrepareTemplate#getSQLExecuteGroups
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> List&lt;InputGroup&lt;StatementExecuteUnit&gt;&gt; getSQLExecuteGroups(<span style="color:#fff;font-weight:bold">final</span> String dataSourceName,
</span></span><span style="display:flex;"><span>                                                                   <span style="color:#fff;font-weight:bold">final</span> List&lt;SQLUnit&gt; sqlUnits, <span style="color:#fff;font-weight:bold">final</span> SQLExecutePrepareCallback callback) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    List&lt;InputGroup&lt;StatementExecuteUnit&gt;&gt; result = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//每个连接需要执行的最大sql数量
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">int</span> desiredPartitionSize = Math.<span style="color:#007f7f">max</span>(<span style="color:#ff0;font-weight:bold">0</span> == sqlUnits.<span style="color:#007f7f">size</span>() % maxConnectionsSizePerQuery ? sqlUnits.<span style="color:#007f7f">size</span>() / maxConnectionsSizePerQuery : sqlUnits.<span style="color:#007f7f">size</span>() / maxConnectionsSizePerQuery + <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//分组，每组对应一条数据库连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;List&lt;SQLUnit&gt;&gt; sqlUnitPartitions = Lists.<span style="color:#007f7f">partition</span>(sqlUnits, desiredPartitionSize);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//选择连接模式 连接限制/内存限制
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ConnectionMode connectionMode = maxConnectionsSizePerQuery &lt; sqlUnits.<span style="color:#007f7f">size</span>() ? ConnectionMode.<span style="color:#007f7f">CONNECTION_STRICTLY</span> : ConnectionMode.<span style="color:#007f7f">MEMORY_STRICTLY</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//创建连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;Connection&gt; connections = callback.<span style="color:#007f7f">getConnections</span>(connectionMode, dataSourceName, sqlUnitPartitions.<span style="color:#007f7f">size</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> count = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (List&lt;SQLUnit&gt; each : sqlUnitPartitions) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//绑定连接和SQLUnit 创建StatementExecuteUnit
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        result.<span style="color:#007f7f">add</span>(getSQLExecuteGroup(connectionMode, connections.<span style="color:#007f7f">get</span>(count++), dataSourceName, each, callback));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>SQLUnit分组和连接模式选择没有任何关系，<strong>连接模式的选择只取决于maxConnectionsSizePerQuery和SQLUnit数量的大小关系</strong>，</p>
<p>maxConnectionsSizePerQuery代表了一个数据源一次查询允许的最大连接数。</p>
<ul>
<li>当maxConnectionsSizePerQuery&lt;sqlunit数量时，意味着无法做到每个sqlunit独享一个连接，需要直接查询出结果集至内存中；&lt; li=&quot;&quot;&gt;</li>
<li>当maxConnectionsSizePerQuery&gt;=SQLUnit数量时，意味着可以支持每个SQLUnit独享一个连接，可以通过ResultSet游标下移的方式查询结果集。</li>
</ul>
<p>不过maxConnectionsSizePerQuery默认值为1，所以当一条SQL需要路由至多张表时（即有多个SQLUnit）会采用连接限制，当路由至单表时是内存限制模式。</p>
<table>
<thead>
<tr>
<th>连接模式</th>
<th>特点</th>
<th>使用条件</th>
</tr>
</thead>
<tbody>
<tr>
<td>连接限制CONNECTION STRICTLY</td>
<td>一次性读取ResultSet数据到内存，内存合并</td>
<td>maxConnectionsSizePerQuery&lt;SQLUnit数量</td>
</tr>
<tr>
<td>内存限制MEMORY STRICTLY</td>
<td>通过ResultSeti游标下移进行结果查询，流式合并</td>
<td>maxConnectionsSizePerQuery&gt;=SQLUnit数量</td>
</tr>
</tbody>
</table>
<p>为了避免产生数据库连接死锁问题，<strong>在内存限制模式时，Sharding-JDBC通过锁住数据源对象一次性创建出本条SQL需要的所有数据库连接</strong>。连接限制模式下，各连接一次性查出各自的结果，不会出现多连接相互等待的情况，因此不会发生死锁，而内存限制模式通过游标读取结果集，需要多条连接去查询不同的表做合并，如果不一次性拿到所有需要的连接，则可能存在连接相互等待的情况造成死锁。可以参照<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/execute/">官方文档中执行引擎相关例子</a>。</p>
<blockquote>
<p>不同连接模式创建连接</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> List&lt;Connection&gt; createConnections(<span style="color:#fff;font-weight:bold">final</span> String dataSourceName, <span style="color:#fff;font-weight:bold">final</span> ConnectionMode connectionMode, <span style="color:#fff;font-weight:bold">final</span> DataSource dataSource, <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> connectionSize) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#ff0;font-weight:bold">1</span> == connectionSize) {
</span></span><span style="display:flex;"><span>        Connection connection = createConnection(dataSourceName, dataSource);
</span></span><span style="display:flex;"><span>        replayMethodsInvocation(connection);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> Collections.<span style="color:#007f7f">singletonList</span>(connection);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (ConnectionMode.<span style="color:#007f7f">CONNECTION_STRICTLY</span> == connectionMode) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> createConnections(dataSourceName, dataSource, connectionSize);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//内存限制模式加锁 一次性获取所有的连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">synchronized</span> (dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> createConnections(dataSourceName, dataSource, connectionSize);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>此外，结果集的内存合并和流式合并只在调用JDBC的executeQuery的情况下生效，<strong>如果使用execute方式进行查询，都是统一使用流式方式的查询。</strong></p>
<blockquote>
<p>查询结果归并对比</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.executor.PreparedStatementExecutor#executeQuery#101 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.shardingjdbc.executor.PreparedStatementExecutor#getQueryResult
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> QueryResult getQueryResult(<span style="color:#fff;font-weight:bold">final</span> Statement statement, <span style="color:#fff;font-weight:bold">final</span> ConnectionMode connectionMode) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    PreparedStatement preparedStatement = (PreparedStatement) statement;
</span></span><span style="display:flex;"><span>    ResultSet resultSet = preparedStatement.<span style="color:#007f7f">executeQuery</span>();
</span></span><span style="display:flex;"><span>    getResultSets().<span style="color:#007f7f">add</span>(resultSet);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//executeQuery 中根据连接模式选择流式/内存
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> ConnectionMode.<span style="color:#007f7f">MEMORY_STRICTLY</span> == connectionMode ? <span style="color:#fff;font-weight:bold">new</span> StreamQueryResult(resultSet) : <span style="color:#fff;font-weight:bold">new</span> MemoryQueryResult(resultSet);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//execute 单独调用getResultSet中只会使用流式合并
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#getResultSet#158
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#getQueryResults 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> List&lt;QueryResult&gt; getQueryResults(<span style="color:#fff;font-weight:bold">final</span> List&lt;ResultSet&gt; resultSets) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    List&lt;QueryResult&gt; result = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;(resultSets.<span style="color:#007f7f">size</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (ResultSet each : resultSets) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != each) {
</span></span><span style="display:flex;"><span>            result.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> StreamQueryResult(each));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>多条连接的执行方式分为串行和并行，在本地事务和XA事务中是串行的方式，其余情况是并行，具体的执行逻辑这里就不再展开了。</p>
<blockquote>
<p>isHoldTransaction</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> isHoldTransaction() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> (TransactionType.<span style="color:#007f7f">LOCAL</span> == transactionType &amp;&amp; !getAutoCommit()) || (TransactionType.<span style="color:#007f7f">XA</span> == transactionType &amp;&amp; isInShardingTransaction());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="总结-1">总结<a hidden class="anchor" aria-hidden="true" href="#总结-1">#</a></h3>
<p>执行引擎通过maxConnectionsSizePerQuery和同数据源的SQLUnit的数量大小确定连接模式，maxConnectionsSizePerQuery</p>
<p>=SQLUnit数量使用内存限制模式，当使用内存限制模式时会通过对数据源对象加锁来保证一次性获取本条SQL需要的连接而避免死锁。在使用executeQuery查询时，处理结果集时会根据连接模式选择流式或者内存合并，但使用execute方法查询，处理结果集只会使用流式合并。</p>
<h2 id="归并引擎">归并引擎<a hidden class="anchor" aria-hidden="true" href="#归并引擎">#</a></h2>
<h3 id="解析-3">解析<a hidden class="anchor" aria-hidden="true" href="#解析-3">#</a></h3>
<p>查询出的结果集需要经过归并引擎归并后才是最终的结果，归并的核心入口在MergeEntry的process方法中，优先处理分片场景的合并，再进行脱敏，只有读写分离的情况下则直接返回TransparentMergedResult，TransparentMergedResult实际上没做合并的额外处理，其内部实现都是完全调用queryResult的实现。</p>
<p><img loading="lazy" src="5.png" alt=""  />
</p>
<blockquote>
<p>归并逻辑入口</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#mergeQuery#190
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.merge.MergeEngine#merge#61
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.underlying.merge.MergeEntry#process
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> MergedResult process(<span style="color:#fff;font-weight:bold">final</span> List&lt;QueryResult&gt; queryResults, <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//分片合并
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Optional&lt;MergedResult&gt; mergedResult = merge(queryResults, sqlStatementContext);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//脱敏处理
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Optional&lt;MergedResult&gt; result = mergedResult.<span style="color:#007f7f">isPresent</span>() ? Optional.<span style="color:#007f7f">of</span>(decorate(mergedResult.<span style="color:#007f7f">get</span>(), sqlStatementContext)) : decorate(queryResults.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>), sqlStatementContext);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//只有读写分离的情况下，orElseGet会不存在，TransparentMergedResult
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> result.<span style="color:#007f7f">orElseGet</span>(() -&gt; <span style="color:#fff;font-weight:bold">new</span> TransparentMergedResult(queryResults.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>)));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>TransparentMergedResult</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> TransparentMergedResult <span style="color:#fff;font-weight:bold">implements</span> MergedResult {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> QueryResult queryResult;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> next() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> queryResult.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object getValue(<span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> columnIndex, <span style="color:#fff;font-weight:bold">final</span> Class&lt;?&gt; type) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> queryResult.<span style="color:#007f7f">getValue</span>(columnIndex, type);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object getCalendarValue(<span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> columnIndex, <span style="color:#fff;font-weight:bold">final</span> Class&lt;?&gt; type, <span style="color:#fff;font-weight:bold">final</span> Calendar calendar) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> queryResult.<span style="color:#007f7f">getCalendarValue</span>(columnIndex, type, calendar);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> InputStream getInputStream(<span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> columnIndex, <span style="color:#fff;font-weight:bold">final</span> String type) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> queryResult.<span style="color:#007f7f">getInputStream</span>(columnIndex, type);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> wasNull() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> queryResult.<span style="color:#007f7f">wasNull</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们只看分片相关的操作，ResultMergerEngine只有一个实现类ShardingResultMergerEngine，所以只有存在分片情况的时候，上文的第一个merge才会有结果。根据SQL类型的不同选择ResultMerger实现，查询类的合并是最常用也是最复杂的合并。</p>
<blockquote>
<p>MergeEntry.merge</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.merge.MergeEntry#merge
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> Optional&lt;MergedResult&gt; merge(<span style="color:#fff;font-weight:bold">final</span> List&lt;QueryResult&gt; queryResults, <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (Entry&lt;BaseRule, ResultProcessEngine&gt; entry : engines.<span style="color:#007f7f">entrySet</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (entry.<span style="color:#007f7f">getValue</span>() <span style="color:#fff;font-weight:bold">instanceof</span> ResultMergerEngine) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//选择不同类型的 resultMerger
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ResultMerger resultMerger = ((ResultMergerEngine) entry.<span style="color:#007f7f">getValue</span>()).<span style="color:#007f7f">newInstance</span>(databaseType, entry.<span style="color:#007f7f">getKey</span>(), properties, sqlStatementContext);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//归并
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> Optional.<span style="color:#007f7f">of</span>(resultMerger.<span style="color:#007f7f">merge</span>(queryResults, sqlStatementContext, schemaMetaData));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> Optional.<span style="color:#007f7f">empty</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.merge.ShardingResultMergerEngine#newInstance
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ResultMerger newInstance(<span style="color:#fff;font-weight:bold">final</span> DatabaseType databaseType, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties, <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (sqlStatementContext <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatementContext) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ShardingDQLResultMerger(databaseType);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (sqlStatementContext.<span style="color:#007f7f">getSqlStatement</span>() <span style="color:#fff;font-weight:bold">instanceof</span> DALStatement) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ShardingDALResultMerger(shardingRule);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> TransparentResultMerger();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ShardingDQLResultMerger的merge方法就是根据SQL解析结果中包含的token选择合适的归并方式（分组聚合、排序、遍历），归并后的mergedResult统一经过decorate方法进行判断是否需要分页归并，整体处理流程图可以概括如下。</p>
<blockquote>
<p>归并方式选择</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.merge.dql.ShardingDQLResultMerger#merge
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> MergedResult merge(<span style="color:#fff;font-weight:bold">final</span> List&lt;QueryResult&gt; queryResults, <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext, <span style="color:#fff;font-weight:bold">final</span> SchemaMetaData schemaMetaData) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#ff0;font-weight:bold">1</span> == queryResults.<span style="color:#007f7f">size</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> IteratorStreamMergedResult(queryResults);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Map&lt;String, Integer&gt; columnLabelIndexMap = getColumnLabelIndexMap(queryResults.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>));
</span></span><span style="display:flex;"><span>    SelectStatementContext selectStatementContext = (SelectStatementContext) sqlStatementContext;
</span></span><span style="display:flex;"><span>    selectStatementContext.<span style="color:#007f7f">setIndexes</span>(columnLabelIndexMap);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//分组聚合，排序，遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    MergedResult mergedResult = build(queryResults, selectStatementContext, columnLabelIndexMap, schemaMetaData);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//分页归并
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> decorate(queryResults, selectStatementContext, mergedResult);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.merge.dql.ShardingDQLResultMerger#build
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> MergedResult build(<span style="color:#fff;font-weight:bold">final</span> List&lt;QueryResult&gt; queryResults, <span style="color:#fff;font-weight:bold">final</span> SelectStatementContext selectStatementContext,
</span></span><span style="display:flex;"><span>                           <span style="color:#fff;font-weight:bold">final</span> Map&lt;String, Integer&gt; columnLabelIndexMap, <span style="color:#fff;font-weight:bold">final</span> SchemaMetaData schemaMetaData) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (isNeedProcessGroupBy(selectStatementContext)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//分组聚合归并
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> getGroupByMergedResult(queryResults, selectStatementContext, columnLabelIndexMap, schemaMetaData);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (isNeedProcessDistinctRow(selectStatementContext)) {
</span></span><span style="display:flex;"><span>        setGroupByForDistinctRow(selectStatementContext);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//分组聚合归并
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> getGroupByMergedResult(queryResults, selectStatementContext, columnLabelIndexMap, schemaMetaData);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (isNeedProcessOrderBy(selectStatementContext)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//排序归并
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> OrderByStreamMergedResult(queryResults, selectStatementContext, schemaMetaData);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//遍历归并
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> IteratorStreamMergedResult(queryResults);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.merge.dql.ShardingDQLResultMerger#decorate
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> MergedResult decorate(<span style="color:#fff;font-weight:bold">final</span> List&lt;QueryResult&gt; queryResults, <span style="color:#fff;font-weight:bold">final</span> SelectStatementContext selectStatementContext, <span style="color:#fff;font-weight:bold">final</span> MergedResult mergedResult) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    PaginationContext paginationContext = selectStatementContext.<span style="color:#007f7f">getPaginationContext</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!paginationContext.<span style="color:#007f7f">isHasPagination</span>() || <span style="color:#ff0;font-weight:bold">1</span> == queryResults.<span style="color:#007f7f">size</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mergedResult;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    String trunkDatabaseName = DatabaseTypes.<span style="color:#007f7f">getTrunkDatabaseType</span>(databaseType.<span style="color:#007f7f">getName</span>()).<span style="color:#007f7f">getName</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//根据数据库类型分页归并
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#0ff;font-weight:bold">&#34;MySQL&#34;</span>.<span style="color:#007f7f">equals</span>(trunkDatabaseName) || <span style="color:#0ff;font-weight:bold">&#34;PostgreSQL&#34;</span>.<span style="color:#007f7f">equals</span>(trunkDatabaseName)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> LimitDecoratorMergedResult(mergedResult, paginationContext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#0ff;font-weight:bold">&#34;Oracle&#34;</span>.<span style="color:#007f7f">equals</span>(trunkDatabaseName)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RowNumberDecoratorMergedResult(mergedResult, paginationContext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#0ff;font-weight:bold">&#34;SQLServer&#34;</span>.<span style="color:#007f7f">equals</span>(trunkDatabaseName)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> TopAndRowNumberDecoratorMergedResult(mergedResult, paginationContext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> mergedResult;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>每种归并方式的作用在<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/merge/">官方文档有比较详细的案例</a>，这里就不再重复介绍了。</p>
<h3 id="总结-2">总结<a hidden class="anchor" aria-hidden="true" href="#总结-2">#</a></h3>
<p>归并引擎是Sharding-JDBC执行SQL的最后一步，其作用是将多个数节点的结果集组合为一个正确的结果集返回，查询类的归并有<strong>分组归并、聚合归并、排序归并、遍历归并、分页归并</strong>五种，这五种归并方式并不是互斥的，而是相互组合的。</p>
<h1 id="定制研发">定制研发<a hidden class="anchor" aria-hidden="true" href="#定制研发">#</a></h1>
<p>在使用Sharding-JDBC过程中，我们发现了一些问题可以改进，比如存量系统数据量到达一定规模而需要分库分表引入Sharding-JDBC时，就会<strong>存在两大问题</strong>。</p>
<p><strong>一个是存量数据的迁移</strong>，这个问题我们可以通过分片算法兼容，前文已经提过分片键的值是不允许更改的，而且SQL如果不包含分片键，如果这个分片键对应的值是递增的（如id，时间等），我们可以设置一个阈值，在分片算法的doSharding中判断分片值与阈值的大小决定将数据路由至旧表或新表，避免数据迁移的麻烦。如果是根据用户id取模分表，而新增的数据无法只通过用户id判断，这时可以考虑采用复合分片算法，将用户id与订单id或者时间等递增的字段同时设置为分片键，根据订单id或时间判断是否是新数据，再根据用户id取模得到路由结果即可。</p>
<p>另一个是<strong>Sharding-JDBC</strong>语法限制会使得存量SQL面对巨大的改造压力，而实际上业务更关心的是需要分片的表，非分片的表不应该发生改动和影响。实际上，非分片表理论上无需通过解析、路由、重写、合并，为此我们在源码层面对这段逻辑进行了优化，支持跳过部分解析，完全跳过分片路由、重写和合并，尽可能减少Sharding-JDBC对非分片表的语法限制，来减少业务系统的改造压力与风险。</p>
<table>
<thead>
<tr>
<th>定制开发</th>
<th>背景问题</th>
<th>主要改造点</th>
</tr>
</thead>
<tbody>
<tr>
<td>批量update语法支持</td>
<td><foreach>标签的分片表批量updatei语句，无法正确解析路由，造成SQL执行结果不对</td>
<td>1.开发prepareBatch方法支持批量update语句的循环解析路由。2.ExecutionContext和iInputGroup兼容处理批量update的执行单元。</td>
</tr>
<tr>
<td>shardingCondition去重</td>
<td>or条件下可能会创建重复的shardingCondition,重复调用doSharding方法，造成性能浪费和方法内日志重复输出</td>
<td>1.ListRouteValue和RangeRouteValuei添加@EqualsAndHashCode<br />2.createShardingConditions:去重</td>
</tr>
<tr>
<td>配置动态生效</td>
<td>业务无法动态控制SQL打印，影响问题排查效率</td>
<td>TypedProperties支持配置动态刷新</td>
</tr>
<tr>
<td>组件封装(未涉及源码的改造)</td>
<td>业务需要重复开发与熟悉原生配置</td>
<td>1.提供了默认的数据源与连接池配置 2.简化分库分表配置 3.封装常用的分片算法（时间、业务字段值等） 4.统一的配置监听与动态修改(SQL打印、强制主从切换等)</td>
</tr>
<tr>
<td>强制路由主库</td>
<td>在从库延迟过高或故障时，无法动态将SQL切换至主库执行，影响业务正常运行</td>
<td>MasterSlaveRouteDecorator支持根据配置强制路由主库</td>
</tr>
<tr>
<td>全路由校验</td>
<td>未带分片键的SQL导致全路由却不会报错，开发测试不易发现，难以保证SQL改造彻底</td>
<td>ShardingConditions判空</td>
</tr>
<tr>
<td>跳过sharding语法限制</td>
<td>非分片表同样受sharding语法限制，业务改造成本和风险高</td>
<td>1.SQL表名判断 2.跳过解析、路由、改写、归并 3.手动创建执行单元</td>
</tr>
</tbody>
</table>
<h2 id="跳过sharding语法限制">跳过Sharding语法限制<a hidden class="anchor" aria-hidden="true" href="#跳过sharding语法限制">#</a></h2>
<p>Sharding-JDBC执行解析路由重写的逻辑都是在BasePrepareEngine中，最终构造ExecutionContext交由执行引擎执行，ExecutionContext中包含sqlStatementContext和executionUnits，非分片表不涉及路由改写，所以其ExecutionUnit我们非常容易手动构造，而查看SQLStatementContext的使用情况，我们发现SQLStatementContext只会影响结果集的合并而不会影响实际的执行，而不分片表也无需进行结果集的合并，整体实现思路如图。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sql中不含分片表---&gt;跳过解析路由---&gt;跳过改写，手动构造ExecutionUnit---&gt;执行---&gt;跳过结果合并
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ExecutionContext相关对象</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ExecutionContext {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;ExecutionUnit&gt; executionUnits = <span style="color:#fff;font-weight:bold">new</span> LinkedHashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ExecutionUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String dataSourceName;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SQLUnit sqlUnit;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SQLUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String sql;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>（1）校验SQL中是否包含分片表：**我们是通过正则将SQL中的各个单词分隔成Set，然后再遍历BaseRule判断是否存在分片表。大家可能会奇怪明明解析引擎可以帮我们解析出SQL中的表名，为什么还要自己来解析。因为我们测试的过程中发现，<strong>存量业务上的SQL很多在解析阶段就会报错，只能提前判断</strong>，当然这种判断方式并不严谨，比如 SELECT order_id FROM t_order_record WHERE order_id=1 AND remarks=&rsquo; t_order xxx&rsquo;;，配置的分片表t_order时就会存在误判，但这种场景在我们的业务中没有，所以暂时并没有处理。由于这个信息需要在多个对象方法中使用，为了避免修改大量的对象变量和方法入参，而又能方便的透传这个信息，判断的结果我们选择放在ThreadLocal里。</p>
<blockquote>
<p>RuleContextManager</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> RuleContextManager {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ThreadLocal&lt;RuleContextManager&gt; SKIP_CONTEXT_HOLDER = ThreadLocal.<span style="color:#007f7f">withInitial</span>(RuleContextManager::<span style="color:#fff;font-weight:bold">new</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 是否跳过sharding
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> skipSharding;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 是否路由至主库
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> masterRoute;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">boolean</span> isSkipSharding() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> SKIP_CONTEXT_HOLDER.<span style="color:#007f7f">get</span>().<span style="color:#007f7f">skipSharding</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setSkipSharding(<span style="color:#fff;font-weight:bold">boolean</span> skipSharding) {
</span></span><span style="display:flex;"><span>        SKIP_CONTEXT_HOLDER.<span style="color:#007f7f">get</span>().<span style="color:#007f7f">skipSharding</span> = skipSharding;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">boolean</span> isMasterRoute() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> SKIP_CONTEXT_HOLDER.<span style="color:#007f7f">get</span>().<span style="color:#007f7f">masterRoute</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setMasterRoute(<span style="color:#fff;font-weight:bold">boolean</span> masterRoute) {
</span></span><span style="display:flex;"><span>        SKIP_CONTEXT_HOLDER.<span style="color:#007f7f">get</span>().<span style="color:#007f7f">masterRoute</span> = masterRoute;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> clear(){
</span></span><span style="display:flex;"><span>        SKIP_CONTEXT_HOLDER.<span style="color:#007f7f">remove</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>判断SQL是否包含分片表</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#buildSkipContext
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// 判断是否可以跳过sharding,构造RuleContextManager的值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">void</span> buildSkipContext(<span style="color:#fff;font-weight:bold">final</span> String sql){
</span></span><span style="display:flex;"><span>    Set&lt;String&gt; sqlTokenSet = <span style="color:#fff;font-weight:bold">new</span> HashSet&lt;&gt;(Arrays.<span style="color:#007f7f">asList</span>(sql.<span style="color:#007f7f">split</span>(<span style="color:#0ff;font-weight:bold">&#34;[\\s]&#34;</span>)));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (CollectionUtils.<span style="color:#007f7f">isNotEmpty</span>(rules)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (BaseRule baseRule : rules) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//定制方法，ShardingRule实现，判断sqlTokenSet是否包含逻辑表即可
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span>(baseRule.<span style="color:#007f7f">hasContainShardingTable</span>(sqlTokenSet)){
</span></span><span style="display:flex;"><span>                RuleContextManager.<span style="color:#007f7f">setSkipSharding</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                RuleContextManager.<span style="color:#007f7f">setSkipSharding</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.core.rule.ShardingRule#hasContainShardingTable
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> Boolean hasContainShardingTable(Set&lt;String&gt; sqlTokenSet) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//logicTableNameList通过遍历TableRule可以得到
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (String logicTable : logicTableNameList) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (sqlTokenSet.<span style="color:#007f7f">contains</span>(logicTable)) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>**（2）跳过解析路由：**通过RuleContextManager中的skipSharding判断是否需要跳过Sharding解析路由，但为了兼容读写分离的场景，我们还需要知道这条SQL应该走主库还是从库，走主库的场景在后面强制路由主库部分有说明，SQL走主库实际上只有两种情况，一种是非SELECT语句，另一种就是SELECT语句带锁，如SELECT&hellip;FOR UPDATE，因此整体实现的步骤如下：</p>
<ul>
<li>
<p>如果标记了跳过Sharding且不为select语句，直接返回SkipShardingStatement，单独构造一个SkipShardingStatement的目的是为了能利用解析引擎中的缓存，缓存中不能放入null值。</p>
</li>
<li>
<p>如果是select语句需要继续解析，判断是否有锁后直接返回，避免后续解析造成语法不兼容，这里也曾尝试用反射获取lockClause来判断是否包含锁，但最终没有成功。</p>
</li>
<li>
<p>ShardingRouteDecorator根据</p>
<p>RuleContextManager.isSkipSharding判断是否跳过路由。</p>
</li>
</ul>
<blockquote>
<p>跳过解析路由</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SkipShardingStatement <span style="color:#fff;font-weight:bold">implements</span> SQLStatement{
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">int</span> getParameterCount() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sql.parser.SQLParserEngine#parse0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> SQLStatement parse0(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> useCache) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (useCache) {
</span></span><span style="display:flex;"><span>        Optional&lt;SQLStatement&gt; cachedSQLStatement = cache.<span style="color:#007f7f">getSQLStatement</span>(sql);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (cachedSQLStatement.<span style="color:#007f7f">isPresent</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> cachedSQLStatement.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ParseTree parseTree = <span style="color:#fff;font-weight:bold">new</span> SQLParserExecutor(databaseTypeName, sql).<span style="color:#007f7f">execute</span>().<span style="color:#007f7f">getRootNode</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * 跳过sharding 需要判断是否需要路由至主库 如果不是select语句直接跳过
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * 是select语句则需要通过继续解析判断是否有锁
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>    SQLStatement result ;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span>(RuleContextManager.<span style="color:#007f7f">isSkipSharding</span>()&amp;&amp;!VisitorRule.<span style="color:#007f7f">SELECT</span>.<span style="color:#007f7f">equals</span>(VisitorRule.<span style="color:#007f7f">valueOf</span>(parseTree.<span style="color:#007f7f">getClass</span>()))){
</span></span><span style="display:flex;"><span>        RuleContextManager.<span style="color:#007f7f">setMasterRoute</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        result = <span style="color:#fff;font-weight:bold">new</span> SkipShardingStatement();
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        result = (SQLStatement) ParseTreeVisitorFactory.<span style="color:#007f7f">newInstance</span>(databaseTypeName, VisitorRule.<span style="color:#007f7f">valueOf</span>(parseTree.<span style="color:#007f7f">getClass</span>())).<span style="color:#007f7f">visit</span>(parseTree);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (useCache) {
</span></span><span style="display:flex;"><span>        cache.<span style="color:#007f7f">put</span>(sql, result);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sql.parser.mysql.visitor.impl.MySQLDMLVisitor#visitSelectClause
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ASTNode visitSelectClause(<span style="color:#fff;font-weight:bold">final</span> SelectClauseContext ctx) {
</span></span><span style="display:flex;"><span>    SelectStatement result = <span style="color:#fff;font-weight:bold">new</span> SelectStatement();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 跳过sharding 只需要判断是否有锁来决定是否路由至主库即可
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(RuleContextManager.<span style="color:#007f7f">isSkipSharding</span>()){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != ctx.<span style="color:#007f7f">lockClause</span>()) {
</span></span><span style="display:flex;"><span>            result.<span style="color:#007f7f">setLock</span>((LockSegment) visit(ctx.<span style="color:#007f7f">lockClause</span>()));
</span></span><span style="display:flex;"><span>            RuleContextManager.<span style="color:#007f7f">setMasterRoute</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//...后续解析
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.underlying.route.DataNodeRouter#createRouteContext
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> RouteContext createRouteContext(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters, <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> useCache) {
</span></span><span style="display:flex;"><span>    SQLStatement sqlStatement = parserEngine.<span style="color:#007f7f">parse</span>(sql, useCache);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//如果需要跳过sharding 不进行后续的解析直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (RuleContextManager.<span style="color:#007f7f">isSkipSharding</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(sqlStatement, parameters, <span style="color:#fff;font-weight:bold">new</span> RouteResult());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//...解析
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sharding.route.engine.ShardingRouteDecorator#decorate
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> RouteContext decorate(<span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext, <span style="color:#fff;font-weight:bold">final</span> ShardingSphereMetaData metaData, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 跳过sharding路由
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(RuleContextManager.<span style="color:#007f7f">isSkipSharding</span>()){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> routeContext;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//...路由
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>**（3）手动构造ExecutionUnit：**ExecutionUnit中我们需要确定的内容就是datasourceName，这里我们认为跳过Sharding的SQL最终执行的库一定只有一个。如果只是跳过Sharding的情况，直接从元数据中获取数据源名称即可，如果存在读写分离的情况，主从路由的结果也一定是唯一的。创建完ExecutionUnit直接放入ExecutionContext返回即可，从而跳过后续的改写逻辑。</p>
<blockquote>
<p>手动构造ExecutionUnit</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ExecutionContext prepare(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters) {
</span></span><span style="display:flex;"><span>    List&lt;Object&gt; clonedParameters = cloneParameters(parameters);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 判断是否可以跳过sharding,构造RuleContextManager的值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    buildSkipContext(sql);  
</span></span><span style="display:flex;"><span>    RouteContext routeContext = executeRoute(sql, clonedParameters);
</span></span><span style="display:flex;"><span>    ExecutionContext result = <span style="color:#fff;font-weight:bold">new</span> ExecutionContext(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 跳过sharding的sql最后的路由结果一定只有一个库
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(RuleContextManager.<span style="color:#007f7f">isSkipSharding</span>()){
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">debug</span>(<span style="color:#0ff;font-weight:bold">&#34;可以跳过sharding的场景 {}&#34;</span>, sql);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(!Objects.<span style="color:#007f7f">isNull</span>(routeContext.<span style="color:#007f7f">getRouteResult</span>())){
</span></span><span style="display:flex;"><span>            Collection&lt;String&gt; allInstanceDataSourceNames = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">metaData</span>.<span style="color:#007f7f">getDataSources</span>().<span style="color:#007f7f">getAllInstanceDataSourceNames</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> routeUnitsSize = routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>().<span style="color:#007f7f">size</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">/*
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">             * 1. 没有读写分离的情况下  跳过sharding路由会导致routeUnitsSize为0 此时需要判断数据源数量是否为1
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">             * 2. 读写分离情况下 只会路由至具体的主库或从库 routeUnitsSize数量应该为1
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">             */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(!(routeUnitsSize == <span style="color:#ff0;font-weight:bold">0</span> &amp;&amp; allInstanceDataSourceNames.<span style="color:#007f7f">size</span>()==<span style="color:#ff0;font-weight:bold">1</span>)|| routeUnitsSize&gt;<span style="color:#ff0;font-weight:bold">1</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ShardingSphereException(<span style="color:#0ff;font-weight:bold">&#34;可以跳过sharding,但是路由结果不唯一,SQL= %s ,routeUnits= %s &#34;</span>,sql, routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getRouteUnits</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            Collection&lt;String&gt; actualDataSourceNames = routeContext.<span style="color:#007f7f">getRouteResult</span>().<span style="color:#007f7f">getActualDataSourceNames</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 手动创建执行单元
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String datasourceName = CollectionUtils.<span style="color:#007f7f">isEmpty</span>(actualDataSourceNames)? allInstanceDataSourceNames.<span style="color:#007f7f">iterator</span>().<span style="color:#007f7f">next</span>():actualDataSourceNames.<span style="color:#007f7f">iterator</span>().<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>            ExecutionUnit executionUnit = <span style="color:#fff;font-weight:bold">new</span> ExecutionUnit(datasourceName, <span style="color:#fff;font-weight:bold">new</span> SQLUnit(sql, clonedParameters));
</span></span><span style="display:flex;"><span>            result.<span style="color:#007f7f">getExecutionUnits</span>().<span style="color:#007f7f">add</span>(executionUnit);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//标记该结果需要跳过
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            result.<span style="color:#007f7f">setSkipShardingScenarioFlag</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        result.<span style="color:#007f7f">getExecutionUnits</span>().<span style="color:#007f7f">addAll</span>(executeRewrite(sql, clonedParameters, routeContext));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SHOW</span>)) {
</span></span><span style="display:flex;"><span>        SQLLogger.<span style="color:#007f7f">logSQL</span>(sql, properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SIMPLE</span>), result.<span style="color:#007f7f">getSqlStatementContext</span>(), result.<span style="color:#007f7f">getExecutionUnits</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>**（4）跳过合并：**跳过查询结果的合并和影响行数计算的合并，注意ShardingPreparedStatement和ShardingStatement都需要跳过</p>
<blockquote>
<p>跳过合并</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#executeQuery
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ResultSet executeQuery() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    ResultSet result;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        clearPrevious();
</span></span><span style="display:flex;"><span>        prepare();
</span></span><span style="display:flex;"><span>        initPreparedStatementExecutor();
</span></span><span style="display:flex;"><span>        List&lt;QueryResult&gt; queryResults = preparedStatementExecutor.<span style="color:#007f7f">executeQuery</span>();
</span></span><span style="display:flex;"><span>        List&lt;ResultSet&gt; resultSets = preparedStatementExecutor.<span style="color:#007f7f">getResultSets</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 定制开发，不分片跳过合并
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(executionContext.<span style="color:#007f7f">isSkipShardingScenarioFlag</span>()){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> CollectionUtils.<span style="color:#007f7f">isNotEmpty</span>(resultSets) ? resultSets.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>) : <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        MergedResult mergedResult = mergeQuery(queryResults);
</span></span><span style="display:flex;"><span>        result = <span style="color:#fff;font-weight:bold">new</span> ShardingResultSet(resultSets, mergedResult, <span style="color:#fff;font-weight:bold">this</span>, executionContext);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>        clearBatch();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    currentResultSet = result;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.jdbc.core.statement.ShardingPreparedStatement#getResultSet
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> ResultSet getResultSet() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">null</span> != currentResultSet) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> currentResultSet;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    List&lt;ResultSet&gt; resultSets = getResultSets();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 定制开发，不分片跳过合并
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(executionContext.<span style="color:#007f7f">isSkipShardingScenarioFlag</span>()){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> CollectionUtils.<span style="color:#007f7f">isNotEmpty</span>(resultSets) ? resultSets.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>) : <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (executionContext.<span style="color:#007f7f">getSqlStatementContext</span>() <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatementContext || executionContext.<span style="color:#007f7f">getSqlStatementContext</span>().<span style="color:#007f7f">getSqlStatement</span>() <span style="color:#fff;font-weight:bold">instanceof</span> DALStatement) {
</span></span><span style="display:flex;"><span>        MergedResult mergedResult = mergeQuery(getQueryResults(resultSets));
</span></span><span style="display:flex;"><span>        currentResultSet = <span style="color:#fff;font-weight:bold">new</span> ShardingResultSet(resultSets, mergedResult, <span style="color:#fff;font-weight:bold">this</span>, executionContext);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> currentResultSet;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">shardingsphere</span>.<span style="color:#007f7f">shardingjdbc</span>.<span style="color:#007f7f">jdbc</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">statement</span>.<span style="color:#007f7f">ShardingPreparedStatement</span><span style="color:#f00">#</span>isAccumulate
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> isAccumulate() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//定制开发，不分片跳过计算
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(executionContext.<span style="color:#007f7f">isSkipShardingScenarioFlag</span>()){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> !connection.<span style="color:#007f7f">getRuntimeContext</span>().<span style="color:#007f7f">getRule</span>().<span style="color:#007f7f">isAllBroadcastTables</span>(executionContext.<span style="color:#007f7f">getSqlStatementContext</span>().<span style="color:#007f7f">getTablesContext</span>().<span style="color:#007f7f">getTableNames</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>**（5）清空RuleContextManager：**查看一下Sharding-JDBC其他ThreadLocal的清空位置，对应的清空RuleContextManager就好。</p>
<blockquote>
<p>清空ThreadLocal</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.jdbc.adapter.AbstractConnectionAdapter#close
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">void</span> close() <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    closed = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>    MasterVisitedManager.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>    TransactionTypeHolder.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>    RuleContextManager.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> connectionSize = cachedConnections.<span style="color:#007f7f">size</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        forceExecuteTemplateForClose.<span style="color:#007f7f">execute</span>(cachedConnections.<span style="color:#007f7f">entries</span>(), cachedConnections -&gt; cachedConnections.<span style="color:#007f7f">getValue</span>().<span style="color:#007f7f">close</span>());
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>        cachedConnections.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>        rootInvokeHook.<span style="color:#007f7f">finish</span>(connectionSize);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>举个例子，比如Sharding-JDBC本身是不支持INSERT INTO tbl_name (col1, col2, …) SELECT col1, col2, … FROM tbl_name WHERE col3 = ?   这种语法的，会报空指针异常。</p>
<p><img loading="lazy" src="6.png" alt=""  />
</p>
<p>经过我们上述改造验证后，非分片表是可以跳过语法限制执行如下的SQL的。</p>
<p><img loading="lazy" src="7.png" alt=""  />
</p>
<p><strong>通过该功能的实现，业务可以更关注与分片表的SQL改造，而无需担心引入Sharding-JDBC造成所有SQL的验证改造，大幅减少改造成本和风险。</strong></p>
<h2 id="强制路由主库">强制路由主库<a hidden class="anchor" aria-hidden="true" href="#强制路由主库">#</a></h2>
<p>Sharding-JDBC可以通过配置主从库数据源方便的实现读写分离的功能，但使用读写分离就必须面对主从延迟和从库失联的痛点，针对这一问题，我们实现了强制路由主库的动态配置，当主从延迟过大或从库失联时，通过修改配置来实现SQL语句强制走主库的不停机路由切换。</p>
<p>后面会说明了配置的动态生效的实现方式，这里只说明强制路由主库的实现，我们直接使用前文的RuleContextManager即可，在主从路由引擎里判断下是否开启了强制主库路由。</p>
<blockquote>
<p>MasterSlaveRouteDecorator.decorate改造</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.masterslave.route.engine.MasterSlaveRouteDecorator#decorate
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> RouteContext decorate(<span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext, <span style="color:#fff;font-weight:bold">final</span> ShardingSphereMetaData metaData, <span style="color:#fff;font-weight:bold">final</span> MasterSlaveRule masterSlaveRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * 如果配置了强制主库 MasterVisitedManager设置为true
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * 后续isMasterRoute中会保证路由至主库
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span>(properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">MASTER_ROUTE_ONLY</span>)){
</span></span><span style="display:flex;"><span>        MasterVisitedManager.<span style="color:#007f7f">setMasterVisited</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//...路由逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> routeContext;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>为了兼容之前跳过Sharding的功能，我们需要同步修改下isMasterRoute方法，如果是跳过了Sharding路由需要通过RuleContextManager来判断是否走主库。</p>
<blockquote>
<p>isMasterRoute改造</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.masterslave.route.engine.impl.MasterSlaveDataSourceRouter#isMasterRoute
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> isMasterRoute(<span style="color:#fff;font-weight:bold">final</span> SQLStatement sqlStatement) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span>(sqlStatement <span style="color:#fff;font-weight:bold">instanceof</span> SkipShardingStatement){
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 优先以MasterVisitedManager中的值为准
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> MasterVisitedManager.<span style="color:#007f7f">isMasterVisited</span>()|| RuleContextManager.<span style="color:#007f7f">isMasterRoute</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> containsLockSegment(sqlStatement) || !(sqlStatement <span style="color:#fff;font-weight:bold">instanceof</span> SelectStatement) || MasterVisitedManager.<span style="color:#007f7f">isMasterVisited</span>() || HintManager.<span style="color:#007f7f">isMasterRouteOnly</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>当然，更理想的状况是通过监控主从同步延迟和数据库拨测，当超过阈值时或从库失联时直接自动修改配置中心的库，实现自动切换主库，减少业务故障时间和运维压力。</strong></p>
<h2 id="配置动态生效">配置动态生效<a hidden class="anchor" aria-hidden="true" href="#配置动态生效">#</a></h2>
<p>Sharding-JDBC中的ConfigurationPropertyKey中提供了许多配置属性，而Sharding-JDBCB并没有为这些配置提供在线修改的方法，而在实际的应用场景中，像SQL_SHOW这样控制SQL打印的开关配置，我们更希望能够在线修改配置值来控制SQL日志的打印，而不是修改完配置再重启服务。</p>
<p>以SQL打印为例，BasePrepareEngine中存在ConfigurationProperties对象，通过调用getValue方法来获取SQL_SHOW的值。</p>
<blockquote>
<p>SQL 打印</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#prepare
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Prepare to execute.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param sql SQL
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param parameters SQL parameters
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return execution context
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ExecutionContext prepare(<span style="color:#fff;font-weight:bold">final</span> String sql, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters) {
</span></span><span style="display:flex;"><span>    List&lt;Object&gt; clonedParameters = cloneParameters(parameters);
</span></span><span style="display:flex;"><span>    RouteContext routeContext = executeRoute(sql, clonedParameters);
</span></span><span style="display:flex;"><span>    ExecutionContext result = <span style="color:#fff;font-weight:bold">new</span> ExecutionContext(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>());
</span></span><span style="display:flex;"><span>    result.<span style="color:#007f7f">getExecutionUnits</span>().<span style="color:#007f7f">addAll</span>(executeRewrite(sql, clonedParameters, routeContext));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//sql打印
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SHOW</span>)) {
</span></span><span style="display:flex;"><span>        SQLLogger.<span style="color:#007f7f">logSQL</span>(sql, properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SIMPLE</span>), result.<span style="color:#007f7f">getSqlStatementContext</span>(), result.<span style="color:#007f7f">getExecutionUnits</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ConfigurationProperties继承了抽象类TypedProperties，其getValue方法就是根据key获取对应的配置值，因此我们直接在TypedProperties中实现刷新缓存中的配置值的方法。</p>
<blockquote>
<p>TypedProperties刷新配置</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">class</span> TypedProperties&lt;E <span style="color:#fff;font-weight:bold">extends</span> Enum &amp; TypedPropertyKey&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String LINE_SEPARATOR = System.<span style="color:#007f7f">getProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;line.separator&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Getter
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Properties props;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;E, TypedPropertyValue&gt; cache;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TypedProperties(<span style="color:#fff;font-weight:bold">final</span> Class&lt;E&gt; keyClass, <span style="color:#fff;font-weight:bold">final</span> Properties props) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">props</span> = props;
</span></span><span style="display:flex;"><span>        cache = preload(keyClass);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Map&lt;E, TypedPropertyValue&gt; preload(<span style="color:#fff;font-weight:bold">final</span> Class&lt;E&gt; keyClass) {
</span></span><span style="display:flex;"><span>        E[] enumConstants = keyClass.<span style="color:#007f7f">getEnumConstants</span>();
</span></span><span style="display:flex;"><span>        Map&lt;E, TypedPropertyValue&gt; result = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;(enumConstants.<span style="color:#007f7f">length</span>, <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>        Collection&lt;String&gt; errorMessages = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (E each : enumConstants) {
</span></span><span style="display:flex;"><span>            TypedPropertyValue value = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                value = <span style="color:#fff;font-weight:bold">new</span> TypedPropertyValue(each, props.<span style="color:#007f7f">getOrDefault</span>(each.<span style="color:#007f7f">getKey</span>(), each.<span style="color:#007f7f">getDefaultValue</span>()).<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (<span style="color:#fff;font-weight:bold">final</span> TypedPropertyValueException ex) {
</span></span><span style="display:flex;"><span>                errorMessages.<span style="color:#007f7f">add</span>(ex.<span style="color:#007f7f">getMessage</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            result.<span style="color:#007f7f">put</span>(each, value);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!errorMessages.<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ShardingSphereConfigurationException(Joiner.<span style="color:#007f7f">on</span>(LINE_SEPARATOR).<span style="color:#007f7f">join</span>(errorMessages));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Get property value.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param key property key
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param &lt;T&gt; class type of return value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return property value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @SuppressWarnings(<span style="color:#0ff;font-weight:bold">&#34;unchecked&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T getValue(<span style="color:#fff;font-weight:bold">final</span> E key) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> (T) cache.<span style="color:#007f7f">get</span>(key).<span style="color:#007f7f">getValue</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * vivo定制改造方法 refresh property value.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param key property key
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param value property value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return 更新配置是否成功
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> refreshValue(String key, String value){
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//获取配置类支持的配置项
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        E[] enumConstants = targetKeyClass.<span style="color:#007f7f">getEnumConstants</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (E each : enumConstants) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//遍历新的值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span>(each.<span style="color:#007f7f">getKey</span>().<span style="color:#007f7f">equals</span>(key)){
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//空白value认为无效,取默认值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#fff;font-weight:bold">if</span>(!StringUtils.<span style="color:#007f7f">isBlank</span>(value)){
</span></span><span style="display:flex;"><span>                        value = each.<span style="color:#007f7f">getDefaultValue</span>();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//构造新属性
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    TypedPropertyValue typedPropertyValue = <span style="color:#fff;font-weight:bold">new</span> TypedPropertyValue(each, value);
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//替换缓存
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    cache.<span style="color:#007f7f">put</span>(each, typedPropertyValue);
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//原始属性也替换下,有可能会通过RuntimeContext直接获取Properties
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    props.<span style="color:#007f7f">put</span>(key,value);
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">catch</span> (<span style="color:#fff;font-weight:bold">final</span> TypedPropertyValueException ex) {
</span></span><span style="display:flex;"><span>                    log.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;refreshValue error. key={} , value={}&#34;</span>, key, value, ex);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>实现了刷新方法后，我们还需要将该方法一步步暴露至一个外部可以调用的类中，以便在服务监听配置的方法中，能够调用这个刷新方法。ConfigurationProperties直接在</p>
<p>BasePrepareEngine的构造函数中传入，我们通过构造函数逐步反推最外层的这一对象调用来源，最终可以定位到在AbstractDataSourceAdapter中的getRuntimeContext()方法中可以获取到这个配置，而这个就是Sharding-JDBC实现的JDBC中Datasource接口的抽象类，我们直接在这个类中调用刚刚实现的refreshValue方法，剩下的就是监听配置，通过自己实现的</p>
<p>AbstractDataSourceAdapter来调用这个方法就好了。</p>
<p><img loading="lazy" src="8.png" alt=""  />
</p>
<p><strong>通过这一功能，我们可以方便的控制一些开关属性的在线修改，如SQL打印、强制路由主库等，业务无需重启服务即可做到配置的动态生效。</strong></p>
<h2 id="批量update语法支持">批量update语法支持<a hidden class="anchor" aria-hidden="true" href="#批量update语法支持">#</a></h2>
<p>业务中存在使用foreach标签来批量update的语句，这种SQL在Sharding-JDBC中无法被正确路由，只会路由第一组参数，后面的无法被路由改写，原因是解析引擎无法将语句拆分解析。</p>
<blockquote>
<p>批量update样例</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;update</span> <span style="color:#007f7f">id=</span><span style="color:#0ff;font-weight:bold">&#34;batchUpdate&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;foreach</span> <span style="color:#007f7f">collection=</span><span style="color:#0ff;font-weight:bold">&#34;orderList&#34;</span> <span style="color:#007f7f">item=</span><span style="color:#0ff;font-weight:bold">&#34;item&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        update t_order set
</span></span><span style="display:flex;"><span>        status = 1,
</span></span><span style="display:flex;"><span>        updated_by = #{item.updatedBy}
</span></span><span style="display:flex;"><span>        WHERE created_by = #{item.createdBy};
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/foreach&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/update&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们通过将批量update按照;拆分为多个语句，然后分别路由，最后手动汇总路有结果生成执行单元。</p>
<p>为了能正确重写SQL，批量update拆分后的语句需要完全一样，这样就不能使用动态拼接set条件，而是使用ifnull语法或者字段值不发生变化时也将原来的值放入set中，只不过set前后的值保持一致，整体思路与实现如下。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>根据分号拆分sql--&gt;根据sql总数对参数分组--&gt;循环解析路由改写sql--&gt;返回ExecutionContext
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>prepareBatch实现</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.underlying.pluggble.prepare.BasePrepareEngine#prepareBatch
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> ExecutionContext prepareBatch(List&lt;String&gt; splitSqlList, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; allParameters) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//SQL去重
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;String&gt; sqlList = splitSqlList.<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">distinct</span>().<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (sqlList.<span style="color:#007f7f">size</span>() &gt; <span style="color:#ff0;font-weight:bold">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ShardingSphereException(<span style="color:#0ff;font-weight:bold">&#34;不支持多条SQL,请检查SQL,&#34;</span> + sqlList.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//以第一条SQL为标准
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String sql = sqlList.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//所有的执行单元
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Collection&lt;ExecutionUnit&gt; globalExecutionUnitList = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//初始化最后的执行结果
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ExecutionContext executionContextResult = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//根据所有参数数量和SQL语句数量 计算每组参数的数量
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">int</span> eachSqlParameterCount = allParameters.<span style="color:#007f7f">size</span>() / splitSqlList.<span style="color:#007f7f">size</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//平均分配每条SQL的参数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;List&lt;Object&gt;&gt; eachSqlParameterListList = Lists.<span style="color:#007f7f">partition</span>(allParameters, eachSqlParameterCount);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (List&lt;Object&gt; eachSqlParameterList : eachSqlParameterListList) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//每条SQL参数不同 需要根据参数路由不同的结果  实际的SqlStatementContext 是一致的
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        RouteContext routeContext = executeRoute(sql, eachSqlParameterList);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//由于SQL一样  实际的SqlStatementContext 是一致的 只需初始化一次
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (executionContextResult == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            executionContextResult = <span style="color:#fff;font-weight:bold">new</span> ExecutionContext(routeContext.<span style="color:#007f7f">getSqlStatementContext</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        globalExecutionUnitList.<span style="color:#007f7f">addAll</span>(executeRewrite(sql, eachSqlParameterList, routeContext));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//排序打印日志
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    executionContextResult.<span style="color:#007f7f">getExtendMap</span>().<span style="color:#007f7f">put</span>(EXECUTION_UNIT_LIST, globalExecutionUnitList.<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">sorted</span>(Comparator.<span style="color:#007f7f">comparing</span>(ExecutionUnit::getDataSourceName)).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>()));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SHOW</span>)) {
</span></span><span style="display:flex;"><span>        SQLLogger.<span style="color:#007f7f">logSQL</span>(sql, properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">SQL_SIMPLE</span>),
</span></span><span style="display:flex;"><span>                         executionContextResult.<span style="color:#007f7f">getSqlStatementContext</span>(), (Collection&lt;ExecutionUnit&gt;) executionContextResult.<span style="color:#007f7f">getExtendMap</span>().<span style="color:#007f7f">get</span>(EXECUTION_UNIT_LIST));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> executionContextResult;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里我们在ExecutionContext单独构造了一个了ExtendMap来存放ExecutionUnit，原因是ExecutionContext中的executionUnits是HashSet，而判断ExecutionUnit中的SqlUnit只会根据SQL去重，批量update的SQL是一致的，但parameters不同，为了不影响原有的逻辑，单独使用了另外的变量来存放。</p>
<blockquote>
<p>ExecutionContext改造</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ExecutionContext {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Collection&lt;ExecutionUnit&gt; executionUnits = <span style="color:#fff;font-weight:bold">new</span> LinkedHashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 自定义扩展变量
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Map&lt;ExtendEnum,Object&gt; extendMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 定制扩展，是否可以跳过分片逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Setter
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> skipShardingScenarioFlag = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span>@EqualsAndHashCode
</span></span><span style="display:flex;"><span>@ToString
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ExecutionUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String dataSourceName;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SQLUnit sqlUnit;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@AllArgsConstructor
</span></span><span style="display:flex;"><span>@RequiredArgsConstructor
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span>@Setter
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//根据SQL判断是否相等
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@EqualsAndHashCode(of = { <span style="color:#0ff;font-weight:bold">&#34;sql&#34;</span> })
</span></span><span style="display:flex;"><span>@ToString
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SQLUnit {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String sql;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们还需要改造下执行方法，在初始化执行器的时候，判断下ExtendMap中存在我们自定义的EXECUTION_UNIT_LIST是否存在，存在则使用生成InputGroup，同一个数据源下的ExecutionUnit会被放入同一个InputGroup中。</p>
<blockquote>
<p>InputGroup改造</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.shardingjdbc.executor.PreparedStatementExecutor#init
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init(<span style="color:#fff;font-weight:bold">final</span> ExecutionContext executionContext) <span style="color:#fff;font-weight:bold">throws</span> SQLException {
</span></span><span style="display:flex;"><span>    setSqlStatementContext(executionContext.<span style="color:#007f7f">getSqlStatementContext</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//兼容批量update 分库分表后同一张表的情况 判断是否存在EXECUTION_UNIT_LIST 存在则使用未去重的List进行后续的操作
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (MapUtils.<span style="color:#007f7f">isNotEmpty</span>(executionContext.<span style="color:#007f7f">getExtendMap</span>())){
</span></span><span style="display:flex;"><span>        Collection&lt;ExecutionUnit&gt; executionUnitCollection = (Collection&lt;ExecutionUnit&gt;) executionContext.<span style="color:#007f7f">getExtendMap</span>().<span style="color:#007f7f">get</span>(EXECUTION_UNIT_LIST);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(CollectionUtils.<span style="color:#007f7f">isNotEmpty</span>(executionUnitCollection)){
</span></span><span style="display:flex;"><span>            getInputGroups().<span style="color:#007f7f">addAll</span>(obtainExecuteGroups(executionUnitCollection));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        getInputGroups().<span style="color:#007f7f">addAll</span>(obtainExecuteGroups(executionContext.<span style="color:#007f7f">getExecutionUnits</span>()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cacheStatements();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>改造完成后，批量update中的每条SQL都可以被正确路由执行。</p>
<h2 id="shardingcondition去重">ShardingCondition去重<a hidden class="anchor" aria-hidden="true" href="#shardingcondition去重">#</a></h2>
<p>当where语句包括多个or条件时，而or条件不包含分片键时，会造成createShardingConditions方法生成重复的分片条件，导致重复调用doSharding方法。如这种SQL，</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> * <span style="color:#fff;font-weight:bold">FROM</span> t_order
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> created_by = ?
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">and</span> (  (status = ?) <span style="color:#fff;font-weight:bold">or</span>  (status = ?) <span style="color:#fff;font-weight:bold">or</span>  (status = ?) )
</span></span></code></pre></td></tr></table>
</div>
</div><p>存在三个or条件，分片键是created_by ，实际产生的shardingCondition会是三个一样的值，并会调用三次doSharding的方法。虽然实际执行还是只有一次（批量update那里说明过执行单元会去重），但为了减少方法的重复调用，我们还是对这里做了一次去重。</p>
<p><img loading="lazy" src="9.png" alt=""  />
</p>
<p><img loading="lazy" src="10.png" alt=""  />
</p>
<p>去重的方法也比较简单粗暴，我们对ListRouteValue和RangeRouteValue添加了@EqualsAndHashCode注解，然后在WhereClauseShardingConditionEngine的createShardingConditions方法返回最终结果前加一次去重，从而避免生成重复的shardingCondition造成doSharding方法的重复调用。</p>
<blockquote>
<p>createShardingConditions去重</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//org.apache.shardingsphere.sharding.route.engine.condition.engine.WhereClauseShardingConditionEngine#createShardingConditions
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> Collection&lt;ShardingCondition&gt; createShardingConditions(<span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext, <span style="color:#fff;font-weight:bold">final</span> Collection&lt;AndPredicate&gt; andPredicates, <span style="color:#fff;font-weight:bold">final</span> List&lt;Object&gt; parameters) {
</span></span><span style="display:flex;"><span>    Collection&lt;ShardingCondition&gt; result = <span style="color:#fff;font-weight:bold">new</span> LinkedList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (AndPredicate each : andPredicates) {
</span></span><span style="display:flex;"><span>        Map&lt;Column, Collection&lt;RouteValue&gt;&gt; routeValueMap = createRouteValueMap(sqlStatementContext, each, parameters);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (routeValueMap.<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> Collections.<span style="color:#007f7f">emptyList</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        result.<span style="color:#007f7f">add</span>(createShardingCondition(routeValueMap));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//去重
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Collection&lt;ShardingCondition&gt; distinctResult = result.<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">distinct</span>().<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toCollection</span>(LinkedList::<span style="color:#fff;font-weight:bold">new</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> distinctResult;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="全路由校验">全路由校验<a hidden class="anchor" aria-hidden="true" href="#全路由校验">#</a></h2>
<p>分片表的SQL中如果没有携带分片键（或者带上了分片键结果没有被正确解析）将会导致全路由，产生性能问题，而这种SQL并不会报错，这就导致在实际的业务改造中，开发和测试很难保证百分百改造彻底。为此，我们在源码层面对这种情况做了额外的校验，当产生全路由，也就是ShardingConditions为空时，主动抛出异常，从而方便开发和测试能够快速发现全路由SQL。</p>
<p>实现方式也比较简单，校验下ShardingConditions是否为空即可，只不过需要额外兼容下Hint策略ShardingConditions始终为空的特殊情况。</p>
<blockquote>
<p>全路由校验</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// org.apache.shardingsphere.sharding.route.engine.ShardingRouteDecorator#decorate
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> RouteContext decorate(<span style="color:#fff;font-weight:bold">final</span> RouteContext routeContext, <span style="color:#fff;font-weight:bold">final</span> ShardingSphereMetaData metaData, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule, <span style="color:#fff;font-weight:bold">final</span> ConfigurationProperties properties) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//省略...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">//获取 ShardingConditions
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ShardingConditions shardingConditions = getShardingConditions(parameters, sqlStatementContext, metaData.<span style="color:#007f7f">getSchema</span>(), shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> hintAlgorithm = isHintAlgorithm(sqlStatementContext, shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//判断是否允许全路由
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (!properties.&lt;Boolean&gt;getValue(ConfigurationPropertyKey.<span style="color:#007f7f">ALLOW_EMPTY_SHARDING_CONDITIONS</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//如果不是Hint算法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(!isHintAlgorithm(sqlStatementContext, shardingRule)){
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">/** 如果是DML语句  则可能有两种情况 这两种情况是根据getShardingConditions方法的内部逻辑而来的
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                 *  一种是非插入语句  shardingConditions.getConditions()为空即可
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                 *  一种是插入语句 插入语句shardingConditions.getConditions()不会为空  但是ShardingCondition的routeValues是空的
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">                 */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (sqlStatementContext.<span style="color:#007f7f">getSqlStatement</span>() <span style="color:#fff;font-weight:bold">instanceof</span> DMLStatement) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span>(shardingConditions.<span style="color:#007f7f">getConditions</span>().<span style="color:#007f7f">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ShardingSphereException(<span style="color:#0ff;font-weight:bold">&#34;SQL不包含分库分表键,请检查SQL&#34;</span>);
</span></span><span style="display:flex;"><span>                }<span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (sqlStatementContext <span style="color:#fff;font-weight:bold">instanceof</span> InsertStatementContext) {
</span></span><span style="display:flex;"><span>                        List&lt;ShardingCondition&gt; routeValuesNotEmpty = shardingConditions.<span style="color:#007f7f">getConditions</span>().<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">filter</span>(r -&gt; CollectionUtils.<span style="color:#007f7f">isNotEmpty</span>(r.<span style="color:#007f7f">getRouteValues</span>())).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">if</span>(CollectionUtils.<span style="color:#007f7f">isEmpty</span>(routeValuesNotEmpty)){
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ShardingSphereException(<span style="color:#0ff;font-weight:bold">&#34;SQL不包含分库分表键,请检查SQL&#34;</span>);
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> needMergeShardingValues = isNeedMergeShardingValues(sqlStatementContext, shardingRule);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//省略...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> RouteContext(sqlStatementContext, parameters, routeResult);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> isHintAlgorithm(<span style="color:#fff;font-weight:bold">final</span> SQLStatementContext sqlStatementContext, <span style="color:#fff;font-weight:bold">final</span> ShardingRule shardingRule) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 场景a 全局默认策略是否使用强制路由策略
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span>(shardingRule.<span style="color:#007f7f">getDefaultDatabaseShardingStrategy</span>() <span style="color:#fff;font-weight:bold">instanceof</span> HintShardingStrategy
</span></span><span style="display:flex;"><span>       || shardingRule.<span style="color:#007f7f">getDefaultTableShardingStrategy</span>() <span style="color:#fff;font-weight:bold">instanceof</span> HintShardingStrategy){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (String each : sqlStatementContext.<span style="color:#007f7f">getTablesContext</span>().<span style="color:#007f7f">getTableNames</span>()) {
</span></span><span style="display:flex;"><span>        Optional&lt;TableRule&gt; tableRule = shardingRule.<span style="color:#007f7f">findTableRule</span>(each);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//场景b 指定表是否使用强制路由策略
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (tableRule.<span style="color:#007f7f">isPresent</span>() &amp;&amp; (shardingRule.<span style="color:#007f7f">getDatabaseShardingStrategy</span>(tableRule.<span style="color:#007f7f">get</span>()) <span style="color:#fff;font-weight:bold">instanceof</span> HintShardingStrategy
</span></span><span style="display:flex;"><span>                                      || shardingRule.<span style="color:#007f7f">getTableShardingStrategy</span>(tableRule.<span style="color:#007f7f">get</span>()) <span style="color:#fff;font-weight:bold">instanceof</span> HintShardingStrategy)) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>当然这块功能也可以在完善些，比如对分片路由结果中的数据源数量进行校验，从而避免跨库操作，我们这边没有实现也就不再赘述了。</p>
<h2 id="组件封装">组件封装<a hidden class="anchor" aria-hidden="true" href="#组件封装">#</a></h2>
<p>业务接入Sharding-JDBC的步骤是一样的，都需要通过Java创建数据源和配置对象或者使用SpringBoot进行配置，存在一定的熟悉成本和重复开发的问题，为此我们也对定制开发版本的Sharding-JDBC封装了一个公共组件，从而简化业务配置，减少重复开发，提升业务的开发效率，具体功能可见下。这块没有涉及源码的改造，只是在定制版本上包装的一个公共组件。</p>
<ul>
<li>提供了默认的数据源与连接池配置</li>
<li>简化分库分表配置，业务配置逻辑表名和后缀，组件拼装行表达式和actual-data-nodes</li>
<li>封装常用的分片算法（时间、业务字段值等），</li>
<li>统一的配置监听与动态修改（SQL打印、强制主从切换等）</li>
</ul>
<blockquote>
<p>开源Sharding-JDBC配置</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#f00">//数据源名称</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.names</span>=<span style="color:#0ff;font-weight:bold">ds0,ds1</span>
</span></span><span style="display:flex;"><span><span style="color:#f00">//ds0配置</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds0.type</span>=<span style="color:#0ff;font-weight:bold">org.apache.commons.dbcp.BasicDataSource</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds0.driver-class-name</span>=<span style="color:#0ff;font-weight:bold">com.mysql.jdbc.Driver</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds0.url</span>=<span style="color:#0ff;font-weight:bold">jdbc:mysql://localhost:3306/ds0</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds0.username</span>=<span style="color:#0ff;font-weight:bold">root</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds0.password</span>=
</span></span><span style="display:flex;"><span><span style="color:#f00">//ds1配置</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds1.type</span>=<span style="color:#0ff;font-weight:bold">org.apache.commons.dbcp.BasicDataSource</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds1.driver-class-name</span>=<span style="color:#0ff;font-weight:bold">com.mysql.jdbc.Driver</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds1.url</span>=<span style="color:#0ff;font-weight:bold">jdbc:mysql://localhost:3306/ds1</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds1.username</span>=<span style="color:#0ff;font-weight:bold">root</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.datasource.ds1.password</span>=
</span></span><span style="display:flex;"><span><span style="color:#f00">//分表规则</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order.actual-data-nodes</span>=<span style="color:#0ff;font-weight:bold">ds$-&gt;{0..1}.t_order$-&gt;{0..1}</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.sharding-column</span>=<span style="color:#0ff;font-weight:bold">order_id</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.algorithm-expression</span>=<span style="color:#0ff;font-weight:bold">t_order$-&gt;{order_id % 2}</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order_item.actual-data-nodes</span>=<span style="color:#0ff;font-weight:bold">ds$-&gt;{0..1}.t_order_item$-&gt;{0..1}</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order_item.table-strategy.inline.sharding-column</span>=<span style="color:#0ff;font-weight:bold">order_id</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.tables.t_order_item.table-strategy.inline.algorithm-expression</span>=<span style="color:#0ff;font-weight:bold">t_order_item$-&gt;{order_id % 2}</span>
</span></span><span style="display:flex;"><span><span style="color:#f00">//默认分库规则</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column</span>=<span style="color:#0ff;font-weight:bold">user_id</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression</span>=<span style="color:#0ff;font-weight:bold">ds$-&gt;{user_id % 2}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>组件简化配置</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#f00">//数据源名称</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.names</span> = <span style="color:#0ff;font-weight:bold">ds0,ds1</span>
</span></span><span style="display:flex;"><span><span style="color:#f00">//ds0配置</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds0.url</span> = <span style="color:#0ff;font-weight:bold">jdbc:mysql://localhost:3306/ds1</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds0.username</span> = <span style="color:#0ff;font-weight:bold">root</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds0.password</span> =
</span></span><span style="display:flex;"><span><span style="color:#f00">//ds1配置</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds1.url</span> = <span style="color:#0ff;font-weight:bold">jdbc:mysql://localhost:3306/ds1</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds1.username</span> = <span style="color:#0ff;font-weight:bold">root</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.datasource.ds1.password</span> =
</span></span><span style="display:flex;"><span><span style="color:#f00">//分表规则</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.table.rule.config</span> = <span style="color:#0ff;font-weight:bold">[{&#34;logicTable&#34;:&#34;t_order,t_order_item&#34;,&#34;tableRange&#34;:&#34;0..1&#34;,&#34;shardingColumn&#34;:&#34;order_id &#34;,&#34;algorithmExpression&#34;:&#34;order_id %2&#34;}]</span>
</span></span><span style="display:flex;"><span><span style="color:#f00">//默认分库规则</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">vivo.it.sharding.default.db.rule.config</span> = <span style="color:#0ff;font-weight:bold">{&#34;shardingColumn&#34;:&#34;user_id&#34;,&#34;algorithmExpression&#34;:&#34;user_id %2&#34;}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="使用建议">使用建议<a hidden class="anchor" aria-hidden="true" href="#使用建议">#</a></h1>
<p>结合官方文档和业务实践经验，我们也梳理了部分使用Sharding-JDBC的建议供大家参考，实际具体如何优化SQL写法（比如子查询、分页、分组排序等）还需要结合业务的实际场景来进行测试和调优。</p>
<p><strong>（1）强制</strong></p>
<p><strong>强制①：涉及分片表的SQL必须携带分片键</strong></p>
<p>原因：无分片键会导致全路由，存在严重的性能隐患</p>
<p><strong>强制②：禁止一条SQL中的分片值路由至不同的库</strong></p>
<p>原因：跨库操作存在严重的性能隐患，事务操作会升级为分布式事务，增加业务复杂度</p>
<p><strong>强制③：禁止对分片键使用运算表达式或函数操作</strong></p>
<p>原因：无法提前计算表达式和函数获取分片值，导致全路由</p>
<p>说明：<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/use-norms/sql/">详见官方文档</a></p>
<p><img loading="lazy" src="11.png" alt="图片"  />
</p>
<p><strong>强制④：禁止在子查询中使用分片表</strong></p>
<p>原因：无法正常解析子查询中的分片表，导致业务错误</p>
<p>说明：虽然<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/use-norms/sql/">官方文档中说有限支持子查询 </a>，但在实际的使用中发现4.1.1并不支持子查询，可见官方<a href="https://github.com/apache/shardingsphere/issues/6164">issue6164 </a>| <a href="https://github.com/apache/shardingsphere/issues/6228">issue 6228</a>。</p>
<p><img loading="lazy" src="12.png" alt="图片"  />
</p>
<p><strong>建议⑤：包含CASE WHEN、HAVING、UNION (ALL)语法的分片SQL，不支持路由至多数据节点</strong></p>
<p>说明：<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/use-norms/sql/">详见官方文档</a></p>
<p><strong>（2）建议</strong></p>
<p><strong>① 建议使用分布式id来保证分片表主键的全局唯一性</strong></p>
<p>原因：方便判断数据的唯一性和后续的迁移扩容</p>
<p>说明：<a href="https://mp.weixin.qq.com/s?__biz=MzI4NjY4MTU5Nw==&amp;mid=2247496863&amp;idx=1&amp;sn=5aa18659b98346517ddeda80e42baf2a&amp;scene=21#wechat_redirect">详见文章《vivo 自研鲁班分布式 ID 服务实践》</a></p>
<p><strong>② 建议跨多表的分组SQL的分组字段与排序字段保证一致</strong></p>
<p>原因：分组和排序字段不一致只能通过内存合并，大数据量时存在性能隐患</p>
<p>说明：<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/principle/merge/">详见官方文档</a></p>
<p><strong>③ 建议通过全局递增的分布式id来优化分页查询</strong></p>
<p>原因：Sharding-JDBC的分页优化侧重于结果集的流式合并来避免内存爆涨，但深度分页自身的性能问题并不能解决</p>
<p>说明：<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/sharding/use-norms/pagination/">详见官方文档</a></p>
<h1 id="总结-3">总结<a hidden class="anchor" aria-hidden="true" href="#总结-3">#</a></h1>
<p>本文结合个人理解梳理了各个引擎的源码入口和关键逻辑，读者可以结合本文和官方文档更好的定位理解Sharding-JDBC的源码实现。<strong>定制开发的目的是为了降低业务接入成本</strong>，尽可能减少业务存量SQL的改造，部分改造思想其实与官方社区也存在差异，比如跳过语法解析，官方社区致力于通过优化解析引擎来适配各种语法，而不是跳过解析阶段，可参考官方<a href="https://github.com/apache/shardingsphere/issues/4806">issue</a>。源码分析和定制改造只涉及了Sharding-JDBC的数据分片和读写分离功能，定制开发的功能也在生产环境经过了考验，如有不足和优化建议，也欢迎大家批评指正。</p>
<h1 id="一些问题">一些问题<a hidden class="anchor" aria-hidden="true" href="#一些问题">#</a></h1>
<h2 id="不支持的关键字">不支持的关键字<a hidden class="anchor" aria-hidden="true" href="#不支持的关键字">#</a></h2>
<p>DISTINCT
CASE WHEN
union
union all
having</p>
<h2 id="不支持的写法">不支持的写法<a hidden class="anchor" aria-hidden="true" href="#不支持的写法">#</a></h2>
<ul>
<li>每条INSERT语句只能插入一条数据，不支持VALUES后有多行数据的语句</li>
<li>特殊insert<code>insert select() ...</code></li>
<li>分表的表，不支持子查询</li>
<li>多条件表连接，如left join table_a on a.id = b.id and a.user_id = b.user_id
这时会报错：
<code>io.shardingjdbc.core.parsing.parser.exception.SQLParsingException: SQL syntax error, expected token is ‘EQ’, actual token is ‘INT’, literals is ‘1’</code></li>
</ul>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>