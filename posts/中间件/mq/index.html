<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>MQ | Wjy&#39;s Blog</title>
<meta name="keywords" content="中间件">
<meta name="description" content="概述
什么是消息队列
消息队列(Message queue)是一种进程间通信或同一进程的不同线程间的通信方式，软件的贮列用来处理一系列的输入，通常来自用户。消息队列提供了异步的通信协议，每一个贮列中的记录包含详细说明的数据，包含发生的时间，输入设备的种类，以及特定的输入参数。也就是说：消息的发送者和接收者不需要同时与消息队列互交。消息会保存在队列中，直到接收者取回它。 &ndash;维基百科">
<meta name="author" content="Me, You">
<link rel="canonical" href="http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/mq/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="MQ" />
<meta property="og:description" content="概述
什么是消息队列
消息队列(Message queue)是一种进程间通信或同一进程的不同线程间的通信方式，软件的贮列用来处理一系列的输入，通常来自用户。消息队列提供了异步的通信协议，每一个贮列中的记录包含详细说明的数据，包含发生的时间，输入设备的种类，以及特定的输入参数。也就是说：消息的发送者和接收者不需要同时与消息队列互交。消息会保存在队列中，直到接收者取回它。 &ndash;维基百科" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/mq/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-06T14:51:55+00:00" />
<meta property="article:modified_time" content="2020-03-06T14:51:55+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MQ"/>
<meta name="twitter:description" content="概述
什么是消息队列
消息队列(Message queue)是一种进程间通信或同一进程的不同线程间的通信方式，软件的贮列用来处理一系列的输入，通常来自用户。消息队列提供了异步的通信协议，每一个贮列中的记录包含详细说明的数据，包含发生的时间，输入设备的种类，以及特定的输入参数。也就是说：消息的发送者和接收者不需要同时与消息队列互交。消息会保存在队列中，直到接收者取回它。 &ndash;维基百科"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "MQ",
      "item": "http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/mq/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MQ",
  "name": "MQ",
  "description": "概述 什么是消息队列 消息队列(Message queue)是一种进程间通信或同一进程的不同线程间的通信方式，软件的贮列用来处理一系列的输入，通常来自用户。消息队列提供了异步的通信协议，每一个贮列中的记录包含详细说明的数据，包含发生的时间，输入设备的种类，以及特定的输入参数。也就是说：消息的发送者和接收者不需要同时与消息队列互交。消息会保存在队列中，直到接收者取回它。 \u0026ndash;维基百科\n",
  "keywords": [
    "中间件"
  ],
  "articleBody": "概述 什么是消息队列 消息队列(Message queue)是一种进程间通信或同一进程的不同线程间的通信方式，软件的贮列用来处理一系列的输入，通常来自用户。消息队列提供了异步的通信协议，每一个贮列中的记录包含详细说明的数据，包含发生的时间，输入设备的种类，以及特定的输入参数。也就是说：消息的发送者和接收者不需要同时与消息队列互交。消息会保存在队列中，直到接收者取回它。 –维基百科\n最简单的模型： Producer--send--\u003eBorker--Receive--\u003eConsumer\nProducer：消息生产者，负责生产和发送消息到Broker； Broker：消息处理中心，负责消息存储、确认、重试等，一般其中会包含多个queue； Consumer：消息的消费者，负责从Broker中获取消息，并进行相应处理。 特性 异步性：将耗时的同步操作，通过发送消息的方式，进行了异步处理，减少了同步等待的时间。 松耦合：减少了服务之间的耦合性，不同的服务可以通过消息队列进行通信，从而不关心彼此的实现细节，只要定义好消息的格式就行。 分布式：通过对消费者的横向扩展，降低了消息队列阻塞的风险，以及单个消费者产生单点故障的可能性(消息队列本身也可以做成分布式请求) 可靠性：消息队列一般会把接收到的消息存储到本地硬盘上(当消息被处理完后，根据不同的消息队列实现，可能删除)，这样即使消息队列挂掉或消息队列本身挂掉，消息也能重新加载。 为什么使用消息队列 消息队列中间件是分布式系统中重要的组件，主要解决应用解耦，异步消息，流量削锋等问题，实现高性能，高可用，可伸缩和最终一致性架构。目前使用较多的消息队列有ActiveMQ，RabbitMQ，ZeroMQ，Kafka，MetaMQ，RocketMQ。在高并发环境下，由于来不及同步处理，请求往往会发生堵塞，如大量的insert、update请求同时到达mysql，直接导致无数的行锁表锁，甚至最后请求会堆积过多，从而触发too many connections错误。通过使用消息队列，可以异步处理请求，从而缓解系统压力。\nMQ使用场景 异步处理：高并发场景，使用MQ的异步特性 消息通讯：进程间通讯和系统间的消息通知，如在分布式系统中 应用解耦：公司中有许多团队，每个团队负责不同的模块，各个模块可以使用MQ来通信 流量削峰 异步处理 场景说明：用户注册后，需要发注册邮件和注册短信。传统的做法有两种 1.串行 2.并行 1.串行：将注册信息写入数据库成功后，发送注册邮件，再发送注册短信。以上三个任务全部完成后，返回给客户端。 2.并行：将注册信息写入数据库成功后，发送注册邮件的同时，发送注册短信。以上三个任务完成后，返回给客户端。与串行的差别是，并行的方式可以加快处理的速度 假设三个业务节点每个使用50毫秒钟，不考虑网络等其他开销，则串行方式的时间是150毫秒，并行的时间可能是100毫秒。因为CPU在单位时间内处理的请求数是一定的，假设CPU1秒内吞吐量是100次。则串行方式1秒内CPU可处理的请求量是7次（1000/150）。并行方式处理的请求量是10次（1000/100）小结：综上所述，传统的方式系统的性能（并发量，吞吐量，响应时间）会有瓶颈。如何解决这个问题呢？\n3.引入消息队列，将不是必须的业务逻辑，异步处理。改造后的架构如下： 按照以上约定，用户的响应时间相当于是注册信息写入数据库的时间，也就是50毫秒。注册邮件，发送短信写入消息队列后，直接返回，因为写入消息队列的速度很快，基本可以忽略，因此用户的响应时间可能是50毫秒。架构改变后，系统的吞吐量提高到每秒20 QPS。比串行提高了3倍，比并行提高了两倍。\n应用解耦 场景说明：用户下单后，订单系统需要通知库存系统。传统的做法是，订单系统调用库存系统的接口。如下图： 传统模式的缺点：假如库存系统无法访问，则订单减库存将失败，从而导致订单失败，订单系统与库存系统耦合。 如何解决以上问题呢？引入应用消息队列后的方案，如下图： 订单系统：用户下单后，订单系统完成持久化处理，将消息写入消息队列，返回用户订单下单成功 库存系统：订阅下单的消息，采用拉/推的方式，获取下单信息，库存系统根据下单信息，进行库存操作。 假如：在下单时库存系统不能正常使用。也不影响正常下单，因为下单后，订单系统写入消息队列就不再关心其他的后续操作了，实现订单系统与库存系统的应用解耦。\n流量削峰 流量削锋也是消息队列中的常用场景，一般在秒杀或团抢活动中使用广泛。 应用场景：秒杀活动，一般会因为流量过大，导致流量暴增，应用挂掉。为解决这个问题，一般需要在应用前端加入消息队列。 a、可以控制活动的人数 b、可以缓解短时间内高流量压垮应用 用户的请求，服务器接收后，首先写入消息队列。假如消息队列长度超过最大数量，则直接抛弃用户请求或跳转到错误页面。秒杀业务根据消息队列中的请求信息，再做后续处理。\n日志处理 日志处理是指将消息队列用在日志处理中，比如Kafka的应用，解决大量日志传输的问题。架构简化如下： 日志采集客户端：负责日志数据采集，定时写受写入Kafka队列。 Kafka消息队列：负责日志数据的接收，存储和转发。 日志处理应用：订阅并消费kafka队列中的日志数据 。\n消息通讯 消息通讯是指，消息队列一般都内置了高效的通信机制，因此也可以用在纯的消息通讯。比如实现点对点消息队列，或者聊天室等。\n点对点通讯： 客户端A和客户端B使用同一队列，进行消息通讯。\n聊天室通讯： 客户端A，客户端B，客户端N订阅同一主题，进行消息发布和接收。实现类似聊天室效果。 以上实际是消息队列的两种消息模式，点对点或发布订阅模式。模型为示意图，供参考。\nMQ使用示例 电商系统 消息队列采用高可用，可持久化的消息中间件。比如Active MQ，Rabbit MQ，Rocket Mq。 （1）应用将主干逻辑处理完成后，写入消息队列。消息发送是否成功可以开启消息的确认模式。（消息队列返回消息接收成功状态后，应用再返回，这样保障消息的完整性） （2）扩展流程（发短信，配送处理）订阅队列消息。采用推或拉的方式获取消息并处理。 （3）消息将应用解耦的同时，带来了数据一致性问题，可以采用最终一致性方式解决。比如主数据写入数据库，扩展应用根据消息队列，并结合数据库方式实现基于消息队列的后续处理。\n日志收集系统 分为Zookeeper注册中心，日志收集客户端，Kafka集群和Storm集群（OtherApp）四部分组成。 Zookeeper注册中心，提出负载均衡和地址查找服务 日志收集客户端，用于采集应用系统的日志，并将数据推送到kafka队列 Kafka集群：接收，路由，存储，转发等消息处理 Storm集群：与OtherApp处于同一级别，采用拉的方式消费队列中的数据\nJMS 讲消息队列就不得不提JMS。JMS（JAVA Message Service，java消息服务）API是一个消息服务的标准/规范，允许应用程序组件基于JavaEE平台创建、发送、接收和读取消息。它使分布式通信耦合度更低，消息服务更加可靠以及异步性。在EJB架构中，有消息bean可以无缝的与JM消息服务集成。在J2EE架构模式中，有消息服务者模式，用于实现消息与应用直接的解耦。\n消息模型 在JMS标准中，有两种消息模型P2P（Point to Point）、Publish/Subscribe(Pub/Sub)\nP2P P2P模式包含三个角色：消息队列（Queue），发送者(Sender)，接收者(Receiver)。每个消息都被发送到 一个特定的队列，接收者从队列中获取消息。队列保留着消息，直到他们被消费或超时。\nP2P的特点：\n每个消息只有一个消费者（Consumer）(即一旦被消费，消息就不再在消息队列中) 发送者和接收者之间在时间上没有依赖性，也就是说当发送者发送了消息之后，不管接收者有没有正在运行，它不会影响到消息被发送到队列 接收者在成功接收消息之后需向队列应答成功 如果希望发送的每个消息都会被成功处理的话，那么需要P2P模式。 Pub/Sub模式 包含三个角色主题（Topic），发布者（Publisher），订阅者（Subscriber） 多个发布者将消息发送到Topic，系统将这些消息传递给多个订阅者。\nPub/Sub的特点\n每个消息可以有多个消费者 发布者和订阅者之间有时间上的依赖性。针对某个主题（Topic）的订阅者，它必须创建一个订阅者之后，才能消费发布者的消息 为了消费消息，订阅者必须保持运行的状态 为了缓和这样严格的时间相关性，JMS允许订阅者创建一个可持久化的订阅。这样，即使订阅者没有被激活（运行），它也能接收到发布者的消息。 如果希望发送的消息可以不被做任何处理、或者只被一个消息者处理、或者可以被多个消费者处理的话，那么可以采用Pub/Sub模型。 消息消费 在JMS中，消息的产生和消费都是异步的。对于消费来说，JMS的消息者可以通过两种方式来消费消息。\n同步 订阅者或接收者通过receive方法来接收消息，receive方法在接收到消息之前（或超时之前）将一直阻塞；\n异步 订阅者或接收者可以注册为一个消息监听器。当消息到达之后，系统自动调用监听器的onMessage方法。\nJNDI：Java命名和目录接口，是一种标准的Java命名系统接口。可以在网络上查找和访问服务。通过指定一个资源名称，该名称对应于数据库或命名服务中的一个记录，同时返回资源连接建立所必须的信息。JNDI在JMS中起到查找和访问发送目标或消息来源的作用。\n常用的消息队列 Kafka、rocketmq、activemq、rabbitmq，对比社区活跃度、吞吐量、可靠性、时效性等，选择rocketmq和Kafka。\nKafka Kafka是最初由Linkedin公司开发，是一个分布式、分区的、多副本的、多订阅者，基于zookeeper协调的分布式日志系统（也可以当做MQ系统），常见可以用于web/nginx日志、访问日志，消息服务等等，Linkedin于2010年贡献给了Apache基金会并成为顶级开源项目。\n主要应用场景是：日志收集系统和消息系统。\nKafka主要设计目标如下：\n以时间复杂度为O(1)的方式提供消息持久化能力，即使对TB级以上数据也能保证常数时间的访问性能。 高吞吐率。即使在非常廉价的商用机器上也能做到单机支持每秒100K条消息的传输。 支持Kafka Server间的消息分区，及分布式消费，同时保证每个partition内的消息顺序传输。 同时支持离线数据处理和实时数据处理。 Scale out:支持在线水平扩展 kafka参考 RocketMQ RocketMQ官方文档 官方开发指南\n开源版和商用版 RocketMQ有一个开源的（就是github上的），一个商用的（通过阿里云购买使用）。二者区别： 开源版本RocketMQ仅支持定时Level，从1秒到2小时，共18个级别，不能自定义。商用MQ支持毫秒级别的延时时间。 参考\n基本概念 消息模型（Message Model） RocketMQ主要由 Producer、Broker、Consumer 三部分组成，其中Producer 负责生产消息，Consumer 负责消费消息，Broker 负责存储消息。Broker 在实际部署过程中对应一台服务器，每个 Broker 可以存储多个Topic的消息，每个Topic的消息也可以分片存储于不同的 Broker。Message Queue 用于存储消息的物理地址，每个Topic中的消息地址存储于多个 Message Queue 中。ConsumerGroup 由多个Consumer 实例构成。\n消息生产者（Producer） 负责生产消息，一般由业务系统负责生产消息。一个消息生产者会把业务应用系统里产生的消息发送到broker服务器。RocketMQ提供多种发送方式，同步发送、异步发送、顺序发送、单向发送。同步和异步方式均需要Broker返回确认信息，单向发送不需要。\n消息消费者（Consumer） 负责消费消息，一般是后台系统负责异步消费。一个消息消费者会从Broker服务器拉取消息、并将其提供给应用程序。从用户应用的角度而言提供了两种消费形式：拉取式消费、推动式消费。\n主题（Topic） 表示一类消息的集合，是一种消息的逻辑分类，每个主题包含若干条消息，每条消息只能属于一个主题，是RocketMQ进行消息订阅的基本单位。\n代理服务器（Broker Server） 消息中转角色，负责存储消息、转发消息。代理服务器在RocketMQ系统中负责接收从生产者发送来的消息并存储、同时为消费者的拉取请求作准备。代理服务器也存储消息相关的元数据，包括消费者组、消费进度偏移和主题和队列消息等。\n名字服务（Name Server） 名称服务充当路由消息的提供者。生产者或消费者能够通过名字服务查找各主题相应的Broker IP列表。多个Namesrv实例组成集群，但相互独立，没有信息交换。\n拉取式消费（Pull Consumer） Consumer消费的一种类型，应用通常主动调用Consumer的拉消息方法从Broker服务器拉消息、主动权由应用控制。一旦获取了批量消息，应用就会启动消费过程。\n推动式消费（Push Consumer） Consumer消费的一种类型，该模式下Broker收到数据后会主动推送给消费端，该消费模式一般实时性较高。\n生产者组（Producer Group） 同一类Producer的集合，这类Producer发送同一类消息且发送逻辑一致。如果发送的是事务消息且原始生产者在发送之后崩溃，则Broker服务器会联系同一生产者组的其他生产者实例以提交或回溯消费。\n消费者组（Consumer Group） 同一类Consumer的集合，这类Consumer通常消费同一类消息且消费逻辑一致。消费者组使得在消息消费方面，实现负载均衡和容错的目标变得非常容易。要注意的是，消费者组的消费者实例必须订阅完全相同的Topic。 RocketMQ 支持两种消息模式：集群消费（Clustering）和广播消费（Broadcasting）。\n集群消费（Clustering） 集群消费模式下,相同Consumer Group的每个Consumer实例平均分摊消息。\n广播消费（Broadcasting） 广播消费模式下，相同Consumer Group的每个Consumer实例都接收全量的消息。\n普通顺序消息（Normal Ordered Message） 普通顺序消费模式下，消费者通过同一个消费队列收到的消息是有顺序的，不同消息队列收到的消息则可能是无顺序的。\n严格顺序消息（Strictly Ordered Message） 严格顺序消息模式下，消费者收到的所有消息均是有顺序的。\n消息（Message） 消息系统所传输信息的物理载体，生产和消费数据的最小单位，每条消息必须属于一个主题。RocketMQ中每个消息拥有唯一的Message ID，且可以携带具有业务标识的Key。系统提供了通过Message ID和Key查询消息的功能。\n标签（Tag） 为消息设置的标志，用于同一主题下区分不同类型的消息。来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。标签能够有效地保持代码的清晰度和连贯性，并优化RocketMQ提供的查询系统。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性。\n特性(features) 介绍RocketMQ实现的功能特性。\n架构 介绍RocketMQ部署架构和技术架构\n设计 介绍RocketMQ关键机制的设计原理\n安装 官网安装教程 source release是源代码，需要编译打包才能运行。 binary release是编译好的，可以直接运行。\nlinux安装，参考官网。\nwindows安装，推荐下载binary release。\n将下载好的文件解压到理想位置。\n添加系统环境变量。 ROCKETMQ_HOME=\"D:\\你的解压位置\" NAMESRV_ADDR=\"localhost:9876\" 环境变量配置完成，必须重启电脑。\n启动name server 通过git bush，cd到安装目录的bin目录下，执行命令 ./mqnamesrv.cmd 看到The Name Server boot success. serializeType=JSON，证明启动成功，这个窗口不要关。 如果启动报错：错误: 找不到或无法加载主类。 那应该是jdk的安装路径有问题，默认的安装路径：C:\\Program Files\\Java\\jdk-12 Program Files 这个文件夹中带有空格，会影响mq的启动。 需要把JDK安装到没有空格的路径。 直接将Java文件夹（里面有jdk和jre）剪切到D盘根目录，然后修改系统环境变量 JAVA_HOME\n启动broker ./mqbroker.cmd -n localhost:9876 autoCreateTopicEnable=true 如上的 ip+port 是NameServer的进程，因为Nameser安装启动在本地，所以这里的 ip 是 localhost。 运行如上命令，可能会报如下错误：找不到或无法加载主类。 如果出此情况，找到bin目录下的runbroker.cmd，给%CLASSPATH%加上双引号，\"%CLASSPATH%\"\n再次执行启动命令，看到 The broker[DESKTOP-U0510U3, 192.168.2.156:10911] boot success. serializeType=JSON and name server is localhost:9876 证明broker启动成功。\n代码示例 引入依赖\n1 2 3 4 5 org.apache.rocketmq rocketmq-client 4.8.0 注意依赖版本一定要和前面安装的程序版本一致。\n最基本示例 Consumer\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 package com.wjy.rocketmq.consumer; import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer; import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext; import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus; import org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently; import org.apache.rocketmq.client.exception.MQClientException; import org.apache.rocketmq.common.message.MessageExt; import java.util.List; /** * 消费者 */ public class Consumer { public static void main(String[] args) throws Exception { startConsumer(); } public static void startConsumer() throws Exception{ // 实例化消费者 DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(\"please_rename_unique_group_name\"); // 设置NameServer的地址 consumer.setNamesrvAddr(\"localhost:9876\"); // 订阅一个或者多个Topic，以及Tag来过滤需要消费的消息 consumer.subscribe(\"TopicTest\", \"*\"); // 注册回调实现类来处理从broker拉取回来的消息 consumer.registerMessageListener(new MessageListenerConcurrently() { @Override public ConsumeConcurrentlyStatus consumeMessage(List msgs, ConsumeConcurrentlyContext context) { System.out.printf(\"%s Receive New Messages: %s %n\", Thread.currentThread().getName(), msgs); // 标记该消息已经被成功消费 return ConsumeConcurrentlyStatus.CONSUME_SUCCESS; } }); // 启动消费者实例 consumer.start(); System.out.printf(\"Consumer Started.%n\"); } } 运行main方法，就启动了Consumer。\nProducer\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package com.wjy.rocketmq.producer; import org.apache.rocketmq.client.producer.DefaultMQProducer; import org.apache.rocketmq.client.producer.SendResult; import org.apache.rocketmq.common.message.Message; import org.apache.rocketmq.remoting.common.RemotingHelper; /** * 发送同步消息 * 这种可靠性同步地发送方式使用的比较广泛，比如：重要的消息通知，短信通知。 */ public class SyncProducer { public static void main(String[] args) throws Exception { send(); } public static void send() throws Exception { // 实例化消息生产者Producer DefaultMQProducer producer = new DefaultMQProducer(\"please_rename_unique_group_name\"); // 设置NameServer的地址 producer.setNamesrvAddr(\"localhost:9876\"); // 启动Producer实例 producer.start(); for (int i = 0; i \u003c 100; i++) { // 创建消息，并指定Topic，Tag和消息体 Message msg = new Message(\"TopicTest\" /* Topic */, \"TagA\" /* Tag */, (\"Hello RocketMQ \" + i).getBytes(RemotingHelper.DEFAULT_CHARSET) /* Message body */ ); // 发送消息到一个Broker SendResult sendResult = producer.send(msg); // 通过sendResult返回消息是否成功送达 System.out.printf(\"%s%n\", sendResult); } // 如果不再发送消息，关闭Producer实例。 producer.shutdown(); } } 通过main方法运行Producer，然后可以在Consumer 控制台查看收到的消息。\n整合spring boot 生产者和消费者放到一个模块里是没问题的。\n生产者配置\n1 2 3 4 5 6 7 8 9 10 11 12 # 是否开启自动配置 rocketmq.producer.isOnOff=on # 发送同一类消息设置为同一个group，保证唯一默认不需要设置，rocketmq会使用ip@pid（pid代表jvm名字）作为唯一标识 rocketmq.producer.groupName=spring-application-api # mq的nameserver地址 rocketmq.producer.namesrvAddr=127.0.0.1:9876 # 消息最大长度 默认 1024 * 4 (4M) rocketmq.producer.maxMessageSize = 4096 # 发送消息超时时间，默认 3000 rocketmq.producer.sendMsgTimeOut=3000 # 发送消息失败重试次数，默认2 rocketmq.producer.retryTimesWhenSendFailed=2 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 @Slf4j @Configuration public class MQProducerConfigure { @Value(\"${rocketmq.producer.groupName}\") private String groupName; @Value(\"${rocketmq.producer.namesrvAddr}\") private String namesrvAddr; @Value(\"${rocketmq.producer.maxMessageSize}\") private Integer maxMessageSize; @Value(\"${rocketmq.producer.sendMsgTimeOut}\") private Integer sendMsgTimeOut; @Value(\"${rocketmq.producer.retryTimesWhenSendFailed}\") private Integer retryTimesWhenSendFailed; /** * mq 生成者配置 * @return * @throws MQClientException */ @Bean public DefaultMQProducer defaultProducer() throws MQClientException { log.info(\"defaultProducer 正在创建---------------------------------------\"); DefaultMQProducer producer = new DefaultMQProducer(groupName); producer.setNamesrvAddr(namesrvAddr); producer.setVipChannelEnabled(false); producer.setMaxMessageSize(maxMessageSize); producer.setSendMsgTimeout(sendMsgTimeOut); producer.setRetryTimesWhenSendAsyncFailed(retryTimesWhenSendFailed); producer.start(); log.info(\"rocketmq producer server 开启成功----------------------------------\"); return producer; } } 消费者配置\n1 2 3 4 5 6 7 8 9 10 11 12 13 # 是否开启自动配置 rocketmq.consumer.isOnOff=on # 发送同一类消息设置为同一个group，保证唯一默认不需要设置，rocketmq会使用ip@pid（pid代表jvm名字）作为唯一标识 rocketmq.consumer.groupName=spring-application-pay # mq的nameserver地址 rocketmq.consumer.namesrvAddr=127.0.0.1:9876 # 消费者订阅的主题topic和tags（*标识订阅该主题下所有的tags），格式: topic~tag1||tag2||tags3; rocketmq.consumer.topics=TestTopic~*; # 消费者线程数据量 rocketmq.consumer.consumeThreadMin=5 rocketmq.consumer.consumeThreadMax=32 # 设置一次消费信心的条数，默认1 rocketmq.consumer.consumeMessageBatchMaxSize=1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 @Slf4j @Configuration public class MQConsumerConfigure { @Value(\"${rocketmq.consumer.groupName}\") private String groupName; @Value(\"${rocketmq.consumer.namesrvAddr}\") private String namesrvAddr; @Value(\"${rocketmq.consumer.topics}\") private String topics; @Value(\"${rocketmq.consumer.consumeThreadMin}\") private Integer consumeThreadMin; @Value(\"${rocketmq.consumer.consumeThreadMax}\") private Integer consumeThreadMax; @Value(\"${rocketmq.consumer.consumeMessageBatchMaxSize}\") private Integer consumeMessageBatchMaxSize; @Autowired private MQConsumeMsgListenerProcessor consumeMsgListenerProcessor; /** * mq 消费者配置 * @return * @throws MQClientException */ @Bean public DefaultMQPushConsumer defaultConsumer() throws MQClientException { log.info(\"defaultConsumer 正在创建---------------------------------------\"); DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(groupName); consumer.setNamesrvAddr(namesrvAddr); consumer.setConsumeThreadMin(consumeThreadMin); consumer.setConsumeThreadMax(consumeThreadMax); consumer.setConsumeMessageBatchMaxSize(consumeMessageBatchMaxSize); // 设置监听，处理业务逻辑 consumer.registerMessageListener(consumeMsgListenerProcessor); /** * 设置consumer第一次启动是从队列头部开始还是队列尾部开始 * 如果不是第一次启动，那么按照上次消费的位置继续消费 */ consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET); /** * 设置消费模型，集群还是广播，默认为集群 */ // consumer.setMessageModel(MessageModel.CLUSTERING); try { // 设置该消费者订阅的主题和tag，如果订阅该主题下的所有tag，则使用*, String[] topicArr = topics.split(\";\"); for (String tag : topicArr) { String[] tagArr = tag.split(\"~\"); consumer.subscribe(tagArr[0], tagArr[1]); } consumer.start(); log.info(\"consumer 创建成功 groupName={}, topics={}, namesrvAddr={}\",groupName,topics,namesrvAddr); } catch (MQClientException e) { log.error(\"consumer 创建失败!\"); } return consumer; } } 消费者监听\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 /** * 处理业务逻辑 */ @Slf4j @Component public class MQConsumeMsgListenerProcessor implements MessageListenerConcurrently { @Resource private OrdersMapper ordersMapper; @Resource private StudyCardMapper studyCardMapper; @Resource private StudyCardBatchMapper studyCardBatchMapper; /** * 默认msg里只有一条消息，可以通过设置consumeMessageBatchMaxSize参数来批量接收消息 * 不要抛异常，如果没有return CONSUME_SUCCESS ，consumer会重新消费该消息，直到return CONSUME_SUCCESS * @param msgList * @param consumeConcurrentlyContext * @return */ @Override public ConsumeConcurrentlyStatus consumeMessage(List msgList, ConsumeConcurrentlyContext consumeConcurrentlyContext) { if (CollectionUtils.isEmpty(msgList)) { log.info(\"MQ接收消息为空，直接返回成功\"); return ConsumeConcurrentlyStatus.CONSUME_SUCCESS; } MessageExt messageExt = msgList.get(0); log.info(\"MQ接收到的消息为：\" + messageExt.toString()); try { String topic = messageExt.getTopic(); String tags = messageExt.getTags(); String body = new String(messageExt.getBody(), \"utf-8\"); log.info(\"MQ消息topic={}, tags={}, 消息内容={}\", topic,tags,body); // TODO 处理业务逻辑，取消订单等操作 } catch (Exception e) { log.error(\"获取MQ消息内容异常{}\",e); } return ConsumeConcurrentlyStatus.CONSUME_SUCCESS; } } 找到合适的位置，发送mq消息\n1 2 @Autowired private DefaultMQProducer defaultMQProducer; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 try { log.info(\"发送MQ消息内容：\" + orderNo); Message sendMsg = new Message(\"TestTopic\", \"TestTag\", orderNo.getBytes()); //设置延时队列，无法自定义时间，有1-18，共18个等级 sendMsg.setDelayTimeLevel(4); SendResult sendResult = defaultMQProducer.send(sendMsg); log.info(\"消息发送响应：\" + sendResult.toString()); } catch (MQClientException e) { e.printStackTrace(); } catch (RemotingException e) { e.printStackTrace(); } catch (MQBrokerException e) { e.printStackTrace(); } catch (InterruptedException e) { e.printStackTrace(); } 官方代码示例 官方示例\n修改延时级别 RocketMQ自带的延时级别： 1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h 从1秒到2小时，这可能不满足我们的业务需求，我们可以修改这个配置。\n找到broker.conf，位置在 D:\\install\\rocketmq-4.9.2\\conf\\broker.conf\n在最后一行增加配置 messageDelayLevel=11s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h 将级别1设置成了11秒延时。然后重启broker（需要指定配置文件） windows：./mqbroker.cmd -n localhost:9876 autoCreateTopicEnable=true -c../conf/broker.conf linux：nohup sh mqbroker -n localhost:9876 -c ../conf/broker.conf \u0026\n测试成功。\n",
  "wordCount" : "9134",
  "inLanguage": "en",
  "datePublished": "2020-03-06T14:51:55Z",
  "dateModified": "2020-03-06T14:51:55Z",
  "author":[{
    "@type": "Person",
    "name": "Me"
  }, {
    "@type": "Person",
    "name": "You"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6/mq/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title">
      MQ
    </h1>
    <div class="post-meta"><span title='2020-03-06 14:51:55 +0000 UTC'>2020-03-06</span>&nbsp;·&nbsp;Me, You

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%a6%82%e8%bf%b0" aria-label="概述">概述</a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97" aria-label="什么是消息队列">什么是消息队列</a></li>
                <li>
                    <a href="#%e7%89%b9%e6%80%a7" aria-label="特性">特性</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%bd%bf%e7%94%a8%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97" aria-label="为什么使用消息队列">为什么使用消息队列</a></li>
                <li>
                    <a href="#mq%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af" aria-label="MQ使用场景">MQ使用场景</a><ul>
                        
                <li>
                    <a href="#%e5%bc%82%e6%ad%a5%e5%a4%84%e7%90%86" aria-label="异步处理">异步处理</a></li>
                <li>
                    <a href="#%e5%ba%94%e7%94%a8%e8%a7%a3%e8%80%a6" aria-label="应用解耦">应用解耦</a></li>
                <li>
                    <a href="#%e6%b5%81%e9%87%8f%e5%89%8a%e5%b3%b0" aria-label="流量削峰">流量削峰</a></li>
                <li>
                    <a href="#%e6%97%a5%e5%bf%97%e5%a4%84%e7%90%86" aria-label="日志处理">日志处理</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e9%80%9a%e8%ae%af" aria-label="消息通讯">消息通讯</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#mq%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b" aria-label="MQ使用示例">MQ使用示例</a><ul>
                        
                <li>
                    <a href="#%e7%94%b5%e5%95%86%e7%b3%bb%e7%bb%9f" aria-label="电商系统">电商系统</a></li>
                <li>
                    <a href="#%e6%97%a5%e5%bf%97%e6%94%b6%e9%9b%86%e7%b3%bb%e7%bb%9f" aria-label="日志收集系统">日志收集系统</a></li></ul>
                </li>
                <li>
                    <a href="#jms" aria-label="JMS">JMS</a><ul>
                        
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e6%a8%a1%e5%9e%8b" aria-label="消息模型">消息模型</a><ul>
                        
                <li>
                    <a href="#p2p" aria-label="P2P">P2P</a></li>
                <li>
                    <a href="#pubsub%e6%a8%a1%e5%bc%8f" aria-label="Pub/Sub模式">Pub/Sub模式</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e6%b6%88%e8%b4%b9" aria-label="消息消费">消息消费</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b8%b8%e7%94%a8%e7%9a%84%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97" aria-label="常用的消息队列">常用的消息队列</a><ul>
                        
                <li>
                    <a href="#kafka" aria-label="Kafka">Kafka</a></li></ul>
                </li>
                <li>
                    <a href="#rocketmq" aria-label="RocketMQ">RocketMQ</a><ul>
                        
                <li>
                    <a href="#%e5%bc%80%e6%ba%90%e7%89%88%e5%92%8c%e5%95%86%e7%94%a8%e7%89%88" aria-label="开源版和商用版">开源版和商用版</a></li>
                <li>
                    <a href="#%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" aria-label="基本概念">基本概念</a><ul>
                        
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e6%a8%a1%e5%9e%8bmessage-model" aria-label="消息模型（Message Model）">消息模型（Message Model）</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e7%94%9f%e4%ba%a7%e8%80%85producer" aria-label="消息生产者（Producer）">消息生产者（Producer）</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e6%b6%88%e8%b4%b9%e8%80%85consumer" aria-label="消息消费者（Consumer）">消息消费者（Consumer）</a></li>
                <li>
                    <a href="#%e4%b8%bb%e9%a2%98topic" aria-label="主题（Topic）">主题（Topic）</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%90%86%e6%9c%8d%e5%8a%a1%e5%99%a8broker-server" aria-label="代理服务器（Broker Server）">代理服务器（Broker Server）</a></li>
                <li>
                    <a href="#%e5%90%8d%e5%ad%97%e6%9c%8d%e5%8a%a1name-server" aria-label="名字服务（Name Server）">名字服务（Name Server）</a></li>
                <li>
                    <a href="#%e6%8b%89%e5%8f%96%e5%bc%8f%e6%b6%88%e8%b4%b9pull-consumer" aria-label="拉取式消费（Pull Consumer）">拉取式消费（Pull Consumer）</a></li>
                <li>
                    <a href="#%e6%8e%a8%e5%8a%a8%e5%bc%8f%e6%b6%88%e8%b4%b9push-consumer" aria-label="推动式消费（Push Consumer）">推动式消费（Push Consumer）</a></li>
                <li>
                    <a href="#%e7%94%9f%e4%ba%a7%e8%80%85%e7%bb%84producer-group" aria-label="生产者组（Producer Group）">生产者组（Producer Group）</a></li>
                <li>
                    <a href="#%e6%b6%88%e8%b4%b9%e8%80%85%e7%bb%84consumer-group" aria-label="消费者组（Consumer Group）">消费者组（Consumer Group）</a></li>
                <li>
                    <a href="#%e9%9b%86%e7%be%a4%e6%b6%88%e8%b4%b9clustering" aria-label="集群消费（Clustering）">集群消费（Clustering）</a></li>
                <li>
                    <a href="#%e5%b9%bf%e6%92%ad%e6%b6%88%e8%b4%b9broadcasting" aria-label="广播消费（Broadcasting）">广播消费（Broadcasting）</a></li>
                <li>
                    <a href="#%e6%99%ae%e9%80%9a%e9%a1%ba%e5%ba%8f%e6%b6%88%e6%81%afnormal-ordered-message" aria-label="普通顺序消息（Normal Ordered Message）">普通顺序消息（Normal Ordered Message）</a></li>
                <li>
                    <a href="#%e4%b8%a5%e6%a0%bc%e9%a1%ba%e5%ba%8f%e6%b6%88%e6%81%afstrictly-ordered-message" aria-label="严格顺序消息（Strictly Ordered Message）">严格顺序消息（Strictly Ordered Message）</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%afmessage" aria-label="消息（Message）">消息（Message）</a></li>
                <li>
                    <a href="#%e6%a0%87%e7%ad%betag" aria-label="标签（Tag）">标签（Tag）</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%89%b9%e6%80%a7features" aria-label="特性(features)">特性(features)</a></li>
                <li>
                    <a href="#%e6%9e%b6%e6%9e%84" aria-label="架构">架构</a></li>
                <li>
                    <a href="#%e8%ae%be%e8%ae%a1" aria-label="设计">设计</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85" aria-label="安装">安装</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b" aria-label="代码示例">代码示例</a><ul>
                        
                <li>
                    <a href="#%e6%9c%80%e5%9f%ba%e6%9c%ac%e7%a4%ba%e4%be%8b" aria-label="最基本示例">最基本示例</a></li>
                <li>
                    <a href="#%e6%95%b4%e5%90%88spring-boot" aria-label="整合spring boot">整合spring boot</a></li>
                <li>
                    <a href="#%e5%ae%98%e6%96%b9%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b" aria-label="官方代码示例">官方代码示例</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bf%ae%e6%94%b9%e5%bb%b6%e6%97%b6%e7%ba%a7%e5%88%ab" aria-label="修改延时级别">修改延时级别</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="概述">概述<a hidden class="anchor" aria-hidden="true" href="#概述">#</a></h1>
<h2 id="什么是消息队列">什么是消息队列<a hidden class="anchor" aria-hidden="true" href="#什么是消息队列">#</a></h2>
<p>消息队列(Message queue)是一种进程间通信或同一进程的不同线程间的通信方式，软件的贮列用来处理一系列的输入，通常来自用户。消息队列提供了异步的通信协议，每一个贮列中的记录包含详细说明的数据，包含发生的时间，输入设备的种类，以及特定的输入参数。也就是说：消息的发送者和接收者不需要同时与消息队列互交。消息会保存在队列中，直到接收者取回它。 &ndash;维基百科</p>
<p>最简单的模型：
<code>Producer--send--&gt;Borker--Receive--&gt;Consumer</code></p>
<ul>
<li>Producer：消息生产者，负责生产和发送消息到Broker；</li>
<li>Broker：消息处理中心，负责消息存储、确认、重试等，一般其中会包含多个queue；</li>
<li>Consumer：消息的消费者，负责从Broker中获取消息，并进行相应处理。</li>
</ul>
<h2 id="特性">特性<a hidden class="anchor" aria-hidden="true" href="#特性">#</a></h2>
<ul>
<li>异步性：将耗时的同步操作，通过发送消息的方式，进行了异步处理，减少了同步等待的时间。</li>
<li>松耦合：减少了服务之间的耦合性，不同的服务可以通过消息队列进行通信，从而不关心彼此的实现细节，只要定义好消息的格式就行。</li>
<li>分布式：通过对消费者的横向扩展，降低了消息队列阻塞的风险，以及单个消费者产生单点故障的可能性(消息队列本身也可以做成分布式请求)</li>
<li>可靠性：消息队列一般会把接收到的消息存储到本地硬盘上(当消息被处理完后，根据不同的消息队列实现，可能删除)，这样即使消息队列挂掉或消息队列本身挂掉，消息也能重新加载。</li>
</ul>
<h2 id="为什么使用消息队列">为什么使用消息队列<a hidden class="anchor" aria-hidden="true" href="#为什么使用消息队列">#</a></h2>
<p>消息队列中间件是分布式系统中重要的组件，主要解决应用解耦，异步消息，流量削锋等问题，实现高性能，高可用，可伸缩和最终一致性架构。目前使用较多的消息队列有ActiveMQ，RabbitMQ，ZeroMQ，Kafka，MetaMQ，RocketMQ。在高并发环境下，由于来不及同步处理，请求往往会发生堵塞，如大量的insert、update请求同时到达mysql，直接导致无数的行锁表锁，甚至最后请求会堆积过多，从而触发too many connections错误。通过使用消息队列，可以异步处理请求，从而缓解系统压力。</p>
<h2 id="mq使用场景">MQ使用场景<a hidden class="anchor" aria-hidden="true" href="#mq使用场景">#</a></h2>
<ul>
<li>异步处理：高并发场景，使用MQ的异步特性</li>
<li>消息通讯：进程间通讯和系统间的消息通知，如在分布式系统中</li>
<li>应用解耦：公司中有许多团队，每个团队负责不同的模块，各个模块可以使用MQ来通信</li>
<li>流量削峰</li>
</ul>
<h3 id="异步处理">异步处理<a hidden class="anchor" aria-hidden="true" href="#异步处理">#</a></h3>
<p>场景说明：用户注册后，需要发注册邮件和注册短信。传统的做法有两种 1.串行 2.并行
1.串行：将注册信息写入数据库成功后，发送注册邮件，再发送注册短信。以上三个任务全部完成后，返回给客户端。
<img loading="lazy" src="1.png" alt=""  />

2.并行：将注册信息写入数据库成功后，发送注册邮件的同时，发送注册短信。以上三个任务完成后，返回给客户端。与串行的差别是，并行的方式可以加快处理的速度
<img loading="lazy" src="2.png" alt=""  />
</p>
<p>假设三个业务节点每个使用50毫秒钟，不考虑网络等其他开销，则串行方式的时间是150毫秒，并行的时间可能是100毫秒。因为CPU在单位时间内处理的请求数是一定的，假设CPU1秒内吞吐量是100次。则串行方式1秒内CPU可处理的请求量是7次（1000/150）。并行方式处理的请求量是10次（1000/100）小结：综上所述，传统的方式系统的性能（并发量，吞吐量，响应时间）会有瓶颈。如何解决这个问题呢？</p>
<p>3.引入消息队列，将不是必须的业务逻辑，异步处理。改造后的架构如下：
<img loading="lazy" src="3.png" alt=""  />

按照以上约定，用户的响应时间相当于是注册信息写入数据库的时间，也就是50毫秒。注册邮件，发送短信写入消息队列后，直接返回，因为写入消息队列的速度很快，基本可以忽略，因此用户的响应时间可能是50毫秒。架构改变后，系统的吞吐量提高到每秒20 QPS。比串行提高了3倍，比并行提高了两倍。</p>
<h3 id="应用解耦">应用解耦<a hidden class="anchor" aria-hidden="true" href="#应用解耦">#</a></h3>
<p>场景说明：用户下单后，订单系统需要通知库存系统。传统的做法是，订单系统调用库存系统的接口。如下图：
<img loading="lazy" src="4.png" alt=""  />

传统模式的缺点：假如库存系统无法访问，则订单减库存将失败，从而导致订单失败，订单系统与库存系统耦合。
如何解决以上问题呢？引入应用消息队列后的方案，如下图：
<img loading="lazy" src="5.png" alt=""  />
</p>
<p>订单系统：用户下单后，订单系统完成持久化处理，将消息写入消息队列，返回用户订单下单成功
库存系统：订阅下单的消息，采用拉/推的方式，获取下单信息，库存系统根据下单信息，进行库存操作。
假如：在下单时库存系统不能正常使用。也不影响正常下单，因为下单后，订单系统写入消息队列就不再关心其他的后续操作了，实现订单系统与库存系统的应用解耦。</p>
<h3 id="流量削峰">流量削峰<a hidden class="anchor" aria-hidden="true" href="#流量削峰">#</a></h3>
<p>流量削锋也是消息队列中的常用场景，一般在秒杀或团抢活动中使用广泛。
应用场景：秒杀活动，一般会因为流量过大，导致流量暴增，应用挂掉。为解决这个问题，一般需要在应用前端加入消息队列。
a、可以控制活动的人数
b、可以缓解短时间内高流量压垮应用
<img loading="lazy" src="6.png" alt=""  />

用户的请求，服务器接收后，首先写入消息队列。假如消息队列长度超过最大数量，则直接抛弃用户请求或跳转到错误页面。秒杀业务根据消息队列中的请求信息，再做后续处理。</p>
<h3 id="日志处理">日志处理<a hidden class="anchor" aria-hidden="true" href="#日志处理">#</a></h3>
<p>日志处理是指将消息队列用在日志处理中，比如Kafka的应用，解决大量日志传输的问题。架构简化如下：
<img loading="lazy" src="7.png" alt=""  />

日志采集客户端：负责日志数据采集，定时写受写入Kafka队列。
Kafka消息队列：负责日志数据的接收，存储和转发。
日志处理应用：订阅并消费kafka队列中的日志数据 。</p>
<h3 id="消息通讯">消息通讯<a hidden class="anchor" aria-hidden="true" href="#消息通讯">#</a></h3>
<p>消息通讯是指，消息队列一般都内置了高效的通信机制，因此也可以用在纯的消息通讯。比如实现点对点消息队列，或者聊天室等。</p>
<p>点对点通讯：
<img loading="lazy" src="8.png" alt=""  />

客户端A和客户端B使用同一队列，进行消息通讯。</p>
<p>聊天室通讯：
<img loading="lazy" src="9.png" alt=""  />

客户端A，客户端B，客户端N订阅同一主题，进行消息发布和接收。实现类似聊天室效果。
以上实际是消息队列的两种消息模式，点对点或发布订阅模式。模型为示意图，供参考。</p>
<h1 id="mq使用示例">MQ使用示例<a hidden class="anchor" aria-hidden="true" href="#mq使用示例">#</a></h1>
<h2 id="电商系统">电商系统<a hidden class="anchor" aria-hidden="true" href="#电商系统">#</a></h2>
<p><img loading="lazy" src="10.png" alt=""  />

消息队列采用高可用，可持久化的消息中间件。比如Active MQ，Rabbit MQ，Rocket Mq。
（1）应用将主干逻辑处理完成后，写入消息队列。消息发送是否成功可以开启消息的确认模式。（消息队列返回消息接收成功状态后，应用再返回，这样保障消息的完整性）
（2）扩展流程（发短信，配送处理）订阅队列消息。采用推或拉的方式获取消息并处理。
（3）消息将应用解耦的同时，带来了数据一致性问题，可以采用最终一致性方式解决。比如主数据写入数据库，扩展应用根据消息队列，并结合数据库方式实现基于消息队列的后续处理。</p>
<h2 id="日志收集系统">日志收集系统<a hidden class="anchor" aria-hidden="true" href="#日志收集系统">#</a></h2>
<p><img loading="lazy" src="11.png" alt=""  />

分为Zookeeper注册中心，日志收集客户端，Kafka集群和Storm集群（OtherApp）四部分组成。
Zookeeper注册中心，提出负载均衡和地址查找服务
日志收集客户端，用于采集应用系统的日志，并将数据推送到kafka队列
Kafka集群：接收，路由，存储，转发等消息处理
Storm集群：与OtherApp处于同一级别，采用拉的方式消费队列中的数据</p>
<h1 id="jms">JMS<a hidden class="anchor" aria-hidden="true" href="#jms">#</a></h1>
<p>讲消息队列就不得不提JMS。JMS（JAVA Message Service，java消息服务）API是一个消息服务的标准/规范，允许应用程序组件基于JavaEE平台创建、发送、接收和读取消息。它使分布式通信耦合度更低，消息服务更加可靠以及异步性。在EJB架构中，有消息bean可以无缝的与JM消息服务集成。在J2EE架构模式中，有消息服务者模式，用于实现消息与应用直接的解耦。</p>
<h2 id="消息模型">消息模型<a hidden class="anchor" aria-hidden="true" href="#消息模型">#</a></h2>
<p>在JMS标准中，有两种消息模型P2P（Point to Point）、Publish/Subscribe(Pub/Sub)</p>
<h3 id="p2p">P2P<a hidden class="anchor" aria-hidden="true" href="#p2p">#</a></h3>
<p><img loading="lazy" src="12.png" alt=""  />

P2P模式包含三个角色：消息队列（Queue），发送者(Sender)，接收者(Receiver)。每个消息都被发送到
一个特定的队列，接收者从队列中获取消息。队列保留着消息，直到他们被消费或超时。</p>
<p>P2P的特点：</p>
<ul>
<li>每个消息只有一个消费者（Consumer）(即一旦被消费，消息就不再在消息队列中)</li>
<li>发送者和接收者之间在时间上没有依赖性，也就是说当发送者发送了消息之后，不管接收者有没有正在运行，它不会影响到消息被发送到队列</li>
<li>接收者在成功接收消息之后需向队列应答成功</li>
<li>如果希望发送的每个消息都会被成功处理的话，那么需要P2P模式。</li>
</ul>
<h3 id="pubsub模式">Pub/Sub模式<a hidden class="anchor" aria-hidden="true" href="#pubsub模式">#</a></h3>
<p><img loading="lazy" src="13.png" alt=""  />

包含三个角色主题（Topic），发布者（Publisher），订阅者（Subscriber） 多个发布者将消息发送到Topic，系统将这些消息传递给多个订阅者。</p>
<p>Pub/Sub的特点</p>
<ul>
<li>每个消息可以有多个消费者</li>
<li>发布者和订阅者之间有时间上的依赖性。针对某个主题（Topic）的订阅者，它必须创建一个订阅者之后，才能消费发布者的消息</li>
<li>为了消费消息，订阅者必须保持运行的状态</li>
<li>为了缓和这样严格的时间相关性，JMS允许订阅者创建一个可持久化的订阅。这样，即使订阅者没有被激活（运行），它也能接收到发布者的消息。</li>
<li>如果希望发送的消息可以不被做任何处理、或者只被一个消息者处理、或者可以被多个消费者处理的话，那么可以采用Pub/Sub模型。</li>
</ul>
<h2 id="消息消费">消息消费<a hidden class="anchor" aria-hidden="true" href="#消息消费">#</a></h2>
<p>在JMS中，消息的产生和消费都是异步的。对于消费来说，JMS的消息者可以通过两种方式来消费消息。</p>
<ul>
<li>
<p>同步
订阅者或接收者通过receive方法来接收消息，receive方法在接收到消息之前（或超时之前）将一直阻塞；</p>
</li>
<li>
<p>异步
订阅者或接收者可以注册为一个消息监听器。当消息到达之后，系统自动调用监听器的onMessage方法。</p>
</li>
</ul>
<p>JNDI：Java命名和目录接口，是一种标准的Java命名系统接口。可以在网络上查找和访问服务。通过指定一个资源名称，该名称对应于数据库或命名服务中的一个记录，同时返回资源连接建立所必须的信息。JNDI在JMS中起到查找和访问发送目标或消息来源的作用。</p>
<h1 id="常用的消息队列">常用的消息队列<a hidden class="anchor" aria-hidden="true" href="#常用的消息队列">#</a></h1>
<p>Kafka、rocketmq、activemq、rabbitmq，对比社区活跃度、吞吐量、可靠性、时效性等，选择rocketmq和Kafka。</p>
<h2 id="kafka">Kafka<a hidden class="anchor" aria-hidden="true" href="#kafka">#</a></h2>
<p>Kafka是最初由Linkedin公司开发，是一个分布式、分区的、多副本的、多订阅者，基于zookeeper协调的分布式日志系统（也可以当做MQ系统），常见可以用于web/nginx日志、访问日志，消息服务等等，Linkedin于2010年贡献给了Apache基金会并成为顶级开源项目。</p>
<p>主要应用场景是：日志收集系统和消息系统。</p>
<p>Kafka主要设计目标如下：</p>
<ul>
<li>以时间复杂度为O(1)的方式提供消息持久化能力，即使对TB级以上数据也能保证常数时间的访问性能。</li>
<li>高吞吐率。即使在非常廉价的商用机器上也能做到单机支持每秒100K条消息的传输。</li>
<li>支持Kafka Server间的消息分区，及分布式消费，同时保证每个partition内的消息顺序传输。</li>
<li>同时支持离线数据处理和实时数据处理。</li>
<li>Scale out:支持在线水平扩展
<a href="https://www.cnblogs.com/qingyunzong/category/1212387.html">kafka参考</a></li>
</ul>
<h1 id="rocketmq">RocketMQ<a hidden class="anchor" aria-hidden="true" href="#rocketmq">#</a></h1>
<p><a href="http://rocketmq.apache.org/">RocketMQ官方文档</a>
<a href="https://github.com/apache/rocketmq/tree/master/docs/cn">官方开发指南</a></p>
<h2 id="开源版和商用版">开源版和商用版<a hidden class="anchor" aria-hidden="true" href="#开源版和商用版">#</a></h2>
<p>RocketMQ有一个开源的（就是github上的），一个商用的（通过阿里云购买使用）。二者区别：
开源版本RocketMQ仅支持定时Level，从1秒到2小时，共18个级别，不能自定义。商用MQ支持毫秒级别的延时时间。
<a href="https://www.jianshu.com/p/0843505d3e03">参考</a></p>
<h2 id="基本概念">基本概念<a hidden class="anchor" aria-hidden="true" href="#基本概念">#</a></h2>
<h3 id="消息模型message-model">消息模型（Message Model）<a hidden class="anchor" aria-hidden="true" href="#消息模型message-model">#</a></h3>
<p>RocketMQ主要由 Producer、Broker、Consumer 三部分组成，其中Producer 负责生产消息，Consumer 负责消费消息，Broker 负责存储消息。Broker 在实际部署过程中对应一台服务器，每个 Broker 可以存储多个Topic的消息，每个Topic的消息也可以分片存储于不同的 Broker。Message Queue 用于存储消息的物理地址，每个Topic中的消息地址存储于多个 Message Queue 中。ConsumerGroup 由多个Consumer 实例构成。</p>
<h3 id="消息生产者producer">消息生产者（Producer）<a hidden class="anchor" aria-hidden="true" href="#消息生产者producer">#</a></h3>
<p>负责生产消息，一般由业务系统负责生产消息。一个消息生产者会把业务应用系统里产生的消息发送到broker服务器。RocketMQ提供多种发送方式，同步发送、异步发送、顺序发送、单向发送。同步和异步方式均需要Broker返回确认信息，单向发送不需要。</p>
<h3 id="消息消费者consumer">消息消费者（Consumer）<a hidden class="anchor" aria-hidden="true" href="#消息消费者consumer">#</a></h3>
<p>负责消费消息，一般是后台系统负责异步消费。一个消息消费者会从Broker服务器拉取消息、并将其提供给应用程序。从用户应用的角度而言提供了两种消费形式：拉取式消费、推动式消费。</p>
<h3 id="主题topic">主题（Topic）<a hidden class="anchor" aria-hidden="true" href="#主题topic">#</a></h3>
<p>表示一类消息的集合，是一种消息的逻辑分类，每个主题包含若干条消息，每条消息只能属于一个主题，是RocketMQ进行消息订阅的基本单位。</p>
<h3 id="代理服务器broker-server">代理服务器（Broker Server）<a hidden class="anchor" aria-hidden="true" href="#代理服务器broker-server">#</a></h3>
<p>消息中转角色，负责存储消息、转发消息。代理服务器在RocketMQ系统中负责接收从生产者发送来的消息并存储、同时为消费者的拉取请求作准备。代理服务器也存储消息相关的元数据，包括消费者组、消费进度偏移和主题和队列消息等。</p>
<h3 id="名字服务name-server">名字服务（Name Server）<a hidden class="anchor" aria-hidden="true" href="#名字服务name-server">#</a></h3>
<p>名称服务充当路由消息的提供者。生产者或消费者能够通过名字服务查找各主题相应的Broker IP列表。多个Namesrv实例组成集群，但相互独立，没有信息交换。</p>
<h3 id="拉取式消费pull-consumer">拉取式消费（Pull Consumer）<a hidden class="anchor" aria-hidden="true" href="#拉取式消费pull-consumer">#</a></h3>
<p>Consumer消费的一种类型，应用通常主动调用Consumer的拉消息方法从Broker服务器拉消息、主动权由应用控制。一旦获取了批量消息，应用就会启动消费过程。</p>
<h3 id="推动式消费push-consumer">推动式消费（Push Consumer）<a hidden class="anchor" aria-hidden="true" href="#推动式消费push-consumer">#</a></h3>
<p>Consumer消费的一种类型，该模式下Broker收到数据后会主动推送给消费端，该消费模式一般实时性较高。</p>
<h3 id="生产者组producer-group">生产者组（Producer Group）<a hidden class="anchor" aria-hidden="true" href="#生产者组producer-group">#</a></h3>
<p>同一类Producer的集合，这类Producer发送同一类消息且发送逻辑一致。如果发送的是事务消息且原始生产者在发送之后崩溃，则Broker服务器会联系同一生产者组的其他生产者实例以提交或回溯消费。</p>
<h3 id="消费者组consumer-group">消费者组（Consumer Group）<a hidden class="anchor" aria-hidden="true" href="#消费者组consumer-group">#</a></h3>
<p>同一类Consumer的集合，这类Consumer通常消费同一类消息且消费逻辑一致。消费者组使得在消息消费方面，实现负载均衡和容错的目标变得非常容易。要注意的是，消费者组的消费者实例必须订阅完全相同的Topic。
RocketMQ 支持两种消息模式：集群消费（Clustering）和广播消费（Broadcasting）。</p>
<h3 id="集群消费clustering">集群消费（Clustering）<a hidden class="anchor" aria-hidden="true" href="#集群消费clustering">#</a></h3>
<p>集群消费模式下,相同Consumer Group的每个Consumer实例平均分摊消息。</p>
<h3 id="广播消费broadcasting">广播消费（Broadcasting）<a hidden class="anchor" aria-hidden="true" href="#广播消费broadcasting">#</a></h3>
<p>广播消费模式下，相同Consumer Group的每个Consumer实例都接收全量的消息。</p>
<h3 id="普通顺序消息normal-ordered-message">普通顺序消息（Normal Ordered Message）<a hidden class="anchor" aria-hidden="true" href="#普通顺序消息normal-ordered-message">#</a></h3>
<p>普通顺序消费模式下，消费者通过同一个消费队列收到的消息是有顺序的，不同消息队列收到的消息则可能是无顺序的。</p>
<h3 id="严格顺序消息strictly-ordered-message">严格顺序消息（Strictly Ordered Message）<a hidden class="anchor" aria-hidden="true" href="#严格顺序消息strictly-ordered-message">#</a></h3>
<p>严格顺序消息模式下，消费者收到的所有消息均是有顺序的。</p>
<h3 id="消息message">消息（Message）<a hidden class="anchor" aria-hidden="true" href="#消息message">#</a></h3>
<p>消息系统所传输信息的物理载体，生产和消费数据的最小单位，每条消息必须属于一个主题。RocketMQ中每个消息拥有唯一的Message ID，且可以携带具有业务标识的Key。系统提供了通过Message ID和Key查询消息的功能。</p>
<h3 id="标签tag">标签（Tag）<a hidden class="anchor" aria-hidden="true" href="#标签tag">#</a></h3>
<p>为消息设置的标志，用于同一主题下区分不同类型的消息。来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。标签能够有效地保持代码的清晰度和连贯性，并优化RocketMQ提供的查询系统。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性。</p>
<h2 id="特性features">特性(features)<a hidden class="anchor" aria-hidden="true" href="#特性features">#</a></h2>
<p><a href="https://github.com/apache/rocketmq/blob/master/docs/cn/features.md">介绍RocketMQ实现的功能特性。</a></p>
<h2 id="架构">架构<a hidden class="anchor" aria-hidden="true" href="#架构">#</a></h2>
<p><a href="https://github.com/apache/rocketmq/blob/master/docs/cn/architecture.md">介绍RocketMQ部署架构和技术架构</a></p>
<h2 id="设计">设计<a hidden class="anchor" aria-hidden="true" href="#设计">#</a></h2>
<p><a href="https://github.com/apache/rocketmq/blob/master/docs/cn/design.md">介绍RocketMQ关键机制的设计原理</a></p>
<h2 id="安装">安装<a hidden class="anchor" aria-hidden="true" href="#安装">#</a></h2>
<p><a href="http://rocketmq.apache.org/docs/quick-start/">官网安装教程</a>
source release是源代码，需要编译打包才能运行。
binary release是编译好的，可以直接运行。</p>
<p>linux安装，参考官网。</p>
<p>windows安装，推荐下载binary release。</p>
<ol>
<li>
<p>将下载好的文件解压到理想位置。</p>
</li>
<li>
<p>添加系统环境变量。
<code>ROCKETMQ_HOME=&quot;D:\你的解压位置&quot;</code>
<code>NAMESRV_ADDR=&quot;localhost:9876&quot;</code>
环境变量配置完成，必须重启电脑。</p>
</li>
<li>
<p>启动name server
通过git bush，cd到安装目录的bin目录下，执行命令
<code>./mqnamesrv.cmd</code>
看到<code>The Name Server boot success. serializeType=JSON</code>，证明启动成功，这个窗口不要关。
如果启动报错：错误: 找不到或无法加载主类。
那应该是jdk的安装路径有问题，默认的安装路径：C:\Program Files\Java\jdk-12
Program Files 这个文件夹中带有空格，会影响mq的启动。
需要把JDK安装到没有空格的路径。
直接将Java文件夹（里面有jdk和jre）剪切到D盘根目录，然后修改系统环境变量
<code>JAVA_HOME</code></p>
</li>
<li>
<p>启动broker
<code>./mqbroker.cmd -n localhost:9876 autoCreateTopicEnable=true</code>
如上的 ip+port 是NameServer的进程，因为Nameser安装启动在本地，所以这里的 ip 是 localhost。
运行如上命令，可能会报如下错误：找不到或无法加载主类。
如果出此情况，找到bin目录下的<code>runbroker.cmd</code>，给%CLASSPATH%加上双引号，<code>&quot;%CLASSPATH%&quot;</code></p>
</li>
</ol>
<p>再次执行启动命令，看到
<code>The broker[DESKTOP-U0510U3, 192.168.2.156:10911] boot success. serializeType=JSON and name server is localhost:9876</code>
证明broker启动成功。</p>
<h2 id="代码示例">代码示例<a hidden class="anchor" aria-hidden="true" href="#代码示例">#</a></h2>
<p>引入依赖</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.rocketmq<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;artifactId&gt;</span>rocketmq-client<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;version&gt;</span>4.8.0<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意依赖版本一定要和前面安装的程序版本一致。</p>
<h3 id="最基本示例">最基本示例<a hidden class="anchor" aria-hidden="true" href="#最基本示例">#</a></h3>
<p>Consumer</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.wjy.rocketmq.consumer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.rocketmq.client.exception.MQClientException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.rocketmq.common.message.MessageExt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.List;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 消费者
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Consumer {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        startConsumer();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> startConsumer() <span style="color:#fff;font-weight:bold">throws</span> Exception{
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 实例化消费者
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        DefaultMQPushConsumer consumer = <span style="color:#fff;font-weight:bold">new</span> DefaultMQPushConsumer(<span style="color:#0ff;font-weight:bold">&#34;please_rename_unique_group_name&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 设置NameServer的地址
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        consumer.<span style="color:#007f7f">setNamesrvAddr</span>(<span style="color:#0ff;font-weight:bold">&#34;localhost:9876&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 订阅一个或者多个Topic，以及Tag来过滤需要消费的消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        consumer.<span style="color:#007f7f">subscribe</span>(<span style="color:#0ff;font-weight:bold">&#34;TopicTest&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;*&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 注册回调实现类来处理从broker拉取回来的消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        consumer.<span style="color:#007f7f">registerMessageListener</span>(<span style="color:#fff;font-weight:bold">new</span> MessageListenerConcurrently() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context) {
</span></span><span style="display:flex;"><span>                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">printf</span>(<span style="color:#0ff;font-weight:bold">&#34;%s Receive New Messages: %s %n&#34;</span>, Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">getName</span>(), msgs);
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 标记该消息已经被成功消费
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">return</span> ConsumeConcurrentlyStatus.<span style="color:#007f7f">CONSUME_SUCCESS</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 启动消费者实例
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        consumer.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">printf</span>(<span style="color:#0ff;font-weight:bold">&#34;Consumer Started.%n&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行main方法，就启动了Consumer。</p>
<p>Producer</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.wjy.rocketmq.producer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.rocketmq.client.producer.SendResult;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.rocketmq.common.message.Message;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 发送同步消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 这种可靠性同步地发送方式使用的比较广泛，比如：重要的消息通知，短信通知。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SyncProducer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        send();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> send() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 实例化消息生产者Producer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        DefaultMQProducer producer = <span style="color:#fff;font-weight:bold">new</span> DefaultMQProducer(<span style="color:#0ff;font-weight:bold">&#34;please_rename_unique_group_name&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 设置NameServer的地址
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        producer.<span style="color:#007f7f">setNamesrvAddr</span>(<span style="color:#0ff;font-weight:bold">&#34;localhost:9876&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 启动Producer实例
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        producer.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; <span style="color:#ff0;font-weight:bold">100</span>; i++) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 创建消息，并指定Topic，Tag和消息体
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Message msg = <span style="color:#fff;font-weight:bold">new</span> Message(<span style="color:#0ff;font-weight:bold">&#34;TopicTest&#34;</span> <span style="color:#007f7f">/* Topic */</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;TagA&#34;</span> <span style="color:#007f7f">/* Tag */</span>,
</span></span><span style="display:flex;"><span>                    (<span style="color:#0ff;font-weight:bold">&#34;Hello RocketMQ &#34;</span> + i).<span style="color:#007f7f">getBytes</span>(RemotingHelper.<span style="color:#007f7f">DEFAULT_CHARSET</span>) <span style="color:#007f7f">/* Message body */</span>
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 发送消息到一个Broker
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            SendResult sendResult = producer.<span style="color:#007f7f">send</span>(msg);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 通过sendResult返回消息是否成功送达
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">printf</span>(<span style="color:#0ff;font-weight:bold">&#34;%s%n&#34;</span>, sendResult);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 如果不再发送消息，关闭Producer实例。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        producer.<span style="color:#007f7f">shutdown</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过main方法运行Producer，然后可以在Consumer 控制台查看收到的消息。</p>
<h3 id="整合spring-boot">整合spring boot<a hidden class="anchor" aria-hidden="true" href="#整合spring-boot">#</a></h3>
<p>生产者和消费者放到一个模块里是没问题的。</p>
<p>生产者配置</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#007f7f"># 是否开启自动配置</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.producer.isOnOff</span>=<span style="color:#0ff;font-weight:bold">on</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 发送同一类消息设置为同一个group，保证唯一默认不需要设置，rocketmq会使用ip@pid（pid代表jvm名字）作为唯一标识</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.producer.groupName</span>=<span style="color:#0ff;font-weight:bold">spring-application-api</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># mq的nameserver地址</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.producer.namesrvAddr</span>=<span style="color:#0ff;font-weight:bold">127.0.0.1:9876</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 消息最大长度 默认 1024 * 4 (4M)</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.producer.maxMessageSize</span> = <span style="color:#0ff;font-weight:bold">4096</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 发送消息超时时间，默认 3000</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.producer.sendMsgTimeOut</span>=<span style="color:#0ff;font-weight:bold">3000</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 发送消息失败重试次数，默认2</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.producer.retryTimesWhenSendFailed</span>=<span style="color:#0ff;font-weight:bold">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Slf4j
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MQProducerConfigure {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${rocketmq.producer.groupName}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String groupName;
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${rocketmq.producer.namesrvAddr}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String namesrvAddr;
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${rocketmq.producer.maxMessageSize}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Integer maxMessageSize;
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${rocketmq.producer.sendMsgTimeOut}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Integer sendMsgTimeOut;
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${rocketmq.producer.retryTimesWhenSendFailed}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Integer retryTimesWhenSendFailed;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * mq 生成者配置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @throws MQClientException
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> DefaultMQProducer defaultProducer() <span style="color:#fff;font-weight:bold">throws</span> MQClientException {
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;defaultProducer 正在创建---------------------------------------&#34;</span>);
</span></span><span style="display:flex;"><span>        DefaultMQProducer producer = <span style="color:#fff;font-weight:bold">new</span> DefaultMQProducer(groupName);
</span></span><span style="display:flex;"><span>        producer.<span style="color:#007f7f">setNamesrvAddr</span>(namesrvAddr);
</span></span><span style="display:flex;"><span>        producer.<span style="color:#007f7f">setVipChannelEnabled</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        producer.<span style="color:#007f7f">setMaxMessageSize</span>(maxMessageSize);
</span></span><span style="display:flex;"><span>        producer.<span style="color:#007f7f">setSendMsgTimeout</span>(sendMsgTimeOut);
</span></span><span style="display:flex;"><span>        producer.<span style="color:#007f7f">setRetryTimesWhenSendAsyncFailed</span>(retryTimesWhenSendFailed);
</span></span><span style="display:flex;"><span>        producer.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;rocketmq producer server 开启成功----------------------------------&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> producer;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>消费者配置</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#007f7f"># 是否开启自动配置</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.consumer.isOnOff</span>=<span style="color:#0ff;font-weight:bold">on</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 发送同一类消息设置为同一个group，保证唯一默认不需要设置，rocketmq会使用ip@pid（pid代表jvm名字）作为唯一标识</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.consumer.groupName</span>=<span style="color:#0ff;font-weight:bold">spring-application-pay</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># mq的nameserver地址</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.consumer.namesrvAddr</span>=<span style="color:#0ff;font-weight:bold">127.0.0.1:9876</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 消费者订阅的主题topic和tags（*标识订阅该主题下所有的tags），格式: topic~tag1||tag2||tags3;</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.consumer.topics</span>=<span style="color:#0ff;font-weight:bold">TestTopic~*;</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 消费者线程数据量</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.consumer.consumeThreadMin</span>=<span style="color:#0ff;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.consumer.consumeThreadMax</span>=<span style="color:#0ff;font-weight:bold">32</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># 设置一次消费信心的条数，默认1</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">rocketmq.consumer.consumeMessageBatchMaxSize</span>=<span style="color:#0ff;font-weight:bold">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Slf4j
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MQConsumerConfigure {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${rocketmq.consumer.groupName}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String groupName;
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${rocketmq.consumer.namesrvAddr}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String namesrvAddr;
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${rocketmq.consumer.topics}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String topics;
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${rocketmq.consumer.consumeThreadMin}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Integer consumeThreadMin;
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${rocketmq.consumer.consumeThreadMax}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Integer consumeThreadMax;
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${rocketmq.consumer.consumeMessageBatchMaxSize}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Integer consumeMessageBatchMaxSize;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> MQConsumeMsgListenerProcessor consumeMsgListenerProcessor;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * mq 消费者配置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @throws MQClientException
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> DefaultMQPushConsumer defaultConsumer() <span style="color:#fff;font-weight:bold">throws</span> MQClientException {
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;defaultConsumer 正在创建---------------------------------------&#34;</span>);
</span></span><span style="display:flex;"><span>        DefaultMQPushConsumer consumer = <span style="color:#fff;font-weight:bold">new</span> DefaultMQPushConsumer(groupName);
</span></span><span style="display:flex;"><span>        consumer.<span style="color:#007f7f">setNamesrvAddr</span>(namesrvAddr);
</span></span><span style="display:flex;"><span>        consumer.<span style="color:#007f7f">setConsumeThreadMin</span>(consumeThreadMin);
</span></span><span style="display:flex;"><span>        consumer.<span style="color:#007f7f">setConsumeThreadMax</span>(consumeThreadMax);
</span></span><span style="display:flex;"><span>        consumer.<span style="color:#007f7f">setConsumeMessageBatchMaxSize</span>(consumeMessageBatchMaxSize);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 设置监听，处理业务逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        consumer.<span style="color:#007f7f">registerMessageListener</span>(consumeMsgListenerProcessor);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * 设置consumer第一次启动是从队列头部开始还是队列尾部开始
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * 如果不是第一次启动，那么按照上次消费的位置继续消费
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>        consumer.<span style="color:#007f7f">setConsumeFromWhere</span>(ConsumeFromWhere.<span style="color:#007f7f">CONSUME_FROM_LAST_OFFSET</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         * 设置消费模型，集群还是广播，默认为集群
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">         */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//        consumer.setMessageModel(MessageModel.CLUSTERING);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 设置该消费者订阅的主题和tag，如果订阅该主题下的所有tag，则使用*,
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String[] topicArr = topics.<span style="color:#007f7f">split</span>(<span style="color:#0ff;font-weight:bold">&#34;;&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (String tag : topicArr) {
</span></span><span style="display:flex;"><span>                String[] tagArr = tag.<span style="color:#007f7f">split</span>(<span style="color:#0ff;font-weight:bold">&#34;~&#34;</span>);
</span></span><span style="display:flex;"><span>                consumer.<span style="color:#007f7f">subscribe</span>(tagArr[<span style="color:#ff0;font-weight:bold">0</span>], tagArr[<span style="color:#ff0;font-weight:bold">1</span>]);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            consumer.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;consumer 创建成功 groupName={}, topics={}, namesrvAddr={}&#34;</span>,groupName,topics,namesrvAddr);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (MQClientException e) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;consumer 创建失败!&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> consumer;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>消费者监听</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 处理业务逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@Slf4j
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MQConsumeMsgListenerProcessor <span style="color:#fff;font-weight:bold">implements</span> MessageListenerConcurrently {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Resource
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> OrdersMapper ordersMapper;
</span></span><span style="display:flex;"><span>    @Resource
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> StudyCardMapper studyCardMapper;
</span></span><span style="display:flex;"><span>    @Resource
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> StudyCardBatchMapper studyCardBatchMapper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 默认msg里只有一条消息，可以通过设置consumeMessageBatchMaxSize参数来批量接收消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 不要抛异常，如果没有return CONSUME_SUCCESS ，consumer会重新消费该消息，直到return CONSUME_SUCCESS
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param msgList
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param consumeConcurrentlyContext
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgList, ConsumeConcurrentlyContext consumeConcurrentlyContext) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (CollectionUtils.<span style="color:#007f7f">isEmpty</span>(msgList)) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;MQ接收消息为空，直接返回成功&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> ConsumeConcurrentlyStatus.<span style="color:#007f7f">CONSUME_SUCCESS</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        MessageExt messageExt = msgList.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>        log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;MQ接收到的消息为：&#34;</span> + messageExt.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            String topic = messageExt.<span style="color:#007f7f">getTopic</span>();
</span></span><span style="display:flex;"><span>            String tags = messageExt.<span style="color:#007f7f">getTags</span>();
</span></span><span style="display:flex;"><span>            String body = <span style="color:#fff;font-weight:bold">new</span> String(messageExt.<span style="color:#007f7f">getBody</span>(), <span style="color:#0ff;font-weight:bold">&#34;utf-8&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;MQ消息topic={}, tags={}, 消息内容={}&#34;</span>, topic,tags,body);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// TODO 处理业务逻辑，取消订单等操作
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;获取MQ消息内容异常{}&#34;</span>,e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ConsumeConcurrentlyStatus.<span style="color:#007f7f">CONSUME_SUCCESS</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>找到合适的位置，发送mq消息</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Autowired
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> DefaultMQProducer defaultMQProducer;
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>    log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;发送MQ消息内容：&#34;</span> + orderNo);
</span></span><span style="display:flex;"><span>    Message sendMsg = <span style="color:#fff;font-weight:bold">new</span> Message(<span style="color:#0ff;font-weight:bold">&#34;TestTopic&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;TestTag&#34;</span>, orderNo.<span style="color:#007f7f">getBytes</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//设置延时队列，无法自定义时间，有1-18，共18个等级
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    sendMsg.<span style="color:#007f7f">setDelayTimeLevel</span>(<span style="color:#ff0;font-weight:bold">4</span>);
</span></span><span style="display:flex;"><span>    SendResult sendResult = defaultMQProducer.<span style="color:#007f7f">send</span>(sendMsg);
</span></span><span style="display:flex;"><span>    log.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;消息发送响应：&#34;</span> + sendResult.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>} <span style="color:#fff;font-weight:bold">catch</span> (MQClientException e) {
</span></span><span style="display:flex;"><span>    e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>} <span style="color:#fff;font-weight:bold">catch</span> (RemotingException e) {
</span></span><span style="display:flex;"><span>    e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>} <span style="color:#fff;font-weight:bold">catch</span> (MQBrokerException e) {
</span></span><span style="display:flex;"><span>    e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>} <span style="color:#fff;font-weight:bold">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>    e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="官方代码示例">官方代码示例<a hidden class="anchor" aria-hidden="true" href="#官方代码示例">#</a></h3>
<p><a href="https://github.com/apache/rocketmq/blob/master/docs/cn/RocketMQ_Example.md">官方示例</a></p>
<h2 id="修改延时级别">修改延时级别<a hidden class="anchor" aria-hidden="true" href="#修改延时级别">#</a></h2>
<p>RocketMQ自带的延时级别：
<code>1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</code>
从1秒到2小时，这可能不满足我们的业务需求，我们可以修改这个配置。</p>
<p>找到<code>broker.conf</code>，位置在
<code>D:\install\rocketmq-4.9.2\conf\broker.conf</code></p>
<p>在最后一行增加配置
<code>messageDelayLevel=11s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</code>
将级别1设置成了11秒延时。然后重启broker（需要指定配置文件）
windows：<code>./mqbroker.cmd -n localhost:9876 autoCreateTopicEnable=true -c../conf/broker.conf</code>
linux：<code>nohup sh mqbroker -n localhost:9876 -c ../conf/broker.conf &amp;</code></p>
<p>测试成功。</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/%E5%85%B6%E4%BB%96/%E7%BD%91%E7%AB%99%E7%9A%84%E6%89%A9%E5%B1%95/">
    <span class="title">« Prev</span>
    <br>
    <span>网站的扩展</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/%E5%85%B6%E4%BB%96%E5%9F%BA%E7%A1%80/docker/">
    <span class="title">Next »</span>
    <br>
    <span>docker</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://localhost:1313/">Wjy&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>