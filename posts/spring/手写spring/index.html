<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>æ‰‹å†™Spring | Wjy&#39;s Blog</title>
<meta name="keywords" content="spring">
<meta name="description" content="å®ç°IOCå®¹å™¨
Springçš„æ ¸å¿ƒå°±æ˜¯èƒ½ç®¡ç†ä¸€ç»„Beanï¼Œå¹¶èƒ½è‡ªåŠ¨é…ç½®ä¾èµ–å…³ç³»çš„IoCå®¹å™¨ã€‚è€Œæˆ‘ä»¬çš„Summer Frameworkçš„æ ¸å¿ƒcontextæ¨¡å—å°±æ˜¯è¦å®ç°IoCå®¹å™¨ã€‚
æ‰‹å†™Spring - å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ (liaoxuefeng.com)">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://wjy6.netlify.app/posts/spring/%E6%89%8B%E5%86%99spring/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://wjy6.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://wjy6.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://wjy6.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://wjy6.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://wjy6.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://wjy6.netlify.app/posts/spring/%E6%89%8B%E5%86%99spring/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:url" content="https://wjy6.netlify.app/posts/spring/%E6%89%8B%E5%86%99spring/">
  <meta property="og:site_name" content="Wjy&#39;s Blog">
  <meta property="og:title" content="æ‰‹å†™Spring">
  <meta property="og:description" content="å®ç°IOCå®¹å™¨ Springçš„æ ¸å¿ƒå°±æ˜¯èƒ½ç®¡ç†ä¸€ç»„Beanï¼Œå¹¶èƒ½è‡ªåŠ¨é…ç½®ä¾èµ–å…³ç³»çš„IoCå®¹å™¨ã€‚è€Œæˆ‘ä»¬çš„Summer Frameworkçš„æ ¸å¿ƒcontextæ¨¡å—å°±æ˜¯è¦å®ç°IoCå®¹å™¨ã€‚
æ‰‹å†™Spring - å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ (liaoxuefeng.com)">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-04-13T15:50:13+00:00">
    <meta property="article:modified_time" content="2023-04-13T15:50:13+00:00">
    <meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æ‰‹å†™Spring">
<meta name="twitter:description" content="å®ç°IOCå®¹å™¨
Springçš„æ ¸å¿ƒå°±æ˜¯èƒ½ç®¡ç†ä¸€ç»„Beanï¼Œå¹¶èƒ½è‡ªåŠ¨é…ç½®ä¾èµ–å…³ç³»çš„IoCå®¹å™¨ã€‚è€Œæˆ‘ä»¬çš„Summer Frameworkçš„æ ¸å¿ƒcontextæ¨¡å—å°±æ˜¯è¦å®ç°IoCå®¹å™¨ã€‚
æ‰‹å†™Spring - å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ (liaoxuefeng.com)">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://wjy6.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "æ‰‹å†™Spring",
      "item": "https://wjy6.netlify.app/posts/spring/%E6%89%8B%E5%86%99spring/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "æ‰‹å†™Spring",
  "name": "æ‰‹å†™Spring",
  "description": "å®ç°IOCå®¹å™¨ Springçš„æ ¸å¿ƒå°±æ˜¯èƒ½ç®¡ç†ä¸€ç»„Beanï¼Œå¹¶èƒ½è‡ªåŠ¨é…ç½®ä¾èµ–å…³ç³»çš„IoCå®¹å™¨ã€‚è€Œæˆ‘ä»¬çš„Summer Frameworkçš„æ ¸å¿ƒcontextæ¨¡å—å°±æ˜¯è¦å®ç°IoCå®¹å™¨ã€‚\næ‰‹å†™Spring - å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ (liaoxuefeng.com)\n",
  "keywords": [
    "spring"
  ],
  "articleBody": "å®ç°IOCå®¹å™¨ Springçš„æ ¸å¿ƒå°±æ˜¯èƒ½ç®¡ç†ä¸€ç»„Beanï¼Œå¹¶èƒ½è‡ªåŠ¨é…ç½®ä¾èµ–å…³ç³»çš„IoCå®¹å™¨ã€‚è€Œæˆ‘ä»¬çš„Summer Frameworkçš„æ ¸å¿ƒcontextæ¨¡å—å°±æ˜¯è¦å®ç°IoCå®¹å™¨ã€‚\næ‰‹å†™Spring - å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ (liaoxuefeng.com)\nè®¾è®¡ç›®æ ‡ Springçš„IoCå®¹å™¨åˆ†ä¸ºä¸¤ç±»ï¼šBeanFactoryå’ŒApplicationContextï¼Œå‰è€…æ€»æ˜¯å»¶è¿Ÿåˆ›å»ºBeanï¼Œè€Œåè€…åˆ™åœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–æ‰€æœ‰Beanã€‚å®é™…ä½¿ç”¨æ—¶ï¼Œ99%éƒ½é‡‡ç”¨ApplicationContextï¼Œå› æ­¤ï¼ŒSummer Frameworkä»…å®ç°ApplicationContextï¼Œä¸æ”¯æŒBeanFactoryã€‚\næ—©æœŸçš„Springå®¹å™¨é‡‡ç”¨XMLæ¥é…ç½®Beanï¼ŒåæœŸåˆåŠ å…¥äº†è‡ªåŠ¨æ‰«æåŒ…çš„åŠŸèƒ½ï¼Œå³é€šè¿‡çš„é…ç½®ã€‚å†åæ¥ï¼ŒåˆåŠ å…¥äº†Annotationé…ç½®ï¼Œå¹¶é€šè¿‡@ComponentScanæ³¨è§£å®ç°è‡ªåŠ¨æ‰«æã€‚å¦‚æœä½¿ç”¨Spring Bootï¼Œåˆ™99%éƒ½é‡‡ç”¨@ComponentScanæ³¨è§£æ–¹å¼é…ç½®ï¼Œå› æ­¤ï¼ŒSummer Frameworkä¹Ÿä»…å®ç°Annotationé…ç½®+@ComponentScanæ‰«ææ–¹å¼å®Œæˆå®¹å™¨çš„é…ç½®ã€‚\næ­¤å¤–ï¼ŒSummer Frameworkä»…æ”¯æŒSingletonç±»å‹çš„Beanï¼Œä¸æ”¯æŒPrototypeç±»å‹çš„Beanï¼Œå› ä¸ºå®é™…ä½¿ç”¨ä¸­ï¼Œ99%éƒ½é‡‡ç”¨Singletonã€‚ä¾èµ–æ³¨å…¥åˆ™ä¸Springä¿æŒä¸€è‡´ï¼Œæ”¯æŒæ„é€ æ–¹æ³•ã€Setteræ–¹æ³•ä¸å­—æ®µæ³¨å…¥ã€‚æ”¯æŒ@Configurationå’ŒBeanPostProcessorã€‚è‡³äºSpringçš„å…¶ä»–åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œå±‚çº§å®¹å™¨ã€MessageSourceã€ä¸€ä¸ªBeanå…è®¸å¤šä¸ªåå­—ç­‰åŠŸèƒ½ï¼Œä¸€æ¦‚ä¸æ”¯æŒï¼\nä¸‹è¡¨åˆ—å‡ºäº†Spring Frameworkå’ŒSummer Frameworkåœ¨IoCå®¹å™¨æ–¹é¢çš„å¼‚åŒï¼š\nåŠŸèƒ½ Spring Framework Summer Framework IoCå®¹å™¨ æ”¯æŒBeanFactoryå’ŒApplicationContext ä»…æ”¯æŒApplicationContext é…ç½®æ–¹å¼ æ”¯æŒXMLä¸Annotation ä»…æ”¯æŒAnnotation æ‰«ææ–¹å¼ æ”¯æŒæŒ‰åŒ…åæ‰«æ æ”¯æŒæŒ‰åŒ…åæ‰«æ Beanç±»å‹ æ”¯æŒSingletonå’ŒPrototype ä»…æ”¯æŒSingleton Beanå·¥å‚ æ”¯æŒFactoryBeanå’Œ@Beanæ³¨è§£ ä»…æ”¯æŒ@Beanæ³¨è§£ å®šåˆ¶Bean æ”¯æŒBeanPostProcessor æ”¯æŒBeanPostProcessor ä¾èµ–æ³¨å…¥ æ”¯æŒæ„é€ æ–¹æ³•ã€Setteræ–¹æ³•ä¸å­—æ®µ æ”¯æŒæ„é€ æ–¹æ³•ã€Setteræ–¹æ³•ä¸å­—æ®µ å¤šå®¹å™¨ æ”¯æŒçˆ¶å­å®¹å™¨ ä¸æ”¯æŒ Annotationé…ç½® ä»ä½¿ç”¨è€…çš„è§’åº¦çœ‹ï¼Œä½¿ç”¨IoCå®¹å™¨æ—¶ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªå…¥å£é…ç½®ï¼Œå®ƒé€šå¸¸é•¿è¿™æ ·ï¼š\n1 2 3 @ComponentScan public class AppConfig { } AppConfigåªæ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œå®ƒçš„ç›®çš„æ˜¯é€šè¿‡@ComponentScanæ¥æ ‡è¯†è¦æ‰«æçš„Beançš„åŒ…ã€‚å¦‚æœæ²¡æœ‰æ˜ç¡®å†™å‡ºåŒ…åï¼Œé‚£ä¹ˆå°†åŸºäºAppConfigæ‰€åœ¨åŒ…è¿›è¡Œæ‰«æï¼Œå¦‚æœæ˜ç¡®å†™å‡ºäº†åŒ…åï¼Œåˆ™åœ¨æŒ‡å®šçš„åŒ…ä¸‹è¿›è¡Œæ‰«æã€‚\nåœ¨æ‰«æè¿‡ç¨‹ä¸­ï¼Œå‡¡æ˜¯å¸¦æœ‰æ³¨è§£@Componentçš„ç±»ï¼Œå°†è¢«æ·»åŠ åˆ°IoCå®¹å™¨è¿›è¡Œç®¡ç†ï¼š\n1 2 3 @Component public class Hello { } æˆ‘ä»¬ç”¨åˆ°çš„è®¸å¤šç¬¬ä¸‰æ–¹ç»„ä»¶ä¹Ÿç»å¸¸ä¼šçº³å…¥IoCå®¹å™¨ç®¡ç†ã€‚è¿™äº›ç¬¬ä¸‰æ–¹ç»„ä»¶æ˜¯ä¸å¯èƒ½å¸¦æœ‰@Componentæ³¨è§£çš„ï¼Œå¼•å…¥ç¬¬ä¸‰æ–¹Beanåªèƒ½é€šè¿‡å·¥å‚æ¨¡å¼ï¼Œå³åœ¨@Configurationå·¥å‚ç±»ä¸­å®šä¹‰å¸¦@Beançš„å·¥å‚æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 @Configuration public class DbConfig { @Bean DataSource createDataSource(...) { return new HikariDataSource(...); } @Bean JdbcTemplate createJdbcTemplate(...) { return new JdbcTemplate(...); } } åŸºäºAnnotationé…ç½®çš„IoCå®¹å™¨åŸºæœ¬ç”¨æ³•å°±æ˜¯ä¸Šé¢æ‰€è¿°ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å°±ä¸€æ­¥ä¸€æ­¥æ¥å®ç°IoCå®¹å™¨ã€‚\nå®ç°ResourceResolver åœ¨ç¼–å†™IoCå®¹å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å®ç°@ComponentScanï¼Œå³è§£å†³åœ¨æŒ‡å®šåŒ…ä¸‹æ‰«ææ‰€æœ‰Classçš„é—®é¢˜ã€‚\nJavaçš„ClassLoaderæœºåˆ¶å¯ä»¥åœ¨æŒ‡å®šçš„Classpathä¸­æ ¹æ®ç±»ååŠ è½½æŒ‡å®šçš„Classï¼Œä½†é—æ†¾çš„æ˜¯ï¼Œç»™å‡ºä¸€ä¸ªåŒ…åï¼Œä¾‹å¦‚ï¼Œorg.exampleï¼Œå®ƒå¹¶ä¸èƒ½è·å–åˆ°è¯¥åŒ…ä¸‹çš„æ‰€æœ‰Classï¼Œä¹Ÿä¸èƒ½è·å–å­åŒ…ã€‚\nè¦åœ¨Classpathä¸­æ‰«ææŒ‡å®šåŒ…åä¸‹çš„æ‰€æœ‰Classï¼ŒåŒ…æ‹¬å­åŒ…ï¼Œå®é™…ä¸Šæ˜¯åœ¨Classpathä¸­æœç´¢æ‰€æœ‰æ–‡ä»¶ï¼Œæ‰¾å‡ºæ–‡ä»¶ååŒ¹é…çš„.classæ–‡ä»¶ã€‚ä¾‹å¦‚ï¼ŒClasspathä¸­æœç´¢çš„æ–‡ä»¶org/example/Hello.classå°±ç¬¦åˆåŒ…åorg.exampleï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æ–‡ä»¶è·¯å¾„æŠŠå®ƒå˜ä¸ºorg.example.Helloï¼Œå°±ç›¸å½“äºè·å¾—äº†ç±»åã€‚å› æ­¤ï¼Œæœç´¢Classå˜æˆäº†æœç´¢æ–‡ä»¶ã€‚\næˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªResourceç±»å‹è¡¨ç¤ºæ–‡ä»¶ï¼š\n1 2 public record Resource(String path, String name) { } å†ä»¿é€ Springæä¾›ä¸€ä¸ªResourceResolverï¼Œå®šä¹‰scan()æ–¹æ³•æ¥è·å–æ‰«æåˆ°çš„Resourceï¼š\n1 2 3 4 5 6 7 8 9 10 11 public class ResourceResolver { String basePackage; public ResourceResolver(String basePackage) { this.basePackage = basePackage; } public List scan(Function mapper) { ... } } è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰«ææŒ‡å®šåŒ…ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚æœ‰çš„åŒå­¦ä¼šé—®ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯æ‰«æ.classæ–‡ä»¶ï¼Œå¦‚ä½•è¿‡æ»¤å‡ºClassï¼Ÿ\næ³¨æ„åˆ°scan()æ–¹æ³•ä¼ å…¥äº†ä¸€ä¸ªæ˜ å°„å‡½æ•°ï¼Œæˆ‘ä»¬ä¼ å…¥Resourceåˆ°Class Nameçš„æ˜ å°„ï¼Œå°±å¯ä»¥æ‰«æå‡ºClass Nameï¼š\n1 2 3 4 5 6 7 8 9 10 11 // å®šä¹‰ä¸€ä¸ªæ‰«æå™¨: ResourceResolver rr = new ResourceResolver(\"org.example\"); List classList = rr.scan(res -\u003e { String name = res.name(); // èµ„æºåç§°\"org/example/Hello.class\" if (name.endsWith(\".class\")) { // å¦‚æœä»¥.classç»“å°¾ // æŠŠ\"org/example/Hello.class\"å˜ä¸º\"org.example.Hello\": return name.substring(0, name.length() - 6).replace(\"/\", \".\").replace(\"\\\\\", \".\"); } // å¦åˆ™è¿”å›nullè¡¨ç¤ºä¸æ˜¯æœ‰æ•ˆçš„Class Name: return null; }); è¿™æ ·ï¼ŒResourceResolveråªè´Ÿè´£æ‰«æå¹¶åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ï¼Œç”±å®¢æˆ·ç«¯å†³å®šæ˜¯æ‰¾å‡º.classæ–‡ä»¶ï¼Œè¿˜æ˜¯æ‰¾å‡º.propertiesæ–‡ä»¶ã€‚\nåœ¨ClassPathä¸­æ‰«ææ–‡ä»¶çš„ä»£ç æ˜¯å›ºå®šæ¨¡å¼ï¼Œå¯ä»¥åœ¨ç½‘ä¸Šæœç´¢è·å¾—ï¼Œä¾‹å¦‚StackOverflowçš„è¿™ä¸ªå›ç­”ã€‚è¿™é‡Œè¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼ŒJavaæ”¯æŒåœ¨jaråŒ…ä¸­æœç´¢æ–‡ä»¶ï¼Œæ‰€ä»¥ï¼Œä¸ä½†éœ€è¦åœ¨æ™®é€šç›®å½•ä¸­æœç´¢ï¼Œä¹Ÿéœ€è¦åœ¨Classpathä¸­åˆ—å‡ºçš„jaråŒ…ä¸­æœç´¢ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 // é€šè¿‡ClassLoaderè·å–URLåˆ—è¡¨: Enumeration en = getContextClassLoader().getResources(\"org/example\"); while (en.hasMoreElements()) { URL url = en.nextElement(); URI uri = url.toURI(); if (uri.toString().startsWith(\"file:\")) { // åœ¨ç›®å½•ä¸­æœç´¢ } if (uri.toString().startsWith(\"jar:\")) { // åœ¨JaråŒ…ä¸­æœç´¢ } } å‡ ä¸ªè¦ç‚¹ï¼š\nClassLoaderé¦–å…ˆä»Thread.getContextClassLoader()è·å–ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œå†ä»å½“å‰Classè·å–ï¼Œå› ä¸ºWebåº”ç”¨çš„ClassLoaderä¸æ˜¯JVMæä¾›çš„åŸºäºClasspathçš„ClassLoaderï¼Œè€Œæ˜¯Servletå®¹å™¨æä¾›çš„ClassLoaderï¼Œå®ƒä¸åœ¨é»˜è®¤çš„Classpathæœç´¢ï¼Œè€Œæ˜¯åœ¨/WEB-INF/classesç›®å½•å’Œ/WEB-INF/libçš„æ‰€æœ‰jaråŒ…æœç´¢ï¼Œä»Thread.getContextClassLoader()å¯ä»¥è·å–åˆ°Servletå®¹å™¨ä¸“å±çš„ClassLoaderï¼› Windowså’ŒLinux/macOSçš„è·¯å¾„åˆ†éš”ç¬¦ä¸åŒï¼Œå‰è€…æ˜¯\\ï¼Œåè€…æ˜¯/ï¼Œéœ€è¦æ­£ç¡®å¤„ç†ï¼› æ‰«æç›®å½•æ—¶ï¼Œè¿”å›çš„è·¯å¾„å¯èƒ½æ˜¯abc/xyzï¼Œä¹Ÿå¯èƒ½æ˜¯abc/xyz/ï¼Œéœ€è¦æ³¨æ„å¤„ç†æœ«å°¾çš„/ã€‚ è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†èƒ½æ‰«ææŒ‡å®šåŒ…ä»¥åŠå­åŒ…ä¸‹æ‰€æœ‰æ–‡ä»¶çš„ResourceResolverã€‚\nå®ç°PropertyResolver Springçš„æ³¨å…¥åˆ†ä¸º@Autowiredå’Œ@Valueä¸¤ç§ã€‚å¯¹äº@Autowiredï¼Œæ¶‰åŠåˆ°Beançš„ä¾èµ–ï¼Œè€Œå¯¹äº@Valueï¼Œåˆ™ä»…ä»…æ˜¯å°†å¯¹åº”çš„é…ç½®æ³¨å…¥ï¼Œä¸æ¶‰åŠBeançš„ä¾èµ–ï¼Œç›¸å¯¹æ¯”è¾ƒç®€å•ã€‚ä¸ºäº†æ³¨å…¥é…ç½®ï¼Œæˆ‘ä»¬ç”¨PropertyResolverä¿å­˜æ‰€æœ‰é…ç½®é¡¹ï¼Œå¯¹å¤–æä¾›æŸ¥è¯¢åŠŸèƒ½ã€‚\næœ¬èŠ‚æˆ‘ä»¬æ¥å®ç°PropertyResolverï¼Œå®ƒæ”¯æŒ3ç§æŸ¥è¯¢æ–¹å¼ï¼š\næŒ‰é…ç½®çš„keyæŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šgetProperty(\"app.title\"); ä»¥${abc.xyz}å½¢å¼çš„æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼ŒgetProperty(\"${app.title}\")ï¼Œå¸¸ç”¨äº@Value(\"${app.title}\")æ³¨å…¥ï¼› å¸¦é»˜è®¤å€¼çš„ï¼Œä»¥${abc.xyz:defaultValue}å½¢å¼çš„æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼ŒgetProperty(\"${app.title:Summer}\")ï¼Œå¸¸ç”¨äº@Value(\"${app.title:Summer}\")æ³¨å…¥ã€‚ Javaæœ¬èº«æä¾›äº†æŒ‰key-valueæŸ¥è¯¢çš„Propertiesï¼Œæˆ‘ä»¬å…ˆä¼ å…¥Propertiesï¼Œå†…éƒ¨æŒ‰key-valueå­˜å‚¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 public class PropertyResolver { Map properties = new HashMap\u003c\u003e(); public PropertyResolver(Properties props) { // å­˜å…¥ç¯å¢ƒå˜é‡: this.properties.putAll(System.getenv()); // å­˜å…¥Properties: Set names = props.stringPropertyNames(); for (String name : names) { this.properties.put(name, props.getProperty(name)); } } } è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨PropertyResolverå†…éƒ¨ï¼Œé€šè¿‡ä¸€ä¸ªMapå­˜å‚¨äº†æ‰€æœ‰çš„é…ç½®é¡¹ï¼ŒåŒ…æ‹¬ç¯å¢ƒå˜é‡ã€‚å¯¹äºæŒ‰keyæŸ¥è¯¢çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•å®ç°å¦‚ä¸‹ï¼š\n1 2 3 4 @Nullable public String getProperty(String key) { return this.properties.get(key); } ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å‡†å¤‡è§£æ${abc.xyz:defaultValue}è¿™æ ·çš„keyï¼Œå…ˆå®šä¹‰ä¸€ä¸ªPropertyExprï¼ŒæŠŠè§£æåçš„keyå’ŒdefaultValueå­˜å‚¨èµ·æ¥ï¼š\n1 2 record PropertyExpr(String key, String defaultValue) { } ç„¶åæŒ‰${...}è§£æï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 PropertyExpr parsePropertyExpr(String key) { if (key.startsWith(\"${\") \u0026\u0026 key.endsWith(\"}\")) { // æ˜¯å¦å­˜åœ¨defaultValue? int n = key.indexOf(':'); if (n == (-1)) { // æ²¡æœ‰defaultValue: ${key} String k = key.substring(2, key.length() - 1); return new PropertyExpr(k, null); } else { // æœ‰defaultValue: ${key:default} String k = key.substring(2, n); return new PropertyExpr(k, key.substring(n + 1, key.length() - 1)); } return null; } } æˆ‘ä»¬æŠŠgetProperty()æ”¹é€ ä¸€ä¸‹ï¼Œå³å¯å®ç°æŸ¥è¯¢${abc.xyz:defaultValue}ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @Nullable public String getProperty(String key) { // è§£æ${abc.xyz:defaultValue}: PropertyExpr keyExpr = parsePropertyExpr(key); if (keyExpr != null) { if (keyExpr.defaultValue() != null) { // å¸¦é»˜è®¤å€¼æŸ¥è¯¢: return getProperty(keyExpr.key(), keyExpr.defaultValue()); } else { // ä¸å¸¦é»˜è®¤å€¼æŸ¥è¯¢: return getRequiredProperty(keyExpr.key()); } } // æ™®é€škeyæŸ¥è¯¢: String value = this.properties.get(key); if (value != null) { return parseValue(value); } return value; } æ¯æ¬¡æŸ¥è¯¢åˆ°valueåï¼Œæˆ‘ä»¬é€’å½’è°ƒç”¨parseValue()ï¼Œè¿™æ ·å°±å¯ä»¥æ”¯æŒåµŒå¥—çš„keyï¼Œä¾‹å¦‚ï¼š\n1 ${app.title:${APP_NAME:Summer}} è¿™æ ·å¯ä»¥å…ˆæŸ¥è¯¢app.titleï¼Œæ²¡æœ‰æ‰¾åˆ°å°±å†æŸ¥è¯¢APP_NAMEï¼Œè¿˜æ²¡æœ‰æ‰¾åˆ°å°±è¿”å›é»˜è®¤å€¼Summerã€‚\næ³¨æ„åˆ°Springçš„${...}è¡¨è¾¾å¼å®é™…ä¸Šå¯ä»¥åšåˆ°ç»„åˆï¼Œä¾‹å¦‚ï¼š\n1 jdbc.url=jdbc:mysql//${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME} è€Œæˆ‘ä»¬å®ç°çš„${...}è¡¨è¾¾å¼åªèƒ½åµŒå¥—ï¼Œä¸èƒ½ç»„åˆï¼Œå› ä¸ºè¦å®ç°Springçš„è¡¨è¾¾å¼ï¼Œéœ€è¦ç¼–å†™ä¸€ä¸ªå®Œæ•´çš„èƒ½è§£æè¡¨è¾¾å¼çš„å¤æ‚åŠŸèƒ½ï¼Œè€Œä¸èƒ½ä»…ä»…ä¾é åˆ¤æ–­${å¼€å¤´ã€}ç»“å°¾ã€‚ç”±äºè§£æè¡¨è¾¾å¼çš„åŠŸèƒ½è¿‡äºå¤æ‚ï¼Œå› æ­¤æˆ‘ä»¬å†³å®šä¸äºˆæ”¯æŒã€‚\nSpringè¿˜æ”¯æŒæ›´å¤æ‚çš„#{...}è¡¨è¾¾å¼ï¼Œå®ƒå¯ä»¥å¼•ç”¨Beanã€è°ƒç”¨æ–¹æ³•ã€è®¡ç®—ç­‰ï¼š\n1 #{appBean.version() + 1} ä¸ºæ­¤Springä¸“é—¨æä¾›äº†ä¸€ä¸ªspring-expressionåº“æ¥æ”¯æŒè¿™ç§æ›´å¤æ‚çš„åŠŸèƒ½ã€‚æŒ‰ç…§ä¸€åˆ‡ä»ç®€çš„åŸåˆ™ï¼Œæˆ‘ä»¬ä¸æ”¯æŒ#{...}è¡¨è¾¾å¼ã€‚\nå®ç°ç±»å‹è½¬æ¢ é™¤äº†Stringç±»å‹å¤–ï¼Œ@Valueæ³¨å…¥æ—¶ï¼Œè¿˜å…è®¸booleanã€intã€Longç­‰åŸºæœ¬ç±»å‹å’ŒåŒ…è£…ç±»å‹ã€‚æ­¤å¤–ï¼ŒSpringè¿˜æ”¯æŒDateã€Durationç­‰ç±»å‹çš„æ³¨å…¥ã€‚æˆ‘ä»¬æ—¢è¦å®ç°ç±»å‹è½¬æ¢ï¼Œåˆä¸èƒ½å†™æ­»ï¼Œå¦åˆ™ï¼Œå°†æ¥æ”¯æŒæ–°çš„ç±»å‹æ—¶å°±è¦æ”¹ä»£ç ã€‚\næˆ‘ä»¬å…ˆå†™ç±»å‹è½¬æ¢çš„å…¥å£æŸ¥è¯¢ï¼š\n1 2 3 4 5 6 7 8 9 @Nullable public T getProperty(String key, Class targetType) { String value = getProperty(key); if (value == null) { return null; } // è½¬æ¢ä¸ºæŒ‡å®šç±»å‹: return convert(targetType, value); } å†è€ƒè™‘å¦‚ä½•å®ç°convert()æ–¹æ³•ã€‚å¯¹äºç±»å‹è½¬æ¢ï¼Œå®é™…ä¸Šæ˜¯ä»Stringè½¬æ¢ä¸ºæŒ‡å®šç±»å‹ï¼Œå› æ­¤ï¼Œç”¨å‡½æ•°å¼æ¥å£Functionå°±å¾ˆåˆé€‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 public class PropertyResolver { // å­˜å‚¨Class -\u003e Function: Map",
  "wordCount" : "40407",
  "inLanguage": "en",
  "datePublished": "2023-04-13T15:50:13Z",
  "dateModified": "2023-04-13T15:50:13Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://wjy6.netlify.app/posts/spring/%E6%89%8B%E5%86%99spring/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://wjy6.netlify.app/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://wjy6.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://wjy6.netlify.app/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://wjy6.netlify.app/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://wjy6.netlify.app/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://wjy6.netlify.app/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://wjy6.netlify.app/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://wjy6.netlify.app/">Home</a>&nbsp;Â»&nbsp;<a href="https://wjy6.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      æ‰‹å†™Spring
    </h1>
    <div class="post-meta"><span title='2023-04-13 15:50:13 +0000 UTC'>2023-04-13</span>&nbsp;Â·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0ioc%e5%ae%b9%e5%99%a8" aria-label="å®ç°IOCå®¹å™¨">å®ç°IOCå®¹å™¨</a><ul>
                        
                <li>
                    <a href="#%e8%ae%be%e8%ae%a1%e7%9b%ae%e6%a0%87" aria-label="è®¾è®¡ç›®æ ‡">è®¾è®¡ç›®æ ‡</a></li>
                <li>
                    <a href="#annotation%e9%85%8d%e7%bd%ae" aria-label="Annotationé…ç½®">Annotationé…ç½®</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0resourceresolver" aria-label="å®ç°ResourceResolver">å®ç°ResourceResolver</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0propertyresolver" aria-label="å®ç°PropertyResolver">å®ç°PropertyResolver</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e7%b1%bb%e5%9e%8b%e8%bd%ac%e6%8d%a2" aria-label="å®ç°ç±»å‹è½¬æ¢">å®ç°ç±»å‹è½¬æ¢</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8yaml%e9%85%8d%e7%bd%ae" aria-label="ä½¿ç”¨YAMLé…ç½®">ä½¿ç”¨YAMLé…ç½®</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%babeandefinition" aria-label="åˆ›å»ºBeanDefinition">åˆ›å»ºBeanDefinition</a><ul>
                        
                <li>
                    <a href="#bean%e7%9a%84%e5%a3%b0%e6%98%8e%e7%b1%bb%e5%9e%8b" aria-label="Beançš„å£°æ˜ç±»å‹">Beançš„å£°æ˜ç±»å‹</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%babean%e5%ae%9e%e4%be%8b" aria-label="åˆ›å»ºBeanå®ä¾‹">åˆ›å»ºBeanå®ä¾‹</a></li>
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96bean" aria-label="åˆå§‹åŒ–Bean">åˆå§‹åŒ–Bean</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0beanpostprocessor" aria-label="å®ç°BeanPostProcessor">å®ç°BeanPostProcessor</a><ul>
                        
                <li>
                    <a href="#%e6%b5%8b%e8%af%95" aria-label="æµ‹è¯•">æµ‹è¯•</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%8c%e6%88%90ioc%e5%ae%b9%e5%99%a8" aria-label="å®ŒæˆIOCå®¹å™¨">å®ŒæˆIOCå®¹å™¨</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0aop" aria-label="å®ç°AOP">å®ç°AOP</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0proxyresolver" aria-label="å®ç°ProxyResolver">å®ç°ProxyResolver</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0around" aria-label="å®ç°Around">å®ç°Around</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0before%e5%92%8cafter" aria-label="å®ç°Beforeå’ŒAfter">å®ç°Beforeå’ŒAfter</a></li>
                <li>
                    <a href="#%e6%89%a9%e5%b1%95annotation" aria-label="æ‰©å±•Annotation">æ‰©å±•Annotation</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0jdbc%e5%92%8c%e4%ba%8b%e5%8a%a1" aria-label="å®ç°JDBCå’Œäº‹åŠ¡">å®ç°JDBCå’Œäº‹åŠ¡</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0jdbctemplate" aria-label="å®ç°JdbcTemplate">å®ç°JdbcTemplate</a><ul>
                        
                <li>
                    <a href="#%e9%85%8d%e7%bd%aedatasource" aria-label="é…ç½®DataSource">é…ç½®DataSource</a></li>
                <li>
                    <a href="#%e5%ae%9a%e4%b9%89jdbctemplate" aria-label="å®šä¹‰JdbcTemplate">å®šä¹‰JdbcTemplate</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e5%a3%b0%e6%98%8e%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="å®ç°å£°æ˜å¼äº‹åŠ¡">å®ç°å£°æ˜å¼äº‹åŠ¡</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0web-mvc" aria-label="å®ç°Web MVC">å®ç°Web MVC</a><ul>
                        
                <li>
                    <a href="#%e5%90%af%e5%8a%a8ioc%e5%ae%b9%e5%99%a8" aria-label="å¯åŠ¨IoCå®¹å™¨">å¯åŠ¨IoCå®¹å™¨</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0mvc" aria-label="å®ç°MVC">å®ç°MVC</a><ul>
                        
                <li>
                    <a href="#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" aria-label="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95-1" aria-label="æµ‹è¯•">æµ‹è¯•</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%80%e5%8f%91web%e5%ba%94%e7%94%a8" aria-label="å¼€å‘Webåº”ç”¨">å¼€å‘Webåº”ç”¨</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0boot" aria-label="å®ç°Boot">å®ç°Boot</a><ul>
                        
                <li>
                    <a href="#%e5%90%af%e5%8a%a8%e5%b5%8c%e5%85%a5%e5%bc%8ftomcat" aria-label="å¯åŠ¨åµŒå…¥å¼Tomcat">å¯åŠ¨åµŒå…¥å¼Tomcat</a></li>
                <li>
                    <a href="#%e5%bc%80%e5%8f%91boot%e5%ba%94%e7%94%a8" aria-label="å¼€å‘Bootåº”ç”¨">å¼€å‘Bootåº”ç”¨</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="å®ç°iocå®¹å™¨">å®ç°IOCå®¹å™¨<a hidden class="anchor" aria-hidden="true" href="#å®ç°iocå®¹å™¨">#</a></h1>
<p>Springçš„æ ¸å¿ƒå°±æ˜¯èƒ½ç®¡ç†ä¸€ç»„Beanï¼Œå¹¶èƒ½è‡ªåŠ¨é…ç½®ä¾èµ–å…³ç³»çš„IoCå®¹å™¨ã€‚è€Œæˆ‘ä»¬çš„Summer Frameworkçš„æ ¸å¿ƒcontextæ¨¡å—å°±æ˜¯è¦å®ç°IoCå®¹å™¨ã€‚</p>
<p><a href="https://www.liaoxuefeng.com/wiki/1539348902182944">æ‰‹å†™Spring - å»–é›ªå³°çš„å®˜æ–¹ç½‘ç«™ (liaoxuefeng.com)</a></p>
<h2 id="è®¾è®¡ç›®æ ‡">è®¾è®¡ç›®æ ‡<a hidden class="anchor" aria-hidden="true" href="#è®¾è®¡ç›®æ ‡">#</a></h2>
<p>Springçš„IoCå®¹å™¨åˆ†ä¸ºä¸¤ç±»ï¼šBeanFactoryå’ŒApplicationContextï¼Œå‰è€…æ€»æ˜¯å»¶è¿Ÿåˆ›å»ºBeanï¼Œè€Œåè€…åˆ™åœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–æ‰€æœ‰Beanã€‚å®é™…ä½¿ç”¨æ—¶ï¼Œ99%éƒ½é‡‡ç”¨ApplicationContextï¼Œå› æ­¤ï¼ŒSummer Frameworkä»…å®ç°ApplicationContextï¼Œä¸æ”¯æŒBeanFactoryã€‚</p>
<p>æ—©æœŸçš„Springå®¹å™¨é‡‡ç”¨XMLæ¥é…ç½®Beanï¼ŒåæœŸåˆåŠ å…¥äº†è‡ªåŠ¨æ‰«æåŒ…çš„åŠŸèƒ½ï¼Œå³é€šè¿‡<code>&lt;context:component-scan base-package=&quot;org.example&quot;/&gt;</code>çš„é…ç½®ã€‚å†åæ¥ï¼ŒåˆåŠ å…¥äº†Annotationé…ç½®ï¼Œå¹¶é€šè¿‡<code>@ComponentScan</code>æ³¨è§£å®ç°è‡ªåŠ¨æ‰«æã€‚å¦‚æœä½¿ç”¨Spring Bootï¼Œåˆ™99%éƒ½é‡‡ç”¨<code>@ComponentScan</code>æ³¨è§£æ–¹å¼é…ç½®ï¼Œå› æ­¤ï¼ŒSummer Frameworkä¹Ÿä»…å®ç°Annotationé…ç½®+<code>@ComponentScan</code>æ‰«ææ–¹å¼å®Œæˆå®¹å™¨çš„é…ç½®ã€‚</p>
<p>æ­¤å¤–ï¼ŒSummer Frameworkä»…æ”¯æŒSingletonç±»å‹çš„Beanï¼Œä¸æ”¯æŒPrototypeç±»å‹çš„Beanï¼Œå› ä¸ºå®é™…ä½¿ç”¨ä¸­ï¼Œ99%éƒ½é‡‡ç”¨Singletonã€‚ä¾èµ–æ³¨å…¥åˆ™ä¸Springä¿æŒä¸€è‡´ï¼Œæ”¯æŒæ„é€ æ–¹æ³•ã€Setteræ–¹æ³•ä¸å­—æ®µæ³¨å…¥ã€‚æ”¯æŒ<code>@Configuration</code>å’Œ<code>BeanPostProcessor</code>ã€‚è‡³äºSpringçš„å…¶ä»–åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œå±‚çº§å®¹å™¨ã€MessageSourceã€ä¸€ä¸ªBeanå…è®¸å¤šä¸ªåå­—ç­‰åŠŸèƒ½ï¼Œä¸€æ¦‚ä¸æ”¯æŒï¼</p>
<p>ä¸‹è¡¨åˆ—å‡ºäº†Spring Frameworkå’ŒSummer Frameworkåœ¨IoCå®¹å™¨æ–¹é¢çš„å¼‚åŒï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">åŠŸèƒ½</th>
<th style="text-align:left">Spring Framework</th>
<th style="text-align:left">Summer Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">IoCå®¹å™¨</td>
<td style="text-align:left">æ”¯æŒBeanFactoryå’ŒApplicationContext</td>
<td style="text-align:left">ä»…æ”¯æŒApplicationContext</td>
</tr>
<tr>
<td style="text-align:left">é…ç½®æ–¹å¼</td>
<td style="text-align:left">æ”¯æŒXMLä¸Annotation</td>
<td style="text-align:left">ä»…æ”¯æŒAnnotation</td>
</tr>
<tr>
<td style="text-align:left">æ‰«ææ–¹å¼</td>
<td style="text-align:left">æ”¯æŒæŒ‰åŒ…åæ‰«æ</td>
<td style="text-align:left">æ”¯æŒæŒ‰åŒ…åæ‰«æ</td>
</tr>
<tr>
<td style="text-align:left">Beanç±»å‹</td>
<td style="text-align:left">æ”¯æŒSingletonå’ŒPrototype</td>
<td style="text-align:left">ä»…æ”¯æŒSingleton</td>
</tr>
<tr>
<td style="text-align:left">Beanå·¥å‚</td>
<td style="text-align:left">æ”¯æŒFactoryBeanå’Œ@Beanæ³¨è§£</td>
<td style="text-align:left">ä»…æ”¯æŒ@Beanæ³¨è§£</td>
</tr>
<tr>
<td style="text-align:left">å®šåˆ¶Bean</td>
<td style="text-align:left">æ”¯æŒBeanPostProcessor</td>
<td style="text-align:left">æ”¯æŒBeanPostProcessor</td>
</tr>
<tr>
<td style="text-align:left">ä¾èµ–æ³¨å…¥</td>
<td style="text-align:left">æ”¯æŒæ„é€ æ–¹æ³•ã€Setteræ–¹æ³•ä¸å­—æ®µ</td>
<td style="text-align:left">æ”¯æŒæ„é€ æ–¹æ³•ã€Setteræ–¹æ³•ä¸å­—æ®µ</td>
</tr>
<tr>
<td style="text-align:left">å¤šå®¹å™¨</td>
<td style="text-align:left">æ”¯æŒçˆ¶å­å®¹å™¨</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
</tbody>
</table>
<h2 id="annotationé…ç½®">Annotationé…ç½®<a hidden class="anchor" aria-hidden="true" href="#annotationé…ç½®">#</a></h2>
<p>ä»ä½¿ç”¨è€…çš„è§’åº¦çœ‹ï¼Œä½¿ç”¨IoCå®¹å™¨æ—¶ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªå…¥å£é…ç½®ï¼Œå®ƒé€šå¸¸é•¿è¿™æ ·ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>AppConfig</code>åªæ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œå®ƒçš„ç›®çš„æ˜¯é€šè¿‡<code>@ComponentScan</code>æ¥æ ‡è¯†è¦æ‰«æçš„Beançš„åŒ…ã€‚å¦‚æœæ²¡æœ‰æ˜ç¡®å†™å‡ºåŒ…åï¼Œé‚£ä¹ˆå°†åŸºäº<code>AppConfig</code>æ‰€åœ¨åŒ…è¿›è¡Œæ‰«æï¼Œå¦‚æœæ˜ç¡®å†™å‡ºäº†åŒ…åï¼Œåˆ™åœ¨æŒ‡å®šçš„åŒ…ä¸‹è¿›è¡Œæ‰«æã€‚</p>
<p>åœ¨æ‰«æè¿‡ç¨‹ä¸­ï¼Œå‡¡æ˜¯å¸¦æœ‰æ³¨è§£<code>@Component</code>çš„ç±»ï¼Œå°†è¢«æ·»åŠ åˆ°IoCå®¹å™¨è¿›è¡Œç®¡ç†ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Hello {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ç”¨åˆ°çš„è®¸å¤šç¬¬ä¸‰æ–¹ç»„ä»¶ä¹Ÿç»å¸¸ä¼šçº³å…¥IoCå®¹å™¨ç®¡ç†ã€‚è¿™äº›ç¬¬ä¸‰æ–¹ç»„ä»¶æ˜¯ä¸å¯èƒ½å¸¦æœ‰<code>@Component</code>æ³¨è§£çš„ï¼Œå¼•å…¥ç¬¬ä¸‰æ–¹Beanåªèƒ½é€šè¿‡å·¥å‚æ¨¡å¼ï¼Œå³åœ¨<code>@Configuration</code>å·¥å‚ç±»ä¸­å®šä¹‰å¸¦<code>@Bean</code>çš„å·¥å‚æ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DbConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    DataSource createDataSource(...) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> HikariDataSource(...);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    JdbcTemplate createJdbcTemplate(...) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> JdbcTemplate(...);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŸºäºAnnotationé…ç½®çš„IoCå®¹å™¨åŸºæœ¬ç”¨æ³•å°±æ˜¯ä¸Šé¢æ‰€è¿°ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å°±ä¸€æ­¥ä¸€æ­¥æ¥å®ç°IoCå®¹å™¨ã€‚</p>
<h2 id="å®ç°resourceresolver">å®ç°ResourceResolver<a hidden class="anchor" aria-hidden="true" href="#å®ç°resourceresolver">#</a></h2>
<p>åœ¨ç¼–å†™IoCå®¹å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å®ç°<code>@ComponentScan</code>ï¼Œå³è§£å†³<code>åœ¨æŒ‡å®šåŒ…ä¸‹æ‰«ææ‰€æœ‰Class</code>çš„é—®é¢˜ã€‚</p>
<p>Javaçš„ClassLoaderæœºåˆ¶å¯ä»¥åœ¨æŒ‡å®šçš„Classpathä¸­æ ¹æ®ç±»ååŠ è½½æŒ‡å®šçš„Classï¼Œä½†é—æ†¾çš„æ˜¯ï¼Œç»™å‡ºä¸€ä¸ªåŒ…åï¼Œä¾‹å¦‚ï¼Œ<code>org.example</code>ï¼Œå®ƒå¹¶ä¸èƒ½è·å–åˆ°è¯¥åŒ…ä¸‹çš„æ‰€æœ‰Classï¼Œä¹Ÿä¸èƒ½è·å–å­åŒ…ã€‚</p>
<p>è¦åœ¨Classpathä¸­æ‰«ææŒ‡å®šåŒ…åä¸‹çš„æ‰€æœ‰Classï¼ŒåŒ…æ‹¬å­åŒ…ï¼Œå®é™…ä¸Šæ˜¯åœ¨Classpathä¸­æœç´¢æ‰€æœ‰æ–‡ä»¶ï¼Œæ‰¾å‡ºæ–‡ä»¶ååŒ¹é…çš„<code>.class</code>æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼ŒClasspathä¸­æœç´¢çš„æ–‡ä»¶<code>org/example/Hello.class</code>å°±ç¬¦åˆåŒ…å<code>org.example</code>ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æ–‡ä»¶è·¯å¾„æŠŠå®ƒå˜ä¸º<code>org.example.Hello</code>ï¼Œå°±ç›¸å½“äºè·å¾—äº†ç±»åã€‚å› æ­¤ï¼Œæœç´¢Classå˜æˆäº†æœç´¢æ–‡ä»¶ã€‚</p>
<p>æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ª<code>Resource</code>ç±»å‹è¡¨ç¤ºæ–‡ä»¶ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">record</span> Resource(String path, String name) {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†ä»¿é€ Springæä¾›ä¸€ä¸ª<code>ResourceResolver</code>ï¼Œå®šä¹‰<code>scan()</code>æ–¹æ³•æ¥è·å–æ‰«æåˆ°çš„<code>Resource</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ResourceResolver {
</span></span><span style="display:flex;"><span>    String basePackage;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ResourceResolver(String basePackage) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">basePackage</span> = basePackage;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> &lt;R&gt; List&lt;R&gt; scan(Function&lt;Resource, R&gt; mapper) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰«ææŒ‡å®šåŒ…ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚æœ‰çš„åŒå­¦ä¼šé—®ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯æ‰«æ<code>.class</code>æ–‡ä»¶ï¼Œå¦‚ä½•è¿‡æ»¤å‡ºClassï¼Ÿ</p>
<p>æ³¨æ„åˆ°<code>scan()</code>æ–¹æ³•ä¼ å…¥äº†ä¸€ä¸ªæ˜ å°„å‡½æ•°ï¼Œæˆ‘ä»¬ä¼ å…¥<code>Resource</code>åˆ°Class Nameçš„æ˜ å°„ï¼Œå°±å¯ä»¥æ‰«æå‡ºClass Nameï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// å®šä¹‰ä¸€ä¸ªæ‰«æå™¨:</span>
</span></span><span style="display:flex;"><span>ResourceResolver rr = <span style="color:#fff;font-weight:bold">new</span> ResourceResolver(<span style="color:#0ff;font-weight:bold">&#34;org.example&#34;</span>);
</span></span><span style="display:flex;"><span>List&lt;String&gt; classList = rr.<span style="color:#007f7f">scan</span>(res -&gt; {
</span></span><span style="display:flex;"><span>    String name = res.<span style="color:#007f7f">name</span>(); <span style="color:#007f7f">// èµ„æºåç§°&#34;org/example/Hello.class&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (name.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.class&#34;</span>)) { <span style="color:#007f7f">// å¦‚æœä»¥.classç»“å°¾</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æŠŠ&#34;org/example/Hello.class&#34;å˜ä¸º&#34;org.example.Hello&#34;:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> name.<span style="color:#007f7f">substring</span>(0, name.<span style="color:#007f7f">length</span>() - 6).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;\\&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å¦åˆ™è¿”å›nullè¡¨ç¤ºä¸æ˜¯æœ‰æ•ˆçš„Class Name:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ï¼Œ<code>ResourceResolver</code>åªè´Ÿè´£æ‰«æå¹¶åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ï¼Œç”±å®¢æˆ·ç«¯å†³å®šæ˜¯æ‰¾å‡º<code>.class</code>æ–‡ä»¶ï¼Œè¿˜æ˜¯æ‰¾å‡º<code>.properties</code>æ–‡ä»¶ã€‚</p>
<p>åœ¨ClassPathä¸­æ‰«ææ–‡ä»¶çš„ä»£ç æ˜¯å›ºå®šæ¨¡å¼ï¼Œå¯ä»¥åœ¨ç½‘ä¸Šæœç´¢è·å¾—ï¼Œä¾‹å¦‚StackOverflowçš„<a href="https://stackoverflow.com/questions/520328/can-you-find-all-classes-in-a-package-using-reflection#58773038">è¿™ä¸ªå›ç­”</a>ã€‚è¿™é‡Œè¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼ŒJavaæ”¯æŒåœ¨jaråŒ…ä¸­æœç´¢æ–‡ä»¶ï¼Œæ‰€ä»¥ï¼Œä¸ä½†éœ€è¦åœ¨æ™®é€šç›®å½•ä¸­æœç´¢ï¼Œä¹Ÿéœ€è¦åœ¨Classpathä¸­åˆ—å‡ºçš„jaråŒ…ä¸­æœç´¢ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// é€šè¿‡ClassLoaderè·å–URLåˆ—è¡¨:</span>
</span></span><span style="display:flex;"><span>Enumeration&lt;URL&gt; en = getContextClassLoader().<span style="color:#007f7f">getResources</span>(<span style="color:#0ff;font-weight:bold">&#34;org/example&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">while</span> (en.<span style="color:#007f7f">hasMoreElements</span>()) {
</span></span><span style="display:flex;"><span>    URL url = en.<span style="color:#007f7f">nextElement</span>();
</span></span><span style="display:flex;"><span>    URI uri = url.<span style="color:#007f7f">toURI</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (uri.<span style="color:#007f7f">toString</span>().<span style="color:#007f7f">startsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;file:&#34;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åœ¨ç›®å½•ä¸­æœç´¢</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (uri.<span style="color:#007f7f">toString</span>().<span style="color:#007f7f">startsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;jar:&#34;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åœ¨JaråŒ…ä¸­æœç´¢</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡ ä¸ªè¦ç‚¹ï¼š</p>
<ol>
<li>ClassLoaderé¦–å…ˆä»<code>Thread.getContextClassLoader()</code>è·å–ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œå†ä»å½“å‰Classè·å–ï¼Œå› ä¸ºWebåº”ç”¨çš„ClassLoaderä¸æ˜¯JVMæä¾›çš„åŸºäºClasspathçš„ClassLoaderï¼Œè€Œæ˜¯Servletå®¹å™¨æä¾›çš„ClassLoaderï¼Œå®ƒä¸åœ¨é»˜è®¤çš„Classpathæœç´¢ï¼Œè€Œæ˜¯åœ¨<code>/WEB-INF/classes</code>ç›®å½•å’Œ<code>/WEB-INF/lib</code>çš„æ‰€æœ‰jaråŒ…æœç´¢ï¼Œä»<code>Thread.getContextClassLoader()</code>å¯ä»¥è·å–åˆ°Servletå®¹å™¨ä¸“å±çš„ClassLoaderï¼›</li>
<li>Windowså’ŒLinux/macOSçš„è·¯å¾„åˆ†éš”ç¬¦ä¸åŒï¼Œå‰è€…æ˜¯<code>\</code>ï¼Œåè€…æ˜¯<code>/</code>ï¼Œéœ€è¦æ­£ç¡®å¤„ç†ï¼›</li>
<li>æ‰«æç›®å½•æ—¶ï¼Œè¿”å›çš„è·¯å¾„å¯èƒ½æ˜¯<code>abc/xyz</code>ï¼Œä¹Ÿå¯èƒ½æ˜¯<code>abc/xyz/</code>ï¼Œéœ€è¦æ³¨æ„å¤„ç†æœ«å°¾çš„<code>/</code>ã€‚</li>
</ol>
<p>è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†èƒ½æ‰«ææŒ‡å®šåŒ…ä»¥åŠå­åŒ…ä¸‹æ‰€æœ‰æ–‡ä»¶çš„<code>ResourceResolver</code>ã€‚</p>
<h2 id="å®ç°propertyresolver">å®ç°PropertyResolver<a hidden class="anchor" aria-hidden="true" href="#å®ç°propertyresolver">#</a></h2>
<p>Springçš„æ³¨å…¥åˆ†ä¸º<code>@Autowired</code>å’Œ<code>@Value</code>ä¸¤ç§ã€‚å¯¹äº<code>@Autowired</code>ï¼Œæ¶‰åŠåˆ°Beançš„ä¾èµ–ï¼Œè€Œå¯¹äº<code>@Value</code>ï¼Œåˆ™ä»…ä»…æ˜¯å°†å¯¹åº”çš„é…ç½®æ³¨å…¥ï¼Œä¸æ¶‰åŠBeançš„ä¾èµ–ï¼Œç›¸å¯¹æ¯”è¾ƒç®€å•ã€‚ä¸ºäº†æ³¨å…¥é…ç½®ï¼Œæˆ‘ä»¬ç”¨<code>PropertyResolver</code>ä¿å­˜æ‰€æœ‰é…ç½®é¡¹ï¼Œå¯¹å¤–æä¾›æŸ¥è¯¢åŠŸèƒ½ã€‚</p>
<p>æœ¬èŠ‚æˆ‘ä»¬æ¥å®ç°<code>PropertyResolver</code>ï¼Œå®ƒæ”¯æŒ3ç§æŸ¥è¯¢æ–¹å¼ï¼š</p>
<ol>
<li>æŒ‰é…ç½®çš„keyæŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼š<code>getProperty(&quot;app.title&quot;)</code>;</li>
<li>ä»¥<code>${abc.xyz}</code>å½¢å¼çš„æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼Œ<code>getProperty(&quot;${app.title}&quot;)</code>ï¼Œå¸¸ç”¨äº<code>@Value(&quot;${app.title}&quot;)</code>æ³¨å…¥ï¼›</li>
<li>å¸¦é»˜è®¤å€¼çš„ï¼Œä»¥<code>${abc.xyz:defaultValue}</code>å½¢å¼çš„æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼Œ<code>getProperty(&quot;${app.title:Summer}&quot;)</code>ï¼Œå¸¸ç”¨äº<code>@Value(&quot;${app.title:Summer}&quot;)</code>æ³¨å…¥ã€‚</li>
</ol>
<p>Javaæœ¬èº«æä¾›äº†æŒ‰key-valueæŸ¥è¯¢çš„<code>Properties</code>ï¼Œæˆ‘ä»¬å…ˆä¼ å…¥<code>Properties</code>ï¼Œå†…éƒ¨æŒ‰key-valueå­˜å‚¨ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PropertyResolver {
</span></span><span style="display:flex;"><span>    Map&lt;String, String&gt; properties = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> PropertyResolver(Properties props) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å­˜å…¥ç¯å¢ƒå˜é‡:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">properties</span>.<span style="color:#007f7f">putAll</span>(System.<span style="color:#007f7f">getenv</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å­˜å…¥Properties:</span>
</span></span><span style="display:flex;"><span>        Set&lt;String&gt; names = props.<span style="color:#007f7f">stringPropertyNames</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (String name : names) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">properties</span>.<span style="color:#007f7f">put</span>(name, props.<span style="color:#007f7f">getProperty</span>(name));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨<code>PropertyResolver</code>å†…éƒ¨ï¼Œé€šè¿‡ä¸€ä¸ª<code>Map&lt;String, String&gt;</code>å­˜å‚¨äº†æ‰€æœ‰çš„é…ç½®é¡¹ï¼ŒåŒ…æ‹¬ç¯å¢ƒå˜é‡ã€‚å¯¹äºæŒ‰keyæŸ¥è¯¢çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Nullable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> String getProperty(String key) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">properties</span>.<span style="color:#007f7f">get</span>(key);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å‡†å¤‡è§£æ<code>${abc.xyz:defaultValue}</code>è¿™æ ·çš„keyï¼Œå…ˆå®šä¹‰ä¸€ä¸ª<code>PropertyExpr</code>ï¼ŒæŠŠè§£æåçš„keyå’ŒdefaultValueå­˜å‚¨èµ·æ¥ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">record</span> PropertyExpr(String key, String defaultValue) {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæŒ‰<code>${...}</code>è§£æï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>PropertyExpr parsePropertyExpr(String key) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (key.<span style="color:#007f7f">startsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;${&#34;</span>) &amp;&amp; key.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;}&#34;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ˜¯å¦å­˜åœ¨defaultValue?</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> n = key.<span style="color:#007f7f">indexOf</span>(<span style="color:#0ff;font-weight:bold">&#39;:&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (n == (-1)) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// æ²¡æœ‰defaultValue: ${key}</span>
</span></span><span style="display:flex;"><span>            String k = key.<span style="color:#007f7f">substring</span>(2, key.<span style="color:#007f7f">length</span>() - 1);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> PropertyExpr(k, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// æœ‰defaultValue: ${key:default}</span>
</span></span><span style="display:flex;"><span>            String k = key.<span style="color:#007f7f">substring</span>(2, n);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> PropertyExpr(k, key.<span style="color:#007f7f">substring</span>(n + 1, key.<span style="color:#007f7f">length</span>() - 1));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬æŠŠ<code>getProperty()</code>æ”¹é€ ä¸€ä¸‹ï¼Œå³å¯å®ç°æŸ¥è¯¢<code>${abc.xyz:defaultValue}</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Nullable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> String getProperty(String key) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è§£æ${abc.xyz:defaultValue}:</span>
</span></span><span style="display:flex;"><span>    PropertyExpr keyExpr = parsePropertyExpr(key);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (keyExpr != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (keyExpr.<span style="color:#007f7f">defaultValue</span>() != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å¸¦é»˜è®¤å€¼æŸ¥è¯¢:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> getProperty(keyExpr.<span style="color:#007f7f">key</span>(), keyExpr.<span style="color:#007f7f">defaultValue</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// ä¸å¸¦é»˜è®¤å€¼æŸ¥è¯¢:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> getRequiredProperty(keyExpr.<span style="color:#007f7f">key</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ™®é€škeyæŸ¥è¯¢:</span>
</span></span><span style="display:flex;"><span>    String value = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">properties</span>.<span style="color:#007f7f">get</span>(key);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (value != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> parseValue(value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> value;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯æ¬¡æŸ¥è¯¢åˆ°valueåï¼Œæˆ‘ä»¬é€’å½’è°ƒç”¨<code>parseValue()</code>ï¼Œè¿™æ ·å°±å¯ä»¥æ”¯æŒåµŒå¥—çš„keyï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>${app.<span style="color:#007f7f">title</span>:${APP_NAME:Summer}}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·å¯ä»¥å…ˆæŸ¥è¯¢<code>app.title</code>ï¼Œæ²¡æœ‰æ‰¾åˆ°å°±å†æŸ¥è¯¢<code>APP_NAME</code>ï¼Œè¿˜æ²¡æœ‰æ‰¾åˆ°å°±è¿”å›é»˜è®¤å€¼<code>Summer</code>ã€‚</p>
<p>æ³¨æ„åˆ°Springçš„<code>${...}</code>è¡¨è¾¾å¼å®é™…ä¸Šå¯ä»¥åšåˆ°ç»„åˆï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>jdbc.<span style="color:#007f7f">url</span>=jdbc:mysql<span style="color:#007f7f">//${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è€Œæˆ‘ä»¬å®ç°çš„<code>${...}</code>è¡¨è¾¾å¼åªèƒ½åµŒå¥—ï¼Œä¸èƒ½ç»„åˆï¼Œå› ä¸ºè¦å®ç°Springçš„è¡¨è¾¾å¼ï¼Œéœ€è¦ç¼–å†™ä¸€ä¸ªå®Œæ•´çš„èƒ½è§£æè¡¨è¾¾å¼çš„å¤æ‚åŠŸèƒ½ï¼Œè€Œä¸èƒ½ä»…ä»…ä¾é åˆ¤æ–­<code>${</code>å¼€å¤´ã€<code>}</code>ç»“å°¾ã€‚ç”±äºè§£æè¡¨è¾¾å¼çš„åŠŸèƒ½è¿‡äºå¤æ‚ï¼Œå› æ­¤æˆ‘ä»¬å†³å®šä¸äºˆæ”¯æŒã€‚</p>
<p>Springè¿˜æ”¯æŒæ›´å¤æ‚çš„<code>#{...}</code>è¡¨è¾¾å¼ï¼Œå®ƒå¯ä»¥å¼•ç”¨Beanã€è°ƒç”¨æ–¹æ³•ã€è®¡ç®—ç­‰ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f00">#</span>{appBean.<span style="color:#007f7f">version</span>() + 1}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸ºæ­¤Springä¸“é—¨æä¾›äº†ä¸€ä¸ª<code>spring-expression</code>åº“æ¥æ”¯æŒè¿™ç§æ›´å¤æ‚çš„åŠŸèƒ½ã€‚æŒ‰ç…§ä¸€åˆ‡ä»ç®€çš„åŸåˆ™ï¼Œæˆ‘ä»¬ä¸æ”¯æŒ<code>#{...}</code>è¡¨è¾¾å¼ã€‚</p>
<h3 id="å®ç°ç±»å‹è½¬æ¢">å®ç°ç±»å‹è½¬æ¢<a hidden class="anchor" aria-hidden="true" href="#å®ç°ç±»å‹è½¬æ¢">#</a></h3>
<p>é™¤äº†Stringç±»å‹å¤–ï¼Œ@Valueæ³¨å…¥æ—¶ï¼Œè¿˜å…è®¸<code>boolean</code>ã€<code>int</code>ã€<code>Long</code>ç­‰åŸºæœ¬ç±»å‹å’ŒåŒ…è£…ç±»å‹ã€‚æ­¤å¤–ï¼ŒSpringè¿˜æ”¯æŒ<code>Date</code>ã€<code>Duration</code>ç­‰ç±»å‹çš„æ³¨å…¥ã€‚æˆ‘ä»¬æ—¢è¦å®ç°ç±»å‹è½¬æ¢ï¼Œåˆä¸èƒ½å†™æ­»ï¼Œå¦åˆ™ï¼Œå°†æ¥æ”¯æŒæ–°çš„ç±»å‹æ—¶å°±è¦æ”¹ä»£ç ã€‚</p>
<p>æˆ‘ä»¬å…ˆå†™ç±»å‹è½¬æ¢çš„å…¥å£æŸ¥è¯¢ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Nullable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T getProperty(String key, Class&lt;T&gt; targetType) {
</span></span><span style="display:flex;"><span>    String value = getProperty(key);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (value == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è½¬æ¢ä¸ºæŒ‡å®šç±»å‹:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> convert(targetType, value);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†è€ƒè™‘å¦‚ä½•å®ç°<code>convert()</code>æ–¹æ³•ã€‚å¯¹äºç±»å‹è½¬æ¢ï¼Œå®é™…ä¸Šæ˜¯ä»Stringè½¬æ¢ä¸ºæŒ‡å®šç±»å‹ï¼Œå› æ­¤ï¼Œç”¨å‡½æ•°å¼æ¥å£<code>Function&lt;String, Object&gt;</code>å°±å¾ˆåˆé€‚ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PropertyResolver {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å­˜å‚¨Class -&gt; Function:</span>
</span></span><span style="display:flex;"><span>    Map&lt;Class&lt;?&gt;, Function&lt;String, Object&gt;&gt; converters = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è½¬æ¢åˆ°æŒ‡å®šClassç±»å‹:</span>
</span></span><span style="display:flex;"><span>    &lt;T&gt; T convert(Class&lt;?&gt; clazz, String value) {
</span></span><span style="display:flex;"><span>        Function&lt;String, Object&gt; fn = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">converters</span>.<span style="color:#007f7f">get</span>(clazz);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (fn == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalArgumentException(<span style="color:#0ff;font-weight:bold">&#34;Unsupported value type: &#34;</span> + clazz.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> (T) fn.<span style="color:#007f7f">apply</span>(value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·æˆ‘ä»¬å°±å·²ç»å®ç°äº†ç±»å‹è½¬æ¢ï¼Œä¸‹ä¸€æ­¥æ˜¯æŠŠå„ç§è¦è½¬æ¢çš„ç±»å‹æ”¾åˆ°<code>Map</code>é‡Œã€‚åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ”¾å…¥å¸¸ç”¨çš„åŸºæœ¬ç±»å‹è½¬æ¢å™¨ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> PropertyResolver(Properties props) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Stringç±»å‹:</span>
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(String.<span style="color:#007f7f">class</span>, s -&gt; s);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// booleanç±»å‹:</span>
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(<span style="color:#fff;font-weight:bold">boolean</span>.<span style="color:#007f7f">class</span>, s -&gt; Boolean.<span style="color:#007f7f">parseBoolean</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(Boolean.<span style="color:#007f7f">class</span>, s -&gt; Boolean.<span style="color:#007f7f">valueOf</span>(s));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// intç±»å‹:</span>
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(<span style="color:#fff;font-weight:bold">int</span>.<span style="color:#007f7f">class</span>, s -&gt; Integer.<span style="color:#007f7f">parseInt</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(Integer.<span style="color:#007f7f">class</span>, s -&gt; Integer.<span style="color:#007f7f">valueOf</span>(s));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å…¶ä»–åŸºæœ¬ç±»å‹...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Date/Timeç±»å‹:</span>
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(LocalDate.<span style="color:#007f7f">class</span>, s -&gt; LocalDate.<span style="color:#007f7f">parse</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(LocalTime.<span style="color:#007f7f">class</span>, s -&gt; LocalTime.<span style="color:#007f7f">parse</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(LocalDateTime.<span style="color:#007f7f">class</span>, s -&gt; LocalDateTime.<span style="color:#007f7f">parse</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(ZonedDateTime.<span style="color:#007f7f">class</span>, s -&gt; ZonedDateTime.<span style="color:#007f7f">parse</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(Duration.<span style="color:#007f7f">class</span>, s -&gt; Duration.<span style="color:#007f7f">parse</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(ZoneId.<span style="color:#007f7f">class</span>, s -&gt; ZoneId.<span style="color:#007f7f">of</span>(s));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœå†åŠ ä¸€ä¸ª<code>registerConverter()</code>æ¥å£ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹å¤–æä¾›æ‰©å±•ï¼Œè®©ç”¨æˆ·è‡ªå·±ç¼–å†™è‡ªå·±å®šåˆ¶çš„Converterï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬çš„PropertyResolverå°±å‡†å¤‡å°±ç»ªï¼Œè¯»å–é…ç½®çš„åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// Javaæ ‡å‡†åº“è¯»å–propertiesæ–‡ä»¶:</span>
</span></span><span style="display:flex;"><span>Properties props = <span style="color:#fff;font-weight:bold">new</span> Properties();
</span></span><span style="display:flex;"><span>props.<span style="color:#007f7f">load</span>(fileInput); <span style="color:#007f7f">// æ–‡ä»¶è¾“å…¥æµ</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// æ„é€ PropertyResolver:</span>
</span></span><span style="display:flex;"><span>PropertyResolver pr = <span style="color:#fff;font-weight:bold">new</span> PropertyResolver(props);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// åç»­ä»£ç è°ƒç”¨...</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// pr.getProperty(&#34;${app.version:1}&#34;, int.class)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä½¿ç”¨yamlé…ç½®">ä½¿ç”¨YAMLé…ç½®<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨yamlé…ç½®">#</a></h3>
<p>Spring Frameworkå¹¶ä¸æ”¯æŒYAMLé…ç½®ï¼Œä½†Spring Bootæ”¯æŒã€‚å› ä¸ºYAMLé…ç½®æ¯”<code>.properties</code>è¦æ–¹ä¾¿ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå¯¹YAMLçš„æ”¯æŒä¹Ÿé›†æˆè¿›æ¥ã€‚</p>
<p>é¦–å…ˆå¼•å…¥ä¾èµ–<code>org.yaml:snakeyaml:2.0</code>ï¼Œç„¶åæˆ‘ä»¬å†™ä¸€ä¸ª<code>YamlUtils</code>ï¼Œé€šè¿‡<code>loadYamlAsPlainMap()</code>æ–¹æ³•è¯»å–ä¸€ä¸ªYAMLæ–‡ä»¶ï¼Œå¹¶è¿”å›<code>Map</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> YamlUtils {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Map&lt;String, Object&gt; loadYamlAsPlainMap(String path) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬æŠŠYAMLæ ¼å¼ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>app:
</span></span><span style="display:flex;"><span>  title: Summer Framework
</span></span><span style="display:flex;"><span>  version: ${VER:1.<span style="color:#007f7f">0</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¯»å–ä¸º<code>Map</code>ï¼Œå…¶ä¸­ï¼Œæ¯ä¸ªkeyéƒ½æ˜¯å®Œæ•´è·¯å¾„ï¼Œç›¸å½“äºæŠŠå®ƒå˜ä¸º<code>.properties</code>æ ¼å¼ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>app.<span style="color:#007f7f">title</span>=Summer Framework
</span></span><span style="display:flex;"><span>app.<span style="color:#007f7f">version</span>=${VER:1.<span style="color:#007f7f">0</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·æˆ‘ä»¬æ— éœ€æ”¹åŠ¨<code>PropertyResolver</code>çš„ä»£ç ï¼Œä½¿ç”¨YAMLæ—¶ï¼Œå¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼è¯»å–é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Map&lt;String, Object&gt; configs = YamlUtils.<span style="color:#007f7f">loadYamlAsPlainMap</span>(<span style="color:#0ff;font-weight:bold">&#34;/application.yml&#34;</span>);
</span></span><span style="display:flex;"><span>Properties props = <span style="color:#fff;font-weight:bold">new</span> Properties();
</span></span><span style="display:flex;"><span>props.<span style="color:#007f7f">putAll</span>(config);
</span></span><span style="display:flex;"><span>PropertyResolver pr = <span style="color:#fff;font-weight:bold">new</span> PropertyResolver(props);
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¯»å–YAMLçš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œæ³¨æ„è¦ç‚¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>SnakeYamlé»˜è®¤è¯»å‡ºçš„ç»“æ„æ˜¯æ ‘å½¢ç»“æ„ï¼Œéœ€è¦â€œæ‹å¹³â€æˆ<code>abc.xyz</code>æ ¼å¼çš„keyï¼›</li>
<li>SnakeYamlé»˜è®¤ä¼šè‡ªåŠ¨è½¬æ¢<code>int</code>ã€<code>boolean</code>ç­‰valueï¼Œéœ€è¦ç¦ç”¨è‡ªåŠ¨è½¬æ¢ï¼ŒæŠŠæ‰€æœ‰valueå‡æŒ‰<code>String</code>ç±»å‹è¿”å›ã€‚</li>
</ol>
<h2 id="åˆ›å»ºbeandefinition">åˆ›å»ºBeanDefinition<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºbeandefinition">#</a></h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>ResourceResolver</code>æ‰«æClassï¼Œç”¨<code>PropertyResolver</code>è·å–é…ç½®ï¼Œä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹å®ç°IoCå®¹å™¨ã€‚</p>
<p>åœ¨IoCå®¹å™¨ä¸­ï¼Œæ¯ä¸ªBeanéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åå­—æ ‡è¯†ã€‚Springè¿˜å…è®¸ä¸ºä¸€ä¸ªBeanå®šä¹‰å¤šä¸ªåå­—ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹ï¼Œä¸€ä¸ªBeanåªå…è®¸ä¸€ä¸ªåå­—ï¼Œå› æ­¤ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ç”¨ä¸€ä¸ª<code>Map&lt;String, Object&gt;</code>ä¿å­˜æ‰€æœ‰çš„Beanï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext {
</span></span><span style="display:flex;"><span>    Map&lt;String, Object&gt; beans;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¹ˆåšä¸æ˜¯ä¸å¯ä»¥ï¼Œä½†æ˜¯ä¸¢å¤±äº†å¤§é‡Beançš„å®šä¹‰ä¿¡æ¯ï¼Œä¸ä¾¿äºæˆ‘ä»¬åˆ›å»ºBeanä»¥åŠè§£æä¾èµ–å…³ç³»ã€‚åˆç†çš„æ–¹å¼æ˜¯å…ˆå®šä¹‰<code>BeanDefinition</code>ï¼Œå®ƒèƒ½ä»Annotationä¸­æå–åˆ°è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œä¾¿äºåç»­åˆ›å»ºBeanã€è®¾ç½®ä¾èµ–ã€è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ç­‰ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BeanDefinition {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å…¨å±€å”¯ä¸€çš„Bean Name:</span>
</span></span><span style="display:flex;"><span>    String name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Beançš„å£°æ˜ç±»å‹:</span>
</span></span><span style="display:flex;"><span>    Class&lt;?&gt; beanClass;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Beançš„å®ä¾‹:</span>
</span></span><span style="display:flex;"><span>    Object instance = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ„é€ æ–¹æ³•/null:</span>
</span></span><span style="display:flex;"><span>    Constructor&lt;?&gt; constructor;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å·¥å‚æ–¹æ³•åç§°/null:</span>
</span></span><span style="display:flex;"><span>    String factoryName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å·¥å‚æ–¹æ³•/null:</span>
</span></span><span style="display:flex;"><span>    Method factoryMethod;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Beançš„é¡ºåº:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> order;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ˜¯å¦æ ‡è¯†@Primary:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> primary;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// init/destroyæ–¹æ³•åç§°:</span>
</span></span><span style="display:flex;"><span>    String initMethodName;
</span></span><span style="display:flex;"><span>    String destroyMethodName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// init/destroyæ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>    Method initMethod;
</span></span><span style="display:flex;"><span>    Method destroyMethod;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äºè‡ªå·±å®šä¹‰çš„å¸¦<code>@Component</code>æ³¨è§£çš„Beanï¼Œæˆ‘ä»¬éœ€è¦è·å–Classç±»å‹ï¼Œè·å–æ„é€ æ–¹æ³•æ¥åˆ›å»ºBeanï¼Œç„¶åæ”¶é›†<code>@PostConstruct</code>å’Œ<code>@PreDestroy</code>æ ‡æ³¨çš„åˆå§‹åŒ–ä¸é”€æ¯çš„æ–¹æ³•ï¼Œä»¥åŠå…¶ä»–ä¿¡æ¯ï¼Œå¦‚<code>@Order</code>å®šä¹‰Beançš„å†…éƒ¨æ’åºé¡ºåºï¼Œ<code>@Primary</code>å®šä¹‰å­˜åœ¨å¤šä¸ªç›¸åŒç±»å‹æ—¶è¿”å›å“ªä¸ªâ€œä¸»è¦â€Beanã€‚ä¸€ä¸ªå…¸å‹çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Hello {
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> init() {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PreDestroy
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> destroy() {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äº<code>@Configuration</code>å®šä¹‰çš„<code>@Bean</code>æ–¹æ³•ï¼Œæˆ‘ä»¬æŠŠå®ƒçœ‹ä½œBeançš„å·¥å‚æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦è·å–æ–¹æ³•è¿”å›å€¼ä½œä¸ºClassç±»å‹ï¼Œæ–¹æ³•æœ¬èº«ä½œä¸ºåˆ›å»ºBeançš„<code>factoryMethod</code>ï¼Œç„¶åæ”¶é›†<code>@Bean</code>å®šä¹‰çš„<code>initMethod</code>å’Œ<code>destroyMethod</code>æ ‡è¯†çš„åˆå§‹åŒ–äºé”€æ¯çš„æ–¹æ³•åï¼Œä»¥åŠå…¶ä»–<code>@Order</code>ã€<code>@Primary</code>ç­‰ä¿¡æ¯ã€‚ä¸€ä¸ªå…¸å‹çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>    @Bean(initMethod=<span style="color:#0ff;font-weight:bold">&#34;init&#34;</span>, destroyMethod=<span style="color:#0ff;font-weight:bold">&#34;close&#34;</span>)
</span></span><span style="display:flex;"><span>    DataSource createDataSource() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> HikariDataSource(...);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="beançš„å£°æ˜ç±»å‹">Beançš„å£°æ˜ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#beançš„å£°æ˜ç±»å‹">#</a></h3>
<p>è¿™é‡Œæˆ‘ä»¬è¦ç‰¹åˆ«æ³¨æ„ä¸€ç‚¹ï¼Œå°±æ˜¯Beançš„å£°æ˜ç±»å‹ã€‚å¯¹äº<code>@Component</code>å®šä¹‰çš„Beanï¼Œå®ƒçš„å£°æ˜ç±»å‹å°±æ˜¯å…¶Classæœ¬èº«ã€‚ç„¶è€Œï¼Œå¯¹äºç”¨<code>@Bean</code>å·¥å‚æ–¹æ³•åˆ›å»ºçš„Beanï¼Œå®ƒçš„å£°æ˜ç±»å‹ä¸å®é™…ç±»å‹ä¸ä¸€å®šæ˜¯åŒä¸€ç±»å‹ã€‚ä¸Šè¿°<code>createDataSource()</code>å®šä¹‰çš„Beanï¼Œå£°æ˜ç±»å‹æ˜¯<code>DataSource</code>ï¼Œå®é™…ç±»å‹å´æ˜¯æŸä¸ªå­ç±»ï¼Œä¾‹å¦‚<code>HikariDataSource</code>ï¼Œå› æ­¤è¦ç‰¹åˆ«æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨<code>BeanDefinition</code>ä¸­ï¼Œå­˜å‚¨çš„<code>beanClass</code>æ˜¯<strong>å£°æ˜ç±»å‹</strong>ï¼Œå®é™…ç±»å‹ä¸å¿…å­˜å‚¨ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡<code>instance.getClass()</code>è·å¾—ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BeanDefinition {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Beançš„å£°æ˜ç±»å‹:</span>
</span></span><span style="display:flex;"><span>    Class&lt;?&gt; beanClass;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Beançš„å®ä¾‹:</span>
</span></span><span style="display:flex;"><span>    Object instance = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¹Ÿå¼•å‡ºäº†ä¸‹ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœæˆ‘ä»¬æŒ‰ç…§åå­—æŸ¥æ‰¾Beanæˆ–BeanDefinitionï¼Œè¦ä¹ˆæ‹¿åˆ°å”¯ä¸€å®ä¾‹ï¼Œè¦ä¹ˆä¸å­˜åœ¨ï¼Œå³é€šè¿‡æŸ¥è¯¢<code>Map&lt;String, BeanDefinition&gt;</code>å³å¯å®Œæˆï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext {
</span></span><span style="display:flex;"><span>    Map&lt;String, BeanDefinition&gt; beans;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ ¹æ®NameæŸ¥æ‰¾BeanDefinitionï¼Œå¦‚æœNameä¸å­˜åœ¨ï¼Œè¿”å›null</span>
</span></span><span style="display:flex;"><span>    @Nullable
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> BeanDefinition findBeanDefinition(String name) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">get</span>(name);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯é€šè¿‡ç±»å‹æŸ¥æ‰¾Beanæˆ–BeanDefinitionï¼Œæˆ‘ä»¬æ²¡æ³•å®šä¹‰ä¸€ä¸ª<code>Map&lt;Class, BeanDefinition&gt;</code>ï¼ŒåŸå› å°±æ˜¯Beançš„å£°æ˜ç±»å‹ä¸å®é™…ç±»å‹ä¸ä¸€å®šç›¸ç¬¦ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    AtomicInteger counter() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> AtomicInteger();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    Number bigInt() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> BigInteger(<span style="color:#0ff;font-weight:bold">&#34;1000000000&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“æˆ‘ä»¬è°ƒç”¨<code>getBean(AtomicInteger.class)</code>æ—¶ï¼Œæˆ‘ä»¬ä¼šè·å¾—<code>counter()</code>æ–¹æ³•åˆ›å»ºçš„å”¯ä¸€å®ä¾‹ï¼Œä½†æ˜¯ï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>getBean(Number.class)</code>æ—¶ï¼Œ<code>counter()</code>æ–¹æ³•å’Œ<code>bigInt()</code>æ–¹æ³•åˆ›å»ºçš„å®ä¾‹å‡ç¬¦åˆè¦æ±‚ï¼Œæ­¤æ—¶ï¼Œå¦‚æœæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ ‡æ³¨äº†<code>@Primary</code>ï¼Œå°±è¿”å›æ ‡æ³¨äº†<code>@Primary</code>çš„Beanï¼Œå¦åˆ™ï¼Œç›´æ¥æŠ¥<code>NoUniqueBeanDefinitionException</code>é”™è¯¯ã€‚</p>
<p>å› æ­¤ï¼Œå¯¹äº<code>getBean(Class)</code>æ–¹æ³•ï¼Œå¿…é¡»éå†æ‰¾å‡ºæ‰€æœ‰ç¬¦åˆç±»å‹çš„Beanï¼Œå¦‚æœä¸å”¯ä¸€ï¼Œå†åˆ¤æ–­<code>@Primary</code>ï¼Œæ‰èƒ½è¿”å›å”¯ä¸€Beanæˆ–æŠ¥é”™ã€‚</p>
<p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªæ‰¾å‡ºæ‰€æœ‰ç±»å‹çš„<code>findBeanDefinitions(Class)</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// æ ¹æ®TypeæŸ¥æ‰¾è‹¥å¹²ä¸ªBeanDefinitionï¼Œè¿”å›0ä¸ªæˆ–å¤šä¸ª:</span>
</span></span><span style="display:flex;"><span>List&lt;BeanDefinition&gt; findBeanDefinitions(Class&lt;?&gt; type) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æŒ‰ç±»å‹è¿‡æ»¤:</span>
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">filter</span>(def -&gt; type.<span style="color:#007f7f">isAssignableFrom</span>(def.<span style="color:#007f7f">getBeanClass</span>()))
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ’åº:</span>
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">sorted</span>().<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬å†ç¼–å†™ä¸€ä¸ª<code>findBeanDefinition(Class)</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// æ ¹æ®TypeæŸ¥æ‰¾æŸä¸ªBeanDefinitionï¼Œå¦‚æœä¸å­˜åœ¨è¿”å›nullï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªè¿”å›@Primaryæ ‡æ³¨çš„ä¸€ä¸ª:</span>
</span></span><span style="display:flex;"><span>@Nullable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> BeanDefinition findBeanDefinition(Class&lt;?&gt; type) {
</span></span><span style="display:flex;"><span>    List&lt;BeanDefinition&gt; defs = findBeanDefinitions(type);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (defs.<span style="color:#007f7f">isEmpty</span>()) { <span style="color:#007f7f">// æ²¡æœ‰æ‰¾åˆ°ä»»ä½•BeanDefinition</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (defs.<span style="color:#007f7f">size</span>() == 1) { <span style="color:#007f7f">// æ‰¾åˆ°å”¯ä¸€ä¸€ä¸ª</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> defs.<span style="color:#007f7f">get</span>(0);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å¤šäºä¸€ä¸ªæ—¶ï¼ŒæŸ¥æ‰¾@Primary:</span>
</span></span><span style="display:flex;"><span>    List&lt;BeanDefinition&gt; primaryDefs = defs.<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">filter</span>(def -&gt; def.<span style="color:#007f7f">isPrimary</span>()).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (primaryDefs.<span style="color:#007f7f">size</span>() == 1) { <span style="color:#007f7f">// @Primaryå”¯ä¸€</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> primaryDefs.<span style="color:#007f7f">get</span>(0);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (primaryDefs.<span style="color:#007f7f">isEmpty</span>()) { <span style="color:#007f7f">// ä¸å­˜åœ¨@Primary</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> NoUniqueBeanDefinitionException(String.<span style="color:#007f7f">format</span>(<span style="color:#0ff;font-weight:bold">&#34;Multiple bean with type &#39;%s&#39; found, but no @Primary specified.&#34;</span>, type.<span style="color:#007f7f">getName</span>()));
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> { <span style="color:#007f7f">// @Primaryä¸å”¯ä¸€</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> NoUniqueBeanDefinitionException(String.<span style="color:#007f7f">format</span>(<span style="color:#0ff;font-weight:bold">&#34;Multiple bean with type &#39;%s&#39; found, and multiple @Primary specified.&#34;</span>, type.<span style="color:#007f7f">getName</span>()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å®šä¹‰å¥½äº†æ•°æ®ç»“æ„ï¼Œä¸‹é¢å¼€å§‹è·å–æ‰€æœ‰<code>BeanDefinition</code>ä¿¡æ¯ï¼Œå®é™…åˆ†ä¸¤æ­¥ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext {
</span></span><span style="display:flex;"><span>    Map&lt;String, BeanDefinition&gt; beans;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> AnnotationConfigApplicationContext(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ‰«æè·å–æ‰€æœ‰Beançš„Classç±»å‹:</span>
</span></span><span style="display:flex;"><span>        Set&lt;String&gt; beanClassNames = scanForClassNames(configClass);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åˆ›å»ºBeançš„å®šä¹‰:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span> = createBeanDefinitions(beanClassNames);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬ä¸€æ­¥æ˜¯æ‰«ææŒ‡å®šåŒ…ä¸‹çš„æ‰€æœ‰Classï¼Œç„¶åè¿”å›Classåå­—ï¼Œè¿™ä¸€æ­¥æ¯”è¾ƒç®€å•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Set&lt;String&gt; scanForClassNames(Class&lt;?&gt; configClass) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è·å–@ComponentScanæ³¨è§£:</span>
</span></span><span style="display:flex;"><span>    ComponentScan scan = ClassUtils.<span style="color:#007f7f">findAnnotation</span>(configClass, ComponentScan.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è·å–æ³¨è§£é…ç½®çš„packageåå­—,æœªé…ç½®åˆ™é»˜è®¤å½“å‰ç±»æ‰€åœ¨åŒ…:</span>
</span></span><span style="display:flex;"><span>    String[] scanPackages = scan == <span style="color:#fff;font-weight:bold">null</span> || scan.<span style="color:#007f7f">value</span>().<span style="color:#007f7f">length</span> == 0 ? <span style="color:#fff;font-weight:bold">new</span> String[] { configClass.<span style="color:#007f7f">getPackage</span>().<span style="color:#007f7f">getName</span>() } : scan.<span style="color:#007f7f">value</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Set&lt;String&gt; classNameSet = <span style="color:#fff;font-weight:bold">new</span> HashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ä¾æ¬¡æ‰«ææ‰€æœ‰åŒ…:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (String pkg : scanPackages) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">atDebug</span>().<span style="color:#007f7f">log</span>(<span style="color:#0ff;font-weight:bold">&#34;scan package: {}&#34;</span>, pkg);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ‰«æä¸€ä¸ªåŒ…:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> rr = <span style="color:#fff;font-weight:bold">new</span> ResourceResolver(pkg);
</span></span><span style="display:flex;"><span>        List&lt;String&gt; classList = rr.<span style="color:#007f7f">scan</span>(res -&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// é‡åˆ°ä»¥.classç»“å°¾çš„æ–‡ä»¶ï¼Œå°±å°†å…¶è½¬æ¢ä¸ºClasså…¨å:</span>
</span></span><span style="display:flex;"><span>            String name = res.<span style="color:#007f7f">name</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (name.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.class&#34;</span>)) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> name.<span style="color:#007f7f">substring</span>(0, name.<span style="color:#007f7f">length</span>() - 6).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;\\&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ‰«æç»“æœæ·»åŠ åˆ°Set:</span>
</span></span><span style="display:flex;"><span>        classNameSet.<span style="color:#007f7f">addAll</span>(classList);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ç»§ç»­æŸ¥æ‰¾@Import(Xyz.class)å¯¼å…¥çš„Classé…ç½®:</span>
</span></span><span style="display:flex;"><span>    Import importConfig = configClass.<span style="color:#007f7f">getAnnotation</span>(Import.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (importConfig != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (Class&lt;?&gt; importConfigClass : importConfig.<span style="color:#007f7f">value</span>()) {
</span></span><span style="display:flex;"><span>            String importClassName = importConfigClass.<span style="color:#007f7f">getName</span>();
</span></span><span style="display:flex;"><span>            classNameSet.<span style="color:#007f7f">add</span>(importClassName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> classNameSet;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°æ‰«æç»“æœæ˜¯æŒ‡å®šåŒ…çš„æ‰€æœ‰Classåç§°ï¼Œä»¥åŠé€šè¿‡<code>@Import</code>å¯¼å…¥çš„Classåç§°ï¼Œä¸‹ä¸€æ­¥æ‰ä¼šçœŸæ­£å¤„ç†å„ç§æ³¨è§£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Map&lt;String, BeanDefinition&gt; createBeanDefinitions(Set&lt;String&gt; classNameSet) {
</span></span><span style="display:flex;"><span>    Map&lt;String, BeanDefinition&gt; defs = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (String className : classNameSet) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è·å–Class:</span>
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; clazz = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            clazz = Class.<span style="color:#007f7f">forName</span>(className);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (ClassNotFoundException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanCreationException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ˜¯å¦æ ‡æ³¨@Component?</span>
</span></span><span style="display:flex;"><span>        Component component = ClassUtils.<span style="color:#007f7f">findAnnotation</span>(clazz, Component.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (component != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// è·å–Beançš„åç§°:</span>
</span></span><span style="display:flex;"><span>            String beanName = ClassUtils.<span style="color:#007f7f">getBeanName</span>(clazz);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">var</span> def = <span style="color:#fff;font-weight:bold">new</span> BeanDefinition(
</span></span><span style="display:flex;"><span>                beanName, clazz, getSuitableConstructor(clazz),
</span></span><span style="display:flex;"><span>                getOrder(clazz), clazz.<span style="color:#007f7f">isAnnotationPresent</span>(Primary.<span style="color:#007f7f">class</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// init/destroyæ–¹æ³•åç§°:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">null</span>, <span style="color:#fff;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// æŸ¥æ‰¾@PostConstructæ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>                ClassUtils.<span style="color:#007f7f">findAnnotationMethod</span>(clazz, PostConstruct.<span style="color:#007f7f">class</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// æŸ¥æ‰¾@PreDestroyæ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>                ClassUtils.<span style="color:#007f7f">findAnnotationMethod</span>(clazz, PreDestroy.<span style="color:#007f7f">class</span>));
</span></span><span style="display:flex;"><span>            addBeanDefinitions(defs, def);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// æŸ¥æ‰¾æ˜¯å¦æœ‰@Configuration:</span>
</span></span><span style="display:flex;"><span>            Configuration configuration = ClassUtils.<span style="color:#007f7f">findAnnotation</span>(clazz, Configuration.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (configuration != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// æŸ¥æ‰¾@Beanæ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>                scanFactoryMethods(beanName, clazz, defs);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> defs;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼ŒæŸ¥æ‰¾<code>@Component</code>æ—¶ï¼Œå¹¶ä¸æ˜¯ç®€å•åœ°åœ¨Classå®šä¹‰æŸ¥çœ‹<code>@Component</code>æ³¨è§£ï¼Œå› ä¸ºSpringçš„<code>@Component</code>æ˜¯å¯ä»¥æ‰©å±•çš„ï¼Œä¾‹å¦‚ï¼Œæ ‡è®°ä¸º<code>Controller</code>çš„Classä¹Ÿç¬¦åˆè¦æ±‚ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MvcController {...}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŸå› å°±åœ¨äºï¼Œ<code>@Controller</code>æ³¨è§£çš„å®šä¹‰åŒ…å«äº†<code>@Component</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Target(ElementType.<span style="color:#007f7f">TYPE</span>)
</span></span><span style="display:flex;"><span>@Retention(RetentionPolicy.<span style="color:#007f7f">RUNTIME</span>)
</span></span><span style="display:flex;"><span>@Documented
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> @interface Controller {
</span></span><span style="display:flex;"><span>    String value() <span style="color:#fff;font-weight:bold">default</span> <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨<code>@Component</code>ï¼Œä¸ä½†è¦åœ¨å½“å‰ç±»æŸ¥æ‰¾<code>@Component</code>ï¼Œè¿˜è¦åœ¨å½“å‰ç±»çš„æ‰€æœ‰æ³¨è§£ä¸Šï¼ŒæŸ¥æ‰¾è¯¥æ³¨è§£æ˜¯å¦æœ‰<code>@Component</code>ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªèƒ½é€’å½’æŸ¥æ‰¾æ³¨è§£çš„æ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ClassUtils {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> &lt;A <span style="color:#fff;font-weight:bold">extends</span> Annotation&gt; A findAnnotation(Class&lt;?&gt; target, Class&lt;A&gt; annoClass) {
</span></span><span style="display:flex;"><span>        A a = target.<span style="color:#007f7f">getAnnotation</span>(annoClass);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (Annotation anno : target.<span style="color:#007f7f">getAnnotations</span>()) {
</span></span><span style="display:flex;"><span>            Class&lt;? <span style="color:#fff;font-weight:bold">extends</span> Annotation&gt; annoType = anno.<span style="color:#007f7f">annotationType</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (!annoType.<span style="color:#007f7f">getPackageName</span>().<span style="color:#007f7f">equals</span>(<span style="color:#0ff;font-weight:bold">&#34;java.lang.annotation&#34;</span>)) {
</span></span><span style="display:flex;"><span>                A found = findAnnotation(annoType, annoClass);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (found != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (a != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanDefinitionException(<span style="color:#0ff;font-weight:bold">&#34;Duplicate @&#34;</span> + annoClass.<span style="color:#007f7f">getSimpleName</span>() + <span style="color:#0ff;font-weight:bold">&#34; found on class &#34;</span> + target.<span style="color:#007f7f">getSimpleName</span>());
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    a = found;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> a;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¸¦æœ‰<code>@Configuration</code>æ³¨è§£çš„Classï¼Œè§†ä¸ºBeançš„å·¥å‚ï¼Œæˆ‘ä»¬éœ€è¦ç»§ç»­åœ¨<code>scanFactoryMethods()</code>ä¸­æŸ¥æ‰¾<code>@Bean</code>æ ‡æ³¨çš„æ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> scanFactoryMethods(String factoryBeanName, Class&lt;?&gt; clazz, Map&lt;String, BeanDefinition&gt; defs) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (Method method : clazz.<span style="color:#007f7f">getDeclaredMethods</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ˜¯å¦å¸¦æœ‰@Beanæ ‡æ³¨:</span>
</span></span><span style="display:flex;"><span>        Bean bean = method.<span style="color:#007f7f">getAnnotation</span>(Bean.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (bean != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Beançš„å£°æ˜ç±»å‹æ˜¯æ–¹æ³•è¿”å›ç±»å‹:</span>
</span></span><span style="display:flex;"><span>            Class&lt;?&gt; beanClass = method.<span style="color:#007f7f">getReturnType</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">var</span> def = <span style="color:#fff;font-weight:bold">new</span> BeanDefinition(
</span></span><span style="display:flex;"><span>                ClassUtils.<span style="color:#007f7f">getBeanName</span>(method), beanClass,
</span></span><span style="display:flex;"><span>                factoryBeanName,
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// åˆ›å»ºBeançš„å·¥å‚æ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>                method,
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// @Order</span>
</span></span><span style="display:flex;"><span>                getOrder(method),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// æ˜¯å¦å­˜åœ¨@Primaryæ ‡æ³¨?</span>
</span></span><span style="display:flex;"><span>                method.<span style="color:#007f7f">isAnnotationPresent</span>(Primary.<span style="color:#007f7f">class</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// initæ–¹æ³•åç§°:</span>
</span></span><span style="display:flex;"><span>                bean.<span style="color:#007f7f">initMethod</span>().<span style="color:#007f7f">isEmpty</span>() ? <span style="color:#fff;font-weight:bold">null</span> : bean.<span style="color:#007f7f">initMethod</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// destroyæ–¹æ³•åç§°:</span>
</span></span><span style="display:flex;"><span>                bean.<span style="color:#007f7f">destroyMethod</span>().<span style="color:#007f7f">isEmpty</span>() ? <span style="color:#fff;font-weight:bold">null</span> : bean.<span style="color:#007f7f">destroyMethod</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// @PostConstruct / @PreDestroyæ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">null</span>, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>            addBeanDefinitions(defs, def);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°<code>@Configuration</code>æ³¨è§£æœ¬èº«åˆç”¨<code>@Component</code>æ³¨è§£ä¿®é¥°äº†ï¼Œå› æ­¤ï¼Œå¯¹äºä¸€ä¸ª<code>@Configuration</code>æ¥è¯´ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DateTimeConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    LocalDateTime local() { <span style="color:#fff;font-weight:bold">return</span> LocalDateTime.<span style="color:#007f7f">now</span>(); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    ZonedDateTime zoned() { <span style="color:#fff;font-weight:bold">return</span> ZonedDateTime.<span style="color:#007f7f">now</span>(); }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®é™…ä¸Šåˆ›å»ºäº†3ä¸ª<code>BeanDefinition</code>ï¼š</p>
<ul>
<li>DateTimeConfigæœ¬èº«ï¼›</li>
<li>LocalDateTimeï¼›</li>
<li>ZonedDateTimeã€‚</li>
</ul>
<p>ä¸åˆ›å»º<code>DateTimeConfig</code>è¡Œä¸è¡Œï¼Ÿä¸è¡Œï¼Œå› ä¸ºåç»­æ²¡æœ‰<code>DateTimeConfig</code>çš„å®ä¾‹ï¼Œæ— æ³•è°ƒç”¨<code>local()</code>å’Œ<code>zoned()</code>æ–¹æ³•ã€‚å› ä¸ºå½“å‰æˆ‘ä»¬åªåˆ›å»ºäº†<code>BeanDefinition</code>ï¼Œæ‰€ä»¥å¯¹äº<code>LocalDateTime</code>å’Œ<code>ZonedDateTime</code>çš„<code>BeanDefinition</code>æ¥è¯´ï¼Œè¿˜å¿…é¡»ä¿å­˜<code>DateTimeConfig</code>çš„åå­—ï¼Œå°†æ¥æ‰èƒ½é€šè¿‡åå­—æŸ¥æ‰¾<code>DateTimeConfig</code>çš„å®ä¾‹ã€‚</p>
<p>æœ‰çš„åŒå­¦æ³¨æ„åˆ°æˆ‘ä»¬åŒæ—¶å­˜å‚¨äº†<code>initMethodName</code>å’Œ<code>initMethod</code>ï¼Œä»¥åŠ<code>destroyMethodName</code>å’Œ<code>destroyMethod</code>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨<code>@Component</code>å£°æ˜çš„Beanä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®<code>@PostConstruct</code>å’Œ<code>@PreDestroy</code>ç›´æ¥æ‹¿åˆ°Methodæœ¬èº«ï¼Œè€Œåœ¨<code>@Bean</code>å£°æ˜çš„Beanä¸­ï¼Œæˆ‘ä»¬æ‹¿ä¸åˆ°Methodï¼Œåªèƒ½ä»<code>@Bean</code>æ³¨è§£æå–å‡ºå­—ç¬¦ä¸²æ ¼å¼çš„æ–¹æ³•åç§°ï¼Œå› æ­¤ï¼Œå­˜å‚¨åœ¨<code>BeanDefinition</code>çš„æ–¹æ³•åç§°ä¸æ–¹æ³•ï¼Œå…¶ä¸­æ€»æœ‰ä¸€ä¸ªä¸º<code>null</code>ã€‚</p>
<p>æœ€åï¼Œä»”ç»†ç¼–å†™<code>BeanDefinition</code>çš„<code>toString()</code>æ–¹æ³•ï¼Œä½¿ä¹‹èƒ½æ‰“å°å‡ºè¯¦ç»†çš„ä¿¡æ¯ã€‚æˆ‘ä»¬ç¼–å†™æµ‹è¯•ï¼Œè¿è¡Œï¼Œæ‰“å°å‡ºæ¯ä¸ª<code>BeanDefinition</code>å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>define bean: BeanDefinition [name=annotationDestroyBean, beanClass=com.<span style="color:#007f7f">itranswarp</span>.<span style="color:#007f7f">scan</span>.<span style="color:#007f7f">destroy</span>.<span style="color:#007f7f">AnnotationDestroyBean</span>, factory=<span style="color:#fff;font-weight:bold">null</span>, init-method=<span style="color:#fff;font-weight:bold">null</span>, destroy-method=destroy, primary=<span style="color:#fff;font-weight:bold">false</span>, instance=<span style="color:#fff;font-weight:bold">null</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>define bean: BeanDefinition [name=nestedBean, beanClass=com.<span style="color:#007f7f">itranswarp</span>.<span style="color:#007f7f">scan</span>.<span style="color:#007f7f">nested</span>.<span style="color:#007f7f">OuterBean$NestedBean</span>, factory=<span style="color:#fff;font-weight:bold">null</span>, init-method=<span style="color:#fff;font-weight:bold">null</span>, destroy-method=<span style="color:#fff;font-weight:bold">null</span>, primary=<span style="color:#fff;font-weight:bold">false</span>, instance=<span style="color:#fff;font-weight:bold">null</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>define bean: BeanDefinition [name=createSpecifyInitBean, beanClass=com.<span style="color:#007f7f">itranswarp</span>.<span style="color:#007f7f">scan</span>.<span style="color:#007f7f">init</span>.<span style="color:#007f7f">SpecifyInitBean</span>, factory=SpecifyInitConfiguration.<span style="color:#007f7f">createSpecifyInitBean</span>(String, String), init-method=<span style="color:#fff;font-weight:bold">null</span>, destroy-method=<span style="color:#fff;font-weight:bold">null</span>, primary=<span style="color:#fff;font-weight:bold">false</span>, instance=<span style="color:#fff;font-weight:bold">null</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»èƒ½æ‰«æå¹¶åˆ›å»ºæ‰€æœ‰çš„<code>BeanDefinition</code>ï¼Œåªæ˜¯ç›®å‰æ¯ä¸ª<code>BeanDefinition</code>å†…éƒ¨çš„<code>instance</code>è¿˜æ˜¯<code>null</code>ï¼Œå› ä¸ºæˆ‘ä»¬åç»­æ‰ä¼šåˆ›å»ºçœŸæ­£çš„Beanã€‚</p>
<h2 id="åˆ›å»ºbeanå®ä¾‹">åˆ›å»ºBeanå®ä¾‹<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºbeanå®ä¾‹">#</a></h2>
<p>å½“æˆ‘ä»¬æ‹¿åˆ°æ‰€æœ‰<code>BeanDefinition</code>ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹åˆ›å»ºBeançš„å®ä¾‹äº†ã€‚</p>
<p>åœ¨åˆ›å»ºBeanå®ä¾‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹Springæ”¯æŒçš„4ç§ä¾èµ–æ³¨å…¥æ¨¡å¼ï¼š</p>
<ol>
<li>æ„é€ æ–¹æ³•æ³¨å…¥ï¼Œä¾‹å¦‚ï¼š</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Hello {
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Hello(@Autowired JdbcTemplate jdbcTemplate) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">jdbcTemplate</span> = jdbcTemplate;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>å·¥å‚æ–¹æ³•æ³¨å…¥ï¼Œä¾‹å¦‚ï¼š</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    Hello hello(@Autowired JdbcTemplate jdbcTemplate) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> Hello(jdbcTemplate);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>Setteræ–¹æ³•æ³¨å…¥ï¼Œä¾‹å¦‚ï¼š</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Hello {
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> setJdbcTemplate(JdbcTemplate jdbcTemplate) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">jdbcTemplate</span> = jdbcTemplate;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>å­—æ®µæ³¨å…¥ï¼Œä¾‹å¦‚ï¼š</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Hello {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶è€Œæˆ‘ä»¬ä»”ç»†åˆ†æï¼Œå‘ç°è¿™4ç§æ³¨å…¥æ–¹å¼å®é™…ä¸Šæ˜¯æœ‰åŒºåˆ«çš„ã€‚</p>
<p>åŒºåˆ«å°±åœ¨äºï¼Œå‰ä¸¤ç§æ–¹å¼ï¼Œå³æ„é€ æ–¹æ³•æ³¨å…¥å’Œå·¥å‚æ–¹æ³•æ³¨å…¥ï¼ŒBeançš„åˆ›å»ºä¸æ³¨å…¥æ˜¯ä¸€ä½“çš„ï¼Œæˆ‘ä»¬æ— æ³•æŠŠå®ƒä»¬åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œå› ä¸ºæ— æ³•ä¸­æ–­æ–¹æ³•å†…éƒ¨ä»£ç çš„æ‰§è¡Œã€‚è€Œåä¸¤ç§æ–¹å¼ï¼Œå³Setteræ–¹æ³•æ³¨å…¥å’Œå±æ€§æ³¨å…¥ï¼ŒBeançš„åˆ›å»ºä¸æ³¨å…¥æ˜¯å¯ä»¥åˆ†å¼€çš„ï¼Œå³å…ˆåˆ›å»ºBeanå®ä¾‹ï¼Œå†ç”¨åå°„è°ƒç”¨æ–¹æ³•æˆ–å­—æ®µï¼Œå®Œæˆæ³¨å…¥ã€‚</p>
<p>æˆ‘ä»¬å†åˆ†æä¸€ä¸‹å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚å¾ªç¯ä¾èµ–ï¼Œå³Aã€Bäº’ç›¸ä¾èµ–ï¼Œæˆ–è€…Aä¾èµ–Bï¼ŒBä¾èµ–Cï¼ŒCä¾èµ–Aï¼Œå½¢æˆäº†ä¸€ä¸ªé—­ç¯ã€‚IoCå®¹å™¨å¯¹Beanè¿›è¡Œç®¡ç†ï¼Œå¯ä»¥è§£å†³éƒ¨åˆ†å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œä½†ä¸æ˜¯æ‰€æœ‰å¾ªç¯ä¾èµ–éƒ½èƒ½è§£å†³ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸èƒ½è§£å†³çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œå‡å®šä¸‹åˆ—ä»£ç å®šä¹‰çš„Aã€Bä¸¤ä¸ªBeanï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> A {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> B b;
</span></span><span style="display:flex;"><span>    A(B b) { <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">b</span> = b; }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> B {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> A a;
</span></span><span style="display:flex;"><span>    B(A a) { <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">a</span> = a; }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ç§é€šè¿‡æ„é€ æ–¹æ³•æ³¨å…¥ä¾èµ–çš„ä¸¤ä¸ªBeanï¼Œå¦‚æœå­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œæ˜¯æ— è§£çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ç”¨IoCï¼Œè‡ªå·±å†™Javaä»£ç ä¹Ÿå†™ä¸å‡ºæ­£ç¡®åˆ›å»ºä¸¤ä¸ªBeanå®ä¾‹çš„ä»£ç ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬æŠŠæ„é€ æ–¹æ³•æ³¨å…¥å’Œå·¥å‚æ–¹æ³•æ³¨å…¥çš„ä¾èµ–ç§°ä¸ºå¼ºä¾èµ–ï¼Œä¸èƒ½æœ‰å¼ºä¾èµ–çš„å¾ªç¯ä¾èµ–ï¼Œå¦åˆ™åªèƒ½æŠ¥é”™ã€‚</p>
<p>åä¸¤ç§æ³¨å…¥æ–¹å¼å½¢æˆçš„ä¾èµ–åˆ™æ˜¯å¼±ä¾èµ–ï¼Œå‡å®šä¸‹åˆ—ä»£ç å®šä¹‰çš„Aã€Bä¸¤ä¸ªBeanï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> A {
</span></span><span style="display:flex;"><span>    B b;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> B {
</span></span><span style="display:flex;"><span>    A a;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ç§å¾ªç¯ä¾èµ–åˆ™å¾ˆå®¹æ˜“è§£å†³ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥åˆ†ä¸¤æ­¥ï¼Œå…ˆåˆ†åˆ«å®ä¾‹åŒ–Beanï¼Œå†æ³¨å…¥ä¾èµ–ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// ç¬¬ä¸€æ­¥,å®ä¾‹åŒ–:</span>
</span></span><span style="display:flex;"><span>A a = <span style="color:#fff;font-weight:bold">new</span> A();
</span></span><span style="display:flex;"><span>B b = <span style="color:#fff;font-weight:bold">new</span> B();
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// ç¬¬äºŒæ­¥,æ³¨å…¥:</span>
</span></span><span style="display:flex;"><span>a.<span style="color:#007f7f">b</span> = b;
</span></span><span style="display:flex;"><span>b.<span style="color:#007f7f">a</span> = a;
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥ï¼Œå¯¹äºIoCå®¹å™¨æ¥è¯´ï¼Œåˆ›å»ºBeançš„è¿‡ç¨‹åˆ†ä¸¤æ­¥ï¼š</p>
<ol>
<li>åˆ›å»ºBeançš„å®ä¾‹ï¼Œæ­¤æ—¶å¿…é¡»æ³¨å…¥å¼ºä¾èµ–ï¼›</li>
<li>å¯¹Beanå®ä¾‹è¿›è¡ŒSetteræ–¹æ³•æ³¨å…¥å’Œå­—æ®µæ³¨å…¥ã€‚</li>
</ol>
<p>ç¬¬ä¸€æ­¥å¦‚æœé‡åˆ°å¾ªç¯ä¾èµ–åˆ™ç›´æ¥æŠ¥é”™ï¼Œç¬¬äºŒæ­¥åˆ™ä¸éœ€è¦å…³å¿ƒæœ‰æ²¡æœ‰å¾ªç¯ä¾èµ–ã€‚</p>
<p>æˆ‘ä»¬å…ˆå®ç°ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºBeançš„å®ä¾‹ï¼ŒåŒæ—¶æ³¨å…¥å¼ºä¾èµ–ã€‚</p>
<p>åœ¨ä¸Šä¸€èŠ‚ä»£ç ä¸­ï¼Œæˆ‘ä»¬å·²ç»è·å¾—äº†æ‰€æœ‰çš„<code>BeanDefinition</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext {
</span></span><span style="display:flex;"><span>    PropertyResolver propertyResolver;
</span></span><span style="display:flex;"><span>    Map&lt;String, BeanDefinition&gt; beans;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> AnnotationConfigApplicationContext(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span> = propertyResolver;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ‰«æè·å–æ‰€æœ‰Beançš„Classç±»å‹:</span>
</span></span><span style="display:flex;"><span>        Set&lt;String&gt; beanClassNames = scanForClassNames(configClass);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åˆ›å»ºBeançš„å®šä¹‰:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span> = createBeanDefinitions(beanClassNames);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹ä¸€æ­¥æ˜¯åˆ›å»ºBeançš„å®ä¾‹ï¼ŒåŒæ—¶æ³¨å…¥å¼ºä¾èµ–ã€‚æ­¤é˜¶æ®µå¿…é¡»æ£€æµ‹å¾ªç¯ä¾èµ–ã€‚æ£€æµ‹å¾ªç¯ä¾èµ–å…¶å®éå¸¸ç®€å•ï¼Œå°±æ˜¯å®šä¹‰ä¸€ä¸ª<code>Set&lt;String&gt;</code>è·Ÿè¸ªå½“å‰æ­£åœ¨åˆ›å»ºçš„æ‰€æœ‰Beançš„åç§°ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext {
</span></span><span style="display:flex;"><span>    Set&lt;String&gt; creatingBeanNames;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºBeanå®ä¾‹æˆ‘ä»¬ç”¨æ–¹æ³•<code>createBeanAsEarlySingleton()</code>å®ç°ï¼Œåœ¨æ–¹æ³•å¼€å§‹å¤„æ£€æµ‹å¾ªç¯ä¾èµ–ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// åˆ›å»ºä¸€ä¸ªBeanï¼Œä½†ä¸è¿›è¡Œå­—æ®µå’Œæ–¹æ³•çº§åˆ«çš„æ³¨å…¥ã€‚å¦‚æœåˆ›å»ºçš„Beanä¸æ˜¯Configurationï¼Œåˆ™åœ¨æ„é€ æ–¹æ³•/å·¥å‚æ–¹æ³•ä¸­æ³¨å…¥çš„ä¾èµ–Beanä¼šè‡ªåŠ¨åˆ›å»º</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object createBeanAsEarlySingleton(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">creatingBeanNames</span>.<span style="color:#007f7f">add</span>(def.<span style="color:#007f7f">getName</span>())) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ£€æµ‹åˆ°é‡å¤åˆ›å»ºBeanå¯¼è‡´çš„å¾ªç¯ä¾èµ–:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> UnsatisfiedDependencyException();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±äº<code>@Configuration</code>æ ‡è¯†çš„Beanå®é™…ä¸Šæ˜¯å·¥å‚ï¼Œå®ƒä»¬å¿…é¡»å…ˆå®ä¾‹åŒ–ï¼Œæ‰èƒ½å®ä¾‹åŒ–å…¶ä»–æ™®é€šBeanï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæŠŠ<code>@Configuration</code>æ ‡è¯†çš„Beanåˆ›å»ºå‡ºæ¥ï¼Œå†åˆ›å»ºæ™®é€šBeanï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> AnnotationConfigApplicationContext(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span> = propertyResolver;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ‰«æè·å–æ‰€æœ‰Beançš„Classç±»å‹:</span>
</span></span><span style="display:flex;"><span>    Set&lt;String&gt; beanClassNames = scanForClassNames(configClass);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»ºBeançš„å®šä¹‰:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span> = createBeanDefinitions(beanClassNames);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»ºBeanNameæ£€æµ‹å¾ªç¯ä¾èµ–:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">creatingBeanNames</span> = <span style="color:#fff;font-weight:bold">new</span> HashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»º@Configurationç±»å‹çš„Bean:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// è¿‡æ»¤å‡º@Configuration:</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">filter</span>(<span style="color:#fff;font-weight:bold">this</span>::isConfigurationDefinition).<span style="color:#007f7f">sorted</span>().<span style="color:#007f7f">map</span>(def -&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// åˆ›å»ºBeanå®ä¾‹:</span>
</span></span><span style="display:flex;"><span>                createBeanAsEarlySingleton(def);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> def.<span style="color:#007f7f">getName</span>();
</span></span><span style="display:flex;"><span>            }).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»ºå…¶ä»–æ™®é€šBean:</span>
</span></span><span style="display:flex;"><span>    List&lt;BeanDefinition&gt; defs = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// è¿‡æ»¤å‡ºinstance==nullçš„BeanDefinition:</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">filter</span>(def -&gt; def.<span style="color:#007f7f">getInstance</span>() == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">sorted</span>().<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ä¾æ¬¡åˆ›å»ºBeanå®ä¾‹:</span>
</span></span><span style="display:flex;"><span>    defs.<span style="color:#007f7f">forEach</span>(def -&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å¦‚æœBeanæœªè¢«åˆ›å»º(å¯èƒ½åœ¨å…¶ä»–Beançš„æ„é€ æ–¹æ³•æ³¨å…¥å‰è¢«åˆ›å»º):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (def.<span style="color:#007f7f">getInstance</span>() == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// åˆ›å»ºBean:</span>
</span></span><span style="display:flex;"><span>            createBeanAsEarlySingleton(def);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‰©ä¸‹çš„å·¥ä½œå°±æ˜¯æŠŠ<code>createBeanAsEarlySingleton()</code>è¡¥å……å®Œæ•´ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object createBeanAsEarlySingleton(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ£€æµ‹å¾ªç¯ä¾èµ–:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">creatingBeanNames</span>.<span style="color:#007f7f">add</span>(def.<span style="color:#007f7f">getName</span>())) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> UnsatisfiedDependencyException();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»ºæ–¹å¼ï¼šæ„é€ æ–¹æ³•æˆ–å·¥å‚æ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>    Executable createFn = def.<span style="color:#007f7f">getFactoryName</span>() == <span style="color:#fff;font-weight:bold">null</span> ?
</span></span><span style="display:flex;"><span>        def.<span style="color:#007f7f">getConstructor</span>() : def.<span style="color:#007f7f">getFactoryMethod</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»ºå‚æ•°:</span>
</span></span><span style="display:flex;"><span>    Parameter[] parameters = createFn.<span style="color:#007f7f">getParameters</span>();
</span></span><span style="display:flex;"><span>    Object[] args = <span style="color:#fff;font-weight:bold">new</span> Object[parameters.<span style="color:#007f7f">length</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; parameters.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ä»å‚æ•°è·å–@Valueå’Œ@Autowired:</span>
</span></span><span style="display:flex;"><span>        Value value = ...
</span></span><span style="display:flex;"><span>        Autowired autowired = ...
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ£€æŸ¥Valueå’ŒAutowired</span>
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å‚æ•°ç±»å‹:</span>
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; type = param.<span style="color:#007f7f">getType</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (value != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å‚æ•°è®¾ç½®ä¸ºæŸ¥è¯¢çš„@Value:</span>
</span></span><span style="display:flex;"><span>            args[i] = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span>.<span style="color:#007f7f">getRequiredProperty</span>(value.<span style="color:#007f7f">value</span>(), type);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å‚æ•°æ˜¯@Autowired,æŸ¥æ‰¾ä¾èµ–çš„BeanDefinition:</span>
</span></span><span style="display:flex;"><span>            BeanDefinition dependsOnDef = name.<span style="color:#007f7f">isEmpty</span>() ? findBeanDefinition(type) : findBeanDefinition(name, type);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// è·å–ä¾èµ–Beançš„å®ä¾‹:</span>
</span></span><span style="display:flex;"><span>            Object autowiredBeanInstance = dependsOnDef.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (autowiredBeanInstance == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// å½“å‰ä¾èµ–Beanå°šæœªåˆå§‹åŒ–ï¼Œé€’å½’è°ƒç”¨åˆå§‹åŒ–è¯¥ä¾èµ–Bean:</span>
</span></span><span style="display:flex;"><span>                autowiredBeanInstance = createBeanAsEarlySingleton(dependsOnDef);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å‚æ•°è®¾ç½®ä¸ºä¾èµ–çš„Beanå®ä¾‹:</span>
</span></span><span style="display:flex;"><span>            args[i] = autowiredBeanInstance;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å·²æ‹¿åˆ°æ‰€æœ‰æ–¹æ³•å‚æ•°,åˆ›å»ºBeanå®ä¾‹:</span>
</span></span><span style="display:flex;"><span>    Object instance = ...
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è®¾ç½®å®ä¾‹åˆ°BeanDefinition:</span>
</span></span><span style="display:flex;"><span>    def.<span style="color:#007f7f">setInstance</span>(instance);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è¿”å›å®ä¾‹:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> def.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°é€’å½’è°ƒç”¨ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object createBeanAsEarlySingleton(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    Object[] args = <span style="color:#fff;font-weight:bold">new</span> Object[parameters.<span style="color:#007f7f">length</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; parameters.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è·å–ä¾èµ–Beançš„å®ä¾‹:</span>
</span></span><span style="display:flex;"><span>        Object autowiredBeanInstance = dependsOnDef.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (autowiredBeanInstance == <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; !isConfiguration) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å½“å‰ä¾èµ–Beanå°šæœªåˆå§‹åŒ–ï¼Œé€’å½’è°ƒç”¨åˆå§‹åŒ–è¯¥ä¾èµ–Bean:</span>
</span></span><span style="display:flex;"><span>            autowiredBeanInstance = createBeanAsEarlySingleton(dependsOnDef);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‡è®¾å¦‚ä¸‹çš„Beanä¾èµ–ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> A {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ä¾èµ–B,C:</span>
</span></span><span style="display:flex;"><span>    A(@Autowired B, @Autowired C) {}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> B {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ä¾èµ–C:</span>
</span></span><span style="display:flex;"><span>    B(@Autowired C) {}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> C {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ— ä¾èµ–:</span>
</span></span><span style="display:flex;"><span>    C() {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæŒ‰ç…§Aã€Bã€Cçš„é¡ºåºåˆ›å»ºBeanå®ä¾‹ï¼Œé‚£ä¹ˆç³»ç»Ÿæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å‡†å¤‡åˆ›å»ºAï¼›</li>
<li>æ£€æµ‹åˆ°ä¾èµ–Bï¼šæœªå°±ç»ªï¼›
<ol>
<li>å‡†å¤‡åˆ›å»ºBï¼š</li>
<li>æ£€æµ‹åˆ°ä¾èµ–Cï¼šæœªå°±ç»ªï¼›
<ol>
<li>å‡†å¤‡åˆ›å»ºCï¼›</li>
<li>å®Œæˆåˆ›å»ºCï¼›</li>
</ol>
</li>
<li>å®Œæˆåˆ›å»ºBï¼›</li>
</ol>
</li>
<li>æ£€æµ‹åˆ°ä¾èµ–Cï¼Œå·²å°±ç»ªï¼›</li>
<li>å®Œæˆåˆ›å»ºAã€‚</li>
</ol>
<p>å¦‚æœæŒ‰ç…§Bã€Cã€Açš„é¡ºåºåˆ›å»ºBeanå®ä¾‹ï¼Œé‚£ä¹ˆç³»ç»Ÿæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å‡†å¤‡åˆ›å»ºBï¼›</li>
<li>æ£€æµ‹åˆ°ä¾èµ–Cï¼šæœªå°±ç»ªï¼›
<ol>
<li>å‡†å¤‡åˆ›å»ºCï¼›</li>
<li>å®Œæˆåˆ›å»ºCï¼›</li>
</ol>
</li>
<li>å®Œæˆåˆ›å»ºBï¼›</li>
<li>å‡†å¤‡åˆ›å»ºAï¼›</li>
<li>æ£€æµ‹åˆ°ä¾èµ–Bï¼Œå·²å°±ç»ªï¼›</li>
<li>æ£€æµ‹åˆ°ä¾èµ–Cï¼Œå·²å°±ç»ªï¼›</li>
<li>å®Œæˆåˆ›å»ºAã€‚</li>
</ol>
<p>å¯è§æ— è®ºä»¥ä»€ä¹ˆé¡ºåºåˆ›å»ºï¼ŒCæ€»æ˜¯æœ€å…ˆè¢«å®ä¾‹åŒ–ï¼ŒAæ€»æ˜¯æœ€åè¢«å®ä¾‹åŒ–ã€‚</p>
<h2 id="åˆå§‹åŒ–bean">åˆå§‹åŒ–Bean<a hidden class="anchor" aria-hidden="true" href="#åˆå§‹åŒ–bean">#</a></h2>
<p>åœ¨åˆ›å»ºBeanå®ä¾‹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†å¼ºä¾èµ–çš„æ³¨å…¥ã€‚ä¸‹ä¸€æ­¥ï¼Œæ˜¯æ ¹æ®Setteræ–¹æ³•å’Œå­—æ®µå®Œæˆå¼±ä¾èµ–æ³¨å…¥ï¼Œæ¥ç€è°ƒç”¨ç”¨<code>@PostConstruct</code>æ ‡æ³¨çš„initæ–¹æ³•ï¼Œå°±å®Œæˆäº†æ‰€æœ‰Beançš„åˆå§‹åŒ–ã€‚</p>
<p>è¿™ä¸€æ­¥ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºåªæ¶‰åŠåˆ°æŸ¥æ‰¾ä¾èµ–çš„<code>@Value</code>å’Œ<code>@Autowired</code>ï¼Œç„¶åç”¨åå°„å®Œæˆè°ƒç”¨å³å¯ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> AnnotationConfigApplicationContext(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// é€šè¿‡å­—æ®µå’Œsetæ–¹æ³•æ³¨å…¥ä¾èµ–:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">forEach</span>(def -&gt; {
</span></span><span style="display:flex;"><span>        injectBean(def);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è°ƒç”¨initæ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">forEach</span>(def -&gt; {
</span></span><span style="display:flex;"><span>        initBean(def);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨Setteræ–¹æ³•å’Œå­—æ®µæ³¨å…¥æ—¶ï¼Œè¦æ³¨æ„ä¸€ç‚¹ï¼Œå°±æ˜¯ä¸ä»…è¦åœ¨å½“å‰ç±»æŸ¥æ‰¾ï¼Œè¿˜è¦åœ¨çˆ¶ç±»æŸ¥æ‰¾ï¼Œå› ä¸ºæœ‰äº›<code>@Autowired</code>å†™åœ¨çˆ¶ç±»ï¼Œæ‰€æœ‰å­ç±»éƒ½å¯ä½¿ç”¨ï¼Œè¿™æ ·æ›´æ–¹ä¾¿ã€‚æ³¨å…¥å¼±ä¾èµ–ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// åœ¨å½“å‰ç±»åŠçˆ¶ç±»è¿›è¡Œå­—æ®µå’Œæ–¹æ³•æ³¨å…¥:</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> injectProperties(BeanDefinition def, Class&lt;?&gt; clazz, Object bean) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åœ¨å½“å‰ç±»æŸ¥æ‰¾Fieldå’ŒMethodå¹¶æ³¨å…¥:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (Field f : clazz.<span style="color:#007f7f">getDeclaredFields</span>()) {
</span></span><span style="display:flex;"><span>        tryInjectProperties(def, clazz, bean, f);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (Method m : clazz.<span style="color:#007f7f">getDeclaredMethods</span>()) {
</span></span><span style="display:flex;"><span>        tryInjectProperties(def, clazz, bean, m);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åœ¨çˆ¶ç±»æŸ¥æ‰¾Fieldå’ŒMethodå¹¶æ³¨å…¥:</span>
</span></span><span style="display:flex;"><span>    Class&lt;?&gt; superClazz = clazz.<span style="color:#007f7f">getSuperclass</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (superClazz != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// é€’å½’è°ƒç”¨:</span>
</span></span><span style="display:flex;"><span>        injectProperties(def, superClazz, bean);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// æ³¨å…¥å•ä¸ªå±æ€§</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> tryInjectProperties(BeanDefinition def, Class&lt;?&gt; clazz, Object bean, AccessibleObject acc) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¼±ä¾èµ–æ³¨å…¥å®Œæˆåï¼Œå†å¾ªç¯ä¸€éæ‰€æœ‰çš„<code>BeanDefinition</code>ï¼Œå¯¹å…¶è°ƒç”¨<code>init</code>æ–¹æ³•ï¼Œå®Œæˆæœ€åä¸€æ­¥åˆå§‹åŒ–ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> initBean(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è°ƒç”¨initæ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>    callMethod(def.<span style="color:#007f7f">getInstance</span>(), def.<span style="color:#007f7f">getInitMethod</span>(), def.<span style="color:#007f7f">getInitMethodName</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¤„ç†<code>@PreDestroy</code>æ–¹æ³•æ›´ç®€å•ï¼Œåœ¨<code>ApplicationContext</code>å…³é—­æ—¶éå†æ‰€æœ‰Beanï¼Œè°ƒç”¨<code>destroy</code>æ–¹æ³•å³å¯ã€‚</p>
<h2 id="å®ç°beanpostprocessor">å®ç°BeanPostProcessor<a hidden class="anchor" aria-hidden="true" href="#å®ç°beanpostprocessor">#</a></h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ‰«æClassåç§°ã€åˆ›å»ºBeanDefinitionã€åˆ›å»ºBeanå®ä¾‹ã€åˆå§‹åŒ–Beanï¼Œç†è®ºä¸Šä¸€ä¸ªå¯ç”¨çš„IoCå®¹å™¨å°±å·²ç»å°±ç»ªã€‚</p>
<p>ç„¶è€Œï¼Œ<code>BeanPostProcessor</code>çš„å‡ºç°æ”¹å˜äº†è¿™ä¸€åˆ‡ã€‚Springå…è®¸ç”¨æˆ·è‡ªå®šä¹‰ä¸€ç§ç‰¹æ®Šçš„Beanï¼Œå³å®ç°äº†<code>BeanPostProcessor</code>æ¥å£ï¼Œå®ƒæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿå…¶å®å°±æ˜¯æ›¿æ¢Beanã€‚æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢çš„ä»£ç æ˜¯åŸºäºSpringä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> ctx = <span style="color:#fff;font-weight:bold">new</span> AnnotationConfigApplicationContext(AppConfig.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å¯ä»¥è·å–åˆ°ZonedDateTime:</span>
</span></span><span style="display:flex;"><span>        ZonedDateTime dt = ctx.<span style="color:#007f7f">getBean</span>(ZonedDateTime.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(dt);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// é”™è¯¯:NoSuchBeanDefinitionException:</span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(ctx.<span style="color:#007f7f">getBean</span>(LocalDateTime.<span style="color:#007f7f">class</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»ºLocalDateTimeå®ä¾‹</span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> LocalDateTime localDateTime() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> LocalDateTime.<span style="color:#007f7f">now</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å®ç°ä¸€ä¸ªBeanPostProcessor</span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    BeanPostProcessor replaceLocalDateTime() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> BeanPostProcessor() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> Object postProcessBeforeInitialization(Object bean, String beanName) <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// å°†LocalDateTimeç±»å‹å®ä¾‹æ›¿æ¢ä¸ºZonedDateTimeç±»å‹å®ä¾‹:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (bean <span style="color:#fff;font-weight:bold">instanceof</span> LocalDateTime) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> ZonedDateTime.<span style="color:#007f7f">now</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œå¯çŸ¥ï¼Œæˆ‘ä»¬å®šä¹‰çš„<code>@Bean</code>ç±»å‹æ˜æ˜æ˜¯<code>LocalDateTime</code>ç±»å‹ï¼Œä½†å´è¢«å¦ä¸€ä¸ª<code>BeanPostProcessor</code>æ›¿æ¢æˆäº†<code>ZonedDateTime</code>ï¼Œäºæ˜¯ï¼Œè°ƒç”¨<code>getBean(ZonedDateTime.class)</code>å¯ä»¥æ‹¿åˆ°æ›¿æ¢åçš„Beanï¼Œè°ƒç”¨<code>getBean(LocalDateTime.class)</code>ä¼šæŠ¥é”™ï¼Œæç¤ºæ‰¾ä¸åˆ°Beanã€‚é‚£ä¹ˆåŸå§‹çš„Beanå“ªå»äº†ï¼Ÿç­”æ¡ˆæ˜¯è¢«<code>BeanPostProcessor</code>æ‰”æ‰äº†ã€‚</p>
<p>å¯è§ï¼Œ<code>BeanPostProcessor</code>æ˜¯ä¸€ç§ç‰¹æ®ŠBeanï¼Œå®ƒçš„ä½œç”¨æ˜¯æ ¹æ®æ¡ä»¶æ›¿æ¢æŸäº›Beanã€‚ä¸Šè¿°çš„ä¾‹å­ä¸­ï¼Œ<code>LocalDateTime</code>è¢«æ›¿æ¢ä¸º<code>ZonedDateTime</code>å…¶å®æ²¡å•¥æ„ä¹‰ï¼Œä½†å®é™…åº”ç”¨ä¸­ï¼ŒæŠŠåŸå§‹Beanæ›¿æ¢ä¸ºä»£ç†åçš„Beanæ˜¯éå¸¸å¸¸è§çš„ï¼Œæ¯”å¦‚ä¸‹é¢çš„åŸºäºSpringçš„ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> ctx = <span style="color:#fff;font-weight:bold">new</span> AnnotationConfigApplicationContext(AppConfig.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        UserService u = ctx.<span style="color:#007f7f">getBean</span>(UserService.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(u.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getSimpleName</span>()); <span style="color:#007f7f">// UserServiceProxy</span>
</span></span><span style="display:flex;"><span>        u.<span style="color:#007f7f">register</span>(<span style="color:#0ff;font-weight:bold">&#34;bob@example.com&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;bob12345&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    BeanPostProcessor createProxy() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> BeanPostProcessor() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> Object postProcessBeforeInitialization(Object bean, String beanName) <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// å®ç°äº‹åŠ¡åŠŸèƒ½:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (bean <span style="color:#fff;font-weight:bold">instanceof</span> UserService u) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> UserServiceProxy(u);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> register(String email, String password) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;INSERT INTO ...&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// ä»£ç†ç±»:</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> UserServiceProxy <span style="color:#fff;font-weight:bold">extends</span> UserService {
</span></span><span style="display:flex;"><span>    UserService target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserServiceProxy(UserService target) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> register(String email, String password) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;begin tx&#34;</span>);
</span></span><span style="display:flex;"><span>        target.<span style="color:#007f7f">register</span>(email, password);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;commit tx&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæ‰§è¡Œä¸Šè¿°ä»£ç ï¼Œæ‰“å°å‡ºçš„Beanç±»å‹ä¸æ˜¯<code>UserService</code>ï¼Œè€Œæ˜¯<code>UserServiceProxy</code>ï¼Œå› æ­¤ï¼Œè°ƒç”¨<code>register()</code>ä¼šæ‰“å°å‡º<code>begin tx</code>å’Œ<code>commit tx</code>ï¼Œè¯´æ˜â€œäº‹åŠ¡â€ç”Ÿæ•ˆäº†ã€‚</p>
<p>è¿„ä»Šä¸ºæ­¢ï¼Œåˆ›å»ºProxyä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆå½±å“ã€‚è®©æˆ‘ä»¬æŠŠä»£ç å†æŒ‰å®é™…æƒ…å†µæ‰©å±•ä¸€ä¸‹ï¼Œ<code>UserService</code>æ˜¯ç”¨æˆ·ç¼–å†™çš„ä¸šåŠ¡ä»£ç ï¼Œéœ€è¦æ³¨å…¥<code>JdbcTemplate</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    @Autowired JdbcTemplate jdbcTemplate;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> register(String email, String password) {
</span></span><span style="display:flex;"><span>        jdbcTemplate.<span style="color:#007f7f">update</span>(<span style="color:#0ff;font-weight:bold">&#34;INSERT INTO ...&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è€Œ<code>PostBeanProcessor</code>ä¸€èˆ¬ç”±æ¡†æ¶æœ¬èº«æä¾›äº‹åŠ¡åŠŸèƒ½ï¼Œæ‰€ä»¥å®ƒä¼šåŠ¨æ€åˆ›å»ºä¸€ä¸ª<code>UserServiceProxy</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> UserServiceProxy <span style="color:#fff;font-weight:bold">extends</span> UserService {
</span></span><span style="display:flex;"><span>    UserService target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserServiceProxy(UserService target) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> register(String email, String password) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;begin tx&#34;</span>);
</span></span><span style="display:flex;"><span>        target.<span style="color:#007f7f">register</span>(email, password);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;commit tx&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è°ƒç”¨ç”¨æˆ·æ³¨å†Œçš„é¡µé¢ç”±<code>MvcController</code>æ§åˆ¶ï¼Œå› æ­¤ï¼Œå°†<code>UserService</code>æ³¨å…¥åˆ°<code>MvcController</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> MvcController {
</span></span><span style="display:flex;"><span>    @Autowired UserService userService;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @PostMapping(<span style="color:#0ff;font-weight:bold">&#34;/register&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> register() {
</span></span><span style="display:flex;"><span>        userService.<span style="color:#007f7f">register</span>(...);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸€å¼€å§‹ï¼Œç”±IoCå®¹å™¨åˆ›å»ºçš„BeanåŒ…æ‹¬ï¼š</p>
<ul>
<li>JdbcTemplate</li>
<li>UserService</li>
<li>MvcController</li>
</ul>
<p>æ¥ç€ï¼Œç”±äº<code>BeanPostProcessor</code>çš„ä»‹å…¥ï¼ŒåŸå§‹çš„<code>UserService</code>è¢«æ›¿æ¢ä¸º<code>UserServiceProxy</code>ï¼š</p>
<ul>
<li>JdbcTemplate</li>
<li>UserServiceProxy</li>
<li>MvcController</li>
</ul>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šæ³¨æ„åˆ°<code>UserServiceProxy</code>æ˜¯ä»<code>UserService</code>ç»§æ‰¿çš„ï¼Œå®ƒä¹Ÿæœ‰ä¸€ä¸ª<code>@Autowired JdbcTemplate</code>ï¼Œé‚£<code>JdbcTemplate</code>å®ä¾‹åº”æ³¨å…¥åˆ°åŸå§‹çš„<code>UserService</code>è¿˜æ˜¯<code>UserServiceProxy</code>ï¼Ÿ</p>
<p>ä»ä¸šåŠ¡é€»è¾‘å‡ºå‘ï¼Œ<code>JdbcTemplate</code>å®ä¾‹å¿…é¡»æ³¨å…¥åˆ°åŸå§‹çš„<code>UserService</code>ï¼Œå¦åˆ™ï¼Œä»£ç†ç±»<code>UserServiceProxy</code>æ‰§è¡Œ<code>target.register()</code>æ—¶ï¼Œç›¸å½“äºå¯¹åŸå§‹çš„<code>UserService</code>è°ƒç”¨<code>register()</code>æ–¹æ³•ï¼Œå¦‚æœ<code>JdbcTemplate</code>æ²¡æœ‰æ³¨å…¥ï¼Œå°†ç›´æ¥æŠ¥<code>NullPointerException</code>é”™è¯¯ã€‚</p>
<p>è¿™æ—¶ç¬¬äºŒä¸ªé—®é¢˜åˆæ¥äº†ï¼š<code>MvcController</code>éœ€è¦æ³¨å…¥çš„<code>UserService</code>ï¼Œåº”è¯¥æ˜¯åŸå§‹çš„<code>UserService</code>è¿˜æ˜¯<code>UserServiceProxy</code>ï¼Ÿ</p>
<p>è¿˜æ˜¯ä»ä¸šåŠ¡é€»è¾‘å‡ºå‘ï¼Œ<code>MvcController</code>éœ€è¦æ³¨å…¥çš„<code>UserService</code>å¿…é¡»æ˜¯<code>UserServiceProxy</code>ï¼Œå¦åˆ™ï¼Œäº‹åŠ¡ä¸èµ·ä½œç”¨ã€‚</p>
<p>æˆ‘ä»¬ç”¨å›¾æè¿°ä¸€ä¸‹æ³¨å…¥å…³ç³»ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>â”‚MvcController  â”‚
</span></span><span style="display:flex;"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>â”‚- userService â”€â”¼â”€â”€â–¶â”‚UserServiceProxyâ”‚
</span></span><span style="display:flex;"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</span></span><span style="display:flex;"><span>                    â”‚- jdbcTemplate  â”‚
</span></span><span style="display:flex;"><span>                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>                    â”‚- target       â”€â”¼â”€â”€â–¶â”‚UserService     â”‚
</span></span><span style="display:flex;"><span>                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>                                         â”‚- jdbcTemplate â”€â”¼â”€â”€â–¶â”‚JdbcTemplateâ”‚
</span></span><span style="display:flex;"><span>                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°ä¸Šå›¾çš„<code>UserService</code>å·²ç»è„±ç¦»äº†IoCå®¹å™¨çš„ç®¡ç†ï¼Œå› ä¸ºæ­¤æ—¶<code>UserService</code>å¯¹åº”çš„<code>BeanDefinition</code>ä¸­ï¼Œå­˜æ”¾çš„instanceæ˜¯<code>UserServiceProxy</code>ã€‚</p>
<p>å¯è§ï¼Œå¼•å…¥<code>BeanPostProcessor</code>å¯ä»¥å®ç°Proxyæœºåˆ¶ï¼Œä½†ä¹Ÿè®©ä¾èµ–æ³¨å…¥å˜å¾—æ›´åŠ å¤æ‚ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬ä»”ç»†åˆ†æä¾èµ–å…³ç³»ï¼Œè¿˜æ˜¯å¯ä»¥æ€»ç»“å‡ºä¸¤æ¡åŸåˆ™ï¼š</p>
<ol>
<li>ä¸€ä¸ªBeanå¦‚æœè¢«Proxyæ›¿æ¢ï¼Œåˆ™ä¾èµ–å®ƒçš„Beanåº”æ³¨å…¥Proxyï¼Œå³ä¸Šå›¾çš„<code>MvcController</code>åº”æ³¨å…¥<code>UserServiceProxy</code>ï¼›</li>
<li>ä¸€ä¸ªBeanå¦‚æœè¢«Proxyæ›¿æ¢ï¼Œå¦‚æœè¦æ³¨å…¥ä¾èµ–ï¼Œåˆ™åº”è¯¥æ³¨å…¥åˆ°åŸå§‹å¯¹è±¡ï¼Œå³ä¸Šå›¾çš„<code>JdbcTemplate</code>åº”æ³¨å…¥åˆ°åŸå§‹çš„<code>UserService</code>ã€‚</li>
</ol>
<p>åŸºäºè¿™ä¸ªåŸåˆ™ï¼Œè¦æ»¡è¶³æ¡ä»¶1æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œå› ä¸ºåªè¦åˆ›å»ºBeanå®Œæˆåï¼Œç«‹åˆ»è°ƒç”¨<code>BeanPostProcessor</code>å°±å®ç°äº†æ›¿æ¢ï¼Œåç»­å…¶ä»–Beanå¼•ç”¨çš„è‚¯å®šå°±æ˜¯Proxyäº†ã€‚å…ˆæ”¹é€ åˆ›å»ºBeançš„æµç¨‹ï¼Œåœ¨åˆ›å»º<code>@Configuration</code>åï¼Œæ¥ç€åˆ›å»º<code>BeanPostProcessor</code>ï¼Œå†åˆ›å»ºå…¶ä»–æ™®é€šBeanï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> AnnotationConfigApplicationContext(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»º@Configurationç±»å‹çš„Bean:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// è¿‡æ»¤å‡º@Configuration:</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">filter</span>(<span style="color:#fff;font-weight:bold">this</span>::isConfigurationDefinition).<span style="color:#007f7f">sorted</span>().<span style="color:#007f7f">map</span>(def -&gt; {
</span></span><span style="display:flex;"><span>                createBeanAsEarlySingleton(def);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> def.<span style="color:#007f7f">getName</span>();
</span></span><span style="display:flex;"><span>            }).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»ºBeanPostProcessorç±»å‹çš„Bean:</span>
</span></span><span style="display:flex;"><span>    List&lt;BeanPostProcessor&gt; processors = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// è¿‡æ»¤å‡ºBeanPostProcessor:</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">filter</span>(<span style="color:#fff;font-weight:bold">this</span>::isBeanPostProcessorDefinition)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// æ’åº:</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">sorted</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// åˆ›å»ºBeanPostProcessorå®ä¾‹:</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">map</span>(def -&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> (BeanPostProcessor) createBeanAsEarlySingleton(def);
</span></span><span style="display:flex;"><span>            }).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanPostProcessors</span>.<span style="color:#007f7f">addAll</span>(processors);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»ºå…¶ä»–æ™®é€šBean:</span>
</span></span><span style="display:flex;"><span>    createNormalBeans();
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†ç»§ç»­ä¿®æ”¹<code>createBeanAsEarlySingleton()</code>ï¼Œåˆ›å»ºBeanå®ä¾‹åï¼Œè°ƒç”¨<code>BeanPostProcessor</code>å¤„ç†ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object createBeanAsEarlySingleton(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»ºBeanå®ä¾‹:</span>
</span></span><span style="display:flex;"><span>    Object instance = ...;
</span></span><span style="display:flex;"><span>    def.<span style="color:#007f7f">setInstance</span>(instance);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è°ƒç”¨BeanPostProcessorå¤„ç†Bean:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (BeanPostProcessor processor : beanPostProcessors) {
</span></span><span style="display:flex;"><span>        Object processed = processor.<span style="color:#007f7f">postProcessBeforeInitialization</span>(def.<span style="color:#007f7f">getInstance</span>(), def.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å¦‚æœä¸€ä¸ªBeanPostProcessoræ›¿æ¢äº†åŸå§‹Beanï¼Œåˆ™æ›´æ–°Beançš„å¼•ç”¨:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (def.<span style="color:#007f7f">getInstance</span>() != processed) {
</span></span><span style="display:flex;"><span>            def.<span style="color:#007f7f">setInstance</span>(processed);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> def.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨ï¼Œå¦‚æœä¸€ä¸ªBeanè¢«æ›¿æ¢ä¸ºProxyï¼Œé‚£ä¹ˆ<code>BeanDefinition</code>ä¸­çš„<code>instance</code>å·²ç»æ˜¯Proxyäº†ï¼Œè¿™æ—¶ï¼Œå¯¹è¿™ä¸ªBeanè¿›è¡Œä¾èµ–æ³¨å…¥ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºæ³¨å…¥çš„æ˜¯Proxyè€Œä¸æ˜¯åŸå§‹Beanï¼Œæ€ä¹ˆåŠï¼Ÿ</p>
<p>è¿™æ—¶æˆ‘ä»¬è¦æ€è€ƒåŸå§‹Beanå»å“ªäº†ï¼ŸåŸå§‹Beanå®é™…ä¸Šæ˜¯è¢«<code>BeanPostProcessor</code>ç»™ä¸¢äº†ï¼å¦‚æœ<code>BeanPostProcessor</code>èƒ½ä¿å­˜åŸå§‹Beanï¼Œé‚£ä¹ˆï¼Œæ³¨å…¥å‰å…ˆæ‰¾åˆ°åŸå§‹Beanï¼Œå°±å¯ä»¥æŠŠä¾èµ–æ­£ç¡®åœ°æ³¨å…¥ç»™åŸå§‹Beanã€‚æˆ‘ä»¬ç»™<code>BeanPostProcessor</code>åŠ ä¸€ä¸ª<code>postProcessOnSetProperty()</code>æ–¹æ³•ï¼Œè®©å®ƒè¿”å›åŸå§‹Beanï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> BeanPostProcessor {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ³¨å…¥ä¾èµ–æ—¶,åº”è¯¥ä½¿ç”¨çš„Beanå®ä¾‹:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">default</span> Object postProcessOnSetProperty(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†ç»§ç»­æŠŠ<code>injectBean()</code>æ”¹ä¸€ä¸‹ï¼Œä¸è¦ç›´æ¥æ‹¿<code>BeanDefinition.getInstance()</code>ï¼Œè€Œæ˜¯æ‹¿åˆ°åŸå§‹Beanï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> injectBean(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è·å–Beanå®ä¾‹ï¼Œæˆ–è¢«ä»£ç†çš„åŸå§‹å®ä¾‹:</span>
</span></span><span style="display:flex;"><span>    Object beanInstance = getProxiedInstance(def);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        injectProperties(def, def.<span style="color:#007f7f">getBeanClass</span>(), beanInstance);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (ReflectiveOperationException e) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanCreationException(e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>getProxiedInstance()</code>å°±æ˜¯ä¸ºäº†è·å–åŸå§‹Beanï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Object getProxiedInstance(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    Object beanInstance = def.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å¦‚æœProxyæ”¹å˜äº†åŸå§‹Beanï¼Œåˆå¸Œæœ›æ³¨å…¥åˆ°åŸå§‹Beanï¼Œåˆ™ç”±BeanPostProcessoræŒ‡å®šåŸå§‹Bean:</span>
</span></span><span style="display:flex;"><span>    List&lt;BeanPostProcessor&gt; reversedBeanPostProcessors = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanPostProcessors</span>);
</span></span><span style="display:flex;"><span>    Collections.<span style="color:#007f7f">reverse</span>(reversedBeanPostProcessors);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (BeanPostProcessor beanPostProcessor : reversedBeanPostProcessors) {
</span></span><span style="display:flex;"><span>        Object restoredInstance = beanPostProcessor.<span style="color:#007f7f">postProcessOnSetProperty</span>(beanInstance, def.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (restoredInstance != beanInstance) {
</span></span><span style="display:flex;"><span>            beanInstance = restoredInstance;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> beanInstance;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œæˆ‘ä»¬è¿˜èƒ½å¤„ç†å¤šæ¬¡ä»£ç†çš„æƒ…å†µï¼Œå³ä¸€ä¸ªåŸå§‹Beanï¼Œæ¯”å¦‚<code>UserService</code>ï¼Œè¢«ä¸€ä¸ªäº‹åŠ¡å¤„ç†çš„<code>BeanPostProcsssor</code>ä»£ç†ä¸º<code>UserServiceTx</code>ï¼Œåˆè¢«ä¸€ä¸ªæ€§èƒ½ç›‘æ§çš„<code>BeanPostProcessor</code>ä»£ç†ä¸º<code>UserServiceMetric</code>ï¼Œè¿˜åŸçš„æ—¶å€™ï¼Œå¯¹<code>BeanPostProcsssor</code>åšä¸€ä¸ªå€’åºï¼Œå…ˆè¿˜åŸä¸º<code>UserServiceTx</code>ï¼Œå†è¿˜åŸä¸º<code>UserService</code>ã€‚</p>
<h3 id="æµ‹è¯•">æµ‹è¯•<a hidden class="anchor" aria-hidden="true" href="#æµ‹è¯•">#</a></h3>
<p>æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªæµ‹è¯•æ¥éªŒè¯Beançš„æ³¨å…¥æ˜¯å¦æ­£ç¡®ã€‚å…ˆå®šä¹‰åŸå§‹Beanï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OriginBean {
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${app.title}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${app.version}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String version;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getName() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> name;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡<code>FirstProxyBeanPostProcessor</code>ä»£ç†ä¸º<code>FirstProxyBean</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Order(100)
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FirstProxyBeanPostProcessor <span style="color:#fff;font-weight:bold">implements</span> BeanPostProcessor {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ä¿å­˜åŸå§‹Bean:</span>
</span></span><span style="display:flex;"><span>    Map&lt;String, Object&gt; originBeans = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessBeforeInitialization(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (OriginBean.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">isAssignableFrom</span>(bean.<span style="color:#007f7f">getClass</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// æ£€æµ‹åˆ°OriginBean,åˆ›å»ºFirstProxyBean:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">var</span> proxy = <span style="color:#fff;font-weight:bold">new</span> FirstProxyBean((OriginBean) bean);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// ä¿å­˜åŸå§‹Bean:</span>
</span></span><span style="display:flex;"><span>            originBeans.<span style="color:#007f7f">put</span>(beanName, bean);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// è¿”å›Proxy:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> proxy;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessOnSetProperty(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        Object origin = originBeans.<span style="color:#007f7f">get</span>(beanName);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (origin != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å­˜åœ¨åŸå§‹Beanæ—¶,è¿”å›åŸå§‹Bean:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> origin;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// ä»£ç†Bean:</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> FirstProxyBean <span style="color:#fff;font-weight:bold">extends</span> OriginBean {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> OriginBean target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FirstProxyBean(OriginBean target) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡<code>SecondProxyBeanPostProcessor</code>ä»£ç†ä¸º<code>SecondProxyBean</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Order(200)
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecondProxyBeanPostProcessor <span style="color:#fff;font-weight:bold">implements</span> BeanPostProcessor {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ä¿å­˜åŸå§‹Bean:</span>
</span></span><span style="display:flex;"><span>    Map&lt;String, Object&gt; originBeans = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessBeforeInitialization(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (OriginBean.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">isAssignableFrom</span>(bean.<span style="color:#007f7f">getClass</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// æ£€æµ‹åˆ°OriginBean,åˆ›å»ºSecondProxyBean:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">var</span> proxy = <span style="color:#fff;font-weight:bold">new</span> SecondProxyBean((OriginBean) bean);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// ä¿å­˜åŸå§‹Bean:</span>
</span></span><span style="display:flex;"><span>            originBeans.<span style="color:#007f7f">put</span>(beanName, bean);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// è¿”å›Proxy:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> proxy;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessOnSetProperty(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        Object origin = originBeans.<span style="color:#007f7f">get</span>(beanName);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (origin != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å­˜åœ¨åŸå§‹Beanæ—¶,è¿”å›åŸå§‹Bean:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> origin;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// ä»£ç†Bean:</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> SecondProxyBean <span style="color:#fff;font-weight:bold">extends</span> OriginBean {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> OriginBean target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SecondProxyBean(OriginBean target) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®šä¹‰ä¸€ä¸ªBeanï¼Œç”¨äºæ£€æµ‹æ˜¯å¦æ³¨å…¥äº†Proxyï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> InjectProxyOnConstructorBean {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> OriginBean injected;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> InjectProxyOnConstructorBean(@Autowired OriginBean injected) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">injected</span> = injected;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">var</span> ctx = <span style="color:#fff;font-weight:bold">new</span> AnnotationConfigApplicationContext(ScanApplication.<span style="color:#007f7f">class</span>, createPropertyResolver());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// è·å–OriginBeançš„å®ä¾‹,æ­¤å¤„è·å–çš„åº”è¯¥æ˜¯SendProxyBeanProxy:</span>
</span></span><span style="display:flex;"><span>OriginBean proxy = ctx.<span style="color:#007f7f">getBean</span>(OriginBean.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>assertSame(SecondProxyBean.<span style="color:#007f7f">class</span>, proxy.<span style="color:#007f7f">getClass</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// proxyçš„nameå’Œversionå­—æ®µå¹¶æ²¡æœ‰è¢«æ³¨å…¥:</span>
</span></span><span style="display:flex;"><span>assertNull(proxy.<span style="color:#007f7f">name</span>);
</span></span><span style="display:flex;"><span>assertNull(proxy.<span style="color:#007f7f">version</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// ä½†æ˜¯è°ƒç”¨proxyçš„getName()ä¼šæœ€ç»ˆè°ƒç”¨åŸå§‹Beançš„getName(),ä»è€Œè¿”å›æ­£ç¡®çš„å€¼:</span>
</span></span><span style="display:flex;"><span>assertEquals(<span style="color:#0ff;font-weight:bold">&#34;Scan App&#34;</span>, proxy.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// è·å–InjectProxyOnConstructorBeanå®ä¾‹:</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">var</span> inject = ctx.<span style="color:#007f7f">getBean</span>(InjectProxyOnConstructorBean.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// æ³¨å…¥çš„OriginBeanåº”è¯¥ä¸ºProxyï¼Œè€Œä¸”å’Œå‰é¢è¿”å›çš„proxyæ˜¯åŒä¸€å®ä¾‹:</span>
</span></span><span style="display:flex;"><span>assertSame(proxy, inject.<span style="color:#007f7f">injected</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»ä¸Šé¢çš„æµ‹è¯•ä»£ç æˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºï¼Œå¯¹äºä½¿ç”¨Proxyæ¨¡å¼çš„Beanæ¥è¯´ï¼Œæ­£å¸¸çš„æ–¹æ³•è°ƒç”¨å¯¹ç”¨æˆ·æ˜¯é€æ˜çš„ï¼Œä½†æ˜¯ï¼Œç›´æ¥è®¿é—®Beanæ³¨å…¥çš„å­—æ®µï¼Œå¦‚æœè·å–çš„æ˜¯Proxyï¼Œåˆ™å­—æ®µå…¨éƒ¨ä¸º<code>null</code>ï¼Œå› ä¸ºæ³¨å…¥å¹¶æ²¡æœ‰å‘ç”Ÿåœ¨Proxyï¼Œè€Œæ˜¯åŸå§‹Beanã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå½“æˆ‘ä»¬éœ€è¦è®¿é—®æŸä¸ªæ³¨å…¥çš„Beanæ—¶ï¼Œæ€»æ˜¯è°ƒç”¨æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥è®¿é—®å­—æ®µï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MailService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    UserService userService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String sendMail() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// é”™è¯¯:ä¸è¦ç›´æ¥è®¿é—®UserServiceçš„å­—æ®µ,å› ä¸ºå¦‚æœUserServiceè¢«ä»£ç†,åˆ™è¿”å›null:</span>
</span></span><span style="display:flex;"><span>        ZoneId zoneId = userService.<span style="color:#007f7f">zoneId</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ­£ç¡®:é€šè¿‡æ–¹æ³•è®¿é—®UserServiceçš„å­—æ®µ,æ— è®ºæ˜¯å¦è¢«ä»£ç†,è¿”å›å€¼å‡æ˜¯æ­£ç¡®çš„:</span>
</span></span><span style="display:flex;"><span>        ZoneId zoneId = userService.<span style="color:#007f7f">getZoneId</span>();
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å®Œæˆiocå®¹å™¨">å®ŒæˆIOCå®¹å™¨<a hidden class="anchor" aria-hidden="true" href="#å®Œæˆiocå®¹å™¨">#</a></h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†IoCå®¹å™¨çš„åŸºæœ¬åŠŸèƒ½ã€‚æœ€åçš„æ”¶å°¾å·¥ä½œä¸»è¦æ˜¯æå–æ¥å£ã€‚å…ˆå®šä¹‰ç»™ç”¨æˆ·ä½¿ç”¨çš„<code>ApplicationContext</code>æ¥å£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> ApplicationContext <span style="color:#fff;font-weight:bold">extends</span> AutoCloseable {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ˜¯å¦å­˜åœ¨æŒ‡å®šnameçš„Beanï¼Ÿ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> containsBean(String name);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ ¹æ®nameè¿”å›å”¯ä¸€Beanï¼Œæœªæ‰¾åˆ°æŠ›å‡ºNoSuchBeanDefinitionException</span>
</span></span><span style="display:flex;"><span>    &lt;T&gt; T getBean(String name);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ ¹æ®nameè¿”å›å”¯ä¸€Beanï¼Œæœªæ‰¾åˆ°æŠ›å‡ºNoSuchBeanDefinitionException</span>
</span></span><span style="display:flex;"><span>    &lt;T&gt; T getBean(String name, Class&lt;T&gt; requiredType);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ ¹æ®typeè¿”å›å”¯ä¸€Beanï¼Œæœªæ‰¾åˆ°æŠ›å‡ºNoSuchBeanDefinitionException</span>
</span></span><span style="display:flex;"><span>    &lt;T&gt; T getBean(Class&lt;T&gt; requiredType);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ ¹æ®typeè¿”å›ä¸€ç»„Beanï¼Œæœªæ‰¾åˆ°è¿”å›ç©ºList</span>
</span></span><span style="display:flex;"><span>    &lt;T&gt; List&lt;T&gt; getBeans(Class&lt;T&gt; requiredType);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å…³é—­å¹¶æ‰§è¡Œæ‰€æœ‰beançš„destroyæ–¹æ³•</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> close();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†å®šä¹‰ä¸€ä¸ªç»™Frameworkçº§åˆ«çš„ä»£ç ç”¨çš„<code>ConfigurableApplicationContext</code>æ¥å£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> ConfigurableApplicationContext <span style="color:#fff;font-weight:bold">extends</span> ApplicationContext {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    List&lt;BeanDefinition&gt; findBeanDefinitions(Class&lt;?&gt; type);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Nullable
</span></span><span style="display:flex;"><span>    BeanDefinition findBeanDefinition(Class&lt;?&gt; type);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Nullable
</span></span><span style="display:flex;"><span>    BeanDefinition findBeanDefinition(String name);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Nullable
</span></span><span style="display:flex;"><span>    BeanDefinition findBeanDefinition(String name, Class&lt;?&gt; requiredType);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Object createBeanAsEarlySingleton(BeanDefinition def);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è®©<code>AnnotationConfigApplicationContext</code>å®ç°æ¥å£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext <span style="color:#fff;font-weight:bold">implements</span> ConfigurableApplicationContext {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é¡ºä¾¿åœ¨<code>close()</code>æ–¹æ³•ä¸­æŠŠBeançš„<code>destroy</code>æ–¹æ³•æ‰§è¡Œäº†ã€‚</p>
<p>æœ€ååŠ ä¸€ä¸ª<code>ApplicationUtils</code>ç±»ï¼Œç›®çš„æ˜¯èƒ½é€šè¿‡<code>getRequiredApplicationContext()</code>æ–¹æ³•éšæ—¶è·å–åˆ°<code>ApplicationContext</code>å®ä¾‹ã€‚</p>
<p>æå®š<code>summer-context</code>æ¨¡å—ï¼</p>
<p>æœ‰çš„åŒå­¦å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ç”¨äº†ä¸åˆ°1000è¡Œæ ¸å¿ƒä»£ç ï¼Œå°±å®ç°äº†<code>ApplicationContext</code>ï¼Ÿå¦‚æœæŸ¥çœ‹Springçš„æºç ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå…‰æ˜¯å±‚æ¬¡ç»“æ„ï¼Œå°±ä»¤äººçœ¼èŠ±ç¼­ä¹±ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BeanFactory
</span></span><span style="display:flex;"><span>  HierarchicalBeanFactory
</span></span><span style="display:flex;"><span>    ConfigurableBeanFactory
</span></span><span style="display:flex;"><span>      AbstractBeanFactory
</span></span><span style="display:flex;"><span>        AbstractAutowireCapableBeanFactory
</span></span><span style="display:flex;"><span>          DefaultListableBeanFactory
</span></span><span style="display:flex;"><span>    ApplicationContext
</span></span><span style="display:flex;"><span>      ConfigurableApplicationContext
</span></span><span style="display:flex;"><span>        AbstractApplicationContext
</span></span><span style="display:flex;"><span>          AbstractRefreshableApplicationContext
</span></span><span style="display:flex;"><span>            AbstractXmlApplicationContext
</span></span><span style="display:flex;"><span>              ClassPathXmlApplicationContext
</span></span><span style="display:flex;"><span>              FileSystemXmlApplicationContext
</span></span><span style="display:flex;"><span>          GenericApplicationContext
</span></span><span style="display:flex;"><span>            AnnotationConfigApplicationContext
</span></span><span style="display:flex;"><span>            GenericXmlApplicationContext
</span></span><span style="display:flex;"><span>            StaticApplicationContext
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶å®æ ¹æœ¬åŸå› æ˜¯æˆ‘ä»¬å¤§å¹…ç®€åŒ–äº†éœ€æ±‚ã€‚Springæœ€æ—©æä¾›äº†<code>BeanFactory</code>å’Œ<code>ApplicationContext</code>ä¸¤ç§å®¹å™¨ï¼Œå‰è€…æ˜¯æ‡’åŠ è½½ï¼Œåè€…æ˜¯ç«‹åˆ»åˆå§‹åŒ–æ‰€æœ‰Beanã€‚æ‡’åŠ è½½çš„ç‰¹æ€§ä¼šå¯¼è‡´ä¾èµ–æ³¨å…¥å˜å¾—æ›´åŠ å¤æ‚ï¼Œè™½ç„¶<code>BeanFactory</code>åœ¨å®é™…é¡¹ç›®ä¸­å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ã€‚ç„¶è€Œä¸€æ—¦å‘å¸ƒäº†æ¥å£ï¼Œå¤„äºå…¼å®¹æ€§è€ƒè™‘ï¼Œå°±æ²¡æ³•å†æ”¶å›å»äº†ã€‚å†è€ƒè™‘åˆ°Springæœ€æ—©é‡‡ç”¨XMLé…ç½®ï¼Œåæ¥é‡‡ç”¨Annotationé…ç½®ï¼Œè¿˜å…è®¸æ··åˆé…ç½®ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæ—©æœŸå‘å¸ƒçš„<code>XmlApplicationContext</code>ä¸èƒ½åŠ¨ï¼Œæ–°çš„Annotationé…ç½®å°±å¿…é¡»æ·»åŠ æ–°çš„å®ç°ç±»ï¼Œæ‰€ä»¥ï¼Œä»£ç çš„å¤æ‚åº¦éšç€éœ€æ±‚å¢åŠ è€Œå¢åŠ ï¼Œä¿æŒå…¼å®¹æ€§åˆä¼šå¯¼è‡´éœ€è¦æ›´å¤šçš„ä»£ç æ¥å®ç°æ–°åŠŸèƒ½ã€‚</p>
<p>æ‰€ä»¥ï¼Œæ²¡äº‹ä¸è¦çæéœ€æ±‚ã€‚</p>
<h1 id="å®ç°aop">å®ç°AOP<a hidden class="anchor" aria-hidden="true" href="#å®ç°aop">#</a></h1>
<p>å®ç°äº†IoCå®¹å™¨åï¼Œæˆ‘ä»¬ç»§ç»­å®ç°AOPåŠŸèƒ½ã€‚</p>
<p>AOPå³Aspect Oriented Programmingï¼Œé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œå®ƒæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªProxyæ¨¡å¼ï¼Œåªä¸è¿‡å¯ä»¥è®©IoCå®¹å™¨åœ¨è¿è¡Œæ—¶å†ç»„åˆèµ·æ¥ï¼Œè€Œä¸æ˜¯äº‹å…ˆè‡ªå·±ç”¨Proxyæ¨¡å¼å†™æ­»äº†ã€‚è€Œå®ç°Proxyæ¨¡å¼çš„æ ¸å¿ƒæ˜¯æ‹¦æˆªç›®æ ‡Beançš„æ–¹æ³•è°ƒç”¨ã€‚</p>
<p>æ—¢ç„¶åŸç†æ˜¯æ–¹æ³•æ‹¦æˆªï¼Œé‚£ä¹ˆAOPçš„å®ç°æ–¹å¼ä¸å¤–ä¹ä»¥ä¸‹å‡ ç§ï¼š</p>
<ol>
<li>ç¼–è¯‘æœŸï¼šåœ¨ç¼–è¯‘æ—¶ï¼Œç”±ç¼–è¯‘å™¨æŠŠåˆ‡é¢è°ƒç”¨ç¼–è¯‘è¿›å­—èŠ‚ç ï¼Œè¿™ç§æ–¹å¼éœ€è¦å®šä¹‰æ–°çš„å…³é”®å­—å¹¶æ‰©å±•ç¼–è¯‘å™¨ï¼ŒAspectJå°±æ‰©å±•äº†Javaç¼–è¯‘å™¨ï¼Œä½¿ç”¨å…³é”®å­—aspectæ¥å®ç°ç»‡å…¥ï¼›</li>
<li>ç±»åŠ è½½å™¨ï¼šåœ¨ç›®æ ‡ç±»è¢«è£…è½½åˆ°JVMæ—¶ï¼Œé€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„ç±»åŠ è½½å™¨ï¼Œå¯¹ç›®æ ‡ç±»çš„å­—èŠ‚ç é‡æ–°â€œå¢å¼ºâ€ï¼›</li>
<li>è¿è¡ŒæœŸï¼šç›®æ ‡å¯¹è±¡å’Œåˆ‡é¢éƒ½æ˜¯æ™®é€šJavaç±»ï¼Œé€šè¿‡JVMçš„åŠ¨æ€ä»£ç†åŠŸèƒ½æˆ–è€…ç¬¬ä¸‰æ–¹åº“å®ç°è¿è¡ŒæœŸåŠ¨æ€ç»‡å…¥ã€‚</li>
</ol>
<p>ä»å¤æ‚åº¦çœ‹ï¼Œæœ€ç®€å•çš„æ˜¯æ–¹æ¡ˆ3ï¼Œå› ä¸ºä¸æ¶‰åŠåˆ°ä»»ä½•JVMåº•å±‚ã€‚</p>
<p>æ–¹æ¡ˆ3åˆæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š</p>
<ol>
<li>ä½¿ç”¨Javaæ ‡å‡†åº“çš„åŠ¨æ€ä»£ç†æœºåˆ¶ï¼Œä¸è¿‡ä»…æ”¯æŒå¯¹æ¥å£ä»£ç†ï¼Œæ— æ³•å¯¹å…·ä½“ç±»å®ç°ä»£ç†ï¼›</li>
<li>ä½¿ç”¨CGLIBæˆ–Javassistè¿™äº›ç¬¬ä¸‰æ–¹åº“ï¼Œé€šè¿‡åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç ï¼Œå¯ä»¥å¯¹å…·ä½“ç±»å®ç°ä»£ç†ã€‚</li>
</ol>
<p>é‚£ä¹ˆSpringçš„å®ç°æ–¹å¼æ˜¯å•¥ï¼ŸSpringå®é™…ä¸Šå†…ç½®äº†å¤šç§ä»£ç†æœºåˆ¶ï¼Œå¦‚æœä¸€ä¸ªBeanå£°æ˜çš„ç±»å‹æ˜¯æ¥å£ï¼Œé‚£ä¹ˆSpringç›´æ¥ä½¿ç”¨Javaæ ‡å‡†åº“å®ç°å¯¹æ¥å£çš„ä»£ç†ï¼Œå¦‚æœä¸€ä¸ªBeanå£°æ˜çš„ç±»å‹æ˜¯Classï¼Œé‚£ä¹ˆSpringå°±ä½¿ç”¨CGLIBåŠ¨æ€ç”Ÿæˆå­—èŠ‚ç å®ç°ä»£ç†ã€‚</p>
<p>é™¤äº†å®ç°ä»£ç†å¤–ï¼Œè¿˜å¾—æœ‰ä¸€å¥—æœºåˆ¶è®©ç”¨æˆ·èƒ½å®šä¹‰ä»£ç†ã€‚Springåˆæä¾›äº†å¤šç§æ–¹å¼ï¼š</p>
<ol>
<li>ç”¨AspectJçš„è¯­æ³•æ¥å®šä¹‰AOPï¼Œæ¯”å¦‚<code>execution(public * com.itranswarp.service.*.*(..))</code>ï¼›</li>
<li>ç”¨æ³¨è§£æ¥å®šä¹‰AOPï¼Œæ¯”å¦‚ç”¨<code>@Transactional</code>è¡¨ç¤ºå¼€å¯äº‹åŠ¡ã€‚</li>
</ol>
<p>ç”¨è¡¨è¾¾å¼åŒ¹é…ï¼Œå¾ˆå®¹æ˜“æ¼æ‰æˆ–è€…æ‰“å‡»é¢å¤ªå¤§ã€‚ç”¨æ³¨è§£æ— ç–‘æ˜¯æœ€ç®€å•çš„ï¼Œå› ä¸ºè¿™æ ·è¢«è£…é…çš„Beanè‡ªå·±èƒ½æ¸…æ¸…æ¥šæ¥šåœ°çŸ¥é“è‡ªå·±è¢«å®‰æ’äº†ã€‚å› æ­¤ï¼Œåœ¨Summer Frameworkä¸­ï¼Œæˆ‘ä»¬åªæ”¯æŒAnnotationæ¨¡å¼çš„AOPæœºåˆ¶ï¼Œå¹¶ä¸”é‡‡ç”¨åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç çš„æ–¹å¼å®ç°ã€‚</p>
<p>æ˜ç¡®äº†éœ€æ±‚ï¼Œæˆ‘ä»¬æ¥çœ‹å¦‚ä½•å®ç°åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç ã€‚Springé‡‡ç”¨çš„æ˜¯CGLIBï¼Œå› æ­¤æˆ‘ä»¬å»CGLIBé¦–é¡µçœ‹ä¸€ä¸‹ï¼Œä¸çœ‹ä¸è¦ç´§ï¼Œä¸€çœ‹å“ä¸€è·³ï¼š</p>
<blockquote>
<p>cglib is unmaintained &hellip; migrating to something like ByteBuddy.</p>
</blockquote>
<p>åŸæ¥CGLIBå·²ç»ä¸ç»´æŠ¤äº†ï¼Œå»ºè®®ä½¿ç”¨ByteBuddyã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å°±é€‰æ‹©ByteBuddyå®ç°AOPå§ã€‚</p>
<p>æ¯”è¾ƒä¸€ä¸‹Spring Frameworkå’ŒSummer Frameworkå¯¹AOPçš„æ”¯æŒï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">Spring Framework</th>
<th style="text-align:left">Summer Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">AspectJæ–¹å¼</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">Annotationæ–¹å¼</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">ä»£ç†æ¥å£</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">ä»£ç†ç±»</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">å®ç°æœºåˆ¶</td>
<td style="text-align:left">CGLIB</td>
<td style="text-align:left">ByteBuddy</td>
</tr>
</tbody>
</table>
<p>ä¸‹é¢æˆ‘ä»¬å°±æ¥å‡†å¤‡å®ç°AOPã€‚</p>
<h2 id="å®ç°proxyresolver">å®ç°ProxyResolver<a hidden class="anchor" aria-hidden="true" href="#å®ç°proxyresolver">#</a></h2>
<p>ä¸ºäº†å®ç°AOPï¼Œæˆ‘ä»¬å…ˆæ€è€ƒå¦‚ä½•åœ¨IoCå®¹å™¨ä¸­å®ç°ä¸€ä¸ªåŠ¨æ€ä»£ç†ã€‚</p>
<p>åœ¨IoCå®¹å™¨ä¸­ï¼Œå®ç°åŠ¨æ€ä»£ç†éœ€è¦ç”¨æˆ·æä¾›ä¸¤ä¸ªBeanï¼š</p>
<ol>
<li>åŸå§‹Beanï¼Œå³éœ€è¦è¢«ä»£ç†çš„Beanï¼›</li>
<li>æ‹¦æˆªå™¨ï¼Œå³æ‹¦æˆªäº†ç›®æ ‡Beançš„æ–¹æ³•åï¼Œä¼šè‡ªåŠ¨è°ƒç”¨æ‹¦æˆªå™¨å®ç°ä»£ç†åŠŸèƒ½ã€‚</li>
</ol>
<p>æ‹¦æˆªå™¨éœ€è¦å®šä¹‰æ¥å£ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ç”¨Javaæ ‡å‡†åº“çš„<code>InvocationHandler</code>ï¼Œå…å»äº†è‡ªå®šä¹‰æ¥å£ã€‚</p>
<p>å‡å®šæˆ‘ä»¬å·²ç»ä»IoCå®¹å™¨ä¸­è·å–äº†åŸå§‹Beanä¸å®ç°äº†<code>InvocationHandler</code>çš„æ‹¦æˆªå™¨Beanï¼Œé‚£ä¹ˆå°±å¯ä»¥ç¼–å†™ä¸€ä¸ª<code>ProxyResolver</code>æ¥å®ç°AOPä»£ç†ã€‚</p>
<p>ä»<a href="https://bytebuddy.net/">ByteBuddyçš„å®˜ç½‘</a>ä¸Šæœç´¢å¾ˆå®¹æ˜“æ‰¾åˆ°ç›¸å…³ä»£ç ï¼Œæˆ‘ä»¬æ•´ç†ä¸º<code>createProxy()</code>æ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ProxyResolver {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ByteBuddyå®ä¾‹:</span>
</span></span><span style="display:flex;"><span>    ByteBuddy byteBuddy = <span style="color:#fff;font-weight:bold">new</span> ByteBuddy();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ä¼ å…¥åŸå§‹Beanã€æ‹¦æˆªå™¨ï¼Œè¿”å›ä»£ç†åçš„å®ä¾‹:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T createProxy(T bean, InvocationHandler handler) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç›®æ ‡Beançš„Classç±»å‹:</span>
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; targetClass = bean.<span style="color:#007f7f">getClass</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åŠ¨æ€åˆ›å»ºProxyçš„Class:</span>
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; proxyClass = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">byteBuddy</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// å­ç±»ç”¨é»˜è®¤æ— å‚æ•°æ„é€ æ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">subclass</span>(targetClass, ConstructorStrategy.<span style="color:#007f7f">Default</span>.<span style="color:#007f7f">DEFAULT_CONSTRUCTOR</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// æ‹¦æˆªæ‰€æœ‰publicæ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">method</span>(ElementMatchers.<span style="color:#007f7f">isPublic</span>()).<span style="color:#007f7f">intercept</span>(InvocationHandlerAdapter.<span style="color:#007f7f">of</span>(
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// æ–°çš„æ‹¦æˆªå™¨å®ä¾‹:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">new</span> InvocationHandler() {
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">public</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>                                <span style="color:#007f7f">// å°†æ–¹æ³•è°ƒç”¨ä»£ç†è‡³åŸå§‹Bean:</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#fff;font-weight:bold">return</span> handler.<span style="color:#007f7f">invoke</span>(bean, method, args);
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }))
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// ç”Ÿæˆå­—èŠ‚ç :</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">make</span>()
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// åŠ è½½å­—èŠ‚ç :</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">load</span>(targetClass.<span style="color:#007f7f">getClassLoader</span>()).<span style="color:#007f7f">getLoaded</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åˆ›å»ºProxyå®ä¾‹:</span>
</span></span><span style="display:flex;"><span>        Object proxy;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            proxy = proxyClass.<span style="color:#007f7f">getConstructor</span>().<span style="color:#007f7f">newInstance</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (RuntimeException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> e;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> (T) proxy;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„<code>InvocationHandler</code>æœ‰ä¸¤å±‚ï¼šå¤–å±‚çš„<code>invoke()</code>ä¼ å…¥çš„Objectæ˜¯Proxyå®ä¾‹ï¼Œå†…å±‚çš„<code>invoke()</code>å°†è°ƒç”¨è½¬å‘è‡³åŸå§‹Beanã€‚</p>
<p>ä¸€å…±å¤§çº¦50è¡Œä»£ç ï¼Œæˆ‘ä»¬å°±å®ç°äº†AOPåŠŸèƒ½ã€‚æœ‰ç‚¹ä¸æ•¢ç›¸ä¿¡ï¼Œèµ¶å¿«å†™ä¸ªæµ‹è¯•çœ‹çœ‹æ•ˆæœã€‚</p>
<p>å…ˆå®šä¹‰ä¸€ä¸ª<code>OriginBean</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OriginBean {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Polite
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String hello() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Hello, &#34;</span> + name + <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String morning() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Morning, &#34;</span> + name + <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬è¦å®ç°çš„AOPåŠŸèƒ½æ˜¯å¢å¼ºå¸¦<code>@Polite</code>æ³¨è§£çš„æ–¹æ³•ï¼ŒæŠŠè¿”å›å€¼<code>Hello, Bob.</code>æ”¹ä¸º<code>Hello, Bob!</code>ï¼Œè®©æ¬¢è¿æ°”æ°›æ›´å¼ºçƒˆä¸€ç‚¹ï¼Œå› æ­¤ï¼Œç¼–å†™ä¸€ä¸ª<code>InvocationHandler</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PoliteInvocationHandler <span style="color:#fff;font-weight:bold">implements</span> InvocationHandler {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object invoke(Object bean, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ä¿®æ”¹æ ‡è®°äº†@Politeçš„æ–¹æ³•è¿”å›å€¼:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (method.<span style="color:#007f7f">getAnnotation</span>(Polite.<span style="color:#007f7f">class</span>) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            String ret = (String) method.<span style="color:#007f7f">invoke</span>(bean, args);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (ret.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>)) {
</span></span><span style="display:flex;"><span>                ret = ret.<span style="color:#007f7f">substring</span>(0, ret.<span style="color:#007f7f">length</span>() - 1) + <span style="color:#0ff;font-weight:bold">&#34;!&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> ret;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> method.<span style="color:#007f7f">invoke</span>(bean, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æµ‹è¯•ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// åŸå§‹Bean:</span>
</span></span><span style="display:flex;"><span>OriginBean origin = <span style="color:#fff;font-weight:bold">new</span> OriginBean();
</span></span><span style="display:flex;"><span>origin.<span style="color:#007f7f">name</span> = <span style="color:#0ff;font-weight:bold">&#34;Bob&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// è°ƒç”¨åŸå§‹Beançš„hello():</span>
</span></span><span style="display:flex;"><span>assertEquals(<span style="color:#0ff;font-weight:bold">&#34;Hello, Bob.&#34;</span>, origin.<span style="color:#007f7f">hello</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// åˆ›å»ºProxy:</span>
</span></span><span style="display:flex;"><span>OriginBean proxy = <span style="color:#fff;font-weight:bold">new</span> ProxyResolver().<span style="color:#007f7f">createProxy</span>(origin, <span style="color:#fff;font-weight:bold">new</span> PoliteInvocationHandler());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// Proxyç±»å,ç±»ä¼¼OriginBean$ByteBuddy$9hQwRy3T:</span>
</span></span><span style="display:flex;"><span>System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(proxy.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// Proxyç±»ä¸OriginBean.classä¸åŒ:</span>
</span></span><span style="display:flex;"><span>assertNotSame(OriginBean.<span style="color:#007f7f">class</span>, proxy.<span style="color:#007f7f">getClass</span>());
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// proxyå®ä¾‹çš„nameå­—æ®µåº”ä¸ºnull:</span>
</span></span><span style="display:flex;"><span>assertNull(proxy.<span style="color:#007f7f">name</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// è°ƒç”¨å¸¦@Politeçš„æ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>assertEquals(<span style="color:#0ff;font-weight:bold">&#34;Hello, Bob!&#34;</span>, proxy.<span style="color:#007f7f">hello</span>());
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// è°ƒç”¨ä¸å¸¦@Politeçš„æ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>assertEquals(<span style="color:#0ff;font-weight:bold">&#34;Morning, Bob.&#34;</span>, proxy.<span style="color:#007f7f">morning</span>());
</span></span></code></pre></td></tr></table>
</div>
</div><p>æµ‹è¯•é€šè¿‡ï¼Œæœ¬èŠ‚åˆ°æ­¤æ”¶å·¥ã€‚</p>
<h2 id="å®ç°around">å®ç°Around<a hidden class="anchor" aria-hidden="true" href="#å®ç°around">#</a></h2>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»å®ç°äº†ProxyResolverï¼Œä¸‹ä¸€æ­¥ï¼Œå®ç°å®Œæ•´çš„AOPå°±å¾ˆå®¹æ˜“äº†ã€‚</p>
<p>æˆ‘ä»¬å…ˆä»å®¢æˆ·ç«¯ä»£ç å…¥æ‰‹ï¼Œçœ‹çœ‹åº”å½“æ€ä¹ˆè£…é…AOPã€‚</p>
<p>é¦–å…ˆï¼Œå®¢æˆ·ç«¯éœ€è¦å®šä¹‰ä¸€ä¸ªåŸå§‹Beanï¼Œä¾‹å¦‚<code>OriginBean</code>ï¼Œç”¨<code>@Around</code>æ³¨è§£æ ‡æ³¨ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@Around(<span style="color:#0ff;font-weight:bold">&#34;aroundInvocationHandler&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OriginBean {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${customer.name}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Polite
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String hello() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Hello, &#34;</span> + name + <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String morning() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Morning, &#34;</span> + name + <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>@Around</code>æ³¨è§£çš„å€¼<code>aroundInvocationHandler</code>æŒ‡å‡ºåº”è¯¥æŒ‰ä»€ä¹ˆåå­—æŸ¥æ‰¾æ‹¦æˆªå™¨ï¼Œå› æ­¤ï¼Œå®¢æˆ·ç«¯åº”å†å®šä¹‰ä¸€ä¸ª<code>AroundInvocationHandler</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AroundInvocationHandler <span style="color:#fff;font-weight:bold">implements</span> InvocationHandler {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ‹¦æˆªæ ‡è®°äº†@Politeçš„æ–¹æ³•è¿”å›å€¼:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (method.<span style="color:#007f7f">getAnnotation</span>(Polite.<span style="color:#007f7f">class</span>) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            String ret = (String) method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (ret.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>)) {
</span></span><span style="display:flex;"><span>                ret = ret.<span style="color:#007f7f">substring</span>(0, ret.<span style="color:#007f7f">length</span>() - 1) + <span style="color:#0ff;font-weight:bold">&#34;!&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> ret;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ‰äº†åŸå§‹Beanã€æ‹¦æˆªå™¨ï¼Œå°±å¯ä»¥åœ¨IoCå®¹å™¨ä¸­è£…é…AOPï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AroundApplication {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    AroundProxyBeanPostProcessor createAroundProxyBeanPostProcessor() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> AroundProxyBeanPostProcessor();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°è£…é…AOPæ˜¯é€šè¿‡<code>AroundProxyBeanPostProcessor</code>å®ç°çš„ï¼Œè€Œè¿™ä¸ªç±»æ˜¯ç”±Frameworkæä¾›ï¼Œå®¢æˆ·ç«¯å¹¶ä¸éœ€è¦è‡ªå·±å®ç°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¼€å‘ä¸€ä¸ª<code>AroundProxyBeanPostProcessor</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AroundProxyBeanPostProcessor <span style="color:#fff;font-weight:bold">implements</span> BeanPostProcessor {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Map&lt;String, Object&gt; originBeans = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessBeforeInitialization(Object bean, String beanName) <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; beanClass = bean.<span style="color:#007f7f">getClass</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ£€æµ‹@Aroundæ³¨è§£:</span>
</span></span><span style="display:flex;"><span>        Around anno = beanClass.<span style="color:#007f7f">getAnnotation</span>(Around.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (anno != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            String handlerName;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                handlerName = (String) anno.<span style="color:#007f7f">annotationType</span>().<span style="color:#007f7f">getMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;value&#34;</span>).<span style="color:#007f7f">invoke</span>(anno);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (ReflectiveOperationException e) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AopConfigException();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            Object proxy = createProxy(beanClass, bean, handlerName);
</span></span><span style="display:flex;"><span>            originBeans.<span style="color:#007f7f">put</span>(beanName, bean);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> proxy;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Object createProxy(Class&lt;?&gt; beanClass, Object bean, String handlerName) {
</span></span><span style="display:flex;"><span>        ConfigurableApplicationContext ctx = (ConfigurableApplicationContext) ApplicationContextUtils.<span style="color:#007f7f">getRequiredApplicationContext</span>();
</span></span><span style="display:flex;"><span>        BeanDefinition def = ctx.<span style="color:#007f7f">findBeanDefinition</span>(handlerName);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (def == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AopConfigException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Object handlerBean = def.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (handlerBean == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            handlerBean = ctx.<span style="color:#007f7f">createBeanAsEarlySingleton</span>(def);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (handlerBean <span style="color:#fff;font-weight:bold">instanceof</span> InvocationHandler handler) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> ProxyResolver.<span style="color:#007f7f">getInstance</span>().<span style="color:#007f7f">createProxy</span>(bean, handler);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AopConfigException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessOnSetProperty(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        Object origin = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">originBeans</span>.<span style="color:#007f7f">get</span>(beanName);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> origin != <span style="color:#fff;font-weight:bold">null</span> ? origin : bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°<code>AroundProxyBeanPostProcessor</code>çš„æœºåˆ¶éå¸¸ç®€å•ï¼šæ£€æµ‹æ¯ä¸ªBeanå®ä¾‹æ˜¯å¦å¸¦æœ‰<code>@Around</code>æ³¨è§£ï¼Œå¦‚æœæœ‰ï¼Œå°±æ ¹æ®æ³¨è§£çš„å€¼æŸ¥æ‰¾Beanä½œä¸º<code>InvocationHandler</code>ï¼Œæœ€ååˆ›å»ºProxyï¼Œè¿”å›å‰ä¿å­˜äº†åŸå§‹Beançš„å¼•ç”¨ï¼Œå› ä¸ºIoCå®¹å™¨åœ¨åç»­çš„æ³¨å…¥é˜¶æ®µè¦æŠŠç›¸å…³ä¾èµ–å’Œå€¼æ³¨å…¥åˆ°åŸå§‹Beanã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼ŒSummer Frameworkæä¾›çš„åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>Around</code>æ³¨è§£ï¼›</li>
<li><code>AroundProxyBeanPostProcessor</code>å®ç°AOPã€‚</li>
</ul>
<p>å®¢æˆ·ç«¯ä»£ç éœ€è¦æä¾›çš„åŒ…æ‹¬ï¼š</p>
<ul>
<li>å¸¦<code>@Around</code>æ³¨è§£çš„åŸå§‹Beanï¼›</li>
<li>å®ç°<code>InvocationHandler</code>çš„Beanï¼Œåå­—ä¸<code>@Around</code>æ³¨è§£valueä¿æŒä¸€è‡´ã€‚</li>
</ul>
<p>æ²¡æœ‰é¢å¤–çš„è¦æ±‚äº†ã€‚</p>
<h3 id="å®ç°beforeå’Œafter">å®ç°Beforeå’ŒAfter<a hidden class="anchor" aria-hidden="true" href="#å®ç°beforeå’Œafter">#</a></h3>
<p>æˆ‘ä»¬å†ç»§ç»­æ€è€ƒï¼ŒSpringæä¾›çš„AOPæ‹¦æˆªå™¨ï¼Œæœ‰Aroundã€Beforeå’ŒAfterç­‰å¥½å‡ ç§ã€‚å¦‚ä½•å®ç°Beforeå’ŒAfteræ‹¦æˆªï¼Ÿ</p>
<p>å®é™…ä¸ŠAroundæ‹¦æˆªæœ¬èº«å°±åŒ…å«äº†Beforeå’ŒAfteræ‹¦æˆªï¼Œæˆ‘ä»¬æ²¡å¿…è¦å»ä¿®æ”¹<code>ProxyResolver</code>ï¼Œåªéœ€è¦ç”¨Adapteræ¨¡å¼æä¾›ä¸¤ä¸ªæ‹¦æˆªå™¨æ¨¡ç‰ˆï¼Œä¸€ä¸ªæ˜¯<code>BeforeInvocationHandlerAdapter</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">class</span> BeforeInvocationHandlerAdapter <span style="color:#fff;font-weight:bold">implements</span> InvocationHandler {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">void</span> before(Object proxy, Method method, Object[] args);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>        before(proxy, method, args);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®¢æˆ·ç«¯æä¾›çš„<code>InvocationHandler</code>åªéœ€ç»§æ‰¿è‡ª<code>BeforeInvocationHandlerAdapter</code>ï¼Œè‡ªç„¶å°±éœ€è¦è¦†å†™<code>before()</code>æ–¹æ³•ï¼Œå®ç°äº†Beforeæ‹¦æˆªã€‚</p>
<p>Afteræ‹¦æˆªä¹Ÿæ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨æ¨¡ç‰ˆï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">class</span> AfterInvocationHandlerAdapter <span style="color:#fff;font-weight:bold">implements</span> InvocationHandler {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// afterå…è®¸ä¿®æ”¹æ–¹æ³•è¿”å›å€¼:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> Object after(Object proxy, Object returnValue, Method method, Object[] args);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>        Object ret = method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> after(proxy, ret, method, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ‰©å±•annotation">æ‰©å±•Annotation<a hidden class="anchor" aria-hidden="true" href="#æ‰©å±•annotation">#</a></h3>
<p>æˆªæ­¢ç›®å‰ï¼Œå®¢æˆ·ç«¯åªéœ€è¦å®šä¹‰å¸¦æœ‰<code>@Around</code>æ³¨è§£çš„Beanï¼Œå°±èƒ½è‡ªåŠ¨è§¦å‘AOPã€‚æˆ‘ä»¬æ€è€ƒä¸‹Springçš„äº‹åŠ¡æœºåˆ¶ï¼Œå…¶å®ä¹Ÿæ˜¯AOPæ‹¦æˆªï¼Œä¸è¿‡å®ƒçš„æ³¨è§£æ˜¯<code>@Transactional</code>ã€‚å¦‚æœè¦æ‰©å±•Annotationï¼Œå³èƒ½è‡ªå®šä¹‰æ³¨è§£æ¥å¯åŠ¨AOPï¼Œæ€ä¹ˆåšï¼Ÿ</p>
<p>å‡è®¾æˆ‘ä»¬åç»­ç¼–å†™äº†ä¸€ä¸ªäº‹åŠ¡æ¨¡å—ï¼Œæä¾›æ³¨è§£<code>@Transactional</code>ï¼Œé‚£ä¹ˆï¼Œè¦å¯åŠ¨AOPï¼Œå°±å¿…é¡»ä»¿ç…§<code>AroundProxyBeanPostProcessor</code>ï¼Œæä¾›ä¸€ä¸ª<code>TransactionProxyBeanPostProcessor</code>ï¼Œä¸è¿‡å¤åˆ¶ä»£ç å¤ªéº»çƒ¦äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹é€ ä¸€ä¸‹<code>AroundProxyBeanPostProcessor</code>ï¼Œç”¨èŒƒå‹ä»£ç å¤„ç†Annotationï¼Œå…ˆæŠ½è±¡å‡ºä¸€ä¸ª<code>AnnotationProxyBeanPostProcessor</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationProxyBeanPostProcessor&lt;A <span style="color:#fff;font-weight:bold">extends</span> Annotation&gt; <span style="color:#fff;font-weight:bold">implements</span> BeanPostProcessor {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Map&lt;String, Object&gt; originBeans = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    Class&lt;A&gt; annotationClass;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> AnnotationProxyBeanPostProcessor() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">annotationClass</span> = getParameterizedType();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ç°<code>AroundProxyBeanPostProcessor</code>å°±ä¸€è¡Œå®šä¹‰ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AroundProxyBeanPostProcessor <span style="color:#fff;font-weight:bold">extends</span> AnnotationProxyBeanPostProcessor&lt;Around&gt; {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åç»­å¦‚æœæˆ‘ä»¬æƒ³å®ç°<code>@Transactional</code>æ³¨è§£ï¼Œåªéœ€å®šä¹‰ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TransactionalProxyBeanPostProcessor <span style="color:#fff;font-weight:bold">extends</span> AnnotationProxyBeanPostProcessor&lt;Transactional&gt; {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°±èƒ½è‡ªåŠ¨æ ¹æ®<code>@Transactional</code>å¯åŠ¨AOPã€‚</p>
<h1 id="å®ç°jdbcå’Œäº‹åŠ¡">å®ç°JDBCå’Œäº‹åŠ¡<a hidden class="anchor" aria-hidden="true" href="#å®ç°jdbcå’Œäº‹åŠ¡">#</a></h1>
<p>æˆ‘ä»¬å·²ç»å®ç°äº†IoCå®¹å™¨å’ŒAOPåŠŸèƒ½ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ JDBCå’Œäº‹åŠ¡çš„æ”¯æŒå°±æ¯”è¾ƒå®¹æ˜“äº†ã€‚</p>
<p>Springå¯¹JDBCæ•°æ®åº“çš„æ”¯æŒä¸»è¦åŒ…æ‹¬ï¼š</p>
<ol>
<li>æä¾›äº†ä¸€ä¸ª<code>JdbcTemplate</code>å’Œ<code>NamedParameterJdbcTemplate</code>æ¨¡æ¿ç±»ï¼Œå¯ä»¥æ–¹ä¾¿åœ°æ“ä½œJDBCï¼›</li>
<li>æ”¯æŒæµè¡Œçš„ORMæ¡†æ¶ï¼Œå¦‚Hibernateã€JPAç­‰ï¼›</li>
<li>æ”¯æŒå£°æ˜å¼äº‹åŠ¡ï¼Œåªéœ€è¦é€šè¿‡ç®€å•çš„æ³¨è§£é…ç½®å³å¯å®ç°äº‹åŠ¡ç®¡ç†ã€‚</li>
</ol>
<p>åœ¨Summer Frameworkä¸­ï¼Œæˆ‘ä»¬å‡†å¤‡æä¾›ä¸€ä¸ª<code>JdbcTemplate</code>æ¨¡æ¿ï¼Œä»¥åŠå£°æ˜å¼äº‹åŠ¡çš„æ”¯æŒã€‚å¯¹äºORMï¼Œåæ­£æ‰‹åŠ¨é›†æˆä¹Ÿæ¯”è¾ƒå®¹æ˜“ï¼Œå°±ä¸ç®¡äº†ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">Spring Framework</th>
<th style="text-align:left">Summer Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JdbcTemplate</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">NamedParameterJdbcTemplate</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">è½¬æ¢SQLé”™è¯¯ç </td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">ORM</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">æ‰‹åŠ¨ç®¡ç†äº‹åŠ¡</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">å£°æ˜å¼äº‹åŠ¡</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">æ”¯æŒ</td>
</tr>
</tbody>
</table>
<p>ä¸‹é¢å¼€å§‹æ­£å¼å¼€å‘Summer Frameworkçš„<code>JdbcTemplate</code>ä¸å£°æ˜å¼äº‹åŠ¡ã€‚</p>
<h2 id="å®ç°jdbctemplate">å®ç°JdbcTemplate<a hidden class="anchor" aria-hidden="true" href="#å®ç°jdbctemplate">#</a></h2>
<p>æœ¬èŠ‚æˆ‘ä»¬æ¥å®ç°JdbcTemplateã€‚åœ¨Springä¸­ï¼Œé€šè¿‡JdbcTemplateï¼ŒåŸºæœ¬å°è£…äº†æ‰€æœ‰JDBCæ“ä½œï¼Œå¯ä»¥è¦†ç›–ç»å¤§å¤šæ•°æ•°æ®åº“æ“ä½œçš„åœºæ™¯ã€‚</p>
<h3 id="é…ç½®datasource">é…ç½®DataSource<a hidden class="anchor" aria-hidden="true" href="#é…ç½®datasource">#</a></h3>
<p>ä½¿ç”¨JdbcTemplateä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®JDBCæ•°æ®æºã€‚Springæœ¬èº«åªæä¾›äº†åŸºç¡€çš„<code>DriverManagerDataSource</code>ï¼Œä½†Spring Bootæœ‰ä¸€ä¸ªé»˜è®¤é…ç½®çš„æ•°æ®æºï¼Œå¹¶é‡‡ç”¨HikariCPä½œä¸ºè¿æ¥æ± ã€‚è¿™é‡Œæˆ‘ä»¬ä»¿ç…§Spring Bootçš„æ–¹å¼ï¼Œå…ˆå®šä¹‰é»˜è®¤çš„æ•°æ®æºé…ç½®é¡¹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">summer</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:sqlite:test.db
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">driver-class-name</span>: org.sqlite.JDBC
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: sa
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: 
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†å®ç°ä¸€ä¸ªHikariCPæ”¯æŒçš„<code>DataSource</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JdbcConfiguration {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(destroyMethod = <span style="color:#0ff;font-weight:bold">&#34;close&#34;</span>)
</span></span><span style="display:flex;"><span>    DataSource dataSource(
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// properties:</span>
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.url}&#34;</span>) String url,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.username}&#34;</span>) String username,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.password}&#34;</span>) String password,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.driver-class-name:}&#34;</span>) String driver,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.maximum-pool-size:20}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> maximumPoolSize,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.minimum-pool-size:1}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> minimumPoolSize,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.connection-timeout:30000}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> connTimeout
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> config = <span style="color:#fff;font-weight:bold">new</span> HikariConfig();
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setAutoCommit</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setJdbcUrl</span>(url);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setUsername</span>(username);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setPassword</span>(password);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (driver != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            config.<span style="color:#007f7f">setDriverClassName</span>(driver);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setMaximumPoolSize</span>(maximumPoolSize);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setMinimumIdle</span>(minimumPoolSize);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setConnectionTimeout</span>(connTimeout);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> HikariDataSource(config);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ï¼Œå®¢æˆ·ç«¯å¼•å…¥<code>JdbcConfiguration</code>å°±è‡ªåŠ¨è·å¾—äº†æ•°æ®æºï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Import(JdbcConfiguration.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å®šä¹‰jdbctemplate">å®šä¹‰JdbcTemplate<a hidden class="anchor" aria-hidden="true" href="#å®šä¹‰jdbctemplate">#</a></h3>
<p>ä¸‹ä¸€æ­¥æ˜¯å®šä¹‰<code>JdbcTemplate</code>ï¼Œå”¯ä¸€ä¾èµ–æ˜¯æ³¨å…¥<code>DataSource</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JdbcTemplate {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> DataSource dataSource;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> JdbcTemplate(DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">dataSource</span> = dataSource;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>JdbcTemplateåŸºäº<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1281319636041762">Templateæ¨¡å¼</a>ï¼Œæä¾›äº†å¤§é‡ä»¥å›è°ƒä½œä¸ºå‚æ•°çš„æ¨¡æ¿æ–¹æ³•ï¼Œå…¶ä¸­ä»¥<code>execute(ConnectionCallback)</code>ä¸ºåŸºç¡€ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T execute(ConnectionCallback&lt;T&gt; action) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (Connection newConn = dataSource.<span style="color:#007f7f">getConnection</span>()) {
</span></span><span style="display:flex;"><span>        T result = action.<span style="color:#007f7f">doInConnection</span>(newConn);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (SQLException e) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> DataAccessException(e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å³ç”±<code>JdbcTemplate</code>å¤„ç†è·å–è¿æ¥ã€é‡Šæ”¾è¿æ¥ã€æ•è·SQLExceptionï¼Œä¸Šå±‚ä»£ç ä¸“æ³¨äºä½¿ç”¨<code>Connection</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@FunctionalInterface
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> ConnectionCallback&lt;T&gt; {
</span></span><span style="display:flex;"><span>    @Nullable
</span></span><span style="display:flex;"><span>    T doInConnection(Connection con) <span style="color:#fff;font-weight:bold">throws</span> SQLException;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä»–æ–¹æ³•å…¶å®ä¹Ÿæ˜¯åŸºäº<code>execute(ConnectionCallback)</code>ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T execute(PreparedStatementCreator psc, PreparedStatementCallback&lt;T&gt; action) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> execute((Connection con) -&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> (PreparedStatement ps = psc.<span style="color:#007f7f">createPreparedStatement</span>(con)) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> action.<span style="color:#007f7f">doInPreparedStatement</span>(ps);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç å®ç°äº†<code>ConnectionCallback</code>ï¼Œå†…éƒ¨åˆè°ƒç”¨äº†ä¼ å…¥çš„<code>PreparedStatementCreator</code>å’Œ<code>PreparedStatementCallback</code>ï¼Œè¿™æ ·ï¼ŒåŸºäºæ›´æ–°æ“ä½œçš„<code>update</code>å°±å¯ä»¥è¿™ä¹ˆå†™ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">int</span> update(String sql, Object... args) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> execute(
</span></span><span style="display:flex;"><span>        preparedStatementCreator(sql, args),
</span></span><span style="display:flex;"><span>        (PreparedStatement ps) -&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> ps.<span style="color:#007f7f">executeUpdate</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŸºäºæŸ¥è¯¢æ“ä½œçš„<code>queryForList()</code>å°±å¯ä»¥è¿™ä¹ˆå†™ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; List&lt;T&gt; queryForList(String sql, RowMapper&lt;T&gt; rowMapper, Object... args) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> execute(preparedStatementCreator(sql, args),
</span></span><span style="display:flex;"><span>        (PreparedStatement ps) -&gt; {
</span></span><span style="display:flex;"><span>            List&lt;T&gt; list = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> (ResultSet rs = ps.<span style="color:#007f7f">executeQuery</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">while</span> (rs.<span style="color:#007f7f">next</span>()) {
</span></span><span style="display:flex;"><span>                    list.<span style="color:#007f7f">add</span>(rowMapper.<span style="color:#007f7f">mapRow</span>(rs, rs.<span style="color:#007f7f">getRow</span>()));
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> list;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‰©ä¸‹çš„ä¸€ç³»åˆ—æŸ¥è¯¢æ–¹æ³•éƒ½æ˜¯åŸºäºä¸Šè¿°æ–¹æ³•çš„å°è£…ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>queryForList(String sql, RowMapper rowMapper, Object&hellip; args)</li>
<li>queryForList(String sql, Class clazz, Object&hellip; args)</li>
<li>queryForNumber(String sql, Object&hellip; args)</li>
</ul>
<p>æ€»ä¹‹ï¼Œå°±æ˜¯ä¸€ä¸ªå·¥ä½œé‡çš„é—®é¢˜ï¼Œå¼€å‘éš¾åº¦åŸºæœ¬ä¸º0ã€‚</p>
<p>æµ‹è¯•æ—¶ï¼Œå¯ä»¥ä½¿ç”¨Sqliteè¿™ä¸ªè½»é‡çº§æ•°æ®åº“ï¼Œæµ‹è¯•ç”¨ä¾‹è¦†ç›–åˆ°å„ç§SQLæ“ä½œï¼Œæœ€åæŠŠ<code>JdbcTemplate</code>åŠ å…¥åˆ°<code>JdbcConfiguration</code>ä¸­ï¼Œå°±åŸºæœ¬å®Œå–„äº†ã€‚</p>
<h2 id="å®ç°å£°æ˜å¼äº‹åŠ¡">å®ç°å£°æ˜å¼äº‹åŠ¡<a hidden class="anchor" aria-hidden="true" href="#å®ç°å£°æ˜å¼äº‹åŠ¡">#</a></h2>
<p>Springæä¾›çš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†èƒ½æå¤§åœ°é™ä½åº”ç”¨ç¨‹åºçš„äº‹åŠ¡ä»£ç ã€‚å¦‚æœä½¿ç”¨åŸºäºAnnotationé…ç½®çš„å£°æ˜å¼äº‹åŠ¡ï¼Œåˆ™ä¸€ä¸ªä¸æ•°æ®åº“æ“ä½œç›¸å…³çš„ç±»åªéœ€åŠ ä¸Š<code>@Transactional</code>æ³¨è§£ï¼Œå°±å®ç°äº†äº‹åŠ¡æ”¯æŒï¼Œéå¸¸æ–¹ä¾¿ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Transactional
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Springçš„å£°æ˜å¼äº‹åŠ¡æ”¯æŒJDBCæœ¬åœ°äº‹åŠ¡å’ŒJTAåˆ†å¸ƒå¼äº‹åŠ¡ä¸¤ç§ï¼Œäº‹åŠ¡ä¼ æ’­æ¨¡å‹é™¤äº†æœ€å¸¸ç”¨çš„<code>REQUIRED</code>ï¼Œè¿˜åŒ…æ‹¬Java EEå®šä¹‰çš„<code>SUPPORTS</code>ã€<code>REQUIRED_NEW</code>ã€<code>NESTED</code>ç­‰å¤šç§æ¨¡å¼ã€‚Summer Frameworkå‡ºäºç®€åŒ–ç›®çš„ï¼Œä»…æ”¯æŒJDBCæœ¬åœ°äº‹åŠ¡ï¼Œäº‹åŠ¡ä¼ æ’­æ¨¡å‹ä»…æ”¯æŒæœ€å¸¸ç”¨çš„<code>REQUIRED</code>ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§ç®€åŒ–ä»£ç ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">Spring Framework</th>
<th style="text-align:left">Summer Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JDBCäº‹åŠ¡</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">JTAäº‹åŠ¡</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">REQUIREDä¼ æ’­æ¨¡å¼</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">å…¶ä»–ä¼ æ’­æ¨¡å¼</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">è®¾ç½®éš”ç¦»çº§åˆ«</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
</tbody>
</table>
<p>ä¸‹é¢æˆ‘ä»¬å°±æ¥ç¼–å†™å£°æ˜å¼äº‹åŠ¡ç®¡ç†ã€‚</p>
<p>é¦–å…ˆå®šä¹‰<code>@Transactional</code>ï¼Œè¿™é‡Œå°±ä¸å…è®¸å•ç‹¬åœ¨æ–¹æ³•å¤„å®šä¹‰ï¼Œç›´æ¥åœ¨classçº§åˆ«å¯åŠ¨æ‰€æœ‰publicæ–¹æ³•çš„äº‹åŠ¡ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Target(ElementType.<span style="color:#007f7f">TYPE</span>)
</span></span><span style="display:flex;"><span>@Retention(RetentionPolicy.<span style="color:#007f7f">RUNTIME</span>)
</span></span><span style="display:flex;"><span>@Documented
</span></span><span style="display:flex;"><span>@Inherited
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> @interface Transactional {
</span></span><span style="display:flex;"><span>    String value() <span style="color:#fff;font-weight:bold">default</span> <span style="color:#0ff;font-weight:bold">&#34;platformTransactionManager&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é»˜è®¤å€¼<code>platformTransactionManager</code>è¡¨ç¤ºç”¨åå­—ä¸º<code>platformTransactionManager</code>çš„Beanæ¥ç®¡ç†äº‹åŠ¡ã€‚</p>
<p>ä¸‹ä¸€æ­¥æ˜¯å®šä¹‰æ¥å£<code>PlatformTransactionManager</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> PlatformTransactionManager {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶å®å•¥ä¹Ÿæ²¡æœ‰ï¼Œå°±æ˜¯ä¸€ä¸ªæ ‡è¯†ä½œç”¨ã€‚</p>
<p>æ¥ç€å®šä¹‰<code>TransactionStatus</code>ï¼Œè¡¨ç¤ºå½“å‰äº‹åŠ¡çŠ¶æ€ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TransactionStatus {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Connection connection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TransactionStatus(Connection connection) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">connection</span> = connection;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç›®å‰ä»…å°è£…äº†ä¸€ä¸ªConnectionï¼Œå°†æ¥å¦‚æœæ‰©å±•ï¼Œåˆ™å¯ä»¥å°†äº‹åŠ¡çš„ä¼ æ’­æ¨¡å¼å­˜å‚¨åœ¨é‡Œé¢ã€‚</p>
<p>æœ€åå†™ä¸ª<code>DataSourceTransactionManager</code>ï¼Œå®ƒæŒæœ‰ä¸€ä¸ª<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1306581251653666">ThreadLocal</a>å­˜å‚¨çš„<code>TransactionStatus</code>ï¼Œä»¥åŠä¸€ä¸ª<code>DataSource</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DataSourceTransactionManager <span style="color:#fff;font-weight:bold">implements</span>
</span></span><span style="display:flex;"><span>        PlatformTransactionManager, InvocationHandler
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ThreadLocal&lt;TransactionStatus&gt; transactionStatus = <span style="color:#fff;font-weight:bold">new</span> ThreadLocal&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> DataSource dataSource;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> DataSourceTransactionManager(DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">dataSource</span> = dataSource;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸º<code>DataSourceTransactionManager</code>æ˜¯çœŸæ­£æ‰§è¡Œå¼€å¯ã€æäº¤ã€å›å½’äº‹åŠ¡çš„åœ°æ–¹ï¼Œåœ¨å“ªæ‰§è¡Œå‘¢ï¼Ÿå°±åœ¨<code>invoke()</code>å†…éƒ¨ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Override
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>    TransactionStatus ts = transactionStatus.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (ts == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å½“å‰æ— äº‹åŠ¡,å¼€å¯æ–°äº‹åŠ¡:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> (Connection connection = dataSource.<span style="color:#007f7f">getConnection</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> autoCommit = connection.<span style="color:#007f7f">getAutoCommit</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (autoCommit) {
</span></span><span style="display:flex;"><span>                connection.<span style="color:#007f7f">setAutoCommit</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// è®¾ç½®ThreadLocalçŠ¶æ€:</span>
</span></span><span style="display:flex;"><span>                transactionStatus.<span style="color:#007f7f">set</span>(<span style="color:#fff;font-weight:bold">new</span> TransactionStatus(connection));
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// è°ƒç”¨ä¸šåŠ¡æ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>                Object r = method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// æäº¤äº‹åŠ¡:</span>
</span></span><span style="display:flex;"><span>                connection.<span style="color:#007f7f">commit</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// æ–¹æ³•è¿”å›:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> r;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (InvocationTargetException e) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// å›æ»šäº‹åŠ¡:</span>
</span></span><span style="display:flex;"><span>                TransactionException te = <span style="color:#fff;font-weight:bold">new</span> TransactionException(e.<span style="color:#007f7f">getCause</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                    connection.<span style="color:#007f7f">rollback</span>();
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">catch</span> (SQLException sqle) {
</span></span><span style="display:flex;"><span>                    te.<span style="color:#007f7f">addSuppressed</span>(sqle);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> te;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// åˆ é™¤ThreadLocalçŠ¶æ€:</span>
</span></span><span style="display:flex;"><span>                transactionStatus.<span style="color:#007f7f">remove</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (autoCommit) {
</span></span><span style="display:flex;"><span>                    connection.<span style="color:#007f7f">setAutoCommit</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å½“å‰å·²æœ‰äº‹åŠ¡,åŠ å…¥å½“å‰äº‹åŠ¡æ‰§è¡Œ:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·å°±å®ç°äº†å£°æ˜å¼äº‹åŠ¡ã€‚</p>
<p>æœ‰çš„åŒå­¦ä¼šé—®ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•å¼€å¯äº†äº‹åŠ¡ï¼Œé‚£ä¹ˆï¼Œå®ƒå†…éƒ¨è°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œæ˜¯æ€ä¹ˆåŠ å…¥å½“å‰äº‹åŠ¡çš„ï¼Ÿ</p>
<p>è¿™é‡Œæˆ‘ä»¬å…ˆéœ€è¦å†™ä¸€ä¸ªè·å–å½“å‰äº‹åŠ¡è¿æ¥çš„å·¥å…·ç±»ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TransactionalUtils {
</span></span><span style="display:flex;"><span>    @Nullable
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Connection getCurrentConnection() {
</span></span><span style="display:flex;"><span>        TransactionStatus ts = DataSourceTransactionManager.<span style="color:#007f7f">transactionStatus</span>.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ts == <span style="color:#fff;font-weight:bold">null</span> ? <span style="color:#fff;font-weight:bold">null</span> : ts.<span style="color:#007f7f">connection</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæ”¹é€ ä¸‹<code>JdbcTemplate</code>è·å–è¿æ¥çš„ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JdbcTemplate {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T execute(ConnectionCallback&lt;T&gt; action) <span style="color:#fff;font-weight:bold">throws</span> DataAccessException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å°è¯•è·å–å½“å‰äº‹åŠ¡è¿æ¥:</span>
</span></span><span style="display:flex;"><span>        Connection current = TransactionalUtils.<span style="color:#007f7f">getCurrentConnection</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (current != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> action.<span style="color:#007f7f">doInConnection</span>(current);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (SQLException e) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> DataAccessException(e);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ— äº‹åŠ¡,ä»DataSourceè·å–æ–°è¿æ¥:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> (Connection newConn = dataSource.<span style="color:#007f7f">getConnection</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> action.<span style="color:#007f7f">doInConnection</span>(newConn);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (SQLException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> DataAccessException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ï¼Œä½¿ç”¨<code>JdbcTemplate</code>ï¼Œå¦‚æœæœ‰äº‹åŠ¡ï¼Œè‡ªåŠ¨åŠ å…¥å½“å‰äº‹åŠ¡ï¼Œå¦åˆ™ï¼ŒæŒ‰æ™®é€šSQLæ‰§è¡Œï¼ˆæ•°æ®åº“éšå«äº‹åŠ¡ï¼‰ã€‚</p>
<p>æœ€åï¼Œè¿˜éœ€è¦æä¾›ä¸€ä¸ª<code>TransactionalBeanPostProcessor</code>ï¼Œä½¿å¾—AOPæœºåˆ¶ç”Ÿæ•ˆï¼Œæ‰èƒ½æ‹¦æˆª<code>@Transactional</code>æ ‡æ³¨çš„Beançš„publicæ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TransactionalBeanPostProcessor <span style="color:#fff;font-weight:bold">extends</span> AnnotationProxyBeanPostProcessor&lt;Transactional&gt; {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŠŠå®ƒä»¬éƒ½æ•´ç†ä¸€ä¸‹ï¼Œæ”¾åˆ°<code>JdbcConfiguration</code>ä¸­ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JdbcConfiguration {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(destroyMethod = <span style="color:#0ff;font-weight:bold">&#34;close&#34;</span>)
</span></span><span style="display:flex;"><span>    DataSource dataSource(
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// properties:</span>
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.url}&#34;</span>) String url,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.username}&#34;</span>) String username,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.password}&#34;</span>) String password,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.driver-class-name:}&#34;</span>) String driver,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.maximum-pool-size:20}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> maximumPoolSize,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.minimum-pool-size:1}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> minimumPoolSize,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.connection-timeout:30000}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> connTimeout
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> HikariDataSource(config);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate(@Autowired DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> JdbcTemplate(dataSource);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    TransactionalBeanPostProcessor transactionalBeanPostProcessor() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> TransactionalBeanPostProcessor();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    PlatformTransactionManager platformTransactionManager(@Autowired DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> DataSourceTransactionManager(dataSource);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨ï¼Œåº”ç”¨ç¨‹åºåªéœ€å¯¼å…¥<code>JdbcConfiguration</code>ï¼Œä»è¿æ¥æ± åˆ°å£°æ˜å¼äº‹åŠ¡å…¨éƒ¨é½æ´»ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Import(JdbcConfiguration.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ€åæˆ‘ä»¬æ€»ç»“ä¸‹å„ä¸ªç»„ä»¶çš„ä½œç”¨ï¼š</p>
<ol>
<li>ç”±<code>JdbcConfiguration</code>åˆ›å»ºçš„<code>DataSource</code>ï¼Œå®ç°äº†è¿æ¥æ± ï¼›</li>
<li>ç”±<code>JdbcConfiguration</code>åˆ›å»ºçš„<code>JdbcTemplate</code>ï¼Œå®ç°åŸºæœ¬SQLæ“ä½œï¼›</li>
<li>ç”±<code>JdbcConfiguration</code>åˆ›å»ºçš„<code>PlatformTransactionManager</code>ï¼Œè´Ÿè´£æ‹¦æˆª<code>@Transactional</code>æ ‡è¯†çš„Beançš„publicæ–¹æ³•ï¼Œè‡ªåŠ¨ç®¡ç†äº‹åŠ¡ï¼›</li>
<li>ç”±<code>JdbcConfiguration</code>åˆ›å»ºçš„<code>TransactionalBeanPostProcessor</code>ï¼Œè´Ÿè´£ç»™<code>@Transactional</code>æ ‡è¯†çš„Beanåˆ›å»ºAOPä»£ç†ï¼Œæ‹¦æˆªå™¨æ­£æ˜¯<code>PlatformTransactionManager</code>ã€‚</li>
</ol>
<p>åº”ç”¨ç¨‹åºé™¤äº†å¯¼å…¥ä¸€ä¸ª<code>JdbcConfiguration</code>ï¼ŒåŠ ä¸Šé»˜è®¤é…ç½®é¡¹ï¼Œä»€ä¹ˆä¹Ÿä¸ç”¨å¹²ï¼Œå°±å¯ä»¥å¼€å§‹å†™è‡ªåŠ¨å¸¦å£°æ˜å¼äº‹åŠ¡çš„ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Transactional
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> User register(String email, String password) {
</span></span><span style="display:flex;"><span>        jdbcTemplate.<span style="color:#007f7f">update</span>(<span style="color:#0ff;font-weight:bold">&#34;INSERT INTO ...&#34;</span>, ...);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="å®ç°web-mvc">å®ç°Web MVC<a hidden class="anchor" aria-hidden="true" href="#å®ç°web-mvc">#</a></h1>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†IoCå®¹å™¨ã€AOPã€JdbcTemplateå’Œå£°æ˜å¼äº‹åŠ¡ï¼Œç¦»ä¸€ä¸ªå®Œæ•´çš„æ¡†æ¶åªå·®ä¸€ä¸ªWeb MVCäº†ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹çœ‹Springçš„Web MVCä¸»è¦æä¾›äº†å“ªäº›ç»„ä»¶å’ŒAPIæ”¯æŒï¼š</p>
<ol>
<li>ä¸€ä¸ª<code>DispatcherServlet</code>ä½œä¸ºæ ¸å¿ƒå¤„ç†ç»„ä»¶ï¼Œæ¥æ”¶æ‰€æœ‰URLè¯·æ±‚ï¼Œç„¶åæŒ‰MVCè§„åˆ™è½¬å‘ï¼›</li>
<li>åŸºäº<code>@Controller</code>æ³¨è§£çš„URLæ§åˆ¶å™¨ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›ï¼ŒSpringè´Ÿè´£è§£æè§„åˆ™ï¼›</li>
<li>æä¾›<code>ViewResolver</code>ï¼Œå°†åº”ç”¨ç¨‹åºçš„Controllerå¤„ç†åçš„ç»“æœè¿›è¡Œæ¸²æŸ“ï¼Œç»™æµè§ˆå™¨è¿”å›é¡µé¢ï¼›</li>
<li>åŸºäº<code>@RestController</code>æ³¨è§£çš„RESTå¤„ç†æœºåˆ¶ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›ï¼ŒSpringè´Ÿè´£å°†è¾“å…¥è¾“å‡ºå˜ä¸ºJSONæ ¼å¼ï¼›</li>
<li>å¤šç§æ‹¦æˆªå™¨å’Œå¼‚å¸¸å¤„ç†å™¨ç­‰ã€‚</li>
</ol>
<p>Springçš„Web MVCåŠŸèƒ½ååˆ†å¼ºå¤§ï¼Œæ¶‰åŠåˆ°çš„å†…å®¹ä¹Ÿéå¸¸å¹¿ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒSummer Frameworkçš„Web MVCå¿…ç„¶è¦èšç„¦åœ¨æ ¸å¿ƒç»„ä»¶ä¸Šï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">Spring Framework</th>
<th style="text-align:left">Summer Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">DispatcherServlet</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">@Controlleræ³¨è§£</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">@RestControlleræ³¨è§£</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">ViewResolver</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">HandlerInterceptor</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">Exception Handler</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">CORS</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">å¼‚æ­¥å¤„ç†</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
<tr>
<td style="text-align:left">WebSocket</td>
<td style="text-align:left">æ”¯æŒ</td>
<td style="text-align:left">ä¸æ”¯æŒ</td>
</tr>
</tbody>
</table>
<p>ä¸è¿‡ï¼ŒSpring Frameworkçš„Web MVCæ¨¡å—å¯¹<code>Filter</code>æ”¯æŒæœ‰é™ï¼Œè¦æƒ³æ„‰å¿«åœ°ä½¿ç”¨<code>Filter</code>ï¼Œæœ€å¥½é€šè¿‡Spring Bootæä¾›çš„<code>FilterRegistrationBean</code>ï¼ŒSummer Frameworkä¸ºäº†ä¾¿äºåº”ç”¨ç¨‹åºå¼€å‘è‡ªå·±çš„<code>Filter</code>ï¼Œç›´æ¥æ”¯æŒ<code>FilterRegistrationBean</code>ã€‚</p>
<p>ä¸‹é¢å¼€å§‹æ­£å¼å¼€å‘Summer Frameworkçš„Web MVCæ¨¡å—ã€‚</p>
<h2 id="å¯åŠ¨iocå®¹å™¨">å¯åŠ¨IoCå®¹å™¨<a hidden class="anchor" aria-hidden="true" href="#å¯åŠ¨iocå®¹å™¨">#</a></h2>
<p>åœ¨å¼€å‘Web MVCæ¨¡å—ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆå›é¡¾ä¸‹Java Webåº”ç”¨ç¨‹åºåˆ°åº•æœ‰å‡ æ–¹å‚ä¸ã€‚</p>
<p>é¦–å…ˆï¼ŒJava Webåº”ç”¨ä¸€èˆ¬éµå¾ªServletæ ‡å‡†ï¼Œè¿™ä¸ªæ ‡å‡†å®šä¹‰äº†åº”ç”¨ç¨‹åºå¯ä»¥æŒ‰æ¥å£ç¼–å†™å“ªäº›ç»„ä»¶ï¼šServletã€Filterå’ŒListenerï¼Œä¹Ÿè§„å®šäº†ä¸€ä¸ªæœåŠ¡å™¨ï¼ˆå¦‚Tomcatã€Jettyã€JBossç­‰ï¼‰åº”è¯¥æä¾›ä»€ä¹ˆæ ·çš„æœåŠ¡ï¼ŒæŒ‰ä»€ä¹ˆé¡ºåºåŠ è½½åº”ç”¨ç¨‹åºçš„ç»„ä»¶ï¼Œæœ€åæ‰èƒ½è·‘èµ·æ¥å¤„ç†æ¥è‡ªç”¨æˆ·çš„HTTPè¯·æ±‚ã€‚</p>
<p>Servletè§„èŒƒå®šä¹‰çš„ç»„ä»¶æœ‰3ç±»ï¼š</p>
<ol>
<li>Servletï¼šå¤„ç†HTTPè¯·æ±‚ï¼Œç„¶åè¾“å‡ºå“åº”ï¼›</li>
<li>Filterï¼šå¯¹HTTPè¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œå¯ä»¥æœ‰å¤šä¸ªFilterå½¢æˆè¿‡æ»¤å™¨é“¾ï¼Œå®ç°æƒé™æ£€æŸ¥ã€é™æµã€ç¼“å­˜ç­‰é€»è¾‘ï¼›</li>
<li>Listenerï¼šç”¨æ¥ç›‘å¬Webåº”ç”¨ç¨‹åºäº§ç”Ÿçš„äº‹ä»¶ï¼ŒåŒ…æ‹¬å¯åŠ¨ã€åœæ­¢ã€Sessionæœ‰ä¿®æ”¹ç­‰ã€‚</li>
</ol>
<p>è¿™äº›ç»„ä»¶å‡ç”±åº”ç”¨ç¨‹åºå®ç°ã€‚</p>
<p>è€ŒæœåŠ¡å™¨ä¸ºä¸€ä¸ªåº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªâ€œå®¹å™¨â€ï¼Œå³Servlet Containerï¼Œä¸€ä¸ªServerå¯ä»¥åŒæ—¶è·‘å¤šä¸ªContainerï¼Œä¸åŒçš„Containerå¯ä»¥æŒ‰URLã€åŸŸåç­‰åŒºåˆ†ï¼ŒContaineræ‰æ˜¯ç”¨æ¥ç®¡ç†Servletã€Filterã€Listenerè¿™äº›ç»„ä»¶çš„ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>â”‚Web Server                           â”‚
</span></span><span style="display:flex;"><span>â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚Servlet Container                  â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚â”‚Servlet â”‚â”‚Servlet â”‚â”‚Servlet â”‚ ... â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚â”‚Filter  â”‚â”‚Filter  â”‚â”‚Filter  â”‚ ... â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚â”‚Listenerâ”‚â”‚Listenerâ”‚â”‚Listenerâ”‚ ... â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
</span></span><span style="display:flex;"><span>â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚Servlet Container                  â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â”‚                                   â”‚â”‚
</span></span><span style="display:flex;"><span>â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
</span></span><span style="display:flex;"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦ä¸€ä¸ªéœ€è¦ç‰¹åˆ«é‡è¦çš„é—®é¢˜æ˜¯ï¼šç»„ä»¶ç”±è°åˆ›å»ºï¼Œç”±è°é”€æ¯ã€‚</p>
<p>åœ¨ä½¿ç”¨IoCå®¹å™¨æ—¶ï¼Œæ³¨æ„åˆ°IoCå®¹å™¨ä¹Ÿæ˜¯ä¸€ä¸ªJavaç±»ï¼ŒIoCå®¹å™¨åˆç®¡ç†ç€å¾ˆå¤šBeanï¼Œå› æ­¤ï¼Œåˆ›å»ºé¡ºåºæ˜¯ï¼š</p>
<ol>
<li>æ‰§è¡Œåº”ç”¨ç¨‹åºçš„å…¥å£æ–¹æ³•<code>main()</code>ï¼›</li>
<li>åœ¨<code>main()</code>æ–¹æ³•ä¸­ï¼Œåˆ›å»ºIoCå®¹å™¨çš„å®ä¾‹ï¼›</li>
<li>IoCå®¹å™¨åœ¨å®ƒçš„å†…éƒ¨åˆ›å»ºå„ä¸ªBeançš„å®ä¾‹ã€‚</li>
</ol>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¼€å‘çš„æ˜¯Webåº”ç”¨ç¨‹åºï¼Œå®ƒæœ¬èº«å°±æ˜¯ä¸€å †ç»„ä»¶ï¼Œè¢«WebæœåŠ¡å™¨æä¾›çš„Servletâ€œå®¹å™¨â€ç®¡ç†ï¼ŒåŒæ—¶ï¼Œåˆè¦åŠ ä¸€ä¸ªIoCå®¹å™¨ï¼Œåˆ°åº•è°åˆ›å»ºè°ï¼Œè°ç®¡ç†è°ï¼Œè¿™ä¸ªé—®é¢˜ï¼Œå¿…é¡»è¦ææ¸…æ¥šã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä¸èƒ½æ”¹å˜Servletè§„èŒƒï¼Œæ‰€ä»¥ï¼ŒServletã€Filterã€Listenerï¼Œä»¥åŠIoCå®¹å™¨ï¼Œéƒ½å¿…é¡»åœ¨Servletå®¹å™¨å†…è¢«ç®¡ç†ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>         â”‚Servlet Container                           â”‚
</span></span><span style="display:flex;"><span>         â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
</span></span><span style="display:flex;"><span>         â”‚                        â”‚IoC Container     â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
</span></span><span style="display:flex;"><span>Request â”€â”¼â”€â–¶â”‚Filterâ”‚â”€â”€â–¶â”‚Servletâ”‚â”€â”€â”¼â”€â–¶â”‚Controller  â”‚  â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚  â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚                        â”‚         â”‚        â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚         â–¼        â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚  â”‚Listenerâ”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚UserService â”‚  â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚                        â”‚         â”‚        â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚                        â”‚         â–¼        â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚                        â”‚  â”‚JdbcTemplateâ”‚  â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
</span></span><span style="display:flex;"><span>         â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
</span></span><span style="display:flex;"><span>         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥æˆ‘ä»¬è¦æ‹æ¸…æ¥šè¿™äº›ç»„ä»¶çš„åˆ›å»ºé¡ºåºï¼Œä»¥åŠè°åˆ›å»ºè°ã€‚</p>
<p>å¯¹äºä¸€ä¸ªWebåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œå¯åŠ¨æ—¶ï¼Œåº”ç”¨ç¨‹åºæœ¬èº«åªæ˜¯ä¸€ä¸ª<code>war</code>åŒ…ï¼Œå¹¶æ²¡æœ‰<code>main()</code>æ–¹æ³•ï¼Œå› æ­¤ï¼Œå¯åŠ¨æ—¶æ‰§è¡Œçš„æ˜¯Serverçš„<code>main()</code>æ–¹æ³•ã€‚ä»¥TomcatæœåŠ¡å™¨ä¸ºä¾‹ï¼š</p>
<ol>
<li>å¯åŠ¨æœåŠ¡å™¨ï¼Œå³æ‰§è¡ŒTomcatçš„<code>main()</code>æ–¹æ³•ï¼›</li>
<li>Tomcatæ ¹æ®é…ç½®æˆ–è‡ªåŠ¨æ£€æµ‹åˆ°ä¸€ä¸ª<code>xyz.war</code>åŒ…åï¼Œä¸ºè¿™ä¸ª<code>xyz.war</code>åº”ç”¨ç¨‹åºåˆ›å»ºServletå®¹å™¨ï¼›</li>
<li>Tomcatç»§ç»­æŸ¥æ‰¾<code>xyz.war</code>å®šä¹‰çš„Servletã€Filterå’ŒListenerç»„ä»¶ï¼ŒæŒ‰é¡ºåºå®ä¾‹åŒ–æ¯ä¸ªç»„ä»¶ï¼ˆListeneræœ€å…ˆè¢«å®ä¾‹åŒ–ï¼Œç„¶åæ˜¯Filterï¼Œæœ€åæ˜¯Servletï¼‰ï¼›</li>
<li>ç”¨æˆ·å‘é€HTTPè¯·æ±‚ï¼ŒTomcatæ”¶åˆ°è¯·æ±‚åï¼Œè½¬å‘ç»™Servletå®¹å™¨ï¼Œå®¹å™¨æ ¹æ®åº”ç”¨ç¨‹åºå®šä¹‰çš„æ˜ å°„ï¼ŒæŠŠè¯·æ±‚å‘é€ä¸ªè‹¥å¹²Filterå’Œä¸€ä¸ªServletå¤„ç†ï¼›</li>
<li>å¤„ç†æœŸé—´äº§ç”Ÿçš„äº‹ä»¶åˆ™ç”±Servletå®¹å™¨è‡ªåŠ¨è°ƒç”¨Listenerã€‚</li>
</ol>
<p>å…¶ä¸­ï¼Œç¬¬3æ­¥å®ä¾‹åŒ–åˆæœ‰å¾ˆå¤šæ–¹å¼ï¼š</p>
<ol>
<li>é€šè¿‡åœ¨<code>web.xml</code>é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ï¼Œè¿™ä¹Ÿæ˜¯æ—©æœŸServletè§„èŒƒå”¯ä¸€çš„é…ç½®æ–¹å¼ï¼›</li>
<li>é€šè¿‡æ³¨è§£<code>@WebServlet</code>ã€<code>@WebFilter</code>å’Œ<code>@WebListener</code>å®šä¹‰ï¼Œç”±Servletå®¹å™¨è‡ªåŠ¨æ‰«ææ‰€æœ‰classååˆ›å»ºç»„ä»¶ï¼Œè¿™å’Œæˆ‘ä»¬ç”¨Annotationé…ç½®Beanï¼Œç”±IoCå®¹å™¨è‡ªåŠ¨æ‰«æåˆ›å»ºBeanéå¸¸ç±»ä¼¼ï¼›</li>
<li>å…ˆé…ç½®ä¸€ä¸ª<code>Listener</code>ï¼Œç”±Servletå®¹å™¨åˆ›å»º<code>Listener</code>ï¼Œç„¶åï¼Œ<code>Listener</code>è‡ªå·±è°ƒç”¨ç›¸å…³æ¥å£ï¼Œæ‰‹åŠ¨åˆ›å»º<code>Servlet</code>å’Œ<code>Filter</code>ã€‚</li>
</ol>
<p>åˆ°åº•ç”¨å“ªç§æ–¹å¼ï¼Œå–å†³äºWebåº”ç”¨ç¨‹åºè‡ªå·±å¦‚ä½•ç¼–å†™ã€‚å¯¹äºä½¿ç”¨Springæ¡†æ¶çš„Webåº”ç”¨ç¨‹åºæ¥è¯´ï¼ŒServletã€Filterå’ŒListeneræ•°é‡å°‘ï¼Œè€Œä¸”æ˜¯å›ºå®šçš„ï¼Œåº”ç”¨ç¨‹åºè‡ªèº«ç¼–å†™çš„Controlleræ•°é‡ä¸å®šï¼Œä½†ç”±IoCå®¹å™¨ç®¡ç†ï¼Œå› æ­¤ï¼Œé‡‡ç”¨æ–¹å¼3æœ€åˆé€‚ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼ŒTomcatå¯åŠ¨ä¸€ä¸ªåŸºäºSpringå¼€å‘çš„Webåº”ç”¨ç¨‹åºæ—¶ï¼ŒæŒ‰å¦‚ä¸‹æ­¥éª¤åˆå§‹åŒ–ï¼š</p>
<ol>
<li>ä¸ºWebåº”ç”¨ç¨‹åºå‡†å¤‡Servletå®¹å™¨ï¼›</li>
<li>æ ¹æ®é…ç½®å®ä¾‹åŒ–ä¸€ä¸ªSpringæä¾›çš„<code>Listener</code>ï¼›
<ol>
<li>Springæä¾›çš„<code>Listener</code>åœ¨åˆå§‹åŒ–æ—¶å¯åŠ¨IoCå®¹å™¨ï¼›</li>
<li>Springæä¾›çš„<code>Listener</code>åœ¨åˆå§‹åŒ–æ—¶å‘Servletå®¹å™¨æ³¨å†ŒSpringå†…ç½®çš„ä¸€ä¸ª<code>DispatcherServlet</code>ã€‚</li>
</ol>
</li>
</ol>
<p>å½“TomcatæŠŠHTTPè¯·æ±‚å‘é€ç»™Springæ³¨å†Œçš„<code>Servlet</code>åï¼Œå› ä¸ºå®ƒæŒæœ‰IoCå®¹å™¨çš„å¼•ç”¨ï¼Œå°±å¯ä»¥æ‰¾åˆ°<code>Controller</code>å®ä¾‹ï¼Œå› æ­¤ï¼Œå¯ä»¥æŠŠè¯·æ±‚ç»§ç»­è½¬å‘ç»™å¯¹åº”çš„Controllerï¼Œè¿™æ ·å°±å®Œæˆäº†HTTPè¯·æ±‚çš„å¤„ç†ã€‚</p>
<p>å¦å¤–æ³¨æ„åˆ°Webåº”ç”¨ç¨‹åºé™¤äº†æä¾›<code>Controller</code>å¤–ï¼Œå¹¶ä¸å¿…é¡»ä¸Servlet APIæ‰“äº¤é“ï¼Œå› ä¸ºè¢«Springæä¾›çš„<code>DispatcherServlet</code>ç»™éš”ç¦»äº†ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨å¼€å‘Summer Frameworkçš„Web MVCæ¨¡å—æ—¶ï¼Œåº”è¯¥ä»¥å¦‚ä¸‹æ–¹å¼åˆå§‹åŒ–ï¼š</p>
<ol>
<li>åº”ç”¨ç¨‹åºå¿…é¡»é…ç½®ä¸€ä¸ªSummer Frameworkæä¾›çš„Listenerï¼›</li>
<li>Tomcatå®ŒæˆServletå®¹å™¨çš„åˆ›å»ºåï¼Œç«‹åˆ»æ ¹æ®é…ç½®åˆ›å»ºListenerï¼›
<ol>
<li>Listeneråˆå§‹åŒ–æ—¶åˆ›å»ºIoCå®¹å™¨ï¼›</li>
<li>Listenerç»§ç»­åˆ›å»ºDispatcherServletå®ä¾‹ï¼Œå¹¶å‘Servletå®¹å™¨æ³¨å†Œï¼›</li>
<li>DispatcherServletåˆå§‹åŒ–æ—¶è·å–åˆ°IoCå®¹å™¨ä¸­çš„Controllerå®ä¾‹ï¼Œå› æ­¤å¯ä»¥æ ¹æ®URLè°ƒç”¨ä¸åŒControllerå®ä¾‹çš„ä¸åŒå¤„ç†æ–¹æ³•ã€‚</li>
</ol>
</li>
</ol>
<p>æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªåªèƒ½è¾“å‡ºHello Worldçš„Servletï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DispatcherServlet <span style="color:#fff;font-weight:bold">extends</span> HttpServlet {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doGet(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        PrintWriter pw = resp.<span style="color:#007f7f">getWriter</span>();
</span></span><span style="display:flex;"><span>        pw.<span style="color:#007f7f">write</span>(<span style="color:#0ff;font-weight:bold">&#34;&lt;h1&gt;Hello, world!&lt;/h1&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>        pw.<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç´§æ¥ç€ï¼Œç¼–å†™ä¸€ä¸ª<code>ContextLoaderListener</code>ï¼Œå®ƒå®ç°äº†<code>ServletContextListener</code>æ¥å£ï¼Œèƒ½ç›‘å¬Servletå®¹å™¨çš„å¯åŠ¨å’Œé”€æ¯ï¼Œåœ¨ç›‘å¬åˆ°åˆå§‹åŒ–äº‹ä»¶æ—¶ï¼Œå®Œæˆåˆ›å»ºIoCå®¹å™¨å’Œæ³¨å†Œ<code>DispatcherServlet</code>ä¸¤ä¸ªå·¥ä½œï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ContextLoaderListener <span style="color:#fff;font-weight:bold">implements</span> ServletContextListener {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Servletå®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨è°ƒç”¨:</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> contextInitialized(ServletContextEvent sce) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åˆ›å»ºIoCå®¹å™¨:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> applicationContext = createApplicationContext(...);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å®ä¾‹åŒ–DispatcherServlet:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> dispatcherServlet = <span style="color:#fff;font-weight:bold">new</span> DispatcherServlet();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ³¨å†ŒDispatcherServlet:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> dispatcherReg = servletContext.<span style="color:#007f7f">addServlet</span>(<span style="color:#0ff;font-weight:bold">&#34;dispatcherServlet&#34;</span>, dispatcherServlet);
</span></span><span style="display:flex;"><span>        dispatcherReg.<span style="color:#007f7f">addMapping</span>(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>);
</span></span><span style="display:flex;"><span>        dispatcherReg.<span style="color:#007f7f">setLoadOnStartup</span>(0);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†Webåº”ç”¨ç¨‹åºçš„åˆå§‹åŒ–å…¨éƒ¨æµç¨‹ï¼</p>
<p>æœ€åä¸¤ä¸ªå°é—®é¢˜ï¼š</p>
<ol>
<li>åˆ›å»ºIoCå®¹å™¨æ—¶ï¼Œéœ€è¦çš„é…ç½®æ–‡ä»¶ä»å“ªè¯»ï¼Ÿè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨Spring Bootçš„æ–¹å¼ï¼Œé»˜è®¤ä»classpathçš„<code>application.yml</code>æˆ–<code>application.properties</code>è¯»ã€‚</li>
<li>éœ€è¦çš„<code>@Configuration</code>é…ç½®ç±»ä»å“ªè·å–ï¼Ÿè¿™æ˜¯é€šè¿‡<code>web.xml</code>æ–‡ä»¶é…ç½®çš„ï¼š</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;web-app</span> <span style="color:#f00">...</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;context-param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">&lt;!-- å›ºå®šåç§° --&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;param-name&gt;</span>configuration<span style="font-weight:bold">&lt;/param-name&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">&lt;!-- é…ç½®ç±»çš„å®Œæ•´ç±»å --&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;param-value&gt;</span>com.itranswarp.summer.webapp.WebAppConfig<span style="font-weight:bold">&lt;/param-value&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/context-param&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;listener&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;listener-class&gt;</span>com.itranswarp.summer.web.ContextLoaderListener<span style="font-weight:bold">&lt;/listener-class&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/listener&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/web-app&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨<code>ContextLoaderListener</code>çš„<code>contextInitialized()</code>æ–¹æ³•å†…ï¼Œå…ˆè·å–<code>ServletContext</code>å¼•ç”¨ï¼Œå†é€šè¿‡<code>getInitParameter(&quot;configuration&quot;)</code>æ‹¿åˆ°å®Œæ•´ç±»åï¼Œå°±å¯ä»¥é¡ºåˆ©åˆ›å»ºIoCå®¹å™¨äº†ã€‚</p>
<p>ç”¨Mavenæ‰“åŒ…åï¼ŒæŠŠç”Ÿæˆçš„<code>xyz.war</code>æ”¹ä¸º<code>ROOT.war</code>ï¼Œå¤åˆ¶åˆ°Tomcatçš„<code>webapps</code>ç›®å½•ä¸‹ï¼Œæ¸…é™¤æ‰å…¶ä»–webappï¼Œå¯åŠ¨Tomcatï¼Œè¾“å…¥<code>http://localhost:8080</code>å¯çœ‹åˆ°è¾“å‡º<code>Hello, world!</code>ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å°±è·‘é€šäº†ä¸€ä¸ªWebåº”ç”¨ç¨‹åºå¯åŠ¨çš„å…¨éƒ¨æµç¨‹ã€‚</p>
<h2 id="å®ç°mvc">å®ç°MVC<a hidden class="anchor" aria-hidden="true" href="#å®ç°mvc">#</a></h2>
<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬æŠŠWebåº”ç”¨ç¨‹åºçš„æµç¨‹è·‘é€šäº†ï¼Œå› æ­¤ï¼Œæœ¬èŠ‚é‡ç‚¹å°±åœ¨å¦‚ä½•ç»§ç»­å¼€å‘<code>DispatcherServlet</code>ï¼Œå› ä¸ºæ•´ä¸ªMVCçš„å¤„ç†éƒ½æ˜¯åœ¨<code>DispatcherServlet</code>å†…éƒ¨å®Œæˆçš„ã€‚</p>
<p>è¦å¤„ç†MVCï¼Œæˆ‘ä»¬å…ˆå®šä¹‰<code>@Controller</code>å’Œ<code>@RestController</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Target(ElementType.<span style="color:#007f7f">TYPE</span>)
</span></span><span style="display:flex;"><span>@Retention(RetentionPolicy.<span style="color:#007f7f">RUNTIME</span>)
</span></span><span style="display:flex;"><span>@Documented
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> @interface Controller {
</span></span><span style="display:flex;"><span>    String value() <span style="color:#fff;font-weight:bold">default</span> <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Target(ElementType.<span style="color:#007f7f">TYPE</span>)
</span></span><span style="display:flex;"><span>@Retention(RetentionPolicy.<span style="color:#007f7f">RUNTIME</span>)
</span></span><span style="display:flex;"><span>@Documented
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> @interface RestController {
</span></span><span style="display:flex;"><span>    String value() <span style="color:#fff;font-weight:bold">default</span> <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥åŠ<code>@GetMapping</code>ã€<code>@PostMapping</code>ç­‰æ³¨è§£ï¼Œæ¥æ ‡è¯†MVCå¤„ç†çš„æ–¹æ³•ã€‚</p>
<p><code>DispatcherServlet</code>å†…éƒ¨è´Ÿè´£ä»IoCå®¹å™¨æ‰¾å‡ºæ‰€æœ‰<code>@Controller</code>å’Œ<code>@RestController</code>å®šä¹‰çš„Beanï¼Œæ‰«æå®ƒä»¬çš„æ–¹æ³•ï¼Œæ‰¾å‡º<code>@GetMapping</code>å’Œ<code>@PostMapping</code>æ ‡è¯†çš„æ–¹æ³•ï¼Œè¿™æ ·å°±æœ‰äº†ä¸€ä¸ªå¤„ç†ç‰¹å®šURLçš„å¤„ç†å™¨ï¼Œæˆ‘ä»¬æŠ½è±¡ä¸º<code>Dispatcher</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Dispatcher {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ˜¯å¦è¿”å›REST:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> isRest;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ˜¯å¦æœ‰@ResponseBody:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> isResponseBody;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ˜¯å¦è¿”å›void:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> isVoid;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// URLæ­£åˆ™åŒ¹é…:</span>
</span></span><span style="display:flex;"><span>    Pattern urlPattern;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Beanå®ä¾‹:</span>
</span></span><span style="display:flex;"><span>    Object controller;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å¤„ç†æ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>    Method handlerMethod;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ–¹æ³•å‚æ•°:</span>
</span></span><span style="display:flex;"><span>    Param[] methodParameters;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ–¹æ³•å‚æ•°ä¹Ÿéœ€è¦æ ¹æ®<code>@RequestParam</code>ã€<code>@RequestBody</code>ç­‰æŠ½è±¡å‡º<code>Param</code>ç±»å‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Param {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å‚æ•°åç§°:</span>
</span></span><span style="display:flex;"><span>    String name;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å‚æ•°ç±»å‹:</span>
</span></span><span style="display:flex;"><span>    ParamType paramType;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å‚æ•°Classç±»å‹:</span>
</span></span><span style="display:flex;"><span>    Class&lt;?&gt; classType;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å‚æ•°é»˜è®¤å€¼</span>
</span></span><span style="display:flex;"><span>    String defaultValue;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸€å…±æœ‰4ç§ç±»å‹çš„å‚æ•°ï¼Œæˆ‘ä»¬ç”¨æšä¸¾<code>ParamType</code>å®šä¹‰ï¼š</p>
<ul>
<li><code>PATH_VARIABLE</code>ï¼šè·¯å¾„å‚æ•°ï¼Œä»URLä¸­æå–ï¼›</li>
<li><code>REQUEST_PARAM</code>ï¼šURLå‚æ•°ï¼Œä»URL Queryæˆ–Formè¡¨å•æå–ï¼›</li>
<li><code>REQUEST_BODY</code>ï¼šRESTè¯·æ±‚å‚æ•°ï¼Œä»Postä¼ é€’çš„JSONæå–ï¼›</li>
<li><code>SERVLET_VARIABLE</code>ï¼š<code>HttpServletRequest</code>ç­‰Servlet APIæä¾›çš„å‚æ•°ï¼Œç›´æ¥ä»<code>DispatcherServlet</code>çš„æ–¹æ³•å‚æ•°è·å¾—ã€‚</li>
</ul>
<p>è¿™æ ·ï¼Œ<code>DispatcherServlet</code>é€šè¿‡åå°„æ‹¿åˆ°ä¸€ç»„<code>Dispatcher</code>å¯¹è±¡ï¼Œåœ¨<code>doGet()</code>å’Œ<code>doPost()</code>æ–¹æ³•ä¸­ï¼Œä¾æ¬¡åŒ¹é…URLï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DispatcherServlet <span style="color:#fff;font-weight:bold">extends</span> HttpServlet {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    List&lt;Dispatcher&gt; getDispatchers = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>    List&lt;Dispatcher&gt; postDispatchers = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doGet(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        String url = req.<span style="color:#007f7f">getRequestURI</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ä¾æ¬¡åŒ¹é…æ¯ä¸ªDispatcherçš„URL:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (Dispatcher dispatcher : getDispatchers) {
</span></span><span style="display:flex;"><span>            Result result = dispatcher.<span style="color:#007f7f">process</span>(url, req, resp);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// åŒ¹é…æˆåŠŸå¹¶å¤„ç†å:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (result.<span style="color:#007f7f">processed</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// å¤„ç†ç»“æœ</span>
</span></span><span style="display:flex;"><span>                ...
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æœªåŒ¹é…åˆ°ä»»ä½•Dispatcher:</span>
</span></span><span style="display:flex;"><span>        resp.<span style="color:#007f7f">sendError</span>(404, <span style="color:#0ff;font-weight:bold">&#34;Not Found&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doPost(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œä¸èƒ½ç”¨<code>Map&lt;String, Dispatcher&gt;</code>çš„åŸå› åœ¨äºæˆ‘ä»¬è¦å¤„ç†ç±»ä¼¼<code>/hello/{name}</code>è¿™æ ·çš„URLï¼Œæ²¡æ³•ä½¿ç”¨ç²¾ç¡®æŸ¥æ‰¾ï¼Œåªèƒ½ä½¿ç”¨æ­£åˆ™åŒ¹é…ã€‚</p>
<p><code>Dispatcher</code>å¤„ç†åè¿”å›ç±»å‹åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>void</code>æˆ–<code>null</code>ï¼šè¡¨ç¤ºå†…éƒ¨å·²å¤„ç†å®Œæ¯•ï¼›</li>
<li><code>String</code>ï¼šå¦‚æœä»¥<code>redirect:</code>å¼€å¤´ï¼Œåˆ™è¡¨ç¤ºä¸€ä¸ªé‡å®šå‘ï¼›</li>
<li><code>String</code>æˆ–<code>byte[]</code>ï¼šå¦‚æœé…åˆ<code>@ResponseBody</code>ï¼Œåˆ™è¡¨ç¤ºè¿”å›å€¼ç›´æ¥å†™å…¥å“åº”ï¼›</li>
<li><code>ModelAndView</code>ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªMVCå“åº”ï¼ŒåŒ…å«Modelå’ŒViewåç§°ï¼Œåç»­ç”¨æ¨¡æ¿å¼•æ“å¤„ç†åå†™å…¥å“åº”ï¼›</li>
<li>å…¶å®ƒç±»å‹ï¼šå¦‚æœæ˜¯<code>@RestController</code>ï¼Œåˆ™åºåˆ—åŒ–ä¸ºJSONåå†™å…¥å“åº”ã€‚</li>
</ul>
<p>ä¸ç¬¦åˆä¸Šè¿°è¦æ±‚çš„è¿”å›ç±»å‹åˆ™æŠ¥500é”™è¯¯ã€‚</p>
<p>è¿™äº›å¤„ç†é€»è¾‘éƒ½ååˆ†ç®€å•ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹çœ‹å¦‚ä½•å¤„ç†<code>ModelAndView</code>ç±»å‹ï¼Œå³MVCå“åº”ã€‚</p>
<p>ä¸ºäº†å¤„ç†<code>ModelAndView</code>ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¨¡æ¿å¼•æ“ï¼Œå› æ­¤ï¼ŒæŠ½è±¡å‡º<code>ViewResolver</code>æ¥å£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> ViewResolver {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆå§‹åŒ–ViewResolver:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> init();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ¸²æŸ“:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> render(String viewName, Map&lt;String, Object&gt; model, HttpServletRequest req, HttpServletResponse resp);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Springå†…ç½®FreeMarkerå¼•æ“ï¼Œå› æ­¤æˆ‘ä»¬ä¹ŸæŠŠFreeMarkeré›†æˆè¿›æ¥ï¼Œå†™ä¸€ä¸ª<code>FreeMarkerViewResolver</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FreeMarkerViewResolver <span style="color:#fff;font-weight:bold">implements</span> ViewResolver {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> String templatePath;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> String templateEncoding;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> ServletContext servletContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Configuration config;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FreeMarkerViewResolver(ServletContext servletContext, String templatePath, String templateEncoding) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span> = servletContext;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">templatePath</span> = templatePath;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">templateEncoding</span> = templateEncoding;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init() {
</span></span><span style="display:flex;"><span>        Configuration cfg = <span style="color:#fff;font-weight:bold">new</span> Configuration(Configuration.<span style="color:#007f7f">VERSION_2_3_32</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setOutputFormat</span>(HTMLOutputFormat.<span style="color:#007f7f">INSTANCE</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setDefaultEncoding</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">templateEncoding</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setTemplateLoader</span>(<span style="color:#fff;font-weight:bold">new</span> ServletTemplateLoader(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">templatePath</span>));
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setTemplateExceptionHandler</span>(TemplateExceptionHandler.<span style="color:#007f7f">HTML_DEBUG_HANDLER</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setAutoEscapingPolicy</span>(Configuration.<span style="color:#007f7f">ENABLE_IF_SUPPORTED_AUTO_ESCAPING_POLICY</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setLocalizedLookup</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> ow = <span style="color:#fff;font-weight:bold">new</span> DefaultObjectWrapper(Configuration.<span style="color:#007f7f">VERSION_2_3_32</span>);
</span></span><span style="display:flex;"><span>        ow.<span style="color:#007f7f">setExposeFields</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setObjectWrapper</span>(ow);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">config</span> = cfg;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> render(String viewName, Map&lt;String, Object&gt; model, HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        Template templ = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            templ = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">config</span>.<span style="color:#007f7f">getTemplate</span>(viewName);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ServerErrorException(<span style="color:#0ff;font-weight:bold">&#34;View not found: &#34;</span> + viewName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        PrintWriter pw = resp.<span style="color:#007f7f">getWriter</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            templ.<span style="color:#007f7f">process</span>(model, pw);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (TemplateException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ServerErrorException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        pw.<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨<code>DispatcherServlet</code>å†…éƒ¨ï¼ŒæŠŠå¤„ç†ModelAndViewå’ŒViewResolverç»“åˆèµ·æ¥ï¼Œæœ€ç»ˆå‘<code>HttpServletResponse</code>ä¸­è¾“å‡ºHTMLï¼Œå®ŒæˆHTTPè¯·æ±‚çš„å¤„ç†ã€‚</p>
<p>ä¸ºäº†ç®€åŒ–Webåº”ç”¨ç¨‹åºé…ç½®ï¼Œæˆ‘ä»¬æä¾›ä¸€ä¸ª<code>WebMvcConfiguration</code>é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WebMvcConfiguration {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> ServletContext servletContext = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setServletContext(ServletContext ctx) {
</span></span><span style="display:flex;"><span>        servletContext = ctx;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(initMethod = <span style="color:#0ff;font-weight:bold">&#34;init&#34;</span>)
</span></span><span style="display:flex;"><span>    ViewResolver viewResolver( <span style="color:#007f7f">//</span>
</span></span><span style="display:flex;"><span>            @Autowired ServletContext servletContext, <span style="color:#007f7f">//</span>
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.web.freemarker.template-path:/WEB-INF/templates}&#34;</span>) String templatePath, <span style="color:#007f7f">//</span>
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.web.freemarker.template-encoding:UTF-8}&#34;</span>) String templateEncoding) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> FreeMarkerViewResolver(servletContext, templatePath, templateEncoding);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    ServletContext servletContext() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> Objects.<span style="color:#007f7f">requireNonNull</span>(servletContext, <span style="color:#0ff;font-weight:bold">&#34;ServletContext is not set.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é»˜è®¤åˆ›å»ºä¸€ä¸ª<code>ViewResolver</code>å’Œ<code>ServletContext</code>ï¼Œæ³¨æ„<code>ServletContext</code>æœ¬èº«å®é™…ä¸Šæ˜¯ç”±Servletå®¹å™¨æä¾›çš„ï¼Œä½†æˆ‘ä»¬æŠŠå®ƒæ”¾å…¥IoCå®¹å™¨ï¼Œæ˜¯å› ä¸ºè®¸å¤šæ¶‰åŠåˆ°Webçš„ç»„ä»¶ï¼Œå¦‚<code>ViewResolver</code>ï¼Œéœ€è¦æ³¨å…¥<code>ServletContext</code>ï¼Œæ‰èƒ½ä»æŒ‡å®šé…ç½®åŠ è½½æ–‡ä»¶ã€‚</p>
<p>æœ€åï¼Œæ•´ç†ä»£ç ï¼Œæ·»åŠ ä¸€äº›èƒ½æ–¹ä¾¿ç”¨æˆ·å¼€å‘çš„é¢å¤–åŠŸèƒ½ï¼Œä¾‹å¦‚å¤„ç†é™æ€æ–‡ä»¶ç­‰åŠŸèƒ½ï¼Œæˆ‘ä»¬çš„Web MVCæ¨¡å—å°±å¼€å‘å®Œæ¯•ï¼</p>
<h3 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹<a hidden class="anchor" aria-hidden="true" href="#æ³¨æ„äº‹é¡¹">#</a></h3>
<p>åœ¨æ•´ä¸ªHTTPå¤„ç†æµç¨‹ä¸­ï¼Œå…¥å£æ˜¯<code>DispatcherServlet</code>çš„<code>service()</code>æ–¹æ³•ï¼Œæ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>Servletå®¹å™¨è°ƒç”¨<code>DispatcherServlet</code>çš„<code>service()</code>æ–¹æ³•å¤„ç†HTTPè¯·æ±‚ï¼›</li>
<li><code>service()</code>æ ¹æ®GETæˆ–POSTè°ƒç”¨<code>doGet()</code>æˆ–<code>doPost()</code>æ–¹æ³•ï¼›</li>
<li>æ ¹æ®URLä¾æ¬¡åŒ¹é…<code>Dispatcher</code>ï¼ŒåŒ¹é…åè°ƒç”¨<code>process()</code>æ–¹æ³•ï¼Œè·å¾—è¿”å›å€¼ï¼›</li>
<li>æ ¹æ®è¿”å›å€¼å†™å…¥å“åº”ï¼š
<ol>
<li>voidæˆ–nullè¿”å›å€¼æ— éœ€å†™å…¥å“åº”ï¼›</li>
<li>Stringæˆ–byte[]è¿”å›å€¼ç›´æ¥å†™å…¥å“åº”ï¼ˆæˆ–é‡å®šå‘ï¼‰ï¼›</li>
<li>RESTç±»å‹å†™å…¥JSONåºåˆ—åŒ–ç»“æœï¼›</li>
<li>ModelAndViewç±»å‹è°ƒç”¨ViewResolverå†™å…¥æ¸²æŸ“ç»“æœã€‚</li>
</ol>
</li>
<li>æœªåŒ¹é…åˆ°åˆ¤æ–­æ˜¯å¦é™æ€èµ„æºï¼š
<ol>
<li>ç¬¦åˆé™æ€ç›®å½•ï¼ˆé»˜è®¤<code>/static/</code>ï¼‰åˆ™è¯»å–æ–‡ä»¶ï¼Œå†™å…¥æ–‡ä»¶å†…å®¹ï¼›</li>
<li>ç½‘ç«™å›¾æ ‡ï¼ˆé»˜è®¤<code>/favicon.ico</code>ï¼‰åˆ™è¯»å–<code>.ico</code>æ–‡ä»¶ï¼Œå†™å…¥æ–‡ä»¶å†…å®¹ï¼›</li>
</ol>
</li>
<li>å…¶ä»–æƒ…å†µè¿”å›404ã€‚</li>
</ol>
<p>ç”±äºåœ¨å¤„ç†çš„æ¯ä¸€æ­¥éƒ½å¯ä»¥å‘<code>HttpServletResponse</code>å†™å…¥å“åº”ï¼Œå› æ­¤ï¼Œåç»­æ­¥éª¤å†™å…¥æ—¶ï¼Œåº”åˆ¤æ–­å‰é¢çš„æ­¥éª¤æ˜¯å¦å·²ç»å†™å…¥å¹¶å‘é€äº†HTTP Headerã€‚<code>isCommitted()</code>æ–¹æ³•å°±æ˜¯å¹²è¿™ä¸ªç”¨çš„ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> (!resp.<span style="color:#007f7f">isCommitted</span>()) {
</span></span><span style="display:flex;"><span>    resp.<span style="color:#007f7f">resetBuffer</span>();
</span></span><span style="display:flex;"><span>    writeTo(resp);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æµ‹è¯•-1">æµ‹è¯•<a hidden class="anchor" aria-hidden="true" href="#æµ‹è¯•-1">#</a></h3>
<p><code>DispatcherServlet</code>å¤„ç†HTTPè¯·æ±‚æ—¶ï¼Œä¸€äº›ç»„ä»¶æ˜¯Servletå®¹å™¨æä¾›çš„ï¼Œå¦‚ï¼š</p>
<ul>
<li>HttpServletRequestï¼›</li>
<li>HttpServletResponseï¼›</li>
<li>HttpSessionï¼›</li>
<li>ServletContextã€‚</li>
</ul>
<p>è¦æ¨¡æ‹Ÿè¿™äº›å¯¹è±¡ç”¨<a href="https://site.mockito.org/">Mockito</a>ä¹‹ç±»çš„æ¡†æ¶ä»£ç é‡ä¹Ÿå¾ˆå¤§ï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿç”¨Springæä¾›çš„testæ¨¡å—ï¼Œå®ƒå®ç°äº†å®Œå–„çš„MockHttpServletRequestã€MockServletContextç­‰å¯¹è±¡ï¼Œä¾¿äºæµ‹è¯•ã€‚æˆ‘ä»¬å¯¼å…¥ï¼š</p>
<ul>
<li>org.springframework:spring-test:6.0.0</li>
<li>org.springframework:spring-web:6.0.0</li>
</ul>
<p>æ³¨æ„è®¾ç½®<code>&lt;scope&gt;test&lt;/scope&gt;</code>ï¼Œå³ä»…åœ¨æµ‹è¯•ä»£ç ä¸­ç”¨åˆ°äº†Springæä¾›çš„Mockå¯¹è±¡ï¼Œä¸šåŠ¡ä»£ç å¹¶ä¸ä¼šç”¨åˆ°Springçš„ä»»ä½•åŠŸèƒ½ã€‚ä¸€ä¸ªç®€å•çš„æµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> getGreeting() <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»ºMockHttpServletRequest:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">var</span> req = createMockRequest(<span style="color:#0ff;font-weight:bold">&#34;GET&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;/greeting&#34;</span>, <span style="color:#fff;font-weight:bold">null</span>, Map.<span style="color:#007f7f">of</span>(<span style="color:#0ff;font-weight:bold">&#34;name&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;Bob&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ›å»ºMockHttpServletResponse:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">var</span> resp = createMockResponse();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å¤„ç†è¯·æ±‚:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">dispatcherServlet</span>.<span style="color:#007f7f">service</span>(req, resp);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// éªŒè¯200å“åº”:</span>
</span></span><span style="display:flex;"><span>    assertEquals(200, resp.<span style="color:#007f7f">getStatus</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// éªŒè¯å“åº”å†…å®¹:</span>
</span></span><span style="display:flex;"><span>    assertEquals(<span style="color:#0ff;font-weight:bold">&#34;Hello, Bob&#34;</span>, resp.<span style="color:#007f7f">getContentAsString</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å¼€å‘webåº”ç”¨">å¼€å‘Webåº”ç”¨<a hidden class="anchor" aria-hidden="true" href="#å¼€å‘webåº”ç”¨">#</a></h2>
<p>åœ¨æˆ‘ä»¬å¼€å‘å®ŒSummer Frameworkçš„æ‰€æœ‰ç»„ä»¶åï¼Œå°±å¯ä»¥åŸºäºSummer Frameworkæ¥å¼€å‘ä¸€ä¸ªçœŸæ­£çš„Webåº”ç”¨äº†ï¼</p>
<p>æˆ‘ä»¬æ¥ä¸€æ­¥ä¸€æ­¥åˆ›å»ºä¸€ä¸ª<code>hello-webapp</code>çš„åº”ç”¨ï¼Œå®ƒåŸºäºMavené¡¹ç›®ï¼Œç¬¦åˆwebappæ ‡å‡†ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨<code>src/main/resources</code>ä¸‹å®šä¹‰é…ç½®æ–‡ä»¶<code>application.yml</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">app</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">title</span>: Hello Application
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">version</span>: <span style="color:#ff0;font-weight:bold">1.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">summer</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:sqlite:test.db
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">driver-class-name</span>: org.sqlite.JDBC
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: sa
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: 
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç´§æ¥ç€ï¼Œå®šä¹‰IoCå®¹å™¨çš„é…ç½®ç±»å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@Import({ JdbcConfiguration.<span style="color:#007f7f">class</span>, WebMvcConfiguration.<span style="color:#007f7f">class</span> })
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HelloConfiguration {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥åŠç›¸å…³çš„<code>UserService</code>ã€<code>MvcController</code>ç­‰Beanã€‚</p>
<p>æ¥ä¸‹æ¥æ˜¯åœ¨<code>src/main/webapp/WEB-INF</code>ç›®å½•ä¸‹åˆ›å»ºServletå®¹å™¨æ‰€éœ€çš„é…ç½®æ–‡ä»¶<code>web.xml</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;web-app</span> <span style="color:#f00">...</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;display-name&gt;</span>Hello Webapp<span style="font-weight:bold">&lt;/display-name&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;context-param&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;param-name&gt;</span>configuration<span style="font-weight:bold">&lt;/param-name&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;param-value&gt;</span>com.itranswarp.hello.HelloConfiguration<span style="font-weight:bold">&lt;/param-value&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/context-param&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;listener&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;listener-class&gt;</span>com.itranswarp.summer.web.ContextLoaderListener<span style="font-weight:bold">&lt;/listener-class&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/listener&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/web-app&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Servletå®¹å™¨ä¼šè‡ªåŠ¨è¯»å–<code>web.xml</code>ï¼Œæ ¹æ®é…ç½®çš„Listenerå¯åŠ¨Summer Frameworkçš„webæ¨¡å—çš„<code>ContextLoaderListener</code>ï¼Œå®ƒåˆä¼šè¯»å–<code>web.xml</code>é…ç½®çš„<code>&lt;context-param&gt;</code>è·å¾—é…ç½®ç±»çš„å…¨å<code>com.itranswarp.hello.HelloConfiguration</code>ï¼Œæœ€åç”¨è¿™ä¸ªé…ç½®ç±»å®ŒæˆIoCå®¹å™¨çš„åˆ›å»ºã€‚åˆ›å»ºåè‡ªåŠ¨æ³¨å†ŒSummer Frameworkçš„<code>DispatcherServlet</code>ï¼Œä»¥åŠWebåº”ç”¨ç¨‹åºå®šä¹‰çš„<code>FilterRegistrationBean</code>ï¼Œè¿™æ ·å°±å®Œæˆäº†æ•´ä¸ªWebåº”ç”¨ç¨‹åºçš„åˆå§‹åŒ–ã€‚</p>
<p>å…¶ä»–ç”¨åˆ°çš„èµ„æºåŒ…æ‹¬ï¼š</p>
<ul>
<li>å­˜å‚¨åœ¨<code>src/main/webapp/static</code>ç›®å½•ä¸‹çš„é™æ€èµ„æºï¼›</li>
<li>å­˜å‚¨äº<code>src/main/webapp/favicon.ico</code>çš„å›¾æ ‡æ–‡ä»¶ï¼›</li>
<li>å­˜å‚¨åœ¨<code>src/main/webapp/WEB-INF/templates</code>ç›®å½•ä¸‹çš„æ¨¡æ¿ã€‚</li>
</ul>
<p>æœ€åï¼Œè¿è¡Œ<code>mvn clean package</code>å‘½ä»¤ï¼Œåœ¨<code>target</code>ç›®å½•å¾—åˆ°æœ€ç»ˆçš„waråŒ…ï¼Œæ”¹åä¸º<code>ROOT.war</code>ï¼Œå¤åˆ¶åˆ°Tomcatçš„<code>webapps</code>ç›®å½•ä¸‹ï¼Œå¯åŠ¨Tomcatï¼Œå¯ä»¥æ­£å¸¸è®¿é—®<code>http://localhost:8080</code>ï¼š</p>
<h1 id="å®ç°boot">å®ç°Boot<a hidden class="anchor" aria-hidden="true" href="#å®ç°boot">#</a></h1>
<p>è™½ç„¶åŸºäºSummer Frameworkå¯ä»¥å¼€å‘ä¸€ä¸ªå®Œæ•´çš„Webåº”ç”¨ç¨‹åºï¼Œä½†æ˜¯ï¼Œå¼€å‘è¿‡ç¨‹è¿˜æ˜¯æ¶‰åŠåˆ°å…ˆæ‰“åŒ…ï¼Œå†å¤åˆ¶åˆ°Tomcatçš„webappsç›®å½•ï¼Œå†å¯åŠ¨Tomcatã€‚åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸éœ€è¦åå¤æ¥å¥½å¤šæ¬¡ï¼Œæ¯æ¬¡åœæ­¢ã€å¤åˆ¶ã€å¯åŠ¨ï¼Œè¦è°ƒè¯•è¿˜è¦æ¥å…¥è¿œç¨‹ï¼Œæç€æç€å°±ä¼šå‘ç°ï¼Œè¿™ç§å¼€å‘æ¨¡å¼å¤ªéº»çƒ¦ã€‚</p>
<p>ç›´æ¥ç”¨Spring Frameworkå¼€å‘Webåº”ç”¨ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæ‰€ä»¥æ‰æœ‰äº†Spring Bootï¼Œå®ƒæœ€è®©äººçœå¿ƒçš„ä¸€ç‚¹ï¼Œå°±æ˜¯ä¸ç”¨è£…Tomcatï¼Œä¸ç”¨å¤åˆ¶waråŒ…ï¼Œæ‰“ä¸ªjaråŒ…ç›´æ¥å°±èƒ½è·‘ï¼</p>
<p>æ‰€ä»¥ï¼Œä¸ºäº†ç®€åŒ–å¼€å‘æµç¨‹ï¼Œæˆ‘ä»¬ä¹Ÿä»¿ç…§Spring Bootï¼Œç¼–å†™ä¸€ä¸ª<code>boot</code>æ¨¡å—ï¼Œèƒ½ç›´æ¥å¯åŠ¨è¿è¡Œï¼</p>
<p>æ³¨æ„Spring Booté™¤äº†ç›´æ¥æ‰“åŒ…è¿è¡Œå¤–ï¼Œè¿˜æä¾›å¾ˆå¤šå…¶ä»–åŠŸèƒ½ï¼Œè€ŒSummer Frameworkçš„bootæ¨¡å—åªæä¾›æ‰“åŒ…è¿è¡ŒåŠŸèƒ½ï¼Œæ— å…¶ä»–é¢å¤–åŠŸèƒ½ã€‚</p>
<p>ä¸‹é¢å¼€å§‹æ­£å¼å¼€å‘Summer Frameworkçš„bootæ¨¡å—ã€‚</p>
<h2 id="å¯åŠ¨åµŒå…¥å¼tomcat">å¯åŠ¨åµŒå…¥å¼Tomcat<a hidden class="anchor" aria-hidden="true" href="#å¯åŠ¨åµŒå…¥å¼tomcat">#</a></h2>
<p>Spring Bootå®ç°ä¸€ä¸ªjaråŒ…ç›´æ¥è¿è¡Œçš„åŸç†å…¶å®å°±æ˜¯æŠŠTomcatæ‰“åŒ…è¿›å»ï¼Œè‡ªå·±å†å†™ä¸ª<code>main()</code>å‡½æ•°ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@SpringBootApplication
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        SpringApplication.<span style="color:#007f7f">run</span>(AppConfig.<span style="color:#007f7f">class</span>, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨<code>SpringApplication.run()</code>æ–¹æ³•å†…ï¼ŒSpring Bootä¼šå¯åŠ¨åµŒå…¥å¼Tomcatï¼Œç„¶åå†åˆå§‹åŒ–Springçš„IoCå®¹å™¨ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªjaråŒ…å†…åŒ…å«äº†åµŒå…¥å¼Tomcatã€Spring IoCå®¹å™¨ã€Web MVCæ¨¡å—ä»¥åŠåº”ç”¨ç¨‹åºè‡ªå·±å¼€å‘çš„Beanã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿæä¾›ä¸€ä¸ª<code>SummerApplication</code>ï¼Œå®ç°<code>run()</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SummerApplication {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> run(String webDir, String baseDir, Class&lt;?&gt; configClass, String... args) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è¯»å–application.ymlé…ç½®:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> propertyResolver = WebUtils.<span style="color:#007f7f">createPropertyResolver</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åˆ›å»ºTomcatæœåŠ¡å™¨:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> server = startTomcat(webDir, baseDir, configClass, propertyResolver);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç­‰å¾…æœåŠ¡å™¨ç»“æŸ:</span>
</span></span><span style="display:flex;"><span>        server.<span style="color:#007f7f">await</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œå¤šäº†ä¸¤ä¸ªå‚æ•°ï¼š<code>webDir</code>å’Œ<code>baseDir</code>ï¼Œè¿™æ˜¯ä¸ºå¯åŠ¨åµŒå…¥å¼Tomcatå‡†å¤‡çš„ï¼Œå¯åŠ¨åµŒå…¥å¼Tomcatçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Server startTomcat(String webDir, String baseDir, Class&lt;?&gt; configClass, PropertyResolver propertyResolver) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> port = propertyResolver.<span style="color:#007f7f">getProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;${server.port:8080}&#34;</span>, <span style="color:#fff;font-weight:bold">int</span>.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å®ä¾‹åŒ–Tomcat Server:</span>
</span></span><span style="display:flex;"><span>    Tomcat tomcat = <span style="color:#fff;font-weight:bold">new</span> Tomcat();
</span></span><span style="display:flex;"><span>    tomcat.<span style="color:#007f7f">setPort</span>(port);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è®¾ç½®Connector:</span>
</span></span><span style="display:flex;"><span>    tomcat.<span style="color:#007f7f">getConnector</span>().<span style="color:#007f7f">setThrowOnFailure</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ·»åŠ ä¸€ä¸ªé»˜è®¤çš„Webappï¼ŒæŒ‚è½½åœ¨&#39;/&#39;:</span>
</span></span><span style="display:flex;"><span>    Context ctx = tomcat.<span style="color:#007f7f">addWebapp</span>(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> File(webDir).<span style="color:#007f7f">getAbsolutePath</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è®¾ç½®åº”ç”¨ç¨‹åºçš„ç›®å½•:</span>
</span></span><span style="display:flex;"><span>    WebResourceRoot resources = <span style="color:#fff;font-weight:bold">new</span> StandardRoot(ctx);
</span></span><span style="display:flex;"><span>    resources.<span style="color:#007f7f">addPreResources</span>(<span style="color:#fff;font-weight:bold">new</span> DirResourceSet(resources, <span style="color:#0ff;font-weight:bold">&#34;/WEB-INF/classes&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> File(baseDir).<span style="color:#007f7f">getAbsolutePath</span>(), <span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>));
</span></span><span style="display:flex;"><span>    ctx.<span style="color:#007f7f">setResources</span>(resources);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è®¾ç½®ServletContainerInitializerç›‘å¬å™¨:</span>
</span></span><span style="display:flex;"><span>    ctx.<span style="color:#007f7f">addServletContainerInitializer</span>(<span style="color:#fff;font-weight:bold">new</span> ContextLoaderInitializer(configClass, propertyResolver), Set.<span style="color:#007f7f">of</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å¯åŠ¨æœåŠ¡å™¨:</span>
</span></span><span style="display:flex;"><span>    tomcat.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> tomcat.<span style="color:#007f7f">getServer</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é‚£ä¹ˆæˆ‘ä»¬çš„IoCå®¹å™¨ï¼Œä»¥åŠæ³¨å†Œ<code>Servlet</code>ã€<code>Filter</code>æ˜¯åœ¨å“ªè¿›è¡Œçš„ï¼Ÿç­”æ¡ˆæ˜¯æˆ‘ä»¬åœ¨<code>startTomcat()</code>å†…æ³¨å†Œäº†ä¸€ä¸ª<code>ServletContainerInitializer</code>ç›‘å¬å™¨ï¼Œè¿™ä¸ªç›‘å¬å™¨è´Ÿè´£å¯åŠ¨IoCå®¹å™¨ä¸æ³¨å†Œ<code>Servlet</code>ã€<code>Filter</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ContextLoaderInitializer <span style="color:#fff;font-weight:bold">implements</span> ServletContainerInitializer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Class&lt;?&gt; configClass;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> PropertyResolver propertyResolver;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ContextLoaderInitializer(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">configClass</span> = configClass;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span> = propertyResolver;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onStartup(Set&lt;Class&lt;?&gt;&gt; c, ServletContext ctx) <span style="color:#fff;font-weight:bold">throws</span> ServletException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è®¾ç½®ServletContext:</span>
</span></span><span style="display:flex;"><span>        WebMvcConfiguration.<span style="color:#007f7f">setServletContext</span>(ctx);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å¯åŠ¨IoCå®¹å™¨:</span>
</span></span><span style="display:flex;"><span>        ApplicationContext applicationContext = <span style="color:#fff;font-weight:bold">new</span> AnnotationConfigApplicationContext(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">configClass</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ³¨å†ŒFilterä¸DispatcherServlet:</span>
</span></span><span style="display:flex;"><span>        WebUtils.<span style="color:#007f7f">registerFilters</span>(ctx);
</span></span><span style="display:flex;"><span>        WebUtils.<span style="color:#007f7f">registerDispatcherServlet</span>(ctx, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ²¡æœ‰å¤ç”¨webæ¨¡å—çš„<code>ContextLoaderListener</code>æ˜¯å› ä¸ºTomcatä¸å…è®¸æ²¡æœ‰åœ¨<code>web.xml</code>ä¸­å£°æ˜çš„<code>Listener</code>æ³¨å†Œ<code>Filter</code>ä¸<code>Servlet</code>ï¼Œè€Œæˆ‘ä»¬å†™bootæ¨¡å—åŸå› ä¹‹ä¸€ä¹Ÿæ˜¯è¦åšåˆ°ä¸éœ€è¦<code>web.xml</code>ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†bootæ¨¡å—çš„å¼€å‘ï¼Œå®ƒå…¶å®å°±åŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li>SummerApplicationï¼šè´Ÿè´£å¯åŠ¨åµŒå…¥å¼Tomcatï¼›</li>
<li>ContextLoaderInitializerï¼šè´Ÿè´£å¯åŠ¨IoCå®¹å™¨ï¼Œæ³¨å†Œ<code>Filter</code>ä¸<code>DispatcherServlet</code>ã€‚</li>
</ul>
<p>ä¸‹é¢å°±å¯ä»¥ç¼–å†™ä¸€ä¸ªåŸºäº<code>boot</code>çš„Webåº”ç”¨ç¨‹åºäº†ã€‚</p>
<h2 id="å¼€å‘bootåº”ç”¨">å¼€å‘Bootåº”ç”¨<a hidden class="anchor" aria-hidden="true" href="#å¼€å‘bootåº”ç”¨">#</a></h2>
<p>æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½bootæ¨¡å—äº†ï¼Œä¸‹ä¸€æ­¥æ˜¯ä½¿ç”¨bootæ¥å¼€å‘Webåº”ç”¨ç¨‹åºã€‚</p>
<p>æˆ‘ä»¬è¿˜æ˜¯å…ˆå®šä¹‰ä¸€ä¸ªç¬¦åˆMavenç»“æ„çš„Webåº”ç”¨ç¨‹åº<code>hello-boot</code>ï¼Œå…ˆå®šä¹‰é…ç½®ç±»<code>HelloConfiguration</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@Import({ JdbcConfiguration.<span style="color:#007f7f">class</span>, WebMvcConfiguration.<span style="color:#007f7f">class</span> })
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HelloConfiguration {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥åŠ<code>UserService</code>ã€<code>MvcController</code>ç­‰ä¸šåŠ¡Beanã€‚</p>
<p>æˆ‘ä»¬ç›´æ¥å†™ä¸ª<code>main()</code>æ–¹æ³•å¯åŠ¨ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Main {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        SummerApplication.<span style="color:#007f7f">run</span>(<span style="color:#0ff;font-weight:bold">&#34;src/main/webapp&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;target/classes&#34;</span>, HelloConfiguration.<span style="color:#007f7f">class</span>, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç›´æ¥ä»IDEè¿è¡Œï¼Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œèƒ½é¡ºåˆ©å¯åŠ¨Tomcatã€åˆ›å»ºIoCå®¹å™¨ã€æ³¨å†Œ<code>Filter</code>å’Œ<code>DispatcherServlet</code>ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡æµè§ˆå™¨è®¿é—®ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœæ‰“ä¸€ä¸ªwaråŒ…ï¼Œç›´æ¥è¿è¡Œ<code>java -jar xyz.war</code>æ˜¯ä¸è¡Œçš„ï¼ä¼šç›´æ¥æŠ¥é”™ï¼šæ‰¾ä¸åˆ°Mainè¿™ä¸ªclassï¼</p>
<p>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬è¦ä»JVMçš„ç±»åŠ è½½æœºåˆ¶è¯´èµ·ã€‚</p>
<p>å½“æˆ‘ä»¬ç”¨<code>java</code>å¯åŠ¨ä¸€ä¸ªJavaç¨‹åºæ—¶ï¼Œéœ€è¦ç”¨<code>-cp</code>å‚æ•°è®¾ç½®classpathï¼ˆé»˜è®¤ä¸ºå½“å‰ç›®å½•<code>.</code>ï¼‰ï¼›å½“æˆ‘ä»¬ç”¨<code>java -jar xyz.jar</code>å¯åŠ¨ä¸€ä¸ªJavaç¨‹åºæ—¶ï¼ŒJVMå¿½ç•¥<code>-cp</code>å‚æ•°ï¼Œé»˜è®¤classpathä¸º<code>xyz.jar</code>ï¼Œè¿™æ ·ï¼Œå¦‚æœèƒ½åœ¨jaråŒ…ä¸­æ‰¾åˆ°å¯¹åº”çš„classï¼Œå°±å¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p>è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼ŒJVMä»jaråŒ…åŠ è½½classï¼Œæ˜¯ä»jaråŒ…çš„æ ¹ç›®å½•æŸ¥æ‰¾çš„ã€‚å¦‚æœå®ƒè¦åŠ è½½<code>com.itranswarp.hello.Main</code>ï¼Œé‚£ä¹ˆï¼Œ<code>xyz.jar</code>å¿…é¡»æŒ‰å¦‚ä¸‹ç›®å½•ç»„ç»‡ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>xyz.jar
</span></span><span style="display:flex;"><span>â””â”€â”€ com
</span></span><span style="display:flex;"><span>    â””â”€â”€ itranswarp
</span></span><span style="display:flex;"><span>        â””â”€â”€ hello
</span></span><span style="display:flex;"><span>            â””â”€â”€ Main.class
</span></span></code></pre></td></tr></table>
</div>
</div><p>è€Œæˆ‘ä»¬åœ¨ç”¨Mavenæ‰“waråŒ…æ—¶ï¼Œç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>xyz.war
</span></span><span style="display:flex;"><span>â””â”€â”€ WEB-INF
</span></span><span style="display:flex;"><span>    â””â”€â”€ classes
</span></span><span style="display:flex;"><span>        â””â”€â”€ com
</span></span><span style="display:flex;"><span>            â””â”€â”€ itranswarp
</span></span><span style="display:flex;"><span>                â””â”€â”€ hello
</span></span><span style="display:flex;"><span>                    â””â”€â”€ Main.class
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‡ªç„¶æ— æ³•åŠ è½½<code>Main</code>ã€‚ï¼ˆæ³¨æ„jaråŒ…å’ŒwaråŒ…ä»…æ‰©å±•åä¸åŒï¼Œå¯¹JVMæ¥è¯´æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼‰</p>
<p>é‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬æŠŠ<code>xyz.war</code>æ‰”åˆ°Tomcatçš„webappsç›®å½•ä¸‹å°±èƒ½æ­£å¸¸è¿è¡Œå‘¢ï¼Ÿå› ä¸ºTomcatå¯åŠ¨åï¼Œå¹¶ä¸ä½¿ç”¨JVMçš„ClassLoaderåŠ è½½classï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªwebappåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ClassLoaderï¼Œè¿™ä¸ªClassLoaderåœ¨å¦‚ä¸‹ä½ç½®æœç´¢classï¼š</p>
<ul>
<li>WEB-INF/classesç›®å½•ï¼›</li>
<li>WEB-INF/libç›®å½•ä¸‹çš„æ‰€æœ‰jaråŒ…ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œæˆ‘ä»¬è¦è¿è¡Œçš„<code>xyz.war</code>åŒ…å¿…é¡»åŒæ—¶å…·æœ‰Web Appçš„ç»“æ„ï¼Œåˆèƒ½åœ¨æ ¹ç›®å½•ä¸‹æœç´¢åˆ°åº”ç”¨ç¨‹åºè‡ªå·±ç¼–å†™çš„<code>Main</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>xyz.jar
</span></span><span style="display:flex;"><span>â”œâ”€â”€ com
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ itranswarp
</span></span><span style="display:flex;"><span>â”‚       â””â”€â”€ hello
</span></span><span style="display:flex;"><span>â”‚           â””â”€â”€ Main.class
</span></span><span style="display:flex;"><span>â””â”€â”€ WEB-INF
</span></span><span style="display:flex;"><span>    â”œâ”€â”€ classes
</span></span><span style="display:flex;"><span>    â””â”€â”€ libs
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§£å†³æ–¹æ¡ˆæ˜¯åœ¨æ‰“åŒ…æ—¶å¤åˆ¶æ‰€æœ‰ç¼–è¯‘çš„classåˆ°waråŒ…æ ¹ç›®å½•ï¼Œå¹¶æ·»åŠ å¯åŠ¨ç±»å…¥å£ã€‚ä¿®æ”¹<code>pom.xml</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;project</span> <span style="color:#f00">...</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;finalName&gt;</span>${project.name}<span style="font-weight:bold">&lt;/finalName&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;artifactId&gt;</span>maven-war-plugin<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;version&gt;</span>3.3.2<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#007f7f">&lt;!-- å¤åˆ¶classesåˆ°waråŒ…æ ¹ç›®å½• --&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;webResources&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;resource&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;directory&gt;</span>${project.build.directory}/classes<span style="font-weight:bold">&lt;/directory&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;/resource&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;/webResources&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;archiveClasses&gt;</span>true<span style="font-weight:bold">&lt;/archiveClasses&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;archive&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;manifest&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="color:#007f7f">&lt;!-- mainå¯åŠ¨ç±» --&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;mainClass&gt;</span>com.itranswarp.hello.Main<span style="font-weight:bold">&lt;/mainClass&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;/manifest&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;/archive&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/project&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†æ¬¡æ‰“åŒ…ï¼Œè¿è¡Œï¼Œåˆä¼šå¾—åˆ°æ‰¾ä¸åˆ°Classçš„é”™è¯¯ï¼Œä¸è¿‡è¿™æ¬¡æ˜¯<code>SummerApplication</code>ã€‚</p>
<p>è¿™åˆæ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿå¾ˆæ˜æ˜¾<code>Main</code>å·²ç»æ‰¾åˆ°äº†ï¼Œä½†æ˜¯<code>SummerApplication</code>åœ¨å“ªå‘¢ï¼Ÿå®ƒå…¶å®åœ¨<code>WEB-INF/lib/summer-boot-1.x.x.jar</code>ï¼ŒJVMä¸ä¼šåœ¨<code>WEB-INF/lib</code>ä¸‹æœç´¢Classï¼Œä¹Ÿä¸ä¼šåœ¨ä¸€ä¸ªjaråŒ…å†…æœç´¢â€œjaråŒ…å†…çš„jaråŒ…â€ã€‚</p>
<p>æ€ä¹ˆç ´ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯<code>Main</code>è¿è¡Œæ—¶å…ˆè‡ªè§£å‹ï¼Œå†è®©JVMèƒ½æœç´¢åˆ°<code>WEB-INF/lib/summer-boot-1.x.x.jar</code>å³å¯ã€‚</p>
<p>éœ€è¦å…ˆä¿®æ”¹<code>main()</code>æ–¹æ³•ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åˆ¤å®šæ˜¯å¦ä»jar/warå¯åŠ¨:</span>
</span></span><span style="display:flex;"><span>    String jarFile = Main.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getProtectionDomain</span>().<span style="color:#007f7f">getCodeSource</span>().<span style="color:#007f7f">getLocation</span>().<span style="color:#007f7f">getFile</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> isJarFile = jarFile.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.war&#34;</span>) || jarFile.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.jar&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å®šä½webappæ ¹ç›®å½•:</span>
</span></span><span style="display:flex;"><span>    String webDir = isJarFile ? <span style="color:#0ff;font-weight:bold">&#34;tmp-webapp&#34;</span> : <span style="color:#0ff;font-weight:bold">&#34;src/main/webapp&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (isJarFile) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è§£å‹åˆ°tmp-webapp:</span>
</span></span><span style="display:flex;"><span>        Path baseDir = Paths.<span style="color:#007f7f">get</span>(webDir).<span style="color:#007f7f">normalize</span>().<span style="color:#007f7f">toAbsolutePath</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (Files.<span style="color:#007f7f">isDirectory</span>(baseDir)) {
</span></span><span style="display:flex;"><span>            Files.<span style="color:#007f7f">delete</span>(baseDir);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Files.<span style="color:#007f7f">createDirectories</span>(baseDir);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;extract to: &#34;</span> + baseDir);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> (JarFile jar = <span style="color:#fff;font-weight:bold">new</span> JarFile(jarFile)) {
</span></span><span style="display:flex;"><span>            List&lt;JarEntry&gt; entries = jar.<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">sorted</span>(Comparator.<span style="color:#007f7f">comparing</span>(JarEntry::getName)).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (JarEntry entry : entries) {
</span></span><span style="display:flex;"><span>                Path res = baseDir.<span style="color:#007f7f">resolve</span>(entry.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (!entry.<span style="color:#007f7f">isDirectory</span>()) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(res);
</span></span><span style="display:flex;"><span>                    Files.<span style="color:#007f7f">createDirectories</span>(res.<span style="color:#007f7f">getParent</span>());
</span></span><span style="display:flex;"><span>                    Files.<span style="color:#007f7f">copy</span>(jar.<span style="color:#007f7f">getInputStream</span>(entry), res);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// JVMé€€å‡ºæ—¶è‡ªåŠ¨åˆ é™¤tmp-webapp:</span>
</span></span><span style="display:flex;"><span>        Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">addShutdownHook</span>(<span style="color:#fff;font-weight:bold">new</span> Thread(() -&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                Files.<span style="color:#007f7f">walk</span>(baseDir).<span style="color:#007f7f">sorted</span>(Comparator.<span style="color:#007f7f">reverseOrder</span>()).<span style="color:#007f7f">map</span>(Path::toFile).<span style="color:#007f7f">forEach</span>(File::delete);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>                e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    SummerApplication.<span style="color:#007f7f">run</span>(webDir, isJarFile ? <span style="color:#0ff;font-weight:bold">&#34;tmp-webapp&#34;</span> : <span style="color:#0ff;font-weight:bold">&#34;target/classes&#34;</span>, HelloConfiguration.<span style="color:#007f7f">class</span>, args);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†ä¿®æ”¹<code>pom.xml</code>ï¼ŒåŠ ä¸ŠClasspathï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;project</span> <span style="color:#f00">...</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;finalName&gt;</span>${project.name}<span style="font-weight:bold">&lt;/finalName&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;artifactId&gt;</span>maven-war-plugin<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;version&gt;</span>3.3.2<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#007f7f">&lt;!-- å¤åˆ¶classesåˆ°waråŒ…æ ¹ç›®å½• --&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;webResources&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;resource&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;directory&gt;</span>${project.build.directory}/classes<span style="font-weight:bold">&lt;/directory&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;/resource&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;/webResources&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;archiveClasses&gt;</span>true<span style="font-weight:bold">&lt;/archiveClasses&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;archive&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;manifest&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="color:#007f7f">&lt;!-- æ·»åŠ Class-Path --&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;addClasspath&gt;</span>true<span style="font-weight:bold">&lt;/addClasspath&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="color:#007f7f">&lt;!-- Classpathå‰ç¼€ --&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;classpathPrefix&gt;</span>tmp-webapp/WEB-INF/lib/<span style="font-weight:bold">&lt;/classpathPrefix&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="color:#007f7f">&lt;!-- mainå¯åŠ¨ç±» --&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;mainClass&gt;</span>com.itranswarp.hello.Main<span style="font-weight:bold">&lt;/mainClass&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;/manifest&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;/archive&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/project&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“æˆ‘ä»¬æ‰“åŒ…åï¼Œæˆ‘ä»¬æ¥åˆ†æå¯åŠ¨æµç¨‹ã€‚æˆ‘ä»¬å…ˆæŠŠwaråŒ…è§£å‹åˆ°<code>tmp-webapp</code>ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>tmp-webapp
</span></span><span style="display:flex;"><span>â”œâ”€â”€ META-INF
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ MANIFEST.MF
</span></span><span style="display:flex;"><span>â”œâ”€â”€ WEB-INF
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ classes
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ lib
</span></span><span style="display:flex;"><span>â”‚   â”‚   â”œâ”€â”€ summer-boot-1.0.3.jar
</span></span><span style="display:flex;"><span>â”‚   â”‚   â””â”€â”€ ... other jars ...
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ templates
</span></span><span style="display:flex;"><span>â”‚       â””â”€â”€ ... templates.html
</span></span><span style="display:flex;"><span>â”œâ”€â”€ application.yml
</span></span><span style="display:flex;"><span>â”œâ”€â”€ com
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ itranswarp
</span></span><span style="display:flex;"><span>â”‚       â””â”€â”€ hello
</span></span><span style="display:flex;"><span>â”‚           â”œâ”€â”€ Main.class
</span></span><span style="display:flex;"><span>â”‚           â””â”€â”€ ... other classes ...
</span></span><span style="display:flex;"><span>â”œâ”€â”€ favicon.ico
</span></span><span style="display:flex;"><span>â”œâ”€â”€ logback.xml
</span></span><span style="display:flex;"><span>â””â”€â”€ static
</span></span><span style="display:flex;"><span>    â””â”€â”€ ... static files ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯è§ï¼Œ<code>com/itranswarp/hello/Main.class</code>ã€<code>application.yml</code>ã€<code>logback.xml</code>éƒ½ä½äºwaråŒ…çš„æ ¹ç›®å½•ï¼Œå¯ä»¥è¢«JVMçš„ClassLoaderç›´æ¥åŠ è½½ï¼Œè€Œæƒ³è¦åŠ è½½<code>WEB-INF/lib/summer-boot-1.x.x.jar</code>ï¼Œæˆ‘ä»¬éœ€è¦ç»™å‡ºClasspathã€‚é€šè¿‡<code>java -jar xyz.war</code>å¯åŠ¨æ—¶ï¼Œè™½ç„¶<code>-cp</code>å‚æ•°æ— æ•ˆï¼Œä½†JVMä¼šè‡ªåŠ¨ä»<code>META-INF/MANIFEST.MF</code>ä¸­è¯»å–<code>Class-Path</code>æ¡ç›®ï¼Œæˆ‘ä»¬ç”¨Mavenå†™å…¥åå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Manifest-Version: 1.0
</span></span><span style="display:flex;"><span>Created-By: Maven WAR Plugin 3.3.2
</span></span><span style="display:flex;"><span>Build-Jdk-Spec: 17
</span></span><span style="display:flex;"><span>Main-Class: com.itranswarp.hello.Main
</span></span><span style="display:flex;"><span>Class-Path: tmp-webapp/WEB-INF/lib/summer-boot-1.0.3.jar tmp-webapp/WEB-
</span></span><span style="display:flex;"><span> INF/lib/summer-web-1.0.3.jar tmp-webapp/WEB-INF/lib/summer-context-1.0.
</span></span><span style="display:flex;"><span> 3.jar tmp-webapp/WEB-INF/lib/snakeyaml-2.0.jar tmp-webapp/WEB-INF/lib/j
</span></span><span style="display:flex;"><span> ackson-databind-2.14.2.jar tmp-webapp/WEB-INF/lib/jackson-annotations-2
</span></span><span style="display:flex;"><span> .14.2.jar tmp-webapp/WEB-INF/lib/jackson-core-2.14.2.jar tmp-webapp/WEB
</span></span><span style="display:flex;"><span> -INF/lib/jakarta.annotation-api-2.1.1.jar tmp-webapp/WEB-INF/lib/slf4j-
</span></span><span style="display:flex;"><span> api-2.0.7.jar tmp-webapp/WEB-INF/lib/logback-classic-1.4.6.jar tmp-weba
</span></span><span style="display:flex;"><span> pp/WEB-INF/lib/logback-core-1.4.6.jar tmp-webapp/WEB-INF/lib/freemarker
</span></span><span style="display:flex;"><span> -2.3.32.jar tmp-webapp/WEB-INF/lib/summer-jdbc-1.0.3.jar tmp-webapp/WEB
</span></span><span style="display:flex;"><span> -INF/lib/summer-aop-1.0.3.jar tmp-webapp/WEB-INF/lib/byte-buddy-1.14.2.
</span></span><span style="display:flex;"><span> jar tmp-webapp/WEB-INF/lib/HikariCP-5.0.1.jar tmp-webapp/WEB-INF/lib/to
</span></span><span style="display:flex;"><span> mcat-embed-core-10.1.7.jar tmp-webapp/WEB-INF/lib/tomcat-annotations-ap
</span></span><span style="display:flex;"><span> i-10.1.7.jar tmp-webapp/WEB-INF/lib/tomcat-embed-jasper-10.1.7.jar tmp-
</span></span><span style="display:flex;"><span> webapp/WEB-INF/lib/tomcat-embed-el-10.1.7.jar tmp-webapp/WEB-INF/lib/ec
</span></span><span style="display:flex;"><span> j-3.32.0.jar tmp-webapp/WEB-INF/lib/sqlite-jdbc-3.41.2.1.jar
</span></span></code></pre></td></tr></table>
</div>
</div><p>JVMä¼šè¯»å–åˆ°<code>Main-Class</code>å’Œ<code>Class-Path</code>ï¼Œç”±äºå·²ç»è§£å‹ï¼Œå°±èƒ½åœ¨<code>tmp-webapp</code>ç›®å½•ä¸­é¡ºåˆ©æœç´¢åˆ°<code>tmp-webapp/WEB-INF/lib/summer-boot-1.x.x.jar</code>ã€‚åç»­Tomcatå¯åŠ¨åï¼Œä»¥<code>tmp-webapp</code>ä½œä¸ºwebç›®å½•æœ¬èº«å°±æ˜¯æ ‡å‡†çš„Web Appï¼ŒTomcatçš„ClassLoaderä¹Ÿèƒ½ç»§ç»­ä»<code>WEB-INF/lib</code>åŠ è½½å„ç§jaråŒ…ã€‚</p>
<p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼Œæ‰“åŒ…æ—¶åšäº†å“ªäº›å·¥ä½œï¼š</p>
<ul>
<li>å¤åˆ¶æ‰€æœ‰ç¼–è¯‘çš„classåˆ°waråŒ…æ ¹ç›®å½•ï¼›</li>
<li>ä¿®æ”¹META-INF/MANIFEST.MFï¼š
<ul>
<li>æ·»åŠ <code>Main-Class</code>æ¡ç›®ï¼›</li>
<li>æ·»åŠ <code>Class-Path</code>æ¡ç›®ã€‚</li>
</ul>
</li>
</ul>
<p>è¿è¡Œæ—¶çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>JVMä»waråŒ…åŠ è½½Mainç±»ï¼Œæ‰§è¡Œ<code>main()</code>æ–¹æ³•ï¼›</li>
<li>ç«‹åˆ»è‡ªè§£å‹waråŒ…è‡³<code>tmp-webapp</code>ç›®å½•ï¼›</li>
<li>åç»­åŠ è½½<code>SummerApplication</code>æ—¶ï¼ŒJVMæ ¹æ®Class-Pathèƒ½æ‰¾åˆ°<code>tmp-webapp/WEB-INF/lib/summer-boot-1.x.x.jar</code>ï¼Œå› æ­¤å¯é¡ºåˆ©åŠ è½½ï¼›</li>
<li>å¯åŠ¨Tomcatï¼Œå°†<code>tmp-webapp</code>åšä¸ºWebç›®å½•ï¼›</li>
<li>ä½œä¸ºWeb Appä½¿ç”¨Tomcatçš„ClassLoaderåŠ è½½å…¶ä»–ç»„ä»¶ã€‚</li>
</ol>
<p>è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥ç”¨<code>java -jar xyz.war</code>å¯åŠ¨çš„Webåº”ç”¨ç¨‹åºï¼</p>
<p>æœ‰çš„åŒå­¦ä¼šé—®ï¼Œæˆ‘ä»¬çš„bootåº”ç”¨ï¼Œ<code>main()</code>æ–¹æ³•å†™äº†ä¸€å †è‡ªè§£å‹ä»£ç ï¼Œè€Œä¸”ï¼Œéœ€è¦åœ¨<code>pom.xml</code>ä¸­é…ç½®å¾ˆå¤šé¢å¤–çš„è®¾ç½®ï¼Œå¯¹æ¯”Spring Bootåº”ç”¨ï¼Œå®ƒå¯¹<code>main()</code>æ–¹æ³•æ²¡æœ‰ä»»ä½•è¦æ±‚ï¼Œè€Œä¸”ï¼Œåœ¨<code>pom.xml</code>ä¸­ä¹Ÿåªéœ€é…ç½®ä¸€ä¸ª<code>spring-boot-maven-plugin</code>ï¼Œæ²¡æœ‰å…¶ä»–é¢å¤–é…ç½®ï¼Œç›¸æ¯”ä¹‹ä¸‹ç®€å•å¤šäº†ï¼Œé‚£ä¹ˆï¼ŒSpring Bootæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</p>
<p>æˆ‘ä»¬æ‰¾ä¸€ä¸ªSpring Bootæ‰“åŒ…çš„jarè§£å‹åå°±æ˜ç™½äº†ï¼Œå®ƒçš„jaråŒ…ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>xyz.jar
</span></span><span style="display:flex;"><span><span style="color:#f00">â”œâ”€â”€</span> BOOT-INF
</span></span><span style="display:flex;"><span><span style="color:#f00">â”‚</span>   <span style="color:#f00">â”œâ”€â”€</span> classes
</span></span><span style="display:flex;"><span><span style="color:#f00">â”‚</span>   <span style="color:#f00">â”‚</span>   <span style="color:#f00">â”œâ”€â”€</span> application.yml
</span></span><span style="display:flex;"><span><span style="color:#f00">â”‚</span>   <span style="color:#f00">â”‚</span>   <span style="color:#f00">â”œâ”€â”€</span> logback-spring.xml
</span></span><span style="display:flex;"><span><span style="color:#f00">â”‚</span>   <span style="color:#f00">â”‚</span>   <span style="color:#f00">â”œâ”€â”€</span> <span style="color:#fff;font-weight:bold">static</span>
</span></span><span style="display:flex;"><span><span style="color:#f00">â”‚</span>   <span style="color:#f00">â”‚</span>   <span style="color:#f00">â”‚</span>   <span style="color:#f00">â””â”€â”€</span> ... <span style="color:#fff;font-weight:bold">static</span> files ...
</span></span><span style="display:flex;"><span><span style="color:#f00">â”‚</span>   <span style="color:#f00">â”‚</span>   <span style="color:#f00">â””â”€â”€</span> templates
</span></span><span style="display:flex;"><span><span style="color:#f00">â”‚</span>   <span style="color:#f00">â”‚</span>       <span style="color:#f00">â””â”€â”€</span> ... templates ...
</span></span><span style="display:flex;"><span><span style="color:#f00">â”‚</span>   <span style="color:#f00">â””â”€â”€</span> lib
</span></span><span style="display:flex;"><span><span style="color:#f00">â”‚</span>       <span style="color:#f00">â”œâ”€â”€</span> spring-boot-<span style="color:#ff0;font-weight:bold">3.0</span>.<span style="color:#ff0;font-weight:bold">0.j</span>ar
</span></span><span style="display:flex;"><span><span style="color:#f00">â”‚</span>       <span style="color:#f00">â””â”€â”€</span> ... other jars ...
</span></span><span style="display:flex;"><span><span style="color:#f00">â”œâ”€â”€</span> META-INF
</span></span><span style="display:flex;"><span><span style="color:#f00">â”‚</span>   <span style="color:#f00">â””â”€â”€</span> MANIFEST.MF
</span></span><span style="display:flex;"><span><span style="color:#f00">â””â”€â”€</span> org
</span></span><span style="display:flex;"><span>    <span style="color:#f00">â””â”€â”€</span> springframework
</span></span><span style="display:flex;"><span>        <span style="color:#f00">â””â”€â”€</span> boot
</span></span><span style="display:flex;"><span>            <span style="color:#f00">â””â”€â”€</span> loader
</span></span><span style="display:flex;"><span>                <span style="color:#f00">â”œâ”€â”€</span> JarLauncher.<span style="color:#fff;font-weight:bold">class</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f00">â””â”€â”€</span> ... other classes ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Spring Bootå¹¶ä¸èƒ½ä¿®æ”¹JVMçš„ClassLoaderæœºåˆ¶ï¼Œå› æ­¤ï¼ŒSpring Bootçš„jaråŒ…ä»ç„¶éœ€è¦åœ¨<code>META-INF/MANIFEST.MF</code>ä¸­å£°æ˜<code>Main-Class</code>ï¼Œåªä¸è¿‡å®ƒå£°æ˜çš„ä¸æ˜¯åº”ç”¨ç¨‹åºè‡ªå·±çš„<code>Main</code>ï¼Œè€Œæ˜¯Spring Bootçš„<code>JarLauncher</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>Main-Class: org.springframework.boot.loader.JarLauncher
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨jaråŒ…çš„æ ¹ç›®å½•ï¼ŒJVMå¯ä»¥åŠ è½½<code>JarLauncher</code>ã€‚ä¸€æ—¦åŠ è½½äº†<code>JarLauncher</code>åï¼ŒSpring Bootä¼šç”¨è‡ªå·±çš„ClassLoaderå»åŠ è½½å…¶ä»–çš„classå’ŒjaråŒ…ï¼Œå®ƒåœ¨<code>BOOT-INF/classes</code>å’Œ<code>BOOT-INF/lib</code>ä¸‹æœç´¢ã€‚æ³¨æ„Spring Bootè‡ªå®šä¹‰çš„ClassLoaderå¹¶ä¸éœ€è¦è®¾ç½®<code>Class-Path</code>ï¼Œå®ƒå¯ä»¥å®Œå…¨è‡ªå®šä¹‰æœç´¢è·¯å¾„ï¼ŒåŒ…æ‹¬æœç´¢â€œjaråŒ…ä¸­çš„jaråŒ…â€ã€‚</p>
<p>å› æ­¤ï¼ŒSpring Booté‡‡ç”¨äº†ä¸¤ç§æœºåˆ¶æ¥å®ç°å¯æ‰§è¡ŒjaråŒ…ï¼š</p>
<ol>
<li>æä¾›Mavenæ’ä»¶ï¼Œè‡ªåŠ¨è®¾ç½®<code>Main-Class</code>ï¼Œå¤åˆ¶ç›¸å…³å¯åŠ¨Classï¼ŒæŒ‰<code>BOOT-INF</code>ç»„ç»‡classå’ŒjaråŒ…ï¼›</li>
<li>æä¾›è‡ªå®šä¹‰çš„ClassLoaderï¼Œå¯ä»¥åœ¨jaråŒ…ä¸­æœç´¢<code>BOOT-INF/classes</code>å’Œ<code>BOOT-INF/lib</code>ã€‚</li>
</ol>
<p>è¿™æ ·å°±ä½¿å¾—ç¼–å†™Webåº”ç”¨ç¨‹åºæ—¶èƒ½ç®€åŒ–æ‰“åŒ…å’Œå¯åŠ¨æµç¨‹ã€‚ä»£ä»·å°±æ˜¯ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰çš„Mavenæ’ä»¶å’Œè‡ªå®šä¹‰çš„ClassLoaderå·¥ä½œé‡å¾ˆå¤§ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è¯•ç€å®ç°Spring Bootçš„æœºåˆ¶ã€‚</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://wjy6.netlify.app/tags/spring/">Spring</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://wjy6.netlify.app/">Wjy&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
