<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>手写Spring | Wjy&#39;s Blog</title>
<meta name="keywords" content="spring">
<meta name="description" content="实现IOC容器
Spring的核心就是能管理一组Bean，并能自动配置依赖关系的IoC容器。而我们的Summer Framework的核心context模块就是要实现IoC容器。
手写Spring - 廖雪峰的官方网站 (liaoxuefeng.com)">
<meta name="author" content="Wjy">
<link rel="canonical" href="http://localhost:1313/posts/spring/%E6%89%8B%E5%86%99spring/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="手写Spring" />
<meta property="og:description" content="实现IOC容器
Spring的核心就是能管理一组Bean，并能自动配置依赖关系的IoC容器。而我们的Summer Framework的核心context模块就是要实现IoC容器。
手写Spring - 廖雪峰的官方网站 (liaoxuefeng.com)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/spring/%E6%89%8B%E5%86%99spring/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-13T15:50:13+00:00" />
<meta property="article:modified_time" content="2023-04-13T15:50:13+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="手写Spring"/>
<meta name="twitter:description" content="实现IOC容器
Spring的核心就是能管理一组Bean，并能自动配置依赖关系的IoC容器。而我们的Summer Framework的核心context模块就是要实现IoC容器。
手写Spring - 廖雪峰的官方网站 (liaoxuefeng.com)"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "手写Spring",
      "item": "http://localhost:1313/posts/spring/%E6%89%8B%E5%86%99spring/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "手写Spring",
  "name": "手写Spring",
  "description": "实现IOC容器 Spring的核心就是能管理一组Bean，并能自动配置依赖关系的IoC容器。而我们的Summer Framework的核心context模块就是要实现IoC容器。\n手写Spring - 廖雪峰的官方网站 (liaoxuefeng.com)\n",
  "keywords": [
    "spring"
  ],
  "articleBody": "实现IOC容器 Spring的核心就是能管理一组Bean，并能自动配置依赖关系的IoC容器。而我们的Summer Framework的核心context模块就是要实现IoC容器。\n手写Spring - 廖雪峰的官方网站 (liaoxuefeng.com)\n设计目标 Spring的IoC容器分为两类：BeanFactory和ApplicationContext，前者总是延迟创建Bean，而后者则在启动时初始化所有Bean。实际使用时，99%都采用ApplicationContext，因此，Summer Framework仅实现ApplicationContext，不支持BeanFactory。\n早期的Spring容器采用XML来配置Bean，后期又加入了自动扫描包的功能，即通过的配置。再后来，又加入了Annotation配置，并通过@ComponentScan注解实现自动扫描。如果使用Spring Boot，则99%都采用@ComponentScan注解方式配置，因此，Summer Framework也仅实现Annotation配置+@ComponentScan扫描方式完成容器的配置。\n此外，Summer Framework仅支持Singleton类型的Bean，不支持Prototype类型的Bean，因为实际使用中，99%都采用Singleton。依赖注入则与Spring保持一致，支持构造方法、Setter方法与字段注入。支持@Configuration和BeanPostProcessor。至于Spring的其他功能，例如，层级容器、MessageSource、一个Bean允许多个名字等功能，一概不支持！\n下表列出了Spring Framework和Summer Framework在IoC容器方面的异同：\n功能 Spring Framework Summer Framework IoC容器 支持BeanFactory和ApplicationContext 仅支持ApplicationContext 配置方式 支持XML与Annotation 仅支持Annotation 扫描方式 支持按包名扫描 支持按包名扫描 Bean类型 支持Singleton和Prototype 仅支持Singleton Bean工厂 支持FactoryBean和@Bean注解 仅支持@Bean注解 定制Bean 支持BeanPostProcessor 支持BeanPostProcessor 依赖注入 支持构造方法、Setter方法与字段 支持构造方法、Setter方法与字段 多容器 支持父子容器 不支持 Annotation配置 从使用者的角度看，使用IoC容器时，需要定义一个入口配置，它通常长这样：\n1 2 3 @ComponentScan public class AppConfig { } AppConfig只是一个配置类，它的目的是通过@ComponentScan来标识要扫描的Bean的包。如果没有明确写出包名，那么将基于AppConfig所在包进行扫描，如果明确写出了包名，则在指定的包下进行扫描。\n在扫描过程中，凡是带有注解@Component的类，将被添加到IoC容器进行管理：\n1 2 3 @Component public class Hello { } 我们用到的许多第三方组件也经常会纳入IoC容器管理。这些第三方组件是不可能带有@Component注解的，引入第三方Bean只能通过工厂模式，即在@Configuration工厂类中定义带@Bean的工厂方法：\n1 2 3 4 5 6 7 8 9 10 11 12 @Configuration public class DbConfig { @Bean DataSource createDataSource(...) { return new HikariDataSource(...); } @Bean JdbcTemplate createJdbcTemplate(...) { return new JdbcTemplate(...); } } 基于Annotation配置的IoC容器基本用法就是上面所述。下面，我们就一步一步来实现IoC容器。\n实现ResourceResolver 在编写IoC容器之前，我们首先要实现@ComponentScan，即解决在指定包下扫描所有Class的问题。\nJava的ClassLoader机制可以在指定的Classpath中根据类名加载指定的Class，但遗憾的是，给出一个包名，例如，org.example，它并不能获取到该包下的所有Class，也不能获取子包。\n要在Classpath中扫描指定包名下的所有Class，包括子包，实际上是在Classpath中搜索所有文件，找出文件名匹配的.class文件。例如，Classpath中搜索的文件org/example/Hello.class就符合包名org.example，我们需要根据文件路径把它变为org.example.Hello，就相当于获得了类名。因此，搜索Class变成了搜索文件。\n我们先定义一个Resource类型表示文件：\n1 2 public record Resource(String path, String name) { } 再仿造Spring提供一个ResourceResolver，定义scan()方法来获取扫描到的Resource：\n1 2 3 4 5 6 7 8 9 10 11 public class ResourceResolver { String basePackage; public ResourceResolver(String basePackage) { this.basePackage = basePackage; } public List scan(Function mapper) { ... } } 这样，我们就可以扫描指定包下的所有文件。有的同学会问，我们的目的是扫描.class文件，如何过滤出Class？\n注意到scan()方法传入了一个映射函数，我们传入Resource到Class Name的映射，就可以扫描出Class Name：\n1 2 3 4 5 6 7 8 9 10 11 // 定义一个扫描器: ResourceResolver rr = new ResourceResolver(\"org.example\"); List classList = rr.scan(res -\u003e { String name = res.name(); // 资源名称\"org/example/Hello.class\" if (name.endsWith(\".class\")) { // 如果以.class结尾 // 把\"org/example/Hello.class\"变为\"org.example.Hello\": return name.substring(0, name.length() - 6).replace(\"/\", \".\").replace(\"\\\\\", \".\"); } // 否则返回null表示不是有效的Class Name: return null; }); 这样，ResourceResolver只负责扫描并列出所有文件，由客户端决定是找出.class文件，还是找出.properties文件。\n在ClassPath中扫描文件的代码是固定模式，可以在网上搜索获得，例如StackOverflow的这个回答。这里要注意的一点是，Java支持在jar包中搜索文件，所以，不但需要在普通目录中搜索，也需要在Classpath中列出的jar包中搜索，核心代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 // 通过ClassLoader获取URL列表: Enumeration en = getContextClassLoader().getResources(\"org/example\"); while (en.hasMoreElements()) { URL url = en.nextElement(); URI uri = url.toURI(); if (uri.toString().startsWith(\"file:\")) { // 在目录中搜索 } if (uri.toString().startsWith(\"jar:\")) { // 在Jar包中搜索 } } 几个要点：\nClassLoader首先从Thread.getContextClassLoader()获取，如果获取不到，再从当前Class获取，因为Web应用的ClassLoader不是JVM提供的基于Classpath的ClassLoader，而是Servlet容器提供的ClassLoader，它不在默认的Classpath搜索，而是在/WEB-INF/classes目录和/WEB-INF/lib的所有jar包搜索，从Thread.getContextClassLoader()可以获取到Servlet容器专属的ClassLoader； Windows和Linux/macOS的路径分隔符不同，前者是\\，后者是/，需要正确处理； 扫描目录时，返回的路径可能是abc/xyz，也可能是abc/xyz/，需要注意处理末尾的/。 这样我们就完成了能扫描指定包以及子包下所有文件的ResourceResolver。\n实现PropertyResolver Spring的注入分为@Autowired和@Value两种。对于@Autowired，涉及到Bean的依赖，而对于@Value，则仅仅是将对应的配置注入，不涉及Bean的依赖，相对比较简单。为了注入配置，我们用PropertyResolver保存所有配置项，对外提供查询功能。\n本节我们来实现PropertyResolver，它支持3种查询方式：\n按配置的key查询，例如：getProperty(\"app.title\"); 以${abc.xyz}形式的查询，例如，getProperty(\"${app.title}\")，常用于@Value(\"${app.title}\")注入； 带默认值的，以${abc.xyz:defaultValue}形式的查询，例如，getProperty(\"${app.title:Summer}\")，常用于@Value(\"${app.title:Summer}\")注入。 Java本身提供了按key-value查询的Properties，我们先传入Properties，内部按key-value存储：\n1 2 3 4 5 6 7 8 9 10 11 12 13 public class PropertyResolver { Map properties = new HashMap\u003c\u003e(); public PropertyResolver(Properties props) { // 存入环境变量: this.properties.putAll(System.getenv()); // 存入Properties: Set names = props.stringPropertyNames(); for (String name : names) { this.properties.put(name, props.getProperty(name)); } } } 这样，我们在PropertyResolver内部，通过一个Map存储了所有的配置项，包括环境变量。对于按key查询的功能，我们可以简单实现如下：\n1 2 3 4 @Nullable public String getProperty(String key) { return this.properties.get(key); } 下一步，我们准备解析${abc.xyz:defaultValue}这样的key，先定义一个PropertyExpr，把解析后的key和defaultValue存储起来：\n1 2 record PropertyExpr(String key, String defaultValue) { } 然后按${...}解析：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 PropertyExpr parsePropertyExpr(String key) { if (key.startsWith(\"${\") \u0026\u0026 key.endsWith(\"}\")) { // 是否存在defaultValue? int n = key.indexOf(':'); if (n == (-1)) { // 没有defaultValue: ${key} String k = key.substring(2, key.length() - 1); return new PropertyExpr(k, null); } else { // 有defaultValue: ${key:default} String k = key.substring(2, n); return new PropertyExpr(k, key.substring(n + 1, key.length() - 1)); } return null; } } 我们把getProperty()改造一下，即可实现查询${abc.xyz:defaultValue}：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @Nullable public String getProperty(String key) { // 解析${abc.xyz:defaultValue}: PropertyExpr keyExpr = parsePropertyExpr(key); if (keyExpr != null) { if (keyExpr.defaultValue() != null) { // 带默认值查询: return getProperty(keyExpr.key(), keyExpr.defaultValue()); } else { // 不带默认值查询: return getRequiredProperty(keyExpr.key()); } } // 普通key查询: String value = this.properties.get(key); if (value != null) { return parseValue(value); } return value; } 每次查询到value后，我们递归调用parseValue()，这样就可以支持嵌套的key，例如：\n1 ${app.title:${APP_NAME:Summer}} 这样可以先查询app.title，没有找到就再查询APP_NAME，还没有找到就返回默认值Summer。\n注意到Spring的${...}表达式实际上可以做到组合，例如：\n1 jdbc.url=jdbc:mysql//${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME} 而我们实现的${...}表达式只能嵌套，不能组合，因为要实现Spring的表达式，需要编写一个完整的能解析表达式的复杂功能，而不能仅仅依靠判断${开头、}结尾。由于解析表达式的功能过于复杂，因此我们决定不予支持。\nSpring还支持更复杂的#{...}表达式，它可以引用Bean、调用方法、计算等：\n1 #{appBean.version() + 1} 为此Spring专门提供了一个spring-expression库来支持这种更复杂的功能。按照一切从简的原则，我们不支持#{...}表达式。\n实现类型转换 除了String类型外，@Value注入时，还允许boolean、int、Long等基本类型和包装类型。此外，Spring还支持Date、Duration等类型的注入。我们既要实现类型转换，又不能写死，否则，将来支持新的类型时就要改代码。\n我们先写类型转换的入口查询：\n1 2 3 4 5 6 7 8 9 @Nullable public T getProperty(String key, Class targetType) { String value = getProperty(key); if (value == null) { return null; } // 转换为指定类型: return convert(targetType, value); } 再考虑如何实现convert()方法。对于类型转换，实际上是从String转换为指定类型，因此，用函数式接口Function就很合适：\n1 2 3 4 5 6 7 8 9 10 11 12 13 public class PropertyResolver { // 存储Class -\u003e Function: Map",
  "wordCount" : "40407",
  "inLanguage": "en",
  "datePublished": "2023-04-13T15:50:13Z",
  "dateModified": "2023-04-13T15:50:13Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/spring/%E6%89%8B%E5%86%99spring/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      手写Spring
    </h1>
    <div class="post-meta"><span title='2023-04-13 15:50:13 +0000 UTC'>2023-04-13</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0ioc%e5%ae%b9%e5%99%a8" aria-label="实现IOC容器">实现IOC容器</a><ul>
                        
                <li>
                    <a href="#%e8%ae%be%e8%ae%a1%e7%9b%ae%e6%a0%87" aria-label="设计目标">设计目标</a></li>
                <li>
                    <a href="#annotation%e9%85%8d%e7%bd%ae" aria-label="Annotation配置">Annotation配置</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0resourceresolver" aria-label="实现ResourceResolver">实现ResourceResolver</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0propertyresolver" aria-label="实现PropertyResolver">实现PropertyResolver</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e7%b1%bb%e5%9e%8b%e8%bd%ac%e6%8d%a2" aria-label="实现类型转换">实现类型转换</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8yaml%e9%85%8d%e7%bd%ae" aria-label="使用YAML配置">使用YAML配置</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%babeandefinition" aria-label="创建BeanDefinition">创建BeanDefinition</a><ul>
                        
                <li>
                    <a href="#bean%e7%9a%84%e5%a3%b0%e6%98%8e%e7%b1%bb%e5%9e%8b" aria-label="Bean的声明类型">Bean的声明类型</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%babean%e5%ae%9e%e4%be%8b" aria-label="创建Bean实例">创建Bean实例</a></li>
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96bean" aria-label="初始化Bean">初始化Bean</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0beanpostprocessor" aria-label="实现BeanPostProcessor">实现BeanPostProcessor</a><ul>
                        
                <li>
                    <a href="#%e6%b5%8b%e8%af%95" aria-label="测试">测试</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%8c%e6%88%90ioc%e5%ae%b9%e5%99%a8" aria-label="完成IOC容器">完成IOC容器</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0aop" aria-label="实现AOP">实现AOP</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0proxyresolver" aria-label="实现ProxyResolver">实现ProxyResolver</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0around" aria-label="实现Around">实现Around</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0before%e5%92%8cafter" aria-label="实现Before和After">实现Before和After</a></li>
                <li>
                    <a href="#%e6%89%a9%e5%b1%95annotation" aria-label="扩展Annotation">扩展Annotation</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0jdbc%e5%92%8c%e4%ba%8b%e5%8a%a1" aria-label="实现JDBC和事务">实现JDBC和事务</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0jdbctemplate" aria-label="实现JdbcTemplate">实现JdbcTemplate</a><ul>
                        
                <li>
                    <a href="#%e9%85%8d%e7%bd%aedatasource" aria-label="配置DataSource">配置DataSource</a></li>
                <li>
                    <a href="#%e5%ae%9a%e4%b9%89jdbctemplate" aria-label="定义JdbcTemplate">定义JdbcTemplate</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e5%a3%b0%e6%98%8e%e5%bc%8f%e4%ba%8b%e5%8a%a1" aria-label="实现声明式事务">实现声明式事务</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0web-mvc" aria-label="实现Web MVC">实现Web MVC</a><ul>
                        
                <li>
                    <a href="#%e5%90%af%e5%8a%a8ioc%e5%ae%b9%e5%99%a8" aria-label="启动IoC容器">启动IoC容器</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0mvc" aria-label="实现MVC">实现MVC</a><ul>
                        
                <li>
                    <a href="#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" aria-label="注意事项">注意事项</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95-1" aria-label="测试">测试</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%80%e5%8f%91web%e5%ba%94%e7%94%a8" aria-label="开发Web应用">开发Web应用</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0boot" aria-label="实现Boot">实现Boot</a><ul>
                        
                <li>
                    <a href="#%e5%90%af%e5%8a%a8%e5%b5%8c%e5%85%a5%e5%bc%8ftomcat" aria-label="启动嵌入式Tomcat">启动嵌入式Tomcat</a></li>
                <li>
                    <a href="#%e5%bc%80%e5%8f%91boot%e5%ba%94%e7%94%a8" aria-label="开发Boot应用">开发Boot应用</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="实现ioc容器">实现IOC容器<a hidden class="anchor" aria-hidden="true" href="#实现ioc容器">#</a></h1>
<p>Spring的核心就是能管理一组Bean，并能自动配置依赖关系的IoC容器。而我们的Summer Framework的核心context模块就是要实现IoC容器。</p>
<p><a href="https://www.liaoxuefeng.com/wiki/1539348902182944">手写Spring - 廖雪峰的官方网站 (liaoxuefeng.com)</a></p>
<h2 id="设计目标">设计目标<a hidden class="anchor" aria-hidden="true" href="#设计目标">#</a></h2>
<p>Spring的IoC容器分为两类：BeanFactory和ApplicationContext，前者总是延迟创建Bean，而后者则在启动时初始化所有Bean。实际使用时，99%都采用ApplicationContext，因此，Summer Framework仅实现ApplicationContext，不支持BeanFactory。</p>
<p>早期的Spring容器采用XML来配置Bean，后期又加入了自动扫描包的功能，即通过<code>&lt;context:component-scan base-package=&quot;org.example&quot;/&gt;</code>的配置。再后来，又加入了Annotation配置，并通过<code>@ComponentScan</code>注解实现自动扫描。如果使用Spring Boot，则99%都采用<code>@ComponentScan</code>注解方式配置，因此，Summer Framework也仅实现Annotation配置+<code>@ComponentScan</code>扫描方式完成容器的配置。</p>
<p>此外，Summer Framework仅支持Singleton类型的Bean，不支持Prototype类型的Bean，因为实际使用中，99%都采用Singleton。依赖注入则与Spring保持一致，支持构造方法、Setter方法与字段注入。支持<code>@Configuration</code>和<code>BeanPostProcessor</code>。至于Spring的其他功能，例如，层级容器、MessageSource、一个Bean允许多个名字等功能，一概不支持！</p>
<p>下表列出了Spring Framework和Summer Framework在IoC容器方面的异同：</p>
<table>
<thead>
<tr>
<th style="text-align:left">功能</th>
<th style="text-align:left">Spring Framework</th>
<th style="text-align:left">Summer Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">IoC容器</td>
<td style="text-align:left">支持BeanFactory和ApplicationContext</td>
<td style="text-align:left">仅支持ApplicationContext</td>
</tr>
<tr>
<td style="text-align:left">配置方式</td>
<td style="text-align:left">支持XML与Annotation</td>
<td style="text-align:left">仅支持Annotation</td>
</tr>
<tr>
<td style="text-align:left">扫描方式</td>
<td style="text-align:left">支持按包名扫描</td>
<td style="text-align:left">支持按包名扫描</td>
</tr>
<tr>
<td style="text-align:left">Bean类型</td>
<td style="text-align:left">支持Singleton和Prototype</td>
<td style="text-align:left">仅支持Singleton</td>
</tr>
<tr>
<td style="text-align:left">Bean工厂</td>
<td style="text-align:left">支持FactoryBean和@Bean注解</td>
<td style="text-align:left">仅支持@Bean注解</td>
</tr>
<tr>
<td style="text-align:left">定制Bean</td>
<td style="text-align:left">支持BeanPostProcessor</td>
<td style="text-align:left">支持BeanPostProcessor</td>
</tr>
<tr>
<td style="text-align:left">依赖注入</td>
<td style="text-align:left">支持构造方法、Setter方法与字段</td>
<td style="text-align:left">支持构造方法、Setter方法与字段</td>
</tr>
<tr>
<td style="text-align:left">多容器</td>
<td style="text-align:left">支持父子容器</td>
<td style="text-align:left">不支持</td>
</tr>
</tbody>
</table>
<h2 id="annotation配置">Annotation配置<a hidden class="anchor" aria-hidden="true" href="#annotation配置">#</a></h2>
<p>从使用者的角度看，使用IoC容器时，需要定义一个入口配置，它通常长这样：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>AppConfig</code>只是一个配置类，它的目的是通过<code>@ComponentScan</code>来标识要扫描的Bean的包。如果没有明确写出包名，那么将基于<code>AppConfig</code>所在包进行扫描，如果明确写出了包名，则在指定的包下进行扫描。</p>
<p>在扫描过程中，凡是带有注解<code>@Component</code>的类，将被添加到IoC容器进行管理：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Hello {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们用到的许多第三方组件也经常会纳入IoC容器管理。这些第三方组件是不可能带有<code>@Component</code>注解的，引入第三方Bean只能通过工厂模式，即在<code>@Configuration</code>工厂类中定义带<code>@Bean</code>的工厂方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DbConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    DataSource createDataSource(...) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> HikariDataSource(...);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    JdbcTemplate createJdbcTemplate(...) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> JdbcTemplate(...);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>基于Annotation配置的IoC容器基本用法就是上面所述。下面，我们就一步一步来实现IoC容器。</p>
<h2 id="实现resourceresolver">实现ResourceResolver<a hidden class="anchor" aria-hidden="true" href="#实现resourceresolver">#</a></h2>
<p>在编写IoC容器之前，我们首先要实现<code>@ComponentScan</code>，即解决<code>在指定包下扫描所有Class</code>的问题。</p>
<p>Java的ClassLoader机制可以在指定的Classpath中根据类名加载指定的Class，但遗憾的是，给出一个包名，例如，<code>org.example</code>，它并不能获取到该包下的所有Class，也不能获取子包。</p>
<p>要在Classpath中扫描指定包名下的所有Class，包括子包，实际上是在Classpath中搜索所有文件，找出文件名匹配的<code>.class</code>文件。例如，Classpath中搜索的文件<code>org/example/Hello.class</code>就符合包名<code>org.example</code>，我们需要根据文件路径把它变为<code>org.example.Hello</code>，就相当于获得了类名。因此，搜索Class变成了搜索文件。</p>
<p>我们先定义一个<code>Resource</code>类型表示文件：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> record Resource(String path, String name) {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>再仿造Spring提供一个<code>ResourceResolver</code>，定义<code>scan()</code>方法来获取扫描到的<code>Resource</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ResourceResolver {
</span></span><span style="display:flex;"><span>    String basePackage;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ResourceResolver(String basePackage) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">basePackage</span> = basePackage;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> &lt;R&gt; List&lt;R&gt; scan(Function&lt;Resource, R&gt; mapper) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样，我们就可以扫描指定包下的所有文件。有的同学会问，我们的目的是扫描<code>.class</code>文件，如何过滤出Class？</p>
<p>注意到<code>scan()</code>方法传入了一个映射函数，我们传入<code>Resource</code>到Class Name的映射，就可以扫描出Class Name：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 定义一个扫描器:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>ResourceResolver rr = <span style="color:#fff;font-weight:bold">new</span> ResourceResolver(<span style="color:#0ff;font-weight:bold">&#34;org.example&#34;</span>);
</span></span><span style="display:flex;"><span>List&lt;String&gt; classList = rr.<span style="color:#007f7f">scan</span>(res -&gt; {
</span></span><span style="display:flex;"><span>    String name = res.<span style="color:#007f7f">name</span>(); <span style="color:#007f7f">// 资源名称&#34;org/example/Hello.class&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (name.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.class&#34;</span>)) { <span style="color:#007f7f">// 如果以.class结尾
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 把&#34;org/example/Hello.class&#34;变为&#34;org.example.Hello&#34;:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> name.<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">0</span>, name.<span style="color:#007f7f">length</span>() - <span style="color:#ff0;font-weight:bold">6</span>).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;\\&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 否则返回null表示不是有效的Class Name:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样，<code>ResourceResolver</code>只负责扫描并列出所有文件，由客户端决定是找出<code>.class</code>文件，还是找出<code>.properties</code>文件。</p>
<p>在ClassPath中扫描文件的代码是固定模式，可以在网上搜索获得，例如StackOverflow的<a href="https://stackoverflow.com/questions/520328/can-you-find-all-classes-in-a-package-using-reflection#58773038">这个回答</a>。这里要注意的一点是，Java支持在jar包中搜索文件，所以，不但需要在普通目录中搜索，也需要在Classpath中列出的jar包中搜索，核心代码如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 通过ClassLoader获取URL列表:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Enumeration&lt;URL&gt; en = getContextClassLoader().<span style="color:#007f7f">getResources</span>(<span style="color:#0ff;font-weight:bold">&#34;org/example&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">while</span> (en.<span style="color:#007f7f">hasMoreElements</span>()) {
</span></span><span style="display:flex;"><span>    URL url = en.<span style="color:#007f7f">nextElement</span>();
</span></span><span style="display:flex;"><span>    URI uri = url.<span style="color:#007f7f">toURI</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (uri.<span style="color:#007f7f">toString</span>().<span style="color:#007f7f">startsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;file:&#34;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 在目录中搜索
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (uri.<span style="color:#007f7f">toString</span>().<span style="color:#007f7f">startsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;jar:&#34;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 在Jar包中搜索
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>几个要点：</p>
<ol>
<li>ClassLoader首先从<code>Thread.getContextClassLoader()</code>获取，如果获取不到，再从当前Class获取，因为Web应用的ClassLoader不是JVM提供的基于Classpath的ClassLoader，而是Servlet容器提供的ClassLoader，它不在默认的Classpath搜索，而是在<code>/WEB-INF/classes</code>目录和<code>/WEB-INF/lib</code>的所有jar包搜索，从<code>Thread.getContextClassLoader()</code>可以获取到Servlet容器专属的ClassLoader；</li>
<li>Windows和Linux/macOS的路径分隔符不同，前者是<code>\</code>，后者是<code>/</code>，需要正确处理；</li>
<li>扫描目录时，返回的路径可能是<code>abc/xyz</code>，也可能是<code>abc/xyz/</code>，需要注意处理末尾的<code>/</code>。</li>
</ol>
<p>这样我们就完成了能扫描指定包以及子包下所有文件的<code>ResourceResolver</code>。</p>
<h2 id="实现propertyresolver">实现PropertyResolver<a hidden class="anchor" aria-hidden="true" href="#实现propertyresolver">#</a></h2>
<p>Spring的注入分为<code>@Autowired</code>和<code>@Value</code>两种。对于<code>@Autowired</code>，涉及到Bean的依赖，而对于<code>@Value</code>，则仅仅是将对应的配置注入，不涉及Bean的依赖，相对比较简单。为了注入配置，我们用<code>PropertyResolver</code>保存所有配置项，对外提供查询功能。</p>
<p>本节我们来实现<code>PropertyResolver</code>，它支持3种查询方式：</p>
<ol>
<li>按配置的key查询，例如：<code>getProperty(&quot;app.title&quot;)</code>;</li>
<li>以<code>${abc.xyz}</code>形式的查询，例如，<code>getProperty(&quot;${app.title}&quot;)</code>，常用于<code>@Value(&quot;${app.title}&quot;)</code>注入；</li>
<li>带默认值的，以<code>${abc.xyz:defaultValue}</code>形式的查询，例如，<code>getProperty(&quot;${app.title:Summer}&quot;)</code>，常用于<code>@Value(&quot;${app.title:Summer}&quot;)</code>注入。</li>
</ol>
<p>Java本身提供了按key-value查询的<code>Properties</code>，我们先传入<code>Properties</code>，内部按key-value存储：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PropertyResolver {
</span></span><span style="display:flex;"><span>    Map&lt;String, String&gt; properties = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> PropertyResolver(Properties props) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 存入环境变量:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">properties</span>.<span style="color:#007f7f">putAll</span>(System.<span style="color:#007f7f">getenv</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 存入Properties:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Set&lt;String&gt; names = props.<span style="color:#007f7f">stringPropertyNames</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (String name : names) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">properties</span>.<span style="color:#007f7f">put</span>(name, props.<span style="color:#007f7f">getProperty</span>(name));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样，我们在<code>PropertyResolver</code>内部，通过一个<code>Map&lt;String, String&gt;</code>存储了所有的配置项，包括环境变量。对于按key查询的功能，我们可以简单实现如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Nullable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> String getProperty(String key) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">properties</span>.<span style="color:#007f7f">get</span>(key);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>下一步，我们准备解析<code>${abc.xyz:defaultValue}</code>这样的key，先定义一个<code>PropertyExpr</code>，把解析后的key和defaultValue存储起来：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>record PropertyExpr(String key, String defaultValue) {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后按<code>${...}</code>解析：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>PropertyExpr parsePropertyExpr(String key) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (key.<span style="color:#007f7f">startsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;${&#34;</span>) &amp;&amp; key.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;}&#34;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 是否存在defaultValue?
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">int</span> n = key.<span style="color:#007f7f">indexOf</span>(<span style="color:#0ff;font-weight:bold">&#39;:&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (n == (-<span style="color:#ff0;font-weight:bold">1</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 没有defaultValue: ${key}
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String k = key.<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">2</span>, key.<span style="color:#007f7f">length</span>() - <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> PropertyExpr(k, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 有defaultValue: ${key:default}
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String k = key.<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">2</span>, n);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> PropertyExpr(k, key.<span style="color:#007f7f">substring</span>(n + <span style="color:#ff0;font-weight:bold">1</span>, key.<span style="color:#007f7f">length</span>() - <span style="color:#ff0;font-weight:bold">1</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们把<code>getProperty()</code>改造一下，即可实现查询<code>${abc.xyz:defaultValue}</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Nullable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> String getProperty(String key) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 解析${abc.xyz:defaultValue}:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    PropertyExpr keyExpr = parsePropertyExpr(key);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (keyExpr != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (keyExpr.<span style="color:#007f7f">defaultValue</span>() != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 带默认值查询:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> getProperty(keyExpr.<span style="color:#007f7f">key</span>(), keyExpr.<span style="color:#007f7f">defaultValue</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 不带默认值查询:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> getRequiredProperty(keyExpr.<span style="color:#007f7f">key</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 普通key查询:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String value = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">properties</span>.<span style="color:#007f7f">get</span>(key);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (value != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> parseValue(value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> value;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>每次查询到value后，我们递归调用<code>parseValue()</code>，这样就可以支持嵌套的key，例如：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>${app.<span style="color:#007f7f">title</span>:${APP_NAME:Summer}}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样可以先查询<code>app.title</code>，没有找到就再查询<code>APP_NAME</code>，还没有找到就返回默认值<code>Summer</code>。</p>
<p>注意到Spring的<code>${...}</code>表达式实际上可以做到组合，例如：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>jdbc.<span style="color:#007f7f">url</span>=jdbc:mysql<span style="color:#007f7f">//${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME}
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>而我们实现的<code>${...}</code>表达式只能嵌套，不能组合，因为要实现Spring的表达式，需要编写一个完整的能解析表达式的复杂功能，而不能仅仅依靠判断<code>${</code>开头、<code>}</code>结尾。由于解析表达式的功能过于复杂，因此我们决定不予支持。</p>
<p>Spring还支持更复杂的<code>#{...}</code>表达式，它可以引用Bean、调用方法、计算等：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f00">#</span>{appBean.<span style="color:#007f7f">version</span>() + <span style="color:#ff0;font-weight:bold">1</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>为此Spring专门提供了一个<code>spring-expression</code>库来支持这种更复杂的功能。按照一切从简的原则，我们不支持<code>#{...}</code>表达式。</p>
<h3 id="实现类型转换">实现类型转换<a hidden class="anchor" aria-hidden="true" href="#实现类型转换">#</a></h3>
<p>除了String类型外，@Value注入时，还允许<code>boolean</code>、<code>int</code>、<code>Long</code>等基本类型和包装类型。此外，Spring还支持<code>Date</code>、<code>Duration</code>等类型的注入。我们既要实现类型转换，又不能写死，否则，将来支持新的类型时就要改代码。</p>
<p>我们先写类型转换的入口查询：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Nullable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T getProperty(String key, Class&lt;T&gt; targetType) {
</span></span><span style="display:flex;"><span>    String value = getProperty(key);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (value == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 转换为指定类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> convert(targetType, value);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>再考虑如何实现<code>convert()</code>方法。对于类型转换，实际上是从String转换为指定类型，因此，用函数式接口<code>Function&lt;String, Object&gt;</code>就很合适：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PropertyResolver {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 存储Class -&gt; Function:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Map&lt;Class&lt;?&gt;, Function&lt;String, Object&gt;&gt; converters = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 转换到指定Class类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    &lt;T&gt; T convert(Class&lt;?&gt; clazz, String value) {
</span></span><span style="display:flex;"><span>        Function&lt;String, Object&gt; fn = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">converters</span>.<span style="color:#007f7f">get</span>(clazz);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (fn == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalArgumentException(<span style="color:#0ff;font-weight:bold">&#34;Unsupported value type: &#34;</span> + clazz.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> (T) fn.<span style="color:#007f7f">apply</span>(value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样我们就已经实现了类型转换，下一步是把各种要转换的类型放到<code>Map</code>里。在构造方法中，我们放入常用的基本类型转换器：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> PropertyResolver(Properties props) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// String类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    converters.<span style="color:#007f7f">put</span>(String.<span style="color:#007f7f">class</span>, s -&gt; s);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// boolean类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    converters.<span style="color:#007f7f">put</span>(<span style="color:#fff;font-weight:bold">boolean</span>.<span style="color:#007f7f">class</span>, s -&gt; Boolean.<span style="color:#007f7f">parseBoolean</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(Boolean.<span style="color:#007f7f">class</span>, s -&gt; Boolean.<span style="color:#007f7f">valueOf</span>(s));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// int类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    converters.<span style="color:#007f7f">put</span>(<span style="color:#fff;font-weight:bold">int</span>.<span style="color:#007f7f">class</span>, s -&gt; Integer.<span style="color:#007f7f">parseInt</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(Integer.<span style="color:#007f7f">class</span>, s -&gt; Integer.<span style="color:#007f7f">valueOf</span>(s));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 其他基本类型...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// Date/Time类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    converters.<span style="color:#007f7f">put</span>(LocalDate.<span style="color:#007f7f">class</span>, s -&gt; LocalDate.<span style="color:#007f7f">parse</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(LocalTime.<span style="color:#007f7f">class</span>, s -&gt; LocalTime.<span style="color:#007f7f">parse</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(LocalDateTime.<span style="color:#007f7f">class</span>, s -&gt; LocalDateTime.<span style="color:#007f7f">parse</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(ZonedDateTime.<span style="color:#007f7f">class</span>, s -&gt; ZonedDateTime.<span style="color:#007f7f">parse</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(Duration.<span style="color:#007f7f">class</span>, s -&gt; Duration.<span style="color:#007f7f">parse</span>(s));
</span></span><span style="display:flex;"><span>    converters.<span style="color:#007f7f">put</span>(ZoneId.<span style="color:#007f7f">class</span>, s -&gt; ZoneId.<span style="color:#007f7f">of</span>(s));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果再加一个<code>registerConverter()</code>接口，我们就可以对外提供扩展，让用户自己编写自己定制的Converter，这样一来，我们的PropertyResolver就准备就绪，读取配置的初始化代码如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// Java标准库读取properties文件:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Properties props = <span style="color:#fff;font-weight:bold">new</span> Properties();
</span></span><span style="display:flex;"><span>props.<span style="color:#007f7f">load</span>(fileInput); <span style="color:#007f7f">// 文件输入流
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// 构造PropertyResolver:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>PropertyResolver pr = <span style="color:#fff;font-weight:bold">new</span> PropertyResolver(props);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 后续代码调用...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// pr.getProperty(&#34;${app.version:1}&#34;, int.class)
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用yaml配置">使用YAML配置<a hidden class="anchor" aria-hidden="true" href="#使用yaml配置">#</a></h3>
<p>Spring Framework并不支持YAML配置，但Spring Boot支持。因为YAML配置比<code>.properties</code>要方便，所以我们把对YAML的支持也集成进来。</p>
<p>首先引入依赖<code>org.yaml:snakeyaml:2.0</code>，然后我们写一个<code>YamlUtils</code>，通过<code>loadYamlAsPlainMap()</code>方法读取一个YAML文件，并返回<code>Map</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> YamlUtils {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Map&lt;String, Object&gt; loadYamlAsPlainMap(String path) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们把YAML格式：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>app:
</span></span><span style="display:flex;"><span>  title: Summer Framework
</span></span><span style="display:flex;"><span>  version: ${VER:<span style="color:#ff0;font-weight:bold">1.0</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>读取为<code>Map</code>，其中，每个key都是完整路径，相当于把它变为<code>.properties</code>格式：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>app.<span style="color:#007f7f">title</span>=Summer Framework
</span></span><span style="display:flex;"><span>app.<span style="color:#007f7f">version</span>=${VER:<span style="color:#ff0;font-weight:bold">1.0</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样我们无需改动<code>PropertyResolver</code>的代码，使用YAML时，可以按如下方式读取配置：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Map&lt;String, Object&gt; configs = YamlUtils.<span style="color:#007f7f">loadYamlAsPlainMap</span>(<span style="color:#0ff;font-weight:bold">&#34;/application.yml&#34;</span>);
</span></span><span style="display:flex;"><span>Properties props = <span style="color:#fff;font-weight:bold">new</span> Properties();
</span></span><span style="display:flex;"><span>props.<span style="color:#007f7f">putAll</span>(config);
</span></span><span style="display:flex;"><span>PropertyResolver pr = <span style="color:#fff;font-weight:bold">new</span> PropertyResolver(props);
</span></span></code></pre></td></tr></table>
</div>
</div><p>读取YAML的代码比较简单，注意要点如下：</p>
<ol>
<li>SnakeYaml默认读出的结构是树形结构，需要“拍平”成<code>abc.xyz</code>格式的key；</li>
<li>SnakeYaml默认会自动转换<code>int</code>、<code>boolean</code>等value，需要禁用自动转换，把所有value均按<code>String</code>类型返回。</li>
</ol>
<h2 id="创建beandefinition">创建BeanDefinition<a hidden class="anchor" aria-hidden="true" href="#创建beandefinition">#</a></h2>
<p>现在，我们可以用<code>ResourceResolver</code>扫描Class，用<code>PropertyResolver</code>获取配置，下面，我们开始实现IoC容器。</p>
<p>在IoC容器中，每个Bean都有一个唯一的名字标识。Spring还允许为一个Bean定义多个名字，这里我们简化一下，一个Bean只允许一个名字，因此，很容易想到用一个<code>Map&lt;String, Object&gt;</code>保存所有的Bean：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext {
</span></span><span style="display:flex;"><span>    Map&lt;String, Object&gt; beans;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这么做不是不可以，但是丢失了大量Bean的定义信息，不便于我们创建Bean以及解析依赖关系。合理的方式是先定义<code>BeanDefinition</code>，它能从Annotation中提取到足够的信息，便于后续创建Bean、设置依赖、调用初始化方法等：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BeanDefinition {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 全局唯一的Bean Name:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Bean的声明类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Class&lt;?&gt; beanClass;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Bean的实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Object instance = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 构造方法/null:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Constructor&lt;?&gt; constructor;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 工厂方法名称/null:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String factoryName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 工厂方法/null:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Method factoryMethod;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Bean的顺序:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">int</span> order;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 是否标识@Primary:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">boolean</span> primary;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// init/destroy方法名称:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String initMethodName;
</span></span><span style="display:flex;"><span>    String destroyMethodName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// init/destroy方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Method initMethod;
</span></span><span style="display:flex;"><span>    Method destroyMethod;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于自己定义的带<code>@Component</code>注解的Bean，我们需要获取Class类型，获取构造方法来创建Bean，然后收集<code>@PostConstruct</code>和<code>@PreDestroy</code>标注的初始化与销毁的方法，以及其他信息，如<code>@Order</code>定义Bean的内部排序顺序，<code>@Primary</code>定义存在多个相同类型时返回哪个“主要”Bean。一个典型的定义如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Hello {
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> init() {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PreDestroy
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> destroy() {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于<code>@Configuration</code>定义的<code>@Bean</code>方法，我们把它看作Bean的工厂方法，我们需要获取方法返回值作为Class类型，方法本身作为创建Bean的<code>factoryMethod</code>，然后收集<code>@Bean</code>定义的<code>initMethod</code>和<code>destroyMethod</code>标识的初始化于销毁的方法名，以及其他<code>@Order</code>、<code>@Primary</code>等信息。一个典型的定义如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>    @Bean(initMethod=<span style="color:#0ff;font-weight:bold">&#34;init&#34;</span>, destroyMethod=<span style="color:#0ff;font-weight:bold">&#34;close&#34;</span>)
</span></span><span style="display:flex;"><span>    DataSource createDataSource() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> HikariDataSource(...);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bean的声明类型">Bean的声明类型<a hidden class="anchor" aria-hidden="true" href="#bean的声明类型">#</a></h3>
<p>这里我们要特别注意一点，就是Bean的声明类型。对于<code>@Component</code>定义的Bean，它的声明类型就是其Class本身。然而，对于用<code>@Bean</code>工厂方法创建的Bean，它的声明类型与实际类型不一定是同一类型。上述<code>createDataSource()</code>定义的Bean，声明类型是<code>DataSource</code>，实际类型却是某个子类，例如<code>HikariDataSource</code>，因此要特别注意，我们在<code>BeanDefinition</code>中，存储的<code>beanClass</code>是<strong>声明类型</strong>，实际类型不必存储，因为可以通过<code>instance.getClass()</code>获得：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BeanDefinition {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Bean的声明类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Class&lt;?&gt; beanClass;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Bean的实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Object instance = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这也引出了下一个问题：如果我们按照名字查找Bean或BeanDefinition，要么拿到唯一实例，要么不存在，即通过查询<code>Map&lt;String, BeanDefinition&gt;</code>即可完成：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext {
</span></span><span style="display:flex;"><span>    Map&lt;String, BeanDefinition&gt; beans;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 根据Name查找BeanDefinition，如果Name不存在，返回null
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Nullable
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> BeanDefinition findBeanDefinition(String name) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">get</span>(name);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是通过类型查找Bean或BeanDefinition，我们没法定义一个<code>Map&lt;Class, BeanDefinition&gt;</code>，原因就是Bean的声明类型与实际类型不一定相符，举个例子：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    AtomicInteger counter() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> AtomicInteger();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    Number bigInt() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> BigInteger(<span style="color:#0ff;font-weight:bold">&#34;1000000000&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>当我们调用<code>getBean(AtomicInteger.class)</code>时，我们会获得<code>counter()</code>方法创建的唯一实例，但是，当我们调用<code>getBean(Number.class)</code>时，<code>counter()</code>方法和<code>bigInt()</code>方法创建的实例均符合要求，此时，如果有且仅有一个标注了<code>@Primary</code>，就返回标注了<code>@Primary</code>的Bean，否则，直接报<code>NoUniqueBeanDefinitionException</code>错误。</p>
<p>因此，对于<code>getBean(Class)</code>方法，必须遍历找出所有符合类型的Bean，如果不唯一，再判断<code>@Primary</code>，才能返回唯一Bean或报错。</p>
<p>我们编写一个找出所有类型的<code>findBeanDefinitions(Class)</code>方法如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 根据Type查找若干个BeanDefinition，返回0个或多个:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>List&lt;BeanDefinition&gt; findBeanDefinitions(Class&lt;?&gt; type) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 按类型过滤:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        .<span style="color:#007f7f">filter</span>(def -&gt; type.<span style="color:#007f7f">isAssignableFrom</span>(def.<span style="color:#007f7f">getBeanClass</span>()))
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 排序:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        .<span style="color:#007f7f">sorted</span>().<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们再编写一个<code>findBeanDefinition(Class)</code>方法如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 根据Type查找某个BeanDefinition，如果不存在返回null，如果存在多个返回@Primary标注的一个:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@Nullable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> BeanDefinition findBeanDefinition(Class&lt;?&gt; type) {
</span></span><span style="display:flex;"><span>    List&lt;BeanDefinition&gt; defs = findBeanDefinitions(type);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (defs.<span style="color:#007f7f">isEmpty</span>()) { <span style="color:#007f7f">// 没有找到任何BeanDefinition
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (defs.<span style="color:#007f7f">size</span>() == <span style="color:#ff0;font-weight:bold">1</span>) { <span style="color:#007f7f">// 找到唯一一个
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> defs.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 多于一个时，查找@Primary:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;BeanDefinition&gt; primaryDefs = defs.<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">filter</span>(def -&gt; def.<span style="color:#007f7f">isPrimary</span>()).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (primaryDefs.<span style="color:#007f7f">size</span>() == <span style="color:#ff0;font-weight:bold">1</span>) { <span style="color:#007f7f">// @Primary唯一
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> primaryDefs.<span style="color:#007f7f">get</span>(<span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (primaryDefs.<span style="color:#007f7f">isEmpty</span>()) { <span style="color:#007f7f">// 不存在@Primary
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> NoUniqueBeanDefinitionException(String.<span style="color:#007f7f">format</span>(<span style="color:#0ff;font-weight:bold">&#34;Multiple bean with type &#39;%s&#39; found, but no @Primary specified.&#34;</span>, type.<span style="color:#007f7f">getName</span>()));
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> { <span style="color:#007f7f">// @Primary不唯一
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> NoUniqueBeanDefinitionException(String.<span style="color:#007f7f">format</span>(<span style="color:#0ff;font-weight:bold">&#34;Multiple bean with type &#39;%s&#39; found, and multiple @Primary specified.&#34;</span>, type.<span style="color:#007f7f">getName</span>()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，我们已经定义好了数据结构，下面开始获取所有<code>BeanDefinition</code>信息，实际分两步：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext {
</span></span><span style="display:flex;"><span>    Map&lt;String, BeanDefinition&gt; beans;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> AnnotationConfigApplicationContext(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 扫描获取所有Bean的Class类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Set&lt;String&gt; beanClassNames = scanForClassNames(configClass);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 创建Bean的定义:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span> = createBeanDefinitions(beanClassNames);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>第一步是扫描指定包下的所有Class，然后返回Class名字，这一步比较简单：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Set&lt;String&gt; scanForClassNames(Class&lt;?&gt; configClass) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 获取@ComponentScan注解:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ComponentScan scan = ClassUtils.<span style="color:#007f7f">findAnnotation</span>(configClass, ComponentScan.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 获取注解配置的package名字,未配置则默认当前类所在包:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String[] scanPackages = scan == <span style="color:#fff;font-weight:bold">null</span> || scan.<span style="color:#007f7f">value</span>().<span style="color:#007f7f">length</span> == <span style="color:#ff0;font-weight:bold">0</span> ? <span style="color:#fff;font-weight:bold">new</span> String[] { configClass.<span style="color:#007f7f">getPackage</span>().<span style="color:#007f7f">getName</span>() } : scan.<span style="color:#007f7f">value</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Set&lt;String&gt; classNameSet = <span style="color:#fff;font-weight:bold">new</span> HashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 依次扫描所有包:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (String pkg : scanPackages) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">atDebug</span>().<span style="color:#007f7f">log</span>(<span style="color:#0ff;font-weight:bold">&#34;scan package: {}&#34;</span>, pkg);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 扫描一个包:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        var rr = <span style="color:#fff;font-weight:bold">new</span> ResourceResolver(pkg);
</span></span><span style="display:flex;"><span>        List&lt;String&gt; classList = rr.<span style="color:#007f7f">scan</span>(res -&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 遇到以.class结尾的文件，就将其转换为Class全名:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String name = res.<span style="color:#007f7f">name</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (name.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.class&#34;</span>)) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> name.<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">0</span>, name.<span style="color:#007f7f">length</span>() - <span style="color:#ff0;font-weight:bold">6</span>).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;\\&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 扫描结果添加到Set:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        classNameSet.<span style="color:#007f7f">addAll</span>(classList);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 继续查找@Import(Xyz.class)导入的Class配置:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Import importConfig = configClass.<span style="color:#007f7f">getAnnotation</span>(Import.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (importConfig != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (Class&lt;?&gt; importConfigClass : importConfig.<span style="color:#007f7f">value</span>()) {
</span></span><span style="display:flex;"><span>            String importClassName = importConfigClass.<span style="color:#007f7f">getName</span>();
</span></span><span style="display:flex;"><span>            classNameSet.<span style="color:#007f7f">add</span>(importClassName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> classNameSet;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意到扫描结果是指定包的所有Class名称，以及通过<code>@Import</code>导入的Class名称，下一步才会真正处理各种注解：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Map&lt;String, BeanDefinition&gt; createBeanDefinitions(Set&lt;String&gt; classNameSet) {
</span></span><span style="display:flex;"><span>    Map&lt;String, BeanDefinition&gt; defs = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (String className : classNameSet) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 获取Class:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Class&lt;?&gt; clazz = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            clazz = Class.<span style="color:#007f7f">forName</span>(className);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (ClassNotFoundException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanCreationException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 是否标注@Component?
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Component component = ClassUtils.<span style="color:#007f7f">findAnnotation</span>(clazz, Component.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (component != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 获取Bean的名称:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String beanName = ClassUtils.<span style="color:#007f7f">getBeanName</span>(clazz);
</span></span><span style="display:flex;"><span>            var def = <span style="color:#fff;font-weight:bold">new</span> BeanDefinition(
</span></span><span style="display:flex;"><span>                beanName, clazz, getSuitableConstructor(clazz),
</span></span><span style="display:flex;"><span>                getOrder(clazz), clazz.<span style="color:#007f7f">isAnnotationPresent</span>(Primary.<span style="color:#007f7f">class</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// init/destroy方法名称:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">null</span>, <span style="color:#fff;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 查找@PostConstruct方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                ClassUtils.<span style="color:#007f7f">findAnnotationMethod</span>(clazz, PostConstruct.<span style="color:#007f7f">class</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 查找@PreDestroy方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                ClassUtils.<span style="color:#007f7f">findAnnotationMethod</span>(clazz, PreDestroy.<span style="color:#007f7f">class</span>));
</span></span><span style="display:flex;"><span>            addBeanDefinitions(defs, def);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 查找是否有@Configuration:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Configuration configuration = ClassUtils.<span style="color:#007f7f">findAnnotation</span>(clazz, Configuration.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (configuration != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 查找@Bean方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                scanFactoryMethods(beanName, clazz, defs);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> defs;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上述代码需要注意的一点是，查找<code>@Component</code>时，并不是简单地在Class定义查看<code>@Component</code>注解，因为Spring的<code>@Component</code>是可以扩展的，例如，标记为<code>Controller</code>的Class也符合要求：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MvcController {...}
</span></span></code></pre></td></tr></table>
</div>
</div><p>原因就在于，<code>@Controller</code>注解的定义包含了<code>@Component</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Target(ElementType.<span style="color:#007f7f">TYPE</span>)
</span></span><span style="display:flex;"><span>@Retention(RetentionPolicy.<span style="color:#007f7f">RUNTIME</span>)
</span></span><span style="display:flex;"><span>@Documented
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> @interface Controller {
</span></span><span style="display:flex;"><span>    String value() <span style="color:#fff;font-weight:bold">default</span> <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以，判断是否存在<code>@Component</code>，不但要在当前类查找<code>@Component</code>，还要在当前类的所有注解上，查找该注解是否有<code>@Component</code>，因此，我们编写了一个能递归查找注解的方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ClassUtils {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> &lt;A <span style="color:#fff;font-weight:bold">extends</span> Annotation&gt; A findAnnotation(Class&lt;?&gt; target, Class&lt;A&gt; annoClass) {
</span></span><span style="display:flex;"><span>        A a = target.<span style="color:#007f7f">getAnnotation</span>(annoClass);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (Annotation anno : target.<span style="color:#007f7f">getAnnotations</span>()) {
</span></span><span style="display:flex;"><span>            Class&lt;? <span style="color:#fff;font-weight:bold">extends</span> Annotation&gt; annoType = anno.<span style="color:#007f7f">annotationType</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (!annoType.<span style="color:#007f7f">getPackageName</span>().<span style="color:#007f7f">equals</span>(<span style="color:#0ff;font-weight:bold">&#34;java.lang.annotation&#34;</span>)) {
</span></span><span style="display:flex;"><span>                A found = findAnnotation(annoType, annoClass);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (found != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (a != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanDefinitionException(<span style="color:#0ff;font-weight:bold">&#34;Duplicate @&#34;</span> + annoClass.<span style="color:#007f7f">getSimpleName</span>() + <span style="color:#0ff;font-weight:bold">&#34; found on class &#34;</span> + target.<span style="color:#007f7f">getSimpleName</span>());
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    a = found;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> a;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>带有<code>@Configuration</code>注解的Class，视为Bean的工厂，我们需要继续在<code>scanFactoryMethods()</code>中查找<code>@Bean</code>标注的方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> scanFactoryMethods(String factoryBeanName, Class&lt;?&gt; clazz, Map&lt;String, BeanDefinition&gt; defs) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (Method method : clazz.<span style="color:#007f7f">getDeclaredMethods</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 是否带有@Bean标注:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Bean bean = method.<span style="color:#007f7f">getAnnotation</span>(Bean.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (bean != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Bean的声明类型是方法返回类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Class&lt;?&gt; beanClass = method.<span style="color:#007f7f">getReturnType</span>();
</span></span><span style="display:flex;"><span>            var def = <span style="color:#fff;font-weight:bold">new</span> BeanDefinition(
</span></span><span style="display:flex;"><span>                ClassUtils.<span style="color:#007f7f">getBeanName</span>(method), beanClass,
</span></span><span style="display:flex;"><span>                factoryBeanName,
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 创建Bean的工厂方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                method,
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// @Order
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                getOrder(method),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 是否存在@Primary标注?
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                method.<span style="color:#007f7f">isAnnotationPresent</span>(Primary.<span style="color:#007f7f">class</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// init方法名称:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                bean.<span style="color:#007f7f">initMethod</span>().<span style="color:#007f7f">isEmpty</span>() ? <span style="color:#fff;font-weight:bold">null</span> : bean.<span style="color:#007f7f">initMethod</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// destroy方法名称:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                bean.<span style="color:#007f7f">destroyMethod</span>().<span style="color:#007f7f">isEmpty</span>() ? <span style="color:#fff;font-weight:bold">null</span> : bean.<span style="color:#007f7f">destroyMethod</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// @PostConstruct / @PreDestroy方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">null</span>, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>            addBeanDefinitions(defs, def);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意到<code>@Configuration</code>注解本身又用<code>@Component</code>注解修饰了，因此，对于一个<code>@Configuration</code>来说：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DateTimeConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    LocalDateTime local() { <span style="color:#fff;font-weight:bold">return</span> LocalDateTime.<span style="color:#007f7f">now</span>(); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    ZonedDateTime zoned() { <span style="color:#fff;font-weight:bold">return</span> ZonedDateTime.<span style="color:#007f7f">now</span>(); }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>实际上创建了3个<code>BeanDefinition</code>：</p>
<ul>
<li>DateTimeConfig本身；</li>
<li>LocalDateTime；</li>
<li>ZonedDateTime。</li>
</ul>
<p>不创建<code>DateTimeConfig</code>行不行？不行，因为后续没有<code>DateTimeConfig</code>的实例，无法调用<code>local()</code>和<code>zoned()</code>方法。因为当前我们只创建了<code>BeanDefinition</code>，所以对于<code>LocalDateTime</code>和<code>ZonedDateTime</code>的<code>BeanDefinition</code>来说，还必须保存<code>DateTimeConfig</code>的名字，将来才能通过名字查找<code>DateTimeConfig</code>的实例。</p>
<p>有的同学注意到我们同时存储了<code>initMethodName</code>和<code>initMethod</code>，以及<code>destroyMethodName</code>和<code>destroyMethod</code>，这是因为在<code>@Component</code>声明的Bean中，我们可以根据<code>@PostConstruct</code>和<code>@PreDestroy</code>直接拿到Method本身，而在<code>@Bean</code>声明的Bean中，我们拿不到Method，只能从<code>@Bean</code>注解提取出字符串格式的方法名称，因此，存储在<code>BeanDefinition</code>的方法名称与方法，其中总有一个为<code>null</code>。</p>
<p>最后，仔细编写<code>BeanDefinition</code>的<code>toString()</code>方法，使之能打印出详细的信息。我们编写测试，运行，打印出每个<code>BeanDefinition</code>如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>define bean: BeanDefinition [name=annotationDestroyBean, beanClass=com.<span style="color:#007f7f">itranswarp</span>.<span style="color:#007f7f">scan</span>.<span style="color:#007f7f">destroy</span>.<span style="color:#007f7f">AnnotationDestroyBean</span>, factory=<span style="color:#fff;font-weight:bold">null</span>, init-method=<span style="color:#fff;font-weight:bold">null</span>, destroy-method=destroy, primary=<span style="color:#fff;font-weight:bold">false</span>, instance=<span style="color:#fff;font-weight:bold">null</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>define bean: BeanDefinition [name=nestedBean, beanClass=com.<span style="color:#007f7f">itranswarp</span>.<span style="color:#007f7f">scan</span>.<span style="color:#007f7f">nested</span>.<span style="color:#007f7f">OuterBean$NestedBean</span>, factory=<span style="color:#fff;font-weight:bold">null</span>, init-method=<span style="color:#fff;font-weight:bold">null</span>, destroy-method=<span style="color:#fff;font-weight:bold">null</span>, primary=<span style="color:#fff;font-weight:bold">false</span>, instance=<span style="color:#fff;font-weight:bold">null</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>define bean: BeanDefinition [name=createSpecifyInitBean, beanClass=com.<span style="color:#007f7f">itranswarp</span>.<span style="color:#007f7f">scan</span>.<span style="color:#007f7f">init</span>.<span style="color:#007f7f">SpecifyInitBean</span>, factory=SpecifyInitConfiguration.<span style="color:#007f7f">createSpecifyInitBean</span>(String, String), init-method=<span style="color:#fff;font-weight:bold">null</span>, destroy-method=<span style="color:#fff;font-weight:bold">null</span>, primary=<span style="color:#fff;font-weight:bold">false</span>, instance=<span style="color:#fff;font-weight:bold">null</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，我们已经能扫描并创建所有的<code>BeanDefinition</code>，只是目前每个<code>BeanDefinition</code>内部的<code>instance</code>还是<code>null</code>，因为我们后续才会创建真正的Bean。</p>
<h2 id="创建bean实例">创建Bean实例<a hidden class="anchor" aria-hidden="true" href="#创建bean实例">#</a></h2>
<p>当我们拿到所有<code>BeanDefinition</code>之后，就可以开始创建Bean的实例了。</p>
<p>在创建Bean实例之前，我们先看看Spring支持的4种依赖注入模式：</p>
<ol>
<li>构造方法注入，例如：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Hello {
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Hello(@Autowired JdbcTemplate jdbcTemplate) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">jdbcTemplate</span> = jdbcTemplate;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>工厂方法注入，例如：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    Hello hello(@Autowired JdbcTemplate jdbcTemplate) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> Hello(jdbcTemplate);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>Setter方法注入，例如：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Hello {
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> setJdbcTemplate(JdbcTemplate jdbcTemplate) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">jdbcTemplate</span> = jdbcTemplate;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>字段注入，例如：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Hello {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然而我们仔细分析，发现这4种注入方式实际上是有区别的。</p>
<p>区别就在于，前两种方式，即构造方法注入和工厂方法注入，Bean的创建与注入是一体的，我们无法把它们分成两个阶段，因为无法中断方法内部代码的执行。而后两种方式，即Setter方法注入和属性注入，Bean的创建与注入是可以分开的，即先创建Bean实例，再用反射调用方法或字段，完成注入。</p>
<p>我们再分析一下循环依赖的问题。循环依赖，即A、B互相依赖，或者A依赖B，B依赖C，C依赖A，形成了一个闭环。IoC容器对Bean进行管理，可以解决部分循环依赖问题，但不是所有循环依赖都能解决。</p>
<p>我们先来看不能解决的循环依赖问题，假定下列代码定义的A、B两个Bean：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> A {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> B b;
</span></span><span style="display:flex;"><span>    A(B b) { <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">b</span> = b; }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> B {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> A a;
</span></span><span style="display:flex;"><span>    B(A a) { <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">a</span> = a; }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这种通过构造方法注入依赖的两个Bean，如果存在循环依赖，是无解的，因为我们不用IoC，自己写Java代码也写不出正确创建两个Bean实例的代码。</p>
<p>因此，我们把构造方法注入和工厂方法注入的依赖称为强依赖，不能有强依赖的循环依赖，否则只能报错。</p>
<p>后两种注入方式形成的依赖则是弱依赖，假定下列代码定义的A、B两个Bean：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> A {
</span></span><span style="display:flex;"><span>    B b;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> B {
</span></span><span style="display:flex;"><span>    A a;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这种循环依赖则很容易解决，因为我们可以分两步，先分别实例化Bean，再注入依赖：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 第一步,实例化:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>A a = <span style="color:#fff;font-weight:bold">new</span> A();
</span></span><span style="display:flex;"><span>B b = <span style="color:#fff;font-weight:bold">new</span> B();
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 第二步,注入:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>a.<span style="color:#007f7f">b</span> = b;
</span></span><span style="display:flex;"><span>b.<span style="color:#007f7f">a</span> = a;
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以，对于IoC容器来说，创建Bean的过程分两步：</p>
<ol>
<li>创建Bean的实例，此时必须注入强依赖；</li>
<li>对Bean实例进行Setter方法注入和字段注入。</li>
</ol>
<p>第一步如果遇到循环依赖则直接报错，第二步则不需要关心有没有循环依赖。</p>
<p>我们先实现第一步：创建Bean的实例，同时注入强依赖。</p>
<p>在上一节代码中，我们已经获得了所有的<code>BeanDefinition</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext {
</span></span><span style="display:flex;"><span>    PropertyResolver propertyResolver;
</span></span><span style="display:flex;"><span>    Map&lt;String, BeanDefinition&gt; beans;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> AnnotationConfigApplicationContext(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span> = propertyResolver;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 扫描获取所有Bean的Class类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Set&lt;String&gt; beanClassNames = scanForClassNames(configClass);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 创建Bean的定义:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span> = createBeanDefinitions(beanClassNames);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>下一步是创建Bean的实例，同时注入强依赖。此阶段必须检测循环依赖。检测循环依赖其实非常简单，就是定义一个<code>Set&lt;String&gt;</code>跟踪当前正在创建的所有Bean的名称：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext {
</span></span><span style="display:flex;"><span>    Set&lt;String&gt; creatingBeanNames;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建Bean实例我们用方法<code>createBeanAsEarlySingleton()</code>实现，在方法开始处检测循环依赖：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 创建一个Bean，但不进行字段和方法级别的注入。如果创建的Bean不是Configuration，则在构造方法/工厂方法中注入的依赖Bean会自动创建
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> Object createBeanAsEarlySingleton(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">creatingBeanNames</span>.<span style="color:#007f7f">add</span>(def.<span style="color:#007f7f">getName</span>())) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 检测到重复创建Bean导致的循环依赖:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> UnsatisfiedDependencyException();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于<code>@Configuration</code>标识的Bean实际上是工厂，它们必须先实例化，才能实例化其他普通Bean，所以我们先把<code>@Configuration</code>标识的Bean创建出来，再创建普通Bean：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> AnnotationConfigApplicationContext(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span> = propertyResolver;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 扫描获取所有Bean的Class类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Set&lt;String&gt; beanClassNames = scanForClassNames(configClass);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建Bean的定义:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span> = createBeanDefinitions(beanClassNames);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建BeanName检测循环依赖:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">creatingBeanNames</span> = <span style="color:#fff;font-weight:bold">new</span> HashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建@Configuration类型的Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 过滤出@Configuration:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">filter</span>(<span style="color:#fff;font-weight:bold">this</span>::isConfigurationDefinition).<span style="color:#007f7f">sorted</span>().<span style="color:#007f7f">map</span>(def -&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 创建Bean实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                createBeanAsEarlySingleton(def);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> def.<span style="color:#007f7f">getName</span>();
</span></span><span style="display:flex;"><span>            }).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建其他普通Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;BeanDefinition&gt; defs = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 过滤出instance==null的BeanDefinition:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">filter</span>(def -&gt; def.<span style="color:#007f7f">getInstance</span>() == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">sorted</span>().<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 依次创建Bean实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    defs.<span style="color:#007f7f">forEach</span>(def -&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 如果Bean未被创建(可能在其他Bean的构造方法注入前被创建):
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (def.<span style="color:#007f7f">getInstance</span>() == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 创建Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            createBeanAsEarlySingleton(def);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>剩下的工作就是把<code>createBeanAsEarlySingleton()</code>补充完整：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object createBeanAsEarlySingleton(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 检测循环依赖:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (!<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">creatingBeanNames</span>.<span style="color:#007f7f">add</span>(def.<span style="color:#007f7f">getName</span>())) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> UnsatisfiedDependencyException();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建方式：构造方法或工厂方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Executable createFn = def.<span style="color:#007f7f">getFactoryName</span>() == <span style="color:#fff;font-weight:bold">null</span> ?
</span></span><span style="display:flex;"><span>        def.<span style="color:#007f7f">getConstructor</span>() : def.<span style="color:#007f7f">getFactoryMethod</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建参数:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Parameter[] parameters = createFn.<span style="color:#007f7f">getParameters</span>();
</span></span><span style="display:flex;"><span>    Object[] args = <span style="color:#fff;font-weight:bold">new</span> Object[parameters.<span style="color:#007f7f">length</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; parameters.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 从参数获取@Value和@Autowired:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Value value = ...
</span></span><span style="display:flex;"><span>        Autowired autowired = ...
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 检查Value和Autowired
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 参数类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Class&lt;?&gt; type = param.<span style="color:#007f7f">getType</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (value != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 参数设置为查询的@Value:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            args[i] = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span>.<span style="color:#007f7f">getRequiredProperty</span>(value.<span style="color:#007f7f">value</span>(), type);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 参数是@Autowired,查找依赖的BeanDefinition:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            BeanDefinition dependsOnDef = name.<span style="color:#007f7f">isEmpty</span>() ? findBeanDefinition(type) : findBeanDefinition(name, type);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 获取依赖Bean的实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Object autowiredBeanInstance = dependsOnDef.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (autowiredBeanInstance == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 当前依赖Bean尚未初始化，递归调用初始化该依赖Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                autowiredBeanInstance = createBeanAsEarlySingleton(dependsOnDef);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 参数设置为依赖的Bean实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            args[i] = autowiredBeanInstance;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 已拿到所有方法参数,创建Bean实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Object instance = ...
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 设置实例到BeanDefinition:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    def.<span style="color:#007f7f">setInstance</span>(instance);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 返回实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> def.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意到递归调用：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object createBeanAsEarlySingleton(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    Object[] args = <span style="color:#fff;font-weight:bold">new</span> Object[parameters.<span style="color:#007f7f">length</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; parameters.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 获取依赖Bean的实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Object autowiredBeanInstance = dependsOnDef.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (autowiredBeanInstance == <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; !isConfiguration) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 当前依赖Bean尚未初始化，递归调用初始化该依赖Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            autowiredBeanInstance = createBeanAsEarlySingleton(dependsOnDef);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>假设如下的Bean依赖：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> A {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 依赖B,C:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    A(@Autowired B, @Autowired C) {}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> B {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 依赖C:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    B(@Autowired C) {}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> C {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 无依赖:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    C() {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果按照A、B、C的顺序创建Bean实例，那么系统流程如下：</p>
<ol>
<li>准备创建A；</li>
<li>检测到依赖B：未就绪；
<ol>
<li>准备创建B：</li>
<li>检测到依赖C：未就绪；
<ol>
<li>准备创建C；</li>
<li>完成创建C；</li>
</ol>
</li>
<li>完成创建B；</li>
</ol>
</li>
<li>检测到依赖C，已就绪；</li>
<li>完成创建A。</li>
</ol>
<p>如果按照B、C、A的顺序创建Bean实例，那么系统流程如下：</p>
<ol>
<li>准备创建B；</li>
<li>检测到依赖C：未就绪；
<ol>
<li>准备创建C；</li>
<li>完成创建C；</li>
</ol>
</li>
<li>完成创建B；</li>
<li>准备创建A；</li>
<li>检测到依赖B，已就绪；</li>
<li>检测到依赖C，已就绪；</li>
<li>完成创建A。</li>
</ol>
<p>可见无论以什么顺序创建，C总是最先被实例化，A总是最后被实例化。</p>
<h2 id="初始化bean">初始化Bean<a hidden class="anchor" aria-hidden="true" href="#初始化bean">#</a></h2>
<p>在创建Bean实例的过程中，我们已经完成了强依赖的注入。下一步，是根据Setter方法和字段完成弱依赖注入，接着调用用<code>@PostConstruct</code>标注的init方法，就完成了所有Bean的初始化。</p>
<p>这一步相对比较简单，因为只涉及到查找依赖的<code>@Value</code>和<code>@Autowired</code>，然后用反射完成调用即可：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> AnnotationConfigApplicationContext(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 通过字段和set方法注入依赖:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">forEach</span>(def -&gt; {
</span></span><span style="display:flex;"><span>        injectBean(def);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 调用init方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">forEach</span>(def -&gt; {
</span></span><span style="display:flex;"><span>        initBean(def);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用Setter方法和字段注入时，要注意一点，就是不仅要在当前类查找，还要在父类查找，因为有些<code>@Autowired</code>写在父类，所有子类都可使用，这样更方便。注入弱依赖代码如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 在当前类及父类进行字段和方法注入:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">void</span> injectProperties(BeanDefinition def, Class&lt;?&gt; clazz, Object bean) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 在当前类查找Field和Method并注入:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (Field f : clazz.<span style="color:#007f7f">getDeclaredFields</span>()) {
</span></span><span style="display:flex;"><span>        tryInjectProperties(def, clazz, bean, f);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (Method m : clazz.<span style="color:#007f7f">getDeclaredMethods</span>()) {
</span></span><span style="display:flex;"><span>        tryInjectProperties(def, clazz, bean, m);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 在父类查找Field和Method并注入:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Class&lt;?&gt; superClazz = clazz.<span style="color:#007f7f">getSuperclass</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (superClazz != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 递归调用:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        injectProperties(def, superClazz, bean);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 注入单个属性
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">void</span> tryInjectProperties(BeanDefinition def, Class&lt;?&gt; clazz, Object bean, AccessibleObject acc) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>弱依赖注入完成后，再循环一遍所有的<code>BeanDefinition</code>，对其调用<code>init</code>方法，完成最后一步初始化：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> initBean(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 调用init方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    callMethod(def.<span style="color:#007f7f">getInstance</span>(), def.<span style="color:#007f7f">getInitMethod</span>(), def.<span style="color:#007f7f">getInitMethodName</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>处理<code>@PreDestroy</code>方法更简单，在<code>ApplicationContext</code>关闭时遍历所有Bean，调用<code>destroy</code>方法即可。</p>
<h2 id="实现beanpostprocessor">实现BeanPostProcessor<a hidden class="anchor" aria-hidden="true" href="#实现beanpostprocessor">#</a></h2>
<p>现在，我们已经完成了扫描Class名称、创建BeanDefinition、创建Bean实例、初始化Bean，理论上一个可用的IoC容器就已经就绪。</p>
<p>然而，<code>BeanPostProcessor</code>的出现改变了这一切。Spring允许用户自定义一种特殊的Bean，即实现了<code>BeanPostProcessor</code>接口，它有什么用呢？其实就是替换Bean。我们举个例子，下面的代码是基于Spring代码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        var ctx = <span style="color:#fff;font-weight:bold">new</span> AnnotationConfigApplicationContext(AppConfig.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 可以获取到ZonedDateTime:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ZonedDateTime dt = ctx.<span style="color:#007f7f">getBean</span>(ZonedDateTime.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(dt);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 错误:NoSuchBeanDefinitionException:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(ctx.<span style="color:#007f7f">getBean</span>(LocalDateTime.<span style="color:#007f7f">class</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建LocalDateTime实例
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> LocalDateTime localDateTime() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> LocalDateTime.<span style="color:#007f7f">now</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 实现一个BeanPostProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Bean
</span></span><span style="display:flex;"><span>    BeanPostProcessor replaceLocalDateTime() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> BeanPostProcessor() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> Object postProcessBeforeInitialization(Object bean, String beanName) <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 将LocalDateTime类型实例替换为ZonedDateTime类型实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> (bean <span style="color:#fff;font-weight:bold">instanceof</span> LocalDateTime) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> ZonedDateTime.<span style="color:#007f7f">now</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行可知，我们定义的<code>@Bean</code>类型明明是<code>LocalDateTime</code>类型，但却被另一个<code>BeanPostProcessor</code>替换成了<code>ZonedDateTime</code>，于是，调用<code>getBean(ZonedDateTime.class)</code>可以拿到替换后的Bean，调用<code>getBean(LocalDateTime.class)</code>会报错，提示找不到Bean。那么原始的Bean哪去了？答案是被<code>BeanPostProcessor</code>扔掉了。</p>
<p>可见，<code>BeanPostProcessor</code>是一种特殊Bean，它的作用是根据条件替换某些Bean。上述的例子中，<code>LocalDateTime</code>被替换为<code>ZonedDateTime</code>其实没啥意义，但实际应用中，把原始Bean替换为代理后的Bean是非常常见的，比如下面的基于Spring的代码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        var ctx = <span style="color:#fff;font-weight:bold">new</span> AnnotationConfigApplicationContext(AppConfig.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        UserService u = ctx.<span style="color:#007f7f">getBean</span>(UserService.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(u.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getSimpleName</span>()); <span style="color:#007f7f">// UserServiceProxy
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        u.<span style="color:#007f7f">register</span>(<span style="color:#0ff;font-weight:bold">&#34;bob@example.com&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;bob12345&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    BeanPostProcessor createProxy() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> BeanPostProcessor() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> Object postProcessBeforeInitialization(Object bean, String beanName) <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 实现事务功能:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> (bean <span style="color:#fff;font-weight:bold">instanceof</span> UserService u) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> UserServiceProxy(u);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> register(String email, String password) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;INSERT INTO ...&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 代理类:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">class</span> UserServiceProxy <span style="color:#fff;font-weight:bold">extends</span> UserService {
</span></span><span style="display:flex;"><span>    UserService target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserServiceProxy(UserService target) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> register(String email, String password) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;begin tx&#34;</span>);
</span></span><span style="display:flex;"><span>        target.<span style="color:#007f7f">register</span>(email, password);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;commit tx&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果执行上述代码，打印出的Bean类型不是<code>UserService</code>，而是<code>UserServiceProxy</code>，因此，调用<code>register()</code>会打印出<code>begin tx</code>和<code>commit tx</code>，说明“事务”生效了。</p>
<p>迄今为止，创建Proxy似乎没有什么影响。让我们把代码再按实际情况扩展一下，<code>UserService</code>是用户编写的业务代码，需要注入<code>JdbcTemplate</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    @Autowired JdbcTemplate jdbcTemplate;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> register(String email, String password) {
</span></span><span style="display:flex;"><span>        jdbcTemplate.<span style="color:#007f7f">update</span>(<span style="color:#0ff;font-weight:bold">&#34;INSERT INTO ...&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>而<code>PostBeanProcessor</code>一般由框架本身提供事务功能，所以它会动态创建一个<code>UserServiceProxy</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> UserServiceProxy <span style="color:#fff;font-weight:bold">extends</span> UserService {
</span></span><span style="display:flex;"><span>    UserService target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserServiceProxy(UserService target) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> register(String email, String password) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;begin tx&#34;</span>);
</span></span><span style="display:flex;"><span>        target.<span style="color:#007f7f">register</span>(email, password);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;commit tx&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>调用用户注册的页面由<code>MvcController</code>控制，因此，将<code>UserService</code>注入到<code>MvcController</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> MvcController {
</span></span><span style="display:flex;"><span>    @Autowired UserService userService;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @PostMapping(<span style="color:#0ff;font-weight:bold">&#34;/register&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> register() {
</span></span><span style="display:flex;"><span>        userService.<span style="color:#007f7f">register</span>(...);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>一开始，由IoC容器创建的Bean包括：</p>
<ul>
<li>JdbcTemplate</li>
<li>UserService</li>
<li>MvcController</li>
</ul>
<p>接着，由于<code>BeanPostProcessor</code>的介入，原始的<code>UserService</code>被替换为<code>UserServiceProxy</code>：</p>
<ul>
<li>JdbcTemplate</li>
<li>UserServiceProxy</li>
<li>MvcController</li>
</ul>
<p>那么问题来了：注意到<code>UserServiceProxy</code>是从<code>UserService</code>继承的，它也有一个<code>@Autowired JdbcTemplate</code>，那<code>JdbcTemplate</code>实例应注入到原始的<code>UserService</code>还是<code>UserServiceProxy</code>？</p>
<p>从业务逻辑出发，<code>JdbcTemplate</code>实例必须注入到原始的<code>UserService</code>，否则，代理类<code>UserServiceProxy</code>执行<code>target.register()</code>时，相当于对原始的<code>UserService</code>调用<code>register()</code>方法，如果<code>JdbcTemplate</code>没有注入，将直接报<code>NullPointerException</code>错误。</p>
<p>这时第二个问题又来了：<code>MvcController</code>需要注入的<code>UserService</code>，应该是原始的<code>UserService</code>还是<code>UserServiceProxy</code>？</p>
<p>还是从业务逻辑出发，<code>MvcController</code>需要注入的<code>UserService</code>必须是<code>UserServiceProxy</code>，否则，事务不起作用。</p>
<p>我们用图描述一下注入关系：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>┌───────────────┐
</span></span><span style="display:flex;"><span>│MvcController  │
</span></span><span style="display:flex;"><span>├───────────────┤   ┌────────────────┐
</span></span><span style="display:flex;"><span>│- userService ─┼──▶│UserServiceProxy│
</span></span><span style="display:flex;"><span>└───────────────┘   ├────────────────┤
</span></span><span style="display:flex;"><span>                    │- jdbcTemplate  │
</span></span><span style="display:flex;"><span>                    ├────────────────┤   ┌────────────────┐
</span></span><span style="display:flex;"><span>                    │- target       ─┼──▶│UserService     │
</span></span><span style="display:flex;"><span>                    └────────────────┘   ├────────────────┤   ┌────────────┐
</span></span><span style="display:flex;"><span>                                         │- jdbcTemplate ─┼──▶│JdbcTemplate│
</span></span><span style="display:flex;"><span>                                         └────────────────┘   └────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意到上图的<code>UserService</code>已经脱离了IoC容器的管理，因为此时<code>UserService</code>对应的<code>BeanDefinition</code>中，存放的instance是<code>UserServiceProxy</code>。</p>
<p>可见，引入<code>BeanPostProcessor</code>可以实现Proxy机制，但也让依赖注入变得更加复杂。</p>
<p>但是我们仔细分析依赖关系，还是可以总结出两条原则：</p>
<ol>
<li>一个Bean如果被Proxy替换，则依赖它的Bean应注入Proxy，即上图的<code>MvcController</code>应注入<code>UserServiceProxy</code>；</li>
<li>一个Bean如果被Proxy替换，如果要注入依赖，则应该注入到原始对象，即上图的<code>JdbcTemplate</code>应注入到原始的<code>UserService</code>。</li>
</ol>
<p>基于这个原则，要满足条件1是很容易的，因为只要创建Bean完成后，立刻调用<code>BeanPostProcessor</code>就实现了替换，后续其他Bean引用的肯定就是Proxy了。先改造创建Bean的流程，在创建<code>@Configuration</code>后，接着创建<code>BeanPostProcessor</code>，再创建其他普通Bean：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> AnnotationConfigApplicationContext(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建@Configuration类型的Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 过滤出@Configuration:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">filter</span>(<span style="color:#fff;font-weight:bold">this</span>::isConfigurationDefinition).<span style="color:#007f7f">sorted</span>().<span style="color:#007f7f">map</span>(def -&gt; {
</span></span><span style="display:flex;"><span>                createBeanAsEarlySingleton(def);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> def.<span style="color:#007f7f">getName</span>();
</span></span><span style="display:flex;"><span>            }).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建BeanPostProcessor类型的Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;BeanPostProcessor&gt; processors = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beans</span>.<span style="color:#007f7f">values</span>().<span style="color:#007f7f">stream</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 过滤出BeanPostProcessor:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">filter</span>(<span style="color:#fff;font-weight:bold">this</span>::isBeanPostProcessorDefinition)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 排序:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">sorted</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 创建BeanPostProcessor实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">map</span>(def -&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> (BeanPostProcessor) createBeanAsEarlySingleton(def);
</span></span><span style="display:flex;"><span>            }).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanPostProcessors</span>.<span style="color:#007f7f">addAll</span>(processors);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建其他普通Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    createNormalBeans();
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>再继续修改<code>createBeanAsEarlySingleton()</code>，创建Bean实例后，调用<code>BeanPostProcessor</code>处理：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object createBeanAsEarlySingleton(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建Bean实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Object instance = ...;
</span></span><span style="display:flex;"><span>    def.<span style="color:#007f7f">setInstance</span>(instance);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 调用BeanPostProcessor处理Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (BeanPostProcessor processor : beanPostProcessors) {
</span></span><span style="display:flex;"><span>        Object processed = processor.<span style="color:#007f7f">postProcessBeforeInitialization</span>(def.<span style="color:#007f7f">getInstance</span>(), def.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 如果一个BeanPostProcessor替换了原始Bean，则更新Bean的引用:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (def.<span style="color:#007f7f">getInstance</span>() != processed) {
</span></span><span style="display:flex;"><span>            def.<span style="color:#007f7f">setInstance</span>(processed);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> def.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，如果一个Bean被替换为Proxy，那么<code>BeanDefinition</code>中的<code>instance</code>已经是Proxy了，这时，对这个Bean进行依赖注入会有问题，因为注入的是Proxy而不是原始Bean，怎么办？</p>
<p>这时我们要思考原始Bean去哪了？原始Bean实际上是被<code>BeanPostProcessor</code>给丢了！如果<code>BeanPostProcessor</code>能保存原始Bean，那么，注入前先找到原始Bean，就可以把依赖正确地注入给原始Bean。我们给<code>BeanPostProcessor</code>加一个<code>postProcessOnSetProperty()</code>方法，让它返回原始Bean：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> BeanPostProcessor {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 注入依赖时,应该使用的Bean实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">default</span> Object postProcessOnSetProperty(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>再继续把<code>injectBean()</code>改一下，不要直接拿<code>BeanDefinition.getInstance()</code>，而是拿到原始Bean：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> injectBean(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 获取Bean实例，或被代理的原始实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Object beanInstance = getProxiedInstance(def);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        injectProperties(def, def.<span style="color:#007f7f">getBeanClass</span>(), beanInstance);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (ReflectiveOperationException e) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> BeanCreationException(e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>getProxiedInstance()</code>就是为了获取原始Bean：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Object getProxiedInstance(BeanDefinition def) {
</span></span><span style="display:flex;"><span>    Object beanInstance = def.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 如果Proxy改变了原始Bean，又希望注入到原始Bean，则由BeanPostProcessor指定原始Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    List&lt;BeanPostProcessor&gt; reversedBeanPostProcessors = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">beanPostProcessors</span>);
</span></span><span style="display:flex;"><span>    Collections.<span style="color:#007f7f">reverse</span>(reversedBeanPostProcessors);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> (BeanPostProcessor beanPostProcessor : reversedBeanPostProcessors) {
</span></span><span style="display:flex;"><span>        Object restoredInstance = beanPostProcessor.<span style="color:#007f7f">postProcessOnSetProperty</span>(beanInstance, def.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (restoredInstance != beanInstance) {
</span></span><span style="display:flex;"><span>            beanInstance = restoredInstance;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> beanInstance;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里我们还能处理多次代理的情况，即一个原始Bean，比如<code>UserService</code>，被一个事务处理的<code>BeanPostProcsssor</code>代理为<code>UserServiceTx</code>，又被一个性能监控的<code>BeanPostProcessor</code>代理为<code>UserServiceMetric</code>，还原的时候，对<code>BeanPostProcsssor</code>做一个倒序，先还原为<code>UserServiceTx</code>，再还原为<code>UserService</code>。</p>
<h3 id="测试">测试<a hidden class="anchor" aria-hidden="true" href="#测试">#</a></h3>
<p>我们可以写一个测试来验证Bean的注入是否正确。先定义原始Bean：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OriginBean {
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${app.title}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${app.version}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String version;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getName() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> name;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过<code>FirstProxyBeanPostProcessor</code>代理为<code>FirstProxyBean</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Order(<span style="color:#ff0;font-weight:bold">100</span>)
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FirstProxyBeanPostProcessor <span style="color:#fff;font-weight:bold">implements</span> BeanPostProcessor {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 保存原始Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Map&lt;String, Object&gt; originBeans = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessBeforeInitialization(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (OriginBean.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">isAssignableFrom</span>(bean.<span style="color:#007f7f">getClass</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 检测到OriginBean,创建FirstProxyBean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            var proxy = <span style="color:#fff;font-weight:bold">new</span> FirstProxyBean((OriginBean) bean);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 保存原始Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            originBeans.<span style="color:#007f7f">put</span>(beanName, bean);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 返回Proxy:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> proxy;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessOnSetProperty(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        Object origin = originBeans.<span style="color:#007f7f">get</span>(beanName);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (origin != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 存在原始Bean时,返回原始Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> origin;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 代理Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">class</span> FirstProxyBean <span style="color:#fff;font-weight:bold">extends</span> OriginBean {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> OriginBean target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FirstProxyBean(OriginBean target) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过<code>SecondProxyBeanPostProcessor</code>代理为<code>SecondProxyBean</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Order(<span style="color:#ff0;font-weight:bold">200</span>)
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecondProxyBeanPostProcessor <span style="color:#fff;font-weight:bold">implements</span> BeanPostProcessor {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 保存原始Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Map&lt;String, Object&gt; originBeans = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessBeforeInitialization(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (OriginBean.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">isAssignableFrom</span>(bean.<span style="color:#007f7f">getClass</span>())) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 检测到OriginBean,创建SecondProxyBean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            var proxy = <span style="color:#fff;font-weight:bold">new</span> SecondProxyBean((OriginBean) bean);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 保存原始Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            originBeans.<span style="color:#007f7f">put</span>(beanName, bean);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 返回Proxy:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> proxy;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessOnSetProperty(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        Object origin = originBeans.<span style="color:#007f7f">get</span>(beanName);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (origin != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 存在原始Bean时,返回原始Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> origin;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 代理Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">class</span> SecondProxyBean <span style="color:#fff;font-weight:bold">extends</span> OriginBean {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> OriginBean target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SecondProxyBean(OriginBean target) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义一个Bean，用于检测是否注入了Proxy：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> InjectProxyOnConstructorBean {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> OriginBean injected;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> InjectProxyOnConstructorBean(@Autowired OriginBean injected) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">injected</span> = injected;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试代码如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>var ctx = <span style="color:#fff;font-weight:bold">new</span> AnnotationConfigApplicationContext(ScanApplication.<span style="color:#007f7f">class</span>, createPropertyResolver());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 获取OriginBean的实例,此处获取的应该是SendProxyBeanProxy:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>OriginBean proxy = ctx.<span style="color:#007f7f">getBean</span>(OriginBean.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>assertSame(SecondProxyBean.<span style="color:#007f7f">class</span>, proxy.<span style="color:#007f7f">getClass</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// proxy的name和version字段并没有被注入:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>assertNull(proxy.<span style="color:#007f7f">name</span>);
</span></span><span style="display:flex;"><span>assertNull(proxy.<span style="color:#007f7f">version</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 但是调用proxy的getName()会最终调用原始Bean的getName(),从而返回正确的值:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>assertEquals(<span style="color:#0ff;font-weight:bold">&#34;Scan App&#34;</span>, proxy.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 获取InjectProxyOnConstructorBean实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>var inject = ctx.<span style="color:#007f7f">getBean</span>(InjectProxyOnConstructorBean.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 注入的OriginBean应该为Proxy，而且和前面返回的proxy是同一实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>assertSame(proxy, inject.<span style="color:#007f7f">injected</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>从上面的测试代码我们也能看出，对于使用Proxy模式的Bean来说，正常的方法调用对用户是透明的，但是，直接访问Bean注入的字段，如果获取的是Proxy，则字段全部为<code>null</code>，因为注入并没有发生在Proxy，而是原始Bean。这也是为什么当我们需要访问某个注入的Bean时，总是调用方法而不是直接访问字段：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MailService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    UserService userService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String sendMail() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 错误:不要直接访问UserService的字段,因为如果UserService被代理,则返回null:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ZoneId zoneId = userService.<span style="color:#007f7f">zoneId</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 正确:通过方法访问UserService的字段,无论是否被代理,返回值均是正确的:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ZoneId zoneId = userService.<span style="color:#007f7f">getZoneId</span>();
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="完成ioc容器">完成IOC容器<a hidden class="anchor" aria-hidden="true" href="#完成ioc容器">#</a></h2>
<p>现在，我们已经完成了IoC容器的基本功能。最后的收尾工作主要是提取接口。先定义给用户使用的<code>ApplicationContext</code>接口：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> ApplicationContext <span style="color:#fff;font-weight:bold">extends</span> AutoCloseable {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 是否存在指定name的Bean？
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">boolean</span> containsBean(String name);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 根据name返回唯一Bean，未找到抛出NoSuchBeanDefinitionException
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    &lt;T&gt; T getBean(String name);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 根据name返回唯一Bean，未找到抛出NoSuchBeanDefinitionException
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    &lt;T&gt; T getBean(String name, Class&lt;T&gt; requiredType);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 根据type返回唯一Bean，未找到抛出NoSuchBeanDefinitionException
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    &lt;T&gt; T getBean(Class&lt;T&gt; requiredType);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 根据type返回一组Bean，未找到返回空List
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    &lt;T&gt; List&lt;T&gt; getBeans(Class&lt;T&gt; requiredType);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 关闭并执行所有bean的destroy方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">void</span> close();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>再定义一个给Framework级别的代码用的<code>ConfigurableApplicationContext</code>接口：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> ConfigurableApplicationContext <span style="color:#fff;font-weight:bold">extends</span> ApplicationContext {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    List&lt;BeanDefinition&gt; findBeanDefinitions(Class&lt;?&gt; type);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Nullable
</span></span><span style="display:flex;"><span>    BeanDefinition findBeanDefinition(Class&lt;?&gt; type);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Nullable
</span></span><span style="display:flex;"><span>    BeanDefinition findBeanDefinition(String name);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Nullable
</span></span><span style="display:flex;"><span>    BeanDefinition findBeanDefinition(String name, Class&lt;?&gt; requiredType);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Object createBeanAsEarlySingleton(BeanDefinition def);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>让<code>AnnotationConfigApplicationContext</code>实现接口：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationConfigApplicationContext <span style="color:#fff;font-weight:bold">implements</span> ConfigurableApplicationContext {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>顺便在<code>close()</code>方法中把Bean的<code>destroy</code>方法执行了。</p>
<p>最后加一个<code>ApplicationUtils</code>类，目的是能通过<code>getRequiredApplicationContext()</code>方法随时获取到<code>ApplicationContext</code>实例。</p>
<p>搞定<code>summer-context</code>模块！</p>
<p>有的同学可能会问，为什么我们用了不到1000行核心代码，就实现了<code>ApplicationContext</code>？如果查看Spring的源码，可以看到，光是层次结构，就令人眼花缭乱：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>BeanFactory
</span></span><span style="display:flex;"><span>  HierarchicalBeanFactory
</span></span><span style="display:flex;"><span>    ConfigurableBeanFactory
</span></span><span style="display:flex;"><span>      AbstractBeanFactory
</span></span><span style="display:flex;"><span>        AbstractAutowireCapableBeanFactory
</span></span><span style="display:flex;"><span>          DefaultListableBeanFactory
</span></span><span style="display:flex;"><span>    ApplicationContext
</span></span><span style="display:flex;"><span>      ConfigurableApplicationContext
</span></span><span style="display:flex;"><span>        AbstractApplicationContext
</span></span><span style="display:flex;"><span>          AbstractRefreshableApplicationContext
</span></span><span style="display:flex;"><span>            AbstractXmlApplicationContext
</span></span><span style="display:flex;"><span>              ClassPathXmlApplicationContext
</span></span><span style="display:flex;"><span>              FileSystemXmlApplicationContext
</span></span><span style="display:flex;"><span>          GenericApplicationContext
</span></span><span style="display:flex;"><span>            AnnotationConfigApplicationContext
</span></span><span style="display:flex;"><span>            GenericXmlApplicationContext
</span></span><span style="display:flex;"><span>            StaticApplicationContext
</span></span></code></pre></td></tr></table>
</div>
</div><p>其实根本原因是我们大幅简化了需求。Spring最早提供了<code>BeanFactory</code>和<code>ApplicationContext</code>两种容器，前者是懒加载，后者是立刻初始化所有Bean。懒加载的特性会导致依赖注入变得更加复杂，虽然<code>BeanFactory</code>在实际项目中并没有什么卵用。然而一旦发布了接口，处于兼容性考虑，就没法再收回去了。再考虑到Spring最早采用XML配置，后来采用Annotation配置，还允许混合配置，这样一来，早期发布的<code>XmlApplicationContext</code>不能动，新的Annotation配置就必须添加新的实现类，所以，代码的复杂度随着需求增加而增加，保持兼容性又会导致需要更多的代码来实现新功能。</p>
<p>所以，没事不要瞎提需求。</p>
<h1 id="实现aop">实现AOP<a hidden class="anchor" aria-hidden="true" href="#实现aop">#</a></h1>
<p>实现了IoC容器后，我们继续实现AOP功能。</p>
<p>AOP即Aspect Oriented Programming，面向切面编程，它本质上就是一个Proxy模式，只不过可以让IoC容器在运行时再组合起来，而不是事先自己用Proxy模式写死了。而实现Proxy模式的核心是拦截目标Bean的方法调用。</p>
<p>既然原理是方法拦截，那么AOP的实现方式不外乎以下几种：</p>
<ol>
<li>编译期：在编译时，由编译器把切面调用编译进字节码，这种方式需要定义新的关键字并扩展编译器，AspectJ就扩展了Java编译器，使用关键字aspect来实现织入；</li>
<li>类加载器：在目标类被装载到JVM时，通过一个特殊的类加载器，对目标类的字节码重新“增强”；</li>
<li>运行期：目标对象和切面都是普通Java类，通过JVM的动态代理功能或者第三方库实现运行期动态织入。</li>
</ol>
<p>从复杂度看，最简单的是方案3，因为不涉及到任何JVM底层。</p>
<p>方案3又有两种实现方式：</p>
<ol>
<li>使用Java标准库的动态代理机制，不过仅支持对接口代理，无法对具体类实现代理；</li>
<li>使用CGLIB或Javassist这些第三方库，通过动态生成字节码，可以对具体类实现代理。</li>
</ol>
<p>那么Spring的实现方式是啥？Spring实际上内置了多种代理机制，如果一个Bean声明的类型是接口，那么Spring直接使用Java标准库实现对接口的代理，如果一个Bean声明的类型是Class，那么Spring就使用CGLIB动态生成字节码实现代理。</p>
<p>除了实现代理外，还得有一套机制让用户能定义代理。Spring又提供了多种方式：</p>
<ol>
<li>用AspectJ的语法来定义AOP，比如<code>execution(public * com.itranswarp.service.*.*(..))</code>；</li>
<li>用注解来定义AOP，比如用<code>@Transactional</code>表示开启事务。</li>
</ol>
<p>用表达式匹配，很容易漏掉或者打击面太大。用注解无疑是最简单的，因为这样被装配的Bean自己能清清楚楚地知道自己被安排了。因此，在Summer Framework中，我们只支持Annotation模式的AOP机制，并且采用动态生成字节码的方式实现。</p>
<p>明确了需求，我们来看如何实现动态生成字节码。Spring采用的是CGLIB，因此我们去CGLIB首页看一下，不看不要紧，一看吓一跳：</p>
<blockquote>
<p>cglib is unmaintained &hellip; migrating to something like ByteBuddy.</p>
</blockquote>
<p>原来CGLIB已经不维护了，建议使用ByteBuddy。既然如此，我们就选择ByteBuddy实现AOP吧。</p>
<p>比较一下Spring Framework和Summer Framework对AOP的支持：</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">Spring Framework</th>
<th style="text-align:left">Summer Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">AspectJ方式</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">Annotation方式</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">支持</td>
</tr>
<tr>
<td style="text-align:left">代理接口</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">代理类</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">支持</td>
</tr>
<tr>
<td style="text-align:left">实现机制</td>
<td style="text-align:left">CGLIB</td>
<td style="text-align:left">ByteBuddy</td>
</tr>
</tbody>
</table>
<p>下面我们就来准备实现AOP。</p>
<h2 id="实现proxyresolver">实现ProxyResolver<a hidden class="anchor" aria-hidden="true" href="#实现proxyresolver">#</a></h2>
<p>为了实现AOP，我们先思考如何在IoC容器中实现一个动态代理。</p>
<p>在IoC容器中，实现动态代理需要用户提供两个Bean：</p>
<ol>
<li>原始Bean，即需要被代理的Bean；</li>
<li>拦截器，即拦截了目标Bean的方法后，会自动调用拦截器实现代理功能。</li>
</ol>
<p>拦截器需要定义接口，这里我们直接用Java标准库的<code>InvocationHandler</code>，免去了自定义接口。</p>
<p>假定我们已经从IoC容器中获取了原始Bean与实现了<code>InvocationHandler</code>的拦截器Bean，那么就可以编写一个<code>ProxyResolver</code>来实现AOP代理。</p>
<p>从<a href="https://bytebuddy.net/">ByteBuddy的官网</a>上搜索很容易找到相关代码，我们整理为<code>createProxy()</code>方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ProxyResolver {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ByteBuddy实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ByteBuddy byteBuddy = <span style="color:#fff;font-weight:bold">new</span> ByteBuddy();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 传入原始Bean、拦截器，返回代理后的实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T createProxy(T bean, InvocationHandler handler) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 目标Bean的Class类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Class&lt;?&gt; targetClass = bean.<span style="color:#007f7f">getClass</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 动态创建Proxy的Class:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Class&lt;?&gt; proxyClass = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">byteBuddy</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 子类用默认无参数构造方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">subclass</span>(targetClass, ConstructorStrategy.<span style="color:#007f7f">Default</span>.<span style="color:#007f7f">DEFAULT_CONSTRUCTOR</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 拦截所有public方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">method</span>(ElementMatchers.<span style="color:#007f7f">isPublic</span>()).<span style="color:#007f7f">intercept</span>(InvocationHandlerAdapter.<span style="color:#007f7f">of</span>(
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// 新的拦截器实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        <span style="color:#fff;font-weight:bold">new</span> InvocationHandler() {
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">public</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>                                <span style="color:#007f7f">// 将方法调用代理至原始Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                                <span style="color:#fff;font-weight:bold">return</span> handler.<span style="color:#007f7f">invoke</span>(bean, method, args);
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }))
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 生成字节码:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">make</span>()
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 加载字节码:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">load</span>(targetClass.<span style="color:#007f7f">getClassLoader</span>()).<span style="color:#007f7f">getLoaded</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 创建Proxy实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Object proxy;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            proxy = proxyClass.<span style="color:#007f7f">getConstructor</span>().<span style="color:#007f7f">newInstance</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (RuntimeException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> e;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> (T) proxy;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意<code>InvocationHandler</code>有两层：外层的<code>invoke()</code>传入的Object是Proxy实例，内层的<code>invoke()</code>将调用转发至原始Bean。</p>
<p>一共大约50行代码，我们就实现了AOP功能。有点不敢相信，赶快写个测试看看效果。</p>
<p>先定义一个<code>OriginBean</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OriginBean {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Polite
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String hello() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Hello, &#34;</span> + name + <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String morning() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Morning, &#34;</span> + name + <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们要实现的AOP功能是增强带<code>@Polite</code>注解的方法，把返回值<code>Hello, Bob.</code>改为<code>Hello, Bob!</code>，让欢迎气氛更强烈一点，因此，编写一个<code>InvocationHandler</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PoliteInvocationHandler <span style="color:#fff;font-weight:bold">implements</span> InvocationHandler {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object invoke(Object bean, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 修改标记了@Polite的方法返回值:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (method.<span style="color:#007f7f">getAnnotation</span>(Polite.<span style="color:#007f7f">class</span>) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            String ret = (String) method.<span style="color:#007f7f">invoke</span>(bean, args);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (ret.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>)) {
</span></span><span style="display:flex;"><span>                ret = ret.<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">0</span>, ret.<span style="color:#007f7f">length</span>() - <span style="color:#ff0;font-weight:bold">1</span>) + <span style="color:#0ff;font-weight:bold">&#34;!&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> ret;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> method.<span style="color:#007f7f">invoke</span>(bean, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试代码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 原始Bean:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>OriginBean origin = <span style="color:#fff;font-weight:bold">new</span> OriginBean();
</span></span><span style="display:flex;"><span>origin.<span style="color:#007f7f">name</span> = <span style="color:#0ff;font-weight:bold">&#34;Bob&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 调用原始Bean的hello():
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>assertEquals(<span style="color:#0ff;font-weight:bold">&#34;Hello, Bob.&#34;</span>, origin.<span style="color:#007f7f">hello</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 创建Proxy:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>OriginBean proxy = <span style="color:#fff;font-weight:bold">new</span> ProxyResolver().<span style="color:#007f7f">createProxy</span>(origin, <span style="color:#fff;font-weight:bold">new</span> PoliteInvocationHandler());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// Proxy类名,类似OriginBean$ByteBuddy$9hQwRy3T:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(proxy.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// Proxy类与OriginBean.class不同:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>assertNotSame(OriginBean.<span style="color:#007f7f">class</span>, proxy.<span style="color:#007f7f">getClass</span>());
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// proxy实例的name字段应为null:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>assertNull(proxy.<span style="color:#007f7f">name</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 调用带@Polite的方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>assertEquals(<span style="color:#0ff;font-weight:bold">&#34;Hello, Bob!&#34;</span>, proxy.<span style="color:#007f7f">hello</span>());
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 调用不带@Polite的方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>assertEquals(<span style="color:#0ff;font-weight:bold">&#34;Morning, Bob.&#34;</span>, proxy.<span style="color:#007f7f">morning</span>());
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试通过，本节到此收工。</p>
<h2 id="实现around">实现Around<a hidden class="anchor" aria-hidden="true" href="#实现around">#</a></h2>
<p>现在我们已经实现了ProxyResolver，下一步，实现完整的AOP就很容易了。</p>
<p>我们先从客户端代码入手，看看应当怎么装配AOP。</p>
<p>首先，客户端需要定义一个原始Bean，例如<code>OriginBean</code>，用<code>@Around</code>注解标注：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@Around(<span style="color:#0ff;font-weight:bold">&#34;aroundInvocationHandler&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OriginBean {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${customer.name}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String name;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Polite
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String hello() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Hello, &#34;</span> + name + <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String morning() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Morning, &#34;</span> + name + <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>@Around</code>注解的值<code>aroundInvocationHandler</code>指出应该按什么名字查找拦截器，因此，客户端应再定义一个<code>AroundInvocationHandler</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AroundInvocationHandler <span style="color:#fff;font-weight:bold">implements</span> InvocationHandler {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 拦截标记了@Polite的方法返回值:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (method.<span style="color:#007f7f">getAnnotation</span>(Polite.<span style="color:#007f7f">class</span>) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            String ret = (String) method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (ret.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>)) {
</span></span><span style="display:flex;"><span>                ret = ret.<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">0</span>, ret.<span style="color:#007f7f">length</span>() - <span style="color:#ff0;font-weight:bold">1</span>) + <span style="color:#0ff;font-weight:bold">&#34;!&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> ret;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>有了原始Bean、拦截器，就可以在IoC容器中装配AOP：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AroundApplication {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    AroundProxyBeanPostProcessor createAroundProxyBeanPostProcessor() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> AroundProxyBeanPostProcessor();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意到装配AOP是通过<code>AroundProxyBeanPostProcessor</code>实现的，而这个类是由Framework提供，客户端并不需要自己实现。因此，我们需要开发一个<code>AroundProxyBeanPostProcessor</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AroundProxyBeanPostProcessor <span style="color:#fff;font-weight:bold">implements</span> BeanPostProcessor {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Map&lt;String, Object&gt; originBeans = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessBeforeInitialization(Object bean, String beanName) <span style="color:#fff;font-weight:bold">throws</span> BeansException {
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; beanClass = bean.<span style="color:#007f7f">getClass</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 检测@Around注解:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Around anno = beanClass.<span style="color:#007f7f">getAnnotation</span>(Around.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (anno != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            String handlerName;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                handlerName = (String) anno.<span style="color:#007f7f">annotationType</span>().<span style="color:#007f7f">getMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;value&#34;</span>).<span style="color:#007f7f">invoke</span>(anno);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (ReflectiveOperationException e) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AopConfigException();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            Object proxy = createProxy(beanClass, bean, handlerName);
</span></span><span style="display:flex;"><span>            originBeans.<span style="color:#007f7f">put</span>(beanName, bean);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> proxy;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> bean;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Object createProxy(Class&lt;?&gt; beanClass, Object bean, String handlerName) {
</span></span><span style="display:flex;"><span>        ConfigurableApplicationContext ctx = (ConfigurableApplicationContext) ApplicationContextUtils.<span style="color:#007f7f">getRequiredApplicationContext</span>();
</span></span><span style="display:flex;"><span>        BeanDefinition def = ctx.<span style="color:#007f7f">findBeanDefinition</span>(handlerName);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (def == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AopConfigException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Object handlerBean = def.<span style="color:#007f7f">getInstance</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (handlerBean == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            handlerBean = ctx.<span style="color:#007f7f">createBeanAsEarlySingleton</span>(def);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (handlerBean <span style="color:#fff;font-weight:bold">instanceof</span> InvocationHandler handler) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> ProxyResolver.<span style="color:#007f7f">getInstance</span>().<span style="color:#007f7f">createProxy</span>(bean, handler);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> AopConfigException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object postProcessOnSetProperty(Object bean, String beanName) {
</span></span><span style="display:flex;"><span>        Object origin = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">originBeans</span>.<span style="color:#007f7f">get</span>(beanName);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> origin != <span style="color:#fff;font-weight:bold">null</span> ? origin : bean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上述<code>AroundProxyBeanPostProcessor</code>的机制非常简单：检测每个Bean实例是否带有<code>@Around</code>注解，如果有，就根据注解的值查找Bean作为<code>InvocationHandler</code>，最后创建Proxy，返回前保存了原始Bean的引用，因为IoC容器在后续的注入阶段要把相关依赖和值注入到原始Bean。</p>
<p>总结一下，Summer Framework提供的包括：</p>
<ul>
<li><code>Around</code>注解；</li>
<li><code>AroundProxyBeanPostProcessor</code>实现AOP。</li>
</ul>
<p>客户端代码需要提供的包括：</p>
<ul>
<li>带<code>@Around</code>注解的原始Bean；</li>
<li>实现<code>InvocationHandler</code>的Bean，名字与<code>@Around</code>注解value保持一致。</li>
</ul>
<p>没有额外的要求了。</p>
<h3 id="实现before和after">实现Before和After<a hidden class="anchor" aria-hidden="true" href="#实现before和after">#</a></h3>
<p>我们再继续思考，Spring提供的AOP拦截器，有Around、Before和After等好几种。如何实现Before和After拦截？</p>
<p>实际上Around拦截本身就包含了Before和After拦截，我们没必要去修改<code>ProxyResolver</code>，只需要用Adapter模式提供两个拦截器模版，一个是<code>BeforeInvocationHandlerAdapter</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">class</span> BeforeInvocationHandlerAdapter <span style="color:#fff;font-weight:bold">implements</span> InvocationHandler {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">void</span> before(Object proxy, Method method, Object[] args);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>        before(proxy, method, args);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>客户端提供的<code>InvocationHandler</code>只需继承自<code>BeforeInvocationHandlerAdapter</code>，自然就需要覆写<code>before()</code>方法，实现了Before拦截。</p>
<p>After拦截也是一个拦截器模版：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">class</span> AfterInvocationHandlerAdapter <span style="color:#fff;font-weight:bold">implements</span> InvocationHandler {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// after允许修改方法返回值:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> Object after(Object proxy, Object returnValue, Method method, Object[] args);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>        Object ret = method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> after(proxy, ret, method, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="扩展annotation">扩展Annotation<a hidden class="anchor" aria-hidden="true" href="#扩展annotation">#</a></h3>
<p>截止目前，客户端只需要定义带有<code>@Around</code>注解的Bean，就能自动触发AOP。我们思考下Spring的事务机制，其实也是AOP拦截，不过它的注解是<code>@Transactional</code>。如果要扩展Annotation，即能自定义注解来启动AOP，怎么做？</p>
<p>假设我们后续编写了一个事务模块，提供注解<code>@Transactional</code>，那么，要启动AOP，就必须仿照<code>AroundProxyBeanPostProcessor</code>，提供一个<code>TransactionProxyBeanPostProcessor</code>，不过复制代码太麻烦了，我们可以改造一下<code>AroundProxyBeanPostProcessor</code>，用范型代码处理Annotation，先抽象出一个<code>AnnotationProxyBeanPostProcessor</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">abstract</span> <span style="color:#fff;font-weight:bold">class</span> AnnotationProxyBeanPostProcessor&lt;A <span style="color:#fff;font-weight:bold">extends</span> Annotation&gt; <span style="color:#fff;font-weight:bold">implements</span> BeanPostProcessor {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Map&lt;String, Object&gt; originBeans = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>    Class&lt;A&gt; annotationClass;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> AnnotationProxyBeanPostProcessor() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">annotationClass</span> = getParameterizedType();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>实现<code>AroundProxyBeanPostProcessor</code>就一行定义：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AroundProxyBeanPostProcessor <span style="color:#fff;font-weight:bold">extends</span> AnnotationProxyBeanPostProcessor&lt;Around&gt; {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>后续如果我们想实现<code>@Transactional</code>注解，只需定义：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TransactionalProxyBeanPostProcessor <span style="color:#fff;font-weight:bold">extends</span> AnnotationProxyBeanPostProcessor&lt;Transactional&gt; {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>就能自动根据<code>@Transactional</code>启动AOP。</p>
<h1 id="实现jdbc和事务">实现JDBC和事务<a hidden class="anchor" aria-hidden="true" href="#实现jdbc和事务">#</a></h1>
<p>我们已经实现了IoC容器和AOP功能，在此基础上增加JDBC和事务的支持就比较容易了。</p>
<p>Spring对JDBC数据库的支持主要包括：</p>
<ol>
<li>提供了一个<code>JdbcTemplate</code>和<code>NamedParameterJdbcTemplate</code>模板类，可以方便地操作JDBC；</li>
<li>支持流行的ORM框架，如Hibernate、JPA等；</li>
<li>支持声明式事务，只需要通过简单的注解配置即可实现事务管理。</li>
</ol>
<p>在Summer Framework中，我们准备提供一个<code>JdbcTemplate</code>模板，以及声明式事务的支持。对于ORM，反正手动集成也比较容易，就不管了。</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">Spring Framework</th>
<th style="text-align:left">Summer Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JdbcTemplate</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">支持</td>
</tr>
<tr>
<td style="text-align:left">NamedParameterJdbcTemplate</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">转换SQL错误码</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">ORM</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">手动管理事务</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">声明式事务</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">支持</td>
</tr>
</tbody>
</table>
<p>下面开始正式开发Summer Framework的<code>JdbcTemplate</code>与声明式事务。</p>
<h2 id="实现jdbctemplate">实现JdbcTemplate<a hidden class="anchor" aria-hidden="true" href="#实现jdbctemplate">#</a></h2>
<p>本节我们来实现JdbcTemplate。在Spring中，通过JdbcTemplate，基本封装了所有JDBC操作，可以覆盖绝大多数数据库操作的场景。</p>
<h3 id="配置datasource">配置DataSource<a hidden class="anchor" aria-hidden="true" href="#配置datasource">#</a></h3>
<p>使用JdbcTemplate之前，我们需要配置JDBC数据源。Spring本身只提供了基础的<code>DriverManagerDataSource</code>，但Spring Boot有一个默认配置的数据源，并采用HikariCP作为连接池。这里我们仿照Spring Boot的方式，先定义默认的数据源配置项：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">summer</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:sqlite:test.db
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">driver-class-name</span>: org.sqlite.JDBC
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: sa
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: 
</span></span></code></pre></td></tr></table>
</div>
</div><p>再实现一个HikariCP支持的<code>DataSource</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JdbcConfiguration {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(destroyMethod = <span style="color:#0ff;font-weight:bold">&#34;close&#34;</span>)
</span></span><span style="display:flex;"><span>    DataSource dataSource(
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// properties:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.url}&#34;</span>) String url,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.username}&#34;</span>) String username,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.password}&#34;</span>) String password,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.driver-class-name:}&#34;</span>) String driver,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.maximum-pool-size:20}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> maximumPoolSize,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.minimum-pool-size:1}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> minimumPoolSize,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.connection-timeout:30000}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> connTimeout
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        var config = <span style="color:#fff;font-weight:bold">new</span> HikariConfig();
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setAutoCommit</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setJdbcUrl</span>(url);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setUsername</span>(username);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setPassword</span>(password);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (driver != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            config.<span style="color:#007f7f">setDriverClassName</span>(driver);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setMaximumPoolSize</span>(maximumPoolSize);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setMinimumIdle</span>(minimumPoolSize);
</span></span><span style="display:flex;"><span>        config.<span style="color:#007f7f">setConnectionTimeout</span>(connTimeout);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> HikariDataSource(config);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样，客户端引入<code>JdbcConfiguration</code>就自动获得了数据源：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Import(JdbcConfiguration.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="定义jdbctemplate">定义JdbcTemplate<a hidden class="anchor" aria-hidden="true" href="#定义jdbctemplate">#</a></h3>
<p>下一步是定义<code>JdbcTemplate</code>，唯一依赖是注入<code>DataSource</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JdbcTemplate {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> DataSource dataSource;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> JdbcTemplate(DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">dataSource</span> = dataSource;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>JdbcTemplate基于<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1281319636041762">Template模式</a>，提供了大量以回调作为参数的模板方法，其中以<code>execute(ConnectionCallback)</code>为基础：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T execute(ConnectionCallback&lt;T&gt; action) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (Connection newConn = dataSource.<span style="color:#007f7f">getConnection</span>()) {
</span></span><span style="display:flex;"><span>        T result = action.<span style="color:#007f7f">doInConnection</span>(newConn);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (SQLException e) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> DataAccessException(e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>即由<code>JdbcTemplate</code>处理获取连接、释放连接、捕获SQLException，上层代码专注于使用<code>Connection</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@FunctionalInterface
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> ConnectionCallback&lt;T&gt; {
</span></span><span style="display:flex;"><span>    @Nullable
</span></span><span style="display:flex;"><span>    T doInConnection(Connection con) <span style="color:#fff;font-weight:bold">throws</span> SQLException;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>其他方法其实也是基于<code>execute(ConnectionCallback)</code>，例如：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T execute(PreparedStatementCreator psc, PreparedStatementCallback&lt;T&gt; action) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> execute((Connection con) -&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> (PreparedStatement ps = psc.<span style="color:#007f7f">createPreparedStatement</span>(con)) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> action.<span style="color:#007f7f">doInPreparedStatement</span>(ps);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上述代码实现了<code>ConnectionCallback</code>，内部又调用了传入的<code>PreparedStatementCreator</code>和<code>PreparedStatementCallback</code>，这样，基于更新操作的<code>update</code>就可以这么写：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">int</span> update(String sql, Object... args) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> execute(
</span></span><span style="display:flex;"><span>        preparedStatementCreator(sql, args),
</span></span><span style="display:flex;"><span>        (PreparedStatement ps) -&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> ps.<span style="color:#007f7f">executeUpdate</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>基于查询操作的<code>queryForList()</code>就可以这么写：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; List&lt;T&gt; queryForList(String sql, RowMapper&lt;T&gt; rowMapper, Object... args) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> execute(preparedStatementCreator(sql, args),
</span></span><span style="display:flex;"><span>        (PreparedStatement ps) -&gt; {
</span></span><span style="display:flex;"><span>            List&lt;T&gt; list = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> (ResultSet rs = ps.<span style="color:#007f7f">executeQuery</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">while</span> (rs.<span style="color:#007f7f">next</span>()) {
</span></span><span style="display:flex;"><span>                    list.<span style="color:#007f7f">add</span>(rowMapper.<span style="color:#007f7f">mapRow</span>(rs, rs.<span style="color:#007f7f">getRow</span>()));
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> list;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>剩下的一系列查询方法都是基于上述方法的封装，包括：</p>
<ul>
<li>queryForList(String sql, RowMapper rowMapper, Object&hellip; args)</li>
<li>queryForList(String sql, Class clazz, Object&hellip; args)</li>
<li>queryForNumber(String sql, Object&hellip; args)</li>
</ul>
<p>总之，就是一个工作量的问题，开发难度基本为0。</p>
<p>测试时，可以使用Sqlite这个轻量级数据库，测试用例覆盖到各种SQL操作，最后把<code>JdbcTemplate</code>加入到<code>JdbcConfiguration</code>中，就基本完善了。</p>
<h2 id="实现声明式事务">实现声明式事务<a hidden class="anchor" aria-hidden="true" href="#实现声明式事务">#</a></h2>
<p>Spring提供的声明式事务管理能极大地降低应用程序的事务代码。如果使用基于Annotation配置的声明式事务，则一个与数据库操作相关的类只需加上<code>@Transactional</code>注解，就实现了事务支持，非常方便：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Transactional
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Spring的声明式事务支持JDBC本地事务和JTA分布式事务两种，事务传播模型除了最常用的<code>REQUIRED</code>，还包括Java EE定义的<code>SUPPORTS</code>、<code>REQUIRED_NEW</code>、<code>NESTED</code>等多种模式。Summer Framework出于简化目的，仅支持JDBC本地事务，事务传播模型仅支持最常用的<code>REQUIRED</code>，这样可以大大简化代码：</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">Spring Framework</th>
<th style="text-align:left">Summer Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JDBC事务</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">支持</td>
</tr>
<tr>
<td style="text-align:left">JTA事务</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">REQUIRED传播模式</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">支持</td>
</tr>
<tr>
<td style="text-align:left">其他传播模式</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">设置隔离级别</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
</tbody>
</table>
<p>下面我们就来编写声明式事务管理。</p>
<p>首先定义<code>@Transactional</code>，这里就不允许单独在方法处定义，直接在class级别启动所有public方法的事务：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Target(ElementType.<span style="color:#007f7f">TYPE</span>)
</span></span><span style="display:flex;"><span>@Retention(RetentionPolicy.<span style="color:#007f7f">RUNTIME</span>)
</span></span><span style="display:flex;"><span>@Documented
</span></span><span style="display:flex;"><span>@Inherited
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> @interface Transactional {
</span></span><span style="display:flex;"><span>    String value() <span style="color:#fff;font-weight:bold">default</span> <span style="color:#0ff;font-weight:bold">&#34;platformTransactionManager&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>默认值<code>platformTransactionManager</code>表示用名字为<code>platformTransactionManager</code>的Bean来管理事务。</p>
<p>下一步是定义接口<code>PlatformTransactionManager</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> PlatformTransactionManager {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>其实啥也没有，就是一个标识作用。</p>
<p>接着定义<code>TransactionStatus</code>，表示当前事务状态：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TransactionStatus {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Connection connection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TransactionStatus(Connection connection) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">connection</span> = connection;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>目前仅封装了一个Connection，将来如果扩展，则可以将事务的传播模式存储在里面。</p>
<p>最后写个<code>DataSourceTransactionManager</code>，它持有一个<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1306581251653666">ThreadLocal</a>存储的<code>TransactionStatus</code>，以及一个<code>DataSource</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DataSourceTransactionManager <span style="color:#fff;font-weight:bold">implements</span>
</span></span><span style="display:flex;"><span>        PlatformTransactionManager, InvocationHandler
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ThreadLocal&lt;TransactionStatus&gt; transactionStatus = <span style="color:#fff;font-weight:bold">new</span> ThreadLocal&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> DataSource dataSource;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> DataSourceTransactionManager(DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">dataSource</span> = dataSource;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为<code>DataSourceTransactionManager</code>是真正执行开启、提交、回归事务的地方，在哪执行呢？就在<code>invoke()</code>内部：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Override
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>    TransactionStatus ts = transactionStatus.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (ts == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 当前无事务,开启新事务:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">try</span> (Connection connection = dataSource.<span style="color:#007f7f">getConnection</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> autoCommit = connection.<span style="color:#007f7f">getAutoCommit</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (autoCommit) {
</span></span><span style="display:flex;"><span>                connection.<span style="color:#007f7f">setAutoCommit</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 设置ThreadLocal状态:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                transactionStatus.<span style="color:#007f7f">set</span>(<span style="color:#fff;font-weight:bold">new</span> TransactionStatus(connection));
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 调用业务方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                Object r = method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 提交事务:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                connection.<span style="color:#007f7f">commit</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 方法返回:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">return</span> r;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (InvocationTargetException e) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 回滚事务:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                TransactionException te = <span style="color:#fff;font-weight:bold">new</span> TransactionException(e.<span style="color:#007f7f">getCause</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                    connection.<span style="color:#007f7f">rollback</span>();
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">catch</span> (SQLException sqle) {
</span></span><span style="display:flex;"><span>                    te.<span style="color:#007f7f">addSuppressed</span>(sqle);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> te;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 删除ThreadLocal状态:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                transactionStatus.<span style="color:#007f7f">remove</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (autoCommit) {
</span></span><span style="display:flex;"><span>                    connection.<span style="color:#007f7f">setAutoCommit</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 当前已有事务,加入当前事务执行:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> method.<span style="color:#007f7f">invoke</span>(proxy, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样就实现了声明式事务。</p>
<p>有的同学会问，如果一个方法开启了事务，那么，它内部调用其他方法，是怎么加入当前事务的？</p>
<p>这里我们先需要写一个获取当前事务连接的工具类：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TransactionalUtils {
</span></span><span style="display:flex;"><span>    @Nullable
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Connection getCurrentConnection() {
</span></span><span style="display:flex;"><span>        TransactionStatus ts = DataSourceTransactionManager.<span style="color:#007f7f">transactionStatus</span>.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ts == <span style="color:#fff;font-weight:bold">null</span> ? <span style="color:#fff;font-weight:bold">null</span> : ts.<span style="color:#007f7f">connection</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后改造下<code>JdbcTemplate</code>获取连接的代码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JdbcTemplate {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T execute(ConnectionCallback&lt;T&gt; action) <span style="color:#fff;font-weight:bold">throws</span> DataAccessException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 尝试获取当前事务连接:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Connection current = TransactionalUtils.<span style="color:#007f7f">getCurrentConnection</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (current != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> action.<span style="color:#007f7f">doInConnection</span>(current);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (SQLException e) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> DataAccessException(e);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 无事务,从DataSource获取新连接:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">try</span> (Connection newConn = dataSource.<span style="color:#007f7f">getConnection</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> action.<span style="color:#007f7f">doInConnection</span>(newConn);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (SQLException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> DataAccessException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样，使用<code>JdbcTemplate</code>，如果有事务，自动加入当前事务，否则，按普通SQL执行（数据库隐含事务）。</p>
<p>最后，还需要提供一个<code>TransactionalBeanPostProcessor</code>，使得AOP机制生效，才能拦截<code>@Transactional</code>标注的Bean的public方法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TransactionalBeanPostProcessor <span style="color:#fff;font-weight:bold">extends</span> AnnotationProxyBeanPostProcessor&lt;Transactional&gt; {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>把它们都整理一下，放到<code>JdbcConfiguration</code>中：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JdbcConfiguration {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(destroyMethod = <span style="color:#0ff;font-weight:bold">&#34;close&#34;</span>)
</span></span><span style="display:flex;"><span>    DataSource dataSource(
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// properties:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.url}&#34;</span>) String url,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.username}&#34;</span>) String username,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.password}&#34;</span>) String password,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.driver-class-name:}&#34;</span>) String driver,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.maximum-pool-size:20}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> maximumPoolSize,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.minimum-pool-size:1}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> minimumPoolSize,
</span></span><span style="display:flex;"><span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.datasource.connection-timeout:30000}&#34;</span>) <span style="color:#fff;font-weight:bold">int</span> connTimeout
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> HikariDataSource(config);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate(@Autowired DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> JdbcTemplate(dataSource);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    TransactionalBeanPostProcessor transactionalBeanPostProcessor() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> TransactionalBeanPostProcessor();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    PlatformTransactionManager platformTransactionManager(@Autowired DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> DataSourceTransactionManager(dataSource);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，应用程序只需导入<code>JdbcConfiguration</code>，从连接池到声明式事务全部齐活：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Import(JdbcConfiguration.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后我们总结下各个组件的作用：</p>
<ol>
<li>由<code>JdbcConfiguration</code>创建的<code>DataSource</code>，实现了连接池；</li>
<li>由<code>JdbcConfiguration</code>创建的<code>JdbcTemplate</code>，实现基本SQL操作；</li>
<li>由<code>JdbcConfiguration</code>创建的<code>PlatformTransactionManager</code>，负责拦截<code>@Transactional</code>标识的Bean的public方法，自动管理事务；</li>
<li>由<code>JdbcConfiguration</code>创建的<code>TransactionalBeanPostProcessor</code>，负责给<code>@Transactional</code>标识的Bean创建AOP代理，拦截器正是<code>PlatformTransactionManager</code>。</li>
</ol>
<p>应用程序除了导入一个<code>JdbcConfiguration</code>，加上默认配置项，什么也不用干，就可以开始写自动带声明式事务的代码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Transactional
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> User register(String email, String password) {
</span></span><span style="display:flex;"><span>        jdbcTemplate.<span style="color:#007f7f">update</span>(<span style="color:#0ff;font-weight:bold">&#34;INSERT INTO ...&#34;</span>, ...);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="实现web-mvc">实现Web MVC<a hidden class="anchor" aria-hidden="true" href="#实现web-mvc">#</a></h1>
<p>现在，我们已经实现了IoC容器、AOP、JdbcTemplate和声明式事务，离一个完整的框架只差一个Web MVC了。</p>
<p>我们先看看Spring的Web MVC主要提供了哪些组件和API支持：</p>
<ol>
<li>一个<code>DispatcherServlet</code>作为核心处理组件，接收所有URL请求，然后按MVC规则转发；</li>
<li>基于<code>@Controller</code>注解的URL控制器，由应用程序提供，Spring负责解析规则；</li>
<li>提供<code>ViewResolver</code>，将应用程序的Controller处理后的结果进行渲染，给浏览器返回页面；</li>
<li>基于<code>@RestController</code>注解的REST处理机制，由应用程序提供，Spring负责将输入输出变为JSON格式；</li>
<li>多种拦截器和异常处理器等。</li>
</ol>
<p>Spring的Web MVC功能十分强大，涉及到的内容也非常广。相比之下，Summer Framework的Web MVC必然要聚焦在核心组件上：</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">Spring Framework</th>
<th style="text-align:left">Summer Framework</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">DispatcherServlet</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">支持</td>
</tr>
<tr>
<td style="text-align:left">@Controller注解</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">支持</td>
</tr>
<tr>
<td style="text-align:left">@RestController注解</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">支持</td>
</tr>
<tr>
<td style="text-align:left">ViewResolver</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">支持</td>
</tr>
<tr>
<td style="text-align:left">HandlerInterceptor</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">Exception Handler</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">CORS</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">异步处理</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
<tr>
<td style="text-align:left">WebSocket</td>
<td style="text-align:left">支持</td>
<td style="text-align:left">不支持</td>
</tr>
</tbody>
</table>
<p>不过，Spring Framework的Web MVC模块对<code>Filter</code>支持有限，要想愉快地使用<code>Filter</code>，最好通过Spring Boot提供的<code>FilterRegistrationBean</code>，Summer Framework为了便于应用程序开发自己的<code>Filter</code>，直接支持<code>FilterRegistrationBean</code>。</p>
<p>下面开始正式开发Summer Framework的Web MVC模块。</p>
<h2 id="启动ioc容器">启动IoC容器<a hidden class="anchor" aria-hidden="true" href="#启动ioc容器">#</a></h2>
<p>在开发Web MVC模块之前，我们首先回顾下Java Web应用程序到底有几方参与。</p>
<p>首先，Java Web应用一般遵循Servlet标准，这个标准定义了应用程序可以按接口编写哪些组件：Servlet、Filter和Listener，也规定了一个服务器（如Tomcat、Jetty、JBoss等）应该提供什么样的服务，按什么顺序加载应用程序的组件，最后才能跑起来处理来自用户的HTTP请求。</p>
<p>Servlet规范定义的组件有3类：</p>
<ol>
<li>Servlet：处理HTTP请求，然后输出响应；</li>
<li>Filter：对HTTP请求进行过滤，可以有多个Filter形成过滤器链，实现权限检查、限流、缓存等逻辑；</li>
<li>Listener：用来监听Web应用程序产生的事件，包括启动、停止、Session有修改等。</li>
</ol>
<p>这些组件均由应用程序实现。</p>
<p>而服务器为一个应用程序提供一个“容器”，即Servlet Container，一个Server可以同时跑多个Container，不同的Container可以按URL、域名等区分，Container才是用来管理Servlet、Filter、Listener这些组件的：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>┌─────────────────────────────────────┐
</span></span><span style="display:flex;"><span>│Web Server                           │
</span></span><span style="display:flex;"><span>│┌───────────────────────────────────┐│
</span></span><span style="display:flex;"><span>││Servlet Container                  ││
</span></span><span style="display:flex;"><span>││┌────────┐┌────────┐┌────────┐     ││
</span></span><span style="display:flex;"><span>│││Servlet ││Servlet ││Servlet │ ... ││
</span></span><span style="display:flex;"><span>││└────────┘└────────┘└────────┘     ││
</span></span><span style="display:flex;"><span>││┌────────┐┌────────┐┌────────┐     ││
</span></span><span style="display:flex;"><span>│││Filter  ││Filter  ││Filter  │ ... ││
</span></span><span style="display:flex;"><span>││└────────┘└────────┘└────────┘     ││
</span></span><span style="display:flex;"><span>││┌────────┐┌────────┐┌────────┐     ││
</span></span><span style="display:flex;"><span>│││Listener││Listener││Listener│ ... ││
</span></span><span style="display:flex;"><span>││└────────┘└────────┘└────────┘     ││
</span></span><span style="display:flex;"><span>│└───────────────────────────────────┘│
</span></span><span style="display:flex;"><span>│┌───────────────────────────────────┐│
</span></span><span style="display:flex;"><span>││Servlet Container                  ││
</span></span><span style="display:flex;"><span>││                                   ││
</span></span><span style="display:flex;"><span>│└───────────────────────────────────┘│
</span></span><span style="display:flex;"><span>└─────────────────────────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>另一个需要特别重要的问题是：组件由谁创建，由谁销毁。</p>
<p>在使用IoC容器时，注意到IoC容器也是一个Java类，IoC容器又管理着很多Bean，因此，创建顺序是：</p>
<ol>
<li>执行应用程序的入口方法<code>main()</code>；</li>
<li>在<code>main()</code>方法中，创建IoC容器的实例；</li>
<li>IoC容器在它的内部创建各个Bean的实例。</li>
</ol>
<p>现在，我们开发的是Web应用程序，它本身就是一堆组件，被Web服务器提供的Servlet“容器”管理，同时，又要加一个IoC容器，到底谁创建谁，谁管理谁，这个问题，必须要搞清楚。</p>
<p>首先，我们不能改变Servlet规范，所以，Servlet、Filter、Listener，以及IoC容器，都必须在Servlet容器内被管理：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>         ┌────────────────────────────────────────────┐
</span></span><span style="display:flex;"><span>         │Servlet Container                           │
</span></span><span style="display:flex;"><span>         │                        ┌──────────────────┐│
</span></span><span style="display:flex;"><span>         │                        │IoC Container     ││
</span></span><span style="display:flex;"><span>         │  ┌──────┐   ┌───────┐  │  ┌────────────┐  ││
</span></span><span style="display:flex;"><span>Request ─┼─▶│Filter│──▶│Servlet│──┼─▶│Controller  │  ││
</span></span><span style="display:flex;"><span>         │  └──────┘   └───────┘  │  └────────────┘  ││
</span></span><span style="display:flex;"><span>         │                        │         │        ││
</span></span><span style="display:flex;"><span>         │  ┌────────┐            │         ▼        ││
</span></span><span style="display:flex;"><span>         │  │Listener│            │  ┌────────────┐  ││
</span></span><span style="display:flex;"><span>         │  └────────┘            │  │UserService │  ││
</span></span><span style="display:flex;"><span>         │                        │  └────────────┘  ││
</span></span><span style="display:flex;"><span>         │                        │         │        ││
</span></span><span style="display:flex;"><span>         │                        │         ▼        ││
</span></span><span style="display:flex;"><span>         │                        │  ┌────────────┐  ││
</span></span><span style="display:flex;"><span>         │                        │  │JdbcTemplate│  ││
</span></span><span style="display:flex;"><span>         │                        │  └────────────┘  ││
</span></span><span style="display:flex;"><span>         │                        └──────────────────┘│
</span></span><span style="display:flex;"><span>         └────────────────────────────────────────────┘
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以我们要捋清楚这些组件的创建顺序，以及谁创建谁。</p>
<p>对于一个Web应用程序来说，启动时，应用程序本身只是一个<code>war</code>包，并没有<code>main()</code>方法，因此，启动时执行的是Server的<code>main()</code>方法。以Tomcat服务器为例：</p>
<ol>
<li>启动服务器，即执行Tomcat的<code>main()</code>方法；</li>
<li>Tomcat根据配置或自动检测到一个<code>xyz.war</code>包后，为这个<code>xyz.war</code>应用程序创建Servlet容器；</li>
<li>Tomcat继续查找<code>xyz.war</code>定义的Servlet、Filter和Listener组件，按顺序实例化每个组件（Listener最先被实例化，然后是Filter，最后是Servlet）；</li>
<li>用户发送HTTP请求，Tomcat收到请求后，转发给Servlet容器，容器根据应用程序定义的映射，把请求发送个若干Filter和一个Servlet处理；</li>
<li>处理期间产生的事件则由Servlet容器自动调用Listener。</li>
</ol>
<p>其中，第3步实例化又有很多方式：</p>
<ol>
<li>通过在<code>web.xml</code>配置文件中定义，这也是早期Servlet规范唯一的配置方式；</li>
<li>通过注解<code>@WebServlet</code>、<code>@WebFilter</code>和<code>@WebListener</code>定义，由Servlet容器自动扫描所有class后创建组件，这和我们用Annotation配置Bean，由IoC容器自动扫描创建Bean非常类似；</li>
<li>先配置一个<code>Listener</code>，由Servlet容器创建<code>Listener</code>，然后，<code>Listener</code>自己调用相关接口，手动创建<code>Servlet</code>和<code>Filter</code>。</li>
</ol>
<p>到底用哪种方式，取决于Web应用程序自己如何编写。对于使用Spring框架的Web应用程序来说，Servlet、Filter和Listener数量少，而且是固定的，应用程序自身编写的Controller数量不定，但由IoC容器管理，因此，采用方式3最合适。</p>
<p>具体来说，Tomcat启动一个基于Spring开发的Web应用程序时，按如下步骤初始化：</p>
<ol>
<li>为Web应用程序准备Servlet容器；</li>
<li>根据配置实例化一个Spring提供的<code>Listener</code>；
<ol>
<li>Spring提供的<code>Listener</code>在初始化时启动IoC容器；</li>
<li>Spring提供的<code>Listener</code>在初始化时向Servlet容器注册Spring内置的一个<code>DispatcherServlet</code>。</li>
</ol>
</li>
</ol>
<p>当Tomcat把HTTP请求发送给Spring注册的<code>Servlet</code>后，因为它持有IoC容器的引用，就可以找到<code>Controller</code>实例，因此，可以把请求继续转发给对应的Controller，这样就完成了HTTP请求的处理。</p>
<p>另外注意到Web应用程序除了提供<code>Controller</code>外，并不必须与Servlet API打交道，因为被Spring提供的<code>DispatcherServlet</code>给隔离了。</p>
<p>所以，我们在开发Summer Framework的Web MVC模块时，应该以如下方式初始化：</p>
<ol>
<li>应用程序必须配置一个Summer Framework提供的Listener；</li>
<li>Tomcat完成Servlet容器的创建后，立刻根据配置创建Listener；
<ol>
<li>Listener初始化时创建IoC容器；</li>
<li>Listener继续创建DispatcherServlet实例，并向Servlet容器注册；</li>
<li>DispatcherServlet初始化时获取到IoC容器中的Controller实例，因此可以根据URL调用不同Controller实例的不同处理方法。</li>
</ol>
</li>
</ol>
<p>我们先写一个只能输出Hello World的Servlet：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DispatcherServlet <span style="color:#fff;font-weight:bold">extends</span> HttpServlet {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doGet(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        PrintWriter pw = resp.<span style="color:#007f7f">getWriter</span>();
</span></span><span style="display:flex;"><span>        pw.<span style="color:#007f7f">write</span>(<span style="color:#0ff;font-weight:bold">&#34;&lt;h1&gt;Hello, world!&lt;/h1&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>        pw.<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>紧接着，编写一个<code>ContextLoaderListener</code>，它实现了<code>ServletContextListener</code>接口，能监听Servlet容器的启动和销毁，在监听到初始化事件时，完成创建IoC容器和注册<code>DispatcherServlet</code>两个工作：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ContextLoaderListener <span style="color:#fff;font-weight:bold">implements</span> ServletContextListener {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Servlet容器启动时自动调用:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> contextInitialized(ServletContextEvent sce) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 创建IoC容器:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        var applicationContext = createApplicationContext(...);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 实例化DispatcherServlet:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        var dispatcherServlet = <span style="color:#fff;font-weight:bold">new</span> DispatcherServlet();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 注册DispatcherServlet:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        var dispatcherReg = servletContext.<span style="color:#007f7f">addServlet</span>(<span style="color:#0ff;font-weight:bold">&#34;dispatcherServlet&#34;</span>, dispatcherServlet);
</span></span><span style="display:flex;"><span>        dispatcherReg.<span style="color:#007f7f">addMapping</span>(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>);
</span></span><span style="display:flex;"><span>        dispatcherReg.<span style="color:#007f7f">setLoadOnStartup</span>(<span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样，我们就完成了Web应用程序的初始化全部流程！</p>
<p>最后两个小问题：</p>
<ol>
<li>创建IoC容器时，需要的配置文件从哪读？这里我们采用Spring Boot的方式，默认从classpath的<code>application.yml</code>或<code>application.properties</code>读。</li>
<li>需要的<code>@Configuration</code>配置类从哪获取？这是通过<code>web.xml</code>文件配置的：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;web-app</span> <span style="color:#f00">...</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;context-param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">&lt;!-- 固定名称 --&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;param-name&gt;</span>configuration<span style="font-weight:bold">&lt;/param-name&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">&lt;!-- 配置类的完整类名 --&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;param-value&gt;</span>com.itranswarp.summer.webapp.WebAppConfig<span style="font-weight:bold">&lt;/param-value&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/context-param&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;listener&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;listener-class&gt;</span>com.itranswarp.summer.web.ContextLoaderListener<span style="font-weight:bold">&lt;/listener-class&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/listener&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/web-app&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>ContextLoaderListener</code>的<code>contextInitialized()</code>方法内，先获取<code>ServletContext</code>引用，再通过<code>getInitParameter(&quot;configuration&quot;)</code>拿到完整类名，就可以顺利创建IoC容器了。</p>
<p>用Maven打包后，把生成的<code>xyz.war</code>改为<code>ROOT.war</code>，复制到Tomcat的<code>webapps</code>目录下，清除掉其他webapp，启动Tomcat，输入<code>http://localhost:8080</code>可看到输出<code>Hello, world!</code>。</p>
<p>这样我们就跑通了一个Web应用程序启动的全部流程。</p>
<h2 id="实现mvc">实现MVC<a hidden class="anchor" aria-hidden="true" href="#实现mvc">#</a></h2>
<p>上一节我们把Web应用程序的流程跑通了，因此，本节重点就在如何继续开发<code>DispatcherServlet</code>，因为整个MVC的处理都是在<code>DispatcherServlet</code>内部完成的。</p>
<p>要处理MVC，我们先定义<code>@Controller</code>和<code>@RestController</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Target(ElementType.<span style="color:#007f7f">TYPE</span>)
</span></span><span style="display:flex;"><span>@Retention(RetentionPolicy.<span style="color:#007f7f">RUNTIME</span>)
</span></span><span style="display:flex;"><span>@Documented
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> @interface Controller {
</span></span><span style="display:flex;"><span>    String value() <span style="color:#fff;font-weight:bold">default</span> <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Target(ElementType.<span style="color:#007f7f">TYPE</span>)
</span></span><span style="display:flex;"><span>@Retention(RetentionPolicy.<span style="color:#007f7f">RUNTIME</span>)
</span></span><span style="display:flex;"><span>@Documented
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> @interface RestController {
</span></span><span style="display:flex;"><span>    String value() <span style="color:#fff;font-weight:bold">default</span> <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>以及<code>@GetMapping</code>、<code>@PostMapping</code>等注解，来标识MVC处理的方法。</p>
<p><code>DispatcherServlet</code>内部负责从IoC容器找出所有<code>@Controller</code>和<code>@RestController</code>定义的Bean，扫描它们的方法，找出<code>@GetMapping</code>和<code>@PostMapping</code>标识的方法，这样就有了一个处理特定URL的处理器，我们抽象为<code>Dispatcher</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Dispatcher {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 是否返回REST:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">boolean</span> isRest;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 是否有@ResponseBody:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">boolean</span> isResponseBody;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 是否返回void:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">boolean</span> isVoid;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// URL正则匹配:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Pattern urlPattern;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Bean实例:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Object controller;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 处理方法:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Method handlerMethod;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 方法参数:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Param[] methodParameters;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>方法参数也需要根据<code>@RequestParam</code>、<code>@RequestBody</code>等抽象出<code>Param</code>类型：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Param {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 参数名称:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String name;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 参数类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ParamType paramType;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 参数Class类型:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Class&lt;?&gt; classType;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 参数默认值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String defaultValue;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>一共有4种类型的参数，我们用枚举<code>ParamType</code>定义：</p>
<ul>
<li><code>PATH_VARIABLE</code>：路径参数，从URL中提取；</li>
<li><code>REQUEST_PARAM</code>：URL参数，从URL Query或Form表单提取；</li>
<li><code>REQUEST_BODY</code>：REST请求参数，从Post传递的JSON提取；</li>
<li><code>SERVLET_VARIABLE</code>：<code>HttpServletRequest</code>等Servlet API提供的参数，直接从<code>DispatcherServlet</code>的方法参数获得。</li>
</ul>
<p>这样，<code>DispatcherServlet</code>通过反射拿到一组<code>Dispatcher</code>对象，在<code>doGet()</code>和<code>doPost()</code>方法中，依次匹配URL：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DispatcherServlet <span style="color:#fff;font-weight:bold">extends</span> HttpServlet {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    List&lt;Dispatcher&gt; getDispatchers = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>    List&lt;Dispatcher&gt; postDispatchers = <span style="color:#fff;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doGet(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        String url = req.<span style="color:#007f7f">getRequestURI</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 依次匹配每个Dispatcher的URL:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">for</span> (Dispatcher dispatcher : getDispatchers) {
</span></span><span style="display:flex;"><span>            Result result = dispatcher.<span style="color:#007f7f">process</span>(url, req, resp);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 匹配成功并处理后:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (result.<span style="color:#007f7f">processed</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 处理结果
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                ...
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 未匹配到任何Dispatcher:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        resp.<span style="color:#007f7f">sendError</span>(<span style="color:#ff0;font-weight:bold">404</span>, <span style="color:#0ff;font-weight:bold">&#34;Not Found&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doPost(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里不能用<code>Map&lt;String, Dispatcher&gt;</code>的原因在于我们要处理类似<code>/hello/{name}</code>这样的URL，没法使用精确查找，只能使用正则匹配。</p>
<p><code>Dispatcher</code>处理后返回类型包括：</p>
<ul>
<li><code>void</code>或<code>null</code>：表示内部已处理完毕；</li>
<li><code>String</code>：如果以<code>redirect:</code>开头，则表示一个重定向；</li>
<li><code>String</code>或<code>byte[]</code>：如果配合<code>@ResponseBody</code>，则表示返回值直接写入响应；</li>
<li><code>ModelAndView</code>：表示这是一个MVC响应，包含Model和View名称，后续用模板引擎处理后写入响应；</li>
<li>其它类型：如果是<code>@RestController</code>，则序列化为JSON后写入响应。</li>
</ul>
<p>不符合上述要求的返回类型则报500错误。</p>
<p>这些处理逻辑都十分简单，我们重点看看如何处理<code>ModelAndView</code>类型，即MVC响应。</p>
<p>为了处理<code>ModelAndView</code>，我们需要一个模板引擎，因此，抽象出<code>ViewResolver</code>接口：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> ViewResolver {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 初始化ViewResolver:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">void</span> init();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 渲染:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">void</span> render(String viewName, Map&lt;String, Object&gt; model, HttpServletRequest req, HttpServletResponse resp);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Spring内置FreeMarker引擎，因此我们也把FreeMarker集成进来，写一个<code>FreeMarkerViewResolver</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FreeMarkerViewResolver <span style="color:#fff;font-weight:bold">implements</span> ViewResolver {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> String templatePath;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> String templateEncoding;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> ServletContext servletContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Configuration config;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FreeMarkerViewResolver(ServletContext servletContext, String templatePath, String templateEncoding) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span> = servletContext;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">templatePath</span> = templatePath;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">templateEncoding</span> = templateEncoding;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init() {
</span></span><span style="display:flex;"><span>        Configuration cfg = <span style="color:#fff;font-weight:bold">new</span> Configuration(Configuration.<span style="color:#007f7f">VERSION_2_3_32</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setOutputFormat</span>(HTMLOutputFormat.<span style="color:#007f7f">INSTANCE</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setDefaultEncoding</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">templateEncoding</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setTemplateLoader</span>(<span style="color:#fff;font-weight:bold">new</span> ServletTemplateLoader(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">servletContext</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">templatePath</span>));
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setTemplateExceptionHandler</span>(TemplateExceptionHandler.<span style="color:#007f7f">HTML_DEBUG_HANDLER</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setAutoEscapingPolicy</span>(Configuration.<span style="color:#007f7f">ENABLE_IF_SUPPORTED_AUTO_ESCAPING_POLICY</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setLocalizedLookup</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        var ow = <span style="color:#fff;font-weight:bold">new</span> DefaultObjectWrapper(Configuration.<span style="color:#007f7f">VERSION_2_3_32</span>);
</span></span><span style="display:flex;"><span>        ow.<span style="color:#007f7f">setExposeFields</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        cfg.<span style="color:#007f7f">setObjectWrapper</span>(ow);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">config</span> = cfg;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> render(String viewName, Map&lt;String, Object&gt; model, HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        Template templ = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            templ = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">config</span>.<span style="color:#007f7f">getTemplate</span>(viewName);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ServerErrorException(<span style="color:#0ff;font-weight:bold">&#34;View not found: &#34;</span> + viewName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        PrintWriter pw = resp.<span style="color:#007f7f">getWriter</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            templ.<span style="color:#007f7f">process</span>(model, pw);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (TemplateException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> ServerErrorException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        pw.<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样我们就可以在<code>DispatcherServlet</code>内部，把处理ModelAndView和ViewResolver结合起来，最终向<code>HttpServletResponse</code>中输出HTML，完成HTTP请求的处理。</p>
<p>为了简化Web应用程序配置，我们提供一个<code>WebMvcConfiguration</code>配置：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WebMvcConfiguration {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> ServletContext servletContext = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setServletContext(ServletContext ctx) {
</span></span><span style="display:flex;"><span>        servletContext = ctx;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(initMethod = <span style="color:#0ff;font-weight:bold">&#34;init&#34;</span>)
</span></span><span style="display:flex;"><span>    ViewResolver viewResolver( <span style="color:#007f7f">//
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            @Autowired ServletContext servletContext, <span style="color:#007f7f">//
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.web.freemarker.template-path:/WEB-INF/templates}&#34;</span>) String templatePath, <span style="color:#007f7f">//
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            @Value(<span style="color:#0ff;font-weight:bold">&#34;${summer.web.freemarker.template-encoding:UTF-8}&#34;</span>) String templateEncoding) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> FreeMarkerViewResolver(servletContext, templatePath, templateEncoding);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    ServletContext servletContext() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> Objects.<span style="color:#007f7f">requireNonNull</span>(servletContext, <span style="color:#0ff;font-weight:bold">&#34;ServletContext is not set.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>默认创建一个<code>ViewResolver</code>和<code>ServletContext</code>，注意<code>ServletContext</code>本身实际上是由Servlet容器提供的，但我们把它放入IoC容器，是因为许多涉及到Web的组件，如<code>ViewResolver</code>，需要注入<code>ServletContext</code>，才能从指定配置加载文件。</p>
<p>最后，整理代码，添加一些能方便用户开发的额外功能，例如处理静态文件等功能，我们的Web MVC模块就开发完毕！</p>
<h3 id="注意事项">注意事项<a hidden class="anchor" aria-hidden="true" href="#注意事项">#</a></h3>
<p>在整个HTTP处理流程中，入口是<code>DispatcherServlet</code>的<code>service()</code>方法，整个流程如下：</p>
<ol>
<li>Servlet容器调用<code>DispatcherServlet</code>的<code>service()</code>方法处理HTTP请求；</li>
<li><code>service()</code>根据GET或POST调用<code>doGet()</code>或<code>doPost()</code>方法；</li>
<li>根据URL依次匹配<code>Dispatcher</code>，匹配后调用<code>process()</code>方法，获得返回值；</li>
<li>根据返回值写入响应：
<ol>
<li>void或null返回值无需写入响应；</li>
<li>String或byte[]返回值直接写入响应（或重定向）；</li>
<li>REST类型写入JSON序列化结果；</li>
<li>ModelAndView类型调用ViewResolver写入渲染结果。</li>
</ol>
</li>
<li>未匹配到判断是否静态资源：
<ol>
<li>符合静态目录（默认<code>/static/</code>）则读取文件，写入文件内容；</li>
<li>网站图标（默认<code>/favicon.ico</code>）则读取<code>.ico</code>文件，写入文件内容；</li>
</ol>
</li>
<li>其他情况返回404。</li>
</ol>
<p>由于在处理的每一步都可以向<code>HttpServletResponse</code>写入响应，因此，后续步骤写入时，应判断前面的步骤是否已经写入并发送了HTTP Header。<code>isCommitted()</code>方法就是干这个用的：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> (!resp.<span style="color:#007f7f">isCommitted</span>()) {
</span></span><span style="display:flex;"><span>    resp.<span style="color:#007f7f">resetBuffer</span>();
</span></span><span style="display:flex;"><span>    writeTo(resp);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="测试-1">测试<a hidden class="anchor" aria-hidden="true" href="#测试-1">#</a></h3>
<p><code>DispatcherServlet</code>处理HTTP请求时，一些组件是Servlet容器提供的，如：</p>
<ul>
<li>HttpServletRequest；</li>
<li>HttpServletResponse；</li>
<li>HttpSession；</li>
<li>ServletContext。</li>
</ul>
<p>要模拟这些对象用<a href="https://site.mockito.org/">Mockito</a>之类的框架代码量也很大，我们可以借用Spring提供的test模块，它实现了完善的MockHttpServletRequest、MockServletContext等对象，便于测试。我们导入：</p>
<ul>
<li>org.springframework:spring-test:6.0.0</li>
<li>org.springframework:spring-web:6.0.0</li>
</ul>
<p>注意设置<code>&lt;scope&gt;test&lt;/scope&gt;</code>，即仅在测试代码中用到了Spring提供的Mock对象，业务代码并不会用到Spring的任何功能。一个简单的测试用例如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">void</span> getGreeting() <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建MockHttpServletRequest:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    var req = createMockRequest(<span style="color:#0ff;font-weight:bold">&#34;GET&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;/greeting&#34;</span>, <span style="color:#fff;font-weight:bold">null</span>, Map.<span style="color:#007f7f">of</span>(<span style="color:#0ff;font-weight:bold">&#34;name&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;Bob&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建MockHttpServletResponse:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    var resp = createMockResponse();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 处理请求:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">dispatcherServlet</span>.<span style="color:#007f7f">service</span>(req, resp);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 验证200响应:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    assertEquals(<span style="color:#ff0;font-weight:bold">200</span>, resp.<span style="color:#007f7f">getStatus</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 验证响应内容:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    assertEquals(<span style="color:#0ff;font-weight:bold">&#34;Hello, Bob&#34;</span>, resp.<span style="color:#007f7f">getContentAsString</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="开发web应用">开发Web应用<a hidden class="anchor" aria-hidden="true" href="#开发web应用">#</a></h2>
<p>在我们开发完Summer Framework的所有组件后，就可以基于Summer Framework来开发一个真正的Web应用了！</p>
<p>我们来一步一步创建一个<code>hello-webapp</code>的应用，它基于Maven项目，符合webapp标准。</p>
<p>首先，我们在<code>src/main/resources</code>下定义配置文件<code>application.yml</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">app</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">title</span>: Hello Application
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">version</span>: <span style="color:#ff0;font-weight:bold">1.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">summer</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:sqlite:test.db
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">driver-class-name</span>: org.sqlite.JDBC
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: sa
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: 
</span></span></code></pre></td></tr></table>
</div>
</div><p>紧接着，定义IoC容器的配置类如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@Import({ JdbcConfiguration.<span style="color:#007f7f">class</span>, WebMvcConfiguration.<span style="color:#007f7f">class</span> })
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HelloConfiguration {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>以及相关的<code>UserService</code>、<code>MvcController</code>等Bean。</p>
<p>接下来是在<code>src/main/webapp/WEB-INF</code>目录下创建Servlet容器所需的配置文件<code>web.xml</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;web-app</span> <span style="color:#f00">...</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;display-name&gt;</span>Hello Webapp<span style="font-weight:bold">&lt;/display-name&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;context-param&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;param-name&gt;</span>configuration<span style="font-weight:bold">&lt;/param-name&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;param-value&gt;</span>com.itranswarp.hello.HelloConfiguration<span style="font-weight:bold">&lt;/param-value&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/context-param&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;listener&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;listener-class&gt;</span>com.itranswarp.summer.web.ContextLoaderListener<span style="font-weight:bold">&lt;/listener-class&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/listener&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/web-app&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Servlet容器会自动读取<code>web.xml</code>，根据配置的Listener启动Summer Framework的web模块的<code>ContextLoaderListener</code>，它又会读取<code>web.xml</code>配置的<code>&lt;context-param&gt;</code>获得配置类的全名<code>com.itranswarp.hello.HelloConfiguration</code>，最后用这个配置类完成IoC容器的创建。创建后自动注册Summer Framework的<code>DispatcherServlet</code>，以及Web应用程序定义的<code>FilterRegistrationBean</code>，这样就完成了整个Web应用程序的初始化。</p>
<p>其他用到的资源包括：</p>
<ul>
<li>存储在<code>src/main/webapp/static</code>目录下的静态资源；</li>
<li>存储于<code>src/main/webapp/favicon.ico</code>的图标文件；</li>
<li>存储在<code>src/main/webapp/WEB-INF/templates</code>目录下的模板。</li>
</ul>
<p>最后，运行<code>mvn clean package</code>命令，在<code>target</code>目录得到最终的war包，改名为<code>ROOT.war</code>，复制到Tomcat的<code>webapps</code>目录下，启动Tomcat，可以正常访问<code>http://localhost:8080</code>：</p>
<h1 id="实现boot">实现Boot<a hidden class="anchor" aria-hidden="true" href="#实现boot">#</a></h1>
<p>虽然基于Summer Framework可以开发一个完整的Web应用程序，但是，开发过程还是涉及到先打包，再复制到Tomcat的webapps目录，再启动Tomcat。在开发过程中，经常需要反复来好多次，每次停止、复制、启动，要调试还要接入远程，搞着搞着就会发现，这种开发模式太麻烦。</p>
<p>直接用Spring Framework开发Web应用也是一样，所以才有了Spring Boot，它最让人省心的一点，就是不用装Tomcat，不用复制war包，打个jar包直接就能跑！</p>
<p>所以，为了简化开发流程，我们也仿照Spring Boot，编写一个<code>boot</code>模块，能直接启动运行！</p>
<p>注意Spring Boot除了直接打包运行外，还提供很多其他功能，而Summer Framework的boot模块只提供打包运行功能，无其他额外功能。</p>
<p>下面开始正式开发Summer Framework的boot模块。</p>
<h2 id="启动嵌入式tomcat">启动嵌入式Tomcat<a hidden class="anchor" aria-hidden="true" href="#启动嵌入式tomcat">#</a></h2>
<p>Spring Boot实现一个jar包直接运行的原理其实就是把Tomcat打包进去，自己再写个<code>main()</code>函数：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@SpringBootApplication
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        SpringApplication.<span style="color:#007f7f">run</span>(AppConfig.<span style="color:#007f7f">class</span>, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>SpringApplication.run()</code>方法内，Spring Boot会启动嵌入式Tomcat，然后再初始化Spring的IoC容器，实际上就是一个jar包内包含了嵌入式Tomcat、Spring IoC容器、Web MVC模块以及应用程序自己开发的Bean。</p>
<p>因此，我们也提供一个<code>SummerApplication</code>，实现<code>run()</code>方法如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SummerApplication {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> run(String webDir, String baseDir, Class&lt;?&gt; configClass, String... args) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 读取application.yml配置:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        var propertyResolver = WebUtils.<span style="color:#007f7f">createPropertyResolver</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 创建Tomcat服务器:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        var server = startTomcat(webDir, baseDir, configClass, propertyResolver);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 等待服务器结束:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        server.<span style="color:#007f7f">await</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里多了两个参数：<code>webDir</code>和<code>baseDir</code>，这是为启动嵌入式Tomcat准备的，启动嵌入式Tomcat的代码如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Server startTomcat(String webDir, String baseDir, Class&lt;?&gt; configClass, PropertyResolver propertyResolver) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> port = propertyResolver.<span style="color:#007f7f">getProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;${server.port:8080}&#34;</span>, <span style="color:#fff;font-weight:bold">int</span>.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 实例化Tomcat Server:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Tomcat tomcat = <span style="color:#fff;font-weight:bold">new</span> Tomcat();
</span></span><span style="display:flex;"><span>    tomcat.<span style="color:#007f7f">setPort</span>(port);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 设置Connector:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    tomcat.<span style="color:#007f7f">getConnector</span>().<span style="color:#007f7f">setThrowOnFailure</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 添加一个默认的Webapp，挂载在&#39;/&#39;:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Context ctx = tomcat.<span style="color:#007f7f">addWebapp</span>(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> File(webDir).<span style="color:#007f7f">getAbsolutePath</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 设置应用程序的目录:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    WebResourceRoot resources = <span style="color:#fff;font-weight:bold">new</span> StandardRoot(ctx);
</span></span><span style="display:flex;"><span>    resources.<span style="color:#007f7f">addPreResources</span>(<span style="color:#fff;font-weight:bold">new</span> DirResourceSet(resources, <span style="color:#0ff;font-weight:bold">&#34;/WEB-INF/classes&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> File(baseDir).<span style="color:#007f7f">getAbsolutePath</span>(), <span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>));
</span></span><span style="display:flex;"><span>    ctx.<span style="color:#007f7f">setResources</span>(resources);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 设置ServletContainerInitializer监听器:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    ctx.<span style="color:#007f7f">addServletContainerInitializer</span>(<span style="color:#fff;font-weight:bold">new</span> ContextLoaderInitializer(configClass, propertyResolver), Set.<span style="color:#007f7f">of</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 启动服务器:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    tomcat.<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> tomcat.<span style="color:#007f7f">getServer</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么我们的IoC容器，以及注册<code>Servlet</code>、<code>Filter</code>是在哪进行的？答案是我们在<code>startTomcat()</code>内注册了一个<code>ServletContainerInitializer</code>监听器，这个监听器负责启动IoC容器与注册<code>Servlet</code>、<code>Filter</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ContextLoaderInitializer <span style="color:#fff;font-weight:bold">implements</span> ServletContainerInitializer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Class&lt;?&gt; configClass;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> PropertyResolver propertyResolver;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ContextLoaderInitializer(Class&lt;?&gt; configClass, PropertyResolver propertyResolver) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">configClass</span> = configClass;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span> = propertyResolver;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onStartup(Set&lt;Class&lt;?&gt;&gt; c, ServletContext ctx) <span style="color:#fff;font-weight:bold">throws</span> ServletException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 设置ServletContext:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        WebMvcConfiguration.<span style="color:#007f7f">setServletContext</span>(ctx);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 启动IoC容器:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ApplicationContext applicationContext = <span style="color:#fff;font-weight:bold">new</span> AnnotationConfigApplicationContext(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">configClass</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 注册Filter与DispatcherServlet:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        WebUtils.<span style="color:#007f7f">registerFilters</span>(ctx);
</span></span><span style="display:flex;"><span>        WebUtils.<span style="color:#007f7f">registerDispatcherServlet</span>(ctx, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">propertyResolver</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>没有复用web模块的<code>ContextLoaderListener</code>是因为Tomcat不允许没有在<code>web.xml</code>中声明的<code>Listener</code>注册<code>Filter</code>与<code>Servlet</code>，而我们写boot模块原因之一也是要做到不需要<code>web.xml</code>。</p>
<p>这样我们就完成了boot模块的开发，它其实就包含两个组件：</p>
<ul>
<li>SummerApplication：负责启动嵌入式Tomcat；</li>
<li>ContextLoaderInitializer：负责启动IoC容器，注册<code>Filter</code>与<code>DispatcherServlet</code>。</li>
</ul>
<p>下面就可以编写一个基于<code>boot</code>的Web应用程序了。</p>
<h2 id="开发boot应用">开发Boot应用<a hidden class="anchor" aria-hidden="true" href="#开发boot应用">#</a></h2>
<p>我们已经准备好boot模块了，下一步是使用boot来开发Web应用程序。</p>
<p>我们还是先定义一个符合Maven结构的Web应用程序<code>hello-boot</code>，先定义配置类<code>HelloConfiguration</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@Import({ JdbcConfiguration.<span style="color:#007f7f">class</span>, WebMvcConfiguration.<span style="color:#007f7f">class</span> })
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HelloConfiguration {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>以及<code>UserService</code>、<code>MvcController</code>等业务Bean。</p>
<p>我们直接写个<code>main()</code>方法启动：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Main {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        SummerApplication.<span style="color:#007f7f">run</span>(<span style="color:#0ff;font-weight:bold">&#34;src/main/webapp&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;target/classes&#34;</span>, HelloConfiguration.<span style="color:#007f7f">class</span>, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>直接从IDE运行，是没有问题的，能顺利启动Tomcat、创建IoC容器、注册<code>Filter</code>和<code>DispatcherServlet</code>，可以直接通过浏览器访问。</p>
<p>但是，如果打一个war包，直接运行<code>java -jar xyz.war</code>是不行的！会直接报错：找不到Main这个class！</p>
<p>这是为什么呢？我们要从JVM的类加载机制说起。</p>
<p>当我们用<code>java</code>启动一个Java程序时，需要用<code>-cp</code>参数设置classpath（默认为当前目录<code>.</code>）；当我们用<code>java -jar xyz.jar</code>启动一个Java程序时，JVM忽略<code>-cp</code>参数，默认classpath为<code>xyz.jar</code>，这样，如果能在jar包中找到对应的class，就可以正常运行。</p>
<p>要注意的一点是，JVM从jar包加载class，是从jar包的根目录查找的。如果它要加载<code>com.itranswarp.hello.Main</code>，那么，<code>xyz.jar</code>必须按如下目录组织：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>xyz.jar
</span></span><span style="display:flex;"><span>└── com
</span></span><span style="display:flex;"><span>    └── itranswarp
</span></span><span style="display:flex;"><span>        └── hello
</span></span><span style="display:flex;"><span>            └── Main.class
</span></span></code></pre></td></tr></table>
</div>
</div><p>而我们在用Maven打war包时，结构是这样的：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>xyz.war
</span></span><span style="display:flex;"><span>└── WEB-INF
</span></span><span style="display:flex;"><span>    └── classes
</span></span><span style="display:flex;"><span>        └── com
</span></span><span style="display:flex;"><span>            └── itranswarp
</span></span><span style="display:flex;"><span>                └── hello
</span></span><span style="display:flex;"><span>                    └── Main.class
</span></span></code></pre></td></tr></table>
</div>
</div><p>自然无法加载<code>Main</code>。（注意jar包和war包仅扩展名不同，对JVM来说是完全一样的）</p>
<p>那为什么我们把<code>xyz.war</code>扔到Tomcat的webapps目录下就能正常运行呢？因为Tomcat启动后，并不使用JVM的ClassLoader加载class，而是为每个webapp创建一个单独的ClassLoader，这个ClassLoader在如下位置搜索class：</p>
<ul>
<li>WEB-INF/classes目录；</li>
<li>WEB-INF/lib目录下的所有jar包。</li>
</ul>
<p>因此，我们要运行的<code>xyz.war</code>包必须同时具有Web App的结构，又能在根目录下搜索到应用程序自己编写的<code>Main</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>xyz.jar
</span></span><span style="display:flex;"><span>├── com
</span></span><span style="display:flex;"><span>│   └── itranswarp
</span></span><span style="display:flex;"><span>│       └── hello
</span></span><span style="display:flex;"><span>│           └── Main.class
</span></span><span style="display:flex;"><span>└── WEB-INF
</span></span><span style="display:flex;"><span>    ├── classes
</span></span><span style="display:flex;"><span>    └── libs
</span></span></code></pre></td></tr></table>
</div>
</div><p>解决方案是在打包时复制所有编译的class到war包根目录，并添加启动类入口。修改<code>pom.xml</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;project</span> <span style="color:#f00">...</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;finalName&gt;</span>${project.name}<span style="font-weight:bold">&lt;/finalName&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;artifactId&gt;</span>maven-war-plugin<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;version&gt;</span>3.3.2<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#007f7f">&lt;!-- 复制classes到war包根目录 --&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;webResources&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;resource&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;directory&gt;</span>${project.build.directory}/classes<span style="font-weight:bold">&lt;/directory&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;/resource&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;/webResources&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;archiveClasses&gt;</span>true<span style="font-weight:bold">&lt;/archiveClasses&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;archive&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;manifest&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="color:#007f7f">&lt;!-- main启动类 --&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;mainClass&gt;</span>com.itranswarp.hello.Main<span style="font-weight:bold">&lt;/mainClass&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;/manifest&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;/archive&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/project&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再次打包，运行，又会得到找不到Class的错误，不过这次是<code>SummerApplication</code>。</p>
<p>这又是什么原因呢？很明显<code>Main</code>已经找到了，但是<code>SummerApplication</code>在哪呢？它其实在<code>WEB-INF/lib/summer-boot-1.x.x.jar</code>，JVM不会在<code>WEB-INF/lib</code>下搜索Class，也不会在一个jar包内搜索“jar包内的jar包”。</p>
<p>怎么破？</p>
<p>答案是<code>Main</code>运行时先自解压，再让JVM能搜索到<code>WEB-INF/lib/summer-boot-1.x.x.jar</code>即可。</p>
<p>需要先修改<code>main()</code>方法代码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 判定是否从jar/war启动:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String jarFile = Main.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getProtectionDomain</span>().<span style="color:#007f7f">getCodeSource</span>().<span style="color:#007f7f">getLocation</span>().<span style="color:#007f7f">getFile</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> isJarFile = jarFile.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.war&#34;</span>) || jarFile.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;.jar&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 定位webapp根目录:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String webDir = isJarFile ? <span style="color:#0ff;font-weight:bold">&#34;tmp-webapp&#34;</span> : <span style="color:#0ff;font-weight:bold">&#34;src/main/webapp&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (isJarFile) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 解压到tmp-webapp:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Path baseDir = Paths.<span style="color:#007f7f">get</span>(webDir).<span style="color:#007f7f">normalize</span>().<span style="color:#007f7f">toAbsolutePath</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (Files.<span style="color:#007f7f">isDirectory</span>(baseDir)) {
</span></span><span style="display:flex;"><span>            Files.<span style="color:#007f7f">delete</span>(baseDir);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Files.<span style="color:#007f7f">createDirectories</span>(baseDir);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;extract to: &#34;</span> + baseDir);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> (JarFile jar = <span style="color:#fff;font-weight:bold">new</span> JarFile(jarFile)) {
</span></span><span style="display:flex;"><span>            List&lt;JarEntry&gt; entries = jar.<span style="color:#007f7f">stream</span>().<span style="color:#007f7f">sorted</span>(Comparator.<span style="color:#007f7f">comparing</span>(JarEntry::getName)).<span style="color:#007f7f">collect</span>(Collectors.<span style="color:#007f7f">toList</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (JarEntry entry : entries) {
</span></span><span style="display:flex;"><span>                Path res = baseDir.<span style="color:#007f7f">resolve</span>(entry.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (!entry.<span style="color:#007f7f">isDirectory</span>()) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(res);
</span></span><span style="display:flex;"><span>                    Files.<span style="color:#007f7f">createDirectories</span>(res.<span style="color:#007f7f">getParent</span>());
</span></span><span style="display:flex;"><span>                    Files.<span style="color:#007f7f">copy</span>(jar.<span style="color:#007f7f">getInputStream</span>(entry), res);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// JVM退出时自动删除tmp-webapp:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">addShutdownHook</span>(<span style="color:#fff;font-weight:bold">new</span> Thread(() -&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                Files.<span style="color:#007f7f">walk</span>(baseDir).<span style="color:#007f7f">sorted</span>(Comparator.<span style="color:#007f7f">reverseOrder</span>()).<span style="color:#007f7f">map</span>(Path::toFile).<span style="color:#007f7f">forEach</span>(File::delete);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>                e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    SummerApplication.<span style="color:#007f7f">run</span>(webDir, isJarFile ? <span style="color:#0ff;font-weight:bold">&#34;tmp-webapp&#34;</span> : <span style="color:#0ff;font-weight:bold">&#34;target/classes&#34;</span>, HelloConfiguration.<span style="color:#007f7f">class</span>, args);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>再修改<code>pom.xml</code>，加上Classpath：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;project</span> <span style="color:#f00">...</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;finalName&gt;</span>${project.name}<span style="font-weight:bold">&lt;/finalName&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;artifactId&gt;</span>maven-war-plugin<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;version&gt;</span>3.3.2<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#007f7f">&lt;!-- 复制classes到war包根目录 --&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;webResources&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;resource&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;directory&gt;</span>${project.build.directory}/classes<span style="font-weight:bold">&lt;/directory&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;/resource&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;/webResources&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;archiveClasses&gt;</span>true<span style="font-weight:bold">&lt;/archiveClasses&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;archive&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;manifest&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="color:#007f7f">&lt;!-- 添加Class-Path --&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;addClasspath&gt;</span>true<span style="font-weight:bold">&lt;/addClasspath&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="color:#007f7f">&lt;!-- Classpath前缀 --&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;classpathPrefix&gt;</span>tmp-webapp/WEB-INF/lib/<span style="font-weight:bold">&lt;/classpathPrefix&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="color:#007f7f">&lt;!-- main启动类 --&gt;</span>
</span></span><span style="display:flex;"><span>							<span style="font-weight:bold">&lt;mainClass&gt;</span>com.itranswarp.hello.Main<span style="font-weight:bold">&lt;/mainClass&gt;</span>
</span></span><span style="display:flex;"><span>						<span style="font-weight:bold">&lt;/manifest&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="font-weight:bold">&lt;/archive&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="font-weight:bold">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="font-weight:bold">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/project&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当我们打包后，我们来分析启动流程。我们先把war包解压到<code>tmp-webapp</code>，它的结构如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>tmp-webapp
</span></span><span style="display:flex;"><span>├── META-INF
</span></span><span style="display:flex;"><span>│   └── MANIFEST.MF
</span></span><span style="display:flex;"><span>├── WEB-INF
</span></span><span style="display:flex;"><span>│   ├── classes
</span></span><span style="display:flex;"><span>│   ├── lib
</span></span><span style="display:flex;"><span>│   │   ├── summer-boot-1.0.3.jar
</span></span><span style="display:flex;"><span>│   │   └── ... other jars ...
</span></span><span style="display:flex;"><span>│   └── templates
</span></span><span style="display:flex;"><span>│       └── ... templates.html
</span></span><span style="display:flex;"><span>├── application.yml
</span></span><span style="display:flex;"><span>├── com
</span></span><span style="display:flex;"><span>│   └── itranswarp
</span></span><span style="display:flex;"><span>│       └── hello
</span></span><span style="display:flex;"><span>│           ├── Main.class
</span></span><span style="display:flex;"><span>│           └── ... other classes ...
</span></span><span style="display:flex;"><span>├── favicon.ico
</span></span><span style="display:flex;"><span>├── logback.xml
</span></span><span style="display:flex;"><span>└── static
</span></span><span style="display:flex;"><span>    └── ... static files ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>可见，<code>com/itranswarp/hello/Main.class</code>、<code>application.yml</code>、<code>logback.xml</code>都位于war包的根目录，可以被JVM的ClassLoader直接加载，而想要加载<code>WEB-INF/lib/summer-boot-1.x.x.jar</code>，我们需要给出Classpath。通过<code>java -jar xyz.war</code>启动时，虽然<code>-cp</code>参数无效，但JVM会自动从<code>META-INF/MANIFEST.MF</code>中读取<code>Class-Path</code>条目，我们用Maven写入后内容如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Manifest-Version: 1.0
</span></span><span style="display:flex;"><span>Created-By: Maven WAR Plugin 3.3.2
</span></span><span style="display:flex;"><span>Build-Jdk-Spec: 17
</span></span><span style="display:flex;"><span>Main-Class: com.itranswarp.hello.Main
</span></span><span style="display:flex;"><span>Class-Path: tmp-webapp/WEB-INF/lib/summer-boot-1.0.3.jar tmp-webapp/WEB-
</span></span><span style="display:flex;"><span> INF/lib/summer-web-1.0.3.jar tmp-webapp/WEB-INF/lib/summer-context-1.0.
</span></span><span style="display:flex;"><span> 3.jar tmp-webapp/WEB-INF/lib/snakeyaml-2.0.jar tmp-webapp/WEB-INF/lib/j
</span></span><span style="display:flex;"><span> ackson-databind-2.14.2.jar tmp-webapp/WEB-INF/lib/jackson-annotations-2
</span></span><span style="display:flex;"><span> .14.2.jar tmp-webapp/WEB-INF/lib/jackson-core-2.14.2.jar tmp-webapp/WEB
</span></span><span style="display:flex;"><span> -INF/lib/jakarta.annotation-api-2.1.1.jar tmp-webapp/WEB-INF/lib/slf4j-
</span></span><span style="display:flex;"><span> api-2.0.7.jar tmp-webapp/WEB-INF/lib/logback-classic-1.4.6.jar tmp-weba
</span></span><span style="display:flex;"><span> pp/WEB-INF/lib/logback-core-1.4.6.jar tmp-webapp/WEB-INF/lib/freemarker
</span></span><span style="display:flex;"><span> -2.3.32.jar tmp-webapp/WEB-INF/lib/summer-jdbc-1.0.3.jar tmp-webapp/WEB
</span></span><span style="display:flex;"><span> -INF/lib/summer-aop-1.0.3.jar tmp-webapp/WEB-INF/lib/byte-buddy-1.14.2.
</span></span><span style="display:flex;"><span> jar tmp-webapp/WEB-INF/lib/HikariCP-5.0.1.jar tmp-webapp/WEB-INF/lib/to
</span></span><span style="display:flex;"><span> mcat-embed-core-10.1.7.jar tmp-webapp/WEB-INF/lib/tomcat-annotations-ap
</span></span><span style="display:flex;"><span> i-10.1.7.jar tmp-webapp/WEB-INF/lib/tomcat-embed-jasper-10.1.7.jar tmp-
</span></span><span style="display:flex;"><span> webapp/WEB-INF/lib/tomcat-embed-el-10.1.7.jar tmp-webapp/WEB-INF/lib/ec
</span></span><span style="display:flex;"><span> j-3.32.0.jar tmp-webapp/WEB-INF/lib/sqlite-jdbc-3.41.2.1.jar
</span></span></code></pre></td></tr></table>
</div>
</div><p>JVM会读取到<code>Main-Class</code>和<code>Class-Path</code>，由于已经解压，就能在<code>tmp-webapp</code>目录中顺利搜索到<code>tmp-webapp/WEB-INF/lib/summer-boot-1.x.x.jar</code>。后续Tomcat启动后，以<code>tmp-webapp</code>作为web目录本身就是标准的Web App，Tomcat的ClassLoader也能继续从<code>WEB-INF/lib</code>加载各种jar包。</p>
<p>我们总结一下，打包时做了哪些工作：</p>
<ul>
<li>复制所有编译的class到war包根目录；</li>
<li>修改META-INF/MANIFEST.MF：
<ul>
<li>添加<code>Main-Class</code>条目；</li>
<li>添加<code>Class-Path</code>条目。</li>
</ul>
</li>
</ul>
<p>运行时的流程如下：</p>
<ol>
<li>JVM从war包加载Main类，执行<code>main()</code>方法；</li>
<li>立刻自解压war包至<code>tmp-webapp</code>目录；</li>
<li>后续加载<code>SummerApplication</code>时，JVM根据Class-Path能找到<code>tmp-webapp/WEB-INF/lib/summer-boot-1.x.x.jar</code>，因此可顺利加载；</li>
<li>启动Tomcat，将<code>tmp-webapp</code>做为Web目录；</li>
<li>作为Web App使用Tomcat的ClassLoader加载其他组件。</li>
</ol>
<p>这样我们就实现了一个可以直接用<code>java -jar xyz.war</code>启动的Web应用程序！</p>
<p>有的同学会问，我们的boot应用，<code>main()</code>方法写了一堆自解压代码，而且，需要在<code>pom.xml</code>中配置很多额外的设置，对比Spring Boot应用，它对<code>main()</code>方法没有任何要求，而且，在<code>pom.xml</code>中也只需配置一个<code>spring-boot-maven-plugin</code>，没有其他额外配置，相比之下简单多了，那么，Spring Boot是如何实现的？</p>
<p>我们找一个Spring Boot打包的jar解压后就明白了，它的jar包结构如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>xyz.jar
</span></span><span style="display:flex;"><span>├── BOOT-INF
</span></span><span style="display:flex;"><span>│   ├── classes
</span></span><span style="display:flex;"><span>│   │   ├── application.yml
</span></span><span style="display:flex;"><span>│   │   ├── logback-spring.xml
</span></span><span style="display:flex;"><span>│   │   ├── static
</span></span><span style="display:flex;"><span>│   │   │   └── ... static files ...
</span></span><span style="display:flex;"><span>│   │   └── templates
</span></span><span style="display:flex;"><span>│   │       └── ... templates ...
</span></span><span style="display:flex;"><span>│   └── lib
</span></span><span style="display:flex;"><span>│       ├── spring-boot-3.0.0.jar
</span></span><span style="display:flex;"><span>│       └── ... other jars ...
</span></span><span style="display:flex;"><span>├── META-INF
</span></span><span style="display:flex;"><span>│   └── MANIFEST.MF
</span></span><span style="display:flex;"><span>└── org
</span></span><span style="display:flex;"><span>    └── springframework
</span></span><span style="display:flex;"><span>        └── boot
</span></span><span style="display:flex;"><span>            └── loader
</span></span><span style="display:flex;"><span>                ├── JarLauncher.class
</span></span><span style="display:flex;"><span>                └── ... other classes ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Spring Boot并不能修改JVM的ClassLoader机制，因此，Spring Boot的jar包仍然需要在<code>META-INF/MANIFEST.MF</code>中声明<code>Main-Class</code>，只不过它声明的不是应用程序自己的<code>Main</code>，而是Spring Boot的<code>JarLauncher</code>：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Main-Class: org.springframework.boot.loader.JarLauncher
</span></span></code></pre></td></tr></table>
</div>
</div><p>在jar包的根目录，JVM可以加载<code>JarLauncher</code>。一旦加载了<code>JarLauncher</code>后，Spring Boot会用自己的ClassLoader去加载其他的class和jar包，它在<code>BOOT-INF/classes</code>和<code>BOOT-INF/lib</code>下搜索。注意Spring Boot自定义的ClassLoader并不需要设置<code>Class-Path</code>，它可以完全自定义搜索路径，包括搜索“jar包中的jar包”。</p>
<p>因此，Spring Boot采用了两种机制来实现可执行jar包：</p>
<ol>
<li>提供Maven插件，自动设置<code>Main-Class</code>，复制相关启动Class，按<code>BOOT-INF</code>组织class和jar包；</li>
<li>提供自定义的ClassLoader，可以在jar包中搜索<code>BOOT-INF/classes</code>和<code>BOOT-INF/lib</code>。</li>
</ol>
<p>这样就使得编写Web应用程序时能简化打包和启动流程。代价就是编写一个自定义的Maven插件和自定义的ClassLoader工作量很大，有兴趣的同学可以试着实现Spring Boot的机制。</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/spring/">spring</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>