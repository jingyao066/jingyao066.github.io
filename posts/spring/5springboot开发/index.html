<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>5ã€SpringBootå¼€å‘ | Wjy&#39;s Blog</title>
<meta name="keywords" content="spring">
<meta name="description" content="æ¦‚è¿° æˆ‘ä»¬å·²ç»åœ¨å‰é¢è¯¦ç»†ä»‹ç»äº†Springæ¡†æ¶ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬IoCå®¹å™¨ã€AOPæ”¯æŒã€äº‹åŠ¡æ”¯æŒã€MVCå¼€å‘ä»¥åŠå¼ºå¤§çš„ç¬¬ä¸‰æ–¹é›†æˆåŠŸèƒ½ç­‰ã€‚ é‚£ä¹ˆï¼Œ">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://009965.xyz/posts/spring/5springboot%E5%BC%80%E5%8F%91/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://009965.xyz/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://009965.xyz/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://009965.xyz/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://009965.xyz/apple-touch-icon.png">
<link rel="mask-icon" href="https://009965.xyz/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://009965.xyz/posts/spring/5springboot%E5%BC%80%E5%8F%91/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:url" content="https://009965.xyz/posts/spring/5springboot%E5%BC%80%E5%8F%91/">
  <meta property="og:site_name" content="Wjy&#39;s Blog">
  <meta property="og:title" content="5ã€SpringBootå¼€å‘">
  <meta property="og:description" content="æ¦‚è¿° æˆ‘ä»¬å·²ç»åœ¨å‰é¢è¯¦ç»†ä»‹ç»äº†Springæ¡†æ¶ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬IoCå®¹å™¨ã€AOPæ”¯æŒã€äº‹åŠ¡æ”¯æŒã€MVCå¼€å‘ä»¥åŠå¼ºå¤§çš„ç¬¬ä¸‰æ–¹é›†æˆåŠŸèƒ½ç­‰ã€‚ é‚£ä¹ˆï¼Œ">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-01-05T10:15:56+00:00">
    <meta property="article:modified_time" content="2020-01-05T10:15:56+00:00">
    <meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="5ã€SpringBootå¼€å‘">
<meta name="twitter:description" content="æ¦‚è¿° æˆ‘ä»¬å·²ç»åœ¨å‰é¢è¯¦ç»†ä»‹ç»äº†Springæ¡†æ¶ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬IoCå®¹å™¨ã€AOPæ”¯æŒã€äº‹åŠ¡æ”¯æŒã€MVCå¼€å‘ä»¥åŠå¼ºå¤§çš„ç¬¬ä¸‰æ–¹é›†æˆåŠŸèƒ½ç­‰ã€‚ é‚£ä¹ˆï¼Œ">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://009965.xyz/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "5ã€SpringBootå¼€å‘",
      "item": "https://009965.xyz/posts/spring/5springboot%E5%BC%80%E5%8F%91/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "5ã€SpringBootå¼€å‘",
  "name": "5ã€SpringBootå¼€å‘",
  "description": "æ¦‚è¿° æˆ‘ä»¬å·²ç»åœ¨å‰é¢è¯¦ç»†ä»‹ç»äº†Springæ¡†æ¶ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬IoCå®¹å™¨ã€AOPæ”¯æŒã€äº‹åŠ¡æ”¯æŒã€MVCå¼€å‘ä»¥åŠå¼ºå¤§çš„ç¬¬ä¸‰æ–¹é›†æˆåŠŸèƒ½ç­‰ã€‚ é‚£ä¹ˆï¼Œ",
  "keywords": [
    "spring"
  ],
  "articleBody": "æ¦‚è¿° æˆ‘ä»¬å·²ç»åœ¨å‰é¢è¯¦ç»†ä»‹ç»äº†Springæ¡†æ¶ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬IoCå®¹å™¨ã€AOPæ”¯æŒã€äº‹åŠ¡æ”¯æŒã€MVCå¼€å‘ä»¥åŠå¼ºå¤§çš„ç¬¬ä¸‰æ–¹é›†æˆåŠŸèƒ½ç­‰ã€‚\né‚£ä¹ˆï¼ŒSpring Bootåˆæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’ŒSpringæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ\nSpring Bootæ˜¯ä¸€ä¸ªåŸºäºSpringçš„å¥—ä»¶ï¼Œå®ƒå¸®æˆ‘ä»¬é¢„ç»„è£…äº†Springçš„ä¸€ç³»åˆ—ç»„ä»¶ï¼Œä»¥ä¾¿ä»¥å°½å¯èƒ½å°‘çš„ä»£ç å’Œé…ç½®æ¥å¼€å‘åŸºäºSpringçš„Javaåº”ç”¨ç¨‹åºã€‚\nä»¥æ±½è½¦ä¸ºä¾‹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç»„è£…ä¸€è¾†æ±½è½¦ï¼Œæˆ‘ä»¬éœ€è¦å‘åŠ¨æœºã€ä¼ åŠ¨ã€è½®èƒã€åº•ç›˜ã€å¤–å£³ã€åº§æ¤…ã€å†…é¥°ç­‰å„ç§éƒ¨ä»¶ï¼Œç„¶åæŠŠå®ƒä»¬è£…é…èµ·æ¥ã€‚Springå°±ç›¸å½“äºæä¾›äº†ä¸€ç³»åˆ—è¿™æ ·çš„éƒ¨ä»¶ï¼Œä½†æ˜¯è¦è£…å¥½æ±½è½¦ä¸Šè·¯ï¼Œè¿˜éœ€è¦æˆ‘ä»¬è‡ªå·±åŠ¨æ‰‹ã€‚è€ŒSpring Bootåˆ™ç›¸å½“äºå·²ç»å¸®æˆ‘ä»¬é¢„è£…å¥½äº†ä¸€è¾†å¯ä»¥ä¸Šè·¯çš„æ±½è½¦ï¼Œå¦‚æœæœ‰ç‰¹æ®Šçš„è¦æ±‚ï¼Œä¾‹å¦‚æŠŠå‘åŠ¨æœºä»æ™®é€šæ¬¾æ¢æˆæ¶¡è½®å¢å‹æ¬¾ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æˆ–ç¼–å†™å°‘é‡ä»£ç å®Œæˆã€‚\nå› æ­¤ï¼ŒSpring Bootå’ŒSpringçš„å…³ç³»å°±æ˜¯æ•´è½¦å’Œé›¶éƒ¨ä»¶çš„å…³ç³»ï¼Œå®ƒä»¬ä¸æ˜¯å–ä»£å…³ç³»ï¼Œè¯•å›¾è·³è¿‡Springç›´æ¥å­¦ä¹ Spring Bootæ˜¯ä¸å¯èƒ½çš„ã€‚\nSpring Bootçš„ç›®æ ‡å°±æ˜¯æä¾›ä¸€ä¸ªå¼€ç®±å³ç”¨çš„åº”ç”¨ç¨‹åºæ¶æ„ï¼Œæˆ‘ä»¬åŸºäºSpring Bootçš„é¢„ç½®ç»“æ„ç»§ç»­å¼€å‘ï¼Œçœæ—¶çœåŠ›ã€‚\næœ¬ç« æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨Spring Bootã€‚\næœ¬æ•™ç¨‹ä½¿ç”¨çš„Spring Bootç‰ˆæœ¬æ˜¯3.xç‰ˆï¼Œå¦‚æœä½¿ç”¨Spring Boot 2.xåˆ™éœ€æ³¨æ„ï¼Œä¸¤è€…æœ‰ä»¥ä¸‹ä¸åŒï¼š\nSpring Boot 2.x Spring Boot 3.x Springç‰ˆæœ¬ Spring 5.x Spring 6.x JDKç‰ˆæœ¬ \u003e= 1.8 \u003e= 17 Tomcatç‰ˆæœ¬ 9.x 10.x AnnotationåŒ… javax.annotation jakarta.annotation ServletåŒ… javax.servlet jakarta.servlet JMSåŒ… javax.jms jakarta.jms JavaMailåŒ… javax.mail jakarta.mail å¦‚æœä½¿ç”¨Spring Bootçš„å…¶ä»–ç‰ˆæœ¬ï¼Œåˆ™éœ€è¦æ ¹æ®éœ€è¦è°ƒæ•´ä»£ç ã€‚\nSpring Bootçš„å®˜ç½‘å…¥å£æ˜¯è¿™é‡Œï¼Œå»ºè®®æ·»åŠ åˆ°æµè§ˆå™¨æ”¶è—å¤¹ã€‚\nç¬¬ä¸€ä¸ªSpring Bootåº”ç”¨ è¦äº†è§£Spring Bootï¼Œæˆ‘ä»¬å…ˆæ¥ç¼–å†™ç¬¬ä¸€ä¸ªSpring Bootåº”ç”¨ç¨‹åºï¼Œçœ‹çœ‹ä¸å‰é¢æˆ‘ä»¬ç¼–å†™çš„Springåº”ç”¨ç¨‹åºæœ‰ä½•å¼‚åŒã€‚\næˆ‘ä»¬æ–°å»ºä¸€ä¸ªspringboot-helloçš„å·¥ç¨‹ï¼Œåˆ›å»ºæ ‡å‡†çš„Mavenç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 springboot-hello â”œâ”€â”€ pom.xml â”œâ”€â”€ src â”‚ â””â”€â”€ main â”‚ â”œâ”€â”€ java â”‚ â””â”€â”€ resources â”‚ â”œâ”€â”€ application.yml â”‚ â”œâ”€â”€ logback-spring.xml â”‚ â”œâ”€â”€ static â”‚ â””â”€â”€ templates â””â”€â”€ target å…¶ä¸­ï¼Œåœ¨src/main/resourcesç›®å½•ä¸‹ï¼Œæ³¨æ„åˆ°å‡ ä¸ªæ–‡ä»¶ï¼š\napplication.yml è¿™æ˜¯Spring Booté»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œå®ƒé‡‡ç”¨YAMLæ ¼å¼è€Œä¸æ˜¯.propertiesæ ¼å¼ï¼Œæ–‡ä»¶åå¿…é¡»æ˜¯application.ymlè€Œä¸æ˜¯å…¶ä»–åç§°ã€‚\nYAMLæ ¼å¼æ¯”key=valueæ ¼å¼çš„.propertiesæ–‡ä»¶æ›´æ˜“è¯»ã€‚æ¯”è¾ƒä¸€ä¸‹ä¸¤è€…çš„å†™æ³•ï¼š\nä½¿ç”¨.propertiesæ ¼å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # application.properties spring.application.name=${APP_NAME:unnamed} spring.datasource.url=jdbc:hsqldb:file:testdb spring.datasource.username=sa spring.datasource.password= spring.datasource.driver-class-name=org.hsqldb.jdbc.JDBCDriver spring.datasource.hikari.auto-commit=false spring.datasource.hikari.connection-timeout=3000 spring.datasource.hikari.validation-timeout=3000 spring.datasource.hikari.max-lifetime=60000 spring.datasource.hikari.maximum-pool-size=20 spring.datasource.hikari.minimum-idle=1 ä½¿ç”¨YAMLæ ¼å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # application.yml spring: application: name: ${APP_NAME:unnamed} datasource: url: jdbc:hsqldb:file:testdb username: sa password: driver-class-name: org.hsqldb.jdbc.JDBCDriver hikari: auto-commit: false connection-timeout: 3000 validation-timeout: 3000 max-lifetime: 60000 maximum-pool-size: 20 minimum-idle: 1 å¯è§ï¼ŒYAMLæ˜¯ä¸€ç§å±‚çº§æ ¼å¼ï¼Œå®ƒå’Œ.propertieså¾ˆå®¹æ˜“äº’ç›¸è½¬æ¢ï¼Œå®ƒçš„ä¼˜ç‚¹æ˜¯å»æ‰äº†å¤§é‡é‡å¤çš„å‰ç¼€ï¼Œå¹¶ä¸”æ›´åŠ æ˜“è¯»ã€‚\næç¤º\nä¹Ÿå¯ä»¥ä½¿ç”¨application.propertiesä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œä½†ä¸å¦‚YAMLæ ¼å¼ç®€å•ã€‚\nä½¿ç”¨ç¯å¢ƒå˜é‡ åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨å¦‚ä¸‹çš„æ ¼å¼å¯¹æŸä¸ªkeyè¿›è¡Œé…ç½®ï¼š\n1 2 3 4 5 app: db: host: ${DB_HOST:localhost} user: ${DB_USER:root} password: ${DB_PASSWORD:password} è¿™ç§${DB_HOST:localhost}æ„æ€æ˜¯ï¼Œé¦–å…ˆä»ç¯å¢ƒå˜é‡æŸ¥æ‰¾DB_HOSTï¼Œå¦‚æœç¯å¢ƒå˜é‡å®šä¹‰äº†ï¼Œé‚£ä¹ˆä½¿ç”¨ç¯å¢ƒå˜é‡çš„å€¼ï¼Œå¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤å€¼localhostã€‚\nè¿™ä½¿å¾—æˆ‘ä»¬åœ¨å¼€å‘å’Œéƒ¨ç½²æ—¶æ›´åŠ æ–¹ä¾¿ï¼Œå› ä¸ºå¼€å‘æ—¶æ— éœ€è®¾å®šä»»ä½•ç¯å¢ƒå˜é‡ï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤å€¼å³æœ¬åœ°æ•°æ®åº“ï¼Œè€Œå®é™…çº¿ä¸Šè¿è¡Œçš„æ—¶å€™ï¼Œåªéœ€è¦ä¼ å…¥ç¯å¢ƒå˜é‡å³å¯ï¼š\n1 $ DB_HOST=10.0.1.123 DB_USER=prod DB_PASSWORD=xxxx java -jar xxx.jar logback-spring.xml è¿™æ˜¯Spring Bootçš„logbacké…ç½®æ–‡ä»¶åç§°ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨logback.xmlï¼‰ï¼Œä¸€ä¸ªæ ‡å‡†çš„å†™æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e ",
  "wordCount" : "23739",
  "inLanguage": "en",
  "datePublished": "2020-01-05T10:15:56Z",
  "dateModified": "2020-01-05T10:15:56Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://009965.xyz/posts/spring/5springboot%E5%BC%80%E5%8F%91/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://009965.xyz/favicon.ico"
    }
  }
}
</script>

  <script id="MathJax-script" async src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-chtml.min.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath:  [['\\(', '\\)'], ['$', '$']],  
    }
  };
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://009965.xyz/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://009965.xyz/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://009965.xyz/">Home</a>&nbsp;Â»&nbsp;<a href="https://009965.xyz/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      5ã€SpringBootå¼€å‘
    </h1>
    <div class="post-meta"><span title='2020-01-05 10:15:56 +0000 UTC'>2020-01-05</span>&nbsp;Â·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%a6%82%e8%bf%b0" aria-label="æ¦‚è¿°">æ¦‚è¿°</a></li>
                <li>
                    <a href="#%e7%ac%ac%e4%b8%80%e4%b8%aaspring-boot%e5%ba%94%e7%94%a8" aria-label="ç¬¬ä¸€ä¸ªSpring Bootåº”ç”¨">ç¬¬ä¸€ä¸ªSpring Bootåº”ç”¨</a><ul>
                        
                <li>
                    <a href="#applicationyml" aria-label="application.yml">application.yml</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" aria-label="ä½¿ç”¨ç¯å¢ƒå˜é‡">ä½¿ç”¨ç¯å¢ƒå˜é‡</a></li>
                <li>
                    <a href="#logback-springxml" aria-label="logback-spring.xml">logback-spring.xml</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%89%93%e5%8c%85spring-boot%e5%ba%94%e7%94%a8" aria-label="æ‰“åŒ…Spring Bootåº”ç”¨">æ‰“åŒ…Spring Bootåº”ç”¨</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8actuator" aria-label="ä½¿ç”¨Actuator">ä½¿ç”¨Actuator</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8profiles" aria-label="ä½¿ç”¨Profiles">ä½¿ç”¨Profiles</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8conditional" aria-label="ä½¿ç”¨Conditional">ä½¿ç”¨Conditional</a></li>
                <li>
                    <a href="#%e5%8a%a0%e8%bd%bd%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="åŠ è½½é…ç½®æ–‡ä»¶">åŠ è½½é…ç½®æ–‡ä»¶</a></li>
                <li>
                    <a href="#%e7%a6%81%e7%94%a8%e8%87%aa%e5%8a%a8%e9%85%8d%e7%bd%ae" aria-label="ç¦ç”¨è‡ªåŠ¨é…ç½®">ç¦ç”¨è‡ªåŠ¨é…ç½®</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0filter" aria-label="æ·»åŠ Filter">æ·»åŠ Filter</a></li>
                <li>
                    <a href="#%e9%9b%86%e6%88%90open-api" aria-label="é›†æˆOpen API">é›†æˆOpen API</a><ul>
                        
                <li>
                    <a href="#%e6%98%af%e4%b8%8d%e6%98%af%e5%a4%aa%e6%96%b9%e4%be%bf%e4%ba%86" aria-label="æ˜¯ä¸æ˜¯å¤ªæ–¹ä¾¿äº†ï¼">æ˜¯ä¸æ˜¯å¤ªæ–¹ä¾¿äº†ï¼</a><ul>
                        
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86" aria-label="é…ç½®åå‘ä»£ç†">é…ç½®åå‘ä»£ç†</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e8%ae%bf%e9%97%aeredis" aria-label="è®¿é—®Redis">è®¿é—®Redis</a></li>
                <li>
                    <a href="#%e9%9b%86%e6%88%90artemis" aria-label="é›†æˆArtemis">é›†æˆArtemis</a></li>
                <li>
                    <a href="#%e9%9b%86%e6%88%90rabbitmq" aria-label="é›†æˆRabbitMQ">é›†æˆRabbitMQ</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e5%ae%89%e8%a3%85rabbitmq" aria-label="å®‰è£…RabbitMQ">å®‰è£…RabbitMQ</a></li>
                <li>
                    <a href="#amqp%e5%8d%8f%e8%ae%ae" aria-label="AMQPåè®®">AMQPåè®®</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8rabbitmq" aria-label="ä½¿ç”¨RabbitMQ">ä½¿ç”¨RabbitMQ</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#%e9%9b%86%e6%88%90kafka" aria-label="é›†æˆKafka">é›†æˆKafka</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e5%ae%89%e8%a3%85kafka" aria-label="å®‰è£…Kafka">å®‰è£…Kafka</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8kafka" aria-label="ä½¿ç”¨Kafka">ä½¿ç”¨Kafka</a></li>
                <li>
                    <a href="#%e5%8f%91%e9%80%81%e6%b6%88%e6%81%af" aria-label="å‘é€æ¶ˆæ¯">å‘é€æ¶ˆæ¯</a></li>
                <li>
                    <a href="#%e6%8e%a5%e6%94%b6%e6%b6%88%e6%81%af" aria-label="æ¥æ”¶æ¶ˆæ¯">æ¥æ”¶æ¶ˆæ¯</a>
                </li>
            </ul>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="æ¦‚è¿°">æ¦‚è¿°<a hidden class="anchor" aria-hidden="true" href="#æ¦‚è¿°">#</a></h1>
<p>æˆ‘ä»¬å·²ç»åœ¨å‰é¢è¯¦ç»†ä»‹ç»äº†Springæ¡†æ¶ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬IoCå®¹å™¨ã€AOPæ”¯æŒã€äº‹åŠ¡æ”¯æŒã€MVCå¼€å‘ä»¥åŠå¼ºå¤§çš„ç¬¬ä¸‰æ–¹é›†æˆåŠŸèƒ½ç­‰ã€‚</p>
<p>é‚£ä¹ˆï¼ŒSpring Bootåˆæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’ŒSpringæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</p>
<p>Spring Bootæ˜¯ä¸€ä¸ªåŸºäºSpringçš„å¥—ä»¶ï¼Œå®ƒå¸®æˆ‘ä»¬é¢„ç»„è£…äº†Springçš„ä¸€ç³»åˆ—ç»„ä»¶ï¼Œä»¥ä¾¿ä»¥å°½å¯èƒ½å°‘çš„ä»£ç å’Œé…ç½®æ¥å¼€å‘åŸºäºSpringçš„Javaåº”ç”¨ç¨‹åºã€‚</p>
<p>ä»¥æ±½è½¦ä¸ºä¾‹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç»„è£…ä¸€è¾†æ±½è½¦ï¼Œæˆ‘ä»¬éœ€è¦å‘åŠ¨æœºã€ä¼ åŠ¨ã€è½®èƒã€åº•ç›˜ã€å¤–å£³ã€åº§æ¤…ã€å†…é¥°ç­‰å„ç§éƒ¨ä»¶ï¼Œç„¶åæŠŠå®ƒä»¬è£…é…èµ·æ¥ã€‚Springå°±ç›¸å½“äºæä¾›äº†ä¸€ç³»åˆ—è¿™æ ·çš„éƒ¨ä»¶ï¼Œä½†æ˜¯è¦è£…å¥½æ±½è½¦ä¸Šè·¯ï¼Œè¿˜éœ€è¦æˆ‘ä»¬è‡ªå·±åŠ¨æ‰‹ã€‚è€ŒSpring Bootåˆ™ç›¸å½“äºå·²ç»å¸®æˆ‘ä»¬é¢„è£…å¥½äº†ä¸€è¾†å¯ä»¥ä¸Šè·¯çš„æ±½è½¦ï¼Œå¦‚æœæœ‰ç‰¹æ®Šçš„è¦æ±‚ï¼Œä¾‹å¦‚æŠŠå‘åŠ¨æœºä»æ™®é€šæ¬¾æ¢æˆæ¶¡è½®å¢å‹æ¬¾ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æˆ–ç¼–å†™å°‘é‡ä»£ç å®Œæˆã€‚</p>
<p>å› æ­¤ï¼ŒSpring Bootå’ŒSpringçš„å…³ç³»å°±æ˜¯æ•´è½¦å’Œé›¶éƒ¨ä»¶çš„å…³ç³»ï¼Œå®ƒä»¬ä¸æ˜¯å–ä»£å…³ç³»ï¼Œè¯•å›¾è·³è¿‡Springç›´æ¥å­¦ä¹ Spring Bootæ˜¯ä¸å¯èƒ½çš„ã€‚</p>
<p>Spring Bootçš„ç›®æ ‡å°±æ˜¯æä¾›ä¸€ä¸ªå¼€ç®±å³ç”¨çš„åº”ç”¨ç¨‹åºæ¶æ„ï¼Œæˆ‘ä»¬åŸºäºSpring Bootçš„é¢„ç½®ç»“æ„ç»§ç»­å¼€å‘ï¼Œçœæ—¶çœåŠ›ã€‚</p>
<p>æœ¬ç« æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨Spring Bootã€‚</p>
<p>æœ¬æ•™ç¨‹ä½¿ç”¨çš„Spring Bootç‰ˆæœ¬æ˜¯3.xç‰ˆï¼Œå¦‚æœä½¿ç”¨Spring Boot 2.xåˆ™éœ€æ³¨æ„ï¼Œä¸¤è€…æœ‰ä»¥ä¸‹ä¸åŒï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>Spring Boot 2.x</th>
<th>Spring Boot 3.x</th>
</tr>
</thead>
<tbody>
<tr>
<td>Springç‰ˆæœ¬</td>
<td>Spring 5.x</td>
<td>Spring 6.x</td>
</tr>
<tr>
<td>JDKç‰ˆæœ¬</td>
<td>&gt;= 1.8</td>
<td>&gt;= 17</td>
</tr>
<tr>
<td>Tomcatç‰ˆæœ¬</td>
<td>9.x</td>
<td>10.x</td>
</tr>
<tr>
<td>AnnotationåŒ…</td>
<td>javax.annotation</td>
<td>jakarta.annotation</td>
</tr>
<tr>
<td>ServletåŒ…</td>
<td>javax.servlet</td>
<td>jakarta.servlet</td>
</tr>
<tr>
<td>JMSåŒ…</td>
<td>javax.jms</td>
<td>jakarta.jms</td>
</tr>
<tr>
<td>JavaMailåŒ…</td>
<td>javax.mail</td>
<td>jakarta.mail</td>
</tr>
</tbody>
</table>
<p>å¦‚æœä½¿ç”¨Spring Bootçš„å…¶ä»–ç‰ˆæœ¬ï¼Œåˆ™éœ€è¦æ ¹æ®éœ€è¦è°ƒæ•´ä»£ç ã€‚</p>
<p>Spring Bootçš„å®˜ç½‘å…¥å£æ˜¯<a href="https://spring.io/projects/spring-boot">è¿™é‡Œ</a>ï¼Œå»ºè®®æ·»åŠ åˆ°æµè§ˆå™¨æ”¶è—å¤¹ã€‚</p>
<h1 id="ç¬¬ä¸€ä¸ªspring-bootåº”ç”¨">ç¬¬ä¸€ä¸ªSpring Bootåº”ç”¨<a hidden class="anchor" aria-hidden="true" href="#ç¬¬ä¸€ä¸ªspring-bootåº”ç”¨">#</a></h1>
<p>è¦äº†è§£Spring Bootï¼Œæˆ‘ä»¬å…ˆæ¥ç¼–å†™ç¬¬ä¸€ä¸ªSpring Bootåº”ç”¨ç¨‹åºï¼Œçœ‹çœ‹ä¸å‰é¢æˆ‘ä»¬ç¼–å†™çš„Springåº”ç”¨ç¨‹åºæœ‰ä½•å¼‚åŒã€‚</p>
<p>æˆ‘ä»¬æ–°å»ºä¸€ä¸ª<code>springboot-hello</code>çš„å·¥ç¨‹ï¼Œåˆ›å»ºæ ‡å‡†çš„Mavenç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>springboot-hello
</span></span><span style="display:flex;"><span>â”œâ”€â”€ pom.xml
</span></span><span style="display:flex;"><span>â”œâ”€â”€ src
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ main
</span></span><span style="display:flex;"><span>â”‚       â”œâ”€â”€ java
</span></span><span style="display:flex;"><span>â”‚       â””â”€â”€ resources
</span></span><span style="display:flex;"><span>â”‚           â”œâ”€â”€ application.yml
</span></span><span style="display:flex;"><span>â”‚           â”œâ”€â”€ logback-spring.xml
</span></span><span style="display:flex;"><span>â”‚           â”œâ”€â”€ static
</span></span><span style="display:flex;"><span>â”‚           â””â”€â”€ templates
</span></span><span style="display:flex;"><span>â””â”€â”€ target
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­ï¼Œåœ¨<code>src/main/resources</code>ç›®å½•ä¸‹ï¼Œæ³¨æ„åˆ°å‡ ä¸ªæ–‡ä»¶ï¼š</p>
<h2 id="applicationyml">application.yml<a hidden class="anchor" aria-hidden="true" href="#applicationyml">#</a></h2>
<p>è¿™æ˜¯Spring Booté»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œå®ƒé‡‡ç”¨<a href="https://yaml.org/">YAML</a>æ ¼å¼è€Œä¸æ˜¯<code>.properties</code>æ ¼å¼ï¼Œæ–‡ä»¶åå¿…é¡»æ˜¯<code>application.yml</code>è€Œä¸æ˜¯å…¶ä»–åç§°ã€‚</p>
<p>YAMLæ ¼å¼æ¯”<code>key=value</code>æ ¼å¼çš„<code>.properties</code>æ–‡ä»¶æ›´æ˜“è¯»ã€‚æ¯”è¾ƒä¸€ä¸‹ä¸¤è€…çš„å†™æ³•ï¼š</p>
<p>ä½¿ç”¨<code>.properties</code>æ ¼å¼ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#007f7f"># application.properties</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.application.name</span>=<span style="color:#0ff;font-weight:bold">${APP_NAME:unnamed}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.datasource.url</span>=<span style="color:#0ff;font-weight:bold">jdbc:hsqldb:file:testdb</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.datasource.username</span>=<span style="color:#0ff;font-weight:bold">sa</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.datasource.password</span>=
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.datasource.driver-class-name</span>=<span style="color:#0ff;font-weight:bold">org.hsqldb.jdbc.JDBCDriver</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.datasource.hikari.auto-commit</span>=<span style="color:#0ff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.datasource.hikari.connection-timeout</span>=<span style="color:#0ff;font-weight:bold">3000</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.datasource.hikari.validation-timeout</span>=<span style="color:#0ff;font-weight:bold">3000</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.datasource.hikari.max-lifetime</span>=<span style="color:#0ff;font-weight:bold">60000</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.datasource.hikari.maximum-pool-size</span>=<span style="color:#0ff;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">spring.datasource.hikari.minimum-idle</span>=<span style="color:#0ff;font-weight:bold">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨YAMLæ ¼å¼ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#007f7f"># application.yml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">application</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: ${APP_NAME:unnamed}
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:hsqldb:file:testdb
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: sa
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">driver-class-name</span>: org.hsqldb.jdbc.JDBCDriver
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">hikari</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">auto-commit</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">connection-timeout</span>: <span style="color:#ff0;font-weight:bold">3000</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">validation-timeout</span>: <span style="color:#ff0;font-weight:bold">3000</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">max-lifetime</span>: <span style="color:#ff0;font-weight:bold">60000</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">maximum-pool-size</span>: <span style="color:#ff0;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">minimum-idle</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯è§ï¼ŒYAMLæ˜¯ä¸€ç§å±‚çº§æ ¼å¼ï¼Œå®ƒå’Œ<code>.properties</code>å¾ˆå®¹æ˜“äº’ç›¸è½¬æ¢ï¼Œå®ƒçš„ä¼˜ç‚¹æ˜¯å»æ‰äº†å¤§é‡é‡å¤çš„å‰ç¼€ï¼Œå¹¶ä¸”æ›´åŠ æ˜“è¯»ã€‚</p>
<p>æç¤º</p>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨application.propertiesä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œä½†ä¸å¦‚YAMLæ ¼å¼ç®€å•ã€‚</p>
<h2 id="ä½¿ç”¨ç¯å¢ƒå˜é‡">ä½¿ç”¨ç¯å¢ƒå˜é‡<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨ç¯å¢ƒå˜é‡">#</a></h2>
<p>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨å¦‚ä¸‹çš„æ ¼å¼å¯¹æŸä¸ªkeyè¿›è¡Œé…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">app</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">db</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: ${DB_HOST:localhost}
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">user</span>: ${DB_USER:root}
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: ${DB_PASSWORD:password}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ç§<code>${DB_HOST:localhost}</code>æ„æ€æ˜¯ï¼Œé¦–å…ˆä»ç¯å¢ƒå˜é‡æŸ¥æ‰¾<code>DB_HOST</code>ï¼Œå¦‚æœç¯å¢ƒå˜é‡å®šä¹‰äº†ï¼Œé‚£ä¹ˆä½¿ç”¨ç¯å¢ƒå˜é‡çš„å€¼ï¼Œå¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤å€¼<code>localhost</code>ã€‚</p>
<p>è¿™ä½¿å¾—æˆ‘ä»¬åœ¨å¼€å‘å’Œéƒ¨ç½²æ—¶æ›´åŠ æ–¹ä¾¿ï¼Œå› ä¸ºå¼€å‘æ—¶æ— éœ€è®¾å®šä»»ä½•ç¯å¢ƒå˜é‡ï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤å€¼å³æœ¬åœ°æ•°æ®åº“ï¼Œè€Œå®é™…çº¿ä¸Šè¿è¡Œçš„æ—¶å€™ï¼Œåªéœ€è¦ä¼ å…¥ç¯å¢ƒå˜é‡å³å¯ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ DB_HOST=10.0.1.123 DB_USER=prod DB_PASSWORD=xxxx java -jar xxx.jar
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="logback-springxml">logback-spring.xml<a hidden class="anchor" aria-hidden="true" href="#logback-springxml">#</a></h2>
<p>è¿™æ˜¯Spring Bootçš„logbacké…ç½®æ–‡ä»¶åç§°ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨<code>logback.xml</code>ï¼‰ï¼Œä¸€ä¸ªæ ‡å‡†çš„å†™æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;include</span> <span style="color:#007f7f">resource=</span><span style="color:#0ff;font-weight:bold">&#34;org/springframework/boot/logging/logback/defaults.xml&#34;</span> <span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;appender</span> <span style="color:#007f7f">name=</span><span style="color:#0ff;font-weight:bold">&#34;CONSOLE&#34;</span> <span style="color:#007f7f">class=</span><span style="color:#0ff;font-weight:bold">&#34;ch.qos.logback.core.ConsoleAppender&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;encoder&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;pattern&gt;</span>${CONSOLE_LOG_PATTERN}<span style="font-weight:bold">&lt;/pattern&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;charset&gt;</span>utf8<span style="font-weight:bold">&lt;/charset&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/encoder&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/appender&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;appender</span> <span style="color:#007f7f">name=</span><span style="color:#0ff;font-weight:bold">&#34;APP_LOG&#34;</span> <span style="color:#007f7f">class=</span><span style="color:#0ff;font-weight:bold">&#34;ch.qos.logback.core.rolling.RollingFileAppender&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;encoder&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;pattern&gt;</span>${FILE_LOG_PATTERN}<span style="font-weight:bold">&lt;/pattern&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;charset&gt;</span>utf8<span style="font-weight:bold">&lt;/charset&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/encoder&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="font-weight:bold">&lt;file&gt;</span>app.log<span style="font-weight:bold">&lt;/file&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;rollingPolicy</span> <span style="color:#007f7f">class=</span><span style="color:#0ff;font-weight:bold">&#34;ch.qos.logback.core.rolling.FixedWindowRollingPolicy&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;maxIndex&gt;</span>1<span style="font-weight:bold">&lt;/maxIndex&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;fileNamePattern&gt;</span>app.log.%i<span style="font-weight:bold">&lt;/fileNamePattern&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/rollingPolicy&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;triggeringPolicy</span> <span style="color:#007f7f">class=</span><span style="color:#0ff;font-weight:bold">&#34;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;MaxFileSize&gt;</span>1MB<span style="font-weight:bold">&lt;/MaxFileSize&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/triggeringPolicy&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/appender&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;root</span> <span style="color:#007f7f">level=</span><span style="color:#0ff;font-weight:bold">&#34;INFO&#34;</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;appender-ref</span> <span style="color:#007f7f">ref=</span><span style="color:#0ff;font-weight:bold">&#34;CONSOLE&#34;</span> <span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;appender-ref</span> <span style="color:#007f7f">ref=</span><span style="color:#0ff;font-weight:bold">&#34;APP_LOG&#34;</span> <span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/root&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒä¸»è¦é€šè¿‡<code>&lt;include resource=&quot;...&quot; /&gt;</code>å¼•å…¥äº†Spring Bootçš„ä¸€ä¸ªç¼ºçœé…ç½®ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¼•ç”¨ç±»ä¼¼<code>${CONSOLE_LOG_PATTERN}</code>è¿™æ ·çš„å˜é‡ã€‚ä¸Šè¿°é…ç½®å®šä¹‰äº†ä¸€ä¸ªæ§åˆ¶å°è¾“å‡ºå’Œæ–‡ä»¶è¾“å‡ºï¼Œå¯æ ¹æ®éœ€è¦ä¿®æ”¹ã€‚</p>
<p><code>static</code>æ˜¯é™æ€æ–‡ä»¶ç›®å½•ï¼Œ<code>templates</code>æ˜¯æ¨¡æ¿æ–‡ä»¶ç›®å½•ï¼Œæ³¨æ„å®ƒä»¬ä¸å†å­˜æ”¾åœ¨<code>src/main/webapp</code>ä¸‹ï¼Œè€Œæ˜¯ç›´æ¥æ”¾åˆ°<code>src/main/resources</code>è¿™ä¸ªclasspathç›®å½•ï¼Œå› ä¸ºåœ¨Spring Bootä¸­å·²ç»ä¸éœ€è¦ä¸“é—¨çš„webappç›®å½•äº†ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯Spring Bootçš„æ ‡å‡†ç›®å½•ç»“æ„ï¼Œå®ƒå®Œå…¨æ˜¯ä¸€ä¸ªåŸºäºJavaåº”ç”¨çš„æ™®é€šMavené¡¹ç›®ã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹æºç ç›®å½•ç»“æ„ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>src/main/java
</span></span><span style="display:flex;"><span>â””â”€â”€ com
</span></span><span style="display:flex;"><span>    â””â”€â”€ itranswarp
</span></span><span style="display:flex;"><span>        â””â”€â”€ learnjava
</span></span><span style="display:flex;"><span>            â”œâ”€â”€ Application.java
</span></span><span style="display:flex;"><span>            â”œâ”€â”€ entity
</span></span><span style="display:flex;"><span>            â”‚   â””â”€â”€ User.java
</span></span><span style="display:flex;"><span>            â”œâ”€â”€ service
</span></span><span style="display:flex;"><span>            â”‚   â””â”€â”€ UserService.java
</span></span><span style="display:flex;"><span>            â””â”€â”€ web
</span></span><span style="display:flex;"><span>                â””â”€â”€ UserController.java
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨å­˜æ”¾æºç çš„<code>src/main/java</code>ç›®å½•ä¸­ï¼ŒSpring Bootå¯¹JavaåŒ…çš„å±‚çº§ç»“æ„æœ‰ä¸€ä¸ªè¦æ±‚ã€‚æ³¨æ„åˆ°æˆ‘ä»¬çš„æ ¹packageæ˜¯<code>com.itranswarp.learnjava</code>ï¼Œä¸‹é¢è¿˜æœ‰<code>entity</code>ã€<code>service</code>ã€<code>web</code>ç­‰å­packageã€‚Spring Bootè¦æ±‚<code>main()</code>æ–¹æ³•æ‰€åœ¨çš„å¯åŠ¨ç±»å¿…é¡»æ”¾åˆ°æ ¹packageä¸‹ï¼Œå‘½åä¸åšè¦æ±‚ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥<code>Application.java</code>å‘½åï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@SpringBootApplication
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Application {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        SpringApplication.<span style="color:#007f7f">run</span>(Application.<span style="color:#007f7f">class</span>, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯åŠ¨Spring Bootåº”ç”¨ç¨‹åºåªéœ€è¦ä¸€è¡Œä»£ç åŠ ä¸Šä¸€ä¸ªæ³¨è§£<code>@SpringBootApplication</code>ï¼Œè¯¥æ³¨è§£å®é™…ä¸ŠåˆåŒ…å«äº†ï¼š</p>
<ul>
<li>@SpringBootConfiguration
<ul>
<li>@Configuration</li>
</ul>
</li>
<li>@EnableAutoConfiguration
<ul>
<li>@AutoConfigurationPackage</li>
</ul>
</li>
<li>@ComponentScan</li>
</ul>
<p>è¿™æ ·ä¸€ä¸ªæ³¨è§£å°±ç›¸å½“äºå¯åŠ¨äº†è‡ªåŠ¨é…ç½®å’Œè‡ªåŠ¨æ‰«æã€‚</p>
<p>æˆ‘ä»¬å†è§‚å¯Ÿ<code>pom.xml</code>ï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;project</span> <span style="color:#f00">...</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;version&gt;</span>3.0.0<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;modelVersion&gt;</span>4.0.0<span style="font-weight:bold">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>com.itranswarp.learnjava<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>springboot-hello<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>1.0-SNAPSHOT<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;maven.compiler.source&gt;</span>17<span style="font-weight:bold">&lt;/maven.compiler.source&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;maven.compiler.target&gt;</span>17<span style="font-weight:bold">&lt;/maven.compiler.target&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;java.version&gt;</span>17<span style="font-weight:bold">&lt;/java.version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;pebble.version&gt;</span>3.2.0<span style="font-weight:bold">&lt;/pebble.version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-jdbc<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">&lt;!-- é›†æˆPebble View --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;groupId&gt;</span>io.pebbletemplates<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;artifactId&gt;</span>pebble-spring-boot-starter<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;version&gt;</span>${pebble.version}<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">&lt;!-- JDBCé©±åŠ¨ --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;groupId&gt;</span>org.hsqldb<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;artifactId&gt;</span>hsqldb<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/project&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨Spring Bootæ—¶ï¼Œå¼ºçƒˆæ¨èä»<code>spring-boot-starter-parent</code>ç»§æ‰¿ï¼Œå› ä¸ºè¿™æ ·å°±å¯ä»¥å¼•å…¥Spring Bootçš„é¢„ç½®é…ç½®ã€‚</p>
<p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¾èµ–<code>spring-boot-starter-web</code>å’Œ<code>spring-boot-starter-jdbc</code>ï¼Œå®ƒä»¬åˆ†åˆ«å¼•å…¥äº†Spring MVCç›¸å…³ä¾èµ–å’ŒSpring JDBCç›¸å…³ä¾èµ–ï¼Œæ— éœ€æŒ‡å®šç‰ˆæœ¬å·ï¼Œå› ä¸ºå¼•å…¥çš„<code>&lt;parent&gt;</code>å†…å·²ç»æŒ‡å®šäº†ï¼Œåªæœ‰æˆ‘ä»¬è‡ªå·±å¼•å…¥çš„æŸäº›ç¬¬ä¸‰æ–¹jaråŒ…éœ€è¦æŒ‡å®šç‰ˆæœ¬å·ã€‚è¿™é‡Œæˆ‘ä»¬å¼•å…¥<code>pebble-spring-boot-starter</code>ä½œä¸ºViewï¼Œä»¥åŠ<code>hsqldb</code>ä½œä¸ºåµŒå…¥å¼æ•°æ®åº“ã€‚<code>hsqldb</code>å·²åœ¨<code>spring-boot-starter-jdbc</code>ä¸­é¢„ç½®äº†ç‰ˆæœ¬å·<code>3.0.0</code>ï¼Œå› æ­¤æ­¤å¤„æ— éœ€æŒ‡å®šç‰ˆæœ¬å·ã€‚</p>
<p>æ ¹æ®<code>pebble-spring-boot-starter</code>çš„<a href="https://pebbletemplates.io/wiki/guide/spring-boot-integration/">æ–‡æ¡£</a>ï¼ŒåŠ å…¥å¦‚ä¸‹é…ç½®åˆ°<code>application.yml</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">pebble</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f"># é»˜è®¤ä¸º&#34;.peb&#34;ï¼Œæ”¹ä¸º&#34;&#34;:</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">suffix</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f"># å¼€å‘é˜¶æ®µç¦ç”¨æ¨¡æ¿ç¼“å­˜:</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">cache</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹<code>Application</code>ç¨ä½œæ”¹åŠ¨ï¼Œæ·»åŠ <code>WebMvcConfigurer</code>è¿™ä¸ªBeanï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@SpringBootApplication
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Application {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    WebMvcConfigurer createWebMvcConfigurer(@Autowired HandlerInterceptor[] interceptors) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> WebMvcConfigurer() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> addResourceHandlers(ResourceHandlerRegistry registry) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// æ˜ å°„è·¯å¾„`/static/`åˆ°classpathè·¯å¾„:</span>
</span></span><span style="display:flex;"><span>                registry.<span style="color:#007f7f">addResourceHandler</span>(<span style="color:#0ff;font-weight:bold">&#34;/static/**&#34;</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#007f7f">addResourceLocations</span>(<span style="color:#0ff;font-weight:bold">&#34;classpath:/static/&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨å°±å¯ä»¥ç›´æ¥è¿è¡Œ<code>Application</code>ï¼Œå¯åŠ¨åè§‚å¯ŸSpring Bootçš„æ—¥å¿—ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>  .   ____          _            __ _ _
</span></span><span style="display:flex;"><span> /\\ / ___&#39;_ __ _ _(_)_ __  __ _ \ \ \ \
</span></span><span style="display:flex;"><span>( ( )\___ | &#39;_ | &#39;_| | &#39;_ \/ _` | \ \ \ \
</span></span><span style="display:flex;"><span> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
</span></span><span style="display:flex;"><span>  &#39;  |____| .__|_| |_|_| |_\__, | / / / /
</span></span><span style="display:flex;"><span> =========|_|==============|___/=/_/_/_/
</span></span><span style="display:flex;"><span> :: Spring Boot ::                (v3.0.0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2022-11-25T10:49:31.100+08:00  INFO 13105 --- [           main] com.itranswarp.learnjava.Application     : Starting Application using Java 17 with PID 13105 (/Users/liaoxuefeng/Git/springboot-hello/target/classes started by liaoxuefeng in /Users/liaoxuefeng/Git/springboot-hello)
</span></span><span style="display:flex;"><span>2022-11-25T10:49:31.107+08:00  INFO 13105 --- [           main] com.itranswarp.learnjava.Application     : No active profile set, falling back to 1 default profile: &#34;default&#34;
</span></span><span style="display:flex;"><span>2022-11-25T10:49:32.404+08:00  INFO 13105 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
</span></span><span style="display:flex;"><span>2022-11-25T10:49:32.423+08:00  INFO 13105 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
</span></span><span style="display:flex;"><span>2022-11-25T10:49:32.426+08:00  INFO 13105 --- [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.1]
</span></span><span style="display:flex;"><span>2022-11-25T10:49:32.549+08:00  INFO 13105 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
</span></span><span style="display:flex;"><span>2022-11-25T10:49:32.551+08:00  INFO 13105 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 1327 ms
</span></span><span style="display:flex;"><span>2022-11-25T10:49:32.668+08:00  WARN 13105 --- [           main] com.zaxxer.hikari.HikariConfig           : HikariPool-1 - idleTimeout is close to or more than maxLifetime, disabling it.
</span></span><span style="display:flex;"><span>2022-11-25T10:49:32.669+08:00  INFO 13105 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
</span></span><span style="display:flex;"><span>2022-11-25T10:49:32.996+08:00  INFO 13105 --- [           main] com.zaxxer.hikari.pool.PoolBase          : HikariPool-1 - Driver does not support get/set network timeout for connections. (feature not supported)
</span></span><span style="display:flex;"><span>2022-11-25T10:49:32.998+08:00  INFO 13105 --- [           main] com.zaxxer.hikari.pool.HikariPool        : HikariPool-1 - Added connection org.hsqldb.jdbc.JDBCConnection@31a2a9fa
</span></span><span style="display:flex;"><span>2022-11-25T10:49:33.002+08:00  INFO 13105 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
</span></span><span style="display:flex;"><span>2022-11-25T10:49:33.391+08:00  WARN 13105 --- [           main] ocalVariableTableParameterNameDiscoverer : Using deprecated &#39;-debug&#39; fallback for parameter name resolution. Compile the affected code with &#39;-parameters&#39; instead or avoid its introspection: io.pebbletemplates.boot.autoconfigure.PebbleServletWebConfiguration
</span></span><span style="display:flex;"><span>2022-11-25T10:49:33.398+08:00  WARN 13105 --- [           main] ocalVariableTableParameterNameDiscoverer : Using deprecated &#39;-debug&#39; fallback for parameter name resolution. Compile the affected code with &#39;-parameters&#39; instead or avoid its introspection: io.pebbletemplates.boot.autoconfigure.PebbleAutoConfiguration
</span></span><span style="display:flex;"><span>2022-11-25T10:49:33.619+08:00  INFO 13105 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#39;&#39;
</span></span><span style="display:flex;"><span>2022-11-25T10:49:33.637+08:00  INFO 13105 --- [           main] com.itranswarp.learnjava.Application     : Started Application in 3.151 seconds (process running for 3.835)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Spring Bootè‡ªåŠ¨å¯åŠ¨äº†åµŒå…¥å¼Tomcatï¼Œå½“çœ‹åˆ°<code>Started Application in xxx seconds</code>æ—¶ï¼ŒSpring Bootåº”ç”¨å¯åŠ¨æˆåŠŸã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨æµè§ˆå™¨è¾“å…¥<code>localhost:8080</code>å°±å¯ä»¥ç›´æ¥è®¿é—®é¡µé¢ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼š</p>
<p>å‰é¢æˆ‘ä»¬å®šä¹‰çš„æ•°æ®æºã€å£°æ˜å¼äº‹åŠ¡ã€JdbcTemplateåœ¨å“ªåˆ›å»ºçš„ï¼Ÿæ€ä¹ˆå°±å¯ä»¥ç›´æ¥æ³¨å…¥åˆ°è‡ªå·±ç¼–å†™çš„<code>UserService</code>ä¸­å‘¢ï¼Ÿ</p>
<p>è¿™äº›è‡ªåŠ¨åˆ›å»ºçš„Beanå°±æ˜¯Spring Bootçš„ç‰¹è‰²ï¼šAutoConfigurationã€‚</p>
<p>å½“æˆ‘ä»¬å¼•å…¥<code>spring-boot-starter-jdbc</code>æ—¶ï¼Œå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰«ææ‰€æœ‰çš„<code>XxxAutoConfiguration</code>ï¼š</p>
<ul>
<li><code>DataSourceAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª<code>DataSource</code>ï¼Œå…¶ä¸­é…ç½®é¡¹ä»<code>application.yml</code>çš„<code>spring.datasource</code>è¯»å–ï¼›</li>
<li><code>DataSourceTransactionManagerAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ªåŸºäºJDBCçš„äº‹åŠ¡ç®¡ç†å™¨ï¼›</li>
<li><code>JdbcTemplateAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ª<code>JdbcTemplate</code>ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œæˆ‘ä»¬è‡ªåŠ¨å¾—åˆ°äº†ä¸€ä¸ª<code>DataSource</code>ã€ä¸€ä¸ª<code>DataSourceTransactionManager</code>å’Œä¸€ä¸ª<code>JdbcTemplate</code>ã€‚</p>
<p>ç±»ä¼¼çš„ï¼Œå½“æˆ‘ä»¬å¼•å…¥<code>spring-boot-starter-web</code>æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºäº†ï¼š</p>
<ul>
<li><code>ServletWebServerFactoryAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåµŒå…¥å¼WebæœåŠ¡å™¨ï¼Œé»˜è®¤æ˜¯Tomcatï¼›</li>
<li><code>DispatcherServletAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª<code>DispatcherServlet</code>ï¼›</li>
<li><code>HttpEncodingAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª<code>CharacterEncodingFilter</code>ï¼›</li>
<li><code>WebMvcAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºè‹¥å¹²ä¸MVCç›¸å…³çš„Beanã€‚</li>
<li>&hellip;</li>
</ul>
<p>å¼•å…¥ç¬¬ä¸‰æ–¹<code>pebble-spring-boot-starter</code>æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºäº†ï¼š</p>
<ul>
<li><code>PebbleAutoConfiguration</code>ï¼šè‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ª<code>PebbleViewResolver</code>ã€‚</li>
</ul>
<p>Spring Bootå¤§é‡ä½¿ç”¨<code>XxxAutoConfiguration</code>æ¥ä½¿å¾—è®¸å¤šç»„ä»¶è¢«è‡ªåŠ¨åŒ–é…ç½®å¹¶åˆ›å»ºï¼Œè€Œè¿™äº›åˆ›å»ºè¿‡ç¨‹åˆå¤§é‡ä½¿ç”¨äº†Springçš„ConditionalåŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬è§‚å¯Ÿ<code>JdbcTemplateAutoConfiguration</code>ï¼Œå®ƒçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration(proxyBeanMethods = <span style="color:#fff;font-weight:bold">false</span>)
</span></span><span style="display:flex;"><span>@ConditionalOnClass({ DataSource.<span style="color:#007f7f">class</span>, JdbcTemplate.<span style="color:#007f7f">class</span> })
</span></span><span style="display:flex;"><span>@ConditionalOnSingleCandidate(DataSource.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>@AutoConfigureAfter(DataSourceAutoConfiguration.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>@EnableConfigurationProperties(JdbcProperties.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>@Import({ JdbcTemplateConfiguration.<span style="color:#007f7f">class</span>, NamedParameterJdbcTemplateConfiguration.<span style="color:#007f7f">class</span> })
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JdbcTemplateAutoConfiguration {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“æ»¡è¶³æ¡ä»¶ï¼š</p>
<ul>
<li><code>@ConditionalOnClass</code>ï¼šåœ¨classpathä¸­èƒ½æ‰¾åˆ°<code>DataSource</code>å’Œ<code>JdbcTemplate</code>ï¼›</li>
<li><code>@ConditionalOnSingleCandidate(DataSource.class)</code>ï¼šåœ¨å½“å‰Beançš„å®šä¹‰ä¸­èƒ½æ‰¾åˆ°å”¯ä¸€çš„<code>DataSource</code>ï¼›</li>
</ul>
<p>è¯¥<code>JdbcTemplateAutoConfiguration</code>å°±ä¼šèµ·ä½œç”¨ã€‚å®é™…åˆ›å»ºç”±å¯¼å…¥çš„<code>JdbcTemplateConfiguration</code>å®Œæˆï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration(proxyBeanMethods = <span style="color:#fff;font-weight:bold">false</span>)
</span></span><span style="display:flex;"><span>@ConditionalOnMissingBean(JdbcOperations.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> JdbcTemplateConfiguration {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    @Primary
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate(DataSource dataSource, JdbcProperties properties) {
</span></span><span style="display:flex;"><span>        JdbcTemplate jdbcTemplate = <span style="color:#fff;font-weight:bold">new</span> JdbcTemplate(dataSource);
</span></span><span style="display:flex;"><span>        JdbcProperties.<span style="color:#007f7f">Template</span> template = properties.<span style="color:#007f7f">getTemplate</span>();
</span></span><span style="display:flex;"><span>        jdbcTemplate.<span style="color:#007f7f">setFetchSize</span>(template.<span style="color:#007f7f">getFetchSize</span>());
</span></span><span style="display:flex;"><span>        jdbcTemplate.<span style="color:#007f7f">setMaxRows</span>(template.<span style="color:#007f7f">getMaxRows</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (template.<span style="color:#007f7f">getQueryTimeout</span>() != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            jdbcTemplate.<span style="color:#007f7f">setQueryTimeout</span>((<span style="color:#fff;font-weight:bold">int</span>) template.<span style="color:#007f7f">getQueryTimeout</span>().<span style="color:#007f7f">getSeconds</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> jdbcTemplate;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»º<code>JdbcTemplate</code>ä¹‹å‰ï¼Œè¦æ»¡è¶³<code>@ConditionalOnMissingBean(JdbcOperations.class)</code>ï¼Œå³ä¸å­˜åœ¨<code>JdbcOperations</code>çš„Beanã€‚</p>
<p>å¦‚æœæˆ‘ä»¬è‡ªå·±åˆ›å»ºäº†ä¸€ä¸ª<code>JdbcTemplate</code>ï¼Œä¾‹å¦‚ï¼Œåœ¨<code>Application</code>ä¸­è‡ªå·±å†™ä¸ªæ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@SpringBootApplication
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Application {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    JdbcTemplate createJdbcTemplate(@Autowired DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> JdbcTemplate(dataSource);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é‚£ä¹ˆæ ¹æ®æ¡ä»¶<code>@ConditionalOnMissingBean(JdbcOperations.class)</code>ï¼ŒSpring Bootå°±ä¸ä¼šå†åˆ›å»ºä¸€ä¸ªé‡å¤çš„<code>JdbcTemplate</code>ï¼ˆå› ä¸º<code>JdbcOperations</code>æ˜¯<code>JdbcTemplate</code>çš„çˆ¶ç±»ï¼‰ã€‚</p>
<p>å¯è§ï¼ŒSpring Bootè‡ªåŠ¨è£…é…åŠŸèƒ½æ˜¯é€šè¿‡è‡ªåŠ¨æ‰«æ+æ¡ä»¶è£…é…å®ç°çš„ï¼Œè¿™ä¸€å¥—æœºåˆ¶åœ¨é»˜è®¤æƒ…å†µä¸‹å·¥ä½œå¾—å¾ˆå¥½ï¼Œä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è¦æ‰‹åŠ¨æ§åˆ¶æŸä¸ªBeançš„åˆ›å»ºï¼Œå°±éœ€è¦è¯¦ç»†åœ°äº†è§£Spring Bootè‡ªåŠ¨åˆ›å»ºçš„åŸç†ï¼Œå¾ˆå¤šæ—¶å€™è¿˜è¦è·Ÿè¸ª<code>XxxAutoConfiguration</code>ï¼Œä»¥ä¾¿è®¾å®šæ¡ä»¶ä½¿å¾—æŸä¸ªBeanä¸ä¼šè¢«è‡ªåŠ¨åˆ›å»ºã€‚</p>
<p><strong>å°ç»“</strong>
Spring Bootæ˜¯ä¸€ä¸ªåŸºäºSpringæä¾›äº†å¼€ç®±å³ç”¨çš„ä¸€ç»„å¥—ä»¶ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬åŸºäºå¾ˆå°‘çš„é…ç½®å’Œä»£ç å¿«é€Ÿæ­å»ºå‡ºä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>Spring Bootæœ‰éå¸¸å¼ºå¤§çš„AutoConfigurationåŠŸèƒ½ï¼Œå®ƒæ˜¯é€šè¿‡è‡ªåŠ¨æ‰«æ+æ¡ä»¶è£…é…å®ç°çš„ã€‚</p>
<h1 id="æ‰“åŒ…spring-bootåº”ç”¨">æ‰“åŒ…Spring Bootåº”ç”¨<a hidden class="anchor" aria-hidden="true" href="#æ‰“åŒ…spring-bootåº”ç”¨">#</a></h1>
<p>æˆ‘ä»¬åœ¨Mavençš„<a href="https://liaoxuefeng.com/books/java/maven/plugin/index.html">ä½¿ç”¨æ’ä»¶</a>ä¸€èŠ‚ä¸­ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨<code>maven-shade-plugin</code>æ‰“åŒ…ä¸€ä¸ªå¯æ‰§è¡Œçš„jaråŒ…ã€‚åœ¨Spring Bootåº”ç”¨ä¸­ï¼Œæ‰“åŒ…æ›´åŠ ç®€å•ï¼Œå› ä¸ºSpring Bootè‡ªå¸¦ä¸€ä¸ªæ›´ç®€å•çš„<code>spring-boot-maven-plugin</code>æ’ä»¶ç”¨æ¥æ‰“åŒ…ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨<code>pom.xml</code>ä¸­åŠ å…¥ä»¥ä¸‹é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;project</span> <span style="color:#f00">...</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/project&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ— éœ€ä»»ä½•é…ç½®ï¼ŒSpring Bootçš„è¿™æ¬¾æ’ä»¶ä¼šè‡ªåŠ¨å®šä½åº”ç”¨ç¨‹åºçš„å…¥å£Classï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹Mavenå‘½ä»¤å³å¯æ‰“åŒ…ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ mvn clean package
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥<code>springboot-exec-jar</code>é¡¹ç›®ä¸ºä¾‹ï¼Œæ‰“åŒ…åæˆ‘ä»¬åœ¨<code>target</code>ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªjaræ–‡ä»¶ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span>classes
</span></span><span style="display:flex;"><span>generated-sources
</span></span><span style="display:flex;"><span>maven-archiver
</span></span><span style="display:flex;"><span>maven-status
</span></span><span style="display:flex;"><span>springboot-exec-jar-1.0-SNAPSHOT.jar
</span></span><span style="display:flex;"><span>springboot-exec-jar-1.0-SNAPSHOT.jar.original
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­ï¼Œ<code>springboot-exec-jar-1.0-SNAPSHOT.jar.original</code>æ˜¯Mavenæ ‡å‡†æ‰“åŒ…æ’ä»¶æ‰“çš„jaråŒ…ï¼Œå®ƒåªåŒ…å«æˆ‘ä»¬è‡ªå·±çš„Classï¼Œä¸åŒ…å«ä¾èµ–ï¼Œè€Œ<code>springboot-exec-jar-1.0-SNAPSHOT.jar</code>æ˜¯Spring Bootæ‰“åŒ…æ’ä»¶åˆ›å»ºçš„åŒ…å«ä¾èµ–çš„jarï¼Œå¯ä»¥ç›´æ¥è¿è¡Œï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ java -jar springboot-exec-jar-1.0-SNAPSHOT.jar
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ï¼Œéƒ¨ç½²ä¸€ä¸ªSpring Bootåº”ç”¨å°±éå¸¸ç®€å•ï¼Œæ— éœ€é¢„è£…ä»»ä½•æœåŠ¡å™¨ï¼Œåªéœ€è¦ä¸Šä¼ jaråŒ…å³å¯ã€‚</p>
<p>åœ¨æ‰“åŒ…çš„æ—¶å€™ï¼Œå› ä¸ºæ‰“åŒ…åçš„Spring Bootåº”ç”¨ä¸ä¼šè¢«ä¿®æ”¹ï¼Œå› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>spring-boot-devtools</code>è¿™ä¸ªä¾èµ–ä¸ä¼šè¢«æ‰“åŒ…è¿›å»ã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œä½¿ç”¨æ—©æœŸçš„Spring Bootç‰ˆæœ¬æ—¶ï¼Œéœ€è¦é…ç½®ä¸€ä¸‹æ‰èƒ½æ’é™¤<code>spring-boot-devtools</code>è¿™ä¸ªä¾èµ–ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;excludeDevtools&gt;</span>true<span style="font-weight:bold">&lt;/excludeDevtools&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/plugin&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœä¸å–œæ¬¢é»˜è®¤çš„é¡¹ç›®å+ç‰ˆæœ¬å·ä½œä¸ºæ–‡ä»¶åï¼Œå¯ä»¥åŠ ä¸€ä¸ªé…ç½®æŒ‡å®šæ–‡ä»¶åï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;project</span> <span style="color:#f00">...</span><span style="font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;finalName&gt;</span>awesome-app<span style="font-weight:bold">&lt;/finalName&gt;</span>
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/project&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·æ‰“åŒ…åçš„æ–‡ä»¶åå°±æ˜¯<code>awesome-app.jar</code>ã€‚</p>
<p><strong>å°ç»“</strong>
Spring Bootæä¾›äº†ä¸€ä¸ªMavenæ’ä»¶ç”¨äºæ‰“åŒ…æ‰€æœ‰ä¾èµ–åˆ°å•ä¸€jaræ–‡ä»¶ï¼Œæ­¤æ’ä»¶ååˆ†æ˜“ç”¨ï¼Œæ— éœ€é…ç½®ã€‚</p>
<h1 id="ä½¿ç”¨actuator">ä½¿ç”¨Actuator<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨actuator">#</a></h1>
<p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦å¯¹åº”ç”¨ç¨‹åºçš„çŠ¶æ€è¿›è¡Œç›‘æ§ã€‚å‰é¢æˆ‘ä»¬å·²ç»ä»‹ç»äº†ä½¿ç”¨JMXå¯¹Javaåº”ç”¨ç¨‹åºåŒ…æ‹¬JVMè¿›è¡Œç›‘æ§ï¼Œä½¿ç”¨JMXéœ€è¦æŠŠä¸€äº›ç›‘æ§ä¿¡æ¯ä»¥MBeançš„å½¢å¼æš´éœ²ç»™JMX Serverï¼Œè€ŒSpring Bootå·²ç»å†…ç½®äº†ä¸€ä¸ªç›‘æ§åŠŸèƒ½ï¼Œå®ƒå«Actuatorã€‚</p>
<p>ä½¿ç”¨Actuatoréå¸¸ç®€å•ï¼Œåªéœ€æ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæ­£å¸¸å¯åŠ¨åº”ç”¨ç¨‹åºï¼ŒActuatorä¼šæŠŠå®ƒèƒ½æ”¶é›†åˆ°çš„æ‰€æœ‰ä¿¡æ¯éƒ½æš´éœ²ç»™JMXã€‚æ­¤å¤–ï¼ŒActuatorè¿˜å¯ä»¥é€šè¿‡URL<code>/actuator/</code>æŒ‚è½½ä¸€äº›ç›‘æ§ç‚¹ï¼Œä¾‹å¦‚ï¼Œè¾“å…¥<code>http://localhost:8080/actuator/health</code>ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åº”ç”¨ç¨‹åºå½“å‰çŠ¶æ€ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;status&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;UP&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è®¸å¤šç½‘å…³ä½œä¸ºåå‘ä»£ç†éœ€è¦ä¸€ä¸ªURLæ¥æ¢æµ‹åç«¯é›†ç¾¤åº”ç”¨æ˜¯å¦å­˜æ´»ï¼Œè¿™ä¸ªURLå°±å¯ä»¥æä¾›ç»™ç½‘å…³ä½¿ç”¨ã€‚</p>
<p>Actuatoré»˜è®¤æŠŠæ‰€æœ‰è®¿é—®ç‚¹æš´éœ²ç»™JMXï¼Œä½†å¤„äºå®‰å…¨åŸå› ï¼Œåªæœ‰<code>health</code>å’Œ<code>info</code>ä¼šæš´éœ²ç»™Webã€‚Actuatoræä¾›çš„æ‰€æœ‰è®¿é—®ç‚¹å‡åœ¨å®˜æ–¹æ–‡æ¡£åˆ—å‡ºï¼Œè¦æš´éœ²æ›´å¤šçš„è®¿é—®ç‚¹ç»™Webï¼Œéœ€è¦åœ¨<code>application.yml</code>ä¸­åŠ ä¸Šé…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">management</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">endpoints</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">web</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">exposure</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">include</span>: info, health, beans, env, metrics
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¦ç‰¹åˆ«æ³¨æ„æš´éœ²çš„URLçš„å®‰å…¨æ€§ï¼Œä¾‹å¦‚ï¼Œ<code>/actuator/env</code>å¯ä»¥è·å–å½“å‰æœºå™¨çš„æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼Œä¸å¯æš´éœ²ç»™å…¬ç½‘ã€‚</p>
<p><strong>å°ç»“</strong></p>
<p>Spring Bootæä¾›äº†ä¸€ä¸ªActuatorï¼Œå¯ä»¥æ–¹ä¾¿åœ°å®ç°ç›‘æ§ï¼Œå¹¶å¯é€šè¿‡Webè®¿é—®ç‰¹å®šç±»å‹çš„ç›‘æ§ã€‚</p>
<h1 id="ä½¿ç”¨profiles">ä½¿ç”¨Profiles<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨profiles">#</a></h1>
<p>Profileæœ¬èº«æ˜¯Springæä¾›çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åœ¨<a href="https://liaoxuefeng.com/books/java/spring/ioc/conditional/index.html">ä½¿ç”¨æ¡ä»¶è£…é…</a>ä¸­å·²ç»è®²åˆ°äº†ï¼ŒProfileè¡¨ç¤ºä¸€ä¸ªç¯å¢ƒçš„æ¦‚å¿µï¼Œå¦‚å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§è¿™3ä¸ªç¯å¢ƒï¼š</p>
<ul>
<li>native</li>
<li>test</li>
<li>production</li>
</ul>
<p>æˆ–è€…æŒ‰gitåˆ†æ”¯å®šä¹‰masterã€devè¿™äº›ç¯å¢ƒï¼š</p>
<ul>
<li>master</li>
<li>dev</li>
</ul>
<p>åœ¨å¯åŠ¨ä¸€ä¸ªSpringåº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œå¯ä»¥ä¼ å…¥ä¸€ä¸ªæˆ–å¤šä¸ªç¯å¢ƒï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>-Dspring.profiles.active=test,master
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½¿ç”¨ä¸€ä¸ªç¯å¢ƒå°±è¶³å¤Ÿäº†ã€‚</p>
<p>Spring Bootå¯¹Profilesçš„æ”¯æŒåœ¨äºï¼Œå¯ä»¥åœ¨<code>application.yml</code>ä¸­ä¸ºæ¯ä¸ªç¯å¢ƒè¿›è¡Œé…ç½®ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">application</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">name</span>: ${APP_NAME:unnamed}
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:hsqldb:file:testdb
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: sa
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">dirver-class-name</span>: org.hsqldb.jdbc.JDBCDriver
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">hikari</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">auto-commit</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">connection-timeout</span>: <span style="color:#ff0;font-weight:bold">3000</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">validation-timeout</span>: <span style="color:#ff0;font-weight:bold">3000</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">max-lifetime</span>: <span style="color:#ff0;font-weight:bold">60000</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">maximum-pool-size</span>: <span style="color:#ff0;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">minimum-idle</span>: <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">pebble</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">suffix</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">cache</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: ${APP_PORT:8080}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">config</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">activate</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">on-profile</span>: test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">8000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">config</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">activate</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">on-profile</span>: production
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">pebble</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">cache</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°åˆ†éš”ç¬¦<code>---</code>ï¼Œæœ€å‰é¢çš„é…ç½®æ˜¯é»˜è®¤é…ç½®ï¼Œä¸éœ€è¦æŒ‡å®šProfileï¼Œåé¢çš„æ¯æ®µé…ç½®éƒ½å¿…é¡»ä»¥<code>spring.config.activate.on-profile: xxx</code>å¼€å¤´ï¼Œè¡¨ç¤ºä¸€ä¸ªProfileã€‚ä¸Šè¿°é…ç½®é»˜è®¤ä½¿ç”¨8080ç«¯å£ï¼Œä½†æ˜¯åœ¨<code>test</code>ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨<code>8000</code>ç«¯å£ï¼Œåœ¨<code>production</code>ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨<code>80</code>ç«¯å£ï¼Œå¹¶ä¸”å¯ç”¨Pebbleçš„ç¼“å­˜ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬ä¸æŒ‡å®šä»»ä½•Profileï¼Œç›´æ¥å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆProfileå®é™…ä¸Šå°±æ˜¯<code>default</code>ï¼Œå¯ä»¥ä»Spring Bootå¯åŠ¨æ—¥å¿—çœ‹å‡ºï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>2022-11-25T11:10:34.006+08:00  INFO 13537 --- [           main] com.itranswarp.learnjava.Application     : No active profile set, falling back to 1 default profile: &#34;default&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°æ—¥å¿—æ˜¾ç¤ºæœªè®¾ç½®Profileï¼Œä½¿ç”¨é»˜è®¤çš„Profileä¸º<code>default</code>ã€‚</p>
<p>è¦ä»¥<code>test</code>ç¯å¢ƒå¯åŠ¨ï¼Œå¯è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>$ java -Dspring.profiles.active=test -jar springboot-profiles-1.0-SNAPSHOT.jar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>2022-11-25T11:09:02.946+08:00  INFO 13510 --- [           main] com.itranswarp.learnjava.Application     : The following 1 profile is active: &#34;test&#34;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>2022-11-25T11:09:05.124+08:00  INFO 13510 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8000 (http) with context path &#39;&#39;
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»æ—¥å¿—çœ‹åˆ°æ´»åŠ¨çš„Profileæ˜¯<code>test</code>ï¼ŒTomcatçš„ç›‘å¬ç«¯å£æ˜¯<code>8000</code>ã€‚</p>
<p>é€šè¿‡Profileå¯ä»¥å®ç°ä¸€å¥—ä»£ç åœ¨ä¸åŒç¯å¢ƒå¯ç”¨ä¸åŒçš„é…ç½®å’ŒåŠŸèƒ½ã€‚å‡è®¾æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå­˜å‚¨æœåŠ¡ï¼Œåœ¨æœ¬åœ°å¼€å‘æ—¶ï¼Œç›´æ¥ä½¿ç”¨æ–‡ä»¶å­˜å‚¨å³å¯ï¼Œä½†æ˜¯ï¼Œåœ¨æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒï¼Œéœ€è¦å­˜å‚¨åˆ°äº‘ç«¯å¦‚S3ä¸Šï¼Œå¦‚ä½•é€šè¿‡Profileå®ç°è¯¥åŠŸèƒ½ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦å®šä¹‰å­˜å‚¨æ¥å£<code>StorageService</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> StorageService {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ ¹æ®URIæ‰“å¼€InputStream:</span>
</span></span><span style="display:flex;"><span>    InputStream openInputStream(String uri) <span style="color:#fff;font-weight:bold">throws</span> IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ ¹æ®æ‰©å±•å+InputStreamä¿å­˜å¹¶è¿”å›URI:</span>
</span></span><span style="display:flex;"><span>    String store(String extName, InputStream input) <span style="color:#fff;font-weight:bold">throws</span> IOException;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ¬åœ°å­˜å‚¨å¯é€šè¿‡<code>LocalStorageService</code>å®ç°ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@Profile(<span style="color:#0ff;font-weight:bold">&#34;default&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LocalStorageService <span style="color:#fff;font-weight:bold">implements</span> StorageService {
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${storage.local:/var/static}&#34;</span>)
</span></span><span style="display:flex;"><span>    String localStorageRootDir;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Logger logger = LoggerFactory.<span style="color:#007f7f">getLogger</span>(getClass());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> File localStorageRoot;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init() {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;Intializing local storage with root dir: {}&#34;</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">localStorageRootDir</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">localStorageRoot</span> = <span style="color:#fff;font-weight:bold">new</span> File(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">localStorageRootDir</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> InputStream openInputStream(String uri) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        File targetFile = <span style="color:#fff;font-weight:bold">new</span> File(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">localStorageRoot</span>, uri);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> BufferedInputStream(<span style="color:#fff;font-weight:bold">new</span> FileInputStream(targetFile));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String store(String extName, InputStream input) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        String fileName = UUID.<span style="color:#007f7f">randomUUID</span>().<span style="color:#007f7f">toString</span>() + <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span> + extName;
</span></span><span style="display:flex;"><span>        File targetFile = <span style="color:#fff;font-weight:bold">new</span> File(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">localStorageRoot</span>, fileName);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> (OutputStream output = <span style="color:#fff;font-weight:bold">new</span> BufferedOutputStream(<span style="color:#fff;font-weight:bold">new</span> FileOutputStream(targetFile))) {
</span></span><span style="display:flex;"><span>            input.<span style="color:#007f7f">transferTo</span>(output);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> fileName;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è€Œäº‘ç«¯å­˜å‚¨å¯é€šè¿‡<code>CloudStorageService</code>å®ç°ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@Profile(<span style="color:#0ff;font-weight:bold">&#34;!default&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CloudStorageService <span style="color:#fff;font-weight:bold">implements</span> StorageService {
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${storage.cloud.bucket:}&#34;</span>)
</span></span><span style="display:flex;"><span>    String bucket;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${storage.cloud.access-key:}&#34;</span>)
</span></span><span style="display:flex;"><span>    String accessKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${storage.cloud.access-secret:}&#34;</span>)
</span></span><span style="display:flex;"><span>    String accessSecret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Logger logger = LoggerFactory.<span style="color:#007f7f">getLogger</span>(getClass());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// TODO:</span>
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;Initializing cloud storage...&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> InputStream openInputStream(String uri) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// TODO:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IOException(<span style="color:#0ff;font-weight:bold">&#34;File not found: &#34;</span> + uri);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String store(String extName, InputStream input) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// TODO:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IOException(<span style="color:#0ff;font-weight:bold">&#34;Unable to access cloud storage.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°<code>LocalStorageService</code>ä½¿ç”¨äº†æ¡ä»¶è£…é…<code>@Profile(&quot;default&quot;)</code>ï¼Œå³é»˜è®¤å¯ç”¨<code>LocalStorageService</code>ï¼Œè€Œ<code>CloudStorageService</code>ä½¿ç”¨äº†æ¡ä»¶è£…é…<code>@Profile(&quot;!default&quot;)</code>ï¼Œå³é<code>default</code>ç¯å¢ƒæ—¶ï¼Œè‡ªåŠ¨å¯ç”¨<code>CloudStorageService</code>ã€‚è¿™æ ·ï¼Œä¸€å¥—ä»£ç ï¼Œå°±å®ç°äº†ä¸åŒç¯å¢ƒå¯ç”¨ä¸åŒçš„é…ç½®ã€‚</p>
<p><strong>å°ç»“</strong>
Spring Bootå…è®¸åœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­é’ˆå¯¹ä¸åŒProfileè¿›è¡Œé…ç½®ï¼›
Spring Bootåœ¨æœªæŒ‡å®šProfileæ—¶é»˜è®¤ä¸ºdefaultã€‚</p>
<h1 id="ä½¿ç”¨conditional">ä½¿ç”¨Conditional<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨conditional">#</a></h1>
<p>ä½¿ç”¨Profileèƒ½æ ¹æ®ä¸åŒçš„Profileè¿›è¡Œæ¡ä»¶è£…é…ï¼Œä½†æ˜¯Profileæ§åˆ¶æ¯”è¾ƒç³™ï¼Œå¦‚æœæƒ³è¦ç²¾ç»†æ§åˆ¶ï¼Œä¾‹å¦‚ï¼Œé…ç½®æœ¬åœ°å­˜å‚¨ï¼ŒAWSå­˜å‚¨å’Œé˜¿é‡Œäº‘å­˜å‚¨ï¼Œå°†æ¥å¾ˆå¯èƒ½ä¼šå¢åŠ Azureå­˜å‚¨ç­‰ï¼Œç”¨Profileå°±å¾ˆéš¾å®ç°ã€‚</p>
<p>Springæœ¬èº«æä¾›äº†æ¡ä»¶è£…é…<code>@Conditional</code>ï¼Œä½†æ˜¯è¦è‡ªå·±ç¼–å†™æ¯”è¾ƒå¤æ‚çš„<code>Condition</code>æ¥åšåˆ¤æ–­ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚Spring Bootåˆ™ä¸ºæˆ‘ä»¬å‡†å¤‡å¥½äº†å‡ ä¸ªéå¸¸æœ‰ç”¨çš„æ¡ä»¶ï¼š</p>
<ul>
<li>@ConditionalOnPropertyï¼šå¦‚æœæœ‰æŒ‡å®šçš„é…ç½®ï¼Œæ¡ä»¶ç”Ÿæ•ˆï¼›</li>
<li>@ConditionalOnBeanï¼šå¦‚æœæœ‰æŒ‡å®šçš„Beanï¼Œæ¡ä»¶ç”Ÿæ•ˆï¼›</li>
<li>@ConditionalOnMissingBeanï¼šå¦‚æœæ²¡æœ‰æŒ‡å®šçš„Beanï¼Œæ¡ä»¶ç”Ÿæ•ˆï¼›</li>
<li>@ConditionalOnMissingClassï¼šå¦‚æœæ²¡æœ‰æŒ‡å®šçš„Classï¼Œæ¡ä»¶ç”Ÿæ•ˆï¼›</li>
<li>@ConditionalOnWebApplicationï¼šåœ¨Webç¯å¢ƒä¸­æ¡ä»¶ç”Ÿæ•ˆï¼›</li>
<li>@ConditionalOnExpressionï¼šæ ¹æ®è¡¨è¾¾å¼åˆ¤æ–­æ¡ä»¶æ˜¯å¦ç”Ÿæ•ˆã€‚</li>
</ul>
<p>æˆ‘ä»¬ä»¥æœ€å¸¸ç”¨çš„<code>@ConditionalOnProperty</code>ä¸ºä¾‹ï¼ŒæŠŠä¸Šä¸€èŠ‚çš„<code>StorageService</code>æ”¹å†™å¦‚ä¸‹ã€‚é¦–å…ˆï¼Œå®šä¹‰é…ç½®<code>storage.type=xxx</code>ï¼Œç”¨æ¥åˆ¤æ–­æ¡ä»¶ï¼Œé»˜è®¤ä¸º<code>local</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">storage</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">type</span>: ${STORAGE_TYPE:local}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è®¾å®šä¸º<code>local</code>æ—¶ï¼Œå¯ç”¨<code>LocalStorageService</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@ConditionalOnProperty(value = <span style="color:#0ff;font-weight:bold">&#34;storage.type&#34;</span>, havingValue = <span style="color:#0ff;font-weight:bold">&#34;local&#34;</span>, matchIfMissing = <span style="color:#fff;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LocalStorageService <span style="color:#fff;font-weight:bold">implements</span> StorageService {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è®¾å®šä¸º<code>aws</code>æ—¶ï¼Œå¯ç”¨<code>AwsStorageService</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@ConditionalOnProperty(value = <span style="color:#0ff;font-weight:bold">&#34;storage.type&#34;</span>, havingValue = <span style="color:#0ff;font-weight:bold">&#34;aws&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AwsStorageService <span style="color:#fff;font-weight:bold">implements</span> StorageService {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è®¾å®šä¸º<code>aliyun</code>æ—¶ï¼Œå¯ç”¨<code>AliyunStorageService</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@ConditionalOnProperty(value = <span style="color:#0ff;font-weight:bold">&#34;storage.type&#34;</span>, havingValue = <span style="color:#0ff;font-weight:bold">&#34;aliyun&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AliyunStorageService <span style="color:#fff;font-weight:bold">implements</span> StorageService {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°<code>LocalStorageService</code>çš„æ³¨è§£ï¼Œå½“æŒ‡å®šé…ç½®ä¸º<code>local</code>ï¼Œæˆ–è€…é…ç½®ä¸å­˜åœ¨ï¼Œå‡å¯ç”¨<code>LocalStorageService</code>ã€‚</p>
<p>å¯è§ï¼ŒSpring Bootæä¾›çš„æ¡ä»¶è£…é…ä½¿å¾—åº”ç”¨ç¨‹åºæ›´åŠ å…·æœ‰çµæ´»æ€§ã€‚</p>
<p><strong>å°ç»“</strong></p>
<p>Spring Bootæä¾›äº†å‡ ä¸ªéå¸¸æœ‰ç”¨çš„æ¡ä»¶è£…é…æ³¨è§£ï¼Œå¯å®ç°çµæ´»çš„æ¡ä»¶è£…é…ã€‚</p>
<h1 id="åŠ è½½é…ç½®æ–‡ä»¶">åŠ è½½é…ç½®æ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#åŠ è½½é…ç½®æ–‡ä»¶">#</a></h1>
<p>åŠ è½½é…ç½®æ–‡ä»¶å¯ä»¥ç›´æ¥ä½¿ç”¨æ³¨è§£<code>@Value</code>ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæœ€å¤§å…è®¸ä¸Šä¼ çš„æ–‡ä»¶å¤§å°é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">storage</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">local</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">max-size</span>: <span style="color:#ff0;font-weight:bold">102400</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æŸä¸ªFileUploaderé‡Œï¼Œéœ€è¦è·å–è¯¥é…ç½®ï¼Œå¯ä½¿ç”¨<code>@Value</code>æ³¨å…¥ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FileUploader {
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${storage.local.max-size:102400}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> maxSize;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨å¦ä¸€ä¸ª<code>UploadFilter</code>ä¸­ï¼Œå› ä¸ºè¦æ£€æŸ¥æ–‡ä»¶çš„MD5ï¼ŒåŒæ—¶ä¹Ÿè¦æ£€æŸ¥è¾“å…¥æµçš„å¤§å°ï¼Œå› æ­¤ï¼Œä¹Ÿéœ€è¦è¯¥é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UploadFilter <span style="color:#fff;font-weight:bold">implements</span> Filter {
</span></span><span style="display:flex;"><span>    @Value(<span style="color:#0ff;font-weight:bold">&#34;${storage.local.max-size:100000}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> maxSize;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¤šæ¬¡å¼•ç”¨åŒä¸€ä¸ª<code>@Value</code>ä¸ä½†éº»çƒ¦ï¼Œè€Œä¸”<code>@Value</code>ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œç¼ºå°‘ç¼–è¯‘å™¨æ£€æŸ¥ï¼Œå®¹æ˜“é€ æˆå¤šå¤„å¼•ç”¨ä¸ä¸€è‡´ï¼ˆä¾‹å¦‚ï¼Œ<code>UploadFilter</code>æŠŠç¼ºçœå€¼è¯¯å†™ä¸º<code>100000</code>ï¼‰ã€‚</p>
<p>ä¸ºäº†æ›´å¥½åœ°ç®¡ç†é…ç½®ï¼ŒSpring Bootå…è®¸åˆ›å»ºä¸€ä¸ªBeanï¼ŒæŒæœ‰ä¸€ç»„é…ç½®ï¼Œå¹¶ç”±Spring Bootè‡ªåŠ¨æ³¨å…¥ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬åœ¨<code>application.yml</code>ä¸­æ·»åŠ äº†å¦‚ä¸‹é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">storage</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ–‡ä»¶å­˜å‚¨æ ¹ç›®å½•:</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">root-dir</span>: ${STORAGE_LOCAL_ROOT:/var/storage}
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æœ€å¤§æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤100K:</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">max-size</span>: ${STORAGE_LOCAL_MAX_SIZE:102400}
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æ˜¯å¦å…è®¸ç©ºæ–‡ä»¶:</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">allow-empty</span>: <span style="color:#fff;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># å…è®¸çš„æ–‡ä»¶ç±»å‹:</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">allow-types</span>: jpg, png, gif
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥é¦–å…ˆå®šä¹‰ä¸€ä¸ªJava Beanï¼ŒæŒæœ‰è¯¥ç»„é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> StorageConfiguration {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String rootDir;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> maxSize;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">boolean</span> allowEmpty;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> List&lt;String&gt; allowTypes;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// TODO: getters and setters</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿è¯Java Beançš„å±æ€§åç§°ä¸é…ç½®ä¸€è‡´å³å¯ã€‚ç„¶åï¼Œæˆ‘ä»¬æ·»åŠ ä¸¤ä¸ªæ³¨è§£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ConfigurationProperties(<span style="color:#0ff;font-weight:bold">&#34;storage.local&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> StorageConfiguration {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°<code>@ConfigurationProperties(&quot;storage.local&quot;)</code>è¡¨ç¤ºå°†ä»é…ç½®é¡¹<code>storage.local</code>è¯»å–è¯¥é¡¹çš„æ‰€æœ‰å­é¡¹é…ç½®ï¼Œå¹¶ä¸”ï¼Œ<code>@Configuration</code>è¡¨ç¤º<code>StorageConfiguration</code>ä¹Ÿæ˜¯ä¸€ä¸ªSpringç®¡ç†çš„Beanï¼Œå¯ç›´æ¥æ³¨å…¥åˆ°å…¶ä»–Beanä¸­ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> StorageService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Logger logger = LoggerFactory.<span style="color:#007f7f">getLogger</span>(getClass());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    StorageConfiguration storageConfig;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init() {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;Load configuration: root-dir = {}&#34;</span>, storageConfig.<span style="color:#007f7f">getRootDir</span>());
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;Load configuration: max-size = {}&#34;</span>, storageConfig.<span style="color:#007f7f">getMaxSize</span>());
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;Load configuration: allowed-types = {}&#34;</span>, storageConfig.<span style="color:#007f7f">getAllowTypes</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ä¸€æ¥ï¼Œå¼•å…¥<code>storage.local</code>çš„ç›¸å…³é…ç½®å°±å¾ˆå®¹æ˜“äº†ï¼Œå› ä¸ºåªéœ€è¦æ³¨å…¥<code>StorageConfiguration</code>è¿™ä¸ªBeanï¼Œè¿™æ ·å¯ä»¥ç”±ç¼–è¯‘å™¨æ£€æŸ¥ç±»å‹ï¼Œæ— éœ€ç¼–å†™é‡å¤çš„<code>@Value</code>æ³¨è§£ã€‚</p>
<p><strong>å°ç»“</strong></p>
<p>Spring Bootæä¾›äº†<code>@ConfigurationProperties</code>æ³¨è§£ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°æŠŠä¸€æ®µé…ç½®åŠ è½½åˆ°ä¸€ä¸ªBeanä¸­ã€‚</p>
<h1 id="ç¦ç”¨è‡ªåŠ¨é…ç½®">ç¦ç”¨è‡ªåŠ¨é…ç½®<a hidden class="anchor" aria-hidden="true" href="#ç¦ç”¨è‡ªåŠ¨é…ç½®">#</a></h1>
<p>Spring Bootå¤§é‡ä½¿ç”¨è‡ªåŠ¨é…ç½®å’Œé»˜è®¤é…ç½®ï¼Œæå¤§åœ°å‡å°‘äº†ä»£ç ï¼Œé€šå¸¸åªéœ€è¦åŠ ä¸Šå‡ ä¸ªæ³¨è§£ï¼Œå¹¶æŒ‰ç…§é»˜è®¤è§„åˆ™è®¾å®šä¸€ä¸‹å¿…è¦çš„é…ç½®å³å¯ã€‚ä¾‹å¦‚ï¼Œé…ç½®JDBCï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œåªéœ€è¦é…ç½®ä¸€ä¸ª<code>spring.datasource</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:hsqldb:file:testdb
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: sa
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">dirver-class-name</span>: org.hsqldb.jdbc.JDBCDriver
</span></span></code></pre></td></tr></table>
</div>
</div><p>Spring Bootå°±ä¼šè‡ªåŠ¨åˆ›å»ºå‡º<code>DataSource</code>ã€<code>JdbcTemplate</code>ã€<code>DataSourceTransactionManager</code>ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p>
<p>ä½†æ˜¯ï¼Œæœ‰æ—¶å€™ï¼Œæˆ‘ä»¬åˆå¿…é¡»è¦ç¦ç”¨æŸäº›è‡ªåŠ¨é…ç½®ã€‚ä¾‹å¦‚ï¼Œç³»ç»Ÿæœ‰ä¸»ä»ä¸¤ä¸ªæ•°æ®åº“ï¼Œè€ŒSpring Bootçš„è‡ªåŠ¨é…ç½®åªèƒ½é…ä¸€ä¸ªï¼Œæ€ä¹ˆåŠï¼Ÿ</p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œé’ˆå¯¹<code>DataSource</code>ç›¸å…³çš„è‡ªåŠ¨é…ç½®ï¼Œå°±å¿…é¡»å…³æ‰ã€‚æˆ‘ä»¬éœ€è¦ç”¨<code>exclude</code>æŒ‡å®šéœ€è¦å…³æ‰çš„è‡ªåŠ¨é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@SpringBootApplication
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// å¯åŠ¨è‡ªåŠ¨é…ç½®ï¼Œä½†æ’é™¤æŒ‡å®šçš„è‡ªåŠ¨é…ç½®:</span>
</span></span><span style="display:flex;"><span>@EnableAutoConfiguration(exclude = DataSourceAutoConfiguration.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Application {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨ï¼ŒSpring Bootä¸å†ç»™æˆ‘ä»¬è‡ªåŠ¨åˆ›å»º<code>DataSource</code>ã€<code>JdbcTemplate</code>å’Œ<code>DataSourceTransactionManager</code>äº†ï¼Œè¦å®ç°ä¸»ä»æ•°æ®åº“æ”¯æŒï¼Œæ€ä¹ˆåŠï¼Ÿ</p>
<p>è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥å¼€å§‹ç¼–å†™æ”¯æŒä¸»ä»æ•°æ®åº“çš„åŠŸèƒ½ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æŠŠä¸»ä»æ•°æ®åº“é…ç½®å†™åˆ°<code>application.yml</code>ä¸­ï¼Œä»ç„¶æŒ‰ç…§Spring Booté»˜è®¤çš„æ ¼å¼å†™ï¼Œä½†<code>datasource</code>æ”¹ä¸º<code>datasource-master</code>å’Œ<code>datasource-slave</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource-master</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:hsqldb:file:testdb
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: sa
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">dirver-class-name</span>: org.hsqldb.jdbc.JDBCDriver
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">datasource-slave</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">url</span>: jdbc:hsqldb:file:testdb
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: sa
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">dirver-class-name</span>: org.hsqldb.jdbc.JDBCDriver
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°ä¸¤ä¸ªæ•°æ®åº“å®é™…ä¸Šæ˜¯åŒä¸€ä¸ªåº“ã€‚å¦‚æœä½¿ç”¨MySQLï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªåªè¯»ç”¨æˆ·ï¼Œä½œä¸º<code>datasource-slave</code>çš„ç”¨æˆ·æ¥æ¨¡æ‹Ÿä¸€ä¸ªä»åº“ã€‚</p>
<p>ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬åˆ†åˆ«åˆ›å»ºä¸¤ä¸ªHikariCPçš„<code>DataSource</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MasterDataSourceConfiguration {
</span></span><span style="display:flex;"><span>    @Bean(<span style="color:#0ff;font-weight:bold">&#34;masterDataSourceProperties&#34;</span>)
</span></span><span style="display:flex;"><span>    @ConfigurationProperties(<span style="color:#0ff;font-weight:bold">&#34;spring.datasource-master&#34;</span>)
</span></span><span style="display:flex;"><span>    DataSourceProperties dataSourceProperties() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> DataSourceProperties();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(<span style="color:#0ff;font-weight:bold">&#34;masterDataSource&#34;</span>)
</span></span><span style="display:flex;"><span>    DataSource dataSource(@Autowired @Qualifier(<span style="color:#0ff;font-weight:bold">&#34;masterDataSourceProperties&#34;</span>) DataSourceProperties props) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> props.<span style="color:#007f7f">initializeDataSourceBuilder</span>().<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SlaveDataSourceConfiguration {
</span></span><span style="display:flex;"><span>    @Bean(<span style="color:#0ff;font-weight:bold">&#34;slaveDataSourceProperties&#34;</span>)
</span></span><span style="display:flex;"><span>    @ConfigurationProperties(<span style="color:#0ff;font-weight:bold">&#34;spring.datasource-slave&#34;</span>)
</span></span><span style="display:flex;"><span>    DataSourceProperties dataSourceProperties() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> DataSourceProperties();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(<span style="color:#0ff;font-weight:bold">&#34;slaveDataSource&#34;</span>)
</span></span><span style="display:flex;"><span>    DataSource dataSource(@Autowired @Qualifier(<span style="color:#0ff;font-weight:bold">&#34;slaveDataSourceProperties&#34;</span>) DataSourceProperties props) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> props.<span style="color:#007f7f">initializeDataSourceBuilder</span>().<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°ä¸Šè¿°classå¹¶æœªæ·»åŠ <code>@Configuration</code>å’Œ<code>@Component</code>ï¼Œè¦ä½¿ä¹‹ç”Ÿæ•ˆï¼Œå¯ä»¥ä½¿ç”¨<code>@Import</code>å¯¼å…¥ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@SpringBootApplication
</span></span><span style="display:flex;"><span>@EnableAutoConfiguration(exclude = DataSourceAutoConfiguration.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>@Import({ MasterDataSourceConfiguration.<span style="color:#007f7f">class</span>, SlaveDataSourceConfiguration.<span style="color:#007f7f">class</span>})
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Application {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤–ï¼Œä¸Šè¿°ä¸¤ä¸ª<code>DataSource</code>çš„Beanåç§°åˆ†åˆ«ä¸º<code>masterDataSource</code>å’Œ<code>slaveDataSource</code>ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªæœ€ç»ˆçš„<code>@Primary</code>æ ‡æ³¨çš„<code>DataSource</code>ï¼Œå®ƒé‡‡ç”¨Springæä¾›çš„<code>AbstractRoutingDataSource</code>ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> RoutingDataSource <span style="color:#fff;font-weight:bold">extends</span> AbstractRoutingDataSource {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> Object determineCurrentLookupKey() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ä»ThreadLocalä¸­å–å‡ºkey:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> RoutingDataSourceContext.<span style="color:#007f7f">getDataSourceRoutingKey</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>RoutingDataSource</code>æœ¬èº«å¹¶ä¸æ˜¯çœŸæ­£çš„<code>DataSource</code>ï¼Œå®ƒé€šè¿‡Mapå…³è”ä¸€ç»„<code>DataSource</code>ï¼Œä¸‹é¢çš„ä»£ç åˆ›å»ºäº†åŒ…å«ä¸¤ä¸ª<code>DataSource</code>çš„<code>RoutingDataSource</code>ï¼Œå…³è”çš„keyåˆ†åˆ«ä¸º<code>masterDataSource</code>å’Œ<code>slaveDataSource</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> RoutingDataSourceConfiguration {
</span></span><span style="display:flex;"><span>    @Primary
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    DataSource dataSource(
</span></span><span style="display:flex;"><span>            @Autowired @Qualifier(<span style="color:#0ff;font-weight:bold">&#34;masterDataSource&#34;</span>) DataSource masterDataSource,
</span></span><span style="display:flex;"><span>            @Autowired @Qualifier(<span style="color:#0ff;font-weight:bold">&#34;slaveDataSource&#34;</span>) DataSource slaveDataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">var</span> ds = <span style="color:#fff;font-weight:bold">new</span> RoutingDataSource();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å…³è”ä¸¤ä¸ªDataSource:</span>
</span></span><span style="display:flex;"><span>        ds.<span style="color:#007f7f">setTargetDataSources</span>(Map.<span style="color:#007f7f">of</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;masterDataSource&#34;</span>, masterDataSource,
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;slaveDataSource&#34;</span>, slaveDataSource));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// é»˜è®¤ä½¿ç”¨masterDataSource:</span>
</span></span><span style="display:flex;"><span>        ds.<span style="color:#007f7f">setDefaultTargetDataSource</span>(masterDataSource);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ds;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate(@Autowired DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> JdbcTemplate(dataSource);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    DataSourceTransactionManager dataSourceTransactionManager(@Autowired DataSource dataSource) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> DataSourceTransactionManager(dataSource);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»ç„¶éœ€è¦è‡ªå·±åˆ›å»º<code>JdbcTemplate</code>å’Œ<code>PlatformTransactionManager</code>ï¼Œæ³¨å…¥çš„æ˜¯æ ‡è®°ä¸º<code>@Primary</code>çš„<code>RoutingDataSource</code>ã€‚</p>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹çš„ä»£ç å°±å¯ä»¥åˆ‡æ¢<code>RoutingDataSource</code>åº•å±‚ä½¿ç”¨çš„çœŸæ­£çš„<code>DataSource</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>RoutingDataSourceContext.<span style="color:#007f7f">setDataSourceRoutingKey</span>(<span style="color:#0ff;font-weight:bold">&#34;slaveDataSource&#34;</span>);
</span></span><span style="display:flex;"><span>jdbcTemplate.<span style="color:#007f7f">query</span>(...);
</span></span></code></pre></td></tr></table>
</div>
</div><p>åªä¸è¿‡å†™ä»£ç åˆ‡æ¢DataSourceå³éº»çƒ¦åˆå®¹æ˜“å‡ºé”™ï¼Œæ›´å¥½çš„æ–¹å¼æ˜¯é€šè¿‡æ³¨è§£é…åˆAOPå®ç°è‡ªåŠ¨åˆ‡æ¢ï¼Œè¿™æ ·ï¼Œå®¢æˆ·ç«¯ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserController {
</span></span><span style="display:flex;"><span>	@RoutingWithSlave <span style="color:#007f7f">// &lt;-- æŒ‡ç¤ºåœ¨æ­¤æ–¹æ³•ä¸­ä½¿ç”¨slaveæ•°æ®åº“</span>
</span></span><span style="display:flex;"><span>	@GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/profile&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">public</span> ModelAndView profile(HttpSession session) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ç°ä¸Šè¿°åŠŸèƒ½éœ€è¦ç¼–å†™ä¸€ä¸ª<code>@RoutingWithSlave</code>æ³¨è§£ï¼Œä¸€ä¸ªAOPç»‡å…¥å’Œä¸€ä¸ª<code>ThreadLocal</code>æ¥ä¿å­˜keyã€‚ç”±äºä»£ç æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸å†è¯¦è¿°ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¦ç¡®è®¤æ˜¯å¦çœŸçš„åˆ‡æ¢äº†<code>DataSource</code>ï¼Œå¯ä»¥è¦†å†™<code>determineTargetDataSource()</code>æ–¹æ³•å¹¶æ‰“å°å‡º<code>DataSource</code>çš„åç§°ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> RoutingDataSource <span style="color:#fff;font-weight:bold">extends</span> AbstractRoutingDataSource {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> DataSource determineTargetDataSource() {
</span></span><span style="display:flex;"><span>        DataSource ds = <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">determineTargetDataSource</span>();
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;determin target datasource: {}&#34;</span>, ds);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> ds;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è®¿é—®ä¸åŒçš„URLï¼Œå¯ä»¥åœ¨æ—¥å¿—ä¸­çœ‹åˆ°ä¸¤ä¸ª<code>DataSource</code>ï¼Œåˆ†åˆ«æ˜¯<code>HikariPool-1</code>å’Œ<code>hikariPool-2</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>2020-06-14 17:55:21.676  INFO 91561 --- [nio-8080-exec-7] c.i.learnjava.config.RoutingDataSource   : determin target datasource: HikariDataSource (HikariPool-1)
</span></span><span style="display:flex;"><span>2020-06-14 17:57:08.992  INFO 91561 --- [io-8080-exec-10] c.i.learnjava.config.RoutingDataSource   : determin target datasource: HikariDataSource (HikariPool-2)
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ç”¨ä¸€ä¸ªå›¾æ¥è¡¨ç¤ºåˆ›å»ºçš„DataSourceä»¥åŠç›¸å…³Beançš„å…³ç³»ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>â”‚@Primary            â”‚&lt;â”€â”€â”€â”€â”€â”€â”‚   JdbcTemplate   â”‚
</span></span><span style="display:flex;"><span>â”‚RoutingDataSource   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span style="display:flex;"><span>â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>â”‚ â”‚MasterDataSourceâ”‚ â”‚&lt;â”€â”€â”€â”€â”€â”€â”‚DataSource        â”‚
</span></span><span style="display:flex;"><span>â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚TransactionManagerâ”‚
</span></span><span style="display:flex;"><span>â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span style="display:flex;"><span>â”‚ â”‚SlaveDataSource â”‚ â”‚
</span></span><span style="display:flex;"><span>â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
</span></span><span style="display:flex;"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°<code>DataSourceTransactionManager</code>å’Œ<code>JdbcTemplate</code>å¼•ç”¨çš„éƒ½æ˜¯<code>RoutingDataSource</code>ï¼Œæ‰€ä»¥ï¼Œè¿™ç§è®¾è®¡çš„ä¸€ä¸ªé™åˆ¶å°±æ˜¯ï¼šåœ¨ä¸€ä¸ªè¯·æ±‚ä¸­ï¼Œä¸€æ—¦åˆ‡æ¢äº†å†…éƒ¨æ•°æ®æºï¼Œåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä¸èƒ½å†åˆ‡åˆ°å¦ä¸€ä¸ªï¼Œå¦åˆ™ï¼Œ<code>DataSourceTransactionManager</code>å’Œ<code>JdbcTemplate</code>æ“ä½œçš„å°±ä¸æ˜¯åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥ã€‚</p>
<p><strong>å°ç»“</strong></p>
<p>å¯ä»¥é€šè¿‡<code>@EnableAutoConfiguration(exclude = {...})</code>æŒ‡å®šç¦ç”¨çš„è‡ªåŠ¨é…ç½®ï¼›</p>
<p>å¯ä»¥é€šè¿‡<code>@Import({...})</code>å¯¼å…¥è‡ªå®šä¹‰é…ç½®ã€‚</p>
<h1 id="æ·»åŠ filter">æ·»åŠ Filter<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ filter">#</a></h1>
<p>æˆ‘ä»¬åœ¨Springä¸­å·²ç»å­¦è¿‡äº†<a href="https://liaoxuefeng.com/books/java/spring/web/filter/index.html">é›†æˆFilter</a>ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡ä»£ç†ï¼ŒæŠŠSpringç®¡ç†çš„Beanæ³¨å†Œåˆ°Servletå®¹å™¨ä¸­ï¼Œä¸è¿‡æ­¥éª¤æ¯”è¾ƒç¹çï¼Œéœ€è¦é…ç½®<code>web.xml</code>ã€‚</p>
<p>åœ¨Spring Bootä¸­ï¼Œæ·»åŠ ä¸€ä¸ª<code>Filter</code>æ›´ç®€å•äº†ï¼Œå¯ä»¥åšåˆ°é›¶é…ç½®ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨Spring Bootä¸­å¦‚ä½•æ·»åŠ <code>Filter</code>ã€‚</p>
<p>Spring Bootä¼šè‡ªåŠ¨æ‰«ææ‰€æœ‰çš„<code>FilterRegistrationBean</code>ç±»å‹çš„Beanï¼Œç„¶åï¼Œå°†å®ƒä»¬è¿”å›çš„<code>Filter</code>è‡ªåŠ¨æ³¨å†Œåˆ°Servletå®¹å™¨ä¸­ï¼Œæ— éœ€ä»»ä½•é…ç½®ã€‚</p>
<p>æˆ‘ä»¬è¿˜æ˜¯ä»¥<code>AuthFilter</code>ä¸ºä¾‹ï¼Œé¦–å…ˆç¼–å†™ä¸€ä¸ª<code>AuthFilterRegistrationBean</code>ï¼Œå®ƒç»§æ‰¿è‡ª<code>FilterRegistrationBean</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AuthFilterRegistrationBean <span style="color:#fff;font-weight:bold">extends</span> FilterRegistrationBean&lt;Filter&gt; {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    UserService userService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Filter getFilter() {
</span></span><span style="display:flex;"><span>        setOrder(10);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> AuthFilter();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">class</span> AuthFilter <span style="color:#fff;font-weight:bold">implements</span> Filter {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>FilterRegistrationBean</code>æœ¬èº«ä¸æ˜¯<code>Filter</code>ï¼Œå®ƒå®é™…ä¸Šæ˜¯<code>Filter</code>çš„å·¥å‚ã€‚Spring Bootä¼šè°ƒç”¨<code>getFilter()</code>ï¼ŒæŠŠè¿”å›çš„<code>Filter</code>æ³¨å†Œåˆ°Servletå®¹å™¨ä¸­ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥åœ¨<code>FilterRegistrationBean</code>ä¸­æ³¨å…¥éœ€è¦çš„èµ„æºï¼Œç„¶åï¼Œåœ¨è¿”å›çš„<code>AuthFilter</code>ä¸­ï¼Œè¿™ä¸ªå†…éƒ¨ç±»å¯ä»¥å¼•ç”¨å¤–éƒ¨ç±»çš„æ‰€æœ‰å­—æ®µï¼Œè‡ªç„¶ä¹ŸåŒ…æ‹¬æ³¨å…¥çš„<code>UserService</code>ï¼Œæ‰€ä»¥ï¼Œæ•´ä¸ªè¿‡ç¨‹å®Œå…¨åŸºäºSpringçš„IoCå®¹å™¨å®Œæˆã€‚</p>
<p>å†æ³¨æ„åˆ°<code>AuthFilterRegistrationBean</code>ä½¿ç”¨äº†<code>setOrder(10)</code>ï¼Œå› ä¸ºSpring Bootæ”¯æŒç»™å¤šä¸ª<code>Filter</code>æ’åºï¼Œæ•°å­—å°çš„åœ¨å‰é¢ï¼Œæ‰€ä»¥ï¼Œå¤šä¸ª<code>Filter</code>çš„é¡ºåºæ˜¯å¯ä»¥å›ºå®šçš„ã€‚</p>
<p>æˆ‘ä»¬å†ç¼–å†™ä¸€ä¸ª<code>ApiFilter</code>ï¼Œä¸“é—¨è¿‡æ»¤<code>/api/*</code>è¿™æ ·çš„URLã€‚é¦–å…ˆç¼–å†™ä¸€ä¸ª<code>ApiFilterRegistrationBean</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ApiFilterRegistrationBean <span style="color:#fff;font-weight:bold">extends</span> FilterRegistrationBean&lt;Filter&gt; {
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init() {
</span></span><span style="display:flex;"><span>        setOrder(20);
</span></span><span style="display:flex;"><span>        setFilter(<span style="color:#fff;font-weight:bold">new</span> ApiFilter());
</span></span><span style="display:flex;"><span>        setUrlPatterns(List.<span style="color:#007f7f">of</span>(<span style="color:#0ff;font-weight:bold">&#34;/api/*&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">class</span> ApiFilter <span style="color:#fff;font-weight:bold">implements</span> Filter {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ª<code>ApiFilterRegistrationBean</code>å’Œ<code>AuthFilterRegistrationBean</code>åˆæœ‰æ‰€ä¸åŒã€‚å› ä¸ºæˆ‘ä»¬è¦è¿‡æ»¤URLï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ‰€æœ‰URLç”Ÿæ•ˆï¼Œå› æ­¤ï¼Œåœ¨<code>@PostConstruct</code>æ–¹æ³•ä¸­ï¼Œé€šè¿‡<code>setFilter()</code>è®¾ç½®ä¸€ä¸ª<code>Filter</code>å®ä¾‹åï¼Œå†è°ƒç”¨<code>setUrlPatterns()</code>ä¼ å…¥è¦è¿‡æ»¤çš„URLåˆ—è¡¨ã€‚</p>
<p><strong>å°ç»“</strong></p>
<p>åœ¨Spring Bootä¸­æ·»åŠ <code>Filter</code>æ›´åŠ æ–¹ä¾¿ï¼Œå¹¶ä¸”æ”¯æŒå¯¹å¤šä¸ª<code>Filter</code>è¿›è¡Œæ’åºã€‚</p>
<h1 id="é›†æˆopen-api">é›†æˆOpen API<a hidden class="anchor" aria-hidden="true" href="#é›†æˆopen-api">#</a></h1>
<p><a href="https://www.openapis.org/">Open API</a>æ˜¯ä¸€ä¸ªæ ‡å‡†ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æè¿°REST APIï¼Œæ—¢å¯ä»¥ä½œä¸ºæ–‡æ¡£ç»™å¼€å‘è€…é˜…è¯»ï¼Œåˆå¯ä»¥è®©æœºå™¨æ ¹æ®è¿™ä¸ªæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆå®¢æˆ·ç«¯ä»£ç ç­‰ã€‚</p>
<p>åœ¨Spring Bootåº”ç”¨ä¸­ï¼Œå‡è®¾æˆ‘ä»¬ç¼–å†™äº†ä¸€å †REST APIï¼Œå¦‚ä½•æ·»åŠ Open APIçš„æ”¯æŒï¼Ÿ</p>
<p>æˆ‘ä»¬åªéœ€è¦åœ¨<code>pom.xml</code>ä¸­åŠ å…¥ä»¥ä¸‹ä¾èµ–ï¼š</p>
<ul>
<li>org.springdoc:springdoc-openapi-starter-webmvc-ui:2.0.0</li>
</ul>
<p>ç„¶åå‘¢ï¼Ÿæ²¡æœ‰ç„¶åäº†ï¼Œç›´æ¥å¯åŠ¨åº”ç”¨ï¼Œæ‰“å¼€æµè§ˆå™¨è¾“å…¥<code>http://localhost:8080/swagger-ui.html</code>ï¼š</p>
<p><img alt="swagger-ui" loading="lazy" src="https://liaoxuefeng.com/books/java/springboot/integration/open-api/open-api.png"></p>
<p>ç«‹åˆ»å¯ä»¥çœ‹åˆ°è‡ªåŠ¨ç”Ÿæˆçš„APIæ–‡æ¡£ï¼Œè¿™é‡Œåˆ—å‡ºäº†3ä¸ªAPIï¼Œæ¥è‡ª<code>api-controller</code>ï¼ˆå› ä¸ºå®šä¹‰åœ¨<code>ApiController</code>è¿™ä¸ªç±»ä¸­ï¼‰ï¼Œç‚¹å‡»æŸä¸ªAPIè¿˜å¯ä»¥äº¤äº’ï¼Œå³è¾“å…¥APIå‚æ•°ï¼Œç‚¹â€œTry it outâ€æŒ‰é’®ï¼Œè·å¾—è¿è¡Œç»“æœã€‚</p>
<h2 id="æ˜¯ä¸æ˜¯å¤ªæ–¹ä¾¿äº†">æ˜¯ä¸æ˜¯å¤ªæ–¹ä¾¿äº†ï¼<a hidden class="anchor" aria-hidden="true" href="#æ˜¯ä¸æ˜¯å¤ªæ–¹ä¾¿äº†">#</a></h2>
<p>å› ä¸ºæˆ‘ä»¬å¼•å…¥<code>springdoc-openapi-ui</code>è¿™ä¸ªä¾èµ–åï¼Œå®ƒè‡ªåŠ¨å¼•å…¥Swagger UIç”¨æ¥åˆ›å»ºAPIæ–‡æ¡£ã€‚å¯ä»¥ç»™APIåŠ å…¥ä¸€äº›æè¿°ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span>@RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/api&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ApiController {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    @Operation(summary = <span style="color:#0ff;font-weight:bold">&#34;Get specific user object by it&#39;s id.&#34;</span>)
</span></span><span style="display:flex;"><span>	@GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/users/{id}&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">public</span> User user(@Parameter(description = <span style="color:#0ff;font-weight:bold">&#34;id of the user.&#34;</span>) @PathVariable(<span style="color:#0ff;font-weight:bold">&#34;id&#34;</span>) <span style="color:#fff;font-weight:bold">long</span> id) {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> userService.<span style="color:#007f7f">getUserById</span>(id);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>@Operation</code>å¯ä»¥å¯¹APIè¿›è¡Œæè¿°ï¼Œ<code>@Parameter</code>å¯ä»¥å¯¹å‚æ•°è¿›è¡Œæè¿°ï¼Œå®ƒä»¬çš„ç›®çš„æ˜¯ç”¨äºç”ŸæˆAPIæ–‡æ¡£çš„æè¿°ä¿¡æ¯ã€‚æ·»åŠ äº†æè¿°çš„APIæ–‡æ¡£å¦‚ä¸‹ï¼š</p>
<p><img alt="api-description" loading="lazy" src="https://liaoxuefeng.com/books/java/springboot/integration/open-api/open-api-desc.png"></p>
<p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸éœ€è¦ä»»ä½•é…ç½®ï¼Œæˆ‘ä»¬å°±ç›´æ¥å¾—åˆ°äº†ä¸€ä¸ªè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„å¯äº¤äº’çš„APIæ–‡æ¡£ï¼Œè¯¥APIæ–‡æ¡£æ€»æ˜¯å’Œä»£ç ä¿æŒåŒæ­¥ï¼Œå¤§å¤§ç®€åŒ–äº†æ–‡æ¡£çš„ç¼–å†™å·¥ä½œã€‚</p>
<p>è¦è‡ªå®šä¹‰æ–‡æ¡£çš„æ ·å¼ã€æ§åˆ¶æŸäº›APIæ˜¾ç¤ºç­‰ï¼Œè¯·å‚è€ƒ<a href="https://springdoc.org/">springdocæ–‡æ¡£</a>ã€‚</p>
<h3 id="é…ç½®åå‘ä»£ç†">é…ç½®åå‘ä»£ç†<a hidden class="anchor" aria-hidden="true" href="#é…ç½®åå‘ä»£ç†">#</a></h3>
<p>å¦‚æœåœ¨æœåŠ¡å™¨ä¸Šï¼Œç”¨æˆ·è®¿é—®çš„åŸŸåæ˜¯<code>https://example.com</code>ï¼Œä½†å†…éƒ¨æ˜¯é€šè¿‡ç±»ä¼¼Nginxè¿™æ ·çš„åå‘ä»£ç†è®¿é—®å®é™…çš„Spring Bootåº”ç”¨ï¼Œæ¯”å¦‚<code>http://localhost:8080</code>ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œåœ¨é¡µé¢<code>https://example.com/swagger-ui.html</code>ä¸Šï¼Œæ˜¾ç¤ºçš„URLä»ç„¶æ˜¯<code>http://localhost:8080</code>ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±æ— æ³•ç›´æ¥åœ¨é¡µé¢æ‰§è¡ŒAPIï¼Œéå¸¸ä¸æ–¹ä¾¿ã€‚</p>
<p>è¿™æ˜¯å› ä¸ºSpring Bootå†…ç½®çš„Tomcaté»˜è®¤è·å–çš„æœåŠ¡å™¨åç§°æ˜¯<code>localhost</code>ï¼Œç«¯å£æ˜¯å®é™…ç›‘å¬ç«¯å£ï¼Œè€Œä¸æ˜¯å¯¹å¤–æš´éœ²çš„åŸŸåå’Œ<code>80</code>æˆ–<code>443</code>ç«¯å£ã€‚è¦è®©Tomcatè·å–åˆ°å¯¹å¤–æš´éœ²çš„åŸŸåç­‰ä¿¡æ¯ï¼Œå¿…é¡»åœ¨Nginxé…ç½®ä¸­ä¼ å…¥å¿…è¦çš„HTTP Headerï¼Œå¸¸ç”¨çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span># Nginxé…ç½®
</span></span><span style="display:flex;"><span>server {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    location / {
</span></span><span style="display:flex;"><span>        proxy_pass http://localhost:8080;
</span></span><span style="display:flex;"><span>        proxy_set_header Host $host;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Real-IP $remote_addr;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Forwarded-Proto $scheme;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åï¼Œåœ¨Spring Bootçš„<code>application.yml</code>ä¸­ï¼ŒåŠ å…¥å¦‚ä¸‹é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f"># å®é™…ç›‘å¬ç«¯å£:</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span>  <span style="color:#007f7f"># ä»åå‘ä»£ç†è¯»å–ç›¸å…³çš„HTTP Header:</span>
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">forward-headers-strategy</span>: native
</span></span></code></pre></td></tr></table>
</div>
</div><p>é‡å¯Spring Bootåº”ç”¨ï¼Œå³å¯åœ¨Swaggerä¸­æ˜¾ç¤ºæ­£ç¡®çš„URLã€‚</p>
<p><strong>å°ç»“</strong></p>
<p>ä½¿ç”¨springdocè®©å…¶è‡ªåŠ¨åˆ›å»ºAPIæ–‡æ¡£éå¸¸å®¹æ˜“ï¼Œå¼•å…¥ä¾èµ–åæ— éœ€ä»»ä½•é…ç½®å³å¯è®¿é—®äº¤äº’å¼APIæ–‡æ¡£ã€‚</p>
<p>å¯ä»¥å¯¹APIæ·»åŠ æ³¨è§£ä»¥ä¾¿ç”Ÿæˆæ›´è¯¦ç»†çš„æè¿°ã€‚</p>
<h1 id="è®¿é—®redis">è®¿é—®Redis<a hidden class="anchor" aria-hidden="true" href="#è®¿é—®redis">#</a></h1>
<p>åœ¨Spring Bootä¸­ï¼Œè¦è®¿é—®Redisï¼Œå¯ä»¥ç›´æ¥å¼•å…¥<code>spring-boot-starter-data-redis</code>ä¾èµ–ï¼Œå®ƒå®é™…ä¸Šæ˜¯Spring Dataçš„ä¸€ä¸ªå­é¡¹ç›®â€”â€”Spring Data Redisï¼Œä¸»è¦ç”¨åˆ°äº†è¿™å‡ ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li>Lettuceï¼šä¸€ä¸ªåŸºäºNettyçš„é«˜æ€§èƒ½Rediså®¢æˆ·ç«¯ï¼›</li>
<li>RedisTemplateï¼šä¸€ä¸ªç±»ä¼¼äºJdbcTemplateçš„æ¥å£ï¼Œç”¨äºç®€åŒ–Redisçš„æ“ä½œã€‚</li>
</ul>
<p>å› ä¸ºSpring Data Rediså¼•å…¥çš„ä¾èµ–é¡¹å¾ˆå¤šï¼Œå¦‚æœåªæ˜¯ä¸ºäº†ä½¿ç”¨Redisï¼Œå®Œå…¨å¯ä»¥åªå¼•å…¥Lettuceï¼Œå‰©ä¸‹çš„æ“ä½œéƒ½è‡ªå·±æ¥å®Œæˆã€‚</p>
<p>æœ¬èŠ‚æˆ‘ä»¬ç¨å¾®æ·±å…¥ä¸€ä¸‹Redisçš„å®¢æˆ·ç«¯ï¼Œçœ‹çœ‹æ€ä¹ˆä¸€æ­¥ä¸€æ­¥æŠŠä¸€ä¸ªç¬¬ä¸‰æ–¹ç»„ä»¶å¼•å…¥åˆ°Spring Bootä¸­ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ·»åŠ å¿…è¦çš„å‡ ä¸ªä¾èµ–é¡¹ï¼š</p>
<ul>
<li>io.lettuce:lettuce-core</li>
<li>org.apache.commons:commons-pool2</li>
</ul>
<p>æ³¨æ„æˆ‘ä»¬å¹¶æœªæŒ‡å®šç‰ˆæœ¬å·ï¼Œå› ä¸ºåœ¨<code>spring-boot-starter-parent</code>ä¸­å·²ç»æŠŠå¸¸ç”¨ç»„ä»¶çš„ç‰ˆæœ¬å·ç¡®å®šä¸‹æ¥äº†ã€‚</p>
<p>ç¬¬ä¸€æ­¥æ˜¯åœ¨é…ç½®æ–‡ä»¶<code>application.yml</code>ä¸­æ·»åŠ Redisçš„ç›¸å…³é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">redis</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: ${REDIS_HOST:localhost}
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: ${REDIS_PORT:6379}
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: ${REDIS_PASSWORD:}
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">ssl</span>: ${REDIS_SSL:false}
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">database</span>: ${REDIS_DATABASE:0}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åï¼Œé€šè¿‡<code>RedisConfiguration</code>æ¥åŠ è½½å®ƒï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@ConfigurationProperties(<span style="color:#0ff;font-weight:bold">&#34;spring.redis&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> RedisConfiguration {
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">private</span> String host;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> port;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">private</span> String password;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> database;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// getters and setters...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†ç¼–å†™ä¸€ä¸ª<code>@Bean</code>æ–¹æ³•æ¥åˆ›å»º<code>RedisClient</code>ï¼Œå¯ä»¥ç›´æ¥æ”¾åœ¨<code>RedisConfiguration</code>ä¸­ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@ConfigurationProperties(<span style="color:#0ff;font-weight:bold">&#34;spring.redis&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> RedisConfiguration {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    RedisClient redisClient() {
</span></span><span style="display:flex;"><span>        RedisURI uri = RedisURI.<span style="color:#007f7f">Builder</span>.<span style="color:#007f7f">redis</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">host</span>, <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">port</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">withPassword</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">password</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">withDatabase</span>(<span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">database</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> RedisClient.<span style="color:#007f7f">create</span>(uri);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨å¯åŠ¨å…¥å£å¼•å…¥è¯¥é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@SpringBootApplication
</span></span><span style="display:flex;"><span>@Import(RedisConfiguration.<span style="color:#007f7f">class</span>) <span style="color:#007f7f">// åŠ è½½Redisé…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Application {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„ï¼šå¦‚æœåœ¨<code>RedisConfiguration</code>ä¸­æ ‡æ³¨<code>@Configuration</code>ï¼Œåˆ™å¯é€šè¿‡Spring Bootçš„è‡ªåŠ¨æ‰«ææœºåˆ¶è‡ªåŠ¨åŠ è½½ï¼Œå¦åˆ™ï¼Œä½¿ç”¨<code>@Import</code>æ‰‹åŠ¨åŠ è½½ã€‚</p>
<p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ª<code>RedisService</code>æ¥å°è£…æ‰€æœ‰çš„Redisæ“ä½œã€‚åŸºç¡€ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> RedisService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    RedisClient redisClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    GenericObjectPool&lt;StatefulRedisConnection&lt;String, String&gt;&gt; redisConnectionPool;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init() {
</span></span><span style="display:flex;"><span>        GenericObjectPoolConfig&lt;StatefulRedisConnection&lt;String, String&gt;&gt; poolConfig = <span style="color:#fff;font-weight:bold">new</span> GenericObjectPoolConfig&lt;&gt;();
</span></span><span style="display:flex;"><span>        poolConfig.<span style="color:#007f7f">setMaxTotal</span>(20);
</span></span><span style="display:flex;"><span>        poolConfig.<span style="color:#007f7f">setMaxIdle</span>(5);
</span></span><span style="display:flex;"><span>        poolConfig.<span style="color:#007f7f">setTestOnReturn</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        poolConfig.<span style="color:#007f7f">setTestWhileIdle</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">redisConnectionPool</span> = ConnectionPoolSupport.<span style="color:#007f7f">createGenericObjectPool</span>(() -&gt; redisClient.<span style="color:#007f7f">connect</span>(), poolConfig);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PreDestroy
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> shutdown() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">redisConnectionPool</span>.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">redisClient</span>.<span style="color:#007f7f">shutdown</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°ä¸Šè¿°ä»£ç å¼•å…¥äº†Commons Poolçš„ä¸€ä¸ªå¯¹è±¡æ± ï¼Œç”¨äºç¼“å­˜Redisè¿æ¥ã€‚å› ä¸ºLettuceæœ¬èº«æ˜¯åŸºäºNettyçš„å¼‚æ­¥é©±åŠ¨ï¼Œåœ¨å¼‚æ­¥è®¿é—®æ—¶å¹¶ä¸éœ€è¦åˆ›å»ºè¿æ¥æ± ï¼Œä½†åŸºäºServletæ¨¡å‹çš„åŒæ­¥è®¿é—®æ—¶ï¼Œè¿æ¥æ± æ˜¯æœ‰å¿…è¦çš„ã€‚è¿æ¥æ± åœ¨<code>@PostConstruct</code>æ–¹æ³•ä¸­åˆå§‹åŒ–ï¼Œåœ¨<code>@PreDestroy</code>æ–¹æ³•ä¸­å…³é—­ã€‚</p>
<p>ä¸‹ä¸€æ­¥ï¼Œæ˜¯åœ¨<code>RedisService</code>ä¸­æ·»åŠ Redisè®¿é—®æ–¹æ³•ã€‚ä¸ºäº†ç®€åŒ–ä»£ç ï¼Œæˆ‘ä»¬ä»¿ç…§<code>JdbcTemplate.execute(ConnectionCallback)</code>æ–¹æ³•ï¼Œä¼ å…¥å›è°ƒå‡½æ•°ï¼Œå¯å¤§å¹…å‡å°‘æ ·æ¿ä»£ç ã€‚</p>
<p>é¦–å…ˆå®šä¹‰å›è°ƒå‡½æ•°æ¥å£<code>SyncCommandCallback</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@FunctionalInterface
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> SyncCommandCallback&lt;T&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åœ¨æ­¤æ“ä½œRedis:</span>
</span></span><span style="display:flex;"><span>    T doInConnection(RedisCommands&lt;String, String&gt; commands);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¼–å†™<code>executeSync</code>æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œè·å–Redisè¿æ¥ï¼Œåˆ©ç”¨callbackæ“ä½œRedisï¼Œæœ€åé‡Šæ”¾è¿æ¥ï¼Œå¹¶è¿”å›æ“ä½œç»“æœï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T executeSync(SyncCommandCallback&lt;T&gt; callback) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> (StatefulRedisConnection&lt;String, String&gt; connection = redisConnectionPool.<span style="color:#007f7f">borrowObject</span>()) {
</span></span><span style="display:flex;"><span>        connection.<span style="color:#007f7f">setAutoFlushCommands</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        RedisCommands&lt;String, String&gt; commands = connection.<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> callback.<span style="color:#007f7f">doInConnection</span>(commands);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">warn</span>(<span style="color:#0ff;font-weight:bold">&#34;executeSync redis failed.&#34;</span>, e);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ‰çš„ç«¥é‹è§‰å¾—è¿™æ ·è®¿é—®Redisçš„ä»£ç å¤ªå¤æ‚äº†ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥é’ˆå¯¹å¸¸ç”¨æ“ä½œæŠŠå®ƒå°è£…ä¸€ä¸‹ï¼Œä¾‹å¦‚<code>set</code>å’Œ<code>get</code>å‘½ä»¤ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> String set(String key, String value) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> executeSync(commands -&gt; commands.<span style="color:#007f7f">set</span>(key, value));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> String get(String key) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> executeSync(commands -&gt; commands.<span style="color:#007f7f">get</span>(key));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç±»ä¼¼çš„ï¼Œ<code>hget</code>å’Œ<code>hset</code>æ“ä½œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> hset(String key, String field, String value) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> executeSync(commands -&gt; commands.<span style="color:#007f7f">hset</span>(key, field, value));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> String hget(String key, String field) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> executeSync(commands -&gt; commands.<span style="color:#007f7f">hget</span>(key, field));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Map&lt;String, String&gt; hgetall(String key) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> executeSync(commands -&gt; commands.<span style="color:#007f7f">hgetall</span>(key));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¸¸ç”¨å‘½ä»¤å¯ä»¥æä¾›æ–¹æ³•æ¥å£ï¼Œå¦‚æœè¦æ‰§è¡Œä»»æ„å¤æ‚çš„æ“ä½œï¼Œå°±å¯ä»¥é€šè¿‡<code>executeSync(SyncCommandCallback&lt;T&gt;)</code>æ¥å®Œæˆã€‚</p>
<p>å®Œæˆäº†<code>RedisService</code>åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Redisäº†ã€‚ä¾‹å¦‚ï¼Œåœ¨<code>UserController</code>ä¸­ï¼Œæˆ‘ä»¬åœ¨Sessionä¸­åªå­˜æ”¾ç™»å½•ç”¨æˆ·çš„IDï¼Œç”¨æˆ·ä¿¡æ¯å­˜æ”¾åˆ°Redisï¼Œæä¾›ä¸¤ä¸ªæ–¹æ³•ç”¨äºè¯»å†™ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserController {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String KEY_USER_ID = <span style="color:#0ff;font-weight:bold">&#34;__userid__&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String KEY_USERS = <span style="color:#0ff;font-weight:bold">&#34;__users__&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired ObjectMapper objectMapper;
</span></span><span style="display:flex;"><span>    @Autowired RedisService redisService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æŠŠUserå†™å…¥Redis:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">void</span> putUserIntoRedis(User user) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        redisService.<span style="color:#007f7f">hset</span>(KEY_USERS, user.<span style="color:#007f7f">getId</span>().<span style="color:#007f7f">toString</span>(), objectMapper.<span style="color:#007f7f">writeValueAsString</span>(user));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ä»Redisè¯»å–User:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> User getUserFromRedis(HttpSession session) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        Long id = (Long) session.<span style="color:#007f7f">getAttribute</span>(KEY_USER_ID);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (id != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            String s = redisService.<span style="color:#007f7f">hget</span>(KEY_USERS, id.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (s != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> objectMapper.<span style="color:#007f7f">readValue</span>(s, User.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”¨æˆ·ç™»å½•æˆåŠŸåï¼ŒæŠŠIDæ”¾å…¥Sessionï¼ŒæŠŠ<code>User</code>å®ä¾‹æ”¾å…¥Redisï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@PostMapping(<span style="color:#0ff;font-weight:bold">&#34;/signin&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ModelAndView doSignin(@RequestParam(<span style="color:#0ff;font-weight:bold">&#34;email&#34;</span>) String email, @RequestParam(<span style="color:#0ff;font-weight:bold">&#34;password&#34;</span>) String password, HttpSession session) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        User user = userService.<span style="color:#007f7f">signin</span>(email, password);
</span></span><span style="display:flex;"><span>        session.<span style="color:#007f7f">setAttribute</span>(KEY_USER_ID, user.<span style="color:#007f7f">getId</span>());
</span></span><span style="display:flex;"><span>        putUserIntoRedis(user);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (RuntimeException e) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ModelAndView(<span style="color:#0ff;font-weight:bold">&#34;signin.html&#34;</span>, Map.<span style="color:#007f7f">of</span>(<span style="color:#0ff;font-weight:bold">&#34;email&#34;</span>, email, <span style="color:#0ff;font-weight:bold">&#34;error&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;Signin failed&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ModelAndView(<span style="color:#0ff;font-weight:bold">&#34;redirect:/profile&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>éœ€è¦è·å–<code>User</code>æ—¶ï¼Œä»Rediså–å‡ºï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@GetMapping(<span style="color:#0ff;font-weight:bold">&#34;/profile&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> ModelAndView profile(HttpSession session) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>    User user = getUserFromRedis(session);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (user == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ModelAndView(<span style="color:#0ff;font-weight:bold">&#34;redirect:/signin&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ModelAndView(<span style="color:#0ff;font-weight:bold">&#34;profile.html&#34;</span>, Map.<span style="color:#007f7f">of</span>(<span style="color:#0ff;font-weight:bold">&#34;user&#34;</span>, user));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»Redisè¯»å†™Javaå¯¹è±¡æ—¶ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ˜¯åº”ç”¨ç¨‹åºçš„å·¥ä½œï¼Œä¸Šè¿°ä»£ç ä½¿ç”¨JSONä½œä¸ºåºåˆ—åŒ–æ–¹æ¡ˆï¼Œç®€å•å¯é ã€‚ä¹Ÿå¯å°†ç›¸å…³åºåˆ—åŒ–æ“ä½œå°è£…åˆ°<code>RedisService</code>ä¸­ï¼Œè¿™æ ·å¯ä»¥æä¾›æ›´åŠ é€šç”¨çš„æ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T get(String key, Class&lt;T&gt; clazz) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> &lt;T&gt; T set(String key, T value) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å°ç»“</strong></p>
<p>Spring Booté»˜è®¤ä½¿ç”¨Lettuceä½œä¸ºRediså®¢æˆ·ç«¯ï¼ŒåŒæ­¥ä½¿ç”¨æ—¶ï¼Œåº”é€šè¿‡è¿æ¥æ± æé«˜æ•ˆç‡ã€‚</p>
<h1 id="é›†æˆartemis">é›†æˆArtemis<a hidden class="anchor" aria-hidden="true" href="#é›†æˆartemis">#</a></h1>
<p>ActiveMQ Artemisæ˜¯ä¸€ä¸ªJMSæœåŠ¡å™¨ï¼Œåœ¨<a href="https://liaoxuefeng.com/books/java/spring/integration/jms/index.html">é›†æˆJMS</a>ä¸€èŠ‚ä¸­æˆ‘ä»¬å·²ç»è¯¦ç»†è®¨è®ºäº†å¦‚ä½•åœ¨Springä¸­é›†æˆArtemisï¼Œæœ¬èŠ‚æˆ‘ä»¬è®¨è®ºå¦‚ä½•åœ¨Spring Bootä¸­é›†æˆArtemisã€‚</p>
<p>æˆ‘ä»¬è¿˜æ˜¯ä»¥å®é™…å·¥ç¨‹ä¸ºä¾‹ï¼Œåˆ›å»ºä¸€ä¸ª<code>springboot-jms</code>å·¥ç¨‹ï¼Œå¼•å…¥çš„ä¾èµ–é™¤äº†<code>spring-boot-starter-web</code>ï¼Œ<code>spring-boot-starter-jdbc</code>ç­‰ä»¥å¤–ï¼Œæ–°å¢<code>spring-boot-starter-artemis</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-artemis<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŒæ ·æ— éœ€æŒ‡å®šç‰ˆæœ¬å·ã€‚</p>
<p>å¦‚ä½•åˆ›å»ºArtemisæœåŠ¡å™¨æˆ‘ä»¬å·²ç»åœ¨é›†æˆJMSä¸€èŠ‚ä¸­è¯¦ç»†è®²è¿°äº†ï¼Œæ­¤å¤„ä¸å†é‡å¤ã€‚åˆ›å»ºArtemisæœåŠ¡å™¨åï¼Œæˆ‘ä»¬åœ¨<code>application.yml</code>ä¸­åŠ å…¥ç›¸å…³é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">artemis</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æŒ‡å®šè¿æ¥å¤–éƒ¨ArtemisæœåŠ¡å™¨ï¼Œè€Œä¸æ˜¯å¯åŠ¨åµŒå…¥å¼æœåŠ¡:</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">mode</span>: native
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># æœåŠ¡å™¨åœ°å€å’Œç«¯å£å·:</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: <span style="color:#ff0;font-weight:bold">127.0.0.1</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">61616</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># è¿æ¥ç”¨æˆ·åå’Œå£ä»¤ç”±åˆ›å»ºArtemisæœåŠ¡å™¨æ—¶æŒ‡å®š:</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">user</span>: admin
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: password
</span></span></code></pre></td></tr></table>
</div>
</div><p>å’ŒSpringç‰ˆæœ¬çš„JMSä»£ç ç›¸æ¯”ï¼Œä½¿ç”¨Spring Booté›†æˆJMSæ—¶ï¼Œåªè¦å¼•å…¥äº†<code>spring-boot-starter-artemis</code>ï¼ŒSpring Bootä¼šè‡ªåŠ¨åˆ›å»ºJMSç›¸å…³çš„<code>ConnectionFactory</code>ã€<code>JmsListenerContainerFactory</code>ã€<code>JmsTemplate</code>ç­‰ï¼Œæ— éœ€æˆ‘ä»¬å†æ‰‹åŠ¨é…ç½®äº†ã€‚</p>
<p>å‘é€æ¶ˆæ¯æ—¶åªéœ€è¦å¼•å…¥<code>JmsTemplate</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MessagingService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    JmsTemplate jmsTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendMailMessage() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        String text = <span style="color:#0ff;font-weight:bold">&#34;...&#34;</span>;
</span></span><span style="display:flex;"><span>        jmsTemplate.<span style="color:#007f7f">send</span>(<span style="color:#0ff;font-weight:bold">&#34;jms/queue/mail&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> MessageCreator() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> Message createMessage(Session session) <span style="color:#fff;font-weight:bold">throws</span> JMSException {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> session.<span style="color:#007f7f">createTextMessage</span>(text);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥æ”¶æ¶ˆæ¯æ—¶åªéœ€è¦æ ‡æ³¨<code>@JmsListener</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MailMessageListener {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Logger logger = LoggerFactory.<span style="color:#007f7f">getLogger</span>(getClass());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @JmsListener(destination = <span style="color:#0ff;font-weight:bold">&#34;jms/queue/mail&#34;</span>, concurrency = <span style="color:#0ff;font-weight:bold">&#34;10&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onMailMessageReceived(Message message) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;received message: &#34;</span> + message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯è§ï¼Œåº”ç”¨ç¨‹åºæ”¶å‘æ¶ˆæ¯çš„é€»è¾‘å’ŒSpringä¸­ä½¿ç”¨JMSå®Œå…¨ç›¸åŒï¼Œåªæ˜¯é€šè¿‡Spring Bootï¼Œæˆ‘ä»¬æŠŠå·¥ç¨‹ç®€åŒ–åˆ°åªéœ€è¦è®¾å®šArtemisç›¸å…³é…ç½®ã€‚</p>
<p><strong>å°ç»“</strong></p>
<p>åœ¨Spring Bootä¸­ä½¿ç”¨Artemisä½œä¸ºJMSæœåŠ¡æ—¶ï¼Œåªéœ€å¼•å…¥<code>spring-boot-starter-artemis</code>ä¾èµ–ï¼Œå³å¯ç›´æ¥ä½¿ç”¨JMSã€‚</p>
<h1 id="é›†æˆrabbitmq">é›†æˆRabbitMQ<a hidden class="anchor" aria-hidden="true" href="#é›†æˆrabbitmq">#</a></h1>
<p>å‰é¢æˆ‘ä»¬è®²äº†ActiveMQ Artemisï¼Œå®ƒå®ç°äº†JMSçš„æ¶ˆæ¯æœåŠ¡åè®®ã€‚JMSæ˜¯JavaEEçš„æ¶ˆæ¯æœåŠ¡æ ‡å‡†æ¥å£ï¼Œä½†æ˜¯ï¼Œå¦‚æœJavaç¨‹åºè¦å’Œå¦ä¸€ç§è¯­è¨€ç¼–å†™çš„ç¨‹åºé€šè¿‡æ¶ˆæ¯æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œé‚£ä¹ˆJMSå°±ä¸å¤ªé€‚åˆäº†ã€‚</p>
<p>AMQPæ˜¯ä¸€ç§ä½¿ç”¨å¹¿æ³›çš„ç‹¬ç«‹äºè¯­è¨€çš„æ¶ˆæ¯åè®®ï¼Œå®ƒçš„å…¨ç§°æ˜¯Advanced Message Queuing Protocolï¼Œå³é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§äºŒè¿›åˆ¶æ ¼å¼çš„æ¶ˆæ¯æµï¼Œä»»ä½•ç¼–ç¨‹è¯­è¨€éƒ½å¯ä»¥å®ç°è¯¥åè®®ã€‚å®é™…ä¸Šï¼ŒArtemisä¹Ÿæ”¯æŒAMQPï¼Œä½†å®é™…åº”ç”¨æœ€å¹¿æ³›çš„AMQPæœåŠ¡å™¨æ˜¯ä½¿ç”¨<a href="https://www.erlang.org/">Erlang</a>ç¼–å†™çš„<a href="https://www.rabbitmq.com/">RabbitMQ</a>ã€‚</p>
<h3 id="å®‰è£…rabbitmq">å®‰è£…RabbitMQ<a hidden class="anchor" aria-hidden="true" href="#å®‰è£…rabbitmq">#</a></h3>
<p>æˆ‘ä»¬å…ˆä»RabbitMQçš„å®˜ç½‘<a href="https://www.rabbitmq.com/download.html">ä¸‹è½½</a>å¹¶å®‰è£…RabbitMQï¼Œå®‰è£…å’Œå¯åŠ¨RabbitMQè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚è¦éªŒè¯å¯åŠ¨æ˜¯å¦æˆåŠŸï¼Œå¯ä»¥è®¿é—®RabbitMQçš„ç®¡ç†åå°<a href="http://localhost:15672/">http://localhost:15672</a>ï¼Œå¦‚èƒ½çœ‹åˆ°ç™»å½•ç•Œé¢è¡¨ç¤ºRabbitMQå¯åŠ¨æˆåŠŸï¼š</p>
<p><img alt="rabbitmq-manage" loading="lazy" src="https://liaoxuefeng.com/books/java/springboot/integration/rabbitmq/rabbitmq.jpg"></p>
<p>RabbitMQåå°ç®¡ç†çš„é»˜è®¤ç”¨æˆ·åå’Œå£ä»¤å‡ä¸º<code>guest</code>ã€‚</p>
<h3 id="amqpåè®®">AMQPåè®®<a hidden class="anchor" aria-hidden="true" href="#amqpåè®®">#</a></h3>
<p>AMQPåè®®å’Œå‰é¢æˆ‘ä»¬ä»‹ç»çš„JMSåè®®æœ‰æ‰€ä¸åŒã€‚åœ¨JMSä¸­ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„æ¶ˆæ¯é€šé“ï¼š</p>
<ol>
<li>ç‚¹å¯¹ç‚¹çš„Queueï¼Œå³Producerå‘é€æ¶ˆæ¯åˆ°æŒ‡å®šçš„Queueï¼Œæ¥æ”¶æ–¹ä»Queueæ”¶å–æ¶ˆæ¯ï¼›</li>
<li>ä¸€å¯¹å¤šçš„Topicï¼Œå³Producerå‘é€æ¶ˆæ¯åˆ°æŒ‡å®šçš„Topicï¼Œä»»æ„å¤šä¸ªåœ¨çº¿çš„æ¥æ”¶æ–¹å‡å¯ä»Topicè·å¾—ä¸€ä»½å®Œæ•´çš„æ¶ˆæ¯å‰¯æœ¬ã€‚</li>
</ol>
<p>ä½†æ˜¯AMQPåè®®æ¯”JMSè¦å¤æ‚ä¸€ç‚¹ï¼Œå®ƒåªæœ‰Queueï¼Œæ²¡æœ‰Topicï¼Œå¹¶ä¸”å¼•å…¥äº†Exchangeçš„æ¦‚å¿µã€‚å½“Produceræƒ³è¦å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå®ƒå°†æ¶ˆæ¯å‘é€ç»™Exchangeï¼Œç”±Exchangeå°†æ¶ˆæ¯æ ¹æ®å„ç§è§„åˆ™æŠ•é€’åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªQueueï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>                                â”Œâ”€â”€â–¶â”‚Queue-1â”‚
</span></span><span style="display:flex;"><span>                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span style="display:flex;"><span>              â”Œâ”€â”€â–¶â”‚Exchange-1â”‚â”€â”€â”¤
</span></span><span style="display:flex;"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>â”‚Producer-1â”‚â”€â”€â”¤                 â”œâ”€â”€â–¶â”‚Queue-2â”‚
</span></span><span style="display:flex;"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span style="display:flex;"><span>              â””â”€â”€â–¶â”‚Exchange-2â”‚â”€â”€â”¤
</span></span><span style="display:flex;"><span>                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>                                â””â”€â”€â–¶â”‚Queue-3â”‚
</span></span><span style="display:flex;"><span>                                    â””â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæŸä¸ªExchangeæ€»æ˜¯æŠŠæ¶ˆæ¯å‘é€åˆ°å›ºå®šçš„Queueï¼Œé‚£ä¹ˆè¿™ä¸ªæ¶ˆæ¯é€šé“å°±ç›¸å½“äºJMSçš„Queueã€‚å¦‚æœæŸä¸ªExchangeæŠŠæ¶ˆæ¯å‘é€åˆ°å¤šä¸ªQueueï¼Œé‚£ä¹ˆè¿™ä¸ªæ¶ˆæ¯é€šé“å°±ç›¸å½“äºJMSçš„Topicã€‚å’ŒJMSçš„Topicç›¸æ¯”ï¼ŒExchangeçš„æŠ•é€’è§„åˆ™æ›´çµæ´»ï¼Œæ¯”å¦‚ä¸€ä¸ªâ€œç™»å½•æˆåŠŸâ€çš„æ¶ˆæ¯è¢«æŠ•é€’åˆ°Queue-1å’ŒQueue-2ï¼Œè€Œâ€œç™»å½•å¤±è´¥â€çš„æ¶ˆæ¯åˆ™è¢«æŠ•é€’åˆ°Queue-3ã€‚è¿™äº›è·¯ç”±è§„åˆ™ç§°ä¹‹ä¸ºBindingï¼Œé€šå¸¸éƒ½åœ¨RabbitMQçš„ç®¡ç†åå°è®¾ç½®ã€‚</p>
<p>æˆ‘ä»¬ä»¥å…·ä½“çš„ä¸šåŠ¡ä¸ºä¾‹å­ï¼Œåœ¨RabbitMQä¸­ï¼Œé¦–å…ˆåˆ›å»º3ä¸ªQueueï¼Œåˆ†åˆ«ç”¨äºå‘é€é‚®ä»¶ã€çŸ­ä¿¡å’ŒAppé€šçŸ¥ï¼š</p>
<p><img alt="queues" loading="lazy" src="https://liaoxuefeng.com/books/java/springboot/integration/rabbitmq/queue.jpg"></p>
<p>åˆ›å»ºQueueæ—¶æ³¨æ„åˆ°å¯é…ç½®ä¸ºæŒä¹…åŒ–ï¼ˆDurableï¼‰å’ŒéæŒä¹…åŒ–ï¼ˆTransientï¼‰ï¼Œå½“Consumerä¸åœ¨çº¿æ—¶ï¼ŒæŒä¹…åŒ–çš„Queueä¼šæš‚å­˜æ¶ˆæ¯ï¼ŒéæŒä¹…åŒ–çš„Queueä¼šä¸¢å¼ƒæ¶ˆæ¯ã€‚</p>
<p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬åœ¨Exchangesä¸­åˆ›å»ºä¸€ä¸ªDirectç±»å‹çš„Exchangeï¼Œå‘½åä¸º<code>registration</code>ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹ä¸¤ä¸ªBindingï¼š</p>
<p><img alt="exchange-registration" loading="lazy" src="https://liaoxuefeng.com/books/java/springboot/integration/rabbitmq/exchange.png"></p>
<p>ä¸Šè¿°Bindingçš„è§„åˆ™å°±æ˜¯ï¼šå‡¡æ˜¯å‘é€åˆ°<code>registration</code>è¿™ä¸ªExchangeçš„æ¶ˆæ¯ï¼Œå‡è¢«å‘é€åˆ°<code>q_mail</code>å’Œ<code>q_sms</code>è¿™ä¸¤ä¸ªQueueã€‚</p>
<p>æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ªDirectç±»å‹çš„Exchangeï¼Œå‘½åä¸º<code>login</code>ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹Bindingï¼š</p>
<p><img alt="exchange-login" loading="lazy" src="https://liaoxuefeng.com/books/java/springboot/integration/rabbitmq/exchange2.png"></p>
<p>ä¸Šè¿°Bindingçš„è§„åˆ™ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œå½“å‘é€æ¶ˆæ¯ç»™<code>login</code>è¿™ä¸ªExchangeæ—¶ï¼Œå¦‚æœæ¶ˆæ¯æ²¡æœ‰æŒ‡å®šRouting Keyï¼Œåˆ™è¢«æŠ•é€’åˆ°<code>q_app</code>å’Œ<code>q_mail</code>ï¼Œå¦‚æœæ¶ˆæ¯æŒ‡å®šäº†Routing Key=&ldquo;login_failed&rdquo;ï¼Œé‚£ä¹ˆæ¶ˆæ¯è¢«æŠ•é€’åˆ°<code>q_sms</code>ã€‚</p>
<p>é…ç½®å¥½RabbitMQåï¼Œæˆ‘ä»¬å°±å¯ä»¥åŸºäºSpring Bootå¼€å‘AMQPç¨‹åºã€‚</p>
<h3 id="ä½¿ç”¨rabbitmq">ä½¿ç”¨RabbitMQ<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨rabbitmq">#</a></h3>
<p>æˆ‘ä»¬é¦–å…ˆåˆ›å»ºSpring Bootå·¥ç¨‹<code>springboot-rabbitmq</code>ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹ä¾èµ–å¼•å…¥RabbitMQï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶ååœ¨<code>application.yml</code>ä¸­æ·»åŠ RabbitMQç›¸å…³é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">host</span>: localhost
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">port</span>: <span style="color:#ff0;font-weight:bold">5672</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">username</span>: guest
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">password</span>: guest
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬è¿˜éœ€è¦åœ¨<code>Application</code>ä¸­æ·»åŠ ä¸€ä¸ª<code>MessageConverter</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.springframework.amqp.support.converter.MessageConverter;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@SpringBootApplication
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Application {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    MessageConverter createMessageConverter() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> Jackson2JsonMessageConverter();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>MessageConverter</code>ç”¨äºå°†Javaå¯¹è±¡è½¬æ¢ä¸ºRabbitMQçš„æ¶ˆæ¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring Bootä½¿ç”¨<code>SimpleMessageConverter</code>ï¼Œåªèƒ½å‘é€<code>String</code>å’Œ<code>byte[]</code>ç±»å‹çš„æ¶ˆæ¯ï¼Œä¸å¤ªæ–¹ä¾¿ã€‚ä½¿ç”¨<code>Jackson2JsonMessageConverter</code>ï¼Œæˆ‘ä»¬å°±å¯ä»¥å‘é€JavaBeanå¯¹è±¡ï¼Œç”±Spring Bootè‡ªåŠ¨åºåˆ—åŒ–ä¸ºJSONå¹¶ä»¥æ–‡æœ¬æ¶ˆæ¯ä¼ é€’ã€‚</p>
<p>å› ä¸ºå¼•å…¥äº†starterï¼Œæ‰€æœ‰RabbitMQç›¸å…³çš„Beanå‡è‡ªåŠ¨è£…é…ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Produceræ³¨å…¥çš„æ˜¯<code>RabbitTemplate</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MessagingService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    RabbitTemplate rabbitTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendRegistrationMessage(RegistrationMessage msg) {
</span></span><span style="display:flex;"><span>        rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;registration&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendLoginMessage(LoginMessage msg) {
</span></span><span style="display:flex;"><span>        String routingKey = msg.<span style="color:#007f7f">success</span> ? <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> : <span style="color:#0ff;font-weight:bold">&#34;login_failed&#34;</span>;
</span></span><span style="display:flex;"><span>        rabbitTemplate.<span style="color:#007f7f">convertAndSend</span>(<span style="color:#0ff;font-weight:bold">&#34;login&#34;</span>, routingKey, msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‘é€æ¶ˆæ¯æ—¶ï¼Œä½¿ç”¨<code>convertAndSend(exchange, routingKey, message)</code>å¯ä»¥æŒ‡å®šExchangeã€Routing Keyä»¥åŠæ¶ˆæ¯æœ¬èº«ã€‚è¿™é‡Œä¼ å…¥JavaBeanåä¼šè‡ªåŠ¨åºåˆ—åŒ–ä¸ºJSONæ–‡æœ¬ã€‚ä¸Šè¿°ä»£ç å°†<code>RegistrationMessage</code>å‘é€åˆ°<code>registration</code>ï¼Œå°†<code>LoginMessage</code>å‘é€åˆ°<code>login</code>ï¼Œå¹¶æ ¹æ®ç™»å½•æ˜¯å¦æˆåŠŸæ¥æŒ‡å®šRouting Keyã€‚</p>
<p>æ¥æ”¶æ¶ˆæ¯æ—¶ï¼Œéœ€è¦åœ¨æ¶ˆæ¯å¤„ç†çš„æ–¹æ³•ä¸Šæ ‡æ³¨<code>@RabbitListener</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> QueueMessageListener {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> Logger logger = LoggerFactory.<span style="color:#007f7f">getLogger</span>(getClass());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String QUEUE_MAIL = <span style="color:#0ff;font-weight:bold">&#34;q_mail&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String QUEUE_SMS = <span style="color:#0ff;font-weight:bold">&#34;q_sms&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String QUEUE_APP = <span style="color:#0ff;font-weight:bold">&#34;q_app&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = QUEUE_MAIL)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onRegistrationMessageFromMailQueue(RegistrationMessage message) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;queue {} received registration message: {}&#34;</span>, QUEUE_MAIL, message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = QUEUE_SMS)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onRegistrationMessageFromSmsQueue(RegistrationMessage message) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;queue {} received registration message: {}&#34;</span>, QUEUE_SMS, message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = QUEUE_MAIL)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onLoginMessageFromMailQueue(LoginMessage message) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;queue {} received message: {}&#34;</span>, QUEUE_MAIL, message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = QUEUE_SMS)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onLoginMessageFromSmsQueue(LoginMessage message) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;queue {} received message: {}&#34;</span>, QUEUE_SMS, message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RabbitListener(queues = QUEUE_APP)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onLoginMessageFromAppQueue(LoginMessage message) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;queue {} received message: {}&#34;</span>, QUEUE_APP, message);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç ä¸€å…±å®šä¹‰äº†5ä¸ªConsumerï¼Œç›‘å¬3ä¸ªQueueã€‚</p>
<p>å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬æ³¨å†Œä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œç„¶åå‘é€ä¸€æ¡<code>RegistrationMessage</code>æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œæ ¹æ®<code>registration</code>è¿™ä¸ªExchangeçš„è®¾å®šï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸¤ä¸ªQueueæ”¶åˆ°æ¶ˆæ¯ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>... c.i.learnjava.service.UserService        : try register by bob@example.com...
</span></span><span style="display:flex;"><span>... c.i.learnjava.web.UserController         : user registered: bob@example.com
</span></span><span style="display:flex;"><span>... c.i.l.service.QueueMessageListener       : queue q_mail received registration message: [RegistrationMessage: email=bob@example.com, name=Bob, timestamp=1594559871495]
</span></span><span style="display:flex;"><span>... c.i.l.service.QueueMessageListener       : queue q_sms received registration message: [RegistrationMessage: email=bob@example.com, name=Bob, timestamp=1594559871495]
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“æˆ‘ä»¬ç™»å½•å¤±è´¥æ—¶ï¼Œå‘é€<code>LoginMessage</code>å¹¶è®¾å®šRouting Keyä¸º<code>login_failed</code>ï¼Œæ­¤æ—¶ï¼Œåªæœ‰<code>q_sms</code>ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>... c.i.learnjava.service.UserService        : try login by bob@example.com...
</span></span><span style="display:flex;"><span>... c.i.l.service.QueueMessageListener       : queue q_sms received message: [LoginMessage: email=bob@example.com, name=(unknown), success=false, timestamp=1594559886722]
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç™»å½•æˆåŠŸåï¼Œå‘é€<code>LoginMessage</code>ï¼Œæ­¤æ—¶ï¼Œ<code>q_mail</code>å’Œ<code>q_app</code>å°†æ”¶åˆ°æ¶ˆæ¯ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>... c.i.learnjava.service.UserService        : try login by bob@example.com...
</span></span><span style="display:flex;"><span>... c.i.l.service.QueueMessageListener       : queue q_mail received message: [LoginMessage: email=bob@example.com, name=Bob, success=true, timestamp=1594559895251]
</span></span><span style="display:flex;"><span>... c.i.l.service.QueueMessageListener       : queue q_app received message: [LoginMessage: email=bob@example.com, name=Bob, success=true, timestamp=1594559895251]
</span></span></code></pre></td></tr></table>
</div>
</div><p>RabbitMQè¿˜æä¾›äº†ä½¿ç”¨Topicçš„Exchangeï¼ˆæ­¤TopicæŒ‡æ¶ˆæ¯çš„æ ‡ç­¾ï¼Œå¹¶éJMSçš„Topicæ¦‚å¿µï¼‰ï¼Œå¯ä»¥ä½¿ç”¨<code>*</code>è¿›è¡ŒåŒ¹é…å¹¶è·¯ç”±ã€‚å¯è§ï¼ŒæŒæ¡RabbitMQçš„æ ¸å¿ƒæ˜¯ç†è§£å…¶æ¶ˆæ¯çš„è·¯ç”±è§„åˆ™ã€‚</p>
<p>ç›´æ¥æŒ‡å®šä¸€ä¸ªQueueå¹¶æŠ•é€’æ¶ˆæ¯ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ­¤æ—¶æŒ‡å®šRouting Keyä¸ºQueueçš„åç§°å³å¯ï¼Œå› ä¸ºRabbitMQæä¾›äº†ä¸€ä¸ª<code>default exchange</code>ç”¨äºæ ¹æ®Routing KeyæŸ¥æ‰¾Queueå¹¶ç›´æ¥æŠ•é€’æ¶ˆæ¯åˆ°æŒ‡å®šçš„Queueã€‚ä½†æ˜¯è¦å®ç°ä¸€å¯¹å¤šçš„æŠ•é€’å°±å¿…é¡»è‡ªå·±é…ç½®Exchangeã€‚</p>
<p><strong>å°ç»“</strong></p>
<p>Spring Bootæä¾›äº†AMQPçš„é›†æˆï¼Œé»˜è®¤ä½¿ç”¨RabbitMQä½œä¸ºAMQPæ¶ˆæ¯æœåŠ¡å™¨ã€‚</p>
<p>ä½¿ç”¨RabbitMQå‘é€æ¶ˆæ¯æ—¶ï¼Œç†è§£Exchangeå¦‚ä½•è·¯ç”±è‡³ä¸€ä¸ªæˆ–å¤šä¸ªQueueè‡³å…³é‡è¦ã€‚</p>
<h1 id="é›†æˆkafka">é›†æˆKafka<a hidden class="anchor" aria-hidden="true" href="#é›†æˆkafka">#</a></h1>
<p>æˆ‘ä»¬åœ¨å‰é¢å·²ç»ä»‹ç»äº†JMSå’ŒAMQPï¼ŒJMSæ˜¯JavaEEçš„æ ‡å‡†æ¶ˆæ¯æ¥å£ï¼ŒArtemisæ˜¯ä¸€ä¸ªJMSå®ç°äº§å“ï¼ŒAMQPæ˜¯è·¨è¯­è¨€çš„ä¸€ä¸ªæ ‡å‡†æ¶ˆæ¯æ¥å£ï¼ŒRabbitMQæ˜¯ä¸€ä¸ªAMQPå®ç°äº§å“ã€‚</p>
<p>Kafkaä¹Ÿæ˜¯ä¸€ä¸ªæ¶ˆæ¯æœåŠ¡å™¨ï¼Œå®ƒçš„ç‰¹ç‚¹ä¸€æ˜¯å¿«ï¼ŒäºŒæ˜¯æœ‰å·¨å¤§çš„ååé‡ï¼Œé‚£ä¹ˆKafkaå®ç°äº†ä»€ä¹ˆæ ‡å‡†æ¶ˆæ¯æ¥å£å‘¢ï¼Ÿ</p>
<p>Kafkaæ²¡æœ‰å®ç°ä»»ä½•æ ‡å‡†çš„æ¶ˆæ¯æ¥å£ï¼Œå®ƒè‡ªå·±æä¾›çš„APIå°±æ˜¯Kafkaçš„æ¥å£ã€‚</p>
<blockquote>
<p>å“¥æ²¡æœ‰å®ç°ä»»ä½•æ ‡å‡†ï¼Œå“¥è‡ªå·±å°±æ˜¯æ ‡å‡†ã€‚</p>
<p>â€”â€” Kafka</p>
</blockquote>
<p>Kafkaæœ¬èº«æ˜¯Scalaç¼–å†™çš„ï¼Œè¿è¡Œåœ¨JVMä¹‹ä¸Šã€‚Producerå’ŒConsumeréƒ½é€šè¿‡Kafkaçš„å®¢æˆ·ç«¯ä½¿ç”¨ç½‘ç»œæ¥ä¸ä¹‹é€šä¿¡ã€‚ä»é€»è¾‘ä¸Šè®²ï¼ŒKafkaè®¾è®¡éå¸¸ç®€å•ï¼Œå®ƒåªæœ‰ä¸€ç§ç±»ä¼¼JMSçš„Topicçš„æ¶ˆæ¯é€šé“ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>                       â”Œâ”€â”€â–¶â”‚Consumer-1â”‚
</span></span><span style="display:flex;"><span>                       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span style="display:flex;"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>â”‚Producerâ”‚â”€â”€â”€â–¶â”‚Topicâ”‚â”€â”€â”¼â”€â”€â–¶â”‚Consumer-2â”‚
</span></span><span style="display:flex;"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span style="display:flex;"><span>                       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>                       â””â”€â”€â–¶â”‚Consumer-3â”‚
</span></span><span style="display:flex;"><span>                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span></code></pre></td></tr></table>
</div>
</div><p>é‚£ä¹ˆKafkaå¦‚ä½•æ”¯æŒåä¸‡ç”šè‡³ç™¾ä¸‡çš„å¹¶å‘å‘¢ï¼Ÿç­”æ¡ˆæ˜¯åˆ†åŒºã€‚Kafkaçš„ä¸€ä¸ªTopicå¯ä»¥æœ‰ä¸€ä¸ªè‡³å¤šä¸ªPartitionï¼Œå¹¶ä¸”å¯ä»¥åˆ†å¸ƒåˆ°å¤šå°æœºå™¨ä¸Šï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>            â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”
</span></span><span style="display:flex;"><span>             Topic
</span></span><span style="display:flex;"><span>            â”‚                   â”‚
</span></span><span style="display:flex;"><span>                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>            â”‚â”Œâ”€â–¶â”‚Partition-1â”‚â”€â”€â”â”‚â”Œâ”€â”€â–¶â”‚Consumer-1â”‚
</span></span><span style="display:flex;"><span>             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span style="display:flex;"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>â”‚Producerâ”‚â”€â”€â”€â”¼â”€â–¶â”‚Partition-2â”‚â”€â”€â”¼â”€â”¼â”€â”€â–¶â”‚Consumer-2â”‚
</span></span><span style="display:flex;"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span style="display:flex;"><span>             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span style="display:flex;"><span>            â”‚â””â”€â–¶â”‚Partition-3â”‚â”€â”€â”˜â”‚â””â”€â”€â–¶â”‚Consumer-3â”‚
</span></span><span style="display:flex;"><span>                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span style="display:flex;"><span>            â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜
</span></span></code></pre></td></tr></table>
</div>
</div><p>Kafkaåªä¿è¯åœ¨ä¸€ä¸ªPartitionå†…éƒ¨ï¼Œæ¶ˆæ¯æ˜¯æœ‰åºçš„ï¼Œä½†æ˜¯ï¼Œå­˜åœ¨å¤šä¸ªPartitionçš„æƒ…å†µä¸‹ï¼ŒProducerå‘é€çš„3ä¸ªæ¶ˆæ¯ä¼šä¾æ¬¡å‘é€åˆ°Partition-1ã€Partition-2å’ŒPartition-3ï¼ŒConsumerä»3ä¸ªPartitionæ¥æ”¶çš„æ¶ˆæ¯å¹¶ä¸ä¸€å®šæ˜¯Producerå‘é€çš„é¡ºåºï¼Œå› æ­¤ï¼Œå¤šä¸ªPartitionåªèƒ½ä¿è¯æ¥æ”¶æ¶ˆæ¯å¤§æ¦‚ç‡æŒ‰å‘é€æ—¶é—´æœ‰åºï¼Œå¹¶ä¸èƒ½ä¿è¯å®Œå…¨æŒ‰Producerå‘é€çš„é¡ºåºã€‚è¿™ä¸€ç‚¹åœ¨ä½¿ç”¨Kafkaä½œä¸ºæ¶ˆæ¯æœåŠ¡å™¨æ—¶è¦ç‰¹åˆ«æ³¨æ„ï¼Œå¯¹å‘é€é¡ºåºæœ‰ä¸¥æ ¼è¦æ±‚çš„Topicåªèƒ½æœ‰ä¸€ä¸ªPartitionã€‚</p>
<p>Kafkaçš„å¦ä¸€ä¸ªç‰¹ç‚¹æ˜¯æ¶ˆæ¯å‘é€å’Œæ¥æ”¶éƒ½å°½é‡ä½¿ç”¨æ‰¹å¤„ç†ï¼Œä¸€æ¬¡å¤„ç†å‡ åç”šè‡³ä¸Šç™¾æ¡æ¶ˆæ¯ï¼Œæ¯”ä¸€æ¬¡ä¸€æ¡æ•ˆç‡è¦é«˜å¾ˆå¤šã€‚</p>
<p>æœ€åè¦æ³¨æ„çš„æ˜¯æ¶ˆæ¯çš„æŒä¹…æ€§ã€‚Kafkaæ€»æ˜¯å°†æ¶ˆæ¯å†™å…¥Partitionå¯¹åº”çš„æ–‡ä»¶ï¼Œæ¶ˆæ¯ä¿å­˜å¤šä¹…å–å†³äºæœåŠ¡å™¨çš„é…ç½®ï¼Œå¯ä»¥æŒ‰ç…§æ—¶é—´åˆ é™¤ï¼ˆé»˜è®¤3å¤©ï¼‰ï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§æ–‡ä»¶å¤§å°åˆ é™¤ï¼Œå› æ­¤ï¼Œåªè¦Consumeråœ¨ç¦»çº¿æœŸå†…çš„æ¶ˆæ¯è¿˜æ²¡æœ‰è¢«åˆ é™¤ï¼Œå†æ¬¡ä¸Šçº¿ä»ç„¶å¯ä»¥æ¥æ”¶åˆ°å®Œæ•´çš„æ¶ˆæ¯æµã€‚è¿™ä¸€åŠŸèƒ½å®é™…ä¸Šæ˜¯å®¢æˆ·ç«¯è‡ªå·±å®ç°çš„ï¼Œå®¢æˆ·ç«¯ä¼šå­˜å‚¨å®ƒæ¥æ”¶åˆ°çš„æœ€åä¸€ä¸ªæ¶ˆæ¯çš„offsetIdï¼Œå†æ¬¡ä¸Šçº¿åæŒ‰ä¸Šæ¬¡çš„offsetIdæŸ¥è¯¢ã€‚offsetIdæ˜¯Kafkaæ ‡è¯†æŸä¸ªPartionçš„æ¯ä¸€æ¡æ¶ˆæ¯çš„é€’å¢æ•´æ•°ï¼Œå®¢æˆ·ç«¯é€šå¸¸å°†å®ƒå­˜å‚¨åœ¨ZooKeeperä¸­ã€‚</p>
<p>æœ‰äº†Kafkaæ¶ˆæ¯è®¾è®¡çš„åŸºæœ¬æ¦‚å¿µï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åœ¨Spring Bootä¸­ä½¿ç”¨Kafkaã€‚</p>
<h3 id="å®‰è£…kafka">å®‰è£…Kafka<a hidden class="anchor" aria-hidden="true" href="#å®‰è£…kafka">#</a></h3>
<p>é¦–å…ˆä»Kafkaå®˜ç½‘<a href="https://kafka.apache.org/downloads">ä¸‹è½½</a>æœ€æ–°ç‰ˆKafakaï¼Œè§£å‹ååœ¨<code>bin</code>ç›®å½•æ‰¾åˆ°ä¸¤ä¸ªæ–‡ä»¶ï¼š</p>
<ul>
<li><code>zookeeper-server-start.sh</code>ï¼šå¯åŠ¨ZooKeeperï¼ˆå·²å†…ç½®åœ¨Kafkaä¸­ï¼‰ï¼›</li>
<li><code>kafka-server-start.sh</code>ï¼šå¯åŠ¨Kafkaã€‚</li>
</ul>
<p>å…ˆå¯åŠ¨ZooKeeperï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>$ ./zookeeper-server-start.sh ../config/zookeeper.properties 
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†å¯åŠ¨Kafkaï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>./kafka-server-start.sh ../config/server.properties
</span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºè¡¨ç¤ºå¯åŠ¨æˆåŠŸï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>... INFO [KafkaServer id=0] started (kafka.server.KafkaServer)
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœè¦å…³é—­Kafkaå’ŒZooKeeperï¼Œä¾æ¬¡æŒ‰Ctrl-Cé€€å‡ºå³å¯ã€‚æ³¨æ„è¿™æ˜¯åœ¨æœ¬åœ°å¼€å‘æ—¶ä½¿ç”¨Kafkaçš„æ–¹å¼ï¼Œçº¿ä¸ŠKafkaæœåŠ¡æ¨èä½¿ç”¨äº‘æœåŠ¡å‚å•†æ‰˜ç®¡æ¨¡å¼ï¼ˆAWSçš„MSKï¼Œé˜¿é‡Œäº‘çš„æ¶ˆæ¯é˜Ÿåˆ—Kafkaç‰ˆï¼‰ã€‚</p>
<h3 id="ä½¿ç”¨kafka">ä½¿ç”¨Kafka<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨kafka">#</a></h3>
<p>åœ¨Spring Bootä¸­ä½¿ç”¨Kafkaï¼Œé¦–å…ˆè¦å¼•å…¥ä¾èµ–ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework.kafka<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-kafka<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„è¿™ä¸ªä¾èµ–æ˜¯<code>spring-kafka</code>é¡¹ç›®æä¾›çš„ã€‚</p>
<p>ç„¶åï¼Œåœ¨<code>application.yml</code>ä¸­æ·»åŠ Kafkaé…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="font-weight:bold">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">kafka</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">bootstrap-servers</span>: localhost:9092
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">consumer</span>:
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">auto-offset-reset</span>: latest
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">max-poll-records</span>: <span style="color:#ff0;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>      <span style="font-weight:bold">max-partition-fetch-bytes</span>: <span style="color:#ff0;font-weight:bold">1000000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é™¤äº†<code>bootstrap-servers</code>å¿…é¡»æŒ‡å®šå¤–ï¼Œ<code>consumer</code>ç›¸å…³çš„é…ç½®é¡¹å‡ä¸ºè°ƒä¼˜é€‰é¡¹ã€‚ä¾‹å¦‚ï¼Œ<code>max-poll-records</code>è¡¨ç¤ºä¸€æ¬¡æœ€å¤šæŠ“å–100æ¡æ¶ˆæ¯ã€‚é…ç½®åç§°å»å“ªé‡Œçœ‹ï¼ŸIDEé‡Œå®šä¹‰ä¸€ä¸ª<code>KafkaProperties.Consumer</code>çš„å˜é‡ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>KafkaProperties.<span style="color:#007f7f">Consumer</span> c = <span style="color:#fff;font-weight:bold">null</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæŒ‰ä½CtrlæŸ¥çœ‹æºç å³å¯ã€‚</p>
<h3 id="å‘é€æ¶ˆæ¯">å‘é€æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#å‘é€æ¶ˆæ¯">#</a></h3>
<p>Spring Bootè‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>KafkaTemplate</code>ç”¨äºå‘é€æ¶ˆæ¯ã€‚æ³¨æ„åˆ°è¿™æ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼Œè€Œé»˜è®¤é…ç½®æ€»æ˜¯ä½¿ç”¨<code>String</code>ä½œä¸ºKafkaæ¶ˆæ¯çš„ç±»å‹ï¼Œæ‰€ä»¥æ³¨å…¥<code>KafkaTemplate&lt;String, String&gt;</code>å³å¯ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MessagingService {
</span></span><span style="display:flex;"><span>    @Autowired ObjectMapper objectMapper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired KafkaTemplate&lt;String, String&gt; kafkaTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendRegistrationMessage(RegistrationMessage msg) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        send(<span style="color:#0ff;font-weight:bold">&#34;topic_registration&#34;</span>, msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> sendLoginMessage(LoginMessage msg) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        send(<span style="color:#0ff;font-weight:bold">&#34;topic_login&#34;</span>, msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">void</span> send(String topic, Object msg) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        ProducerRecord&lt;String, String&gt; pr = <span style="color:#fff;font-weight:bold">new</span> ProducerRecord&lt;&gt;(topic, objectMapper.<span style="color:#007f7f">writeValueAsString</span>(msg));
</span></span><span style="display:flex;"><span>        pr.<span style="color:#007f7f">headers</span>().<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;type&#34;</span>, msg.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getName</span>().<span style="color:#007f7f">getBytes</span>(StandardCharsets.<span style="color:#007f7f">UTF_8</span>));
</span></span><span style="display:flex;"><span>        kafkaTemplate.<span style="color:#007f7f">send</span>(pr);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‘é€æ¶ˆæ¯æ—¶ï¼Œéœ€æŒ‡å®šTopicåç§°ï¼Œæ¶ˆæ¯æ­£æ–‡ã€‚ä¸ºäº†å‘é€ä¸€ä¸ªJavaBeanï¼Œè¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨<code>MessageConverter</code>æ¥è½¬æ¢JavaBeanï¼Œè€Œæ˜¯ç›´æ¥æŠŠæ¶ˆæ¯ç±»å‹ä½œä¸ºHeaderæ·»åŠ åˆ°æ¶ˆæ¯ä¸­ï¼ŒHeaderåç§°ä¸º<code>type</code>ï¼Œå€¼ä¸ºClasså…¨åã€‚æ¶ˆæ¯æ­£æ–‡æ˜¯åºåˆ—åŒ–çš„JSONã€‚</p>
<h3 id="æ¥æ”¶æ¶ˆæ¯">æ¥æ”¶æ¶ˆæ¯<a hidden class="anchor" aria-hidden="true" href="#æ¥æ”¶æ¶ˆæ¯">#</a></h3>
<p>æ¥æ”¶æ¶ˆæ¯å¯ä»¥ä½¿ç”¨<code>@KafkaListener</code>æ³¨è§£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TopicMessageListener {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Logger logger = LoggerFactory.<span style="color:#007f7f">getLogger</span>(getClass());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    ObjectMapper objectMapper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @KafkaListener(topics = <span style="color:#0ff;font-weight:bold">&#34;topic_registration&#34;</span>, groupId = <span style="color:#0ff;font-weight:bold">&#34;group1&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onRegistrationMessage(@Payload String message, @Header(<span style="color:#0ff;font-weight:bold">&#34;type&#34;</span>) String type) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        RegistrationMessage msg = objectMapper.<span style="color:#007f7f">readValue</span>(message, getType(type));
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;received registration message: {}&#34;</span>, msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @KafkaListener(topics = <span style="color:#0ff;font-weight:bold">&#34;topic_login&#34;</span>, groupId = <span style="color:#0ff;font-weight:bold">&#34;group1&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> onLoginMessage(@Payload String message, @Header(<span style="color:#0ff;font-weight:bold">&#34;type&#34;</span>) String type) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        LoginMessage msg = objectMapper.<span style="color:#007f7f">readValue</span>(message, getType(type));
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;received login message: {}&#34;</span>, msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @KafkaListener(topics = <span style="color:#0ff;font-weight:bold">&#34;topic_login&#34;</span>, groupId = <span style="color:#0ff;font-weight:bold">&#34;group2&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> processLoginMessage(@Payload String message, @Header(<span style="color:#0ff;font-weight:bold">&#34;type&#34;</span>) String type) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        LoginMessage msg = objectMapper.<span style="color:#007f7f">readValue</span>(message, getType(type));
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">info</span>(<span style="color:#0ff;font-weight:bold">&#34;process login message: {}&#34;</span>, msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @SuppressWarnings(<span style="color:#0ff;font-weight:bold">&#34;unchecked&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> &lt;T&gt; Class&lt;T&gt; getType(String type) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// TODO: use cache:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> (Class&lt;T&gt;) Class.<span style="color:#007f7f">forName</span>(type);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (ClassNotFoundException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æ¥æ”¶æ¶ˆæ¯çš„æ–¹æ³•ä¸­ï¼Œä½¿ç”¨<code>@Payload</code>è¡¨ç¤ºä¼ å…¥çš„æ˜¯æ¶ˆæ¯æ­£æ–‡ï¼Œä½¿ç”¨<code>@Header</code>å¯ä¼ å…¥æ¶ˆæ¯çš„æŒ‡å®šHeaderï¼Œè¿™é‡Œä¼ å…¥<code>@Header(&quot;type&quot;)</code>ï¼Œå°±æ˜¯æˆ‘ä»¬å‘é€æ¶ˆæ¯æ—¶æŒ‡å®šçš„Classå…¨åã€‚æ¥æ”¶æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®Classå…¨åæ¥ååºåˆ—åŒ–è·å¾—JavaBeanã€‚</p>
<p>ä¸Šè¿°ä»£ç ä¸€å…±å®šä¹‰äº†3ä¸ªListenerï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•ç›‘å¬çš„æ˜¯åŒä¸€ä¸ªTopicï¼Œä½†å®ƒä»¬çš„Group IDä¸åŒã€‚å‡è®¾Producerå‘é€çš„æ¶ˆæ¯æµæ˜¯Aã€Bã€Cã€Dï¼ŒGroup IDä¸åŒè¡¨ç¤ºè¿™æ˜¯ä¸¤ä¸ªä¸åŒçš„Consumerï¼Œå®ƒä»¬å°†åˆ†åˆ«æ”¶å–å®Œæ•´çš„æ¶ˆæ¯æµï¼Œå³å„è‡ªå‡æ”¶åˆ°Aã€Bã€Cã€Dã€‚Group IDç›¸åŒçš„å¤šä¸ªConsumerå®é™…ä¸Šè¢«è§†ä½œä¸€ä¸ªConsumerï¼Œå³å¦‚æœæœ‰ä¸¤ä¸ªGroup IDç›¸åŒçš„Consumerï¼Œé‚£ä¹ˆå®ƒä»¬å„è‡ªæ”¶åˆ°çš„å¾ˆå¯èƒ½æ˜¯Aã€Cå’ŒBã€Dã€‚</p>
<p>è¿è¡Œåº”ç”¨ç¨‹åºï¼Œæ³¨å†Œæ–°ç”¨æˆ·åï¼Œè§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>... c.i.learnjava.service.UserService        : try register by bob@example.com...
</span></span><span style="display:flex;"><span>... c.i.learnjava.web.UserController         : user registered: bob@example.com
</span></span><span style="display:flex;"><span>... c.i.l.service.TopicMessageListener       : received registration message: [RegistrationMessage: email=bob@example.com, name=Bob, timestamp=1594637517458]
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”¨æˆ·ç™»å½•åï¼Œè§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>... c.i.learnjava.service.UserService        : try login by bob@example.com...
</span></span><span style="display:flex;"><span>... c.i.l.service.TopicMessageListener       : received login message: [LoginMessage: email=bob@example.com, name=Bob, success=true, timestamp=1594637523470]
</span></span><span style="display:flex;"><span>... c.i.l.service.TopicMessageListener       : process login message: [LoginMessage: email=bob@example.com, name=Bob, success=true, timestamp=1594637523470]
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºGroup IDä¸åŒï¼ŒåŒä¸€ä¸ªæ¶ˆæ¯è¢«ä¸¤ä¸ªConsumeråˆ†åˆ«ç‹¬ç«‹æ¥æ”¶ã€‚å¦‚æœæŠŠGroup IDæ”¹ä¸ºç›¸åŒï¼Œé‚£ä¹ˆåŒä¸€ä¸ªæ¶ˆæ¯åªä¼šè¢«ä¸¤è€…ä¹‹ä¸€æ¥æ”¶ã€‚</p>
<p>æœ‰ç»†å¿ƒçš„ç«¥é‹å¯èƒ½ä¼šé—®ï¼Œåœ¨Kafkaä¸­æ˜¯å¦‚ä½•åˆ›å»ºTopicçš„ï¼Ÿåˆå¦‚ä½•æŒ‡å®šæŸä¸ªTopicçš„åˆ†åŒºæ•°é‡ï¼Ÿ</p>
<p>å®é™…ä¸Šå¼€å‘ä½¿ç”¨çš„Kafkaé»˜è®¤å…è®¸è‡ªåŠ¨åˆ›å»ºTopicï¼Œåˆ›å»ºTopicæ—¶é»˜è®¤çš„åˆ†åŒºæ•°é‡æ˜¯2ï¼Œå¯ä»¥é€šè¿‡<code>server.properties</code>ä¿®æ”¹é»˜è®¤åˆ†åŒºæ•°é‡ã€‚</p>
<p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸ä¼šå…³é—­è‡ªåŠ¨åˆ›å»ºåŠŸèƒ½ï¼ŒTopicéœ€è¦ç”±è¿ç»´äººå‘˜å…ˆåˆ›å»ºå¥½ã€‚å’ŒRabbitMQç›¸æ¯”ï¼ŒKafkaå¹¶ä¸æä¾›ç½‘é¡µç‰ˆç®¡ç†åå°ï¼Œç®¡ç†Topicéœ€è¦ä½¿ç”¨å‘½ä»¤è¡Œï¼Œæ¯”è¾ƒç¹çï¼Œåªæœ‰äº‘æœåŠ¡å•†é€šå¸¸ä¼šæä¾›æ›´å‹å¥½çš„ç®¡ç†åå°ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://009965.xyz/tags/spring/">Spring</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://009965.xyz/">Wjy&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>