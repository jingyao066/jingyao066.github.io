<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>2ã€AOP | Wjy&#39;s Blog</title>
<meta name="keywords" content="spring">
<meta name="description" content="ä½¿ç”¨AOP
AOPæ˜¯Aspect Oriented Programmingï¼Œå³é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚
é‚£ä»€ä¹ˆæ˜¯AOPï¼Ÿ
æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹OOPï¼šObject Oriented Programmingï¼ŒOOPä½œä¸ºé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ¨¡å¼ï¼Œè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼ŒOOPçš„ä¸»è¦åŠŸèƒ½æ˜¯æ•°æ®å°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://wjy6.netlify.app/posts/spring/2aop/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://wjy6.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://wjy6.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://wjy6.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://wjy6.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://wjy6.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://wjy6.netlify.app/posts/spring/2aop/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:url" content="https://wjy6.netlify.app/posts/spring/2aop/">
  <meta property="og:site_name" content="Wjy&#39;s Blog">
  <meta property="og:title" content="2ã€AOP">
  <meta property="og:description" content="ä½¿ç”¨AOP AOPæ˜¯Aspect Oriented Programmingï¼Œå³é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚
é‚£ä»€ä¹ˆæ˜¯AOPï¼Ÿ
æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹OOPï¼šObject Oriented Programmingï¼ŒOOPä½œä¸ºé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ¨¡å¼ï¼Œè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼ŒOOPçš„ä¸»è¦åŠŸèƒ½æ˜¯æ•°æ®å°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-01-02T16:21:14+00:00">
    <meta property="article:modified_time" content="2020-01-02T16:21:14+00:00">
    <meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2ã€AOP">
<meta name="twitter:description" content="ä½¿ç”¨AOP
AOPæ˜¯Aspect Oriented Programmingï¼Œå³é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚
é‚£ä»€ä¹ˆæ˜¯AOPï¼Ÿ
æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹OOPï¼šObject Oriented Programmingï¼ŒOOPä½œä¸ºé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ¨¡å¼ï¼Œè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼ŒOOPçš„ä¸»è¦åŠŸèƒ½æ˜¯æ•°æ®å°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://wjy6.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "2ã€AOP",
      "item": "https://wjy6.netlify.app/posts/spring/2aop/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "2ã€AOP",
  "name": "2ã€AOP",
  "description": "ä½¿ç”¨AOP AOPæ˜¯Aspect Oriented Programmingï¼Œå³é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚\né‚£ä»€ä¹ˆæ˜¯AOPï¼Ÿ\næˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹OOPï¼šObject Oriented Programmingï¼ŒOOPä½œä¸ºé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ¨¡å¼ï¼Œè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼ŒOOPçš„ä¸»è¦åŠŸèƒ½æ˜¯æ•°æ®å°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚\n",
  "keywords": [
    "spring"
  ],
  "articleBody": "ä½¿ç”¨AOP AOPæ˜¯Aspect Oriented Programmingï¼Œå³é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚\né‚£ä»€ä¹ˆæ˜¯AOPï¼Ÿ\næˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹OOPï¼šObject Oriented Programmingï¼ŒOOPä½œä¸ºé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ¨¡å¼ï¼Œè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼ŒOOPçš„ä¸»è¦åŠŸèƒ½æ˜¯æ•°æ®å°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚\nè€ŒAOPæ˜¯ä¸€ç§æ–°çš„ç¼–ç¨‹æ–¹å¼ï¼Œå®ƒå’ŒOOPä¸åŒï¼ŒOOPæŠŠç³»ç»Ÿçœ‹ä½œå¤šä¸ªå¯¹è±¡çš„äº¤äº’ï¼ŒAOPæŠŠç³»ç»Ÿåˆ†è§£ä¸ºä¸åŒçš„å…³æ³¨ç‚¹ï¼Œæˆ–è€…ç§°ä¹‹ä¸ºåˆ‡é¢ï¼ˆAspectï¼‰ã€‚\nè¦ç†è§£AOPçš„æ¦‚å¿µï¼Œæˆ‘ä»¬å…ˆç”¨OOPä¸¾ä¾‹ï¼Œæ¯”å¦‚ä¸€ä¸ªä¸šåŠ¡ç»„ä»¶BookServiceï¼Œå®ƒæœ‰å‡ ä¸ªä¸šåŠ¡æ–¹æ³•ï¼š\ncreateBookï¼šæ·»åŠ æ–°çš„Bookï¼› updateBookï¼šä¿®æ”¹Bookï¼› deleteBookï¼šåˆ é™¤Bookã€‚ å¯¹æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ï¼Œä¾‹å¦‚ï¼ŒcreateBook()ï¼Œé™¤äº†ä¸šåŠ¡é€»è¾‘ï¼Œè¿˜éœ€è¦å®‰å…¨æ£€æŸ¥ã€æ—¥å¿—è®°å½•å’Œäº‹åŠ¡å¤„ç†ï¼Œå®ƒçš„ä»£ç åƒè¿™æ ·ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public class BookService { public void createBook(Book book) { securityCheck(); Transaction tx = startTransaction(); try { // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ tx.commit(); } catch (RuntimeException e) { tx.rollback(); throw e; } log(\"created book: \" + book); } } ç»§ç»­ç¼–å†™updateBook()ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public class BookService { public void updateBook(Book book) { securityCheck(); Transaction tx = startTransaction(); try { // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ tx.commit(); } catch (RuntimeException e) { tx.rollback(); throw e; } log(\"updated book: \" + book); } } å¯¹äºå®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰ä»£ç ï¼Œå®ƒä»¬ä¼šé‡å¤å‡ºç°åœ¨æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­ã€‚ä½¿ç”¨OOPï¼Œæˆ‘ä»¬å¾ˆéš¾å°†è¿™äº›å››å¤„åˆ†æ•£çš„ä»£ç æ¨¡å—åŒ–ã€‚\nè€ƒå¯Ÿä¸šåŠ¡æ¨¡å‹å¯ä»¥å‘ç°ï¼ŒBookServiceå…³å¿ƒçš„æ˜¯è‡ªèº«çš„æ ¸å¿ƒé€»è¾‘ï¼Œä½†æ•´ä¸ªç³»ç»Ÿè¿˜è¦æ±‚å…³æ³¨å®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½å®é™…ä¸Šâ€œæ¨ªè·¨â€å¤šä¸ªä¸šåŠ¡æ–¹æ³•ï¼Œä¸ºäº†å®ç°è¿™äº›åŠŸèƒ½ï¼Œä¸å¾—ä¸åœ¨æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸Šé‡å¤ç¼–å†™ä»£ç ã€‚\nä¸€ç§å¯è¡Œçš„æ–¹å¼æ˜¯ä½¿ç”¨Proxyæ¨¡å¼ï¼Œå°†æŸä¸ªåŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œæƒé™æ£€æŸ¥ï¼Œæ”¾å…¥Proxyä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public class SecurityCheckBookService implements BookService { private final BookService target; public SecurityCheckBookService(BookService target) { this.target = target; } public void createBook(Book book) { securityCheck(); target.createBook(book); } public void updateBook(Book book) { securityCheck(); target.updateBook(book); } public void deleteBook(Book book) { securityCheck(); target.deleteBook(book); } private void securityCheck() { ... } } è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œå¿…é¡»å…ˆæŠ½å–æ¥å£ï¼Œç„¶åï¼Œé’ˆå¯¹æ¯ä¸ªæ–¹æ³•å®ç°Proxyã€‚\nå¦ä¸€ç§æ–¹æ³•æ˜¯ï¼Œæ—¢ç„¶SecurityCheckBookServiceçš„ä»£ç éƒ½æ˜¯æ ‡å‡†çš„Proxyæ ·æ¿ä»£ç ï¼Œä¸å¦‚æŠŠæƒé™æ£€æŸ¥è§†ä½œä¸€ç§åˆ‡é¢ï¼ˆAspectï¼‰ï¼ŒæŠŠæ—¥å¿—ã€äº‹åŠ¡ä¹Ÿè§†ä¸ºåˆ‡é¢ï¼Œç„¶åï¼Œä»¥æŸç§è‡ªåŠ¨åŒ–çš„æ–¹å¼ï¼ŒæŠŠåˆ‡é¢ç»‡å…¥åˆ°æ ¸å¿ƒé€»è¾‘ä¸­ï¼Œå®ç°Proxyæ¨¡å¼ã€‚\nå¦‚æœæˆ‘ä»¬ä»¥AOPçš„è§†è§’æ¥ç¼–å†™ä¸Šè¿°ä¸šåŠ¡ï¼Œå¯ä»¥ä¾æ¬¡å®ç°ï¼š\næ ¸å¿ƒé€»è¾‘ï¼Œå³BookServiceï¼› åˆ‡é¢é€»è¾‘ï¼Œå³ï¼š æƒé™æ£€æŸ¥çš„Aspectï¼› æ—¥å¿—çš„Aspectï¼› äº‹åŠ¡çš„Aspectã€‚ ç„¶åï¼Œä»¥æŸç§æ–¹å¼ï¼Œè®©æ¡†æ¶æ¥æŠŠä¸Šè¿°3ä¸ªAspectä»¥Proxyçš„æ–¹å¼â€œç»‡å…¥â€åˆ°BookServiceä¸­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±ä¸å¿…ç¼–å†™å¤æ‚è€Œå†—é•¿çš„Proxyæ¨¡å¼ã€‚\nAOP çš„åŸç†\nå¦‚ä½•æŠŠåˆ‡é¢ç»‡å…¥åˆ°æ ¸å¿ƒé€»è¾‘ä¸­ï¼Ÿè¿™æ­£æ˜¯AOPéœ€è¦è§£å†³çš„é—®é¢˜ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯è·å¾—äº†BookServiceçš„å¼•ç”¨ï¼Œå½“è°ƒç”¨bookService.createBook()æ—¶ï¼Œå¦‚ä½•å¯¹è°ƒç”¨æ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œå¹¶åœ¨æ‹¦æˆªå‰åè¿›è¡Œå®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰å¤„ç†ï¼Œå°±ç›¸å½“äºå®Œæˆäº†æ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½ã€‚\nåœ¨Javaå¹³å°ä¸Šï¼Œå¯¹äºAOPçš„ç»‡å…¥ï¼Œæœ‰3ç§æ–¹å¼ï¼š\nç¼–è¯‘æœŸï¼šåœ¨ç¼–è¯‘æ—¶ï¼Œç”±ç¼–è¯‘å™¨æŠŠåˆ‡é¢è°ƒç”¨ç¼–è¯‘è¿›å­—èŠ‚ç ï¼Œè¿™ç§æ–¹å¼éœ€è¦å®šä¹‰æ–°çš„å…³é”®å­—å¹¶æ‰©å±•ç¼–è¯‘å™¨ï¼ŒAspectJå°±æ‰©å±•äº†Javaç¼–è¯‘å™¨ï¼Œä½¿ç”¨å…³é”®å­—aspectæ¥å®ç°ç»‡å…¥ï¼› ç±»åŠ è½½å™¨ï¼šåœ¨ç›®æ ‡ç±»è¢«è£…è½½åˆ°JVMæ—¶ï¼Œé€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„ç±»åŠ è½½å™¨ï¼Œå¯¹ç›®æ ‡ç±»çš„å­—èŠ‚ç é‡æ–°â€œå¢å¼ºâ€ï¼› è¿è¡ŒæœŸï¼šç›®æ ‡å¯¹è±¡å’Œåˆ‡é¢éƒ½æ˜¯æ™®é€šJavaç±»ï¼Œé€šè¿‡JVMçš„åŠ¨æ€ä»£ç†åŠŸèƒ½æˆ–è€…ç¬¬ä¸‰æ–¹åº“å®ç°è¿è¡ŒæœŸåŠ¨æ€ç»‡å…¥ã€‚ æœ€ç®€å•çš„æ–¹å¼æ˜¯ç¬¬ä¸‰ç§ï¼ŒSpringçš„AOPå®ç°å°±æ˜¯åŸºäºJVMçš„åŠ¨æ€ä»£ç†ã€‚ç”±äºJVMçš„åŠ¨æ€ä»£ç†è¦æ±‚å¿…é¡»å®ç°æ¥å£ï¼Œå¦‚æœä¸€ä¸ªæ™®é€šç±»æ²¡æœ‰ä¸šåŠ¡æ¥å£ï¼Œå°±éœ€è¦é€šè¿‡CGLIBæˆ–è€…Javassistè¿™äº›ç¬¬ä¸‰æ–¹åº“å®ç°ã€‚\nAOPæŠ€æœ¯çœ‹ä¸Šå»æ¯”è¾ƒç¥ç§˜ï¼Œä½†å®é™…ä¸Šï¼Œå®ƒæœ¬è´¨å°±æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ï¼Œè®©æˆ‘ä»¬æŠŠä¸€äº›å¸¸ç”¨åŠŸèƒ½å¦‚æƒé™æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰ï¼Œä»æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­å‰¥ç¦»å‡ºæ¥ã€‚\néœ€è¦ç‰¹åˆ«æŒ‡å‡ºçš„æ˜¯ï¼ŒAOPå¯¹äºè§£å†³ç‰¹å®šé—®é¢˜ï¼Œä¾‹å¦‚äº‹åŠ¡ç®¡ç†éå¸¸æœ‰ç”¨ï¼Œè¿™æ˜¯å› ä¸ºåˆ†æ•£åœ¨å„å¤„çš„äº‹åŠ¡ä»£ç å‡ ä¹æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå¹¶ä¸”å®ƒä»¬éœ€è¦çš„å‚æ•°ï¼ˆJDBCçš„Connectionï¼‰ä¹Ÿæ˜¯å›ºå®šçš„ã€‚å¦ä¸€äº›ç‰¹å®šé—®é¢˜ï¼Œå¦‚æ—¥å¿—ï¼Œå°±ä¸é‚£ä¹ˆå®¹æ˜“å®ç°ï¼Œå› ä¸ºæ—¥å¿—è™½ç„¶ç®€å•ï¼Œä½†æ‰“å°æ—¥å¿—çš„æ—¶å€™ï¼Œç»å¸¸éœ€è¦æ•è·å±€éƒ¨å˜é‡ï¼Œå¦‚æœä½¿ç”¨AOPå®ç°æ—¥å¿—ï¼Œæˆ‘ä»¬åªèƒ½è¾“å‡ºå›ºå®šæ ¼å¼çš„æ—¥å¿—ï¼Œå› æ­¤ï¼Œä½¿ç”¨AOPæ—¶ï¼Œå¿…é¡»é€‚åˆç‰¹å®šçš„åœºæ™¯ã€‚\nè£…é…AOP åœ¨AOPç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸‹é¢çš„æ¦‚å¿µï¼š\nAspectï¼šåˆ‡é¢ï¼Œå³ä¸€ä¸ªæ¨ªè·¨å¤šä¸ªæ ¸å¿ƒé€»è¾‘çš„åŠŸèƒ½ï¼Œæˆ–è€…ç§°ä¹‹ä¸ºç³»ç»Ÿå…³æ³¨ç‚¹ï¼› Joinpointï¼šè¿æ¥ç‚¹ï¼Œå³å®šä¹‰åœ¨åº”ç”¨ç¨‹åºæµç¨‹çš„ä½•å¤„æ’å…¥åˆ‡é¢çš„æ‰§è¡Œï¼› Pointcutï¼šåˆ‡å…¥ç‚¹ï¼Œå³ä¸€ç»„è¿æ¥ç‚¹çš„é›†åˆï¼› Adviceï¼šå¢å¼ºï¼ŒæŒ‡ç‰¹å®šè¿æ¥ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼› Introductionï¼šå¼•ä»‹ï¼ŒæŒ‡ä¸ºä¸€ä¸ªå·²æœ‰çš„Javaå¯¹è±¡åŠ¨æ€åœ°å¢åŠ æ–°çš„æ¥å£ï¼› Weavingï¼šç»‡å…¥ï¼ŒæŒ‡å°†åˆ‡é¢æ•´åˆåˆ°ç¨‹åºçš„æ‰§è¡Œæµç¨‹ä¸­ï¼› Interceptorï¼šæ‹¦æˆªå™¨ï¼Œæ˜¯ä¸€ç§å®ç°å¢å¼ºçš„æ–¹å¼ï¼› Target Objectï¼šç›®æ ‡å¯¹è±¡ï¼Œå³çœŸæ­£æ‰§è¡Œä¸šåŠ¡çš„æ ¸å¿ƒé€»è¾‘å¯¹è±¡ï¼› AOP Proxyï¼šAOPä»£ç†ï¼Œæ˜¯å®¢æˆ·ç«¯æŒæœ‰çš„å¢å¼ºåçš„å¯¹è±¡å¼•ç”¨ã€‚ çœ‹å®Œä¸Šè¿°æœ¯è¯­ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰å¯¹AOPæœ‰äº†è¿›ä¸€æ­¥çš„å›°æƒ‘ï¼Ÿå…¶å®ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒAOPåˆ›é€ çš„â€œæœ¯è¯­â€ï¼Œåªéœ€è¦ç†è§£AOPæœ¬è´¨ä¸Šåªæ˜¯ä¸€ç§ä»£ç†æ¨¡å¼çš„å®ç°æ–¹å¼ï¼Œåœ¨Springçš„å®¹å™¨ä¸­å®ç°AOPç‰¹åˆ«æ–¹ä¾¿ã€‚\næˆ‘ä»¬ä»¥UserServiceå’ŒMailServiceä¸ºä¾‹ï¼Œè¿™ä¸¤ä¸ªå±äºæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡ç»™UserServiceçš„æ¯ä¸ªä¸šåŠ¡æ–¹æ³•æ‰§è¡Œå‰æ·»åŠ æ—¥å¿—ï¼Œç»™MailServiceçš„æ¯ä¸ªä¸šåŠ¡æ–¹æ³•æ‰§è¡Œå‰åæ·»åŠ æ—¥å¿—ï¼Œåœ¨Springä¸­ï¼Œéœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š\né¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡Mavenå¼•å…¥Springå¯¹AOPçš„æ”¯æŒï¼š\n1 2 3 4 5 org.springframework spring-aspects ${spring.version} ä¸Šè¿°ä¾èµ–ä¼šè‡ªåŠ¨å¼•å…¥AspectJï¼Œä½¿ç”¨AspectJå®ç°AOPæ¯”è¾ƒæ–¹ä¾¿ï¼Œå› ä¸ºå®ƒçš„å®šä¹‰æ¯”è¾ƒç®€å•ã€‚\nç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªLoggingAspectï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Aspect @Component public class LoggingAspect { // åœ¨æ‰§è¡ŒUserServiceçš„æ¯ä¸ªæ–¹æ³•å‰æ‰§è¡Œ: @Before(\"execution(public * com.itranswarp.learnjava.service.UserService.*(..))\") public void doAccessCheck() { System.err.println(\"[Before] do access check...\"); } // åœ¨æ‰§è¡ŒMailServiceçš„æ¯ä¸ªæ–¹æ³•å‰åæ‰§è¡Œ: @Around(\"execution(public * com.itranswarp.learnjava.service.MailService.*(..))\") public Object doLogging(ProceedingJoinPoint pjp) throws Throwable { System.err.println(\"[Around] start \" + pjp.getSignature()); Object retVal = pjp.proceed(); System.err.println(\"[Around] done \" + pjp.getSignature()); return retVal; } } è§‚å¯ŸdoAccessCheck()æ–¹æ³•ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª@Beforeæ³¨è§£ï¼Œåé¢çš„å­—ç¬¦ä¸²æ˜¯å‘Šè¯‰AspectJåº”è¯¥åœ¨ä½•å¤„æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œè¿™é‡Œå†™çš„æ„æ€æ˜¯ï¼šæ‰§è¡ŒUserServiceçš„æ¯ä¸ªpublicæ–¹æ³•å‰æ‰§è¡ŒdoAccessCheck()ä»£ç ã€‚\nå†è§‚å¯ŸdoLogging()æ–¹æ³•ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª@Aroundæ³¨è§£ï¼Œå®ƒå’Œ@Beforeä¸åŒï¼Œ@Aroundå¯ä»¥å†³å®šæ˜¯å¦æ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åœ¨doLogging()å†…éƒ¨å…ˆæ‰“å°æ—¥å¿—ï¼Œå†è°ƒç”¨æ–¹æ³•ï¼Œæœ€åæ‰“å°æ—¥å¿—åè¿”å›ç»“æœã€‚\nåœ¨LoggingAspectç±»çš„å£°æ˜å¤„ï¼Œé™¤äº†ç”¨@Componentè¡¨ç¤ºå®ƒæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªBeanå¤–ï¼Œæˆ‘ä»¬å†åŠ ä¸Š@Aspectæ³¨è§£ï¼Œè¡¨ç¤ºå®ƒçš„@Beforeæ ‡æ³¨çš„æ–¹æ³•éœ€è¦æ³¨å…¥åˆ°UserServiceçš„æ¯ä¸ªpublicæ–¹æ³•æ‰§è¡Œå‰ï¼Œ@Aroundæ ‡æ³¨çš„æ–¹æ³•éœ€è¦æ³¨å…¥åˆ°MailServiceçš„æ¯ä¸ªpublicæ–¹æ³•æ‰§è¡Œå‰åã€‚\nç´§æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦ç»™@Configurationç±»åŠ ä¸Šä¸€ä¸ª@EnableAspectJAutoProxyæ³¨è§£ï¼š\n1 2 3 4 5 6 @Configuration @ComponentScan @EnableAspectJAutoProxy public class AppConfig { ... } Springçš„IoCå®¹å™¨çœ‹åˆ°è¿™ä¸ªæ³¨è§£ï¼Œå°±ä¼šè‡ªåŠ¨æŸ¥æ‰¾å¸¦æœ‰@Aspectçš„Beanï¼Œç„¶åæ ¹æ®æ¯ä¸ªæ–¹æ³•çš„@Beforeã€@Aroundç­‰æ³¨è§£æŠŠAOPæ³¨å…¥åˆ°ç‰¹å®šçš„Beanä¸­ã€‚æ‰§è¡Œä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š\n1 2 3 4 5 6 7 8 [Before] do access check... [Around] start void com.itranswarp.learnjava.service.MailService.sendRegistrationMail(User) Welcome, test! [Around] done void com.itranswarp.learnjava.service.MailService.sendRegistrationMail(User) [Before] do access check... [Around] start void com.itranswarp.learnjava.service.MailService.sendLoginMail(User) Hi, Bob! You are logged in at 2020-02-14T23:13:52.167996+08:00[Asia/Shanghai] [Around] done void com.itranswarp.learnjava.service.MailService.sendLoginMail(User) è¿™è¯´æ˜æ‰§è¡Œä¸šåŠ¡é€»è¾‘å‰åï¼Œç¡®å®æ‰§è¡Œäº†æˆ‘ä»¬å®šä¹‰çš„Aspectï¼ˆå³LoggingAspectçš„æ–¹æ³•ï¼‰ã€‚\næœ‰äº›ç«¥é‹ä¼šé—®ï¼ŒLoggingAspectå®šä¹‰çš„æ–¹æ³•ï¼Œæ˜¯å¦‚ä½•æ³¨å…¥åˆ°å…¶ä»–Beançš„å‘¢ï¼Ÿ\nå…¶å®AOPçš„åŸç†éå¸¸ç®€å•ã€‚æˆ‘ä»¬ä»¥LoggingAspect.doAccessCheck()ä¸ºä¾‹ï¼Œè¦æŠŠå®ƒæ³¨å…¥åˆ°UserServiceçš„æ¯ä¸ªpublicæ–¹æ³•ä¸­ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ç¼–å†™ä¸€ä¸ªå­ç±»ï¼Œå¹¶æŒæœ‰åŸå§‹å®ä¾‹çš„å¼•ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public UserServiceAopProxy extends UserService { private UserService target; private LoggingAspect aspect; public UserServiceAopProxy(UserService target, LoggingAspect aspect) { this.target = target; this.aspect = aspect; } public User login(String email, String password) { // å…ˆæ‰§è¡ŒAspectçš„ä»£ç : aspect.doAccessCheck(); // å†æ‰§è¡ŒUserServiceçš„é€»è¾‘: return target.login(email, password); } public User register(String email, String password, String name) { aspect.doAccessCheck(); return target.register(email, password, name); } ... } è¿™äº›éƒ½æ˜¯Springå®¹å™¨å¯åŠ¨æ—¶ä¸ºæˆ‘ä»¬è‡ªåŠ¨åˆ›å»ºçš„æ³¨å…¥äº†Aspectçš„å­ç±»ï¼Œå®ƒå–ä»£äº†åŸå§‹çš„UserServiceï¼ˆåŸå§‹çš„UserServiceå®ä¾‹ä½œä¸ºå†…éƒ¨å˜é‡éšè—åœ¨UserServiceAopProxyä¸­ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æ‰“å°ä»Springå®¹å™¨è·å–çš„UserServiceå®ä¾‹ç±»å‹ï¼Œå®ƒç±»ä¼¼UserService$$EnhancerBySpringCGLIB$$1f44e01cï¼Œå®é™…ä¸Šæ˜¯Springä½¿ç”¨CGLIBåŠ¨æ€åˆ›å»ºçš„å­ç±»ï¼Œä½†å¯¹äºè°ƒç”¨æ–¹æ¥è¯´ï¼Œæ„Ÿè§‰ä¸åˆ°ä»»ä½•åŒºåˆ«ã€‚\nSpringå¯¹æ¥å£ç±»å‹ä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼Œå¯¹æ™®é€šç±»ä½¿ç”¨CGLIBåˆ›å»ºå­ç±»ã€‚å¦‚æœä¸€ä¸ªBeançš„classæ˜¯finalï¼ŒSpringå°†æ— æ³•ä¸ºå…¶åˆ›å»ºå­ç±»ã€‚\nå¯è§ï¼Œè™½ç„¶Springå®¹å™¨å†…éƒ¨å®ç°AOPçš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼ˆéœ€è¦ä½¿ç”¨AspectJè§£ææ³¨è§£ï¼Œå¹¶é€šè¿‡CGLIBå®ç°ä»£ç†ç±»ï¼‰ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨AOPéå¸¸ç®€å•ï¼Œä¸€å…±éœ€è¦ä¸‰æ­¥ï¼š\nå®šä¹‰æ‰§è¡Œæ–¹æ³•ï¼Œå¹¶åœ¨æ–¹æ³•ä¸Šé€šè¿‡AspectJçš„æ³¨è§£å‘Šè¯‰Springåº”è¯¥åœ¨ä½•å¤„è°ƒç”¨æ­¤æ–¹æ³•ï¼› æ ‡è®°@Componentå’Œ@Aspectï¼› åœ¨@Configurationç±»ä¸Šæ ‡æ³¨@EnableAspectJAutoProxyã€‚ è‡³äºAspectJçš„æ³¨å…¥è¯­æ³•åˆ™æ¯”è¾ƒå¤æ‚ï¼Œè¯·å‚è€ƒSpringæ–‡æ¡£ã€‚\nSpringä¹Ÿæä¾›å…¶ä»–æ–¹æ³•æ¥è£…é…AOPï¼Œä½†éƒ½æ²¡æœ‰ä½¿ç”¨AspectJæ³¨è§£çš„æ–¹å¼æ¥å¾—ç®€æ´æ˜äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å†ä½œä»‹ç»ã€‚\næ‹¦æˆªå™¨ç±»å‹ é¡¾åæ€ä¹‰ï¼Œæ‹¦æˆªå™¨æœ‰ä»¥ä¸‹ç±»å‹ï¼š\n@Beforeï¼šè¿™ç§æ‹¦æˆªå™¨å…ˆæ‰§è¡Œæ‹¦æˆªä»£ç ï¼Œå†æ‰§è¡Œç›®æ ‡ä»£ç ã€‚å¦‚æœæ‹¦æˆªå™¨æŠ›å¼‚å¸¸ï¼Œé‚£ä¹ˆç›®æ ‡ä»£ç å°±ä¸æ‰§è¡Œäº†ï¼› @Afterï¼šè¿™ç§æ‹¦æˆªå™¨å…ˆæ‰§è¡Œç›®æ ‡ä»£ç ï¼Œå†æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ã€‚æ— è®ºç›®æ ‡ä»£ç æ˜¯å¦æŠ›å¼‚å¸¸ï¼Œæ‹¦æˆªå™¨ä»£ç éƒ½ä¼šæ‰§è¡Œï¼› @AfterReturningï¼šå’Œ@Afterä¸åŒçš„æ˜¯ï¼Œåªæœ‰å½“ç›®æ ‡ä»£ç æ­£å¸¸è¿”å›æ—¶ï¼Œæ‰æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ï¼› @AfterThrowingï¼šå’Œ@Afterä¸åŒçš„æ˜¯ï¼Œåªæœ‰å½“ç›®æ ‡ä»£ç æŠ›å‡ºäº†å¼‚å¸¸æ—¶ï¼Œæ‰æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ï¼› @Aroundï¼šèƒ½å®Œå…¨æ§åˆ¶ç›®æ ‡ä»£ç æ˜¯å¦æ‰§è¡Œï¼Œå¹¶å¯ä»¥åœ¨æ‰§è¡Œå‰åã€æŠ›å¼‚å¸¸åæ‰§è¡Œä»»æ„æ‹¦æˆªä»£ç ï¼Œå¯ä»¥è¯´æ˜¯åŒ…å«äº†ä¸Šé¢æ‰€æœ‰åŠŸèƒ½ã€‚ å°ç»“ åœ¨Springå®¹å™¨ä¸­ä½¿ç”¨AOPéå¸¸ç®€å•ï¼Œåªéœ€è¦å®šä¹‰æ‰§è¡Œæ–¹æ³•ï¼Œå¹¶ç”¨AspectJçš„æ³¨è§£æ ‡æ³¨åº”è¯¥åœ¨ä½•å¤„è§¦å‘å¹¶æ‰§è¡Œã€‚\nSpringé€šè¿‡CGLIBåŠ¨æ€åˆ›å»ºå­ç±»ç­‰æ–¹å¼æ¥å®ç°AOPä»£ç†æ¨¡å¼ï¼Œå¤§å¤§ç®€åŒ–äº†ä»£ç ã€‚\nä½¿ç”¨æ³¨è§£è£…é…AOP ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²è§£äº†ä½¿ç”¨AspectJçš„æ³¨è§£ï¼Œå¹¶é…åˆä¸€ä¸ªå¤æ‚çš„execution(* xxx.Xyz.*(..))è¯­æ³•æ¥å®šä¹‰åº”è¯¥å¦‚ä½•è£…é…AOPã€‚\nåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™ç§å†™æ³•å…¶å®å¾ˆå°‘ä½¿ç”¨ã€‚å‡è®¾ä½ å†™äº†ä¸€ä¸ªSecurityAspectï¼š\n1 2 3 4 5 6 7 8 9 10 @Aspect @Component public class SecurityAspect { @Before(\"execution(public * com.itranswarp.learnjava.service.*.*(..))\") public void check() { if (SecurityContext.getCurrentUser() == null) { throw new RuntimeException(\"check failed\"); } } } åŸºæœ¬èƒ½å®ç°æ— å·®åˆ«å…¨è¦†ç›–ï¼Œå³æŸä¸ªåŒ…ä¸‹é¢çš„æ‰€æœ‰Beançš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè¢«è¿™ä¸ªcheck()æ–¹æ³•æ‹¦æˆªã€‚\nè¿˜æœ‰çš„ç«¥é‹å–œæ¬¢ç”¨æ–¹æ³•åå‰ç¼€è¿›è¡Œæ‹¦æˆªï¼š\n1 2 3 4 5 6 7 8 @Around(\"execution(public * update*(..))\") public Object doLogging(ProceedingJoinPoint pjp) throws Throwable { // å¯¹updateå¼€å¤´çš„æ–¹æ³•åˆ‡æ¢æ•°æ®æº: String old = setCurrentDataSource(\"master\"); Object retVal = pjp.proceed(); restoreCurrentDataSource(old); return retVal; } è¿™ç§éç²¾å‡†æ‰“å‡»è¯¯ä¼¤é¢æ›´å¤§ï¼Œå› ä¸ºä»æ–¹æ³•å‰ç¼€åŒºåˆ†æ˜¯å¦æ˜¯æ•°æ®åº“æ“ä½œæ˜¯éå¸¸ä¸å¯å–çš„ã€‚\næˆ‘ä»¬åœ¨ä½¿ç”¨AOPæ—¶ï¼Œè¦æ³¨æ„åˆ°è™½ç„¶Springå®¹å™¨å¯ä»¥æŠŠæŒ‡å®šçš„æ–¹æ³•é€šè¿‡AOPè§„åˆ™è£…é…åˆ°æŒ‡å®šçš„Beançš„æŒ‡å®šæ–¹æ³•å‰åï¼Œä½†æ˜¯ï¼Œå¦‚æœè‡ªåŠ¨è£…é…æ—¶ï¼Œå› ä¸ºä¸æ°å½“çš„èŒƒå›´ï¼Œå®¹æ˜“å¯¼è‡´æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œå³å¾ˆå¤šä¸éœ€è¦AOPä»£ç†çš„Beanä¹Ÿè¢«è‡ªåŠ¨ä»£ç†äº†ï¼Œå¹¶ä¸”ï¼Œåç»­æ–°å¢çš„Beanï¼Œå¦‚æœä¸æ¸…æ¥šç°æœ‰çš„AOPè£…é…è§„åˆ™ï¼Œå®¹æ˜“è¢«å¼ºè¿«è£…é…ã€‚\nä½¿ç”¨AOPæ—¶ï¼Œè¢«è£…é…çš„Beanæœ€å¥½è‡ªå·±èƒ½æ¸…æ¸…æ¥šæ¥šåœ°çŸ¥é“è‡ªå·±è¢«å®‰æ’äº†ã€‚ä¾‹å¦‚ï¼ŒSpringæä¾›çš„@Transactionalå°±æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¾‹å­ã€‚å¦‚æœæˆ‘ä»¬è‡ªå·±å†™çš„Beanå¸Œæœ›åœ¨ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ä¸­è¢«è°ƒç”¨ï¼Œå°±æ ‡æ³¨ä¸Š@Transactionalï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Component public class UserService { // æœ‰äº‹åŠ¡: @Transactional public User createUser(String name) { ... } // æ— äº‹åŠ¡: public boolean isValidName(String name) { ... } // æœ‰äº‹åŠ¡: @Transactional public void updateUser(User user) { ... } } æˆ–è€…ç›´æ¥åœ¨classçº§åˆ«æ³¨è§£ï¼Œè¡¨ç¤ºâ€œæ‰€æœ‰publicæ–¹æ³•éƒ½è¢«å®‰æ’äº†â€ï¼š\n1 2 3 4 5 @Component @Transactional public class UserService { ... } é€šè¿‡@Transactionalï¼ŒæŸä¸ªæ–¹æ³•æ˜¯å¦å¯ç”¨äº†äº‹åŠ¡å°±ä¸€æ¸…äºŒæ¥šäº†ã€‚å› æ­¤ï¼Œè£…é…AOPçš„æ—¶å€™ï¼Œä½¿ç”¨æ³¨è§£æ˜¯æœ€å¥½çš„æ–¹å¼ã€‚\næˆ‘ä»¬ä»¥ä¸€ä¸ªå®é™…ä¾‹å­æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨æ³¨è§£å®ç°AOPè£…é…ã€‚ä¸ºäº†ç›‘æ§åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ€§èƒ½ç›‘æ§çš„æ³¨è§£ï¼š\n1 2 3 4 5 @Target(METHOD) @Retention(RUNTIME) public @interface MetricTime { String value(); } åœ¨éœ€è¦è¢«ç›‘æ§çš„å…³é”®æ–¹æ³•ä¸Šæ ‡æ³¨è¯¥æ³¨è§£ï¼š\n1 2 3 4 5 6 7 8 9 @Component public class UserService { // ç›‘æ§register()æ–¹æ³•æ€§èƒ½: @MetricTime(\"register\") public User register(String email, String password, String name) { ... } ... } ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰MetricAspectï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Aspect @Component public class MetricAspect { @Around(\"@annotation(metricTime)\") public Object metric(ProceedingJoinPoint joinPoint, MetricTime metricTime) throws Throwable { String name = metricTime.value(); long start = System.currentTimeMillis(); try { return joinPoint.proceed(); } finally { long t = System.currentTimeMillis() - start; // å†™å…¥æ—¥å¿—æˆ–å‘é€è‡³JMX: System.err.println(\"[Metrics] \" + name + \": \" + t + \"ms\"); } } } æ³¨æ„metric()æ–¹æ³•æ ‡æ³¨äº†@Around(\"@annotation(metricTime)\")ï¼Œå®ƒçš„æ„æ€æ˜¯ï¼Œç¬¦åˆæ¡ä»¶çš„ç›®æ ‡æ–¹æ³•æ˜¯å¸¦æœ‰@MetricTimeæ³¨è§£çš„æ–¹æ³•ï¼Œå› ä¸ºmetric()æ–¹æ³•å‚æ•°ç±»å‹æ˜¯MetricTimeï¼ˆæ³¨æ„å‚æ•°åæ˜¯metricTimeä¸æ˜¯MetricTimeï¼‰ï¼Œæˆ‘ä»¬é€šè¿‡å®ƒè·å–æ€§èƒ½ç›‘æ§çš„åç§°ã€‚\næœ‰äº†@MetricTimeæ³¨è§£ï¼Œå†é…åˆMetricAspectï¼Œä»»ä½•Beanï¼Œåªè¦æ–¹æ³•æ ‡æ³¨äº†@MetricTimeæ³¨è§£ï¼Œå°±å¯ä»¥è‡ªåŠ¨å®ç°æ€§èƒ½ç›‘æ§ã€‚è¿è¡Œä»£ç ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š\n1 2 Welcome, Bob! [Metrics] register: 16ms å°ç»“ ä½¿ç”¨æ³¨è§£å®ç°AOPéœ€è¦å…ˆå®šä¹‰æ³¨è§£ï¼Œç„¶åä½¿ç”¨@Around(\"@annotation(name)\")å®ç°è£…é…ï¼›\nä½¿ç”¨æ³¨è§£æ—¢ç®€å•ï¼Œåˆèƒ½æ˜ç¡®æ ‡è¯†AOPè£…é…ï¼Œæ˜¯ä½¿ç”¨AOPæ¨èçš„æ–¹å¼ã€‚\nAOPé¿å‘æŒ‡å— æ— è®ºæ˜¯ä½¿ç”¨AspectJè¯­æ³•ï¼Œè¿˜æ˜¯é…åˆAnnotationï¼Œä½¿ç”¨AOPï¼Œå®é™…ä¸Šå°±æ˜¯è®©Springè‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªProxyï¼Œä½¿å¾—è°ƒç”¨æ–¹èƒ½æ— æ„ŸçŸ¥åœ°è°ƒç”¨æŒ‡å®šæ–¹æ³•ï¼Œä½†è¿è¡ŒæœŸå´åŠ¨æ€â€œç»‡å…¥â€äº†å…¶ä»–é€»è¾‘ï¼Œå› æ­¤ï¼ŒAOPæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªä»£ç†æ¨¡å¼ã€‚\nå› ä¸ºSpringä½¿ç”¨äº†CGLIBæ¥å®ç°è¿è¡ŒæœŸåŠ¨æ€åˆ›å»ºProxyï¼Œå¦‚æœæˆ‘ä»¬æ²¡èƒ½æ·±å…¥ç†è§£å…¶è¿è¡ŒåŸç†å’Œå®ç°æœºåˆ¶ï¼Œå°±ææœ‰å¯èƒ½é‡åˆ°å„ç§è¯¡å¼‚çš„é—®é¢˜ã€‚\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ã€‚\nå‡è®¾æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªUserServiceçš„Beanï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @Component public class UserService { // æˆå‘˜å˜é‡: public final ZoneId zoneId = ZoneId.systemDefault(); // æ„é€ æ–¹æ³•: public UserService() { System.out.println(\"UserService(): init...\"); System.out.println(\"UserService(): zoneId = \" + this.zoneId); } // publicæ–¹æ³•: public ZoneId getZoneId() { return zoneId; } // public finalæ–¹æ³•: public final ZoneId getFinalZoneId() { return zoneId; } } å†å†™ä¸ªMailServiceï¼Œå¹¶æ³¨å…¥UserServiceï¼š\n1 2 3 4 5 6 7 8 9 10 11 @Component public class MailService { @Autowired UserService userService; public String sendMail() { ZoneId zoneId = userService.zoneId; String dt = ZonedDateTime.now(zoneId).toString(); return \"Hello, it is \" + dt; } } æœ€åç”¨main()æ–¹æ³•æµ‹è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 @Configuration @ComponentScan public class AppConfig { public static void main(String[] args) { ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class); MailService mailService = context.getBean(MailService.class); System.out.println(mailService.sendMail()); } } æŸ¥çœ‹è¾“å‡ºï¼Œä¸€åˆ‡æ­£å¸¸ï¼š\n1 2 3 UserService(): init... UserService(): zoneId = Asia/Shanghai Hello, it is 2020-04-12T10:23:22.917721+08:00[Asia/Shanghai] ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬ç»™UserServiceåŠ ä¸ŠAOPæ”¯æŒï¼Œå°±æ·»åŠ ä¸€ä¸ªæœ€ç®€å•çš„LoggingAspectï¼š\n1 2 3 4 5 6 7 8 @Aspect @Component public class LoggingAspect { @Before(\"execution(public * com..*.UserService.*(..))\") public void doAccessCheck() { System.err.println(\"[Before] do access check...\"); } } åˆ«å¿˜äº†åœ¨AppConfigä¸ŠåŠ ä¸Š@EnableAspectJAutoProxyã€‚å†æ¬¡è¿è¡Œï¼Œä¸å‡ºæ„å¤–çš„è¯ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªNullPointerExceptionï¼š\n1 2 3 4 5 6 Exception in thread \"main\" java.lang.NullPointerException: zone at java.base/java.util.Objects.requireNonNull(Objects.java:246) at java.base/java.time.Clock.system(Clock.java:203) at java.base/java.time.ZonedDateTime.now(ZonedDateTime.java:216) at com.itranswarp.learnjava.service.MailService.sendMail(MailService.java:19) at com.itranswarp.learnjava.AppConfig.main(AppConfig.java:21) ä»”ç»†è·Ÿè¸ªä»£ç ï¼Œä¼šå‘ç°nullå€¼å‡ºç°åœ¨MailService.sendMail()å†…éƒ¨çš„è¿™ä¸€è¡Œä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 @Component public class MailService { @Autowired UserService userService; public String sendMail() { ZoneId zoneId = userService.zoneId; System.out.println(zoneId); // null ... } } æˆ‘ä»¬è¿˜æ•…æ„åœ¨UserServiceä¸­ç‰¹æ„ç”¨finalä¿®é¥°äº†ä¸€ä¸‹æˆå‘˜å˜é‡ï¼š\n1 2 3 4 5 @Component public class UserService { public final ZoneId zoneId = ZoneId.systemDefault(); ... } ç”¨finalæ ‡æ³¨çš„æˆå‘˜å˜é‡ä¸ºnullï¼Ÿé€—æˆ‘å‘¢ï¼Ÿ\næ€ä¹ˆå›äº‹ï¼Ÿ ä¸ºä»€ä¹ˆåŠ äº†AOPå°±æŠ¥NPEï¼Œå»äº†AOPå°±ä¸€åˆ‡æ­£å¸¸ï¼Ÿfinalå­—æ®µä¸æ‰§è¡Œï¼Œéš¾é“JVMæœ‰é—®é¢˜ï¼Ÿä¸ºäº†è§£ç­”è¿™ä¸ªè¯¡å¼‚çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ·±å…¥ç†è§£Springä½¿ç”¨CGLIBç”ŸæˆProxyçš„åŸç†ï¼š\nç¬¬ä¸€æ­¥ï¼Œæ­£å¸¸åˆ›å»ºä¸€ä¸ªUserServiceçš„åŸå§‹å®ä¾‹ï¼Œè¿™æ˜¯é€šè¿‡åå°„è°ƒç”¨æ„é€ æ–¹æ³•å®ç°çš„ï¼Œå®ƒçš„è¡Œä¸ºå’Œæˆ‘ä»¬é¢„æœŸçš„å®Œå…¨ä¸€è‡´ï¼›\nç¬¬äºŒæ­¥ï¼Œé€šè¿‡CGLIBåˆ›å»ºä¸€ä¸ªUserServiceçš„å­ç±»ï¼Œå¹¶å¼•ç”¨äº†åŸå§‹å®ä¾‹å’ŒLoggingAspectï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 public UserService$$EnhancerBySpringCGLIB extends UserService { UserService target; LoggingAspect aspect; public UserService$$EnhancerBySpringCGLIB() { } public ZoneId getZoneId() { aspect.doAccessCheck(); return target.getZoneId(); } } å¦‚æœæˆ‘ä»¬è§‚å¯ŸSpringåˆ›å»ºçš„AOPä»£ç†ï¼Œå®ƒçš„ç±»åæ€»æ˜¯ç±»ä¼¼UserService$$EnhancerBySpringCGLIB$$1c76af9dï¼ˆä½ æ²¡çœ‹é”™ï¼ŒJavaçš„ç±»åå®é™…ä¸Šå…è®¸$å­—ç¬¦ï¼‰ã€‚ä¸ºäº†è®©è°ƒç”¨æ–¹è·å¾—UserServiceçš„å¼•ç”¨ï¼Œå®ƒå¿…é¡»ç»§æ‰¿è‡ªUserServiceã€‚ç„¶åï¼Œè¯¥ä»£ç†ç±»ä¼šè¦†å†™æ‰€æœ‰publicå’Œprotectedæ–¹æ³•ï¼Œå¹¶åœ¨å†…éƒ¨å°†è°ƒç”¨å§”æ‰˜ç»™åŸå§‹çš„UserServiceå®ä¾‹ã€‚\nè¿™é‡Œå‡ºç°äº†ä¸¤ä¸ªUserServiceå®ä¾‹ï¼š\nä¸€ä¸ªæ˜¯æˆ‘ä»¬ä»£ç ä¸­å®šä¹‰çš„åŸå§‹å®ä¾‹ï¼Œå®ƒçš„æˆå‘˜å˜é‡å·²ç»æŒ‰ç…§æˆ‘ä»¬é¢„æœŸçš„æ–¹å¼è¢«åˆå§‹åŒ–å®Œæˆï¼š\n1 UserService original = new UserService(); ç¬¬äºŒä¸ªUserServiceå®ä¾‹å®é™…ä¸Šç±»å‹æ˜¯UserService$$EnhancerBySpringCGLIBï¼Œå®ƒå¼•ç”¨äº†åŸå§‹çš„UserServiceå®ä¾‹ï¼š\n1 2 3 UserService$$EnhancerBySpringCGLIB proxy = new UserService$$EnhancerBySpringCGLIB(); proxy.target = original; proxy.aspect = ... æ³¨æ„åˆ°è¿™ç§æƒ…å†µä»…å‡ºç°åœ¨å¯ç”¨äº†AOPçš„æƒ…å†µï¼Œæ­¤åˆ»ï¼Œä»ApplicationContextä¸­è·å–çš„UserServiceå®ä¾‹æ˜¯proxyï¼Œæ³¨å…¥åˆ°MailServiceä¸­çš„UserServiceå®ä¾‹ä¹Ÿæ˜¯proxyã€‚\né‚£ä¹ˆæœ€ç»ˆçš„é—®é¢˜æ¥äº†ï¼šproxyå®ä¾‹çš„æˆå‘˜å˜é‡ï¼Œä¹Ÿå°±æ˜¯ä»UserServiceç»§æ‰¿çš„zoneIdï¼Œå®ƒçš„å€¼æ˜¯nullã€‚\nåŸå› åœ¨äºï¼ŒUserServiceæˆå‘˜å˜é‡çš„åˆå§‹åŒ–ï¼š\n1 2 3 4 public class UserService { public final ZoneId zoneId = ZoneId.systemDefault(); ... } åœ¨UserService$$EnhancerBySpringCGLIBä¸­ï¼Œå¹¶æœªæ‰§è¡Œã€‚åŸå› æ˜¯ï¼Œæ²¡å¿…è¦åˆå§‹åŒ–proxyçš„æˆå‘˜å˜é‡ï¼Œå› ä¸ºproxyçš„ç›®çš„æ˜¯ä»£ç†æ–¹æ³•ã€‚\nå®é™…ä¸Šï¼Œæˆå‘˜å˜é‡çš„åˆå§‹åŒ–æ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­å®Œæˆçš„ã€‚è¿™æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„ä»£ç ï¼š\n1 2 3 4 5 public class UserService { public final ZoneId zoneId = ZoneId.systemDefault(); public UserService() { } } è¿™æ˜¯ç¼–è¯‘å™¨å®é™…ç¼–è¯‘çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 public class UserService { public final ZoneId zoneId; public UserService() { super(); // æ„é€ æ–¹æ³•çš„ç¬¬ä¸€è¡Œä»£ç æ€»æ˜¯è°ƒç”¨super() zoneId = ZoneId.systemDefault(); // ç»§ç»­åˆå§‹åŒ–æˆå‘˜å˜é‡ } } ç„¶è€Œï¼Œå¯¹äºSpringé€šè¿‡CGLIBåŠ¨æ€åˆ›å»ºçš„UserService$$EnhancerBySpringCGLIBä»£ç†ç±»ï¼Œå®ƒçš„æ„é€ æ–¹æ³•ä¸­ï¼Œå¹¶æœªè°ƒç”¨super()ï¼Œå› æ­¤ï¼Œä»çˆ¶ç±»ç»§æ‰¿çš„æˆå‘˜å˜é‡ï¼ŒåŒ…æ‹¬finalç±»å‹çš„æˆå‘˜å˜é‡ï¼Œç»Ÿç»Ÿéƒ½æ²¡æœ‰åˆå§‹åŒ–ã€‚\næœ‰çš„ç«¥é‹ä¼šé—®ï¼šJavaè¯­è¨€è§„å®šï¼Œä»»ä½•ç±»çš„æ„é€ æ–¹æ³•ï¼Œç¬¬ä¸€è¡Œå¿…é¡»è°ƒç”¨super()ï¼Œå¦‚æœæ²¡æœ‰ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åŠ ä¸Šï¼Œæ€ä¹ˆSpringçš„CGLIBå°±å¯ä»¥æç‰¹æ®Šï¼Ÿ\nè¿™æ˜¯å› ä¸ºè‡ªåŠ¨åŠ super()çš„åŠŸèƒ½æ˜¯Javaç¼–è¯‘å™¨å®ç°çš„ï¼Œå®ƒå‘ç°ä½ æ²¡åŠ ï¼Œå°±è‡ªåŠ¨ç»™åŠ ä¸Šï¼Œå‘ç°ä½ åŠ é”™äº†ï¼Œå°±æŠ¥ç¼–è¯‘é”™è¯¯ã€‚ä½†å®é™…ä¸Šï¼Œå¦‚æœç›´æ¥æ„é€ å­—èŠ‚ç ï¼Œä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ä¸­ï¼Œä¸ä¸€å®šéè¦è°ƒç”¨super()ã€‚Springä½¿ç”¨CGLIBæ„é€ çš„Proxyç±»ï¼Œæ˜¯ç›´æ¥ç”Ÿæˆå­—èŠ‚ç ï¼Œå¹¶æ²¡æœ‰æºç -ç¼–è¯‘-å­—èŠ‚ç è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤ï¼š\nSpringé€šè¿‡CGLIBåˆ›å»ºçš„ä»£ç†ç±»ï¼Œä¸ä¼šåˆå§‹åŒ–ä»£ç†ç±»è‡ªèº«ç»§æ‰¿çš„ä»»ä½•æˆå‘˜å˜é‡ï¼ŒåŒ…æ‹¬finalç±»å‹çš„æˆå‘˜å˜é‡ï¼\nå†è€ƒå¯ŸMailServiceçš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 @Component public class MailService { @Autowired UserService userService; public String sendMail() { ZoneId zoneId = userService.zoneId; System.out.println(zoneId); // null ... } } å¦‚æœæ²¡æœ‰å¯ç”¨AOPï¼Œæ³¨å…¥çš„æ˜¯åŸå§‹çš„UserServiceå®ä¾‹ï¼Œé‚£ä¹ˆä¸€åˆ‡æ­£å¸¸ï¼Œå› ä¸ºUserServiceå®ä¾‹çš„zoneIdå­—æ®µå·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–äº†ã€‚\nå¦‚æœå¯åŠ¨äº†AOPï¼Œæ³¨å…¥çš„æ˜¯ä»£ç†åçš„UserService$$EnhancerBySpringCGLIBå®ä¾‹ï¼Œé‚£ä¹ˆé—®é¢˜å¤§äº†ï¼šè·å–çš„UserService$$EnhancerBySpringCGLIBå®ä¾‹çš„zoneIdå­—æ®µï¼Œæ°¸è¿œä¸ºnullã€‚\né‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šå¯ç”¨äº†AOPï¼Œå¦‚ä½•ä¿®å¤ï¼Ÿ\nä¿®å¤å¾ˆç®€å•ï¼Œåªéœ€è¦æŠŠç›´æ¥è®¿é—®å­—æ®µçš„ä»£ç ï¼Œæ”¹ä¸ºé€šè¿‡æ–¹æ³•è®¿é—®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 @Component public class MailService { @Autowired UserService userService; public String sendMail() { // ä¸è¦ç›´æ¥è®¿é—®UserServiceçš„å­—æ®µ: ZoneId zoneId = userService.getZoneId(); ... } } æ— è®ºæ³¨å…¥çš„UserServiceæ˜¯åŸå§‹å®ä¾‹è¿˜æ˜¯ä»£ç†å®ä¾‹ï¼ŒgetZoneId()éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œå› ä¸ºä»£ç†ç±»ä¼šè¦†å†™getZoneId()æ–¹æ³•ï¼Œå¹¶å°†å…¶å§”æ‰˜ç»™åŸå§‹å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 public UserService$$EnhancerBySpringCGLIB extends UserService { UserService target = ... ... public ZoneId getZoneId() { return target.getZoneId(); } } æ³¨æ„åˆ°æˆ‘ä»¬è¿˜ç»™UserServiceæ·»åŠ äº†ä¸€ä¸ªpublic+finalçš„æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 @Component public class UserService { ... public final ZoneId getFinalZoneId() { return zoneId; } } å¦‚æœåœ¨MailServiceä¸­ï¼Œè°ƒç”¨çš„ä¸æ˜¯getZoneId()ï¼Œè€Œæ˜¯getFinalZoneId()ï¼Œåˆä¼šå‡ºç°NullPointerExceptionï¼Œè¿™æ˜¯å› ä¸ºï¼Œä»£ç†ç±»æ— æ³•è¦†å†™finalæ–¹æ³•ï¼ˆè¿™ä¸€ç‚¹ç»•ä¸è¿‡JVMçš„ClassLoaderæ£€æŸ¥ï¼‰ï¼Œè¯¥æ–¹æ³•è¿”å›çš„æ˜¯ä»£ç†ç±»çš„zoneIdå­—æ®µï¼Œå³nullã€‚\nå®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬åŠ ä¸Šæ—¥å¿—ï¼ŒSpringåœ¨å¯åŠ¨æ—¶ä¼šæ‰“å°ä¸€ä¸ªè­¦å‘Šï¼š\n1 10:43:09.929 [main] DEBUG org.springframework.aop.framework.CglibAopProxy - Final method [public final java.time.ZoneId xxx.UserService.getFinalZoneId()] cannot get proxied via CGLIB: Calls to this method will NOT be routed to the target instance and might lead to NPEs against uninitialized fields in the proxy instance. ä¸Šé¢çš„æ—¥å¿—å¤§æ„å°±æ˜¯ï¼Œå› ä¸ºè¢«ä»£ç†çš„UserServiceæœ‰ä¸€ä¸ªfinalæ–¹æ³•getFinalZoneId()ï¼Œè¿™ä¼šå¯¼è‡´å…¶ä»–Beanå¦‚æœè°ƒç”¨æ­¤æ–¹æ³•ï¼Œæ— æ³•å°†å…¶ä»£ç†åˆ°çœŸæ­£çš„åŸå§‹å®ä¾‹ï¼Œä»è€Œå¯èƒ½å‘ç”ŸNPEå¼‚å¸¸ã€‚\nå› æ­¤ï¼Œæ­£ç¡®ä½¿ç”¨AOPï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé¿å‘æŒ‡å—ï¼š\nè®¿é—®è¢«æ³¨å…¥çš„Beanæ—¶ï¼Œæ€»æ˜¯è°ƒç”¨æ–¹æ³•è€Œéç›´æ¥è®¿é—®å­—æ®µï¼› ç¼–å†™Beanæ—¶ï¼Œå¦‚æœå¯èƒ½ä¼šè¢«ä»£ç†ï¼Œå°±ä¸è¦ç¼–å†™public finalæ–¹æ³•ã€‚ è¿™æ ·æ‰èƒ½ä¿è¯æœ‰æ²¡æœ‰AOPï¼Œä»£ç éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚\næ€è€ƒ ä¸ºä»€ä¹ˆSpringåˆ»æ„ä¸åˆå§‹åŒ–Proxyç»§æ‰¿çš„å­—æ®µï¼Ÿ\nå¦‚æœä¸€ä¸ªBeanä¸å…è®¸ä»»ä½•AOPä»£ç†ï¼Œåº”è¯¥æ€ä¹ˆåšæ¥â€œä¿æŠ¤â€è‡ªå·±åœ¨è¿è¡ŒæœŸä¸ä¼šè¢«ä»£ç†ï¼Ÿ\nå°ç»“ ç”±äºSpringé€šè¿‡CGLIBå®ç°ä»£ç†ç±»ï¼Œæˆ‘ä»¬è¦é¿å…ç›´æ¥è®¿é—®Beançš„å­—æ®µï¼Œä»¥åŠç”±finalæ–¹æ³•å¸¦æ¥çš„â€œæœªä»£ç†â€é—®é¢˜ã€‚\né‡åˆ°CglibAopProxyçš„ç›¸å…³æ—¥å¿—ï¼ŒåŠ¡å¿…è¦ä»”ç»†æ£€æŸ¥ï¼Œé˜²æ­¢å› ä¸ºAOPå‡ºç°NPEå¼‚å¸¸ã€‚\n",
  "wordCount" : "8945",
  "inLanguage": "en",
  "datePublished": "2020-01-02T16:21:14Z",
  "dateModified": "2020-01-02T16:21:14Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://wjy6.netlify.app/posts/spring/2aop/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://wjy6.netlify.app/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://wjy6.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://wjy6.netlify.app/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://wjy6.netlify.app/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://wjy6.netlify.app/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://wjy6.netlify.app/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://wjy6.netlify.app/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://wjy6.netlify.app/">Home</a>&nbsp;Â»&nbsp;<a href="https://wjy6.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      2ã€AOP
    </h1>
    <div class="post-meta"><span title='2020-01-02 16:21:14 +0000 UTC'>2020-01-02</span>&nbsp;Â·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8aop" aria-label="ä½¿ç”¨AOP">ä½¿ç”¨AOP</a></li>
                <li>
                    <a href="#%e8%a3%85%e9%85%8daop" aria-label="è£…é…AOP">è£…é…AOP</a><ul>
                        
                <li>
                    <a href="#%e6%8b%a6%e6%88%aa%e5%99%a8%e7%b1%bb%e5%9e%8b" aria-label="æ‹¦æˆªå™¨ç±»å‹">æ‹¦æˆªå™¨ç±»å‹</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93" aria-label="å°ç»“">å°ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e6%b3%a8%e8%a7%a3%e8%a3%85%e9%85%8daop" aria-label="ä½¿ç”¨æ³¨è§£è£…é…AOP">ä½¿ç”¨æ³¨è§£è£…é…AOP</a><ul>
                        
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93-1" aria-label="å°ç»“">å°ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#aop%e9%81%bf%e5%9d%91%e6%8c%87%e5%8d%97" aria-label="AOPé¿å‘æŒ‡å—">AOPé¿å‘æŒ‡å—</a><ul>
                        
                <li>
                    <a href="#%e6%80%8e%e4%b9%88%e5%9b%9e%e4%ba%8b" aria-label="æ€ä¹ˆå›äº‹ï¼Ÿ">æ€ä¹ˆå›äº‹ï¼Ÿ</a></li>
                <li>
                    <a href="#%e6%80%9d%e8%80%83" aria-label="æ€è€ƒ">æ€è€ƒ</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93-2" aria-label="å°ç»“">å°ç»“</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="ä½¿ç”¨aop">ä½¿ç”¨AOP<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨aop">#</a></h1>
<p>AOPæ˜¯Aspect Oriented Programmingï¼Œå³é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚</p>
<p>é‚£ä»€ä¹ˆæ˜¯AOPï¼Ÿ</p>
<p>æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹OOPï¼šObject Oriented Programmingï¼ŒOOPä½œä¸ºé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ¨¡å¼ï¼Œè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼ŒOOPçš„ä¸»è¦åŠŸèƒ½æ˜¯æ•°æ®å°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚</p>
<p>è€ŒAOPæ˜¯ä¸€ç§æ–°çš„ç¼–ç¨‹æ–¹å¼ï¼Œå®ƒå’ŒOOPä¸åŒï¼ŒOOPæŠŠç³»ç»Ÿçœ‹ä½œå¤šä¸ªå¯¹è±¡çš„äº¤äº’ï¼ŒAOPæŠŠç³»ç»Ÿåˆ†è§£ä¸ºä¸åŒçš„å…³æ³¨ç‚¹ï¼Œæˆ–è€…ç§°ä¹‹ä¸ºåˆ‡é¢ï¼ˆAspectï¼‰ã€‚</p>
<p>è¦ç†è§£AOPçš„æ¦‚å¿µï¼Œæˆ‘ä»¬å…ˆç”¨OOPä¸¾ä¾‹ï¼Œæ¯”å¦‚ä¸€ä¸ªä¸šåŠ¡ç»„ä»¶<code>BookService</code>ï¼Œå®ƒæœ‰å‡ ä¸ªä¸šåŠ¡æ–¹æ³•ï¼š</p>
<ul>
<li>createBookï¼šæ·»åŠ æ–°çš„Bookï¼›</li>
<li>updateBookï¼šä¿®æ”¹Bookï¼›</li>
<li>deleteBookï¼šåˆ é™¤Bookã€‚</li>
</ul>
<p>å¯¹æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ï¼Œä¾‹å¦‚ï¼Œ<code>createBook()</code>ï¼Œé™¤äº†ä¸šåŠ¡é€»è¾‘ï¼Œè¿˜éœ€è¦å®‰å…¨æ£€æŸ¥ã€æ—¥å¿—è®°å½•å’Œäº‹åŠ¡å¤„ç†ï¼Œå®ƒçš„ä»£ç åƒè¿™æ ·ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BookService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> createBook(Book book) {
</span></span><span style="display:flex;"><span>        securityCheck();
</span></span><span style="display:flex;"><span>        Transaction tx = startTransaction();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// æ ¸å¿ƒä¸šåŠ¡é€»è¾‘</span>
</span></span><span style="display:flex;"><span>            tx.<span style="color:#007f7f">commit</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (RuntimeException e) {
</span></span><span style="display:flex;"><span>            tx.<span style="color:#007f7f">rollback</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> e;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        log(<span style="color:#0ff;font-weight:bold">&#34;created book: &#34;</span> + book);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç»§ç»­ç¼–å†™<code>updateBook()</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BookService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> updateBook(Book book) {
</span></span><span style="display:flex;"><span>        securityCheck();
</span></span><span style="display:flex;"><span>        Transaction tx = startTransaction();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// æ ¸å¿ƒä¸šåŠ¡é€»è¾‘</span>
</span></span><span style="display:flex;"><span>            tx.<span style="color:#007f7f">commit</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (RuntimeException e) {
</span></span><span style="display:flex;"><span>            tx.<span style="color:#007f7f">rollback</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> e;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        log(<span style="color:#0ff;font-weight:bold">&#34;updated book: &#34;</span> + book);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äºå®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰ä»£ç ï¼Œå®ƒä»¬ä¼šé‡å¤å‡ºç°åœ¨æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­ã€‚ä½¿ç”¨OOPï¼Œæˆ‘ä»¬å¾ˆéš¾å°†è¿™äº›å››å¤„åˆ†æ•£çš„ä»£ç æ¨¡å—åŒ–ã€‚</p>
<p>è€ƒå¯Ÿä¸šåŠ¡æ¨¡å‹å¯ä»¥å‘ç°ï¼Œ<code>BookService</code>å…³å¿ƒçš„æ˜¯è‡ªèº«çš„æ ¸å¿ƒé€»è¾‘ï¼Œä½†æ•´ä¸ªç³»ç»Ÿè¿˜è¦æ±‚å…³æ³¨å®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½å®é™…ä¸Šâ€œæ¨ªè·¨â€å¤šä¸ªä¸šåŠ¡æ–¹æ³•ï¼Œä¸ºäº†å®ç°è¿™äº›åŠŸèƒ½ï¼Œä¸å¾—ä¸åœ¨æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸Šé‡å¤ç¼–å†™ä»£ç ã€‚</p>
<p>ä¸€ç§å¯è¡Œçš„æ–¹å¼æ˜¯ä½¿ç”¨<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1281319432618017">Proxyæ¨¡å¼</a>ï¼Œå°†æŸä¸ªåŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œæƒé™æ£€æŸ¥ï¼Œæ”¾å…¥Proxyä¸­ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecurityCheckBookService <span style="color:#fff;font-weight:bold">implements</span> BookService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> BookService target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SecurityCheckBookService(BookService target) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> createBook(Book book) {
</span></span><span style="display:flex;"><span>        securityCheck();
</span></span><span style="display:flex;"><span>        target.<span style="color:#007f7f">createBook</span>(book);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> updateBook(Book book) {
</span></span><span style="display:flex;"><span>        securityCheck();
</span></span><span style="display:flex;"><span>        target.<span style="color:#007f7f">updateBook</span>(book);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> deleteBook(Book book) {
</span></span><span style="display:flex;"><span>        securityCheck();
</span></span><span style="display:flex;"><span>        target.<span style="color:#007f7f">deleteBook</span>(book);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">void</span> securityCheck() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œå¿…é¡»å…ˆæŠ½å–æ¥å£ï¼Œç„¶åï¼Œé’ˆå¯¹æ¯ä¸ªæ–¹æ³•å®ç°Proxyã€‚</p>
<p>å¦ä¸€ç§æ–¹æ³•æ˜¯ï¼Œæ—¢ç„¶<code>SecurityCheckBookService</code>çš„ä»£ç éƒ½æ˜¯æ ‡å‡†çš„Proxyæ ·æ¿ä»£ç ï¼Œä¸å¦‚æŠŠæƒé™æ£€æŸ¥è§†ä½œä¸€ç§åˆ‡é¢ï¼ˆAspectï¼‰ï¼ŒæŠŠæ—¥å¿—ã€äº‹åŠ¡ä¹Ÿè§†ä¸ºåˆ‡é¢ï¼Œç„¶åï¼Œä»¥æŸç§è‡ªåŠ¨åŒ–çš„æ–¹å¼ï¼ŒæŠŠåˆ‡é¢ç»‡å…¥åˆ°æ ¸å¿ƒé€»è¾‘ä¸­ï¼Œå®ç°Proxyæ¨¡å¼ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬ä»¥AOPçš„è§†è§’æ¥ç¼–å†™ä¸Šè¿°ä¸šåŠ¡ï¼Œå¯ä»¥ä¾æ¬¡å®ç°ï¼š</p>
<ol>
<li>æ ¸å¿ƒé€»è¾‘ï¼Œå³BookServiceï¼›</li>
<li>åˆ‡é¢é€»è¾‘ï¼Œå³ï¼š
<ol>
<li>æƒé™æ£€æŸ¥çš„Aspectï¼›</li>
<li>æ—¥å¿—çš„Aspectï¼›</li>
<li>äº‹åŠ¡çš„Aspectã€‚</li>
</ol>
</li>
</ol>
<p>ç„¶åï¼Œä»¥æŸç§æ–¹å¼ï¼Œè®©æ¡†æ¶æ¥æŠŠä¸Šè¿°3ä¸ªAspectä»¥Proxyçš„æ–¹å¼â€œç»‡å…¥â€åˆ°<code>BookService</code>ä¸­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±ä¸å¿…ç¼–å†™å¤æ‚è€Œå†—é•¿çš„Proxyæ¨¡å¼ã€‚</p>
<p><strong>AOP çš„åŸç†</strong></p>
<p>å¦‚ä½•æŠŠåˆ‡é¢ç»‡å…¥åˆ°æ ¸å¿ƒé€»è¾‘ä¸­ï¼Ÿè¿™æ­£æ˜¯AOPéœ€è¦è§£å†³çš„é—®é¢˜ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯è·å¾—äº†<code>BookService</code>çš„å¼•ç”¨ï¼Œå½“è°ƒç”¨<code>bookService.createBook()</code>æ—¶ï¼Œå¦‚ä½•å¯¹è°ƒç”¨æ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œå¹¶åœ¨æ‹¦æˆªå‰åè¿›è¡Œå®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰å¤„ç†ï¼Œå°±ç›¸å½“äºå®Œæˆäº†æ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½ã€‚</p>
<p>åœ¨Javaå¹³å°ä¸Šï¼Œå¯¹äºAOPçš„ç»‡å…¥ï¼Œæœ‰3ç§æ–¹å¼ï¼š</p>
<ol>
<li>ç¼–è¯‘æœŸï¼šåœ¨ç¼–è¯‘æ—¶ï¼Œç”±ç¼–è¯‘å™¨æŠŠåˆ‡é¢è°ƒç”¨ç¼–è¯‘è¿›å­—èŠ‚ç ï¼Œè¿™ç§æ–¹å¼éœ€è¦å®šä¹‰æ–°çš„å…³é”®å­—å¹¶æ‰©å±•ç¼–è¯‘å™¨ï¼ŒAspectJå°±æ‰©å±•äº†Javaç¼–è¯‘å™¨ï¼Œä½¿ç”¨å…³é”®å­—aspectæ¥å®ç°ç»‡å…¥ï¼›</li>
<li>ç±»åŠ è½½å™¨ï¼šåœ¨ç›®æ ‡ç±»è¢«è£…è½½åˆ°JVMæ—¶ï¼Œé€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„ç±»åŠ è½½å™¨ï¼Œå¯¹ç›®æ ‡ç±»çš„å­—èŠ‚ç é‡æ–°â€œå¢å¼ºâ€ï¼›</li>
<li>è¿è¡ŒæœŸï¼šç›®æ ‡å¯¹è±¡å’Œåˆ‡é¢éƒ½æ˜¯æ™®é€šJavaç±»ï¼Œé€šè¿‡JVMçš„åŠ¨æ€ä»£ç†åŠŸèƒ½æˆ–è€…ç¬¬ä¸‰æ–¹åº“å®ç°è¿è¡ŒæœŸåŠ¨æ€ç»‡å…¥ã€‚</li>
</ol>
<p>æœ€ç®€å•çš„æ–¹å¼æ˜¯ç¬¬ä¸‰ç§ï¼ŒSpringçš„AOPå®ç°å°±æ˜¯åŸºäºJVMçš„åŠ¨æ€ä»£ç†ã€‚ç”±äºJVMçš„åŠ¨æ€ä»£ç†è¦æ±‚å¿…é¡»å®ç°æ¥å£ï¼Œå¦‚æœä¸€ä¸ªæ™®é€šç±»æ²¡æœ‰ä¸šåŠ¡æ¥å£ï¼Œå°±éœ€è¦é€šè¿‡<a href="https://github.com/cglib/cglib">CGLIB</a>æˆ–è€…<a href="https://www.javassist.org/">Javassist</a>è¿™äº›ç¬¬ä¸‰æ–¹åº“å®ç°ã€‚</p>
<p>AOPæŠ€æœ¯çœ‹ä¸Šå»æ¯”è¾ƒç¥ç§˜ï¼Œä½†å®é™…ä¸Šï¼Œå®ƒæœ¬è´¨å°±æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ï¼Œè®©æˆ‘ä»¬æŠŠä¸€äº›å¸¸ç”¨åŠŸèƒ½å¦‚æƒé™æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰ï¼Œä»æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­å‰¥ç¦»å‡ºæ¥ã€‚</p>
<p>éœ€è¦ç‰¹åˆ«æŒ‡å‡ºçš„æ˜¯ï¼ŒAOPå¯¹äºè§£å†³ç‰¹å®šé—®é¢˜ï¼Œä¾‹å¦‚äº‹åŠ¡ç®¡ç†éå¸¸æœ‰ç”¨ï¼Œè¿™æ˜¯å› ä¸ºåˆ†æ•£åœ¨å„å¤„çš„äº‹åŠ¡ä»£ç å‡ ä¹æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå¹¶ä¸”å®ƒä»¬éœ€è¦çš„å‚æ•°ï¼ˆJDBCçš„Connectionï¼‰ä¹Ÿæ˜¯å›ºå®šçš„ã€‚å¦ä¸€äº›ç‰¹å®šé—®é¢˜ï¼Œå¦‚æ—¥å¿—ï¼Œå°±ä¸é‚£ä¹ˆå®¹æ˜“å®ç°ï¼Œå› ä¸ºæ—¥å¿—è™½ç„¶ç®€å•ï¼Œä½†æ‰“å°æ—¥å¿—çš„æ—¶å€™ï¼Œç»å¸¸éœ€è¦æ•è·å±€éƒ¨å˜é‡ï¼Œå¦‚æœä½¿ç”¨AOPå®ç°æ—¥å¿—ï¼Œæˆ‘ä»¬åªèƒ½è¾“å‡ºå›ºå®šæ ¼å¼çš„æ—¥å¿—ï¼Œå› æ­¤ï¼Œä½¿ç”¨AOPæ—¶ï¼Œå¿…é¡»é€‚åˆç‰¹å®šçš„åœºæ™¯ã€‚</p>
<h1 id="è£…é…aop">è£…é…AOP<a hidden class="anchor" aria-hidden="true" href="#è£…é…aop">#</a></h1>
<p>åœ¨AOPç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸‹é¢çš„æ¦‚å¿µï¼š</p>
<ul>
<li>Aspectï¼šåˆ‡é¢ï¼Œå³ä¸€ä¸ªæ¨ªè·¨å¤šä¸ªæ ¸å¿ƒé€»è¾‘çš„åŠŸèƒ½ï¼Œæˆ–è€…ç§°ä¹‹ä¸ºç³»ç»Ÿå…³æ³¨ç‚¹ï¼›</li>
<li>Joinpointï¼šè¿æ¥ç‚¹ï¼Œå³å®šä¹‰åœ¨åº”ç”¨ç¨‹åºæµç¨‹çš„ä½•å¤„æ’å…¥åˆ‡é¢çš„æ‰§è¡Œï¼›</li>
<li>Pointcutï¼šåˆ‡å…¥ç‚¹ï¼Œå³ä¸€ç»„è¿æ¥ç‚¹çš„é›†åˆï¼›</li>
<li>Adviceï¼šå¢å¼ºï¼ŒæŒ‡ç‰¹å®šè¿æ¥ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼›</li>
<li>Introductionï¼šå¼•ä»‹ï¼ŒæŒ‡ä¸ºä¸€ä¸ªå·²æœ‰çš„Javaå¯¹è±¡åŠ¨æ€åœ°å¢åŠ æ–°çš„æ¥å£ï¼›</li>
<li>Weavingï¼šç»‡å…¥ï¼ŒæŒ‡å°†åˆ‡é¢æ•´åˆåˆ°ç¨‹åºçš„æ‰§è¡Œæµç¨‹ä¸­ï¼›</li>
<li>Interceptorï¼šæ‹¦æˆªå™¨ï¼Œæ˜¯ä¸€ç§å®ç°å¢å¼ºçš„æ–¹å¼ï¼›</li>
<li>Target Objectï¼šç›®æ ‡å¯¹è±¡ï¼Œå³çœŸæ­£æ‰§è¡Œä¸šåŠ¡çš„æ ¸å¿ƒé€»è¾‘å¯¹è±¡ï¼›</li>
<li>AOP Proxyï¼šAOPä»£ç†ï¼Œæ˜¯å®¢æˆ·ç«¯æŒæœ‰çš„å¢å¼ºåçš„å¯¹è±¡å¼•ç”¨ã€‚</li>
</ul>
<p>çœ‹å®Œä¸Šè¿°æœ¯è¯­ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰å¯¹AOPæœ‰äº†è¿›ä¸€æ­¥çš„å›°æƒ‘ï¼Ÿå…¶å®ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒAOPåˆ›é€ çš„â€œæœ¯è¯­â€ï¼Œåªéœ€è¦ç†è§£AOPæœ¬è´¨ä¸Šåªæ˜¯ä¸€ç§ä»£ç†æ¨¡å¼çš„å®ç°æ–¹å¼ï¼Œåœ¨Springçš„å®¹å™¨ä¸­å®ç°AOPç‰¹åˆ«æ–¹ä¾¿ã€‚</p>
<p>æˆ‘ä»¬ä»¥<code>UserService</code>å’Œ<code>MailService</code>ä¸ºä¾‹ï¼Œè¿™ä¸¤ä¸ªå±äºæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡ç»™<code>UserService</code>çš„æ¯ä¸ªä¸šåŠ¡æ–¹æ³•æ‰§è¡Œå‰æ·»åŠ æ—¥å¿—ï¼Œç»™<code>MailService</code>çš„æ¯ä¸ªä¸šåŠ¡æ–¹æ³•æ‰§è¡Œå‰åæ·»åŠ æ—¥å¿—ï¼Œåœ¨Springä¸­ï¼Œéœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡Mavenå¼•å…¥Springå¯¹AOPçš„æ”¯æŒï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.springframework<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>spring-aspects<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>${spring.version}<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä¾èµ–ä¼šè‡ªåŠ¨å¼•å…¥AspectJï¼Œä½¿ç”¨AspectJå®ç°AOPæ¯”è¾ƒæ–¹ä¾¿ï¼Œå› ä¸ºå®ƒçš„å®šä¹‰æ¯”è¾ƒç®€å•ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª<code>LoggingAspect</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Aspect
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LoggingAspect {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åœ¨æ‰§è¡ŒUserServiceçš„æ¯ä¸ªæ–¹æ³•å‰æ‰§è¡Œ:</span>
</span></span><span style="display:flex;"><span>    @Before(<span style="color:#0ff;font-weight:bold">&#34;execution(public * com.itranswarp.learnjava.service.UserService.*(..))&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> doAccessCheck() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;[Before] do access check...&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// åœ¨æ‰§è¡ŒMailServiceçš„æ¯ä¸ªæ–¹æ³•å‰åæ‰§è¡Œ:</span>
</span></span><span style="display:flex;"><span>    @Around(<span style="color:#0ff;font-weight:bold">&#34;execution(public * com.itranswarp.learnjava.service.MailService.*(..))&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object doLogging(ProceedingJoinPoint pjp) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;[Around] start &#34;</span> + pjp.<span style="color:#007f7f">getSignature</span>());
</span></span><span style="display:flex;"><span>        Object retVal = pjp.<span style="color:#007f7f">proceed</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;[Around] done &#34;</span> + pjp.<span style="color:#007f7f">getSignature</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> retVal;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§‚å¯Ÿ<code>doAccessCheck()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>@Before</code>æ³¨è§£ï¼Œåé¢çš„å­—ç¬¦ä¸²æ˜¯å‘Šè¯‰AspectJåº”è¯¥åœ¨ä½•å¤„æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œè¿™é‡Œå†™çš„æ„æ€æ˜¯ï¼šæ‰§è¡Œ<code>UserService</code>çš„æ¯ä¸ª<code>public</code>æ–¹æ³•å‰æ‰§è¡Œ<code>doAccessCheck()</code>ä»£ç ã€‚</p>
<p>å†è§‚å¯Ÿ<code>doLogging()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>@Around</code>æ³¨è§£ï¼Œå®ƒå’Œ<code>@Before</code>ä¸åŒï¼Œ<code>@Around</code>å¯ä»¥å†³å®šæ˜¯å¦æ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åœ¨<code>doLogging()</code>å†…éƒ¨å…ˆæ‰“å°æ—¥å¿—ï¼Œå†è°ƒç”¨æ–¹æ³•ï¼Œæœ€åæ‰“å°æ—¥å¿—åè¿”å›ç»“æœã€‚</p>
<p>åœ¨<code>LoggingAspect</code>ç±»çš„å£°æ˜å¤„ï¼Œé™¤äº†ç”¨<code>@Component</code>è¡¨ç¤ºå®ƒæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªBeanå¤–ï¼Œæˆ‘ä»¬å†åŠ ä¸Š<code>@Aspect</code>æ³¨è§£ï¼Œè¡¨ç¤ºå®ƒçš„<code>@Before</code>æ ‡æ³¨çš„æ–¹æ³•éœ€è¦æ³¨å…¥åˆ°<code>UserService</code>çš„æ¯ä¸ª<code>public</code>æ–¹æ³•æ‰§è¡Œå‰ï¼Œ<code>@Around</code>æ ‡æ³¨çš„æ–¹æ³•éœ€è¦æ³¨å…¥åˆ°<code>MailService</code>çš„æ¯ä¸ª<code>public</code>æ–¹æ³•æ‰§è¡Œå‰åã€‚</p>
<p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦ç»™<code>@Configuration</code>ç±»åŠ ä¸Šä¸€ä¸ª<code>@EnableAspectJAutoProxy</code>æ³¨è§£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span>@EnableAspectJAutoProxy
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Springçš„IoCå®¹å™¨çœ‹åˆ°è¿™ä¸ªæ³¨è§£ï¼Œå°±ä¼šè‡ªåŠ¨æŸ¥æ‰¾å¸¦æœ‰<code>@Aspect</code>çš„Beanï¼Œç„¶åæ ¹æ®æ¯ä¸ªæ–¹æ³•çš„<code>@Before</code>ã€<code>@Around</code>ç­‰æ³¨è§£æŠŠAOPæ³¨å…¥åˆ°ç‰¹å®šçš„Beanä¸­ã€‚æ‰§è¡Œä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[Before] do access check...
</span></span><span style="display:flex;"><span>[Around] start void com.itranswarp.learnjava.service.MailService.sendRegistrationMail(User)
</span></span><span style="display:flex;"><span>Welcome, test!
</span></span><span style="display:flex;"><span>[Around] done void com.itranswarp.learnjava.service.MailService.sendRegistrationMail(User)
</span></span><span style="display:flex;"><span>[Before] do access check...
</span></span><span style="display:flex;"><span>[Around] start void com.itranswarp.learnjava.service.MailService.sendLoginMail(User)
</span></span><span style="display:flex;"><span>Hi, Bob! You are logged in at 2020-02-14T23:13:52.167996+08:00[Asia/Shanghai]
</span></span><span style="display:flex;"><span>[Around] done void com.itranswarp.learnjava.service.MailService.sendLoginMail(User)
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™è¯´æ˜æ‰§è¡Œä¸šåŠ¡é€»è¾‘å‰åï¼Œç¡®å®æ‰§è¡Œäº†æˆ‘ä»¬å®šä¹‰çš„Aspectï¼ˆå³<code>LoggingAspect</code>çš„æ–¹æ³•ï¼‰ã€‚</p>
<p>æœ‰äº›ç«¥é‹ä¼šé—®ï¼Œ<code>LoggingAspect</code>å®šä¹‰çš„æ–¹æ³•ï¼Œæ˜¯å¦‚ä½•æ³¨å…¥åˆ°å…¶ä»–Beançš„å‘¢ï¼Ÿ</p>
<p>å…¶å®AOPçš„åŸç†éå¸¸ç®€å•ã€‚æˆ‘ä»¬ä»¥<code>LoggingAspect.doAccessCheck()</code>ä¸ºä¾‹ï¼Œè¦æŠŠå®ƒæ³¨å…¥åˆ°<code>UserService</code>çš„æ¯ä¸ª<code>public</code>æ–¹æ³•ä¸­ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ç¼–å†™ä¸€ä¸ªå­ç±»ï¼Œå¹¶æŒæœ‰åŸå§‹å®ä¾‹çš„å¼•ç”¨ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> UserServiceAopProxy <span style="color:#fff;font-weight:bold">extends</span> UserService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> UserService target;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> LoggingAspect aspect;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserServiceAopProxy(UserService target, LoggingAspect aspect) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">aspect</span> = aspect;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> User login(String email, String password) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å…ˆæ‰§è¡ŒAspectçš„ä»£ç :</span>
</span></span><span style="display:flex;"><span>        aspect.<span style="color:#007f7f">doAccessCheck</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å†æ‰§è¡ŒUserServiceçš„é€»è¾‘:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> target.<span style="color:#007f7f">login</span>(email, password);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> User register(String email, String password, String name) {
</span></span><span style="display:flex;"><span>        aspect.<span style="color:#007f7f">doAccessCheck</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> target.<span style="color:#007f7f">register</span>(email, password, name);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™äº›éƒ½æ˜¯Springå®¹å™¨å¯åŠ¨æ—¶ä¸ºæˆ‘ä»¬è‡ªåŠ¨åˆ›å»ºçš„æ³¨å…¥äº†Aspectçš„å­ç±»ï¼Œå®ƒå–ä»£äº†åŸå§‹çš„<code>UserService</code>ï¼ˆåŸå§‹çš„<code>UserService</code>å®ä¾‹ä½œä¸ºå†…éƒ¨å˜é‡éšè—åœ¨<code>UserServiceAopProxy</code>ä¸­ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æ‰“å°ä»Springå®¹å™¨è·å–çš„<code>UserService</code>å®ä¾‹ç±»å‹ï¼Œå®ƒç±»ä¼¼<code>UserService$$EnhancerBySpringCGLIB$$1f44e01c</code>ï¼Œå®é™…ä¸Šæ˜¯Springä½¿ç”¨CGLIBåŠ¨æ€åˆ›å»ºçš„å­ç±»ï¼Œä½†å¯¹äºè°ƒç”¨æ–¹æ¥è¯´ï¼Œæ„Ÿè§‰ä¸åˆ°ä»»ä½•åŒºåˆ«ã€‚</p>
<p>Springå¯¹æ¥å£ç±»å‹ä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼Œå¯¹æ™®é€šç±»ä½¿ç”¨CGLIBåˆ›å»ºå­ç±»ã€‚å¦‚æœä¸€ä¸ªBeançš„classæ˜¯finalï¼ŒSpringå°†æ— æ³•ä¸ºå…¶åˆ›å»ºå­ç±»ã€‚</p>
<p>å¯è§ï¼Œè™½ç„¶Springå®¹å™¨å†…éƒ¨å®ç°AOPçš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼ˆéœ€è¦ä½¿ç”¨AspectJè§£ææ³¨è§£ï¼Œå¹¶é€šè¿‡CGLIBå®ç°ä»£ç†ç±»ï¼‰ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨AOPéå¸¸ç®€å•ï¼Œä¸€å…±éœ€è¦ä¸‰æ­¥ï¼š</p>
<ol>
<li>å®šä¹‰æ‰§è¡Œæ–¹æ³•ï¼Œå¹¶åœ¨æ–¹æ³•ä¸Šé€šè¿‡AspectJçš„æ³¨è§£å‘Šè¯‰Springåº”è¯¥åœ¨ä½•å¤„è°ƒç”¨æ­¤æ–¹æ³•ï¼›</li>
<li>æ ‡è®°<code>@Component</code>å’Œ<code>@Aspect</code>ï¼›</li>
<li>åœ¨<code>@Configuration</code>ç±»ä¸Šæ ‡æ³¨<code>@EnableAspectJAutoProxy</code>ã€‚</li>
</ol>
<p>è‡³äºAspectJçš„æ³¨å…¥è¯­æ³•åˆ™æ¯”è¾ƒå¤æ‚ï¼Œè¯·å‚è€ƒ<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-pointcuts-examples">Springæ–‡æ¡£</a>ã€‚</p>
<p>Springä¹Ÿæä¾›å…¶ä»–æ–¹æ³•æ¥è£…é…AOPï¼Œä½†éƒ½æ²¡æœ‰ä½¿ç”¨AspectJæ³¨è§£çš„æ–¹å¼æ¥å¾—ç®€æ´æ˜äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å†ä½œä»‹ç»ã€‚</p>
<h2 id="æ‹¦æˆªå™¨ç±»å‹">æ‹¦æˆªå™¨ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#æ‹¦æˆªå™¨ç±»å‹">#</a></h2>
<p>é¡¾åæ€ä¹‰ï¼Œæ‹¦æˆªå™¨æœ‰ä»¥ä¸‹ç±»å‹ï¼š</p>
<ul>
<li>@Beforeï¼šè¿™ç§æ‹¦æˆªå™¨å…ˆæ‰§è¡Œæ‹¦æˆªä»£ç ï¼Œå†æ‰§è¡Œç›®æ ‡ä»£ç ã€‚å¦‚æœæ‹¦æˆªå™¨æŠ›å¼‚å¸¸ï¼Œé‚£ä¹ˆç›®æ ‡ä»£ç å°±ä¸æ‰§è¡Œäº†ï¼›</li>
<li>@Afterï¼šè¿™ç§æ‹¦æˆªå™¨å…ˆæ‰§è¡Œç›®æ ‡ä»£ç ï¼Œå†æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ã€‚æ— è®ºç›®æ ‡ä»£ç æ˜¯å¦æŠ›å¼‚å¸¸ï¼Œæ‹¦æˆªå™¨ä»£ç éƒ½ä¼šæ‰§è¡Œï¼›</li>
<li>@AfterReturningï¼šå’Œ@Afterä¸åŒçš„æ˜¯ï¼Œåªæœ‰å½“ç›®æ ‡ä»£ç æ­£å¸¸è¿”å›æ—¶ï¼Œæ‰æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ï¼›</li>
<li>@AfterThrowingï¼šå’Œ@Afterä¸åŒçš„æ˜¯ï¼Œåªæœ‰å½“ç›®æ ‡ä»£ç æŠ›å‡ºäº†å¼‚å¸¸æ—¶ï¼Œæ‰æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ï¼›</li>
<li>@Aroundï¼šèƒ½å®Œå…¨æ§åˆ¶ç›®æ ‡ä»£ç æ˜¯å¦æ‰§è¡Œï¼Œå¹¶å¯ä»¥åœ¨æ‰§è¡Œå‰åã€æŠ›å¼‚å¸¸åæ‰§è¡Œä»»æ„æ‹¦æˆªä»£ç ï¼Œå¯ä»¥è¯´æ˜¯åŒ…å«äº†ä¸Šé¢æ‰€æœ‰åŠŸèƒ½ã€‚</li>
</ul>
<h2 id="å°ç»“">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“">#</a></h2>
<p>åœ¨Springå®¹å™¨ä¸­ä½¿ç”¨AOPéå¸¸ç®€å•ï¼Œåªéœ€è¦å®šä¹‰æ‰§è¡Œæ–¹æ³•ï¼Œå¹¶ç”¨AspectJçš„æ³¨è§£æ ‡æ³¨åº”è¯¥åœ¨ä½•å¤„è§¦å‘å¹¶æ‰§è¡Œã€‚</p>
<p>Springé€šè¿‡CGLIBåŠ¨æ€åˆ›å»ºå­ç±»ç­‰æ–¹å¼æ¥å®ç°AOPä»£ç†æ¨¡å¼ï¼Œå¤§å¤§ç®€åŒ–äº†ä»£ç ã€‚</p>
<h1 id="ä½¿ç”¨æ³¨è§£è£…é…aop">ä½¿ç”¨æ³¨è§£è£…é…AOP<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨æ³¨è§£è£…é…aop">#</a></h1>
<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²è§£äº†ä½¿ç”¨AspectJçš„æ³¨è§£ï¼Œå¹¶é…åˆä¸€ä¸ªå¤æ‚çš„<code>execution(* xxx.Xyz.*(..))</code>è¯­æ³•æ¥å®šä¹‰åº”è¯¥å¦‚ä½•è£…é…AOPã€‚</p>
<p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™ç§å†™æ³•å…¶å®å¾ˆå°‘ä½¿ç”¨ã€‚å‡è®¾ä½ å†™äº†ä¸€ä¸ª<code>SecurityAspect</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Aspect
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecurityAspect {
</span></span><span style="display:flex;"><span>    @Before(<span style="color:#0ff;font-weight:bold">&#34;execution(public * com.itranswarp.learnjava.service.*.*(..))&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> check() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (SecurityContext.<span style="color:#007f7f">getCurrentUser</span>() == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> RuntimeException(<span style="color:#0ff;font-weight:bold">&#34;check failed&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŸºæœ¬èƒ½å®ç°æ— å·®åˆ«å…¨è¦†ç›–ï¼Œå³æŸä¸ªåŒ…ä¸‹é¢çš„æ‰€æœ‰Beançš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè¢«è¿™ä¸ª<code>check()</code>æ–¹æ³•æ‹¦æˆªã€‚</p>
<p>è¿˜æœ‰çš„ç«¥é‹å–œæ¬¢ç”¨æ–¹æ³•åå‰ç¼€è¿›è¡Œæ‹¦æˆªï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Around(<span style="color:#0ff;font-weight:bold">&#34;execution(public * update*(..))&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Object doLogging(ProceedingJoinPoint pjp) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// å¯¹updateå¼€å¤´çš„æ–¹æ³•åˆ‡æ¢æ•°æ®æº:</span>
</span></span><span style="display:flex;"><span>    String old = setCurrentDataSource(<span style="color:#0ff;font-weight:bold">&#34;master&#34;</span>);
</span></span><span style="display:flex;"><span>    Object retVal = pjp.<span style="color:#007f7f">proceed</span>();
</span></span><span style="display:flex;"><span>    restoreCurrentDataSource(old);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> retVal;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ç§éç²¾å‡†æ‰“å‡»è¯¯ä¼¤é¢æ›´å¤§ï¼Œå› ä¸ºä»æ–¹æ³•å‰ç¼€åŒºåˆ†æ˜¯å¦æ˜¯æ•°æ®åº“æ“ä½œæ˜¯éå¸¸ä¸å¯å–çš„ã€‚</p>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨AOPæ—¶ï¼Œè¦æ³¨æ„åˆ°è™½ç„¶Springå®¹å™¨å¯ä»¥æŠŠæŒ‡å®šçš„æ–¹æ³•é€šè¿‡AOPè§„åˆ™è£…é…åˆ°æŒ‡å®šçš„Beançš„æŒ‡å®šæ–¹æ³•å‰åï¼Œä½†æ˜¯ï¼Œå¦‚æœè‡ªåŠ¨è£…é…æ—¶ï¼Œå› ä¸ºä¸æ°å½“çš„èŒƒå›´ï¼Œå®¹æ˜“å¯¼è‡´æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œå³å¾ˆå¤šä¸éœ€è¦AOPä»£ç†çš„Beanä¹Ÿè¢«è‡ªåŠ¨ä»£ç†äº†ï¼Œå¹¶ä¸”ï¼Œåç»­æ–°å¢çš„Beanï¼Œå¦‚æœä¸æ¸…æ¥šç°æœ‰çš„AOPè£…é…è§„åˆ™ï¼Œå®¹æ˜“è¢«å¼ºè¿«è£…é…ã€‚</p>
<p>ä½¿ç”¨AOPæ—¶ï¼Œè¢«è£…é…çš„Beanæœ€å¥½è‡ªå·±èƒ½æ¸…æ¸…æ¥šæ¥šåœ°çŸ¥é“è‡ªå·±è¢«å®‰æ’äº†ã€‚ä¾‹å¦‚ï¼ŒSpringæä¾›çš„<code>@Transactional</code>å°±æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¾‹å­ã€‚å¦‚æœæˆ‘ä»¬è‡ªå·±å†™çš„Beanå¸Œæœ›åœ¨ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ä¸­è¢«è°ƒç”¨ï¼Œå°±æ ‡æ³¨ä¸Š<code>@Transactional</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æœ‰äº‹åŠ¡:</span>
</span></span><span style="display:flex;"><span>    @Transactional
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> User createUser(String name) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ— äº‹åŠ¡:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> isValidName(String name) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æœ‰äº‹åŠ¡:</span>
</span></span><span style="display:flex;"><span>    @Transactional
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> updateUser(User user) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ–è€…ç›´æ¥åœ¨classçº§åˆ«æ³¨è§£ï¼Œè¡¨ç¤ºâ€œæ‰€æœ‰publicæ–¹æ³•éƒ½è¢«å®‰æ’äº†â€ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span>@Transactional
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡<code>@Transactional</code>ï¼ŒæŸä¸ªæ–¹æ³•æ˜¯å¦å¯ç”¨äº†äº‹åŠ¡å°±ä¸€æ¸…äºŒæ¥šäº†ã€‚å› æ­¤ï¼Œè£…é…AOPçš„æ—¶å€™ï¼Œä½¿ç”¨æ³¨è§£æ˜¯æœ€å¥½çš„æ–¹å¼ã€‚</p>
<p>æˆ‘ä»¬ä»¥ä¸€ä¸ªå®é™…ä¾‹å­æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨æ³¨è§£å®ç°AOPè£…é…ã€‚ä¸ºäº†ç›‘æ§åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ€§èƒ½ç›‘æ§çš„æ³¨è§£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Target(METHOD)
</span></span><span style="display:flex;"><span>@Retention(RUNTIME)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> @interface MetricTime {
</span></span><span style="display:flex;"><span>    String value();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨éœ€è¦è¢«ç›‘æ§çš„å…³é”®æ–¹æ³•ä¸Šæ ‡æ³¨è¯¥æ³¨è§£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ç›‘æ§register()æ–¹æ³•æ€§èƒ½:</span>
</span></span><span style="display:flex;"><span>    @MetricTime(<span style="color:#0ff;font-weight:bold">&#34;register&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> User register(String email, String password, String name) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰<code>MetricAspect</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Aspect
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MetricAspect {
</span></span><span style="display:flex;"><span>    @Around(<span style="color:#0ff;font-weight:bold">&#34;@annotation(metricTime)&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object metric(ProceedingJoinPoint joinPoint, MetricTime metricTime) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>        String name = metricTime.<span style="color:#007f7f">value</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> start = System.<span style="color:#007f7f">currentTimeMillis</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> joinPoint.<span style="color:#007f7f">proceed</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">long</span> t = System.<span style="color:#007f7f">currentTimeMillis</span>() - start;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å†™å…¥æ—¥å¿—æˆ–å‘é€è‡³JMX:</span>
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;[Metrics] &#34;</span> + name + <span style="color:#0ff;font-weight:bold">&#34;: &#34;</span> + t + <span style="color:#0ff;font-weight:bold">&#34;ms&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„<code>metric()</code>æ–¹æ³•æ ‡æ³¨äº†<code>@Around(&quot;@annotation(metricTime)&quot;)</code>ï¼Œå®ƒçš„æ„æ€æ˜¯ï¼Œç¬¦åˆæ¡ä»¶çš„ç›®æ ‡æ–¹æ³•æ˜¯å¸¦æœ‰<code>@MetricTime</code>æ³¨è§£çš„æ–¹æ³•ï¼Œå› ä¸º<code>metric()</code>æ–¹æ³•å‚æ•°ç±»å‹æ˜¯<code>MetricTime</code>ï¼ˆæ³¨æ„å‚æ•°åæ˜¯<code>metricTime</code>ä¸æ˜¯<code>MetricTime</code>ï¼‰ï¼Œæˆ‘ä»¬é€šè¿‡å®ƒè·å–æ€§èƒ½ç›‘æ§çš„åç§°ã€‚</p>
<p>æœ‰äº†<code>@MetricTime</code>æ³¨è§£ï¼Œå†é…åˆ<code>MetricAspect</code>ï¼Œä»»ä½•Beanï¼Œåªè¦æ–¹æ³•æ ‡æ³¨äº†<code>@MetricTime</code>æ³¨è§£ï¼Œå°±å¯ä»¥è‡ªåŠ¨å®ç°æ€§èƒ½ç›‘æ§ã€‚è¿è¡Œä»£ç ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Welcome, Bob!
</span></span><span style="display:flex;"><span>[Metrics] register: 16ms
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å°ç»“-1">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“-1">#</a></h2>
<p>ä½¿ç”¨æ³¨è§£å®ç°AOPéœ€è¦å…ˆå®šä¹‰æ³¨è§£ï¼Œç„¶åä½¿ç”¨<code>@Around(&quot;@annotation(name)&quot;)</code>å®ç°è£…é…ï¼›</p>
<p>ä½¿ç”¨æ³¨è§£æ—¢ç®€å•ï¼Œåˆèƒ½æ˜ç¡®æ ‡è¯†AOPè£…é…ï¼Œæ˜¯ä½¿ç”¨AOPæ¨èçš„æ–¹å¼ã€‚</p>
<h1 id="aopé¿å‘æŒ‡å—">AOPé¿å‘æŒ‡å—<a hidden class="anchor" aria-hidden="true" href="#aopé¿å‘æŒ‡å—">#</a></h1>
<p>æ— è®ºæ˜¯ä½¿ç”¨AspectJè¯­æ³•ï¼Œè¿˜æ˜¯é…åˆAnnotationï¼Œä½¿ç”¨AOPï¼Œå®é™…ä¸Šå°±æ˜¯è®©Springè‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªProxyï¼Œä½¿å¾—è°ƒç”¨æ–¹èƒ½æ— æ„ŸçŸ¥åœ°è°ƒç”¨æŒ‡å®šæ–¹æ³•ï¼Œä½†è¿è¡ŒæœŸå´åŠ¨æ€â€œç»‡å…¥â€äº†å…¶ä»–é€»è¾‘ï¼Œå› æ­¤ï¼ŒAOPæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1281319432618017">ä»£ç†æ¨¡å¼</a>ã€‚</p>
<p>å› ä¸ºSpringä½¿ç”¨äº†CGLIBæ¥å®ç°è¿è¡ŒæœŸåŠ¨æ€åˆ›å»ºProxyï¼Œå¦‚æœæˆ‘ä»¬æ²¡èƒ½æ·±å…¥ç†è§£å…¶è¿è¡ŒåŸç†å’Œå®ç°æœºåˆ¶ï¼Œå°±ææœ‰å¯èƒ½é‡åˆ°å„ç§è¯¡å¼‚çš„é—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>UserService</code>çš„Beanï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æˆå‘˜å˜é‡:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> ZoneId zoneId = ZoneId.<span style="color:#007f7f">systemDefault</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æ„é€ æ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserService() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;UserService(): init...&#34;</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;UserService(): zoneId = &#34;</span> + <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">zoneId</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// publicæ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ZoneId getZoneId() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> zoneId;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// public finalæ–¹æ³•:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> ZoneId getFinalZoneId() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> zoneId;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†å†™ä¸ª<code>MailService</code>ï¼Œå¹¶æ³¨å…¥<code>UserService</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MailService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    UserService userService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String sendMail() {
</span></span><span style="display:flex;"><span>        ZoneId zoneId = userService.<span style="color:#007f7f">zoneId</span>;
</span></span><span style="display:flex;"><span>        String dt = ZonedDateTime.<span style="color:#007f7f">now</span>(zoneId).<span style="color:#007f7f">toString</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;Hello, it is &#34;</span> + dt;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ€åç”¨<code>main()</code>æ–¹æ³•æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AppConfig {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        ApplicationContext context = <span style="color:#fff;font-weight:bold">new</span> AnnotationConfigApplicationContext(AppConfig.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        MailService mailService = context.<span style="color:#007f7f">getBean</span>(MailService.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(mailService.<span style="color:#007f7f">sendMail</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹è¾“å‡ºï¼Œä¸€åˆ‡æ­£å¸¸ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>UserService(): init...
</span></span><span style="display:flex;"><span>UserService(): zoneId = Asia/Shanghai
</span></span><span style="display:flex;"><span>Hello, it is 2020-04-12T10:23:22.<span style="color:#007f7f">917721</span>+08:00[Asia/Shanghai]
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬ç»™<code>UserService</code>åŠ ä¸ŠAOPæ”¯æŒï¼Œå°±æ·»åŠ ä¸€ä¸ªæœ€ç®€å•çš„<code>LoggingAspect</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Aspect
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LoggingAspect {
</span></span><span style="display:flex;"><span>    @Before(<span style="color:#0ff;font-weight:bold">&#34;execution(public * com..*.UserService.*(..))&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> doAccessCheck() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;[Before] do access check...&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ«å¿˜äº†åœ¨<code>AppConfig</code>ä¸ŠåŠ ä¸Š<code>@EnableAspectJAutoProxy</code>ã€‚å†æ¬¡è¿è¡Œï¼Œä¸å‡ºæ„å¤–çš„è¯ï¼Œä¼šå¾—åˆ°ä¸€ä¸ª<code>NullPointerException</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Exception in thread <span style="color:#0ff;font-weight:bold">&#34;main&#34;</span> java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">NullPointerException</span>: zone
</span></span><span style="display:flex;"><span>    at java.<span style="color:#007f7f">base</span>/java.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">Objects</span>.<span style="color:#007f7f">requireNonNull</span>(Objects.<span style="color:#007f7f">java</span>:246)
</span></span><span style="display:flex;"><span>    at java.<span style="color:#007f7f">base</span>/java.<span style="color:#007f7f">time</span>.<span style="color:#007f7f">Clock</span>.<span style="color:#007f7f">system</span>(Clock.<span style="color:#007f7f">java</span>:203)
</span></span><span style="display:flex;"><span>    at java.<span style="color:#007f7f">base</span>/java.<span style="color:#007f7f">time</span>.<span style="color:#007f7f">ZonedDateTime</span>.<span style="color:#007f7f">now</span>(ZonedDateTime.<span style="color:#007f7f">java</span>:216)
</span></span><span style="display:flex;"><span>    at com.<span style="color:#007f7f">itranswarp</span>.<span style="color:#007f7f">learnjava</span>.<span style="color:#007f7f">service</span>.<span style="color:#007f7f">MailService</span>.<span style="color:#007f7f">sendMail</span>(MailService.<span style="color:#007f7f">java</span>:19)
</span></span><span style="display:flex;"><span>    at com.<span style="color:#007f7f">itranswarp</span>.<span style="color:#007f7f">learnjava</span>.<span style="color:#007f7f">AppConfig</span>.<span style="color:#007f7f">main</span>(AppConfig.<span style="color:#007f7f">java</span>:21)
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»”ç»†è·Ÿè¸ªä»£ç ï¼Œä¼šå‘ç°<code>null</code>å€¼å‡ºç°åœ¨<code>MailService.sendMail()</code>å†…éƒ¨çš„è¿™ä¸€è¡Œä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MailService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    UserService userService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String sendMail() {
</span></span><span style="display:flex;"><span>        ZoneId zoneId = userService.<span style="color:#007f7f">zoneId</span>;
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(zoneId); <span style="color:#007f7f">// null</span>
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬è¿˜æ•…æ„åœ¨<code>UserService</code>ä¸­ç‰¹æ„ç”¨<code>final</code>ä¿®é¥°äº†ä¸€ä¸‹æˆå‘˜å˜é‡ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> ZoneId zoneId = ZoneId.<span style="color:#007f7f">systemDefault</span>();
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”¨<code>final</code>æ ‡æ³¨çš„æˆå‘˜å˜é‡ä¸º<code>null</code>ï¼Ÿé€—æˆ‘å‘¢ï¼Ÿ</p>
<h2 id="æ€ä¹ˆå›äº‹">æ€ä¹ˆå›äº‹ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#æ€ä¹ˆå›äº‹">#</a></h2>
<p>ä¸ºä»€ä¹ˆåŠ äº†AOPå°±æŠ¥NPEï¼Œå»äº†AOPå°±ä¸€åˆ‡æ­£å¸¸ï¼Ÿ<code>final</code>å­—æ®µä¸æ‰§è¡Œï¼Œéš¾é“JVMæœ‰é—®é¢˜ï¼Ÿä¸ºäº†è§£ç­”è¿™ä¸ªè¯¡å¼‚çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ·±å…¥ç†è§£Springä½¿ç”¨CGLIBç”ŸæˆProxyçš„åŸç†ï¼š</p>
<p>ç¬¬ä¸€æ­¥ï¼Œæ­£å¸¸åˆ›å»ºä¸€ä¸ª<code>UserService</code>çš„åŸå§‹å®ä¾‹ï¼Œè¿™æ˜¯é€šè¿‡åå°„è°ƒç”¨æ„é€ æ–¹æ³•å®ç°çš„ï¼Œå®ƒçš„è¡Œä¸ºå’Œæˆ‘ä»¬é¢„æœŸçš„å®Œå…¨ä¸€è‡´ï¼›</p>
<p>ç¬¬äºŒæ­¥ï¼Œé€šè¿‡CGLIBåˆ›å»ºä¸€ä¸ª<code>UserService</code>çš„å­ç±»ï¼Œå¹¶å¼•ç”¨äº†åŸå§‹å®ä¾‹å’Œ<code>LoggingAspect</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> UserService$$EnhancerBySpringCGLIB <span style="color:#fff;font-weight:bold">extends</span> UserService {
</span></span><span style="display:flex;"><span>    UserService target;
</span></span><span style="display:flex;"><span>    LoggingAspect aspect;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserService$$EnhancerBySpringCGLIB() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ZoneId getZoneId() {
</span></span><span style="display:flex;"><span>        aspect.<span style="color:#007f7f">doAccessCheck</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> target.<span style="color:#007f7f">getZoneId</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæˆ‘ä»¬è§‚å¯ŸSpringåˆ›å»ºçš„AOPä»£ç†ï¼Œå®ƒçš„ç±»åæ€»æ˜¯ç±»ä¼¼<code>UserService$$EnhancerBySpringCGLIB$$1c76af9d</code>ï¼ˆä½ æ²¡çœ‹é”™ï¼ŒJavaçš„ç±»åå®é™…ä¸Šå…è®¸<code>$</code>å­—ç¬¦ï¼‰ã€‚ä¸ºäº†è®©è°ƒç”¨æ–¹è·å¾—<code>UserService</code>çš„å¼•ç”¨ï¼Œå®ƒå¿…é¡»ç»§æ‰¿è‡ª<code>UserService</code>ã€‚ç„¶åï¼Œè¯¥ä»£ç†ç±»ä¼šè¦†å†™æ‰€æœ‰<code>public</code>å’Œ<code>protected</code>æ–¹æ³•ï¼Œå¹¶åœ¨å†…éƒ¨å°†è°ƒç”¨å§”æ‰˜ç»™åŸå§‹çš„<code>UserService</code>å®ä¾‹ã€‚</p>
<p>è¿™é‡Œå‡ºç°äº†ä¸¤ä¸ª<code>UserService</code>å®ä¾‹ï¼š</p>
<p>ä¸€ä¸ªæ˜¯æˆ‘ä»¬ä»£ç ä¸­å®šä¹‰çš„<em>åŸå§‹å®ä¾‹</em>ï¼Œå®ƒçš„æˆå‘˜å˜é‡å·²ç»æŒ‰ç…§æˆ‘ä»¬é¢„æœŸçš„æ–¹å¼è¢«åˆå§‹åŒ–å®Œæˆï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>UserService original = <span style="color:#fff;font-weight:bold">new</span> UserService();
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬äºŒä¸ª<code>UserService</code>å®ä¾‹å®é™…ä¸Šç±»å‹æ˜¯<code>UserService$$EnhancerBySpringCGLIB</code>ï¼Œå®ƒå¼•ç”¨äº†åŸå§‹çš„<code>UserService</code>å®ä¾‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>UserService$$EnhancerBySpringCGLIB proxy = <span style="color:#fff;font-weight:bold">new</span> UserService$$EnhancerBySpringCGLIB();
</span></span><span style="display:flex;"><span>proxy.<span style="color:#007f7f">target</span> = original;
</span></span><span style="display:flex;"><span>proxy.<span style="color:#007f7f">aspect</span> = ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°è¿™ç§æƒ…å†µä»…å‡ºç°åœ¨å¯ç”¨äº†AOPçš„æƒ…å†µï¼Œæ­¤åˆ»ï¼Œä»<code>ApplicationContext</code>ä¸­è·å–çš„<code>UserService</code>å®ä¾‹æ˜¯proxyï¼Œæ³¨å…¥åˆ°<code>MailService</code>ä¸­çš„<code>UserService</code>å®ä¾‹ä¹Ÿæ˜¯proxyã€‚</p>
<p>é‚£ä¹ˆæœ€ç»ˆçš„é—®é¢˜æ¥äº†ï¼šproxyå®ä¾‹çš„æˆå‘˜å˜é‡ï¼Œä¹Ÿå°±æ˜¯ä»<code>UserService</code>ç»§æ‰¿çš„<code>zoneId</code>ï¼Œå®ƒçš„å€¼æ˜¯<code>null</code>ã€‚</p>
<p>åŸå› åœ¨äºï¼Œ<code>UserService</code>æˆå‘˜å˜é‡çš„åˆå§‹åŒ–ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> ZoneId zoneId = ZoneId.<span style="color:#007f7f">systemDefault</span>();
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨<code>UserService$$EnhancerBySpringCGLIB</code>ä¸­ï¼Œå¹¶æœªæ‰§è¡Œã€‚åŸå› æ˜¯ï¼Œæ²¡å¿…è¦åˆå§‹åŒ–proxyçš„æˆå‘˜å˜é‡ï¼Œå› ä¸ºproxyçš„ç›®çš„æ˜¯ä»£ç†æ–¹æ³•ã€‚</p>
<p>å®é™…ä¸Šï¼Œæˆå‘˜å˜é‡çš„åˆå§‹åŒ–æ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­å®Œæˆçš„ã€‚è¿™æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> ZoneId zoneId = ZoneId.<span style="color:#007f7f">systemDefault</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserService() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ˜¯ç¼–è¯‘å™¨å®é™…ç¼–è¯‘çš„ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> ZoneId zoneId;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserService() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(); <span style="color:#007f7f">// æ„é€ æ–¹æ³•çš„ç¬¬ä¸€è¡Œä»£ç æ€»æ˜¯è°ƒç”¨super()</span>
</span></span><span style="display:flex;"><span>        zoneId = ZoneId.<span style="color:#007f7f">systemDefault</span>(); <span style="color:#007f7f">// ç»§ç»­åˆå§‹åŒ–æˆå‘˜å˜é‡</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶è€Œï¼Œå¯¹äºSpringé€šè¿‡CGLIBåŠ¨æ€åˆ›å»ºçš„<code>UserService$$EnhancerBySpringCGLIB</code>ä»£ç†ç±»ï¼Œå®ƒçš„æ„é€ æ–¹æ³•ä¸­ï¼Œå¹¶æœªè°ƒç”¨<code>super()</code>ï¼Œå› æ­¤ï¼Œä»çˆ¶ç±»ç»§æ‰¿çš„æˆå‘˜å˜é‡ï¼ŒåŒ…æ‹¬<code>final</code>ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œç»Ÿç»Ÿéƒ½æ²¡æœ‰åˆå§‹åŒ–ã€‚</p>
<p>æœ‰çš„ç«¥é‹ä¼šé—®ï¼šJavaè¯­è¨€è§„å®šï¼Œä»»ä½•ç±»çš„æ„é€ æ–¹æ³•ï¼Œç¬¬ä¸€è¡Œå¿…é¡»è°ƒç”¨<code>super()</code>ï¼Œå¦‚æœæ²¡æœ‰ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åŠ ä¸Šï¼Œæ€ä¹ˆSpringçš„CGLIBå°±å¯ä»¥æç‰¹æ®Šï¼Ÿ</p>
<p>è¿™æ˜¯å› ä¸ºè‡ªåŠ¨åŠ <code>super()</code>çš„åŠŸèƒ½æ˜¯Javaç¼–è¯‘å™¨å®ç°çš„ï¼Œå®ƒå‘ç°ä½ æ²¡åŠ ï¼Œå°±è‡ªåŠ¨ç»™åŠ ä¸Šï¼Œå‘ç°ä½ åŠ é”™äº†ï¼Œå°±æŠ¥ç¼–è¯‘é”™è¯¯ã€‚ä½†å®é™…ä¸Šï¼Œå¦‚æœç›´æ¥æ„é€ å­—èŠ‚ç ï¼Œä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ä¸­ï¼Œä¸ä¸€å®šéè¦è°ƒç”¨<code>super()</code>ã€‚Springä½¿ç”¨CGLIBæ„é€ çš„Proxyç±»ï¼Œæ˜¯ç›´æ¥ç”Ÿæˆå­—èŠ‚ç ï¼Œå¹¶æ²¡æœ‰æºç -ç¼–è¯‘-å­—èŠ‚ç è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤ï¼š</p>
<p>Springé€šè¿‡CGLIBåˆ›å»ºçš„ä»£ç†ç±»ï¼Œä¸ä¼šåˆå§‹åŒ–ä»£ç†ç±»è‡ªèº«ç»§æ‰¿çš„ä»»ä½•æˆå‘˜å˜é‡ï¼ŒåŒ…æ‹¬finalç±»å‹çš„æˆå‘˜å˜é‡ï¼</p>
<p>å†è€ƒå¯Ÿ<code>MailService</code>çš„ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MailService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    UserService userService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String sendMail() {
</span></span><span style="display:flex;"><span>        ZoneId zoneId = userService.<span style="color:#007f7f">zoneId</span>;
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(zoneId); <span style="color:#007f7f">// null</span>
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæ²¡æœ‰å¯ç”¨AOPï¼Œæ³¨å…¥çš„æ˜¯åŸå§‹çš„<code>UserService</code>å®ä¾‹ï¼Œé‚£ä¹ˆä¸€åˆ‡æ­£å¸¸ï¼Œå› ä¸º<code>UserService</code>å®ä¾‹çš„<code>zoneId</code>å­—æ®µå·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–äº†ã€‚</p>
<p>å¦‚æœå¯åŠ¨äº†AOPï¼Œæ³¨å…¥çš„æ˜¯ä»£ç†åçš„<code>UserService$$EnhancerBySpringCGLIB</code>å®ä¾‹ï¼Œé‚£ä¹ˆé—®é¢˜å¤§äº†ï¼šè·å–çš„<code>UserService$$EnhancerBySpringCGLIB</code>å®ä¾‹çš„<code>zoneId</code>å­—æ®µï¼Œæ°¸è¿œä¸º<code>null</code>ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šå¯ç”¨äº†AOPï¼Œå¦‚ä½•ä¿®å¤ï¼Ÿ</p>
<p>ä¿®å¤å¾ˆç®€å•ï¼Œåªéœ€è¦æŠŠç›´æ¥è®¿é—®å­—æ®µçš„ä»£ç ï¼Œæ”¹ä¸ºé€šè¿‡æ–¹æ³•è®¿é—®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MailService {
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    UserService userService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String sendMail() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ä¸è¦ç›´æ¥è®¿é—®UserServiceçš„å­—æ®µ:</span>
</span></span><span style="display:flex;"><span>        ZoneId zoneId = userService.<span style="color:#007f7f">getZoneId</span>();
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ— è®ºæ³¨å…¥çš„<code>UserService</code>æ˜¯åŸå§‹å®ä¾‹è¿˜æ˜¯ä»£ç†å®ä¾‹ï¼Œ<code>getZoneId()</code>éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œå› ä¸ºä»£ç†ç±»ä¼šè¦†å†™<code>getZoneId()</code>æ–¹æ³•ï¼Œå¹¶å°†å…¶å§”æ‰˜ç»™åŸå§‹å®ä¾‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> UserService$$EnhancerBySpringCGLIB <span style="color:#fff;font-weight:bold">extends</span> UserService {
</span></span><span style="display:flex;"><span>    UserService target = ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ZoneId getZoneId() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> target.<span style="color:#007f7f">getZoneId</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ°æˆ‘ä»¬è¿˜ç»™<code>UserService</code>æ·»åŠ äº†ä¸€ä¸ª<code>public</code>+<code>final</code>çš„æ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserService {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> ZoneId getFinalZoneId() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> zoneId;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœåœ¨<code>MailService</code>ä¸­ï¼Œè°ƒç”¨çš„ä¸æ˜¯<code>getZoneId()</code>ï¼Œè€Œæ˜¯<code>getFinalZoneId()</code>ï¼Œåˆä¼šå‡ºç°<code>NullPointerException</code>ï¼Œè¿™æ˜¯å› ä¸ºï¼Œä»£ç†ç±»æ— æ³•è¦†å†™<code>final</code>æ–¹æ³•ï¼ˆè¿™ä¸€ç‚¹ç»•ä¸è¿‡JVMçš„ClassLoaderæ£€æŸ¥ï¼‰ï¼Œè¯¥æ–¹æ³•è¿”å›çš„æ˜¯ä»£ç†ç±»çš„<code>zoneId</code>å­—æ®µï¼Œå³<code>null</code>ã€‚</p>
<p>å®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬åŠ ä¸Šæ—¥å¿—ï¼ŒSpringåœ¨å¯åŠ¨æ—¶ä¼šæ‰“å°ä¸€ä¸ªè­¦å‘Šï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>10:43:09.929 [main] DEBUG org.springframework.aop.framework.CglibAopProxy - Final method [public final java.time.ZoneId xxx.UserService.getFinalZoneId()] cannot get proxied via CGLIB: Calls to this method will NOT be routed to the target instance and might lead to NPEs against uninitialized fields in the proxy instance.
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„æ—¥å¿—å¤§æ„å°±æ˜¯ï¼Œå› ä¸ºè¢«ä»£ç†çš„<code>UserService</code>æœ‰ä¸€ä¸ª<code>final</code>æ–¹æ³•<code>getFinalZoneId()</code>ï¼Œè¿™ä¼šå¯¼è‡´å…¶ä»–Beanå¦‚æœè°ƒç”¨æ­¤æ–¹æ³•ï¼Œæ— æ³•å°†å…¶ä»£ç†åˆ°çœŸæ­£çš„åŸå§‹å®ä¾‹ï¼Œä»è€Œå¯èƒ½å‘ç”ŸNPEå¼‚å¸¸ã€‚</p>
<p>å› æ­¤ï¼Œæ­£ç¡®ä½¿ç”¨AOPï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé¿å‘æŒ‡å—ï¼š</p>
<ol>
<li>è®¿é—®è¢«æ³¨å…¥çš„Beanæ—¶ï¼Œæ€»æ˜¯è°ƒç”¨æ–¹æ³•è€Œéç›´æ¥è®¿é—®å­—æ®µï¼›</li>
<li>ç¼–å†™Beanæ—¶ï¼Œå¦‚æœå¯èƒ½ä¼šè¢«ä»£ç†ï¼Œå°±ä¸è¦ç¼–å†™<code>public final</code>æ–¹æ³•ã€‚</li>
</ol>
<p>è¿™æ ·æ‰èƒ½ä¿è¯æœ‰æ²¡æœ‰AOPï¼Œä»£ç éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚</p>
<h2 id="æ€è€ƒ">æ€è€ƒ<a hidden class="anchor" aria-hidden="true" href="#æ€è€ƒ">#</a></h2>
<p>ä¸ºä»€ä¹ˆSpringåˆ»æ„ä¸åˆå§‹åŒ–Proxyç»§æ‰¿çš„å­—æ®µï¼Ÿ</p>
<p>å¦‚æœä¸€ä¸ªBeanä¸å…è®¸ä»»ä½•AOPä»£ç†ï¼Œåº”è¯¥æ€ä¹ˆåšæ¥â€œä¿æŠ¤â€è‡ªå·±åœ¨è¿è¡ŒæœŸä¸ä¼šè¢«ä»£ç†ï¼Ÿ</p>
<h2 id="å°ç»“-2">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“-2">#</a></h2>
<p>ç”±äºSpringé€šè¿‡CGLIBå®ç°ä»£ç†ç±»ï¼Œæˆ‘ä»¬è¦é¿å…ç›´æ¥è®¿é—®Beançš„å­—æ®µï¼Œä»¥åŠç”±<code>final</code>æ–¹æ³•å¸¦æ¥çš„â€œæœªä»£ç†â€é—®é¢˜ã€‚</p>
<p>é‡åˆ°CglibAopProxyçš„ç›¸å…³æ—¥å¿—ï¼ŒåŠ¡å¿…è¦ä»”ç»†æ£€æŸ¥ï¼Œé˜²æ­¢å› ä¸ºAOPå‡ºç°NPEå¼‚å¸¸ã€‚</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://wjy6.netlify.app/tags/spring/">Spring</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://wjy6.netlify.app/">Wjy&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
