<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>《Netty实战》读书笔记 | Wjy&#39;s Blog</title>
<meta name="keywords" content="java">
<meta name="description" content="第一个Netty应用程序 Netty 客户端/服务器概览 Echo 客户端和服务器之间的交互是非常简单的；在客户端建立一个连接之后，它会向服务器发送一个或多个消息">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%85%B6%E4%BB%96%E5%9F%BA%E7%A1%80/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="《Netty实战》读书笔记" />
<meta property="og:description" content="第一个Netty应用程序 Netty 客户端/服务器概览 Echo 客户端和服务器之间的交互是非常简单的；在客户端建立一个连接之后，它会向服务器发送一个或多个消息" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/%E5%85%B6%E4%BB%96%E5%9F%BA%E7%A1%80/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-14T09:28:13+00:00" />
<meta property="article:modified_time" content="2021-01-14T09:28:13+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="《Netty实战》读书笔记"/>
<meta name="twitter:description" content="第一个Netty应用程序 Netty 客户端/服务器概览 Echo 客户端和服务器之间的交互是非常简单的；在客户端建立一个连接之后，它会向服务器发送一个或多个消息"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "《Netty实战》读书笔记",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/%E5%85%B6%E4%BB%96%E5%9F%BA%E7%A1%80/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "《Netty实战》读书笔记",
  "name": "《Netty实战》读书笔记",
  "description": "第一个Netty应用程序 Netty 客户端/服务器概览 Echo 客户端和服务器之间的交互是非常简单的；在客户端建立一个连接之后，它会向服务器发送一个或多个消息",
  "keywords": [
    "java"
  ],
  "articleBody": "第一个Netty应用程序 Netty 客户端/服务器概览 Echo 客户端和服务器之间的交互是非常简单的；在客户端建立一个连接之后，它会向服务器发送一个或多个消息，反过来，服务器又会将每个消息回送给客户端。虽然它本身看起来好像用处不大，但它充分地体现了客户端/服务器系统中典型的请求-响应交互模式。\n编写 Echo 服务器 所有的 Netty 服务器都需要以下两部分。\n至少一个 ChannelHandler：处理客户端传过来的数据，实现自己的业务逻辑。 启动引导：绑定端口和启动服务。 通过channelHandler实现服务端 因为你的 Echo 服务器会响应传入的消息，所以它需要实现 ChannelInboundHandler 接口，用来定义响应入站事件的方法。这个简单的应用程序只需要用到少量的这些方法，所以继承 ChannelInboundHandlerAdapter 类也就足够了，它提供了 ChannelInboundHandler 的默认实现。\nchannelRead()：每个传入的消息都要调用该方法。 channelReadComplete()：通知ChannelInboundHandler最后一次对channelRead()的调用是当前批量读取中的最后一条消息。 exceptionCaught()：在读取操作期间，有异常抛出时会调用。\n代码如下\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package nia.chapter2.echoserver; import io.netty.buffer.ByteBuf; import io.netty.buffer.Unpooled; import io.netty.channel.ChannelFutureListener; import io.netty.channel.ChannelHandler.Sharable; import io.netty.channel.ChannelHandlerContext; import io.netty.channel.ChannelInboundHandlerAdapter; import io.netty.util.CharsetUtil; /** * 代码清单 2-1 EchoServerHandler * * @author Norman Maurer */ //标示一个ChannelHandler可以被多个 Channel 安全地共享 @Sharable public class EchoServerHandler extends ChannelInboundHandlerAdapter { @Override public void channelRead(ChannelHandlerContext ctx, Object msg) { ByteBuf in = (ByteBuf) msg; //将消息记录到控制台 System.out.println( \"Server received: \" + in.toString(CharsetUtil.UTF_8)); //将接收到的消息写给发送者，而不冲刷出站消息 ctx.write(in); } @Override public void channelReadComplete(ChannelHandlerContext ctx) throws Exception { //将未决消息冲刷到远程节点，并且关闭该 Channel ctx.writeAndFlush(Unpooled.EMPTY_BUFFER) .addListener(ChannelFutureListener.CLOSE); } @Override public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) { //打印异常栈跟踪 cause.printStackTrace(); //关闭该Channel ctx.close(); } } ChannelInboundHandlerAdapter 有一个直观的 API，并且它的每个方法都可以被重写以挂钩到事件生命周期的恰当点上。因为需要处理所有接收到的数据，所以你重写了 channelRead()方法。在这个服务器应用程序中，你将数据简单地回送给了远程节点。重写 exceptionCaught()方法允许你对 Throwable 的任何子类型做出反应，在这里你记录了异常并关闭了连接。虽然一个更加完善的应用程序也许会尝试从异常中恢复，但在这个场景下，只是通过简单地关闭连接来通知远程节点发生了错误。\n如果不捕获异常，会发生什么呢？每个 Channel 都拥有一个与之相关联的 ChannelPipeline，其持有一个 ChannelHandler 的实例链。在默认的情况下，ChannelHandler 会把对它的方法的调用转发给链中的下一个 ChannelHandler。因此，如果 exceptionCaught()方法没有被该链中的某处实现，那么所接收的异常将会被传递到 ChannelPipeline 的尾端并被记录。为此，你的应用程序应该提供至少有一个实现了exceptionCaught()方法的 ChannelHandler。\n除了 ChannelInboundHandlerAdapter 之外，还有很多需要学习的 ChannelHandler 的 子类型和实现，我们将在第 6 章和第 7 章中对它们进行详细的阐述。目前，请记住下面这些关键点：\n针对不同类型的事件来调用 ChannelHandler； 应用程序通过实现或者扩展 ChannelHandler 来挂钩到事件的生命周期，并且提供自定义的应用程序逻辑； 在架构上，ChannelHandler 有助于保持业务逻辑与网络处理代码的分离。这简化了开发过程，因为代码必须不断地演化以响应不断变化的需求。 编写引导服务器 将端口绑定到服务器上 配置 Channel，以将有关的入站消息通知给 EchoServerHandler 实例。 代码如下\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 package nia.chapter2.echoserver; import io.netty.bootstrap.ServerBootstrap; import io.netty.channel.ChannelFuture; import io.netty.channel.ChannelInitializer; import io.netty.channel.EventLoopGroup; import io.netty.channel.nio.NioEventLoopGroup; import io.netty.channel.socket.SocketChannel; import io.netty.channel.socket.nio.NioServerSocketChannel; import java.net.InetSocketAddress; /** * 代码清单 2-2 EchoServer 类 * * @author Norman Maurer */ public class EchoServer { private final int port; public EchoServer(int port) { this.port = port; } public static void main(String[] args) throws Exception { //调用服务器的 start()方法 new EchoServer(8888).start(); } public void start() throws Exception { final EchoServerHandler serverHandler = new EchoServerHandler(); //(1) 创建EventLoopGroup EventLoopGroup group = new NioEventLoopGroup(); try { //(2) 创建ServerBootstrap ServerBootstrap b = new ServerBootstrap(); b.group(group) //(3) 指定所使用的 NIO 传输 Channel .channel(NioServerSocketChannel.class) //(4) 使用指定的端口设置套接字地址 .localAddress(new InetSocketAddress(port)) //(5) 添加一个EchoServerHandler到于Channel的 ChannelPipeline .childHandler(new ChannelInitializer() { @Override public void initChannel(SocketChannel ch) throws Exception { //EchoServerHandler 被标注为@Shareable，所以我们可以总是使用同样的实例 //这里对于所有的客户端连接来说，都会使用同一个 EchoServerHandler，因为其被标注为@Sharable， //这将在后面的章节中讲到。 ch.pipeline().addLast(serverHandler); } }); //(6) 异步地绑定服务器；调用 sync()方法阻塞等待直到绑定完成 ChannelFuture f = b.bind().sync(); System.out.println(EchoServer.class.getName() + \" started and listening for connections on \" + f.channel().localAddress()); //(7) 获取 Channel 的CloseFuture，并且阻塞当前线程直到它完成 f.channel().closeFuture().sync(); } finally { //(8) 关闭 EventLoopGroup，释放所有的资源 group.shutdownGracefully().sync(); } } } 在(2)处，你创建了一个 ServerBootstrap 实例。因为你正在使用的是 NIO 传输，所以你指定了 (1)NioEventLoopGroup 来接受和处理新的连接，并且将 Channel 的类型指定为 NioServerSocketChannel(3)。 在此之后，你将本地地址设置为一个具有选定端口的 InetSocketAddress(4) 。 服务器将绑定到这个地址以监听新的连接请求。\n在(5)处，你使用了一个特殊的类:ChannelInitializer。这是关键。当一个新的连接被接受时，一个新的子Channel 将会被创建，而 ChannelInitializer 将会把一个你的EchoServerHandler 的实例添加到该 Channel的 ChannelPipeline 中。正如我们之前所解释的，这个 ChannelHandler 将会收到有关入站消息的通知。\n虽然 NIO 是可伸缩的，但是其适当的尤其是关于多线程处理的配置并不简单。Netty 的设计封装了大部分的复杂性，而且我们将在第 3 章中对相关的抽象（EventLoopGroup、SocketChannel 和 ChannelInitializer）进行详细的讨论。\n接下来你绑定了服务器(6)，并等待绑定完成。（对 sync()方法的调用将导致当前 Thread阻塞，一直到绑定操作完成为止）。在(7)处，该应用程序将会阻塞等待直到服务器的 Channel关闭（因为你在 Channel 的CloseFuture 上调用了 sync()方法）。然后，你将可以关闭EventLoopGroup，并释放所有的资源，包括所有被创建的线程(8)。\n与此同时，让我们回顾一下你刚完成的服务器实现中的重要步骤。下面这些是服务器的主要代码组件：\nEchoServerHandler 实现了业务逻辑； main()方法引导了服务器； 引导过程中所需要的步骤如下： 创建一个 ServerBootstrap 的实例以引导和绑定服务器； 创建并分配一个 NioEventLoopGroup 实例以进行事件的处理，如接受新连接以及读/写数据； 指定服务器绑定的本地的 InetSocketAddress； 使用一个 EchoServerHandler 的实例初始化每一个新的 Channel； 调用 ServerBootstrap.bind()方法以绑定服务器。 在这个时候，服务器已经初始化，并且已经就绪能被使用了。下一节我们将探讨对应的客户端应用程序的代码。\n编写echo客户端 Echo 客户端将会： （1）连接到服务器； （2）发送一个或者多个消息； （3）对于每个消息，等待并接收从服务器发回的相同的消息； （4）关闭连接。 编写客户端所涉及的两个主要代码部分也是业务逻辑和引导，和你在服务器中看到的一样。\n通过 ChannelHandler 实现客户端逻辑 如同服务器，客户端将拥有一个用来处理数据的 ChannelInboundHandler。在这个场景下，你将扩展SimpleChannelInboundHandler 类以处理所有必须的任务。我们需要重写如下方法：\nchannelActive()：在到服务器的连接已经建立之后将被调用； channelRead0()：当从服务器接收到一条消息时被调用； exceptionCaught()：在处理过程中引发异常时被调用。\n客户端的channelHandler\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package nia.chapter2.echoclient; import io.netty.buffer.ByteBuf; import io.netty.buffer.Unpooled; import io.netty.channel.ChannelHandler.Sharable; import io.netty.channel.ChannelHandlerContext; import io.netty.channel.SimpleChannelInboundHandler; import io.netty.util.CharsetUtil; /** * 代码清单 2-3 客户端的 ChannelHandler * * @author Norman Maurer */ @Sharable //标记该类的实例可以被多个 Channel 共享 public class EchoClientHandler extends SimpleChannelInboundHandler { @Override public void channelActive(ChannelHandlerContext ctx) { //当被通知 Channel是活跃的时候，发送一条消息 ctx.writeAndFlush(Unpooled.copiedBuffer(\"Netty rocks!\", CharsetUtil.UTF_8)); } @Override public void channelRead0(ChannelHandlerContext ctx, ByteBuf in) { //记录已接收消息的转储 System.out.println(\"Client received: \" + in.toString(CharsetUtil.UTF_8)); } @Override //在发生异常时，记录错误并关闭Channel public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) { cause.printStackTrace(); ctx.close(); } } 重写了 channelActive()方法，其将在一个连接建立时被调用，确保数据将会被尽可能快地写入服务器。内容是一个编码了字符串\"Netty rocks!“的字节缓冲区。\n重写了 channelRead0()方法，每当接收数据时，都会调用这个方法。需要注意的是，由服务器发送的消息可能会被分块接收。也就是说，如果服务器发送了 5 字节，那么不能保证这 5 字节会被一次性接收。即使是对于这么少量的数据，channelRead0()方法也可能会被调用两次，第一次使用一个持有 3 字节的 ByteBuf（Netty 的字节容器），第二次使用一个持有 2 字节的 ByteBuf。作为一个面向流的协议，TCP 保证了字节数组将会按照服务器发送它们的顺序被接收。\n重写了 exceptionCaught()。用于记录 Throwable，关闭 Channel。\nSimpleChannelInboundHandler 与 ChannelInboundHandler 你可能会想：为什么我们在客户端使用的是 SimpleChannelInboundHandler， 而不是在 EchoServerHandler 中所使用的 ChannelInboundHandlerAdapter 呢？ 这和两个因素的相互作用有关：业务逻辑如何处理消息以及 Netty 如何管理资源。\n在客户端，当 channelRead0()方法完成时，你已经有了传入消息，并且已经处理完它了。当该方法返回时，SimpleChannelInboundHandler 负责释放指向保存该消息的 ByteBuf 的内存引用。 在 EchoServerHandler 中，你仍然需要将传入消息回送给发送者，而 write()操作是异步的，直 到 channelRead()方法返回后可能仍然没有完成（如代码清单 2-1 所示）。为此，EchoServerHandler扩展了 ChannelInboundHandlerAdapter，其在这个时间点上不会释放消息。 消息在 EchoServerHandler 的 channelReadComplete()方法中，当 writeAndFlush()方 法被调用时被释放（见代码清单 2-1）。第 5 章和第 6 章将对消息的资源管理进行详细的介绍。\n编写引导客户端 引导客户端类似于引导服务器，不同的是，客户端是使用主机和端口参数来连接远程地址，也就是这里的Echo 服务器的地址，而不是绑定到一个一直被监听的端口。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package nia.chapter2.echoclient; import io.netty.bootstrap.Bootstrap; import io.netty.channel.ChannelFuture; import io.netty.channel.ChannelInitializer; import io.netty.channel.EventLoopGroup; import io.netty.channel.nio.NioEventLoopGroup; import io.netty.channel.socket.SocketChannel; import io.netty.channel.socket.nio.NioSocketChannel; import java.net.InetSocketAddress; /** * 代码清单 2-4 客户端的主类 * * @author Norman Maurer */ public class EchoClient { private final String host; private final int port; public EchoClient(String host, int port) { this.host = host; this.port = port; } public void start() throws Exception { EventLoopGroup group = new NioEventLoopGroup(); try { //创建 Bootstrap Bootstrap b = new Bootstrap(); //指定 EventLoopGroup 以处理客户端事件；需要适用于 NIO 的实现 b.group(group) //适用于 NIO 传输的Channel 类型 .channel(NioSocketChannel.class) //设置服务器的InetSocketAddress .remoteAddress(new InetSocketAddress(host, port)) //在创建Channel时，向 ChannelPipeline中添加一个 EchoClientHandler实例 .handler(new ChannelInitializer() { @Override public void initChannel(SocketChannel ch) throws Exception { ch.pipeline().addLast( new EchoClientHandler()); } }); //连接到远程节点，阻塞等待直到连接完成 ChannelFuture f = b.connect().sync(); //阻塞，直到Channel 关闭 f.channel().closeFuture().sync(); } finally { //关闭线程池并且释放所有的资源 group.shutdownGracefully().sync(); } } public static void main(String[] args) throws Exception { new EchoClient(\"localhost\", 8888).start(); } } 和之前一样，使用了 NIO 传输。注意，你可以在客户端和服务器上分别使用不同的传输。 例如，在服务器端使用 NIO 传输，而在客户端使用 OIO 传输。\n让我们回顾一下这一节中所介绍的要点：\n为初始化客户端，创建了一个 Bootstrap 实例 为进行事件处理分配了一个 NioEventLoopGroup 实例，其中事件处理包括创建新的连接以及处理入站和出站数据 为服务器连接创建了一个 InetSocketAddress 实例 当连接被建立时，一个 EchoClientHandler 实例会被安装到（该 Channel 的）ChannelPipeline 中 在一切都设置完成后，调用 Bootstrap.connect()方法连接到远程节点 服务端和客户端都完成了，可以测试了。\n通过main方法运行EchoServer 控制台打印 nia.chapter2.echoserver.EchoServer started and listening for connections on /0:0:0:0:0:0:0:0:8888\n通过main方法运行EchoClient Client received: Netty rocks!\n服务端再次打印 Server received: Netty rocks!\n下面是发生的事： （1）一旦客户端建立连接，它就发送它的消息——Netty rocks!； （2）服务器报告接收到的消息，并将其回送给客户端； （3）客户端报告返回的消息并退出。\n需要注意，服务端必须先启动，客户端先启动会抛出异常ConnectException。 这个异常不会被exceptionCaught捕捉到。原书这里有些问题。\nNetty的组件和设计 Channel接口 基本的 I/O 操作（bind()、connect()、read()和 write()）依赖于底层网络传输所提供的原语。 在基于 Java 的网络编程中，其基本的构造是 class Socket。Netty 的 Channel 接口所提供的 API， 大大地降低了直接使用 Socket 类的复杂性。此外，Channel 也是拥有许多预定义的、专门化实现的广泛类层次结构的根，下面是一个简短的部分清单： EmbeddedChannel LocalServerChannel NioDatagramChannel NioSctpChannel NioSocketChannel\nEventLoop接口 EventLoop 定义了 Netty 的核心抽象，用于处理连接的生命周期中所发生的事件。我们将在第 7 章中结合 Netty 的线程处理模型的上下文对 EventLoop 进行详细的讨论。目前，下图在高层次上说明了 Channel、EventLoop、Thread 以及 EventLoopGroup 之间的关系。 一个 EventLoopGroup 包含一个或者多个 EventLoop； 一个 EventLoop 在它的生命周期内只和一个 Thread 绑定； 所有由 EventLoop 处理的 I/O 事件都将在它专有的 Thread 上被处理； 一个 Channel 在它的生命周期内只注册于一个 EventLoop； 一个 EventLoop 可能会被分配给一个或多个 Channel。 注意，在这种设计中，一个给定 Channel 的 I/O 操作都是由相同的 Thread 执行的，实际上消除了对于同步的需要。\nChannelFuture接口 正如我们已经解释过的那样，Netty 中所有的 I/O 操作都是异步的。因为一个操作可能不会立即返回，所以我们需要一种用于在之后的某个时间点确定其结果的方法。为此，Netty 提供了ChannelFuture 接口，其 addListener()方法注册了一个 ChannelFutureListener，以便在某个操作完成时（无论是否成功）得到通知。\nChannelHandler接口 从应用程序开发人员的角度来看，Netty 的主要组件是 ChannelHandler，它充当了所有处理入站和出站数据的应用程序逻辑的容器。这是可行的，因为 ChannelHandler 的方法是由网络事件（其中术语“事件”的使用非常广泛）触发的。事实上，ChannelHandler 可专门用于几乎任何类型的动作，例如将数据从一种格式转换为另外一种格式，或者处理转换过程中所抛出的异常。 举例来说，ChannelInboundHandler 是一个你将会经常实现的子接口。这种类型的ChannelHandler 接收入站事件和数据，这些数据随后将会被你的应用程序的业务逻辑所处理。当你要给连接的客户端发送响应时，也可以从 ChannelInboundHandler 冲刷数据。你的应用程序的业务逻辑通常驻留在一个或者多个 ChannelInboundHandler 中。\nChannelPipeline接口 ChannelPipeline 提供了 ChannelHandler 链的容器，并定义了用于在该链上传播入站和出站事件流的 API。 当 Channel 被创建时，它会被自动地分配到它专属的 ChannelPipeline。 ChannelHandler 安装到 ChannelPipeline 中的过程如下所示：\n一个ChannelInitializer的实现被注册到了ServerBootstrap中 当 ChannelInitializer.initChannel()方法被调用时，ChannelInitializer 将在 ChannelPipeline 中安装一组自定义的 ChannelHandler ChannelInitializer 将它自己从 ChannelPipeline 中移除。 ChannelHandler 是专为支持广泛的用途而设计的，可以将它看作是处理往来 ChannelPipeline 事件 （包括数据）的任何代码的通用容器。图 3-2 说明了这一点，其展示了从 ChannelHandler 派生的 ChannelInboundHandler 和 ChannelOutboundHandler 接口。 使得事件流经 ChannelPipeline 是 ChannelHandler 的工作，它们是在应用程序的初始化或者引导阶段被安装的。这些对象接收事件、执行它们所实现的处理逻辑，并将数据传递给链中的下一个 ChannelHandler。 它们的执行顺序是由它们被添加的顺序所决定的。实际上，被我们称为 ChannelPipeline 的是这些 ChannelHandler 的编排顺序。\n图 3-3 说明了一个 Netty 应用程序中入站和出站数据流之间的区别。从一个客户端应用程序的角度来看，如果事件的运动方向是从客户端到服务器端，那么我们称这些事件为出站的，反之则称为入站的。 图 3-3 也显示了入站和出站 ChannelHandler 可以被安装到同一个 ChannelPipeline中。如果一个消息或者任何其他的入站事件被读取，那么它会从 ChannelPipeline 的头部开始流动，并被传递给第一个ChannelInboundHandler。这个 ChannelHandler 不一定会实际地修改数据，具体取决于它的具体功能，在这之后，数据将会被传递给链中的下一个ChannelInboundHandler。最终，数据将会到达 ChannelPipeline 的尾端，届时，所有处理就都结束了。\n数据的出站运动（即正在被写的数据）在概念上也是一样的。在这种情况下，数据将从 ChannelOutboundHandler 链的尾端开始流动，直到它到达链的头部为止。在这之后，出站数据将会到达网络传输层，这里显示为 Socket。通常情况下，这将触发一个写操作。\n关于入站和出站 ChannelHandler 的更多讨论 通过使用作为参数传递到每个方法的 ChannelHandlerContext，事件可以被传递给当前 ChannelHandler 链中的下一个 ChannelHandler。因为你有时会忽略那些不感兴趣的事件，所以 Netty提供了抽象基类 ChannelInboundHandlerAdapter 和 ChannelOutboundHandlerAdapter。通过调用 ChannelHandlerContext 上的对应方法，每个都提供了简单地将事件传递给下一个ChannelHandler的方法的实现。随后，你可以通过重写你所感兴趣的那些方法来扩展这些类。\n鉴于出站操作和入站操作是不同的，你可能会想知道如果将两个类别的 ChannelHandler都混合添加到同一个 ChannelPipeline 中会发生什么。虽然 ChannelInboundHandle 和ChannelOutboundHandle 都扩展自ChannelHandler，但是 Netty 能区分 ChannelInboundHandler 实现和 ChannelOutboundHandler 实现，并确保数据只会在具有相同定向类型的两个 ChannelHandler 之间传递。\n当ChannelHandler 被添加到ChannelPipeline 时，它将会被分配一个ChannelHandlerContext，其代表了ChannelHandler 和 ChannelPipeline 之间的绑定。虽然这个对象可以被用于获取底层的 Channel，但是它主要还是被用于写出站数据。 在 Netty 中，有两种发送消息的方式。你可以直接写到 Channel 中，也可以 写到和 ChannelHandler相关联的ChannelHandlerContext对象中。前一种方式将会导致消息从ChannelPipeline 的尾端开始流动，而后者将导致消息从 ChannelPipeline 中的下一个 ChannelHandler 开始流动。\n更加深入地了解 ChannelHandler 正如我们之前所说的，有许多不同类型的 ChannelHandler，它们各自的功能主要取决于它们的超类。Netty 以适配器类的形式提供了大量默认的 ChannelHandler 实现，其旨在简化应用程序处理逻辑的开发过程。你已经看到了，ChannelPipeline中的每个ChannelHandler将负责把事件转发到链中的下一个ChannelHandler。这些适配器类（及它们的子类）将自动执行这个操作，所以你可以只重写那些你想要特殊处理的方法和事件。\n为什么需要适配器类 有一些适配器类可以将编写自定义的 ChannelHandler 所需要的努力降到最低限度，因为它们提供了定义在对应接口中的所有方法的默认实现。 下面这些是编写自定义 ChannelHandler 时经常会用到的适配器类： ChannelHandlerAdapter ChannelInboundHandlerAdapter ChannelOutboundHandlerAdapter ChannelDuplexHandler\n接下来我们将研究 3 个 ChannelHandler 的子类型：编码器、解码器和 SimpleChannelInboundHandler—— ChannelInboundHandlerAdapter 的一个子类。\n编码器和解码器 当你通过 Netty 发送或者接收一个消息的时候，就将会发生一次数据转换。入站消息会被解码； 也就是说，从字节转换为另一种格式，通常是一个 Java 对象。如果是出站消息，则会发生相反方向的转换：它将从它的当前格式被编码为字节。这两种方向的转换的原因很简单：网络数据总是一系列的字节。\n对应于特定的需要，Netty 为编码器和解码器提供了不同类型的抽象类。例如，你的应用程序可能使用了一种中间格式，而不需要立即将消息转换成字节。你将仍然需要一个编码器，但是它将派生自一个不同的超类。 为了确定合适的编码器类型，你可以应用一个简单的命名约定。通常来说，这些基类的名称将类似于ByteToMessageDecoder 或 MessageToByteEncoder。对于特殊的类型，你可能会发现类似于 ProtobufEncoder 和 ProtobufDecoder这样的名称——预置的用来支持 Google 的 Protocol Buffers。\n严格地说，其他的处理器也可以完成编码器和解码器的功能。但是，正如有用来简化ChannelHandler 的创建的适配器类一样，所有由 Netty 提供的编码器/解码器适配器类都实现了 ChannelOutboundHandler 或者 ChannelInboundHandler 接口。\n你将会发现对于入站数据来说，channelRead 方法/事件已经被重写了。对于每个从入站Channel 读取的消息，这个方法都将会被调用。随后，它将调用由预置解码器所提供的 decode() 方法，并将已解码的字节转发给 ChannelPipeline 中的下一个 ChannelInboundHandler。出站消息的模式是相反方向的：编码器将消息转换为字节，并将它们转发给下一ChannelOutboundHandler。\n抽象类 SimpleChannelInboundHandler 通常我们会使用一个 ChannelHandler 来接收解码消息，并结合业务逻辑来处理这个消息。 要创建一个这样的 ChannelHandler，你只需要扩展基类 SimpleChannelInboundHandler， 其中 T 是你要处理的消息的 Java 类型 。在这个 ChannelHandler 中，你将需要重写基类的一个或者多个方法，并且获取一个到 ChannelHandlerContext 的引用，这个引用将作为输入参数传递给 ChannelHandler 的所有方法。 在这种类型的 ChannelHandler 中，最重要的方法是 channelRead0(ChannelHandlerContext,T)。 除了要求不要阻塞当前的 I/O 线程之外，其具体实现完全取决于你。我们稍后将对这一主题进行更多的说明。\n引导类 Netty 的引导类为应用程序的网络层配置提供了容器，这涉及将一个进程绑定到某个指定的端口，或者将一个进程连接到另一个运行在某个指定主机的指定端口上的进程。通常来说，我们把前面的用例称作引导一个服务器，后面的用例称作引导一个客户端。虽然这个术语简单方便，但是它略微掩盖了一个重要的事实，即“服务器”和“客户端”实际上表示了不同的网络行为；换句话说，是监听传入的连接还是建立到一个或者多个进程的连接。\n因此，有两种类型的引导：Bootstrap用于客户端，ServerBootstrap用于服务器。 无论你的应用程序使用哪种协议或者处理哪种类型的数据，唯一决定它使用哪种引导类的是它是作为一个客户端还是作为一个服务器。两种引导类的区别是：\n类别 网络编程中的作用 EventLoopGroup 的数目 bootstrap 连接远程主机和端口 1 serverbootstrap 绑定到一个本地端口 2 引导一个客户端只需要一个 EventLoopGroup，但是一个ServerBootstrap 则需要两个（也可以是同一个实例）。为什么呢？（实际上，ServerBootstrap 类也可以只使用一个 EventLoopGroup，此时其将在两个场景下共用同一个 EventLoopGroup。）\n因为服务器需要两组不同的 Channel。第一组将只包含一个 ServerChannel，代表服务器自身的已绑定到某个本地端口的正在监听的套接字。而第二组将包含所有已创建的用来处理传入客户端连接（对于每个服务器已经接受的连接都有一个）的 Channel。图 3-4 说明了这个模型，并且展示了为何需要两个不同的 EventLoopGroup。 与 ServerChannel 相关联的 EventLoopGroup 将分配一个负责为传入连接请求创建Channel 的 EventLoop。一旦连接被接受，第二个 EventLoopGroup 就会给它的 Channel分配一个 EventLoop。\n传输 案例研究 我们将从一个应用程序开始我们对传输的学习，这个应用程序只简单地接受连接，向客户端写“Hi!”，然后关闭连接。\n不通过 Netty 使用 OIO 和 NIO 我们将介绍仅使用了 JDK API 的应用程序的阻塞（OIO）版本和异步（NIO）版本。代码清单 4-1 展示了其s阻塞版本的实现。如果你曾享受过使用 JDK 进行网络编程的乐趣，那么这段代码将唤起你美好的回忆。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 /** * 代码清单 4-1 未使用 Netty 的阻塞网络编程 */ public class PlainOioServer { public void server(int port) throws IOException { //将服务器绑定到指定端口 final ServerSocket socket = new ServerSocket(port); try { for(;;) { //接受连接 final Socket clientSocket = socket.accept(); System.out.println(\"Accepted connection from \" + clientSocket); //创建一个新的线程来处理该连接 new Thread(new Runnable() { @Override public void run() { OutputStream out; try { //将消息写给已连接的客户端 out = clientSocket.getOutputStream(); out.write(\"Hi!\\r\\n\".getBytes(Charset.forName(\"UTF-8\"))); out.flush(); //关闭连接 clientSocket.close(); } catch (IOException e) { e.printStackTrace(); } finally { try { clientSocket.close(); } catch (IOException ex) { // ignore on close } } //启动线程 } }).start(); } } catch (IOException e) { e.printStackTrace(); } } } 这段代码完全可以处理中等数量的并发客户端。但是随着应用程序变得流行起来，你会发现它并不能很好地伸缩到支撑成千上万的并发连入连接。你决定改用异步网络编程，但是很快就发现异步 API 是完全不同的，以至于现在你不得不重写你的应用程序。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 /** * 代码清单 4-2 未使用 Netty 的异步网络编程 */ public class PlainNioServer { public void server(int port) throws IOException { ServerSocketChannel serverChannel = ServerSocketChannel.open(); serverChannel.configureBlocking(false); ServerSocket ss = serverChannel.socket(); InetSocketAddress address = new InetSocketAddress(port); //将服务器绑定到选定的端口 ss.bind(address); //打开Selector来处理 Channel Selector selector = Selector.open(); //将ServerSocketChannel注册到Selector以接受连接 serverChannel.register(selector, SelectionKey.OP_ACCEPT); final ByteBuffer msg = ByteBuffer.wrap(\"Hi!\\r\\n\".getBytes()); for (;;){ try { //等待需要处理的新事件；阻塞将一直持续到下一个传入事件 selector.select(); } catch (IOException ex) { ex.printStackTrace(); //handle exception break; } //获取所有接收事件的SelectionKey实例 Set readyKeys = selector.selectedKeys(); Iterator iterator = readyKeys.iterator(); while (iterator.hasNext()) { SelectionKey key = iterator.next(); iterator.remove(); try { //检查事件是否是一个新的已经就绪可以被接受的连接 if (key.isAcceptable()) { ServerSocketChannel server = (ServerSocketChannel) key.channel(); SocketChannel client = server.accept(); client.configureBlocking(false); //接受客户端，并将它注册到选择器 client.register(selector, SelectionKey.OP_WRITE | SelectionKey.OP_READ, msg.duplicate()); System.out.println(\"Accepted connection from \" + client); } //检查套接字是否已经准备好写数据 if (key.isWritable()) { SocketChannel client = (SocketChannel) key.channel(); ByteBuffer buffer = (ByteBuffer) key.attachment(); while (buffer.hasRemaining()) { //将数据写到已连接的客户端 if (client.write(buffer) == 0) { break; } } //关闭连接 client.close(); } } catch (IOException ex) { key.cancel(); try { key.channel().close(); } catch (IOException cex) { // ignore on close } } } } } } 如同你所看到的，虽然这段代码所做的事情与之前的版本完全相同，但是代码却截然不同。如果为了用于非阻塞 I/O 而重新实现这个简单的应用程序，都需要一次完全的重写的话，那么不难想象，移植真正复杂的应用程序需要付出什么样的努力。鉴于此，让我们来看看使用 Netty 实现该应用程序将会是什么样子吧。\n通过 Netty 使用 OIO 和 NIO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 /** * 代码清单 4-3 使用 Netty 的阻塞网络编程 */ public class NettyOioServer { public void server(int port) throws Exception { final ByteBuf buf = Unpooled.unreleasableBuffer(Unpooled.copiedBuffer(\"Hi!\\r\\n\", Charset.forName(\"UTF-8\"))); EventLoopGroup group = new OioEventLoopGroup(); try { //创建 ServerBootstrap ServerBootstrap b = new ServerBootstrap(); b.group(group) //使用 OioEventLoopGroup以允许阻塞模式（旧的I/O） .channel(OioServerSocketChannel.class) .localAddress(new InetSocketAddress(port)) //指定 ChannelInitializer，对于每个已接受的连接都调用它 .childHandler(new ChannelInitializer() { @Override public void initChannel(SocketChannel ch) throws Exception { ch.pipeline().addLast( //添加一个 ChannelInboundHandlerAdapter以拦截和处理事件 new ChannelInboundHandlerAdapter() { @Override public void channelActive(ChannelHandlerContext ctx) throws Exception { ctx.writeAndFlush(buf.duplicate()) .addListener( //将消息写到客户端，并添加 ChannelFutureListener， //以便消息一被写完就关闭连接 ChannelFutureListener.CLOSE); } }); } }); //绑定服务器以接受连接 ChannelFuture f = b.bind().sync(); f.channel().closeFuture().sync(); } finally { //释放所有的资源 group.shutdownGracefully().sync(); } } } 非阻塞的 Netty 版本 代码清单 4-4 和代码清单 4-3 几乎一模一样，除了高亮显示的那两行。这就是从阻塞（OIO）传输切换到非阻塞（NIO）传输需要做的所有变更。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 /** * 代码清单 4-4 使用 Netty 的异步网络处理 */ public class NettyNioServer { public void server(int port) throws Exception { final ByteBuf buf = Unpooled.unreleasableBuffer(Unpooled.copiedBuffer(\"Hi!\\r\\n\", Charset.forName(\"UTF-8\"))); //为非阻塞模式使用NioEventLoopGroup NioEventLoopGroup group = new NioEventLoopGroup(); try { //创建ServerBootstrap ServerBootstrap b = new ServerBootstrap(); b.group(group).channel(NioServerSocketChannel.class) .localAddress(new InetSocketAddress(port)) //指定 ChannelInitializer，对于每个已接受的连接都调用它 .childHandler(new ChannelInitializer() { @Override public void initChannel(SocketChannel ch) throws Exception { ch.pipeline().addLast( //添加 ChannelInboundHandlerAdapter以接收和处理事件 new ChannelInboundHandlerAdapter() { @Override public void channelActive( //将消息写到客户端，并添加ChannelFutureListener， //以便消息一被写完就关闭连接 ChannelHandlerContext ctx) throws Exception { ctx.writeAndFlush(buf.duplicate()) .addListener( ChannelFutureListener.CLOSE); } }); } } ); //绑定服务器以接受连接 ChannelFuture f = b.bind().sync(); f.channel().closeFuture().sync(); } finally { //释放所有的资源 group.shutdownGracefully().sync(); } } } 因为 Netty 为每种传输的实现都暴露了相同的 API，所以无论选用哪一种传输的实现，你的代码都仍然几乎不受影响。在所有的情况下，传输的实现都依赖于 interface Channel、ChannelPipeline 和 ChannelHandler。在看过一些使用基于 Netty 的传输的这些优点之后，让我们仔细看看传输 API 本身。\n传输API 传输 API 的核心是 interface Channel，它被用于所有的 I/O 操作。Channel 类的层次结构如图 4-1 所示。 如图所示，每个 Channel 都将会被分配一个 ChannelPipeline 和 ChannelConfig。ChannelConfig 包含了该 Channel 的所有配置设置，并且支持热更新。由于特定的传输可能具有独特的设置，所以它可能会实现一个 ChannelConfig 的子类型。（请参考 ChannelConfig实现对应的 Javadoc。） 由于 Channel 是独一无二的，所以为了保证顺序将 Channel 声明为 java.lang.Comparable 的一个子接口。因此，如果两个不同的 Channel 实例都返回了相同的散列码，那么 AbstractChannel 中的 compareTo()方法的实现将会抛出一个 Error。\nChannelPipeline 持有所有将应用于入站和出站数据以及事件的 ChannelHandler 实例，这些 ChannelHandler 实现了应用程序用于处理状态变化以及数据处理的逻辑。\nChannelHandler 的典型用途包括：\n将数据从一种格式转换为另一种格式； 提供异常的通知； 提供 Channel 变为活动的或者非活动的通知； 提供当 Channel 注册到 EventLoop 或者从 EventLoop 注销时的通知； 提供有关用户自定义事件的通知。 你也可以根据需要通过添加或者移除ChannelHandler实例来修改ChannelPipeline。\n通过利用Netty的这项能力可以构建出高度灵活的应用程序。例如，每当STARTTLS①协议被请求时，你可以简单地通过 向 ChannelPipeline 添 加 一个适当的 ChannelHandler（SslHandler）来按需地支持STARTTLS协议。除了访问所分配的 ChannelPipeline 和 ChannelConfig 之外，也可以利用 Channel的其他方法，如下：\n方法名 描述 eventLoop 返回分配给 Channel 的 EventLoop pipeline 返回分配给 Channel 的 ChannelPipeline isActive 如果 Channel 是活动的，则返回 true。活动的意义可能依赖于底层的传输。例如， 一个 Socket 传输一旦连接到了远程节点便是活动的，而一个 Datagram 传输一旦被打开便是活动的 localAddress 返回本地的 SokcetAddress remoteAddress 返回远程的 SocketAddress write 将数据写到远程节点。这个数据将被传递给 ChannelPipeline，并且排队直到它被冲刷 flush 将之前已写的数据冲刷到底层传输，如一个 Socket writeAndFlush 一个简便的方法，等同于调用 write()并接着调用 flush() 稍后我们将进一步深入地讨论所有这些特性的应用。目前，请记住，Netty 所提供的广泛功能只依赖于少量的接口。这意味着，你可以对你的应用程序逻辑进行重大的修改，而又无需大规模地重构你的代码库。\n考虑一下写数据并将其冲刷到远程节点这样的常规任务。代码清单 4-5 演示了使用Channel.writeAndFlush()来实现这一目的。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 /** * 代码清单 4-5 写出到 Channel * * 代码清单 4-6 从多个线程使用同一个 Channel */ public class ChannelOperationExamples { private static final Channel CHANNEL_FROM_SOMEWHERE = new NioSocketChannel(); /** * 代码清单 4-5 写出到 Channel */ public static void writingToChannel() { Channel channel = CHANNEL_FROM_SOMEWHERE; // Get the channel reference from somewhere //创建持有要写数据的 ByteBuf ByteBuf buf = Unpooled.copiedBuffer(\"your data\", CharsetUtil.UTF_8); ChannelFuture cf = channel.writeAndFlush(buf); //添加 ChannelFutureListener 以便在写操作完成后接收通知 cf.addListener(new ChannelFutureListener() { @Override public void operationComplete(ChannelFuture future) { //写操作完成，并且没有错误发生 if (future.isSuccess()) { System.out.println(\"Write successful\"); } else { //记录错误 System.err.println(\"Write error\"); future.cause().printStackTrace(); } } }); } /** * 代码清单 4-6 从多个线程使用同一个 Channel */ public static void writingToChannelFromManyThreads() { final Channel channel = CHANNEL_FROM_SOMEWHERE; // Get the channel reference from somewhere //创建持有要写数据的ByteBuf final ByteBuf buf = Unpooled.copiedBuffer(\"your data\", CharsetUtil.UTF_8); //创建将数据写到Channel 的 Runnable Runnable writer = new Runnable() { @Override public void run() { channel.write(buf.duplicate()); } }; //获取到线程池Executor 的引用 Executor executor = Executors.newCachedThreadPool(); //递交写任务给线程池以便在某个线程中执行 // write in one thread executor.execute(writer); //递交另一个写任务以便在另一个线程中执行 // write in another thread executor.execute(writer); //... } } Netty 的 Channel 实现是线程安全的，因此你可以存储一个到 Channel 的引用，并且每当你需要向远程节点写数据时，都可以使用它，即使当时许多线程都在使用它。代码清单 4-6 （上边）展示了一个多线程写数据的简单例子。需要注意的是，消息将会被保证按顺序发送。\n内置的传输 Netty 内置了一些可开箱即用的传输。因为并不是它们所有的传输都支持每一种协议，所以你必须选择一个和你的应用程序所使用的协议相容的传输。在本节中我们将讨论这些关系。\n名称 包 描述 NIO io.netty.channel.socket.nio 使用 java.nio.channels 包作为基础——基于 选择器的方式 Epoll io.netty.channel.epoll 由 JNI 驱动的 epoll()和非阻塞 IO。这个传输支持 只有在Linux上可用的多种特性，如SO_REUSEPORT， 比 NIO 传输更快，而且是完全非阻塞的 OIO io.netty.channel.socket.oio 使用 java.net 包作为基础——使用阻塞流 Local io.netty.channel.local 可以在 VM 内部通过管道进行通信的本地传输 Embedded io.netty.channel.embedded Embedded 传输，允许使用 ChannelHandler 而又 不需要一个真正的基于网络的传输。这在测试你的 ChannelHandler 实现时非常有用 NIO——非阻塞 I/O NIO 提供了一个所有 I/O 操作的全异步的实现。它利用了自 NIO 子系统被引入 JDK 1.4 时便可用的基于选择器的 API。选择器背后的基本概念是充当一个注册表，在那里你将可以请求在 Channel 的状态发生变化时得到通知。可能的状态变化有：\n新的 Channel 已被接受并且就绪； Channel 连接已经完成； Channel 有已经就绪的可供读取的数据； Channel 可用于写数据。 选择器运行在一个检查状态变化并对其做出相应响应的线程上，在应用程序对状态的改变做出响应之后，选择器将会被重置，并将重复这个过程。表4-3中的常量值代表了由class java.nio.channels.SelectionKey定义的位模式。这些位模式可以组合起来定义一组应用程序正在请求通知的状态变化集。\n名称 描述 OP_ACCEPT 请求在接受新连接并创建 Channel 时获得通知 OP_CONNECT 请求在建立一个连接时获得通知 OP_READ 请求当数据已经就绪，可以从 Channel 中读取时获得通知 OP_WRITE 请求当可以向 Channel 中写更多的数据时获得通知。这处理了套接字缓冲区被完 全填满时的情况，这种情况通常发生在数据的发送速度比远程节点可处理的速度更 快的时候 对于所有 Netty 的传输实现都共有的用户级别 API 完全地隐藏了这些 NIO 的内部细节。图 4-2 展示了该处理流程。 零拷贝（zero-copy）是一种目前只有在使用 NIO 和 Epoll 传输时才可使用的特性。它使你可以快速高效地将数据从文件系统移动到网络接口，而不需要将其从内核空间复制到用户空间，其在像 FTP 或者HTTP 这样的协议中可以显著地提升性能。但是，并不是所有的操作系统都支持这一特性。特别地，它对于实现了数据加密或者压缩的文件系统是不可用的——只能传输文件的原始内容。反过来说，传输已被加密的文件则不是问题。\nEpoll—用于 Linux 的本地非阻塞传输 正如我们之前所说的，Netty 的 NIO 传输基于 Java 提供的异步/非阻塞网络编程的通用抽象。虽然这保证了Netty 的非阻塞 API 可以在任何平台上使用，但它也包含了相应的限制，因为 JDK为了在所有系统上提供相同的功能，必须做出妥协。Linux作为高性能网络编程的平台，其重要性与日俱增，这催生了大量先进特性的开发，其中包括epoll——一个高度可扩展的I/O事件通知特性。这个API自Linux内核版本 2.5.44（2002）被引入，提供了比旧的POSIX select和poll系统调用更好的性能。同时现在也是Linux上非阻塞网络编程的事实标准。Linux JDK NIO API使用了这些epoll调用。 Netty为Linux提供了一组NIO API，其以一种和它本身的设计更加一致的方式使用epoll，并且以一种更加轻量的方式使用中断。如果你的应用程序旨在运行于Linux系统，那么请考虑利用这个版本的传输；你将发现在高负载下它的性能要优于JDK的NIO实现。\n这个传输的语义与在图 4-2 所示的完全相同，而且它的用法也是简单直接的。相关示例参照代码清单 4-4。如果要在那个代码清单中使用 epoll 替代 NIO，只需要将 NioEventLoopGroup替换为 EpollEventLoopGroup，并且将 NioServerSocketChannel.class 替换为EpollServerSocketChannel.class 即可。\nOIO—旧的阻塞 I/O Netty 的 OIO 传输实现代表了一种折中：它可以通过常规的传输 API 使用，但是由于它是建立在 java.net 包的阻塞实现之上的，所以它不是异步的。但是，它仍然非常适合于某些用途。例如，你可能需要移植使用了一些进行阻塞调用的库（如JDBC）的遗留代码，而将逻辑转换为非阻塞的可能也是不切实际的。相反，你可以在短期内使用Netty的OIO传输，然后再将你的代码移植到纯粹的异步传输上。让我们来看一看怎么做。\n在 java.net API 中，你通常会有一个用来接受到达正在监听的 ServerSocket 的新连接的线程。会创建一个新的和远程节点进行交互的套接字，并且会分配一个新的用于处理相应通信流量的线程。这是必需的，因为某个指定套接字上的任何 I/O 操作在任意的时间点上都可能会阻塞。使用单个线程来处理多个套接字，很容易导致一个套接字上的阻塞操作也捆绑了所有其他的套接字。\n有了这个背景，你可能会想，Netty是如何能够使用和用于异步传输相同的API来支持OIO的呢。答案就是，Netty利用了SO_TIMEOUT这个Socket标志，它指定了等待一个I/O操作完成的最大毫秒数。如果操作在指定的时间间隔内没有完成，则将会抛出一个SocketTimeout Exception。Netty将捕获这个异常并继续处理循环。 在EventLoop下一次运行时，它将再次尝试。这实际上也是类似于Netty这样的异步框架能够支持OIO的唯一方式。\n用于 JVM 内部通信的 Local 传输 Netty 提供了一个 Local 传输，用于在同一个 JVM 中运行的客户端和服务器程序之间的异步通信。同样，这个传输也支持对于所有 Netty 传输实现都共同的 API。 在这个传输中，和服务器 Channel 相关联的 SocketAddress 并没有绑定物理网络地址；相反，只要服务器还在运行，它就会被存储在注册表里，并在 Channel 关闭时注销。因为这个传输并不接受真正的网络流量，所以它并不能够和其他传输实现进行互操作。因此，客户端希望连接到（在同一个 JVM 中）使用了这个传输的服务器端时也必须使用它。除了这个限制，它的使用方式和其他的传输一模一样。 Embedded 传输 Netty 提供了一种额外的传输，使得你可以将一组 ChannelHandler 作为帮助器类嵌入到其他的 ChannelHandler 内部。通过这种方式，你将可以扩展一个 ChannelHandler 的功能，而又不需要修改其内部代码。不足为奇的是，Embedded 传输的关键是一个被称为 EmbeddedChannel 的具体的 Channel实现。在第 9 章中，我们将详细地讨论如何使用这个类来为 ChannelHandler 的实现创建单元测试用例。\n选择哪一种传输 非阻塞代码库 如果你的代码库中没有阻塞调用（或者你能够限制它们的范围），那么在 Linux 上使用 NIO 或者 epoll 始终是个好主意。虽然 NIO/epoll 旨在处理大量的并发连接，但是在处理较小数目的并发连接时，它也能很好地工作，尤其是考虑到它在连接之间共享线程的方式。\n阻塞代码库 正如我们已经指出的，如果你的代码库严重地依赖于阻塞 I/O，而且你的应用程序也有一个相应的设计，那么在你尝试将其直接转换为 Netty 的 NIO 传输时，你将可能会遇到和阻塞操作相关的问题。不要为此而重写你的代码，可以考虑分阶段迁移：先从OIO 开始，等你的代码修改好之后，再迁移到 NIO（或者使用 epoll，如果你在使用 Linux）。\n在同一个 JVM 内部的通信 —在同一个 JVM 内部的通信，不需要通过网络暴露服务，是Local 传输的完美用例。这将消除所有真实网络操作的开销，同时仍然使用你的 Netty 代码库。如果随后需要通过网络暴露服务，那么你将只需要把传输改为 NIO 或者 OIO 即可。\n测试你的 ChannelHandler 实现 如果你想要为自己的 ChannelHandler 实现编写单元测试，那么请考虑使用 Embedded 传输。这既便于测试你的代码，而又不需要创建大量的模拟（mock）对象。你的类将仍然符合常规的 API 事件流，保证该 ChannelHandler在和真实的传输一起使用时能够正确地工作。\nByteBuf 网络数据的基本单位总是字节。Java NIO 提供了 ByteBuffer 作为它的字节容器，但是这个类使用起来过于复杂。Netty 的 ByteBuffer 替代品是 ByteBuf，一个强大的实现，既解决了 JDK API 的局限性，又为网络应用程序的开发者提供了更好的 API。在本章中我们将会说明和 JDK 的 ByteBuffer 相比，ByteBuf 的卓越功能性和灵活性。这也将有助于更好地理解 Netty 数据处理的一般方式，并为将在第 6 章中针对ChannelPipeline和 ChannelHandler 的讨论做好准备。\nByteBuf 的 API Netty 的数据处理 API 通过两个组件暴露——abstract class ByteBuf 和 interfaceByteBufHolder。 下面是一些 ByteBuf API 的优点\n它可以被用户自定义的缓冲区类型扩展； 通过内置的复合缓冲区类型实现了透明的零拷贝； 容量可以按需增长（类似于 JDK 的 StringBuilder）； 在读和写这两种模式之间切换不需要调用 ByteBuffer 的 flip()方法； 读和写使用了不同的索引； 支持方法的链式调用 支持引用计数； 支持池化。 其他类可用于管理 ByteBuf 实例的分配，以及执行各种针对于数据容器本身和它所持有的数据的操作。我们将在仔细研究 ByteBuf 和 ByteBufHolder 时探讨这些特性。 ByteBuf 类——Netty 的数据容器 因为所有的网络通信都涉及字节序列的移动，所以高效易用的数据结构明显是必不可少的。 Netty 的 ByteBuf 实现满足并超越了这些需求。让我们首先来看看它是如何通过使用不同的索引来简化对它所包含的数据的访问的吧。\nbytebuf如何工作 ByteBuf 维护了两个不同的索引：一个用于读取，一个用于写入。当你从 ByteBuf 读取时， 它的 readerIndex 将会被递增已经被读取的字节数。同样地，当你写入 ByteBuf 时，它的 writerIndex 也会被递增。图 5-1 展示了一个空 ByteBuf 的布局结构和状态。 要了解这些索引两两之间的关系，请考虑一下，如果打算读取字节直到 readerIndex 达到 和 writerIndex 同样的值时会发生什么。在那时，你将会到达“可以读取的”数据的末尾。就如同试图读取超出数组末尾的数据一样，试图读取超出该点的数据将会触发一个 IndexOutOfBoundsException。\n名称以 read 或者 write 开头的 ByteBuf 方法，将会推进其对应的索引，而名称以 set 或 者 get 开头的操作则不会。后面的这些方法将在作为一个参数传入的一个相对索引上执行操作。 可以指定 ByteBuf 的最大容量。试图移动写索引（即 writerIndex）超过这个值将会触发一个异常①。（默认的限制是 Integer.MAX_VALUE。）\nByteBuf 的使用模式 在使用 Netty 时，你将遇到几种常见的围绕 ByteBuf 而构建的使用模式。在研究它们时，我们心里想着图 5-1 会有所裨益，一个由不同的索引分别控制读访问和写访问的字节数组。\n堆缓冲区 最常用的 ByteBuf 模式是将数据存储在 JVM 的堆空间中。这种模式被称为支撑数组 （backing array），它能在没有使用池化的情况下提供快速的分配和释放。这种方式，如代码清单 5-1 所示，非常适合于有遗留的数据需要处理的情况。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /** * 代码清单 5-1 支撑数组 */ public static void heapBuffer() { ByteBuf heapBuf = BYTE_BUF_FROM_SOMEWHERE; //get reference form somewhere //检查 ByteBuf 是否有一个支撑数组 if (heapBuf.hasArray()) { //如果有，则获取对该数组的引用 byte[] array = heapBuf.array(); //计算第一个字节的偏移量 int offset = heapBuf.arrayOffset() + heapBuf.readerIndex(); //获得可读字节数 int length = heapBuf.readableBytes(); //使用数组、偏移量和长度作为参数调用你的方法 handleArray(array, offset, length); } } 直接缓冲区 直接缓冲区是另外一种 ByteBuf 模式。我们期望用于对象创建的内存分配永远都来自于堆中，但这并不是必须的——NIO 在 JDK 1.4 中引入的 ByteBuffer 类允许 JVM 实现通过本地调用来分配内存。这主要是为了避免在每次调用本地 I/O 操作之前（或者之后）将缓冲区的内容复制到一个中间缓冲区（或者从中间缓冲区把内容复制到缓冲区）。\nByteBuffer的Javadoc明确指出：“直接缓冲区的内容将驻留在常规的会被垃圾回收的堆之外。”这也就解释了为何直接缓冲区对于网络数据传输是理想的选择。如果你的数据包含在一个在堆上分配的缓冲区中，那么事实上，在通过套接字发送它之前，JVM将会在内部把你的缓冲区复制到一个直接缓冲区中。\n直接缓冲区的主要缺点是，相对于基于堆的缓冲区，它们的分配和释放都较为昂贵。如果你正在处理遗留代码，你也可能会遇到另外一个缺点：因为数据不是在堆上，所以你不得不进行一次复制，如代码清单 5-2 所示。显然，与使用支撑数组相比，这涉及的工作更多。因此，如果事先知道容器中的数据将会被作为数组来访问，你可能更愿意使用堆内存。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /** * 代码清单 5-2 访问直接缓冲区的数据 */ public static void directBuffer() { ByteBuf directBuf = BYTE_BUF_FROM_SOMEWHERE; //get reference form somewhere //检查 ByteBuf 是否由数组支撑。如果不是，则这是一个直接缓冲区 if (!directBuf.hasArray()) { //获取可读字节数 int length = directBuf.readableBytes(); //分配一个新的数组来保存具有该长度的字节数据 byte[] array = new byte[length]; //将字节复制到该数组 directBuf.getBytes(directBuf.readerIndex(), array); //使用数组、偏移量和长度作为参数调用你的方法 handleArray(array, 0, length); } } 复合缓冲区 第三种也是最后一种模式使用的是复合缓冲区，它为多个 ByteBuf 提供一个聚合视图。在这里你可以根据需要添加或者删除 ByteBuf 实例，这是一个 JDK 的 ByteBuffer 实现完全缺失的特性。\nNetty 通过一个 ByteBuf 子类——CompositeByteBuf——实现了这个模式，它提供了一个将多个缓冲区表示为单个合并缓冲区的虚拟表示。\n警告：CompositeByteBuf 中的 ByteBuf 实例可能同时包含直接内存分配和非直接内存分配。如果其中只有一个实例，那么对 CompositeByteBuf 上的 hasArray()方法的调用将返回该组件上的 hasArray()方法的值；否则它将返回 false。\n举例：一个由头部和主体组成的消息，将通过http协议传输。这两部分由应用程序的不同模块产生， 将会在消息被发送的时候组装。该应用程序可以选择为多个消息重用相同的消息主体。当这种情况发生时，对于每个消息都将会创建一个新的头部。 因为我们不想为每个消息都重新分配这两个缓冲区，所以使用 CompositeByteBuf 是一个完美的选择。它在消除了没必要的复制的同时，暴露了通用的 ByteBuf API。\n代码清单 5-3 展示了如何通过使用 JDK 的 ByteBuffer 来实现这一需求。创建了一个包含两个 ByteBuffer 的数组用来保存这些消息组件，同时创建了第三个 ByteBuffer 用来保存所有这些数据的副本。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 /** * 代码清单 5-3 使用 ByteBuffer 的复合缓冲区模式 */ public static void byteBufferComposite(ByteBuffer header, ByteBuffer body) { // Use an array to hold the message parts ByteBuffer[] message = new ByteBuffer[]{ header, body }; // Create a new ByteBuffer and use copy to merge the header and body ByteBuffer message2 = ByteBuffer.allocate(header.remaining() + body.remaining()); message2.put(header); message2.put(body); message2.flip(); } 分配和复制操作，以及伴随着对数组管理的需要，使得这个版本的实现效率低下而且笨拙。 代码清单 5-4 展示了一个使用了 CompositeByteBuf 的版本。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /** * 代码清单 5-4 使用 CompositeByteBuf 的复合缓冲区模式 */ public static void byteBufComposite() { CompositeByteBuf messageBuf = Unpooled.compositeBuffer(); ByteBuf headerBuf = BYTE_BUF_FROM_SOMEWHERE; // can be backing or direct ByteBuf bodyBuf = BYTE_BUF_FROM_SOMEWHERE; // can be backing or direct //将 ByteBuf 实例追加到 CompositeByteBuf messageBuf.addComponents(headerBuf, bodyBuf); //... //删除位于索引位置为 0（第一个组件）的 ByteBuf messageBuf.removeComponent(0); // remove the header //循环遍历所有的 ByteBuf 实例 for (ByteBuf buf : messageBuf) { System.out.println(buf.toString()); } } CompositeByteBuf 可能不支持访问其支撑数组，因此访问 CompositeByteBuf 中的数据类似 于（访问）直接缓冲区的模式，如代码清单 5-5 所示。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 /** * 代码清单 5-5 访问 CompositeByteBuf 中的数据 */ public static void byteBufCompositeArray() { CompositeByteBuf compBuf = Unpooled.compositeBuffer(); //获得可读字节数 int length = compBuf.readableBytes(); //分配一个具有可读字节数长度的新数组 byte[] array = new byte[length]; //将字节读到该数组中 compBuf.getBytes(compBuf.readerIndex(), array); //使用偏移量和长度作为参数使用该数组 handleArray(array, 0, array.length); } 需要注意的是，Netty使用了CompositeByteBuf来优化套接字的I/O操作，尽可能地消除了由JDK的缓冲区实现所导致的性能以及内存使用率的惩罚。这种优化发生在Netty的核心代码中，因此不会被暴露出来，但是你应该知道它所带来的影响。CompositeByteBuf API 除了从 ByteBuf 继承的方法，CompositeByteBuf 提供了大量的附加功能。请参考 Netty 的 Javadoc 以获得该 API 的完整列表。\nByeBuf字节级操作 ByteBuf 提供了许多超出基本读、写操作的方法用于修改它的数据。我们将会讨论这些中最重要的部分。\n随机访问索引 如同在普通的 Java 字节数组中一样，ByteBuf 的索引是从零开始的：第一个字节的索引是0，最后一个字节的索引总是 capacity() - 1。代码清单 5-6 表明，对存储机制的封装使得遍历 ByteBuf 的内容非常简单。\n1 2 3 4 5 6 7 8 9 10 /** * 代码清单 5-6 访问数据 */ public static void byteBufRelativeAccess() { ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; //get reference form somewhere for (int i = 0; i \u003c buffer.capacity(); i++) { byte b = buffer.getByte(i); System.out.println((char) b); } } 需要注意的是，使用那些需要一个索引值参数的方法（的其中）之一来访问数据既不会改变readerIndex也不会改变 writerIndex。如果有需要，也可以通过调用 readerIndex(index)或者writerIndex(index)来手动移动这两者。\n顺序访问索引 虽然 ByteBuf 同时具有读索引和写索引，但是 JDK 的 ByteBuffer 却只有一个索引，这也就是为什么必须调用 flip()方法来在读模式和写模式之间进行切换的原因。图 5-3 展示了ByteBuf 是如何被它的两个索引划分成 3 个区域的。 可丢弃字节 在图 5-3 中标记为可丢弃字节的分段包含了已经被读过的字节。通过调用 discardReadBytes()方法，可以丢弃它们并回收空间。这个分段的初始大小为 0，存储在 readerIndex 中，会随着 read 操作的执行而增加（get*操作不会移动 readerIndex）。图 5-4 展示了图 5-3 中所展示的缓冲区上调用discardReadBytes()方法后的结果。可以看到，可丢弃字节分段中的空间已经变为可写的了。注意，在调用discardReadBytes()之后，对可写分段的内容并没有任何的保证 ①。 虽然你可能会倾向于频繁地调用 discardReadBytes()方法以确保可写分段的最大化，但是请注意，这将极有可能会导致内存复制，因为可读字节（图中标记为 CONTENT 的部分）必须被移动到缓冲区的开始位置。我们建议只在有真正需要的时候才这样做，例如，当内存非常宝贵的时候。\n可读字节 ByteBuf 的可读字节分段存储了实际数据。新分配的、包装的或者复制的缓冲区的默认的readerIndex值为0。 任何名称以read或者skip开头的操作都将检索或者跳过位于当前readerIndex的数据，并且将它增加已读字节数。如果被调用的方法需要一个 ByteBuf 参数作为写入的目标，并且没有指定目标索引参数，那么该目标缓冲区的 writerIndex 也将被增加，例如：readBytes(ByteBuf dest);\n如果尝试在缓冲区的可读字节数已经耗尽时从中读取数据，那么将会引发一个 IndexOutOfBoundsException。 代码清单 5-7 展示了如何读取所有可以读的字节。\n1 2 3 4 5 6 7 8 9 /** * 代码清单 5-7 读取所有数据 */ public static void readAllData() { ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; //get reference form somewhere while (buffer.isReadable()) { System.out.println(buffer.readByte()); } } 可写字节 可写字节分段是指一个拥有未定义内容的、写入就绪的内存区域。新分配的缓冲区的writerIndex的默认值为0。任何名称以 write 开头的操作都将从当前的 writerIndex 处开始写数据，并将它增加已经写入的字节数。如果写操作的目标也是 ByteBuf，并且没有指定源索引的值，则源缓冲区的 readerIndex 也同样会被增加相同的大小。这个调用如下所示：writeBytes(ByteBuf dest);\n如果尝试往目标写入超过目标容量的数据，将会引发一个IndexOutOfBoundException。 在往 ByteBuf 中写入数据时，其将首先确保目标 ByteBuf 具有足够的可写入空间来容纳当前要写入 的数据，如果没有，则将检查当前的写索引以及最大容量是否可以在扩展后容纳该数据，可以则会分配并调整容量，否则就会抛出该异常。 代码清单5-8 是一个用随机整数值填充缓冲区，直到它空间不足为止的例子。writeableBytes() 方法在这里被用来确定该缓冲区中是否还有足够的空间。\n1 2 3 4 5 6 7 8 9 10 /** * 代码清单 5-8 写数据 */ public static void write() { // Fills the writable bytes of a buffer with random integers. ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; //get reference form somewhere while (buffer.writableBytes() \u003e= 4) { buffer.writeInt(random.nextInt()); } } 索引管理 JDK 的 InputStream 定义了 mark(int readlimit)和 reset()方法，这些方法分别被用来将流中的当前位置标记为指定的值，以及将流重置到该位置。同样，可以通过调用 markReaderIndex()、markWriterIndex()、resetWriterIndex()和 resetReaderIndex()来标记和重置 ByteBuf 的 readerIndex 和 writerIndex。 这些和InputStream 上的调用类似，只是没有 readlimit 参数来指定标记什么时候失效。也可以通过调用readerIndex(int)或者 writerIndex(int)来将索引移动到指定位置。试图将任何一个索引设置到一个无效的位置都将导致一个 IndexOutOfBoundsException。可以通过调用 clear()方法来将 readerIndex 和writerIndex 都设置为 0。注意，这并不会清除内存中的内容。 图 5-5（重复上面的图 5-3）展示了它是如何工作的。 和之前一样，ByteBuf 包含 3 个分段。图 5-6 展示了在 clear()方法被调用之后 ByteBuf的状态。 调用 clear()比调用 discardReadBytes()轻量得多，因为它将只是重置索引而不会复制任何的内存。\n查找操作 在ByteBuf中有多种可以用来确定指定值的索引的方法。最简单的是使用indexOf()方法。较复杂的查找可以通过那些需要一个io.netty.util.ByteProcessor为参数的方法达成。这个接口只定义了一个方法： boolean process(byte value) 它将检查输入值是否是正在查找的值。 ByteProcessor针对一些常见的值定义了许多便利的方法。假设你的应用程序需要和所谓的包含有以NULL结尾的内容的Flash套接字集成，调用forEachByte(ByteBufProcessor.FIND_NUL) 将简单高效地消费该 Flash 数据，因为在处理期间只会执行较少的边界检查。 代码清单 5-9 展示了一个查找回车符（\\r）的例子。\n1 2 3 4 5 6 7 8 9 /** * 代码清单 5-9 使用 ByteBufProcessor 来寻找\\r * * use {@link io.netty.util.ByteProcessor in Netty 4.0.x} */ public static void byteProcessor() { ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; //get reference form somewhere int index = buffer.forEachByte(ByteProcessor.FIND_CR); } 注：ByteBufProcessor在netty 4.1.x版本已经废弃。\n派生缓冲区 派生缓冲区为 ByteBuf 提供了以专门的方式来呈现其内容的视图。这类视图是通过以下方法被创建的： duplicate() slice() slice(int, int) Unpooled.unmodifiableBuffer(…) order(ByteOrder) readSlice(int)\n每个这些方法都将返回一个新的 ByteBuf 实例，它具有自己的读索引、写索引和标记索引。其内部存储和JDK 的 ByteBuffer 一样也是共享的。这使得派生缓冲区的创建成本是很低廉的，但是这也意味着，如果你修改了它的内容，也同时修改了其对应的源实例，所以要小心。 ByteBuf 复制：如果需要一个现有缓冲区的真实副本，请使用 copy()或者 copy(int, int)方 法。不同于派生缓冲区，由这个调用所返回的 ByteBuf 拥有独立的数据副本。\n代码清单 5-10 展示了如何使用 slice(int, int)方法来操作 ByteBuf 的一个分段。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /** * 代码清单 5-10 对 ByteBuf 进行切片 */ public static void byteBufSlice() { Charset utf8 = Charset.forName(\"UTF-8\"); //创建一个用于保存给定字符串的字节的 ByteBuf ByteBuf buf = Unpooled.copiedBuffer(\"Netty in Action rocks!\", utf8); //创建该 ByteBuf 从索引 0 开始到索引 15 结束的一个新切片 ByteBuf sliced = buf.slice(0, 15); //将打印“Netty in Action” System.out.println(sliced.toString(utf8)); //更新索引 0 处的字节 buf.setByte(0, (byte)'J'); //将会成功，因为数据是共享的，对其中一个所做的更改对另外一个也是可见的 assert buf.getByte(0) == sliced.getByte(0); } 现在，让我们看看 ByteBuf 的分段的副本和切片有何区别，如代码清单 5-11 所示。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /** * 代码清单 5-11 复制一个 ByteBuf */ public static void byteBufCopy() { Charset utf8 = Charset.forName(\"UTF-8\"); //创建 ByteBuf 以保存所提供的字符串的字节 ByteBuf buf = Unpooled.copiedBuffer(\"Netty in Action rocks!\", utf8); //创建该 ByteBuf 从索引 0 开始到索引 15 结束的分段的副本 ByteBuf copy = buf.copy(0, 15); //将打印“Netty in Action” System.out.println(copy.toString(utf8)); //更新索引 0 处的字节 buf.setByte(0, (byte)'J'); //将会成功，因为数据不是共享的 assert buf.getByte(0) != copy.getByte(0); } 除了修改原始 ByteBuf 的切片或者副本的效果以外，这两种场景是相同的。 只要有可能，使用slice()方法来避免复制内存的开销。\n读/写操作 ByteBuf有两种读写操作。 get()和 set()操作，从给定的索引开始，并且保持索引不变。 read()和 write()操作，从给定的索引开始，并且会根据已经访问过的字节数对索引进行调整。\n表 5-1 列举了最常用的 get()方法。完整列表请参考对应的 API 文档。\n名 称 描 述 getBoolean(int) 返回给定索引处的 Boolean 值 getByte(int) 返回给定索引处的字节 getUnsignedByte(int) 将给定索引处的无符号字节值作为 short 返回 getMedium(int 返回给定索引处的 24 位的中等 int 值 getUnsignedMedium(int 返回给定索引处的无符号的 24 位的中等 int 值 getInt(int) 返回给定索引处的 int 值 getUnsignedInt(int) 将给定索引处的无符号 int 值作为 long 返回 getLong(int) 返回给定索引处的 long 值 getShort(int) 返回给定索引处的 short 值 getUnsignedShort(int) 将给定索引处的无符号 short 值作为 int 返回 getBytes(int, …) 将该缓冲区中从给定索引开始的数据传送到指定的目的地 上边的大多数的这些操作都有一个对应的 set()方法。这些方法在表 5-2 中列出。\n名 称 描 述 setBoolean(int, boolean) 设定给定索引处的 Boolean 值 setByte(int index, int value) 设定给定索引处的字节值 setMedium(int index, int value) 设定给定索引处的 24 位的中等 int 值 setInt(int index, int value) 设定给定索引处的 int 值 setLong(int index, long value) 设定给定索引处的 long 值 setShort(int index, int value) 设定给定索引处的 short 值 代码清单 5-12 说明了 get()和 set()方法的用法，表明了它们不会改变读索引和写索引。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /** * 代码清单 5-12 get()和 set()方法的用法 */ public static void byteBufSetGet() { Charset utf8 = Charset.forName(\"UTF-8\"); //创建一个新的 ByteBuf以保存给定字符串的字节 ByteBuf buf = Unpooled.copiedBuffer(\"Netty in Action rocks!\", utf8); //打印第一个字符'N' System.out.println((char)buf.getByte(0)); //存储当前的 readerIndex 和 writerIndex int readerIndex = buf.readerIndex(); int writerIndex = buf.writerIndex(); //将索引 0 处的字 节更新为字符'B' buf.setByte(0, (byte)'B'); //打印第一个字符，现在是'B' System.out.println((char)buf.getByte(0)); //将会成功，因为这些操作并不会修改相应的索引 assert readerIndex == buf.readerIndex(); assert writerIndex == buf.writerIndex(); } 现在，让我们研究一下 read()操作，其作用于当前的 readerIndex 或 writerIndex。 这些方法将用于从 ByteBuf 中读取数据，如同它是一个流。表 5-3 展示了最常用的方法。\n名 称 描 述 readBoolean() 返回当前 readerIndex 处的 Boolean，并将 readerIndex 增加 1 readByte() 返回当前 readerIndex 处的字节，并将 readerIndex 增加 1 readUnsignedByte() 将当前 readerIndex 处的无符号字节值作为 short 返回，并将 readerIndex 增加 1 readMedium() 返回当前 readerIndex 处的 24 位的中等 int 值，并将 readerIndex 增加 3 readUnsignedMedium() 返回当前 readerIndex 处的 24 位的无符号的中等 int 值，并将 readerIndex 增加 3 readInt() 返回当前 readerIndex 的 int 值，并将 readerIndex 增加 4 readUnsignedInt() 将当前 readerIndex 处的无符号的 int 值作为 long 值返回，并将 readerIndex 增加 4 readLong() 返回当前 readerIndex 处的 long 值，并将 readerIndex 增加 8 readShort() 返回当前 readerIndex 处的 short 值，并将 readerIndex 增加 2 readUnsignedShort() 将当前 readerIndex 处的无符号 short 值作为 int 值返回，并将 readerIndex 增加 2 readBytes(ByteBuf byte[] destination, int dstIndex [,int length]) 将当前 ByteBuf 中从当前 readerIndex 处开始的（如果设置了， length 长度的字节）数据传送到一个目标 ByteBuf 或者 byte[]，从 目标的 dstIndex 开始的位置。本地的 readerIndex 将被增加已经传 输的字节数 几乎每个 read()方法都有对应的 write()方法，用于将数据追加到 ByteBuf 中。注意， 表 5-4 中所列出的这些方法的参数是需要写入的值，而不是索引值。\n名 称 描 述 writeBoolean(boolean) 在当前 writerIndex 处写入一个 Boolean，并将 writerIndex 增加 1 writeByte(int) 在当前 writerIndex 处写入一个字节值，并将 writerIndex 增加 1 writeMedium(int) 在当前 writerIndex 处写入一个中等的 int 值，并将 writerIndex 增加 3 writeInt(int) 在当前 writerIndex 处写入一个 int 值，并将 writerIndex 增加 4 writeLong(long) 在当前 writerIndex 处写入一个 long 值，并将 writerIndex 增加 8 writeShort(int) 在当前 writerIndex 处写入一个 short 值，并将 writerIndex 增加 2 writeBytes(source ByteBuf byte[] [,int srcIndex ,int length]) 从当前 writerIndex 开始，传输来自于指定源（ByteBuf 或者 byte[]） 的数据。如果提供了 srcIndex 和 length，则从 srcIndex 开始读取， 并且处理长度为 length 的字节。当前 writerIndex 将会被增加所写入 的字节数 代码清单 5-13 展示了这些方法的用法。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 /** * 代码清单 5-13 ByteBuf 上的 read()和 write()操作 */ public static void byteBufWriteRead() { Charset utf8 = Charset.forName(\"UTF-8\"); //创建一个新的 ByteBuf 以保存给定字符串的字节 ByteBuf buf = Unpooled.copiedBuffer(\"Netty in Action rocks!\", utf8); //打印第一个字符'N' System.out.println((char)buf.readByte()); //存储当前的readerIndex int readerIndex = buf.readerIndex(); //存储当前的writerIndex int writerIndex = buf.writerIndex(); //将字符 '?'追加到缓冲区 buf.writeByte((byte)'?'); assert readerIndex == buf.readerIndex(); //将会成功，因为 writeByte()方法移动了 writerIndex assert writerIndex != buf.writerIndex(); } byteBuf其他操作 名 称 描 述 isReadable() 如果至少有一个字节可供读取，则返回 true isWritable() 如果至少有一个字节可被写入，则返回 true readableBytes() 返回可被读取的字节数 writableBytes() 返回可被写入的字节数 capacity() 返回 ByteBuf 可容纳的字节数。在此之后，它会尝试再次扩展直 到达到 maxCapacity() maxCapacity() 返回 ByteBuf 可以容纳的最大字节数 hasArray() 如果 ByteBuf 由一个字节数组支撑，则返回 true array() 如果 ByteBuf 由一个字节数组支撑则返回该数组；否则，它将抛出一个 UnsupportedOperationException 异常 ByteBufHolder 接口 我们经常发现，除了实际的数据负载之外，我们还需要存储各种属性值。HTTP 响应便是一个很好的例子，除了表示为字节的内容，还包括状态码、cookie 等。为了处理这种常见的用例，Netty 提供了ByteBufHolder。ByteBufHolder 也为 Netty 的高级特性提供了支持，如缓冲区池化，其中可以从池中借用 ByteBuf，并且在需要时自动释放。ByteBufHolder 只有几种用于访问底层数据和引用计数的方法。表 5-6 列出了它们（这里不包括它继承自 ReferenceCounted 的那些方法）。\n名 称 描 述 content() 返回由这个 ByteBufHolder 所持有的 ByteBuf copy() 返回这个 ByteBufHolder 的一个深拷贝，包括一个其所包含的 ByteBuf 的非共享拷贝 duplicate() 返回这个 ByteBufHolder 的一个浅拷贝，包括一个其所包含的 ByteBuf 的共享拷贝 如果想要实现一个将其有效负载存储在 ByteBuf 中的消息对象，那么 ByteBufHolder 将是个不错的选择。\nByteBuf分配(管理) 按需分配：ByteBufAllocator 接口 为了降低分配和释放内存的开销，Netty 通过 interface ByteBufAllocator 实现了（ByteBuf 的）池化，它可以用来分配我们所描述过的任意类型的 ByteBuf 实例。使用池化是特定于应用程序的决定，其并不会以任何方式改变 ByteBuf API（的语义）。\n表 5-7 列出了 ByteBufAllocator 提供的一些操作。\n名 称 描 述 buffer() buffer(int initialCapacity); buffer(int initialCapacity, int maxCapacity); 返回一个基于堆或者直接内存 存储的 ByteBuf heapBuffer() heapBuffer(int initialCapacity) heapBuffer(int initialCapacity, int maxCapacity) 返回一个基于堆内存存储的 ByteBuf directBuffer() directBuffer(int initialCapacity) directBuffer(int initialCapacity, int maxCapacity) 返回一个基于直接内存存储的 ByteBuf compositeBuffer() compositeBuffer(int maxNumComponents) compositeDirectBuffer() compositeDirectBuffer(int maxNumComponents); compositeHeapBuffer() compositeHeapBuffer(int maxNumComponents); 返回一个可以通过添加最大到 指定数目的基于堆的或者直接 内存存储的缓冲区来扩展的 CompositeByteBuf ioBuffer() 返回一个用于套接字的 I/O 操 作的 ByteBuf 可以通过 Channel（每个都可以有一个不同的 ByteBufAllocator 实例）或者绑定到ChannelHandler 的 ChannelHandlerContext 获取一个到 ByteBufAllocator 的引用。 代码清单 5-14 说明了这两种方法。\n1 2 3 4 5 6 7 8 9 10 11 12 13 /** * 代码清单 5-14 获取一个到 ByteBufAllocator 的引用 */ public static void obtainingByteBufAllocatorReference(){ Channel channel = CHANNEL_FROM_SOMEWHERE; //get reference form somewhere //从 Channel 获取一个到ByteBufAllocator 的引用 ByteBufAllocator allocator = channel.alloc(); //... ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; //get reference form somewhere //从 ChannelHandlerContext 获取一个到 ByteBufAllocator 的引用 ByteBufAllocator allocator2 = ctx.alloc(); //... } Netty提供了两种ByteBufAllocator的实现：PooledByteBufAllocator和UnpooledByteBufAllocator。 前者池化了ByteBuf的实例以提高性能并最大限度地减少内存碎片。此实现使用了一种称为jemalloc的已被大量现代操作系统所采用的高效方法来分配内存。后者的实现不池化ByteBuf实例，并且在每次它被调用时都会返回一个新的实例。虽然Netty默认使用了PooledByteBufAllocator，但这可以很容易地通过ChannelConfigAPI或者在引导你的应用程序时指定一个不同的分配器来更改。\nUnpooled 缓冲区 可能某些情况下，你未能获取一个到 ByteBufAllocator 的引用。对于这种情况，Netty 提供了一个简单的称为 Unpooled 的工具类，它提供了静态的辅助方法来创建未池化的 ByteBuf实例。 表 5-8 列举了这些中最重要的方法。\n名 称 描 述 buffer() buffer(int initialCapacity) buffer(int initialCapacity, int maxCapacity) 返回一个未池化的基于堆内存存储的 ByteBuf directBuffer() directBuffer(int initialCapacity) directBuffer(int initialCapacity, int maxCapacity) 返回一个未池化的基于直接内存存储 的 ByteBuf wrappedBuffer() 返回一个包装了给定数据的 ByteBuf copiedBuffer() 返回一个复制了给定数据的 ByteBuf Unpooled 类还使得 ByteBuf 同样可用于那些并不需要 Netty 的其他组件的非网络项目，使得其能得益于高性能的可扩展的缓冲区 API。\nByteBufUtil 类 ByteBufUtil 提供了用于操作 ByteBuf 的静态的辅助方法。因为这个 API 是通用的，并且和池化无关，所以这些方法已然在分配类的外部实现。这些静态方法中最有价值的可能就是 hexdump()方法，它以十六进制的表示形式打印ByteBuf 的内容。这在各种情况下都很有用，例如，出于调试的目的记录 ByteBuf 的内容。十六进制的表示通常会提供一个比字节值的直接表示形式更加有用的日志条目，此外，十六进制的版本还可以很容易地转换回实际的字节表示。另一个有用的方法是 boolean equals(ByteBuf, ByteBuf)，它被用来判断两个 ByteBuf实例的相等性。如果你实现自己的 ByteBuf 子类，你可能会发现 ByteBufUtil 的其他有用方法。\n引用计数法 引用计数是一种通过在某个对象所持有的资源不再被其他对象引用时释放该对象所持有的资源来优化内存使用和性能的技术。。Netty 在第 4 版中为 ByteBuf 和 ByteBufHolder 引入了引用计数技术，它们都实现了interface ReferenceCounted。 引用计数法并不复杂，它主要涉及跟踪到某个特定对象的活动引用的数量。一个 ReferenceCounted 实现的实例将通常以活动的引用计数为 1 作为开始。只要引用计数大于 0，就能保证对象不会被释放。当活动引用的数量减少到 0 时，该实例就会被释放。注意，虽然释放的确切语义可能是特定于实现的，但是至少已经释放的对象应该不可再用了。 引用计数对于池化实现（如 PooledByteBufAllocator）来说是至关重要的，它降低了内存分配的开销。代码清单 5-15 和代码清单 5-16 展示了相关的示例。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 /** * 代码清单 5-15 引用计数 * */ public static void referenceCounting(){ Channel channel = CHANNEL_FROM_SOMEWHERE; //get reference form somewhere //从 Channel 获取ByteBufAllocator ByteBufAllocator allocator = channel.alloc(); //... //从 ByteBufAllocator分配一个 ByteBuf ByteBuf buffer = allocator.directBuffer(); //检查引用计数是否为预期的 1 assert buffer.refCnt() == 1; //... } 1 2 3 4 5 6 7 8 9 /** * 代码清单 5-16 释放引用计数的对象 */ public static void releaseReferenceCountedObject(){ ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; //get reference form somewhere //减少到该对象的活动引用。当减少到 0 时，该对象被释放，并且该方法返回 true boolean released = buffer.release(); //... } 试图访问一个已经被释放的引用计数的对象，将会导致一个 IllegalReferenceCountException。 注意，一个特定的（ReferenceCounted 的实现）类，可以用它自己的独特方式来定义它的引用计数规则。例如，我们可以设想一个类，其 release()方法的实现总是将引用计数设为零，而不用关心它的当前值，从而一次性地使所有的活动引用都失效。 谁负责释放：一般来说，是由最后访问（引用计数）对象的那一方来负责将它释放。\nChannelHandler和ChannelPipeline 在上一章中你学习了Netty的数据容器ByteBuf。当我们在本章中探讨 Netty 的数据流以及处理组件时，我们将基于已经学过的东西，并且你将开始看到框架的重要元素都结合到了一起。你已经知道，可以在 ChannelPipeline 中将 ChannelHandler 链接在一起以组织处理逻辑。我们将会研究涉及这些类的各种用例，以及一个重要的关系—ChannelHandlerContext。理解所有这些组件之间的交互对于通过 Netty 构建模块化的、可重用的实现至关重要。\nChannelHandler家族 Channel的生命周期 状 态 描 述 ChannelUnregistered Channel 已经被创建，但还未注册到 EventLoop ChannelRegistered Channel 已经被注册到了 EventLoop ChannelActive Channel 处于活动状态（已经连接到它的远程节点）。它现在可以接收和发送数据了 ChannelInactive Channel 没有连接到远程节点 当这些状态发生改变时，将会生成对应的事件。 这些事件将会被转发给 ChannelPipeline 中的 ChannelHandler，其可以随后对它们做出响应。 ChannelRegistered-\u003eChannelActive-\u003eChannelInactive-\u003eChannelUnregistered\nChannelHandler的生命周期 状 态 描 述 handlerAdded 当把 ChannelHandler 添加到 ChannelPipeline 中时被调用 handlerRemoved 当从 ChannelPipeline 中移除 ChannelHandler 时被调用 exceptionCaught 当处理过程中在 ChannelPipeline 中有错误产生时被调用 在 ChannelHandler被添加到 ChannelPipeline 中或者被从 ChannelPipeline 中移除时会调用这些操作。这些方法中的每一个都接受一个 ChannelHandlerContext 参数。 Netty 定义了下面两个重要的 ChannelHandler 子接口： ChannelInboundHandler——处理入站数据以及各种状态变化； ChannelOutboundHandler——处理出站数据并且允许拦截所有的操作。\nChannelInboundHandler 接口 类 型 描 述 channelRegistered 当 Channel 已经注册到它的 EventLoop 并且能够处理 I/O 时被调用 channelUnregistered 当 Channel 从它的 EventLoop 注销并且无法处理任何 I/O 时被调用 channelActive 当 Channel 处于活动状态时被调用；Channel 已经连接/绑定并且已经就绪 channelInactive 当 Channel 离开活动状态并且不再连接它的远程节点时被调用 channelReadComplete 当Channel上的一个读操作完成时被调用(注：当所有可读的字节都已经从 Channel 中读取之后，将会调用该回调方法；所以，可能在 channelReadComplete()被调用之前看到多次调用 channelRead(…)) channelRead 当从 Channel 读取数据时被调用 ChannelWritability-Changed 当 Channel 的可写状态发生改变时被调用。用户可以确保写操作不会完成 得太快（以避免发生 OutOfMemoryError）或者可以在 Channel 变为再 次可写时恢复写入。可以通过调用 Channel 的 isWritable()方法来检测 Channel 的可写性。与可写性相关的阈值可以通过 Channel.config(). setWriteHighWaterMark()和 Channel.config().setWriteLowWaterMark()方法来设置 userEventTriggered 当 ChannelnboundHandler.fireUserEventTriggered()方法被调 用时被调用，因为一个 POJO 被传经了 ChannelPipeline 这些方法将会在数据被接收时或者与其对应的 Channel 状态发生改变时被调用。正如我们前面所提到的，这些方法和 Channel 的生命周期密切相关。 当某个 ChannelInboundHandler 的实现重写 channelRead()方法时，它将负责显式地释放与池化的 ByteBuf 实例相关的内存。Netty 为此提供了一个实用方法 ReferenceCountUtil.release()，如代码清单 6-1 所示。\n1 2 3 4 5 6 7 8 9 10 11 12 13 /** * 代码清单 6-1 释放消息资源 * @author Norman Maurer */ @Sharable //扩展了 ChannelInboundHandlerAdapter public class DiscardHandler extends ChannelInboundHandlerAdapter { @Override public void channelRead(ChannelHandlerContext ctx, Object msg) { //丢弃已接收的消息 ReferenceCountUtil.release(msg); } } Netty 将使用 WARN 级别的日志消息记录未释放的资源，使得可以非常简单地在代码中发现违规的实例。但是以这种方式管理资源可能很繁琐。一个更加简单的方式是使用 SimpleChannelInboundHandler。 代码清单 6-2 是代码清单 6-1 的一个变体，说明了这一点。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /** * 代码清单 6-2 使用 SimpleChannelInboundHandler * * @author Norman Maurer */ @Sharable //扩展了SimpleChannelInboundHandler public class SimpleDiscardHandler extends SimpleChannelInboundHandler { @Override public void channelRead0(ChannelHandlerContext ctx, Object msg) { //不需要任何显式的资源释放 // No need to do anything special } } 由于 SimpleChannelInboundHandler 会自动释放资源，所以你不应该存储指向任何消息的引用供将来使用，因为这些引用都将会失效。\nChannelOutboundHandler 接口 出站操作和数据将由 ChannelOutboundHandler 处理。 它的方法将被 Channel、ChannelPipeline 以及 ChannelHandlerContext 调用。 ChannelOutboundHandler 的一个强大的功能是可以按需推迟操作或者事件，这使得可以通过一些复杂的方法来处理请求。例如，如果到远程节点的写入被暂停了，那么你可以推迟冲刷操作并在稍后继续。\n类 型 描 述 bind(ChannelHandlerContext, SocketAddress,ChannelPromise) 当请求将 Channel 绑定到本地地址时被调用 connect(ChannelHandlerContext, SocketAddress,SocketAddress,ChannelPromise) 当请求将 Channel 连接到远程节点时被调用 disconnect(ChannelHandlerContext, ChannelPromise) 当请求将 Channel 从远程节点断开时被调用 close(ChannelHandlerContext,ChannelPromise) 当请求关闭 Channel 时被调用 deregister(ChannelHandlerContext, ChannelPromise) 当请求将 Channel 从它的 EventLoop 注销 时被调用 read(ChannelHandlerContext) 当请求从 Channel 读取更多的数据时被调用 flush(ChannelHandlerContext) 当请求通过 Channel 将入队数据冲刷到远程 节点时被调用 write(ChannelHandlerContext,Object, ChannelPromise) 当请求通过 Channel 将数据写到远程节点时 被调用 ChannelPromise与ChannelFuture ChannelOutboundHandler中的大部分方法都需要一个ChannelPromise参数，以便在操作完成时得到通知。ChannelPromise是ChannelFuture的一个子类，其定义了一些可写的方法，如setSuccess()和setFailure()，从而使ChannelFuture不可变。\nChannelHandler 适配器 你可以使用 ChannelInboundHandlerAdapter 和 ChannelOutboundHandlerAdapter类作为自己的 ChannelHandler 的起始点。这两个适配器分别提供了 ChannelInboundHandler和 ChannelOutboundHandler 的基本实现。通过扩展抽象类 ChannelHandlerAdapter，它们获得了它们共同的超接口 ChannelHandler 的方法。生成的类的层次结构如图 6-2 所示。 ChannelHandlerAdapter 还提供了实用方法 isSharable()。如果其对应的实现被标注为 Sharable，那么这个方法将返回 true，表示它可以被添加到多个 ChannelPipeline中。你要想在自己的 ChannelHandler 中使用这些适配器类，只需要简单地扩展它们，并且重写那些你想要自定义的方法。\n资源管理 每当通过调用 ChannelInboundHandler.channelRead()或者 ChannelOutboundHandler.write()方法来处理数据时，你都需要确保没有任何的资源泄漏。你可能还记得在前面的章节中所提到的，Netty 使用引用计数来处理池化的 ByteBuf。所以在完全使用完某个ByteBuf 后，调整其引用计数是很重要的。为了帮助你诊断潜在的（资源泄漏）问题，Netty提供了class ResourceLeakDetector（其利用了 JDK 提供的 PhantomReference类来实现这一点）。它将对你应用程序的缓冲区分配做大约 1%的采样来检测内存泄露，相关的开销是非常小的。如果检测到了内存泄露，将会产生类似于下面的日志消息：\n1 2 3 4 5 LEAK: ByteBuf.release() was not called before it's garbage-collected. Enable advanced leak reporting to find out where the leak occurred. To enable advanced leak reporting, specify the JVM option '-Dio.netty.leakDetectionLevel=ADVANCED' or call ResourceLeakDetector.setLevel(). Netty 目前定义了 4 种泄漏检测级别，如表 6-5 所示。\n级 别 描 述 DISABLED 禁用泄漏检测。只有在详尽的测试之后才应设置为这个值 SIMPLE 使用 1%的默认采样率检测并报告任何发现的泄露。这是默认级别，适合绝大部分的情况 ADVANCED 使用默认的采样率，报告所发现的任何的泄露以及对应的消息被访问的位置 PARANOID 类似于 ADVANCED，但是其将会对每次（对消息的）访问都进行采样。这对性能将会有很 大的影响，应该只在调试阶段使用 泄露检测级别可以通过将下面的 Java 系统属性设置为表中的一个值来定义： java -Dio.netty.leakDetectionLevel=ADVANCED 如果带着该 JVM 选项重新启动你的应用程序，你将看到自己的应用程序最近被泄漏的缓冲区被访问的位置。 下面是一个典型的由单元测试产生的泄漏报告： 1 2 3 4 5 6 7 8 9 10 Running io.netty.handler.codec.xml.XmlFrameDecoderTest 15:03:36.886 [main] ERROR io.netty.util.ResourceLeakDetector - LEAK: ByteBuf.release() was not called before it's garbage-collected. Recent access records: 1 #1: io.netty.buffer.AdvancedLeakAwareByteBuf.toString( AdvancedLeakAwareByteBuf.java:697) io.netty.handler.codec.xml.XmlFrameDecoderTest.testDecodeWithXml( XmlFrameDecoderTest.java:157) io.netty.handler.codec.xml.XmlFrameDecoderTest.testDecodeWithTwoMessages( XmlFrameDecoderTest.java:133) 实现 ChannelInboundHandler.channelRead()和 ChannelOutboundHandler.write()方法时，应该如何使用这个诊断工具来防止泄露呢？让我们看看你的 channelRead()操作直接消费入站消息的情况；也就是说，它不会通过调用 ChannelHandlerContext.fireChannelRead()方法将入站消息转发给下一个 ChannelInboundHandler。代码清单 6-3 展示了如何释放消息。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 /** * 代码清单 6-3 消费并释放入站消息 * * @author Norman Maurer */ @Sharable //扩展了ChannelInboundandlerAdapter public class DiscardInboundHandler extends ChannelInboundHandlerAdapter { @Override public void channelRead(ChannelHandlerContext ctx, Object msg) { //通过调用 ReferenceCountUtil.release()方法释放资源 ReferenceCountUtil.release(msg); } } 消费入站消息的简单方式：由于消费入站数据是一项常规任务，所以 Netty 提供了一个特殊的被 称为 SimpleChannelInboundHandler 的 ChannelInboundHandler 实现。这个实现会在消息被 channelRead0()方法消费之后自动释放消息。 在出站方向这边，如果你处理了 write()操作并丢弃了一个消息，那么你也应该负责释放它。 代码清单 6-4 展示了一个丢弃所有的写入数据的实现。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /** * 代码清单 6-4 丢弃并释放出站消息 * * @author Norman Maurer */ @Sharable //扩展了ChannelOutboundHandlerAdapter public class DiscardOutboundHandler extends ChannelOutboundHandlerAdapter { @Override public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) { //通过使用 ReferenceCountUtil.realse(...)方法释放资源 ReferenceCountUtil.release(msg); //通知 ChannelPromise数据已经被处理了 promise.setSuccess(); } } 重要的是，不仅要释放资源，还要通知 ChannelPromise。否则可能会出现 ChannelFutureListener 收不到某个消息已经被处理了的通知的情况。总之，如果一个消息被消费或者丢弃了，并且没有传递给ChannelPipeline 中的下一个ChannelOutboundHandler，那么用户就有责任调用 ReferenceCountUtil.release()。如果消息到达了实际的传输层，那么当它被写入时或者 Channel 关闭时，都将被自动释放。\nChannelPipeline 接口 ChannelPipeline是一个拦截流经Channel的入站和出站事件的ChannelHandler 实例链。 这些 ChannelHandler 之间的交互，组成了一个应用程序数据和事件处理逻辑的核心。 每一个新创建的 Channel 都将会被分配一个新的 ChannelPipeline。这项关联是永久性的； Channel 既不能附加另外一个 ChannelPipeline，也不能分离其当前的。在 Netty 组件的生命周期中，这是一项固定的操作，不需要开发人员的任何干预。 根据事件的起源，事件将会被 ChannelInboundHandler 或者 ChannelOutboundHandler处理。随后，通过调用 ChannelHandlerContext 实现，它将被转发给同一超类型的下一个ChannelHandler。\nChannelHandlerContext使得ChannelHandler能够和它的ChannelPipeline以及其他的 ChannelHandler 交互。 ChannelHandler 可以通知其所属的 ChannelPipeline 中的下一 个ChannelHandler，甚至可以动态修改它所属的ChannelPipeline中的 ChannelHandler 的编排。\nChannelHandlerContext 具有丰富的用于处理事件和执行 I/O 操作的 API。6.3 节将提供有关ChannelHandlerContext 的更多内容。\n图 6-3 展示了一个典型的同时具有入站和出站 ChannelHandler 的 ChannelPipeline 的布局，并且印证了我们之前的关于 ChannelPipeline 主要由一系列的 ChannelHandler 所组成的说法。ChannelPipeline 还提供了通过 ChannelPipeline 本身传播事件的方法。如果一个入站事件被触发，它将被从 ChannelPipeline 的头部开始一直被传播到 Channel Pipeline 的尾端。在图 6-3 中，一个出站 I/O 事件将从ChannelPipeline 的最右边开始，然后向左传播。 ChannelPipeline 相对论： 你可能会说，从事件途经 ChannelPipeline 的角度来看，ChannelPipeline 的头部和尾端取决于该事件是入站的还是出站的。然而 Netty 总是将 ChannelPipeline 的入站口（图 6-3 中的左侧）作为头部，而将出站口（该图的右侧）作为尾端。 当你完成了通过调用 ChannelPipeline.add*()方法将入站处理器（ChannelInboundHandler）和出站处理器（ ChannelOutboundHandler ）混合添加到 ChannelPipeline 之后，每一个ChannelHandler 从头部到尾端的顺序位置正如同我们方才所定义它们的一样。因此，如果你将图 6-3 中的处理器（ChannelHandler）从左到右进行编号，那么第一个被入站事件看到的 ChannelHandler 将是1，而第一个被出站事件看到的 ChannelHandler 将是 5。\n在 ChannelPipeline 传播事件时，它会测试 ChannelPipeline 中的下一个 ChannelHandler 的类型是否和事件的运动方向相匹配。如果不匹配，ChannelPipeline 将跳过该ChannelHandler 并前进到下一个，直到它找到和该事件所期望的方向相匹配的为止。（当然，ChannelHandler 也可以同时实现ChannelInboundHandler 接口和 ChannelOutboundHandler 接口。）\n修改 ChannelPipeline ChannelHandler 可以通过添加、删除或者替换其他的 ChannelHandler 来实时地修改ChannelPipeline的布局。 （它也可以将它自己从 ChannelPipeline 中移除。）这是 ChannelHandler 最重要的能力之一，所以我们将仔细地来看看它是如何做到的。表 6-6 列出了相关的方法。\n名 称 描 述 AddFirstaddBefore addAfteraddLast 将一个ChannelHandler 添加到ChannelPipeline 中 remove 将一个ChannelHandler 从ChannelPipeline 中移除 replace 将 ChannelPipeline 中的一个 ChannelHandler 替换为另一个 ChannelHandler 代码清单 6-5 展示了这些方法的使用。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 /** * 代码清单 6-5 修改 ChannelPipeline * * @author Norman Maurer */ public class ModifyChannelPipeline { private static final ChannelPipeline CHANNEL_PIPELINE_FROM_SOMEWHERE = DUMMY_INSTANCE; /** * 代码清单 6-5 修改 ChannelPipeline * */ public static void modifyPipeline() { ChannelPipeline pipeline = CHANNEL_PIPELINE_FROM_SOMEWHERE; // get reference to pipeline; //创建一个 FirstHandler 的实例 FirstHandler firstHandler = new FirstHandler(); //将该实例作为\"handler1\"添加到ChannelPipeline 中 pipeline.addLast(\"handler1\", firstHandler); //将一个 SecondHandler的实例作为\"handler2\"添加到 ChannelPipeline的第一个槽中。这意味着它将被放置在已有的\"handler1\"之前 pipeline.addFirst(\"handler2\", new SecondHandler()); //将一个 ThirdHandler 的实例作为\"handler3\"添加到 ChannelPipeline 的最后一个槽中 pipeline.addLast(\"handler3\", new ThirdHandler()); //... //通过名称移除\"handler3\" pipeline.remove(\"handler3\"); //通过引用移除FirstHandler（它是唯一的，所以不需要它的名称） pipeline.remove(firstHandler); //将 SecondHandler(\"handler2\")替换为 FourthHandler:\"handler4\" pipeline.replace(\"handler2\", \"handler4\", new FourthHandler()); } private static final class FirstHandler extends ChannelHandlerAdapter { } private static final class SecondHandler extends ChannelHandlerAdapter { } private static final class ThirdHandler extends ChannelHandlerAdapter { } private static final class FourthHandler extends ChannelHandlerAdapter { } } 稍后，你将看到，重组 ChannelHandler 的这种能力使我们可以用它来轻松地实现极其灵活的逻辑。\nChannelHandler 的执行和阻塞： 通常 ChannelPipeline 中的每一个 ChannelHandler 都是通过它的 EventLoop（I/O 线程）来处 理传递给它的事件的。所以至关重要的是不要阻塞这个线程，因为这会对整体的 I/O 处理产生负面的影响。但有时可能需要与那些使用阻塞 API 的遗留代码进行交互。对于这种情况，ChannelPipeline 有一些接受一个 EventExecutorGroup 的 add()方法。如果一个事件被传递给一个自定义的 EventExecutor-Group，它将被包含在这个 EventExecutorGroup 中的某个 EventExecutor 所处理，从而被从该Channel 本身的EventLoop 中移除。对于这种用例，Netty 提供了一个叫 DefaultEventExecutorGroup 的默认实现。 除了这些操作，还有别的通过类型或者名称来访问 ChannelHandler 的方法。这些方法都列在了表 6-7 中。\n名 称 描 述 get 通过类型或者名称返回 ChannelHandler context 返回和 ChannelHandler 绑定的 ChannelHandlerContext names 返回 ChannelPipeline 中所有 ChannelHandler 的名称 触发事件 ChannelPipeline 的 API 公开了用于调用入站和出站操作的附加方法。表 6-8 列出了入站操作， 用于通知 ChannelInboundHandler 在 ChannelPipeline 中所发生的事件。\n方 法 名 称 描 述 fireChannelRegistered 调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelRegistered(ChannelHandlerContext)方法 fireChannelUnregistered 调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelUnregistered(ChannelHandlerContext)方法 fireChannelActive 调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelActive(ChannelHandlerContext)方法 fireChannelInactive 调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelInactive(ChannelHandlerContext)方法 fireExceptionCaught 调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 exceptionCaught(ChannelHandlerContext, Throwable)方法 fireUserEventTriggered 调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 userEventTriggered(ChannelHandlerContext, Object)方法 fireChannelRead 调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelRead(ChannelHandlerContext, Object msg)方法 fireChannelReadComplete 调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelReadComplete(ChannelHandlerContext)方法 fireChannelWritability-Changed 调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelWritabilityChanged(ChannelHandlerContext)方法 在出站这边，处理事件将会导致底层的套接字上发生一系列的动作。表 6-9 列出了 ChannelPipeline API 的出站操作。\n方 法 名 称 描 述 bind 将 Channel 绑定到一个本地地址，这将调用 ChannelPipeline 中的下一个 ChannelOutboundHandler 的 bind(ChannelHandlerContext, SocketAddress, ChannelPromise)方法 connect 将 Channel 连接到一个远程地址，这将调用 ChannelPipeline 中的下一个 ChannelOutboundHandler 的 connect(ChannelHandlerContext, SocketAddress, ChannelPromise)方法 disconnect 将Channel 断开连接。这将调用ChannelPipeline 中的下一个ChannelOutboundHandler 的 disconnect(ChannelHandlerContext, Channel Promise)方法 close 将 Channel 关闭。这将调用 ChannelPipeline 中的下一个 ChannelOutboundHandler 的 close(ChannelHandlerContext, ChannelPromise)方法 deregister 将 Channel 从它先前所分配的 EventExecutor（即 EventLoop）中注销。这将调 用 ChannelPipeline 中的下一个 ChannelOutboundHandler 的 deregister (ChannelHandlerContext, ChannelPromise)方法 flush 冲刷Channel所有挂起的写入。这将调用ChannelPipeline中的下一个ChannelOutboundHandler 的 flush(ChannelHandlerContext)方法 write 将消息写入 Channel。这将调用 ChannelPipeline 中的下一个 ChannelOutboundHandler的write(ChannelHandlerContext, Object msg, ChannelPromise)方法。注意：这并不会将消息写入底层的 Socket，而只会将它放入队列中。 要将它写入 Socket，需要调用 flush()或者 writeAndFlush()方法 writeAndFlush 这是一个先调用 write()方法再接着调用 flush()方法的便利方法 read 请求从 Channel 中读取更多的数据。这将调用 ChannelPipeline 中的下一个 ChannelOutboundHandler 的 read(ChannelHandlerContext)方法 总结：\nChannelPipeline 保存了与 Channel 相关联的 ChannelHandler； ChannelPipeline 可以根据需要，通过添加或者删除 ChannelHandler 来动态地修改； ChannelPipeline 有着丰富的 API 用以被调用，以响应入站和出站事件。 ChannelHandlerContext 接口 ChannelHandlerContextz代表了 ChannelHandler 和 ChannelPipeline 之间的关联。 每当有 ChannelHandler 添加到 ChannelPipeline 中时，都会创建 ChannelHandlerContext。 ChannelHandlerContext 的主要功能是管理它所关联的 ChannelHandler 和在同一个 ChannelPipeline中的其他 ChannelHandler 之间的交互。 ChannelHandlerContext 有很多的方法，其中一些方法也存在于 Channel 和 ChannelPipeline 本身上，但是有一点重要的不同。如果调用 Channel 或者 ChannelPipeline 上的这些方法，它们将沿着整个ChannelPipeline 进行传播。而调用位于 ChannelHandlerContext上的相同方法，则将从当前所关联的ChannelHandler 开始，并且只会传播给位于该ChannelPipeline 中的下一个能够处理该事件的 ChannelHandler。\n方 法 名 称 描 述 alloc 返回和这个实例相关联的Channel 所配置的 ByteBufAllocator bind 绑定到给定的 SocketAddress，并返回 ChannelFuture channel 返回绑定到这个实例的 Channel close 关闭 Channel，并返回 ChannelFuture connect 连接给定的 SocketAddress，并返回 ChannelFuture deregister 从之前分配的 EventExecutor 注销，并返回 ChannelFuture executor 返回调度事件的 EventExecutor fireChannelActive 触发对下一个 ChannelInboundHandler 上的 channelActive()方法（已连接）的调用 fireChannelInactive 触发对下一个 ChannelInboundHandler 上的 channelInactive()方法（已关闭）的调用 fireChannelRead 触发对下一个 ChannelInboundHandler 上的 channelRead()方法（已接收的消息）的调用 fireChannelReadComplete 触发对下一个ChannelInboundHandler上的 channelReadComplete()方法的调用 fireChannelRegistered 触发对下一个 ChannelInboundHandler 上的 fireChannelRegistered()方法的调用 fireChannelUnregistered 触发对下一个 ChannelInboundHandler 上的 fireChannelUnregistered()方法的调用 fireChannelWritabilityChanged 触发对下一个 ChannelInboundHandler 上的 fireChannelWritabilityChanged()方法的调用 fireExceptionCaught 触发对下一个 ChannelInboundHandler 上的 fireExceptionCaught(Throwable)方法的调用 fireUserEventTriggered 触发对下一个 ChannelInboundHandler 上的 fireUserEventTriggered(Object evt)方法的调用 handler 返回绑定到这个实例的 ChannelHandler isRemoved 如果所关联的 ChannelHandler 已经被从 ChannelPipeline 中移除则返回 true name 返回这个实例的唯一名称 pipeline 返回这个实例所关联的 ChannelPipeline read 将数据从Channel读取到第一个入站缓冲区；如果读取成功则触发一个channelRead事件，并（在最后一个消息被读取完成后） 通 知 ChannelInboundHandler 的 channelReadComplete (ChannelHandlerContext)方法。通过配合 ChannelConfig.setAutoRead(boolean autoRead)方法，可以实现反应式系统的特性 之一回压（back-pressure） write 通过这个实例写入消息并经过 ChannelPipeline writeAndFlush 通过这个实例写入并冲刷消息并经过 ChannelPipeline 当使用 ChannelHandlerContext 的 API 的时候，请牢记以下两点：\nChannelHandlerContext 和 ChannelHandler 之间的关联（绑定）是永远不会改变的，所以缓存对它的引用是安全的； 如同我们在本节开头所解释的一样，相对于其他类的同名方法，ChannelHandler Context的方法将产生更短的事件流，应该尽可能地利用这个特性来获得最大的性能。 使用 ChannelHandlerContext 在这一节中我们将讨论 ChannelHandlerContext 的用法，以及存在于 ChannelHandlerContext、 Channel 和 ChannelPipeline 上的方法的行为。图 6-4 展示了它们之间的关系。 在代码清单 6-6 中，将通过 ChannelHandlerContext 获取到 Channel 的引用。调用 Channel 上的 write()方法将会导致写入事件从尾端到头部地流经 ChannelPipeline。\n1 2 3 4 5 6 7 8 9 10 /** * 代码清单 6-6 从 ChannelHandlerContext 访问 Channel * */ public static void writeViaChannel() { ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; //get reference form somewhere //获取到与 ChannelHandlerContext相关联的 Channel 的引用 Channel channel = ctx.channel(); //通过 Channel 写入缓冲区 channel.write(Unpooled.copiedBuffer(\"Netty in Action\", CharsetUtil.UTF_8)); } 代码清单 6-7 展示了一个类似的例子，但是这一次是写入 ChannelPipeline。我们再次看 到，（到 ChannelPipline 的）引用是通过 ChannelHandlerContext 获取的。\n1 2 3 4 5 6 7 8 9 10 /** * 代码清单 6-7 通过 ChannelHandlerContext 访问 ChannelPipeline * */ public static void writeViaChannelPipeline() { ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; //get reference form somewhere //获取到与 ChannelHandlerContext相关联的 ChannelPipeline 的引用 ChannelPipeline pipeline = ctx.pipeline(); //get reference form somewhere //通过 ChannelPipeline写入缓冲区 pipeline.write(Unpooled.copiedBuffer(\"Netty in Action\", CharsetUtil.UTF_8)); } 如同在图 6-5 中所能够看到的一样，代码清单 6-6 和代码清单 6-7 中的事件流是一样的。重要的是要注意到，虽然被调用的 Channel 或 ChannelPipeline 上的 write()方法将一直传播事件通过整个 ChannelPipeline，但是在 ChannelHandler 的级别上，事件从一个 ChannelHandler到下一个 ChannelHandler 的移动是由 ChannelHandlerContext 上的调用完成的。 为什么会想要从 ChannelPipeline 中的某个特定点开始传播事件呢？\n为了减少将事件传经对它不感兴趣的 ChannelHandler 所带来的开销。 为了避免将事件传经那些可能会对它感兴趣的 ChannelHandler。 要想调用从某个特定的 ChannelHandler 开始的处理过程，必须获取到在（ChannelPipeline）该 ChannelHandler 之前的 ChannelHandler 所关联的 ChannelHandlerContext。这个 ChannelHandlerContext将调用和它所关联的 ChannelHandler 之后的ChannelHandler。 1 2 3 4 5 6 7 8 9 /** * 代码清单 6-8 调用 ChannelHandlerContext 的 write()方法 * */ public static void writeViaChannelHandlerContext() { //获取到 ChannelHandlerContext 的引用 ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; //get reference form somewhere; //write()方法将把缓冲区数据发送到下一个 ChannelHandler ctx.write(Unpooled.copiedBuffer(\"Netty in Action\", CharsetUtil.UTF_8)); } ChannelHandler 和 ChannelHandlerContext 的高级用法 正如我们在代码清单 6-6 中所看到的，你可以通过调用 ChannelHandlerContext 上的pipeline()方法来获得被封闭的 ChannelPipeline 的引用。这使得运行时得以操作ChannelPipeline 的 ChannelHandler，我们可以利用这一点来实现一些复杂的设计。例如，你可以通过将 ChannelHandler 添加到 ChannelPipeline 中来实现动态的协议切换。\n另一种高级的用法是缓存到 ChannelHandlerContext 的引用以供稍后使用，这可能会发生在任何的 ChannelHandler 方法之外，甚至来自于不同的线程。代码清单 6-9 展示了用这种模式来触发事件。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /** * 代码清单 6-9 缓存到 ChannelHandlerContext 的引用 * * @author Norman Maurer */ public class WriteHandler extends ChannelHandlerAdapter { private ChannelHandlerContext ctx; @Override public void handlerAdded(ChannelHandlerContext ctx) { //存储到 ChannelHandlerContext的引用以供稍后使用 this.ctx = ctx; } public void send(String msg) { //使用之前存储的到 ChannelHandlerContext的引用来发送消息 ctx.writeAndFlush(msg); } } 因为一个 ChannelHandler 可以从属于多个 ChannelPipeline，所以它也可以绑定到多个 ChannelHandlerContext 实例。对于这种用法指在多个 ChannelPipeline 中共享同一个 ChannelHandler，对应的 ChannelHandler 必须要使用@Sharable 注解标注；否则，试图将它添加到多个 ChannelPipeline 时将会触发异常。显而易见，为了安全地被用于多个并发的 Channel（即连接），这样的 ChannelHandler 必须是线程安全的。代码清单 6-10 展示了这种模式的一个正确实现。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /** * 代码清单 6-10 可共享的 ChannelHandler * * @author Norman Maurer */ //使用注解@Sharable标注 @Sharable public class SharableHandler extends ChannelInboundHandlerAdapter { @Override public void channelRead(ChannelHandlerContext ctx, Object msg) { System.out.println(\"channel read message \" + msg); //记录方法调用，并转发给下一个 ChannelHandler ctx.fireChannelRead(msg); } } 前面的 ChannelHandler 实现符合所有的将其加入到多个 ChannelPipeline 的需求，即它使用了注解 @Sharable 标注，并且也不持有任何的状态。相反，代码清单 6-11 中的实现将会导致问题。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 /** * 代码清单 6-11 @Sharable 的错误用法 * * @author Norman Maurer */ //使用注解@Sharable标注 @Sharable public class UnsharableHandler extends ChannelInboundHandlerAdapter { private int count; @Override public void channelRead(ChannelHandlerContext ctx, Object msg) { //将 count 字段的值加 1 count++; //记录方法调用，并转发给下一个ChannelHandler System.out.println(\"inboundBufferUpdated(...) called the \" + count + \" time\"); ctx.fireChannelRead(msg); } } 这段代码的主要的问题在于，对于其所持有的状态的修改并不是线程安全的（也可以通过使用 AtomicInteger来规避这个问题），即用于跟踪方法调用次数的实例变量count。将这个类的一个实例添加到ChannelPipeline将极有可能在它被多个并发的Channel访问时导致问题。（当然，这个简单的问题可以通过使channelRead()方法变为同步方法来修正。） 总之，只应该在确定了你的 ChannelHandler 是线程安全的时才使用@Sharable 注解。 为何要共享同一个ChannelHandler 在多个ChannelPipeline中安装同一个ChannelHandler的一个常见的原因是用于收集跨越多个 Channel 的统计信息。\n异常处理 异常处理是程序的重要组成部分，Netty提供了几种方式用于处理出入站过程中所抛出的异常。\n入站异常 如果在处理入站事件的过程中有异常被抛出，那么它将从它在 ChannelInboundHandler里被触发的那一点开始流经 ChannelPipeline。要想处理这种类型的入站异常，你需要在你的 ChannelInboundHandler 实现中重写下面的方法。 public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception\n代码清单 6-12 展示了一个简单的示例，其关闭了 Channel 并打印了异常的栈跟踪信息。\n1 2 3 4 5 6 7 8 9 10 11 12 13 /** * 代码清单 6-12 基本的入站异常处理 * * @author Norman Maurer */ public class InboundExceptionHandler extends ChannelInboundHandlerAdapter { @Override public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) { cause.printStackTrace(); ctx.close(); } } 因为异常将会继续按照入站方向流动（就像所有的入站事件一样），所以实现了前面所示逻辑的 ChannelInboundHandler 通常位于 ChannelPipeline 的最后。这确保了所有的入站异常都总是会被处理，无论它们可能会发生在 ChannelPipeline 中的什么位置。 你应该如何响应异常，可能很大程度上取决于你的应用程序。你可能想要关闭Channel（和连接），也可能会尝试进行恢复。如果你不实现任何处理入站异常的逻辑（或者没有消费该异常），那么Netty将会记录该异常没有被处理的事实，即 Netty 将会通过 Warning 级别的日志记录该异常到达了 ChannelPipeline 的尾端，但没有被处理，并尝试释放该异常。 总结：\nChannelHandler.exceptionCaught()的默认实现是简单地将当前异常转发给ChannelPipeline 中的下一个ChannelHandler； 如果异常到达了 ChannelPipeline 的尾端，它将会被记录为未被处理； 要想定义自定义的处理逻辑，你需要重写 exceptionCaught()方法。然后你需要决定是否需要将该异常传播出去。 出站异常 用于处理出站操作中的正常完成以及异常的选项，都基于以下的通知机制。\n每个出站操作都将返回一个 ChannelFuture。注册到 ChannelFuture 的 ChannelFutureListener 将在操作完成时被通知该操作是成功了还是出错了。 几乎所有的 ChannelOutboundHandler 上的方法都会传入一个 ChannelPromise的实例。作为ChannelFuture的子类，ChannelPromise 也可以被分配用于异步通知的监听器。但是，ChannelPromise 还具有提供立即通知的可写方法： ChannelPromise setSuccess(); ChannelPromise setFailure(Throwable cause); 添加 ChannelFutureListener 只需要调用 ChannelFuture 实例上的 addListener (ChannelFutureListener)方法，并且有两种不同的方式可以做到这一点。其中最常用的方式是，调用出站操作（如 write()方法）所返回的 ChannelFuture 上的 addListener()方法。 代码清单 6-13 使用了这种方式来添加 ChannelFutureListener，它将打印栈跟踪信息并且随后关闭 Channel。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 /** * Created by kerr. * * 代码清单 6-13 添加 ChannelFutureListener 到 ChannelFuture */ public class ChannelFutures { private static final Channel CHANNEL_FROM_SOMEWHERE = new NioSocketChannel(); private static final ByteBuf SOME_MSG_FROM_SOMEWHERE = Unpooled.buffer(1024); /** * 代码清单 6-13 添加 ChannelFutureListener 到 ChannelFuture * */ public static void addingChannelFutureListener(){ Channel channel = CHANNEL_FROM_SOMEWHERE; // get reference to pipeline; ByteBuf someMessage = SOME_MSG_FROM_SOMEWHERE; // get reference to pipeline; //... io.netty.channel.ChannelFuture future = channel.write(someMessage); future.addListener(new ChannelFutureListener() { @Override public void operationComplete(io.netty.channel.ChannelFuture f) { if (!f.isSuccess()) { f.cause().printStackTrace(); f.channel().close(); } } }); } } 第二种方式是将 ChannelFutureListener 添加到即将作为参数传递给 ChannelOutboundHandler 的方法的ChannelPromise。代码清单 6-14 中所展示的代码和代码清单 6-13中所展示的具有相同的效果。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /** * 代码清单 6-14 添加 ChannelFutureListener 到 ChannelPromise * * @author Norman Maurer */ public class OutboundExceptionHandler extends ChannelOutboundHandlerAdapter { @Override public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) { promise.addListener(new ChannelFutureListener() { @Override public void operationComplete(ChannelFuture f) { if (!f.isSuccess()) { f.cause().printStackTrace(); f.channel().close(); } } }); } } ChannelPromise 的可写方法： 通过调用 ChannelPromise 上的 setSuccess()和 setFailure()方法，可以使一个操作的状态在 ChannelHandler 的方法返回给其调用者时便即刻被感知到。 为何选择一种方式而不是另一种呢？对于细致的异常处理，你可能会发现，在调用出站操作时添加 ChannelFutureListener 更合适，如代码清单 6-13 所示。而对于一般的异常处理，你可能会发现， 代码清单 6-14 所示的自定义的 ChannelOutboundHandler 实现的方式更加的简单。 如果你的 ChannelOutboundHandler 本身抛出了异常会发生什么呢？在这种情况下，Netty 本身会通知任何已经注册到对应 ChannelPromise 的监听器。\nEventLoop和线程模型 简单地说，线程模型指定了操作系统、编程语言、框架或者应用程序的上下文中的线程管理的关键方面。显而易见地，如何以及何时创建线程将对应用程序代码的执行产生显著的影响，因此开发人员需要理解与不同模型相关的权衡。无论是他们自己选择模型，还是通过采用某种编程语言或者框架隐式地获得它，这都是真实的。在本章中，我们将详细地探讨 Netty 的线程模型。它强大但又易用，并且和 Netty 的一贯宗旨一样，旨在简化你的应用程序代码，同时最大限度地提高性能和可维护性。我们还将讨论致使选择当前线程模型的经验。\n线程模型概述 正如我们在本章开头所指出的，线程模型确定了代码的执行方式。由于我们总是必须规避并发执行可能会带来的副作用，所以理解所采用的并发模型（也有单线程的线程模型）的影响很重要。忽略这些问题，仅寄希望于最好的情况（不会引发并发问题）无疑是掩耳盗铃。\n现在多核心多线程的CPU已经司空见惯，大多数的现代应用程序都利用了复杂的多线程处理技术以有效地利用系统资源。相比之下，在早期的 Java 语言中，我们使用多线程处理的主要方式无非是按需创建和启动新的Thread 来执行并发的任务单元（一种在高负载下工作得很差的原始方式。） Java 5 随后引入了 Executor API，其线程池通过缓存和重用Thread 极大地提高了性能。\n基本的线程池化模式可以描述为：\n从池的空闲线程列表中选择一个 Thread，并且指派它去运行一个已提交的任务（一个Runnable 的实现）； 当任务完成时，将该 Thread 返回给该列表，使其可被重用。图 7-1 说明了这个模式。 虽然池化和重用线程相对于简单地为每个任务都创建和销毁线程是一种进步，但是它并不能消除由上下文切换所带来的开销，其将随着线程数量的增加很快变得明显，并且在高负载下愈演愈烈。此外，仅仅由于应用程序的整体复杂性或者并发需求，在项目的生命周期内也可能会出现其他和线程相关的问题。简而言之，多线程处理是很复杂的。在接下来的章节中，我们将会看到 Netty 是如何帮助简化它的。 EventLoop接口 运行任务来处理在连接的生命周期内发生的事件是任何网络框架的基本功能。与之相应的编程上的构造通常被称为事件循环：一个 Netty 使用了 interface io.netty.channel.EventLoop 来适配的术语。 代码清单 7-1 中说明了事件循环的基本思想，其中每个任务都是一个 Runnable 的实例（如图 7-1 所示）。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 /** * 代码清单 7-1 在事件循环中执行任务 * * @author Norman Maurer */ public class EventLoopExamples { /** * 代码清单 7-1 在事件循环中执行任务 * */ public static void executeTaskInEventLoop() { boolean terminated = true; //... while (!terminated) { //阻塞，直到有事件已经就绪可被运行 List readyEvents = blockUntilEventsReady(); for (Runnable ev: readyEvents) { //循环遍历，并处理所有的事件 ev.run(); } } } private static final List blockUntilEventsReady() { return Collections.singletonList(new Runnable() { @Override public void run() { try { Thread.sleep(1000); } catch (InterruptedException e) { e.printStackTrace(); } } }); } } Netty 的 EventLoop 是协同设计的一部分，它采用了两个基本的 API：并发和网络编程。 首先，io.netty.util.concurrent 包构建在 JDK 的 java.util.concurrent 包上，用来提供线程执行器。 其次，io.netty.channel 包中的类，为了与 Channel 的事件进行交互，扩展了这些接口/类。 图 7-2 展示了生成的类层次结构。 在这个模型中，一个 EventLoop 将由一个永远都不会改变的 Thread 驱动， 同时任务（Runnable 或者 Callable）可以直接提交给 EventLoop 实现，以立即执行或者调度执行。根据配置和可用核心的不同，可能会创建多个 EventLoop 实例用以优化资源的使用，并且单个EventLoop 可能会被指派用于服务多个 Channel。\n需要注意的是，Netty的EventLoop在继承了ScheduledExecutorService的同时，只定义了一个方法，parent()。这个方法重写了 EventExecutor 的 EventExecutorGroup.parent()方法。用于返回到当前EventLoop实现的实例所属的EventLoopGroup的引用。\n1 2 3 4 public interface EventLoop extends EventExecutor, EventLoopGroup { @Override EventLoopGroup parent(); } 事件/任务的执行顺序： 事件和任务是以先进先出（FIFO）的顺序执行的。这样可以通过保证字节内容总是按正确的顺序被处理，消除潜在的数据损坏的可能性。\nNetty 4 中的 I/O 和事件处理 正如我们在第 6 章中所详细描述的，由 I/O 操作触发的事件将流经安装了一个或者多个ChannelHandler的ChannelPipeline。传播这些事件的方法调用可以随后被 ChannelHandler 所拦截，并且可以按需地处理事件。 事件的性质通常决定了它将被如何处理；它可能将数据从网络栈中传递到你的应用程序中，或者进行逆向操作，或者 执行一些截然不同的操作。但是事件的处理逻辑必须足够的通用和灵活，以处理所有可能的用例。因此，在Netty 4 中，所有的I/O操作和事件都由已经被分配给了EventLoop的那个Thread来处理。\nNetty 3 中的 I/O 操作 在以前的版本中所使用的线程模型只保证了入站（之前称为上游）事件会在所谓的 I/O 线程（对应于Netty 4 中的 EventLoop）中执行。所有的出站（下游）事件都由调用线程处理，其可能是 I/O 线程也可能是别的线程。开始看起来这似乎是个好主意，但是已经被发现是有问题的，因为需要在 ChannelHandler 中对出站事件进行仔细的同步。简而言之，不可能保证多个线程不会在同一时刻尝试访问出站事件。例如，如果你通过在不同的线程中调用 Channel.write()方法，针对同一个 Channel 同时触发出站的事件，就会发生这种情况。当出站事件触发了入站事件时，将会导致另一个负面影响。当 Channel.write()方法导致异常时，需要生成并触发一个 exceptionCaught 事件。但是在 Netty 3 的模型中，由于这是一个入站事件，需要在调用线程中执行代码，然后将事件移交给 I/O 线程去执行，然而这将带来额外的上下文切换。Netty 4 中所采用的线程模型，通过在同一个线程中处理某个给定的 EventLoop 中所产生的所有事件，解决了这个问题。这提供了一个更加简单的执行体系架构，并且消除了在多个ChannelHandler 中进行同步的需要（除了任何可能需要在多个 Channel 中共享的）。现在，已经理解了 EventLoop 的角色，让我们来看看任务是如何被调度执行的吧。\n任务调度 有时候，你将需要调度一个任务以便稍后（延迟）执行或者周期性地执行。例如，你可能想要注册一个在客户端已经连接了 5 分钟之后触发的任务。一个常见的用例是，发送心跳消息到远程节点，以检查连接是否仍然还活着。如果没有响应，你便知道可以关闭该 Channel 了。 在接下来的几节中，我们将展示如何使用核心的Java API 和 Netty 的 EventLoop 来调度任务。 然后，我们将研究 Netty 的内部实现，并讨论它的优点和局限性。\nJDK 的任务调度 API 在 Java 5 之前，任务调度是建立在 java.util.Timer 类之上的，其使用了一个后台 Thread，并且具有与标准线程相同的限制。随后，JDK 提供了 java.util.concurrent 包，它定义了 interface ScheduledExecutorService。如下是 java.util.concurrent.Executors的相关工厂方法。\nnewScheduledThreadPool( int corePoolSize) newScheduledThreadPool( int corePoolSize, ThreadFactorythreadFactory) 创建一个 ScheduledThreadExecutorService， 用于调度命令在指定延迟之后运行或者周期性地执 行。它使用 corePoolSize 参数来计算线程数\nnewSingleThreadScheduledExecutor(), newSingleThreadScheduledExecutor( ThreadFactorythreadFactory) 创建一个 ScheduledThreadExecutorService， 用于调度命令在指定延迟之后运行或者周期性地执行。它使用一个线程来执行被调度的任务\n虽然选择不多，但是这些预置的实现已经足以应对大多数的用例。 代码清单 7-2 展示了如何使用ScheduledExecutorService来在 60 秒的延迟之后执行一个任务。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 /** * 代码清单 7-2 使用 ScheduledExecutorService 调度任务 * */ public static void schedule() { //创建一个其线程池具有 10 个线程的ScheduledExecutorService ScheduledExecutorService executor = Executors.newScheduledThreadPool(10); ScheduledFuture\u003c?\u003e future = executor.schedule( //创建一个 Runnable，以供调度稍后执行 new Runnable() { @Override public void run() { //该任务要打印的消息 System.out.println(\"Now it is 60 seconds later\"); } //调度任务在从现在开始的 60 秒之后执行 }, 60, TimeUnit.SECONDS); //... //一旦调度任务执行完成，就关闭 ScheduledExecutorService 以释放资源 executor.shutdown(); } 虽然 ScheduledExecutorService API 是直截了当的，但是在高负载下它将带来性能上的负担。 在下一节中，我们将看到 Netty 是如何以更高的效率提供相同的功能的。\n使用 EventLoop 调度任务 ScheduledExecutorService 的实现具有局限性，因为作为线程池管理的一部分，将会有额外的线程创建。如果有大量任务被紧凑地调度，那么这将成为一个问题。Netty 通过 Channel 的 EventLoop 实现任务调度解决了这一问题，如代码清单 7-3 所示。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /** * 代码清单 7-3 使用 EventLoop 调度任务 * */ public static void scheduleViaEventLoop() { Channel ch = CHANNEL_FROM_SOMEWHERE; // get reference from somewhere ScheduledFuture\u003c?\u003e future = ch.eventLoop().schedule( //创建一个 Runnable以供调度稍后执行 new Runnable() { @Override public void run() { //要执行的代码 System.out.println(\"60 seconds later\"); } //调度任务在从现在开始的 60 秒之后执行 }, 60, TimeUnit.SECONDS); } 经过 60 秒之后，Runnable 实例将由分配给 Channel 的 EventLoop 执行。如果要调度任务以每隔 60 秒执行一次，请使用 scheduleAtFixedRate()方法，如代码清单 7-4 所示。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /** * 代码清单 7-4 使用 EventLoop 调度周期性的任务 * */ public static void scheduleFixedViaEventLoop() { Channel ch = CHANNEL_FROM_SOMEWHERE; // get reference from somewhere ScheduledFuture\u003c?\u003e future = ch.eventLoop().scheduleAtFixedRate( //创建一个 Runnable，以供调度稍后执行 new Runnable() { @Override public void run() { //这将一直运行，直到 ScheduledFuture 被取消 System.out.println(\"Run every 60 seconds\"); } //调度在 60 秒之后，并且以后每间隔 60 秒运行 }, 60, 60, TimeUnit.SECONDS); } 如我们前面所提到的，Netty的EventLoop扩展了ScheduledExecutorService（见图7-2），所以它提供了使用JDK实现可用的所有方法，包括在前面的示例中使用到的schedule()和scheduleAtFixedRate()方法。 所有操作的完整列表可以在ScheduledExecutorService的Javadoc中找到。 ①Java平台，标准版第8版API规范，java.util.concurrent，Interface ScheduledExecutorService： http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ScheduledExecutorService.html\n要想取消或者检查（被调度任务的）执行状态，可以使用每个异步操作所返回的 ScheduledFuture。 代码清单 7-5 展示了一个简单的取消操作。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 /** * 代码清单 7-5 使用 ScheduledFuture 取消任务 * */ public static void cancelingTaskUsingScheduledFuture(){ Channel ch = CHANNEL_FROM_SOMEWHERE; // get reference from somewhere //调度任务，并获得所返回的ScheduledFuture ScheduledFuture\u003c?\u003e future = ch.eventLoop().scheduleAtFixedRate( new Runnable() { @Override public void run() { System.out.println(\"Run every 60 seconds\"); } }, 60, 60, TimeUnit.SECONDS); //运行其他代码 boolean mayInterruptIfRunning = false; //取消该任务，防止它再次运行 future.cancel(mayInterruptIfRunning); } 这些例子说明，可以利用 Netty 的任务调度功能来获得性能上的提升。 反过来，这些也依赖于底层的线程模型，我们接下来将对其进行研究。\n实现细节 这一节将更加详细地探讨 Netty 的线程模型和任务调度实现的主要内容。 我们也将会提到需要注意的局限性，以及正在不断发展中的领域。\n线程管理 Netty线程模型的卓越性能取决于对于当前执行的Thread的身份的确定。 （通过调用 EventLoop 的 inEventLoop(Thread)方法实现） 也就是说，确定它是否是分配给当前Channel以及它的EventLoop的那一个线程。（EventLoop将负责处理一个Channel的整个生命周期内的所有事件。）\n如果（当前）调用线程正是支撑 EventLoop 的线程，那么所提交的代码块将会被（直接）执行。 否则，EventLoop 将调度该任务以便稍后执行，并将它放入到内部队列中。当 EventLoop下次处理它的事件时，它会执行队列中的那些任务/事件。这也就解释了任何的 Thread 是如何与 Channel 直接交互而无需在ChannelHandler 中进行额外同步的。\n注意，每个 EventLoop 都有它自已的任务队列，独立于任何其他的 EventLoop。 图 7-3展示了 EventLoop 用于调度任务的执行逻辑。这是 Netty 线程模型的关键组成部分。 我们之前已经阐明了不要阻塞当前 I/O 线程的重要性。我们再以另一种方式重申一次：“永远不要将一个长时间运行的任务放入到执行队列中，因为它将阻塞需要在同一线程上执行的任何其他任务。”如果必须要进行阻塞调用或者执行长时间运行的任务，我们建议使用一个专门的EventExecutor。 （见 6.2.1 节的“ChannelHandler 的执行和阻塞”）。 除了这种受限的场景，如同传输所采用的不同的事件处理实现一样，所使用的线程模型也可以强烈地影响到排队的任务对整体系统性能的影响。（如同我们在第 4 章中所看到的，使用 Netty可以轻松地切换到不同的传输实现，而不需要修改你的代码库。）\nEventLoop/线程的分配 服务于 Channel 的 I/O 和事件的 EventLoop 包含在 EventLoopGroup 中。 根据不同的传输实现，EventLoop 的创建和分配方式也不同。\n异步传输 异步传输实现只使用了少量的 EventLoop（以及和它们相关联的 Thread），而且在当前的线程模型中，它们可能会被多个 Channel 所共享。这使得可以通过尽可能少量的 Thread 来支撑大量的 Channel，而不是每个Channel 分配一个 Thread。 图 7-4 显示了一个 EventLoopGroup，它具有 3 个固定大小的 EventLoop（每个 EventLoop都由一个Thread支撑）。在创建 EventLoopGroup 时就直接分配了 EventLoop（以及支撑它们的 Thread），以确保在需要时它们是可用的。 EventLoopGroup 负责为每个新创建的 Channel 分配一个 EventLoop。在当前实现中，使用顺序循环（round-robin）的方式进行分配以获取一个均衡的分布，并且相同的 EventLoop可能会被分配给多个Channel。（这一点在将来的版本中可能会改变。）一旦一个 Channel 被分配给一个 EventLoop，它将在它的整个生命周期中都使用这个EventLoop（以及相关联的 Thread）。这将影响你ChannelHandler的同步和线程安全。\n阻塞传输 阻塞传输的模型有所不同。这里每一个 Channel 都将被分配给一个 EventLoop（以及它的 Thread）。可以保证的是每个 Channel 的 I/O 事件都将只会被一个 Thread处理（用于支撑该 Channel 的 EventLoop 的那个 Thread）。这也是Netty一致性的例子，这种设计上的一致性，正是Netty的可靠性和易用性的体现。 小结 本章我们学习了Netty 所采用的线程模型，详细探讨了其性能以及一致性。你学习了如何调度任务以便推迟执行，并且我们还探讨了高负载下的伸缩性问题。你也看到了如何验证一个任务是否已被执行以及如何取消它。通过我们对 Netty 框架的实现细节的研究所获得的这些信息，将帮助你在简化你的应用程序代码库的同时最大限度地提高它的性能。\n引导 简单来说，引导一个应用程序是指对它进行配置，并使它运行起来的过程。本章我们会通过引导将 ChannelPipeline、ChannelHandler和 EventLoop组合起来。 Netty的引导会将你的应用程序和网络层隔离（分层抽象）。\nBootstrap类 服务器致力于使用一个父 Channel 来接受来自客户端的连接，并创建子 Channel 以用于它们之间的通信；而客户端将最可能只需要一个单独的、没有父 Channel 的 Channel 来用于所有的网络交互。（正如同我们将要看到的，这也适用于无连接的传输协议，如 UDP，因为它们并不是每个连接都需要一个单独的 Channel）\n为什么引导类是 Cloneable 的？ 你有时可能会需要创建多个具有类似配置或者完全相同配置的Channel。为了支持这种模式而又不需要为每个Channel 都创建并配置一个新的引导类实例， AbstractBootstrap 被标记为了Cloneable。 在一个已经配置完成的引导类实例上调用clone()方法将返回另一个可以立即使用的引导类实例。 注意，这种方式只会创建引导类实例的EventLoopGroup的一个浅拷贝，所以被浅拷贝的 EventLoopGroup将在所有克隆的Channel实例之间共享。这是可以接受的，因为通常这些克隆的Channel的生命周期都很短暂，一个典型的场景是：创建一个Channel以进行一次HTTP请求。\nAbstractBootstrap 类的完整声明是： public abstract class AbstractBootstrap ",
  "wordCount" : "86896",
  "inLanguage": "en",
  "datePublished": "2021-01-14T09:28:13Z",
  "dateModified": "2021-01-14T09:28:13Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/%E5%85%B6%E4%BB%96%E5%9F%BA%E7%A1%80/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

  <script id="MathJax-script" async src="https://cdn.bootcss.com/mathjax/3.0.5/es5/tex-mml-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath:  [['\\(', '\\)'], ['$', '$']],  
    }
  };
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      《Netty实战》读书笔记
    </h1>
    <div class="post-meta"><span title='2021-01-14 09:28:13 +0000 UTC'>2021-01-14</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%ac%ac%e4%b8%80%e4%b8%aanetty%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="第一个Netty应用程序">第一个Netty应用程序</a><ul>
                        
                <li>
                    <a href="#%e7%bc%96%e5%86%99-echo-%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="编写 Echo 服务器">编写 Echo 服务器</a><ul>
                        
                <li>
                    <a href="#%e9%80%9a%e8%bf%87channelhandler%e5%ae%9e%e7%8e%b0%e6%9c%8d%e5%8a%a1%e7%ab%af" aria-label="通过channelHandler实现服务端">通过channelHandler实现服务端</a></li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99%e5%bc%95%e5%af%bc%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="编写引导服务器">编写引导服务器</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99echo%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="编写echo客户端">编写echo客户端</a><ul>
                        
                <li>
                    <a href="#%e9%80%9a%e8%bf%87-channelhandler-%e5%ae%9e%e7%8e%b0%e5%ae%a2%e6%88%b7%e7%ab%af%e9%80%bb%e8%be%91" aria-label="通过 ChannelHandler 实现客户端逻辑">通过 ChannelHandler 实现客户端逻辑</a></li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99%e5%bc%95%e5%af%bc%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="编写引导客户端">编写引导客户端</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#netty%e7%9a%84%e7%bb%84%e4%bb%b6%e5%92%8c%e8%ae%be%e8%ae%a1" aria-label="Netty的组件和设计">Netty的组件和设计</a><ul>
                        
                <li>
                    <a href="#channel%e6%8e%a5%e5%8f%a3" aria-label="Channel接口">Channel接口</a></li>
                <li>
                    <a href="#eventloop%e6%8e%a5%e5%8f%a3" aria-label="EventLoop接口">EventLoop接口</a></li>
                <li>
                    <a href="#channelfuture%e6%8e%a5%e5%8f%a3" aria-label="ChannelFuture接口">ChannelFuture接口</a></li>
                <li>
                    <a href="#channelhandler%e6%8e%a5%e5%8f%a3" aria-label="ChannelHandler接口">ChannelHandler接口</a></li>
                <li>
                    <a href="#channelpipeline%e6%8e%a5%e5%8f%a3" aria-label="ChannelPipeline接口">ChannelPipeline接口</a></li>
                <li>
                    <a href="#%e6%9b%b4%e5%8a%a0%e6%b7%b1%e5%85%a5%e5%9c%b0%e4%ba%86%e8%a7%a3-channelhandler" aria-label="更加深入地了解 ChannelHandler">更加深入地了解 ChannelHandler</a></li>
                <li>
                    <a href="#%e7%bc%96%e7%a0%81%e5%99%a8%e5%92%8c%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="编码器和解码器">编码器和解码器</a></li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-simplechannelinboundhandler" aria-label="抽象类 SimpleChannelInboundHandler">抽象类 SimpleChannelInboundHandler</a></li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc%e7%b1%bb" aria-label="引导类">引导类</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bc%a0%e8%be%93" aria-label="传输">传输</a><ul>
                        
                <li>
                    <a href="#%e6%a1%88%e4%be%8b%e7%a0%94%e7%a9%b6" aria-label="案例研究">案例研究</a><ul>
                        
                <li>
                    <a href="#%e4%b8%8d%e9%80%9a%e8%bf%87-netty-%e4%bd%bf%e7%94%a8-oio-%e5%92%8c-nio" aria-label="不通过 Netty 使用 OIO 和 NIO">不通过 Netty 使用 OIO 和 NIO</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87-netty-%e4%bd%bf%e7%94%a8-oio-%e5%92%8c-nio" aria-label="通过 Netty 使用 OIO 和 NIO">通过 Netty 使用 OIO 和 NIO</a></li>
                <li>
                    <a href="#%e9%9d%9e%e9%98%bb%e5%a1%9e%e7%9a%84-netty-%e7%89%88%e6%9c%ac" aria-label="非阻塞的 Netty 版本">非阻塞的 Netty 版本</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bc%a0%e8%be%93api" aria-label="传输API">传输API</a></li>
                <li>
                    <a href="#%e5%86%85%e7%bd%ae%e7%9a%84%e4%bc%a0%e8%be%93" aria-label="内置的传输">内置的传输</a><ul>
                        
                <li>
                    <a href="#nio%e9%9d%9e%e9%98%bb%e5%a1%9e-io" aria-label="NIO——非阻塞 I/O">NIO——非阻塞 I/O</a></li>
                <li>
                    <a href="#epoll%e7%94%a8%e4%ba%8e-linux-%e7%9a%84%e6%9c%ac%e5%9c%b0%e9%9d%9e%e9%98%bb%e5%a1%9e%e4%bc%a0%e8%be%93" aria-label="Epoll—用于 Linux 的本地非阻塞传输">Epoll—用于 Linux 的本地非阻塞传输</a></li>
                <li>
                    <a href="#oio%e6%97%a7%e7%9a%84%e9%98%bb%e5%a1%9e-io" aria-label="OIO—旧的阻塞 I/O">OIO—旧的阻塞 I/O</a></li>
                <li>
                    <a href="#%e7%94%a8%e4%ba%8e-jvm-%e5%86%85%e9%83%a8%e9%80%9a%e4%bf%a1%e7%9a%84-local-%e4%bc%a0%e8%be%93" aria-label="用于 JVM 内部通信的 Local 传输">用于 JVM 内部通信的 Local 传输</a></li>
                <li>
                    <a href="#embedded-%e4%bc%a0%e8%be%93" aria-label="Embedded 传输">Embedded 传输</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%80%89%e6%8b%a9%e5%93%aa%e4%b8%80%e7%a7%8d%e4%bc%a0%e8%be%93" aria-label="选择哪一种传输">选择哪一种传输</a><ul>
                        
                <li>
                    <a href="#%e9%9d%9e%e9%98%bb%e5%a1%9e%e4%bb%a3%e7%a0%81%e5%ba%93" aria-label="非阻塞代码库">非阻塞代码库</a></li>
                <li>
                    <a href="#%e9%98%bb%e5%a1%9e%e4%bb%a3%e7%a0%81%e5%ba%93" aria-label="阻塞代码库">阻塞代码库</a></li>
                <li>
                    <a href="#%e5%9c%a8%e5%90%8c%e4%b8%80%e4%b8%aa-jvm-%e5%86%85%e9%83%a8%e7%9a%84%e9%80%9a%e4%bf%a1" aria-label="在同一个 JVM 内部的通信">在同一个 JVM 内部的通信</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e4%bd%a0%e7%9a%84-channelhandler-%e5%ae%9e%e7%8e%b0" aria-label="测试你的 ChannelHandler 实现">测试你的 ChannelHandler 实现</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#bytebuf" aria-label="ByteBuf">ByteBuf</a><ul>
                        
                <li>
                    <a href="#bytebuf-%e7%9a%84-api" aria-label="ByteBuf 的 API">ByteBuf 的 API</a></li>
                <li>
                    <a href="#bytebuf-%e7%b1%bbnetty-%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ae%b9%e5%99%a8" aria-label="ByteBuf 类——Netty 的数据容器">ByteBuf 类——Netty 的数据容器</a><ul>
                        
                <li>
                    <a href="#bytebuf%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c" aria-label="bytebuf如何工作">bytebuf如何工作</a></li>
                <li>
                    <a href="#bytebuf-%e7%9a%84%e4%bd%bf%e7%94%a8%e6%a8%a1%e5%bc%8f" aria-label="ByteBuf 的使用模式">ByteBuf 的使用模式</a><ul>
                        
                <li>
                    <a href="#%e5%a0%86%e7%bc%93%e5%86%b2%e5%8c%ba" aria-label="堆缓冲区">堆缓冲区</a></li>
                <li>
                    <a href="#%e7%9b%b4%e6%8e%a5%e7%bc%93%e5%86%b2%e5%8c%ba" aria-label="直接缓冲区">直接缓冲区</a></li>
                <li>
                    <a href="#%e5%a4%8d%e5%90%88%e7%bc%93%e5%86%b2%e5%8c%ba" aria-label="复合缓冲区">复合缓冲区</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#byebuf%e5%ad%97%e8%8a%82%e7%ba%a7%e6%93%8d%e4%bd%9c" aria-label="ByeBuf字节级操作">ByeBuf字节级操作</a><ul>
                        
                <li>
                    <a href="#%e9%9a%8f%e6%9c%ba%e8%ae%bf%e9%97%ae%e7%b4%a2%e5%bc%95" aria-label="随机访问索引">随机访问索引</a></li>
                <li>
                    <a href="#%e9%a1%ba%e5%ba%8f%e8%ae%bf%e9%97%ae%e7%b4%a2%e5%bc%95" aria-label="顺序访问索引">顺序访问索引</a></li>
                <li>
                    <a href="#%e5%8f%af%e4%b8%a2%e5%bc%83%e5%ad%97%e8%8a%82" aria-label="可丢弃字节">可丢弃字节</a></li>
                <li>
                    <a href="#%e5%8f%af%e8%af%bb%e5%ad%97%e8%8a%82" aria-label="可读字节">可读字节</a></li>
                <li>
                    <a href="#%e5%8f%af%e5%86%99%e5%ad%97%e8%8a%82" aria-label="可写字节">可写字节</a></li>
                <li>
                    <a href="#%e7%b4%a2%e5%bc%95%e7%ae%a1%e7%90%86" aria-label="索引管理">索引管理</a></li>
                <li>
                    <a href="#%e6%9f%a5%e6%89%be%e6%93%8d%e4%bd%9c" aria-label="查找操作">查找操作</a></li>
                <li>
                    <a href="#%e6%b4%be%e7%94%9f%e7%bc%93%e5%86%b2%e5%8c%ba" aria-label="派生缓冲区">派生缓冲区</a></li>
                <li>
                    <a href="#%e8%af%bb%e5%86%99%e6%93%8d%e4%bd%9c" aria-label="读/写操作">读/写操作</a></li>
                <li>
                    <a href="#bytebuf%e5%85%b6%e4%bb%96%e6%93%8d%e4%bd%9c" aria-label="byteBuf其他操作">byteBuf其他操作</a></li></ul>
                </li>
                <li>
                    <a href="#bytebufholder-%e6%8e%a5%e5%8f%a3" aria-label="ByteBufHolder 接口">ByteBufHolder 接口</a></li>
                <li>
                    <a href="#bytebuf%e5%88%86%e9%85%8d%e7%ae%a1%e7%90%86" aria-label="ByteBuf分配(管理)">ByteBuf分配(管理)</a><ul>
                        
                <li>
                    <a href="#%e6%8c%89%e9%9c%80%e5%88%86%e9%85%8dbytebufallocator-%e6%8e%a5%e5%8f%a3" aria-label="按需分配：ByteBufAllocator 接口">按需分配：ByteBufAllocator 接口</a></li>
                <li>
                    <a href="#unpooled-%e7%bc%93%e5%86%b2%e5%8c%ba" aria-label="Unpooled 缓冲区">Unpooled 缓冲区</a></li>
                <li>
                    <a href="#bytebufutil-%e7%b1%bb" aria-label="ByteBufUtil 类">ByteBufUtil 类</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%95%e7%94%a8%e8%ae%a1%e6%95%b0%e6%b3%95" aria-label="引用计数法">引用计数法</a></li></ul>
                </li>
                <li>
                    <a href="#channelhandler%e5%92%8cchannelpipeline" aria-label="ChannelHandler和ChannelPipeline">ChannelHandler和ChannelPipeline</a><ul>
                        
                <li>
                    <a href="#channelhandler%e5%ae%b6%e6%97%8f" aria-label="ChannelHandler家族">ChannelHandler家族</a><ul>
                        
                <li>
                    <a href="#channel%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="Channel的生命周期">Channel的生命周期</a></li>
                <li>
                    <a href="#channelhandler%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="ChannelHandler的生命周期">ChannelHandler的生命周期</a></li>
                <li>
                    <a href="#channelinboundhandler-%e6%8e%a5%e5%8f%a3" aria-label="ChannelInboundHandler 接口">ChannelInboundHandler 接口</a></li>
                <li>
                    <a href="#channeloutboundhandler-%e6%8e%a5%e5%8f%a3" aria-label="ChannelOutboundHandler 接口">ChannelOutboundHandler 接口</a></li>
                <li>
                    <a href="#channelhandler-%e9%80%82%e9%85%8d%e5%99%a8" aria-label="ChannelHandler 适配器">ChannelHandler 适配器</a></li>
                <li>
                    <a href="#%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86" aria-label="资源管理">资源管理</a></li></ul>
                </li>
                <li>
                    <a href="#channelpipeline-%e6%8e%a5%e5%8f%a3" aria-label="ChannelPipeline 接口">ChannelPipeline 接口</a><ul>
                        
                <li>
                    <a href="#%e4%bf%ae%e6%94%b9-channelpipeline" aria-label="修改 ChannelPipeline">修改 ChannelPipeline</a></li>
                <li>
                    <a href="#%e8%a7%a6%e5%8f%91%e4%ba%8b%e4%bb%b6" aria-label="触发事件">触发事件</a></li></ul>
                </li>
                <li>
                    <a href="#channelhandlercontext-%e6%8e%a5%e5%8f%a3" aria-label="ChannelHandlerContext 接口">ChannelHandlerContext 接口</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-channelhandlercontext" aria-label="使用 ChannelHandlerContext">使用 ChannelHandlerContext</a></li>
                <li>
                    <a href="#channelhandler-%e5%92%8c-channelhandlercontext-%e7%9a%84%e9%ab%98%e7%ba%a7%e7%94%a8%e6%b3%95" aria-label="ChannelHandler 和 ChannelHandlerContext 的高级用法">ChannelHandler 和 ChannelHandlerContext 的高级用法</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86" aria-label="异常处理">异常处理</a><ul>
                        
                <li>
                    <a href="#%e5%85%a5%e7%ab%99%e5%bc%82%e5%b8%b8" aria-label="入站异常">入站异常</a></li>
                <li>
                    <a href="#%e5%87%ba%e7%ab%99%e5%bc%82%e5%b8%b8" aria-label="出站异常">出站异常</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#eventloop%e5%92%8c%e7%ba%bf%e7%a8%8b%e6%a8%a1%e5%9e%8b" aria-label="EventLoop和线程模型">EventLoop和线程模型</a><ul>
                        
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e6%a8%a1%e5%9e%8b%e6%a6%82%e8%bf%b0" aria-label="线程模型概述">线程模型概述</a></li>
                <li>
                    <a href="#eventloop%e6%8e%a5%e5%8f%a3-1" aria-label="EventLoop接口">EventLoop接口</a><ul>
                        
                <li>
                    <a href="#netty-4-%e4%b8%ad%e7%9a%84-io-%e5%92%8c%e4%ba%8b%e4%bb%b6%e5%a4%84%e7%90%86" aria-label="Netty 4 中的 I/O 和事件处理">Netty 4 中的 I/O 和事件处理</a></li>
                <li>
                    <a href="#netty-3-%e4%b8%ad%e7%9a%84-io-%e6%93%8d%e4%bd%9c" aria-label="Netty 3 中的 I/O 操作">Netty 3 中的 I/O 操作</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bb%bb%e5%8a%a1%e8%b0%83%e5%ba%a6" aria-label="任务调度">任务调度</a><ul>
                        
                <li>
                    <a href="#jdk-%e7%9a%84%e4%bb%bb%e5%8a%a1%e8%b0%83%e5%ba%a6-api" aria-label="JDK 的任务调度 API">JDK 的任务调度 API</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-eventloop-%e8%b0%83%e5%ba%a6%e4%bb%bb%e5%8a%a1" aria-label="使用 EventLoop 调度任务">使用 EventLoop 调度任务</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e7%bb%86%e8%8a%82" aria-label="实现细节">实现细节</a><ul>
                        
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e7%ae%a1%e7%90%86" aria-label="线程管理">线程管理</a></li>
                <li>
                    <a href="#eventloop%e7%ba%bf%e7%a8%8b%e7%9a%84%e5%88%86%e9%85%8d" aria-label="EventLoop/线程的分配">EventLoop/线程的分配</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93" aria-label="小结">小结</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc" aria-label="引导">引导</a><ul>
                        
                <li>
                    <a href="#bootstrap%e7%b1%bb" aria-label="Bootstrap类">Bootstrap类</a></li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc%e5%ae%a2%e6%88%b7%e7%ab%af%e5%92%8c%e6%97%a0%e8%bf%9e%e6%8e%a5%e5%8d%8f%e8%ae%ae" aria-label="引导客户端和无连接协议">引导客户端和无连接协议</a><ul>
                        
                <li>
                    <a href="#%e5%bc%95%e5%af%bc%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="引导客户端">引导客户端</a></li>
                <li>
                    <a href="#channel-%e5%92%8c-eventloopgroup-%e7%9a%84%e5%85%bc%e5%ae%b9%e6%80%a7" aria-label="Channel 和 EventLoopGroup 的兼容性">Channel 和 EventLoopGroup 的兼容性</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc%e6%9c%8d%e5%8a%a1%e5%99%a8" aria-label="引导服务器">引导服务器</a><ul>
                        
                <li>
                    <a href="#serverbootstrap-%e7%b1%bb" aria-label="ServerBootstrap 类">ServerBootstrap 类</a></li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc%e6%9c%8d%e5%8a%a1%e5%99%a8-1" aria-label="引导服务器">引导服务器</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bb%8e-channel-%e5%bc%95%e5%af%bc%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="从 Channel 引导客户端">从 Channel 引导客户端</a></li>
                <li>
                    <a href="#%e5%9c%a8%e5%bc%95%e5%af%bc%e8%bf%87%e7%a8%8b%e4%b8%ad%e6%b7%bb%e5%8a%a0%e5%a4%9a%e4%b8%aa-channelhandler" aria-label="在引导过程中添加多个 ChannelHandler">在引导过程中添加多个 ChannelHandler</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-netty-%e7%9a%84-channeloption-%e5%92%8c%e5%b1%9e%e6%80%a7" aria-label="使用 Netty 的 ChannelOption 和属性">使用 Netty 的 ChannelOption 和属性</a></li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc-datagramchannel" aria-label="引导 DatagramChannel">引导 DatagramChannel</a></li>
                <li>
                    <a href="#%e5%85%b3%e9%97%ad%e7%a8%8b%e5%ba%8f" aria-label="关闭程序">关闭程序</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93-1" aria-label="小结">小结</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95" aria-label="单元测试">单元测试</a><ul>
                        
                <li>
                    <a href="#embeddedchannel-%e6%a6%82%e8%bf%b0" aria-label="EmbeddedChannel 概述">EmbeddedChannel 概述</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-embeddedchannel-%e6%b5%8b%e8%af%95-channelhandler" aria-label="使用 EmbeddedChannel 测试 ChannelHandler">使用 EmbeddedChannel 测试 ChannelHandler</a><ul>
                        
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e5%85%a5%e7%ab%99%e6%b6%88%e6%81%af" aria-label="测试入站消息">测试入站消息</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e5%87%ba%e7%ab%99%e6%b6%88%e6%81%af" aria-label="测试出站消息">测试出站消息</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86" aria-label="测试异常处理">测试异常处理</a></li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93-2" aria-label="小结">小结</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bc%96%e8%a7%a3%e7%a0%81%e5%99%a8%e6%a1%86%e6%9e%b6" aria-label="编解码器框架">编解码器框架</a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e7%bc%96%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="什么是编解码器">什么是编解码器</a></li>
                <li>
                    <a href="#%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="解码器">解码器</a><ul>
                        
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-bytetomessagedecoder" aria-label="抽象类 ByteToMessageDecoder">抽象类 ByteToMessageDecoder</a></li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-replayingdecoder" aria-label="抽象类 ReplayingDecoder">抽象类 ReplayingDecoder</a></li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-messagetomessagedecoder" aria-label="抽象类 MessageToMessageDecoder">抽象类 MessageToMessageDecoder</a></li>
                <li>
                    <a href="#toolongframeexception-%e7%b1%bb" aria-label="TooLongFrameException 类">TooLongFrameException 类</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bc%96%e7%a0%81%e5%99%a8" aria-label="编码器">编码器</a><ul>
                        
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-messagetobyteencoder" aria-label="抽象类 MessageToByteEncoder">抽象类 MessageToByteEncoder</a></li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-messagetomessageencoder" aria-label="抽象类 MessageToMessageEncoder">抽象类 MessageToMessageEncoder</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%9a%84%e7%bc%96%e8%a7%a3%e7%a0%81%e5%99%a8%e7%b1%bb" aria-label="抽象的编解码器类">抽象的编解码器类</a><ul>
                        
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-bytetomessagecodec" aria-label="抽象类 ByteToMessageCodec">抽象类 ByteToMessageCodec</a></li>
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e7%b1%bb-messagetomessagecodec" aria-label="抽象类 MessageToMessageCodec">抽象类 MessageToMessageCodec</a></li>
                <li>
                    <a href="#combinedchannelduplexhandler-%e7%b1%bb" aria-label="CombinedChannelDuplexHandler 类">CombinedChannelDuplexHandler 类</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93-3" aria-label="小结">小结</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%a2%84%e7%bd%ae%e7%9a%84channelhandler%e5%92%8c%e7%bc%96%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="预置的ChannelHandler和编解码器">预置的ChannelHandler和编解码器</a><ul>
                        
                <li>
                    <a href="#%e9%80%9a%e8%bf%87-ssltls-%e4%bf%9d%e6%8a%a4-netty-%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="通过 SSL/TLS 保护 Netty 应用程序">通过 SSL/TLS 保护 Netty 应用程序</a></li>
                <li>
                    <a href="#%e6%9e%84%e5%bb%ba%e5%9f%ba%e4%ba%8e-netty-%e7%9a%84-httphttps-%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="构建基于 Netty 的 HTTP/HTTPS 应用程序">构建基于 Netty 的 HTTP/HTTPS 应用程序</a><ul>
                        
                <li>
                    <a href="#http-%e8%a7%a3%e7%a0%81%e5%99%a8%e7%bc%96%e7%a0%81%e5%99%a8%e5%92%8c%e7%bc%96%e8%a7%a3%e7%a0%81%e5%99%a8" aria-label="HTTP 解码器、编码器和编解码器">HTTP 解码器、编码器和编解码器</a></li>
                <li>
                    <a href="#%e8%81%9a%e5%90%88-http-%e6%b6%88%e6%81%af" aria-label="聚合 HTTP 消息">聚合 HTTP 消息</a></li>
                <li>
                    <a href="#http-%e5%8e%8b%e7%bc%a9" aria-label="HTTP 压缩">HTTP 压缩</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-https" aria-label="使用 HTTPS">使用 HTTPS</a></li>
                <li>
                    <a href="#websocket" aria-label="WebSocket">WebSocket</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%a9%ba%e9%97%b2%e7%9a%84%e8%bf%9e%e6%8e%a5%e5%92%8c%e8%b6%85%e6%97%b6" aria-label="空闲的连接和超时">空闲的连接和超时</a></li>
                <li>
                    <a href="#%e8%a7%a3%e7%a0%81%e5%9f%ba%e4%ba%8e%e5%88%86%e9%9a%94%e7%ac%a6%e7%9a%84%e5%8d%8f%e8%ae%ae%e5%92%8c%e5%9f%ba%e4%ba%8e%e9%95%bf%e5%ba%a6%e7%9a%84%e5%8d%8f%e8%ae%ae" aria-label="解码基于分隔符的协议和基于长度的协议">解码基于分隔符的协议和基于长度的协议</a><ul>
                        
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e5%88%86%e9%9a%94%e7%ac%a6%e7%9a%84%e5%8d%8f%e8%ae%ae" aria-label="基于分隔符的协议">基于分隔符的协议</a></li>
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e9%95%bf%e5%ba%a6%e7%9a%84%e5%8d%8f%e8%ae%ae" aria-label="基于长度的协议">基于长度的协议</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%86%99%e5%a4%a7%e5%9e%8b%e6%95%b0%e6%8d%ae" aria-label="写大型数据">写大型数据</a></li>
                <li>
                    <a href="#%e5%ba%8f%e5%88%97%e5%8c%96%e6%95%b0%e6%8d%ae" aria-label="序列化数据">序列化数据</a><ul>
                        
                <li>
                    <a href="#jdk-%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="JDK 序列化">JDK 序列化</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-jboss-marshalling-%e8%bf%9b%e8%a1%8c%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="使用 JBoss Marshalling 进行序列化">使用 JBoss Marshalling 进行序列化</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87-protocol-buffers-%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="通过 Protocol Buffers 序列化">通过 Protocol Buffers 序列化</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93-4" aria-label="小结">小结</a></li></ul>
                </li>
                <li>
                    <a href="#websocket-1" aria-label="WebSocket">WebSocket</a><ul>
                        
                <li>
                    <a href="#websocket-%e7%ae%80%e4%bb%8b" aria-label="WebSocket 简介">WebSocket 简介</a></li>
                <li>
                    <a href="#%e6%88%91%e4%bb%ac%e7%9a%84-websocket-%e7%a4%ba%e4%be%8b%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="我们的 WebSocket 示例应用程序">我们的 WebSocket 示例应用程序</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0-websocket-%e6%94%af%e6%8c%81" aria-label="添加 WebSocket 支持">添加 WebSocket 支持</a><ul>
                        
                <li>
                    <a href="#%e5%a4%84%e7%90%86-http-%e8%af%b7%e6%b1%82" aria-label="处理 HTTP 请求">处理 HTTP 请求</a></li>
                <li>
                    <a href="#%e5%a4%84%e7%90%86-websocket-%e5%b8%a7" aria-label="处理 WebSocket 帧">处理 WebSocket 帧</a></li>
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96-channelpipeline" aria-label="初始化 ChannelPipeline">初始化 ChannelPipeline</a></li>
                <li>
                    <a href="#%e5%bc%95%e5%af%bc-1" aria-label="引导">引导</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e8%af%a5%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="测试该应用程序">测试该应用程序</a><ul>
                        
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e8%bf%9b%e8%a1%8c%e5%8a%a0%e5%af%86" aria-label="如何进行加密">如何进行加密</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8dup%e5%b9%bf%e6%92%ad%e4%ba%8b%e4%bb%b6" aria-label="使用DUP广播事件">使用DUP广播事件</a><ul>
                        
                <li>
                    <a href="#dup%e5%9f%ba%e7%a1%80" aria-label="DUP基础">DUP基础</a></li>
                <li>
                    <a href="#dup%e5%b9%bf%e6%92%ad" aria-label="DUP广播">DUP广播</a></li>
                <li>
                    <a href="#udp-%e7%a4%ba%e4%be%8b%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" aria-label="UDP 示例应用程序">UDP 示例应用程序</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af-pojo-logeventc" aria-label="消息 POJO: LogEventc">消息 POJO: LogEventc</a></li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99%e5%b9%bf%e6%92%ad%e8%80%85" aria-label="编写广播者">编写广播者</a></li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99%e7%9b%91%e8%a7%86%e5%99%a8" aria-label="编写监视器">编写监视器</a></li>
                <li>
                    <a href="#%e8%bf%90%e8%a1%8c-logeventbroadcaster-%e5%92%8c-logeventmonitor" aria-label="运行 LogEventBroadcaster 和 LogEventMonitor">运行 LogEventBroadcaster 和 LogEventMonitor</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%a1%88%e4%be%8b%e7%a0%94%e7%a9%b6-1" aria-label="案例研究">案例研究</a></li>
                <li>
                    <a href="#%e5%8d%95%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%e5%8a%9f%e8%83%bd" aria-label="单用户登录功能">单用户登录功能</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="第一个netty应用程序">第一个Netty应用程序<a hidden class="anchor" aria-hidden="true" href="#第一个netty应用程序">#</a></h1>
<p>Netty 客户端/服务器概览
<img loading="lazy" src="27.png" alt=""  />

Echo 客户端和服务器之间的交互是非常简单的；在客户端建立一个连接之后，它会向服务器发送一个或多个消息，反过来，服务器又会将每个消息回送给客户端。虽然它本身看起来好像用处不大，但它充分地体现了客户端/服务器系统中典型的请求-响应交互模式。</p>
<!-- more -->
<h2 id="编写-echo-服务器">编写 Echo 服务器<a hidden class="anchor" aria-hidden="true" href="#编写-echo-服务器">#</a></h2>
<p>所有的 Netty 服务器都需要以下两部分。</p>
<ul>
<li>至少一个 ChannelHandler：处理客户端传过来的数据，实现自己的业务逻辑。</li>
<li>启动引导：绑定端口和启动服务。</li>
</ul>
<h3 id="通过channelhandler实现服务端">通过channelHandler实现服务端<a hidden class="anchor" aria-hidden="true" href="#通过channelhandler实现服务端">#</a></h3>
<p>因为你的 Echo 服务器会响应传入的消息，所以它需要实现 ChannelInboundHandler 接口，用来定义响应入站事件的方法。这个简单的应用程序只需要用到少量的这些方法，所以继承 ChannelInboundHandlerAdapter 类也就足够了，它提供了 ChannelInboundHandler 的默认实现。</p>
<p>channelRead()：每个传入的消息都要调用该方法。
channelReadComplete()：通知ChannelInboundHandler最后一次对channelRead()的调用是当前批量读取中的最后一条消息。
exceptionCaught()：在读取操作期间，有异常抛出时会调用。</p>
<p>代码如下</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> nia.chapter2.echoserver;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.buffer.ByteBuf;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.buffer.Unpooled;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelFutureListener;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelHandler.Sharable;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelHandlerContext;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelInboundHandlerAdapter;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.util.CharsetUtil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 2-1 EchoServerHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//标示一个ChannelHandler可以被多个 Channel 安全地共享
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@Sharable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EchoServerHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead(ChannelHandlerContext ctx, Object msg) {
</span></span><span style="display:flex;"><span>        ByteBuf in = (ByteBuf) msg;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将消息记录到控制台
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;Server received: &#34;</span> + in.<span style="color:#007f7f">toString</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将接收到的消息写给发送者，而不冲刷出站消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ctx.<span style="color:#007f7f">write</span>(in);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelReadComplete(ChannelHandlerContext ctx) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将未决消息冲刷到远程节点，并且关闭该 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ctx.<span style="color:#007f7f">writeAndFlush</span>(Unpooled.<span style="color:#007f7f">EMPTY_BUFFER</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">addListener</span>(ChannelFutureListener.<span style="color:#007f7f">CLOSE</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> exceptionCaught(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        Throwable cause) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//打印异常栈跟踪
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        cause.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//关闭该Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ctx.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ChannelInboundHandlerAdapter 有一个直观的 API，并且它的每个方法都可以被重写以挂钩到事件生命周期的恰当点上。因为需要处理所有接收到的数据，所以你重写了 channelRead()方法。在这个服务器应用程序中，你将数据简单地回送给了远程节点。重写 exceptionCaught()方法允许你对 Throwable 的任何子类型做出反应，在这里你记录了异常并关闭了连接。虽然一个更加完善的应用程序也许会尝试从异常中恢复，但在这个场景下，只是通过简单地关闭连接来通知远程节点发生了错误。</p>
<p>如果不捕获异常，会发生什么呢？每个 Channel 都拥有一个与之相关联的 ChannelPipeline，其持有一个 ChannelHandler 的实例链。在默认的情况下，ChannelHandler 会把对它的方法的调用转发给链中的下一个 ChannelHandler。因此，如果 exceptionCaught()方法没有被该链中的某处实现，那么所接收的异常将会被传递到 ChannelPipeline 的尾端并被记录。为此，你的应用程序应该提供至少有一个实现了exceptionCaught()方法的 ChannelHandler。</p>
<p>除了 ChannelInboundHandlerAdapter 之外，还有很多需要学习的 ChannelHandler 的
子类型和实现，我们将在第 6 章和第 7 章中对它们进行详细的阐述。目前，请记住下面这些关键点：</p>
<ul>
<li>针对不同类型的事件来调用 ChannelHandler；</li>
<li>应用程序通过实现或者扩展 ChannelHandler 来挂钩到事件的生命周期，并且提供自定义的应用程序逻辑；</li>
<li>在架构上，ChannelHandler 有助于保持业务逻辑与网络处理代码的分离。这简化了开发过程，因为代码必须不断地演化以响应不断变化的需求。</li>
</ul>
<h3 id="编写引导服务器">编写引导服务器<a hidden class="anchor" aria-hidden="true" href="#编写引导服务器">#</a></h3>
<ul>
<li>将端口绑定到服务器上</li>
<li>配置 Channel，以将有关的入站消息通知给 EchoServerHandler 实例。</li>
</ul>
<p>代码如下</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> nia.chapter2.echoserver;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.bootstrap.ServerBootstrap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelFuture;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelInitializer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.EventLoopGroup;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.nio.NioEventLoopGroup;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.socket.SocketChannel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.net.InetSocketAddress;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 2-2 EchoServer 类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EchoServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> port;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> EchoServer(<span style="color:#fff;font-weight:bold">int</span> port) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">port</span> = port;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//调用服务器的 start()方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">new</span> EchoServer(<span style="color:#ff0;font-weight:bold">8888</span>).<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> start() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> EchoServerHandler serverHandler = <span style="color:#fff;font-weight:bold">new</span> EchoServerHandler();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//(1) 创建EventLoopGroup
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(2) 创建ServerBootstrap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ServerBootstrap b = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>            b.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//(3) 指定所使用的 NIO 传输 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//(4) 使用指定的端口设置套接字地址
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">localAddress</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port))
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//(5) 添加一个EchoServerHandler到于Channel的 ChannelPipeline
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">childHandler</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelInitializer&lt;SocketChannel&gt;() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(SocketChannel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//EchoServerHandler 被标注为@Shareable，所以我们可以总是使用同样的实例
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        <span style="color:#007f7f">//这里对于所有的客户端连接来说，都会使用同一个 EchoServerHandler，因为其被标注为@Sharable，
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        <span style="color:#007f7f">//这将在后面的章节中讲到。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addLast</span>(serverHandler);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(6) 异步地绑定服务器；调用 sync()方法阻塞等待直到绑定完成
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ChannelFuture f = b.<span style="color:#007f7f">bind</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(EchoServer.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getName</span>() +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34; started and listening for connections on &#34;</span> + f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">localAddress</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(7) 获取 Channel 的CloseFuture，并且阻塞当前线程直到它完成
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(8) 关闭 EventLoopGroup，释放所有的资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            group.<span style="color:#007f7f">shutdownGracefully</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在(2)处，你创建了一个 ServerBootstrap 实例。因为你正在使用的是 NIO 传输，所以你指定了
(1)NioEventLoopGroup 来接受和处理新的连接，并且将 Channel 的类型指定为 NioServerSocketChannel(3)。
在此之后，你将本地地址设置为一个具有选定端口的 InetSocketAddress(4) 。
服务器将绑定到这个地址以监听新的连接请求。</p>
<p>在(5)处，你使用了一个特殊的类:ChannelInitializer。这是关键。当一个新的连接被接受时，一个新的子Channel 将会被创建，而 ChannelInitializer 将会把一个你的EchoServerHandler 的实例添加到该 Channel的 ChannelPipeline 中。正如我们之前所解释的，这个 ChannelHandler 将会收到有关入站消息的通知。</p>
<p>虽然 NIO 是可伸缩的，但是其适当的尤其是关于多线程处理的配置并不简单。Netty 的设计封装了大部分的复杂性，而且我们将在第 3 章中对相关的抽象（EventLoopGroup、SocketChannel 和 ChannelInitializer）进行详细的讨论。</p>
<p>接下来你绑定了服务器(6)，并等待绑定完成。（对 sync()方法的调用将导致当前 Thread阻塞，一直到绑定操作完成为止）。在(7)处，该应用程序将会阻塞等待直到服务器的 Channel关闭（因为你在 Channel 的CloseFuture 上调用了 sync()方法）。然后，你将可以关闭EventLoopGroup，并释放所有的资源，包括所有被创建的线程(8)。</p>
<p>与此同时，让我们回顾一下你刚完成的服务器实现中的重要步骤。下面这些是服务器的主要代码组件：</p>
<ul>
<li>EchoServerHandler 实现了业务逻辑；</li>
<li>main()方法引导了服务器；
引导过程中所需要的步骤如下：
<ul>
<li>创建一个 ServerBootstrap 的实例以引导和绑定服务器；</li>
<li>创建并分配一个 NioEventLoopGroup 实例以进行事件的处理，如接受新连接以及读/写数据；</li>
<li>指定服务器绑定的本地的 InetSocketAddress；</li>
<li>使用一个 EchoServerHandler 的实例初始化每一个新的 Channel；</li>
<li>调用 ServerBootstrap.bind()方法以绑定服务器。</li>
</ul>
</li>
</ul>
<p>在这个时候，服务器已经初始化，并且已经就绪能被使用了。下一节我们将探讨对应的客户端应用程序的代码。</p>
<h2 id="编写echo客户端">编写echo客户端<a hidden class="anchor" aria-hidden="true" href="#编写echo客户端">#</a></h2>
<p>Echo 客户端将会：
（1）连接到服务器；
（2）发送一个或者多个消息；
（3）对于每个消息，等待并接收从服务器发回的相同的消息；
（4）关闭连接。
编写客户端所涉及的两个主要代码部分也是业务逻辑和引导，和你在服务器中看到的一样。</p>
<h3 id="通过-channelhandler-实现客户端逻辑">通过 ChannelHandler 实现客户端逻辑<a hidden class="anchor" aria-hidden="true" href="#通过-channelhandler-实现客户端逻辑">#</a></h3>
<p>如同服务器，客户端将拥有一个用来处理数据的 ChannelInboundHandler。在这个场景下，你将扩展SimpleChannelInboundHandler 类以处理所有必须的任务。我们需要重写如下方法：</p>
<p>channelActive()：在到服务器的连接已经建立之后将被调用；
channelRead0()：当从服务器接收到一条消息时被调用；
exceptionCaught()：在处理过程中引发异常时被调用。</p>
<p>客户端的channelHandler</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> nia.chapter2.echoclient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.buffer.ByteBuf;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.buffer.Unpooled;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelHandler.Sharable;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelHandlerContext;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.SimpleChannelInboundHandler;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.util.CharsetUtil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 2-3 客户端的 ChannelHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@Sharable
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//标记该类的实例可以被多个 Channel 共享
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EchoClientHandler <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;ByteBuf&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(ChannelHandlerContext ctx) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//当被通知 Channel是活跃的时候，发送一条消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ctx.<span style="color:#007f7f">writeAndFlush</span>(Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Netty rocks!&#34;</span>, CharsetUtil.<span style="color:#007f7f">UTF_8</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, ByteBuf in) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//记录已接收消息的转储
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Client received: &#34;</span> + in.<span style="color:#007f7f">toString</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//在发生异常时，记录错误并关闭Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> exceptionCaught(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        Throwable cause) {
</span></span><span style="display:flex;"><span>        cause.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>重写了 channelActive()方法，其将在一个连接建立时被调用，确保数据将会被尽可能快地写入服务器。内容是一个编码了字符串&quot;Netty rocks!&ldquo;的字节缓冲区。</p>
<p>重写了 channelRead0()方法，每当接收数据时，都会调用这个方法。需要注意的是，由服务器发送的消息可能会被分块接收。也就是说，如果服务器发送了 5 字节，那么不能保证这 5 字节会被一次性接收。即使是对于这么少量的数据，channelRead0()方法也可能会被调用两次，第一次使用一个持有 3 字节的 ByteBuf（Netty 的字节容器），第二次使用一个持有 2 字节的 ByteBuf。作为一个面向流的协议，TCP 保证了字节数组将会按照服务器发送它们的顺序被接收。</p>
<p>重写了 exceptionCaught()。用于记录 Throwable，关闭 Channel。</p>
<p>SimpleChannelInboundHandler 与 ChannelInboundHandler
你可能会想：为什么我们在客户端使用的是 SimpleChannelInboundHandler，
而不是在 EchoServerHandler 中所使用的 ChannelInboundHandlerAdapter 呢？
这和两个因素的相互作用有关：业务逻辑如何处理消息以及 Netty 如何管理资源。</p>
<p>在客户端，当 channelRead0()方法完成时，你已经有了传入消息，并且已经处理完它了。当该方法返回时，SimpleChannelInboundHandler 负责释放指向保存该消息的 ByteBuf 的内存引用。
在 EchoServerHandler 中，你仍然需要将传入消息回送给发送者，而 write()操作是异步的，直
到 channelRead()方法返回后可能仍然没有完成（如代码清单 2-1 所示）。为此，EchoServerHandler扩展了 ChannelInboundHandlerAdapter，其在这个时间点上不会释放消息。
消息在 EchoServerHandler 的 channelReadComplete()方法中，当 writeAndFlush()方
法被调用时被释放（见代码清单 2-1）。第 5 章和第 6 章将对消息的资源管理进行详细的介绍。</p>
<h3 id="编写引导客户端">编写引导客户端<a hidden class="anchor" aria-hidden="true" href="#编写引导客户端">#</a></h3>
<p>引导客户端类似于引导服务器，不同的是，客户端是使用主机和端口参数来连接远程地址，也就是这里的Echo 服务器的地址，而不是绑定到一个一直被监听的端口。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> nia.chapter2.echoclient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.bootstrap.Bootstrap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelFuture;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.ChannelInitializer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.EventLoopGroup;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.nio.NioEventLoopGroup;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.socket.SocketChannel;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> io.netty.channel.socket.nio.NioSocketChannel;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.net.InetSocketAddress;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 2-4 客户端的主类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EchoClient {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String host;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> port;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> EchoClient(String host, <span style="color:#fff;font-weight:bold">int</span> port) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">host</span> = host;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">port</span> = port;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> start()
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//创建 Bootstrap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Bootstrap b = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//指定 EventLoopGroup 以处理客户端事件；需要适用于 NIO 的实现
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            b.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//适用于 NIO 传输的Channel 类型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">channel</span>(NioSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//设置服务器的InetSocketAddress
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">remoteAddress</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(host, port))
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//在创建Channel时，向 ChannelPipeline中添加一个 EchoClientHandler实例
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">handler</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelInitializer&lt;SocketChannel&gt;() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(SocketChannel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>                             <span style="color:#fff;font-weight:bold">new</span> EchoClientHandler());
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//连接到远程节点，阻塞等待直到连接完成
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ChannelFuture f = b.<span style="color:#007f7f">connect</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//阻塞，直到Channel 关闭
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//关闭线程池并且释放所有的资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            group.<span style="color:#007f7f">shutdownGracefully</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">new</span> EchoClient(<span style="color:#0ff;font-weight:bold">&#34;localhost&#34;</span>, <span style="color:#ff0;font-weight:bold">8888</span>).<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>和之前一样，使用了 NIO 传输。注意，你可以在客户端和服务器上分别使用不同的传输。
例如，在服务器端使用 NIO 传输，而在客户端使用 OIO 传输。</p>
<p>让我们回顾一下这一节中所介绍的要点：</p>
<ul>
<li>为初始化客户端，创建了一个 Bootstrap 实例</li>
<li>为进行事件处理分配了一个 NioEventLoopGroup 实例，其中事件处理包括创建新的连接以及处理入站和出站数据</li>
<li>为服务器连接创建了一个 InetSocketAddress 实例</li>
<li>当连接被建立时，一个 EchoClientHandler 实例会被安装到（该 Channel 的）ChannelPipeline 中</li>
<li>在一切都设置完成后，调用 Bootstrap.connect()方法连接到远程节点</li>
</ul>
<p>服务端和客户端都完成了，可以测试了。</p>
<ol>
<li>
<p>通过main方法运行<code>EchoServer</code>
控制台打印
<code>nia.chapter2.echoserver.EchoServer started and listening for connections on /0:0:0:0:0:0:0:0:8888</code></p>
</li>
<li>
<p>通过main方法运行<code>EchoClient</code>
<code>Client received: Netty rocks!</code></p>
</li>
</ol>
<p>服务端再次打印
<code>Server received: Netty rocks!</code></p>
<p>下面是发生的事：
（1）一旦客户端建立连接，它就发送它的消息——Netty rocks!；
（2）服务器报告接收到的消息，并将其回送给客户端；
（3）客户端报告返回的消息并退出。</p>
<p>需要注意，服务端必须先启动，客户端先启动会抛出异常<code>ConnectException</code>。
这个异常不会被<code>exceptionCaught</code>捕捉到。原书这里有些问题。</p>
<h1 id="netty的组件和设计">Netty的组件和设计<a hidden class="anchor" aria-hidden="true" href="#netty的组件和设计">#</a></h1>
<h2 id="channel接口">Channel接口<a hidden class="anchor" aria-hidden="true" href="#channel接口">#</a></h2>
<p>基本的 I/O 操作（bind()、connect()、read()和 write()）依赖于底层网络传输所提供的原语。
在基于 Java 的网络编程中，其基本的构造是 class Socket。Netty 的 Channel 接口所提供的 API，
大大地降低了直接使用 Socket 类的复杂性。此外，Channel 也是拥有许多预定义的、专门化实现的广泛类层次结构的根，下面是一个简短的部分清单：
EmbeddedChannel
LocalServerChannel
NioDatagramChannel
NioSctpChannel
NioSocketChannel</p>
<h2 id="eventloop接口">EventLoop接口<a hidden class="anchor" aria-hidden="true" href="#eventloop接口">#</a></h2>
<p>EventLoop 定义了 Netty 的核心抽象，用于处理连接的生命周期中所发生的事件。我们将在第 7 章中结合 Netty 的线程处理模型的上下文对 EventLoop 进行详细的讨论。目前，下图在高层次上说明了 Channel、EventLoop、Thread 以及 EventLoopGroup 之间的关系。
<img loading="lazy" src="28.png" alt=""  />
</p>
<ul>
<li>一个 EventLoopGroup 包含一个或者多个 EventLoop；</li>
<li>一个 EventLoop 在它的生命周期内只和一个 Thread 绑定；</li>
<li>所有由 EventLoop 处理的 I/O 事件都将在它专有的 Thread 上被处理；</li>
<li>一个 Channel 在它的生命周期内只注册于一个 EventLoop；</li>
<li>一个 EventLoop 可能会被分配给一个或多个 Channel。</li>
</ul>
<p>注意，在这种设计中，一个给定 Channel 的 I/O 操作都是由相同的 Thread 执行的，实际上消除了对于同步的需要。</p>
<h2 id="channelfuture接口">ChannelFuture接口<a hidden class="anchor" aria-hidden="true" href="#channelfuture接口">#</a></h2>
<p>正如我们已经解释过的那样，Netty 中所有的 I/O 操作都是异步的。因为一个操作可能不会立即返回，所以我们需要一种用于在之后的某个时间点确定其结果的方法。为此，Netty 提供了ChannelFuture 接口，其 addListener()方法注册了一个 ChannelFutureListener，以便在某个操作完成时（无论是否成功）得到通知。</p>
<h2 id="channelhandler接口">ChannelHandler接口<a hidden class="anchor" aria-hidden="true" href="#channelhandler接口">#</a></h2>
<p>从应用程序开发人员的角度来看，Netty 的主要组件是 ChannelHandler，它充当了所有处理入站和出站数据的应用程序逻辑的容器。这是可行的，因为 ChannelHandler 的方法是由网络事件（其中术语“事件”的使用非常广泛）触发的。事实上，ChannelHandler 可专门用于几乎任何类型的动作，例如将数据从一种格式转换为另外一种格式，或者处理转换过程中所抛出的异常。
举例来说，ChannelInboundHandler 是一个你将会经常实现的子接口。这种类型的ChannelHandler 接收入站事件和数据，这些数据随后将会被你的应用程序的业务逻辑所处理。当你要给连接的客户端发送响应时，也可以从 ChannelInboundHandler 冲刷数据。你的应用程序的业务逻辑通常驻留在一个或者多个 ChannelInboundHandler 中。</p>
<h2 id="channelpipeline接口">ChannelPipeline接口<a hidden class="anchor" aria-hidden="true" href="#channelpipeline接口">#</a></h2>
<p>ChannelPipeline 提供了 ChannelHandler 链的容器，并定义了用于在该链上传播入站和出站事件流的 API。
当 Channel 被创建时，它会被自动地分配到它专属的 ChannelPipeline。
ChannelHandler 安装到 ChannelPipeline 中的过程如下所示：</p>
<ul>
<li>一个ChannelInitializer的实现被注册到了ServerBootstrap中</li>
<li>当 ChannelInitializer.initChannel()方法被调用时，ChannelInitializer
将在 ChannelPipeline 中安装一组自定义的 ChannelHandler</li>
<li>ChannelInitializer 将它自己从 ChannelPipeline 中移除。</li>
</ul>
<p>ChannelHandler 是专为支持广泛的用途而设计的，可以将它看作是处理往来 ChannelPipeline 事件
（包括数据）的任何代码的通用容器。图 3-2 说明了这一点，其展示了从 ChannelHandler 派生的
ChannelInboundHandler 和 ChannelOutboundHandler 接口。
<img loading="lazy" src="29.png" alt=""  />
</p>
<p>使得事件流经 ChannelPipeline 是 ChannelHandler 的工作，它们是在应用程序的初始化或者引导阶段被安装的。这些对象接收事件、执行它们所实现的处理逻辑，并将数据传递给链中的下一个 ChannelHandler。
它们的执行顺序是由它们被添加的顺序所决定的。实际上，被我们称为 ChannelPipeline 的是这些 ChannelHandler 的编排顺序。</p>
<p>图 3-3 说明了一个 Netty 应用程序中入站和出站数据流之间的区别。从一个客户端应用程序的角度来看，如果事件的运动方向是从客户端到服务器端，那么我们称这些事件为出站的，反之则称为入站的。
<img loading="lazy" src="30.png" alt=""  />
</p>
<p>图 3-3 也显示了入站和出站 ChannelHandler 可以被安装到同一个 ChannelPipeline中。如果一个消息或者任何其他的入站事件被读取，那么它会从 ChannelPipeline 的头部开始流动，并被传递给第一个ChannelInboundHandler。这个 ChannelHandler 不一定会实际地修改数据，具体取决于它的具体功能，在这之后，数据将会被传递给链中的下一个ChannelInboundHandler。最终，数据将会到达 ChannelPipeline 的尾端，届时，所有处理就都结束了。</p>
<p>数据的出站运动（即正在被写的数据）在概念上也是一样的。在这种情况下，数据将从
ChannelOutboundHandler 链的尾端开始流动，直到它到达链的头部为止。在这之后，出站数据将会到达网络传输层，这里显示为 Socket。通常情况下，这将触发一个写操作。</p>
<p>关于入站和出站 ChannelHandler 的更多讨论
通过使用作为参数传递到每个方法的 ChannelHandlerContext，事件可以被传递给当前
ChannelHandler 链中的下一个 ChannelHandler。因为你有时会忽略那些不感兴趣的事件，所以 Netty提供了抽象基类 ChannelInboundHandlerAdapter 和 ChannelOutboundHandlerAdapter。通过调用 ChannelHandlerContext 上的对应方法，每个都提供了简单地将事件传递给下一个ChannelHandler的方法的实现。随后，你可以通过重写你所感兴趣的那些方法来扩展这些类。</p>
<p>鉴于出站操作和入站操作是不同的，你可能会想知道如果将两个类别的 ChannelHandler都混合添加到同一个 ChannelPipeline 中会发生什么。虽然 ChannelInboundHandle 和ChannelOutboundHandle 都扩展自ChannelHandler，但是 Netty 能区分 ChannelInboundHandler 实现和 ChannelOutboundHandler 实现，并确保数据只会在具有相同定向类型的两个 ChannelHandler 之间传递。</p>
<p>当ChannelHandler 被添加到ChannelPipeline 时，它将会被分配一个ChannelHandlerContext，其代表了ChannelHandler 和 ChannelPipeline 之间的绑定。虽然这个对象可以被用于获取底层的 Channel，但是它主要还是被用于写出站数据。
在 Netty 中，有两种发送消息的方式。你可以直接写到 Channel 中，也可以 写到和 ChannelHandler相关联的ChannelHandlerContext对象中。前一种方式将会导致消息从ChannelPipeline 的尾端开始流动，而后者将导致消息从 ChannelPipeline 中的下一个 ChannelHandler 开始流动。</p>
<h2 id="更加深入地了解-channelhandler">更加深入地了解 ChannelHandler<a hidden class="anchor" aria-hidden="true" href="#更加深入地了解-channelhandler">#</a></h2>
<p>正如我们之前所说的，有许多不同类型的 ChannelHandler，它们各自的功能主要取决于它们的超类。Netty 以适配器类的形式提供了大量默认的 ChannelHandler 实现，其旨在简化应用程序处理逻辑的开发过程。你已经看到了，ChannelPipeline中的每个ChannelHandler将负责把事件转发到链中的下一个ChannelHandler。这些适配器类（及它们的子类）将自动执行这个操作，所以你可以只重写那些你想要特殊处理的方法和事件。</p>
<p>为什么需要适配器类
有一些适配器类可以将编写自定义的 ChannelHandler 所需要的努力降到最低限度，因为它们提供了定义在对应接口中的所有方法的默认实现。
下面这些是编写自定义 ChannelHandler 时经常会用到的适配器类：
ChannelHandlerAdapter
ChannelInboundHandlerAdapter
ChannelOutboundHandlerAdapter
ChannelDuplexHandler</p>
<p>接下来我们将研究 3 个 ChannelHandler 的子类型：编码器、解码器和
<code>SimpleChannelInboundHandler&lt;T&gt;</code>—— ChannelInboundHandlerAdapter 的一个子类。</p>
<h2 id="编码器和解码器">编码器和解码器<a hidden class="anchor" aria-hidden="true" href="#编码器和解码器">#</a></h2>
<p>当你通过 Netty 发送或者接收一个消息的时候，就将会发生一次数据转换。入站消息会被解码；
也就是说，从字节转换为另一种格式，通常是一个 Java 对象。如果是出站消息，则会发生相反方向的转换：它将从它的当前格式被编码为字节。这两种方向的转换的原因很简单：网络数据总是一系列的字节。</p>
<p>对应于特定的需要，Netty 为编码器和解码器提供了不同类型的抽象类。例如，你的应用程序可能使用了一种中间格式，而不需要立即将消息转换成字节。你将仍然需要一个编码器，但是它将派生自一个不同的超类。
为了确定合适的编码器类型，你可以应用一个简单的命名约定。通常来说，这些基类的名称将类似于ByteToMessageDecoder 或 MessageToByteEncoder。对于特殊的类型，你可能会发现类似于 ProtobufEncoder 和 ProtobufDecoder这样的名称——预置的用来支持 Google 的 Protocol Buffers。</p>
<p>严格地说，其他的处理器也可以完成编码器和解码器的功能。但是，正如有用来简化ChannelHandler 的创建的适配器类一样，所有由 Netty 提供的编码器/解码器适配器类都实现了
ChannelOutboundHandler 或者 ChannelInboundHandler 接口。</p>
<p>你将会发现对于入站数据来说，channelRead 方法/事件已经被重写了。对于每个从入站Channel
读取的消息，这个方法都将会被调用。随后，它将调用由预置解码器所提供的 decode()
方法，并将已解码的字节转发给 ChannelPipeline 中的下一个 ChannelInboundHandler。出站消息的模式是相反方向的：编码器将消息转换为字节，并将它们转发给下一ChannelOutboundHandler。</p>
<h2 id="抽象类-simplechannelinboundhandler">抽象类 SimpleChannelInboundHandler<a hidden class="anchor" aria-hidden="true" href="#抽象类-simplechannelinboundhandler">#</a></h2>
<p>通常我们会使用一个 ChannelHandler 来接收解码消息，并结合业务逻辑来处理这个消息。
要创建一个这样的 ChannelHandler，你只需要扩展基类 <code>SimpleChannelInboundHandler&lt;T&gt;</code>，
其中 T 是你要处理的消息的 Java 类型 。在这个 ChannelHandler 中，你将需要重写基类的一个或者多个方法，并且获取一个到 ChannelHandlerContext 的引用，这个引用将作为输入参数传递给 ChannelHandler 的所有方法。
在这种类型的 ChannelHandler 中，最重要的方法是 channelRead0(ChannelHandlerContext,T)。
除了要求不要阻塞当前的 I/O 线程之外，其具体实现完全取决于你。我们稍后将对这一主题进行更多的说明。</p>
<h2 id="引导类">引导类<a hidden class="anchor" aria-hidden="true" href="#引导类">#</a></h2>
<p>Netty 的引导类为应用程序的网络层配置提供了容器，这涉及将一个进程绑定到某个指定的端口，或者将一个进程连接到另一个运行在某个指定主机的指定端口上的进程。通常来说，我们把前面的用例称作引导一个服务器，后面的用例称作引导一个客户端。虽然这个术语简单方便，但是它略微掩盖了一个重要的事实，即“服务器”和“客户端”实际上表示了不同的网络行为；换句话说，是监听传入的连接还是建立到一个或者多个进程的连接。</p>
<p>因此，有两种类型的引导：Bootstrap用于客户端，ServerBootstrap用于服务器。
无论你的应用程序使用哪种协议或者处理哪种类型的数据，唯一决定它使用哪种引导类的是它是作为一个客户端还是作为一个服务器。两种引导类的区别是：</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>网络编程中的作用</th>
<th>EventLoopGroup 的数目</th>
</tr>
</thead>
<tbody>
<tr>
<td>bootstrap</td>
<td>连接远程主机和端口</td>
<td>1</td>
</tr>
<tr>
<td>serverbootstrap</td>
<td>绑定到一个本地端口</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>引导一个客户端只需要一个 EventLoopGroup，但是一个ServerBootstrap 则需要两个（也可以是同一个实例）。为什么呢？（实际上，ServerBootstrap 类也可以只使用一个 EventLoopGroup，此时其将在两个场景下共用同一个 EventLoopGroup。）</p>
<p>因为服务器需要两组不同的 Channel。第一组将只包含一个 ServerChannel，代表服务器自身的已绑定到某个本地端口的正在监听的套接字。而第二组将包含所有已创建的用来处理传入客户端连接（对于每个服务器已经接受的连接都有一个）的 Channel。图 3-4 说明了这个模型，并且展示了为何需要两个不同的 EventLoopGroup。
<img loading="lazy" src="31.png" alt=""  />
</p>
<p>与 ServerChannel 相关联的 EventLoopGroup 将分配一个负责为传入连接请求创建Channel 的 EventLoop。一旦连接被接受，第二个 EventLoopGroup 就会给它的 Channel分配一个 EventLoop。</p>
<h1 id="传输">传输<a hidden class="anchor" aria-hidden="true" href="#传输">#</a></h1>
<h2 id="案例研究">案例研究<a hidden class="anchor" aria-hidden="true" href="#案例研究">#</a></h2>
<p>我们将从一个应用程序开始我们对传输的学习，这个应用程序只简单地接受连接，向客户端写“Hi!”，然后关闭连接。</p>
<h3 id="不通过-netty-使用-oio-和-nio">不通过 Netty 使用 OIO 和 NIO<a hidden class="anchor" aria-hidden="true" href="#不通过-netty-使用-oio-和-nio">#</a></h3>
<p>我们将介绍仅使用了 JDK API 的应用程序的阻塞（OIO）版本和异步（NIO）版本。代码清单 4-1 展示了其s阻塞版本的实现。如果你曾享受过使用 JDK 进行网络编程的乐趣，那么这段代码将唤起你美好的回忆。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 4-1 未使用 Netty 的阻塞网络编程
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PlainOioServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> server(<span style="color:#fff;font-weight:bold">int</span> port) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将服务器绑定到指定端口
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">final</span> ServerSocket socket = <span style="color:#fff;font-weight:bold">new</span> ServerSocket(port);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span>(;;) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//接受连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">final</span> Socket clientSocket = socket.<span style="color:#007f7f">accept</span>();
</span></span><span style="display:flex;"><span>                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Accepted connection from &#34;</span> + clientSocket);
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//创建一个新的线程来处理该连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">new</span> Thread(<span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>                        OutputStream out;
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//将消息写给已连接的客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            out = clientSocket.<span style="color:#007f7f">getOutputStream</span>();
</span></span><span style="display:flex;"><span>                            out.<span style="color:#007f7f">write</span>(<span style="color:#0ff;font-weight:bold">&#34;Hi!\r\n&#34;</span>.<span style="color:#007f7f">getBytes</span>(Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>)));
</span></span><span style="display:flex;"><span>                            out.<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//关闭连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            clientSocket.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>                            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                                clientSocket.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                            } <span style="color:#fff;font-weight:bold">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>                                <span style="color:#007f7f">// ignore on close
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//启动线程
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    }
</span></span><span style="display:flex;"><span>                }).<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码完全可以处理中等数量的并发客户端。但是随着应用程序变得流行起来，你会发现它并不能很好地伸缩到支撑成千上万的并发连入连接。你决定改用异步网络编程，但是很快就发现异步 API 是完全不同的，以至于现在你不得不重写你的应用程序。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 4-2 未使用 Netty 的异步网络编程
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> PlainNioServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> server(<span style="color:#fff;font-weight:bold">int</span> port) <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        ServerSocketChannel serverChannel = ServerSocketChannel.<span style="color:#007f7f">open</span>();
</span></span><span style="display:flex;"><span>        serverChannel.<span style="color:#007f7f">configureBlocking</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        ServerSocket ss = serverChannel.<span style="color:#007f7f">socket</span>();
</span></span><span style="display:flex;"><span>        InetSocketAddress address = <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将服务器绑定到选定的端口
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ss.<span style="color:#007f7f">bind</span>(address);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//打开Selector来处理 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Selector selector = Selector.<span style="color:#007f7f">open</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将ServerSocketChannel注册到Selector以接受连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        serverChannel.<span style="color:#007f7f">register</span>(selector, SelectionKey.<span style="color:#007f7f">OP_ACCEPT</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> ByteBuffer msg = ByteBuffer.<span style="color:#007f7f">wrap</span>(<span style="color:#0ff;font-weight:bold">&#34;Hi!\r\n&#34;</span>.<span style="color:#007f7f">getBytes</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (;;){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//等待需要处理的新事件；阻塞将一直持续到下一个传入事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                selector.<span style="color:#007f7f">select</span>();
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>                ex.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//handle exception
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//获取所有接收事件的SelectionKey实例
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Set&lt;SelectionKey&gt; readyKeys = selector.<span style="color:#007f7f">selectedKeys</span>();
</span></span><span style="display:flex;"><span>            Iterator&lt;SelectionKey&gt; iterator = readyKeys.<span style="color:#007f7f">iterator</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">while</span> (iterator.<span style="color:#007f7f">hasNext</span>()) {
</span></span><span style="display:flex;"><span>                SelectionKey key = iterator.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>                iterator.<span style="color:#007f7f">remove</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//检查事件是否是一个新的已经就绪可以被接受的连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#fff;font-weight:bold">if</span> (key.<span style="color:#007f7f">isAcceptable</span>()) {
</span></span><span style="display:flex;"><span>                        ServerSocketChannel server = (ServerSocketChannel) key.<span style="color:#007f7f">channel</span>();
</span></span><span style="display:flex;"><span>                        SocketChannel client = server.<span style="color:#007f7f">accept</span>();
</span></span><span style="display:flex;"><span>                        client.<span style="color:#007f7f">configureBlocking</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//接受客户端，并将它注册到选择器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        client.<span style="color:#007f7f">register</span>(selector, SelectionKey.<span style="color:#007f7f">OP_WRITE</span> | SelectionKey.<span style="color:#007f7f">OP_READ</span>, msg.<span style="color:#007f7f">duplicate</span>());
</span></span><span style="display:flex;"><span>                        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Accepted connection from &#34;</span> + client);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//检查套接字是否已经准备好写数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#fff;font-weight:bold">if</span> (key.<span style="color:#007f7f">isWritable</span>()) {
</span></span><span style="display:flex;"><span>                        SocketChannel client = (SocketChannel) key.<span style="color:#007f7f">channel</span>();
</span></span><span style="display:flex;"><span>                        ByteBuffer buffer = (ByteBuffer) key.<span style="color:#007f7f">attachment</span>();
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">while</span> (buffer.<span style="color:#007f7f">hasRemaining</span>()) {
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//将数据写到已连接的客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            <span style="color:#fff;font-weight:bold">if</span> (client.<span style="color:#007f7f">write</span>(buffer) == <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>                                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//关闭连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        client.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">catch</span> (IOException ex) {
</span></span><span style="display:flex;"><span>                    key.<span style="color:#007f7f">cancel</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                        key.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                    } <span style="color:#fff;font-weight:bold">catch</span> (IOException cex) {
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// ignore on close
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如同你所看到的，虽然这段代码所做的事情与之前的版本完全相同，但是代码却截然不同。如果为了用于非阻塞 I/O 而重新实现这个简单的应用程序，都需要一次完全的重写的话，那么不难想象，移植真正复杂的应用程序需要付出什么样的努力。鉴于此，让我们来看看使用 Netty 实现该应用程序将会是什么样子吧。</p>
<h3 id="通过-netty-使用-oio-和-nio">通过 Netty 使用 OIO 和 NIO<a hidden class="anchor" aria-hidden="true" href="#通过-netty-使用-oio-和-nio">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 4-3 使用 Netty 的阻塞网络编程
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> NettyOioServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> server(<span style="color:#fff;font-weight:bold">int</span> port) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> ByteBuf buf = Unpooled.<span style="color:#007f7f">unreleasableBuffer</span>(Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Hi!\r\n&#34;</span>, Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>)));
</span></span><span style="display:flex;"><span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> OioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//创建 ServerBootstrap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ServerBootstrap b = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>            b.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//使用 OioEventLoopGroup以允许阻塞模式（旧的I/O）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    .<span style="color:#007f7f">channel</span>(OioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">localAddress</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port))
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//指定 ChannelInitializer，对于每个已接受的连接都调用它
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    .<span style="color:#007f7f">childHandler</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelInitializer&lt;SocketChannel&gt;() {
</span></span><span style="display:flex;"><span>                        @Override
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(SocketChannel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                                ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>                                    <span style="color:#007f7f">//添加一个 ChannelInboundHandlerAdapter以拦截和处理事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                                    <span style="color:#fff;font-weight:bold">new</span> ChannelInboundHandlerAdapter() {
</span></span><span style="display:flex;"><span>                                        @Override
</span></span><span style="display:flex;"><span>                                        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(ChannelHandlerContext ctx) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                                            ctx.<span style="color:#007f7f">writeAndFlush</span>(buf.<span style="color:#007f7f">duplicate</span>())
</span></span><span style="display:flex;"><span>                                                    .<span style="color:#007f7f">addListener</span>(
</span></span><span style="display:flex;"><span>                                                            <span style="color:#007f7f">//将消息写到客户端，并添加 ChannelFutureListener，
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                                                            <span style="color:#007f7f">//以便消息一被写完就关闭连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                                                            ChannelFutureListener.<span style="color:#007f7f">CLOSE</span>);
</span></span><span style="display:flex;"><span>                                        }
</span></span><span style="display:flex;"><span>                                    });
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    });
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//绑定服务器以接受连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ChannelFuture f = b.<span style="color:#007f7f">bind</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>            f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//释放所有的资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            group.<span style="color:#007f7f">shutdownGracefully</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="非阻塞的-netty-版本">非阻塞的 Netty 版本<a hidden class="anchor" aria-hidden="true" href="#非阻塞的-netty-版本">#</a></h3>
<p>代码清单 4-4 和代码清单 4-3 几乎一模一样，除了高亮显示的那两行。这就是从阻塞（OIO）传输切换到非阻塞（NIO）传输需要做的所有变更。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 4-4 使用 Netty 的异步网络处理
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> NettyNioServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> server(<span style="color:#fff;font-weight:bold">int</span> port) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> ByteBuf buf = Unpooled.<span style="color:#007f7f">unreleasableBuffer</span>(Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Hi!\r\n&#34;</span>, Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>)));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//为非阻塞模式使用NioEventLoopGroup
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        NioEventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//创建ServerBootstrap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ServerBootstrap b = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>            b.<span style="color:#007f7f">group</span>(group).<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#007f7f">localAddress</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port))
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//指定 ChannelInitializer，对于每个已接受的连接都调用它
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    .<span style="color:#007f7f">childHandler</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelInitializer&lt;SocketChannel&gt;() {
</span></span><span style="display:flex;"><span>                                      @Override
</span></span><span style="display:flex;"><span>                                      <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(SocketChannel ch)
</span></span><span style="display:flex;"><span>                                              <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                                              ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>                                                 <span style="color:#007f7f">//添加 ChannelInboundHandlerAdapter以接收和处理事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                                                  <span style="color:#fff;font-weight:bold">new</span> ChannelInboundHandlerAdapter() {
</span></span><span style="display:flex;"><span>                                                      @Override
</span></span><span style="display:flex;"><span>                                                      <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(
</span></span><span style="display:flex;"><span>                                                              <span style="color:#007f7f">//将消息写到客户端，并添加ChannelFutureListener，
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                                                              <span style="color:#007f7f">//以便消息一被写完就关闭连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                                                              ChannelHandlerContext ctx) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                                                                ctx.<span style="color:#007f7f">writeAndFlush</span>(buf.<span style="color:#007f7f">duplicate</span>())
</span></span><span style="display:flex;"><span>                                                                  .<span style="color:#007f7f">addListener</span>(
</span></span><span style="display:flex;"><span>                                                                          ChannelFutureListener.<span style="color:#007f7f">CLOSE</span>);
</span></span><span style="display:flex;"><span>                                                      }
</span></span><span style="display:flex;"><span>                                                  });
</span></span><span style="display:flex;"><span>                                      }
</span></span><span style="display:flex;"><span>                                  }
</span></span><span style="display:flex;"><span>                    );
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//绑定服务器以接受连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ChannelFuture f = b.<span style="color:#007f7f">bind</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>            f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//释放所有的资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            group.<span style="color:#007f7f">shutdownGracefully</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为 Netty 为每种传输的实现都暴露了相同的 API，所以无论选用哪一种传输的实现，你的代码都仍然几乎不受影响。在所有的情况下，传输的实现都依赖于 interface Channel、ChannelPipeline 和 ChannelHandler。在看过一些使用基于 Netty 的传输的这些优点之后，让我们仔细看看传输 API 本身。</p>
<h2 id="传输api">传输API<a hidden class="anchor" aria-hidden="true" href="#传输api">#</a></h2>
<p>传输 API 的核心是 interface Channel，它被用于所有的 I/O 操作。Channel 类的层次结构如图 4-1 所示。
<img loading="lazy" src="32.png" alt=""  />

如图所示，每个 Channel 都将会被分配一个 ChannelPipeline 和 ChannelConfig。ChannelConfig 包含了该 Channel 的所有配置设置，并且支持热更新。由于特定的传输可能具有独特的设置，所以它可能会实现一个 ChannelConfig 的子类型。（请参考 ChannelConfig实现对应的 Javadoc。）
由于 Channel 是独一无二的，所以为了保证顺序将 Channel 声明为 java.lang.Comparable 的一个子接口。因此，如果两个不同的 Channel 实例都返回了相同的散列码，那么 AbstractChannel 中的 compareTo()方法的实现将会抛出一个 Error。</p>
<p>ChannelPipeline 持有所有将应用于入站和出站数据以及事件的 ChannelHandler 实例，这些
ChannelHandler 实现了应用程序用于处理状态变化以及数据处理的逻辑。</p>
<p>ChannelHandler 的典型用途包括：</p>
<ul>
<li>将数据从一种格式转换为另一种格式；</li>
<li>提供异常的通知；</li>
<li>提供 Channel 变为活动的或者非活动的通知；</li>
<li>提供当 Channel 注册到 EventLoop 或者从 EventLoop 注销时的通知；</li>
<li>提供有关用户自定义事件的通知。</li>
</ul>
<p>你也可以根据需要通过添加或者移除ChannelHandler实例来修改ChannelPipeline。</p>
<p>通过利用Netty的这项能力可以构建出高度灵活的应用程序。例如，每当STARTTLS①协议被请求时，你可以简单地通过 向 ChannelPipeline 添 加 一个适当的 ChannelHandler（SslHandler）来按需地支持STARTTLS协议。除了访问所分配的 ChannelPipeline 和 ChannelConfig 之外，也可以利用 Channel的其他方法，如下：</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>eventLoop</td>
<td>返回分配给 Channel 的 EventLoop</td>
</tr>
<tr>
<td>pipeline</td>
<td>返回分配给 Channel 的 ChannelPipeline</td>
</tr>
<tr>
<td>isActive</td>
<td>如果 Channel 是活动的，则返回 true。活动的意义可能依赖于底层的传输。例如， 一个 Socket 传输一旦连接到了远程节点便是活动的，而一个 Datagram 传输一旦被打开便是活动的</td>
</tr>
<tr>
<td>localAddress</td>
<td>返回本地的 SokcetAddress</td>
</tr>
<tr>
<td>remoteAddress</td>
<td>返回远程的 SocketAddress</td>
</tr>
<tr>
<td>write</td>
<td>将数据写到远程节点。这个数据将被传递给 ChannelPipeline，并且排队直到它被冲刷</td>
</tr>
<tr>
<td>flush</td>
<td>将之前已写的数据冲刷到底层传输，如一个 Socket</td>
</tr>
<tr>
<td>writeAndFlush</td>
<td>一个简便的方法，等同于调用 write()并接着调用 flush()</td>
</tr>
</tbody>
</table>
<p>稍后我们将进一步深入地讨论所有这些特性的应用。目前，请记住，Netty 所提供的广泛功能只依赖于少量的接口。这意味着，你可以对你的应用程序逻辑进行重大的修改，而又无需大规模地重构你的代码库。</p>
<p>考虑一下写数据并将其冲刷到远程节点这样的常规任务。代码清单 4-5 演示了使用Channel.writeAndFlush()来实现这一目的。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 4-5 写出到 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 4-6 从多个线程使用同一个 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ChannelOperationExamples {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> Channel CHANNEL_FROM_SOMEWHERE = <span style="color:#fff;font-weight:bold">new</span> NioSocketChannel();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 4-5 写出到 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> writingToChannel() {
</span></span><span style="display:flex;"><span>        Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// Get the channel reference from somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//创建持有要写数据的 ByteBuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;your data&#34;</span>, CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        ChannelFuture cf = channel.<span style="color:#007f7f">writeAndFlush</span>(buf);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 ChannelFutureListener 以便在写操作完成后接收通知
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        cf.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture future) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//写操作完成，并且没有错误发生
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> (future.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Write successful&#34;</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//记录错误
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Write error&#34;</span>);
</span></span><span style="display:flex;"><span>                    future.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 4-6 从多个线程使用同一个 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> writingToChannelFromManyThreads() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// Get the channel reference from somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//创建持有要写数据的ByteBuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">final</span> ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;your data&#34;</span>,
</span></span><span style="display:flex;"><span>                CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建将数据写到Channel 的 Runnable
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Runnable writer = <span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>                channel.<span style="color:#007f7f">write</span>(buf.<span style="color:#007f7f">duplicate</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//获取到线程池Executor 的引用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Executor executor = Executors.<span style="color:#007f7f">newCachedThreadPool</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//递交写任务给线程池以便在某个线程中执行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// write in one thread
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        executor.<span style="color:#007f7f">execute</span>(writer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//递交另一个写任务以便在另一个线程中执行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// write in another thread
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        executor.<span style="color:#007f7f">execute</span>(writer);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty 的 Channel 实现是线程安全的，因此你可以存储一个到 Channel 的引用，并且每当你需要向远程节点写数据时，都可以使用它，即使当时许多线程都在使用它。代码清单 4-6 （上边）展示了一个多线程写数据的简单例子。需要注意的是，消息将会被保证按顺序发送。</p>
<h2 id="内置的传输">内置的传输<a hidden class="anchor" aria-hidden="true" href="#内置的传输">#</a></h2>
<p>Netty 内置了一些可开箱即用的传输。因为并不是它们所有的传输都支持每一种协议，所以你必须选择一个和你的应用程序所使用的协议相容的传输。在本节中我们将讨论这些关系。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>包</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>NIO</td>
<td>io.netty.channel.socket.nio</td>
<td>使用 java.nio.channels 包作为基础——基于 选择器的方式</td>
</tr>
<tr>
<td>Epoll</td>
<td>io.netty.channel.epoll</td>
<td>由 JNI 驱动的 epoll()和非阻塞 IO。这个传输支持 只有在Linux上可用的多种特性，如SO_REUSEPORT， 比 NIO 传输更快，而且是完全非阻塞的</td>
</tr>
<tr>
<td>OIO</td>
<td>io.netty.channel.socket.oio</td>
<td>使用 java.net 包作为基础——使用阻塞流</td>
</tr>
<tr>
<td>Local</td>
<td>io.netty.channel.local</td>
<td>可以在 VM 内部通过管道进行通信的本地传输</td>
</tr>
<tr>
<td>Embedded</td>
<td>io.netty.channel.embedded</td>
<td>Embedded 传输，允许使用 ChannelHandler 而又 不需要一个真正的基于网络的传输。这在测试你的 ChannelHandler 实现时非常有用</td>
</tr>
</tbody>
</table>
<h3 id="nio非阻塞-io">NIO——非阻塞 I/O<a hidden class="anchor" aria-hidden="true" href="#nio非阻塞-io">#</a></h3>
<p>NIO 提供了一个所有 I/O 操作的全异步的实现。它利用了自 NIO 子系统被引入 JDK 1.4 时便可用的基于选择器的 API。选择器背后的基本概念是充当一个注册表，在那里你将可以请求在 Channel 的状态发生变化时得到通知。可能的状态变化有：</p>
<ul>
<li>新的 Channel 已被接受并且就绪；</li>
<li>Channel 连接已经完成；</li>
<li>Channel 有已经就绪的可供读取的数据；</li>
<li>Channel 可用于写数据。</li>
</ul>
<p>选择器运行在一个检查状态变化并对其做出相应响应的线程上，在应用程序对状态的改变做出响应之后，选择器将会被重置，并将重复这个过程。表4-3中的常量值代表了由class java.nio.channels.SelectionKey定义的位模式。这些位模式可以组合起来定义一组应用程序正在请求通知的状态变化集。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>OP_ACCEPT</td>
<td>请求在接受新连接并创建 Channel 时获得通知</td>
</tr>
<tr>
<td>OP_CONNECT</td>
<td>请求在建立一个连接时获得通知</td>
</tr>
<tr>
<td>OP_READ</td>
<td>请求当数据已经就绪，可以从 Channel 中读取时获得通知</td>
</tr>
<tr>
<td>OP_WRITE</td>
<td>请求当可以向 Channel 中写更多的数据时获得通知。这处理了套接字缓冲区被完 全填满时的情况，这种情况通常发生在数据的发送速度比远程节点可处理的速度更 快的时候</td>
</tr>
</tbody>
</table>
<p>对于所有 Netty 的传输实现都共有的用户级别 API 完全地隐藏了这些 NIO 的内部细节。图 4-2 展示了该处理流程。
<img loading="lazy" src="33.png" alt=""  />
</p>
<p>零拷贝（zero-copy）是一种目前只有在使用 NIO 和 Epoll 传输时才可使用的特性。它使你可以快速高效地将数据从文件系统移动到网络接口，而不需要将其从内核空间复制到用户空间，其在像 FTP 或者HTTP 这样的协议中可以显著地提升性能。但是，并不是所有的操作系统都支持这一特性。特别地，它对于实现了数据加密或者压缩的文件系统是不可用的——只能传输文件的原始内容。反过来说，传输已被加密的文件则不是问题。</p>
<h3 id="epoll用于-linux-的本地非阻塞传输">Epoll—用于 Linux 的本地非阻塞传输<a hidden class="anchor" aria-hidden="true" href="#epoll用于-linux-的本地非阻塞传输">#</a></h3>
<p>正如我们之前所说的，Netty 的 NIO 传输基于 Java 提供的异步/非阻塞网络编程的通用抽象。虽然这保证了Netty 的非阻塞 API 可以在任何平台上使用，但它也包含了相应的限制，因为 JDK为了在所有系统上提供相同的功能，必须做出妥协。Linux作为高性能网络编程的平台，其重要性与日俱增，这催生了大量先进特性的开发，其中包括epoll——一个高度可扩展的I/O事件通知特性。这个API自Linux内核版本 2.5.44（2002）被引入，提供了比旧的POSIX select和poll系统调用更好的性能。同时现在也是Linux上非阻塞网络编程的事实标准。Linux JDK NIO API使用了这些epoll调用。
Netty为Linux提供了一组NIO API，其以一种和它本身的设计更加一致的方式使用epoll，并且以一种更加轻量的方式使用中断。如果你的应用程序旨在运行于Linux系统，那么请考虑利用这个版本的传输；你将发现在高负载下它的性能要优于JDK的NIO实现。</p>
<p>这个传输的语义与在图 4-2 所示的完全相同，而且它的用法也是简单直接的。相关示例参照代码清单 4-4。如果要在那个代码清单中使用 epoll 替代 NIO，只需要将 NioEventLoopGroup替换为 EpollEventLoopGroup，并且将 NioServerSocketChannel.class 替换为EpollServerSocketChannel.class 即可。</p>
<h3 id="oio旧的阻塞-io">OIO—旧的阻塞 I/O<a hidden class="anchor" aria-hidden="true" href="#oio旧的阻塞-io">#</a></h3>
<p>Netty 的 OIO 传输实现代表了一种折中：它可以通过常规的传输 API 使用，但是由于它是建立在
java.net 包的阻塞实现之上的，所以它不是异步的。但是，它仍然非常适合于某些用途。例如，你可能需要移植使用了一些进行阻塞调用的库（如JDBC）的遗留代码，而将逻辑转换为非阻塞的可能也是不切实际的。相反，你可以在短期内使用Netty的OIO传输，然后再将你的代码移植到纯粹的异步传输上。让我们来看一看怎么做。</p>
<p>在 java.net API 中，你通常会有一个用来接受到达正在监听的 ServerSocket 的新连接的线程。会创建一个新的和远程节点进行交互的套接字，并且会分配一个新的用于处理相应通信流量的线程。这是必需的，因为某个指定套接字上的任何 I/O 操作在任意的时间点上都可能会阻塞。使用单个线程来处理多个套接字，很容易导致一个套接字上的阻塞操作也捆绑了所有其他的套接字。</p>
<p>有了这个背景，你可能会想，Netty是如何能够使用和用于异步传输相同的API来支持OIO的呢。答案就是，Netty利用了SO_TIMEOUT这个Socket标志，它指定了等待一个I/O操作完成的最大毫秒数。如果操作在指定的时间间隔内没有完成，则将会抛出一个SocketTimeout Exception。Netty将捕获这个异常并继续处理循环。
在EventLoop下一次运行时，它将再次尝试。这实际上也是类似于Netty这样的异步框架能够支持OIO的唯一方式。</p>
<h3 id="用于-jvm-内部通信的-local-传输">用于 JVM 内部通信的 Local 传输<a hidden class="anchor" aria-hidden="true" href="#用于-jvm-内部通信的-local-传输">#</a></h3>
<p>Netty 提供了一个 Local 传输，用于在同一个 JVM 中运行的客户端和服务器程序之间的异步通信。同样，这个传输也支持对于所有 Netty 传输实现都共同的 API。
在这个传输中，和服务器 Channel 相关联的 SocketAddress 并没有绑定物理网络地址；相反，只要服务器还在运行，它就会被存储在注册表里，并在 Channel 关闭时注销。因为这个传输并不接受真正的网络流量，所以它并不能够和其他传输实现进行互操作。因此，客户端希望连接到（在同一个 JVM 中）使用了这个传输的服务器端时也必须使用它。除了这个限制，它的使用方式和其他的传输一模一样。
<img loading="lazy" src="34.png" alt=""  />
</p>
<h3 id="embedded-传输">Embedded 传输<a hidden class="anchor" aria-hidden="true" href="#embedded-传输">#</a></h3>
<p>Netty 提供了一种额外的传输，使得你可以将一组 ChannelHandler 作为帮助器类嵌入到其他的
ChannelHandler 内部。通过这种方式，你将可以扩展一个 ChannelHandler 的功能，而又不需要修改其内部代码。不足为奇的是，Embedded 传输的关键是一个被称为 EmbeddedChannel 的具体的 Channel实现。在第 9 章中，我们将详细地讨论如何使用这个类来为 ChannelHandler 的实现创建单元测试用例。</p>
<h2 id="选择哪一种传输">选择哪一种传输<a hidden class="anchor" aria-hidden="true" href="#选择哪一种传输">#</a></h2>
<h3 id="非阻塞代码库">非阻塞代码库<a hidden class="anchor" aria-hidden="true" href="#非阻塞代码库">#</a></h3>
<p>如果你的代码库中没有阻塞调用（或者你能够限制它们的范围），那么在 Linux 上使用 NIO 或者 epoll 始终是个好主意。虽然 NIO/epoll 旨在处理大量的并发连接，但是在处理较小数目的并发连接时，它也能很好地工作，尤其是考虑到它在连接之间共享线程的方式。</p>
<h3 id="阻塞代码库">阻塞代码库<a hidden class="anchor" aria-hidden="true" href="#阻塞代码库">#</a></h3>
<p>正如我们已经指出的，如果你的代码库严重地依赖于阻塞 I/O，而且你的应用程序也有一个相应的设计，那么在你尝试将其直接转换为 Netty 的 NIO 传输时，你将可能会遇到和阻塞操作相关的问题。不要为此而重写你的代码，可以考虑分阶段迁移：先从OIO 开始，等你的代码修改好之后，再迁移到 NIO（或者使用 epoll，如果你在使用 Linux）。</p>
<h3 id="在同一个-jvm-内部的通信">在同一个 JVM 内部的通信<a hidden class="anchor" aria-hidden="true" href="#在同一个-jvm-内部的通信">#</a></h3>
<p>—在同一个 JVM 内部的通信，不需要通过网络暴露服务，是Local 传输的完美用例。这将消除所有真实网络操作的开销，同时仍然使用你的 Netty 代码库。如果随后需要通过网络暴露服务，那么你将只需要把传输改为 NIO 或者 OIO 即可。</p>
<h3 id="测试你的-channelhandler-实现">测试你的 ChannelHandler 实现<a hidden class="anchor" aria-hidden="true" href="#测试你的-channelhandler-实现">#</a></h3>
<p>如果你想要为自己的 ChannelHandler 实现编写单元测试，那么请考虑使用 Embedded 传输。这既便于测试你的代码，而又不需要创建大量的模拟（mock）对象。你的类将仍然符合常规的 API 事件流，保证该 ChannelHandler在和真实的传输一起使用时能够正确地工作。</p>
<h1 id="bytebuf">ByteBuf<a hidden class="anchor" aria-hidden="true" href="#bytebuf">#</a></h1>
<p>网络数据的基本单位总是字节。Java NIO 提供了 ByteBuffer 作为它的字节容器，但是这个类使用起来过于复杂。Netty 的 ByteBuffer 替代品是 ByteBuf，一个强大的实现，既解决了 JDK API 的局限性，又为网络应用程序的开发者提供了更好的 API。在本章中我们将会说明和 JDK 的 ByteBuffer 相比，ByteBuf 的卓越功能性和灵活性。这也将有助于更好地理解 Netty 数据处理的一般方式，并为将在第 6 章中针对ChannelPipeline和 ChannelHandler 的讨论做好准备。</p>
<h2 id="bytebuf-的-api">ByteBuf 的 API<a hidden class="anchor" aria-hidden="true" href="#bytebuf-的-api">#</a></h2>
<p>Netty 的数据处理 API 通过两个组件暴露——abstract class ByteBuf 和 interfaceByteBufHolder。
下面是一些 ByteBuf API 的优点</p>
<ul>
<li>它可以被用户自定义的缓冲区类型扩展；</li>
<li>通过内置的复合缓冲区类型实现了透明的零拷贝；</li>
<li>容量可以按需增长（类似于 JDK 的 StringBuilder）；</li>
<li>在读和写这两种模式之间切换不需要调用 ByteBuffer 的 flip()方法；</li>
<li>读和写使用了不同的索引；</li>
<li>支持方法的链式调用</li>
<li>支持引用计数；</li>
<li>支持池化。
其他类可用于管理 ByteBuf 实例的分配，以及执行各种针对于数据容器本身和它所持有的数据的操作。我们将在仔细研究 ByteBuf 和 ByteBufHolder 时探讨这些特性。</li>
</ul>
<h2 id="bytebuf-类netty-的数据容器">ByteBuf 类——Netty 的数据容器<a hidden class="anchor" aria-hidden="true" href="#bytebuf-类netty-的数据容器">#</a></h2>
<p>因为所有的网络通信都涉及字节序列的移动，所以高效易用的数据结构明显是必不可少的。
Netty 的 ByteBuf 实现满足并超越了这些需求。让我们首先来看看它是如何通过使用不同的索引来简化对它所包含的数据的访问的吧。</p>
<h3 id="bytebuf如何工作">bytebuf如何工作<a hidden class="anchor" aria-hidden="true" href="#bytebuf如何工作">#</a></h3>
<p>ByteBuf 维护了两个不同的索引：一个用于读取，一个用于写入。当你从 ByteBuf 读取时，
它的 readerIndex 将会被递增已经被读取的字节数。同样地，当你写入 ByteBuf 时，它的
writerIndex 也会被递增。图 5-1 展示了一个空 ByteBuf 的布局结构和状态。
<img loading="lazy" src="35.png" alt=""  />
</p>
<p>要了解这些索引两两之间的关系，请考虑一下，如果打算读取字节直到 readerIndex 达到
和 writerIndex 同样的值时会发生什么。在那时，你将会到达“可以读取的”数据的末尾。就如同试图读取超出数组末尾的数据一样，试图读取超出该点的数据将会触发一个 IndexOutOfBoundsException。</p>
<p>名称以 read 或者 write 开头的 ByteBuf 方法，将会推进其对应的索引，而名称以 set 或
者 get 开头的操作则不会。后面的这些方法将在作为一个参数传入的一个相对索引上执行操作。
可以指定 ByteBuf 的最大容量。试图移动写索引（即 writerIndex）超过这个值将会触发一个异常①。（默认的限制是 Integer.MAX_VALUE。）</p>
<h3 id="bytebuf-的使用模式">ByteBuf 的使用模式<a hidden class="anchor" aria-hidden="true" href="#bytebuf-的使用模式">#</a></h3>
<p>在使用 Netty 时，你将遇到几种常见的围绕 ByteBuf 而构建的使用模式。在研究它们时，我们心里想着图 5-1 会有所裨益，一个由不同的索引分别控制读访问和写访问的字节数组。</p>
<h4 id="堆缓冲区">堆缓冲区<a hidden class="anchor" aria-hidden="true" href="#堆缓冲区">#</a></h4>
<p>最常用的 ByteBuf 模式是将数据存储在 JVM 的堆空间中。这种模式被称为支撑数组
（backing array），它能在没有使用池化的情况下提供快速的分配和释放。这种方式，如代码清单
5-1 所示，非常适合于有遗留的数据需要处理的情况。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-1 支撑数组
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> heapBuffer() {
</span></span><span style="display:flex;"><span>	ByteBuf heapBuf = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//检查 ByteBuf 是否有一个支撑数组
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">if</span> (heapBuf.<span style="color:#007f7f">hasArray</span>()) {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//如果有，则获取对该数组的引用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">byte</span>[] array = heapBuf.<span style="color:#007f7f">array</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//计算第一个字节的偏移量
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">int</span> offset = heapBuf.<span style="color:#007f7f">arrayOffset</span>() + heapBuf.<span style="color:#007f7f">readerIndex</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//获得可读字节数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">int</span> length = heapBuf.<span style="color:#007f7f">readableBytes</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//使用数组、偏移量和长度作为参数调用你的方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		handleArray(array, offset, length);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="直接缓冲区">直接缓冲区<a hidden class="anchor" aria-hidden="true" href="#直接缓冲区">#</a></h4>
<p>直接缓冲区是另外一种 ByteBuf 模式。我们期望用于对象创建的内存分配永远都来自于堆中，但这并不是必须的——NIO 在 JDK 1.4 中引入的 ByteBuffer 类允许 JVM 实现通过本地调用来分配内存。这主要是为了避免在每次调用本地 I/O 操作之前（或者之后）将缓冲区的内容复制到一个中间缓冲区（或者从中间缓冲区把内容复制到缓冲区）。</p>
<p>ByteBuffer的Javadoc明确指出：“直接缓冲区的内容将驻留在常规的会被垃圾回收的堆之外。”这也就解释了为何直接缓冲区对于网络数据传输是理想的选择。如果你的数据包含在一个在堆上分配的缓冲区中，那么事实上，在通过套接字发送它之前，JVM将会在内部把你的缓冲区复制到一个直接缓冲区中。</p>
<p>直接缓冲区的主要缺点是，相对于基于堆的缓冲区，它们的分配和释放都较为昂贵。如果你正在处理遗留代码，你也可能会遇到另外一个缺点：因为数据不是在堆上，所以你不得不进行一次复制，如代码清单 5-2 所示。显然，与使用支撑数组相比，这涉及的工作更多。因此，如果事先知道容器中的数据将会被作为数组来访问，你可能更愿意使用堆内存。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-2 访问直接缓冲区的数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> directBuffer() {
</span></span><span style="display:flex;"><span>	ByteBuf directBuf = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//检查 ByteBuf 是否由数组支撑。如果不是，则这是一个直接缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">if</span> (!directBuf.<span style="color:#007f7f">hasArray</span>()) {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//获取可读字节数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">int</span> length = directBuf.<span style="color:#007f7f">readableBytes</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//分配一个新的数组来保存具有该长度的字节数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">byte</span>[] array = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[length];
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//将字节复制到该数组
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		directBuf.<span style="color:#007f7f">getBytes</span>(directBuf.<span style="color:#007f7f">readerIndex</span>(), array);
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//使用数组、偏移量和长度作为参数调用你的方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		handleArray(array, <span style="color:#ff0;font-weight:bold">0</span>, length);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="复合缓冲区">复合缓冲区<a hidden class="anchor" aria-hidden="true" href="#复合缓冲区">#</a></h4>
<p>第三种也是最后一种模式使用的是复合缓冲区，它为多个 ByteBuf 提供一个聚合视图。在这里你可以根据需要添加或者删除 ByteBuf 实例，这是一个 JDK 的 ByteBuffer 实现完全缺失的特性。</p>
<p>Netty 通过一个 ByteBuf 子类——CompositeByteBuf——实现了这个模式，它提供了一个将多个缓冲区表示为单个合并缓冲区的虚拟表示。</p>
<p>警告：CompositeByteBuf 中的 ByteBuf 实例可能同时包含直接内存分配和非直接内存分配。如果其中只有一个实例，那么对 CompositeByteBuf 上的 hasArray()方法的调用将返回该组件上的 hasArray()方法的值；否则它将返回 false。</p>
<p>举例：一个由头部和主体组成的消息，将通过http协议传输。这两部分由应用程序的不同模块产生，
将会在消息被发送的时候组装。该应用程序可以选择为多个消息重用相同的消息主体。当这种情况发生时，对于每个消息都将会创建一个新的头部。
因为我们不想为每个消息都重新分配这两个缓冲区，所以使用 CompositeByteBuf 是一个完美的选择。它在消除了没必要的复制的同时，暴露了通用的 ByteBuf API。</p>
<p>代码清单 5-3 展示了如何通过使用 JDK 的 ByteBuffer 来实现这一需求。创建了一个包含两个
ByteBuffer 的数组用来保存这些消息组件，同时创建了第三个 ByteBuffer 用来保存所有这些数据的副本。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-3 使用 ByteBuffer 的复合缓冲区模式
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufferComposite(ByteBuffer header, ByteBuffer body) {
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// Use an array to hold the message parts
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBuffer[] message =  <span style="color:#fff;font-weight:bold">new</span> ByteBuffer[]{ header, body };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// Create a new ByteBuffer and use copy to merge the header and body
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBuffer message2 =
</span></span><span style="display:flex;"><span>			ByteBuffer.<span style="color:#007f7f">allocate</span>(header.<span style="color:#007f7f">remaining</span>() + body.<span style="color:#007f7f">remaining</span>());
</span></span><span style="display:flex;"><span>	message2.<span style="color:#007f7f">put</span>(header);
</span></span><span style="display:flex;"><span>	message2.<span style="color:#007f7f">put</span>(body);
</span></span><span style="display:flex;"><span>	message2.<span style="color:#007f7f">flip</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>分配和复制操作，以及伴随着对数组管理的需要，使得这个版本的实现效率低下而且笨拙。
代码清单 5-4 展示了一个使用了 CompositeByteBuf 的版本。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-4 使用 CompositeByteBuf 的复合缓冲区模式
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufComposite() {
</span></span><span style="display:flex;"><span>	CompositeByteBuf messageBuf = Unpooled.<span style="color:#007f7f">compositeBuffer</span>();
</span></span><span style="display:flex;"><span>	ByteBuf headerBuf = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">// can be backing or direct
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBuf bodyBuf = BYTE_BUF_FROM_SOMEWHERE;   <span style="color:#007f7f">// can be backing or direct
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//将 ByteBuf 实例追加到 CompositeByteBuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	messageBuf.<span style="color:#007f7f">addComponents</span>(headerBuf, bodyBuf);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//删除位于索引位置为 0（第一个组件）的 ByteBuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	messageBuf.<span style="color:#007f7f">removeComponent</span>(<span style="color:#ff0;font-weight:bold">0</span>); <span style="color:#007f7f">// remove the header
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//循环遍历所有的 ByteBuf 实例
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">for</span> (ByteBuf buf : messageBuf) {
</span></span><span style="display:flex;"><span>		System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(buf.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>CompositeByteBuf 可能不支持访问其支撑数组，因此访问 CompositeByteBuf 中的数据类似
于（访问）直接缓冲区的模式，如代码清单 5-5 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-5 访问 CompositeByteBuf 中的数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufCompositeArray() {
</span></span><span style="display:flex;"><span>	CompositeByteBuf compBuf = Unpooled.<span style="color:#007f7f">compositeBuffer</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//获得可读字节数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">int</span> length = compBuf.<span style="color:#007f7f">readableBytes</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//分配一个具有可读字节数长度的新数组
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">byte</span>[] array = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[length];
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//将字节读到该数组中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	compBuf.<span style="color:#007f7f">getBytes</span>(compBuf.<span style="color:#007f7f">readerIndex</span>(), array);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//使用偏移量和长度作为参数使用该数组
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	handleArray(array, <span style="color:#ff0;font-weight:bold">0</span>, array.<span style="color:#007f7f">length</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要注意的是，Netty使用了CompositeByteBuf来优化套接字的I/O操作，尽可能地消除了由JDK的缓冲区实现所导致的性能以及内存使用率的惩罚。这种优化发生在Netty的核心代码中，因此不会被暴露出来，但是你应该知道它所带来的影响。CompositeByteBuf API 除了从 ByteBuf 继承的方法，CompositeByteBuf 提供了大量的附加功能。请参考 Netty 的 Javadoc 以获得该 API 的完整列表。</p>
<h2 id="byebuf字节级操作">ByeBuf字节级操作<a hidden class="anchor" aria-hidden="true" href="#byebuf字节级操作">#</a></h2>
<p>ByteBuf 提供了许多超出基本读、写操作的方法用于修改它的数据。我们将会讨论这些中最重要的部分。</p>
<h3 id="随机访问索引">随机访问索引<a hidden class="anchor" aria-hidden="true" href="#随机访问索引">#</a></h3>
<p>如同在普通的 Java 字节数组中一样，ByteBuf 的索引是从零开始的：第一个字节的索引是0，最后一个字节的索引总是 capacity() - 1。代码清单 5-6 表明，对存储机制的封装使得遍历 ByteBuf 的内容非常简单。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-6 访问数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufRelativeAccess() {
</span></span><span style="display:flex;"><span>	ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; buffer.<span style="color:#007f7f">capacity</span>(); i++) {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">byte</span> b = buffer.<span style="color:#007f7f">getByte</span>(i);
</span></span><span style="display:flex;"><span>		System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>((<span style="color:#fff;font-weight:bold">char</span>) b);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要注意的是，使用那些需要一个索引值参数的方法（的其中）之一来访问数据既不会改变readerIndex也不会改变 writerIndex。如果有需要，也可以通过调用 readerIndex(index)或者writerIndex(index)来手动移动这两者。</p>
<h3 id="顺序访问索引">顺序访问索引<a hidden class="anchor" aria-hidden="true" href="#顺序访问索引">#</a></h3>
<p>虽然 ByteBuf 同时具有读索引和写索引，但是 JDK 的 ByteBuffer 却只有一个索引，这也就是为什么必须调用 flip()方法来在读模式和写模式之间进行切换的原因。图 5-3 展示了ByteBuf 是如何被它的两个索引划分成 3 个区域的。
<img loading="lazy" src="36.png" alt=""  />
</p>
<h3 id="可丢弃字节">可丢弃字节<a hidden class="anchor" aria-hidden="true" href="#可丢弃字节">#</a></h3>
<p>在图 5-3 中标记为可丢弃字节的分段包含了已经被读过的字节。通过调用 discardReadBytes()方法，可以丢弃它们并回收空间。这个分段的初始大小为 0，存储在 readerIndex 中，会随着 read 操作的执行而增加（get*操作不会移动 readerIndex）。图 5-4 展示了图 5-3 中所展示的缓冲区上调用discardReadBytes()方法后的结果。可以看到，可丢弃字节分段中的空间已经变为可写的了。注意，在调用discardReadBytes()之后，对可写分段的内容并没有任何的保证 ①。
<img loading="lazy" src="37.png" alt=""  />
</p>
<p>虽然你可能会倾向于频繁地调用 discardReadBytes()方法以确保可写分段的最大化，但是请注意，这将极有可能会导致内存复制，因为可读字节（图中标记为 CONTENT 的部分）必须被移动到缓冲区的开始位置。我们建议只在有真正需要的时候才这样做，例如，当内存非常宝贵的时候。</p>
<h3 id="可读字节">可读字节<a hidden class="anchor" aria-hidden="true" href="#可读字节">#</a></h3>
<p>ByteBuf 的可读字节分段存储了实际数据。新分配的、包装的或者复制的缓冲区的默认的readerIndex值为0。
任何名称以read或者skip开头的操作都将检索或者跳过位于当前readerIndex的数据，并且将它增加已读字节数。如果被调用的方法需要一个 ByteBuf 参数作为写入的目标，并且没有指定目标索引参数，那么该目标缓冲区的 writerIndex 也将被增加，例如：<code>readBytes(ByteBuf dest);</code></p>
<p>如果尝试在缓冲区的可读字节数已经耗尽时从中读取数据，那么将会引发一个 IndexOutOfBoundsException。
代码清单 5-7 展示了如何读取所有可以读的字节。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-7 读取所有数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> readAllData() {
</span></span><span style="display:flex;"><span>	ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">while</span> (buffer.<span style="color:#007f7f">isReadable</span>()) {
</span></span><span style="display:flex;"><span>		System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(buffer.<span style="color:#007f7f">readByte</span>());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="可写字节">可写字节<a hidden class="anchor" aria-hidden="true" href="#可写字节">#</a></h3>
<p>可写字节分段是指一个拥有未定义内容的、写入就绪的内存区域。新分配的缓冲区的writerIndex的默认值为0。任何名称以 write 开头的操作都将从当前的 writerIndex 处开始写数据，并将它增加已经写入的字节数。如果写操作的目标也是 ByteBuf，并且没有指定源索引的值，则源缓冲区的 readerIndex 也同样会被增加相同的大小。这个调用如下所示：<code>writeBytes(ByteBuf dest);</code></p>
<p>如果尝试往目标写入超过目标容量的数据，将会引发一个IndexOutOfBoundException。
在往 ByteBuf 中写入数据时，其将首先确保目标 ByteBuf 具有足够的可写入空间来容纳当前要写入
的数据，如果没有，则将检查当前的写索引以及最大容量是否可以在扩展后容纳该数据，可以则会分配并调整容量，否则就会抛出该异常。
代码清单5-8 是一个用随机整数值填充缓冲区，直到它空间不足为止的例子。writeableBytes()
方法在这里被用来确定该缓冲区中是否还有足够的空间。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * 代码清单 5-8 写数据
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>public static void write() {
</span></span><span style="display:flex;"><span>	// Fills the writable bytes of a buffer with random integers.
</span></span><span style="display:flex;"><span>	ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; //get reference form somewhere
</span></span><span style="display:flex;"><span>	while (buffer.writableBytes() &gt;= 4) {
</span></span><span style="display:flex;"><span>		buffer.writeInt(random.nextInt());
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="索引管理">索引管理<a hidden class="anchor" aria-hidden="true" href="#索引管理">#</a></h3>
<p>JDK 的 InputStream 定义了 mark(int readlimit)和 reset()方法，这些方法分别被用来将流中的当前位置标记为指定的值，以及将流重置到该位置。同样，可以通过调用 markReaderIndex()、markWriterIndex()、resetWriterIndex()和 resetReaderIndex()来标记和重置 ByteBuf 的 readerIndex 和 writerIndex。
这些和InputStream 上的调用类似，只是没有 readlimit 参数来指定标记什么时候失效。也可以通过调用readerIndex(int)或者 writerIndex(int)来将索引移动到指定位置。试图将任何一个索引设置到一个无效的位置都将导致一个 IndexOutOfBoundsException。可以通过调用 clear()方法来将 readerIndex 和writerIndex 都设置为 0。注意，这并不会清除内存中的内容。
图 5-5（重复上面的图 5-3）展示了它是如何工作的。
<img loading="lazy" src="36.png" alt=""  />
</p>
<p>和之前一样，ByteBuf 包含 3 个分段。图 5-6 展示了在 clear()方法被调用之后 ByteBuf的状态。
<img loading="lazy" src="38.png" alt=""  />

调用 clear()比调用 discardReadBytes()轻量得多，因为它将只是重置索引而不会复制任何的内存。</p>
<h3 id="查找操作">查找操作<a hidden class="anchor" aria-hidden="true" href="#查找操作">#</a></h3>
<p>在ByteBuf中有多种可以用来确定指定值的索引的方法。最简单的是使用indexOf()方法。较复杂的查找可以通过那些需要一个io.netty.util.ByteProcessor为参数的方法达成。这个接口只定义了一个方法：
<code>boolean process(byte value)</code>
它将检查输入值是否是正在查找的值。
ByteProcessor针对一些常见的值定义了许多便利的方法。假设你的应用程序需要和所谓的包含有以NULL结尾的内容的Flash套接字集成，调用<code>forEachByte(ByteBufProcessor.FIND_NUL)</code>
将简单高效地消费该 Flash 数据，因为在处理期间只会执行较少的边界检查。
代码清单 5-9 展示了一个查找回车符（\r）的例子。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-9 使用 ByteBufProcessor 来寻找\r
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * use {@link io.netty.util.ByteProcessor in Netty 4.0.x}
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteProcessor() {
</span></span><span style="display:flex;"><span>	ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">int</span> index = buffer.<span style="color:#007f7f">forEachByte</span>(ByteProcessor.<span style="color:#007f7f">FIND_CR</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>注：ByteBufProcessor在netty 4.1.x版本已经废弃。</p>
<h3 id="派生缓冲区">派生缓冲区<a hidden class="anchor" aria-hidden="true" href="#派生缓冲区">#</a></h3>
<p>派生缓冲区为 ByteBuf 提供了以专门的方式来呈现其内容的视图。这类视图是通过以下方法被创建的：
duplicate()
slice()
slice(int, int)
Unpooled.unmodifiableBuffer(…)
order(ByteOrder)
readSlice(int)</p>
<p>每个这些方法都将返回一个新的 ByteBuf 实例，它具有自己的读索引、写索引和标记索引。其内部存储和JDK 的 ByteBuffer 一样也是共享的。这使得派生缓冲区的创建成本是很低廉的，但是这也意味着，如果你修改了它的内容，也同时修改了其对应的源实例，所以要小心。
ByteBuf 复制：如果需要一个现有缓冲区的真实副本，请使用 copy()或者 copy(int, int)方
法。不同于派生缓冲区，由这个调用所返回的 ByteBuf 拥有独立的数据副本。</p>
<p>代码清单 5-10 展示了如何使用 slice(int, int)方法来操作 ByteBuf 的一个分段。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-10 对 ByteBuf 进行切片
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufSlice() {
</span></span><span style="display:flex;"><span>	Charset utf8 = Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//创建一个用于保存给定字符串的字节的 ByteBuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Netty in Action rocks!&#34;</span>, utf8);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//创建该 ByteBuf 从索引 0 开始到索引 15 结束的一个新切片
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBuf sliced = buf.<span style="color:#007f7f">slice</span>(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">15</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//将打印“Netty in Action”
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(sliced.<span style="color:#007f7f">toString</span>(utf8));
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//更新索引 0 处的字节
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	buf.<span style="color:#007f7f">setByte</span>(<span style="color:#ff0;font-weight:bold">0</span>, (<span style="color:#fff;font-weight:bold">byte</span>)<span style="color:#0ff;font-weight:bold">&#39;J&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//将会成功，因为数据是共享的，对其中一个所做的更改对另外一个也是可见的
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">assert</span> buf.<span style="color:#007f7f">getByte</span>(<span style="color:#ff0;font-weight:bold">0</span>) == sliced.<span style="color:#007f7f">getByte</span>(<span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，让我们看看 ByteBuf 的分段的副本和切片有何区别，如代码清单 5-11 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-11 复制一个 ByteBuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufCopy() {
</span></span><span style="display:flex;"><span>	Charset utf8 = Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//创建 ByteBuf 以保存所提供的字符串的字节
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Netty in Action rocks!&#34;</span>, utf8);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//创建该 ByteBuf 从索引 0 开始到索引 15 结束的分段的副本
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBuf copy = buf.<span style="color:#007f7f">copy</span>(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">15</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//将打印“Netty in Action”
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(copy.<span style="color:#007f7f">toString</span>(utf8));
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//更新索引 0 处的字节
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	buf.<span style="color:#007f7f">setByte</span>(<span style="color:#ff0;font-weight:bold">0</span>, (<span style="color:#fff;font-weight:bold">byte</span>)<span style="color:#0ff;font-weight:bold">&#39;J&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//将会成功，因为数据不是共享的
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">assert</span> buf.<span style="color:#007f7f">getByte</span>(<span style="color:#ff0;font-weight:bold">0</span>) != copy.<span style="color:#007f7f">getByte</span>(<span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>除了修改原始 ByteBuf 的切片或者副本的效果以外，这两种场景是相同的。
只要有可能，使用slice()方法来避免复制内存的开销。</p>
<h3 id="读写操作">读/写操作<a hidden class="anchor" aria-hidden="true" href="#读写操作">#</a></h3>
<p>ByteBuf有两种读写操作。
get()和 set()操作，从给定的索引开始，并且保持索引不变。
read()和 write()操作，从给定的索引开始，并且会根据已经访问过的字节数对索引进行调整。</p>
<p>表 5-1 列举了最常用的 get()方法。完整列表请参考对应的 API 文档。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>getBoolean(int)</td>
<td>返回给定索引处的 Boolean 值</td>
</tr>
<tr>
<td>getByte(int)</td>
<td>返回给定索引处的字节</td>
</tr>
<tr>
<td>getUnsignedByte(int)</td>
<td>将给定索引处的无符号字节值作为 short 返回</td>
</tr>
<tr>
<td>getMedium(int</td>
<td>返回给定索引处的 24 位的中等 int 值</td>
</tr>
<tr>
<td>getUnsignedMedium(int</td>
<td>返回给定索引处的无符号的 24 位的中等 int 值</td>
</tr>
<tr>
<td>getInt(int)</td>
<td>返回给定索引处的 int 值</td>
</tr>
<tr>
<td>getUnsignedInt(int)</td>
<td>将给定索引处的无符号 int 值作为 long 返回</td>
</tr>
<tr>
<td>getLong(int)</td>
<td>返回给定索引处的 long 值</td>
</tr>
<tr>
<td>getShort(int)</td>
<td>返回给定索引处的 short 值</td>
</tr>
<tr>
<td>getUnsignedShort(int)</td>
<td>将给定索引处的无符号 short 值作为 int 返回</td>
</tr>
<tr>
<td>getBytes(int, &hellip;)</td>
<td>将该缓冲区中从给定索引开始的数据传送到指定的目的地</td>
</tr>
</tbody>
</table>
<p>上边的大多数的这些操作都有一个对应的 set()方法。这些方法在表 5-2 中列出。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>setBoolean(int, boolean)</td>
<td>设定给定索引处的 Boolean 值</td>
</tr>
<tr>
<td>setByte(int index, int value)</td>
<td>设定给定索引处的字节值</td>
</tr>
<tr>
<td>setMedium(int index, int value)</td>
<td>设定给定索引处的 24 位的中等 int 值</td>
</tr>
<tr>
<td>setInt(int index, int value)</td>
<td>设定给定索引处的 int 值</td>
</tr>
<tr>
<td>setLong(int index, long value)</td>
<td>设定给定索引处的 long 值</td>
</tr>
<tr>
<td>setShort(int index, int value)</td>
<td>设定给定索引处的 short 值</td>
</tr>
</tbody>
</table>
<p>代码清单 5-12 说明了 get()和 set()方法的用法，表明了它们不会改变读索引和写索引。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-12 get()和 set()方法的用法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufSetGet() {
</span></span><span style="display:flex;"><span>	Charset utf8 = Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//创建一个新的 ByteBuf以保存给定字符串的字节
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Netty in Action rocks!&#34;</span>, utf8);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//打印第一个字符&#39;N&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>((<span style="color:#fff;font-weight:bold">char</span>)buf.<span style="color:#007f7f">getByte</span>(<span style="color:#ff0;font-weight:bold">0</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//存储当前的 readerIndex 和 writerIndex
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">int</span> readerIndex = buf.<span style="color:#007f7f">readerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">int</span> writerIndex = buf.<span style="color:#007f7f">writerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//将索引 0 处的字 节更新为字符&#39;B&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	buf.<span style="color:#007f7f">setByte</span>(<span style="color:#ff0;font-weight:bold">0</span>, (<span style="color:#fff;font-weight:bold">byte</span>)<span style="color:#0ff;font-weight:bold">&#39;B&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//打印第一个字符，现在是&#39;B&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>((<span style="color:#fff;font-weight:bold">char</span>)buf.<span style="color:#007f7f">getByte</span>(<span style="color:#ff0;font-weight:bold">0</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//将会成功，因为这些操作并不会修改相应的索引
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">assert</span> readerIndex == buf.<span style="color:#007f7f">readerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">assert</span> writerIndex == buf.<span style="color:#007f7f">writerIndex</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，让我们研究一下 read()操作，其作用于当前的 readerIndex 或 writerIndex。
这些方法将用于从 ByteBuf 中读取数据，如同它是一个流。表 5-3 展示了最常用的方法。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>readBoolean()</td>
<td>返回当前 readerIndex 处的 Boolean，并将 readerIndex 增加 1</td>
</tr>
<tr>
<td>readByte()</td>
<td>返回当前 readerIndex 处的字节，并将 readerIndex 增加 1</td>
</tr>
<tr>
<td>readUnsignedByte()</td>
<td>将当前 readerIndex 处的无符号字节值作为 short 返回，并将 readerIndex 增加 1</td>
</tr>
<tr>
<td>readMedium()</td>
<td>返回当前 readerIndex 处的 24 位的中等 int 值，并将 readerIndex 增加 3</td>
</tr>
<tr>
<td>readUnsignedMedium()</td>
<td>返回当前 readerIndex 处的 24 位的无符号的中等 int 值，并将 readerIndex 增加 3</td>
</tr>
<tr>
<td>readInt()</td>
<td>返回当前 readerIndex 的 int 值，并将 readerIndex 增加 4</td>
</tr>
<tr>
<td>readUnsignedInt()</td>
<td>将当前 readerIndex 处的无符号的 int 值作为 long 值返回，并将 readerIndex 增加 4</td>
</tr>
<tr>
<td>readLong()</td>
<td>返回当前 readerIndex 处的 long 值，并将 readerIndex 增加 8</td>
</tr>
<tr>
<td>readShort()</td>
<td>返回当前 readerIndex 处的 short 值，并将 readerIndex 增加 2</td>
</tr>
<tr>
<td>readUnsignedShort()</td>
<td>将当前 readerIndex 处的无符号 short 值作为 int 值返回，并将 readerIndex 增加 2</td>
</tr>
<tr>
<td>readBytes(ByteBuf byte[] destination, int dstIndex [,int length])</td>
<td>将当前 ByteBuf 中从当前 readerIndex 处开始的（如果设置了， length 长度的字节）数据传送到一个目标 ByteBuf 或者 byte[]，从 目标的 dstIndex 开始的位置。本地的 readerIndex 将被增加已经传 输的字节数</td>
</tr>
</tbody>
</table>
<p>几乎每个 read()方法都有对应的 write()方法，用于将数据追加到 ByteBuf 中。注意，
表 5-4 中所列出的这些方法的参数是需要写入的值，而不是索引值。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>writeBoolean(boolean)</td>
<td>在当前 writerIndex 处写入一个 Boolean，并将 writerIndex 增加 1</td>
</tr>
<tr>
<td>writeByte(int)</td>
<td>在当前 writerIndex 处写入一个字节值，并将 writerIndex 增加 1</td>
</tr>
<tr>
<td>writeMedium(int)</td>
<td>在当前 writerIndex 处写入一个中等的 int 值，并将 writerIndex 增加 3</td>
</tr>
<tr>
<td>writeInt(int)</td>
<td>在当前 writerIndex 处写入一个 int 值，并将 writerIndex 增加 4</td>
</tr>
<tr>
<td>writeLong(long)</td>
<td>在当前 writerIndex 处写入一个 long 值，并将 writerIndex 增加 8</td>
</tr>
<tr>
<td>writeShort(int)</td>
<td>在当前 writerIndex 处写入一个 short 值，并将 writerIndex 增加 2</td>
</tr>
<tr>
<td>writeBytes(source ByteBuf byte[] [,int srcIndex ,int length])</td>
<td>从当前 writerIndex 开始，传输来自于指定源（ByteBuf 或者 byte[]） 的数据。如果提供了 srcIndex 和 length，则从 srcIndex 开始读取， 并且处理长度为 length 的字节。当前 writerIndex 将会被增加所写入 的字节数</td>
</tr>
</tbody>
</table>
<p>代码清单 5-13 展示了这些方法的用法。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-13 ByteBuf 上的 read()和 write()操作
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> byteBufWriteRead() {
</span></span><span style="display:flex;"><span>	Charset utf8 = Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//创建一个新的 ByteBuf 以保存给定字符串的字节
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBuf buf = Unpooled.<span style="color:#007f7f">copiedBuffer</span>(<span style="color:#0ff;font-weight:bold">&#34;Netty in Action rocks!&#34;</span>, utf8);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//打印第一个字符&#39;N&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>((<span style="color:#fff;font-weight:bold">char</span>)buf.<span style="color:#007f7f">readByte</span>());
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//存储当前的readerIndex
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">int</span> readerIndex = buf.<span style="color:#007f7f">readerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//存储当前的writerIndex
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">int</span> writerIndex = buf.<span style="color:#007f7f">writerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//将字符 &#39;?&#39;追加到缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	buf.<span style="color:#007f7f">writeByte</span>((<span style="color:#fff;font-weight:bold">byte</span>)<span style="color:#0ff;font-weight:bold">&#39;?&#39;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">assert</span> readerIndex == buf.<span style="color:#007f7f">readerIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//将会成功，因为 writeByte()方法移动了 writerIndex
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">assert</span> writerIndex != buf.<span style="color:#007f7f">writerIndex</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bytebuf其他操作">byteBuf其他操作<a hidden class="anchor" aria-hidden="true" href="#bytebuf其他操作">#</a></h3>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>isReadable()</td>
<td>如果至少有一个字节可供读取，则返回 true</td>
</tr>
<tr>
<td>isWritable()</td>
<td>如果至少有一个字节可被写入，则返回 true</td>
</tr>
<tr>
<td>readableBytes()</td>
<td>返回可被读取的字节数</td>
</tr>
<tr>
<td>writableBytes()</td>
<td>返回可被写入的字节数</td>
</tr>
<tr>
<td>capacity()</td>
<td>返回 ByteBuf 可容纳的字节数。在此之后，它会尝试再次扩展直 到达到 maxCapacity()</td>
</tr>
<tr>
<td>maxCapacity()</td>
<td>返回 ByteBuf 可以容纳的最大字节数</td>
</tr>
<tr>
<td>hasArray()</td>
<td>如果 ByteBuf 由一个字节数组支撑，则返回 true</td>
</tr>
<tr>
<td>array()</td>
<td>如果 ByteBuf 由一个字节数组支撑则返回该数组；否则，它将抛出一个 UnsupportedOperationException 异常</td>
</tr>
</tbody>
</table>
<h2 id="bytebufholder-接口">ByteBufHolder 接口<a hidden class="anchor" aria-hidden="true" href="#bytebufholder-接口">#</a></h2>
<p>我们经常发现，除了实际的数据负载之外，我们还需要存储各种属性值。HTTP 响应便是一个很好的例子，除了表示为字节的内容，还包括状态码、cookie 等。为了处理这种常见的用例，Netty 提供了ByteBufHolder。ByteBufHolder 也为 Netty 的高级特性提供了支持，如缓冲区池化，其中可以从池中借用 ByteBuf，并且在需要时自动释放。ByteBufHolder 只有几种用于访问底层数据和引用计数的方法。表 5-6 列出了它们（这里不包括它继承自 ReferenceCounted 的那些方法）。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>content()</td>
<td>返回由这个 ByteBufHolder 所持有的 ByteBuf</td>
</tr>
<tr>
<td>copy()</td>
<td>返回这个 ByteBufHolder 的一个深拷贝，包括一个其所包含的 ByteBuf 的非共享拷贝</td>
</tr>
<tr>
<td>duplicate()</td>
<td>返回这个 ByteBufHolder 的一个浅拷贝，包括一个其所包含的 ByteBuf 的共享拷贝</td>
</tr>
</tbody>
</table>
<p>如果想要实现一个将其有效负载存储在 ByteBuf 中的消息对象，那么 ByteBufHolder 将是个不错的选择。</p>
<h2 id="bytebuf分配管理">ByteBuf分配(管理)<a hidden class="anchor" aria-hidden="true" href="#bytebuf分配管理">#</a></h2>
<h3 id="按需分配bytebufallocator-接口">按需分配：ByteBufAllocator 接口<a hidden class="anchor" aria-hidden="true" href="#按需分配bytebufallocator-接口">#</a></h3>
<p>为了降低分配和释放内存的开销，Netty 通过 interface ByteBufAllocator 实现了（ByteBuf 的）池化，它可以用来分配我们所描述过的任意类型的 ByteBuf 实例。使用池化是特定于应用程序的决定，其并不会以任何方式改变 ByteBuf API（的语义）。</p>
<p>表 5-7 列出了 ByteBufAllocator 提供的一些操作。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>buffer() buffer(int initialCapacity); buffer(int initialCapacity, int maxCapacity);</td>
<td>返回一个基于堆或者直接内存 存储的 ByteBuf</td>
</tr>
<tr>
<td>heapBuffer() heapBuffer(int initialCapacity) heapBuffer(int initialCapacity, int maxCapacity)</td>
<td>返回一个基于堆内存存储的 ByteBuf</td>
</tr>
<tr>
<td>directBuffer() directBuffer(int initialCapacity) directBuffer(int initialCapacity, int maxCapacity)</td>
<td>返回一个基于直接内存存储的 ByteBuf</td>
</tr>
<tr>
<td>compositeBuffer() compositeBuffer(int maxNumComponents) compositeDirectBuffer() compositeDirectBuffer(int maxNumComponents); compositeHeapBuffer() compositeHeapBuffer(int maxNumComponents);</td>
<td>返回一个可以通过添加最大到 指定数目的基于堆的或者直接 内存存储的缓冲区来扩展的 CompositeByteBuf</td>
</tr>
<tr>
<td>ioBuffer()</td>
<td>返回一个用于套接字的 I/O 操 作的 ByteBuf</td>
</tr>
</tbody>
</table>
<p>可以通过 Channel（每个都可以有一个不同的 ByteBufAllocator 实例）或者绑定到ChannelHandler
的 ChannelHandlerContext 获取一个到 ByteBufAllocator 的引用。
代码清单 5-14 说明了这两种方法。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-14 获取一个到 ByteBufAllocator 的引用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> obtainingByteBufAllocatorReference(){
</span></span><span style="display:flex;"><span>	Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//从 Channel 获取一个到ByteBufAllocator 的引用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBufAllocator allocator = channel.<span style="color:#007f7f">alloc</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//从 ChannelHandlerContext 获取一个到 ByteBufAllocator 的引用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBufAllocator allocator2 = ctx.<span style="color:#007f7f">alloc</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty提供了两种ByteBufAllocator的实现：PooledByteBufAllocator和UnpooledByteBufAllocator。
前者池化了ByteBuf的实例以提高性能并最大限度地减少内存碎片。此实现使用了一种称为jemalloc的已被大量现代操作系统所采用的高效方法来分配内存。后者的实现不池化ByteBuf实例，并且在每次它被调用时都会返回一个新的实例。虽然Netty默认使用了PooledByteBufAllocator，但这可以很容易地通过ChannelConfigAPI或者在引导你的应用程序时指定一个不同的分配器来更改。</p>
<h3 id="unpooled-缓冲区">Unpooled 缓冲区<a hidden class="anchor" aria-hidden="true" href="#unpooled-缓冲区">#</a></h3>
<p>可能某些情况下，你未能获取一个到 ByteBufAllocator 的引用。对于这种情况，Netty 提供了一个简单的称为 Unpooled 的工具类，它提供了静态的辅助方法来创建未池化的 ByteBuf实例。
表 5-8 列举了这些中最重要的方法。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>buffer() buffer(int initialCapacity) buffer(int initialCapacity, int maxCapacity)</td>
<td>返回一个未池化的基于堆内存存储的 ByteBuf</td>
</tr>
<tr>
<td>directBuffer() directBuffer(int initialCapacity) directBuffer(int initialCapacity, int maxCapacity)</td>
<td>返回一个未池化的基于直接内存存储 的 ByteBuf</td>
</tr>
<tr>
<td>wrappedBuffer()</td>
<td>返回一个包装了给定数据的 ByteBuf</td>
</tr>
<tr>
<td>copiedBuffer()</td>
<td>返回一个复制了给定数据的 ByteBuf</td>
</tr>
</tbody>
</table>
<p>Unpooled 类还使得 ByteBuf 同样可用于那些并不需要 Netty 的其他组件的非网络项目，使得其能得益于高性能的可扩展的缓冲区 API。</p>
<h3 id="bytebufutil-类">ByteBufUtil 类<a hidden class="anchor" aria-hidden="true" href="#bytebufutil-类">#</a></h3>
<p>ByteBufUtil 提供了用于操作 ByteBuf 的静态的辅助方法。因为这个 API 是通用的，并且和池化无关，所以这些方法已然在分配类的外部实现。这些静态方法中最有价值的可能就是 hexdump()方法，它以十六进制的表示形式打印ByteBuf 的内容。这在各种情况下都很有用，例如，出于调试的目的记录 ByteBuf 的内容。十六进制的表示通常会提供一个比字节值的直接表示形式更加有用的日志条目，此外，十六进制的版本还可以很容易地转换回实际的字节表示。另一个有用的方法是 boolean equals(ByteBuf, ByteBuf)，它被用来判断两个 ByteBuf实例的相等性。如果你实现自己的 ByteBuf 子类，你可能会发现 ByteBufUtil 的其他有用方法。</p>
<h2 id="引用计数法">引用计数法<a hidden class="anchor" aria-hidden="true" href="#引用计数法">#</a></h2>
<p>引用计数是一种通过在某个对象所持有的资源不再被其他对象引用时释放该对象所持有的资源来优化内存使用和性能的技术。。Netty 在第 4 版中为 ByteBuf 和 ByteBufHolder 引入了引用计数技术，它们都实现了interface ReferenceCounted。
引用计数法并不复杂，它主要涉及跟踪到某个特定对象的活动引用的数量。一个 ReferenceCounted 实现的实例将通常以活动的引用计数为 1 作为开始。只要引用计数大于 0，就能保证对象不会被释放。当活动引用的数量减少到 0 时，该实例就会被释放。注意，虽然释放的确切语义可能是特定于实现的，但是至少已经释放的对象应该不可再用了。
引用计数对于池化实现（如 PooledByteBufAllocator）来说是至关重要的，它降低了内存分配的开销。代码清单 5-15 和代码清单 5-16 展示了相关的示例。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-15 引用计数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> referenceCounting(){
</span></span><span style="display:flex;"><span>	Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//从 Channel 获取ByteBufAllocator
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBufAllocator allocator = channel.<span style="color:#007f7f">alloc</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//从 ByteBufAllocator分配一个 ByteBuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ByteBuf buffer = allocator.<span style="color:#007f7f">directBuffer</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//检查引用计数是否为预期的 1
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">assert</span> buffer.<span style="color:#007f7f">refCnt</span>() == <span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 5-16 释放引用计数的对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> releaseReferenceCountedObject(){
</span></span><span style="display:flex;"><span>	ByteBuf buffer = BYTE_BUF_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference form somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//减少到该对象的活动引用。当减少到 0 时，该对象被释放，并且该方法返回 true
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">boolean</span> released = buffer.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>试图访问一个已经被释放的引用计数的对象，将会导致一个 IllegalReferenceCountException。
注意，一个特定的（ReferenceCounted 的实现）类，可以用它自己的独特方式来定义它的引用计数规则。例如，我们可以设想一个类，其 release()方法的实现总是将引用计数设为零，而不用关心它的当前值，从而一次性地使所有的活动引用都失效。
谁负责释放：一般来说，是由最后访问（引用计数）对象的那一方来负责将它释放。</p>
<h1 id="channelhandler和channelpipeline">ChannelHandler和ChannelPipeline<a hidden class="anchor" aria-hidden="true" href="#channelhandler和channelpipeline">#</a></h1>
<p>在上一章中你学习了Netty的数据容器ByteBuf。当我们在本章中探讨 Netty 的数据流以及处理组件时，我们将基于已经学过的东西，并且你将开始看到框架的重要元素都结合到了一起。你已经知道，可以在 ChannelPipeline 中将 ChannelHandler 链接在一起以组织处理逻辑。我们将会研究涉及这些类的各种用例，以及一个重要的关系—ChannelHandlerContext。理解所有这些组件之间的交互对于通过 Netty 构建模块化的、可重用的实现至关重要。</p>
<h2 id="channelhandler家族">ChannelHandler家族<a hidden class="anchor" aria-hidden="true" href="#channelhandler家族">#</a></h2>
<h3 id="channel的生命周期">Channel的生命周期<a hidden class="anchor" aria-hidden="true" href="#channel的生命周期">#</a></h3>
<table>
<thead>
<tr>
<th>状 态</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>ChannelUnregistered</td>
<td>Channel 已经被创建，但还未注册到 EventLoop</td>
</tr>
<tr>
<td>ChannelRegistered</td>
<td>Channel 已经被注册到了 EventLoop</td>
</tr>
<tr>
<td>ChannelActive</td>
<td>Channel 处于活动状态（已经连接到它的远程节点）。它现在可以接收和发送数据了</td>
</tr>
<tr>
<td>ChannelInactive</td>
<td>Channel 没有连接到远程节点</td>
</tr>
</tbody>
</table>
<p>当这些状态发生改变时，将会生成对应的事件。
这些事件将会被转发给 ChannelPipeline 中的 ChannelHandler，其可以随后对它们做出响应。
ChannelRegistered-&gt;ChannelActive-&gt;ChannelInactive-&gt;ChannelUnregistered</p>
<h3 id="channelhandler的生命周期">ChannelHandler的生命周期<a hidden class="anchor" aria-hidden="true" href="#channelhandler的生命周期">#</a></h3>
<table>
<thead>
<tr>
<th>状 态</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>handlerAdded</td>
<td>当把 ChannelHandler 添加到 ChannelPipeline 中时被调用</td>
</tr>
<tr>
<td>handlerRemoved</td>
<td>当从 ChannelPipeline 中移除 ChannelHandler 时被调用</td>
</tr>
<tr>
<td>exceptionCaught</td>
<td>当处理过程中在 ChannelPipeline 中有错误产生时被调用</td>
</tr>
</tbody>
</table>
<p>在 ChannelHandler被添加到 ChannelPipeline 中或者被从 ChannelPipeline 中移除时会调用这些操作。这些方法中的每一个都接受一个 ChannelHandlerContext 参数。
Netty 定义了下面两个重要的 ChannelHandler 子接口：
ChannelInboundHandler——处理入站数据以及各种状态变化；
ChannelOutboundHandler——处理出站数据并且允许拦截所有的操作。</p>
<h3 id="channelinboundhandler-接口">ChannelInboundHandler 接口<a hidden class="anchor" aria-hidden="true" href="#channelinboundhandler-接口">#</a></h3>
<table>
<thead>
<tr>
<th>类 型</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>channelRegistered</td>
<td>当 Channel 已经注册到它的 EventLoop 并且能够处理 I/O 时被调用</td>
</tr>
<tr>
<td>channelUnregistered</td>
<td>当 Channel 从它的 EventLoop 注销并且无法处理任何 I/O 时被调用</td>
</tr>
<tr>
<td>channelActive</td>
<td>当 Channel 处于活动状态时被调用；Channel 已经连接/绑定并且已经就绪</td>
</tr>
<tr>
<td>channelInactive</td>
<td>当 Channel 离开活动状态并且不再连接它的远程节点时被调用</td>
</tr>
<tr>
<td>channelReadComplete</td>
<td>当Channel上的一个读操作完成时被调用(注：当所有可读的字节都已经从 Channel 中读取之后，将会调用该回调方法；所以，可能在 channelReadComplete()被调用之前看到多次调用 channelRead(&hellip;))</td>
</tr>
<tr>
<td>channelRead</td>
<td>当从 Channel 读取数据时被调用</td>
</tr>
<tr>
<td>ChannelWritability-Changed</td>
<td>当 Channel 的可写状态发生改变时被调用。用户可以确保写操作不会完成 得太快（以避免发生 OutOfMemoryError）或者可以在 Channel 变为再 次可写时恢复写入。可以通过调用 Channel 的 isWritable()方法来检测 Channel 的可写性。与可写性相关的阈值可以通过 Channel.config(). setWriteHighWaterMark()和 Channel.config().setWriteLowWaterMark()方法来设置</td>
</tr>
<tr>
<td>userEventTriggered</td>
<td>当 ChannelnboundHandler.fireUserEventTriggered()方法被调 用时被调用，因为一个 POJO 被传经了 ChannelPipeline</td>
</tr>
</tbody>
</table>
<p>这些方法将会在数据被接收时或者与其对应的 Channel 状态发生改变时被调用。正如我们前面所提到的，这些方法和 Channel 的生命周期密切相关。
当某个 ChannelInboundHandler 的实现重写 channelRead()方法时，它将负责显式地释放与池化的 ByteBuf 实例相关的内存。Netty 为此提供了一个实用方法 ReferenceCountUtil.release()，如代码清单 6-1 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * 代码清单 6-1 释放消息资源
</span></span><span style="display:flex;"><span> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@Sharable
</span></span><span style="display:flex;"><span>//扩展了 ChannelInboundHandlerAdapter
</span></span><span style="display:flex;"><span>public class DiscardHandler extends ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    public void channelRead(ChannelHandlerContext ctx, Object msg) {
</span></span><span style="display:flex;"><span>        //丢弃已接收的消息
</span></span><span style="display:flex;"><span>        ReferenceCountUtil.release(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty 将使用 WARN 级别的日志消息记录未释放的资源，使得可以非常简单地在代码中发现违规的实例。但是以这种方式管理资源可能很繁琐。一个更加简单的方式是使用 SimpleChannelInboundHandler。
代码清单 6-2 是代码清单 6-1 的一个变体，说明了这一点。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * 代码清单 6-2 使用 SimpleChannelInboundHandler
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@Sharable
</span></span><span style="display:flex;"><span>//扩展了SimpleChannelInboundHandler
</span></span><span style="display:flex;"><span>public class SimpleDiscardHandler extends SimpleChannelInboundHandler&lt;Object&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    public void channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        Object msg) {
</span></span><span style="display:flex;"><span>        //不需要任何显式的资源释放
</span></span><span style="display:flex;"><span>        // No need to do anything special
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于 SimpleChannelInboundHandler 会自动释放资源，所以你不应该存储指向任何消息的引用供将来使用，因为这些引用都将会失效。</p>
<h3 id="channeloutboundhandler-接口">ChannelOutboundHandler 接口<a hidden class="anchor" aria-hidden="true" href="#channeloutboundhandler-接口">#</a></h3>
<p>出站操作和数据将由 ChannelOutboundHandler 处理。
它的方法将被 Channel、ChannelPipeline 以及 ChannelHandlerContext 调用。
ChannelOutboundHandler 的一个强大的功能是可以按需推迟操作或者事件，这使得可以通过一些复杂的方法来处理请求。例如，如果到远程节点的写入被暂停了，那么你可以推迟冲刷操作并在稍后继续。</p>
<table>
<thead>
<tr>
<th>类 型</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>bind(ChannelHandlerContext, SocketAddress,ChannelPromise)</td>
<td>当请求将 Channel 绑定到本地地址时被调用</td>
</tr>
<tr>
<td>connect(ChannelHandlerContext, SocketAddress,SocketAddress,ChannelPromise)</td>
<td>当请求将 Channel 连接到远程节点时被调用</td>
</tr>
<tr>
<td>disconnect(ChannelHandlerContext, ChannelPromise)</td>
<td>当请求将 Channel 从远程节点断开时被调用</td>
</tr>
<tr>
<td>close(ChannelHandlerContext,ChannelPromise)</td>
<td>当请求关闭 Channel 时被调用</td>
</tr>
<tr>
<td>deregister(ChannelHandlerContext, ChannelPromise)</td>
<td>当请求将 Channel 从它的 EventLoop 注销 时被调用</td>
</tr>
<tr>
<td>read(ChannelHandlerContext)</td>
<td>当请求从 Channel 读取更多的数据时被调用</td>
</tr>
<tr>
<td>flush(ChannelHandlerContext)</td>
<td>当请求通过 Channel 将入队数据冲刷到远程 节点时被调用</td>
</tr>
<tr>
<td>write(ChannelHandlerContext,Object, ChannelPromise)</td>
<td>当请求通过 Channel 将数据写到远程节点时 被调用</td>
</tr>
</tbody>
</table>
<p>ChannelPromise与ChannelFuture ChannelOutboundHandler中的大部分方法都需要一个ChannelPromise参数，以便在操作完成时得到通知。ChannelPromise是ChannelFuture的一个子类，其定义了一些可写的方法，如setSuccess()和setFailure()，从而使ChannelFuture不可变。</p>
<h3 id="channelhandler-适配器">ChannelHandler 适配器<a hidden class="anchor" aria-hidden="true" href="#channelhandler-适配器">#</a></h3>
<p>你可以使用 ChannelInboundHandlerAdapter 和 ChannelOutboundHandlerAdapter类作为自己的
ChannelHandler 的起始点。这两个适配器分别提供了 ChannelInboundHandler和
ChannelOutboundHandler 的基本实现。通过扩展抽象类 ChannelHandlerAdapter，它们获得了它们共同的超接口 ChannelHandler 的方法。生成的类的层次结构如图 6-2 所示。
<img loading="lazy" src="39.png" alt=""  />

ChannelHandlerAdapter 还提供了实用方法 isSharable()。如果其对应的实现被标注为 Sharable，那么这个方法将返回 true，表示它可以被添加到多个 ChannelPipeline中。你要想在自己的
ChannelHandler 中使用这些适配器类，只需要简单地扩展它们，并且重写那些你想要自定义的方法。</p>
<h3 id="资源管理">资源管理<a hidden class="anchor" aria-hidden="true" href="#资源管理">#</a></h3>
<p>每当通过调用 ChannelInboundHandler.channelRead()或者 ChannelOutboundHandler.write()方法来处理数据时，你都需要确保没有任何的资源泄漏。你可能还记得在前面的章节中所提到的，Netty 使用引用计数来处理池化的 ByteBuf。所以在完全使用完某个ByteBuf 后，调整其引用计数是很重要的。为了帮助你诊断潜在的（资源泄漏）问题，Netty提供了class ResourceLeakDetector（其利用了 JDK 提供的 <code>PhantomReference&lt;T&gt;</code>类来实现这一点）。它将对你应用程序的缓冲区分配做大约 1%的采样来检测内存泄露，相关的开销是非常小的。如果检测到了内存泄露，将会产生类似于下面的日志消息：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>LEAK: ByteBuf.release() was not called before it&#39;s garbage-collected. Enable
</span></span><span style="display:flex;"><span>advanced leak reporting to find out where the leak occurred. To enable
</span></span><span style="display:flex;"><span>advanced leak reporting, specify the JVM option
</span></span><span style="display:flex;"><span>&#39;-Dio.netty.leakDetectionLevel=ADVANCED&#39; or call
</span></span><span style="display:flex;"><span>ResourceLeakDetector.setLevel().
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty 目前定义了 4 种泄漏检测级别，如表 6-5 所示。</p>
<table>
<thead>
<tr>
<th>级 别</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>DISABLED</td>
<td>禁用泄漏检测。只有在详尽的测试之后才应设置为这个值</td>
</tr>
<tr>
<td>SIMPLE</td>
<td>使用 1%的默认采样率检测并报告任何发现的泄露。这是默认级别，适合绝大部分的情况</td>
</tr>
<tr>
<td>ADVANCED</td>
<td>使用默认的采样率，报告所发现的任何的泄露以及对应的消息被访问的位置</td>
</tr>
<tr>
<td>PARANOID</td>
<td>类似于 ADVANCED，但是其将会对每次（对消息的）访问都进行采样。这对性能将会有很 大的影响，应该只在调试阶段使用</td>
</tr>
<tr>
<td>泄露检测级别可以通过将下面的 Java 系统属性设置为表中的一个值来定义：</td>
<td></td>
</tr>
<tr>
<td><code>java -Dio.netty.leakDetectionLevel=ADVANCED</code></td>
<td></td>
</tr>
<tr>
<td>如果带着该 JVM 选项重新启动你的应用程序，你将看到自己的应用程序最近被泄漏的缓冲区被访问的位置。</td>
<td></td>
</tr>
<tr>
<td>下面是一个典型的由单元测试产生的泄漏报告：</td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Running io.netty.handler.codec.xml.XmlFrameDecoderTest
</span></span><span style="display:flex;"><span>15:03:36.886 [main] ERROR io.netty.util.ResourceLeakDetector - LEAK:
</span></span><span style="display:flex;"><span>ByteBuf.release() was not called before it&#39;s garbage-collected.
</span></span><span style="display:flex;"><span>Recent access records: 1
</span></span><span style="display:flex;"><span>#1: io.netty.buffer.AdvancedLeakAwareByteBuf.toString(
</span></span><span style="display:flex;"><span>AdvancedLeakAwareByteBuf.java:697)
</span></span><span style="display:flex;"><span>io.netty.handler.codec.xml.XmlFrameDecoderTest.testDecodeWithXml(
</span></span><span style="display:flex;"><span>XmlFrameDecoderTest.java:157)
</span></span><span style="display:flex;"><span>io.netty.handler.codec.xml.XmlFrameDecoderTest.testDecodeWithTwoMessages(
</span></span><span style="display:flex;"><span>XmlFrameDecoderTest.java:133)
</span></span></code></pre></td></tr></table>
</div>
</div><p>实现 ChannelInboundHandler.channelRead()和 ChannelOutboundHandler.write()方法时，应该如何使用这个诊断工具来防止泄露呢？让我们看看你的 channelRead()操作直接消费入站消息的情况；也就是说，它不会通过调用 ChannelHandlerContext.fireChannelRead()方法将入站消息转发给下一个
ChannelInboundHandler。代码清单 6-3 展示了如何释放消息。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * 代码清单 6-3 消费并释放入站消息
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@Sharable
</span></span><span style="display:flex;"><span>//扩展了ChannelInboundandlerAdapter
</span></span><span style="display:flex;"><span>public class DiscardInboundHandler extends ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    public void channelRead(ChannelHandlerContext ctx, Object msg) {
</span></span><span style="display:flex;"><span>        //通过调用 ReferenceCountUtil.release()方法释放资源
</span></span><span style="display:flex;"><span>        ReferenceCountUtil.release(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>消费入站消息的简单方式：由于消费入站数据是一项常规任务，所以 Netty 提供了一个特殊的被
称为 SimpleChannelInboundHandler 的 ChannelInboundHandler 实现。这个实现会在消息被
channelRead0()方法消费之后自动释放消息。
在出站方向这边，如果你处理了 write()操作并丢弃了一个消息，那么你也应该负责释放它。
代码清单 6-4 展示了一个丢弃所有的写入数据的实现。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * 代码清单 6-4 丢弃并释放出站消息
</span></span><span style="display:flex;"><span> *
</span></span><span style="display:flex;"><span> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>@Sharable
</span></span><span style="display:flex;"><span>//扩展了ChannelOutboundHandlerAdapter
</span></span><span style="display:flex;"><span>public class DiscardOutboundHandler extends ChannelOutboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {
</span></span><span style="display:flex;"><span>        //通过使用 ReferenceCountUtil.realse(...)方法释放资源
</span></span><span style="display:flex;"><span>        ReferenceCountUtil.release(msg);
</span></span><span style="display:flex;"><span>        //通知 ChannelPromise数据已经被处理了
</span></span><span style="display:flex;"><span>        promise.setSuccess();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>重要的是，不仅要释放资源，还要通知 ChannelPromise。否则可能会出现 ChannelFutureListener
收不到某个消息已经被处理了的通知的情况。总之，如果一个消息被消费或者丢弃了，并且没有传递给ChannelPipeline 中的下一个ChannelOutboundHandler，那么用户就有责任调用
ReferenceCountUtil.release()。如果消息到达了实际的传输层，那么当它被写入时或者 Channel 关闭时，都将被自动释放。</p>
<h2 id="channelpipeline-接口">ChannelPipeline 接口<a hidden class="anchor" aria-hidden="true" href="#channelpipeline-接口">#</a></h2>
<p>ChannelPipeline是一个拦截流经Channel的入站和出站事件的ChannelHandler 实例链。
这些 ChannelHandler 之间的交互，组成了一个应用程序数据和事件处理逻辑的核心。
每一个新创建的 Channel 都将会被分配一个新的 ChannelPipeline。这项关联是永久性的；
Channel 既不能附加另外一个 ChannelPipeline，也不能分离其当前的。在 Netty 组件的生命周期中，这是一项固定的操作，不需要开发人员的任何干预。
根据事件的起源，事件将会被 ChannelInboundHandler 或者 ChannelOutboundHandler处理。随后，通过调用 ChannelHandlerContext 实现，它将被转发给同一超类型的下一个ChannelHandler。</p>
<p>ChannelHandlerContext使得ChannelHandler能够和它的ChannelPipeline以及其他的
ChannelHandler 交互。 ChannelHandler 可以通知其所属的 ChannelPipeline 中的下一 个ChannelHandler，甚至可以动态修改它所属的ChannelPipeline中的 ChannelHandler 的编排。</p>
<p>ChannelHandlerContext 具有丰富的用于处理事件和执行 I/O 操作的 API。6.3 节将提供有关ChannelHandlerContext 的更多内容。</p>
<p>图 6-3 展示了一个典型的同时具有入站和出站 ChannelHandler 的 ChannelPipeline 的布局，并且印证了我们之前的关于 ChannelPipeline 主要由一系列的 ChannelHandler 所组成的说法。ChannelPipeline 还提供了通过 ChannelPipeline 本身传播事件的方法。如果一个入站事件被触发，它将被从 ChannelPipeline 的头部开始一直被传播到 Channel Pipeline 的尾端。在图 6-3 中，一个出站 I/O 事件将从ChannelPipeline 的最右边开始，然后向左传播。
<img loading="lazy" src="40.png" alt=""  />
</p>
<p>ChannelPipeline 相对论：
你可能会说，从事件途经 ChannelPipeline 的角度来看，ChannelPipeline 的头部和尾端取决于该事件是入站的还是出站的。然而 Netty 总是将 ChannelPipeline 的入站口（图 6-3 中的左侧）作为头部，而将出站口（该图的右侧）作为尾端。
当你完成了通过调用 ChannelPipeline.add*()方法将入站处理器（ChannelInboundHandler）和出站处理器（ ChannelOutboundHandler ）混合添加到 ChannelPipeline 之后，每一个ChannelHandler 从头部到尾端的顺序位置正如同我们方才所定义它们的一样。因此，如果你将图 6-3 中的处理器（ChannelHandler）从左到右进行编号，那么第一个被入站事件看到的 ChannelHandler 将是1，而第一个被出站事件看到的 ChannelHandler 将是 5。</p>
<p>在 ChannelPipeline 传播事件时，它会测试 ChannelPipeline 中的下一个 ChannelHandler 的类型是否和事件的运动方向相匹配。如果不匹配，ChannelPipeline 将跳过该ChannelHandler 并前进到下一个，直到它找到和该事件所期望的方向相匹配的为止。（当然，ChannelHandler 也可以同时实现ChannelInboundHandler 接口和 ChannelOutboundHandler 接口。）</p>
<h3 id="修改-channelpipeline">修改 ChannelPipeline<a hidden class="anchor" aria-hidden="true" href="#修改-channelpipeline">#</a></h3>
<p>ChannelHandler 可以通过添加、删除或者替换其他的 ChannelHandler 来实时地修改ChannelPipeline的布局。
（它也可以将它自己从 ChannelPipeline 中移除。）这是 ChannelHandler 最重要的能力之一，所以我们将仔细地来看看它是如何做到的。表 6-6 列出了相关的方法。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>AddFirstaddBefore addAfteraddLast</td>
<td>将一个ChannelHandler 添加到ChannelPipeline 中</td>
</tr>
<tr>
<td>remove</td>
<td>将一个ChannelHandler 从ChannelPipeline 中移除</td>
</tr>
<tr>
<td>replace</td>
<td>将 ChannelPipeline 中的一个 ChannelHandler 替换为另一个 ChannelHandler</td>
</tr>
<tr>
<td>代码清单 6-5 展示了这些方法的使用。</td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 6-5 修改 ChannelPipeline
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ModifyChannelPipeline {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ChannelPipeline CHANNEL_PIPELINE_FROM_SOMEWHERE = DUMMY_INSTANCE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 6-5 修改 ChannelPipeline
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> modifyPipeline() {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = CHANNEL_PIPELINE_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference to pipeline;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//创建一个 FirstHandler 的实例
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        FirstHandler firstHandler = <span style="color:#fff;font-weight:bold">new</span> FirstHandler();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将该实例作为&#34;handler1&#34;添加到ChannelPipeline 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;handler1&#34;</span>, firstHandler);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将一个 SecondHandler的实例作为&#34;handler2&#34;添加到 ChannelPipeline的第一个槽中。这意味着它将被放置在已有的&#34;handler1&#34;之前
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addFirst</span>(<span style="color:#0ff;font-weight:bold">&#34;handler2&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> SecondHandler());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将一个 ThirdHandler 的实例作为&#34;handler3&#34;添加到 ChannelPipeline 的最后一个槽中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;handler3&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> ThirdHandler());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//通过名称移除&#34;handler3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">remove</span>(<span style="color:#0ff;font-weight:bold">&#34;handler3&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//通过引用移除FirstHandler（它是唯一的，所以不需要它的名称）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">remove</span>(firstHandler);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将 SecondHandler(&#34;handler2&#34;)替换为 FourthHandler:&#34;handler4&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;handler2&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;handler4&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> FourthHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> FirstHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelHandlerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> SecondHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelHandlerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ThirdHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelHandlerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> FourthHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelHandlerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>稍后，你将看到，重组 ChannelHandler 的这种能力使我们可以用它来轻松地实现极其灵活的逻辑。</p>
<p>ChannelHandler 的执行和阻塞：
通常 ChannelPipeline 中的每一个 ChannelHandler 都是通过它的 EventLoop（I/O 线程）来处
理传递给它的事件的。所以至关重要的是不要阻塞这个线程，因为这会对整体的 I/O 处理产生负面的影响。但有时可能需要与那些使用阻塞 API 的遗留代码进行交互。对于这种情况，ChannelPipeline 有一些接受一个 EventExecutorGroup 的 add()方法。如果一个事件被传递给一个自定义的 EventExecutor-Group，它将被包含在这个 EventExecutorGroup 中的某个 EventExecutor 所处理，从而被从该Channel 本身的EventLoop 中移除。对于这种用例，Netty 提供了一个叫 DefaultEventExecutorGroup 的默认实现。
除了这些操作，还有别的通过类型或者名称来访问 ChannelHandler 的方法。这些方法都列在了表 6-7 中。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>get</td>
<td>通过类型或者名称返回 ChannelHandler</td>
</tr>
<tr>
<td>context</td>
<td>返回和 ChannelHandler 绑定的 ChannelHandlerContext</td>
</tr>
<tr>
<td>names</td>
<td>返回 ChannelPipeline 中所有 ChannelHandler 的名称</td>
</tr>
</tbody>
</table>
<h3 id="触发事件">触发事件<a hidden class="anchor" aria-hidden="true" href="#触发事件">#</a></h3>
<p>ChannelPipeline 的 API 公开了用于调用入站和出站操作的附加方法。表 6-8 列出了入站操作，
用于通知 ChannelInboundHandler 在 ChannelPipeline 中所发生的事件。</p>
<table>
<thead>
<tr>
<th>方 法 名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>fireChannelRegistered</td>
<td>调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelRegistered(ChannelHandlerContext)方法</td>
</tr>
<tr>
<td>fireChannelUnregistered</td>
<td>调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelUnregistered(ChannelHandlerContext)方法</td>
</tr>
<tr>
<td>fireChannelActive</td>
<td>调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelActive(ChannelHandlerContext)方法</td>
</tr>
<tr>
<td>fireChannelInactive</td>
<td>调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelInactive(ChannelHandlerContext)方法</td>
</tr>
<tr>
<td>fireExceptionCaught</td>
<td>调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 exceptionCaught(ChannelHandlerContext, Throwable)方法</td>
</tr>
<tr>
<td>fireUserEventTriggered</td>
<td>调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 userEventTriggered(ChannelHandlerContext, Object)方法</td>
</tr>
<tr>
<td>fireChannelRead</td>
<td>调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelRead(ChannelHandlerContext, Object msg)方法</td>
</tr>
<tr>
<td>fireChannelReadComplete</td>
<td>调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelReadComplete(ChannelHandlerContext)方法</td>
</tr>
<tr>
<td>fireChannelWritability-Changed</td>
<td>调用 ChannelPipeline 中下一个 ChannelInboundHandler 的 channelWritabilityChanged(ChannelHandlerContext)方法</td>
</tr>
</tbody>
</table>
<p>在出站这边，处理事件将会导致底层的套接字上发生一系列的动作。表 6-9 列出了 ChannelPipeline API 的出站操作。</p>
<table>
<thead>
<tr>
<th>方 法 名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>bind</td>
<td>将 Channel 绑定到一个本地地址，这将调用 ChannelPipeline 中的下一个 ChannelOutboundHandler 的 bind(ChannelHandlerContext, SocketAddress, ChannelPromise)方法</td>
</tr>
<tr>
<td>connect</td>
<td>将 Channel 连接到一个远程地址，这将调用 ChannelPipeline 中的下一个 ChannelOutboundHandler 的 connect(ChannelHandlerContext, SocketAddress, ChannelPromise)方法</td>
</tr>
<tr>
<td>disconnect</td>
<td>将Channel 断开连接。这将调用ChannelPipeline 中的下一个ChannelOutboundHandler 的 disconnect(ChannelHandlerContext, Channel Promise)方法</td>
</tr>
<tr>
<td>close</td>
<td>将 Channel 关闭。这将调用 ChannelPipeline 中的下一个 ChannelOutboundHandler 的 close(ChannelHandlerContext, ChannelPromise)方法</td>
</tr>
<tr>
<td>deregister</td>
<td>将 Channel 从它先前所分配的 EventExecutor（即 EventLoop）中注销。这将调 用 ChannelPipeline 中的下一个 ChannelOutboundHandler 的 deregister (ChannelHandlerContext, ChannelPromise)方法</td>
</tr>
<tr>
<td>flush</td>
<td>冲刷Channel所有挂起的写入。这将调用ChannelPipeline中的下一个ChannelOutboundHandler 的 flush(ChannelHandlerContext)方法</td>
</tr>
<tr>
<td>write</td>
<td>将消息写入 Channel。这将调用 ChannelPipeline 中的下一个 ChannelOutboundHandler的write(ChannelHandlerContext, Object msg, ChannelPromise)方法。注意：这并不会将消息写入底层的 Socket，而只会将它放入队列中。 要将它写入 Socket，需要调用 flush()或者 writeAndFlush()方法</td>
</tr>
<tr>
<td>writeAndFlush</td>
<td>这是一个先调用 write()方法再接着调用 flush()方法的便利方法</td>
</tr>
<tr>
<td>read</td>
<td>请求从 Channel 中读取更多的数据。这将调用 ChannelPipeline 中的下一个 ChannelOutboundHandler 的 read(ChannelHandlerContext)方法</td>
</tr>
</tbody>
</table>
<p>总结：</p>
<ul>
<li>ChannelPipeline 保存了与 Channel 相关联的 ChannelHandler；</li>
<li>ChannelPipeline 可以根据需要，通过添加或者删除 ChannelHandler 来动态地修改；</li>
<li>ChannelPipeline 有着丰富的 API 用以被调用，以响应入站和出站事件。</li>
</ul>
<h2 id="channelhandlercontext-接口">ChannelHandlerContext 接口<a hidden class="anchor" aria-hidden="true" href="#channelhandlercontext-接口">#</a></h2>
<p>ChannelHandlerContextz代表了 ChannelHandler 和 ChannelPipeline 之间的关联。
每当有 ChannelHandler 添加到 ChannelPipeline 中时，都会创建 ChannelHandlerContext。
ChannelHandlerContext 的主要功能是管理它所关联的 ChannelHandler 和在同一个 ChannelPipeline中的其他 ChannelHandler 之间的交互。
ChannelHandlerContext 有很多的方法，其中一些方法也存在于 Channel 和 ChannelPipeline 本身上，但是有一点重要的不同。如果调用 Channel 或者 ChannelPipeline 上的这些方法，它们将沿着整个ChannelPipeline 进行传播。而调用位于 ChannelHandlerContext上的相同方法，则将从当前所关联的ChannelHandler 开始，并且只会传播给位于该ChannelPipeline 中的下一个能够处理该事件的 ChannelHandler。</p>
<table>
<thead>
<tr>
<th>方 法 名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>alloc</td>
<td>返回和这个实例相关联的Channel 所配置的 ByteBufAllocator</td>
</tr>
<tr>
<td>bind</td>
<td>绑定到给定的 SocketAddress，并返回 ChannelFuture</td>
</tr>
<tr>
<td>channel</td>
<td>返回绑定到这个实例的 Channel</td>
</tr>
<tr>
<td>close</td>
<td>关闭 Channel，并返回 ChannelFuture</td>
</tr>
<tr>
<td>connect</td>
<td>连接给定的 SocketAddress，并返回 ChannelFuture</td>
</tr>
<tr>
<td>deregister</td>
<td>从之前分配的 EventExecutor 注销，并返回 ChannelFuture</td>
</tr>
<tr>
<td>executor</td>
<td>返回调度事件的 EventExecutor</td>
</tr>
<tr>
<td>fireChannelActive</td>
<td>触发对下一个 ChannelInboundHandler 上的 channelActive()方法（已连接）的调用</td>
</tr>
<tr>
<td>fireChannelInactive</td>
<td>触发对下一个 ChannelInboundHandler 上的 channelInactive()方法（已关闭）的调用</td>
</tr>
<tr>
<td>fireChannelRead</td>
<td>触发对下一个 ChannelInboundHandler 上的 channelRead()方法（已接收的消息）的调用</td>
</tr>
<tr>
<td>fireChannelReadComplete</td>
<td>触发对下一个ChannelInboundHandler上的 channelReadComplete()方法的调用</td>
</tr>
<tr>
<td>fireChannelRegistered</td>
<td>触发对下一个 ChannelInboundHandler 上的 fireChannelRegistered()方法的调用</td>
</tr>
<tr>
<td>fireChannelUnregistered</td>
<td>触发对下一个 ChannelInboundHandler 上的 fireChannelUnregistered()方法的调用</td>
</tr>
<tr>
<td>fireChannelWritabilityChanged</td>
<td>触发对下一个 ChannelInboundHandler 上的 fireChannelWritabilityChanged()方法的调用</td>
</tr>
<tr>
<td>fireExceptionCaught</td>
<td>触发对下一个 ChannelInboundHandler 上的 fireExceptionCaught(Throwable)方法的调用</td>
</tr>
<tr>
<td>fireUserEventTriggered</td>
<td>触发对下一个 ChannelInboundHandler 上的 fireUserEventTriggered(Object evt)方法的调用</td>
</tr>
<tr>
<td>handler</td>
<td>返回绑定到这个实例的 ChannelHandler</td>
</tr>
<tr>
<td>isRemoved</td>
<td>如果所关联的 ChannelHandler 已经被从 ChannelPipeline 中移除则返回 true</td>
</tr>
<tr>
<td>name</td>
<td>返回这个实例的唯一名称</td>
</tr>
<tr>
<td>pipeline</td>
<td>返回这个实例所关联的 ChannelPipeline</td>
</tr>
<tr>
<td>read</td>
<td>将数据从Channel读取到第一个入站缓冲区；如果读取成功则触发一个channelRead事件，并（在最后一个消息被读取完成后） 通 知 ChannelInboundHandler 的 channelReadComplete (ChannelHandlerContext)方法。通过配合 ChannelConfig.setAutoRead(boolean autoRead)方法，可以实现反应式系统的特性 之一回压（back-pressure）</td>
</tr>
<tr>
<td>write</td>
<td>通过这个实例写入消息并经过 ChannelPipeline</td>
</tr>
<tr>
<td>writeAndFlush</td>
<td>通过这个实例写入并冲刷消息并经过 ChannelPipeline</td>
</tr>
</tbody>
</table>
<p>当使用 ChannelHandlerContext 的 API 的时候，请牢记以下两点：</p>
<ul>
<li>ChannelHandlerContext 和 ChannelHandler 之间的关联（绑定）是永远不会改变的，所以缓存对它的引用是安全的；</li>
<li>如同我们在本节开头所解释的一样，相对于其他类的同名方法，ChannelHandler Context的方法将产生更短的事件流，应该尽可能地利用这个特性来获得最大的性能。</li>
</ul>
<h3 id="使用-channelhandlercontext">使用 ChannelHandlerContext<a hidden class="anchor" aria-hidden="true" href="#使用-channelhandlercontext">#</a></h3>
<p>在这一节中我们将讨论 ChannelHandlerContext 的用法，以及存在于 ChannelHandlerContext、
Channel 和 ChannelPipeline 上的方法的行为。图 6-4 展示了它们之间的关系。
<img loading="lazy" src="41.png" alt=""  />
</p>
<p>在代码清单 6-6 中，将通过 ChannelHandlerContext 获取到 Channel 的引用。调用
Channel 上的 write()方法将会导致写入事件从尾端到头部地流经 ChannelPipeline。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * 代码清单 6-6 从 ChannelHandlerContext 访问 Channel
</span></span><span style="display:flex;"><span> * */
</span></span><span style="display:flex;"><span>public static void writeViaChannel() {
</span></span><span style="display:flex;"><span>	ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; //get reference form somewhere
</span></span><span style="display:flex;"><span>	//获取到与 ChannelHandlerContext相关联的 Channel 的引用
</span></span><span style="display:flex;"><span>	Channel channel = ctx.channel();
</span></span><span style="display:flex;"><span>	//通过 Channel 写入缓冲区
</span></span><span style="display:flex;"><span>	channel.write(Unpooled.copiedBuffer(&#34;Netty in Action&#34;, CharsetUtil.UTF_8));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码清单 6-7 展示了一个类似的例子，但是这一次是写入 ChannelPipeline。我们再次看
到，（到 ChannelPipline 的）引用是通过 ChannelHandlerContext 获取的。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * 代码清单 6-7 通过 ChannelHandlerContext 访问 ChannelPipeline
</span></span><span style="display:flex;"><span> * */
</span></span><span style="display:flex;"><span>public static void writeViaChannelPipeline() {
</span></span><span style="display:flex;"><span>	ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; //get reference form somewhere
</span></span><span style="display:flex;"><span>	//获取到与 ChannelHandlerContext相关联的 ChannelPipeline 的引用
</span></span><span style="display:flex;"><span>	ChannelPipeline pipeline = ctx.pipeline(); //get reference form somewhere
</span></span><span style="display:flex;"><span>	//通过 ChannelPipeline写入缓冲区
</span></span><span style="display:flex;"><span>	pipeline.write(Unpooled.copiedBuffer(&#34;Netty in Action&#34;, CharsetUtil.UTF_8));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如同在图 6-5 中所能够看到的一样，代码清单 6-6 和代码清单 6-7 中的事件流是一样的。重要的是要注意到，虽然被调用的 Channel 或 ChannelPipeline 上的 write()方法将一直传播事件通过整个
ChannelPipeline，但是在 ChannelHandler 的级别上，事件从一个 ChannelHandler到下一个
ChannelHandler 的移动是由 ChannelHandlerContext 上的调用完成的。
<img loading="lazy" src="42.png" alt=""  />
</p>
<p>为什么会想要从 ChannelPipeline 中的某个特定点开始传播事件呢？</p>
<ul>
<li>为了减少将事件传经对它不感兴趣的 ChannelHandler 所带来的开销。</li>
<li>为了避免将事件传经那些可能会对它感兴趣的 ChannelHandler。
要想调用从某个特定的 ChannelHandler 开始的处理过程，必须获取到在（ChannelPipeline）该
ChannelHandler 之前的 ChannelHandler 所关联的 ChannelHandlerContext。这个 ChannelHandlerContext将调用和它所关联的 ChannelHandler 之后的ChannelHandler。</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/**
</span></span><span style="display:flex;"><span> * 代码清单 6-8 调用 ChannelHandlerContext 的 write()方法
</span></span><span style="display:flex;"><span> * */
</span></span><span style="display:flex;"><span>public static void writeViaChannelHandlerContext() {
</span></span><span style="display:flex;"><span>	//获取到 ChannelHandlerContext 的引用
</span></span><span style="display:flex;"><span>	ChannelHandlerContext ctx = CHANNEL_HANDLER_CONTEXT_FROM_SOMEWHERE; //get reference form somewhere;
</span></span><span style="display:flex;"><span>	//write()方法将把缓冲区数据发送到下一个 ChannelHandler
</span></span><span style="display:flex;"><span>	ctx.write(Unpooled.copiedBuffer(&#34;Netty in Action&#34;, CharsetUtil.UTF_8));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="43.png" alt=""  />
</p>
<h3 id="channelhandler-和-channelhandlercontext-的高级用法">ChannelHandler 和 ChannelHandlerContext 的高级用法<a hidden class="anchor" aria-hidden="true" href="#channelhandler-和-channelhandlercontext-的高级用法">#</a></h3>
<p>正如我们在代码清单 6-6 中所看到的，你可以通过调用 ChannelHandlerContext 上的pipeline()方法来获得被封闭的 ChannelPipeline 的引用。这使得运行时得以操作ChannelPipeline 的 ChannelHandler，我们可以利用这一点来实现一些复杂的设计。例如，你可以通过将 ChannelHandler 添加到 ChannelPipeline 中来实现动态的协议切换。</p>
<p>另一种高级的用法是缓存到 ChannelHandlerContext 的引用以供稍后使用，这可能会发生在任何的
ChannelHandler 方法之外，甚至来自于不同的线程。代码清单 6-9 展示了用这种模式来触发事件。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 6-9 缓存到 ChannelHandlerContext 的引用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WriteHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelHandlerAdapter {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> ChannelHandlerContext ctx;
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> handlerAdded(ChannelHandlerContext ctx) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//存储到 ChannelHandlerContext的引用以供稍后使用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">ctx</span> = ctx;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> send(String msg) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//使用之前存储的到 ChannelHandlerContext的引用来发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ctx.<span style="color:#007f7f">writeAndFlush</span>(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为一个 ChannelHandler 可以从属于多个 ChannelPipeline，所以它也可以绑定到多个
ChannelHandlerContext 实例。对于这种用法指在多个 ChannelPipeline 中共享同一个 ChannelHandler，对应的 ChannelHandler 必须要使用@Sharable 注解标注；否则，试图将它添加到多个 ChannelPipeline 时将会触发异常。显而易见，为了安全地被用于多个并发的 Channel（即连接），这样的 ChannelHandler 必须是线程安全的。代码清单 6-10 展示了这种模式的一个正确实现。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 6-10 可共享的 ChannelHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//使用注解@Sharable标注
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@Sharable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SharableHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead(ChannelHandlerContext ctx, Object msg) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;channel read message &#34;</span> + msg);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//记录方法调用，并转发给下一个 ChannelHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ctx.<span style="color:#007f7f">fireChannelRead</span>(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>前面的 ChannelHandler 实现符合所有的将其加入到多个 ChannelPipeline 的需求，即它使用了注解
@Sharable 标注，并且也不持有任何的状态。相反，代码清单 6-11 中的实现将会导致问题。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 6-11 @Sharable 的错误用法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//使用注解@Sharable标注
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>@Sharable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UnsharableHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> count;
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead(ChannelHandlerContext ctx, Object msg) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将 count 字段的值加 1
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        count++;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//记录方法调用，并转发给下一个ChannelHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;inboundBufferUpdated(...) called the &#34;</span> + count + <span style="color:#0ff;font-weight:bold">&#34; time&#34;</span>);
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">fireChannelRead</span>(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码的主要的问题在于，对于其所持有的状态的修改并不是线程安全的（也可以通过使用 AtomicInteger来规避这个问题），即用于跟踪方法调用次数的实例变量count。将这个类的一个实例添加到ChannelPipeline将极有可能在它被多个并发的Channel访问时导致问题。（当然，这个简单的问题可以通过使channelRead()方法变为同步方法来修正。）
总之，只应该在确定了你的 ChannelHandler 是线程安全的时才使用@Sharable 注解。
为何要共享同一个ChannelHandler 在多个ChannelPipeline中安装同一个ChannelHandler的一个常见的原因是用于收集跨越多个 Channel 的统计信息。</p>
<h2 id="异常处理">异常处理<a hidden class="anchor" aria-hidden="true" href="#异常处理">#</a></h2>
<p>异常处理是程序的重要组成部分，Netty提供了几种方式用于处理出入站过程中所抛出的异常。</p>
<h3 id="入站异常">入站异常<a hidden class="anchor" aria-hidden="true" href="#入站异常">#</a></h3>
<p>如果在处理入站事件的过程中有异常被抛出，那么它将从它在 ChannelInboundHandler里被触发的那一点开始流经 ChannelPipeline。要想处理这种类型的入站异常，你需要在你的 ChannelInboundHandler 实现中重写下面的方法。
<code>public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception</code></p>
<p>代码清单 6-12 展示了一个简单的示例，其关闭了 Channel 并打印了异常的栈跟踪信息。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 6-12 基本的入站异常处理
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> InboundExceptionHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> exceptionCaught(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        Throwable cause) {
</span></span><span style="display:flex;"><span>        cause.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为异常将会继续按照入站方向流动（就像所有的入站事件一样），所以实现了前面所示逻辑的
ChannelInboundHandler 通常位于 ChannelPipeline 的最后。这确保了所有的入站异常都总是会被处理，无论它们可能会发生在 ChannelPipeline 中的什么位置。
你应该如何响应异常，可能很大程度上取决于你的应用程序。你可能想要关闭Channel（和连接），也可能会尝试进行恢复。如果你不实现任何处理入站异常的逻辑（或者没有消费该异常），那么Netty将会记录该异常没有被处理的事实，即 Netty 将会通过 Warning 级别的日志记录该异常到达了 ChannelPipeline 的尾端，但没有被处理，并尝试释放该异常。
总结：</p>
<ul>
<li>ChannelHandler.exceptionCaught()的默认实现是简单地将当前异常转发给ChannelPipeline 中的下一个ChannelHandler；</li>
<li>如果异常到达了 ChannelPipeline 的尾端，它将会被记录为未被处理；</li>
<li>要想定义自定义的处理逻辑，你需要重写 exceptionCaught()方法。然后你需要决定是否需要将该异常传播出去。</li>
</ul>
<h3 id="出站异常">出站异常<a hidden class="anchor" aria-hidden="true" href="#出站异常">#</a></h3>
<p>用于处理出站操作中的正常完成以及异常的选项，都基于以下的通知机制。</p>
<ul>
<li>每个出站操作都将返回一个 ChannelFuture。注册到 ChannelFuture 的 ChannelFutureListener 将在操作完成时被通知该操作是成功了还是出错了。</li>
<li>几乎所有的 ChannelOutboundHandler 上的方法都会传入一个 ChannelPromise的实例。作为ChannelFuture的子类，ChannelPromise 也可以被分配用于异步通知的监听器。但是，ChannelPromise 还具有提供立即通知的可写方法：
ChannelPromise setSuccess();
ChannelPromise setFailure(Throwable cause);</li>
</ul>
<p>添加 ChannelFutureListener 只需要调用 ChannelFuture 实例上的 addListener
(ChannelFutureListener)方法，并且有两种不同的方式可以做到这一点。其中最常用的方式是，调用出站操作（如 write()方法）所返回的 ChannelFuture 上的 addListener()方法。
代码清单 6-13 使用了这种方式来添加 ChannelFutureListener，它将打印栈跟踪信息并且随后关闭 Channel。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * Created by kerr.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 6-13 添加 ChannelFutureListener 到 ChannelFuture
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ChannelFutures {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> Channel CHANNEL_FROM_SOMEWHERE = <span style="color:#fff;font-weight:bold">new</span> NioSocketChannel();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ByteBuf SOME_MSG_FROM_SOMEWHERE = Unpooled.<span style="color:#007f7f">buffer</span>(<span style="color:#ff0;font-weight:bold">1024</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 6-13 添加 ChannelFutureListener 到 ChannelFuture
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> addingChannelFutureListener(){
</span></span><span style="display:flex;"><span>        Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference to pipeline;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ByteBuf someMessage = SOME_MSG_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference to pipeline;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        io.<span style="color:#007f7f">netty</span>.<span style="color:#007f7f">channel</span>.<span style="color:#007f7f">ChannelFuture</span> future = channel.<span style="color:#007f7f">write</span>(someMessage);
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(io.<span style="color:#007f7f">netty</span>.<span style="color:#007f7f">channel</span>.<span style="color:#007f7f">ChannelFuture</span> f) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (!f.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    f.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                    f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>第二种方式是将 ChannelFutureListener 添加到即将作为参数传递给 ChannelOutboundHandler 的方法的ChannelPromise。代码清单 6-14 中所展示的代码和代码清单 6-13中所展示的具有相同的效果。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 6-14 添加 ChannelFutureListener 到 ChannelPromise
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> OutboundExceptionHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelOutboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> write(ChannelHandlerContext ctx, Object msg,
</span></span><span style="display:flex;"><span>        ChannelPromise promise) {
</span></span><span style="display:flex;"><span>        promise.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture f) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (!f.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    f.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                    f.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ChannelPromise 的可写方法：
通过调用 ChannelPromise 上的 setSuccess()和 setFailure()方法，可以使一个操作的状态在
ChannelHandler 的方法返回给其调用者时便即刻被感知到。
为何选择一种方式而不是另一种呢？对于细致的异常处理，你可能会发现，在调用出站操作时添加
ChannelFutureListener 更合适，如代码清单 6-13 所示。而对于一般的异常处理，你可能会发现，
代码清单 6-14 所示的自定义的 ChannelOutboundHandler 实现的方式更加的简单。
如果你的 ChannelOutboundHandler 本身抛出了异常会发生什么呢？在这种情况下，Netty 本身会通知任何已经注册到对应 ChannelPromise 的监听器。</p>
<h1 id="eventloop和线程模型">EventLoop和线程模型<a hidden class="anchor" aria-hidden="true" href="#eventloop和线程模型">#</a></h1>
<p>简单地说，线程模型指定了操作系统、编程语言、框架或者应用程序的上下文中的线程管理的关键方面。显而易见地，如何以及何时创建线程将对应用程序代码的执行产生显著的影响，因此开发人员需要理解与不同模型相关的权衡。无论是他们自己选择模型，还是通过采用某种编程语言或者框架隐式地获得它，这都是真实的。在本章中，我们将详细地探讨 Netty 的线程模型。它强大但又易用，并且和 Netty 的一贯宗旨一样，旨在简化你的应用程序代码，同时最大限度地提高性能和可维护性。我们还将讨论致使选择当前线程模型的经验。</p>
<h2 id="线程模型概述">线程模型概述<a hidden class="anchor" aria-hidden="true" href="#线程模型概述">#</a></h2>
<p>正如我们在本章开头所指出的，线程模型确定了代码的执行方式。由于我们总是必须规避并发执行可能会带来的副作用，所以理解所采用的并发模型（也有单线程的线程模型）的影响很重要。忽略这些问题，仅寄希望于最好的情况（不会引发并发问题）无疑是掩耳盗铃。</p>
<p>现在多核心多线程的CPU已经司空见惯，大多数的现代应用程序都利用了复杂的多线程处理技术以有效地利用系统资源。相比之下，在早期的 Java 语言中，我们使用多线程处理的主要方式无非是按需创建和启动新的Thread 来执行并发的任务单元（一种在高负载下工作得很差的原始方式。）
Java 5 随后引入了 Executor API，其线程池通过缓存和重用Thread 极大地提高了性能。</p>
<p>基本的线程池化模式可以描述为：</p>
<ul>
<li>从池的空闲线程列表中选择一个 Thread，并且指派它去运行一个已提交的任务（一个Runnable 的实现）；</li>
<li>当任务完成时，将该 Thread 返回给该列表，使其可被重用。图 7-1 说明了这个模式。
<img loading="lazy" src="44.png" alt=""  />

虽然池化和重用线程相对于简单地为每个任务都创建和销毁线程是一种进步，但是它并不能消除由上下文切换所带来的开销，其将随着线程数量的增加很快变得明显，并且在高负载下愈演愈烈。此外，仅仅由于应用程序的整体复杂性或者并发需求，在项目的生命周期内也可能会出现其他和线程相关的问题。简而言之，多线程处理是很复杂的。在接下来的章节中，我们将会看到 Netty 是如何帮助简化它的。</li>
</ul>
<h2 id="eventloop接口-1">EventLoop接口<a hidden class="anchor" aria-hidden="true" href="#eventloop接口-1">#</a></h2>
<p>运行任务来处理在连接的生命周期内发生的事件是任何网络框架的基本功能。与之相应的编程上的构造通常被称为事件循环：一个 Netty 使用了 interface io.netty.channel.EventLoop 来适配的术语。
代码清单 7-1 中说明了事件循环的基本思想，其中每个任务都是一个 Runnable 的实例（如图 7-1 所示）。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 7-1 在事件循环中执行任务
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EventLoopExamples {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 7-1 在事件循环中执行任务
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> executeTaskInEventLoop() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">boolean</span> terminated = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">while</span> (!terminated) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//阻塞，直到有事件已经就绪可被运行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            List&lt;Runnable&gt; readyEvents = blockUntilEventsReady();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (Runnable ev: readyEvents) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//循环遍历，并处理所有的事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                ev.<span style="color:#007f7f">run</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> List&lt;Runnable&gt; blockUntilEventsReady() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> Collections.&lt;Runnable&gt;singletonList(<span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                    Thread.<span style="color:#007f7f">sleep</span>(<span style="color:#ff0;font-weight:bold">1000</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>                    e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty 的 EventLoop 是协同设计的一部分，它采用了两个基本的 API：并发和网络编程。
首先，io.netty.util.concurrent 包构建在 JDK 的 java.util.concurrent 包上，用来提供线程执行器。
其次，io.netty.channel 包中的类，为了与 Channel 的事件进行交互，扩展了这些接口/类。
图 7-2 展示了生成的类层次结构。
<img loading="lazy" src="45.png" alt=""  />
</p>
<p>在这个模型中，一个 EventLoop 将由一个永远都不会改变的 Thread 驱动，
同时任务（Runnable 或者 Callable）可以直接提交给 EventLoop 实现，以立即执行或者调度执行。根据配置和可用核心的不同，可能会创建多个 EventLoop 实例用以优化资源的使用，并且单个EventLoop 可能会被指派用于服务多个 Channel。</p>
<p>需要注意的是，Netty的EventLoop在继承了ScheduledExecutorService的同时，只定义了一个方法，parent()。这个方法重写了 EventExecutor 的 EventExecutorGroup.parent()方法。用于返回到当前EventLoop实现的实例所属的EventLoopGroup的引用。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public interface EventLoop extends EventExecutor, EventLoopGroup {
</span></span><span style="display:flex;"><span>@Override
</span></span><span style="display:flex;"><span>EventLoopGroup parent();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>事件/任务的执行顺序：
事件和任务是以先进先出（FIFO）的顺序执行的。这样可以通过保证字节内容总是按正确的顺序被处理，消除潜在的数据损坏的可能性。</p>
<h3 id="netty-4-中的-io-和事件处理">Netty 4 中的 I/O 和事件处理<a hidden class="anchor" aria-hidden="true" href="#netty-4-中的-io-和事件处理">#</a></h3>
<p>正如我们在第 6 章中所详细描述的，由 I/O 操作触发的事件将流经安装了一个或者多个ChannelHandler的ChannelPipeline。传播这些事件的方法调用可以随后被 ChannelHandler 所拦截，并且可以按需地处理事件。
事件的性质通常决定了它将被如何处理；它可能将数据从网络栈中传递到你的应用程序中，或者进行逆向操作，或者 执行一些截然不同的操作。但是事件的处理逻辑必须足够的通用和灵活，以处理所有可能的用例。因此，在Netty 4 中，所有的I/O操作和事件都由已经被分配给了EventLoop的那个Thread来处理。</p>
<h3 id="netty-3-中的-io-操作">Netty 3 中的 I/O 操作<a hidden class="anchor" aria-hidden="true" href="#netty-3-中的-io-操作">#</a></h3>
<p>在以前的版本中所使用的线程模型只保证了入站（之前称为上游）事件会在所谓的 I/O 线程（对应于Netty 4 中的 EventLoop）中执行。所有的出站（下游）事件都由调用线程处理，其可能是 I/O 线程也可能是别的线程。开始看起来这似乎是个好主意，但是已经被发现是有问题的，因为需要在 ChannelHandler 中对出站事件进行仔细的同步。简而言之，不可能保证多个线程不会在同一时刻尝试访问出站事件。例如，如果你通过在不同的线程中调用 Channel.write()方法，针对同一个 Channel 同时触发出站的事件，就会发生这种情况。当出站事件触发了入站事件时，将会导致另一个负面影响。当 Channel.write()方法导致异常时，需要生成并触发一个 exceptionCaught 事件。但是在 Netty 3 的模型中，由于这是一个入站事件，需要在调用线程中执行代码，然后将事件移交给 I/O 线程去执行，然而这将带来额外的上下文切换。Netty 4 中所采用的线程模型，通过在同一个线程中处理某个给定的 EventLoop 中所产生的所有事件，解决了这个问题。这提供了一个更加简单的执行体系架构，并且消除了在多个ChannelHandler 中进行同步的需要（除了任何可能需要在多个 Channel 中共享的）。现在，已经理解了 EventLoop 的角色，让我们来看看任务是如何被调度执行的吧。</p>
<h2 id="任务调度">任务调度<a hidden class="anchor" aria-hidden="true" href="#任务调度">#</a></h2>
<p>有时候，你将需要调度一个任务以便稍后（延迟）执行或者周期性地执行。例如，你可能想要注册一个在客户端已经连接了 5 分钟之后触发的任务。一个常见的用例是，发送心跳消息到远程节点，以检查连接是否仍然还活着。如果没有响应，你便知道可以关闭该 Channel 了。
在接下来的几节中，我们将展示如何使用核心的Java API 和 Netty 的 EventLoop 来调度任务。
然后，我们将研究 Netty 的内部实现，并讨论它的优点和局限性。</p>
<h3 id="jdk-的任务调度-api">JDK 的任务调度 API<a hidden class="anchor" aria-hidden="true" href="#jdk-的任务调度-api">#</a></h3>
<p>在 Java 5 之前，任务调度是建立在 java.util.Timer 类之上的，其使用了一个后台 Thread，并且具有与标准线程相同的限制。随后，JDK 提供了 java.util.concurrent 包，它定义了
interface ScheduledExecutorService。如下是 java.util.concurrent.Executors的相关工厂方法。</p>
<p>newScheduledThreadPool( int corePoolSize)
newScheduledThreadPool( int corePoolSize, ThreadFactorythreadFactory)
创建一个 ScheduledThreadExecutorService， 用于调度命令在指定延迟之后运行或者周期性地执 行。它使用 corePoolSize 参数来计算线程数</p>
<p>newSingleThreadScheduledExecutor(),
newSingleThreadScheduledExecutor( ThreadFactorythreadFactory)
创建一个 ScheduledThreadExecutorService， 用于调度命令在指定延迟之后运行或者周期性地执行。它使用一个线程来执行被调度的任务</p>
<p>虽然选择不多，但是这些预置的实现已经足以应对大多数的用例。
代码清单 7-2 展示了如何使用ScheduledExecutorService来在 60 秒的延迟之后执行一个任务。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 7-2 使用 ScheduledExecutorService 调度任务
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> schedule() {
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//创建一个其线程池具有 10 个线程的ScheduledExecutorService
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ScheduledExecutorService executor = Executors.<span style="color:#007f7f">newScheduledThreadPool</span>(<span style="color:#ff0;font-weight:bold">10</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ScheduledFuture&lt;?&gt; future = executor.<span style="color:#007f7f">schedule</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//创建一个 Runnable，以供调度稍后执行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>		@Override
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//该任务要打印的消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Now it is 60 seconds later&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//调度任务在从现在开始的 60 秒之后执行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	}, <span style="color:#ff0;font-weight:bold">60</span>, TimeUnit.<span style="color:#007f7f">SECONDS</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//一旦调度任务执行完成，就关闭 ScheduledExecutorService 以释放资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	executor.<span style="color:#007f7f">shutdown</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>虽然 ScheduledExecutorService API 是直截了当的，但是在高负载下它将带来性能上的负担。
在下一节中，我们将看到 Netty 是如何以更高的效率提供相同的功能的。</p>
<h3 id="使用-eventloop-调度任务">使用 EventLoop 调度任务<a hidden class="anchor" aria-hidden="true" href="#使用-eventloop-调度任务">#</a></h3>
<p>ScheduledExecutorService 的实现具有局限性，因为作为线程池管理的一部分，将会有额外的线程创建。如果有大量任务被紧凑地调度，那么这将成为一个问题。Netty 通过 Channel 的 EventLoop 实现任务调度解决了这一问题，如代码清单 7-3 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 7-3 使用 EventLoop 调度任务
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> scheduleViaEventLoop() {
</span></span><span style="display:flex;"><span>	Channel ch = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference from somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ScheduledFuture&lt;?&gt; future = ch.<span style="color:#007f7f">eventLoop</span>().<span style="color:#007f7f">schedule</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//创建一个 Runnable以供调度稍后执行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>		@Override
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//要执行的代码
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;60 seconds later&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//调度任务在从现在开始的 60 秒之后执行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	}, <span style="color:#ff0;font-weight:bold">60</span>, TimeUnit.<span style="color:#007f7f">SECONDS</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>经过 60 秒之后，Runnable 实例将由分配给 Channel 的 EventLoop 执行。如果要调度任务以每隔 60 秒执行一次，请使用 scheduleAtFixedRate()方法，如代码清单 7-4 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 7-4 使用 EventLoop 调度周期性的任务
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> scheduleFixedViaEventLoop() {
</span></span><span style="display:flex;"><span>	Channel ch = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference from somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ScheduledFuture&lt;?&gt; future = ch.<span style="color:#007f7f">eventLoop</span>().<span style="color:#007f7f">scheduleAtFixedRate</span>(
</span></span><span style="display:flex;"><span>	   <span style="color:#007f7f">//创建一个 Runnable，以供调度稍后执行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	   <span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>	   @Override
</span></span><span style="display:flex;"><span>	   <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">//这将一直运行，直到 ScheduledFuture 被取消
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Run every 60 seconds&#34;</span>);
</span></span><span style="display:flex;"><span>	   }
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//调度在 60 秒之后，并且以后每间隔 60 秒运行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	}, <span style="color:#ff0;font-weight:bold">60</span>, <span style="color:#ff0;font-weight:bold">60</span>, TimeUnit.<span style="color:#007f7f">SECONDS</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如我们前面所提到的，Netty的EventLoop扩展了ScheduledExecutorService（见图7-2），所以它提供了使用JDK实现可用的所有方法，包括在前面的示例中使用到的schedule()和scheduleAtFixedRate()方法。
所有操作的完整列表可以在ScheduledExecutorService的Javadoc中找到。
①Java平台，标准版第8版API规范，java.util.concurrent，Interface ScheduledExecutorService：
<a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ScheduledExecutorService.html">http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ScheduledExecutorService.html</a></p>
<p>要想取消或者检查（被调度任务的）执行状态，可以使用每个异步操作所返回的 ScheduledFuture。
代码清单 7-5 展示了一个简单的取消操作。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 7-5 使用 ScheduledFuture 取消任务
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> cancelingTaskUsingScheduledFuture(){
</span></span><span style="display:flex;"><span>	Channel ch = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">// get reference from somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">//调度任务，并获得所返回的ScheduledFuture
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ScheduledFuture&lt;?&gt; future = ch.<span style="color:#007f7f">eventLoop</span>().<span style="color:#007f7f">scheduleAtFixedRate</span>(
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">new</span> Runnable() {
</span></span><span style="display:flex;"><span>				@Override
</span></span><span style="display:flex;"><span>				<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>					System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Run every 60 seconds&#34;</span>);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}, <span style="color:#ff0;font-weight:bold">60</span>, <span style="color:#ff0;font-weight:bold">60</span>, TimeUnit.<span style="color:#007f7f">SECONDS</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//运行其他代码
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">boolean</span> mayInterruptIfRunning = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">//取消该任务，防止它再次运行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	future.<span style="color:#007f7f">cancel</span>(mayInterruptIfRunning);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这些例子说明，可以利用 Netty 的任务调度功能来获得性能上的提升。
反过来，这些也依赖于底层的线程模型，我们接下来将对其进行研究。</p>
<h2 id="实现细节">实现细节<a hidden class="anchor" aria-hidden="true" href="#实现细节">#</a></h2>
<p>这一节将更加详细地探讨 Netty 的线程模型和任务调度实现的主要内容。
我们也将会提到需要注意的局限性，以及正在不断发展中的领域。</p>
<h3 id="线程管理">线程管理<a hidden class="anchor" aria-hidden="true" href="#线程管理">#</a></h3>
<p>Netty线程模型的卓越性能取决于对于当前执行的Thread的身份的确定。
（通过调用 EventLoop 的 inEventLoop(Thread)方法实现）
也就是说，确定它是否是分配给当前Channel以及它的EventLoop的那一个线程。（EventLoop将负责处理一个Channel的整个生命周期内的所有事件。）</p>
<p>如果（当前）调用线程正是支撑 EventLoop 的线程，那么所提交的代码块将会被（直接）执行。
否则，EventLoop 将调度该任务以便稍后执行，并将它放入到内部队列中。当 EventLoop下次处理它的事件时，它会执行队列中的那些任务/事件。这也就解释了任何的 Thread 是如何与 Channel 直接交互而无需在ChannelHandler 中进行额外同步的。</p>
<p>注意，每个 EventLoop 都有它自已的任务队列，独立于任何其他的 EventLoop。
图 7-3展示了 EventLoop 用于调度任务的执行逻辑。这是 Netty 线程模型的关键组成部分。
<img loading="lazy" src="46.png" alt=""  />

我们之前已经阐明了不要阻塞当前 I/O 线程的重要性。我们再以另一种方式重申一次：“永远不要将一个长时间运行的任务放入到执行队列中，因为它将阻塞需要在同一线程上执行的任何其他任务。”如果必须要进行阻塞调用或者执行长时间运行的任务，我们建议使用一个专门的EventExecutor。
（见 6.2.1 节的“ChannelHandler 的执行和阻塞”）。
除了这种受限的场景，如同传输所采用的不同的事件处理实现一样，所使用的线程模型也可以强烈地影响到排队的任务对整体系统性能的影响。（如同我们在第 4 章中所看到的，使用 Netty可以轻松地切换到不同的传输实现，而不需要修改你的代码库。）</p>
<h3 id="eventloop线程的分配">EventLoop/线程的分配<a hidden class="anchor" aria-hidden="true" href="#eventloop线程的分配">#</a></h3>
<p>服务于 Channel 的 I/O 和事件的 EventLoop 包含在 EventLoopGroup 中。
根据不同的传输实现，EventLoop 的创建和分配方式也不同。</p>
<ol>
<li>异步传输
异步传输实现只使用了少量的 EventLoop（以及和它们相关联的 Thread），而且在当前的线程模型中，它们可能会被多个 Channel 所共享。这使得可以通过尽可能少量的 Thread 来支撑大量的 Channel，而不是每个Channel 分配一个 Thread。
图 7-4 显示了一个 EventLoopGroup，它具有 3 个固定大小的 EventLoop（每个 EventLoop都由一个Thread支撑）。在创建 EventLoopGroup 时就直接分配了 EventLoop（以及支撑它们的 Thread），以确保在需要时它们是可用的。
<img loading="lazy" src="47.png" alt=""  />
</li>
</ol>
<p>EventLoopGroup 负责为每个新创建的 Channel 分配一个 EventLoop。在当前实现中，使用顺序循环（round-robin）的方式进行分配以获取一个均衡的分布，并且相同的 EventLoop可能会被分配给多个Channel。（这一点在将来的版本中可能会改变。）一旦一个 Channel 被分配给一个 EventLoop，它将在它的整个生命周期中都使用这个EventLoop（以及相关联的 Thread）。这将影响你ChannelHandler的同步和线程安全。</p>
<ol start="2">
<li>阻塞传输
<img loading="lazy" src="48.png" alt=""  />

阻塞传输的模型有所不同。这里每一个 Channel 都将被分配给一个 EventLoop（以及它的 Thread）。可以保证的是每个 Channel 的 I/O 事件都将只会被一个 Thread处理（用于支撑该 Channel 的 EventLoop 的那个 Thread）。这也是Netty一致性的例子，这种设计上的一致性，正是Netty的可靠性和易用性的体现。</li>
</ol>
<h2 id="小结">小结<a hidden class="anchor" aria-hidden="true" href="#小结">#</a></h2>
<p>本章我们学习了Netty 所采用的线程模型，详细探讨了其性能以及一致性。你学习了如何调度任务以便推迟执行，并且我们还探讨了高负载下的伸缩性问题。你也看到了如何验证一个任务是否已被执行以及如何取消它。通过我们对 Netty 框架的实现细节的研究所获得的这些信息，将帮助你在简化你的应用程序代码库的同时最大限度地提高它的性能。</p>
<h1 id="引导">引导<a hidden class="anchor" aria-hidden="true" href="#引导">#</a></h1>
<p>简单来说，引导一个应用程序是指对它进行配置，并使它运行起来的过程。本章我们会通过引导将
ChannelPipeline、ChannelHandler和 EventLoop组合起来。
Netty的引导会将你的应用程序和网络层隔离（分层抽象）。</p>
<h2 id="bootstrap类">Bootstrap类<a hidden class="anchor" aria-hidden="true" href="#bootstrap类">#</a></h2>
<p><img loading="lazy" src="49.png" alt=""  />

服务器致力于使用一个父 Channel 来接受来自客户端的连接，并创建子 Channel 以用于它们之间的通信；而客户端将最可能只需要一个单独的、没有父 Channel 的 Channel 来用于所有的网络交互。（正如同我们将要看到的，这也适用于无连接的传输协议，如 UDP，因为它们并不是每个连接都需要一个单独的 Channel）</p>
<p>为什么引导类是 Cloneable 的？
你有时可能会需要创建多个具有类似配置或者完全相同配置的Channel。为了支持这种模式而又不需要为每个Channel 都创建并配置一个新的引导类实例， AbstractBootstrap 被标记为了Cloneable。
在一个已经配置完成的引导类实例上调用clone()方法将返回另一个可以立即使用的引导类实例。
注意，这种方式只会创建引导类实例的EventLoopGroup的一个浅拷贝，所以被浅拷贝的 EventLoopGroup将在所有克隆的Channel实例之间共享。这是可以接受的，因为通常这些克隆的Channel的生命周期都很短暂，一个典型的场景是：创建一个Channel以进行一次HTTP请求。</p>
<p>AbstractBootstrap 类的完整声明是：
public abstract class AbstractBootstrap
&lt;B extends AbstractBootstrap&lt;B,C&gt;,C extends Channel&gt;
在这个签名中，子类型 B 是其父类型的一个类型参数，因此可以返回到运行时实例的引用以支持方法的链式调用，也就是所谓的流式语法。</p>
<p>其子类的声明如下：
public class Bootstrap
extends AbstractBootstrap&lt;Bootstrap,Channel&gt;</p>
<p>public class ServerBootstrap
extends AbstractBootstrap&lt;ServerBootstrap,ServerChannel&gt;</p>
<h2 id="引导客户端和无连接协议">引导客户端和无连接协议<a hidden class="anchor" aria-hidden="true" href="#引导客户端和无连接协议">#</a></h2>
<p>Bootstrap 类被用于客户端或者使用了无连接协议的应用程序中。表 8-1 提供了该类的一个概览，其中许多方法都继承自 AbstractBootstrap 类。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bootstrap group(EventLoopGroup)</td>
<td>设置用于处理 Channel 所有事件的 EventLoopGroup</td>
</tr>
<tr>
<td><code>Bootstrap channel( Class&lt;? extends C&gt;) Bootstrap channelFactory( ChannelFactory&lt;? extends C&gt;) </code></td>
<td>channel()方法指定了Channel的实现类。如果该实现类 没提供默认的构造函数，可以通过调用channelFactory()方法来指定一个工厂类，它将会被bind()方 法调用</td>
</tr>
<tr>
<td>Bootstrap localAddress( SocketAddress)</td>
<td>指定 Channel 应该绑定到的本地地址。如果没有指定， 则将由操作系统创建一个随机的地址。或者，也可以通过 bind()或者 connect()方法指定 localAddress</td>
</tr>
<tr>
<td><code>&lt;T&gt; Bootstrap option( ChannelOption&lt;T&gt; option, T value)</code></td>
<td>设置 ChannelOption，其将被应用到每个新创建的 Channel 的 ChannelConfig。这些选项将会通过 bind()或者 connect()方法设置到 Channel，不管哪 个先被调用。这个方法在 Channel 已经被创建后再调用 将不会有任何的效果。支持的 ChannelOption 取决于 使用的 Channel 类型。 参见 8.6 节以及 ChannelConfig 的 API 文档，了解所 使用的 Channel 类型</td>
</tr>
<tr>
<td><code>&lt;T&gt; Bootstrap attr( Attribute&lt;T&gt; key, T value)</code></td>
<td>指定新创建的 Channel 的属性值。这些属性值是通过 bind()或者 connect()方法设置到 Channel 的，具体 取决于谁最先被调用。这个方法在 Channel 被创建后将 不会有任何的效果。参见 8.6 节</td>
</tr>
<tr>
<td>Bootstrap handler(ChannelHandler)</td>
<td>设置将被添加到 ChannelPipeline 以接收事件通知的 ChannelHandler</td>
</tr>
<tr>
<td>Bootstrap clone()</td>
<td>创建一个当前 Bootstrap 的克隆，其具有和原始的 Bootstrap 相同的设置信息</td>
</tr>
<tr>
<td>Bootstrap remoteAddress( SocketAddress)</td>
<td>设置远程地址。或者，也可以通过 connect()方法来指 定它</td>
</tr>
<tr>
<td>ChannelFuture connect()</td>
<td>连接到远程节点并返回一个 ChannelFuture，其将 会在 连接操作完成后接收到通知</td>
</tr>
<tr>
<td>ChannelFuture bind()</td>
<td>绑定 Channel 并返回一个 ChannelFuture，其将会在绑 定操作完成后接收到通知，在那之后必须调用 Channel. connect()方法来建立连接</td>
</tr>
</tbody>
</table>
<h3 id="引导客户端">引导客户端<a hidden class="anchor" aria-hidden="true" href="#引导客户端">#</a></h3>
<p>Bootstrap 类负责为客户端和使用无连接协议的应用程序创建 Channel，如图 8-2 所示。
<img loading="lazy" src="50.png" alt=""  />

代码清单 8-1 中的代码引导了一个使用 NIO TCP 传输的客户端。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 8-1 引导一个客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:mawolfthal@gmail.com&#34;&gt;Marvin Wolfthal&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapClient {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String args[]) {
</span></span><span style="display:flex;"><span>        BootstrapClient client = <span style="color:#fff;font-weight:bold">new</span> BootstrapClient();
</span></span><span style="display:flex;"><span>        client.<span style="color:#007f7f">bootstrap</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 8-1 引导一个客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设置 EventLoopGroup，提供用于处理 Channel 事件的 EventLoop
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个Bootstrap类的实例以创建和连接新的客户端Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//指定要使用的Channel 实现
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">channel</span>(NioSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//设置用于 Channel 事件和数据的ChannelInboundHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">handler</span>(<span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                @Override
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                    ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                    ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//连接到远程主机
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">connect</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;www.manning.com&#34;</span>, <span style="color:#ff0;font-weight:bold">80</span>));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture channelFuture)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (channelFuture.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Connection established&#34;</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Connection attempt failed&#34;</span>);
</span></span><span style="display:flex;"><span>                    channelFuture.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个示例使用了前面提到的流式语法；这些方法（除了 connect()方法以外）将通过每次方法调用所返回的对 Bootstrap 实例的引用链接在一起。</p>
<h3 id="channel-和-eventloopgroup-的兼容性">Channel 和 EventLoopGroup 的兼容性<a hidden class="anchor" aria-hidden="true" href="#channel-和-eventloopgroup-的兼容性">#</a></h3>
<p>代码清单 8-2 所示的目录清单来自 io.netty.channel 包。你可以从包名以及与其相对应的类名的前缀看到，对于 NIO 以及 OIO 传输两者来说，都有相关的 EventLoopGroup 和Channel 实现。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>channel
</span></span><span style="display:flex;"><span>├───nio
</span></span><span style="display:flex;"><span>│ NioEventLoopGroup
</span></span><span style="display:flex;"><span>├───oio
</span></span><span style="display:flex;"><span>│ OioEventLoopGroup
</span></span><span style="display:flex;"><span>└───socket
</span></span><span style="display:flex;"><span>├───nio
</span></span><span style="display:flex;"><span>│ NioDatagramChannel
</span></span><span style="display:flex;"><span>│ NioServerSocketChannel
</span></span><span style="display:flex;"><span>│ NioSocketChannel
</span></span><span style="display:flex;"><span>└───oio
</span></span><span style="display:flex;"><span>OioDatagramChannel
</span></span><span style="display:flex;"><span>OioServerSocketChannel
</span></span><span style="display:flex;"><span>OioSocketChannel
</span></span></code></pre></td></tr></table>
</div>
</div><p>必须保持这种兼容性，不能混用具有不同前缀的组件，如 NioEventLoopGroup 和OioSocketChannel。
代码清单 8-3 展示了试图这样做的一个例子。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 8-3 不兼容的 Channel 和 EventLoopGroup
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> InvalidBootstrapClient {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String args[]) {
</span></span><span style="display:flex;"><span>        InvalidBootstrapClient client = <span style="color:#fff;font-weight:bold">new</span> InvalidBootstrapClient();
</span></span><span style="display:flex;"><span>        client.<span style="color:#007f7f">bootstrap</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 8-3 不兼容的 Channel 和 EventLoopGroup
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个新的 Bootstrap 类的实例，以创建新的客户端Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//指定一个适用于 NIO 的 EventLoopGroup 实现
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//指定一个适用于 OIO 的 Channel 实现类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">channel</span>(OioSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//设置一个用于处理 Channel的 I/O 事件和数据的 ChannelInboundHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">handler</span>(<span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                @Override
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                    ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                    ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>             });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//尝试连接到远程节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">connect</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;www.manning.com&#34;</span>, <span style="color:#ff0;font-weight:bold">80</span>));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码将会导致 IllegalStateException，因为它混用了不兼容的传输。</p>
<p>关于 IllegalStateException 的更多讨论
在引导的过程中，在调用 bind()或者 connect()方法之前，必须调用以下方法来设置所需的组件：</p>
<ul>
<li>group()；</li>
<li>channel()或者 channelFactory()；</li>
<li>handler()。</li>
</ul>
<p>如果不这样做，则将会导致 IllegalStateException。对 handler()方法的调用尤其重要，因为它需要配置好 ChannelPipeline。</p>
<h2 id="引导服务器">引导服务器<a hidden class="anchor" aria-hidden="true" href="#引导服务器">#</a></h2>
<h3 id="serverbootstrap-类">ServerBootstrap 类<a hidden class="anchor" aria-hidden="true" href="#serverbootstrap-类">#</a></h3>
<p>表 8-2 ServerBootstrap 类的方法</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>group</td>
<td>设置 ServerBootstrap 要用的 EventLoopGroup。这个 EventLoopGroup 将用于 ServerChannel 和被接受的子 Channel 的 I/O 处理</td>
</tr>
<tr>
<td>channel</td>
<td>设置将要被实例化的 ServerChannel 类</td>
</tr>
<tr>
<td>channelFactory</td>
<td>如果不能通过默认的构造函数创建Channel，那么可以提供一个ChannelFactory</td>
</tr>
<tr>
<td>localAddress</td>
<td>指定 ServerChannel 应该绑定到的本地地址。如果没有指定，则将由操作系 统使用一个随机地址。或者，可以通过 bind()方法来指定该 localAddress</td>
</tr>
<tr>
<td>option</td>
<td>指定要应用到新创建的 ServerChannel 的 ChannelConfig 的 ChannelOption。这些选项将会通过 bind()方法设置到 Channel。在 bind()方法 被调用之后，设置或者改变 ChannelOption 都不会有任何的效果。所支持 的 ChannelOption 取决于所使用的 Channel 类型。参见正在使用的 ChannelConfig 的 API 文档</td>
</tr>
<tr>
<td>childOption</td>
<td>指定当子 Channel 被接受时，应用到子 Channel 的 ChannelConfig 的 ChannelOption。所支持的 ChannelOption 取决于所使用的 Channel 的类 型。参见正在使用的 ChannelConfig 的 API 文档</td>
</tr>
<tr>
<td>attr</td>
<td>指定 ServerChannel 上的属性，属性将会通过 bind()方法设置给 Channel。 在调用 bind()方法之后改变它们将不会有任何的效果</td>
</tr>
<tr>
<td>childAttr</td>
<td>将属性设置给已经被接受的子 Channel。接下来的调用将不会有任何的效果</td>
</tr>
<tr>
<td>handler</td>
<td>设置被添加到ServerChannel 的ChannelPipeline中的ChannelHandler。 更加常用的方法参见 childHandler()</td>
</tr>
<tr>
<td>childHandler</td>
<td>设置将被添加到已被接受的子 Channel 的 ChannelPipeline 中的 ChannelHandler。handler()方法和 childHandler()方法之间的区别是：前者所 添加的 ChannelHandler 由接受子 Channel 的 ServerChannel 处理，而 childHandler()方法所添加的 ChannelHandler 将由已被接受的子 Channel 处理，其代表一个绑定到远程节点的套接字</td>
</tr>
<tr>
<td>clone</td>
<td>克隆一个设置和原始的 ServerBootstrap 相同的 ServerBootstrap</td>
</tr>
<tr>
<td>bind</td>
<td>绑定 ServerChannel 并且返回一个 ChannelFuture，其将会在绑定操作完 成后收到通知（带着成功或者失败的结果）</td>
</tr>
</tbody>
</table>
<h3 id="引导服务器-1">引导服务器<a hidden class="anchor" aria-hidden="true" href="#引导服务器-1">#</a></h3>
<p>你可能已经注意到了，表 8-2 中列出了一些在表 8-1 中不存在的方法：childHandler()、childAttr()和
childOption()。这些调用支持特别用于服务器应用程序的操作。具体来说，ServerChannel 的实现负责创建子 Channel，这些子 Channel 代表了已被接受的连接。因此，负责引导 ServerChannel 的
ServerBootstrap 提供了这些方法，以简化将设置应用到已被接受的子 Channel 的 ChannelConfig 的任务。
图 8-3 展示了 ServerBootstrap 在 bind()方法被调用时创建了一个 ServerChannel，并且该 ServerChannel 管理了多个子 Channel。
<img loading="lazy" src="51.png" alt=""  />

代码清单 8-4 中的代码实现了图 8-3 中所展示的服务器的引导过程。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 8-4 引导服务器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:mawolfthal@gmail.com&#34;&gt;Marvin Wolfthal&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapServer {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 8-4 引导服务器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        NioEventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建 Server Bootstrap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ServerBootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设置 EventLoopGroup，其提供了用于处理 Channel 事件的EventLoop
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//指定要使用的 Channel 实现
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//设置用于处理已被接受的子 Channel 的I/O及数据的 ChannelInboundHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">childHandler</span>(<span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                @Override
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                    ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//通过配置好的 ServerBootstrap 的实例绑定该 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">bind</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#ff0;font-weight:bold">8080</span>));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture channelFuture)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (channelFuture.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Server bound&#34;</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Bind attempt failed&#34;</span>);
</span></span><span style="display:flex;"><span>                    channelFuture.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="从-channel-引导客户端">从 Channel 引导客户端<a hidden class="anchor" aria-hidden="true" href="#从-channel-引导客户端">#</a></h2>
<p>假设你的服务器正在处理一个客户端的请求，这个请求需要它充当第三方系统的客户端。当一个应用程序（如一个代理服务器）必须要和组织现有的系统（如 Web 服务或者数据库）集成时，就可能发生这种情况。
在这种情况下，将需要从已经被接受的子 Channel 中引导一个客户端 Channel。你可以按照 8.2.1 节中所描述的方式创建新的 Bootstrap 实例，但是这并不是最高效的解决方案，因为它将要求你为每个新创建的客户端 Channel 定义另一个 EventLoop。这会产生额外的线程，以及在已被接受的子 Channel 和客户端Channel 之间交换数据时不可避免的上下文切换。</p>
<p>一个更好的解决方案是：通过将已被接受的子 Channel 的 EventLoop 传递给 Bootstrap的 group()方法来共享该 EventLoop。因为分配给 EventLoop 的所有 Channel 都使用同一个线程，所以这避免了额外的线程创建，以及前面所提到的相关的上下文切换。这个共享的解决方案如图 8-4 所示。
<img loading="lazy" src="52.png" alt=""  />

实现 EventLoop 共享涉及通过调用 group()方法来设置 EventLoop，如代码清单 8-5 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 8-5 引导服务器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:mawolfthal@gmail.com&#34;&gt;Marvin Wolfthal&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapSharingEventLoopGroup {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 8-5 引导服务器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建 ServerBootstrap 以创建 ServerSocketChannel，并绑定它
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ServerBootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设置 EventLoopGroup，其将提供用以处理 Channel 事件的 EventLoop
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        bootstrap.<span style="color:#007f7f">group</span>(<span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup(), <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup())
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//指定要使用的 Channel 实现
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//设置用于处理已被接受的子 Channel 的 I/O 和数据的 ChannelInboundHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">childHandler</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                    ChannelFuture connectFuture;
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(ChannelHandlerContext ctx)
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//创建一个 Bootstrap 类的实例以连接到远程主机
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//指定 Channel 的实现
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        bootstrap.<span style="color:#007f7f">channel</span>(NioSocketChannel.<span style="color:#007f7f">class</span>).<span style="color:#007f7f">handler</span>(
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//为入站 I/O 设置 ChannelInboundHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            <span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                                @Override
</span></span><span style="display:flex;"><span>                                <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                                    ChannelHandlerContext ctx, ByteBuf in)
</span></span><span style="display:flex;"><span>                                    <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            });
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//使用与分配给已被接受的子Channel相同的EventLoop
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        bootstrap.<span style="color:#007f7f">group</span>(ctx.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">eventLoop</span>());
</span></span><span style="display:flex;"><span>                        connectFuture = bootstrap.<span style="color:#007f7f">connect</span>(
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//连接到远程节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;www.manning.com&#34;</span>, <span style="color:#ff0;font-weight:bold">80</span>));
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                        ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                            ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">if</span> (connectFuture.<span style="color:#007f7f">isDone</span>()) {
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">//当连接完成时，执行一些数据操作（如代理）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            <span style="color:#007f7f">// do something with the data
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//通过配置好的 ServerBootstrap 绑定该 ServerSocketChannel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">bind</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#ff0;font-weight:bold">8080</span>));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture channelFuture)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (channelFuture.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Server bound&#34;</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Bind attempt failed&#34;</span>);
</span></span><span style="display:flex;"><span>                    channelFuture.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们在这一节中所讨论的主题以及所提出的解决方案都反映了编写 Netty 应用程序的一个一般准则：尽可能地重用 EventLoop，以减少线程创建所带来的开销。</p>
<h2 id="在引导过程中添加多个-channelhandler">在引导过程中添加多个 ChannelHandler<a hidden class="anchor" aria-hidden="true" href="#在引导过程中添加多个-channelhandler">#</a></h2>
<p>在所有我们展示过的代码示例中，我们都在引导的过程中调用了 handler()或者 childHandler()方法来添加单个的 ChannelHandler。这对于简单的应用程序来说可能已经足够了，但是它不能满足更加复杂的需求。例如，一个必须要支持多种协议的应用程序将会有很多的ChannelHandler，而不会是一个庞大而又笨重的类。</p>
<p>正如你经常所看到的一样，你可以根据需要，通过在 ChannelPipeline 中将它们链接在一起来部署尽可能多的 ChannelHandler。但是，如果在引导的过程中你只能设置一个 ChannelHandler，那么你应该怎么做到这一点呢？正是针对于这个用例，Netty 提供了一个特殊的 ChannelInboundHandlerAdapter 子类：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public abstract class ChannelInitializer&lt;C extends Channel&gt;
</span></span><span style="display:flex;"><span>extends ChannelInboundHandlerAdapter
</span></span></code></pre></td></tr></table>
</div>
</div><p>它定义了下面的方法：
<code>protected abstract void initChannel(C ch) throws Exception;</code>
这个方法提供了一种将多个 ChannelHandler 添加到一个 ChannelPipeline 中的简便方法。你只需要简单地向 Bootstrap 或 ServerBootstrap 的实例提供你的 ChannelInitializer 实现即可，并且一旦 Channel 被注册到了它的 EventLoop 之后，就会调用你的initChannel()版本。在该方法返回之后，ChannelInitializer 的实例将会从 ChannelPipeline 中移除它自己。</p>
<p>代码清单 8-6 定义了ChannelInitializerImpl类，并通过ServerBootstrap的childHandler()方法注册它。你可以看到，这个看似复杂的操作实际上是相当简单直接的。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 8-6 引导和使用 ChannelInitializer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapWithInitializer {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 8-6 引导和使用 ChannelInitializer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() <span style="color:#fff;font-weight:bold">throws</span> InterruptedException {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建 ServerBootstrap 以创建和绑定新的 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ServerBootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设置 EventLoopGroup，其将提供用以处理 Channel 事件的 EventLoop
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        bootstrap.<span style="color:#007f7f">group</span>(<span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup(), <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup())
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//指定 Channel 的实现
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//注册一个 ChannelInitializerImpl 的实例来设置 ChannelPipeline
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">childHandler</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelInitializerImpl());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//绑定到地址
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">bind</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#ff0;font-weight:bold">8080</span>));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//用以设置 ChannelPipeline 的自定义 ChannelInitializerImpl 实现
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ChannelInitializerImpl <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将所需的 ChannelHandler 添加到 ChannelPipeline
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HttpClientCodec());
</span></span><span style="display:flex;"><span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HttpObjectAggregator(Integer.<span style="color:#007f7f">MAX_VALUE</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果你的应用程序使用了多个 ChannelHandler，请定义你自己的
ChannelInitializer实现来将它们安装到 ChannelPipeline 中。</p>
<h2 id="使用-netty-的-channeloption-和属性">使用 Netty 的 ChannelOption 和属性<a hidden class="anchor" aria-hidden="true" href="#使用-netty-的-channeloption-和属性">#</a></h2>
<p>在每个 Channel 创建时都手动配置它可能会变得相当乏味。幸运的是，你不必这样做。相反，你可以使用option()方法来将 ChannelOption 应用到引导。你所提供的值将会被自动应用到引导所创建的所有 Channel。可用的 ChannelOption 包括了底层连接的详细信息，如keep-alive 或者超时属性以及缓冲区设置。</p>
<p>Netty 应用程序通常与组织的专有软件集成在一起，而像 Channel 这样的组件可能甚至会在正常的 Netty 生命周期之外被使用。在某些常用的属性和数据不可用时，Netty 提供了AttributeMap 抽象（一个由 Channel和引导类提供的集合）以及<code>AttributeKey&lt;T&gt;</code>（一个用于插入和获取属性值的泛型类）。使用这些工具，便可以安全地将任何类型的数据项与客户端和服务器 Channel（包含 ServerChannel 的子 Channel）相关联了。</p>
<p>例如，考虑一个用于跟踪用户和 Channel 之间的关系的服务器应用程序。这可以通过将用户的 ID 存储为Channel 的一个属性来完成。类似的技术可以被用来基于用户的 ID 将消息路由给用户，或者关闭活动较少的 Channel。代码清单 8-7 展示了可以如何使用 ChannelOption 来配置 Channel，以及如何使用属性来存储整型值。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 8-7 使用属性值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapClientWithOptionsAndAttrs {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 8-7 使用属性值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个 AttributeKey 以标识该属性
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">final</span> AttributeKey&lt;Integer&gt; id = AttributeKey.<span style="color:#007f7f">newInstance</span>(<span style="color:#0ff;font-weight:bold">&#34;ID&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个 Bootstrap 类的实例以创建客户端 Channel 并连接它们
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设置 EventLoopGroup，其提供了用以处理 Channel 事件的 EventLoop
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        bootstrap.<span style="color:#007f7f">group</span>(<span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup())
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//指定 Channel 的实现
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">channel</span>(NioSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">handler</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//设置用以处理 Channel 的 I/O 以及数据的 ChannelInboundHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRegistered(ChannelHandlerContext ctx)
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//使用 AttributeKey 检索属性以及它的值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        Integer idValue = ctx.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">attr</span>(id).<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// do something with the idValue
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                        ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                        ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设置 ChannelOption，其将在 connect()或者bind()方法被调用时被设置到已经创建的 Channel 上
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        bootstrap.<span style="color:#007f7f">option</span>(ChannelOption.<span style="color:#007f7f">SO_KEEPALIVE</span>, <span style="color:#fff;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">option</span>(ChannelOption.<span style="color:#007f7f">CONNECT_TIMEOUT_MILLIS</span>, <span style="color:#ff0;font-weight:bold">5000</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//存储该 id 属性
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        bootstrap.<span style="color:#007f7f">attr</span>(id, <span style="color:#ff0;font-weight:bold">123456</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//使用配置好的 Bootstrap 实例连接到远程主机
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">connect</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;www.manning.com&#34;</span>, <span style="color:#ff0;font-weight:bold">80</span>));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="引导-datagramchannel">引导 DatagramChannel<a hidden class="anchor" aria-hidden="true" href="#引导-datagramchannel">#</a></h2>
<p>前面的引导代码示例使用的都是基于 TCP 协议的 SocketChannel，但是 Bootstrap 类也可以被用于无连接的协议。为此，Netty 提供了各种 DatagramChannel 的实现。唯一区别就是，不再调用 connect()方法，而是只调用 bind()方法，如代码清单 8-8 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 8-8 使用 Bootstrap 和 DatagramChannel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BootstrapDatagramChannel {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 8-8 使用 Bootstrap 和 DatagramChannel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个 Bootstrap 的实例以创建和绑定新的数据报 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//设置 EventLoopGroup，其提供了用以处理 Channel 事件的 EventLoop
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        bootstrap.<span style="color:#007f7f">group</span>(<span style="color:#fff;font-weight:bold">new</span> OioEventLoopGroup()).<span style="color:#007f7f">channel</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//指定 Channel 的实现
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            OioDatagramChannel.<span style="color:#007f7f">class</span>).<span style="color:#007f7f">handler</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//设置用以处理 Channel 的 I/O 以及数据的 ChannelInboundHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;DatagramPacket&gt;() {
</span></span><span style="display:flex;"><span>                @Override
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>                    DatagramPacket msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">// Do something with the packet
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//调用 bind() 方法，因为该协议是无连接的
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">bind</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#ff0;font-weight:bold">0</span>));
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">addListener</span>(<span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture channelFuture)
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">if</span> (channelFuture.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                   System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Channel bound&#34;</span>);
</span></span><span style="display:flex;"><span>               } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                   System.<span style="color:#007f7f">err</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Bind attempt failed&#34;</span>);
</span></span><span style="display:flex;"><span>                   channelFuture.<span style="color:#007f7f">cause</span>().<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>               }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="关闭程序">关闭程序<a hidden class="anchor" aria-hidden="true" href="#关闭程序">#</a></h2>
<p>虽然可以让 JVM 在退出时处理好一切，但是这并不优雅，优雅是指干净地释放资源。
首先需要关闭 EventLoopGroup，并且随后释放所有活动的线程。这就是调用
EventLoopGroup.shutdownGracefully()方法的作用。这个方法调用将会返回一个 Future，这个 Future 将在关闭完成时接收到通知。需要注意的是，shutdownGracefully()方法也是一个异步的操作，所以你需要阻塞等待直到它完成，或者向所返回的 Future 注册一个监听器以在关闭完成时获得通知。
代码清单 8-9 符合优雅关闭的定义。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 8-9 优雅关闭
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> GracefulShutdown {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String args[]) {
</span></span><span style="display:flex;"><span>        GracefulShutdown client = <span style="color:#fff;font-weight:bold">new</span> GracefulShutdown();
</span></span><span style="display:flex;"><span>        client.<span style="color:#007f7f">bootstrap</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 代码清单 8-9 优雅关闭
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> bootstrap() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建处理 I/O 的EventLoopGroup
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个 Bootstrap 类的实例并配置它
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Bootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>             .<span style="color:#007f7f">channel</span>(NioSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>             .<span style="color:#007f7f">handler</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> SimpleChannelInboundHandler&lt;ByteBuf&gt;() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>                            ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>                            ByteBuf byteBuf) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Received data&#34;</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>             );
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">connect</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;www.manning.com&#34;</span>, <span style="color:#ff0;font-weight:bold">80</span>)).<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//,,,
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//shutdownGracefully()方法将释放所有的资源，并且关闭所有的当前正在使用中的 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Future&lt;?&gt; future = group.<span style="color:#007f7f">shutdownGracefully</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// block until the group has shutdown
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        future.<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>或者，你也可以在调用 EventLoopGroup.shutdownGracefully()方法之前，显式地在所有活动的
Channel 上调用 Channel.close()方法。但是在任何情况下，都请记得关闭EventLoopGroup 本身。</p>
<h2 id="小结-1">小结<a hidden class="anchor" aria-hidden="true" href="#小结-1">#</a></h2>
<p>在本章中，你学习了如何引导 Netty 服务器和客户端应用程序，包括那些使用无连接协议的应用程序。我们也涵盖了一些特殊情况，包括在服务器应用程序中引导客户端 Channel，以及使用 ChannelInitializer来处理引导过程中的多个 ChannelHandler 的安装。你看到了如何设置 Channel 的配置选项，以及如何使用属性来将信息附加到 Channel。最后，你学习了如何优雅地关闭应用程序，以有序地释放所有的资源。在下一章中，我们将研究 Netty 提供的帮助你测试你的 ChannelHandler 实现的工具。</p>
<h1 id="单元测试">单元测试<a hidden class="anchor" aria-hidden="true" href="#单元测试">#</a></h1>
<p>ChannelHandler 是 Netty 应用程序的关键元素，所以彻底地测试它们应该是你的开发过程的一个标准部分。
最佳实践要求你的测试不仅要能够证明你的实现是正确的，而且还要能够很容易地隔离那些因修改代码而突然出现的问题。这种类型的测试叫作单元测试。
虽然单元测试没有统一的定义，但是大多数的从业者都有基本的共识。其基本思想是，以尽可能小的区块测试你的代码，并且尽可能地和其他的代码模块以及运行时的依赖（如数据库和网络）相隔离。如果你的应用程序能通过测试验证每个单元本身都能够正常地工作，那么在出了问题时将可以更加容易地找出根本原因。
在本章中，我们将学习一种特殊的 Channel 实现——EmbeddedChannel，它是 Netty 专门为改进针对ChannelHandler 的单元测试而提供的。因为正在被测试的代码模块或者单元将在它正常的运行时环境之外被执行，所以你需要一个框架或者脚手架以便在其中运行它。在我们的例子中，我们将使用 JUnit 4 作为我们的测试框架，所以你需要对它的用法有一个基本的了解。如果它对你来说比较陌生，不要害怕；虽然它功能强大，但却很简单，你可以在 JUnit 的官方网站 <a href="https://junit.org/">https://junit.org/</a> 上找到你所需要的所有信息。</p>
<h2 id="embeddedchannel-概述">EmbeddedChannel 概述<a hidden class="anchor" aria-hidden="true" href="#embeddedchannel-概述">#</a></h2>
<p>你已经知道，可以将 ChannelPipeline 中的 ChannelHandler 实现链接在一起，以构建你的应用程序的业务逻辑。我们已经在前面解释过，这种设计支持将任何潜在的复杂处理过程分解为小的可重用的组件，每个组件都将处理一个明确定义的任务或者步骤。在本章中，我们还将展示它是如何简化测试的。
Netty 提供了它所谓的 Embedded 传输，用于测试 ChannelHandler。这个传输是一种特殊的Channel 实现，EmbeddedChannel的功能，这个实现提供了通过 ChannelPipeline传播事件的简便方法。</p>
<p>将入站数据或者出站数据写入到 EmbeddedChannel 中，然后检查是否有任何东西到达了 ChannelPipeline的尾端。以这种方式，你便可以确定消息是否已经被编码或者被解码过了，以及是否触发了任何的ChannelHandler 动作。表 9-1 中列出了 EmbeddedChannel 的相关方法。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>职 责</th>
</tr>
</thead>
<tbody>
<tr>
<td>writeInbound( Object&hellip; msgs)</td>
<td>将入站消息写到 EmbeddedChannel 中。如果可以通过 readInbound() 方法从 EmbeddedChannel 中读取数据，则返回 true</td>
</tr>
<tr>
<td>readInbound()</td>
<td>从 EmbeddedChannel 中读取一个入站消息。任何返回的东西都穿越了整 个 ChannelPipeline。如果没有任何可供读取的，则返回 null</td>
</tr>
<tr>
<td>writeOutbound( Object&hellip; msgs)</td>
<td>将出站消息写到EmbeddedChannel中。如果现在可以通过readOutbound() 方法从 EmbeddedChannel 中读取到什么东西，则返回 true</td>
</tr>
<tr>
<td>readOutbound()</td>
<td>EmbeddedChannel 中读取一个出站消息。任何返回的东西都穿越了整 个 ChannelPipeline。如果没有任何可供读取的，则返回 null</td>
</tr>
<tr>
<td>finish()</td>
<td>将 EmbeddedChannel 标记为完成，并且如果有可被读取的入站数据或者 出站数据，则返回 true。这个方法还将会调用 EmbeddedChannel 上的 close()方法</td>
</tr>
</tbody>
</table>
<p>入站数据由 ChannelInboundHandler 处理，代表从远程节点读取的数据。出站数据由
ChannelOutboundHandler 处理，代表将要写到远程节点的数据。根据你要测试的 ChannelHandler，你将使用<em>Inbound()或者</em>Outbound()方法对，或者兼而有之。
图 9-1 展示了使用 EmbeddedChannel 的方法，数据是如何流经 ChannelPipeline 的。你可以使用
writeOutbound()方法将消息写到 Channel 中，并通过 ChannelPipeline 沿着出站的方向传递。随后，你可以使用 readOutbound()方法来读取已被处理过的消息，以确定结果是否和预期一样。类似地，对于入站数据，你需要使用writeInbound()和readInbound()方法。
在每种情况下，消息都将会传递过 ChannelPipeline，并且被相关的 ChannelInboundHandler 或者
ChannelOutboundHandler 处理。如果消息没有被消费，那么你可以使用readInbound()或者
readOutbound()方法来在处理过了这些消息之后，酌情把它们从Channel中读出来。
<img loading="lazy" src="53.png" alt=""  />

接下来让我们仔细看看这两种场景，以及它们是如何应用于测试你的应用程序逻辑的吧。</p>
<h2 id="使用-embeddedchannel-测试-channelhandler">使用 EmbeddedChannel 测试 ChannelHandler<a hidden class="anchor" aria-hidden="true" href="#使用-embeddedchannel-测试-channelhandler">#</a></h2>
<p>JUnit 断言：
org.junit.Assert 类提供了很多用于测试的静态方法。失败的断言将导致一个异常被抛出，并将终止当前正在执行中的测试。导入这些断言的最高效的方式是通过一个 import static 语句来实现：
<code>import static org.junit.Assert.*;</code>
一旦这样做了，就可以直接调用 Assert 方法了：
<code>assertEquals(buf.readSlice(3), read);</code></p>
<h3 id="测试入站消息">测试入站消息<a hidden class="anchor" aria-hidden="true" href="#测试入站消息">#</a></h3>
<p>图 9-2 展示了一个简单的 ByteToMessageDecoder 实现。给定足够的数据，这个实现将产生固定大小的帧。如果没有足够的数据可供读取，它将等待下一个数据块的到来，并将再次检查是否能够产生一个新的帧。
<img loading="lazy" src="54.png" alt=""  />

正如可以从图 9-2 右侧的帧看到的那样，这个特定的解码器将产生固定为 3 字节大小的帧。因此，它可能会需要多个事件来提供足够的字节数以产生一个帧。最终，每个帧都会被传递给 ChannelPipeline 中的下一个ChannelHandler。该解码器的实现，如代码清单 9-1 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单9-1 FixedLengthFrameDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展 ByteToMessageDecoder 以处理入站字节，并将它们解码为消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FixedLengthFrameDecoder <span style="color:#fff;font-weight:bold">extends</span> ByteToMessageDecoder {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> frameLength;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//指定要生成的帧的长度
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> FixedLengthFrameDecoder(<span style="color:#fff;font-weight:bold">int</span> frameLength) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (frameLength &lt;= <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalArgumentException(<span style="color:#0ff;font-weight:bold">&#34;frameLength must be a positive integer: &#34;</span> + frameLength);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">frameLength</span> = frameLength;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//检查是否有足够的字节可以被读取，以生成下一个帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">while</span> (in.<span style="color:#007f7f">readableBytes</span>() &gt;= frameLength) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//从 ByteBuf 中读取一个新帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ByteBuf buf = in.<span style="color:#007f7f">readBytes</span>(frameLength);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//将该帧添加到已被解码的消息列表中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            out.<span style="color:#007f7f">add</span>(buf);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，让我们创建一个单元测试，以确保这段代码将按照预期执行。即使是在简单的代码中，单元测试也能帮助我们防止在将来代码重构时可能会导致的问题，并且能在问题发生时帮助我们诊断它们。代码清单 9-2 展示了一个使用 EmbeddedChannel 的对于前面代码的测试。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单9-5 FrameChunkDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FixedLengthFrameDecoderTest {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//使用了注解@Test 标注，因此JUnit 将会执行该方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> testFramesDecoded() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个 ByteBuf，并存储 9 字节
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ByteBuf buf = Unpooled.<span style="color:#007f7f">buffer</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; <span style="color:#ff0;font-weight:bold">9</span>; i++) {
</span></span><span style="display:flex;"><span>            buf.<span style="color:#007f7f">writeByte</span>(i);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ByteBuf input = buf.<span style="color:#007f7f">duplicate</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个EmbeddedChannel，并添加一个FixedLengthFrameDecoder，其将以 3 字节的帧长度被测试
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        EmbeddedChannel channel = <span style="color:#fff;font-weight:bold">new</span> EmbeddedChannel(<span style="color:#fff;font-weight:bold">new</span> FixedLengthFrameDecoder(<span style="color:#ff0;font-weight:bold">3</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 将数据写入EmbeddedChannel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        assertTrue(channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">retain</span>()));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//标记 Channel为已完成状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        assertTrue(channel.<span style="color:#007f7f">finish</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 读取所生成的消息，并且验证是否有 3 帧（切片），其中每帧（切片）都为 3 字节
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ByteBuf read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(<span style="color:#ff0;font-weight:bold">3</span>), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(<span style="color:#ff0;font-weight:bold">3</span>), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(<span style="color:#ff0;font-weight:bold">3</span>), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        assertNull(channel.<span style="color:#007f7f">readInbound</span>());
</span></span><span style="display:flex;"><span>        buf.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> testFramesDecoded2() {
</span></span><span style="display:flex;"><span>        ByteBuf buf = Unpooled.<span style="color:#007f7f">buffer</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; <span style="color:#ff0;font-weight:bold">9</span>; i++) {
</span></span><span style="display:flex;"><span>            buf.<span style="color:#007f7f">writeByte</span>(i);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ByteBuf input = buf.<span style="color:#007f7f">duplicate</span>();
</span></span><span style="display:flex;"><span>        EmbeddedChannel channel = <span style="color:#fff;font-weight:bold">new</span> EmbeddedChannel(<span style="color:#fff;font-weight:bold">new</span> FixedLengthFrameDecoder(<span style="color:#ff0;font-weight:bold">3</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//返回 false，因为没有一个完整的可供读取的帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        assertFalse(channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">readBytes</span>(<span style="color:#ff0;font-weight:bold">2</span>)));
</span></span><span style="display:flex;"><span>        assertTrue(channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">readBytes</span>(<span style="color:#ff0;font-weight:bold">7</span>)));
</span></span><span style="display:flex;"><span>        assertTrue(channel.<span style="color:#007f7f">finish</span>());
</span></span><span style="display:flex;"><span>        ByteBuf read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(<span style="color:#ff0;font-weight:bold">3</span>), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(<span style="color:#ff0;font-weight:bold">3</span>), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        read = channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(<span style="color:#ff0;font-weight:bold">3</span>), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        assertNull(channel.<span style="color:#007f7f">readInbound</span>());
</span></span><span style="display:flex;"><span>        buf.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>该 testFramesDecoded()方法验证了：一个包含 9 个可读字节的 ByteBuf 被解码为 3个 ByteBuf，每个都包含了 3 字节。需要注意的是，仅通过一次对 writeInbound()方法的调用，ByteBuf 是如何被填充了 9 个可读字节的。在此之后，通过执行 finish()方法，将EmbeddedChannel 标记为了已完成状态。最后，通过调用readInbound()方法，从 EmbeddedChannel 中正好读取了 3 个帧和一个 null。testFramesDecoded2()方法也是类似的，只有一处不同：入站 ByteBuf 是通过两个步骤写入的。
当 writeInbound(input.readBytes(2))被调用时，返回了 false。为什么呢？正如同表 9-1 中所描述的，如果对 readInbound()的后续调用将会返回数据，那么 writeInbound()方法将会返回 true。但是只有当有 3 个或者更多的字节可供读取时，FixedLengthFrameDecoder 才会产生输出。
该测试剩下的部分和 testFramesDecoded()是相同的。</p>
<h3 id="测试出站消息">测试出站消息<a hidden class="anchor" aria-hidden="true" href="#测试出站消息">#</a></h3>
<p>测试出站消息的处理过程和刚才所看到的类似。
在下面的例子中，我们将会展示如何使用EmbeddedChannel来测试一个编码器形式的
ChannelOutboundHandler，编码器是一种将一种消息格式转换为另一种的组件。你将在下一章中非常详细地学习编码器和解码器，所以现在我们只需要简单地提及我们正在测试的处理器—AbsIntegerEncoder，它是Netty 的MessageToMessageEncoder 的一个特殊化的实现，用于将负值整数转换为绝对值。该示例将会按照下列方式工作：</p>
<ul>
<li>持有 AbsIntegerEncoder 的 EmbeddedChannel 将会以 4 字节的负整数的形式写出站数据；</li>
<li>编码器将从传入的 ByteBuf 中读取每个负整数，并将会调用 Math.abs()方法来获取其绝对值；</li>
<li>编码器将会把每个负整数的绝对值写到 ChannelPipeline 中。
图 9-3 展示了该逻辑。
<img loading="lazy" src="55.png" alt=""  />

代码清单 9-3 实现了这个逻辑，如图 9-3 所示。encode()方法将把产生的值写到一个List 中。</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单9-3 AbsIntegerEncoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展 MessageToMessageEncoder 以将一个消息编码为另外一种格式
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AbsIntegerEncoder <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageEncoder&lt;ByteBuf&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext channelHandlerContext, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//检查是否有足够的字节用来编码
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">while</span> (in.<span style="color:#007f7f">readableBytes</span>() &gt;= <span style="color:#ff0;font-weight:bold">4</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//从输入的 ByteBuf中读取下一个整数，并且计算其绝对值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">int</span> value = Math.<span style="color:#007f7f">abs</span>(in.<span style="color:#007f7f">readInt</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//将该整数写入到编码消息的 List 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            out.<span style="color:#007f7f">add</span>(value);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码清单 9-4 使用了 EmbeddedChannel 来测试代码。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 9-4 测试 AbsIntegerEncoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AbsIntegerEncoderTest {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> testEncoded() {
</span></span><span style="display:flex;"><span>        ByteBuf buf = Unpooled.<span style="color:#007f7f">buffer</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个 ByteBuf，并且写入 9 个负整数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">1</span>; i &lt; <span style="color:#ff0;font-weight:bold">10</span>; i++) {
</span></span><span style="display:flex;"><span>            buf.<span style="color:#007f7f">writeInt</span>(i * -<span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个EmbeddedChannel，并安装一个要测试的AbsIntegerEncoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        EmbeddedChannel channel = <span style="color:#fff;font-weight:bold">new</span> EmbeddedChannel(<span style="color:#fff;font-weight:bold">new</span> AbsIntegerEncoder());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//写入 ByteBuf，并断言调用 readOutbound()方法将会产生数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        assertTrue(channel.<span style="color:#007f7f">writeOutbound</span>(buf));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将该Channel标记为已完成状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        assertTrue(channel.<span style="color:#007f7f">finish</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 读取所产生的消息，并断言它们包含了对应的绝对值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">1</span>; i &lt; <span style="color:#ff0;font-weight:bold">10</span>; i++) {
</span></span><span style="display:flex;"><span>            assertEquals(i, channel.<span style="color:#007f7f">readOutbound</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        assertNull(channel.<span style="color:#007f7f">readOutbound</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面是代码中执行的步骤。</p>
<ol>
<li>将 4 字节的负整数写到一个新的 ByteBuf 中。</li>
<li>创建一个 EmbeddedChannel，并为它分配一个 AbsIntegerEncoder。</li>
<li>调用 EmbeddedChannel 上的 writeOutbound()方法来写入该 ByteBuf。</li>
<li>标记该 Channel 为已完成状态。</li>
<li>从 EmbeddedChannel 的出站端读取所有的整数，并验证是否只产生了绝对值。</li>
</ol>
<h2 id="测试异常处理">测试异常处理<a hidden class="anchor" aria-hidden="true" href="#测试异常处理">#</a></h2>
<p>应用程序通常需要执行比转换数据更加复杂的任务。例如，你可能需要处理格式不正确的输入或者过量的数据。在下一个示例中，如果所读取的字节数超出了某个特定的限制，我们将会抛出一个 TooLongFrameException。这是一种经常用来防范资源被耗尽的方法。
在图 9-4 中，最大的帧大小已经被设置为 3 字节。如果一个帧的大小超出了该限制，那么程序将会丢弃它的字节，并抛出一个 TooLongFrameException。位于 ChannelPipeline 中的其他ChannelHandler 可以选择在 exceptionCaught()方法中处理该异常或者忽略它。
<img loading="lazy" src="56.png" alt=""  />

实现如代码清单 9-5 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单9-5 FrameChunkDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展 ByteToMessageDecoder以将入站字节解码为消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FrameChunkDecoder <span style="color:#fff;font-weight:bold">extends</span> ByteToMessageDecoder {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> maxFrameSize;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//指定将要产生的帧的最大允许大小
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> FrameChunkDecoder(<span style="color:#fff;font-weight:bold">int</span> maxFrameSize) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">maxFrameSize</span> = maxFrameSize;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> readableBytes = in.<span style="color:#007f7f">readableBytes</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (readableBytes &gt; maxFrameSize) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// discard the bytes
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//如果该帧太大，则丢弃它并抛出一个 TooLongFrameException……
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            in.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> TooLongFrameException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//……否则，从 ByteBuf 中读取一个新的帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ByteBuf buf = in.<span style="color:#007f7f">readBytes</span>(readableBytes);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将该帧添加到解码 读取一个新的帧消息的 List 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        out.<span style="color:#007f7f">add</span>(buf);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们再使用 EmbeddedChannel 来测试一次这段代码，如代码清单 9-6 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 9-6 测试 FrameChunkDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FrameChunkDecoderTest {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> testFramesDecoded() {
</span></span><span style="display:flex;"><span>        ByteBuf buf = Unpooled.<span style="color:#007f7f">buffer</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个 ByteBuf，并向它写入 9 字节
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; <span style="color:#ff0;font-weight:bold">9</span>; i++) {
</span></span><span style="display:flex;"><span>            buf.<span style="color:#007f7f">writeByte</span>(i);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ByteBuf input = buf.<span style="color:#007f7f">duplicate</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建一个 EmbeddedChannel，并向其安装一个帧大小为 3 字节的 FixedLengthFrameDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        EmbeddedChannel channel = <span style="color:#fff;font-weight:bold">new</span> EmbeddedChannel(<span style="color:#fff;font-weight:bold">new</span> FrameChunkDecoder(<span style="color:#ff0;font-weight:bold">3</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//向它写入 2 字节，并断言它们将会产生一个新帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        assertTrue(channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">readBytes</span>(<span style="color:#ff0;font-weight:bold">2</span>)));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//写入一个 4 字节大小的帧，并捕获预期的TooLongFrameException
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">readBytes</span>(<span style="color:#ff0;font-weight:bold">4</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果上面没有抛出异常，那么就会到达这个断言，并且测试失败
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Assert.<span style="color:#007f7f">fail</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (TooLongFrameException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// expected exception
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//写入剩余的2字节，并断言将会产生一个有效帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        assertTrue(channel.<span style="color:#007f7f">writeInbound</span>(input.<span style="color:#007f7f">readBytes</span>(<span style="color:#ff0;font-weight:bold">3</span>)));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将该 Channel 标记为已完成状态
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        assertTrue(channel.<span style="color:#007f7f">finish</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 读取产生的消息，并且验证值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ByteBuf read = (ByteBuf) channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">readSlice</span>(<span style="color:#ff0;font-weight:bold">2</span>), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        read = (ByteBuf) channel.<span style="color:#007f7f">readInbound</span>();
</span></span><span style="display:flex;"><span>        assertEquals(buf.<span style="color:#007f7f">skipBytes</span>(<span style="color:#ff0;font-weight:bold">4</span>).<span style="color:#007f7f">readSlice</span>(<span style="color:#ff0;font-weight:bold">3</span>), read);
</span></span><span style="display:flex;"><span>        read.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>        buf.<span style="color:#007f7f">release</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>乍一看，这看起来非常类似于代码清单 9-2 中的测试，但是它有一个有趣的转折点，即对
TooLongFrameException的处理。这里使用的try/catch块是EmbeddedChannel的一个特殊功能。如果其中一个write*方法产生了一个受检查的Exception，那么它将会被包装在一个RuntimeException中并抛出。需要注意的是，如果该类实现了 exceptionCaught()方法并处理了该异常，那么它将不会被 catch块所捕获。这使得可以容易地测试出一个Exception是否在处理数据的过程中已经被处理了。这里介绍的测试方法可以用于任何能抛出 Exception 的 ChannelHandler 实现。</p>
<h2 id="小结-2">小结<a hidden class="anchor" aria-hidden="true" href="#小结-2">#</a></h2>
<p>使用 JUnit 这样的测试工具来进行单元测试是一种非常行之有效的方式，它能保证你的代码的正确性并提高它的可维护性。在本章中，你学习了如何使用 Netty 提供的测试工具来测试你自定义的 ChannelHandler。在接下来的章节中，我们将专注于使用 Netty 编写真实世界的应用程序。我们不会再提供任何进一步的测试代码示例了，所以我们希望你将这里所展示的测试方法的重要性牢记于心。</p>
<h1 id="编解码器框架">编解码器框架<a hidden class="anchor" aria-hidden="true" href="#编解码器框架">#</a></h1>
<p>就像很多标准的架构模式都被各种专用框架所支持一样，常见的数据处理模式往往也是目标实现的很好的候选对象，它可以节省开发人员大量的时间和精力。当然这也适应于本章的主题：编码和解码，或者数据从一种特定协议的格式到另一种格式的转换。这些任务将由通常称为编解码器的组件来处理。Netty 提供了多种组件，简化了为了支持广泛的协议而创建自定义的编解码器的过程。例如，如果你正在构建一个基于 Netty的邮件服务器，那么你将会发现 Netty 对于编解码器的支持对于实现 POP3、IMAP 和 SMTP 协议来说是多么的宝贵。</p>
<h2 id="什么是编解码器">什么是编解码器<a hidden class="anchor" aria-hidden="true" href="#什么是编解码器">#</a></h2>
<p>每个网络应用程序都必须定义如何解析在两个节点之间来回传输的原始字节，以及如何将其和目标应用程序的数据格式做相互转换。这种转换逻辑由编解码器处理，编解码器由编码器和解码器组成，它们每种都可以将字节流从一种格式转换为另一种格式。那么它们的区别是什么呢？如果将消息看作是对于特定的应用程序具有具体含义的结构化的字节序列—它的数据。那么编码器是将消息转换为适合于传输的格式（最有可能的就是字节流）；而对应的解码器则是将网络字节流转换回应用程序的消息格式。因此，编码器操作出站数据，而解码器处理入站数据。记住这些背景信息，接下来让我们研究一下 Netty 所提供的用于实现这两种组件的类。</p>
<h2 id="解码器">解码器<a hidden class="anchor" aria-hidden="true" href="#解码器">#</a></h2>
<p>在这一节中，我们将研究 Netty 所提供的解码器类，并提供关于何时以及如何使用它们的具体示例。
这些类覆盖了两个不同的用例：</p>
<ul>
<li>将字节解码为消息——ByteToMessageDecoder 和 ReplayingDecoder；</li>
<li>将一种消息类型解码为另一种——MessageToMessageDecoder。
因为解码器是负责将入站数据从一种格式转换到另一种格式的，所以知道 Netty 的解码器实现了
ChannelInboundHandler 也不会让你感到意外。
什么时候会用到解码器呢？很简单：每当需要为 ChannelPipeline 中的下一个 ChannelInboundHandler 转换入站数据时会用到。此外，得益于 ChannelPipeline 的设计，可以将多个解码器链接在一起，以实现任意复杂的转换逻辑，这也是 Netty 是如何支持代码的模块化以及复用的一个很好的例子。</li>
</ul>
<h3 id="抽象类-bytetomessagedecoder">抽象类 ByteToMessageDecoder<a hidden class="anchor" aria-hidden="true" href="#抽象类-bytetomessagedecoder">#</a></h3>
<p>将字节解码为消息（或者另一个字节序列）是一项很常见的任务，Netty 为它提供了一个抽象的基类：ByteToMessageDecoder。由于你不可能知道远程节点是否会一次性地发送一个完整的消息，所以这个类会对入站数据进行缓冲，直到它准备好处理。表 10-1 解释了它最重要的两个方法。</p>
<table>
<thead>
<tr>
<th>方 法</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>decode( ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code></td>
<td>这是你必须实现的唯一抽象方法。decode()方法被调用时将会传 入一个包含了传入数据的 ByteBuf，以及一个用来添加解码消息 的 List。对这个方法的调用将会重复进行，直到确定没有新的元 素被添加到该 List，或者该 ByteBuf 中没有更多可读取的字节 时为止。然后，如果该 List 不为空，那么它的内容将会被传递给 ChannelPipeline 中的下一个 ChannelInboundHandler</td>
</tr>
<tr>
<td><code>decodeLast( ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code></td>
<td>Netty提供的这个默认实现只是简单地调用了decode()方法。 当Channel的状态变为非活动时，这个方法将会被调用一次。 可以重写该方法以提供特殊的处理</td>
</tr>
</tbody>
</table>
<p>下面举一个如何使用这个类的示例，假设你接收了一个包含简单 int 的字节流，每个 int都需要被单独处理。在这种情况下，你需要从入站 ByteBuf 中读取每个 int，并将它传递给ChannelPipeline 中的下一个ChannelInboundHandler。为了解码这个字节流，你要扩展ByteToMessageDecoder 类。
（需要注意的是，原子类型的 int 在被添加到 List 中时，会被自动装箱为 Integer。）该设计如图 10-1 所示。
<img loading="lazy" src="57.png" alt=""  />

每次从入站 ByteBuf 中读取 4 字节，将其解码为一个 int，然后将它添加到一个 List 中。
当没有更多的元素可以被添加到该 List 中时，它的内容将会被发送给下一个 ChannelInboundHandler。
代码清单 10-1 展示了 ToIntegerDecoder 的代码。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 10-1 ToIntegerDecoder 类扩展了 ByteToMessageDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展ByteToMessageDecoder类，以将字节解码为特定的格式
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ToIntegerDecoder <span style="color:#fff;font-weight:bold">extends</span> ByteToMessageDecoder {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//检查是否至少有 4 字节可读（一个 int 的字节长度）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (in.<span style="color:#007f7f">readableBytes</span>() &gt;= <span style="color:#ff0;font-weight:bold">4</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//从入站 ByteBuf 中读取一个 int，并将其添加到解码消息的 List 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            out.<span style="color:#007f7f">add</span>(in.<span style="color:#007f7f">readInt</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>虽然 ByteToMessageDecoder 使得可以很简单地实现这种模式，但是你可能会发现，在调用 readInt()方法前不得不验证所输入的 ByteBuf 是否具有足够的数据有点繁琐。在下一节中，我们将讨论 ReplayingDecoder，它是一个特殊的解码器，以少量的开销消除了这个步骤。
编解码器中的引用计数：
正如我们在第 5 章和第 6 章中所提到的，引用计数需要特别的注意。对于编码器和解码器来说，其过程也是相当的简单：一旦消息被编码或者解码，它就会被 ReferenceCountUtil.release(message)调用自动释放。如果你需要保留引用以便稍后使用，那么你可以调用 ReferenceCountUtil.retain(message)方法。这将会增加该引用计数，从而防止该消息被释放。</p>
<h3 id="抽象类-replayingdecoder">抽象类 ReplayingDecoder<a hidden class="anchor" aria-hidden="true" href="#抽象类-replayingdecoder">#</a></h3>
<p>ReplayingDecoder扩展了ByteToMessageDecoder类，使得我们不必调用 readableBytes()方法。它通过使用一个自定义的ByteBuf实现，ReplayingDecoderByteBuf，包装传入的ByteBuf实现了这一点，其将在内部调用 readableBytes()方法。这个类的完整声明是：
<code>public abstract class ReplayingDecoder&lt;S&gt; extends ByteToMessageDecoder</code>
类型参数 S 指定了用于状态管理的类型，其中 Void 代表不需要状态管理。
代码清单 10-2展示了基于 ReplayingDecoder 重新实现的 ToIntegerDecoder。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 10-2 ToIntegerDecoder2 类扩展了 ReplayingDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展 ReplayingDecoder&lt;Void&gt; 以将字节解码为消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ToIntegerDecoder2 <span style="color:#fff;font-weight:bold">extends</span> ReplayingDecoder&lt;Void&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, <span style="color:#007f7f">//传入的 ByteBuf 是 ReplayingDecoderByteBuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//从入站 ByteBuf 中读取 一个 int，并将其添加到解码消息的 List 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        out.<span style="color:#007f7f">add</span>(in.<span style="color:#007f7f">readInt</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>和之前一样，从ByteBuf中提取的int将会被添加到List中。如果没有足够的字节可用，这个readInt()方法的实现将会抛出一个Error(这里实际上抛出的是一个 Signal，详见 io.netty.util.Signal 类)，其将在基类中被捕获并处理。当有更多的数据可供读取时，该decode()方法将会被再次调用。
请注意 ReplayingDecoderByteBuf 的下面这些方面：</p>
<ul>
<li>并不是所有的 ByteBuf 操作都被支持，如果调用了一个不被支持的方法，将会抛出一个 UnsupportedOperationException；</li>
<li>ReplayingDecoder 稍慢于 ByteToMessageDecoder。
如果对比代码清单 10-1 和代码清单 10-2，你会发现后者明显更简单。示例本身是很基本的，所以请记住，在真实的、更加复杂的情况下，使用一种或者另一种作为基类所带来的差异可能是很显著的。这里有一个简单的准则：如果使用 ByteToMessageDecoder 不会引入太多的复杂性，那么请使用它；否则，请使用 ReplayingDecoder。更多的解码器：
io.netty.handler.codec.LineBasedFrameDecoder
这个类在 Netty 内部也有使用，它使用了行尾控制字符（\n 或者\r\n）来解析消息数据；</li>
</ul>
<p>io.netty.handler.codec.http.HttpObjectDecoder
一个 HTTP 数据的解码器。
在 io.netty.handler.codec 子包下面，你将会发现更多用于特定用例的编码器和解码器实现。</p>
<h3 id="抽象类-messagetomessagedecoder">抽象类 MessageToMessageDecoder<a hidden class="anchor" aria-hidden="true" href="#抽象类-messagetomessagedecoder">#</a></h3>
<p>在这一节中，我们将解释如何使用下面的抽象基类在两个消息格式之间进行转换
（例如，从一种 POJO 类型转换为另一种）：
<code>public abstract class MessageToMessageDecoder&lt;I&gt; extends ChannelInboundHandlerAdapter</code>
类型参数 I 指定了 decode()方法的输入参数 msg 的类型，它是你必须实现的唯一方法。
MessageToMessageDecoder的API：
<code>decode(ChannelHandlerContext ctx,I msg,List&lt;Object&gt; out)</code>
对于每个需要被解码为另一种格式的入站消息来说，该方法都将会被调用。
解码消息随后会被传递给 ChannelPipeline中的下一个 ChannelInboundHandler。</p>
<p>在这个示例中，我们将编写一个 IntegerToStringDecoder 解码器来扩展
<code>MessageToMessageDecoder&lt;Integer&gt;</code>。它的 decode()方法会把 Integer 参数转换为它的 String表示，并将拥有下列签名：
<code>public void decode( ChannelHandlerContext ctx,Integer msg, List&lt;Object&gt; out ) throws Exception</code></p>
<p>和之前一样，解码的String将被添加到传出的List中，并转发给下一个ChannelInboundHandler。
该设计如图 10-2 所示。
<img loading="lazy" src="58.png" alt=""  />

代码清单 10-3 给出了 IntegerToStringDecoder 的实现。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 10-3 IntegerToStringDecoder 类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展了MessageToMessageDecoder&lt;Integer&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> IntegerToStringDecoder <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageDecoder&lt;Integer&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, Integer msg, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将 Integer 消息转换为它的 String 表示，并将其添加到输出的 List 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        out.<span style="color:#007f7f">add</span>(String.<span style="color:#007f7f">valueOf</span>(msg));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>HttpObjectAggregator：
有关更加复杂的例子，请研究 io.netty.handler.codec.http.HttpObjectAggregator 类，
它扩展了<code>MessageToMessageDecoder&lt;HttpObject&gt;</code>。</p>
<h3 id="toolongframeexception-类">TooLongFrameException 类<a hidden class="anchor" aria-hidden="true" href="#toolongframeexception-类">#</a></h3>
<p>由于 Netty 是一个异步框架，所以需要在字节可以解码之前在内存中缓冲它们。因此，不能让解码器缓冲大量的数据以至于耗尽可用的内存。为了解除这个常见的顾虑，Netty 提供了TooLongFrameException 类，其将由解码器在帧超出指定的大小限制时抛出。
为了避免这种情况，你可以设置一个最大字节数的阈值，如果超出该阈值，则会导致抛出一个
TooLongFrameException（随后会被 ChannelHandler.exceptionCaught()方法捕获）。然后，如何处理该异常则完全取决于该解码器的用户。某些协议（如 HTTP）可能允许你返回一个特殊的响应。而在其他的情况下，唯一的选择可能就是关闭对应的连接。代码清单 10-4 展示了 ByteToMessageDecoder 是如何使用TooLongFrameException来通知 ChannelPipeline 中的其他 ChannelHandler 发生了帧大小溢出的。需要注意的是，如果你正在使用一个可变帧大小的协议，那么这种保护措施将是尤为重要的。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 10-4 TooLongFrameException
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展 ByteToMessageDecoder 以将字节解码为消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SafeByteToMessageDecoder <span style="color:#fff;font-weight:bold">extends</span> ByteToMessageDecoder {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> MAX_FRAME_SIZE = <span style="color:#ff0;font-weight:bold">1024</span>;
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">int</span> readable = in.<span style="color:#007f7f">readableBytes</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//检查缓冲区中是否有超过 MAX_FRAME_SIZE 个字节
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (readable &gt; MAX_FRAME_SIZE) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//跳过所有的可读字节，抛出 TooLongFrameException 并通知 ChannelHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                in.<span style="color:#007f7f">skipBytes</span>(readable);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> TooLongFrameException(<span style="color:#0ff;font-weight:bold">&#34;Frame too big!&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// do something
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>到目前为止，我们已经探讨了解码器的常规用例，以及 Netty 所提供的用于构建它们的抽象基类。但是解码器只是硬币的一面。硬币的另一面是编码器，它将消息转换为适合于传出传输的格式。这些编码器完备了编解码器 API，它们将是我们的下一个主题。</p>
<h2 id="编码器">编码器<a hidden class="anchor" aria-hidden="true" href="#编码器">#</a></h2>
<p>回顾一下我们先前的定义，编码器实现了 ChannelOutboundHandler，并将出站数据从一种格式转换为另一种格式，和我们方才学习的解码器的功能正好相反。
Netty 提供了一组类，用于帮助你编写具有以下功能的编码器：</p>
<ul>
<li>将消息编码为字节；</li>
<li>将消息编码为消息(另外一种格式的消息)</li>
</ul>
<h3 id="抽象类-messagetobyteencoder">抽象类 MessageToByteEncoder<a hidden class="anchor" aria-hidden="true" href="#抽象类-messagetobyteencoder">#</a></h3>
<p>encode(ChannelHandlerContext ctx,I msg,ByteBuf out)：
encode()方法是你需要实现的唯一抽象方法。它被调用时将会传入要被该类编码为 ByteBuf 的（类型为 I 的）出站消息。该 ByteBuf 随后将会被转发给 ChannelPipeline中的下一个 ChannelOutboundHandler。
编码器这个类只有一个方法，而解码器有两个。原因是是解码器通常需要在Channel 关闭之后产生最后一个消息（因此也就有了 decodeLast()方法），这显然不适用于编码器的场景，在连接被关闭之后仍然产生一个消息是毫无意义的。
图 10-3 展示了 ShortToByteEncoder，其接受一个 Short 类型的实例作为消息，将它编码为 Short 的原子类型值，并将它写入 ByteBuf 中，其将随后被转发给 ChannelPipeline 中的下一个ChannelOutboundHandler。每个传出的 Short 值都将会占用 ByteBuf 中的 2 字节。
<img loading="lazy" src="59.png" alt=""  />

ShortToByteEncoder 的实现如代码清单 10-5 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 10-5 ShortToByteEncoder 类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展了MessageToByteEncoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ShortToByteEncoder <span style="color:#fff;font-weight:bold">extends</span> MessageToByteEncoder&lt;Short&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext ctx, Short msg, ByteBuf out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将 Short 写入 ByteBuf 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        out.<span style="color:#007f7f">writeShort</span>(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Netty 提供了一些专门化的 MessageToByteEncoder，你可以基于它们实现自己的编码器。
WebSocket08FrameEncoder 类提供了一个很好的实例。
你可以在 io.netty.handler.codec.http.websocketx 包中找到它。</p>
<h3 id="抽象类-messagetomessageencoder">抽象类 MessageToMessageEncoder<a hidden class="anchor" aria-hidden="true" href="#抽象类-messagetomessageencoder">#</a></h3>
<p>MessageToMessageEncoder 类的 encode()方法，可以将出战数据从一种消息编码为另一种消息。
<code>encode(ChannelHandlerContext ctx,I msg,List&lt;Object&gt; out)</code>这是你需要实现的唯一方法。
每个通过 write()方法写入的消息都将会被传递给 encode()方法，以编码为一个或者多个出站消息。
随后，这些出站消息将会被转发给 ChannelPipeline中的下一个 ChannelOutboundHandler。
为了演示，代码清单 10-6 使用 IntegerToStringEncoder 扩展了 MessageToMessageEncoder。
其设计如图 10-4 所示。
<img loading="lazy" src="60.png" alt=""  />

如代码清单 10-6 所示，编码器将每个出站 Integer 的 String 表示添加到了该 List 中。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 10-6 IntegerToStringEncoder 类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展了 MessageToMessageEncoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> IntegerToStringEncoder <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageEncoder&lt;Integer&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext ctx, Integer msg, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将 Integer 转换为 String，并将其添加到 List 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        out.<span style="color:#007f7f">add</span>(String.<span style="color:#007f7f">valueOf</span>(msg));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="抽象的编解码器类">抽象的编解码器类<a hidden class="anchor" aria-hidden="true" href="#抽象的编解码器类">#</a></h2>
<p>虽然我们一直将解码器和编码器作为单独的实体讨论，但是你有时将会发现在同一个类中管理入站和出站数据和消息的转换是很有用的。Netty 的抽象编解码器类正好用于这个目的，因为它们每个都将捆绑一个解码器/编码器对，以处理我们一直在学习的这两种类型的操作。正如同你可能已经猜想到的，这些类同时实现了ChannelInboundHandler 和 ChannelOutboundHandler 接口。为什么我们并没有一直优先于单独的解码器和编码器使用这些复合类呢？因为通过尽可能地将这两种功能分开，最大化了代码的可重用性和可扩展性，这是 Netty 设计的一个基本原则。在我们查看这些抽象的编解码器类时，我们将会把它们与相应的单独的解码器和编码器进行比较和参照。</p>
<h3 id="抽象类-bytetomessagecodec">抽象类 ByteToMessageCodec<a hidden class="anchor" aria-hidden="true" href="#抽象类-bytetomessagecodec">#</a></h3>
<p>让我们来研究这样的一个场景：我们需要将字节解码为某种形式的消息，可能是 POJO，随后再次对它进行编码。ByteToMessageCodec 将为我们处理好这一切，因为它结合了ByteToMessageDecoder 以及它的逆向——MessageToByteEncoder。表 10-5 列出了其中重要的方法。</p>
<table>
<thead>
<tr>
<th>方 法 名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>decode( ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt;)</code></td>
<td>只要有字节可以被消费，这个方法就将会被调用。它将入站 ByteBuf 转换为指定的消息格式，并将其转发给 ChannelPipeline 中的下一个 ChannelInboundHandler</td>
</tr>
<tr>
<td><code>decodeLast( ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code></td>
<td>这个方法的默认实现委托给了 decode()方法。它只会在 Channel 的状态变为非活动时被调用一次。它可以被重写以 实现特殊的处理</td>
</tr>
<tr>
<td>encode( ChannelHandlerContext ctx, I msg, ByteBuf out)</td>
<td>对于每个将被编码并写入出站 ByteBuf 的（类型为 I 的） 消息来说，这个方法都将会被调用</td>
</tr>
</tbody>
</table>
<p>任何的请求/响应协议都可以作为使用ByteToMessageCodec的理想选择。例如，在某个SMTP的实现中，编解码器将读取传入字节，并将它们解码为一个自定义的消息类型，如SmtpRequest。而在接收端，当一个响应被创建时，将会产生一个SmtpResponse，其将被编码回字节以便进行传输。</p>
<h3 id="抽象类-messagetomessagecodec">抽象类 MessageToMessageCodec<a hidden class="anchor" aria-hidden="true" href="#抽象类-messagetomessagecodec">#</a></h3>
<p>在 10.3.1 节中，你看到了一个扩展了 MessageToMessageEncoder 以将一种消息格式转换为另外一种消息格式的例子。通过使用 MessageToMessageCodec，我们可以在一个单个的类中实现该转换的往返过程。MessageToMessageCodec 是一个参数化的类，定义如下：
<code>public abstract class MessageToMessageCodec&lt;INBOUND_IN,OUTBOUND_IN&gt;</code></p>
<table>
<thead>
<tr>
<th>方 法 名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>protected abstract decode( ChannelHandlerContext ctx, INBOUND_IN msg, List&lt;Object&gt; out)</code></td>
<td>这个方法被调用时会被传入 INBOUND_IN 类型的消息。 它将把它们解码为 OUTBOUND_IN 类型的消息，这些消息 将被转发给 ChannelPipeline 中的下一个 ChannelInboundHandler</td>
</tr>
<tr>
<td><code>protected abstract encode( ChannelHandlerContext ctx, OUTBOUND_IN msg, List&lt;Object&gt; out)</code></td>
<td>对于每个 OUTBOUND_IN 类型的消息，这个方法都将会 被调用。这些消息将会被编码为 INBOUND_IN 类型的消 息，然后被转发给 ChannelPipeline 中的下一个 ChannelOutboundHandler</td>
</tr>
</tbody>
</table>
<p>decode()方法是将INBOUND_IN类型的消息转换为OUTBOUND_IN类型的消息，而encode()方法则进行它的逆向操作。将INBOUND_IN类型的消息看作是通过网络发送的类型，而将OUTBOUND_IN类型的消息看作是应用程序所处理的类型，将可能有所裨益。
虽然这个编解码器可能看起来有点高深，但是它所处理的用例却是相当常见的：在两种不同的消息 API 之间来回转换数据。当我们不得不和使用遗留或者专有消息格式的 API 进行互操作时，我们经常会遇到这种模式。WebSocket 协议：
下面关于 MessageToMessageCodec 的示例引用了一个新出的 WebSocket 协议，这个协议能实现 Web 浏览器和服务器之间的全双向通信。我们将在第 12 章中详细地讨论 Netty 对于 WebSocket 的支持。</p>
<p>代码清单 10-7 展示了Web 浏览器和服务器之间的双向通信可能的实现方式。
我们的WebSocketConvertHandler在参数化MessageToMessageCodec时将使用INBOUND_IN类型的WebSocketFrame，以及OUTBOUND_IN类型的MyWebSocketFrame，后者是WebSocketConvertHandler
本身的一个静态嵌套类。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 10-7 使用 MessageToMessageCodec
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>@Sharable
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WebSocketConvertHandler <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageCodec&lt;WebSocketFrame, WebSocketConvertHandler.<span style="color:#007f7f">MyWebSocketFrame</span>&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     @Override
</span></span><span style="display:flex;"><span>     <span style="color:#007f7f">//将 MyWebSocketFrame 编码为指定的 WebSocketFrame 子类型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>     <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext ctx, WebSocketConvertHandler.<span style="color:#007f7f">MyWebSocketFrame</span> msg, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>         ByteBuf payload = msg.<span style="color:#007f7f">getData</span>().<span style="color:#007f7f">duplicate</span>().<span style="color:#007f7f">retain</span>();
</span></span><span style="display:flex;"><span>         <span style="color:#007f7f">//实例化一个指定子类型的 WebSocketFrame
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>         <span style="color:#fff;font-weight:bold">switch</span> (msg.<span style="color:#007f7f">getType</span>()) {
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> BINARY:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> BinaryWebSocketFrame(payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> TEXT:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> TextWebSocketFrame(payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> CLOSE:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> CloseWebSocketFrame(<span style="color:#fff;font-weight:bold">true</span>, <span style="color:#ff0;font-weight:bold">0</span>, payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> CONTINUATION:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> ContinuationWebSocketFrame(payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> PONG:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> PongWebSocketFrame(payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">case</span> PING:
</span></span><span style="display:flex;"><span>                 out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> PingWebSocketFrame(payload));
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>             <span style="color:#fff;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>                 <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalStateException(<span style="color:#0ff;font-weight:bold">&#34;Unsupported websocket msg &#34;</span> + msg);}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//将 WebSocketFrame 解码为 MyWebSocketFrame，并设置 FrameType
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, WebSocketFrame msg, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ByteBuf payload = msg.<span style="color:#007f7f">content</span>().<span style="color:#007f7f">duplicate</span>().<span style="color:#007f7f">retain</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> BinaryWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame(MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">BINARY</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> CloseWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame (MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">CLOSE</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> PingWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame (MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">PING</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> PongWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame (MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">PONG</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> TextWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame (MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">TEXT</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (msg <span style="color:#fff;font-weight:bold">instanceof</span> ContinuationWebSocketFrame) {
</span></span><span style="display:flex;"><span>            out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> MyWebSocketFrame (MyWebSocketFrame.<span style="color:#007f7f">FrameType</span>.<span style="color:#007f7f">CONTINUATION</span>, payload));
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalStateException(<span style="color:#0ff;font-weight:bold">&#34;Unsupported websocket msg &#34;</span> + msg);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//声明 WebSocketConvertHandler 所使用的 OUTBOUND_IN 类型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> MyWebSocketFrame {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//定义拥有被包装的有效负载的 WebSocketFrame 的类型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">enum</span> FrameType {
</span></span><span style="display:flex;"><span>            BINARY,
</span></span><span style="display:flex;"><span>            CLOSE,
</span></span><span style="display:flex;"><span>            PING,
</span></span><span style="display:flex;"><span>            PONG,
</span></span><span style="display:flex;"><span>            TEXT,
</span></span><span style="display:flex;"><span>            CONTINUATION
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> FrameType type;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ByteBuf data;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> MyWebSocketFrame(FrameType type, ByteBuf data) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">type</span> = type;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">data</span> = data;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> FrameType getType() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> type;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> ByteBuf getData() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> data;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="combinedchannelduplexhandler-类">CombinedChannelDuplexHandler 类<a hidden class="anchor" aria-hidden="true" href="#combinedchannelduplexhandler-类">#</a></h3>
<p>正如我们前面所提到的，结合一个解码器和编码器可能会对可重用性造成影响。但是，有一种方法既能够避免这种惩罚，又不会牺牲将一个解码器和一个编码器作为一个单独的单元部署所带来的便利性。
CombinedChannelDuplexHandler 提供了这个解决方案，其声明为：
public class CombinedChannelDuplexHandler
&lt;I extends ChannelInboundHandler,
O extends ChannelOutboundHandler&gt;</p>
<p>这个类充当了 ChannelInboundHandler 和 ChannelOutboundHandler（该类的类型参数 I 和 O）的容器。通过提供分别继承了解码器类和编码器类的类型，我们可以实现一个编解码器，而又不必直接扩展抽象的编解码器类。我们将在下面的示例中说明这一点。首先，让我们研究代码清单 10-8 中的 ByteToCharDecoder。注意，该实现扩展了 ByteToMessageDecoder，因为它要从 ByteBuf 中读取字符。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 10-8 ByteToCharDecoder 类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展了ByteToMessageDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ByteToCharDecoder <span style="color:#fff;font-weight:bold">extends</span> ByteToMessageDecoder {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (in.<span style="color:#007f7f">readableBytes</span>() &gt;= <span style="color:#ff0;font-weight:bold">2</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//将一个或者多个 Character 对象添加到传出的 List 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            out.<span style="color:#007f7f">add</span>(in.<span style="color:#007f7f">readChar</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里的 decode()方法一次将从 ByteBuf 中提取 2 字节，并将它们作为 char 写入到 List中，其将会被自动装箱为 Character 对象。代码清单 10-9 包含了 CharToByteEncoder，它能将 Character 转换回字节。这个类扩展了 MessageToByteEncoder，因为它需要将 char 消息编码到 ByteBuf 中。这是通过直接写入 ByteBuf 做到的。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 9 CharToByteEncoder 类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展了MessageToByteEncoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CharToByteEncoder <span style="color:#fff;font-weight:bold">extends</span>
</span></span><span style="display:flex;"><span>    MessageToByteEncoder&lt;Character&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext ctx, Character msg, ByteBuf out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将 Character 解码为 char，并将其写入到出站 ByteBuf 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        out.<span style="color:#007f7f">writeChar</span>(msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>既然我们有了解码器和编码器，我们将会结合它们来构建一个编解码器。
代码清单 10-10 展示了这是如何做到的。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 CombinedChannelDuplexHandler&lt;I,O&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//通过该解码器和编码器实现参数化 CombinedByteCharCodec
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CombinedByteCharCodec <span style="color:#fff;font-weight:bold">extends</span>
</span></span><span style="display:flex;"><span>    CombinedChannelDuplexHandler&lt;ByteToCharDecoder, CharToByteEncoder&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> CombinedByteCharCodec() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将委托实例传递给父类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">super</span>(<span style="color:#fff;font-weight:bold">new</span> ByteToCharDecoder(), <span style="color:#fff;font-weight:bold">new</span> CharToByteEncoder());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>正如你所能看到的，在某些情况下，通过这种方式结合实现相对于使用编解码器类的方式来说可能更加的简单也更加的灵活。当然，这可能也归结于个人的偏好问题。</p>
<h2 id="小结-3">小结<a hidden class="anchor" aria-hidden="true" href="#小结-3">#</a></h2>
<p>在本章中，我们学习了如何使用 Netty 的编解码器 API 来编写解码器和编码器。你也了解了为什么使用这个API 相对于直接使用 ChannelHandler API 更好。你看到了抽象的编解码器类是如何为在一个实现中处理解码和编码提供支持的。如果你需要更大的灵活性，或者希望重用现有的实现，那么你还可以选择结合他们，而无需扩展任何抽象的编解码器类。在下一章中，我们将讨论作为 Netty 框架本身的一部分的ChannelHandler 实现和编解码器，你可以利用它们来处理特定的协议和任务。</p>
<h1 id="预置的channelhandler和编解码器">预置的ChannelHandler和编解码器<a hidden class="anchor" aria-hidden="true" href="#预置的channelhandler和编解码器">#</a></h1>
<p>Netty 为许多通用协议提供了编解码器和处理器，几乎可以开箱即用，这减少了你在那些相当繁琐的事务上本来会花费的时间与精力。在本章中，我们将探讨这些工具以及它们所带来的好处，其中包括 Netty 对于SSL/TLS 和 WebSocket 的支持，以及如何简单地通过数据压缩来压榨HTTP，以获取更好的性能。</p>
<h2 id="通过-ssltls-保护-netty-应用程序">通过 SSL/TLS 保护 Netty 应用程序<a hidden class="anchor" aria-hidden="true" href="#通过-ssltls-保护-netty-应用程序">#</a></h2>
<p>如今，数据隐私是一个非常值得关注的问题，作为开发人员，我们需要准备好应对它。至少，我们应该熟悉像SSL和TLS这样的安全协议议，它们层叠在其他协议之上，用以实现数据安全。我们在访问安全网站时遇到过这些协议，但是它们也可用于其他不是基于HTTP的应用程序，如安全SMTP（SMTPS）邮件服务器甚至是关系型数据库系统。
为了支持 SSL/TLS，Java 提供了 javax.net.ssl 包，它的 SSLContext 和 SSLEngine类使得实现解密和加密相当简单直接。Netty 通过一个名为 SslHandler 的 ChannelHandler实现利用了这个 API，其中 SslHandler在内部使用 SSLEngine 来完成实际的工作。图 11-1 展示了使用 SslHandler 的数据流。
<img loading="lazy" src="61.png" alt=""  />
</p>
<p>Netty 的 OpenSSL/SSLEngine 实现：
Netty 还提供了使用 OpenSSL 工具包  <a href="https://www.openssl.org">www.openssl.org</a>  的 SSLEngine 实现。这个 OpenSslEngine 类提供了比 JDK 提供的 SSLEngine 实现更好的性能。如果OpenSSL库可用，可以将Netty应用程序（客户端和服务器）配置为默认使用OpenSslEngine。如果不可用，Netty 将会回退到 JDK 实现。有关配置 OpenSSL 支持的详细说明，参见 Netty 文档：http://netty.io/wiki/forked-tomcat-native.html#wikih2-1。
注意，无论你使用 JDK 的 SSLEngine 还是使用 Netty 的 OpenSslEngine，SSL API 和数据流都是一致的。代码清单11-1展示了如何使用ChannelInitializer来将SslHandler添加到ChannelPipeline 中。回想一下，ChannelInitializer 用于在 Channel 注册好时设置 ChannelPipeline。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-1 添加 SSL/TLS 支持
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SslChannelInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SslContext context;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> startTls;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SslChannelInitializer(SslContext context,     <span style="color:#007f7f">//传入要使用的 SslContext
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">boolean</span> startTls) {                              <span style="color:#007f7f">//如果设置为 true，第一个写入的消息将不会被加密（客户端应该设置为 true）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">context</span> = context;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">startTls</span> = startTls;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//对于每个 SslHandler 实例，都使用 Channel 的 ByteBufAllocator 从 SslContext 获取一个新的 SSLEngine
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        SSLEngine engine = context.<span style="color:#007f7f">newEngine</span>(ch.<span style="color:#007f7f">alloc</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将 SslHandler 作为第一个 ChannelHandler 添加到 ChannelPipeline 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addFirst</span>(<span style="color:#0ff;font-weight:bold">&#34;ssl&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> SslHandler(engine, startTls));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在大多数情况下，SslHandler 将是 ChannelPipeline 中的第一个 ChannelHandler。这确保了只有在所有其他的 ChannelHandler 将它们的逻辑应用到数据之后，才会进行加密。SslHandler 具有一些有用的方法，如表 11-1 所示。例如，在握手阶段，两个节点将相互验证并且商定一种加密方式。
你可以通过配置 SslHandler 来修改它的行为，或者在 SSL/TLS握手一旦完成之后提供通知，握手阶段完成之后，所有的数据都将会被加密。SSL/TLS 握手将会被自动执行。</p>
<table>
<thead>
<tr>
<th>方 法 名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>setHandshakeTimeout (long,TimeUnit) setHandshakeTimeoutMillis (long) getHandshakeTimeoutMillis()</td>
<td>设置和获取超时时间，超时之后，握手 ChannelFuture 将会被通知失败</td>
</tr>
<tr>
<td>setCloseNotifyTimeout (long,TimeUnit) setCloseNotifyTimeoutMillis (long) getCloseNotifyTimeoutMillis()</td>
<td>设置和获取超时时间，超时之后，将会触 发一个关闭通知并关闭连接。这也将会导 致通知该 ChannelFuture 失败</td>
</tr>
<tr>
<td>handshakeFuture()</td>
<td>返回一个在握手完成后将会得到通知的 ChannelFuture。如果握手先前已经执 行过了，则返回一个包含了先前的握手结 果的 ChannelFuture</td>
</tr>
<tr>
<td>close() close(ChannelPromise) close(ChannelHandlerContext,ChannelPromise)</td>
<td>发送 close_notify 以请求关闭并销毁 底层的 SslEngine</td>
</tr>
</tbody>
</table>
<h2 id="构建基于-netty-的-httphttps-应用程序">构建基于 Netty 的 HTTP/HTTPS 应用程序<a hidden class="anchor" aria-hidden="true" href="#构建基于-netty-的-httphttps-应用程序">#</a></h2>
<p>HTTP/HTTPS 是最常见的协议套件之一，并且随着智能手机的成功，它的应用也日益广泛，因为对于任何公司来说，拥有一个可以被移动设备访问的网站几乎是必须的。这些协议也被用于其他方面。许多组织导出的用于和他们的商业合作伙伴通信的 WebService API 一般也是基于HTTP（S）的。接下来，我们来看看 Netty提供的 ChannelHandler，你可以用它来处理 HTTP 和 HTTPS协议，而不必编写自定义的编解码器。</p>
<h3 id="http-解码器编码器和编解码器">HTTP 解码器、编码器和编解码器<a hidden class="anchor" aria-hidden="true" href="#http-解码器编码器和编解码器">#</a></h3>
<p>HTTP 是基于请求/响应模式的：客户端向服务器发送一个 HTTP 请求，然后服务器将会返回一个 HTTP 响应。
Netty 提供了多种编码器和解码器以简化对这个协议的使用。
图 11-2 和图 11-3分别展示了生产和消费 HTTP 请求和 HTTP 响应的方法。
<img loading="lazy" src="62.png" alt=""  />

<img loading="lazy" src="63.png" alt=""  />

如图 11-2 和图 11-3 所示，一个 HTTP 请求/响应可能由多个数据部分组成，并且它总是以一个
LastHttpContent 部分作为结束。FullHttpRequest 和 FullHttpResponse 消息是特殊的子类型，分别代表了完整的请求和响应。所有类型的 HTTP 消息（FullHttpRequest、LastHttpContent 以及代码清单 11-2 中展示的那些）都实现了 HttpObject 接口。
表 11-2 概要地介绍了处理和生成这些消息的 HTTP 解码器和编码器。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>HttpRequestEncoder</td>
<td>将HttpRequest、HttpContent 和 LastHttpContent 消息编码为字节</td>
</tr>
<tr>
<td>HttpResponseEncoder</td>
<td>将HttpResponse、HttpContent 和LastHttpContent 消息编码为字节</td>
</tr>
<tr>
<td>HttpRequestDecoder</td>
<td>将字节解码为HttpRequest、HttpContent 和 LastHttpContent 消息</td>
</tr>
<tr>
<td>HttpResponseDecoder</td>
<td>将字节解码为HttpResponse、HttpContent 和LastHttpContent 消息</td>
</tr>
</tbody>
</table>
<p>代码清单 11-2 中的 HttpPipelineInitializer 类展示了将 HTTP 支持添加到你的应用程序是多么简单，
只需要将正确的 ChannelHandler 添加到 ChannelPipeline 中。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-2 添加 HTTP 支持
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpPipelineInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> client;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpPipelineInitializer(<span style="color:#fff;font-weight:bold">boolean</span> client) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">client</span> = client;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (client) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是客户端，则添加 HttpResponseDecoder 以处理来自服务器的响应
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;decoder&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpResponseDecoder());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是客户端，则添加 HttpRequestEncoder 以向服务器发送请求
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;encoder&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpRequestEncoder());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是服务器，则添加 HttpRequestDecoder 以接收来自客户端的请求
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;decoder&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpRequestDecoder());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是服务器，则添加 HttpResponseEncoder 以向客户端发送响应
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;encoder&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpResponseEncoder());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="聚合-http-消息">聚合 HTTP 消息<a hidden class="anchor" aria-hidden="true" href="#聚合-http-消息">#</a></h3>
<p>在 ChannelInitializer 将 ChannelHandler 安装到 ChannelPipeline 中之后，你便可以处理不同类型的
HttpObject 消息了。但是由于 HTTP 的请求和响应可能由许多部分组成，因此你需要聚合它们以形成完整的消息。为了消除这项繁琐的任务，Netty 提供了一个聚合器，它可以将多个消息部分合并为
FullHttpRequest 或者 FullHttpResponse 消息。通过这样的方式，你将总是看到完整的消息内容。
由于消息分段需要被缓冲，直到可以转发一个完整的消息给下一个 ChannelInboundHandler，所以这个操作有轻微的开销。其所带来的好处便是你不必关心消息碎片了。引入这种自动聚合机制只不过是向ChannelPipeline 中添加另外一个 ChannelHandler罢了。代码清单 11-3 展示了如何做到这一点。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-3 自动聚合 HTTP 的消息片段
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpAggregatorInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> isClient;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpAggregatorInitializer(<span style="color:#fff;font-weight:bold">boolean</span> isClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">isClient</span> = isClient;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (isClient) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是客户端，则添加 HttpClientCodec
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpClientCodec());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是服务器，则添加 HttpServerCodec
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpServerCodec());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将最大的消息大小为 512 KB 的 HttpObjectAggregator 添加到 ChannelPipeline
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;aggregator&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpObjectAggregator(<span style="color:#ff0;font-weight:bold">512</span> * <span style="color:#ff0;font-weight:bold">1024</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="http-压缩">HTTP 压缩<a hidden class="anchor" aria-hidden="true" href="#http-压缩">#</a></h3>
<p>当使用 HTTP 时，建议开启压缩功能以尽可能多地减小传输数据的大小。虽然压缩会带来一些 CPU 时钟周期上的开销，但是通常来说它都是一个好主意，特别是对于文本数据来说。
Netty 为压缩和解压缩提供了 ChannelHandler 实现，它们同时支持 gzip 和 deflate 编码。
HTTP 请求的头部信息：
客户端可以通过提供以下头部信息来指示服务器它所支持的压缩格式：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>GET /encrypted-area HTTP/1.1
</span></span><span style="display:flex;"><span>Host: www.example.com
</span></span><span style="display:flex;"><span>Accept-Encoding: gzip, deflate
</span></span></code></pre></td></tr></table>
</div>
</div><p>然而，需要注意的是，服务器没有义务压缩它所发送的数据。
代码清单 11-4 展示了一个例子。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-4 自动压缩 HTTP 消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpCompressionInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> isClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpCompressionInitializer(<span style="color:#fff;font-weight:bold">boolean</span> isClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">isClient</span> = isClient;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (isClient) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是客户端，则添加 HttpClientCodec
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpClientCodec());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是客户端，则添加 HttpContentDecompressor 以处理来自服务器的压缩内容
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;decompressor&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpContentDecompressor());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是服务器，则添加 HttpServerCodec
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpServerCodec());
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是服务器，则添加HttpContentCompressor 来压缩数据（如果客户端支持它）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;compressor&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpContentCompressor());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用-https">使用 HTTPS<a hidden class="anchor" aria-hidden="true" href="#使用-https">#</a></h3>
<p>代码清单 11-5 显示，启用 HTTPS 只需要将SslHandler添加到 ChannelPipeline 的ChannelHandler 组合中。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-5 使用 HTTPS
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpsCodecInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SslContext context;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> isClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpsCodecInitializer(SslContext context, <span style="color:#fff;font-weight:bold">boolean</span> isClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">context</span> = context;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">isClient</span> = isClient;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        SSLEngine engine = context.<span style="color:#007f7f">newEngine</span>(ch.<span style="color:#007f7f">alloc</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将 SslHandler 添加到ChannelPipeline 中以使用 HTTPS
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addFirst</span>(<span style="color:#0ff;font-weight:bold">&#34;ssl&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> SslHandler(engine));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (isClient) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是客户端，则添加 HttpClientCodec
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpClientCodec());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果是服务器，则添加 HttpServerCodec
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#0ff;font-weight:bold">&#34;codec&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> HttpServerCodec());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码说明了 Netty 的架构方式是如何将代码重用变为杠杆作用的。只需要简单地将一个ChannelHandler添加到 ChannelPipeline 中，便可以提供一项新功能，甚至像加密这样重要的功能都能提供。</p>
<h3 id="websocket">WebSocket<a hidden class="anchor" aria-hidden="true" href="#websocket">#</a></h3>
<p>Netty 针对基于 HTTP 的应用程序的广泛工具包中包括了对它的一些最先进的特性的支持。在这一节中，我们将探讨 WebSocket：一种在 2011 年被互联网工程任务组（IETF）标准化的协议。
WebSocket解决了一个长期存在的问题：既然底层的协议（HTTP）是一个请求/响应模式的交互序列，那么如何实时地发布信息呢？AJAX提供了一定程度上的改善，但是数据流仍然是由客户端所发送的请求驱动的。
还有其他的一些或多或少的取巧方式（如Comet），但是最终它们仍然属于扩展性受限的变通之法。WebSocket规范以及它的实现代表了对一种更加有效的解决方案的尝试。简单地说，WebSocket提供了“在一个单个的TCP连接上提供双向的通信……结合WebSocket API……它为网页和远程服务器之间的双向通信提供了一种替代HTTP轮询的方案。”
也就是说，WebSocket 在客户端和服务器之间提供了真正的双向数据交换。我们不会深入地描述太多的内部细节，但是我们还是应该提到，尽管最早的实现仅限于文本数据，但是现在已经不是问题了；WebSocket现在可以用于传输任意类型的数据，很像普通的套接字。
图 11-4 给出了 WebSocket 协议的一般概念。在这个场景下，通信将作为普通的 HTTP 协议开始，随后升级到双向的 WebSocket 协议。<img loading="lazy" src="64.png" alt=""  />

要想向你的应用程序中添加对于 WebSocket 的支持，你需要将适当的客户端或者服务器ChannelHandler添加到 ChannelPipeline 中。这个类将处理由 WebSocket 定义的称为帧的特殊消息类型。如表 11-3 所示，WebSocketFrame 可以被归类为数据帧或者控制帧。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>BinaryWebSocketFrame</td>
<td>数据帧：二进制数据</td>
</tr>
<tr>
<td>TextWebSocketFrame</td>
<td>数据帧：文本数据</td>
</tr>
<tr>
<td>ContinuationWebSocketFrame</td>
<td>数据帧：属于上一个 BinaryWebSocketFrame 或者 TextWebSocketFrame 的文本的或者二进制数据</td>
</tr>
<tr>
<td>CloseWebSocketFrame</td>
<td>控制帧：一个 CLOSE 请求、关闭的状态码以及关闭的原因</td>
</tr>
<tr>
<td>PingWebSocketFrame</td>
<td>控制帧：请求一个 PongWebSocketFrame</td>
</tr>
<tr>
<td>PongWebSocketFrame</td>
<td>控制帧：对 PingWebSocketFrame 请求的响应</td>
</tr>
</tbody>
</table>
<p>因为Netty主要是一种服务器端的技术，所以在这里我们重点创建WebSocket服务器。
关于WebSocket的客户端示例，请参考Netty源代码中所包含的例子：https://github.com/netty/netty/
tree/4.1/example/src/main/java/io/netty/example/http/websocketx/client。
代码清单 11-6 展示了一个使用WebSocketServerProtocolHandler的简单示例，这个类处理协议升级握手，以及 3 种控制帧——Close、Ping和Pong。Text和Binary数据帧将会被传递给下一个（由你实现的）ChannelHandler进行处理。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-6 在服务器端支持 WebSocket
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> WebSocketServerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> HttpServerCodec(),
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//为握手提供聚合的 HttpRequest
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">new</span> HttpObjectAggregator(<span style="color:#ff0;font-weight:bold">65536</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果被请求的端点是&#34;/websocket&#34;，则处理该升级握手
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">new</span> WebSocketServerProtocolHandler(<span style="color:#0ff;font-weight:bold">&#34;/websocket&#34;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//TextFrameHandler 处理 TextWebSocketFrame
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">new</span> TextFrameHandler(),
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//BinaryFrameHandler 处理 BinaryWebSocketFrame
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">new</span> BinaryFrameHandler(),
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//ContinuationFrameHandler 处理 ContinuationWebSocketFrame
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">new</span> ContinuationFrameHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> TextFrameHandler <span style="color:#fff;font-weight:bold">extends</span>
</span></span><span style="display:flex;"><span>        SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>            TextWebSocketFrame msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Handle text frame
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> BinaryFrameHandler <span style="color:#fff;font-weight:bold">extends</span>
</span></span><span style="display:flex;"><span>        SimpleChannelInboundHandler&lt;BinaryWebSocketFrame&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>            BinaryWebSocketFrame msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Handle binary frame
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ContinuationFrameHandler <span style="color:#fff;font-weight:bold">extends</span>
</span></span><span style="display:flex;"><span>        SimpleChannelInboundHandler&lt;ContinuationWebSocketFrame&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>            ContinuationWebSocketFrame msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Handle continuation frame
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>要想为 WebSocket 添加安全性，只需要将 SslHandler 作为第一个 ChannelHandler添加到
ChannelPipeline 中。更加全面的示例参见第 12 章，那一章会深入探讨实时 WebSocket 应用程序的设计。</p>
<h2 id="空闲的连接和超时">空闲的连接和超时<a hidden class="anchor" aria-hidden="true" href="#空闲的连接和超时">#</a></h2>
<p>检测空闲连接以及超时对于及时释放资源来说是至关重要的。由于这是一项常见的任务，Netty 特地为它提供了几个 ChannelHandler 实现。表 11-4 给出了它们的概述。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>IdleStateHandler</td>
<td>当连接空闲时间太长时，将会触发一个 IdleStateEvent 事件。然后， 你可以通过在你的 ChannelInboundHandler 中重写 userEventTriggered()方法来处理该 IdleStateEvent 事件</td>
</tr>
<tr>
<td>ReadTimeoutHandler</td>
<td>如果在指定的时间间隔内没有收到任何的入站数据，则抛出一个 ReadTimeoutException 并关闭对应的 Channel。可以通过重写你的 ChannelHandler 中的 exceptionCaught()方法来检测该 ReadTimeoutException</td>
</tr>
<tr>
<td>WriteTimeoutHandler</td>
<td>如果在指定的时间间隔内没有任何出站数据写入，则抛出一个 WriteTimeoutException 并关闭对应的 Channel 。可以通过重写你的 ChannelHandler 的 exceptionCaught()方法检测该 WriteTimeoutException</td>
</tr>
</tbody>
</table>
<p>让我们仔细看看在实践中使用得最多的 IdleStateHandler 吧。代码清单 11-7 展示了当使用通常的发送心跳消息到远程节点的方法时，如果在 60 秒之内没有接收或者发送任何的数据，我们将如何得到通知；如果没有响应，则连接会被关闭。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-7 发送心跳
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> IdleStateHandlerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt;
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//(1) IdleStateHandler 将在被触发时发送一个IdleStateEvent 事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">new</span> IdleStateHandler(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">60</span>, TimeUnit.<span style="color:#007f7f">SECONDS</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将一个 HeartbeatHandler 添加到ChannelPipeline中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HeartbeatHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//实现 userEventTriggered() 方法以发送心跳消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> HeartbeatHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//发送到远程节点的心跳消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> ByteBuf HEARTBEAT_SEQUENCE =
</span></span><span style="display:flex;"><span>                Unpooled.<span style="color:#007f7f">unreleasableBuffer</span>(Unpooled.<span style="color:#007f7f">copiedBuffer</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;HEARTBEAT&#34;</span>, CharsetUtil.<span style="color:#007f7f">ISO_8859_1</span>));
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> userEventTriggered(ChannelHandlerContext ctx, Object evt) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(2) 发送心跳消息，并在发送失败时关闭该连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (evt <span style="color:#fff;font-weight:bold">instanceof</span> IdleStateEvent) {
</span></span><span style="display:flex;"><span>                ctx.<span style="color:#007f7f">writeAndFlush</span>(HEARTBEAT_SEQUENCE.<span style="color:#007f7f">duplicate</span>())
</span></span><span style="display:flex;"><span>                     .<span style="color:#007f7f">addListener</span>(
</span></span><span style="display:flex;"><span>                         ChannelFutureListener.<span style="color:#007f7f">CLOSE_ON_FAILURE</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//不是 IdleStateEvent 事件，所以将它传递给下一个 ChannelInboundHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">userEventTriggered</span>(ctx, evt);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个示例演示了如何使用 IdleStateHandler 来测试远程节点是否仍然还活着，并且在它失活时通过关闭连接来释放资源。如果连接超过 60 秒没有接收或者发送任何的数据，那么 IdleStateHandler 将会使用一个IdleStateEvent 事件来调用 fireUserEventTriggered()方法。HeartbeatHandler 实现了
userEventTriggered()方法，如果这个方法检测到 IdleStateEvent 事件，它将会发送心跳消息，并且添加一个将在发送操作失败时关闭该连接的 ChannelFutureListener 。</p>
<h2 id="解码基于分隔符的协议和基于长度的协议">解码基于分隔符的协议和基于长度的协议<a hidden class="anchor" aria-hidden="true" href="#解码基于分隔符的协议和基于长度的协议">#</a></h2>
<p>在使用 Netty 的过程中，你将会遇到需要解码器的基于分隔符和帧长度的协议。下一节将解释 Netty 所提供的用于处理这些场景的实现。</p>
<h3 id="基于分隔符的协议">基于分隔符的协议<a hidden class="anchor" aria-hidden="true" href="#基于分隔符的协议">#</a></h3>
<p>基于分隔符的（delimited）消息协议使用定义的字符来标记的消息或者消息段（通常被称为帧）的开头或者结尾。由RFC文档正式定义的许多协议（如SMTP、POP3、IMAP以及Telne )都是这样的。此外，当然，私有组织通常也拥有他们自己的专有格式。无论你使用什么样的协议，表 11-5 中列出的解码器都能帮助你定义可以提取由任意标记（token）序列分隔的帧的自定义解码器。无论你使用什么样的协议，表 11-5 中列出的解码器都能帮助你定义可以提取由任意标记（token）序列分隔的帧的自定义解码器。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>DelimiterBasedFrameDecoder</td>
<td>使用任何由用户提供的分隔符来提取帧的通用解码器</td>
</tr>
<tr>
<td>LineBasedFrameDecoder</td>
<td>提取由行尾符（\n 或者\r\n）分隔的帧的解码器。这个解码 器比 DelimiterBasedFrameDecoder 更快</td>
</tr>
</tbody>
</table>
<p>图 11-5 展示了当帧由行尾序列\r\n（回车符+换行符）分隔时是如何被处理的。
<img loading="lazy" src="65.png" alt=""  />
</p>
<p>代码清单 11-8 展示了如何使用 LineBasedFrameDecoder 来处理图 11-5 所示的场景。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-8 处理由行尾符分隔的帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LineBasedHandlerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//该 LineBasedFrameDecoder 将提取的帧转发给下一个 ChannelInboundHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> LineBasedFrameDecoder(<span style="color:#ff0;font-weight:bold">64</span> * <span style="color:#ff0;font-weight:bold">1024</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 FrameHandler 以接收帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> FrameHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> FrameHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;ByteBuf&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//传入了单个帧的内容
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, ByteBuf msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Do something with the data extracted from the frame
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果你正在使用除了行尾符之外的分隔符分隔的帧，那么你可以以类似的方式使用
DelimiterBasedFrameDecoder，只需要将特定的分隔符序列指定到其构造函数即可。
这些解码器是实现你自己的基于分隔符的协议的工具。作为示例，我们将使用下面的协议规范：</p>
<ul>
<li>传入数据流是一系列的帧，每个帧都由换行符（\n）分隔；</li>
<li>每个帧都由一系列的元素组成，每个元素都由单个空格字符分隔；</li>
<li>一个帧的内容代表一个命令，定义为一个命令名称后跟着数目可变的参数。</li>
</ul>
<p>我们用于这个协议的自定义解码器将定义以下类：</p>
<ul>
<li>Cmd—将帧（命令）的内容存储在 ByteBuf 中，一个 ByteBuf 用于名称，另一个用于参数；</li>
<li>CmdDecoder—从被重写了的 decode()方法中获取一行字符串，并从它的内容构建一个 Cmd 的实例；</li>
<li>CmdHandler—从 CmdDecoder 获取解码的 Cmd 对象，并对它进行一些处理；</li>
<li>CmdHandlerInitializer —为了简便起见，我们将会把前面的这些类定义为专门的 ChannelInitializer 的嵌套类，其将会把这些 ChannelInboundHandler 安装到 ChannelPipeline 中。
正如将在代码清单 11-9 中所能看到的那样，这个解码器的关键是扩展 LineBasedFrameDecoder。</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-9 使用 ChannelInitializer 安装解码器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CmdHandlerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">byte</span> SPACE = (<span style="color:#fff;font-weight:bold">byte</span>)<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>;
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 CmdDecoder 以提取 Cmd 对象，并将它转发给下一个 ChannelInboundHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> CmdDecoder(<span style="color:#ff0;font-weight:bold">64</span> * <span style="color:#ff0;font-weight:bold">1024</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 CmdHandler 以接收和处理 Cmd 对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> CmdHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//Cmd POJO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> Cmd {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ByteBuf name;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ByteBuf args;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> Cmd(ByteBuf name, ByteBuf args) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">name</span> = name;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">args</span> = args;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> ByteBuf name() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> name;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> ByteBuf args() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> args;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> CmdDecoder <span style="color:#fff;font-weight:bold">extends</span> LineBasedFrameDecoder {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> CmdDecoder(<span style="color:#fff;font-weight:bold">int</span> maxLength) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">super</span>(maxLength);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">protected</span> Object decode(ChannelHandlerContext ctx, ByteBuf buffer)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//从 ByteBuf 中提取由行尾符序列分隔的帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ByteBuf frame = (ByteBuf) <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">decode</span>(ctx, buffer);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (frame == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//如果输入中没有帧，则返回 null
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//查找第一个空格字符的索引。前面是命令名称，接着是参数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">int</span> index = frame.<span style="color:#007f7f">indexOf</span>(frame.<span style="color:#007f7f">readerIndex</span>(),
</span></span><span style="display:flex;"><span>                    frame.<span style="color:#007f7f">writerIndex</span>(), SPACE);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//使用包含有命令名称和参数的切片创建新的 Cmd 对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> Cmd(frame.<span style="color:#007f7f">slice</span>(frame.<span style="color:#007f7f">readerIndex</span>(), index),
</span></span><span style="display:flex;"><span>                    frame.<span style="color:#007f7f">slice</span>(index + <span style="color:#ff0;font-weight:bold">1</span>, frame.<span style="color:#007f7f">writerIndex</span>()));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> CmdHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;Cmd&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, Cmd msg)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Do something with the command
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//处理传经 ChannelPipeline 的 Cmd 对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="基于长度的协议">基于长度的协议<a hidden class="anchor" aria-hidden="true" href="#基于长度的协议">#</a></h3>
<p>基于长度的协议通过将它的长度编码到帧的头部来定义帧，而不是使用特殊的分隔符来标记它的结束。(对于固定帧大小的协议来说，不需要将帧长度编码到头部)
表 11-6 列出了Netty提供的用于处理这种类型的协议的两种解码器。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>FixedLengthFrameDecoder</td>
<td>提取在调用构造函数时指定的定长帧</td>
</tr>
<tr>
<td>LengthFieldBasedFrameDecoder</td>
<td>根据编码进帧头部中的长度值提取帧；该字段的偏移量以及 长度在构造函数中指定</td>
</tr>
</tbody>
</table>
<p>图 11-6 展示了 FixedLengthFrameDecoder 的功能，其在构造时已经指定了帧长度为 8字节。
<img loading="lazy" src="66.png" alt=""  />
</p>
<p>你将经常会遇到被编码到消息头部的帧大小不是固定值的协议。为了处理这种变长帧，你可以使用
LengthFieldBasedFrameDecoder，它将从头部字段确定帧长，然后从数据流中提取指定的字节数。
图 11-7 展示了一个示例，其中长度字段在帧中的偏移量为 0，并且长度为 2 字节。
<img loading="lazy" src="67.png" alt=""  />
</p>
<p>LengthFieldBasedFrameDecoder 提供了几个构造函数来支持各种各样的头部配置情况。代码清单 11-10 展示了如何使用其 3 个构造参数分别为 maxFrameLength、lengthFieldOffset 和 lengthFieldLength 的构造函数。在这个场景中，帧的长度被编码到了帧起始的前8 个字节中。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-10 使用 LengthFieldBasedFrameDecoder 解码器基于长度的协议
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LengthBasedInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//使用 LengthFieldBasedFrameDecoder 解码将帧长度编码到帧起始的前 8 个字节中的消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">new</span> LengthFieldBasedFrameDecoder(<span style="color:#ff0;font-weight:bold">64</span> * <span style="color:#ff0;font-weight:bold">1024</span>, <span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">8</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 FrameHandler 以处理每个帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> FrameHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> FrameHandler <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;ByteBuf&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, ByteBuf msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Do something with the frame
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">//处理帧的数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>你现在已经看到了 Netty 提供的，用于支持那些通过指定协议帧的分隔符或者长度（固定的或者可变的）以定义字节流的结构的协议的编解码器。你将会发现这些编解码器的许多用途，因为许多的常见协议都落到了这些分类之一中。</p>
<h2 id="写大型数据">写大型数据<a hidden class="anchor" aria-hidden="true" href="#写大型数据">#</a></h2>
<p>因为网络饱和的可能性，如何在异步框架中高效地写大块的数据是一个特殊的问题。由于写操作是非阻塞的，所以即使没有写出所有的数据，写操作也会在完成时返回并通知 ChannelFuture。当这种情况发生时，如果仍然不停地写入，就有内存耗尽的风险。所以在写大型数据时，需要准备好处理到远程节点的连接是慢速连接的情况，这种情况会导致内存释放的延迟。让我们考虑下将一个文件内容写出到网络的情况。
在我们讨论传输（见 4.2 节）的过程中，提到了 NIO 的零拷贝特性，这种特性消除了将文件的内容从文件系统移动到网络栈的复制过程。所有的这一切都发生在 Netty 的核心中，所以应用程序所有需要做的就是使用一个 FileRegion 接口的实现，其在 Netty 的 API 文档中的定义是：
“通过支持零拷贝的文件传输的 Channel 来发送的文件区域。”
代码清单 11-11 展示了如何通过从FileInputStream创建一个DefaultFileRegion，并将其写入Channel。（我们甚至可以利用 io.netty.channel.ChannelProgressivePromise 来实时获取传输的进度），从而利用零拷贝特性来传输一个文件的内容。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * Created by kerr.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-11 使用 FileRegion 传输文件的内容
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FileRegionWriteHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> Channel CHANNEL_FROM_SOMEWHERE = <span style="color:#fff;font-weight:bold">new</span> NioSocketChannel();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> File FILE_FROM_SOMEWHERE = <span style="color:#fff;font-weight:bold">new</span> File(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(<span style="color:#fff;font-weight:bold">final</span> ChannelHandlerContext ctx) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        File file = FILE_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference from somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Channel channel = CHANNEL_FROM_SOMEWHERE; <span style="color:#007f7f">//get reference from somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//创建一个 FileInputStream
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        FileInputStream in = <span style="color:#fff;font-weight:bold">new</span> FileInputStream(file);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//以该文件的完整长度创建一个新的 DefaultFileRegion
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        FileRegion region = <span style="color:#fff;font-weight:bold">new</span> DefaultFileRegion(
</span></span><span style="display:flex;"><span>                in.<span style="color:#007f7f">getChannel</span>(), <span style="color:#ff0;font-weight:bold">0</span>, file.<span style="color:#007f7f">length</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//发送该 DefaultFileRegion，并注册一个 ChannelFutureListener
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        channel.<span style="color:#007f7f">writeAndFlush</span>(region).<span style="color:#007f7f">addListener</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">new</span> ChannelFutureListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> operationComplete(ChannelFuture future)
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">if</span> (!future.<span style="color:#007f7f">isSuccess</span>()) {
</span></span><span style="display:flex;"><span>                   <span style="color:#007f7f">//处理失败
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                   Throwable cause = future.<span style="color:#007f7f">cause</span>();
</span></span><span style="display:flex;"><span>                   <span style="color:#007f7f">// Do something
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>               }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个示例只适用于文件内容的直接传输，不包括应用程序对数据的任何处理。在需要将数据从文件系统复制到用户内存中时，可以使用 ChunkedWriteHandler，它支持异步写大型数据流，而又不会导致大量的内存消耗。关键是 <code>interface ChunkedInput&lt;B&gt;</code>，其中类型参数 B 是 readChunk()方法返回的类型。Netty 预置了该接口的 4 个实现，如表 11-7 中所列出的。每个都代表了一个将由 ChunkedWriteHandler 处理的不定长度的数据流。
代码清单 11-12 说明了 ChunkedStream 的用法，它是实践中最常用的实现。所示的类使用了一个File 以及一个 SslContext 进行实例化。当 initChannel()方法被调用时，它将使用所示的 ChannelHandler 链初始化该 Channel。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>ChunkedFile</td>
<td>从文件中逐块获取数据，当你的平台不支持零拷贝或者你需要转换数据时使用</td>
</tr>
<tr>
<td>ChunkedNioFile</td>
<td>和 ChunkedFile 类似，只是它使用了 FileChannel</td>
</tr>
<tr>
<td>ChunkedStream</td>
<td>从 InputStream 中逐块传输内容</td>
</tr>
<tr>
<td>ChunkedNioStream</td>
<td>从 ReadableByteChannel 中逐块传输内容</td>
</tr>
</tbody>
</table>
<p>当 Channel 的状态变为活动的时，WriteStreamHandler 将会逐块地把来自文件中的数据作为
ChunkedStream 写入。数据在传输之前将会由 SslHandler 加密。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-12 使用 ChunkedStream 传输文件内容
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ChunkedWriteHandlerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> File file;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SslContext sslCtx;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ChunkedWriteHandlerInitializer(File file, SslContext sslCtx) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">file</span> = file;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">sslCtx</span> = sslCtx;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将 SslHandler 添加到 ChannelPipeline 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> SslHandler(sslCtx.<span style="color:#007f7f">newEngine</span>(ch.<span style="color:#007f7f">alloc</span>())));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 ChunkedWriteHandler 以处理作为 ChunkedInput 传入的数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ChunkedWriteHandler());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//一旦连接建立，WriteStreamHandler 就开始写文件数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> WriteStreamHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> WriteStreamHandler <span style="color:#fff;font-weight:bold">extends</span> ChannelInboundHandlerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//当连接建立时，channelActive() 方法将使用 ChunkedInput 写文件数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelActive(ChannelHandlerContext ctx)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">channelActive</span>(ctx);
</span></span><span style="display:flex;"><span>            ctx.<span style="color:#007f7f">writeAndFlush</span>(<span style="color:#fff;font-weight:bold">new</span> ChunkedStream(<span style="color:#fff;font-weight:bold">new</span> FileInputStream(file)));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>逐块输入：要使用你自己的 ChunkedInput 实现，请在 ChannelPipeline 中安装一个ChunkedWriteHandler。
在本节中，我们讨论了如何通过使用零拷贝特性来高效地传输文件，以及如何通过使用
ChunkedWriteHandler 来写大型数据而又不必冒着导致 OutOfMemoryError 的风险。
在下一节中，我们将仔细研究几种序列化 POJO 的方法。</p>
<h2 id="序列化数据">序列化数据<a hidden class="anchor" aria-hidden="true" href="#序列化数据">#</a></h2>
<p>JDK 提供了 ObjectOutputStream 和 ObjectInputStream，用于通过网络对 POJO 的基本数据类型和图进行序列化和反序列化。该 API 并不复杂，而且可以被应用于任何实现了java.io.Serializable 接口的对象。但是它的性能也不是非常高效的。在这一节中，我们将看到 Netty 必须为此提供什么。</p>
<h3 id="jdk-序列化">JDK 序列化<a hidden class="anchor" aria-hidden="true" href="#jdk-序列化">#</a></h3>
<p>如果你的应用程序必须要和使用了ObjectOutputStream和ObjectInputStream的远程节点交互，并且兼容性也是你最关心的，那么JDK序列化将是正确的选择表。
11-8 中列出了Netty提供的用于和JDK进行互操作的序列化类。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CompatibleObjectDecoder(已废弃)</td>
<td>和使用 JDK 序列化的非基于 Netty 的远程节点进行互操作的解码器</td>
</tr>
<tr>
<td>CompatibleObjectEncoder</td>
<td>和使用 JDK 序列化的非基于 Netty 的远程节点进行互操作的编码器</td>
</tr>
<tr>
<td>ObjectDecoder</td>
<td>构建于 JDK 序列化之上的使用自定义的序列化来解码的解码器；当 没有其他的外部依赖时，它提供了速度上的改进。否则其他的序列化 实现更加可取</td>
</tr>
<tr>
<td>ObjectEncoder</td>
<td>构建于 JDK 序列化之上的使用自定义的序列化来编码的编码器；当 没有其他的外部依赖时，它提供了速度上的改进。否则其他的序列化 实现更加可取</td>
</tr>
</tbody>
</table>
<h3 id="使用-jboss-marshalling-进行序列化">使用 JBoss Marshalling 进行序列化<a hidden class="anchor" aria-hidden="true" href="#使用-jboss-marshalling-进行序列化">#</a></h3>
<p>如果你可以自由地使用外部依赖，那么JBoss Marshalling将是个理想的选择：它比JDK序列化最多快 3 倍，而且也更加紧凑。在JBoss Marshalling官方网站主页上的概述中对它是这么定义的：
JBoss Marshalling 是一种可选的序列化 API，它修复了在 JDK 序列化 API 中所发现的许多问题，同时保留了与 java.io.Serializable 及其相关类的兼容性，并添加了几个新的可调优参数以及额外的特性，所有的这些都是可以通过工厂配置（如外部序列化器、类/实例查找表、类解析以及对象替换等）实现可插拔的。
Netty 通过表 11-9 所示的两组解码器/编码器对为 Boss Marshalling 提供了支持。第一组兼容只使用 JDK 序列化的远程节点。第二组提供了最大的性能，适用于和使用 JBoss Marshalling 的远程节点一起使用。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CompatibleMarshallingDecoder CompatibleMarshallingEncoder</td>
<td>与只使用 JDK 序列化的远程节点兼容</td>
</tr>
<tr>
<td>MarshallingDecoder MarshallingEncoder</td>
<td>适用于使用 JBoss Marshalling 的节点。这些类必须一起使用</td>
</tr>
</tbody>
</table>
<p>代码清单 11-13 展示了如何使用 MarshallingDecoder 和 MarshallingEncoder。同样，几乎只是适当地配置 ChannelPipeline 罢了。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-13 使用 JBoss Marshalling
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MarshallingInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> MarshallerProvider marshallerProvider;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> UnmarshallerProvider unmarshallerProvider;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> MarshallingInitializer(UnmarshallerProvider unmarshallerProvider,
</span></span><span style="display:flex;"><span>            MarshallerProvider marshallerProvider) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">marshallerProvider</span> = marshallerProvider;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">unmarshallerProvider</span> = unmarshallerProvider;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel channel) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = channel.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 MarshallingDecoder 以将 ByteBuf 转换为 POJO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> MarshallingDecoder(unmarshallerProvider));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 MarshallingEncoder 以将POJO 转换为 ByteBuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> MarshallingEncoder(marshallerProvider));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 ObjectHandler，以处理普通的实现了Serializable 接口的 POJO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ObjectHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ObjectHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;Serializable&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(
</span></span><span style="display:flex;"><span>            ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>            Serializable serializable) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Do something
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="通过-protocol-buffers-序列化">通过 Protocol Buffers 序列化<a hidden class="anchor" aria-hidden="true" href="#通过-protocol-buffers-序列化">#</a></h3>
<p>Netty序列化的最后一个解决方案是利用Protocol Buffers的编解码器，它是一种由Google公司开发的、现在已经开源的数据交换格式。可以在https://github.com/google/protobuf找到源代码。
Protocol Buffers 以一种紧凑而高效的方式对结构化的数据进行编码以及解码。它具有许多的编程语言绑定，使得它很适合跨语言的项目。表 11-10 展示了 Netty 为支持 protobuf 所提供的ChannelHandler 实现。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>ProtobufDecoder</td>
<td>使用 protobuf 对消息进行解码</td>
</tr>
<tr>
<td>ProtobufEncoder</td>
<td>使用 protobuf 对消息进行编码</td>
</tr>
<tr>
<td>ProtobufVarint32FrameDecoder</td>
<td>根据消息中的 Google Protocol Buffers 的“Base 128 Varints”整型长度字段值动态地分割所接收到的 ByteBuf</td>
</tr>
<tr>
<td>ProtobufVarint32LengthFieldPrepender</td>
<td>向 ByteBuf 前追加一个 Google Protocal Buffers 的“Base 128 Varints”整型的长度字段值</td>
</tr>
</tbody>
</table>
<p>使用 protobuf只需要将正确的 ChannelHandler 添加到 ChannelPipeline 中，如代码清单 11-14 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 11-14 使用 protobuf
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ProtoBufInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> MessageLite lite;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ProtoBufInitializer(MessageLite lite) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">lite</span> = lite;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 ProtobufVarint32FrameDecoder 以分隔帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ProtobufVarint32FrameDecoder());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 ProtobufEncoder 以处理消息的编码
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ProtobufEncoder());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 ProtobufDecoder 以解码消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ProtobufDecoder(lite));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加 ObjectHandler 以处理解码消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ObjectHandler());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ObjectHandler
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;Object&gt; {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, Object msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// Do something with the object
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这一节中，我们探讨了由 Netty 专门的解码器和编码器所支持的不同的序列化选项：
标准JDK 序列化、JBoss Marshalling 以及 Google 的 Protocol Buffers。</p>
<h2 id="小结-4">小结<a hidden class="anchor" aria-hidden="true" href="#小结-4">#</a></h2>
<p>Netty 提供的编解码器以及各种 ChannelHandler 可以被组合和扩展，以实现非常广泛的处理方案。
此外，它们也是被论证的、健壮的组件，已经被许多的大型系统所使用。需要注意的是，我们只涵盖了最常见的示例；Netty 的 API 文档提供了更加全面的覆盖。在下一章中，我们将学习另一种先进的协议：WebSocket，它被开发用以改进 Web 应用程序的性能以及响应性。Netty 提供了你将会需要的工具，以便你快速、轻松地利用它强大的功能。</p>
<h1 id="websocket-1">WebSocket<a hidden class="anchor" aria-hidden="true" href="#websocket-1">#</a></h1>
<p>WebSocket 是一种为了提高 Web 应用程序的性能以及响应性而开发的先进的网络协议。我们将通过编写一个简单的示例应用程序来探索 Netty 对它们的支持。在第 12 章中，通过构建一个可以在多个浏览器客户端之间进行实时通信的聊天室，你将学习到如何使用 WebSocket 来实现双向数据传输。你还将会看到如何在你的应用程序中通过检测客户端是否支持 WebSocket 协议，从而从 HTTP 协议切换到WebSocket 协议。通过对第 13 章中 Netty 对于用户数据报协议（UDP）的支持的学习，我们将结束第三部分。在这一章中，你将会构建可适用于多种实际用途的广播服务器和监视器客户端。</p>
<p>如果你有跟进 Web 技术的最新进展，你很可能就遇到过“实时 Web”这个短语，而如果你在工程领域中有实时应用程序的实战经验，那么你可能有点怀疑这个术语到底意味着什么。因此，让我们首先澄清，这里并不是指所谓的硬实时服务质量（QoS），硬实时服务质量是保证计算结果将在指定的时间间隔内被递交。仅HTTP 的请求/响应模式设计就使得其很难被支持，从过去所设计的各种方案中都没有提供一种能够提供令人满意的解决方案的事实中便可见一斑。虽然已经有了一些关于正式定义实时Web服务语义的学术讨论，但是被普遍接受的定义似乎还未出现。因此现在我们将采纳下面来自维基百科的非权威性描述：
实时 Web 利用技术和实践，使用户在信息的作者发布信息之后就能够立即收到信息，而不需要他们或者他们的软件周期性地检查信息源以获取更新。
简而言之，虽然全面的实时Web可能并不会马上到来，但是它背后的想法却助长了对于几乎瞬时获得信息的期望。我们将在本章中讨论的WebSocket协议便是在这个方向上迈出的坚实的一步。</p>
<h2 id="websocket-简介">WebSocket 简介<a hidden class="anchor" aria-hidden="true" href="#websocket-简介">#</a></h2>
<p>WebSocket 协议是完全重新设计的协议，旨在为 Web 上的双向数据传输问题提供一个切实可行的解决方案，使得客户端和服务器之间可以在任意时刻传输消息，因此，这也就要求它们异步地处理消息回执。（作为HTML5 客户端 API 的一部分，大部分最新的浏览器都已经支持了 WebSocket。）Netty 对于 WebSocket 的支持包含了所有正在使用中的主要实现，因此在你的下一个应用程序中采用它将是简单直接的。和往常使用 Netty 一样，你可以完全使用该协议，而无需关心它内部的实现细节。我们将通过创建一个基于 WebSocket 的实时聊天应用程序来演示这一点。</p>
<h2 id="我们的-websocket-示例应用程序">我们的 WebSocket 示例应用程序<a hidden class="anchor" aria-hidden="true" href="#我们的-websocket-示例应用程序">#</a></h2>
<p>为了让示例应用程序展示它的实时功能，我们 将通过使用 WebSocket 协议来实现一个基于浏览器的聊天应用程序，就像你可能在 Facebook 的文本消息功能中见到过的那样。我们将通过使得多个用户之间可以同时进行相互通信，从而更进一步。</p>
<p>图 12-1 说明了该应用程序的逻辑：
（1）客户端发送一个消息；
（2）该消息将被广播到所有其他连接的客户端
<img loading="lazy" src="68.png" alt=""  />
</p>
<p>通过我们的程序，所有的人都可以和其他的人聊天。在示例中，我们将只实现服务器端，而客户端则是通过Web 页面访问该聊天室的浏览器。可以发现，WebSocket 简化了编写这样的服务器的过程。</p>
<h2 id="添加-websocket-支持">添加 WebSocket 支持<a hidden class="anchor" aria-hidden="true" href="#添加-websocket-支持">#</a></h2>
<p>在从标准的HTTP或者HTTPS协议切换到WebSocket时，将会使用一种称为升级握手的机制。因此，使用WebSocket的应用程序将始终以HTTP/S作为开始，然后再执行升级。这个升级动作发生的确切时刻特定于应用程序；它可能会发生在启动时，也可能会发生在请求了某个特定的URL之后。
我们的应用程序将采用下面的约定：如果被请求的 URL 以/ws 结尾，那么我们将会把该协议升级为
WebSocket；否则，服务器将使用基本的 HTTP/S。在连接已经升级完成之后，所有数据都将会使用WebSocket 进行传输。图 12-2 说明了该服务器逻辑，一如在 Netty 中一样，它由一组ChannelHandler实现。
我们将会在下一节中，解释用于处理 HTTP 以及 WebSocket 协议的技术时，描述它们。
<img loading="lazy" src="69.png" alt=""  />
</p>
<h3 id="处理-http-请求">处理 HTTP 请求<a hidden class="anchor" aria-hidden="true" href="#处理-http-请求">#</a></h3>
<p>首先，我们将实现该处理 HTTP 请求的组件。这个组件将提供用于访问聊天室并显示由连接的客户端发送的消息的网页。代码清单 12-1 给出了这个 HttpRequestHandler 对应的代码，其扩展了
SimpleChannelInboundHandler 以处理 FullHttpRequest 消息。需要注意的是，channelRead0()方法的实现是如何转发任何目标 URI 为/ws 的请求的。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 12-1 HTTPRequestHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author &lt;a href=&#34;mailto:norman.maurer@gmail.com&#34;&gt;Norman Maurer&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展 SimpleChannelInboundHandler 以处理 FullHttpRequest 消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HttpRequestHandler <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;FullHttpRequest&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String wsUri;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> File INDEX;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>        URL location = HttpRequestHandler.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getProtectionDomain</span>().<span style="color:#007f7f">getCodeSource</span>().<span style="color:#007f7f">getLocation</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            String path = location.<span style="color:#007f7f">toURI</span>() + <span style="color:#0ff;font-weight:bold">&#34;index.html&#34;</span>;
</span></span><span style="display:flex;"><span>            path = !path.<span style="color:#007f7f">contains</span>(<span style="color:#0ff;font-weight:bold">&#34;file:&#34;</span>) ? path : path.<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">5</span>);
</span></span><span style="display:flex;"><span>            INDEX = <span style="color:#fff;font-weight:bold">new</span> File(path);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (URISyntaxException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalStateException(
</span></span><span style="display:flex;"><span>                 <span style="color:#0ff;font-weight:bold">&#34;Unable to locate index.html&#34;</span>, e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> HttpRequestHandler(String wsUri) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">wsUri</span> = wsUri;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        FullHttpRequest request) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//(1) 如果请求了 WebSocket 协议升级，则增加引用计数（调用 retain()方法），并将它传递给下一 个 ChannelInboundHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (wsUri.<span style="color:#007f7f">equalsIgnoreCase</span>(request.<span style="color:#007f7f">getUri</span>())) {
</span></span><span style="display:flex;"><span>            ctx.<span style="color:#007f7f">fireChannelRead</span>(request.<span style="color:#007f7f">retain</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(2) 处理 100 Continue 请求以符合 HTTP 1.1 规范
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (HttpHeaders.<span style="color:#007f7f">is100ContinueExpected</span>(request)) {
</span></span><span style="display:flex;"><span>                send100Continue(ctx);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//读取 index.html
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            RandomAccessFile file = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(INDEX, <span style="color:#0ff;font-weight:bold">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>            HttpResponse response = <span style="color:#fff;font-weight:bold">new</span> DefaultHttpResponse(
</span></span><span style="display:flex;"><span>                request.<span style="color:#007f7f">getProtocolVersion</span>(), HttpResponseStatus.<span style="color:#007f7f">OK</span>);
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">headers</span>().<span style="color:#007f7f">set</span>(
</span></span><span style="display:flex;"><span>                HttpHeaders.<span style="color:#007f7f">Names</span>.<span style="color:#007f7f">CONTENT_TYPE</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;text/html; charset=UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">boolean</span> keepAlive = HttpHeaders.<span style="color:#007f7f">isKeepAlive</span>(request);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//如果请求了keep-alive，则添加所需要的 HTTP 头信息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (keepAlive) {
</span></span><span style="display:flex;"><span>                response.<span style="color:#007f7f">headers</span>().<span style="color:#007f7f">set</span>(
</span></span><span style="display:flex;"><span>                    HttpHeaders.<span style="color:#007f7f">Names</span>.<span style="color:#007f7f">CONTENT_LENGTH</span>, file.<span style="color:#007f7f">length</span>());
</span></span><span style="display:flex;"><span>                response.<span style="color:#007f7f">headers</span>().<span style="color:#007f7f">set</span>( HttpHeaders.<span style="color:#007f7f">Names</span>.<span style="color:#007f7f">CONNECTION</span>,
</span></span><span style="display:flex;"><span>                    HttpHeaders.<span style="color:#007f7f">Values</span>.<span style="color:#007f7f">KEEP_ALIVE</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(3) 将 HttpResponse 写到客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ctx.<span style="color:#007f7f">write</span>(response);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(4) 将 index.html 写到客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (ctx.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">get</span>(SslHandler.<span style="color:#007f7f">class</span>) == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                ctx.<span style="color:#007f7f">write</span>(<span style="color:#fff;font-weight:bold">new</span> DefaultFileRegion(
</span></span><span style="display:flex;"><span>                    file.<span style="color:#007f7f">getChannel</span>(), <span style="color:#ff0;font-weight:bold">0</span>, file.<span style="color:#007f7f">length</span>()));
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                ctx.<span style="color:#007f7f">write</span>(<span style="color:#fff;font-weight:bold">new</span> ChunkedNioFile(file.<span style="color:#007f7f">getChannel</span>()));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(5) 写 LastHttpContent 并冲刷至客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ChannelFuture future = ctx.<span style="color:#007f7f">writeAndFlush</span>(
</span></span><span style="display:flex;"><span>                LastHttpContent.<span style="color:#007f7f">EMPTY_LAST_CONTENT</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(6) 如果没有请求keep-alive，则在写操作完成后关闭 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (!keepAlive) {
</span></span><span style="display:flex;"><span>                future.<span style="color:#007f7f">addListener</span>(ChannelFutureListener.<span style="color:#007f7f">CLOSE</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> send100Continue(ChannelHandlerContext ctx) {
</span></span><span style="display:flex;"><span>        FullHttpResponse response = <span style="color:#fff;font-weight:bold">new</span> DefaultFullHttpResponse(
</span></span><span style="display:flex;"><span>            HttpVersion.<span style="color:#007f7f">HTTP_1_1</span>, HttpResponseStatus.<span style="color:#007f7f">CONTINUE</span>);
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">writeAndFlush</span>(response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> exceptionCaught(ChannelHandlerContext ctx, Throwable cause)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        cause.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果该 HTTP 请求指向了地址为/ws 的 URI，那么 HttpRequestHandler 将调用 FullHttpRequest 对象上的retain()方法，并通过调用 fireChannelRead(msg)方法将它转发给下一个 ChannelInboundHandler 。
之所以需要调用 retain()方法，是因为调用 channelRead()方法完成之后，它将调用 FullHttpRequest 对象上的 release()方法以释放它的资源。（参见我们在第 6 章中对于 SimpleChannelInboundHandler 的讨论）如果客户端发送了 HTTP 1.1 的 HTTP 头信息 Expect: 100-continue，那么 HttpRequestHandler 将会发送一个 100 Continue 响应。在该 HTTP 头信息被设置之后，HttpRequestHandler 将会写回一个HttpResponse 给客户端。这不是一个 FullHttpResponse，因为它只是响应的第一个部分。此外，这里也不会调用 writeAndFlush()方法，在结束的时候才会调用。</p>
<p>如果不需要加密和压缩，那么可以通过将 index.html 的内容存储到 DefaultFileRegion 中来达到最佳效率。这将会利用零拷贝特性来进行内容的传输。为此，你可以检查一下，是否有 SslHandler 存在于在ChannelPipeline 中。否则，你可以使用 ChunkedNioFile。HttpRequestHandler 将写一个
LastHttpContent 来标记响应的结束。如果没有请求 keep-alive ，那么 HttpRequestHandler 将会添加一个 ChannelFutureListener到最后一次写出动作的 ChannelFuture，并关闭该连接。
在这里，你将调用 writeAndFlush()方法以冲刷所有之前写入的消息。这部分代码代表了聊天服务器的第一个部分，它管理纯粹的 HTTP 请求和响应。接下来，我们将处理传输实际聊天消息的 WebSocket 帧。</p>
<p>WEBSOCKET 帧：WebSocket 以帧的方式传输数据，每一帧代表消息的一部分。一个完整的消息可能会包含许多帧。</p>
<h3 id="处理-websocket-帧">处理 WebSocket 帧<a hidden class="anchor" aria-hidden="true" href="#处理-websocket-帧">#</a></h3>
<p>由 IETF 发布的 WebSocket RFC，定义了 6 种帧，Netty 为它们每种都提供了一个 POJO 实现。
表 12-1 列出了这些帧类型，并描述了它们的用法。</p>
<table>
<thead>
<tr>
<th>帧 类 型</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>BinaryWebSocketFrame</td>
<td>包含了二进制数据</td>
</tr>
<tr>
<td>TextWebSocketFrame</td>
<td>包含了文本数据</td>
</tr>
<tr>
<td>ContinuationWebSocketFrame</td>
<td>包含属于上一个BinaryWebSocketFrame或TextWebSocketFrame 的文本数据或者二进制数据</td>
</tr>
<tr>
<td>CloseWebSocketFrame</td>
<td>表示一个 CLOSE 请求，包含一个关闭的状态码和关闭的原因</td>
</tr>
<tr>
<td>PingWebSocketFrame</td>
<td>请求传输一个 PongWebSocketFrame</td>
</tr>
<tr>
<td>PongWebSocketFrame</td>
<td>作为一个对于 PingWebSocketFrame 的响应被发送</td>
</tr>
</tbody>
</table>
<p>我们的聊天应用程序将使用下面几种帧类型：
CloseWebSocketFrame；
PingWebSocketFrame；
PongWebSocketFrame;
TextWebSocketFrame。</p>
<p>TextWebSocketFrame 是我们唯一真正需要处理的帧类型。为了符合 WebSocket RFC，
Netty 提供了 WebSocketServerProtocolHandler 来处理其他类型的帧。
代码清单 12-2 展示了我们用于处理 TextWebSocketFrame 的 ChannelInboundHandler，
其还将在它的 ChannelGroup 中跟踪所有活动的 WebSocket 连接。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 12-2 处理文本帧
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展 SimpleChannelInboundHandler，并处理 TextWebSocketFrame 消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TextWebSocketFrameHandler <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ChannelGroup group;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> TextWebSocketFrameHandler(ChannelGroup group) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">group</span> = group;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//重写 userEventTriggered()方法以处理自定义事件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> userEventTriggered(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>        Object evt) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//如果该事件表示握手成功，则从该 ChannelPipeline 中移除HttpRequest-Handler，因为将不会接收到任何HTTP消息了
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (evt == WebSocketServerProtocolHandler.<span style="color:#007f7f">ServerHandshakeStateEvent</span>.<span style="color:#007f7f">HANDSHAKE_COMPLETE</span>) {
</span></span><span style="display:flex;"><span>            ctx.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">remove</span>(HttpRequestHandler.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(1) 通知所有已经连接的 WebSocket 客户端新的客户端已经连接上了
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            group.<span style="color:#007f7f">writeAndFlush</span>(<span style="color:#fff;font-weight:bold">new</span> TextWebSocketFrame(
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;Client &#34;</span> + ctx.<span style="color:#007f7f">channel</span>() + <span style="color:#0ff;font-weight:bold">&#34; joined&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//(2) 将新的 WebSocket Channel 添加到 ChannelGroup 中，以便它可以接收到所有的消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            group.<span style="color:#007f7f">add</span>(ctx.<span style="color:#007f7f">channel</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">userEventTriggered</span>(ctx, evt);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//(3) 增加消息的引用计数，并将它写到 ChannelGroup 中所有已经连接的客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        group.<span style="color:#007f7f">writeAndFlush</span>(msg.<span style="color:#007f7f">retain</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>TextWebSocketFrameHandler 只有一组非常少量的责任。当和新客户端的 WebSocket握手成功完成之后 ，它将通过把通知消息写到 ChannelGroup 中的所有 Channel 来通知所有已经连接的客户端，然后它将把这个新 Channel 加入到该 ChannelGroup 中 。如果接收到了 TextWebSocketFrame 消息 ，TextWebSocketFrameHandler 将调用TextWebSocketFrame 消息上的 retain()方法，并使用writeAndFlush()方法来将它传输给 ChannelGroup，以便所有已经连接的 WebSocket Channel 都将接收到它。
和之前一样，对于 retain()方法的调用是必需的，因为当 channelRead0()方法返回时，
TextWebSocketFrame 的引用计数将会被减少。由于所有的操作都是异步的，因此，writeAndFlush()方法可能会在 channelRead0()方法返回之后完成，而且它绝对不能访问一个已经失效的引用。因为 Netty 在内部处理了大部分剩下的功能，所以现在剩下唯一需要做的事情就是为每个新创建的 Channel 初始化其ChannelPipeline。为此，我们将需要一个 ChannelInitializer。</p>
<h3 id="初始化-channelpipeline">初始化 ChannelPipeline<a hidden class="anchor" aria-hidden="true" href="#初始化-channelpipeline">#</a></h3>
<p>正如你已经学习到的，为了将 ChannelHandler 安装到 ChannelPipeline 中，你扩展了 ChannelInitializer，并实现了 initChannel()方法。代码清单 12-3 展示了由此生成的 ChatServerInitializer 的代码。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 12-3 初始化 ChannelPipeline
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展了 ChannelInitializer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ChatServerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChannelInitializer&lt;Channel&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ChannelGroup group;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ChatServerInitializer(ChannelGroup group) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">group</span> = group;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//将所有需要的 ChannelHandler 添加到 ChannelPipeline 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ChannelPipeline pipeline = ch.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HttpServerCodec());
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> ChunkedWriteHandler());
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HttpObjectAggregator(<span style="color:#ff0;font-weight:bold">64</span> * <span style="color:#ff0;font-weight:bold">1024</span>));
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> HttpRequestHandler(<span style="color:#0ff;font-weight:bold">&#34;/ws&#34;</span>));
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> WebSocketServerProtocolHandler(<span style="color:#0ff;font-weight:bold">&#34;/ws&#34;</span>));
</span></span><span style="display:flex;"><span>        pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> TextWebSocketFrameHandler(group));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于 initChannel()方法的调用，通过安装所有必需的 ChannelHandler 来设置该新注册的 Channel 的ChannelPipeline。这些 ChannelHandler 以及它们各自的职责都被总结在了表 12-2 中。</p>
<table>
<thead>
<tr>
<th>ChannelHandler</th>
<th>职 责</th>
</tr>
</thead>
<tbody>
<tr>
<td>HttpServerCodec</td>
<td>将字节解码为 HttpRequest、HttpContent 和 LastHttpContent。并将 HttpRequest、HttpContent 和 LastHttpContent 编码为字节</td>
</tr>
<tr>
<td>ChunkedWriteHandler</td>
<td>写入一个文件的内容</td>
</tr>
<tr>
<td>HttpObjectAggregator</td>
<td>将一个 HttpMessage 和跟随它的多个 HttpContent 聚合 为单个 FullHttpRequest 或者 FullHttpResponse（取 决于它是被用来处理请求还是响应）。安装了这个之后， ChannelPipeline 中的下一个 ChannelHandler 将只会 收到完整的 HTTP 请求或响应</td>
</tr>
<tr>
<td>HttpRequestHandler</td>
<td>处理 FullHttpRequest（那些不发送到/ws URI 的请求）</td>
</tr>
<tr>
<td>WebSocketServerProtocolHandler</td>
<td>按照 WebSocket 规范的要求，处理 WebSocket 升级握手、 PingWebSocketFrame 、 PongWebSocketFrame 和 CloseWebSocketFrame</td>
</tr>
<tr>
<td>TextWebSocketFrameHandler</td>
<td>处理 TextWebSocketFrame 和握手完成事件</td>
</tr>
</tbody>
</table>
<p>Netty 的 WebSocketServerProtocolHandler 处理了所有委托管理的 WebSocket 帧类型以及升级握手本身。如果握手成功，那么所需的 ChannelHandler 将会被添加到 ChannelPipeline中，而那些不再需要的ChannelHandler 则将会被移除。
WebSocket 协议升级之前的 ChannelPipeline 的状态如图 12-3 所示。这代表了刚刚被ChatServerInitializer 初始化之后的 ChannelPipeline。
<img loading="lazy" src="70.png" alt=""  />

当 WebSocket 协议升级完成之后，WebSocketServerProtocolHandler 将会把 HttpRequestDecoder 替换为 WebSocketFrameDecoder，把 HttpResponseEncoder 替换为WebSocketFrameEncoder。为了性能最大化，它将移除任何不再被 WebSocket 连接所需要的ChannelHandler。
这也包括了图 12-3 所示的 HttpObjectAggregator 和 HttpRequestHandler。
图 12-4 展示了这些操作完成之后的ChannelPipeline。需要注意的是，Netty目前支持 4个版本的
WebSocket协议，它们每个都具有自己的实现类。Netty将会根据客户端（这里指浏览器）所支持的版本 ，(在这个例子中，我们假设使用了13 版的 WebSocket 协议，所以图中展示的是WebSocketFrameDecoder13和 WebSocketFrameEncoder13。)
自动地选择正确版本的WebSocketFrameDecoder和WebSocketFrameEncoder。
<img loading="lazy" src="71.png" alt=""  />
</p>
<h3 id="引导-1">引导<a hidden class="anchor" aria-hidden="true" href="#引导-1">#</a></h3>
<p>这幅拼图最后的一部分是引导该服务器，并安装 ChatServerInitializer 的代码。这将由 ChatServer 类处理，如代码清单 12-4 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 12-4 引导服务器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ChatServer {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//创建 DefaultChannelGroup，其将保存所有已经连接的 WebSocket Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> ChannelGroup channelGroup =
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">new</span> DefaultChannelGroup(ImmediateEventExecutor.<span style="color:#007f7f">INSTANCE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> EventLoopGroup group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Channel channel;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ChannelFuture start(InetSocketAddress address) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//引导服务器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ServerBootstrap bootstrap = <span style="color:#fff;font-weight:bold">new</span> ServerBootstrap();
</span></span><span style="display:flex;"><span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>             .<span style="color:#007f7f">channel</span>(NioServerSocketChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>             .<span style="color:#007f7f">childHandler</span>(createInitializer(channelGroup));
</span></span><span style="display:flex;"><span>        ChannelFuture future = bootstrap.<span style="color:#007f7f">bind</span>(address);
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>        channel = future.<span style="color:#007f7f">channel</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> future;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//创建 ChatServerInitializer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">protected</span> ChannelInitializer&lt;Channel&gt; createInitializer(
</span></span><span style="display:flex;"><span>        ChannelGroup group) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> ChatServerInitializer(group);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//处理服务器关闭，并释放所有的资源
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> destroy() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (channel != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            channel.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        channelGroup.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>        group.<span style="color:#007f7f">shutdownGracefully</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        if (args.length != 1) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            System.err.println(&#34;Please give port as argument&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            System.exit(1);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//        }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//        int port = Integer.parseInt(args[0]);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">int</span> port = <span style="color:#ff0;font-weight:bold">8989</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> ChatServer endpoint = <span style="color:#fff;font-weight:bold">new</span> ChatServer();
</span></span><span style="display:flex;"><span>        ChannelFuture future = endpoint.<span style="color:#007f7f">start</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port));
</span></span><span style="display:flex;"><span>        Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">addShutdownHook</span>(<span style="color:#fff;font-weight:bold">new</span> Thread() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>                endpoint.<span style="color:#007f7f">destroy</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="测试该应用程序">测试该应用程序<a hidden class="anchor" aria-hidden="true" href="#测试该应用程序">#</a></h2>
<p>通过main方法运行程序，然后在浏览器访问我们在代码中指定的端口8989。开两个页面，都访问：
<code>localhost:8989</code>，在两个页面分别点击connect，一旦连接上，就可以输入消息并点击发送按钮，然后就可以在另外一个页面看到发送的消息。可以开N个页面，代表N个客户端，这就是一个简易的多人聊天室。</p>
<h3 id="如何进行加密">如何进行加密<a hidden class="anchor" aria-hidden="true" href="#如何进行加密">#</a></h3>
<p>在真实世界的场景中，你将很快就会被要求向该服务器添加加密。使用 Netty，这不过是将一个 SslHandler添加到 ChannelPipeline 中，并配置它的问题。代码清单 12-6 展示了如何通过扩展我们的ChatServerInitializer来创建一个SecureChatServerInitializer 以完成这个需求。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 12-6 为 ChannelPipeline 添加加密
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展 ChatServerInitializer 以添加加密
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecureChatServerInitializer <span style="color:#fff;font-weight:bold">extends</span> ChatServerInitializer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SslContext context;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SecureChatServerInitializer(ChannelGroup group,
</span></span><span style="display:flex;"><span>        SslContext context) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(group);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">context</span> = context;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel ch) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//调用父类的 initChannel() 方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">initChannel</span>(ch);
</span></span><span style="display:flex;"><span>        SSLEngine engine = context.<span style="color:#007f7f">newEngine</span>(ch.<span style="color:#007f7f">alloc</span>());
</span></span><span style="display:flex;"><span>        engine.<span style="color:#007f7f">setUseClientMode</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将 SslHandler 添加到 ChannelPipeline 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ch.<span style="color:#007f7f">pipeline</span>().<span style="color:#007f7f">addFirst</span>(<span style="color:#fff;font-weight:bold">new</span> SslHandler(engine));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后一步是调整ChatServer以使用SecureChatServerInitializer，以便在ChannelPipeline 中安装
SslHandler。这给了我们代码清单 12-7 中所展示的 SecureChatServer。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 12-7 向 ChatServer 添加加密
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//SecureChatServer 扩展 ChatServer 以支持加密
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> SecureChatServer <span style="color:#fff;font-weight:bold">extends</span> ChatServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> SslContext context;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SecureChatServer(SslContext context) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">context</span> = context;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> ChannelInitializer&lt;Channel&gt; createInitializer(ChannelGroup group) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//返回之前创建的 SecureChatServerInitializer 以启用加密
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> SecureChatServerInitializer(group, context);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        if (args.length != 1) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            System.err.println(&#34;Please give port as argument&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            System.exit(1);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//        }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//        int port = Integer.parseInt(args[0]);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">int</span> port = <span style="color:#ff0;font-weight:bold">9000</span>;
</span></span><span style="display:flex;"><span>        SelfSignedCertificate cert = <span style="color:#fff;font-weight:bold">new</span> SelfSignedCertificate();
</span></span><span style="display:flex;"><span>        SslContext context = SslContext.<span style="color:#007f7f">newServerContext</span>(
</span></span><span style="display:flex;"><span>                cert.<span style="color:#007f7f">certificate</span>(), cert.<span style="color:#007f7f">privateKey</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> SecureChatServer endpoint = <span style="color:#fff;font-weight:bold">new</span> SecureChatServer(context);
</span></span><span style="display:flex;"><span>        ChannelFuture future = endpoint.<span style="color:#007f7f">start</span>(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(port));
</span></span><span style="display:flex;"><span>        Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">addShutdownHook</span>(<span style="color:#fff;font-weight:bold">new</span> Thread() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() {
</span></span><span style="display:flex;"><span>                endpoint.<span style="color:#007f7f">destroy</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        future.<span style="color:#007f7f">channel</span>().<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">syncUninterruptibly</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这就是为所有的通信启用 SSL/TLS 加密需要做的全部。我们还使用main方法来启动程序。现在，你便可以从 SecureChatServer 的 HTTPS URL 地址 https://localhost:9999 访问它了。</p>
<h1 id="使用dup广播事件">使用DUP广播事件<a hidden class="anchor" aria-hidden="true" href="#使用dup广播事件">#</a></h1>
<p>到目前为止，你所见过的绝大多数的例子都使用了基于连接的协议，如TCP。
本章我们学习DUP(User Datagram Protocol)用户数据报协议，也叫无连接协议。它的特点是允许一定的数据包丢失，注重性能。</p>
<h2 id="dup基础">DUP基础<a hidden class="anchor" aria-hidden="true" href="#dup基础">#</a></h2>
<p>面向连接的传输（如 TCP）管理了两个网络端点之间的连接的建立，在连接的生命周期内的有序和可靠的消息传输，以及最后，连接的有序终止。相比之下，在类似于 UDP 这样的无连接协议中，并没有持久化连接这样的概念，并且每个消息（一个 UDP 数据报）都是一个单独的传输单元。
此外，UDP 也没有 TCP 的纠错机制，其中每个节点都将确认它们所接收到的包，而没有被确认的包将会被发送方重新传输。TCP 连接就像打电话，其中一系列的有序消息将会在两个方向上流动。相反，UDP 则类似于往邮箱中投入一叠明信片。你无法知道它们将以何种顺序到达它们的目的地，或者它们是否所有的都能够到达它们的目的地。UDP的这些方面可能会让你感觉到严重的局限性，但这也是DUP比TCP要快的多的原因：
所有的握手以及消息管理机制的开销都已经被消除了。显然，UDP很适合那些能够处理或者容忍消息丢失的应用程序，但可能不适合那些处理金融交易的应用程序。</p>
<h2 id="dup广播">DUP广播<a hidden class="anchor" aria-hidden="true" href="#dup广播">#</a></h2>
<p>到目前为止，我们所有的例子采用的都是一种叫作单播的传输模式。定义为发送消息给一个由唯一的地址所标识的单一的网络目的地。面向连接的协议和无连接协议都支持这种模式。
UDP 提供了向多个接收者发送消息的额外传输模式：</p>
<ul>
<li>多播——传输到一个预定义的主机组；</li>
<li>广播——传输到网络（或者子网）上的所有主机。
本章中的示例应用程序将通过发送能够被同一个网络中的所有主机所接收的消息来演示UDP 广播的使用。为此，我们将使用特殊的受限广播地址或者零网络地址 255.255.255.255。发送到这个地址的消息都将会被定向给本地网络（0.0.0.0）上的所有主机，而不会被路由器转发给其他的网络。</li>
</ul>
<h2 id="udp-示例应用程序">UDP 示例应用程序<a hidden class="anchor" aria-hidden="true" href="#udp-示例应用程序">#</a></h2>
<p>我们的示例程序将打开一个文件，随后将会通过 UDP 把每一行都作为一个消息广播到一个指定的端口。如果你熟悉类 UNIX 操作系统，你可能会认识到这是标准的 syslog 实用程序的一个非常简化的版本。UDP 非常适合于这样的应用程序，因为考虑到日志文件本身已经被存储在了文件系统中，因此，偶尔丢失日志文件中的一两行是可以容忍的。此外，该应用程序还提供了极具价值的高效处理大量数据的能力。
接收方是怎么样的呢？通过 UDP 广播，只需简单地通过在指定的端口上启动一个监听程序，便可以创建一个事件监视器来接收日志消息。需要注意的是，这样的轻松访问性也带来了潜在的安全隐患，这也就是为何在不安全的环境中并不倾向于使用 UDP 广播的原因之一。出于同样的原因，路由器通常也会阻止广播消息，并将它们限制在它们的来源网络上。
图 13-1 展示了整个系统的一个高级别视图，其由一个广播者以及一个或者多个事件监视器所组成。广播者将监听新内容的出现，当它出现时，则通过 UDP 将它作为一个广播消息进行传输。
<img loading="lazy" src="72.png" alt=""  />

所有的在该 UDP 端口上监听的事件监视器都将会接收到广播消息。
为了简单起见，我们将不会为我们的示例程序添加身份认证、验证或者加密。但是，要加入这些功能并使得其成为一个健壮的、可用的实用程序应该也不难。</p>
<h2 id="消息-pojo-logeventc">消息 POJO: LogEventc<a hidden class="anchor" aria-hidden="true" href="#消息-pojo-logeventc">#</a></h2>
<p>在消息处理应用程序中，数据通常由 POJO 表示，除了实际上的消息内容，其还可以包含配置或处理信息。在这个应用程序中，我们将会把消息作为事件处理，并且由于该数据来自于日志文件，所以我们将它称为LogEvent。代码清单 13-1 展示了这个简单的 POJO 的详细信息。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 13-1 LogEvent 消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> LogEvent {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">byte</span> SEPARATOR = (<span style="color:#fff;font-weight:bold">byte</span>) <span style="color:#0ff;font-weight:bold">&#39;:&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> InetSocketAddress source;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String logfile;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String msg;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> received;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//用于传出消息的构造函数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> LogEvent(String logfile, String msg) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>(<span style="color:#fff;font-weight:bold">null</span>, -<span style="color:#ff0;font-weight:bold">1</span>, logfile, msg);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//用于传入消息的构造函数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> LogEvent(InetSocketAddress source, <span style="color:#fff;font-weight:bold">long</span> received,
</span></span><span style="display:flex;"><span>        String logfile, String msg) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">source</span> = source;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">logfile</span> = logfile;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">msg</span> = msg;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">received</span> = received;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//返回发送 LogEvent 的源的 InetSocketAddress
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> InetSocketAddress getSource() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> source;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//返回所发送的 LogEvent 的日志文件的名称
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> String getLogfile() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> logfile;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//返回消息内容
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> String getMsg() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> msg;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//返回接收 LogEvent 的时间
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">long</span> getReceivedTimestamp() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> received;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义好了消息组件，我们便可以实现该应用程序的广播逻辑了。在下一节中，我们将研究用于编码和传输LogEvent 消息的 Netty 框架类。</p>
<h2 id="编写广播者">编写广播者<a hidden class="anchor" aria-hidden="true" href="#编写广播者">#</a></h2>
<p>Netty 提供了大量的类来支持 UDP 应用程序的编写。
表 13-1 列出了我们将要使用的主要的消息容器以及 Channel 类型。</p>
<table>
<thead>
<tr>
<th>名 称</th>
<th>描 述</th>
</tr>
</thead>
<tbody>
<tr>
<td>interface AddressedEnvelope &lt;M, A extends SocketAddress&gt; extends ReferenceCounted</td>
<td>定义一个消息，其包装了另一个消息并带有发 送者和接收者地址。其中 M 是消息类型；A 是 地址类型</td>
</tr>
<tr>
<td>class DefaultAddressedEnvelope &lt;M, A extends SocketAddress&gt; implements AddressedEnvelope&lt;M,A&gt;</td>
<td>提供了 interface AddressedEnvelope 的默认实现</td>
</tr>
<tr>
<td>class DatagramPacket extends DefaultAddressedEnvelope &lt;ByteBuf, InetSocketAddress&gt; implements ByteBufHolder</td>
<td>扩展了 DefaultAddressedEnvelope 以使 用 ByteBuf 作为消息数据容器</td>
</tr>
<tr>
<td>interface DatagramChannel extends Channel</td>
<td>扩展了 Netty 的 Channel 抽象以支持 UDP 的 多播组管理</td>
</tr>
<tr>
<td>class NioDatagramChannnel extends AbstractNioMessageChannel implements DatagramChannel</td>
<td>定义了一个能够发送和接收 AddressedEnvelope 消息的 Channel 类型</td>
</tr>
</tbody>
</table>
<p>Netty 的 DatagramPacket 是一个简单的消息容器，DatagramChannel 实现用它来和远程节点通信。类似于在我们先前的类比中的明信片，它包含了接收者（和可选的发送者）的地址以及消息的有效负载本身。要将 LogEvent 消息转换为 DatagramPacket，我们将需要一个编码器。但是没有必要从头开始编写我们自己的。我们将扩展 Netty 的 MessageToMessageEncoder，在第 10 章和第11 章中我们已经使用过了。图 13-2 展示了正在广播的 3 个日志条目，每一个都将通过一个专门的 DatagramPacket进行广播。
<img loading="lazy" src="73.png" alt=""  />
</p>
<p>图 13-3 呈现了该 LogEventBroadcaster 的 ChannelPipeline 的一个高级别视图，展示了 LogEvent 消息是如何流经它的。
<img loading="lazy" src="74.png" alt=""  />
</p>
<p>正如你所看到的，所有的将要被传输的数据都被封装在了 LogEvent 消息中。LogEventBroadcaster 将把这些写入到 Channel 中，并通过 ChannelPipeline 发送它们，在那里它们将会被转换（编码）为DatagramPacket 消息。最后，他们都将通过 UDP 被广播，并由远程节点（监视器）所捕获。
代码清单 13-2 展示了我们自定义版本的 MessageToMessageEncoder，其将执行刚才所描述的转换。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 13-2 LogEventEncoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LogEventEncoder <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageEncoder&lt;LogEvent&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> InetSocketAddress remoteAddress;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//LogEventEncoder 创建了即将被发送到指定的 InetSocketAddress 的 DatagramPacket 消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> LogEventEncoder(InetSocketAddress remoteAddress) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">remoteAddress</span> = remoteAddress;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> encode(ChannelHandlerContext channelHandlerContext,
</span></span><span style="display:flex;"><span>        LogEvent logEvent, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[] file = logEvent.<span style="color:#007f7f">getLogfile</span>().<span style="color:#007f7f">getBytes</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[] msg = logEvent.<span style="color:#007f7f">getMsg</span>().<span style="color:#007f7f">getBytes</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        ByteBuf buf = channelHandlerContext.<span style="color:#007f7f">alloc</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">buffer</span>(file.<span style="color:#007f7f">length</span> + msg.<span style="color:#007f7f">length</span> + <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将文件名写入到 ByteBuf 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        buf.<span style="color:#007f7f">writeBytes</span>(file);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//添加一个 SEPARATOR
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        buf.<span style="color:#007f7f">writeByte</span>(LogEvent.<span style="color:#007f7f">SEPARATOR</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将日志消息写入 ByteBuf 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        buf.<span style="color:#007f7f">writeBytes</span>(msg);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//将一个拥有数据和目的地地址的新 DatagramPacket 添加到出站的消息列表中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        out.<span style="color:#007f7f">add</span>(<span style="color:#fff;font-weight:bold">new</span> DatagramPacket(buf, remoteAddress));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 LogEventEncoder 被实现之后，我们已经准备好了引导该服务器，其包括设置各种各样的ChannelOption，以及在 ChannelPipeline 中安装所需要的 ChannelHandler。这将通过主类 LogEventBroadcaster 完成，
如代码清单 13-3 所示。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 13-3 LogEventBroadcaster
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LogEventBroadcaster {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> EventLoopGroup group;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Bootstrap bootstrap;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> File file;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> LogEventBroadcaster(InetSocketAddress address, File file) {
</span></span><span style="display:flex;"><span>        group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//引导该 NioDatagramChannel（无连接的）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        bootstrap.<span style="color:#007f7f">group</span>(group).<span style="color:#007f7f">channel</span>(NioDatagramChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>             <span style="color:#007f7f">//设置 SO_BROADCAST 套接字选项
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>             .<span style="color:#007f7f">option</span>(ChannelOption.<span style="color:#007f7f">SO_BROADCAST</span>, <span style="color:#fff;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>             .<span style="color:#007f7f">handler</span>(<span style="color:#fff;font-weight:bold">new</span> LogEventEncoder(address));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">file</span> = file;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> run() <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//绑定 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Channel ch = bootstrap.<span style="color:#007f7f">bind</span>(<span style="color:#ff0;font-weight:bold">0</span>).<span style="color:#007f7f">sync</span>().<span style="color:#007f7f">channel</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> pointer = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//启动主处理循环
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">for</span> (;;) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">long</span> len = file.<span style="color:#007f7f">length</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (len &lt; pointer) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// file was reset
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#007f7f">//如果有必要，将文件指针设置到该文件的最后一个字节
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                pointer = len;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (len &gt; pointer) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// Content was added
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                RandomAccessFile raf = <span style="color:#fff;font-weight:bold">new</span> RandomAccessFile(file, <span style="color:#0ff;font-weight:bold">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//设置当前的文件指针，以确保没有任何的旧日志被发送
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                raf.<span style="color:#007f7f">seek</span>(pointer);
</span></span><span style="display:flex;"><span>                String line;
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">while</span> ((line = raf.<span style="color:#007f7f">readLine</span>()) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//对于每个日志条目，写入一个 LogEvent 到 Channel 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    ch.<span style="color:#007f7f">writeAndFlush</span>(<span style="color:#fff;font-weight:bold">new</span> LogEvent(<span style="color:#fff;font-weight:bold">null</span>, -<span style="color:#ff0;font-weight:bold">1</span>,
</span></span><span style="display:flex;"><span>                    file.<span style="color:#007f7f">getAbsolutePath</span>(), line));
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//存储其在文件中的当前位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                pointer = raf.<span style="color:#007f7f">getFilePointer</span>();
</span></span><span style="display:flex;"><span>                raf.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//休眠 1 秒，如果被中断，则退出循环；否则重新处理它
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                Thread.<span style="color:#007f7f">sleep</span>(<span style="color:#ff0;font-weight:bold">1000</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>                Thread.<span style="color:#007f7f">interrupted</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> stop() {
</span></span><span style="display:flex;"><span>        group.<span style="color:#007f7f">shutdownGracefully</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        if (args.length != 2) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            throw new IllegalArgumentException();
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//        }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//创建并启动一个新的 LogEventBroadcaster 的实例
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        LogEventBroadcaster broadcaster = <span style="color:#fff;font-weight:bold">new</span> LogEventBroadcaster(
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//                new InetSocketAddress(&#34;255.255.255.255&#34;, Integer.parseInt(args[0])),
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//                new File(args[1]));
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#007f7f">//改用main方法启动
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#0ff;font-weight:bold">&#34;255.255.255.255&#34;</span>,<span style="color:#ff0;font-weight:bold">8888</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">//需要提前在对应路径创建好文件
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">new</span> File(<span style="color:#0ff;font-weight:bold">&#34;D:\\test\\my.log&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            broadcaster.<span style="color:#007f7f">run</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            broadcaster.<span style="color:#007f7f">stop</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样就完成了该应用程序的广播者组件。对于初始测试，你可以使用netcat程序。在UNIX/Linux系统中，你能发现它已经作为nc被预装了。用于Windows的版本可以从http://nmap.org/ncat获取。
netcat 非常适合于对这个应用程序进行基本的测试；它只是监听某个指定的端口，并且将所有接收
到的数据打印到标准输出。可以通过下面所示的方式，将其设置为监听 UDP 端口 9999 上的数据：
<code>$ nc -l -u -p 9999</code>
现在我们需要启动我们的 LogEventBroadcaster。代码清单 13-4 展示了如何使用 mvn
来编译和运行该广播者应用程序。pom.xml 文件中的配置指向了一个将被频繁更新的文件，
/var/log/messages（假设是一个 UNIX/Linux 环境），并将端口设置为了 9999。该文件中的
条目将会通过 UDP 广播到那个端口，并在你启动了 netcat 的终端上打印出来。
<code>mvn clean package exec:exec LogEventBroadcaster</code>
要改变该日志文件和端口值，可以在启动 mvn 的时候通过 System 属性来指定它们。代码清单 13-5 展示了如何将日志文件设置为/var/log/mail.log，并将端口设置为 8888。
mvn clean package exec:exec -PLogEventBroadcaster /
-Dlogfile=/var/log/mail.log –Dport=8888 –&hellip;.
当你看到 LogEventBroadcaster running 时，你便知道它已经成功地启动了。如果有
错误发生，将会打印一个异常消息。一旦这个进程运行起来，它就会广播任何新被添加到该日志
文件中的日志消息。使用 netcat 对于测试来说是足够了，但是它并不适合于生产系统。这也就有了我们的应用程序的第二个部分——我们将在下一节中实现的广播监视器。</p>
<h2 id="编写监视器">编写监视器<a hidden class="anchor" aria-hidden="true" href="#编写监视器">#</a></h2>
<p>我们的目标是将 netcat 替换为一个更加完整的事件消费者，我们称之为 LogEventMonitor。这个程序将：</p>
<ul>
<li>接收由 LogEventBroadcaster 广播的 UDP DatagramPacket；</li>
<li>将它们解码为 LogEvent 消息；</li>
<li>将 LogEvent 消息写出到 System.out。
和之前一样，该逻辑由一组自定义的 ChannelHandler 实现——对于我们的解码器来说，我们将扩展
MessageToMessageDecoder。图 13-4 描绘了 LogEventMonitor 的 ChannelPipeline，并且展示了
LogEvent 是如何流经它的。
<img loading="lazy" src="75.png" alt=""  />

ChannelPipeline 中的第一个解码器LogEventDecoder 负责将传入的DatagramPacket解码为 LogEvent消息（一个用于转换入站数据的任何 Netty 应用程序的典型设置）。代码清单13-6 展示了该实现。</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 13-6 LogEventDecoder
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LogEventDecoder <span style="color:#fff;font-weight:bold">extends</span> MessageToMessageDecoder&lt;DatagramPacket&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> decode(ChannelHandlerContext ctx, DatagramPacket datagramPacket, List&lt;Object&gt; out) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//获取对 DatagramPacket 中的数据（ByteBuf）的引用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ByteBuf data = datagramPacket.<span style="color:#007f7f">content</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//获取该 SEPARATOR 的索引
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">int</span> idx = data.<span style="color:#007f7f">indexOf</span>(<span style="color:#ff0;font-weight:bold">0</span>, data.<span style="color:#007f7f">readableBytes</span>(), LogEvent.<span style="color:#007f7f">SEPARATOR</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//提取文件名
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String filename = data.<span style="color:#007f7f">slice</span>(<span style="color:#ff0;font-weight:bold">0</span>, idx).<span style="color:#007f7f">toString</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//提取日志消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String logMsg = data.<span style="color:#007f7f">slice</span>(idx + <span style="color:#ff0;font-weight:bold">1</span>, data.<span style="color:#007f7f">readableBytes</span>()).<span style="color:#007f7f">toString</span>(CharsetUtil.<span style="color:#007f7f">UTF_8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//构建一个新的 LogEvent 对象，并且将它添加到（已经解码的消息的）列表中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        LogEvent event = <span style="color:#fff;font-weight:bold">new</span> LogEvent(datagramPacket.<span style="color:#007f7f">sender</span>(), System.<span style="color:#007f7f">currentTimeMillis</span>(), filename, logMsg);
</span></span><span style="display:flex;"><span>        out.<span style="color:#007f7f">add</span>(event);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>第二个 ChannelHandler 的工作是对第一个 ChannelHandler 所创建的 LogEvent 消息执行一些处理。在这个场景下，它只是简单地将它们写出到 System.out。在真实世界的应用程序中，你可能需要聚合来源于不同日志文件的事件，或者将它们发布到数据库中。
代码清单13-7 展示了 LogEventHandler，其说明了需要遵循的基本步骤。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 13-7 LogEventHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//扩展 SimpleChannelInboundHandler 以处理 LogEvent 消息
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LogEventHandler <span style="color:#fff;font-weight:bold">extends</span> SimpleChannelInboundHandler&lt;LogEvent&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> exceptionCaught(ChannelHandlerContext ctx, Throwable cause) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//当异常发生时，打印栈跟踪信息，并关闭对应的 Channel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        cause.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        ctx.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> channelRead0(ChannelHandlerContext ctx, LogEvent event) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//创建 StringBuilder，并且构建输出的字符串
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        StringBuilder builder = <span style="color:#fff;font-weight:bold">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(event.<span style="color:#007f7f">getReceivedTimestamp</span>());
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(<span style="color:#0ff;font-weight:bold">&#34; [&#34;</span>);
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(event.<span style="color:#007f7f">getSource</span>().<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(<span style="color:#0ff;font-weight:bold">&#34;] [&#34;</span>);
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(event.<span style="color:#007f7f">getLogfile</span>());
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(<span style="color:#0ff;font-weight:bold">&#34;] : &#34;</span>);
</span></span><span style="display:flex;"><span>        builder.<span style="color:#007f7f">append</span>(event.<span style="color:#007f7f">getMsg</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//打印 LogEvent 的数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(builder.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>LogEventHandler 将以一种简单易读的格式打印 LogEvent 消息，包括以下的各项：</p>
<ul>
<li>以毫秒为单位的被接收的时间戳；</li>
<li>发送方的 InetSocketAddress，其由 IP 地址和端口组成；</li>
<li>生成 LogEvent 消息的日志文件的绝对路径名；</li>
<li>实际上的日志消息，其代表日志文件中的一行。</li>
</ul>
<p>现在我们需要将我们的LogEventDecoder 和LogEventHandler 安装到ChannelPipeline中，
如图 13-4 所示。代码清单 13-8 展示了如何通过 LogEventMonitor 主类来做到这一点。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 代码清单 13-8 LogEventMonitor
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> LogEventMonitor {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> EventLoopGroup group;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Bootstrap bootstrap;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> LogEventMonitor(InetSocketAddress address) {
</span></span><span style="display:flex;"><span>        group = <span style="color:#fff;font-weight:bold">new</span> NioEventLoopGroup();
</span></span><span style="display:flex;"><span>        bootstrap = <span style="color:#fff;font-weight:bold">new</span> Bootstrap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//引导该 NioDatagramChannel
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        bootstrap.<span style="color:#007f7f">group</span>(group)
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">channel</span>(NioDatagramChannel.<span style="color:#007f7f">class</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//设置套接字选项 SO_BROADCAST
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            .<span style="color:#007f7f">option</span>(ChannelOption.<span style="color:#007f7f">SO_BROADCAST</span>, <span style="color:#fff;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">handler</span>( <span style="color:#fff;font-weight:bold">new</span> ChannelInitializer&lt;Channel&gt;() {
</span></span><span style="display:flex;"><span>                @Override
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> initChannel(Channel channel)
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>                    ChannelPipeline pipeline = channel.<span style="color:#007f7f">pipeline</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">//将 LogEventDecoder 和 LogEventHandler 添加到 ChannelPipeline 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> LogEventDecoder());
</span></span><span style="display:flex;"><span>                    pipeline.<span style="color:#007f7f">addLast</span>(<span style="color:#fff;font-weight:bold">new</span> LogEventHandler());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } )
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">localAddress</span>(address);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Channel bind() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//绑定 Channel。注意，DatagramChannel 是无连接的
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> bootstrap.<span style="color:#007f7f">bind</span>().<span style="color:#007f7f">syncUninterruptibly</span>().<span style="color:#007f7f">channel</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> stop() {
</span></span><span style="display:flex;"><span>        group.<span style="color:#007f7f">shutdownGracefully</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//        if (args.length != 1) {
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//            throw new IllegalArgumentException(&#34;Usage: LogEventMonitor &lt;port&gt;&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">//        }
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">//构造一个新的 LogEventMonitor
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        LogEventMonitor monitor = <span style="color:#fff;font-weight:bold">new</span> LogEventMonitor(<span style="color:#fff;font-weight:bold">new</span> InetSocketAddress(<span style="color:#ff0;font-weight:bold">8888</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Channel channel = monitor.<span style="color:#007f7f">bind</span>();
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;LogEventMonitor running&#34;</span>);
</span></span><span style="display:flex;"><span>            channel.<span style="color:#007f7f">closeFuture</span>().<span style="color:#007f7f">sync</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">finally</span> {
</span></span><span style="display:flex;"><span>            monitor.<span style="color:#007f7f">stop</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="运行-logeventbroadcaster-和-logeventmonitor">运行 LogEventBroadcaster 和 LogEventMonitor<a hidden class="anchor" aria-hidden="true" href="#运行-logeventbroadcaster-和-logeventmonitor">#</a></h2>
<p>通过main方法启动<code>LogEventBroadcaster</code>，将通过 UDP 协议广播日志消息。
继续通过main方法启动<code>LogEventMonitor</code>以接收和显示广播消息。当你看到 LogEventMonitor running 时，你将知道它已经成功地启动了。如果有错误发生，则将会打印异常信息。如代码清单 13-10 所示，当任何新的日志事件被添加到该日志文件中时，该终端都会显示它们。消息的格式则是由 LogEventHandler 创建的。代码清单 13-10 LogEventMonitor 的输出</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1364217299382 [/192.168.0.38:63182] [/var/log/messages] : Mar 25 13:55:08
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPREQUEST of 192.168.0.50 on eth2 to 192.168.0.254
</span></span><span style="display:flex;"><span>port 67
</span></span><span style="display:flex;"><span>1364217299382 [/192.168.0.38:63182] [/var/log/messages] : Mar 25 13:55:08
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPACK of 192.168.0.50 from 192.168.0.254
</span></span><span style="display:flex;"><span>1364217299382 [/192.168.0.38:63182] [/var/log/messages] : Mar 25 13:55:08
</span></span><span style="display:flex;"><span>dev-linux dhclient: bound to 192.168.0.50 -- renewal in 270 seconds.
</span></span><span style="display:flex;"><span>1364217299382 [/192.168.0.38:63182] [[/var/log/messages] : Mar 25 13:59:38
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPREQUEST of 192.168.0.50 on eth2 to 192.168.0.254
</span></span><span style="display:flex;"><span>port 67
</span></span><span style="display:flex;"><span>1364217299382 [/192.168.0.38:63182] [/[/var/log/messages] : Mar 25 13:59:38
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPACK of 192.168.0.50 from 192.168.0.254
</span></span><span style="display:flex;"><span>1364217299382 [/192.168.0.38:63182] [/var/log/messages] : Mar 25 13:59:38
</span></span><span style="display:flex;"><span>dev-linux dhclient: bound to 192.168.0.50 -- renewal in 259 seconds.
</span></span><span style="display:flex;"><span>1364217299383 [/192.168.0.38:63182] [/var/log/messages] : Mar 25 14:03:57
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPREQUEST of 192.168.0.50 on eth2 to 192.168.0.254
</span></span><span style="display:flex;"><span>port 67
</span></span><span style="display:flex;"><span>1364217299383 [/192.168.0.38:63182] [/var/log/messages] : Mar 25 14:03:57
</span></span><span style="display:flex;"><span>dev-linux dhclient: DHCPACK of 192.168.0.50 from 192.168.0.254
</span></span><span style="display:flex;"><span>1364217299383 [/192.168.0.38:63182] [/var/log/messages] : Mar 25 14:03:57
</span></span><span style="display:flex;"><span>dev-linux dhclient: bound to 192.168.0.50 -- renewal in 285 seconds.
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果你不能访问 UNIX 的 syslog，那么你可以创建一个自定义的文件，并手动提供内容以观测该应用程序的反应。以使用 touch 命令来创建一个空文件作为开始，下面所展示的步骤使用了 UNIX 命令。
<code> touch ~/mylog.log</code>
现在再次启动 LogEventBroadcaster，并通过设置系统属性来将其指向该文件：
<code> chapter13&gt; mvn exec:exec -PLogEventBroadcaster -Dlogfile=~/mylog.log</code>
一旦 LogEventBroadcaster 运行，你就可以手动将消息添加到该文件中，以在
LogEventMonitor 终端中查看广播输出。使用 echo 命令并将输出重定向到该文件，如下
所示：<code>echo 'Test log entry' &gt;&gt; ~/mylog.log</code>
你可以根据需要启动任意多的监视器实例，它们每一个都将接收并显示相同的消息。</p>
<h1 id="案例研究-1">案例研究<a hidden class="anchor" aria-hidden="true" href="#案例研究-1">#</a></h1>
<p>在本章中，我们将介绍两部分案例研究中的第一部分，它们是由已经在内部基础设施中广泛使用了 Netty 的公司贡献的。我们希望这些其他人如何利用 Netty 框架来解决现实世界问题的例子，能够拓展你对于 Netty能够做到什么事情的理解。略&hellip;看原书吧</p>
<h1 id="单用户登录功能">单用户登录功能<a hidden class="anchor" aria-hidden="true" href="#单用户登录功能">#</a></h1>
<p>a登录，杀进程
b登录，（想T a，但是a进程被杀，长链接断开，session中已经没有，t失败）
a打开，应该被T</p>
<p>a登录，杀进程
b登录，杀进程
b再次打开，自己被T</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/java/">java</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>