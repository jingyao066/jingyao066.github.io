<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>第10章 MySQL优化 | Wjy&#39;s Blog</title>
<meta name="keywords" content="mysql">
<meta name="description" content="MySQL优化手段 MySQL数据库的优化手段通常包括但不限于： SQL查询优化：这是最低成本的优化手段，通过优化查询语句、适当添加索引等方式进">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://009965.xyz/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://009965.xyz/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://009965.xyz/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://009965.xyz/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://009965.xyz/apple-touch-icon.png">
<link rel="mask-icon" href="https://009965.xyz/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://009965.xyz/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:url" content="https://009965.xyz/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/">
  <meta property="og:site_name" content="Wjy&#39;s Blog">
  <meta property="og:title" content="第10章 MySQL优化">
  <meta property="og:description" content="MySQL优化手段 MySQL数据库的优化手段通常包括但不限于： SQL查询优化：这是最低成本的优化手段，通过优化查询语句、适当添加索引等方式进">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-05-25T18:13:06+00:00">
    <meta property="article:modified_time" content="2025-05-25T18:13:06+00:00">
    <meta property="article:tag" content="Mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第10章 MySQL优化">
<meta name="twitter:description" content="MySQL优化手段 MySQL数据库的优化手段通常包括但不限于： SQL查询优化：这是最低成本的优化手段，通过优化查询语句、适当添加索引等方式进">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://009965.xyz/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "第10章 MySQL优化",
      "item": "https://009965.xyz/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "第10章 MySQL优化",
  "name": "第10章 MySQL优化",
  "description": "MySQL优化手段 MySQL数据库的优化手段通常包括但不限于： SQL查询优化：这是最低成本的优化手段，通过优化查询语句、适当添加索引等方式进",
  "keywords": [
    "mysql"
  ],
  "articleBody": "MySQL优化手段 MySQL数据库的优化手段通常包括但不限于：\nSQL查询优化：这是最低成本的优化手段，通过优化查询语句、适当添加索引等方式进行。并且效果显著。 库表结构优化：通过规范化设计、优化索引和数据类型等方式进行库表结构优化，需要对数据库结构进行调整和改进 系统配置优化：根据硬件和操作系统的特点，调整最大连接数、内存管理、IO调度等参数 硬件优化：升级硬盘、增加内存容量、升级处理器等硬件方面的投入，需要购买和替换硬件设备，成本较高 我们主要掌握：SQL查询优化\nSQL性能分析工具 查看数据库整体情况 通过以下命令可以查看当前数据库在SQL语句执行方面的整体情况：\n1 2 3 4 5 6 show global status like 'Com_select'; show global status like 'Com_insert'; show global status like 'Com_delete'; show global status like 'Com_update'; show global status like 'Com_______'; 这些结果反映了从 MySQL 服务器启动到当前时刻，所有的 SELECT 查询总数。对于 MySQL 性能优化来说，通过查看 Com_select 的值可以了解 SELECT 查询在整个 MySQL 服务期间所占比例的情况：\n如果 Com_select 次数过高，可能说明查询表中的每条记录都会返回过多的字段。 如果 Com_select 次数很少，同时insert或delete或update的次数很高，可能说明服务器运行的应用程序过于依赖写入操作和少量读取操作。 总之，通过查看 Com_select 的值，可以了解 MySQL 服务器的长期执行情况，并在优化查询性能时，帮助我们了解 MySQL 的性能瓶颈。\n慢查询日志 慢查询日志文件可以将查询较慢的DQL语句记录下来，便于我们定位需要调优的select语句。\n通过以下命令查看慢查询日志功能是否开启：\n1 show variables like 'slow_query_log'; 慢查询日志功能默认是关闭的。请修改my.ini文件来开启慢查询日志功能，在my.ini的[mysqld]后面添加如下配置：\n注意：slow_query_log=1表示开启慢查询日志功能，long_query_time=3表示：只要SELECT语句的执行耗时超过3秒则将其记录到慢查询日志中。\n重启mysql服务。再次查看是否开启慢查询日志功能：\n尝试执行一条时长超过3秒的select语句：\n1 select empno,ename,sleep(4) from emp where ename='smith'; 慢查询日志文件默认存储在：C:\\dev\\mysql-8.0.36-winx64\\data 目录下，默认的名字是：计算机名-slow.log\n通过该文件可以清晰的看到哪些DQL语句属于慢查询：\nshow profiles 通过show profiles可以查看一个SQL语句在执行过程中具体的耗时情况。帮助我们更好的定位问题所在。\n查看当前数据库是否支持 profile操作：\n1 select @@have_profiling; 查看 profiling 开关是否打开：\n1 select @@profiling; 将 profiling 开关打开：\n1 set profiling = 1; 可以执行多条DQL语句，然后使用 show profiles; 来查看当前数据库中执行过的每个SELECT语句的耗时情况。\n1 2 3 4 select empno,ename from emp; select empno,ename from emp where empno=7369; select count(*) from emp; show profiles; 查看某个SQL语句语句在执行过程中，每个阶段的耗时情况：\n1 show profile for query 4; 想查看执行过程中cpu的情况，可以执行以下命令：\n1 show profile cpu for query 4; explain explain命令可以查看一个DQL语句的执行计划，根据执行计划可以做出相应的优化措施。提高执行效率。\n1 explain select * from emp where empno=7369; id id反映出一条select语句执行顺序，id越大优先级越高。id相同则按照自上而下的顺序执行。\n1 explain select e.ename,d.dname from emp e join dept d on e.deptno=d.deptno join salgrade s on e.sal between s.losal and s.hisal; 由于id相同，反映出三张表在执行顺序上属于平等关系，执行时采用，先d，再e，最后s。\n1 explain select e.ename,d.dname from emp e join dept d on e.deptno=d.deptno where e.sal=(select sal from emp where ename='ford'); 反映出，先执行子查询，然后让e和d做表连接。\nselect_type 反映了mysql查询语句的类型。常用值包括：\nSIMPLE：表示查询中不包含子查询或UNION操作。这种查询通常包括一个表或是最多一个联接（JOIN） PRIMARY：表示当前查询是一个主查询。（主要的查询） UNION：表示查询中包含UNION操作 SUBQUERY：子查询 DERIVED：派生表（表示查询语句出现在from后面） table 反映了这个查询操作的是哪个表。\ntype 反映了查询表中数据时的访问类型，常见的值：\nNULL：效率最高，一般不可能优化到这个级别，只有查询时没有查询表的时候，访问类型是NULL。例如：select 1; system：通常访问系统表的时候，访问类型是system。一般也很难优化到这个程序。 const：根据主键或者唯一性索引查询，索引值是常量值时。explain select * from emp where empno=7369; eq_ref：根据主键或者唯一性索引查询。索引值不是常量值。 ref：使用了非唯一的索引进行查询。 range：使用了索引，扫描了索引树的一部分。 index：表示用了索引，但是也需要遍历整个索引树。 all：全表扫描 效率最高的是NULL，效率最低的是all，从上到下，从高到低。\npossible_keys 这个查询可能会用到的索引\nkey 实际用到的索引\nkey_len 反映索引中在查询中使用的列所占的总字节数。\nrows 查询扫描的预估计行数。\nExtra 给出了与查询相关的额外信息和说明。这些额外信息可以帮助我们更好地理解查询执行的过程。\n索引优化 加索引 vs 不加索引 将这个sql脚本初始化到数据库中（初始化100W条记录）：t_vip.sql\n根据id查询（id是主键，有索引）：\n1 select * from t_vip where id = 900000; 根据name查询（name上没有索引）：\n1 select * from t_vip where name='4c6494cb'; 给name字段添加索引：\n1 create index idx_t_user_name on t_vip(name); 再次根据name查询（此时name上已经有索引了） ：\n1 select * from t_vip where name='4c6494cb'; 最左前缀原则 假设有这样一张表：\n1 2 3 4 5 6 7 create table t_customer( id int primary key auto_increment, name varchar(255), age int, gender char(1), email varchar(255) ); 添加了这些数据：\n1 2 3 4 5 insert into t_customer values(null, 'zhangsan', 20, 'M', 'zhangsan@123.com'); insert into t_customer values(null, 'lisi', 22, 'M', 'lisi@123.com'); insert into t_customer values(null, 'wangwu', 18, 'F', 'wangwu@123.com'); insert into t_customer values(null, 'zhaoliu', 22, 'F', 'zhaoliu@123.com'); insert into t_customer values(null, 'jack', 30, 'M', 'jack@123.com'); 添加了这样的复合索引：\n1 create index idx_name_age_gender on t_customer(name,age,gender); 最左前缀原则：当查询语句条件中包含了这个复合索引最左边的列 name 时，此时索引才会起作用。\n验证1：\n1 explain select * from t_customer where name='zhangsan' and age=20 and gender='M'; 验证结果：完全使用了索引\n验证2：\n1 explain select * from t_customer where name='zhangsan' and age=20; 验证结果：使用了部分索引\n验证3：\n1 explain select * from t_customer where name='zhangsan'; 验证结果：使用了部分索引\n验证4：\n1 explain select * from t_customer where age=20 and gender='M' and name='zhangsan'; 验证结果：完全使用了索引\n验证5：\n1 explain select * from t_customer where gender='M' and age=20; 验证结果：没有使用任何索引\n验证6：\n1 explain select * from t_customer where name='zhangsan' and gender='M'; 验证结果：使用了部分索引\n验证7：\n1 explain select * from t_customer where name='zhangsan' and gender='M' and age=20; 验证结果：完全使用了索引\n范围查询时，在“范围条件”右侧的列索引会失效：\n验证：\n1 explain select * from t_customer where name='zhangsan' and age\u003e20 and gender='M'; 验证结果：name和age列索引生效。gender列索引无效。\n怎么解决？建议范围查找时带上“=”\n1 explain select * from t_customer where name='zhangsan' and age\u003e=20 and gender='M'; 索引失效情况 有这样一张表：\n1 2 3 4 5 6 create table t_emp( id int primary key auto_increment, name varchar(255), sal int, age char(2) ); 有这样一些数据：\n1 2 3 insert into t_emp values(null, '张三', 5000,'20'); insert into t_emp values(null, '张飞', 4000,'30'); insert into t_emp values(null, '李飞', 6000,'40'); 有这样一些索引：\n1 2 3 create index idx_t_emp_name on t_emp(name); create index idx_t_emp_sal on t_emp(sal); create index idx_t_emp_age on t_emp(age); 索引列参加了运算，索引失效 1 explain select * from t_emp where sal \u003e 5000; 验证结果：使用了索引\n1 explain select * from t_emp where sal*10 \u003e 50000; 验证结果：索引失效\n索引列进行模糊查询时以 % 开始的，索引失效 1 explain select * from t_emp where name like '张%'; 验证结果：索引有效\n1 explain select * from t_emp where name like '%飞'; 验证结果：索引失效\n索引列是字符串类型，但查询时省略了单引号，索引失效 1 explain select * from t_emp where age='20'; 验证结果：索引有效\n1 explain select * from t_emp where age=20; 验证结果：索引失效\n查询条件中有or，只要有未添加索引的字段，索引失效 1 explain select * from t_emp where name='张三' or sal=5000; 验证结果：使用了索引\n将t_emp表sal字段上的索引删除：\n1 alter table t_emp drop index idx_t_emp_sal; 再次验证：\n1 explain select * from t_emp where name='张三' or sal=5000; 验证结果：索引失效\n当查询的符合条件的记录在表中占比较大，索引失效 复制一张新表：emp2\n1 create table emp2 as select * from emp; 给sal添加索引：\n1 alter table emp2 add index idx_emp2_sal(sal); 验证1：\n1 explain select * from emp2 where sal \u003e 800; 不走索引：\n验证2：\n1 explain select * from emp2 where sal \u003e 1000; 不走索引：\n验证3：\n1 explain select * from emp2 where sal \u003e 2000; 走索引：\n关于is null和is not null的索引失效问题 给emp2的comm字段添加一个索引：\n1 create index idx_emp2_comm on emp2(comm); 将emp2表的comm字段值全部更新为NULL：\n1 update emp2 set comm=null; 验证此时条件使用is null是否走索引：\n1 explain select * from emp2 where comm is null; 验证结果：不走索引。\n验证此时条件使用is not null是否走索引：\n将emp2表的comm字段全部更新为非NULL：\n1 update emp2 set comm=100; 验证此时条件使用is null是否走索引：\n1 explain select * from emp2 where comm is null; 验证结果：走索引\n验证此时条件使用is not null是否走索引：\n1 explain select * from emp2 where comm is not null; 验证结果：不走索引\n结论：走索引还是不走索引，根数据分布有很大关系，如果符合条件的记录占比较大，会考虑使用全表扫描，而放弃走索引。\n指定索引 当一个字段上既有单列索引，又有复合索引时，我们可以通过以下的SQL提示来要求该SQL语句执行时采用哪个索引：\nuse index(索引名称)：建议使用该索引，只是建议，底层mysql会根据实际效率来考虑是否使用你推荐的索引。 ignore index(索引名称)：忽略该索引 force index(索引名称)：强行使用该索引 查看 t_customer 表上的索引：\n1 show index from t_customer; 可以看到name age gender三列添加了一个复合索引。\n现在给name字段添加一个单列索引：\n1 create index idx_name on t_customer(name); 看看以下的语句默认使用了哪个索引：\n1 explain select * from t_customer where name='zhangsan'; 通过测试得知，默认使用了联合索引。\n如何建议使用单列索引idx_name：\n1 explain select * from t_customer use index(idx_name) where name='zhangsan'; 如何忽略使用符合索引 idx_name_age_gender：\n1 explain select * from t_customer ignore index(idx_name_age_gender) where name='zhangsan'; 如何强行使用单列索引idx_name：\n1 explain select * from t_customer force index(idx_name) where name='zhangsan'; 覆盖索引 覆盖索引我们在讲解索引的时候已经提到过了，覆盖索引强调的是：在select后面写字段的时候，这些字段尽可能是索引所覆盖的字段，这样可以避免回表查询。尽可能避免使用 select *，因为select * 很容易导致回表查询。（本质就是：能在索引上检索的，就不要再次回表查询了。）\n例如：有一张表 emp3，其中 ename,job添加了联合索引：idx_emp3_ename_job，以下这个select语句就不会回表：\n1 2 3 4 5 drop table if exists emp3; create table emp3 as select * from emp; alter table emp3 add constraint emp3_pk primary key(empno); create index idx_emp3_ename_job on emp3(ename,job); explain select empno,ename,job from emp3 where ename='KING'; 如果查询语句要查找的列没有在索引中，则会回表查询，例如：\n1 explain select empno,ename,job,sal from emp3 where ename='KING'; 面试题：t_user表字段如下：id,name,password,realname,birth,email。表中数据量500万条，请针对以下SQL语句给出优化方案：\n1 select id,name,realname from t_user where name='鲁智深'; 如果只给name添加索引，底层会进行大量的回表查询，效率较低，建议给name和realname两个字段添加联合索引，这样大大减少回表操作，提高查询效率。\n前缀索引 如果一个字段类型是varchar或text字段，字段中存储的是文本或者大文本，直接对这种长文本创建索引，会让索引体积很大，怎么优化呢？可以将字符串的前几个字符截取下来当做索引来创建。这种索引被称为前缀索引，例如：\n1 2 3 drop table if exists emp4; create table emp4 as select * from emp; create index idx_emp4_ename_2 on emp4(ename(2)); 以上SQL表示将emp4表中ename字段的前2个字符创建到索引当中。\n使用前缀索引时，需要通过以下公式来确定使用前几个字符作为索引：\n1 select count(distinct substring(ename,1,前几个字符)) / count(*) from emp4; 以上查询结果越接近1，表示索引的效果越好。（原理：做索引值的话，索引值越具有唯一性效率越高）\n假设我们使用前1个字符作为索引值：\n1 select count(distinct substring(ename,1,1)) / count(*) from emp4; 假设我们使用前2个字符作为索引值：\n1 select count(distinct substring(ename,1,2)) / count(*) from emp4; 可见使用前2个字符作为索引值，能够让索引值更具有唯一性，效率越好，因此我们选择前2个字符作为前缀索引。\n1 create index idx_emp4_ename_2 on emp4(ename(2)); 执行以下的查询语句则会走这个前缀索引：\n1 explain select * from emp4 where ename='KING'; 单列索引和复合索引怎么选择 当查询语句的条件中有多个条件，建议将这几个列创建为复合索引，因为创建单列索引很容易回表查询。\n例如分别给emp5表ename，job添加两个单列索引：\n1 2 3 4 5 create table emp5 as select * from emp; alter table emp5 add constraint emp5_pk primary key(empno); create index idx_emp5_ename on emp5(ename); create index idx_emp5_job on emp5(job); 执行以下查询语句：\n1 explain select empno,ename,job from emp5 where ename='SMITH' and job='CLERK'; ename和job都出现在查询条件中，可以给emp6表的ename和job创建一个复合索引：\n1 2 3 4 5 create table emp6 as select * from emp; alter table emp6 add constraint emp6_pk primary key(empno); create index idx_emp6_ename_job on emp6(ename,job); explain select empno,ename,job from emp6 where ename='SMITH' and job='CLERK'; 对于以上查询语句，使用复合索引避免了回表，因此这种情况下还是建议使用复合索引。\n注意：创建索引时应考虑最左前缀原则，主字段并且具有很强唯一性的字段建议排在第一位，例如：\n1 create index idx_emp_ename_job on emp(ename,job); 和以下方式对比：\n1 create index idx_emp_job_ename on emp(job,ename); 由于ename是主字段，并且ename具有很好的唯一性，建议将ename列放在最左边。因此这两种创建复合索引的方式，建议采用第一种。\n复合索引底层原理：\n索引创建原则 表数据量庞大，通常超过百万条数据。 经常出现在where，order by，group by后面的字段建议添加索引。 创建索引的字段尽量具有很强的唯一性。 如果字段存储文本，内容较大，一定要创建前缀索引。 尽量使用复合索引，使用单列索引容易回表查询。 如果一个字段中的数据不会为NULL，建议建表时添加not null约束，这样优化器就知道使用哪个索引列更加有效。 不要创建太多索引，当对数据进行增删改的时候，索引需要重新重新排序。 如果很少的查询，经常的增删改不建议加索引。 SQL优化 order by的优化 准备数据：\n1 2 3 4 5 6 7 8 9 10 11 12 13 drop table if exists workers; create table workers( id int primary key auto_increment, name varchar(255), age int, sal int ); insert into workers values(null, '孙悟空', 500, 50000); insert into workers values(null, '猪八戒', 300, 40000); insert into workers values(null, '沙和尚', 600, 40000); insert into workers values(null, '白骨精', 600, 10000); explain查看一个带有order by的语句时，Extra列会显示：using index 或者 using filesort，区别是什么？\nusing index: 表示使用索引，因为索引是提前排好序的。效率很高。 using filesort：表示使用文件排序，这就表示没有走索引，对表中数据进行排序，排序时将硬盘的数据读取到内存当中，在内存当中排好序。这个效率是低的，应避免。 此时name没有添加索引，如果根据name进行排序的话：\n1 explain select id,name from workers order by name; 显然这种方式效率较低。\n给name添加索引：\n1 create index idx_workers_name on workers(name); 再根据name排序：\n1 explain select id,name from workers order by name; 这样效率则提升了。\n如果要通过age和sal两个字段进行排序，最好给age和sal两个字段添加复合索引，不添加复合索引时：\n按照age升序排，如果age相同则按照sal升序\n1 explain select id,age,sal from workers order by age,sal; 这样效率是低的。\n给age和sal添加复合索引：\n1 create index idx_workers_age_sal on workers(age, sal); 再按照age升序排，如果age相同则按照sal升序：\n1 explain select id,age,sal from workers order by age,sal; 这样效率提升了。\n在B+树上叶子结点上的所有数据默认是按照升序排列的，如果按照age降序，如果age相同则按照sal降序，会走索引吗？\n1 explain select id,age,sal from workers order by age desc,sal desc; 可以看到备注信息是：反向索引扫描，使用了索引。\n这样效率也是很高的，因为B+树叶子结点之间采用的是双向指针。可以从左向右（升序），也可以从右向左（降序）。\n如果一个升序，一个降序会怎样呢？\n1 explain select id,age,sal from workers order by age asc, sal desc; 可见age使用了索引，但是sal没有使用索引。怎么办呢？可以针对这种排序情况创建对应的索引来解决：\n1 create index idx_workers_ageasc_saldesc on workers(age asc, sal desc); 创建的索引如下：A表示升序，D表示降序。\n再次执行：\n1 explain select id,age,sal from workers order by age asc, sal desc; 我们再来看看，对于排序来说是否支持最左前缀法则：\n1 explain select id,age,sal from workers order by sal; 通过测试得知，order by也遵循最左前缀法则。\n我们再来看一下未使用覆盖索引会怎样？\n1 explain select * from workers order by age,sal; 通过测试得知，排序也要尽量使用覆盖索引。\norder by 优化原则总结：\n排序也要遵循最左前缀法则。 使用覆盖索引。 针对不同的排序规则，创建不同索引。（如果所有字段都是升序，或者所有字段都是降序，则不需要创建新的索引） 如果无法避免filesort，要注意排序缓存的大小，默认缓存大小256KB，可以修改系统变量 sort_buffer_size ： 1 show variables like 'sort_buffer_size'; group by优化 创建empx表：\n1 create table empx as select * from emp; job字段上没有索引，根据job进行分组，查看每个工作岗位有多少人：\n1 select job,count(*) from empx group by job; 看看是否走索引了：\n1 explain select job,count(*) from empx group by job; 使用了临时表，效率较低。\n给job添加索引：\n1 create index idx_empx_job on empx(job); 再次执行：\n1 explain select job,count(*) from empx group by job; 效率提升了。\n我们再来看看group by是否需要遵守最左前缀法则：给deptno和sal添加复合索引\n1 create index idx_empx_deptno_sal on empx(deptno, sal); 根据部门编号分组，查看每个部门人数：\n1 explain select deptno,count(*) from empx group by deptno; 效率很高，因为deptno是复合索引中最左边的字段。\n根据sal分组，查看每个工资有多少人：\n1 explain select sal, count(*) from empx group by sal; 使用了临时表，效率较低。\n通过测试得知，group by也同样遵循最左前缀法则。\n我们再来测试一下，如果将部门编号deptno（复合索引的最左列）添加到where条件中，效率会不会提升：\n1 explain select sal, count(*) from empx where deptno=10 group by sal; 效率有提升的，这说明了，group by确实也遵循最左前缀法则。（where中使用了最左列）\nlimit优化 数据量特别庞大时，取数据时，越往后效率越低，怎么提升？mysql官方给出的解决方案是：使用覆盖索引+子查询的形式来提升效率。\n怎么解决？使用覆盖索引，加子查询\n使用覆盖索引：速度有所提升\n使用子查询形式取其他列的数据：\n通过测试，这种方式整体效率有所提升。\n主键优化 主键设计原则：\n主键值不要太长，二级索引叶子结点上存储的是主键值，主键值太长，容易导致索引占用空间较大。 尽量使用auto_increment生成主键。尽量不要使用uuid做主键，因为uuid不是顺序插入。 最好不要使用业务主键，因为业务的变化会导致主键值的频繁修改，主键值不建议修改，因为主键值修改，聚集索引一定会重新排序。 在插入数据时，主键值最好是顺序插入，不要乱序插入，因为乱序插入可能会导致B+树叶子结点频繁的进行页分裂与页合并操作，效率较低。 主键值对应聚集索引，插入主键值如果是乱序的，B+树叶子结点需要不断的重新排序，重排过程中还会频繁涉及到页分裂和页合并的操作，效率较低。 B+树上的每个节点都存储在页（page）中。一个页面中存储一个节点。 MySQL的InnoDB存储引擎一个页可以存储16KB的数据。 如果主键值不是顺序插入的话，会导致频繁的页分裂和页合并。在一个B+树中，页分裂和页合并是树的自动调整机制的一部分。当一个页已经满了，再插入一个新的关键字时就会触发页分裂操作，将页中的关键字分配到两个新的页中，同时调整树的结构。相反，当一个页中的关键字数量下降到一个阈值以下时，就会触发页合并操作，将两个相邻的页合并成一个新的页。如果主键值是随机的、不是顺序插入的，那么页的利用率会降低，页分裂和页合并的次数就会增加。由于页的分裂和合并是比较耗时的操作，频繁的分裂和合并会降低数据库系统的性能。因此，为了优化B+树的性能，可以将主键值设计成顺序插入的，这样可以减少页的分裂和合并的次数，提高B+树的性能。在实际应用中，如果对主键值的顺序性能要求不是特别高，也可以采用一些技术手段来减少页分裂和合并，例如B+树分裂时采用“延迟分裂”技术，或者通过调整页的大小和节点的大小等方式来优化B+树的性能。 insert优化 insert优化原则：\n批量插入：数据量较大时，不要一条一条插入，可以批量插入，当然，建议一次插入数据不超过1000条 1 insert into t_user(id,name,age) values (1,'jack',20),(2,'lucy',30),(3,'timi',22); mysql默认是自动提交事务，只要执行一条DML语句就自动提交一次，因此，当插入大量数据时，建议手动开启事务和手动提交事务。不建议使用数据库事务自动提交机制。 主键值建议采用顺序插入，顺序插入比乱序插入效率高。 超大数据量插入可以考虑使用mysql提供的load指令，load指令可以将csv文件中的数据批量导入到数据库表当中，并且效率很高，过程如下： 第一步：登录mysql时指定参数 1 mysql --local-infile -uroot -p1234 第二步：开启local_infile功能 1 set global local_infile = 1; 第三步：执行load指令 1 2 3 4 5 6 7 8 9 10 11 use powernode; create table t_temp( id int primary key, name varchar(255), password varchar(255), birth char(10), email varchar(255) ); load data local infile 'E:\\\\powernode\\\\05-MySQL高级\\\\resources\\\\t_temp-100W.csv' into table t_temp fields terminated by ',' lines terminated by '\\n'; 文件中的数据如下：\n导入表中之后，数据如下：\ncount(*)优化 分组函数count的使用方式：\ncount(主键) 原理：将每个主键值取出，累加 count(常量值) 原理：获取到每个常量值，累加 count(字段) 原理：取出字段的每个值，判断是否为NULL，不为NULL则累加。 count(*) 原理：不用取值，底层mysql做了优化，直接统计总行数，效率最高。 结论：如果你要统计一张表中数据的总行数，建议使用 count(*)\n注意：\n对于InnoDB存储引擎来说，count计数的实现原理就是将表中每一条记录取出，然后累加。如果你想真正提高效率，可以自己使用额外的其他程序来实现，例如每向表中插入一条记录时，在redis数据库中维护一个总行数，这样获取总行数的时候，直接从redis中获取即可，这样效率是最高的。 对于MyISAM存储引擎来说，当一个select语句没有where条件时，获取总行数效率是极高的，不需要统计，因为MyISAM存储引擎维护了一个单独的总行数。 update优化 当存储引擎是InnoDB时，表的行级锁是针对索引添加的锁，如果索引失效了，或者不是索引列时，会提升为表级锁。\n什么是行级锁？A事务和B事务，开启A事务后，通过A事务修改表中某条记录，修改后，在A事务未提交的前提下，B事务去修改同一条记录时，无法继续，直到A事务提交，B事务才可以继续。\n有一张表：t_fruit\n1 2 3 4 5 6 7 8 create table t_fruit( id int primary key auto_increment, name varchar(255) ); insert into t_fruit values(null, '苹果'); insert into t_fruit values(null, '香蕉'); insert into t_fruit values(null, '橘子'); 开启A事务和B事务，演示行级锁：\n事务A没有结束之前，事务B卡住：\n事务A结束之后，事务B继续执行：\n当然，如果更新的不是同一行数据，事务A和事务B可以并发：\n行级锁是对索引列加锁，以上更新语句的where条件是id，id是主键，当然有索引，所以使用了行级锁，如果索引失效，或者字段上没有索引，则会升级为表级锁：\n因此，为了更新的效率，建议update语句中where条件中的字段是添加索引的。\n",
  "wordCount" : "8815",
  "inLanguage": "en",
  "datePublished": "2025-05-25T18:13:06Z",
  "dateModified": "2025-05-25T18:13:06Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://009965.xyz/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://009965.xyz/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://009965.xyz/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://009965.xyz/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://009965.xyz/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://009965.xyz/">Home</a>&nbsp;»&nbsp;<a href="https://009965.xyz/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      第10章 MySQL优化
    </h1>
    <div class="post-meta"><span title='2025-05-25 18:13:06 +0000 UTC'>2025-05-25</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#mysql%e4%bc%98%e5%8c%96%e6%89%8b%e6%ae%b5" aria-label="MySQL优化手段">MySQL优化手段</a></li>
                <li>
                    <a href="#sql%e6%80%a7%e8%83%bd%e5%88%86%e6%9e%90%e5%b7%a5%e5%85%b7" aria-label="SQL性能分析工具">SQL性能分析工具</a><ul>
                        
                <li>
                    <a href="#%e6%9f%a5%e7%9c%8b%e6%95%b0%e6%8d%ae%e5%ba%93%e6%95%b4%e4%bd%93%e6%83%85%e5%86%b5" aria-label="查看数据库整体情况">查看数据库整体情况</a></li>
                <li>
                    <a href="#%e6%85%a2%e6%9f%a5%e8%af%a2%e6%97%a5%e5%bf%97" aria-label="慢查询日志">慢查询日志</a></li>
                <li>
                    <a href="#show-profiles" aria-label="show profiles">show profiles</a></li>
                <li>
                    <a href="#explain" aria-label="explain">explain</a><ul>
                        
                <li>
                    <a href="#id" aria-label="id">id</a></li>
                <li>
                    <a href="#select_type" aria-label="select_type">select_type</a></li>
                <li>
                    <a href="#table" aria-label="table">table</a></li>
                <li>
                    <a href="#type" aria-label="type">type</a></li>
                <li>
                    <a href="#possible_keys" aria-label="possible_keys">possible_keys</a></li>
                <li>
                    <a href="#key" aria-label="key">key</a></li>
                <li>
                    <a href="#key_len" aria-label="key_len">key_len</a></li>
                <li>
                    <a href="#rows" aria-label="rows">rows</a></li>
                <li>
                    <a href="#extra" aria-label="Extra">Extra</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e7%b4%a2%e5%bc%95%e4%bc%98%e5%8c%96" aria-label="索引优化">索引优化</a><ul>
                        
                <li>
                    <a href="#%e5%8a%a0%e7%b4%a2%e5%bc%95-vs-%e4%b8%8d%e5%8a%a0%e7%b4%a2%e5%bc%95" aria-label="加索引 vs 不加索引">加索引 vs 不加索引</a></li>
                <li>
                    <a href="#%e6%9c%80%e5%b7%a6%e5%89%8d%e7%bc%80%e5%8e%9f%e5%88%99" aria-label="最左前缀原则">最左前缀原则</a></li>
                <li>
                    <a href="#%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88%e6%83%85%e5%86%b5" aria-label="索引失效情况">索引失效情况</a><ul>
                        
                <li>
                    <a href="#%e7%b4%a2%e5%bc%95%e5%88%97%e5%8f%82%e5%8a%a0%e4%ba%86%e8%bf%90%e7%ae%97%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88" aria-label="索引列参加了运算，索引失效">索引列参加了运算，索引失效</a></li>
                <li>
                    <a href="#%e7%b4%a2%e5%bc%95%e5%88%97%e8%bf%9b%e8%a1%8c%e6%a8%a1%e7%b3%8a%e6%9f%a5%e8%af%a2%e6%97%b6%e4%bb%a5--%e5%bc%80%e5%a7%8b%e7%9a%84%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88" aria-label="索引列进行模糊查询时以 % 开始的，索引失效">索引列进行模糊查询时以 % 开始的，索引失效</a></li>
                <li>
                    <a href="#%e7%b4%a2%e5%bc%95%e5%88%97%e6%98%af%e5%ad%97%e7%ac%a6%e4%b8%b2%e7%b1%bb%e5%9e%8b%e4%bd%86%e6%9f%a5%e8%af%a2%e6%97%b6%e7%9c%81%e7%95%a5%e4%ba%86%e5%8d%95%e5%bc%95%e5%8f%b7%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88" aria-label="索引列是字符串类型，但查询时省略了单引号，索引失效">索引列是字符串类型，但查询时省略了单引号，索引失效</a></li>
                <li>
                    <a href="#%e6%9f%a5%e8%af%a2%e6%9d%a1%e4%bb%b6%e4%b8%ad%e6%9c%89or%e5%8f%aa%e8%a6%81%e6%9c%89%e6%9c%aa%e6%b7%bb%e5%8a%a0%e7%b4%a2%e5%bc%95%e7%9a%84%e5%ad%97%e6%ae%b5%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88" aria-label="查询条件中有or，只要有未添加索引的字段，索引失效">查询条件中有or，只要有未添加索引的字段，索引失效</a></li>
                <li>
                    <a href="#%e5%bd%93%e6%9f%a5%e8%af%a2%e7%9a%84%e7%ac%a6%e5%90%88%e6%9d%a1%e4%bb%b6%e7%9a%84%e8%ae%b0%e5%bd%95%e5%9c%a8%e8%a1%a8%e4%b8%ad%e5%8d%a0%e6%af%94%e8%be%83%e5%a4%a7%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88" aria-label="当查询的符合条件的记录在表中占比较大，索引失效">当查询的符合条件的记录在表中占比较大，索引失效</a></li>
                <li>
                    <a href="#%e5%85%b3%e4%ba%8eis-null%e5%92%8cis-not-null%e7%9a%84%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88%e9%97%ae%e9%a2%98" aria-label="关于is null和is not null的索引失效问题">关于is null和is not null的索引失效问题</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%8c%87%e5%ae%9a%e7%b4%a2%e5%bc%95" aria-label="指定索引">指定索引</a></li>
                <li>
                    <a href="#%e8%a6%86%e7%9b%96%e7%b4%a2%e5%bc%95" aria-label="覆盖索引">覆盖索引</a></li>
                <li>
                    <a href="#%e5%89%8d%e7%bc%80%e7%b4%a2%e5%bc%95" aria-label="前缀索引">前缀索引</a></li>
                <li>
                    <a href="#%e5%8d%95%e5%88%97%e7%b4%a2%e5%bc%95%e5%92%8c%e5%a4%8d%e5%90%88%e7%b4%a2%e5%bc%95%e6%80%8e%e4%b9%88%e9%80%89%e6%8b%a9" aria-label="单列索引和复合索引怎么选择">单列索引和复合索引怎么选择</a></li>
                <li>
                    <a href="#%e7%b4%a2%e5%bc%95%e5%88%9b%e5%bb%ba%e5%8e%9f%e5%88%99" aria-label="索引创建原则">索引创建原则</a></li></ul>
                </li>
                <li>
                    <a href="#sql%e4%bc%98%e5%8c%96" aria-label="SQL优化">SQL优化</a><ul>
                        
                <li>
                    <a href="#order-by%e7%9a%84%e4%bc%98%e5%8c%96" aria-label="order by的优化">order by的优化</a></li>
                <li>
                    <a href="#group-by%e4%bc%98%e5%8c%96" aria-label="group by优化">group by优化</a></li>
                <li>
                    <a href="#limit%e4%bc%98%e5%8c%96" aria-label="limit优化">limit优化</a></li>
                <li>
                    <a href="#%e4%b8%bb%e9%94%ae%e4%bc%98%e5%8c%96" aria-label="主键优化">主键优化</a></li>
                <li>
                    <a href="#insert%e4%bc%98%e5%8c%96" aria-label="insert优化">insert优化</a></li>
                <li>
                    <a href="#count%e4%bc%98%e5%8c%96" aria-label="count(*)优化">count(*)优化</a></li>
                <li>
                    <a href="#update%e4%bc%98%e5%8c%96" aria-label="update优化">update优化</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="mysql优化手段">MySQL优化手段<a hidden class="anchor" aria-hidden="true" href="#mysql优化手段">#</a></h1>
<p>MySQL数据库的优化手段通常包括但不限于：</p>
<ul>
<li>SQL查询优化：这是最低成本的优化手段，通过优化查询语句、适当添加索引等方式进行。并且效果显著。</li>
<li>库表结构优化：通过规范化设计、优化索引和数据类型等方式进行库表结构优化，需要对数据库结构进行调整和改进</li>
<li>系统配置优化：根据硬件和操作系统的特点，调整最大连接数、内存管理、IO调度等参数</li>
<li>硬件优化：升级硬盘、增加内存容量、升级处理器等硬件方面的投入，需要购买和替换硬件设备，成本较高</li>
</ul>
<p>我们主要掌握：SQL查询优化</p>
<h1 id="sql性能分析工具">SQL性能分析工具<a hidden class="anchor" aria-hidden="true" href="#sql性能分析工具">#</a></h1>
<h2 id="查看数据库整体情况">查看数据库整体情况<a hidden class="anchor" aria-hidden="true" href="#查看数据库整体情况">#</a></h2>
<p>通过以下命令可以查看当前数据库在SQL语句执行方面的整体情况：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">show</span> <span style="color:#fff;font-weight:bold">global</span> status <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;Com_select&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">show</span> <span style="color:#fff;font-weight:bold">global</span> status <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;Com_insert&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">show</span> <span style="color:#fff;font-weight:bold">global</span> status <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;Com_delete&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">show</span> <span style="color:#fff;font-weight:bold">global</span> status <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;Com_update&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">show</span> <span style="color:#fff;font-weight:bold">global</span> status <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;Com_______&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>这些结果反映了从 MySQL 服务器启动到当前时刻，所有的 SELECT 查询总数。对于 MySQL 性能优化来说，通过查看 <code>Com_select</code> 的值可以了解 SELECT 查询在整个 MySQL 服务期间所占比例的情况：</p>
<ul>
<li>如果 <code>Com_select</code> 次数过高，可能说明查询表中的每条记录都会返回过多的字段。</li>
<li>如果 <code>Com_select</code> 次数很少，同时insert或delete或update的次数很高，可能说明服务器运行的应用程序过于依赖写入操作和少量读取操作。</li>
</ul>
<p>总之，通过查看 <code>Com_select</code> 的值，可以了解 MySQL 服务器的长期执行情况，并在优化查询性能时，帮助我们了解 MySQL 的性能瓶颈。</p>
<h2 id="慢查询日志">慢查询日志<a hidden class="anchor" aria-hidden="true" href="#慢查询日志">#</a></h2>
<p>慢查询日志文件可以将查询较慢的DQL语句记录下来，便于我们定位需要调优的select语句。<br>
通过以下命令查看慢查询日志功能是否开启：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">show</span> variables <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;slow_query_log&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/202652acc839fe5f862ca4abd4cc27fd_MD5.png"><br>
慢查询日志功能默认是关闭的。请修改my.ini文件来开启慢查询日志功能，在my.ini的[mysqld]后面添加如下配置：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/46e97532666bc73858a70a642cace1d3_MD5.png"><br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/4a8d842dbe7406388496f95f16f3d9c8_MD5.png"><br>
注意：slow_query_log=1表示开启慢查询日志功能，long_query_time=3表示：只要SELECT语句的执行耗时超过3秒则将其记录到慢查询日志中。<br>
重启mysql服务。再次查看是否开启慢查询日志功能：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/5228e6a2f7ec348c102f1ea9d4d4e101_MD5.png"><br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/e22921cd851a4570bce58dd0a7075118_MD5.png"></p>
<p>尝试执行一条时长超过3秒的select语句：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> empno,ename,sleep(<span style="color:#ff0;font-weight:bold">4</span>) <span style="color:#fff;font-weight:bold">from</span> emp <span style="color:#fff;font-weight:bold">where</span> ename=<span style="color:#0ff;font-weight:bold">&#39;smith&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>慢查询日志文件默认存储在：C:\dev\mysql-8.0.36-winx64\data 目录下，默认的名字是：计算机名-slow.log<br>
通过该文件可以清晰的看到哪些DQL语句属于慢查询：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/e386a198cf3335771953386658eec74d_MD5.png"></p>
<h2 id="show-profiles">show profiles<a hidden class="anchor" aria-hidden="true" href="#show-profiles">#</a></h2>
<p>通过show profiles可以查看一个SQL语句在执行过程中具体的耗时情况。帮助我们更好的定位问题所在。</p>
<p>查看当前数据库是否支持 profile操作：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> @@have_profiling;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/7f9eb564a453b8c9918eeb28d916c521_MD5.png"></p>
<p>查看 profiling 开关是否打开：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> @@profiling;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/5dc08adb43666216f136ca7d35ab5644_MD5.png"></p>
<p>将 profiling 开关打开：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">set</span> profiling = <span style="color:#ff0;font-weight:bold">1</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/a5e410ff9cc5eecacf5692f750aa0ac6_MD5.png"></p>
<p>可以执行多条DQL语句，然后使用 show profiles; 来查看当前数据库中执行过的每个SELECT语句的耗时情况。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> empno,ename <span style="color:#fff;font-weight:bold">from</span> emp;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> empno,ename <span style="color:#fff;font-weight:bold">from</span> emp <span style="color:#fff;font-weight:bold">where</span> empno=<span style="color:#ff0;font-weight:bold">7369</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> <span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">from</span> emp;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">show</span> profiles;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/6dec15d3939ab66252665108bdf380bd_MD5.png"></p>
<p>查看某个SQL语句语句在执行过程中，每个阶段的耗时情况：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">show</span> profile <span style="color:#fff;font-weight:bold">for</span> query <span style="color:#ff0;font-weight:bold">4</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/4c94eb1bd5859942126596547ab46ab8_MD5.png"></p>
<p>想查看执行过程中cpu的情况，可以执行以下命令：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">show</span> profile cpu <span style="color:#fff;font-weight:bold">for</span> query <span style="color:#ff0;font-weight:bold">4</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/8d1a31a560c189f25d54081c28f850d9_MD5.png"></p>
<h2 id="explain">explain<a hidden class="anchor" aria-hidden="true" href="#explain">#</a></h2>
<p>explain命令可以查看一个DQL语句的执行计划，根据执行计划可以做出相应的优化措施。提高执行效率。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp <span style="color:#fff;font-weight:bold">where</span> empno=<span style="color:#ff0;font-weight:bold">7369</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/2ca8d9483e501fc65c23589de51097e3_MD5.png"></p>
<h3 id="id">id<a hidden class="anchor" aria-hidden="true" href="#id">#</a></h3>
<p>id反映出一条select语句执行顺序，id越大优先级越高。id相同则按照自上而下的顺序执行。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> e.ename,d.dname <span style="color:#fff;font-weight:bold">from</span> emp e <span style="color:#fff;font-weight:bold">join</span> dept d <span style="color:#fff;font-weight:bold">on</span> e.deptno=d.deptno <span style="color:#fff;font-weight:bold">join</span> salgrade s <span style="color:#fff;font-weight:bold">on</span> e.sal <span style="color:#fff;font-weight:bold">between</span> s.losal <span style="color:#fff;font-weight:bold">and</span> s.hisal;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/047349a88bb412a0224232988a28d95a_MD5.png"><br>
由于id相同，反映出三张表在执行顺序上属于平等关系，执行时采用，先d，再e，最后s。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> e.ename,d.dname <span style="color:#fff;font-weight:bold">from</span> emp e <span style="color:#fff;font-weight:bold">join</span> dept d <span style="color:#fff;font-weight:bold">on</span> e.deptno=d.deptno <span style="color:#fff;font-weight:bold">where</span> e.sal=(<span style="color:#fff;font-weight:bold">select</span> sal <span style="color:#fff;font-weight:bold">from</span> emp <span style="color:#fff;font-weight:bold">where</span> ename=<span style="color:#0ff;font-weight:bold">&#39;ford&#39;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/0addcee774e86f64647f046fb696a19d_MD5.png"><br>
反映出，先执行子查询，然后让e和d做表连接。</p>
<h3 id="select_type">select_type<a hidden class="anchor" aria-hidden="true" href="#select_type">#</a></h3>
<p>反映了mysql查询语句的类型。常用值包括：</p>
<ul>
<li>SIMPLE：表示查询中不包含子查询或UNION操作。这种查询通常包括一个表或是最多一个联接（JOIN）</li>
<li>PRIMARY：表示当前查询是一个主查询。（主要的查询）</li>
<li>UNION：表示查询中包含UNION操作</li>
<li>SUBQUERY：子查询</li>
<li>DERIVED：派生表（表示查询语句出现在from后面）</li>
</ul>
<h3 id="table">table<a hidden class="anchor" aria-hidden="true" href="#table">#</a></h3>
<p>反映了这个查询操作的是哪个表。</p>
<h3 id="type">type<a hidden class="anchor" aria-hidden="true" href="#type">#</a></h3>
<p>反映了查询表中数据时的访问类型，常见的值：</p>
<ol>
<li>NULL：效率最高，一般不可能优化到这个级别，只有查询时没有查询表的时候，访问类型是NULL。例如：select 1;</li>
<li>system：通常访问系统表的时候，访问类型是system。一般也很难优化到这个程序。</li>
<li>const：根据主键或者唯一性索引查询，索引值是常量值时。explain select * from emp where empno=7369;</li>
<li>eq_ref：根据主键或者唯一性索引查询。索引值不是常量值。</li>
<li>ref：使用了非唯一的索引进行查询。</li>
<li>range：使用了索引，扫描了索引树的一部分。</li>
<li>index：表示用了索引，但是也需要遍历整个索引树。</li>
<li>all：全表扫描</li>
</ol>
<p>效率最高的是NULL，效率最低的是all，从上到下，从高到低。</p>
<h3 id="possible_keys">possible_keys<a hidden class="anchor" aria-hidden="true" href="#possible_keys">#</a></h3>
<p>这个查询可能会用到的索引</p>
<h3 id="key">key<a hidden class="anchor" aria-hidden="true" href="#key">#</a></h3>
<p>实际用到的索引</p>
<h3 id="key_len">key_len<a hidden class="anchor" aria-hidden="true" href="#key_len">#</a></h3>
<p>反映索引中在查询中使用的列所占的总字节数。</p>
<h3 id="rows">rows<a hidden class="anchor" aria-hidden="true" href="#rows">#</a></h3>
<p>查询扫描的预估计行数。</p>
<h3 id="extra">Extra<a hidden class="anchor" aria-hidden="true" href="#extra">#</a></h3>
<p>给出了与查询相关的额外信息和说明。这些额外信息可以帮助我们更好地理解查询执行的过程。</p>
<h1 id="索引优化">索引优化<a hidden class="anchor" aria-hidden="true" href="#索引优化">#</a></h1>
<h2 id="加索引-vs-不加索引">加索引 vs 不加索引<a hidden class="anchor" aria-hidden="true" href="#加索引-vs-不加索引">#</a></h2>
<p>将这个sql脚本初始化到数据库中（初始化100W条记录）：t_vip.sql<br>
根据id查询（id是主键，有索引）：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_vip <span style="color:#fff;font-weight:bold">where</span> id = <span style="color:#ff0;font-weight:bold">900000</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据name查询（name上没有索引）：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_vip <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;4c6494cb&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>给name字段添加索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_t_user_name <span style="color:#fff;font-weight:bold">on</span> t_vip(name);
</span></span></code></pre></td></tr></table>
</div>
</div><p>再次根据name查询（此时name上已经有索引了） ：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_vip <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;4c6494cb&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="最左前缀原则">最左前缀原则<a hidden class="anchor" aria-hidden="true" href="#最左前缀原则">#</a></h2>
<p>假设有这样一张表：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> t_customer(
</span></span><span style="display:flex;"><span>	id <span style="color:#fff;font-weight:bold">int</span> <span style="color:#fff;font-weight:bold">primary</span> <span style="color:#fff;font-weight:bold">key</span> auto_increment,
</span></span><span style="display:flex;"><span>	name <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">255</span>),
</span></span><span style="display:flex;"><span>	age <span style="color:#fff;font-weight:bold">int</span>,
</span></span><span style="display:flex;"><span>	gender <span style="color:#fff;font-weight:bold">char</span>(<span style="color:#ff0;font-weight:bold">1</span>),
</span></span><span style="display:flex;"><span>	email <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">255</span>)
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>添加了这些数据：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_customer <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span>, <span style="color:#ff0;font-weight:bold">20</span>, <span style="color:#0ff;font-weight:bold">&#39;M&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;zhangsan@123.com&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_customer <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;lisi&#39;</span>, <span style="color:#ff0;font-weight:bold">22</span>, <span style="color:#0ff;font-weight:bold">&#39;M&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;lisi@123.com&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_customer <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;wangwu&#39;</span>, <span style="color:#ff0;font-weight:bold">18</span>, <span style="color:#0ff;font-weight:bold">&#39;F&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;wangwu@123.com&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_customer <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;zhaoliu&#39;</span>, <span style="color:#ff0;font-weight:bold">22</span>, <span style="color:#0ff;font-weight:bold">&#39;F&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;zhaoliu@123.com&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_customer <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;jack&#39;</span>, <span style="color:#ff0;font-weight:bold">30</span>, <span style="color:#0ff;font-weight:bold">&#39;M&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;jack@123.com&#39;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>添加了这样的复合索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_name_age_gender <span style="color:#fff;font-weight:bold">on</span> t_customer(name,age,gender);
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>最左前缀原则：当查询语句条件中包含了这个复合索引最左边的列 name 时，此时索引才会起作用。</strong></p>
<p>验证1：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span> <span style="color:#fff;font-weight:bold">and</span> age=<span style="color:#ff0;font-weight:bold">20</span> <span style="color:#fff;font-weight:bold">and</span> gender=<span style="color:#0ff;font-weight:bold">&#39;M&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：完全使用了索引<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/760cbd25f3fb8fb8bbaf1c146fa58606_MD5.png"></p>
<p>验证2：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span> <span style="color:#fff;font-weight:bold">and</span> age=<span style="color:#ff0;font-weight:bold">20</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：使用了部分索引<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/6e00d16c492f682d95825c4815357dbb_MD5.png"></p>
<p>验证3：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：使用了部分索引<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/8303a6264f7467dc8efdf08d75b82e81_MD5.png"></p>
<p>验证4：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">where</span> age=<span style="color:#ff0;font-weight:bold">20</span> <span style="color:#fff;font-weight:bold">and</span> gender=<span style="color:#0ff;font-weight:bold">&#39;M&#39;</span> <span style="color:#fff;font-weight:bold">and</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：完全使用了索引<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/ccda247a243f4d07bbc4a76ab666b793_MD5.png"></p>
<p>验证5：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">where</span> gender=<span style="color:#0ff;font-weight:bold">&#39;M&#39;</span> <span style="color:#fff;font-weight:bold">and</span> age=<span style="color:#ff0;font-weight:bold">20</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：没有使用任何索引<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/7df3b6ef75102932d8d43756cfe4df9b_MD5.png"></p>
<p>验证6：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span> <span style="color:#fff;font-weight:bold">and</span> gender=<span style="color:#0ff;font-weight:bold">&#39;M&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：使用了部分索引<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/107ce4ecfa7d9e908198c78073bc1de1_MD5.png"></p>
<p>验证7：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span> <span style="color:#fff;font-weight:bold">and</span> gender=<span style="color:#0ff;font-weight:bold">&#39;M&#39;</span> <span style="color:#fff;font-weight:bold">and</span> age=<span style="color:#ff0;font-weight:bold">20</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：完全使用了索引<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/4e7430c8d629f7c016a04db9ca064371_MD5.png"></p>
<p><strong>范围查询时，在“范围条件”右侧的列索引会失效：</strong><br>
验证：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span> <span style="color:#fff;font-weight:bold">and</span> age&gt;<span style="color:#ff0;font-weight:bold">20</span> <span style="color:#fff;font-weight:bold">and</span> gender=<span style="color:#0ff;font-weight:bold">&#39;M&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：name和age列索引生效。gender列索引无效。<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/269e75ee094de37529971cbfaf6d1a36_MD5.png"><br>
怎么解决？建议范围查找时带上“=”</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span> <span style="color:#fff;font-weight:bold">and</span> age&gt;=<span style="color:#ff0;font-weight:bold">20</span> <span style="color:#fff;font-weight:bold">and</span> gender=<span style="color:#0ff;font-weight:bold">&#39;M&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/cbace70f2d34ef40873d17ce814de3a9_MD5.png"></p>
<h2 id="索引失效情况">索引失效情况<a hidden class="anchor" aria-hidden="true" href="#索引失效情况">#</a></h2>
<p>有这样一张表：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> t_emp(
</span></span><span style="display:flex;"><span>  id <span style="color:#fff;font-weight:bold">int</span> <span style="color:#fff;font-weight:bold">primary</span> <span style="color:#fff;font-weight:bold">key</span> auto_increment,
</span></span><span style="display:flex;"><span>  name <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">255</span>),
</span></span><span style="display:flex;"><span>  sal <span style="color:#fff;font-weight:bold">int</span>,
</span></span><span style="display:flex;"><span>  age <span style="color:#fff;font-weight:bold">char</span>(<span style="color:#ff0;font-weight:bold">2</span>)
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>有这样一些数据：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_emp <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;张三&#39;</span>, <span style="color:#ff0;font-weight:bold">5000</span>,<span style="color:#0ff;font-weight:bold">&#39;20&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_emp <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;张飞&#39;</span>, <span style="color:#ff0;font-weight:bold">4000</span>,<span style="color:#0ff;font-weight:bold">&#39;30&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_emp <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;李飞&#39;</span>, <span style="color:#ff0;font-weight:bold">6000</span>,<span style="color:#0ff;font-weight:bold">&#39;40&#39;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>有这样一些索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_t_emp_name <span style="color:#fff;font-weight:bold">on</span> t_emp(name);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_t_emp_sal <span style="color:#fff;font-weight:bold">on</span> t_emp(sal);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_t_emp_age <span style="color:#fff;font-weight:bold">on</span> t_emp(age);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="索引列参加了运算索引失效">索引列参加了运算，索引失效<a hidden class="anchor" aria-hidden="true" href="#索引列参加了运算索引失效">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_emp <span style="color:#fff;font-weight:bold">where</span> sal &gt; <span style="color:#ff0;font-weight:bold">5000</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：使用了索引<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/332e1f99c7d212344f76a98cdcd223b1_MD5.png"></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_emp <span style="color:#fff;font-weight:bold">where</span> sal*<span style="color:#ff0;font-weight:bold">10</span> &gt; <span style="color:#ff0;font-weight:bold">50000</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：索引失效<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/c0cd07d1ae0d3dac932f31121d009ad3_MD5.png"></p>
<h3 id="索引列进行模糊查询时以--开始的索引失效">索引列进行模糊查询时以 % 开始的，索引失效<a hidden class="anchor" aria-hidden="true" href="#索引列进行模糊查询时以--开始的索引失效">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_emp <span style="color:#fff;font-weight:bold">where</span> name <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;张%&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：索引有效<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/8c3e88dd1a5a93a06e9fbfe827787137_MD5.png"></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_emp <span style="color:#fff;font-weight:bold">where</span> name <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;%飞&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：索引失效<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/982d53778a5768eb44b5d659b6b2314c_MD5.png"></p>
<h3 id="索引列是字符串类型但查询时省略了单引号索引失效">索引列是字符串类型，但查询时省略了单引号，索引失效<a hidden class="anchor" aria-hidden="true" href="#索引列是字符串类型但查询时省略了单引号索引失效">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_emp <span style="color:#fff;font-weight:bold">where</span> age=<span style="color:#0ff;font-weight:bold">&#39;20&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：索引有效<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/3a5a0632e75b0b287250364564226a12_MD5.png"></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_emp <span style="color:#fff;font-weight:bold">where</span> age=<span style="color:#ff0;font-weight:bold">20</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：索引失效<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/e24b11e25b2d90e67f0cc3b7163ea346_MD5.png"></p>
<h3 id="查询条件中有or只要有未添加索引的字段索引失效">查询条件中有or，只要有未添加索引的字段，索引失效<a hidden class="anchor" aria-hidden="true" href="#查询条件中有or只要有未添加索引的字段索引失效">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_emp <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;张三&#39;</span> <span style="color:#fff;font-weight:bold">or</span> sal=<span style="color:#ff0;font-weight:bold">5000</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：使用了索引<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/c0935167dc045103e6a404607db04324_MD5.png"></p>
<p>将t_emp表sal字段上的索引删除：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">alter</span> <span style="color:#fff;font-weight:bold">table</span> t_emp <span style="color:#fff;font-weight:bold">drop</span> <span style="color:#fff;font-weight:bold">index</span> idx_t_emp_sal;
</span></span></code></pre></td></tr></table>
</div>
</div><p>再次验证：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_emp <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;张三&#39;</span> <span style="color:#fff;font-weight:bold">or</span> sal=<span style="color:#ff0;font-weight:bold">5000</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：索引失效<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/961f2c8fd85c9d588706076508a4f427_MD5.png"></p>
<h3 id="当查询的符合条件的记录在表中占比较大索引失效">当查询的符合条件的记录在表中占比较大，索引失效<a hidden class="anchor" aria-hidden="true" href="#当查询的符合条件的记录在表中占比较大索引失效">#</a></h3>
<p>复制一张新表：emp2</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> emp2 <span style="color:#fff;font-weight:bold">as</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp;
</span></span></code></pre></td></tr></table>
</div>
</div><p>给sal添加索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">alter</span> <span style="color:#fff;font-weight:bold">table</span> emp2 <span style="color:#fff;font-weight:bold">add</span> <span style="color:#fff;font-weight:bold">index</span> idx_emp2_sal(sal);
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证1：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp2 <span style="color:#fff;font-weight:bold">where</span> sal &gt; <span style="color:#ff0;font-weight:bold">800</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>不走索引：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/bc5847c50620ec19974cddb61c5baa8b_MD5.png"></p>
<p>验证2：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp2 <span style="color:#fff;font-weight:bold">where</span> sal &gt; <span style="color:#ff0;font-weight:bold">1000</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>不走索引：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/bc5847c50620ec19974cddb61c5baa8b_MD5.png"></p>
<p>验证3：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp2 <span style="color:#fff;font-weight:bold">where</span> sal &gt; <span style="color:#ff0;font-weight:bold">2000</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>走索引：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/cb265825c828a453d5b54537dd720c69_MD5.png"></p>
<h3 id="关于is-null和is-not-null的索引失效问题">关于is null和is not null的索引失效问题<a hidden class="anchor" aria-hidden="true" href="#关于is-null和is-not-null的索引失效问题">#</a></h3>
<p>给emp2的comm字段添加一个索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_emp2_comm <span style="color:#fff;font-weight:bold">on</span> emp2(comm);
</span></span></code></pre></td></tr></table>
</div>
</div><p>将emp2表的comm字段值全部更新为NULL：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">update</span> emp2 <span style="color:#fff;font-weight:bold">set</span> comm=<span style="color:#fff;font-weight:bold">null</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证此时条件使用is null是否走索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp2 <span style="color:#fff;font-weight:bold">where</span> comm <span style="color:#fff;font-weight:bold">is</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：不走索引。<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/b5aece84951ff34f3acb9528eb8af4e1_MD5.png"><br>
验证此时条件使用is not null是否走索引：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/e206ff6c91511b75d1d310febb422b68_MD5.png"></p>
<p>将emp2表的comm字段全部更新为非NULL：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">update</span> emp2 <span style="color:#fff;font-weight:bold">set</span> comm=<span style="color:#ff0;font-weight:bold">100</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证此时条件使用is null是否走索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp2 <span style="color:#fff;font-weight:bold">where</span> comm <span style="color:#fff;font-weight:bold">is</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：走索引<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/db0c5ddb8dfbfe1d0545d8bc557f9d59_MD5.png"><br>
验证此时条件使用is not null是否走索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp2 <span style="color:#fff;font-weight:bold">where</span> comm <span style="color:#fff;font-weight:bold">is</span> <span style="color:#fff;font-weight:bold">not</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证结果：不走索引<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/279b4c3c4ff32bb90c00458e24c89958_MD5.png"></p>
<p>结论：走索引还是不走索引，根数据分布有很大关系，如果符合条件的记录占比较大，会考虑使用全表扫描，而放弃走索引。</p>
<h2 id="指定索引">指定索引<a hidden class="anchor" aria-hidden="true" href="#指定索引">#</a></h2>
<p>当一个字段上既有单列索引，又有复合索引时，我们可以通过以下的SQL提示来要求该SQL语句执行时采用哪个索引：</p>
<ul>
<li>use index(索引名称)：建议使用该索引，只是建议，底层mysql会根据实际效率来考虑是否使用你推荐的索引。</li>
<li>ignore index(索引名称)：忽略该索引</li>
<li>force index(索引名称)：强行使用该索引</li>
</ul>
<p>查看 t_customer 表上的索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">show</span> <span style="color:#fff;font-weight:bold">index</span> <span style="color:#fff;font-weight:bold">from</span> t_customer;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/97c374011b5bec8b9b2e976b08ba95df_MD5.png"><br>
可以看到name age gender三列添加了一个复合索引。<br>
现在给name字段添加一个单列索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_name <span style="color:#fff;font-weight:bold">on</span> t_customer(name);
</span></span></code></pre></td></tr></table>
</div>
</div><p>看看以下的语句默认使用了哪个索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/9cec60ce14d34445c0042f1c60df6076_MD5.png"><br>
通过测试得知，默认使用了联合索引。</p>
<p>如何建议使用单列索引idx_name：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer use <span style="color:#fff;font-weight:bold">index</span>(idx_name) <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/7f2fb7977d08b1683d678289246a8415_MD5.png"></p>
<p>如何忽略使用符合索引 idx_name_age_gender：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">ignore</span> <span style="color:#fff;font-weight:bold">index</span>(idx_name_age_gender) <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/e0d13c5f6c7b4b63a5a795731f0fe887_MD5.png"></p>
<p>如何强行使用单列索引idx_name：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> t_customer <span style="color:#fff;font-weight:bold">force</span> <span style="color:#fff;font-weight:bold">index</span>(idx_name) <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;zhangsan&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/2c08c881a17aed65a271a7c7394ccf31_MD5.png"></p>
<h2 id="覆盖索引">覆盖索引<a hidden class="anchor" aria-hidden="true" href="#覆盖索引">#</a></h2>
<p>覆盖索引我们在讲解索引的时候已经提到过了，覆盖索引强调的是：在select后面写字段的时候，这些字段尽可能是索引所覆盖的字段，这样可以避免回表查询。尽可能避免使用 select *，因为select * 很容易导致回表查询。（本质就是：能在索引上检索的，就不要再次回表查询了。）</p>
<p>例如：有一张表 emp3，其中 ename,job添加了联合索引：idx_emp3_ename_job，以下这个select语句就不会回表：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">drop</span> <span style="color:#fff;font-weight:bold">table</span> <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">exists</span> emp3;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> emp3 <span style="color:#fff;font-weight:bold">as</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">alter</span> <span style="color:#fff;font-weight:bold">table</span> emp3 <span style="color:#fff;font-weight:bold">add</span> <span style="color:#fff;font-weight:bold">constraint</span> emp3_pk <span style="color:#fff;font-weight:bold">primary</span> <span style="color:#fff;font-weight:bold">key</span>(empno);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_emp3_ename_job <span style="color:#fff;font-weight:bold">on</span> emp3(ename,job);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> empno,ename,job <span style="color:#fff;font-weight:bold">from</span> emp3 <span style="color:#fff;font-weight:bold">where</span> ename=<span style="color:#0ff;font-weight:bold">&#39;KING&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/0d1022ae0001404c32e00ca867691daf_MD5.png"><br>
如果查询语句要查找的列没有在索引中，则会回表查询，例如：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> empno,ename,job,sal <span style="color:#fff;font-weight:bold">from</span> emp3 <span style="color:#fff;font-weight:bold">where</span> ename=<span style="color:#0ff;font-weight:bold">&#39;KING&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/c3de97bc202760c061eb7fc0f1561e1c_MD5.png"><br>
面试题：t_user表字段如下：id,name,password,realname,birth,email。表中数据量500万条，请针对以下SQL语句给出优化方案：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> id,name,realname <span style="color:#fff;font-weight:bold">from</span> t_user <span style="color:#fff;font-weight:bold">where</span> name=<span style="color:#0ff;font-weight:bold">&#39;鲁智深&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果只给name添加索引，底层会进行大量的回表查询，效率较低，建议给name和realname两个字段添加联合索引，这样大大减少回表操作，提高查询效率。</p>
<h2 id="前缀索引">前缀索引<a hidden class="anchor" aria-hidden="true" href="#前缀索引">#</a></h2>
<p>如果一个字段类型是varchar或text字段，字段中存储的是文本或者大文本，直接对这种长文本创建索引，会让索引体积很大，怎么优化呢？可以将字符串的前几个字符截取下来当做索引来创建。这种索引被称为前缀索引，例如：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">drop</span> <span style="color:#fff;font-weight:bold">table</span> <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">exists</span> emp4;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> emp4 <span style="color:#fff;font-weight:bold">as</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_emp4_ename_2 <span style="color:#fff;font-weight:bold">on</span> emp4(ename(<span style="color:#ff0;font-weight:bold">2</span>));
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上SQL表示将emp4表中ename字段的前2个字符创建到索引当中。</p>
<p>使用前缀索引时，需要通过以下公式来确定使用前几个字符作为索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">distinct</span> <span style="color:#fff;font-weight:bold">substring</span>(ename,<span style="color:#ff0;font-weight:bold">1</span>,<span style="color:#f00">前几个字符</span>)) / <span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">from</span> emp4;
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上查询结果越接近1，表示索引的效果越好。（原理：做索引值的话，索引值越具有唯一性效率越高）</p>
<p>假设我们使用前1个字符作为索引值：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">distinct</span> <span style="color:#fff;font-weight:bold">substring</span>(ename,<span style="color:#ff0;font-weight:bold">1</span>,<span style="color:#ff0;font-weight:bold">1</span>)) / <span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">from</span> emp4;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/c2c8144f3afe346f59c5d19fcaa2e00f_MD5.png"></p>
<p>假设我们使用前2个字符作为索引值：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> <span style="color:#fff;font-weight:bold">count</span>(<span style="color:#fff;font-weight:bold">distinct</span> <span style="color:#fff;font-weight:bold">substring</span>(ename,<span style="color:#ff0;font-weight:bold">1</span>,<span style="color:#ff0;font-weight:bold">2</span>)) / <span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">from</span> emp4;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/1402356d8161c120ac3a2b58f2cd4aa0_MD5.png"><br>
可见使用前2个字符作为索引值，能够让索引值更具有唯一性，效率越好，因此我们选择前2个字符作为前缀索引。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_emp4_ename_2 <span style="color:#fff;font-weight:bold">on</span> emp4(ename(<span style="color:#ff0;font-weight:bold">2</span>));
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行以下的查询语句则会走这个前缀索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp4 <span style="color:#fff;font-weight:bold">where</span> ename=<span style="color:#0ff;font-weight:bold">&#39;KING&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/169d5ff8465a6be2898a4257f0634a78_MD5.png"></p>
<h2 id="单列索引和复合索引怎么选择">单列索引和复合索引怎么选择<a hidden class="anchor" aria-hidden="true" href="#单列索引和复合索引怎么选择">#</a></h2>
<p>当查询语句的条件中有多个条件，建议将这几个列创建为复合索引，因为创建单列索引很容易回表查询。<br>
例如分别给emp5表ename，job添加两个单列索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> emp5 <span style="color:#fff;font-weight:bold">as</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">alter</span> <span style="color:#fff;font-weight:bold">table</span> emp5 <span style="color:#fff;font-weight:bold">add</span> <span style="color:#fff;font-weight:bold">constraint</span> emp5_pk <span style="color:#fff;font-weight:bold">primary</span> <span style="color:#fff;font-weight:bold">key</span>(empno);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_emp5_ename <span style="color:#fff;font-weight:bold">on</span> emp5(ename);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_emp5_job <span style="color:#fff;font-weight:bold">on</span> emp5(job);
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行以下查询语句：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> empno,ename,job <span style="color:#fff;font-weight:bold">from</span> emp5 <span style="color:#fff;font-weight:bold">where</span> ename=<span style="color:#0ff;font-weight:bold">&#39;SMITH&#39;</span> <span style="color:#fff;font-weight:bold">and</span> job=<span style="color:#0ff;font-weight:bold">&#39;CLERK&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/d75bd8fdf2b479b300681cad35c71ab5_MD5.png"></p>
<p>ename和job都出现在查询条件中，可以给emp6表的ename和job创建一个复合索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> emp6 <span style="color:#fff;font-weight:bold">as</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">alter</span> <span style="color:#fff;font-weight:bold">table</span> emp6 <span style="color:#fff;font-weight:bold">add</span> <span style="color:#fff;font-weight:bold">constraint</span> emp6_pk <span style="color:#fff;font-weight:bold">primary</span> <span style="color:#fff;font-weight:bold">key</span>(empno);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_emp6_ename_job <span style="color:#fff;font-weight:bold">on</span> emp6(ename,job);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> empno,ename,job <span style="color:#fff;font-weight:bold">from</span> emp6 <span style="color:#fff;font-weight:bold">where</span> ename=<span style="color:#0ff;font-weight:bold">&#39;SMITH&#39;</span> <span style="color:#fff;font-weight:bold">and</span> job=<span style="color:#0ff;font-weight:bold">&#39;CLERK&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/a892b0c83c0dbf2a144f085b9ee75c71_MD5.png"><br>
对于以上查询语句，使用复合索引避免了回表，因此这种情况下还是建议使用复合索引。</p>
<p>注意：创建索引时应考虑最左前缀原则，主字段并且具有很强唯一性的字段建议排在第一位，例如：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_emp_ename_job <span style="color:#fff;font-weight:bold">on</span> emp(ename,job);
</span></span></code></pre></td></tr></table>
</div>
</div><p>和以下方式对比：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_emp_job_ename <span style="color:#fff;font-weight:bold">on</span> emp(job,ename);
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于ename是主字段，并且ename具有很好的唯一性，建议将ename列放在最左边。因此这两种创建复合索引的方式，建议采用第一种。</p>
<p>复合索引底层原理：<br>
<img alt="无标题.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/8e86a058cca36beb0ed0068c47a189f9_MD5.png"></p>
<h2 id="索引创建原则">索引创建原则<a hidden class="anchor" aria-hidden="true" href="#索引创建原则">#</a></h2>
<ol>
<li>表数据量庞大，通常超过百万条数据。</li>
<li>经常出现在where，order by，group by后面的字段建议添加索引。</li>
<li>创建索引的字段尽量具有很强的唯一性。</li>
<li>如果字段存储文本，内容较大，一定要创建前缀索引。</li>
<li>尽量使用复合索引，使用单列索引容易回表查询。</li>
<li>如果一个字段中的数据不会为NULL，建议建表时添加not null约束，这样优化器就知道使用哪个索引列更加有效。</li>
<li>不要创建太多索引，当对数据进行增删改的时候，索引需要重新重新排序。</li>
<li>如果很少的查询，经常的增删改不建议加索引。</li>
</ol>
<h1 id="sql优化">SQL优化<a hidden class="anchor" aria-hidden="true" href="#sql优化">#</a></h1>
<h2 id="order-by的优化">order by的优化<a hidden class="anchor" aria-hidden="true" href="#order-by的优化">#</a></h2>
<p>准备数据：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">drop</span> <span style="color:#fff;font-weight:bold">table</span> <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">exists</span> workers;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> workers(
</span></span><span style="display:flex;"><span>  id <span style="color:#fff;font-weight:bold">int</span> <span style="color:#fff;font-weight:bold">primary</span> <span style="color:#fff;font-weight:bold">key</span> auto_increment,
</span></span><span style="display:flex;"><span>  name <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">255</span>),
</span></span><span style="display:flex;"><span>  age <span style="color:#fff;font-weight:bold">int</span>,
</span></span><span style="display:flex;"><span>  sal <span style="color:#fff;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> workers <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;孙悟空&#39;</span>, <span style="color:#ff0;font-weight:bold">500</span>, <span style="color:#ff0;font-weight:bold">50000</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> workers <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;猪八戒&#39;</span>, <span style="color:#ff0;font-weight:bold">300</span>, <span style="color:#ff0;font-weight:bold">40000</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> workers <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;沙和尚&#39;</span>, <span style="color:#ff0;font-weight:bold">600</span>, <span style="color:#ff0;font-weight:bold">40000</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> workers <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;白骨精&#39;</span>, <span style="color:#ff0;font-weight:bold">600</span>, <span style="color:#ff0;font-weight:bold">10000</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>explain查看一个带有order by的语句时，Extra列会显示：using index 或者 using filesort，区别是什么？</p>
<ul>
<li>using index:  表示使用索引，因为索引是提前排好序的。效率很高。</li>
<li>using filesort：表示使用文件排序，这就表示没有走索引，对表中数据进行排序，排序时将硬盘的数据读取到内存当中，在内存当中排好序。这个效率是低的，应避免。</li>
</ul>
<p>此时name没有添加索引，如果根据name进行排序的话：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> id,name <span style="color:#fff;font-weight:bold">from</span> workers <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> name;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/6bea9c3d83d07ab3d9a4ee3428d19532_MD5.png"><br>
显然这种方式效率较低。<br>
给name添加索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_workers_name <span style="color:#fff;font-weight:bold">on</span> workers(name);
</span></span></code></pre></td></tr></table>
</div>
</div><p>再根据name排序：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> id,name <span style="color:#fff;font-weight:bold">from</span> workers <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> name;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/892516945e32819c25fb5914e16a853b_MD5.png"><br>
这样效率则提升了。</p>
<p>如果要通过age和sal两个字段进行排序，最好给age和sal两个字段添加复合索引，不添加复合索引时：<br>
按照age升序排，如果age相同则按照sal升序</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> id,age,sal <span style="color:#fff;font-weight:bold">from</span> workers <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> age,sal;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/b59310c79ea36edda7834b0205cc971e_MD5.png"><br>
这样效率是低的。<br>
给age和sal添加复合索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_workers_age_sal <span style="color:#fff;font-weight:bold">on</span> workers(age, sal);
</span></span></code></pre></td></tr></table>
</div>
</div><p>再按照age升序排，如果age相同则按照sal升序：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> id,age,sal <span style="color:#fff;font-weight:bold">from</span> workers <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> age,sal;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/44fb4504caa881389f501c22ddcf8ed8_MD5.png"><br>
这样效率提升了。</p>
<p>在B+树上叶子结点上的所有数据默认是按照升序排列的，如果按照age降序，如果age相同则按照sal降序，会走索引吗？</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> id,age,sal <span style="color:#fff;font-weight:bold">from</span> workers <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> age <span style="color:#fff;font-weight:bold">desc</span>,sal <span style="color:#fff;font-weight:bold">desc</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/780d970acf8d37d836dc1c1866c9f328_MD5.png"><br>
可以看到备注信息是：反向索引扫描，使用了索引。<br>
这样效率也是很高的，因为B+树叶子结点之间采用的是双向指针。可以从左向右（升序），也可以从右向左（降序）。</p>
<p>如果一个升序，一个降序会怎样呢？</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> id,age,sal <span style="color:#fff;font-weight:bold">from</span> workers <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> age <span style="color:#fff;font-weight:bold">asc</span>, sal <span style="color:#fff;font-weight:bold">desc</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/aa1b405bd60e7ac5b013386d4c351ac1_MD5.png"><br>
可见age使用了索引，但是sal没有使用索引。怎么办呢？可以针对这种排序情况创建对应的索引来解决：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_workers_ageasc_saldesc <span style="color:#fff;font-weight:bold">on</span> workers(age <span style="color:#fff;font-weight:bold">asc</span>, sal <span style="color:#fff;font-weight:bold">desc</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建的索引如下：A表示升序，D表示降序。<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/2a9fd50049bb46ad6f91847e312f9231_MD5.png"><br>
再次执行：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> id,age,sal <span style="color:#fff;font-weight:bold">from</span> workers <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> age <span style="color:#fff;font-weight:bold">asc</span>, sal <span style="color:#fff;font-weight:bold">desc</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/27047a9d3f70333bd6d416203140b1fc_MD5.png"></p>
<p>我们再来看看，对于排序来说是否支持最左前缀法则：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> id,age,sal <span style="color:#fff;font-weight:bold">from</span> workers <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> sal;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/cf4eb0ffd0f230bbdc7a616d0eb5d3ba_MD5.png"><br>
通过测试得知，order by也遵循最左前缀法则。</p>
<p>我们再来看一下未使用覆盖索引会怎样？</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> workers <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> age,sal;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/71355752fd560fcb2725725e44fdbb96_MD5.png"><br>
通过测试得知，排序也要尽量使用覆盖索引。</p>
<p>order by 优化原则总结：</p>
<ol>
<li>排序也要遵循最左前缀法则。</li>
<li>使用覆盖索引。</li>
<li>针对不同的排序规则，创建不同索引。（如果所有字段都是升序，或者所有字段都是降序，则不需要创建新的索引）</li>
<li>如果无法避免filesort，要注意排序缓存的大小，默认缓存大小256KB，可以修改系统变量 sort_buffer_size ：</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">show</span> variables <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;sort_buffer_size&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/8582111e3407d6b7da3462c9e8dd32db_MD5.png"></p>
<h2 id="group-by优化">group by优化<a hidden class="anchor" aria-hidden="true" href="#group-by优化">#</a></h2>
<p>创建empx表：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> empx <span style="color:#fff;font-weight:bold">as</span> <span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> emp;
</span></span></code></pre></td></tr></table>
</div>
</div><p>job字段上没有索引，根据job进行分组，查看每个工作岗位有多少人：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> job,<span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">from</span> empx <span style="color:#fff;font-weight:bold">group</span> <span style="color:#fff;font-weight:bold">by</span> job;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/a5e96063d0b29cd6b5de82b4caff0ed6_MD5.png"><br>
看看是否走索引了：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> job,<span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">from</span> empx <span style="color:#fff;font-weight:bold">group</span> <span style="color:#fff;font-weight:bold">by</span> job;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/27b3b75f8982b6db8d8a52e41f193ac7_MD5.png"><br>
使用了临时表，效率较低。</p>
<p>给job添加索引：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_empx_job <span style="color:#fff;font-weight:bold">on</span> empx(job);
</span></span></code></pre></td></tr></table>
</div>
</div><p>再次执行：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> job,<span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">from</span> empx <span style="color:#fff;font-weight:bold">group</span> <span style="color:#fff;font-weight:bold">by</span> job;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/fe856e2d1d9a160cdf9ca1562c1f3f3a_MD5.png"><br>
效率提升了。</p>
<p>我们再来看看group by是否需要遵守最左前缀法则：给deptno和sal添加复合索引</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">index</span> idx_empx_deptno_sal <span style="color:#fff;font-weight:bold">on</span> empx(deptno, sal);
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据部门编号分组，查看每个部门人数：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> deptno,<span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">from</span> empx <span style="color:#fff;font-weight:bold">group</span> <span style="color:#fff;font-weight:bold">by</span> deptno;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/86996968409caf3dc79c4fdd194bbe58_MD5.png"><br>
效率很高，因为deptno是复合索引中最左边的字段。<br>
根据sal分组，查看每个工资有多少人：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> sal, <span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">from</span> empx <span style="color:#fff;font-weight:bold">group</span> <span style="color:#fff;font-weight:bold">by</span> sal;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/6a68dc907f5f9155036021f053a5418f_MD5.png"><br>
使用了临时表，效率较低。<br>
通过测试得知，group by也同样遵循最左前缀法则。</p>
<p>我们再来测试一下，如果将部门编号deptno（复合索引的最左列）添加到where条件中，效率会不会提升：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">explain</span> <span style="color:#fff;font-weight:bold">select</span> sal, <span style="color:#fff;font-weight:bold">count</span>(*) <span style="color:#fff;font-weight:bold">from</span> empx <span style="color:#fff;font-weight:bold">where</span> deptno=<span style="color:#ff0;font-weight:bold">10</span> <span style="color:#fff;font-weight:bold">group</span> <span style="color:#fff;font-weight:bold">by</span> sal;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/9b1eac9909ef007ae4a163c8dc75130a_MD5.png"><br>
效率有提升的，这说明了，group by确实也遵循最左前缀法则。（where中使用了最左列）</p>
<h2 id="limit优化">limit优化<a hidden class="anchor" aria-hidden="true" href="#limit优化">#</a></h2>
<p>数据量特别庞大时，取数据时，越往后效率越低，怎么提升？mysql官方给出的解决方案是：使用覆盖索引+子查询的形式来提升效率。</p>
<p><img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/766be333964812c4774ffe30478b683e_MD5.png"></p>
<p>怎么解决？使用覆盖索引，加子查询<br>
使用覆盖索引：速度有所提升<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/97f750d56ad80aebc3e054761f008eed_MD5.png"><br>
使用子查询形式取其他列的数据：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/c126cb8a318941346466433828de11fe_MD5.png"><br>
通过测试，这种方式整体效率有所提升。</p>
<h2 id="主键优化">主键优化<a hidden class="anchor" aria-hidden="true" href="#主键优化">#</a></h2>
<p>主键设计原则：</p>
<ol>
<li>主键值不要太长，二级索引叶子结点上存储的是主键值，主键值太长，容易导致索引占用空间较大。</li>
<li>尽量使用auto_increment生成主键。尽量不要使用uuid做主键，因为uuid不是顺序插入。</li>
<li>最好不要使用业务主键，因为业务的变化会导致主键值的频繁修改，主键值不建议修改，因为主键值修改，聚集索引一定会重新排序。</li>
<li>在插入数据时，主键值最好是顺序插入，不要乱序插入，因为乱序插入可能会导致B+树叶子结点频繁的进行页分裂与页合并操作，效率较低。
<ol>
<li>主键值对应聚集索引，插入主键值如果是乱序的，B+树叶子结点需要不断的重新排序，重排过程中还会频繁涉及到<strong>页分裂和页合并</strong>的操作，效率较低。</li>
<li>B+树上的每个节点都存储在页（page）中。一个页面中存储一个节点。</li>
<li>MySQL的InnoDB存储引擎一个页可以存储16KB的数据。</li>
<li>如果主键值不是顺序插入的话，会导致频繁的页分裂和页合并。在一个B+树中，页分裂和页合并是树的自动调整机制的一部分。当一个页已经满了，再插入一个新的关键字时就会触发页分裂操作，将页中的关键字分配到两个新的页中，同时调整树的结构。相反，当一个页中的关键字数量下降到一个阈值以下时，就会触发页合并操作，将两个相邻的页合并成一个新的页。如果主键值是随机的、不是顺序插入的，那么页的利用率会降低，页分裂和页合并的次数就会增加。由于页的分裂和合并是比较耗时的操作，频繁的分裂和合并会降低数据库系统的性能。因此，为了优化B+树的性能，可以将主键值设计成顺序插入的，这样可以减少页的分裂和合并的次数，提高B+树的性能。在实际应用中，如果对主键值的顺序性能要求不是特别高，也可以采用一些技术手段来减少页分裂和合并，例如B+树分裂时采用“延迟分裂”技术，或者通过调整页的大小和节点的大小等方式来优化B+树的性能。</li>
</ol>
</li>
</ol>
<p><img alt="1.jpg" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/d85a7efc1374817accaa6ed1b07359f4_MD5.jpg"></p>
<h2 id="insert优化">insert优化<a hidden class="anchor" aria-hidden="true" href="#insert优化">#</a></h2>
<p>insert优化原则：</p>
<ul>
<li>批量插入：数据量较大时，不要一条一条插入，可以批量插入，当然，建议一次插入数据不超过1000条</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_user(id,name,age) <span style="color:#fff;font-weight:bold">values</span> (<span style="color:#ff0;font-weight:bold">1</span>,<span style="color:#0ff;font-weight:bold">&#39;jack&#39;</span>,<span style="color:#ff0;font-weight:bold">20</span>),(<span style="color:#ff0;font-weight:bold">2</span>,<span style="color:#0ff;font-weight:bold">&#39;lucy&#39;</span>,<span style="color:#ff0;font-weight:bold">30</span>),(<span style="color:#ff0;font-weight:bold">3</span>,<span style="color:#0ff;font-weight:bold">&#39;timi&#39;</span>,<span style="color:#ff0;font-weight:bold">22</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>mysql默认是自动提交事务，只要执行一条DML语句就自动提交一次，因此，当插入大量数据时，建议手动开启事务和手动提交事务。不建议使用数据库事务自动提交机制。</li>
<li>主键值建议采用顺序插入，顺序插入比乱序插入效率高。</li>
<li>超大数据量插入可以考虑使用mysql提供的load指令，load指令可以将csv文件中的数据批量导入到数据库表当中，并且效率很高，过程如下：
<ul>
<li>第一步：登录mysql时指定参数</li>
</ul>
</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>mysql <span style="color:#007f7f">--local-infile -uroot -p1234
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>第二步：开启local_infile功能</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">set</span> <span style="color:#fff;font-weight:bold">global</span> local_infile = <span style="color:#ff0;font-weight:bold">1</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>第三步：执行load指令</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>use powernode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> t_temp(
</span></span><span style="display:flex;"><span>  id <span style="color:#fff;font-weight:bold">int</span> <span style="color:#fff;font-weight:bold">primary</span> <span style="color:#fff;font-weight:bold">key</span>,
</span></span><span style="display:flex;"><span>  name <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">255</span>),
</span></span><span style="display:flex;"><span>  password <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">255</span>),
</span></span><span style="display:flex;"><span>  birth <span style="color:#fff;font-weight:bold">char</span>(<span style="color:#ff0;font-weight:bold">10</span>),
</span></span><span style="display:flex;"><span>  email <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">255</span>)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">load</span> <span style="color:#fff;font-weight:bold">data</span> <span style="color:#fff;font-weight:bold">local</span> infile <span style="color:#0ff;font-weight:bold">&#39;E:\\powernode\\05-MySQL高级\\resources\\t_temp-100W.csv&#39;</span> <span style="color:#fff;font-weight:bold">into</span> <span style="color:#fff;font-weight:bold">table</span> t_temp fields terminated <span style="color:#fff;font-weight:bold">by</span> <span style="color:#0ff;font-weight:bold">&#39;,&#39;</span> lines terminated <span style="color:#fff;font-weight:bold">by</span> <span style="color:#0ff;font-weight:bold">&#39;\n&#39;</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>文件中的数据如下：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/0d31535650b608c98871a6116c22ac46_MD5.png"></p>
<p>导入表中之后，数据如下：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/cc195319950d3cc454a0b1e643dfe970_MD5.png"></p>
<h2 id="count优化">count(*)优化<a hidden class="anchor" aria-hidden="true" href="#count优化">#</a></h2>
<p>分组函数count的使用方式：</p>
<ul>
<li>count(主键)
<ul>
<li>原理：将每个主键值取出，累加</li>
</ul>
</li>
<li>count(常量值)
<ul>
<li>原理：获取到每个常量值，累加</li>
</ul>
</li>
<li>count(字段)
<ul>
<li>原理：取出字段的每个值，判断是否为NULL，不为NULL则累加。</li>
</ul>
</li>
<li>count(*)
<ul>
<li>原理：不用取值，底层mysql做了优化，直接统计总行数，效率最高。</li>
</ul>
</li>
</ul>
<p>结论：如果你要统计一张表中数据的总行数，建议使用 count(*)</p>
<p>注意：</p>
<ul>
<li>对于InnoDB存储引擎来说，count计数的实现原理就是将表中每一条记录取出，然后累加。如果你想真正提高效率，可以自己使用额外的其他程序来实现，例如每向表中插入一条记录时，在redis数据库中维护一个总行数，这样获取总行数的时候，直接从redis中获取即可，这样效率是最高的。</li>
<li>对于MyISAM存储引擎来说，当一个select语句没有where条件时，获取总行数效率是极高的，不需要统计，因为MyISAM存储引擎维护了一个单独的总行数。</li>
</ul>
<h2 id="update优化">update优化<a hidden class="anchor" aria-hidden="true" href="#update优化">#</a></h2>
<p>当存储引擎是InnoDB时，表的行级锁是针对索引添加的锁，如果索引失效了，或者不是索引列时，会提升为表级锁。<br>
什么是行级锁？A事务和B事务，开启A事务后，通过A事务修改表中某条记录，修改后，在A事务未提交的前提下，B事务去修改同一条记录时，无法继续，直到A事务提交，B事务才可以继续。</p>
<p>有一张表：t_fruit</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> t_fruit(
</span></span><span style="display:flex;"><span>  id <span style="color:#fff;font-weight:bold">int</span> <span style="color:#fff;font-weight:bold">primary</span> <span style="color:#fff;font-weight:bold">key</span> auto_increment,
</span></span><span style="display:flex;"><span>  name <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">255</span>)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_fruit <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;苹果&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_fruit <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;香蕉&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> t_fruit <span style="color:#fff;font-weight:bold">values</span>(<span style="color:#fff;font-weight:bold">null</span>, <span style="color:#0ff;font-weight:bold">&#39;橘子&#39;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>开启A事务和B事务，演示行级锁：<br>
事务A没有结束之前，事务B卡住：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/92f082b8ba1bcc07470153e4aa1d88fb_MD5.png"><br>
事务A结束之后，事务B继续执行：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/acb5c01880f477b8394ddfc6699c3ceb_MD5.png"><br>
当然，如果更新的不是同一行数据，事务A和事务B可以并发：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/dabf676e0515851820ce50ea64ec7916_MD5.png"></p>
<p>行级锁是对索引列加锁，以上更新语句的where条件是id，id是主键，当然有索引，所以使用了行级锁，如果索引失效，或者字段上没有索引，则会升级为表级锁：<br>
<img alt="image.png" loading="lazy" src="/posts/mysql/%E7%AC%AC10%E7%AB%A0-mysql%E4%BC%98%E5%8C%96/119a1a0000a3619851ef031658293498_MD5.png"></p>
<p>因此，为了更新的效率，建议update语句中where条件中的字段是添加索引的。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://009965.xyz/tags/mysql/">Mysql</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://009965.xyz/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
