<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>mysql技巧 | Wjy&#39;s Blog</title>
<meta name="keywords" content="mysql">
<meta name="description" content="select执行顺序


 1
 2
 3
 4
 5
 6
 7
 8
 9
10


(7) SELECT
(8) DISTINCT &lt;select_list&gt;
(1) FROM &lt;left_table&gt;
(3) &lt;join_type&gt; JOIN &lt;right_table&gt;
(2) ON &lt;join_condition&gt;
(4) WHERE &lt;where_condition&gt;
(5) GROUP BY &lt;group_by_list&gt;
(6) HAVING &lt;having_condition&gt;
(9) ORDER BY &lt;order_by_condition&gt;
(10) LIMIT &lt;limit_number&gt;


">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/mysql/mysql%E6%8A%80%E5%B7%A7/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="mysql技巧" />
<meta property="og:description" content="select执行顺序


 1
 2
 3
 4
 5
 6
 7
 8
 9
10


(7) SELECT
(8) DISTINCT &lt;select_list&gt;
(1) FROM &lt;left_table&gt;
(3) &lt;join_type&gt; JOIN &lt;right_table&gt;
(2) ON &lt;join_condition&gt;
(4) WHERE &lt;where_condition&gt;
(5) GROUP BY &lt;group_by_list&gt;
(6) HAVING &lt;having_condition&gt;
(9) ORDER BY &lt;order_by_condition&gt;
(10) LIMIT &lt;limit_number&gt;


" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/mysql/mysql%E6%8A%80%E5%B7%A7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-12-02T18:13:55+00:00" />
<meta property="article:modified_time" content="2019-12-02T18:13:55+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="mysql技巧"/>
<meta name="twitter:description" content="select执行顺序


 1
 2
 3
 4
 5
 6
 7
 8
 9
10


(7) SELECT
(8) DISTINCT &lt;select_list&gt;
(1) FROM &lt;left_table&gt;
(3) &lt;join_type&gt; JOIN &lt;right_table&gt;
(2) ON &lt;join_condition&gt;
(4) WHERE &lt;where_condition&gt;
(5) GROUP BY &lt;group_by_list&gt;
(6) HAVING &lt;having_condition&gt;
(9) ORDER BY &lt;order_by_condition&gt;
(10) LIMIT &lt;limit_number&gt;


"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "mysql技巧",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/mysql/mysql%E6%8A%80%E5%B7%A7/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "mysql技巧",
  "name": "mysql技巧",
  "description": "select执行顺序 1 2 3 4 5 6 7 8 9 10 (7) SELECT (8) DISTINCT \u0026lt;select_list\u0026gt; (1) FROM \u0026lt;left_table\u0026gt; (3) \u0026lt;join_type\u0026gt; JOIN \u0026lt;right_table\u0026gt; (2) ON \u0026lt;join_condition\u0026gt; (4) WHERE \u0026lt;where_condition\u0026gt; (5) GROUP BY \u0026lt;group_by_list\u0026gt; (6) HAVING \u0026lt;having_condition\u0026gt; (9) ORDER BY \u0026lt;order_by_condition\u0026gt; (10) LIMIT \u0026lt;limit_number\u0026gt; ",
  "keywords": [
    "mysql"
  ],
  "articleBody": "select执行顺序 1 2 3 4 5 6 7 8 9 10 (7) SELECT (8) DISTINCT (1) FROM (3) JOIN (2) ON (4) WHERE (5) GROUP BY (6) HAVING (9) ORDER BY (10) LIMIT select 执行顺序一共分为10步。其中每一次操作都会产生一张虚拟的表，只是这些虚拟的表对用户来说是透明的，但是只有最后一个虚拟的表才会被作为结果返回。如果没有在语句中指定某一个子句，那么将会跳过相应的步骤。\nfrom：对 from 左边的表和右边的表计算笛卡尔积，产生虚表VT1。 on：对虚表VT1进行ON过滤，只有那些符合 join 的行才会被记录在虚表VT2中。 join： 如果指定了OUTER JOIN（比如left join、 right join），那么保留表中未匹配的行就会作为外部行添加到虚拟表VT2中，产生虚拟表VT3。 where： 对虚拟表VT3进行WHERE条件过滤。只有符合 where 的记录才会被插入到虚拟表VT4中。 group by ：根据group by子句中的列，对VT4中的记录进行分组操作，产生VT5。 having： 对虚拟表VT5应用having过滤，只有符合 having 的记录才会被 插入到虚拟表VT6中。 select：执行select操作，选择指定的列，插入到虚拟表VT7中。 distinct：对VT7中的记录进行去重。产生虚拟表VT8。 order by ：将虚拟表VT8中的记录按照 order by 进行排序操作，产生虚拟表VT9。 limit：取出指定行的记录，产生虚拟表VT10，并将结果返回。 时间相关 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 获取今天到明天的数据 where date_format(create_date,'%y-%m-%d') BETWEEN date_format(curdate(),'%y-%m-%d') and DATE_SUB(curdate(),INTERVAL -1 DAY) 当天数据1 where date_format(create_date,'%y-%m-%d') = date_format(curdate(),'%y-%m-%d') 当天数据2 select * from 表名 where to_days(时间字段名) = to_days(now()); 注：to_days 是mysql的函数 昨天数据 SELECT * FROM 表名 WHERE TO_DAYS( NOW( ) ) - TO_DAYS( 时间字段名) \u003c= 1 近7天 SELECT * FROM 表名 where DATE_SUB(CURDATE(), INTERVAL 7 DAY) \u003c= date(时间字段名) 近30天 SELECT * FROM 表名 where DATE_SUB(CURDATE(), INTERVAL 30 DAY) \u003c= date(时间字段名) 本月 SELECT * FROM 表名 WHERE DATE_FORMAT( 时间字段名, '%Y%m' ) = DATE_FORMAT( CURDATE( ) , '%Y%m' ) 上一月 SELECT * FROM 表名 WHERE PERIOD_DIFF( date_format( now( ) , '%Y%m' ) , date_format( 时间字段名, '%Y%m' ) ) =1 查询本季度数据 select * from `ht_invoice_information` where QUARTER(create_date)=QUARTER(now()); 查询上季度数据 select * from `ht_invoice_information` where QUARTER(create_date)=QUARTER(DATE_SUB(now(),interval 1 QUARTER)); 查询本年数据 select * from `ht_invoice_information` where YEAR(create_date)=YEAR(NOW()); 查询上年数据 select * from `ht_invoice_information` where year(create_date)=year(date_sub(now(),interval 1 year)); 查询当前这周的数据 SELECT name,create_time FROM enterprise WHERE YEARWEEK(date_format(create_time,'%Y-%m-%d')) = YEARWEEK(now()); 查询上周的数据 SELECT name,submittime FROM enterprise WHERE YEARWEEK(date_format(submittime,'%Y-%m-%d')) = YEARWEEK(now())-1; 查询上个月的数据 select name,submittime from enterprise where date_format(submittime,'%Y-%m') = date_format(DATE_SUB(curdate(), INTERVAL 1 MONTH),'%Y-%m') select * from user where DATE_FORMAT(pudate,'%Y%m') = DATE_FORMAT(CURDATE(),'%Y%m') ; select * from user where WEEKOFYEAR(FROM_UNIXTIME(pudate,'%y-%m-%d')) = WEEKOFYEAR(now()) select * from user where MONTH(FROM_UNIXTIME(pudate,'%y-%m-%d')) = MONTH(now()) select * from user where YEAR(FROM_UNIXTIME(pudate,'%y-%m-%d')) = YEAR(now()) and MONTH(FROM_UNIXTIME(pudate,'%y-%m-%d')) = MONTH(now()) select * from user where pudate between 上月最后一天 and 下月第一天 查询当前月份的数据 select name,submittime from enterprise where date_format(submittime,'%Y-%m')=date_format(now(),'%Y-%m') 查询距离当前现在6个月的数据 select name,submittime from enterprise where submittime between date_sub(now(),interval 6 month) and now(); rand() order by RAND()：随机返回结果，随机函数效率很低，尽量不要使用，因为它的效率会随着数据量的增大，效率越来越低。\n推荐一种：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 SELECT * FROM `question` AS t1 JOIN ( SELECT ROUND( RAND( ) * ( ( SELECT MAX( id ) FROM `question` ) - ( SELECT MIN( id ) FROM `question` ) ) + ( SELECT MIN( id ) FROM `question` ) ) AS id ) AS t2 WHERE t1.id \u003e= t2.id ORDER BY t1.id LIMIT 5; 加上MIN(id)的判断，是因为最开始测试的时候，因为没有加上MIN(id)的判断，结果有一半的时间总是查询到表中的前面几行。这种方法缺点是会产生id连续的数据。\n并发插入、存在不插入、存在更新操作 通常会，先查询，不存在再插入，但是这样无法避免并发问题，不用考虑了。\n使用replace into，存在即更新，不存在即插入 replace into table (id,name) values(1,\"小明\") 如果发现表中已经有此行数据（根据主键或者唯一索引判断），则先删除此行数据，然后插入新的数据，否则，直接插入新数据。所以，插入时如果不插入主键(逐渐默认递增)，就需要保证一列是唯一索引，保证唯一，才可以。\n存在不插入，不存在再插入(感觉这种方法是最好的) mysql 不能在插入时带where条件，故用临时表处理\n1 2 3 INSERT INTO demo_in(a,b,c) SELECT 123, 2, 4 FROM DUAL WHERE NOT EXISTS(SELECT c FROM demo_in WHERE c = 4); 用临时表DUAL来标记数据，然后插入到demo_in表中。 条件是c=4，并且not exists，也就是当c=4条件满足，则不插入。\nunion all和order by 多个select 语句 union 时不是简单的将查询结果拼接起来 而是将sql拼接起来编译（做为一个sql语句），然后去执行。所以union 连接的语句中只会出现一个order by （不包含子查询中的），否则会报 sql未正确结束的错误。解决方法：将order by 语句放到子查询中。\n1 2 3 4 5 6 7 8 将排序后的查询结果拼接起来 select * from(select * from table order by a) union select * from (select * from table1 order by b) union select * from (select * from table2 order by c);//注意，这里的order by会失效 order by d 此处的order by 是将最后的拼接结果集排序，打乱了之前通过 a、b、c的排序。 MySQL单表多次查询和多表联合查询，哪个效率高？ 很多高性能的应用都会对关联查询进行分解。 简单地，可以对每个表进行一次单表查询，然后将结果在应用程序中进行关联。例如，下面这个查询：\n1 2 3 4 select * from tableA a join tableB b on b.tableA_id = a.id join tableC c on c.tableB_id = b.id where a.name = '123'; 可以分解成下面这些查询来代替：\n1 2 3 select id from tableA where name = '123'; -- 结果A select * from tableB where tableA_id = id(结果A) -- 结果B select * from tableC where id in (结果B) 到底为什么要这样做？ 起初感觉，这样做并没有什么好处，原本一条查询，这里却变成了多条查询，返回结果又是一模一样。 事实上，用分解关联查询的方式重构查询具有如下优势：\n让缓存效率更高 对于MySQL的查询缓存来说，如果关联中的某个表发生了变化，那么就无法使用查询缓存了，而拆分后，如果某个表很少改变，那么基于该表的查询就可以重复利用查询缓存结果了。 可以减少冗余记录的查询。 查询本身效率也可能会有所提升 将查询分解后，执行单个查询可以减少锁的竞争。 在应用层做关联，可以更容易对数据库进行拆分，更容易做到高性能和可扩展。 这样做相当于在应用中实现了哈希关联，而不是使用MySQL的嵌套环关联，某些场景哈希关联的效率更高很多。 mysql存储表情 存储表情时报错： java.sql.SQLException: Incorrect string value: '\\xF0\\x9F\\x92\\x94' for colum n 'name' at row 1 使用mysql数据库的时候，如果字符集是UTF-8，当存储emoji表情的时候，会抛出以上异常。 这是由于字符集不支持的异常，因为utf-8编码有可能是两个，三个，四个字节，其中Emoji表情是四个字节，而mysql的utf-8编码最多三个字节，所以导致数据插不进去。 解决：\n修改database、table、column字符集 1 2 3 ALTER DATABASE database_name CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci; ALTER TABLE table_name CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; ALTER TABLE table_name CHANGE column_name VARCHAR(191) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; 除了column的字符集，库和表的字符集不是必须修改。\n修改mysql配置文件 1 2 3 4 5 6 7 8 9 [client] default-character-set = utf8mb4 [mysql] default-character-set = utf8mb4 [mysqld] character-set-client-handshake = FALSE character-set-server = utf8mb4 collation-server = utf8mb4_unicode_ci init_connect='SET NAMES utf8mb4' 检查mysql-connector-java版本，必须高于5.1.13否则仍然不能试用utf8mb4 修改链接数据库地址 1 2 3 4 5 6 7 8 jdbc:mysql://localhost:3306/test? \"useUnicode=true\" + \"\u0026characterEncoding=UTF-8\" + \"\u0026zeroDateTimeBehavior=convertToNull\" + \"\u0026useSSL=false\" + \"\u0026allowMultiQueries=true\" + \"\u0026autoReconnect=true\" + \"\u0026rewriteBatchedStatements=TRUE\"); 如果升级了mysql-connector，其中的characterEncoding=utf8可以自动被识别为utf8mb4（兼容原来的utf8），而autoReconnection（当数据库连接异常中断时，是否自动重新连接？默认为false）强烈建议配上，忽略这个属性，可能导致缓存缘故 ，没有读取到DB最新的配置，导致一直无法试用utf8mb4字符集。\n查树的所有子节点 在Oracle 中我们知道有一个 Hierarchical Queries 通过CONNECT BY 我们可以方便的查了所有当前节点下的所有子节点。但很遗憾，在MySQL的目前版本中还没有对应的功能。 在MySQL中如果是有限的层次，比如我们事先如果可以确定这个树的最大深度是4, 那么所有节点为根的树的深度均不会超过4，则我们可以直接通过left join 来实现。 但很多时候我们无法控制树的深度。这时就需要在MySQL中用存储过程来实现或在你的程序中来实现这个递归。本文讨论一下几种实现的方法。\n新的思路 解决这种树状结构问题，可以在表中加一个字段path，标识这条数据的路径，即父子级结构路径。\nid 公司名 parent_id path 1 总公司 0 1 2 技术部 1 1,2 3 人力部 1 1,3 4 技术部下-java部门 2 1,2,4 这样如果我想查总公司下有哪些部门，需要使用mysql 函数FIND_IN_SET(str,strlist)，like是不行的。\n样例数据 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 create table treeNodes ( id int primary key, nodename varchar(20), pid int ); select * from treenodes; +----+----------+------+ | id | nodename | pid | +----+----------+------+ | 1 | A | 0 | | 2 | B | 1 | | 3 | C | 1 | | 4 | D | 2 | | 5 | E | 2 | | 6 | F | 3 | | 7 | G | 6 | | 8 | H | 0 | | 9 | I | 8 | | 10 | J | 8 | | 11 | K | 8 | | 12 | L | 9 | | 13 | M | 9 | | 14 | N | 12 | | 15 | O | 12 | | 16 | P | 15 | | 17 | Q | 15 | +----+----------+------+\t树形图如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 1:A +-- 2:B | +-- 4:D | +-- 5:E +-- 3:C +-- 6:F +-- 7:G 8:H +-- 9:I | +-- 12:L | | +--14:N | | +--15:O | | +--16:P | | +--17:Q | +-- 13:M +-- 10:J +-- 11:K 方法一：利用函数来得到所有子节点号 创建一个function getChildLst, 得到一个由所有子节点号组成的字符串。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 CREATE FUNCTION `getChildLst` ( rootId INT ) RETURNS VARCHAR(1000) BEGIN DECLARE sTemp VARCHAR ( 1000 ); DECLARE sTempChd VARCHAR ( 1000 ); SET sTemp = '$'; SET sTempChd = cast( rootId AS CHAR );\tWHILE sTempChd IS NOT NULL DO SET sTemp = concat( sTemp, ',', sTempChd ); SELECT group_concat( id ) INTO sTempChd FROM treeNodes WHERE FIND_IN_SET( pid, sTempChd ) \u003e 0; END WHILE; RETURN sTemp; END 使用我们直接利用find_in_set函数配合这个getChildlst来查找\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 select getChildLst(1); +-----------------+ | getChildLst(1) | +-----------------+ | $,1,2,3,4,5,6,7 | +-----------------+ select * from treeNodes where FIND_IN_SET(id, getChildLst(1)); +----+----------+------+ | id | nodename | pid | +----+----------+------+ | 1 | A | 0 | | 2 | B | 1 | | 3 | C | 1 | | 4 | D | 2 | | 5 | E | 2 | | 6 | F | 3 | | 7 | G | 6 | +----+----------+------+ select * from treeNodes where FIND_IN_SET(id, getChildLst(3)); +----+----------+------+ | id | nodename | pid | +----+----------+------+ | 3 | C | 1 | | 6 | F | 3 | | 7 | G | 6 | +----+----------+------+ 优点: 简单，方便，没有递归调用层次深度的限制 (max_sp_recursion_depth,最大255) ； 缺点：长度受限，虽然可以扩大 RETURNS varchar(1000)，但总是有最大限制的。 MySQL目前版本( 5.1.33-community)中还不支持function 的递归调用。\n方法二：利用临时表和过程递归 创建存储过程如下。createChildLst 为递归过程，showChildLst为调用入口过程，准备临时表及初始化。\n入口过程\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 CREATE PROCEDURE showChildLst ( IN rootId INT ) BEGIN CREATE TEMPORARY TABLE IF NOT EXISTS tmpLst ( sno INT PRIMARY KEY auto_increment, id INT, depth INT ); DELETE FROM tmpLst; CALL createChildLst ( rootId, 0 ); SELECT tmpLst.*, treeNodes.* FROM tmpLst, treeNodes WHERE tmpLst.id = treeNodes.id ORDER BY tmpLst.sno; END; 递归过程\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 CREATE PROCEDURE createChildLst ( IN rootId INT, IN nDepth INT ) BEGIN DECLARE done INT DEFAULT 0; DECLARE b INT; DECLARE cur1 CURSOR FOR SELECT id FROM treeNodes WHERE pid = rootId; DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1; INSERT INTO tmpLst VALUES ( NULL, rootId, nDepth ); OPEN cur1; FETCH cur1 INTO b; WHILE done = 0 DO CALL createChildLst ( b, nDepth + 1 ); FETCH cur1 INTO b; END WHILE; CLOSE cur1; END; 调用时传入结点\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 call showChildLst(1); +-----+------+-------+----+----------+------+ | sno | id | depth | id | nodename | pid | +-----+------+-------+----+----------+------+ | 4 | 1 | 0 | 1 | A | 0 | | 5 | 2 | 1 | 2 | B | 1 | | 6 | 4 | 2 | 4 | D | 2 | | 7 | 5 | 2 | 5 | E | 2 | | 8 | 3 | 1 | 3 | C | 1 | | 9 | 6 | 2 | 6 | F | 3 | | 10 | 7 | 3 | 7 | G | 6 | +-----+------+-------+----+----------+------+ call showChildLst(3); +-----+------+-------+----+----------+------+ | sno | id | depth | id | nodename | pid | +-----+------+-------+----+----------+------+ | 1 | 3 | 0 | 3 | C | 1 | | 2 | 6 | 1 | 6 | F | 3 | | 3 | 7 | 2 | 7 | G | 6 | +-----+------+-------+----+----------+------+ depth 为深度，这样可以在程序进行一些显示上的格式化处理。类似于oracle中的 level 伪列。sno 仅供排序控制。这样你还可以通过临时表tmpLst与数据库中其它表进行联接查询。\nMySQL中你可以利用系统参数 max_sp_recursion_depth 来控制递归调用的层数上限。如下例设为12 set max_sp_recursion_depth=12;\n优点：可以更灵活处理，及层数的显示。并且可以按照树的遍历顺序得到结果。 缺点：递归有255的限制\n方法三：利用中间表和过程 创建存储过程如下。由于MySQL中不允许在同一语句中对临时表多次引用，只以使用普通表tmpLst来实现了。当然你的程序中负责在用完后清除这个表。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 drop PROCEDURE IF EXISTS showTreeNodes; CREATE PROCEDURE showTreeNodes (IN rootid INT) BEGIN DECLARE Level int; drop TABLE IF EXISTS tmpLst; CREATE TABLE tmpLst ( id int, nLevel int, sCort varchar(8000) ); Set Level = 0; INSERT into tmpLst SELECT id,Level,ID FROM category WHERE parent_id = rootid; WHILE ROW_COUNT() \u003e 0 DO SET Level = Level + 1; INSERT into tmpLst SELECT A.ID,Level,concat(B.sCort,A.ID) FROM category A,tmpLst B WHERE A.parent_id = B.ID AND B.nLevel = Level-1; END WHILE; END; CALL showTreeNodes(0); 执行完后会产生一个tmpLst表，nLevel 为节点深度，sCort 为排序字段。 使用方法\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 SELECT concat(SPACE(B.nLevel*2),'+--',A.nodename) FROM treeNodes A,tmpLst B WHERE A.ID=B.ID ORDER BY B.sCort; +--------------------------------------------+ | concat(SPACE(B.nLevel*2),'+--',A.nodename) | +--------------------------------------------+ | +--A | | +--B | | +--D | | +--E | | +--C | | +--F | | +--G | | +--H | | +--J | | +--K | | +--I | | +--L | | +--N | | +--O | | +--P | | +--Q | | +--M | +--------------------------------------------+ 优点：层数的显示。并且可以按照树的遍历顺序得到结果。没有递归限制。 缺点：MySQL中对临时表的限制，只能使用普通表，需做事后清理。\n参考地址\n一些特殊的sql 出自：archive档案管理系统，ArchiveMapper.xml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u003c!-- 案件列表 --\u003e \u003cselect id=\"caseList\" resultType=\"map\"\u003e select id, concat( \"list\" separator=\",\" item=\"i\"\u003e ${i.columnEnglish} \u003cif test=\"null != i.connector and '' != i.connector\"\u003e ,${i.connector} \u003c/if\u003e ) dataName from `${tableName}` \u003c/select\u003e 2 1 2 3 4 5 select * from table_name where id in (1,2,3) order by field(id,1,2,3) 根据in里的参数排序。 xml写法：\n1 2 3 4 5 order by field(q.id, #{i} ) 删除parents表中手机号重复的数据 1 2 3 4 5 6 DELETE FROM parents WHERE mobile IN ( SELECT mobile FROM ( SELECT id, mobile, count( id ) count FROM parents GROUP BY mobile HAVING count \u003e 1 ) a ) AND id NOT IN ( SELECT id FROM ( SELECT id, mobile, count( id ) count FROM parents GROUP BY mobile HAVING count \u003e 1 ) a ) 统计status分别为1和0的数据 1 2 3 4 5 select sum(if(status = 1,1,0)) finished_no, sum(if(status = 0,1,0)) unfinished_no from message_task where message_id = #{_parameter} 更新数据 1 2 3 4 update process_video_data t1 left join process_video_data t2 on t1.album_name = t2.album_name set t1.album_id = t2.album_id where t1.album_id is null mysql order by 字段有相同值，排序出来的字段会随机 一些数据，创建时间会有相同的。但是我需要按照时间排序，此时mysql返回的数据会出现随机。 select * from table_a order by create_time desc 查阅官网发现 “If multiple rows have identical values in the ORDER BY columns, the server is free to return those rows in any order, and may do so differently depending on the overall execution plan. In other words, the sort order of those rows is nondeterministic with respect to the nonordered columns.” 翻译：如果在ORDER BY列中有多个行具有相同的值，则服务器可以自由以任何顺序返回这些行，并且根据整体执行计划的不同，返回值可能会有所不同。 换句话说，这些行的排序顺序相对于无序列是不确定的。 MySQL官网上也给出了一种方案： “If it is important to ensure the same row order with and without LIMIT, include additional columns in the ORDER BY clause to make the order deterministic. For example, if id values are unique, you can make rows for a given category value appear in id order by sorting like this:” 在ORDER BY子句中包括其他列以使顺序确定，比如可以使用主键id等。上面的SQL可以修改下： select * from table_a order by create_time desc,id 问题解决。\nletf join 之后的条件和放到where之后的条件，有什么区别 数据库在连接多张表返回记录时，都会生成一张临时表，然后将这张表返回给用户。 在使用left join 时，on和where条件的区别如下：\non条件是在生成临时表时使用的条件，无论on中的条件是否为真，都会返回左表中的记录。 where条件是在临时表生成好后，再对临时表进行过滤的条件，条件不为真的全部过滤掉。 假设两张表： 表1：table_1\nid size 1 10 2 20 3 30 表2：table_2\nsize name 10 A 20 B 30 C 两条sql： select * form tab1 left join table_2 on (table_1.size = table_2.size) where table_2.name=’A’ select * form tab1 left join table_2 on (table_1.size = table_2.size and table_2.name=’A’)\nsql_1的执行过程： 中间表 on条件: table_1.size = table_2.size\ntable_1.id table_1.size table_2.size table_2.name 1 10 10 A 2 20 20 B 2 20 20 C 3 30 (null) (null) where再对中间表数据过滤：table_2.name = A\ntable_1.id table_1.size table_2.size table_2.name 1 10 10 A sql_2的执行过程： 中间表 on条件: table_1.size = table_2.size and table_2.name=’A’ (条件不为真也会返回左表中的记录)\ntable_1.id table_1.size table_2.size table_2.name 1 10 10 A 2 20 (null) (null) 3 30 (null) (null) 由于left join 、right join 、full join 的特性，不管on上的条件是否为真都会返回left或right表中的记录，full join 具有left join 和right join 特性的并集。而inner join 没有这个特性，返回的结果是相同的。\n总结：\non在生成连接表时起作用，where在生成连接表后对连接表再进行过滤。 使用left join时，无论on的条件是否满足，都会返回左表的所有记录，对于满足条件的记录，两个表对应的记录会连接起来，对于不满足条件的记录，右表字段全部是null。 使用right join时，无论on的条件是否满足，都会返回右表的所有记录，对于满足条件的记录，两个表对应的记录会连接起来，对于不满足条件的记录，左表字段全部是null。 使用inner join时，on的条件和where完全相同。 参考 mysql 获取排列序号 在进入正题之前先来了解一个mysql中的小知识点： := 与 = 的区别 := 赋值的意思。在set update select 中表示赋值的意思，用的比较少一般都用=，但是在用变量实现行号时（比如本文标题获取排列序号），一定要用:=。\n= 等于的意思，只有当set 和 update时，和:=的意思是一样的，表示赋值，其余情况都是等于的意思。\n用户变量 @ @rank 是对一个叫rank的参数进行赋值。对用户变量赋值有两种方式，一种直接用\"=“另一种用”:=\"。 其区别在于使用set命令对用户变量赋值时，两种方式都可以使用；当使用select语句对用户变量进行赋值时，只能使用“:=”方式，因为在select语句中，“=”被看做是比较操作符。\n根据某字段按序排列并获取排序号 1 2 3 4 5 6 7 8 9 SELECT a.*, @rank:=@rank + 1 AS rank_no FROM ( SELECT * FROM `logs` WHERE log_created \u003e \"2017-09-01\" ORDER BY count DESC ) a, (SELECT @rank:= 0) b 2017.09.01之前的日志按访问量进行倒序排序，并返回序号。\nselect @rank:= 0 set @rank=0; 这句话其实就是将rank赋值0，从零开始加1编号，上面两种写法都可以。\n用set的写法：\n1 2 3 4 5 6 7 8 9 10 11 12 set @rank= 0; SELECT a.log_id, a.log_created, a.count, @rank:=@rank + 1 AS rank_no FROM ( SELECT * FROM `logs` WHERE log_update \u003e \"2017-09-01\" ORDER BY count DESC ) a; 所以，获取排序序号还是很简单的，基本上都是固定的方式，里面一层select是正常的sql排序的语句，外面一层是对查到的已排好序的数据列进行rank自增的操作，所以一开始@rank:=0。\n根据某字段按序排列获取排序号，且当该字段的值存在多个相同的记录时，则相同值排序号相同 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 SET @rank = 0 ,@rowtotal := NULL; SELECT a.log_id, a.log_created, a.count, CASE WHEN @rowtotal = a.count THEN @rank WHEN @rowtotal := a.count THEN @rank := @rank + 1 END AS rank_no FROM ( SELECT * FROM `logs` WHERE log_update \u003e \"2017-09-01\" ORDER BY count DESC ) a 从上面的sql语句可以看出多了一句case函数，（rowtotal表示count）根据情况对rank进行赋值， 当rowtotal等于count时，序号就是rank，当rowtotal正常赋值时，言下之意就是不等于，但是 又不能用!= ，（其实这样说也不准确，我也不知道该怎么表达，有知道的人博友可以帮忙补充一下~~~）， 这样就实现了相同记录编号相同的目的，同时其余记录继续编号。\n根据某字段按序排列获取排序号，且当该字段的值存在多个相同的记录时，则相同值的记录的排序号相同，并且下一组值的排序号为上一组内记录数+上一个排序号 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 SET @rank = 0 ,@rowtotal := NULL ,@rowtotal1 = NULL ,@sart := 0; SELECT a.log_id, a.log_created, a.count, CASE WHEN @rowtotal = a.count THEN @rank WHEN @rowtotal := a.count THEN @rank := @rank + 1 + @sart END AS rank_no, CASE WHEN @rowtotal1 = a.count THEN @sart := @sart + 1 WHEN @rowtotal1 := a.count THEN @sart := 0 END AS sart FROM ( SELECT * FROM `logs` WHERE log_update \u003e \"2017-09-01\" ORDER BY count DESC ) a 上面的sql里又增加了一个参数sart，表示当前每次相同的个数，（同时还增加了rowtotal1， 用于区别之前的roetotal，因为在这段sql中rowtotal在运行期间已被多次赋值，不适合做sart的比较参数）下一组记录，将在之前的排名上加上此参数就表示，下一组记录的排序编码。为了再次验证sql准确性，再看一组运行结果，（调整日志创建时间为log_update \u003e “2016-06-20” and log_update \u003c “2017-03-01”）\n上面的sql有个问题就是当数据是0的时候，没有进行特殊处理这个时候得到的rank_no是一个null值，排序就会出问题，下面针对第三种情况做一下纠正其余的类似：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 SET @rank = 0 ,@rowtotal := NULL ,@rowtotal1 = NULL ,@sart := 0; SELECT a.log_id, a.log_created, a.count, CASE WHEN @rowtotal = a.count THEN @rank WHEN @rowtotal := a.count THEN @rank := @rank + 1 + @sart WHEN @rowtotal = 0 THEN @rank := @rank +1 +@sart END AS rank_no, CASE WHEN @rowtotal1 = a.count THEN @sart := @sart + 1 WHEN @rowtotal1 := a.count THEN @sart := 0 WHEN @rowtotal1 =0 THEN @sart := 0 END AS sart FROM ( SELECT * FROM `logs` WHERE log_update \u003e \"2017-09-01\" ORDER BY count DESC ) a 参考\n技巧 mysql按天统计数据 库里的存的时间戳，每条数据的时间戳都不一样。 所以使用如下方法，按天统计数据。\n1 2 3 4 5 6 7 8 SELECT FROM_UNIXTIME( create_time,'%Y-%m-%d') days, count( id ) countId FROM user_behavior where user_id = #{_parameter} GROUP BY days; mysql获取奇数偶数 奇数\n1 2 3 select * from table WHERE id \u0026 1; 偶数：id先除以2然后乘2，如果与原来的相等就是偶数\n1 2 3 select * from table WHERE id = (id \u003e\u003e 1) \u003c\u003c 1; 今天遇到的奇怪bug 主表一对多子表，子表存了主表的id。主表数据清了，AUTO_INCREMENT从1开始，但是子表数没清空。 导致的问题是：再次新增主表数据时，假如主表数据id是1，那么存入子表的主表id是1，但是因为子表的数据没有清空，之前留在子表的主表id为1的数据还在。那么再根据主表id=1时查询，就会出现多的数据，实际是因为旧数据没删除导致的。以后还得注意这个问题，删除据时候，主子表（有关联的）数据要一同删除。\n统计连续天数 已知有一些用户数据，每条数据都有时间，时间格式是Date：2021-05-23。如果是时间戳类型，可以通过函数FROM_UNIXTIME( create_time, '%Y-%m-%d' )格式化成自己想要的时间格式。现在想，找出连续的天数的数据。\n首先将数据分组\n1 2 3 4 5 6 7 8 select user_id, create_time from table_a group by user_id, create_time 然后把连续的天数进行分组\n1 2 3 4 5 6 7 8 9 10 11 12 SELECT *,(( SELECT count( 1 ) FROM ( SELECT user_id, create_time FROM table_a GROUP BY user_id, create_time ) dr2 WHERE dr1.user_id = dr2.user_id AND dr2.create_time \u003c= dr1.create_time ) - DAY ( dr1.create_time )) AS 'rownum' FROM ( SELECT user_id, create_time FROM table_a GROUP BY user_id, create_time ) dr1 然后按用户 、开始时间、结束时间 和 连续天数分组\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 SELECT user_id, min( create_time ), max( create_time ),( datediff( max( create_time ), min( create_time ))+ 1 ) AS 'rn' FROM ( SELECT *,(( SELECT count( 1 ) FROM ( SELECT user_id, create_time FROM table_a GROUP BY user_id, create_time ) dr2 WHERE dr1.user_id = dr2.user_id AND dr2.create_time \u003c= dr1.create_time ) - DAY ( dr1.create_time )) AS 'rownum' FROM ( SELECT user_id, create_time FROM table_a GROUP BY user_id, create_time ) dr1 ) z GROUP BY user_id, rownum 参考\n给查询记录添加自然序号 表a，数据：\nid name 5 张三 6 李四 7 王五 通过一条sql获取这三条记录，并且给每行前面加上从1开始的序号\n序号 id name 1 5 张三 2 6 李四 3 7 王五 1 2 3 4 5 6 SELECT @rownum := @rownum + 1 AS rownum, a.* FROM ( SELECT @rownum := 0 ) r, table a; 写法2：\n1 2 3 4 5 6 SELECT @rowno := @rowno + 1 AS rowno, a.* FROM table a, ( SELECT @rowno := 0 ) t 如果有按照某个字段排序，行号会不规则排列，换成先排序，外层加上行号会更加合适。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 SELECT @ROWNO := @ROWNO + 1 AS ROWNO, T.* FROM ( SELECT a.* FROM table_name a LEFT JOIN ... WHERE ... ORDER BY ... desc ) T,( SELECT @ROWNO := 0 ) T3 ORDER BY ROWNO group_concat 完整语法如下： group_concat([DISTINCT] 要连接的字段 [Order BY ASC/DESC 排序字段] [Separator '分隔符'])\n注意：使用 GROUP_CONCAT（）函数必须对源数据进行分组，否则所有数据会被合并成一行。\n参考 参考\nnull值排序 现在需要按照提交时间create_time正序排序数据， 假设create_time字段中有null值，如果直接，order by create_time，会发现create_time为null的数据排在的前面。\n解决办法： order by create_time is null,create_time\nmysql datetime类型时间错误 初步判断是mysql时区的问题，因为mysql时区设置默认是操作系统时区，查看了下centos时区，东8区没有错，所以可以判定是代码里面设置了一个错误的时区。\n解决方式一 查看当前时区 show variables like ‘%time_zone%’; 发现果然是CST,北美的Central Standard Time\n设置时区 set global time_zone = ‘+8:00’; set time_zone = ‘+8:00’; flush PRIVILEGES;\n解决方式二 在mysql的连接后加上 serverTimezone=GMT%2B8\ngroup by 获取最新的数据 因为group by 是获取的第一条数据，所以可以通过下面的方法获取最后一条数据。\n1 2 3 select * from chapter_user_dub where id in( select MAX(id) from chapter_user_dub where user_id = 106175 group by user_id ) 子查询order by和外层group by 现在想对order by的结果集进行group by，sql如下：\n1 2 3 4 5 6 7 8 select id, name from table_a ta left join table_b tb on tb.id = ta.tb_id where ... order by tb.create_time group by ta.id 已知group by取的是第一条数据，而且group by是在order by之前执行，所有获取不到想要的order by的结果集，于是想用子查询：\n1 2 3 4 5 6 7 8 9 10 select * from ( select id, name from table_a ta left join table_b tb on tb.id = ta.tb_id where ... order by tb.create_time ) t GROUP BY ta.id 虽然在外层执行group by，但是结果还是不对(取的还是第一条数据，子查询没用)。 于是在子查询里边加上limt\n1 2 3 4 5 6 7 8 9 10 11 select * from ( select id, name from table_a ta left join table_b tb on tb.id = ta.tb_id where ... order by tb.create_time limit 999 ) t GROUP BY ta.id 好了。原因是什么我不知道。\ncase-when的几种形式 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 CASE b.check_type when '1' then b.real_name when '2' then b.association_name else u2.name(有else) end AS \"user.name\", --------- CASE a.exh_type when '1' then a.is_art when '2' then c.is_art end AS \"isArt\" --------- case (case后边没东西) when a.end_time \u003e now() then '1' when a.end_time \u0026lt; now() then '2' end AS \"isPass\" --------- where a.is_home = '1' and a.publish_status = '1' and ( case a.exh_type when '1' then a.audit_status = '2' else 1 = 1 end ) find_in_set find_in_set(str,strlist)\nstr：要查询的字符串 strlist：字段名，存储内容逗号分隔，如(1,2,6,8) 查询字段(strlist)中包含(str)的结果，返回结果为null或记录。\nSELECT FIND_IN_SET('b', 'a,b,c,d'); 返回2，因为b 在strlist集合中放在2的位置。\nfind_in_set很适合查询表中数据为树形的结构，比如部门，一般是这种结构\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 1:技术部 +-- 2:JAVA部门 | +-- 4:影魔 | +-- 5:白牛 +-- 3:Python部门 +-- 6:火女 +-- 7:冰女 8:总公司 +-- 9:众望教育 | +-- 12:市场部 | | +--14:小黑 | | +--15:美杜莎 | +-- 13:人力部 +-- 10:xxx +-- 11:xxx 这时如果想查询技术部或总公司下所有的人，用find_in_set就很简单：\n1 2 3 select * from find_in_set where find_in_set(2,path) find_in_set()和in的区别 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 create table find_in_set ( id int auto_increment, dep_name varchar(100) null comment '部门名', parent_id int null comment '父级id', path varchar(100) null comment '部门路径', constraint find_in_set_id_uindex unique (id) ); insert into find_in_set(dep_name, parent_id, path) values ('总公司',0,1), ('技术部','1','1,2'), ('人力部','1','1,3'), ('技术部下-java部门','2','1,2,4') 想查询技术部：\n1 2 3 select * from find_in_set where 2 in (path) 是没有数据的，因为in的条件，必须是完全匹配。所以使用find_in_set\n1 2 3 select * from find_in_set where find_in_set(2,path) 查询结果：\n1 2 2,技术部,1,\"1,2\" 4,技术部下-java部门,2,\"1,2,4\" 是符合预期的。\n和like的区别 like可能查到我们不想要的记录，find_in_set 比like更精准。\nMySQL判断时间段是否重合 如图，4种重合情况和2种不重合情况。 写法一：\n1 2 3 4 5 6 -- 时间段 a,b SELECT * FROM table WHERE (start_time \u003e= a and end_time \u003c= b) -- 被包含了 or (end_time \u003e= a and end_time \u003c=b) or (start_time \u003e= a and start_time \u003c=b) or (start_time \u003c= a and end_time \u003e=b) 解析：where后的4个条件分别代表了图中4种重合的情况。 但是第一种情况被2和3包含了，所以简化一下写法：　1 2 3 4 SELECT * FROM table WHERE (end_time \u003e= a and end_time \u003c=b) or (start_time \u003e= a and start_time \u003c=b) or (start_time \u003c= a and end_time \u003e=b); 写法二： SELECT * FROM table WHERE not (start_time \u003e b or end_time \u003c a);\n其他 mysql导入data文件夹 昨天服务器被挖矿病毒攻击，导致服务器无法访问，数据库无法连接。 解决过程：\n在阿里云控制台备份服务器硬盘快照 重装操作系统 将快照挂载到新系统上，我挂载到了/mnt目录下 进入/mnt目录，查看my.cnfvim etc/my.cnf，发现data文件在var/lib/mysql 进入目录cd var/lib/mysql，将该目录整体打包。 重新安装mysql，将新装mysql的var/lib/mysql删除，将刚才打包的data目录复制到/var/lib 解压，然后启动mysql 远程连接发现mysql无法访问，提示table xxxxx doesn't exist 在服务器任意位置输入mysql_upgrade -uroot -p --force，然后提示： 1 2 Upgrade process completed successfully. Checking if update is needed. 再次尝试远程连接，成功，数据都在！ 导入.frm和.ibd文件 .frm和.ibd分别对应数据库中的表名和表中的数据。 我们进入到mysql的data文件夹，找到一个库进去，可以证实我的想法。\n优化案例 原始sql：\n1 2 3 4 5 6 7 8 9 10 11 select t1.xx, t1.xx, t2.xx, t3.xx from table_1 t1 left join table_2 t2 on t1.user_id = t2.id left join table_3 t3 on t2.id = t3.user_id where 条件 group by t1.user_id order by 条件 sql解释：简单的left join，有问题的地方在于group by t1.user_id，根据 select 的执行顺序，group by 肯定是在left join 之后执行，所以这里因为 join 产生了很多没用的数据，所以优化思路是先 group by ，再 join。\n优化后：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 select t1.xx, t2.xx, t3.xx from ( select user_id, xx from table_1 where del_flag = 0 group by user_id -- 在这里先执行group by ) as t1 left join table_2 t2 on t1.user_id = t2.id left join table_3 t3 on t2.id = t3.user_id where 条件 order by 条件 思路就是先 group by 然后 join，这样少了很多因为 join 产生的笛卡尔积。\nmysql批量插入研究 本部分参考：https://blog.csdn.net/LJFPHP/article/details/99708888\n一次插入多少行数据效率最高？\n查看当前数据库的版本，毕竟各个版本之间存在差异\n1 select version(); 准备工作 插入到数据表的字段。 对于手动创建的临时表来说，字段当然是越少越好，而且字段占用的空间要尽量小一些，这样临时表不至于太大，影响表操作的性能。这里需要插入的字段是：\n1 2 3 4 字段1 int(10) 字段2 int(10) 字段3 int(10) 字段4 varchar(10) 我们一共插入四个字段，分别是3个int类型的，一个varchar类型的，整体来说这些字段都比较小，占用的内存空间会小一些。\n计算一行字段占用的空间。 对于innodb引擎来说，int类型可以存储4个字节，里面的Int(M)并不会影响存储字节的大小，这个M只是数据的展示位数，和mysql的ZEROFILL属性有关，即在数字长度不够的数据前面填充0，以达到设定的长度。此处不多说，想要了解的朋友可以百度一下，还是很有意思的。 varchar（10）代表可以存储10个字符，不管是英文还是中文，最多都是10个，这部分假设存储的是中文，在utf-8mb4下，10个中文占用10*4 = 40个字节那么一行数据最多占用：4+4+4+40 = 52字节\n在数据里做插入操作的时候，整体时间的分配 1 2 3 4 5 6 链接耗时 （30%） 发送query到服务器 （20%） 解析query （20%） 插入操作 （10% * 词条数目） 插入index （10% * Index的数目） 关闭链接 （10%） 从这里可以看出来，真正耗时的不是操作，而是链接，解析的过程。单条sql的话，会在链接，解析部分耗费大量的时间，因此速度会很慢，所以我们一般都是采用批量插入的操作，争取在一次链接里面写入尽可能多的数据，以此来提升插入的速度。但是这个尽可能多的数据是多少呢？一次到底插入多少才合适呢？\n批量插入数据测试 开始测试，但是一开始插入多少是合适的呢，是否有上限？查询mysql手册，我们知道sql语句是有大小限制的。\nmy.ini 里有 max_allowed_packet 这个参数控制通信的 packet 大小。mysql默认的sql语句的最大限制是1M（mysql5.7的客户端默认是16M，服务端默认是4M），可以根据设置查看。官方解释是适当增大 max_allowed_packet 参数可以使client端到server端传递大数据时，系统能够分配更多的扩展内存来处理。 官方手册：https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html\n查看服务器上的参数 1 2 3 4 5 6 7 8 mysql\u003e show variables like '%max_allowed_packet%'; +--------------------------+------------+ | Variable_name | Value | +--------------------------+------------+ | max_allowed_packet | 33554432 | | slave_max_allowed_packet | 1073741824 | +--------------------------+------------+ 2 rows in set (0.00 sec) 33554432字节 = 32M ，也就是规定大小不能超过32M。\n计算一次能插入的最大行记录 1M计算的话，(1024*1024)/52 ≈ 20165 ，为了防止溢出，最大可一次性插入20000条（根据自己的配置和sql语句大小计算）。那么32M的话就是：20000 *32 = 640000 也就是64W条。\n测试插入数据比对 插入11W条数据，按照每次10,600,1000，20000,80000来测试\n1 2 3 4 5 11W的数据，每次插入10条。耗时：2.361s 11W的数据，每次插入600条。耗时：0.523s 11W的数据，每次插入1000条。耗时：0.429s 11W的数据，每次插入20000条。耗时：0.426s 11W的数据，每次插入80000条。耗时：0.352s 从这部分看，随着批量插入的增加，速度略有提升，最起码一次插10条应该不是最佳的。插入数据量多，减少了循环的次数，也就是在数据库链接部分的耗时有所减少，只是这个8W并不是极限数据，具体一次插入多少条，还有待参考。\n加大数据量到24w。\n1 2 3 4 5 24W的数据，每次插入10条。耗时：4.445s 24W的数据，每次插入600条。耗时：1.187s 24W的数据，每次插入1000条。耗时：1.13s 24W的数据，每次插入20000条。耗时：0.933s 24W的数据，每次插入80000条。耗时：0.753s\t一次插入24W反而性能最佳，这么代表我们的测试数据量依然不够。\n加大测试量到42W。\n1 2 3 4 5 6 42W的数据，每次插入1000条。耗时：2.216s 42W的数据，每次插入80000条。耗时：1.777s 42W的数据，每次插入16W条。耗时：1.523s 42W的数据，每次插入20W条。耗时：1.432s 42W的数据，每次插入30W条。耗时：1.362s 42W的数据，每次插入40W条。耗时：1.764s 随着插入量的增加，批量插入条数多了之后，性能是有所提升的。但是在达到30W以上之后，效率反而有所下降。这部分我的理解是mysql是要分配一定的内存给传过来的数据包使用，当批量插入的数据量到达一定程度之后，一次插入操作的开销就很耗费内存了。个人感觉，最佳大小是max_allowed_packet的一半，也就是极限能插入64W，选用32W也许性能会更好一些，同时也不会对mysql的其他操作产生太大的影响。\n如果插入的值就是sql语句限制的最大值，那么性能真的好吗？ 客户端用一个单独的数据包将查询请求发送给服务器，所以当查询语句很长的时候，需要设置max_allowed_packet参数。但是需要注意的是，如果查询实在是太大，服务端会拒绝接收更多数据并抛出异常。与之相反的是，服务器响应给用户的数据通常会很多，由多个数据包组成。但是当服务器响应客户端请求时，客户端必须完整的接收整个返回结果，而不能简单的只取前面几条结果，然后让服务器停止发送。因而在实际开发中，尽量保持查询简单且只返回必需的数据，减小通信间数据包的大小和数量是一个非常好的习惯，这也是查询中尽量避免使用SELECT *以及加上LIMIT限制的原因之一。\n其他影响插入性能的因素 首先是插入的时候，要注意缓冲区的大小使用情况 在分析源码的过程中，有一句话：如果buffer pool余量不足25%，插入失败，返回DB_LOCK_TABLE_FULL。这个错误并不是直接报错：max_allowed_packet 不够大之类的，这个错误是因为对于innodb引擎来说，一次插入是涉及到事务和锁的，在插入索引的时候，要判断缓冲区的剩余情况，所以插入并不能仅仅只考虑max_allowed_packet的问题，也要考虑到缓冲区的大小。\n参考淘宝的数据库日报：\nhttp://mysql.taobao.org/monthly/2017/09/10/\n插入缓存 另外对于innodb引擎来说，因为存在插入缓存（Insert Buffer）这个概念，所以在插入的时候也是要耗费一定的缓冲池内存的。当写密集的情况下，插入缓冲会占用过多的缓冲池内存，默认最大可以占用到1/2的缓冲池内存，当插入缓冲占用太多缓冲池内存的情况下，会影响到其他的操作。 也就是说，插入缓冲受到缓冲池大小的影响，缓冲池大小为：\n1 2 3 4 5 6 mysql\u003e show variables like 'innodb_buffer_pool_size'; +-------------------------+-----------+ | Variable_name | Value | +-------------------------+-----------+ | innodb_buffer_pool_size | 134217728 | +-------------------------+-----------+ 换算后的结果为：128M，也就是说，插入缓存最多可以占用64M的缓冲区大小。这个大小要超过咱们设置的sql语句大小，所以可以忽略不计。\n详细解释：\n我们都知道，在InnoDB引擎上进行插入操作时，一般需要按照主键顺序进行插入，这样才能获得较高的插入性能。当一张表中存在非聚簇的且不唯一的索引时，在插入时，数据页的存放还是按照主键进行顺序存放， 但是对于非聚簇索引叶节点的插入不再是顺序的了，这时就需要离散的访问非聚簇索引页，由于随机读取的存在导致插入操作性能下降。\nInnoDB为此设计了Insert Buffer来进行插入优化。对于非聚簇索引的插入或者更新操作，不是每一次都直接插入到索引页中，而是先判断插入的非聚集索引是否在缓冲池中，若在，则直接插入；若不在，则先放入到一个Insert Buffer中。看似数据库这个非聚集的索引已经查到叶节点，而实际没有，这时存放在另外一个位置。然后再以一定的频率和情况进行Insert Buffer和非聚簇索引页子节点的合并操作。这时通常能够将多个插入合并到一个操作中，这样就大大提高了对于非聚簇索引的插入性能。 使用事务提升效率 还有一种说法，使用事务可以提高数据的插入效率，这是因为进行一个INSERT操作时，MySQL内部会建立一个事务，在事务内才进行真正插入处理操作。通过使用事务可以减少创建事务的消耗，所有插入都在执行后才进行提交操作。大概如下：\n1 2 3 4 5 6 7 START TRANSACTION; INSERT INTO `insert_table` (`datetime`, `uid`, `content`, `type`) VALUES ('0', 'userid_0', 'content_0', 0); INSERT INTO `insert_table` (`datetime`, `uid`, `content`, `type`) VALUES ('1', 'userid_1', 'content_1', 1); ... COMMIT; 事务需要控制大小，事务太大可能会影响执行的效率。MySQL有innodb_log_buffer_size配置项，超过这个值会把innodb的数据刷到磁盘中，这时，效率会有所下降。所以比较好的做法是，在数据达到这个这个值前进行事务提交。\n1 2 3 4 5 6 7 8 查看： show variables like '%innodb_log_buffer_size%'; +------------------------+----------+ | Variable_name | Value | +------------------------+----------+ | innodb_log_buffer_size | 67108864 | +------------------------+----------+ 大概是：64M 这种写法和批量写入的效果差不多，只不过sql语句还是单句的，然后统一提交。一个瓶颈是SQL语句的大小，一个瓶颈是事务的大小。当我们在提交sql的时候，首先是受到sql大小的限制，其次是受到事务大小的限制。在开启事务的情况下使用批量插入，会节省不少事务的开销，如果要追求极致的速度的话，建议是开着事务插入的。不过需要注意一下，内存是有限且共享的，如果批量插入占用太多的事务内存，那么势必会对其他的业务操作等有一定的影响。\n通过配置提升读写性能 也可以通过增大innodb_buffer_pool_size 缓冲区来提升读写性能，只是缓冲区是要占用内存空间的，内存很珍贵，所以这个方案在内存富裕，而性能瓶颈的时候，可以考虑下。\n参考：https://my.oschina.net/anuodog/blog/3002941\n索引影响插入性能 如果表中存在多个字段索引，当对表中的数据进行增加、删除和修改的时候，索引也要动态的维护。这样就降低了数据的插入速度。对于普通的数据表，主键索引是肯定要有的，想要加快性能的话，就是要有序插入，每次插入记录都在索引的最后面，索引的定位效率很高，并且对索引调整较小。如果插入的记录在索引中间，需要B+tree进行分裂合并等处理，会消耗比较多计算资源，并且插入记录的索引定位效率会下降，数据量较大时会有频繁的磁盘操作。\n",
  "wordCount" : "15365",
  "inLanguage": "en",
  "datePublished": "2019-12-02T18:13:55Z",
  "dateModified": "2019-12-02T18:13:55Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/mysql/mysql%E6%8A%80%E5%B7%A7/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

  <script id="MathJax-script" async src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-chtml.min.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath:  [['\\(', '\\)'], ['$', '$']],  
    }
  };
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      mysql技巧
    </h1>
    <div class="post-meta"><span title='2019-12-02 18:13:55 +0000 UTC'>2019-12-02</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#select%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f" aria-label="select执行顺序">select执行顺序</a></li>
                <li>
                    <a href="#%e6%97%b6%e9%97%b4%e7%9b%b8%e5%85%b3" aria-label="时间相关">时间相关</a></li>
                <li>
                    <a href="#rand" aria-label="rand()">rand()</a></li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e6%8f%92%e5%85%a5%e5%ad%98%e5%9c%a8%e4%b8%8d%e6%8f%92%e5%85%a5%e5%ad%98%e5%9c%a8%e6%9b%b4%e6%96%b0%e6%93%8d%e4%bd%9c" aria-label="并发插入、存在不插入、存在更新操作">并发插入、存在不插入、存在更新操作</a></li>
                <li>
                    <a href="#union-all%e5%92%8corder-by" aria-label="union all和order by">union all和order by</a></li>
                <li>
                    <a href="#mysql%e5%8d%95%e8%a1%a8%e5%a4%9a%e6%ac%a1%e6%9f%a5%e8%af%a2%e5%92%8c%e5%a4%9a%e8%a1%a8%e8%81%94%e5%90%88%e6%9f%a5%e8%af%a2%e5%93%aa%e4%b8%aa%e6%95%88%e7%8e%87%e9%ab%98" aria-label="MySQL单表多次查询和多表联合查询，哪个效率高？">MySQL单表多次查询和多表联合查询，哪个效率高？</a></li>
                <li>
                    <a href="#mysql%e5%ad%98%e5%82%a8%e8%a1%a8%e6%83%85" aria-label="mysql存储表情">mysql存储表情</a></li>
                <li>
                    <a href="#%e6%9f%a5%e6%a0%91%e7%9a%84%e6%89%80%e6%9c%89%e5%ad%90%e8%8a%82%e7%82%b9" aria-label="查树的所有子节点">查树的所有子节点</a><ul>
                        
                <li>
                    <a href="#%e6%96%b0%e7%9a%84%e6%80%9d%e8%b7%af" aria-label="新的思路">新的思路</a></li>
                <li>
                    <a href="#%e6%a0%b7%e4%be%8b%e6%95%b0%e6%8d%ae" aria-label="样例数据">样例数据</a></li>
                <li>
                    <a href="#%e6%96%b9%e6%b3%95%e4%b8%80%e5%88%a9%e7%94%a8%e5%87%bd%e6%95%b0%e6%9d%a5%e5%be%97%e5%88%b0%e6%89%80%e6%9c%89%e5%ad%90%e8%8a%82%e7%82%b9%e5%8f%b7" aria-label="方法一：利用函数来得到所有子节点号">方法一：利用函数来得到所有子节点号</a></li>
                <li>
                    <a href="#%e6%96%b9%e6%b3%95%e4%ba%8c%e5%88%a9%e7%94%a8%e4%b8%b4%e6%97%b6%e8%a1%a8%e5%92%8c%e8%bf%87%e7%a8%8b%e9%80%92%e5%bd%92" aria-label="方法二：利用临时表和过程递归">方法二：利用临时表和过程递归</a></li>
                <li>
                    <a href="#%e6%96%b9%e6%b3%95%e4%b8%89%e5%88%a9%e7%94%a8%e4%b8%ad%e9%97%b4%e8%a1%a8%e5%92%8c%e8%bf%87%e7%a8%8b" aria-label="方法三：利用中间表和过程">方法三：利用中间表和过程</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%80%e4%ba%9b%e7%89%b9%e6%ae%8a%e7%9a%84sql" aria-label="一些特殊的sql">一些特殊的sql</a><ul>
                        
                <li>
                    <a href="#%e5%87%ba%e8%87%aaarchive%e6%a1%a3%e6%a1%88%e7%ae%a1%e7%90%86%e7%b3%bb%e7%bb%9farchivemapperxml" aria-label="出自：archive档案管理系统，ArchiveMapper.xml">出自：archive档案管理系统，ArchiveMapper.xml</a></li>
                <li>
                    <a href="#2" aria-label="2">2</a></li>
                <li>
                    <a href="#%e5%88%a0%e9%99%a4parents%e8%a1%a8%e4%b8%ad%e6%89%8b%e6%9c%ba%e5%8f%b7%e9%87%8d%e5%a4%8d%e7%9a%84%e6%95%b0%e6%8d%ae" aria-label="删除parents表中手机号重复的数据">删除parents表中手机号重复的数据</a></li>
                <li>
                    <a href="#%e7%bb%9f%e8%ae%a1status%e5%88%86%e5%88%ab%e4%b8%ba1%e5%92%8c0%e7%9a%84%e6%95%b0%e6%8d%ae" aria-label="统计status分别为1和0的数据">统计status分别为1和0的数据</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0%e6%95%b0%e6%8d%ae" aria-label="更新数据">更新数据</a></li></ul>
                </li>
                <li>
                    <a href="#mysql-order-by-%e5%ad%97%e6%ae%b5%e6%9c%89%e7%9b%b8%e5%90%8c%e5%80%bc%e6%8e%92%e5%ba%8f%e5%87%ba%e6%9d%a5%e7%9a%84%e5%ad%97%e6%ae%b5%e4%bc%9a%e9%9a%8f%e6%9c%ba" aria-label="mysql order by 字段有相同值，排序出来的字段会随机">mysql order by 字段有相同值，排序出来的字段会随机</a></li>
                <li>
                    <a href="#letf-join-%e4%b9%8b%e5%90%8e%e7%9a%84%e6%9d%a1%e4%bb%b6%e5%92%8c%e6%94%be%e5%88%b0where%e4%b9%8b%e5%90%8e%e7%9a%84%e6%9d%a1%e4%bb%b6%e6%9c%89%e4%bb%80%e4%b9%88%e5%8c%ba%e5%88%ab" aria-label="letf join 之后的条件和放到where之后的条件，有什么区别">letf join 之后的条件和放到where之后的条件，有什么区别</a></li>
                <li>
                    <a href="#mysql-%e8%8e%b7%e5%8f%96%e6%8e%92%e5%88%97%e5%ba%8f%e5%8f%b7" aria-label="mysql 获取排列序号">mysql 获取排列序号</a><ul>
                        
                <li>
                    <a href="#%e6%a0%b9%e6%8d%ae%e6%9f%90%e5%ad%97%e6%ae%b5%e6%8c%89%e5%ba%8f%e6%8e%92%e5%88%97%e5%b9%b6%e8%8e%b7%e5%8f%96%e6%8e%92%e5%ba%8f%e5%8f%b7" aria-label="根据某字段按序排列并获取排序号">根据某字段按序排列并获取排序号</a></li>
                <li>
                    <a href="#%e6%a0%b9%e6%8d%ae%e6%9f%90%e5%ad%97%e6%ae%b5%e6%8c%89%e5%ba%8f%e6%8e%92%e5%88%97%e8%8e%b7%e5%8f%96%e6%8e%92%e5%ba%8f%e5%8f%b7%e4%b8%94%e5%bd%93%e8%af%a5%e5%ad%97%e6%ae%b5%e7%9a%84%e5%80%bc%e5%ad%98%e5%9c%a8%e5%a4%9a%e4%b8%aa%e7%9b%b8%e5%90%8c%e7%9a%84%e8%ae%b0%e5%bd%95%e6%97%b6%e5%88%99%e7%9b%b8%e5%90%8c%e5%80%bc%e6%8e%92%e5%ba%8f%e5%8f%b7%e7%9b%b8%e5%90%8c" aria-label="根据某字段按序排列获取排序号，且当该字段的值存在多个相同的记录时，则相同值排序号相同">根据某字段按序排列获取排序号，且当该字段的值存在多个相同的记录时，则相同值排序号相同</a></li>
                <li>
                    <a href="#%e6%a0%b9%e6%8d%ae%e6%9f%90%e5%ad%97%e6%ae%b5%e6%8c%89%e5%ba%8f%e6%8e%92%e5%88%97%e8%8e%b7%e5%8f%96%e6%8e%92%e5%ba%8f%e5%8f%b7%e4%b8%94%e5%bd%93%e8%af%a5%e5%ad%97%e6%ae%b5%e7%9a%84%e5%80%bc%e5%ad%98%e5%9c%a8%e5%a4%9a%e4%b8%aa%e7%9b%b8%e5%90%8c%e7%9a%84%e8%ae%b0%e5%bd%95%e6%97%b6%e5%88%99%e7%9b%b8%e5%90%8c%e5%80%bc%e7%9a%84%e8%ae%b0%e5%bd%95%e7%9a%84%e6%8e%92%e5%ba%8f%e5%8f%b7%e7%9b%b8%e5%90%8c%e5%b9%b6%e4%b8%94%e4%b8%8b%e4%b8%80%e7%bb%84%e5%80%bc%e7%9a%84%e6%8e%92%e5%ba%8f%e5%8f%b7%e4%b8%ba%e4%b8%8a%e4%b8%80%e7%bb%84%e5%86%85%e8%ae%b0%e5%bd%95%e6%95%b0%e4%b8%8a%e4%b8%80%e4%b8%aa%e6%8e%92%e5%ba%8f%e5%8f%b7" aria-label="根据某字段按序排列获取排序号，且当该字段的值存在多个相同的记录时，则相同值的记录的排序号相同，并且下一组值的排序号为上一组内记录数&#43;上一个排序号">根据某字段按序排列获取排序号，且当该字段的值存在多个相同的记录时，则相同值的记录的排序号相同，并且下一组值的排序号为上一组内记录数+上一个排序号</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%8a%80%e5%b7%a7" aria-label="技巧">技巧</a><ul>
                        
                <li>
                    <a href="#mysql%e6%8c%89%e5%a4%a9%e7%bb%9f%e8%ae%a1%e6%95%b0%e6%8d%ae" aria-label="mysql按天统计数据">mysql按天统计数据</a></li>
                <li>
                    <a href="#mysql%e8%8e%b7%e5%8f%96%e5%a5%87%e6%95%b0%e5%81%b6%e6%95%b0" aria-label="mysql获取奇数偶数">mysql获取奇数偶数</a></li>
                <li>
                    <a href="#%e4%bb%8a%e5%a4%a9%e9%81%87%e5%88%b0%e7%9a%84%e5%a5%87%e6%80%aabug" aria-label="今天遇到的奇怪bug">今天遇到的奇怪bug</a></li>
                <li>
                    <a href="#%e7%bb%9f%e8%ae%a1%e8%bf%9e%e7%bb%ad%e5%a4%a9%e6%95%b0" aria-label="统计连续天数">统计连续天数</a></li>
                <li>
                    <a href="#%e7%bb%99%e6%9f%a5%e8%af%a2%e8%ae%b0%e5%bd%95%e6%b7%bb%e5%8a%a0%e8%87%aa%e7%84%b6%e5%ba%8f%e5%8f%b7" aria-label="给查询记录添加自然序号">给查询记录添加自然序号</a></li>
                <li>
                    <a href="#group_concat" aria-label="group_concat">group_concat</a></li>
                <li>
                    <a href="#null%e5%80%bc%e6%8e%92%e5%ba%8f" aria-label="null值排序">null值排序</a></li>
                <li>
                    <a href="#mysql-datetime%e7%b1%bb%e5%9e%8b%e6%97%b6%e9%97%b4%e9%94%99%e8%af%af" aria-label="mysql datetime类型时间错误">mysql datetime类型时间错误</a><ul>
                        
                <li>
                    <a href="#%e8%a7%a3%e5%86%b3%e6%96%b9%e5%bc%8f%e4%b8%80" aria-label="解决方式一">解决方式一</a></li>
                <li>
                    <a href="#%e8%a7%a3%e5%86%b3%e6%96%b9%e5%bc%8f%e4%ba%8c" aria-label="解决方式二">解决方式二</a></li></ul>
                </li>
                <li>
                    <a href="#group-by-%e8%8e%b7%e5%8f%96%e6%9c%80%e6%96%b0%e7%9a%84%e6%95%b0%e6%8d%ae" aria-label="group by 获取最新的数据">group by 获取最新的数据</a></li>
                <li>
                    <a href="#%e5%ad%90%e6%9f%a5%e8%af%a2order-by%e5%92%8c%e5%a4%96%e5%b1%82group-by" aria-label="子查询order by和外层group by">子查询order by和外层group by</a></li>
                <li>
                    <a href="#case-when%e7%9a%84%e5%87%a0%e7%a7%8d%e5%bd%a2%e5%bc%8f" aria-label="case-when的几种形式">case-when的几种形式</a></li>
                <li>
                    <a href="#find_in_set" aria-label="find_in_set">find_in_set</a><ul>
                        
                <li>
                    <a href="#find_in_set%e5%92%8cin%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="find_in_set()和in的区别">find_in_set()和in的区别</a></li>
                <li>
                    <a href="#%e5%92%8clike%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="和like的区别">和like的区别</a></li></ul>
                </li>
                <li>
                    <a href="#mysql%e5%88%a4%e6%96%ad%e6%97%b6%e9%97%b4%e6%ae%b5%e6%98%af%e5%90%a6%e9%87%8d%e5%90%88" aria-label="MySQL判断时间段是否重合">MySQL判断时间段是否重合</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96" aria-label="其他">其他</a><ul>
                        
                <li>
                    <a href="#mysql%e5%af%bc%e5%85%a5data%e6%96%87%e4%bb%b6%e5%a4%b9" aria-label="mysql导入data文件夹">mysql导入data文件夹</a></li>
                <li>
                    <a href="#%e5%af%bc%e5%85%a5frm%e5%92%8cibd%e6%96%87%e4%bb%b6" aria-label="导入.frm和.ibd文件">导入.frm和.ibd文件</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bc%98%e5%8c%96%e6%a1%88%e4%be%8b" aria-label="优化案例">优化案例</a></li>
                <li>
                    <a href="#mysql%e6%89%b9%e9%87%8f%e6%8f%92%e5%85%a5%e7%a0%94%e7%a9%b6" aria-label="mysql批量插入研究">mysql批量插入研究</a><ul>
                        
                <li>
                    <a href="#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c" aria-label="准备工作">准备工作</a><ul>
                        
                <li>
                    <a href="#%e6%8f%92%e5%85%a5%e5%88%b0%e6%95%b0%e6%8d%ae%e8%a1%a8%e7%9a%84%e5%ad%97%e6%ae%b5" aria-label="插入到数据表的字段。">插入到数据表的字段。</a></li>
                <li>
                    <a href="#%e8%ae%a1%e7%ae%97%e4%b8%80%e8%a1%8c%e5%ad%97%e6%ae%b5%e5%8d%a0%e7%94%a8%e7%9a%84%e7%a9%ba%e9%97%b4" aria-label="计算一行字段占用的空间。">计算一行字段占用的空间。</a></li>
                <li>
                    <a href="#%e5%9c%a8%e6%95%b0%e6%8d%ae%e9%87%8c%e5%81%9a%e6%8f%92%e5%85%a5%e6%93%8d%e4%bd%9c%e7%9a%84%e6%97%b6%e5%80%99%e6%95%b4%e4%bd%93%e6%97%b6%e9%97%b4%e7%9a%84%e5%88%86%e9%85%8d" aria-label="在数据里做插入操作的时候，整体时间的分配">在数据里做插入操作的时候，整体时间的分配</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%89%b9%e9%87%8f%e6%8f%92%e5%85%a5%e6%95%b0%e6%8d%ae%e6%b5%8b%e8%af%95" aria-label="批量插入数据测试">批量插入数据测试</a><ul>
                        
                <li>
                    <a href="#%e6%9f%a5%e7%9c%8b%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%8a%e7%9a%84%e5%8f%82%e6%95%b0" aria-label="查看服务器上的参数">查看服务器上的参数</a></li>
                <li>
                    <a href="#%e8%ae%a1%e7%ae%97%e4%b8%80%e6%ac%a1%e8%83%bd%e6%8f%92%e5%85%a5%e7%9a%84%e6%9c%80%e5%a4%a7%e8%a1%8c%e8%ae%b0%e5%bd%95" aria-label="计算一次能插入的最大行记录">计算一次能插入的最大行记录</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e6%8f%92%e5%85%a5%e6%95%b0%e6%8d%ae%e6%af%94%e5%af%b9" aria-label="测试插入数据比对">测试插入数据比对</a></li>
                <li>
                    <a href="#%e5%a6%82%e6%9e%9c%e6%8f%92%e5%85%a5%e7%9a%84%e5%80%bc%e5%b0%b1%e6%98%afsql%e8%af%ad%e5%8f%a5%e9%99%90%e5%88%b6%e7%9a%84%e6%9c%80%e5%a4%a7%e5%80%bc%e9%82%a3%e4%b9%88%e6%80%a7%e8%83%bd%e7%9c%9f%e7%9a%84%e5%a5%bd%e5%90%97" aria-label="如果插入的值就是sql语句限制的最大值，那么性能真的好吗？">如果插入的值就是sql语句限制的最大值，那么性能真的好吗？</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e5%bd%b1%e5%93%8d%e6%8f%92%e5%85%a5%e6%80%a7%e8%83%bd%e7%9a%84%e5%9b%a0%e7%b4%a0" aria-label="其他影响插入性能的因素">其他影响插入性能的因素</a><ul>
                        
                <li>
                    <a href="#%e9%a6%96%e5%85%88%e6%98%af%e6%8f%92%e5%85%a5%e7%9a%84%e6%97%b6%e5%80%99%e8%a6%81%e6%b3%a8%e6%84%8f%e7%bc%93%e5%86%b2%e5%8c%ba%e7%9a%84%e5%a4%a7%e5%b0%8f%e4%bd%bf%e7%94%a8%e6%83%85%e5%86%b5" aria-label="首先是插入的时候，要注意缓冲区的大小使用情况">首先是插入的时候，要注意缓冲区的大小使用情况</a></li>
                <li>
                    <a href="#%e6%8f%92%e5%85%a5%e7%bc%93%e5%ad%98" aria-label="插入缓存">插入缓存</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e4%ba%8b%e5%8a%a1%e6%8f%90%e5%8d%87%e6%95%88%e7%8e%87" aria-label="使用事务提升效率">使用事务提升效率</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87%e9%85%8d%e7%bd%ae%e6%8f%90%e5%8d%87%e8%af%bb%e5%86%99%e6%80%a7%e8%83%bd" aria-label="通过配置提升读写性能">通过配置提升读写性能</a></li>
                <li>
                    <a href="#%e7%b4%a2%e5%bc%95%e5%bd%b1%e5%93%8d%e6%8f%92%e5%85%a5%e6%80%a7%e8%83%bd" aria-label="索引影响插入性能">索引影响插入性能</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="select执行顺序">select执行顺序<a hidden class="anchor" aria-hidden="true" href="#select执行顺序">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>(7) SELECT
</span></span><span style="display:flex;"><span>(8) DISTINCT &lt;select_list&gt;
</span></span><span style="display:flex;"><span>(1) FROM &lt;left_table&gt;
</span></span><span style="display:flex;"><span>(3) &lt;join_type&gt; JOIN &lt;right_table&gt;
</span></span><span style="display:flex;"><span>(2) ON &lt;join_condition&gt;
</span></span><span style="display:flex;"><span>(4) WHERE &lt;where_condition&gt;
</span></span><span style="display:flex;"><span>(5) GROUP BY &lt;group_by_list&gt;
</span></span><span style="display:flex;"><span>(6) HAVING &lt;having_condition&gt;
</span></span><span style="display:flex;"><span>(9) ORDER BY &lt;order_by_condition&gt;
</span></span><span style="display:flex;"><span>(10) LIMIT &lt;limit_number&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>select 执行顺序一共分为10步。其中每一次操作都会产生一张虚拟的表，只是这些虚拟的表对用户来说是透明的，但是只有最后一个虚拟的表才会被作为结果返回。如果没有在语句中指定某一个子句，那么将会跳过相应的步骤。</p>
<ol>
<li>from：对 from 左边的表和右边的表计算笛卡尔积，产生虚表VT1。</li>
<li>on：对虚表VT1进行ON过滤，只有那些符合 join 的行才会被记录在虚表VT2中。</li>
<li>join： 如果指定了OUTER JOIN（比如left join、 right join），那么保留表中未匹配的行就会作为外部行添加到虚拟表VT2中，产生虚拟表VT3。</li>
<li>where： 对虚拟表VT3进行WHERE条件过滤。只有符合 where 的记录才会被插入到虚拟表VT4中。</li>
<li>group by ：根据group by子句中的列，对VT4中的记录进行分组操作，产生VT5。</li>
<li>having： 对虚拟表VT5应用having过滤，只有符合 having 的记录才会被 插入到虚拟表VT6中。</li>
<li>select：执行select操作，选择指定的列，插入到虚拟表VT7中。</li>
<li>distinct：对VT7中的记录进行去重。产生虚拟表VT8。</li>
<li>order by ：将虚拟表VT8中的记录按照 order by 进行排序操作，产生虚拟表VT9。</li>
<li>limit：取出指定行的记录，产生虚拟表VT10，并将结果返回。</li>
</ol>
<h1 id="时间相关">时间相关<a hidden class="anchor" aria-hidden="true" href="#时间相关">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f00">获取今天到明天的数据</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> date_format(create_date,<span style="color:#0ff;font-weight:bold">&#39;%y-%m-%d&#39;</span>) 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">BETWEEN</span> date_format(curdate(),<span style="color:#0ff;font-weight:bold">&#39;%y-%m-%d&#39;</span>) 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">and</span> DATE_SUB(curdate(),<span style="color:#fff;font-weight:bold">INTERVAL</span> -<span style="color:#ff0;font-weight:bold">1</span> <span style="color:#fff;font-weight:bold">DAY</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">当天数据</span><span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> date_format(create_date,<span style="color:#0ff;font-weight:bold">&#39;%y-%m-%d&#39;</span>) = date_format(curdate(),<span style="color:#0ff;font-weight:bold">&#39;%y-%m-%d&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">当天数据</span><span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> <span style="color:#f00">表名</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> to_days(<span style="color:#f00">时间字段名</span>) = to_days(now());
</span></span><span style="display:flex;"><span><span style="color:#f00">注：</span>to_days <span style="color:#f00">是</span>mysql<span style="color:#f00">的函数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">昨天数据</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> * <span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#f00">表名</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> TO_DAYS( NOW( ) ) - TO_DAYS( <span style="color:#f00">时间字段名</span>) &lt;= <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">近</span><span style="color:#ff0;font-weight:bold">7</span><span style="color:#f00">天</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> * <span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#f00">表名</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> DATE_SUB(CURDATE(), <span style="color:#fff;font-weight:bold">INTERVAL</span> <span style="color:#ff0;font-weight:bold">7</span> <span style="color:#fff;font-weight:bold">DAY</span>) &lt;= <span style="color:#fff;font-weight:bold">date</span>(<span style="color:#f00">时间字段名</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">近</span><span style="color:#ff0;font-weight:bold">30</span><span style="color:#f00">天</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> * <span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#f00">表名</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> DATE_SUB(CURDATE(), <span style="color:#fff;font-weight:bold">INTERVAL</span> <span style="color:#ff0;font-weight:bold">30</span> <span style="color:#fff;font-weight:bold">DAY</span>) &lt;= <span style="color:#fff;font-weight:bold">date</span>(<span style="color:#f00">时间字段名</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">本月</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> * <span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#f00">表名</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> DATE_FORMAT( <span style="color:#f00">时间字段名</span>, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span> ) = DATE_FORMAT( CURDATE( ) , <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">上一月</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> * <span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#f00">表名</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> PERIOD_DIFF( date_format( now( ) , <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span> ) , date_format( <span style="color:#f00">时间字段名</span>, <span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span> ) ) =<span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">查询本季度数据</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> `ht_invoice_information`
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> QUARTER(create_date)=QUARTER(now());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">查询上季度数据</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> `ht_invoice_information`
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> QUARTER(create_date)=QUARTER(DATE_SUB(now(),<span style="color:#fff;font-weight:bold">interval</span> <span style="color:#ff0;font-weight:bold">1</span> QUARTER));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">查询本年数据</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> `ht_invoice_information`
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> <span style="color:#fff;font-weight:bold">YEAR</span>(create_date)=<span style="color:#fff;font-weight:bold">YEAR</span>(NOW());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">查询上年数据</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> `ht_invoice_information` 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> <span style="color:#fff;font-weight:bold">year</span>(create_date)=<span style="color:#fff;font-weight:bold">year</span>(date_sub(now(),<span style="color:#fff;font-weight:bold">interval</span> <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#fff;font-weight:bold">year</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">查询当前这周的数据</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> name,create_time <span style="color:#fff;font-weight:bold">FROM</span> enterprise
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> YEARWEEK(date_format(create_time,<span style="color:#0ff;font-weight:bold">&#39;%Y-%m-%d&#39;</span>)) = YEARWEEK(now());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">查询上周的数据</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> name,submittime <span style="color:#fff;font-weight:bold">FROM</span> enterprise 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> YEARWEEK(date_format(submittime,<span style="color:#0ff;font-weight:bold">&#39;%Y-%m-%d&#39;</span>)) = YEARWEEK(now())-<span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">查询上个月的数据</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> name,submittime <span style="color:#fff;font-weight:bold">from</span> enterprise 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> date_format(submittime,<span style="color:#0ff;font-weight:bold">&#39;%Y-%m&#39;</span>) = date_format(DATE_SUB(curdate(), <span style="color:#fff;font-weight:bold">INTERVAL</span> <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#fff;font-weight:bold">MONTH</span>),<span style="color:#0ff;font-weight:bold">&#39;%Y-%m&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> <span style="color:#fff;font-weight:bold">user</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> DATE_FORMAT(pudate,<span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) = DATE_FORMAT(CURDATE(),<span style="color:#0ff;font-weight:bold">&#39;%Y%m&#39;</span>) ; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> <span style="color:#fff;font-weight:bold">user</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> WEEKOFYEAR(FROM_UNIXTIME(pudate,<span style="color:#0ff;font-weight:bold">&#39;%y-%m-%d&#39;</span>)) = WEEKOFYEAR(now()) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> <span style="color:#fff;font-weight:bold">user</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> <span style="color:#fff;font-weight:bold">MONTH</span>(FROM_UNIXTIME(pudate,<span style="color:#0ff;font-weight:bold">&#39;%y-%m-%d&#39;</span>)) = <span style="color:#fff;font-weight:bold">MONTH</span>(now()) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> <span style="color:#fff;font-weight:bold">user</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> <span style="color:#fff;font-weight:bold">YEAR</span>(FROM_UNIXTIME(pudate,<span style="color:#0ff;font-weight:bold">&#39;%y-%m-%d&#39;</span>)) = <span style="color:#fff;font-weight:bold">YEAR</span>(now()) 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">and</span> <span style="color:#fff;font-weight:bold">MONTH</span>(FROM_UNIXTIME(pudate,<span style="color:#0ff;font-weight:bold">&#39;%y-%m-%d&#39;</span>)) = <span style="color:#fff;font-weight:bold">MONTH</span>(now()) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> <span style="color:#fff;font-weight:bold">user</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> pudate <span style="color:#fff;font-weight:bold">between</span>  <span style="color:#f00">上月最后一天</span>  <span style="color:#fff;font-weight:bold">and</span> <span style="color:#f00">下月第一天</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">查询当前月份的数据</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> name,submittime <span style="color:#fff;font-weight:bold">from</span> enterprise 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> date_format(submittime,<span style="color:#0ff;font-weight:bold">&#39;%Y-%m&#39;</span>)=date_format(now(),<span style="color:#0ff;font-weight:bold">&#39;%Y-%m&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">查询距离当前现在</span><span style="color:#ff0;font-weight:bold">6</span><span style="color:#f00">个月的数据</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> name,submittime <span style="color:#fff;font-weight:bold">from</span> enterprise 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> submittime <span style="color:#fff;font-weight:bold">between</span> date_sub(now(),<span style="color:#fff;font-weight:bold">interval</span> <span style="color:#ff0;font-weight:bold">6</span> <span style="color:#fff;font-weight:bold">month</span>) <span style="color:#fff;font-weight:bold">and</span> now();
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="rand">rand()<a hidden class="anchor" aria-hidden="true" href="#rand">#</a></h1>
<p>order by RAND()：随机返回结果，随机函数效率很低，尽量不要使用，因为它的效率会随着数据量的增大，效率越来越低。</p>
<p>推荐一种：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	* 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	`question` <span style="color:#fff;font-weight:bold">AS</span> t1
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">JOIN</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>		ROUND(
</span></span><span style="display:flex;"><span>			RAND( ) * ( ( <span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">MAX</span>( id ) <span style="color:#fff;font-weight:bold">FROM</span> `question` ) 
</span></span><span style="display:flex;"><span>			- ( <span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">MIN</span>( id ) <span style="color:#fff;font-weight:bold">FROM</span> `question` ) ) 
</span></span><span style="display:flex;"><span>			+ ( <span style="color:#fff;font-weight:bold">SELECT</span> <span style="color:#fff;font-weight:bold">MIN</span>( id ) <span style="color:#fff;font-weight:bold">FROM</span> `question` ) 
</span></span><span style="display:flex;"><span>		) <span style="color:#fff;font-weight:bold">AS</span> id 
</span></span><span style="display:flex;"><span>	) <span style="color:#fff;font-weight:bold">AS</span> t2 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>	t1.id &gt;= t2.id 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	t1.id 
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">LIMIT</span> <span style="color:#ff0;font-weight:bold">5</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>加上MIN(id)的判断，是因为最开始测试的时候，因为没有加上MIN(id)的判断，结果有一半的时间总是查询到表中的前面几行。这种方法缺点是会产生id连续的数据。</p>
<h1 id="并发插入存在不插入存在更新操作">并发插入、存在不插入、存在更新操作<a hidden class="anchor" aria-hidden="true" href="#并发插入存在不插入存在更新操作">#</a></h1>
<ol>
<li>
<p>通常会，先查询，不存在再插入，但是这样无法避免并发问题，不用考虑了。</p>
</li>
<li>
<p>使用<code>replace into</code>，存在即更新，不存在即插入
<code>replace into table (id,name) values(1,&quot;小明&quot;)</code>
如果发现表中已经有此行数据（根据主键或者唯一索引判断），则先删除此行数据，然后插入新的数据，否则，直接插入新数据。所以，插入时如果不插入主键(逐渐默认递增)，就需要保证一列是唯一索引，保证唯一，才可以。</p>
</li>
<li>
<p>存在不插入，不存在再插入(感觉这种方法是最好的)
mysql 不能在插入时带where条件，故用临时表处理</p>
</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>INSERT INTO demo_in(a,b,c) 
</span></span><span style="display:flex;"><span>SELECT 123, 2, 4 FROM DUAL 
</span></span><span style="display:flex;"><span>WHERE NOT EXISTS(SELECT c FROM demo_in WHERE c = 4);
</span></span></code></pre></td></tr></table>
</div>
</div><p>用临时表DUAL来标记数据，然后插入到demo_in表中。
条件是c=4，并且not exists，也就是当c=4条件满足，则不插入。</p>
<h1 id="union-all和order-by">union all和order by<a hidden class="anchor" aria-hidden="true" href="#union-all和order-by">#</a></h1>
<p>多个select 语句 union 时不是简单的将查询结果拼接起来 而是将sql拼接起来编译（做为一个sql语句），然后去执行。所以union 连接的语句中只会出现一个order by （不包含子查询中的），否则会报 sql未正确结束的错误。解决方法：将order by 语句放到子查询中。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f00">将排序后的查询结果拼接起来</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span>(<span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> <span style="color:#fff;font-weight:bold">table</span> <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> a)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">union</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> (<span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> table1 <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> b)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">union</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> (<span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> table2 <span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> <span style="color:#fff;font-weight:bold">c</span>);//<span style="color:#f00">注意，这里的</span><span style="color:#fff;font-weight:bold">order</span> by<span style="color:#f00">会失效</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> d
</span></span><span style="display:flex;"><span><span style="color:#f00">此处的</span><span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> <span style="color:#f00">是将最后的拼接结果集排序，打乱了之前通过</span> a<span style="color:#f00">、</span>b<span style="color:#f00">、</span>c<span style="color:#f00">的排序。</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="mysql单表多次查询和多表联合查询哪个效率高">MySQL单表多次查询和多表联合查询，哪个效率高？<a hidden class="anchor" aria-hidden="true" href="#mysql单表多次查询和多表联合查询哪个效率高">#</a></h1>
<p>很多高性能的应用都会对关联查询进行分解。
简单地，可以对每个表进行一次单表查询，然后将结果在应用程序中进行关联。例如，下面这个查询：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>select * from tableA a
</span></span><span style="display:flex;"><span>join tableB b on b.tableA_id = a.id
</span></span><span style="display:flex;"><span>join tableC c on c.tableB_id = b.id
</span></span><span style="display:flex;"><span>where a.name = &#39;123&#39;;
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以分解成下面这些查询来代替：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>select id from tableA where name = &#39;123&#39;; -- 结果A
</span></span><span style="display:flex;"><span>select * from tableB where tableA_id = id(结果A) -- 结果B
</span></span><span style="display:flex;"><span>select * from tableC where id in (结果B)
</span></span></code></pre></td></tr></table>
</div>
</div><p>到底为什么要这样做？
起初感觉，这样做并没有什么好处，原本一条查询，这里却变成了多条查询，返回结果又是一模一样。
事实上，用分解关联查询的方式重构查询具有如下优势：</p>
<ul>
<li>让缓存效率更高
对于MySQL的查询缓存来说，如果关联中的某个表发生了变化，那么就无法使用查询缓存了，而拆分后，如果某个表很少改变，那么基于该表的查询就可以重复利用查询缓存结果了。</li>
<li>可以减少冗余记录的查询。</li>
<li>查询本身效率也可能会有所提升</li>
<li>将查询分解后，执行单个查询可以减少锁的竞争。</li>
<li>在应用层做关联，可以更容易对数据库进行拆分，更容易做到高性能和可扩展。</li>
<li>这样做相当于在应用中实现了哈希关联，而不是使用MySQL的嵌套环关联，某些场景哈希关联的效率更高很多。</li>
</ul>
<h1 id="mysql存储表情">mysql存储表情<a hidden class="anchor" aria-hidden="true" href="#mysql存储表情">#</a></h1>
<p>存储表情时报错：
<code>java.sql.SQLException: Incorrect string value: '\xF0\x9F\x92\x94' for colum n 'name' at row 1 </code>
使用mysql数据库的时候，如果字符集是UTF-8，当存储emoji表情的时候，会抛出以上异常。
这是由于字符集不支持的异常，因为utf-8编码有可能是两个，三个，四个字节，其中Emoji表情是四个字节，而mysql的utf-8编码最多三个字节，所以导致数据插不进去。
解决：</p>
<ol>
<li>修改database、table、column字符集</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ALTER DATABASE database_name CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;
</span></span><span style="display:flex;"><span>ALTER TABLE table_name CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
</span></span><span style="display:flex;"><span>ALTER TABLE table_name CHANGE column_name VARCHAR(191) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
</span></span></code></pre></td></tr></table>
</div>
</div><p>除了column的字符集，库和表的字符集不是必须修改。</p>
<ol start="2">
<li>修改mysql配置文件</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[client]
</span></span><span style="display:flex;"><span>default-character-set = utf8mb4
</span></span><span style="display:flex;"><span>[mysql]
</span></span><span style="display:flex;"><span>default-character-set = utf8mb4
</span></span><span style="display:flex;"><span>[mysqld]
</span></span><span style="display:flex;"><span>character-set-client-handshake = FALSE
</span></span><span style="display:flex;"><span>character-set-server = utf8mb4
</span></span><span style="display:flex;"><span>collation-server = utf8mb4_unicode_ci
</span></span><span style="display:flex;"><span>init_connect=&#39;SET NAMES utf8mb4&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>检查<code>mysql-connector-java</code>版本，必须高于5.1.13否则仍然不能试用utf8mb4</li>
<li>修改链接数据库地址</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>jdbc:mysql://localhost:3306/test?
</span></span><span style="display:flex;"><span>&#34;useUnicode=true&#34; +
</span></span><span style="display:flex;"><span>&#34;&amp;characterEncoding=UTF-8&#34; +
</span></span><span style="display:flex;"><span>&#34;&amp;zeroDateTimeBehavior=convertToNull&#34; +
</span></span><span style="display:flex;"><span>&#34;&amp;useSSL=false&#34; +
</span></span><span style="display:flex;"><span>&#34;&amp;allowMultiQueries=true&#34; +
</span></span><span style="display:flex;"><span>&#34;&amp;autoReconnect=true&#34; +
</span></span><span style="display:flex;"><span>&#34;&amp;rewriteBatchedStatements=TRUE&#34;);
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果升级了mysql-connector，其中的characterEncoding=utf8可以自动被识别为utf8mb4（兼容原来的utf8），而autoReconnection（当数据库连接异常中断时，是否自动重新连接？默认为false）强烈建议配上，忽略这个属性，可能导致缓存缘故 ，没有读取到DB最新的配置，导致一直无法试用utf8mb4字符集。</p>
<h1 id="查树的所有子节点">查树的所有子节点<a hidden class="anchor" aria-hidden="true" href="#查树的所有子节点">#</a></h1>
<p>在Oracle 中我们知道有一个 Hierarchical Queries 通过CONNECT BY 我们可以方便的查了所有当前节点下的所有子节点。但很遗憾，在MySQL的目前版本中还没有对应的功能。
在MySQL中如果是有限的层次，比如我们事先如果可以确定这个树的最大深度是4, 那么所有节点为根的树的深度均不会超过4，则我们可以直接通过left join 来实现。
但很多时候我们无法控制树的深度。这时就需要在MySQL中用存储过程来实现或在你的程序中来实现这个递归。本文讨论一下几种实现的方法。</p>
<h2 id="新的思路">新的思路<a hidden class="anchor" aria-hidden="true" href="#新的思路">#</a></h2>
<p>解决这种树状结构问题，可以在表中加一个字段<code>path</code>，标识这条数据的路径，即父子级结构路径。</p>
<table>
<thead>
<tr>
<th>id</th>
<th>公司名</th>
<th>parent_id</th>
<th>path</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>总公司</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>技术部</td>
<td>1</td>
<td>1,2</td>
</tr>
<tr>
<td>3</td>
<td>人力部</td>
<td>1</td>
<td>1,3</td>
</tr>
<tr>
<td>4</td>
<td>技术部下-java部门</td>
<td>2</td>
<td>1,2,4</td>
</tr>
</tbody>
</table>
<p>这样如果我想查总公司下有哪些部门，需要使用mysql 函数<code>FIND_IN_SET(str,strlist)</code>，like是不行的。</p>
<h2 id="样例数据">样例数据<a hidden class="anchor" aria-hidden="true" href="#样例数据">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>create table treeNodes
</span></span><span style="display:flex;"><span>	(
</span></span><span style="display:flex;"><span>	id int primary key,
</span></span><span style="display:flex;"><span>	nodename varchar(20),
</span></span><span style="display:flex;"><span>	pid int
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>select * from treenodes;
</span></span><span style="display:flex;"><span>+----+----------+------+
</span></span><span style="display:flex;"><span>| id | nodename | pid  |
</span></span><span style="display:flex;"><span>+----+----------+------+
</span></span><span style="display:flex;"><span>|  1 | A        |    0 |
</span></span><span style="display:flex;"><span>|  2 | B        |    1 |
</span></span><span style="display:flex;"><span>|  3 | C        |    1 |
</span></span><span style="display:flex;"><span>|  4 | D        |    2 |
</span></span><span style="display:flex;"><span>|  5 | E        |    2 |
</span></span><span style="display:flex;"><span>|  6 | F        |    3 |
</span></span><span style="display:flex;"><span>|  7 | G        |    6 |
</span></span><span style="display:flex;"><span>|  8 | H        |    0 |
</span></span><span style="display:flex;"><span>|  9 | I        |    8 |
</span></span><span style="display:flex;"><span>| 10 | J        |    8 |
</span></span><span style="display:flex;"><span>| 11 | K        |    8 |
</span></span><span style="display:flex;"><span>| 12 | L        |    9 |
</span></span><span style="display:flex;"><span>| 13 | M        |    9 |
</span></span><span style="display:flex;"><span>| 14 | N        |   12 |
</span></span><span style="display:flex;"><span>| 15 | O        |   12 |
</span></span><span style="display:flex;"><span>| 16 | P        |   15 |
</span></span><span style="display:flex;"><span>| 17 | Q        |   15 |
</span></span><span style="display:flex;"><span>+----+----------+------+	
</span></span></code></pre></td></tr></table>
</div>
</div><p>树形图如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1:A
</span></span><span style="display:flex;"><span>  +-- 2:B
</span></span><span style="display:flex;"><span>  |    +-- 4:D
</span></span><span style="display:flex;"><span>  |    +-- 5:E
</span></span><span style="display:flex;"><span>  +-- 3:C
</span></span><span style="display:flex;"><span>       +-- 6:F
</span></span><span style="display:flex;"><span>            +-- 7:G
</span></span><span style="display:flex;"><span> 8:H
</span></span><span style="display:flex;"><span>  +-- 9:I
</span></span><span style="display:flex;"><span>  |    +-- 12:L
</span></span><span style="display:flex;"><span>  |    |    +--14:N
</span></span><span style="display:flex;"><span>  |    |    +--15:O
</span></span><span style="display:flex;"><span>  |    |        +--16:P
</span></span><span style="display:flex;"><span>  |    |        +--17:Q
</span></span><span style="display:flex;"><span>  |    +-- 13:M
</span></span><span style="display:flex;"><span>  +-- 10:J
</span></span><span style="display:flex;"><span>  +-- 11:K
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="方法一利用函数来得到所有子节点号">方法一：利用函数来得到所有子节点号<a hidden class="anchor" aria-hidden="true" href="#方法一利用函数来得到所有子节点号">#</a></h2>
<p>创建一个function getChildLst, 得到一个由所有子节点号组成的字符串。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">FUNCTION</span> `getChildLst` ( rootId <span style="color:#fff;font-weight:bold">INT</span> ) <span style="color:#fff;font-weight:bold">RETURNS</span> <span style="color:#fff;font-weight:bold">VARCHAR</span>(<span style="color:#ff0;font-weight:bold">1000</span>) <span style="color:#fff;font-weight:bold">BEGIN</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DECLARE</span> sTemp <span style="color:#fff;font-weight:bold">VARCHAR</span> ( <span style="color:#ff0;font-weight:bold">1000</span> );
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DECLARE</span> sTempChd <span style="color:#fff;font-weight:bold">VARCHAR</span> ( <span style="color:#ff0;font-weight:bold">1000</span> );<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#f00"> </span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SET</span> sTemp = <span style="color:#0ff;font-weight:bold">&#39;$&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SET</span> sTempChd = <span style="color:#fff;font-weight:bold">cast</span>( rootId <span style="color:#fff;font-weight:bold">AS</span> <span style="color:#fff;font-weight:bold">CHAR</span> );	<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#f00"> </span>
</span></span><span style="display:flex;"><span>WHILE
</span></span><span style="display:flex;"><span>	sTempChd <span style="color:#fff;font-weight:bold">IS</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">NULL</span> <span style="color:#fff;font-weight:bold">DO</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">SET</span> sTemp = concat( sTemp, <span style="color:#0ff;font-weight:bold">&#39;,&#39;</span>, sTempChd );
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	group_concat( id ) <span style="color:#fff;font-weight:bold">INTO</span> sTempChd 
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	treeNodes 
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>	FIND_IN_SET( pid, sTempChd ) &gt; <span style="color:#ff0;font-weight:bold">0</span>;<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#f00"> </span> 
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">END</span> WHILE;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">RETURN</span> sTemp;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">END</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用我们直接利用find_in_set函数配合这个getChildlst来查找</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> getChildLst(<span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>+<span style="color:#007f7f">-----------------+
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>| getChildLst(<span style="color:#ff0;font-weight:bold">1</span>)<span style="color:#f00">  </span>|
</span></span><span style="display:flex;"><span>+<span style="color:#007f7f">-----------------+
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>| <span style="color:#f00">$</span>,<span style="color:#ff0;font-weight:bold">1</span>,<span style="color:#ff0;font-weight:bold">2</span>,<span style="color:#ff0;font-weight:bold">3</span>,<span style="color:#ff0;font-weight:bold">4</span>,<span style="color:#ff0;font-weight:bold">5</span>,<span style="color:#ff0;font-weight:bold">6</span>,<span style="color:#ff0;font-weight:bold">7</span> |
</span></span><span style="display:flex;"><span>+<span style="color:#007f7f">-----------------+
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> treeNodes <span style="color:#fff;font-weight:bold">where</span> FIND_IN_SET(id, getChildLst(<span style="color:#ff0;font-weight:bold">1</span>));
</span></span><span style="display:flex;"><span>+<span style="color:#007f7f">----+----------+------+
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>| id | nodename | pid<span style="color:#f00">  </span>|
</span></span><span style="display:flex;"><span>+<span style="color:#007f7f">----+----------+------+
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>|<span style="color:#f00">  </span><span style="color:#ff0;font-weight:bold">1</span> | A<span style="color:#f00"> </span> <span style="color:#f00">  </span> <span style="color:#f00">   </span>|<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#ff0;font-weight:bold">0</span> |
</span></span><span style="display:flex;"><span>|<span style="color:#f00">  </span><span style="color:#ff0;font-weight:bold">2</span> | B<span style="color:#f00"> </span> <span style="color:#f00">  </span> <span style="color:#f00">   </span>|<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#ff0;font-weight:bold">1</span> |
</span></span><span style="display:flex;"><span>|<span style="color:#f00">  </span><span style="color:#ff0;font-weight:bold">3</span> | <span style="color:#fff;font-weight:bold">C</span><span style="color:#f00"> </span> <span style="color:#f00">  </span> <span style="color:#f00">   </span>|<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#ff0;font-weight:bold">1</span> |
</span></span><span style="display:flex;"><span>|<span style="color:#f00">  </span><span style="color:#ff0;font-weight:bold">4</span> | D<span style="color:#f00"> </span> <span style="color:#f00">  </span> <span style="color:#f00">   </span>|<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#ff0;font-weight:bold">2</span> |
</span></span><span style="display:flex;"><span>|<span style="color:#f00">  </span><span style="color:#ff0;font-weight:bold">5</span> | E<span style="color:#f00"> </span> <span style="color:#f00">  </span> <span style="color:#f00">   </span>|<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#ff0;font-weight:bold">2</span> |
</span></span><span style="display:flex;"><span>|<span style="color:#f00">  </span><span style="color:#ff0;font-weight:bold">6</span> | F<span style="color:#f00"> </span> <span style="color:#f00">  </span> <span style="color:#f00">   </span>|<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#ff0;font-weight:bold">3</span> |
</span></span><span style="display:flex;"><span>|<span style="color:#f00">  </span><span style="color:#ff0;font-weight:bold">7</span> | <span style="color:#fff;font-weight:bold">G</span><span style="color:#f00"> </span> <span style="color:#f00">  </span> <span style="color:#f00">   </span>|<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#ff0;font-weight:bold">6</span> |
</span></span><span style="display:flex;"><span>+<span style="color:#007f7f">----+----------+------+
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> treeNodes <span style="color:#fff;font-weight:bold">where</span> FIND_IN_SET(id, getChildLst(<span style="color:#ff0;font-weight:bold">3</span>));
</span></span><span style="display:flex;"><span>+<span style="color:#007f7f">----+----------+------+
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>| id | nodename | pid<span style="color:#f00">  </span>|
</span></span><span style="display:flex;"><span>+<span style="color:#007f7f">----+----------+------+
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>|<span style="color:#f00">  </span><span style="color:#ff0;font-weight:bold">3</span> | <span style="color:#fff;font-weight:bold">C</span><span style="color:#f00"> </span> <span style="color:#f00">  </span> <span style="color:#f00">   </span>|<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#ff0;font-weight:bold">1</span> |
</span></span><span style="display:flex;"><span>|<span style="color:#f00">  </span><span style="color:#ff0;font-weight:bold">6</span> | F<span style="color:#f00"> </span> <span style="color:#f00">  </span> <span style="color:#f00">   </span>|<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#ff0;font-weight:bold">3</span> |
</span></span><span style="display:flex;"><span>|<span style="color:#f00">  </span><span style="color:#ff0;font-weight:bold">7</span> | <span style="color:#fff;font-weight:bold">G</span><span style="color:#f00"> </span> <span style="color:#f00">  </span> <span style="color:#f00">   </span>|<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#ff0;font-weight:bold">6</span> |
</span></span><span style="display:flex;"><span>+<span style="color:#007f7f">----+----------+------+
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>优点: 简单，方便，没有递归调用层次深度的限制 (max_sp_recursion_depth,最大255) ；
缺点：长度受限，虽然可以扩大 RETURNS varchar(1000)，但总是有最大限制的。
MySQL目前版本( 5.1.33-community)中还不支持function 的递归调用。</p>
<h2 id="方法二利用临时表和过程递归">方法二：利用临时表和过程递归<a hidden class="anchor" aria-hidden="true" href="#方法二利用临时表和过程递归">#</a></h2>
<p>创建存储过程如下。createChildLst 为递归过程，showChildLst为调用入口过程，准备临时表及初始化。</p>
<p>入口过程</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">PROCEDURE</span> showChildLst ( <span style="color:#fff;font-weight:bold">IN</span> rootId <span style="color:#fff;font-weight:bold">INT</span> ) <span style="color:#fff;font-weight:bold">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TEMPORARY</span> <span style="color:#fff;font-weight:bold">TABLE</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">IF</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">EXISTS</span> tmpLst ( sno <span style="color:#fff;font-weight:bold">INT</span> <span style="color:#fff;font-weight:bold">PRIMARY</span> <span style="color:#fff;font-weight:bold">KEY</span> auto_increment, id <span style="color:#fff;font-weight:bold">INT</span>, depth <span style="color:#fff;font-weight:bold">INT</span> );
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">DELETE</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>		tmpLst;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">CALL</span> createChildLst ( rootId, <span style="color:#ff0;font-weight:bold">0</span> );
</span></span><span style="display:flex;"><span>	<span style="color:#f00"> </span> <span style="color:#f00"> </span> <span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	tmpLst.*,
</span></span><span style="display:flex;"><span>	treeNodes.* 
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>		tmpLst,
</span></span><span style="display:flex;"><span>		treeNodes 
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>		tmpLst.id = treeNodes.id 
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	tmpLst.sno;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">END</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>递归过程</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">PROCEDURE</span> createChildLst ( <span style="color:#fff;font-weight:bold">IN</span> rootId <span style="color:#fff;font-weight:bold">INT</span>, <span style="color:#fff;font-weight:bold">IN</span> nDepth <span style="color:#fff;font-weight:bold">INT</span> ) <span style="color:#fff;font-weight:bold">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">DECLARE</span>
</span></span><span style="display:flex;"><span>		done <span style="color:#fff;font-weight:bold">INT</span> <span style="color:#fff;font-weight:bold">DEFAULT</span> <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">DECLARE</span>
</span></span><span style="display:flex;"><span>		b <span style="color:#fff;font-weight:bold">INT</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">DECLARE</span>
</span></span><span style="display:flex;"><span>		cur1 <span style="color:#fff;font-weight:bold">CURSOR</span> <span style="color:#fff;font-weight:bold">FOR</span> <span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>		id 
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>		treeNodes 
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>		pid = rootId;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">DECLARE</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">CONTINUE</span> <span style="color:#fff;font-weight:bold">HANDLER</span> <span style="color:#fff;font-weight:bold">FOR</span> <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">FOUND</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">SET</span> done = <span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> tmpLst
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">VALUES</span>
</span></span><span style="display:flex;"><span>		( <span style="color:#fff;font-weight:bold">NULL</span>, rootId, nDepth );
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">OPEN</span> cur1;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FETCH</span> cur1 <span style="color:#fff;font-weight:bold">INTO</span> b;
</span></span><span style="display:flex;"><span>	WHILE
</span></span><span style="display:flex;"><span>			done = <span style="color:#ff0;font-weight:bold">0</span> <span style="color:#fff;font-weight:bold">DO</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">CALL</span> createChildLst ( b, nDepth + <span style="color:#ff0;font-weight:bold">1</span> );
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">FETCH</span> cur1 <span style="color:#fff;font-weight:bold">INTO</span> b;
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">END</span> WHILE;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CLOSE</span> cur1;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">END</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>调用时传入结点</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>call showChildLst(1);
</span></span><span style="display:flex;"><span>+-----+------+-------+----+----------+------+
</span></span><span style="display:flex;"><span>| sno | id   | depth | id | nodename | pid  |
</span></span><span style="display:flex;"><span>+-----+------+-------+----+----------+------+
</span></span><span style="display:flex;"><span>|   4 |    1 |     0 |  1 | A        |    0 |
</span></span><span style="display:flex;"><span>|   5 |    2 |     1 |  2 | B        |    1 |
</span></span><span style="display:flex;"><span>|   6 |    4 |     2 |  4 | D        |    2 |
</span></span><span style="display:flex;"><span>|   7 |    5 |     2 |  5 | E        |    2 |
</span></span><span style="display:flex;"><span>|   8 |    3 |     1 |  3 | C        |    1 |
</span></span><span style="display:flex;"><span>|   9 |    6 |     2 |  6 | F        |    3 |
</span></span><span style="display:flex;"><span>|  10 |    7 |     3 |  7 | G        |    6 |
</span></span><span style="display:flex;"><span>+-----+------+-------+----+----------+------+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>call showChildLst(3);
</span></span><span style="display:flex;"><span>+-----+------+-------+----+----------+------+
</span></span><span style="display:flex;"><span>| sno | id   | depth | id | nodename | pid  |
</span></span><span style="display:flex;"><span>+-----+------+-------+----+----------+------+
</span></span><span style="display:flex;"><span>|   1 |    3 |     0 |  3 | C        |    1 |
</span></span><span style="display:flex;"><span>|   2 |    6 |     1 |  6 | F        |    3 |
</span></span><span style="display:flex;"><span>|   3 |    7 |     2 |  7 | G        |    6 |
</span></span><span style="display:flex;"><span>+-----+------+-------+----+----------+------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>depth 为深度，这样可以在程序进行一些显示上的格式化处理。类似于oracle中的 level 伪列。sno 仅供排序控制。这样你还可以通过临时表tmpLst与数据库中其它表进行联接查询。</p>
<p>MySQL中你可以利用系统参数 max_sp_recursion_depth 来控制递归调用的层数上限。如下例设为12
<code>set max_sp_recursion_depth=12;</code></p>
<p>优点：可以更灵活处理，及层数的显示。并且可以按照树的遍历顺序得到结果。
缺点：递归有255的限制</p>
<h2 id="方法三利用中间表和过程">方法三：利用中间表和过程<a hidden class="anchor" aria-hidden="true" href="#方法三利用中间表和过程">#</a></h2>
<p>创建存储过程如下。由于MySQL中不允许在同一语句中对临时表多次引用，只以使用普通表tmpLst来实现了。当然你的程序中负责在用完后清除这个表。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">drop</span> <span style="color:#fff;font-weight:bold">PROCEDURE</span> <span style="color:#fff;font-weight:bold">IF</span> <span style="color:#fff;font-weight:bold">EXISTS</span>  showTreeNodes;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">PROCEDURE</span> showTreeNodes (<span style="color:#fff;font-weight:bold">IN</span> rootid <span style="color:#fff;font-weight:bold">INT</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">BEGIN</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DECLARE</span> <span style="color:#fff;font-weight:bold">Level</span> <span style="color:#fff;font-weight:bold">int</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">drop</span> <span style="color:#fff;font-weight:bold">TABLE</span> <span style="color:#fff;font-weight:bold">IF</span> <span style="color:#fff;font-weight:bold">EXISTS</span> tmpLst;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CREATE</span> <span style="color:#fff;font-weight:bold">TABLE</span> tmpLst (
</span></span><span style="display:flex;"><span> id <span style="color:#fff;font-weight:bold">int</span>,
</span></span><span style="display:flex;"><span> nLevel <span style="color:#fff;font-weight:bold">int</span>,
</span></span><span style="display:flex;"><span> sCort <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">8000</span>)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">Set</span> <span style="color:#fff;font-weight:bold">Level</span> = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">into</span> tmpLst <span style="color:#fff;font-weight:bold">SELECT</span> id,<span style="color:#fff;font-weight:bold">Level</span>,ID <span style="color:#fff;font-weight:bold">FROM</span> category <span style="color:#fff;font-weight:bold">WHERE</span> parent_id = rootid;
</span></span><span style="display:flex;"><span>WHILE <span style="color:#fff;font-weight:bold">ROW_COUNT</span>() &gt; <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DO</span> <span style="color:#fff;font-weight:bold">SET</span> <span style="color:#fff;font-weight:bold">Level</span> = <span style="color:#fff;font-weight:bold">Level</span> + <span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span> <span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">into</span> tmpLst
</span></span><span style="display:flex;"><span>  <span style="color:#fff;font-weight:bold">SELECT</span> A.ID,<span style="color:#fff;font-weight:bold">Level</span>,concat(B.sCort,A.ID) <span style="color:#fff;font-weight:bold">FROM</span> category A,tmpLst B
</span></span><span style="display:flex;"><span>   <span style="color:#fff;font-weight:bold">WHERE</span> A.parent_id = B.ID <span style="color:#fff;font-weight:bold">AND</span> B.nLevel = <span style="color:#fff;font-weight:bold">Level</span>-<span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">END</span> WHILE;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">END</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CALL</span> showTreeNodes(<span style="color:#ff0;font-weight:bold">0</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行完后会产生一个tmpLst表，nLevel 为节点深度，sCort 为排序字段。
使用方法</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT concat(SPACE(B.nLevel*2),&#39;+--&#39;,A.nodename) FROM treeNodes A,tmpLst B WHERE A.ID=B.ID ORDER BY B.sCort;
</span></span><span style="display:flex;"><span>+--------------------------------------------+
</span></span><span style="display:flex;"><span>| concat(SPACE(B.nLevel*2),&#39;+--&#39;,A.nodename) |
</span></span><span style="display:flex;"><span>+--------------------------------------------+
</span></span><span style="display:flex;"><span>| +--A                                       |
</span></span><span style="display:flex;"><span>|   +--B                                     |
</span></span><span style="display:flex;"><span>|     +--D                                   |
</span></span><span style="display:flex;"><span>|     +--E                                   |
</span></span><span style="display:flex;"><span>|   +--C                                     |
</span></span><span style="display:flex;"><span>|     +--F                                   |
</span></span><span style="display:flex;"><span>|       +--G                                 |
</span></span><span style="display:flex;"><span>| +--H                                       |
</span></span><span style="display:flex;"><span>|   +--J                                     |
</span></span><span style="display:flex;"><span>|   +--K                                     |
</span></span><span style="display:flex;"><span>|   +--I                                     |
</span></span><span style="display:flex;"><span>|     +--L                                   |
</span></span><span style="display:flex;"><span>|       +--N                                 |
</span></span><span style="display:flex;"><span>|       +--O                                 |
</span></span><span style="display:flex;"><span>|         +--P                               |
</span></span><span style="display:flex;"><span>|         +--Q                               |
</span></span><span style="display:flex;"><span>|     +--M                                   |
</span></span><span style="display:flex;"><span>+--------------------------------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>优点：层数的显示。并且可以按照树的遍历顺序得到结果。没有递归限制。
缺点：MySQL中对临时表的限制，只能使用普通表，需做事后清理。</p>
<p><a href="https://blog.csdn.net/ACMAIN_CHM/article/details/4142971">参考地址</a></p>
<h1 id="一些特殊的sql">一些特殊的sql<a hidden class="anchor" aria-hidden="true" href="#一些特殊的sql">#</a></h1>
<h2 id="出自archive档案管理系统archivemapperxml">出自：archive档案管理系统，<code>ArchiveMapper.xml</code><a hidden class="anchor" aria-hidden="true" href="#出自archive档案管理系统archivemapperxml">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>&lt;!<span style="color:#007f7f">-- 案件列表 --&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>&lt;<span style="color:#fff;font-weight:bold">select</span> id=<span style="color:#0ff;font-weight:bold">&#34;caseList&#34;</span> resultType=<span style="color:#0ff;font-weight:bold">&#34;map&#34;</span>&gt;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span>
</span></span><span style="display:flex;"><span>	id,
</span></span><span style="display:flex;"><span>	concat(
</span></span><span style="display:flex;"><span>	&lt;foreach collection=<span style="color:#0ff;font-weight:bold">&#34;list&#34;</span> separator=<span style="color:#0ff;font-weight:bold">&#34;,&#34;</span> item=<span style="color:#0ff;font-weight:bold">&#34;i&#34;</span>&gt;
</span></span><span style="display:flex;"><span>		<span style="color:#f00">${</span>i.columnEnglish<span style="color:#f00">}</span>
</span></span><span style="display:flex;"><span>		&lt;<span style="color:#fff;font-weight:bold">if</span> test=<span style="color:#0ff;font-weight:bold">&#34;null != i.connector and &#39;&#39; != i.connector&#34;</span>&gt;
</span></span><span style="display:flex;"><span>		  ,<span style="color:#f00">${</span>i.connector<span style="color:#f00">}</span>
</span></span><span style="display:flex;"><span>		&lt;/<span style="color:#fff;font-weight:bold">if</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;/foreach&gt;
</span></span><span style="display:flex;"><span>	) dataName
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> `<span style="color:#f00">${</span>tableName<span style="color:#f00">}</span>`
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#fff;font-weight:bold">select</span>&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2">2<a hidden class="anchor" aria-hidden="true" href="#2">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> 
</span></span><span style="display:flex;"><span>	* 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> <span style="color:#fff;font-weight:bold">table_name</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> id <span style="color:#fff;font-weight:bold">in</span> (<span style="color:#ff0;font-weight:bold">1</span>,<span style="color:#ff0;font-weight:bold">2</span>,<span style="color:#ff0;font-weight:bold">3</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> field(id,<span style="color:#ff0;font-weight:bold">1</span>,<span style="color:#ff0;font-weight:bold">2</span>,<span style="color:#ff0;font-weight:bold">3</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据in里的参数排序。
xml写法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>order by field(q.id,
</span></span><span style="display:flex;"><span>&lt;foreach collection=&#34;questionIdList&#34; separator=&#34;,&#34; item=&#34;i&#34;&gt;
</span></span><span style="display:flex;"><span>  #{i}
</span></span><span style="display:flex;"><span>&lt;/foreach&gt;
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="删除parents表中手机号重复的数据">删除parents表中手机号重复的数据<a hidden class="anchor" aria-hidden="true" href="#删除parents表中手机号重复的数据">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">DELETE</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span> parents
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span> mobile <span style="color:#fff;font-weight:bold">IN</span> ( <span style="color:#fff;font-weight:bold">SELECT</span> mobile <span style="color:#fff;font-weight:bold">FROM</span> ( <span style="color:#fff;font-weight:bold">SELECT</span> id, mobile, <span style="color:#fff;font-weight:bold">count</span>( id ) <span style="color:#fff;font-weight:bold">count</span> <span style="color:#fff;font-weight:bold">FROM</span> parents <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> mobile <span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">count</span> &gt; <span style="color:#ff0;font-weight:bold">1</span> ) a )
</span></span><span style="display:flex;"><span> <span style="color:#fff;font-weight:bold">AND</span> id <span style="color:#fff;font-weight:bold">NOT</span> <span style="color:#fff;font-weight:bold">IN</span> ( <span style="color:#fff;font-weight:bold">SELECT</span> id <span style="color:#fff;font-weight:bold">FROM</span> ( <span style="color:#fff;font-weight:bold">SELECT</span> id, mobile, <span style="color:#fff;font-weight:bold">count</span>( id ) <span style="color:#fff;font-weight:bold">count</span> <span style="color:#fff;font-weight:bold">FROM</span> parents <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> mobile <span style="color:#fff;font-weight:bold">HAVING</span> <span style="color:#fff;font-weight:bold">count</span> &gt; <span style="color:#ff0;font-weight:bold">1</span> ) a )
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="统计status分别为1和0的数据">统计status分别为1和0的数据<a hidden class="anchor" aria-hidden="true" href="#统计status分别为1和0的数据">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>select
</span></span><span style="display:flex;"><span>	sum(if(status = 1,1,0)) finished_no,
</span></span><span style="display:flex;"><span>	sum(if(status = 0,1,0)) unfinished_no
</span></span><span style="display:flex;"><span>from message_task
</span></span><span style="display:flex;"><span>where message_id = #{_parameter}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="更新数据">更新数据<a hidden class="anchor" aria-hidden="true" href="#更新数据">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>update process_video_data t1
</span></span><span style="display:flex;"><span>left join process_video_data t2 on t1.album_name = t2.album_name
</span></span><span style="display:flex;"><span>set t1.album_id = t2.album_id
</span></span><span style="display:flex;"><span>where t1.album_id is null
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="mysql-order-by-字段有相同值排序出来的字段会随机">mysql order by 字段有相同值，排序出来的字段会随机<a hidden class="anchor" aria-hidden="true" href="#mysql-order-by-字段有相同值排序出来的字段会随机">#</a></h1>
<p>一些数据，创建时间会有相同的。但是我需要按照时间排序，此时mysql返回的数据会出现随机。
<code>select * from table_a order by create_time desc</code>
<a href="https://dev.mysql.com/doc/refman/5.7/en/limit-optimization.html">查阅官网发现</a>
“If multiple rows have identical values in the ORDER BY columns, the server is free to return those rows in any order, and may do so differently depending on the overall execution plan. In other words, the sort order of those rows is nondeterministic with respect to the nonordered columns.”
翻译：如果在ORDER BY列中有多个行具有相同的值，则服务器可以自由以任何顺序返回这些行，并且根据整体执行计划的不同，返回值可能会有所不同。 换句话说，这些行的排序顺序相对于无序列是不确定的。
MySQL官网上也给出了一种方案：
“If it is important to ensure the same row order with and without LIMIT, include additional columns in the ORDER BY clause to make the order deterministic. For example, if id values are unique, you can make rows for a given category value appear in id order by sorting like this:”
在ORDER BY子句中包括其他列以使顺序确定，比如可以使用主键id等。上面的SQL可以修改下：
<code>select * from table_a order by create_time desc,id</code>
问题解决。</p>
<h1 id="letf-join-之后的条件和放到where之后的条件有什么区别">letf join 之后的条件和放到where之后的条件，有什么区别<a hidden class="anchor" aria-hidden="true" href="#letf-join-之后的条件和放到where之后的条件有什么区别">#</a></h1>
<p>数据库在连接多张表返回记录时，都会生成一张临时表，然后将这张表返回给用户。
在使用left join 时，on和where条件的区别如下：</p>
<ul>
<li>on条件是在生成临时表时使用的条件，无论on中的条件是否为真，都会返回左表中的记录。</li>
<li>where条件是在临时表生成好后，再对临时表进行过滤的条件，条件不为真的全部过滤掉。</li>
</ul>
<p>假设两张表：
表1：table_1</p>
<table>
<thead>
<tr>
<th>id</th>
<th>size</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>10</td>
</tr>
<tr>
<td>2</td>
<td>20</td>
</tr>
<tr>
<td>3</td>
<td>30</td>
</tr>
</tbody>
</table>
<p>表2：table_2</p>
<table>
<thead>
<tr>
<th>size</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>A</td>
</tr>
<tr>
<td>20</td>
<td>B</td>
</tr>
<tr>
<td>30</td>
<td>C</td>
</tr>
</tbody>
</table>
<p>两条sql：
<code>select * form tab1 left join table_2 on (table_1.size = table_2.size) where table_2.name=’A’</code>
<code>select * form tab1 left join table_2 on (table_1.size = table_2.size and table_2.name=’A’)</code></p>
<p>sql_1的执行过程：
中间表 on条件: table_1.size = table_2.size</p>
<table>
<thead>
<tr>
<th>table_1.id</th>
<th>table_1.size</th>
<th>table_2.size</th>
<th>table_2.name</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>10</td>
<td>10</td>
<td>A</td>
</tr>
<tr>
<td>2</td>
<td>20</td>
<td>20</td>
<td>B</td>
</tr>
<tr>
<td>2</td>
<td>20</td>
<td>20</td>
<td>C</td>
</tr>
<tr>
<td>3</td>
<td>30</td>
<td>(null)</td>
<td>(null)</td>
</tr>
</tbody>
</table>
<p>where再对中间表数据过滤：table_2.name = A</p>
<table>
<thead>
<tr>
<th>table_1.id</th>
<th>table_1.size</th>
<th>table_2.size</th>
<th>table_2.name</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>10</td>
<td>10</td>
<td>A</td>
</tr>
</tbody>
</table>
<p>sql_2的执行过程：
中间表 on条件: table_1.size = table_2.size and table_2.name=’A’ (条件不为真也会返回左表中的记录)</p>
<table>
<thead>
<tr>
<th>table_1.id</th>
<th>table_1.size</th>
<th>table_2.size</th>
<th>table_2.name</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>10</td>
<td>10</td>
<td>A</td>
</tr>
<tr>
<td>2</td>
<td>20</td>
<td>(null)</td>
<td>(null)</td>
</tr>
<tr>
<td>3</td>
<td>30</td>
<td>(null)</td>
<td>(null)</td>
</tr>
</tbody>
</table>
<p>由于left join 、right join 、full join 的特性，不管on上的条件是否为真都会返回left或right表中的记录，full join 具有left join 和right join 特性的并集。而inner join 没有这个特性，返回的结果是相同的。</p>
<p>总结：</p>
<ul>
<li>on在生成连接表时起作用，where在生成连接表后对连接表再进行过滤。</li>
<li>使用left join时，无论on的条件是否满足，都会返回左表的所有记录，对于满足条件的记录，两个表对应的记录会连接起来，对于不满足条件的记录，右表字段全部是null。</li>
<li>使用right join时，无论on的条件是否满足，都会返回右表的所有记录，对于满足条件的记录，两个表对应的记录会连接起来，对于不满足条件的记录，左表字段全部是null。</li>
<li>使用inner join时，on的条件和where完全相同。
<a href="https://www.cnblogs.com/shamo89/p/11065172.html">参考</a></li>
</ul>
<h1 id="mysql-获取排列序号">mysql 获取排列序号<a hidden class="anchor" aria-hidden="true" href="#mysql-获取排列序号">#</a></h1>
<p>在进入正题之前先来了解一个mysql中的小知识点：
<code>:= 与 = 的区别</code>
<code>:=</code>
赋值的意思。在set update select 中表示赋值的意思，用的比较少一般都用=，但是在用变量实现行号时（比如本文标题获取排列序号），一定要用:=。</p>
<p><code>=</code>
等于的意思，只有当set 和 update时，和:=的意思是一样的，表示赋值，其余情况都是等于的意思。</p>
<p>用户变量 @
@rank 是对一个叫rank的参数进行赋值。对用户变量赋值有两种方式，一种直接用&quot;=&ldquo;另一种用&rdquo;:=&quot;。
其区别在于使用set命令对用户变量赋值时，两种方式都可以使用；当使用select语句对用户变量进行赋值时，只能使用“:=”方式，因为在select语句中，“=”被看做是比较操作符。</p>
<h2 id="根据某字段按序排列并获取排序号">根据某字段按序排列并获取排序号<a hidden class="anchor" aria-hidden="true" href="#根据某字段按序排列并获取排序号">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>a.*,
</span></span><span style="display:flex;"><span>@rank:=@rank + <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#fff;font-weight:bold">AS</span> rank_no
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">SELECT</span> *
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span> `logs`
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">WHERE</span> log_created &gt; <span style="color:#0ff;font-weight:bold">&#34;2017-09-01&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> count <span style="color:#fff;font-weight:bold">DESC</span>
</span></span><span style="display:flex;"><span>) a, (<span style="color:#fff;font-weight:bold">SELECT</span> @rank:= <span style="color:#ff0;font-weight:bold">0</span>) b
</span></span></code></pre></td></tr></table>
</div>
</div><p>2017.09.01之前的日志按访问量进行倒序排序，并返回序号。</p>
<p><code>select @rank:= 0</code>
<code>set @rank=0;</code>
这句话其实就是将rank赋值0，从零开始加1编号，上面两种写法都可以。</p>
<p>用set的写法：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">set</span> @rank= <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>a.log_id,
</span></span><span style="display:flex;"><span>a.log_created,
</span></span><span style="display:flex;"><span>a.count,
</span></span><span style="display:flex;"><span>@rank:=@rank + <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#fff;font-weight:bold">AS</span> rank_no
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">SELECT</span> *
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span> `logs`
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">WHERE</span> log_update &gt; <span style="color:#0ff;font-weight:bold">&#34;2017-09-01&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> count <span style="color:#fff;font-weight:bold">DESC</span>
</span></span><span style="display:flex;"><span>) a;
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以，获取排序序号还是很简单的，基本上都是固定的方式，里面一层select是正常的sql排序的语句，外面一层是对查到的已排好序的数据列进行rank自增的操作，所以一开始@rank:=0。</p>
<h2 id="根据某字段按序排列获取排序号且当该字段的值存在多个相同的记录时则相同值排序号相同">根据某字段按序排列获取排序号，且当该字段的值存在多个相同的记录时，则相同值排序号相同<a hidden class="anchor" aria-hidden="true" href="#根据某字段按序排列获取排序号且当该字段的值存在多个相同的记录时则相同值排序号相同">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SET</span> @rank = <span style="color:#ff0;font-weight:bold">0</span> ,@rowtotal := NULL;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	a.log_id, a.log_created, a.count,
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal = a.count <span style="color:#fff;font-weight:bold">THEN</span>
</span></span><span style="display:flex;"><span>	@rank
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal := a.count <span style="color:#fff;font-weight:bold">THEN</span>
</span></span><span style="display:flex;"><span>	@rank := @rank + <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>END <span style="color:#fff;font-weight:bold">AS</span> rank_no
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	(
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">SELECT</span> * 
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">FROM</span> `logs`
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">WHERE</span> log_update &gt; <span style="color:#0ff;font-weight:bold">&#34;2017-09-01&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> count <span style="color:#fff;font-weight:bold">DESC</span>
</span></span><span style="display:flex;"><span>	) a
</span></span></code></pre></td></tr></table>
</div>
</div><p>从上面的sql语句可以看出多了一句case函数，（rowtotal表示count）根据情况对rank进行赋值，
当rowtotal等于count时，序号就是rank，当rowtotal正常赋值时，言下之意就是不等于，但是
又不能用!= ，（其实这样说也不准确，我也不知道该怎么表达，有知道的人博友可以帮忙补充一下~~~），
这样就实现了相同记录编号相同的目的，同时其余记录继续编号。</p>
<h2 id="根据某字段按序排列获取排序号且当该字段的值存在多个相同的记录时则相同值的记录的排序号相同并且下一组值的排序号为上一组内记录数上一个排序号">根据某字段按序排列获取排序号，且当该字段的值存在多个相同的记录时，则相同值的记录的排序号相同，并且下一组值的排序号为上一组内记录数+上一个排序号<a hidden class="anchor" aria-hidden="true" href="#根据某字段按序排列获取排序号且当该字段的值存在多个相同的记录时则相同值的记录的排序号相同并且下一组值的排序号为上一组内记录数上一个排序号">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SET</span> @rank = <span style="color:#ff0;font-weight:bold">0</span> ,@rowtotal := NULL ,@rowtotal1 = NULL ,@sart := <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> a.log_id, a.log_created, a.count,
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal = a.count <span style="color:#fff;font-weight:bold">THEN</span> @rank
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal := a.count <span style="color:#fff;font-weight:bold">THEN</span> @rank := @rank + <span style="color:#ff0;font-weight:bold">1</span> + @sart
</span></span><span style="display:flex;"><span>        END <span style="color:#fff;font-weight:bold">AS</span> rank_no,
</span></span><span style="display:flex;"><span>         <span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal1 = a.count <span style="color:#fff;font-weight:bold">THEN</span> @sart := @sart + <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal1 := a.count <span style="color:#fff;font-weight:bold">THEN</span> @sart := <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        END <span style="color:#fff;font-weight:bold">AS</span> sart
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	    (
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">SELECT</span> *
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">FROM</span> `logs`
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">WHERE</span> log_update &gt; <span style="color:#0ff;font-weight:bold">&#34;2017-09-01&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> count <span style="color:#fff;font-weight:bold">DESC</span>
</span></span><span style="display:flex;"><span>	    ) a
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的sql里又增加了一个参数sart，表示当前每次相同的个数，（同时还增加了rowtotal1，
用于区别之前的roetotal，因为在这段sql中rowtotal在运行期间已被多次赋值，不适合做sart的比较参数）下一组记录，将在之前的排名上加上此参数就表示，下一组记录的排序编码。为了再次验证sql准确性，再看一组运行结果，（调整日志创建时间为log_update &gt; &ldquo;2016-06-20&rdquo; and log_update &lt; &ldquo;2017-03-01&rdquo;）</p>
<p>上面的sql有个问题就是当数据是0的时候，没有进行特殊处理这个时候得到的rank_no是一个null值，排序就会出问题，下面针对第三种情况做一下纠正其余的类似：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SET</span> @rank = <span style="color:#ff0;font-weight:bold">0</span> ,@rowtotal := NULL ,@rowtotal1 = NULL ,@sart := <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span> a.log_id, a.log_created, a.count,
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal = a.count <span style="color:#fff;font-weight:bold">THEN</span> @rank
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal := a.count <span style="color:#fff;font-weight:bold">THEN</span> @rank := @rank + <span style="color:#ff0;font-weight:bold">1</span> + @sart
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal = <span style="color:#ff0;font-weight:bold">0</span> <span style="color:#fff;font-weight:bold">THEN</span> @rank := @rank +<span style="color:#ff0;font-weight:bold">1</span> +@sart
</span></span><span style="display:flex;"><span>        END <span style="color:#fff;font-weight:bold">AS</span> rank_no,
</span></span><span style="display:flex;"><span>         <span style="color:#fff;font-weight:bold">CASE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal1 = a.count <span style="color:#fff;font-weight:bold">THEN</span> @sart := @sart + <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal1 := a.count <span style="color:#fff;font-weight:bold">THEN</span> @sart := <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">WHEN</span> @rowtotal1 =<span style="color:#ff0;font-weight:bold">0</span> <span style="color:#fff;font-weight:bold">THEN</span> @sart := <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        END <span style="color:#fff;font-weight:bold">AS</span> sart
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	    (
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">SELECT</span> *
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">FROM</span> `logs`
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">WHERE</span> log_update &gt; <span style="color:#0ff;font-weight:bold">&#34;2017-09-01&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span> count <span style="color:#fff;font-weight:bold">DESC</span>
</span></span><span style="display:flex;"><span>	    ) a
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://blog.csdn.net/gao763024185/article/details/79638052">参考</a></p>
<h1 id="技巧">技巧<a hidden class="anchor" aria-hidden="true" href="#技巧">#</a></h1>
<h2 id="mysql按天统计数据">mysql按天统计数据<a hidden class="anchor" aria-hidden="true" href="#mysql按天统计数据">#</a></h2>
<p>库里的存的时间戳，每条数据的时间戳都不一样。
所以使用如下方法，按天统计数据。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	FROM_UNIXTIME( create_time,<span style="color:#0ff;font-weight:bold">&#39;%Y-%m-%d&#39;</span>) days,
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">count</span>( id ) countId
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	 user_behavior
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> user_id = #<span style="color:#f00">{</span>_parameter<span style="color:#f00">}</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	days;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="mysql获取奇数偶数">mysql获取奇数偶数<a hidden class="anchor" aria-hidden="true" href="#mysql获取奇数偶数">#</a></h2>
<p>奇数</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> *
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> <span style="color:#fff;font-weight:bold">table</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> id &amp; <span style="color:#ff0;font-weight:bold">1</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>偶数：id先除以2然后乘2，如果与原来的相等就是偶数</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> *
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> <span style="color:#fff;font-weight:bold">table</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">WHERE</span> id = (id &gt;&gt; <span style="color:#ff0;font-weight:bold">1</span>) &lt;&lt; <span style="color:#ff0;font-weight:bold">1</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="今天遇到的奇怪bug">今天遇到的奇怪bug<a hidden class="anchor" aria-hidden="true" href="#今天遇到的奇怪bug">#</a></h2>
<p>主表一对多子表，子表存了主表的id。主表数据清了，AUTO_INCREMENT从1开始，但是子表数没清空。
导致的问题是：再次新增主表数据时，假如主表数据id是1，那么存入子表的主表id是1，但是因为子表的数据没有清空，之前留在子表的主表id为1的数据还在。那么再根据主表id=1时查询，就会出现多的数据，实际是因为旧数据没删除导致的。以后还得注意这个问题，删除据时候，主子表（有关联的）数据要一同删除。</p>
<h2 id="统计连续天数">统计连续天数<a hidden class="anchor" aria-hidden="true" href="#统计连续天数">#</a></h2>
<p>已知有一些用户数据，每条数据都有时间，时间格式是Date：<code>2021-05-23</code>。如果是时间戳类型，可以通过函数<code>FROM_UNIXTIME( create_time, '%Y-%m-%d' )</code>格式化成自己想要的时间格式。现在想，找出连续的天数的数据。</p>
<p>首先将数据分组</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span>
</span></span><span style="display:flex;"><span>	user_id,
</span></span><span style="display:flex;"><span>	create_time
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span>
</span></span><span style="display:flex;"><span>	table_a
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">group</span> <span style="color:#fff;font-weight:bold">by</span>
</span></span><span style="display:flex;"><span>	user_id,
</span></span><span style="display:flex;"><span>	create_time
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后把连续的天数进行分组</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	*,((
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">count</span>( <span style="color:#ff0;font-weight:bold">1</span> ) 
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>			( <span style="color:#fff;font-weight:bold">SELECT</span> user_id, create_time <span style="color:#fff;font-weight:bold">FROM</span> table_a <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> user_id, create_time ) dr2 
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>			dr1.user_id = dr2.user_id
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">AND</span> dr2.create_time &lt;= dr1.create_time 
</span></span><span style="display:flex;"><span>		) - <span style="color:#fff;font-weight:bold">DAY</span> ( dr1.create_time )) <span style="color:#fff;font-weight:bold">AS</span> <span style="color:#0ff;font-weight:bold">&#39;rownum&#39;</span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	( <span style="color:#fff;font-weight:bold">SELECT</span> user_id, create_time <span style="color:#fff;font-weight:bold">FROM</span> table_a <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> user_id, create_time ) dr1
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后按用户 、开始时间、结束时间 和 连续天数分组</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	user_id,
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">min</span>( create_time ),
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">max</span>( create_time ),(
</span></span><span style="display:flex;"><span>		datediff(
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">max</span>( create_time ),
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">min</span>( create_time ))+ <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	) <span style="color:#fff;font-weight:bold">AS</span> <span style="color:#0ff;font-weight:bold">&#39;rn&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	(
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>		*,((
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fff;font-weight:bold">count</span>( <span style="color:#ff0;font-weight:bold">1</span> )
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>				( <span style="color:#fff;font-weight:bold">SELECT</span> user_id, create_time <span style="color:#fff;font-weight:bold">FROM</span> table_a <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> user_id, create_time ) dr2
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>				dr1.user_id = dr2.user_id 
</span></span><span style="display:flex;"><span>				<span style="color:#fff;font-weight:bold">AND</span> dr2.create_time &lt;= dr1.create_time 
</span></span><span style="display:flex;"><span>			) - <span style="color:#fff;font-weight:bold">DAY</span> ( dr1.create_time )) <span style="color:#fff;font-weight:bold">AS</span> <span style="color:#0ff;font-weight:bold">&#39;rownum&#39;</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>		( <span style="color:#fff;font-weight:bold">SELECT</span> user_id, create_time <span style="color:#fff;font-weight:bold">FROM</span> table_a <span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> user_id, create_time ) dr1
</span></span><span style="display:flex;"><span>	) z 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	user_id,
</span></span><span style="display:flex;"><span>	rownum
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://www.cnblogs.com/ylqs/p/9396229.html">参考</a></p>
<h2 id="给查询记录添加自然序号">给查询记录添加自然序号<a hidden class="anchor" aria-hidden="true" href="#给查询记录添加自然序号">#</a></h2>
<p>表a，数据：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>5</td>
<td>张三</td>
</tr>
<tr>
<td>6</td>
<td>李四</td>
</tr>
<tr>
<td>7</td>
<td>王五</td>
</tr>
</tbody>
</table>
<p>通过一条sql获取这三条记录，并且给每行前面加上从1开始的序号</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>id</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>5</td>
<td>张三</td>
</tr>
<tr>
<td>2</td>
<td>6</td>
<td>李四</td>
</tr>
<tr>
<td>3</td>
<td>7</td>
<td>王五</td>
</tr>
</tbody>
</table>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	@rownum := @rownum + <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#fff;font-weight:bold">AS</span> rownum,
</span></span><span style="display:flex;"><span>	a.* 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>( <span style="color:#fff;font-weight:bold">SELECT</span> @rownum := <span style="color:#ff0;font-weight:bold">0</span> ) r,
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">table</span> a;
</span></span></code></pre></td></tr></table>
</div>
</div><p>写法2：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	@rowno := @rowno + <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#fff;font-weight:bold">AS</span> rowno,
</span></span><span style="display:flex;"><span>	a.* 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">table</span> a,
</span></span><span style="display:flex;"><span>	( <span style="color:#fff;font-weight:bold">SELECT</span> @rowno := <span style="color:#ff0;font-weight:bold">0</span> ) t
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果有按照某个字段排序，行号会不规则排列，换成先排序，外层加上行号会更加合适。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>	@ROWNO := @ROWNO + <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#fff;font-weight:bold">AS</span> ROWNO,
</span></span><span style="display:flex;"><span>	T.* 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>	(
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>		a.*
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">FROM</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">table_name</span> a
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">LEFT</span> <span style="color:#fff;font-weight:bold">JOIN</span> ...
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>		...
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>		... <span style="color:#fff;font-weight:bold">desc</span>
</span></span><span style="display:flex;"><span>	) T,( <span style="color:#fff;font-weight:bold">SELECT</span> @ROWNO := <span style="color:#ff0;font-weight:bold">0</span> ) T3
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">ORDER</span> <span style="color:#fff;font-weight:bold">BY</span>
</span></span><span style="display:flex;"><span>	ROWNO
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="group_concat">group_concat<a hidden class="anchor" aria-hidden="true" href="#group_concat">#</a></h2>
<p>完整语法如下：
<code>group_concat([DISTINCT] 要连接的字段 [Order BY ASC/DESC 排序字段] [Separator '分隔符'])</code></p>
<p>注意：使用 GROUP_CONCAT（）函数必须对源数据进行分组，否则所有数据会被合并成一行。</p>
<p><a href="https://www.cnblogs.com/luxd/p/11302255.html">参考</a>
<a href="https://blog.csdn.net/k0307x1990y/article/details/82905084">参考</a></p>
<h2 id="null值排序">null值排序<a hidden class="anchor" aria-hidden="true" href="#null值排序">#</a></h2>
<p>现在需要按照提交时间<code>create_time</code>正序排序数据，
假设<code>create_time</code>字段中有null值，如果直接，<code>order by create_time</code>，会发现<code>create_time</code>为null的数据排在的前面。</p>
<p>解决办法：
<code>order by create_time is null,create_time</code></p>
<h2 id="mysql-datetime类型时间错误">mysql datetime类型时间错误<a hidden class="anchor" aria-hidden="true" href="#mysql-datetime类型时间错误">#</a></h2>
<p>初步判断是mysql时区的问题，因为mysql时区设置默认是操作系统时区，查看了下centos时区，东8区没有错，所以可以判定是代码里面设置了一个错误的时区。</p>
<h3 id="解决方式一">解决方式一<a hidden class="anchor" aria-hidden="true" href="#解决方式一">#</a></h3>
<p>查看当前时区
show variables like &lsquo;%time_zone%&rsquo;;
发现果然是<code>CST</code>,北美的Central Standard Time</p>
<p>设置时区
set global time_zone = &lsquo;+8:00&rsquo;;
set time_zone = &lsquo;+8:00&rsquo;;
flush PRIVILEGES;</p>
<h3 id="解决方式二">解决方式二<a hidden class="anchor" aria-hidden="true" href="#解决方式二">#</a></h3>
<p>在mysql的连接后加上
<code>serverTimezone=GMT%2B8</code></p>
<h2 id="group-by-获取最新的数据">group by 获取最新的数据<a hidden class="anchor" aria-hidden="true" href="#group-by-获取最新的数据">#</a></h2>
<p>因为group by 是获取的第一条数据，所以可以通过下面的方法获取最后一条数据。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> chapter_user_dub <span style="color:#fff;font-weight:bold">where</span> id <span style="color:#fff;font-weight:bold">in</span>(
</span></span><span style="display:flex;"><span> <span style="color:#fff;font-weight:bold">select</span> <span style="color:#fff;font-weight:bold">MAX</span>(id) <span style="color:#fff;font-weight:bold">from</span> chapter_user_dub <span style="color:#fff;font-weight:bold">where</span> user_id = <span style="color:#ff0;font-weight:bold">106175</span> <span style="color:#fff;font-weight:bold">group</span> <span style="color:#fff;font-weight:bold">by</span> user_id
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="子查询order-by和外层group-by">子查询order by和外层group by<a hidden class="anchor" aria-hidden="true" href="#子查询order-by和外层group-by">#</a></h2>
<p>现在想对order by的结果集进行group by，sql如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>select
</span></span><span style="display:flex;"><span>		id,
</span></span><span style="display:flex;"><span>		name
</span></span><span style="display:flex;"><span>	from table_a ta
</span></span><span style="display:flex;"><span>	left join table_b tb on tb.id = ta.tb_id
</span></span><span style="display:flex;"><span>	where ...
</span></span><span style="display:flex;"><span>	order by tb.create_time
</span></span><span style="display:flex;"><span>	group by ta.id
</span></span></code></pre></td></tr></table>
</div>
</div><p>已知group by取的是第一条数据，而且group by是在order by之前执行，所有获取不到想要的order by的结果集，于是想用子查询：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">select</span>
</span></span><span style="display:flex;"><span>		id,
</span></span><span style="display:flex;"><span>		name
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">from</span> table_a ta
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">left</span> <span style="color:#fff;font-weight:bold">join</span> table_b tb <span style="color:#fff;font-weight:bold">on</span> tb.id = ta.tb_id
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">where</span> ...
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> tb.create_time
</span></span><span style="display:flex;"><span>) t
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> ta.id
</span></span></code></pre></td></tr></table>
</div>
</div><p>虽然在外层执行group by，但是结果还是不对(取的还是第一条数据，子查询没用)。
于是在子查询里边加上<code>limt</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> * <span style="color:#fff;font-weight:bold">from</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">select</span>
</span></span><span style="display:flex;"><span>		id,
</span></span><span style="display:flex;"><span>		name
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">from</span> table_a ta
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">left</span> <span style="color:#fff;font-weight:bold">join</span> table_b tb <span style="color:#fff;font-weight:bold">on</span> tb.id = ta.tb_id
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">where</span> ...
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> tb.create_time
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">limit</span> <span style="color:#ff0;font-weight:bold">999</span>
</span></span><span style="display:flex;"><span>) t
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">GROUP</span> <span style="color:#fff;font-weight:bold">BY</span> ta.id
</span></span></code></pre></td></tr></table>
</div>
</div><p>好了。原因是什么我不知道。</p>
<h2 id="case-when的几种形式">case-when的几种形式<a hidden class="anchor" aria-hidden="true" href="#case-when的几种形式">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CASE</span> b.check_type
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">when</span> <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span> <span style="color:#fff;font-weight:bold">then</span> b.real_name
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">when</span> <span style="color:#0ff;font-weight:bold">&#39;2&#39;</span> <span style="color:#fff;font-weight:bold">then</span> b.association_name
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span> u2.name(<span style="color:#f00">有</span><span style="color:#fff;font-weight:bold">else</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">end</span> <span style="color:#fff;font-weight:bold">AS</span> <span style="color:#0ff;font-weight:bold">&#34;user.name&#34;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">---------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">CASE</span> a.exh_type
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">when</span> <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span> <span style="color:#fff;font-weight:bold">then</span> a.is_art
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">when</span> <span style="color:#0ff;font-weight:bold">&#39;2&#39;</span> <span style="color:#fff;font-weight:bold">then</span> <span style="color:#fff;font-weight:bold">c</span>.is_art
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">end</span> <span style="color:#fff;font-weight:bold">AS</span> <span style="color:#0ff;font-weight:bold">&#34;isArt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">---------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">case</span> (case<span style="color:#f00">后边没东西</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">when</span> a.end_time &gt; now() <span style="color:#fff;font-weight:bold">then</span> <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">when</span> a.end_time &amp;lt; now() <span style="color:#fff;font-weight:bold">then</span> <span style="color:#0ff;font-weight:bold">&#39;2&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">end</span> <span style="color:#fff;font-weight:bold">AS</span> <span style="color:#0ff;font-weight:bold">&#34;isPass&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">---------
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> a.is_home = <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">and</span> a.publish_status = <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">and</span> (
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">case</span> a.exh_type
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">when</span> <span style="color:#0ff;font-weight:bold">&#39;1&#39;</span> <span style="color:#fff;font-weight:bold">then</span> a.audit_status = <span style="color:#0ff;font-weight:bold">&#39;2&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#ff0;font-weight:bold">1</span> = <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="find_in_set">find_in_set<a hidden class="anchor" aria-hidden="true" href="#find_in_set">#</a></h2>
<p><code>find_in_set(str,strlist)</code></p>
<p>str：要查询的字符串
strlist：字段名，存储内容逗号分隔，如<code>(1,2,6,8)</code>
查询字段(strlist)中包含(str)的结果，返回结果为null或记录。</p>
<p><code>SELECT FIND_IN_SET('b', 'a,b,c,d');</code>
返回2，因为b 在strlist集合中放在2的位置。</p>
<p><code>find_in_set</code>很适合查询表中数据为树形的结构，比如部门，一般是这种结构</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1:技术部
</span></span><span style="display:flex;"><span>  +-- 2:JAVA部门
</span></span><span style="display:flex;"><span>  |    +-- 4:影魔
</span></span><span style="display:flex;"><span>  |    +-- 5:白牛
</span></span><span style="display:flex;"><span>  +-- 3:Python部门
</span></span><span style="display:flex;"><span>             +-- 6:火女
</span></span><span style="display:flex;"><span>             +-- 7:冰女
</span></span><span style="display:flex;"><span> 8:总公司
</span></span><span style="display:flex;"><span>  +-- 9:众望教育
</span></span><span style="display:flex;"><span>  |    +-- 12:市场部
</span></span><span style="display:flex;"><span>  |    |    +--14:小黑
</span></span><span style="display:flex;"><span>  |    |    +--15:美杜莎
</span></span><span style="display:flex;"><span>  |    +-- 13:人力部
</span></span><span style="display:flex;"><span>  +-- 10:xxx
</span></span><span style="display:flex;"><span>  +-- 11:xxx
</span></span></code></pre></td></tr></table>
</div>
</div><p>这时如果想查询技术部或总公司下所有的人，用find_in_set就很简单：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>select *
</span></span><span style="display:flex;"><span>from find_in_set
</span></span><span style="display:flex;"><span>where find_in_set(2,path)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="find_in_set和in的区别">find_in_set()和in的区别<a hidden class="anchor" aria-hidden="true" href="#find_in_set和in的区别">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">create</span> <span style="color:#fff;font-weight:bold">table</span> find_in_set
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>    id        <span style="color:#fff;font-weight:bold">int</span> auto_increment,
</span></span><span style="display:flex;"><span>    dep_name  <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">100</span>) <span style="color:#fff;font-weight:bold">null</span> <span style="color:#fff;font-weight:bold">comment</span> <span style="color:#0ff;font-weight:bold">&#39;部门名&#39;</span>,
</span></span><span style="display:flex;"><span>    parent_id <span style="color:#fff;font-weight:bold">int</span>          <span style="color:#fff;font-weight:bold">null</span> <span style="color:#fff;font-weight:bold">comment</span> <span style="color:#0ff;font-weight:bold">&#39;父级id&#39;</span>,
</span></span><span style="display:flex;"><span>    path      <span style="color:#fff;font-weight:bold">varchar</span>(<span style="color:#ff0;font-weight:bold">100</span>) <span style="color:#fff;font-weight:bold">null</span> <span style="color:#fff;font-weight:bold">comment</span> <span style="color:#0ff;font-weight:bold">&#39;部门路径&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">constraint</span> find_in_set_id_uindex
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">unique</span> (id)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">insert</span> <span style="color:#fff;font-weight:bold">into</span> find_in_set(dep_name, parent_id, path)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">values</span>
</span></span><span style="display:flex;"><span>(<span style="color:#0ff;font-weight:bold">&#39;总公司&#39;</span>,<span style="color:#ff0;font-weight:bold">0</span>,<span style="color:#ff0;font-weight:bold">1</span>),
</span></span><span style="display:flex;"><span>(<span style="color:#0ff;font-weight:bold">&#39;技术部&#39;</span>,<span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>,<span style="color:#0ff;font-weight:bold">&#39;1,2&#39;</span>),
</span></span><span style="display:flex;"><span>(<span style="color:#0ff;font-weight:bold">&#39;人力部&#39;</span>,<span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>,<span style="color:#0ff;font-weight:bold">&#39;1,3&#39;</span>),
</span></span><span style="display:flex;"><span>(<span style="color:#0ff;font-weight:bold">&#39;技术部下-java部门&#39;</span>,<span style="color:#0ff;font-weight:bold">&#39;2&#39;</span>,<span style="color:#0ff;font-weight:bold">&#39;1,2,4&#39;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>想查询技术部：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> *
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> find_in_set
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> <span style="color:#ff0;font-weight:bold">2</span> <span style="color:#fff;font-weight:bold">in</span> (path)
</span></span></code></pre></td></tr></table>
</div>
</div><p>是没有数据的，因为in的条件，必须是完全匹配。所以使用find_in_set</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> *
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> find_in_set
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> find_in_set(<span style="color:#ff0;font-weight:bold">2</span>,path)
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询结果：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>2,技术部,1,&#34;1,2&#34;
</span></span><span style="display:flex;"><span>4,技术部下-java部门,2,&#34;1,2,4&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>是符合预期的。</p>
<h3 id="和like的区别">和like的区别<a hidden class="anchor" aria-hidden="true" href="#和like的区别">#</a></h3>
<p>like可能查到我们不想要的记录，find_in_set 比like更精准。</p>
<h2 id="mysql判断时间段是否重合">MySQL判断时间段是否重合<a hidden class="anchor" aria-hidden="true" href="#mysql判断时间段是否重合">#</a></h2>
<p>如图，4种重合情况和2种不重合情况。
<img loading="lazy" src="1.png" alt=""  />
</p>
<p>写法一：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#007f7f">-- 时间段 a,b  
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">SELECT</span> * <span style="color:#fff;font-weight:bold">FROM</span> <span style="color:#fff;font-weight:bold">table</span> <span style="color:#fff;font-weight:bold">WHERE</span>
</span></span><span style="display:flex;"><span>       (start_time &gt;= a <span style="color:#fff;font-weight:bold">and</span> end_time &lt;= b) <span style="color:#007f7f">-- 被包含了
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">or</span> (end_time &gt;= a <span style="color:#fff;font-weight:bold">and</span> end_time &lt;=b)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">or</span> (start_time &gt;= a <span style="color:#fff;font-weight:bold">and</span> start_time &lt;=b)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">or</span> (start_time &lt;= a <span style="color:#fff;font-weight:bold">and</span> end_time &gt;=b)
</span></span></code></pre></td></tr></table>
</div>
</div><p>解析：where后的4个条件分别代表了图中4种重合的情况。
但是第一种情况被2和3包含了，所以简化一下写法：　</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SELECT * FROM table WHERE
</span></span><span style="display:flex;"><span>    (end_time &gt;= a and end_time &lt;=b)
</span></span><span style="display:flex;"><span>    or (start_time &gt;= a and start_time &lt;=b)
</span></span><span style="display:flex;"><span>    or (start_time &lt;= a and end_time &gt;=b);
</span></span></code></pre></td></tr></table>
</div>
</div><p>写法二：
<code>SELECT * FROM table WHERE not (start_time &gt; b or end_time &lt; a);</code></p>
<h1 id="其他">其他<a hidden class="anchor" aria-hidden="true" href="#其他">#</a></h1>
<h2 id="mysql导入data文件夹">mysql导入data文件夹<a hidden class="anchor" aria-hidden="true" href="#mysql导入data文件夹">#</a></h2>
<p>昨天服务器被挖矿病毒攻击，导致服务器无法访问，数据库无法连接。
解决过程：</p>
<ul>
<li>在阿里云控制台备份服务器硬盘快照</li>
<li>重装操作系统</li>
<li>将快照挂载到新系统上，我挂载到了<code>/mnt</code>目录下</li>
<li>进入/mnt目录，查看my.cnf<code>vim etc/my.cnf</code>，发现data文件在<code>var/lib/mysql</code></li>
<li>进入目录<code>cd var/lib/mysql</code>，将该目录整体打包。</li>
<li>重新安装mysql，将新装mysql的<code>var/lib/mysql</code>删除，将刚才打包的data目录复制到<code>/var/lib</code></li>
<li>解压，然后启动mysql</li>
<li>远程连接发现mysql无法访问，提示<code>table xxxxx doesn't exist</code></li>
<li>在服务器任意位置输入<code>mysql_upgrade -uroot -p --force</code>，然后提示：</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Upgrade process completed successfully.
</span></span><span style="display:flex;"><span>Checking if update is needed.
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>再次尝试远程连接，成功，数据都在！</li>
</ul>
<h2 id="导入frm和ibd文件">导入<code>.frm和.ibd</code>文件<a hidden class="anchor" aria-hidden="true" href="#导入frm和ibd文件">#</a></h2>
<p><code>.frm</code>和<code>.ibd</code>分别对应数据库中的表名和表中的数据。
我们进入到mysql的data文件夹，找到一个库进去，可以证实我的想法。</p>
<h1 id="优化案例">优化案例<a hidden class="anchor" aria-hidden="true" href="#优化案例">#</a></h1>
<p>原始sql：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span>
</span></span><span style="display:flex;"><span>      t1.xx,
</span></span><span style="display:flex;"><span>      t1.xx,
</span></span><span style="display:flex;"><span>      t2.xx,
</span></span><span style="display:flex;"><span>      t3.xx
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> table_1 t1
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">left</span> <span style="color:#fff;font-weight:bold">join</span> table_2 t2 <span style="color:#fff;font-weight:bold">on</span> t1.user_id = t2.id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">left</span> <span style="color:#fff;font-weight:bold">join</span> table_3 t3 <span style="color:#fff;font-weight:bold">on</span> t2.id = t3.user_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> <span style="color:#f00">条件</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">group</span> <span style="color:#fff;font-weight:bold">by</span> t1.user_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> <span style="color:#f00">条件</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>sql解释：简单的<code>left join</code>，有问题的地方在于<code>group by t1.user_id</code>，根据 select 的执行顺序，group by 肯定是在left join 之后执行，所以这里因为 join 产生了很多没用的数据，所以优化思路是先 group by ，再 join。</p>
<p>优化后：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span>
</span></span><span style="display:flex;"><span>    t1.xx,
</span></span><span style="display:flex;"><span>    t2.xx,
</span></span><span style="display:flex;"><span>    t3.xx
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">select</span>
</span></span><span style="display:flex;"><span>        user_id,
</span></span><span style="display:flex;"><span>        xx
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">from</span> table_1
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">where</span> del_flag = <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">group</span> <span style="color:#fff;font-weight:bold">by</span> user_id  <span style="color:#007f7f">-- 在这里先执行group by
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>) <span style="color:#fff;font-weight:bold">as</span> t1
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">left</span> <span style="color:#fff;font-weight:bold">join</span> table_2 t2 <span style="color:#fff;font-weight:bold">on</span> t1.user_id = t2.id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">left</span> <span style="color:#fff;font-weight:bold">join</span> table_3 t3 <span style="color:#fff;font-weight:bold">on</span> t2.id = t3.user_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">where</span> <span style="color:#f00">条件</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">order</span> <span style="color:#fff;font-weight:bold">by</span> <span style="color:#f00">条件</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>思路就是先 <code>group by 然后 join</code>，这样少了很多因为 join 产生的笛卡尔积。</p>
<h1 id="mysql批量插入研究">mysql批量插入研究<a hidden class="anchor" aria-hidden="true" href="#mysql批量插入研究">#</a></h1>
<p>本部分参考：https://blog.csdn.net/LJFPHP/article/details/99708888</p>
<p>一次插入多少行数据效率最高？</p>
<p>查看当前数据库的版本，毕竟各个版本之间存在差异</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">select</span> version();
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="准备工作">准备工作<a hidden class="anchor" aria-hidden="true" href="#准备工作">#</a></h2>
<h3 id="插入到数据表的字段">插入到数据表的字段。<a hidden class="anchor" aria-hidden="true" href="#插入到数据表的字段">#</a></h3>
<p>对于手动创建的临时表来说，字段当然是越少越好，而且字段占用的空间要尽量小一些，这样临时表不至于太大，影响表操作的性能。这里需要插入的字段是：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>字段1 int(10)
</span></span><span style="display:flex;"><span>字段2 int(10)
</span></span><span style="display:flex;"><span>字段3 int(10)
</span></span><span style="display:flex;"><span>字段4 varchar(10)
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们一共插入四个字段，分别是<code>3个int类型</code>的，一个<code>varchar</code>类型的，整体来说这些字段都比较小，占用的内存空间会小一些。</p>
<h3 id="计算一行字段占用的空间">计算一行字段占用的空间。<a hidden class="anchor" aria-hidden="true" href="#计算一行字段占用的空间">#</a></h3>
<p>对于innodb引擎来说，int类型可以存储4个字节，里面的Int(M)并不会影响存储字节的大小，这个M只是数据的展示位数，和mysql的ZEROFILL属性有关，即在数字长度不够的数据前面填充0，以达到设定的长度。此处不多说，想要了解的朋友可以百度一下，还是很有意思的。
varchar（10）代表可以存储10个字符，不管是英文还是中文，最多都是10个，这部分假设存储的是中文，在utf-8mb4下，10个中文占用10*4 = 40个字节那么一行数据最多占用：4+4+4+40 = 52字节</p>
<h3 id="在数据里做插入操作的时候整体时间的分配">在数据里做插入操作的时候，整体时间的分配<a hidden class="anchor" aria-hidden="true" href="#在数据里做插入操作的时候整体时间的分配">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>链接耗时 （30%）
</span></span><span style="display:flex;"><span>发送query到服务器 （20%）
</span></span><span style="display:flex;"><span>解析query （20%）
</span></span><span style="display:flex;"><span>插入操作 （10% * 词条数目）
</span></span><span style="display:flex;"><span>插入index （10% * Index的数目）
</span></span><span style="display:flex;"><span>关闭链接 （10%）
</span></span></code></pre></td></tr></table>
</div>
</div><p>从这里可以看出来，真正耗时的不是操作，而是链接，解析的过程。单条<code>sql</code>的话，会在链接，解析部分耗费大量的时间，因此速度会很慢，所以我们一般都是采用批量插入的操作，争取在一次链接里面写入尽可能多的数据，以此来提升插入的速度。但是这个尽可能多的数据是多少呢？一次到底插入多少才合适呢？</p>
<h2 id="批量插入数据测试">批量插入数据测试<a hidden class="anchor" aria-hidden="true" href="#批量插入数据测试">#</a></h2>
<p>开始测试，但是一开始插入多少是合适的呢，是否有上限？查询<code>mysql</code>手册，我们知道<code>sql</code>语句是有大小限制的。</p>
<p>my.ini 里有 max_allowed_packet 这个参数控制通信的 packet 大小。mysql默认的sql语句的最大限制是1M（mysql5.7的客户端默认是16M，服务端默认是4M），可以根据设置查看。官方解释是适当增大 max_allowed_packet 参数可以使client端到server端传递大数据时，系统能够分配更多的扩展内存来处理。
官方手册：https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html</p>
<h3 id="查看服务器上的参数">查看服务器上的参数<a hidden class="anchor" aria-hidden="true" href="#查看服务器上的参数">#</a></h3>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql&gt; <span style="color:#fff;font-weight:bold">show</span> variables <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;%max_allowed_packet%&#39;</span>;
</span></span><span style="display:flex;"><span>+--------------------------+------------+
</span></span><span style="display:flex;"><span>| Variable_name            | Value      |
</span></span><span style="display:flex;"><span>+--------------------------+------------+
</span></span><span style="display:flex;"><span>| max_allowed_packet       | <span style="color:#ff0;font-weight:bold">33554432</span>   |
</span></span><span style="display:flex;"><span>| slave_max_allowed_packet | <span style="color:#ff0;font-weight:bold">1073741824</span> |
</span></span><span style="display:flex;"><span>+--------------------------+------------+
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">2</span> rows <span style="color:#fff;font-weight:bold">in</span> <span style="color:#fff;font-weight:bold">set</span> (<span style="color:#ff0;font-weight:bold">0</span>.<span style="color:#ff0;font-weight:bold">00</span> sec)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>33554432</code>字节 = <code>32M</code> ，也就是规定大小不能超过<code>32M</code>。</p>
<h3 id="计算一次能插入的最大行记录">计算一次能插入的最大行记录<a hidden class="anchor" aria-hidden="true" href="#计算一次能插入的最大行记录">#</a></h3>
<p><code>1M</code>计算的话，(<code>1024*1024)/52 ≈ 20165</code> ，为了防止溢出，最大可一次性插入<code>20000</code>条（根据自己的配置和<code>sql</code>语句大小计算）。那么<code>32M</code>的话就是：<code>20000 *32 = 640000</code> 也就是<code>64W</code>条。</p>
<h3 id="测试插入数据比对">测试插入数据比对<a hidden class="anchor" aria-hidden="true" href="#测试插入数据比对">#</a></h3>
<p>插入11W条数据，按照每次10,600,1000，20000,80000来测试</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>11W的数据，每次插入10条。耗时：2.361s
</span></span><span style="display:flex;"><span>11W的数据，每次插入600条。耗时：0.523s
</span></span><span style="display:flex;"><span>11W的数据，每次插入1000条。耗时：0.429s
</span></span><span style="display:flex;"><span>11W的数据，每次插入20000条。耗时：0.426s
</span></span><span style="display:flex;"><span>11W的数据，每次插入80000条。耗时：0.352s
</span></span></code></pre></td></tr></table>
</div>
</div><p>从这部分看，随着批量插入的增加，速度略有提升，最起码一次插<code>10</code>条应该不是最佳的。插入数据量多，减少了循环的次数，也就是在数据库链接部分的耗时有所减少，只是这个<code>8W</code>并不是极限数据，具体一次插入多少条，还有待参考。</p>
<p>加大数据量到24w。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>24W的数据，每次插入10条。耗时：4.445s
</span></span><span style="display:flex;"><span>24W的数据，每次插入600条。耗时：1.187s
</span></span><span style="display:flex;"><span>24W的数据，每次插入1000条。耗时：1.13s
</span></span><span style="display:flex;"><span>24W的数据，每次插入20000条。耗时：0.933s
</span></span><span style="display:flex;"><span>24W的数据，每次插入80000条。耗时：0.753s	
</span></span></code></pre></td></tr></table>
</div>
</div><p>一次插入<code>24W</code>反而性能最佳，这么代表我们的测试数据量依然不够。</p>
<p>加大测试量到42W。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>42W的数据，每次插入1000条。耗时：2.216s
</span></span><span style="display:flex;"><span>42W的数据，每次插入80000条。耗时：1.777s
</span></span><span style="display:flex;"><span>42W的数据，每次插入16W条。耗时：1.523s
</span></span><span style="display:flex;"><span>42W的数据，每次插入20W条。耗时：1.432s
</span></span><span style="display:flex;"><span>42W的数据，每次插入30W条。耗时：1.362s
</span></span><span style="display:flex;"><span>42W的数据，每次插入40W条。耗时：1.764s
</span></span></code></pre></td></tr></table>
</div>
</div><p>随着插入量的增加，批量插入条数多了之后，性能是有所提升的。但是在达到30W以上之后，效率反而有所下降。这部分我的理解是mysql是要分配一定的内存给传过来的数据包使用，当批量插入的数据量到达一定程度之后，一次插入操作的开销就很耗费内存了。个人感觉，最佳大小是max_allowed_packet的一半，也就是极限能插入64W，选用32W也许性能会更好一些，同时也不会对mysql的其他操作产生太大的影响。</p>
<h3 id="如果插入的值就是sql语句限制的最大值那么性能真的好吗">如果插入的值就是sql语句限制的最大值，那么性能真的好吗？<a hidden class="anchor" aria-hidden="true" href="#如果插入的值就是sql语句限制的最大值那么性能真的好吗">#</a></h3>
<p>客户端用一个单独的数据包将查询请求发送给服务器，所以当查询语句很长的时候，需要设置max_allowed_packet参数。但是需要注意的是，如果查询实在是太大，服务端会拒绝接收更多数据并抛出异常。与之相反的是，服务器响应给用户的数据通常会很多，由多个数据包组成。但是当服务器响应客户端请求时，客户端必须完整的接收整个返回结果，而不能简单的只取前面几条结果，然后让服务器停止发送。因而在实际开发中，尽量保持查询简单且只返回必需的数据，减小通信间数据包的大小和数量是一个非常好的习惯，这也是查询中尽量避免使用SELECT *以及加上LIMIT限制的原因之一。</p>
<h2 id="其他影响插入性能的因素">其他影响插入性能的因素<a hidden class="anchor" aria-hidden="true" href="#其他影响插入性能的因素">#</a></h2>
<h3 id="首先是插入的时候要注意缓冲区的大小使用情况">首先是插入的时候，要注意缓冲区的大小使用情况<a hidden class="anchor" aria-hidden="true" href="#首先是插入的时候要注意缓冲区的大小使用情况">#</a></h3>
<p>在分析源码的过程中，有一句话：如果buffer pool余量不足25%，插入失败，返回DB_LOCK_TABLE_FULL。这个错误并不是直接报错：max_allowed_packet 不够大之类的，这个错误是因为对于innodb引擎来说，一次插入是涉及到事务和锁的，在插入索引的时候，要判断缓冲区的剩余情况，所以插入并不能仅仅只考虑max_allowed_packet的问题，也要考虑到缓冲区的大小。</p>
<p>参考淘宝的数据库日报：</p>
<p><a href="http://mysql.taobao.org/monthly/2017/09/10/">http://mysql.taobao.org/monthly/2017/09/10/</a></p>
<h3 id="插入缓存">插入缓存<a hidden class="anchor" aria-hidden="true" href="#插入缓存">#</a></h3>
<p>另外对于innodb引擎来说，因为存在插入缓存（Insert Buffer）这个概念，所以在插入的时候也是要耗费一定的缓冲池内存的。当写密集的情况下，插入缓冲会占用过多的缓冲池内存，默认最大可以占用到1/2的缓冲池内存，当插入缓冲占用太多缓冲池内存的情况下，会影响到其他的操作。
也就是说，插入缓冲受到缓冲池大小的影响，缓冲池大小为：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>mysql&gt; <span style="color:#fff;font-weight:bold">show</span> variables <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;innodb_buffer_pool_size&#39;</span>;
</span></span><span style="display:flex;"><span>+-------------------------+-----------+
</span></span><span style="display:flex;"><span>| Variable_name           | Value     |
</span></span><span style="display:flex;"><span>+-------------------------+-----------+
</span></span><span style="display:flex;"><span>| innodb_buffer_pool_size | <span style="color:#ff0;font-weight:bold">134217728</span> |
</span></span><span style="display:flex;"><span>+-------------------------+-----------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>换算后的结果为：128M，也就是说，插入缓存最多可以占用64M的缓冲区大小。这个大小要超过咱们设置的sql语句大小，所以可以忽略不计。</p>
<p>详细解释：</p>
<pre><code>我们都知道，在InnoDB引擎上进行插入操作时，一般需要按照主键顺序进行插入，这样才能获得较高的插入性能。当一张表中存在非聚簇的且不唯一的索引时，在插入时，数据页的存放还是按照主键进行顺序存放，
</code></pre>
<p>但是对于非聚簇索引叶节点的插入不再是顺序的了，这时就需要离散的访问非聚簇索引页，由于随机读取的存在导致插入操作性能下降。</p>
<pre><code>InnoDB为此设计了Insert Buffer来进行插入优化。对于非聚簇索引的插入或者更新操作，不是每一次都直接插入到索引页中，而是先判断插入的非聚集索引是否在缓冲池中，若在，则直接插入；若不在，则先放入到一个Insert Buffer中。看似数据库这个非聚集的索引已经查到叶节点，而实际没有，这时存放在另外一个位置。然后再以一定的频率和情况进行Insert Buffer和非聚簇索引页子节点的合并操作。这时通常能够将多个插入合并到一个操作中，这样就大大提高了对于非聚簇索引的插入性能。
</code></pre>
<h3 id="使用事务提升效率">使用事务提升效率<a hidden class="anchor" aria-hidden="true" href="#使用事务提升效率">#</a></h3>
<p>还有一种说法，使用事务可以提高数据的插入效率，这是因为进行一个<code>INSERT</code>操作时，<code>MySQL</code>内部会建立一个事务，在事务内才进行真正插入处理操作。通过使用事务可以减少创建事务的消耗，所有插入都在执行后才进行提交操作。大概如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span>START TRANSACTION;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `insert_table` (`<span style="color:#fff;font-weight:bold">datetime</span>`, `uid`, `content`, `type`) 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;0&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;userid_0&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;content_0&#39;</span>, <span style="color:#ff0;font-weight:bold">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">INSERT</span> <span style="color:#fff;font-weight:bold">INTO</span> `insert_table` (`<span style="color:#fff;font-weight:bold">datetime</span>`, `uid`, `content`, `type`) 
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">VALUES</span> (<span style="color:#0ff;font-weight:bold">&#39;1&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;userid_1&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;content_1&#39;</span>, <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>COMMIT;
</span></span></code></pre></td></tr></table>
</div>
</div><p>事务需要控制大小，事务太大可能会影响执行的效率。<code>MySQL</code>有<code>innodb_log_buffer_size</code>配置项，超过这个值会把<code>innodb</code>的数据刷到磁盘中，这时，效率会有所下降。所以比较好的做法是，在数据达到这个这个值前进行事务提交。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#f00">查看：</span> <span style="color:#fff;font-weight:bold">show</span> variables <span style="color:#fff;font-weight:bold">like</span> <span style="color:#0ff;font-weight:bold">&#39;%innodb_log_buffer_size%&#39;</span>;
</span></span><span style="display:flex;"><span>+------------------------+----------+
</span></span><span style="display:flex;"><span>| Variable_name          | Value    |
</span></span><span style="display:flex;"><span>+------------------------+----------+
</span></span><span style="display:flex;"><span>| innodb_log_buffer_size | <span style="color:#ff0;font-weight:bold">67108864</span> |
</span></span><span style="display:flex;"><span>+------------------------+----------+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">大概是：</span><span style="color:#ff0;font-weight:bold">64</span>M
</span></span></code></pre></td></tr></table>
</div>
</div><p>这种写法和批量写入的效果差不多，只不过sql语句还是单句的，然后统一提交。一个瓶颈是SQL语句的大小，一个瓶颈是事务的大小。当我们在提交sql的时候，首先是受到sql大小的限制，其次是受到事务大小的限制。在开启事务的情况下使用批量插入，会节省不少事务的开销，如果要追求极致的速度的话，建议是开着事务插入的。不过需要注意一下，内存是有限且共享的，如果批量插入占用太多的事务内存，那么势必会对其他的业务操作等有一定的影响。</p>
<h3 id="通过配置提升读写性能">通过配置提升读写性能<a hidden class="anchor" aria-hidden="true" href="#通过配置提升读写性能">#</a></h3>
<p>也可以通过增大innodb_buffer_pool_size 缓冲区来提升读写性能，只是缓冲区是要占用内存空间的，内存很珍贵，所以这个方案在内存富裕，而性能瓶颈的时候，可以考虑下。</p>
<p>参考：https://my.oschina.net/anuodog/blog/3002941</p>
<h3 id="索引影响插入性能">索引影响插入性能<a hidden class="anchor" aria-hidden="true" href="#索引影响插入性能">#</a></h3>
<p>如果表中存在多个字段索引，当对表中的数据进行增加、删除和修改的时候，索引也要动态的维护。这样就降低了数据的插入速度。对于普通的数据表，主键索引是肯定要有的，想要加快性能的话，就是要有序插入，每次插入记录都在索引的最后面，索引的定位效率很高，并且对索引调整较小。如果插入的记录在索引中间，需要B+tree进行分裂合并等处理，会消耗比较多计算资源，并且插入记录的索引定位效率会下降，数据量较大时会有频繁的磁盘操作。</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/mysql/">mysql</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>