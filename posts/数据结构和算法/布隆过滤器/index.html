<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>布隆过滤器 | Wjy&#39;s Blog</title>
<meta name="keywords" content="数据结构">
<meta name="description" content="概述 在互联网中，我们经常遇到需要在大量数据中判断目标数据是否存在的情况。例如，在网络爬虫中，我们需要判断某个网址是否已经被访问过。为了实现这">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="布隆过滤器" />
<meta property="og:description" content="概述 在互联网中，我们经常遇到需要在大量数据中判断目标数据是否存在的情况。例如，在网络爬虫中，我们需要判断某个网址是否已经被访问过。为了实现这" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-29T10:57:33+00:00" />
<meta property="article:modified_time" content="2024-03-29T10:57:33+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="布隆过滤器"/>
<meta name="twitter:description" content="概述 在互联网中，我们经常遇到需要在大量数据中判断目标数据是否存在的情况。例如，在网络爬虫中，我们需要判断某个网址是否已经被访问过。为了实现这"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "布隆过滤器",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "布隆过滤器",
  "name": "布隆过滤器",
  "description": "概述 在互联网中，我们经常遇到需要在大量数据中判断目标数据是否存在的情况。例如，在网络爬虫中，我们需要判断某个网址是否已经被访问过。为了实现这",
  "keywords": [
    "数据结构"
  ],
  "articleBody": "概述 在互联网中，我们经常遇到需要在大量数据中判断目标数据是否存在的情况。例如，在网络爬虫中，我们需要判断某个网址是否已经被访问过。为了实现这一功能，通常需要使用一个容器来存储已访问过的网址。如果将这些数据直接存储在磁盘中，每次判断都要进行磁盘查询，这将导致大量的IO操作，效率较低。\n因此，我们希望将这些数据保存在内存中。在数据量较小的情况下，可以使用Redis来存储这些数据。但是，当数据量超过上千万时，将会消耗几GB甚至几十GB的内存空间。然而，对于仅需要记录数据是否存在的情况而言，这样使用大量内存显然是浪费的。为了解决这个问题，我们可以使用布隆过滤器(Bloom Filter)。布隆过滤器是一种占用空间少且时间效率高的工具。\n参考：https://mp.weixin.qq.com/s/dULRkxnN3nYrICiKZ1-sZw\n布隆过滤器简介 布隆过滤器（Bloom Filter）是1970年由布隆提出的，它实质上是一个很长的二进制向量和一系列随机映射函数 (Hash函数)。\n作用：它是一个空间效率高的概率型数据结构，用来告诉你:一个元素一定不存在或者可能存在。\n优点 相比于其它的数据结构，布隆过滤器在空间和时间方面都有巨大的优势。布隆过滤器存储空间和插入/查询时间都是常数（即hash函数的个数）。 Hash 函数相互之间没有关系，方便由硬件并行实现。 布隆过滤器不需要存储元素本身，在某些对保密要求非常严格的场合有优势。 布隆过滤器可以表示全集，其它任何数据结构都不能。 缺点 有误判率存在。 不支持删除。 适用场景 预防缓存穿透：布隆过滤器快速判断数据是否存在，避免通过查询数据库来判断数据是否存在。 网络爬虫：布隆过滤器可以用来去重已经爬取过的URL。 邮箱的垃圾邮件过滤。 黑白名单。 布隆过滤器原理 结构 布隆过滤器实现原理就是一个超大位数的数组和多个不同Hash算法函数。假设位数组的长度为 m，哈希函数的个数为 k。如下图，一个长度16位的数组，3个不同Hash算法函数，数组里面存储的是 bit 位，只放 0 和 1，初始为 0。\n不同Hash算法函数\n指定长度数组：\n添加元素 将要添加的元素分别通过k个哈希函数计算得到k个哈希值，这k个hash值对应位数组上的k个位置，然后将这k个位置设置为1。\n我们添加一个data1和data2两个元素，两个元素根据三个hash算法函数计算出的值，注意，三个值可能会存在相同的值。\n其中data1计算出1、8、13三值，我们把数组中对应的位置设置为1。\n1 2 3 Hash1(data1)=1 Hash2(data1)=8 Hash3(data1)=13 data2计算出2、5、13三值，我们把数组中对应的位置设置为1\n1 2 3 Hash1(data2)=2 Hash2(data2)=5 Hash3(data2)=13 我们发现data1和data2经过hash函数后，出现了一个相同值，这种是正常的，也正是因为这种情况的存在，需要多个函数来保证每个元素尽可能对应数组位置的唯一性，可以看下两个元素在一起的效果。\n当不同元素在不同或者相同的hash函数计算后，得到同一个值，依旧只需要这个位置保持1即可。\n查询元素 将要查询的元素分别通过k个哈希函数计算得到k个哈希值，这k个hash值对应位数组上的k个位置。如果这k个位置中有一个位置为0，则此元素一定不存在集合中。如果这k个位置全部为1，则这个元素可能存在。\n我们在刚才添加过data1和data2两个元素的布隆过滤器查询以下三种元素，data1已添加到布隆过滤器元素，data3和data4都是未添加到布隆过滤器元素。\n查询data1先根据添加时的三个hash函数计算分别对应值，值分别是1、8、13，然后查询数组中这三个位置的值是否为1。\n1 2 3 Hash1(data1)=1 Hash2(data1)=8 Hash3(data1)=13 我们可以看到数组中1、8、13这三个位置都是1，data1可能存在于该布隆过滤器。我们从添加的角度来看，我们知道data1是一定存在于该布隆过滤器的，为什么还要是说可能呢，是因为查询出来三个位置都为1不能代表这个三个1都是同一个元素添加的，下面我们看下元素data3的查询。\n查询data3先根据添加时的三个hash函数计算分别对应值，值分别是2、8、13，然后查询数组中这三个位置的值是否为1。\n1 2 3 Hash1(data3)=2 Hash2(data3)=8 Hash3(data3)=13 我们已知的该布隆过滤器我们没有添加给data3，为什么data3查询出来三个位置的值都为1呢。我们可以看到data3所命中的位置分别是data2添加时把位置2赋值的1，和data1添加时把位置8和位置13赋值的1，都是由其他元素改变的位置对应的值，所以命中位置全部为1。这个元素可能存在。\n我们查询一下data4，看下命中位置不全为0的数据。查询data4先根据添加时的三个hash函数计算分别对应值，值分别是2、8、13，然后查询数组中这三个位置的值是否为1。\n1 2 3 Hash1(data4)=1 Hash2(data4)=8 Hash3(data4)=12 我们可以看到data4元素的hash函数3计算之后的值是12，数组位置12的值是0，没有元素在位置12赋值过1。如果data4存在于该布隆过滤器，则一定在添加data4时会把位置12赋值1，此时位置12还是0，则说明该布隆过滤器未添加过data4元素，所以位置中有一个位置为0。则此元素一定不存在布隆过滤器中。\n布隆过滤器误判率 刚才查询时我们发现data3没有添加过到布隆过滤器，却在布隆过滤器查询到了，这种情况就是布隆过滤器误判了。那可以不存在误判或者减少误判吗？事实上误判是一定存在的，我们可以尽可能减小误判。下面说下如何得到误判率。\n参数 m：布隆过滤器的bit长度。 n：插入过滤器的元素个数。 k：哈希函数的个数。\n推导过程 误判率公式 实现方案 Guava实现 guava是谷歌开源工具类，其中就有能直接实现布隆过滤器的方法，不需要重复造轮子。\n方法名 功能 参数 返回值 put 添加元素 put(T object) boolean mightContain 检查元素是否存在 mightContain(T object) boolean copy 根据此实例创建一个新的BloomFilte copy() BloomFilter approximateElementCount 已添加到Bloom过滤器的元素的数量 approximateElementCount() long expectedFpp 返回元素存在的错误概率 expectedFpp() double isCompatible 确定给定的Bloom筛选器是否与此Bloom筛选器兼容 isCompatible(BloomFilterthat) boolean putAll 通过执行的逐位OR将此Bloom过滤器与另一个Bloom过滤器组合 putAll(BloomFilterthat) void 引入依赖\n1 2 3 4 5 com.google.guava guava 23.0 测试代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 private static void GuavaBloomFilter() { // 创建布隆过滤器对象 BloomFilter bloomFilter = BloomFilter.create(Funnels.stringFunnel(Charset.defaultCharset()),EXPECTED_INSERTIONS,FALSE_PROBABILITY); // 向过滤器中添加元素 bloomFilter.put(\"element001\"); bloomFilter.put(\"element003\"); // 判断元素是否存在 System.out.println(bloomFilter.mightContain(\"element001\"));//true System.out.println(bloomFilter.mightContain(\"element002\"));//false // 已添加到Bloom过滤器的元素的数量 System.out.println(bloomFilter.approximateElementCount());// 2 // 返回元素存在的错误概率 System.out.println(bloomFilter.expectedFpp()); } Redis实现 开源Redisson方式 Redisson方法\n方法名 功能 参数 返回值 add 添加元素 add(T object) boolean contains 检查元素是否存在 contains(T object) boolean count 已添加到Bloom过滤器的元素的数量 count() long getExpectedInsertions 返回的预期插入元素的个数 getExpectedInsertions() long getFalseProbability 返回元素存在的错误概率 getFalseProbability() double getHashIterations 返回每个元素使用的哈希迭代次数 getHashIterations() int getSize 返回此实例所需Redis内存的位数 getSize() long tryInit 初始化Bloom筛选器参数 tryInit(long expectedInsertions, double falseProbability) boolean delete 删除对象 delete() boolean 引入依赖\n1 2 3 4 5 org.redisson redisson 3.22.1 测试代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 private static void RedissonBloomFilter() { Config config = new Config(); config.useSingleServer().setAddress(\"redis://\" + REDIS_IP + \":\" + REDIS_PORT); config.useSingleServer().setPassword(REDIS_PASSWORD); // 获取客户端 RedissonClient redissonClient = Redisson.create(config); RBloomFilter bloomFilter = redissonClient.getBloomFilter(BLOOM_FILTER_NAME); // 初始化布隆过滤器：预期插入量为100000000L,预期错误概率为1% bloomFilter.tryInit(EXPECTED_INSERTIONS, FALSE_PROBABILITY); // 插入数据 bloomFilter.add(\"element001\"); bloomFilter.add(\"element003\"); // 判断下面元素是否在布隆过滤器中 System.out.println(bloomFilter.contains(\"element002\"));//false System.out.println(bloomFilter.contains(\"element001\"));//true // 已添加到Bloom过滤器的元素的数量 System.out.println(bloomFilter.count());//2 // 预期插入元素的个数 System.out.println(bloomFilter.getExpectedInsertions());//1000000 // 元素存在的错误概率 System.out.println(bloomFilter.getFalseProbability());//0.01 // 每个元素使用的哈希迭代次数 System.out.println(bloomFilter.getHashIterations()); // 实例所需Redis内存的位数 System.out.println(bloomFilter.getSize()); } Redis 4.0 官方提供布隆过滤器插件 基础命令\n命令 功能 参数 BF.RESERVE 创建一个大小为capacity，错误率为error_rate的空的Bloom BF.RESERVE {key} {error_rate} {capacity} [EXPANSION {expansion}] [NONSCALING] BF.ADD 向key指定的Bloom中添加一个元素itom BF.ADD {key} {item} BF.MADD 向key指定的Bloom中添加多个元案 BF.MADD {key} {item …} BF.INSERT 向key指定的Bloom中添加多个元素，添加时可以指定大小和错误率，且可以控制在Bloom不存在的时候是否自动创建 BF.INSERT {key} [CAPACITY {cap}] [ERROR {error}] [EXPANSION {expansion}] [NOCREATE] [NONSCALING] ITEMS {item …} BF.EXISTS 检查一个元秦是否可能存在于key指定的Bloom中 BF.EXISTS {key} {item} BF.MEXISTS 同时检查多个元素是否可能存在于key指定的Bloom中 BF.MEXISTS {key} {item …} BF.SCANDUMP 对Bloom进行增量持久化操作 BF.SCANDUMP {key} {iter} BF.LOADCHUNK 加载SCANDUMP持久化的Bloom数据 BF.LOADCHUNK {key} {iter} {data} BF.INFO 查询key指定的Bloom的信息 BF.INFO {key} BF.DEBUG 查看BloomFilter的内部详细信息(如每层的元素个数，错误率等) BF.DEBUG (key} 引入依赖\n1 2 3 4 5 redis.clients jedis 4.2.0 测试代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 private static void RedisBloomFilter() { // 建立连接 BloomFilterCommands bloomFilterCommands = new JedisPooled(REDIS_IP, REDIS_PORT, \"\", REDIS_PASSWORD); // 构建布隆过滤器参数 BFReserveParams bfReserveParams = new BFReserveParams(); bfReserveParams.expansion(2); // 创建一个过滤器 String test = bloomFilterCommands.bfReserve(BLOOM_FILTER_NAME, FALSE_PROBABILITY, EXPECTED_INSERTIONS, bfReserveParams); // 向过滤器中添加元素 bloomFilterCommands.bfAdd(BLOOM_FILTER_NAME, \"element001\"); bloomFilterCommands.bfAdd(BLOOM_FILTER_NAME, \"element003\"); // 判断元素是否存在 System.out.println(bloomFilterCommands.bfExists(BLOOM_FILTER_NAME, \"element001\"));//true System.out.println(bloomFilterCommands.bfExists(BLOOM_FILTER_NAME, \"element002\"));//false } 通过Redis提供的bitMap自己实现 自定义方法\n方法名 功能 参数 返回值 add 添加元素 add(String key, String element, int expireSec) boolean contains 检查元素是否存在 contains(String key, String element) boolean getExpectedInsertions 返回的预期插入元素的个数 getExpectedInsertions() long getFalseProbability 返回元素存在的错误概率 getFalseProbability() double getNumHashFunctions 返回每个元素使用的哈希迭代次数 getNumHashFunctions() int getBitmapLength 返回Bitmap长度 getBitmapLength() long BloomFilterUtils 创建Bloom对象 BloomFilterUtils(long expectedInsertions, double falseProbability) BloomFilterUtils 测试代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 public class BloomFilterUtils { private static final String BF_KEY_PREFIX = \"bf_\"; private long numApproxElements; private double falseProbability; // hash个数 private int numHashFunctions; // 数组长度 private int bitmapLength; private JedisResourcePool jedisResourcePool; /** * 构造布隆过滤器。注意：在同一业务场景下，三个参数务必相同 * * @param numApproxElements 预估元素数量 * @param fpp 可接受的最大误差 * @param jedisResourcePool Codis专用的Jedis连接池 */ public BloomFilterUtils(Long numApproxElements, double fpp, JedisResourcePool jedisResourcePool) { this.numApproxElements = numApproxElements; this.falseProbability = fpp; this.jedisResourcePool = jedisResourcePool; // 数组长度 m = (n * lnp)/ln2^2 bitmapLength = (int) (-numApproxElements * Math.log(fpp) / (Math.log(2) * Math.log(2))); // hash个数 k = (n / m ) * ln2 numHashFunctions = Math.max(1, (int) Math.round((double) bitmapLength / numApproxElements * Math.log(2))); } /** * 取得预估元素数量 */ public long getExpectedInsertions() { return numApproxElements; } /** * 返回元素存在的错误概率 */ public double getFalseProbability() { return falseProbability; } /** * 取得自动计算的最优哈希函数个数 */ public int getNumHashFunctions() { return numHashFunctions; } /** * 取得自动计算的最优Bitmap长度 */ public int getBitmapLength() { return bitmapLength; } /** * 计算一个元素值哈希后映射到Bitmap的哪些bit上 * * @param element 元素值 * @return bit下标的数组 */ private long[] getBitIndices(String element) { long[] indices = new long[numHashFunctions]; // 元素 使用MurMurHash3 128位Hash算法转换值 byte[] bytes = Hashing.murmur3_128() .hashObject(element, Funnels.stringFunnel(Charset.forName(\"UTF-8\"))) .asBytes(); // 低8位转Long值 long hash1 = Longs.fromBytes( bytes[7], bytes[6], bytes[5], bytes[4], bytes[3], bytes[2], bytes[1], bytes[0] ); // 高8位转Long值 long hash2 = Longs.fromBytes( bytes[15], bytes[14], bytes[13], bytes[12], bytes[11], bytes[10], bytes[9], bytes[8] ); long combinedHash = hash1; // 双重哈希进行散列 for (int i = 0; i \u0026lt; numHashFunctions; i++) { indices[i] = (combinedHash \u0026 Long.MAX_VALUE) % bitmapLength; combinedHash += hash2; } return indices; } /** * 插入元素 * * @param key 原始Redis键，会自动加上'bf_'前缀 * @param element 元素值，字符串类型 * @param expireSec 过期时间（秒） */ public void add(String key, String element, int expireSec) { if (key == null || element == null) { throw new RuntimeException(\"键值均不能为空\"); } String actualKey = BF_KEY_PREFIX.concat(key); try (Jedis jedis = jedisResourcePool.getResource()) { try (Pipeline pipeline = jedis.pipelined()) { // 遍历元素所有hash结果的bit位置 for (long index : getBitIndices(element)) { pipeline.setbit(actualKey, index, true); } pipeline.syncAndReturnAll(); } jedis.expire(actualKey, expireSec); } } /** * 检查元素在集合中是否（可能）存在 * * @param key 原始Redis键，会自动加上'bf_'前缀 * @param element 元素值，字符串类型 */ public boolean contains(String key, String element) { if (key == null || element == null) { throw new RuntimeException(\"键值均不能为空\"); } String actualKey = BF_KEY_PREFIX.concat(key); boolean result = false; try (Jedis jedis = jedisResourcePool.getResource()) { // 遍历元素所有hash结果的bit位置 try (Pipeline pipeline = jedis.pipelined()) { for (long index : getBitIndices(element)) { pipeline.getbit(actualKey, index); } result = !pipeline.syncAndReturnAll().contains(false); } } return result; } public static void main(String[] args) { String path = Path.getCurrentPath() + \"/config/zzjodis.properties\"; ConfigReadUtil configReadUtil = new ConfigReadUtil(path); try { JedisResourcePool jedisResourcePool = RoundRobinJedisPool. create() .curatorClient(configReadUtil.getString(\"jodisZkStr\"), 5000) .zkProxyDir(configReadUtil.getString(\"zkProxyDir\")) .team(configReadUtil.getString(\"team\")) .connectionTimeoutMs(configReadUtil.getInt(\"connectionTimeoutMs\")) .soTimeoutMs(configReadUtil.getInt(\"soTimeoutMs\")) .appKey(configReadUtil.getString(\"appKey\")) .password(\"\".equals(configReadUtil.getString(\"password\")) ? null : configReadUtil.getString(\"password\")) .build(); BloomFilterUtils bloomFilterUtils = new BloomFilterUtils(10000, 0.01, jedisResourcePool); bloomFilterUtils.add(\"filter01\", \"element001\", 30 * 60); System.out.println(bloomFilterUtils.contains(\"filter01\", \"element001\")); // true System.out.println(bloomFilterUtils.contains(\"filter01\", \"element002\")); // false } catch (Exception e) { e.printStackTrace(); } } } 布隆过滤器商业运用 业务场景 在C1看视频得曝光活动项目中，为了在个人中心页为拥有在架商品的用户展示活动入口，需要高效地判断用户是否有在架商品。目前存在上亿存量用户和上百万的在架商品用户。每次用户进入个人中心页时，需要查询用户是否有在架商品，以确定是否展示活动入口。\n然而，直接查询商品服务会导致大量的重复查询和增加服务耗时。可以使用布隆过滤器来优化此过程，它只需要几十MB内存，相比于使用Redis存储每日在架商品用户需要几GB内存，更加高效节省内存消耗。\n布隆过滤器选择 实现方式 储存位置 适用场景 备注 Guava 机器 单机 只需要机器内存不需要其他资源 Redisson redis 分布式 连接Redis即可使用 Redis插件 redis 分布式 需要对redis集群进行设置支持布隆过滤器插件 Redis的bitMap redis 分布式 需要自己实现添加和查询 对于分布式服务环境，Guava方式不适合使用，而Redis插件需要复杂的配置和高成本支持。相比之下，Redisson连接Redis并进行插入和查询的方式更适合当前场景，因此最终选择了Redisson方式。\n使用布隆过滤器效果 内存占用情况 上线初期，我们将符合条件的用户存入Codis缓存中。这使得内存从1.98GB增长到9.52GB，此次数据量占用了7.54GB的内存。 随后，为进一步优化，我们成功将用户量缩小了25倍。这使得内存占用降至308.8MB。 最终，我们切换到了Redisson方式使用布隆过滤器。这次Redis内存从2.7172GB增长到2.7566GB，而数据量仅占用39.4MB的内存。 使用Codis内存占用情况\n插入数据前：1.9G\n插入数据后：9.5G\n使用布隆过滤器内存占用情况：\n插入数据前：2.71G\n插入数据后：2.75G\n性能提升 通过使用布隆过滤器减少对商品服务的查询，从而提升服务性能。之前需要查询商品服务来判断用户商品状态，但使用布隆过滤器后，减少了这部分服务间的调用耗时，整体流程的耗时减少了大约5ms。\n",
  "wordCount" : "5340",
  "inLanguage": "en",
  "datePublished": "2024-03-29T10:57:33Z",
  "dateModified": "2024-03-29T10:57:33Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath:  [['\\(', '\\)'], ['$', '$']],  
    }
  };
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      布隆过滤器
    </h1>
    <div class="post-meta"><span title='2024-03-29 10:57:33 +0000 UTC'>2024-03-29</span>&nbsp;·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%a6%82%e8%bf%b0" aria-label="概述">概述</a><ul>
                        
                <li>
                    <a href="#%e5%b8%83%e9%9a%86%e8%bf%87%e6%bb%a4%e5%99%a8%e7%ae%80%e4%bb%8b" aria-label="布隆过滤器简介">布隆过滤器简介</a><ul>
                        
                <li>
                    <a href="#%e4%bc%98%e7%82%b9" aria-label="优点">优点</a></li>
                <li>
                    <a href="#%e7%bc%ba%e7%82%b9" aria-label="缺点">缺点</a></li>
                <li>
                    <a href="#%e9%80%82%e7%94%a8%e5%9c%ba%e6%99%af" aria-label="适用场景">适用场景</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%b8%83%e9%9a%86%e8%bf%87%e6%bb%a4%e5%99%a8%e5%8e%9f%e7%90%86" aria-label="布隆过滤器原理">布隆过滤器原理</a><ul>
                        
                <li>
                    <a href="#%e7%bb%93%e6%9e%84" aria-label="结构">结构</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0%e5%85%83%e7%b4%a0" aria-label="添加元素">添加元素</a></li>
                <li>
                    <a href="#%e6%9f%a5%e8%af%a2%e5%85%83%e7%b4%a0" aria-label="查询元素">查询元素</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b8%83%e9%9a%86%e8%bf%87%e6%bb%a4%e5%99%a8%e8%af%af%e5%88%a4%e7%8e%87" aria-label="布隆过滤器误判率">布隆过滤器误判率</a><ul>
                        
                <li>
                    <a href="#%e5%8f%82%e6%95%b0" aria-label="参数">参数</a></li>
                <li>
                    <a href="#%e6%8e%a8%e5%af%bc%e8%bf%87%e7%a8%8b" aria-label="推导过程">推导过程</a></li>
                <li>
                    <a href="#%e8%af%af%e5%88%a4%e7%8e%87%e5%85%ac%e5%bc%8f" aria-label="误判率公式">误判率公式</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e6%96%b9%e6%a1%88" aria-label="实现方案">实现方案</a><ul>
                        
                <li>
                    <a href="#guava%e5%ae%9e%e7%8e%b0" aria-label="Guava实现">Guava实现</a></li>
                <li>
                    <a href="#redis%e5%ae%9e%e7%8e%b0" aria-label="Redis实现">Redis实现</a><ul>
                        
                <li>
                    <a href="#%e5%bc%80%e6%ba%90redisson%e6%96%b9%e5%bc%8f" aria-label="开源Redisson方式">开源Redisson方式</a></li>
                <li>
                    <a href="#redis-40-%e5%ae%98%e6%96%b9%e6%8f%90%e4%be%9b%e5%b8%83%e9%9a%86%e8%bf%87%e6%bb%a4%e5%99%a8%e6%8f%92%e4%bb%b6" aria-label="Redis 4.0 官方提供布隆过滤器插件">Redis 4.0 官方提供布隆过滤器插件</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87redis%e6%8f%90%e4%be%9b%e7%9a%84bitmap%e8%87%aa%e5%b7%b1%e5%ae%9e%e7%8e%b0" aria-label="通过Redis提供的bitMap自己实现">通过Redis提供的bitMap自己实现</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%b8%83%e9%9a%86%e8%bf%87%e6%bb%a4%e5%99%a8%e5%95%86%e4%b8%9a%e8%bf%90%e7%94%a8" aria-label="布隆过滤器商业运用">布隆过滤器商业运用</a><ul>
                        
                <li>
                    <a href="#%e4%b8%9a%e5%8a%a1%e5%9c%ba%e6%99%af" aria-label="业务场景">业务场景</a></li>
                <li>
                    <a href="#%e5%b8%83%e9%9a%86%e8%bf%87%e6%bb%a4%e5%99%a8%e9%80%89%e6%8b%a9" aria-label="布隆过滤器选择">布隆过滤器选择</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e5%b8%83%e9%9a%86%e8%bf%87%e6%bb%a4%e5%99%a8%e6%95%88%e6%9e%9c" aria-label="使用布隆过滤器效果">使用布隆过滤器效果</a><ul>
                        
                <li>
                    <a href="#%e5%86%85%e5%ad%98%e5%8d%a0%e7%94%a8%e6%83%85%e5%86%b5" aria-label="内存占用情况">内存占用情况</a></li>
                <li>
                    <a href="#%e6%80%a7%e8%83%bd%e6%8f%90%e5%8d%87" aria-label="性能提升">性能提升</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="概述">概述<a hidden class="anchor" aria-hidden="true" href="#概述">#</a></h1>
<p>在互联网中，我们经常遇到需要在大量数据中判断目标数据是否存在的情况。例如，在网络爬虫中，我们需要判断某个网址是否已经被访问过。为了实现这一功能，通常需要使用一个容器来存储已访问过的网址。如果将这些数据直接存储在磁盘中，每次判断都要进行磁盘查询，这将导致大量的IO操作，效率较低。</p>
<p>因此，我们希望将这些数据保存在内存中。在数据量较小的情况下，可以使用Redis来存储这些数据。但是，当数据量超过上千万时，将会消耗几GB甚至几十GB的内存空间。然而，对于仅需要记录数据是否存在的情况而言，这样使用大量内存显然是浪费的。为了解决这个问题，我们可以使用布隆过滤器(Bloom Filter)。布隆过滤器是一种占用空间少且时间效率高的工具。</p>
<p>参考：https://mp.weixin.qq.com/s/dULRkxnN3nYrICiKZ1-sZw</p>
<h2 id="布隆过滤器简介">布隆过滤器简介<a hidden class="anchor" aria-hidden="true" href="#布隆过滤器简介">#</a></h2>
<p>布隆过滤器（Bloom Filter）是1970年由布隆提出的，它实质上是一个很长的二进制向量和一系列随机映射函数 (Hash函数)。</p>
<p>作用：它是一个空间效率高的概率型数据结构，用来告诉你:<strong>一个元素一定不存在或者可能存在</strong>。</p>
<h3 id="优点"><strong>优点</strong><a hidden class="anchor" aria-hidden="true" href="#优点">#</a></h3>
<ul>
<li>相比于其它的数据结构，布隆过滤器在空间和时间方面都有巨大的优势。布隆过滤器存储空间和插入/查询时间都是常数（即hash函数的个数）。</li>
<li>Hash 函数相互之间没有关系，方便由硬件并行实现。</li>
<li>布隆过滤器不需要存储元素本身，在某些对保密要求非常严格的场合有优势。</li>
<li>布隆过滤器可以表示全集，其它任何数据结构都不能。</li>
</ul>
<h3 id="缺点"><strong>缺点</strong><a hidden class="anchor" aria-hidden="true" href="#缺点">#</a></h3>
<ul>
<li>有误判率存在。</li>
<li>不支持删除。</li>
</ul>
<h3 id="适用场景"><strong>适用场景</strong><a hidden class="anchor" aria-hidden="true" href="#适用场景">#</a></h3>
<ul>
<li>预防缓存穿透：布隆过滤器快速判断数据是否存在，避免通过查询数据库来判断数据是否存在。</li>
<li>网络爬虫：布隆过滤器可以用来去重已经爬取过的URL。</li>
<li>邮箱的垃圾邮件过滤。</li>
<li>黑白名单。</li>
</ul>
<h1 id="布隆过滤器原理">布隆过滤器原理<a hidden class="anchor" aria-hidden="true" href="#布隆过滤器原理">#</a></h1>
<h2 id="结构">结构<a hidden class="anchor" aria-hidden="true" href="#结构">#</a></h2>
<p>布隆过滤器实现原理就是<strong>一个超大位数的数组和多个不同Hash算法函数</strong>。假设位数组的长度为 m，哈希函数的个数为 k。如下图，一个长度16位的数组，3个不同Hash算法函数，数组里面存储的是 bit 位，只放 0 和 1，初始为 0。</p>
<p>不同Hash算法函数</p>
<p><img loading="lazy" src="1.png" alt=""  />
</p>
<p>指定长度数组：</p>
<p><img loading="lazy" src="2.png" alt=""  />
</p>
<h2 id="添加元素">添加元素<a hidden class="anchor" aria-hidden="true" href="#添加元素">#</a></h2>
<p>将要添加的元素分别通过k个哈希函数计算得到k个哈希值，这k个hash值对应位数组上的k个位置，然后将这k个位置设置为1。</p>
<p>我们添加一个data1和data2两个元素，两个元素根据三个hash算法函数计算出的值，注意，三个值可能会存在相同的值。</p>
<p>其中data1计算出1、8、13三值，我们把数组中对应的位置设置为1。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Hash1(data1)=1
</span></span><span style="display:flex;"><span>Hash2(data1)=8
</span></span><span style="display:flex;"><span>Hash3(data1)=13
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="3.png" alt=""  />
</p>
<p>data2计算出2、5、13三值，我们把数组中对应的位置设置为1</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Hash1(data2)=2
</span></span><span style="display:flex;"><span>Hash2(data2)=5
</span></span><span style="display:flex;"><span>Hash3(data2)=13
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="4.png" alt=""  />
</p>
<p>我们发现data1和data2经过hash函数后，出现了一个相同值，这种是正常的，也正是因为这种情况的存在，需要多个函数来保证每个元素尽可能对应数组位置的唯一性，可以看下两个元素在一起的效果。</p>
<p><img loading="lazy" src="5.png" alt=""  />
</p>
<p>当不同元素在不同或者相同的hash函数计算后，得到同一个值，依旧只需要这个位置保持1即可。</p>
<h2 id="查询元素">查询元素<a hidden class="anchor" aria-hidden="true" href="#查询元素">#</a></h2>
<p>将要查询的元素分别通过k个哈希函数计算得到k个哈希值，这k个hash值对应位数组上的k个位置。如果这k个位置中有一个位置为0，则此元素一定不存在集合中。如果这k个位置全部为1，则这个元素可能存在。</p>
<p>我们在刚才添加过data1和data2两个元素的布隆过滤器查询以下三种元素，data1已添加到布隆过滤器元素，data3和data4都是未添加到布隆过滤器元素。</p>
<p>查询data1先根据添加时的三个hash函数计算分别对应值，值分别是1、8、13，然后查询数组中这三个位置的值是否为1。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Hash1(data1)=1
</span></span><span style="display:flex;"><span>Hash2(data1)=8
</span></span><span style="display:flex;"><span>Hash3(data1)=13
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="6.png" alt=""  />
</p>
<p>我们可以看到数组中1、8、13这三个位置都是1，data1可能存在于该布隆过滤器。我们从添加的角度来看，我们知道data1是一定存在于该布隆过滤器的，为什么还要是说可能呢，是因为查询出来三个位置都为1不能代表这个三个1都是同一个元素添加的，下面我们看下元素data3的查询。</p>
<p>查询data3先根据添加时的三个hash函数计算分别对应值，值分别是2、8、13，然后查询数组中这三个位置的值是否为1。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Hash1(data3)=2
</span></span><span style="display:flex;"><span>Hash2(data3)=8
</span></span><span style="display:flex;"><span>Hash3(data3)=13
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="7.png" alt=""  />
</p>
<p>我们已知的该布隆过滤器我们没有添加给data3，为什么data3查询出来三个位置的值都为1呢。我们可以看到data3所命中的位置分别是data2添加时把位置2赋值的1，和data1添加时把位置8和位置13赋值的1，都是由其他元素改变的位置对应的值，所以命中位置全部为1。这个元素可能存在。</p>
<p>我们查询一下data4，看下命中位置不全为0的数据。查询data4先根据添加时的三个hash函数计算分别对应值，值分别是2、8、13，然后查询数组中这三个位置的值是否为1。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Hash1(data4)=1
</span></span><span style="display:flex;"><span>Hash2(data4)=8
</span></span><span style="display:flex;"><span>Hash3(data4)=12
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="8.png" alt=""  />
</p>
<p>我们可以看到data4元素的hash函数3计算之后的值是12，数组位置12的值是0，没有元素在位置12赋值过1。如果data4存在于该布隆过滤器，则一定在添加data4时会把位置12赋值1，此时位置12还是0，则说明该布隆过滤器未添加过data4元素，所以位置中有一个位置为0。则此元素一定不存在布隆过滤器中。</p>
<h1 id="布隆过滤器误判率">布隆过滤器误判率<a hidden class="anchor" aria-hidden="true" href="#布隆过滤器误判率">#</a></h1>
<p>刚才查询时我们发现data3没有添加过到布隆过滤器，却在布隆过滤器查询到了，这种情况就是布隆过滤器误判了。那可以不存在误判或者减少误判吗？事实上误判是一定存在的，我们可以<strong>尽可能减小误判</strong>。下面说下如何得到误判率。</p>
<h2 id="参数">参数<a hidden class="anchor" aria-hidden="true" href="#参数">#</a></h2>
<p>m：布隆过滤器的bit长度。
n：插入过滤器的元素个数。
k：哈希函数的个数。</p>
<h2 id="推导过程">推导过程<a hidden class="anchor" aria-hidden="true" href="#推导过程">#</a></h2>
<p><img loading="lazy" src="9.png" alt=""  />
</p>
<h2 id="误判率公式">误判率公式<a hidden class="anchor" aria-hidden="true" href="#误判率公式">#</a></h2>
<p><img loading="lazy" src="10.png" alt=""  />
</p>
<h1 id="实现方案">实现方案<a hidden class="anchor" aria-hidden="true" href="#实现方案">#</a></h1>
<h2 id="guava实现">Guava实现<a hidden class="anchor" aria-hidden="true" href="#guava实现">#</a></h2>
<p>guava是谷歌开源工具类，其中就有能直接实现布隆过滤器的方法，不需要重复造轮子。</p>
<table>
<thead>
<tr>
<th style="text-align:left">方法名</th>
<th style="text-align:left">功能</th>
<th style="text-align:left">参数</th>
<th style="text-align:left">返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">put</td>
<td style="text-align:left">添加元素</td>
<td style="text-align:left">put(T object)</td>
<td style="text-align:left">boolean</td>
</tr>
<tr>
<td style="text-align:left">mightContain</td>
<td style="text-align:left">检查元素是否存在</td>
<td style="text-align:left">mightContain(T object)</td>
<td style="text-align:left">boolean</td>
</tr>
<tr>
<td style="text-align:left">copy</td>
<td style="text-align:left">根据此实例创建一个新的BloomFilte</td>
<td style="text-align:left">copy()</td>
<td style="text-align:left">BloomFilter</td>
</tr>
<tr>
<td style="text-align:left">approximateElementCount</td>
<td style="text-align:left">已添加到Bloom过滤器的元素的数量</td>
<td style="text-align:left">approximateElementCount()</td>
<td style="text-align:left">long</td>
</tr>
<tr>
<td style="text-align:left">expectedFpp</td>
<td style="text-align:left">返回元素存在的错误概率</td>
<td style="text-align:left">expectedFpp()</td>
<td style="text-align:left">double</td>
</tr>
<tr>
<td style="text-align:left">isCompatible</td>
<td style="text-align:left">确定给定的Bloom筛选器是否与此Bloom筛选器兼容</td>
<td style="text-align:left">isCompatible(BloomFilterthat)</td>
<td style="text-align:left">boolean</td>
</tr>
<tr>
<td style="text-align:left">putAll</td>
<td style="text-align:left">通过执行的逐位OR将此Bloom过滤器与另一个Bloom过滤器组合</td>
<td style="text-align:left">putAll(BloomFilterthat)</td>
<td style="text-align:left">void</td>
</tr>
</tbody>
</table>
<p>引入依赖</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>com.google.guava<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>guava<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>23.0<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试代码</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> GuavaBloomFilter() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建布隆过滤器对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    BloomFilter bloomFilter = BloomFilter.<span style="color:#007f7f">create</span>(Funnels.<span style="color:#007f7f">stringFunnel</span>(Charset.<span style="color:#007f7f">defaultCharset</span>()),EXPECTED_INSERTIONS,FALSE_PROBABILITY);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 向过滤器中添加元素
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    bloomFilter.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;element001&#34;</span>);
</span></span><span style="display:flex;"><span>    bloomFilter.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;element003&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 判断元素是否存在
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilter.<span style="color:#007f7f">mightContain</span>(<span style="color:#0ff;font-weight:bold">&#34;element001&#34;</span>));<span style="color:#007f7f">//true
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilter.<span style="color:#007f7f">mightContain</span>(<span style="color:#0ff;font-weight:bold">&#34;element002&#34;</span>));<span style="color:#007f7f">//false
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 已添加到Bloom过滤器的元素的数量
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilter.<span style="color:#007f7f">approximateElementCount</span>());<span style="color:#007f7f">// 2
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 返回元素存在的错误概率
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilter.<span style="color:#007f7f">expectedFpp</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="redis实现">Redis实现<a hidden class="anchor" aria-hidden="true" href="#redis实现">#</a></h2>
<h3 id="开源redisson方式">开源Redisson方式<a hidden class="anchor" aria-hidden="true" href="#开源redisson方式">#</a></h3>
<p>Redisson方法</p>
<table>
<thead>
<tr>
<th style="text-align:left">方法名</th>
<th style="text-align:left">功能</th>
<th style="text-align:left">参数</th>
<th style="text-align:left">返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">add</td>
<td style="text-align:left">添加元素</td>
<td style="text-align:left">add(T object)</td>
<td style="text-align:left">boolean</td>
</tr>
<tr>
<td style="text-align:left">contains</td>
<td style="text-align:left">检查元素是否存在</td>
<td style="text-align:left">contains(T object)</td>
<td style="text-align:left">boolean</td>
</tr>
<tr>
<td style="text-align:left">count</td>
<td style="text-align:left">已添加到Bloom过滤器的元素的数量</td>
<td style="text-align:left">count()</td>
<td style="text-align:left">long</td>
</tr>
<tr>
<td style="text-align:left">getExpectedInsertions</td>
<td style="text-align:left">返回的预期插入元素的个数</td>
<td style="text-align:left">getExpectedInsertions()</td>
<td style="text-align:left">long</td>
</tr>
<tr>
<td style="text-align:left">getFalseProbability</td>
<td style="text-align:left">返回元素存在的错误概率</td>
<td style="text-align:left">getFalseProbability()</td>
<td style="text-align:left">double</td>
</tr>
<tr>
<td style="text-align:left">getHashIterations</td>
<td style="text-align:left">返回每个元素使用的哈希迭代次数</td>
<td style="text-align:left">getHashIterations()</td>
<td style="text-align:left">int</td>
</tr>
<tr>
<td style="text-align:left">getSize</td>
<td style="text-align:left">返回此实例所需Redis内存的位数</td>
<td style="text-align:left">getSize()</td>
<td style="text-align:left">long</td>
</tr>
<tr>
<td style="text-align:left">tryInit</td>
<td style="text-align:left">初始化Bloom筛选器参数</td>
<td style="text-align:left">tryInit(long expectedInsertions, double falseProbability)</td>
<td style="text-align:left">boolean</td>
</tr>
<tr>
<td style="text-align:left">delete</td>
<td style="text-align:left">删除对象</td>
<td style="text-align:left">delete()</td>
<td style="text-align:left">boolean</td>
</tr>
</tbody>
</table>
<p>引入依赖</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.redisson<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>redisson<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.22.1<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试代码</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> RedissonBloomFilter() {
</span></span><span style="display:flex;"><span>    Config config = <span style="color:#fff;font-weight:bold">new</span> Config();
</span></span><span style="display:flex;"><span>    config.<span style="color:#007f7f">useSingleServer</span>().<span style="color:#007f7f">setAddress</span>(<span style="color:#0ff;font-weight:bold">&#34;redis://&#34;</span> + REDIS_IP + <span style="color:#0ff;font-weight:bold">&#34;:&#34;</span> + REDIS_PORT);
</span></span><span style="display:flex;"><span>    config.<span style="color:#007f7f">useSingleServer</span>().<span style="color:#007f7f">setPassword</span>(REDIS_PASSWORD);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 获取客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    RedissonClient redissonClient = Redisson.<span style="color:#007f7f">create</span>(config);
</span></span><span style="display:flex;"><span>    RBloomFilter&lt;String&gt; bloomFilter = redissonClient.<span style="color:#007f7f">getBloomFilter</span>(BLOOM_FILTER_NAME);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 初始化布隆过滤器：预期插入量为100000000L,预期错误概率为1%
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    bloomFilter.<span style="color:#007f7f">tryInit</span>(EXPECTED_INSERTIONS, FALSE_PROBABILITY);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 插入数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    bloomFilter.<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;element001&#34;</span>);
</span></span><span style="display:flex;"><span>    bloomFilter.<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;element003&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 判断下面元素是否在布隆过滤器中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilter.<span style="color:#007f7f">contains</span>(<span style="color:#0ff;font-weight:bold">&#34;element002&#34;</span>));<span style="color:#007f7f">//false
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilter.<span style="color:#007f7f">contains</span>(<span style="color:#0ff;font-weight:bold">&#34;element001&#34;</span>));<span style="color:#007f7f">//true
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 已添加到Bloom过滤器的元素的数量
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilter.<span style="color:#007f7f">count</span>());<span style="color:#007f7f">//2
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 预期插入元素的个数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilter.<span style="color:#007f7f">getExpectedInsertions</span>());<span style="color:#007f7f">//1000000
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 元素存在的错误概率
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilter.<span style="color:#007f7f">getFalseProbability</span>());<span style="color:#007f7f">//0.01
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 每个元素使用的哈希迭代次数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilter.<span style="color:#007f7f">getHashIterations</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 实例所需Redis内存的位数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilter.<span style="color:#007f7f">getSize</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="redis-40-官方提供布隆过滤器插件">Redis 4.0 官方提供布隆过滤器插件<a hidden class="anchor" aria-hidden="true" href="#redis-40-官方提供布隆过滤器插件">#</a></h3>
<p>基础命令</p>
<table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">功能</th>
<th style="text-align:left">参数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">BF.RESERVE</td>
<td style="text-align:left">创建一个大小为capacity，错误率为error_rate的空的Bloom</td>
<td style="text-align:left">BF.RESERVE {key} {error_rate} {capacity} [EXPANSION {expansion}] [NONSCALING]</td>
</tr>
<tr>
<td style="text-align:left">BF.ADD</td>
<td style="text-align:left">向key指定的Bloom中添加一个元素itom</td>
<td style="text-align:left">BF.ADD {key} {item}</td>
</tr>
<tr>
<td style="text-align:left">BF.MADD</td>
<td style="text-align:left">向key指定的Bloom中添加多个元案</td>
<td style="text-align:left">BF.MADD {key} {item &hellip;}</td>
</tr>
<tr>
<td style="text-align:left">BF.INSERT</td>
<td style="text-align:left">向key指定的Bloom中添加多个元素，添加时可以指定大小和错误率，且可以控制在Bloom不存在的时候是否自动创建</td>
<td style="text-align:left">BF.INSERT {key} [CAPACITY {cap}] [ERROR {error}] [EXPANSION {expansion}] [NOCREATE] [NONSCALING] ITEMS {item &hellip;}</td>
</tr>
<tr>
<td style="text-align:left">BF.EXISTS</td>
<td style="text-align:left">检查一个元秦是否可能存在于key指定的Bloom中</td>
<td style="text-align:left">BF.EXISTS {key} {item}</td>
</tr>
<tr>
<td style="text-align:left">BF.MEXISTS</td>
<td style="text-align:left">同时检查多个元素是否可能存在于key指定的Bloom中</td>
<td style="text-align:left">BF.MEXISTS {key} {item &hellip;}</td>
</tr>
<tr>
<td style="text-align:left">BF.SCANDUMP</td>
<td style="text-align:left">对Bloom进行增量持久化操作</td>
<td style="text-align:left">BF.SCANDUMP {key} {iter}</td>
</tr>
<tr>
<td style="text-align:left">BF.LOADCHUNK</td>
<td style="text-align:left">加载SCANDUMP持久化的Bloom数据</td>
<td style="text-align:left">BF.LOADCHUNK {key} {iter} {data}</td>
</tr>
<tr>
<td style="text-align:left">BF.INFO</td>
<td style="text-align:left">查询key指定的Bloom的信息</td>
<td style="text-align:left">BF.INFO {key}</td>
</tr>
<tr>
<td style="text-align:left">BF.DEBUG</td>
<td style="text-align:left">查看BloomFilter的内部详细信息(如每层的元素个数，错误率等)</td>
<td style="text-align:left">BF.DEBUG (key}</td>
</tr>
</tbody>
</table>
<p>引入依赖</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>redis.clients<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>jedis<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>4.2.0<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试代码</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> RedisBloomFilter() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 建立连接
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    BloomFilterCommands bloomFilterCommands = <span style="color:#fff;font-weight:bold">new</span> JedisPooled(REDIS_IP, REDIS_PORT, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, REDIS_PASSWORD);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 构建布隆过滤器参数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    BFReserveParams bfReserveParams = <span style="color:#fff;font-weight:bold">new</span> BFReserveParams();
</span></span><span style="display:flex;"><span>    bfReserveParams.<span style="color:#007f7f">expansion</span>(<span style="color:#ff0;font-weight:bold">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建一个过滤器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    String test = bloomFilterCommands.<span style="color:#007f7f">bfReserve</span>(BLOOM_FILTER_NAME, FALSE_PROBABILITY, EXPECTED_INSERTIONS, bfReserveParams);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 向过滤器中添加元素
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    bloomFilterCommands.<span style="color:#007f7f">bfAdd</span>(BLOOM_FILTER_NAME, <span style="color:#0ff;font-weight:bold">&#34;element001&#34;</span>);
</span></span><span style="display:flex;"><span>    bloomFilterCommands.<span style="color:#007f7f">bfAdd</span>(BLOOM_FILTER_NAME, <span style="color:#0ff;font-weight:bold">&#34;element003&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 判断元素是否存在
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilterCommands.<span style="color:#007f7f">bfExists</span>(BLOOM_FILTER_NAME, <span style="color:#0ff;font-weight:bold">&#34;element001&#34;</span>));<span style="color:#007f7f">//true
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilterCommands.<span style="color:#007f7f">bfExists</span>(BLOOM_FILTER_NAME, <span style="color:#0ff;font-weight:bold">&#34;element002&#34;</span>));<span style="color:#007f7f">//false
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="通过redis提供的bitmap自己实现">通过Redis提供的bitMap自己实现<a hidden class="anchor" aria-hidden="true" href="#通过redis提供的bitmap自己实现">#</a></h3>
<p>自定义方法</p>
<table>
<thead>
<tr>
<th style="text-align:left">方法名</th>
<th style="text-align:left">功能</th>
<th style="text-align:left">参数</th>
<th style="text-align:left">返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">add</td>
<td style="text-align:left">添加元素</td>
<td style="text-align:left">add(String key, String element, int expireSec)</td>
<td style="text-align:left">boolean</td>
</tr>
<tr>
<td style="text-align:left">contains</td>
<td style="text-align:left">检查元素是否存在</td>
<td style="text-align:left">contains(String key, String element)</td>
<td style="text-align:left">boolean</td>
</tr>
<tr>
<td style="text-align:left">getExpectedInsertions</td>
<td style="text-align:left">返回的预期插入元素的个数</td>
<td style="text-align:left">getExpectedInsertions()</td>
<td style="text-align:left">long</td>
</tr>
<tr>
<td style="text-align:left">getFalseProbability</td>
<td style="text-align:left">返回元素存在的错误概率</td>
<td style="text-align:left">getFalseProbability()</td>
<td style="text-align:left">double</td>
</tr>
<tr>
<td style="text-align:left">getNumHashFunctions</td>
<td style="text-align:left">返回每个元素使用的哈希迭代次数</td>
<td style="text-align:left">getNumHashFunctions()</td>
<td style="text-align:left">int</td>
</tr>
<tr>
<td style="text-align:left">getBitmapLength</td>
<td style="text-align:left">返回Bitmap长度</td>
<td style="text-align:left">getBitmapLength()</td>
<td style="text-align:left">long</td>
</tr>
<tr>
<td style="text-align:left">BloomFilterUtils</td>
<td style="text-align:left">创建Bloom对象</td>
<td style="text-align:left">BloomFilterUtils(long expectedInsertions, double falseProbability)</td>
<td style="text-align:left">BloomFilterUtils</td>
</tr>
</tbody>
</table>
<p>测试代码</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">165
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> BloomFilterUtils {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> String BF_KEY_PREFIX = <span style="color:#0ff;font-weight:bold">&#34;bf_&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span> numApproxElements;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">double</span> falseProbability;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// hash个数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> numHashFunctions;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 数组长度
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">int</span> bitmapLength;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> JedisResourcePool jedisResourcePool;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 构造布隆过滤器。注意：在同一业务场景下，三个参数务必相同
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param numApproxElements 预估元素数量
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param fpp               可接受的最大误差
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param jedisResourcePool Codis专用的Jedis连接池
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> BloomFilterUtils(Long numApproxElements, <span style="color:#fff;font-weight:bold">double</span> fpp, JedisResourcePool jedisResourcePool) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">numApproxElements</span> = numApproxElements;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">falseProbability</span> = fpp;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">jedisResourcePool</span> = jedisResourcePool;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 数组长度 m = (n * lnp)/ln2^2
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        bitmapLength = (<span style="color:#fff;font-weight:bold">int</span>) (-numApproxElements * Math.<span style="color:#007f7f">log</span>(fpp) / (Math.<span style="color:#007f7f">log</span>(<span style="color:#ff0;font-weight:bold">2</span>) * Math.<span style="color:#007f7f">log</span>(<span style="color:#ff0;font-weight:bold">2</span>)));
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// hash个数 k = (n / m ) * ln2
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        numHashFunctions = Math.<span style="color:#007f7f">max</span>(<span style="color:#ff0;font-weight:bold">1</span>, (<span style="color:#fff;font-weight:bold">int</span>) Math.<span style="color:#007f7f">round</span>((<span style="color:#fff;font-weight:bold">double</span>) bitmapLength / numApproxElements * Math.<span style="color:#007f7f">log</span>(<span style="color:#ff0;font-weight:bold">2</span>)));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 取得预估元素数量
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">long</span> getExpectedInsertions() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> numApproxElements;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 返回元素存在的错误概率
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">double</span> getFalseProbability() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> falseProbability;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 取得自动计算的最优哈希函数个数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">int</span> getNumHashFunctions() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> numHashFunctions;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 取得自动计算的最优Bitmap长度
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">int</span> getBitmapLength() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bitmapLength;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 计算一个元素值哈希后映射到Bitmap的哪些bit上
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param element 元素值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return bit下标的数组
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">long</span>[] getBitIndices(String element) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span>[] indices = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">long</span>[numHashFunctions];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 元素  使用MurMurHash3 128位Hash算法转换值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">byte</span>[] bytes = Hashing.<span style="color:#007f7f">murmur3_128</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">hashObject</span>(element, Funnels.<span style="color:#007f7f">stringFunnel</span>(Charset.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;UTF-8&#34;</span>)))
</span></span><span style="display:flex;"><span>            .<span style="color:#007f7f">asBytes</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 低8位转Long值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">long</span> hash1 = Longs.<span style="color:#007f7f">fromBytes</span>(
</span></span><span style="display:flex;"><span>            bytes[<span style="color:#ff0;font-weight:bold">7</span>], bytes[<span style="color:#ff0;font-weight:bold">6</span>], bytes[<span style="color:#ff0;font-weight:bold">5</span>], bytes[<span style="color:#ff0;font-weight:bold">4</span>], bytes[<span style="color:#ff0;font-weight:bold">3</span>], bytes[<span style="color:#ff0;font-weight:bold">2</span>], bytes[<span style="color:#ff0;font-weight:bold">1</span>], bytes[<span style="color:#ff0;font-weight:bold">0</span>]
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 高8位转Long值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">long</span> hash2 = Longs.<span style="color:#007f7f">fromBytes</span>(
</span></span><span style="display:flex;"><span>            bytes[<span style="color:#ff0;font-weight:bold">15</span>], bytes[<span style="color:#ff0;font-weight:bold">14</span>], bytes[<span style="color:#ff0;font-weight:bold">13</span>], bytes[<span style="color:#ff0;font-weight:bold">12</span>], bytes[<span style="color:#ff0;font-weight:bold">11</span>], bytes[<span style="color:#ff0;font-weight:bold">10</span>], bytes[<span style="color:#ff0;font-weight:bold">9</span>], bytes[<span style="color:#ff0;font-weight:bold">8</span>]
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">long</span> combinedHash = hash1;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 双重哈希进行散列
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i  &amp;lt; numHashFunctions; i++) {
</span></span><span style="display:flex;"><span>            indices[i] = (combinedHash &amp; Long.<span style="color:#007f7f">MAX_VALUE</span>) % bitmapLength;
</span></span><span style="display:flex;"><span>            combinedHash += hash2;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> indices;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 插入元素
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param key       原始Redis键，会自动加上&#39;bf_&#39;前缀
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param element   元素值，字符串类型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param expireSec 过期时间（秒）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> add(String key, String element, <span style="color:#fff;font-weight:bold">int</span> expireSec) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (key == <span style="color:#fff;font-weight:bold">null</span> || element == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> RuntimeException(<span style="color:#0ff;font-weight:bold">&#34;键值均不能为空&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        String actualKey = BF_KEY_PREFIX.<span style="color:#007f7f">concat</span>(key);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> (Jedis jedis = jedisResourcePool.<span style="color:#007f7f">getResource</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span> (Pipeline pipeline = jedis.<span style="color:#007f7f">pipelined</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 遍历元素所有hash结果的bit位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">long</span> index : getBitIndices(element)) {
</span></span><span style="display:flex;"><span>                    pipeline.<span style="color:#007f7f">setbit</span>(actualKey, index, <span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                pipeline.<span style="color:#007f7f">syncAndReturnAll</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            jedis.<span style="color:#007f7f">expire</span>(actualKey, expireSec);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 检查元素在集合中是否（可能）存在
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param key     原始Redis键，会自动加上&#39;bf_&#39;前缀
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param element 元素值，字符串类型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> contains(String key, String element) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (key == <span style="color:#fff;font-weight:bold">null</span> || element == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> RuntimeException(<span style="color:#0ff;font-weight:bold">&#34;键值均不能为空&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        String actualKey = BF_KEY_PREFIX.<span style="color:#007f7f">concat</span>(key);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">boolean</span> result = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> (Jedis jedis = jedisResourcePool.<span style="color:#007f7f">getResource</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 遍历元素所有hash结果的bit位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">try</span> (Pipeline pipeline = jedis.<span style="color:#007f7f">pipelined</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">long</span> index : getBitIndices(element)) {
</span></span><span style="display:flex;"><span>                    pipeline.<span style="color:#007f7f">getbit</span>(actualKey, index);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                result = !pipeline.<span style="color:#007f7f">syncAndReturnAll</span>().<span style="color:#007f7f">contains</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        String path = Path.<span style="color:#007f7f">getCurrentPath</span>() + <span style="color:#0ff;font-weight:bold">&#34;/config/zzjodis.properties&#34;</span>;
</span></span><span style="display:flex;"><span>        ConfigReadUtil configReadUtil = <span style="color:#fff;font-weight:bold">new</span> ConfigReadUtil(path);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            JedisResourcePool jedisResourcePool = RoundRobinJedisPool.
</span></span><span style="display:flex;"><span>                create()
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">curatorClient</span>(configReadUtil.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;jodisZkStr&#34;</span>), <span style="color:#ff0;font-weight:bold">5000</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">zkProxyDir</span>(configReadUtil.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;zkProxyDir&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">team</span>(configReadUtil.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;team&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">connectionTimeoutMs</span>(configReadUtil.<span style="color:#007f7f">getInt</span>(<span style="color:#0ff;font-weight:bold">&#34;connectionTimeoutMs&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">soTimeoutMs</span>(configReadUtil.<span style="color:#007f7f">getInt</span>(<span style="color:#0ff;font-weight:bold">&#34;soTimeoutMs&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">appKey</span>(configReadUtil.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;appKey&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">password</span>(<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>.<span style="color:#007f7f">equals</span>(configReadUtil.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;password&#34;</span>)) ? <span style="color:#fff;font-weight:bold">null</span> : configReadUtil.<span style="color:#007f7f">getString</span>(<span style="color:#0ff;font-weight:bold">&#34;password&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#007f7f">build</span>();
</span></span><span style="display:flex;"><span>            BloomFilterUtils bloomFilterUtils = <span style="color:#fff;font-weight:bold">new</span> BloomFilterUtils(<span style="color:#ff0;font-weight:bold">10000</span>, <span style="color:#ff0;font-weight:bold">0.01</span>, jedisResourcePool);
</span></span><span style="display:flex;"><span>            bloomFilterUtils.<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;filter01&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;element001&#34;</span>, <span style="color:#ff0;font-weight:bold">30</span> * <span style="color:#ff0;font-weight:bold">60</span>);
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilterUtils.<span style="color:#007f7f">contains</span>(<span style="color:#0ff;font-weight:bold">&#34;filter01&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;element001&#34;</span>));  <span style="color:#007f7f">// true
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(bloomFilterUtils.<span style="color:#007f7f">contains</span>(<span style="color:#0ff;font-weight:bold">&#34;filter01&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;element002&#34;</span>));  <span style="color:#007f7f">// false
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="布隆过滤器商业运用">布隆过滤器商业运用<a hidden class="anchor" aria-hidden="true" href="#布隆过滤器商业运用">#</a></h1>
<h2 id="业务场景">业务场景<a hidden class="anchor" aria-hidden="true" href="#业务场景">#</a></h2>
<p>在C1看视频得曝光活动项目中，为了在个人中心页为拥有在架商品的用户展示活动入口，需要高效地判断用户是否有在架商品。目前存在上亿存量用户和上百万的在架商品用户。每次用户进入个人中心页时，需要查询用户是否有在架商品，以确定是否展示活动入口。</p>
<p>然而，直接查询商品服务会导致大量的重复查询和增加服务耗时。可以使用布隆过滤器来优化此过程，它只需要几十MB内存，相比于使用Redis存储每日在架商品用户需要几GB内存，更加高效节省内存消耗。</p>
<h2 id="布隆过滤器选择">布隆过滤器选择<a hidden class="anchor" aria-hidden="true" href="#布隆过滤器选择">#</a></h2>
<table>
<thead>
<tr>
<th style="text-align:left">实现方式</th>
<th style="text-align:left">储存位置</th>
<th style="text-align:left">适用场景</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Guava</td>
<td style="text-align:left">机器</td>
<td style="text-align:left">单机</td>
<td style="text-align:left">只需要机器内存不需要其他资源</td>
</tr>
<tr>
<td style="text-align:left">Redisson</td>
<td style="text-align:left">redis</td>
<td style="text-align:left">分布式</td>
<td style="text-align:left">连接Redis即可使用</td>
</tr>
<tr>
<td style="text-align:left">Redis插件</td>
<td style="text-align:left">redis</td>
<td style="text-align:left">分布式</td>
<td style="text-align:left">需要对redis集群进行设置支持布隆过滤器插件</td>
</tr>
<tr>
<td style="text-align:left">Redis的bitMap</td>
<td style="text-align:left">redis</td>
<td style="text-align:left">分布式</td>
<td style="text-align:left">需要自己实现添加和查询</td>
</tr>
</tbody>
</table>
<p>对于分布式服务环境，Guava方式不适合使用，而Redis插件需要复杂的配置和高成本支持。相比之下，Redisson连接Redis并进行插入和查询的方式更适合当前场景，因此最终选择了Redisson方式。</p>
<h2 id="使用布隆过滤器效果">使用布隆过滤器效果<a hidden class="anchor" aria-hidden="true" href="#使用布隆过滤器效果">#</a></h2>
<h3 id="内存占用情况">内存占用情况<a hidden class="anchor" aria-hidden="true" href="#内存占用情况">#</a></h3>
<ol>
<li>上线初期，我们将符合条件的用户存入Codis缓存中。这使得内存从1.98GB增长到9.52GB，此次数据量占用了7.54GB的内存。</li>
<li>随后，为进一步优化，我们成功将用户量缩小了25倍。这使得内存占用降至308.8MB。</li>
<li>最终，我们切换到了Redisson方式使用布隆过滤器。这次Redis内存从2.7172GB增长到2.7566GB，而数据量仅占用39.4MB的内存。</li>
</ol>
<p>使用Codis内存占用情况</p>
<p>插入数据前：1.9G</p>
<p>插入数据后：9.5G</p>
<p>使用布隆过滤器内存占用情况：</p>
<p>插入数据前：2.71G</p>
<p>插入数据后：2.75G</p>
<h3 id="性能提升">性能提升<a hidden class="anchor" aria-hidden="true" href="#性能提升">#</a></h3>
<p>通过使用布隆过滤器减少对商品服务的查询，从而提升服务性能。之前需要查询商品服务来判断用户商品状态，但使用布隆过滤器后，减少了这部分服务间的调用耗时，整体流程的耗时减少了大约5ms。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>