<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>HashMap | Wjy&#39;s Blog</title>
<meta name="keywords" content="Collection">
<meta name="description" content="概述
HashMap是一个散列表（就是哈希表），哈希表就是一种以键-值(key-indexed)存储数据的结构。
HashMap 继承于AbstractMap，实现了Map、Cloneable、java.io.Serializable接口。
HashMap 的实现不是同步的，这意味着它不是线程安全的。它的key、value都可以为null。此外，HashMap中的映射不是有序的。">
<meta name="author" content="">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E9%9B%86%E5%90%88/hashmap/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="HashMap" />
<meta property="og:description" content="概述
HashMap是一个散列表（就是哈希表），哈希表就是一种以键-值(key-indexed)存储数据的结构。
HashMap 继承于AbstractMap，实现了Map、Cloneable、java.io.Serializable接口。
HashMap 的实现不是同步的，这意味着它不是线程安全的。它的key、value都可以为null。此外，HashMap中的映射不是有序的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/%E9%9B%86%E5%90%88/hashmap/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-12-20T14:49:20+00:00" />
<meta property="article:modified_time" content="2017-12-20T14:49:20+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HashMap"/>
<meta name="twitter:description" content="概述
HashMap是一个散列表（就是哈希表），哈希表就是一种以键-值(key-indexed)存储数据的结构。
HashMap 继承于AbstractMap，实现了Map、Cloneable、java.io.Serializable接口。
HashMap 的实现不是同步的，这意味着它不是线程安全的。它的key、value都可以为null。此外，HashMap中的映射不是有序的。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "HashMap",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/%E9%9B%86%E5%90%88/hashmap/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "HashMap",
  "name": "HashMap",
  "description": "概述 HashMap是一个散列表（就是哈希表），哈希表就是一种以键-值(key-indexed)存储数据的结构。 HashMap 继承于AbstractMap，实现了Map、Cloneable、java.io.Serializable接口。 HashMap 的实现不是同步的，这意味着它不是线程安全的。它的key、value都可以为null。此外，HashMap中的映射不是有序的。\n",
  "keywords": [
    "Collection"
  ],
  "articleBody": "概述 HashMap是一个散列表（就是哈希表），哈希表就是一种以键-值(key-indexed)存储数据的结构。 HashMap 继承于AbstractMap，实现了Map、Cloneable、java.io.Serializable接口。 HashMap 的实现不是同步的，这意味着它不是线程安全的。它的key、value都可以为null。此外，HashMap中的映射不是有序的。\nHashMap的实例有两个参数影响其性能：初始容量和加载因子 容量是哈希表中桶的数量，初始容量只是哈希表在创建时的容量。 加载因子是哈希表在其容量自动增长之前，可以达到多满的一种尺度。 当哈希表中的条目数超出了加载因子与当前容量的乘积时，则要对该哈希表进行rehash操作(即重建内部结构)，从而哈希表将具有两倍的桶数。 通常，默认加载因子是0.75， 这是在时间和空间成本上寻求一种折中。加载因子过高虽然减少了空间开销，但是也增加了查询成本（在大多数 HashMap 类的操作中，包括 get 和 put 操作，都反映了这一点）。 在设置初始容量时应该考虑到映射中所需的条目数及其加载因子，以便最大限度地减少 rehash 操作次数。如果初始容量大于最大条目数除以加载因子，则不会发生 rehash 操作。\n链式哈希表 链式哈希表从根本上说是由一组链表构成。 每个链表都可以看做是一个“桶”，我们将所有的元素通过散列的方式放到具体的不同的桶中。 插入元素时，首先将其键传入一个哈希函数（该过程称为哈希键），函数通过散列的方式告知元素属于哪个“桶”，然后在相应的链表头插入元素。 查找或删除元素时，用同样的方式先找到元素的“桶”，然后遍历相应的链表，直到发现我们想要的元素。 因为每个“桶”都是一个链表，所以链式哈希表并不限制包含元素的个数。然而，如果表变得太大，它的性能将会降低。\nJDK 1.8 对 HashMap 进行了比较大的优化，底层实现由之前的 “数组+链表” 改为 “数组+链表+红黑树”。JDK 1.8 的 HashMap 的数据结构如下图所示，当链表节点较少时仍然是以链表存在，当链表节点较多时（大于8）会转为红黑树。\n1、本文中头节点指的是 table 表上索引位置的节点，也就是链表的头节点。\n2、根节点（root 节点）指的是红黑树最上面的那个节点，也就是没有父节点的节点。\n3、红黑树的根节点不一定是索引位置的头节点（也就是链表的头节点），HashMap 通过 moveRootToFront 方法来维持红黑树的根结点就是索引位置的头结点，但是在 removeTreeNode 方法中，当 movable 为 false 时，不会调用 moveRootToFront 方法，此时红黑树的根节点不一定是索引位置的头节点，该场景发生在 HashIterator 的 remove 方法中。\n4、转为红黑树节点后，链表的结构还存在，通过 next 属性维持，红黑树节点在进行操作时都会维护链表的结构，并不是转为红黑树节点，链表结构就不存在了。\n5、在红黑树上，叶子节点也可能有 next 节点，因为红黑树的结构跟链表的结构是互不影响的，不会因为是叶子节点就说该节点已经没有 next 节点。\n6、源码中一些变量定义：如果定义了一个节点 p，则 pl（p left）为 p 的左节点，pr（p right）为 p 的右节点，pp（p parent）为 p 的父节点，ph（p hash）为 p 的 hash 值，pk（p key）为 p 的 key 值，kc（key class）为 key 的类等等。源码中很喜欢在 if/for 等语句中进行赋值并判断，请注意。\n7、链表中移除一个节点只需如下图操作，其他操作同理。\n8、红黑树在维护链表结构时，移除一个节点只需如下图操作（红黑树中增加了一个 prev 属性），其他操作同理。注：此处只是红黑树维护链表结构的操作，红黑树还需要单独进行红黑树的移除或者其他操作。\n9、源码中进行红黑树的查找时，会反复用到以下两条规则：1）如果目标节点的 hash 值小于 p 节点的 hash 值，则向 p 节点的左边遍历；否则向 p 节点的右边遍历。2）如果目标节点的 key 值小于 p 节点的 key 值，则向 p 节点的左边遍历；否则向 p 节点的右边遍历。这两条规则是利用了红黑树的特性（左节点 \u003c 根节点 \u003c 右节点）。\n10、源码中进行红黑树的查找时，会用 dir（direction）来表示向左还是向右查找，dir 存储的值是目标节点的 hash/key 与 p 节点的 hash/key 的比较结果。\n构造函数 1 2 3 4 5 6 7 8 // 默认构造函数。 HashMap() // 指定“容量大小”的构造函数 HashMap(int capacity) // 指定“容量大小”和“加载因子”的构造函数 HashMap(int capacity, float loadFactor) // 包含“子Map”的构造函数 HashMap(Map\u003c? extends K, ? extends V\u003e map) API 1 2 3 4 5 6 7 8 9 10 11 12 13 void clear() Object clone() boolean containsKey(Object key) boolean containsValue(Object value) Set",
  "wordCount" : "26358",
  "inLanguage": "en",
  "datePublished": "2017-12-20T14:49:20Z",
  "dateModified": "2017-12-20T14:49:20Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/%E9%9B%86%E5%90%88/hashmap/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="📚文章">
                    <span>📚文章</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="⏱时间轴">
                    <span>⏱时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="🔖标签">
                    <span>🔖标签</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="🔍搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍搜索</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/about" title="🙋🏻‍♂️关于">
                    <span>🙋🏻‍♂️关于</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/links" title="🤝友链">
                    <span>🤝友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title">
      HashMap
    </h1>
    <div class="post-meta"><span title='2017-12-20 14:49:20 +0000 UTC'>2017-12-20</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%a6%82%e8%bf%b0" aria-label="概述">概述</a></li>
                <li>
                    <a href="#%e6%9e%84%e9%80%a0%e5%87%bd%e6%95%b0" aria-label="构造函数">构造函数</a></li>
                <li>
                    <a href="#api" aria-label="API">API</a></li>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="数据结构">数据结构</a></li>
                <li>
                    <a href="#hashmap%e6%9e%84%e9%80%a0%e5%87%bd%e6%95%b0" aria-label="HashMap构造函数">HashMap构造函数</a></li>
                <li>
                    <a href="#hashmap%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%b1%9e%e6%80%a7" aria-label="HashMap的基本属性">HashMap的基本属性</a></li>
                <li>
                    <a href="#%e5%ae%9a%e4%bd%8d%e5%93%88%e5%b8%8c%e6%a1%b6%e6%95%b0%e7%bb%84%e7%b4%a2%e5%bc%95%e4%bd%8d%e7%bd%ae" aria-label="定位哈希桶数组索引位置">定位哈希桶数组索引位置</a></li>
                <li>
                    <a href="#get-%e6%96%b9%e6%b3%95" aria-label="get 方法">get 方法</a><ul>
                        
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%971gettreenode" aria-label="代码块1：getTreeNode">代码块1：getTreeNode</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%972find" aria-label="代码块2：find">代码块2：find</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%973comparableclassfor" aria-label="代码块3：comparableClassFor">代码块3：comparableClassFor</a></li></ul>
                </li>
                <li>
                    <a href="#put%e6%96%b9%e6%b3%95" aria-label="put方法">put方法</a><ul>
                        
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%974puttreeval" aria-label="代码块4：putTreeVal">代码块4：putTreeVal</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%975tiebreakorder" aria-label="代码块5：tieBreakOrder">代码块5：tieBreakOrder</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%976treeifybin" aria-label="代码块6：treeifyBin">代码块6：treeifyBin</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%977treeify" aria-label="代码块7：treeify">代码块7：treeify</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%978moveroottofront" aria-label="代码块8：moveRootToFront">代码块8：moveRootToFront</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%979checkinvariants" aria-label="代码块9：checkInvariants">代码块9：checkInvariants</a></li></ul>
                </li>
                <li>
                    <a href="#resize-%e6%96%b9%e6%b3%95" aria-label="resize 方法">resize 方法</a><ul>
                        
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%9710split" aria-label="代码块10：split">代码块10：split</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%9711untreeify" aria-label="代码块11：untreeify">代码块11：untreeify</a></li>
                <li>
                    <a href="#%e4%be%8b%e5%ad%901%e6%89%a9%e5%ae%b9%e5%90%8e%e8%8a%82%e7%82%b9%e9%87%8d-hash-%e4%b8%ba%e4%bb%80%e4%b9%88%e5%8f%aa%e5%8f%af%e8%83%bd%e5%88%86%e5%b8%83%e5%9c%a8-%e5%8e%9f%e7%b4%a2%e5%bc%95%e4%bd%8d%e7%bd%ae-%e4%b8%8e-%e5%8e%9f%e7%b4%a2%e5%bc%95--oldcap-%e4%bd%8d%e7%bd%ae-" aria-label="例子1：扩容后，节点重 hash 为什么只可能分布在 “原索引位置” 与 “原索引 &#43; oldCap 位置” ？">例子1：扩容后，节点重 hash 为什么只可能分布在 “原索引位置” 与 “原索引 + oldCap 位置” ？</a></li></ul>
                </li>
                <li>
                    <a href="#remove-%e6%96%b9%e6%b3%95" aria-label="remove 方法">remove 方法</a><ul>
                        
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%9d%9712removetreenode" aria-label="代码块12：removeTreeNode">代码块12：removeTreeNode</a></li>
                <li>
                    <a href="#%e8%a7%a3%e9%87%8a2%e5%85%b3%e4%ba%8e%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e5%b9%b3%e8%a1%a1%e8%b0%83%e6%95%b4" aria-label="解释2：关于红黑树的平衡调整？">解释2：关于红黑树的平衡调整？</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%ad%bb%e5%be%aa%e7%8e%af%e9%97%ae%e9%a2%98" aria-label="死循环问题">死循环问题</a></li>
                <li>
                    <a href="#jdk-18%e6%89%a9%e5%ae%b9%e8%bf%87%e7%a8%8b" aria-label="JDK 1.8扩容过程">JDK 1.8扩容过程</a><ul>
                        
                <li>
                    <a href="#%e5%85%b7%e4%bd%93%e6%89%a9%e5%ae%b9%e8%bf%87%e7%a8%8b" aria-label="具体扩容过程：">具体扩容过程：</a></li></ul>
                </li>
                <li>
                    <a href="#hashmap%e5%ae%9e%e7%8e%b0%e7%9a%84cloneable%e6%8e%a5%e5%8f%a3" aria-label="HashMap实现的Cloneable接口">HashMap实现的Cloneable接口</a></li>
                <li>
                    <a href="#hashmap%e9%81%8d%e5%8e%86%e6%96%b9%e5%bc%8f" aria-label="HashMap遍历方式">HashMap遍历方式</a><ul>
                        
                <li>
                    <a href="#%e9%81%8d%e5%8e%86%e9%94%ae%e5%80%bc%e5%af%b9" aria-label="遍历键值对">遍历键值对</a></li>
                <li>
                    <a href="#%e9%81%8d%e5%8e%86%e9%94%ae" aria-label="遍历键">遍历键</a></li>
                <li>
                    <a href="#%e9%81%8d%e5%8e%86%e5%80%bc" aria-label="遍历值">遍历值</a></li>
                <li>
                    <a href="#jdk18" aria-label="JDK1.8">JDK1.8</a></li></ul>
                </li>
                <li>
                    <a href="#hashmap%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b" aria-label="HashMap代码示例">HashMap代码示例</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li>
                <li>
                    <a href="#concurrenthashmap" aria-label="ConcurrentHashMap">ConcurrentHashMap</a><ul>
                        
                <li>
                    <a href="#jdk17%e4%b8%ad%e7%9a%84-concurrenthashmap" aria-label="jdk1.7中的 ConcurrentHashMap">jdk1.7中的 ConcurrentHashMap</a></li>
                <li>
                    <a href="#jdk18%e4%b8%ad%e7%9a%84-concurrenthashmap" aria-label="jdk1.8中的 ConcurrentHashMap">jdk1.8中的 ConcurrentHashMap</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%a2%98" aria-label="题">题</a><ul>
                        
                <li>
                    <a href="#hashmap-%e7%9a%84%e5%ba%95%e5%b1%82%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="HashMap 的底层数据结构">HashMap 的底层数据结构</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e6%94%b9%e6%88%90%e6%95%b0%e7%bb%84%e9%93%be%e8%a1%a8%e7%ba%a2%e9%bb%91%e6%a0%91" aria-label="为什么要改成“数组&#43;链表&#43;红黑树”？">为什么要改成“数组+链表+红黑树”？</a></li>
                <li>
                    <a href="#%e9%82%a3%e5%9c%a8%e4%bb%80%e4%b9%88%e6%97%b6%e5%80%99%e7%94%a8%e9%93%be%e8%a1%a8%e4%bb%80%e4%b9%88%e6%97%b6%e5%80%99%e7%94%a8%e7%ba%a2%e9%bb%91%e6%a0%91" aria-label="那在什么时候用链表？什么时候用红黑树？">那在什么时候用链表？什么时候用红黑树？</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%93%be%e8%a1%a8%e8%bd%ac%e7%ba%a2%e9%bb%91%e6%a0%91%e7%9a%84%e9%98%88%e5%80%bc%e6%98%af8" aria-label="为什么链表转红黑树的阈值是8？">为什么链表转红黑树的阈值是8？</a></li>
                <li>
                    <a href="#%e9%82%a3%e4%b8%ba%e4%bb%80%e4%b9%88%e8%bd%ac%e5%9b%9e%e9%93%be%e8%a1%a8%e8%8a%82%e7%82%b9%e6%98%af%e7%94%a8%e7%9a%846%e8%80%8c%e4%b8%8d%e6%98%af%e5%a4%8d%e7%94%a88" aria-label="那为什么转回链表节点是用的6而不是复用8？">那为什么转回链表节点是用的6而不是复用8？</a></li>
                <li>
                    <a href="#%e9%82%a3-hashmap-%e6%9c%89%e5%93%aa%e4%ba%9b%e9%87%8d%e8%a6%81%e5%b1%9e%e6%80%a7%e5%88%86%e5%88%ab%e7%94%a8%e4%ba%8e%e5%81%9a%e4%bb%80%e4%b9%88%e7%9a%84" aria-label="那 HashMap 有哪些重要属性？分别用于做什么的？">那 HashMap 有哪些重要属性？分别用于做什么的？</a></li>
                <li>
                    <a href="#threshold-%e9%99%a4%e4%ba%86%e7%94%a8%e4%ba%8e%e5%ad%98%e6%94%be%e6%89%a9%e5%ae%b9%e9%98%88%e5%80%bc%e8%bf%98%e6%9c%89%e5%85%b6%e4%bb%96%e4%bd%9c%e7%94%a8%e5%90%97" aria-label="threshold 除了用于存放扩容阈值还有其他作用吗？">threshold 除了用于存放扩容阈值还有其他作用吗？</a></li>
                <li>
                    <a href="#hashmap-%e7%9a%84%e9%bb%98%e8%ae%a4%e5%88%9d%e5%a7%8b%e5%ae%b9%e9%87%8f%e6%98%af%e5%a4%9a%e5%b0%91hashmap-%e7%9a%84%e5%ae%b9%e9%87%8f%e6%9c%89%e4%bb%80%e4%b9%88%e9%99%90%e5%88%b6%e5%90%97" aria-label="HashMap 的默认初始容量是多少？HashMap 的容量有什么限制吗？">HashMap 的默认初始容量是多少？HashMap 的容量有什么限制吗？</a></li>
                <li>
                    <a href="#%e4%bd%a0%e8%af%b4-hashmap-%e7%9a%84%e5%ae%b9%e9%87%8f%e5%bf%85%e9%a1%bb%e6%98%af-2-%e7%9a%84-n-%e6%ac%a1%e6%96%b9%e8%bf%99%e6%98%af%e4%b8%ba%e4%bb%80%e4%b9%88" aria-label="你说 HashMap 的容量必须是 2 的 N 次方，这是为什么？">你说 HashMap 的容量必须是 2 的 N 次方，这是为什么？</a></li>
                <li>
                    <a href="#hashmap-%e7%9a%84%e9%bb%98%e8%ae%a4%e5%88%9d%e5%a7%8b%e5%ae%b9%e9%87%8f%e6%98%af-16%e4%b8%ba%e4%bb%80%e4%b9%88%e6%98%af16%e8%80%8c%e4%b8%8d%e6%98%af%e5%85%b6%e4%bb%96%e7%9a%84" aria-label="HashMap 的默认初始容量是 16，为什么是16而不是其他的？">HashMap 的默认初始容量是 16，为什么是16而不是其他的？</a></li>
                <li>
                    <a href="#hashmap-%e7%9a%84%e8%b4%9f%e8%bd%bd%e5%9b%a0%e5%ad%90%e9%bb%98%e8%ae%a4%e5%88%9d%e5%a7%8b%e5%80%bc%e5%8f%88%e6%98%af%e5%a4%9a%e5%b0%91%e4%b8%ba%e4%bb%80%e4%b9%88%e6%98%af%e8%bf%99%e4%b8%aa%e6%95%b0" aria-label="HashMap 的负载因子默认初始值又是多少？为什么是这个数？">HashMap 的负载因子默认初始值又是多少？为什么是这个数？</a></li>
                <li>
                    <a href="#hashmap-%e7%9a%84%e6%8f%92%e5%85%a5%e6%b5%81%e7%a8%8b%e6%98%af%e6%80%8e%e4%b9%88%e6%a0%b7%e7%9a%84" aria-label="HashMap 的插入流程是怎么样的？">HashMap 的插入流程是怎么样的？</a></li>
                <li>
                    <a href="#%e4%bb%8b%e7%bb%8d%e6%89%a9%e5%ae%b9resize%e7%9a%84%e6%b5%81%e7%a8%8b" aria-label="介绍扩容（resize）的流程">介绍扩容（resize）的流程</a></li>
                <li>
                    <a href="#hashmap-%e6%98%af%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e7%9a%84%e5%90%97" aria-label="HashMap 是线程安全的吗？">HashMap 是线程安全的吗？</a></li>
                <li>
                    <a href="#%e4%bb%8b%e7%bb%8d%e4%b8%80%e4%b8%8b%e6%ad%bb%e5%be%aa%e7%8e%af%e9%97%ae%e9%a2%98" aria-label="介绍一下死循环问题？">介绍一下死循环问题？</a></li>
                <li>
                    <a href="#jdk-18-%e5%af%b9-hashmap-%e4%b8%bb%e8%a6%81%e8%bf%9b%e8%a1%8c%e4%ba%86%e5%93%aa%e4%ba%9b%e4%bc%98%e5%8c%96" aria-label="JDK 1.8 对 HashMap 主要进行了哪些优化？">JDK 1.8 对 HashMap 主要进行了哪些优化？</a></li>
                <li>
                    <a href="#%e4%bb%8b%e7%bb%8d%e4%b8%8b-concurrenhashmap%e8%a6%81%e8%ae%b2%e5%87%ba-17-%e5%92%8c-18-%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="介绍下 ConcurrenHashMap，要讲出 1.7 和 1.8 的区别？">介绍下 ConcurrenHashMap，要讲出 1.7 和 1.8 的区别？</a></li>
                <li>
                    <a href="#concurrenthashmap-%e7%9a%84%e5%b9%b6%e5%8f%91%e6%89%a9%e5%ae%b9" aria-label="ConcurrentHashMap 的并发扩容">ConcurrentHashMap 的并发扩容</a></li>
                <li>
                    <a href="#hashset-%e6%98%af%e5%a6%82%e4%bd%95%e4%bf%9d%e8%af%81%e4%b8%8d%e9%87%8d%e5%a4%8d%e7%9a%84" aria-label="HashSet 是如何保证不重复的？">HashSet 是如何保证不重复的？</a></li>
                <li>
                    <a href="#arraylist-%e5%92%8c-linkedlist-%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="ArrayList 和 LinkedList 的区别？">ArrayList 和 LinkedList 的区别？</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="概述">概述<a hidden class="anchor" aria-hidden="true" href="#概述">#</a></h1>
<p>HashMap是一个散列表（就是哈希表），哈希表就是一种以<code>键-值(key-indexed)</code>存储数据的结构。
HashMap 继承于AbstractMap，实现了Map、Cloneable、java.io.Serializable接口。
HashMap 的实现不是同步的，这意味着它不是线程安全的。它的key、value都可以为null。此外，HashMap中的映射不是有序的。</p>
<p>HashMap的实例有两个参数影响其性能：<code>初始容量</code>和<code>加载因子</code>
容量是哈希表中桶的数量，初始容量只是哈希表在创建时的容量。
加载因子是哈希表在其容量自动增长之前，可以达到多满的一种尺度。
当哈希表中的条目数超出了加载因子与当前容量的乘积时，则要对该哈希表进行rehash操作(即重建内部结构)，从而哈希表将具有两倍的桶数。
通常，<strong>默认加载因子是0.75</strong>， 这是在时间和空间成本上寻求一种折中。加载因子过高虽然减少了空间开销，但是也增加了查询成本（在大多数 HashMap 类的操作中，包括 get 和 put 操作，都反映了这一点）。
在设置初始容量时应该考虑到映射中所需的条目数及其加载因子，以便最大限度地减少 rehash 操作次数。如果初始容量大于最大条目数除以加载因子，则不会发生 rehash 操作。</p>
<p>链式哈希表
链式哈希表从根本上说是由一组链表构成。
每个链表都可以看做是一个“桶”，我们将所有的元素通过散列的方式放到具体的不同的桶中。
插入元素时，首先将其键传入一个哈希函数（该过程称为哈希键），函数通过散列的方式告知元素属于哪个“桶”，然后在相应的链表头插入元素。
查找或删除元素时，用同样的方式先找到元素的“桶”，然后遍历相应的链表，直到发现我们想要的元素。
因为每个“桶”都是一个链表，所以链式哈希表并不限制包含元素的个数。然而，如果表变得太大，它的性能将会降低。</p>
<p><img loading="lazy" src="1.png" alt=""  />
</p>
<p>JDK 1.8 对 HashMap 进行了比较大的优化，底层实现由之前的 “数组+链表” 改为 “数组+链表+红黑树”。JDK 1.8 的 HashMap 的数据结构如下图所示，当链表节点较少时仍然是以链表存在，当链表节点较多时（大于8）会转为红黑树。</p>
<p><img loading="lazy" src="0.png" alt=""  />
</p>
<p>1、本文中头节点指的是 table 表上索引位置的节点，也就是链表的头节点。</p>
<p>2、根节点（root 节点）指的是红黑树最上面的那个节点，也就是没有父节点的节点。</p>
<p>3、红黑树的根节点不一定是索引位置的头节点（也就是链表的头节点），HashMap 通过 moveRootToFront 方法来维持红黑树的根结点就是索引位置的头结点，但是在 removeTreeNode 方法中，当 movable 为 false 时，不会调用 moveRootToFront 方法，此时红黑树的根节点不一定是索引位置的头节点，该场景发生在 HashIterator 的 remove 方法中。</p>
<p>4、转为红黑树节点后，链表的结构还存在，通过 next 属性维持，红黑树节点在进行操作时都会维护链表的结构，并不是转为红黑树节点，链表结构就不存在了。</p>
<p>5、在红黑树上，叶子节点也可能有 next 节点，因为红黑树的结构跟链表的结构是互不影响的，不会因为是叶子节点就说该节点已经没有 next 节点。</p>
<p>6、源码中一些变量定义：如果定义了一个节点 p，则 pl（p left）为 p 的左节点，pr（p right）为 p 的右节点，pp（p parent）为 p 的父节点，ph（p hash）为 p 的 hash 值，pk（p key）为 p 的 key 值，kc（key class）为 key 的类等等。源码中很喜欢在 if/for 等语句中进行赋值并判断，请注意。</p>
<p>7、链表中移除一个节点只需如下图操作，其他操作同理。</p>
<p><img loading="lazy" src="01.png" alt=""  />
</p>
<p>8、红黑树在维护链表结构时，移除一个节点只需如下图操作（红黑树中增加了一个 prev 属性），其他操作同理。注：此处只是红黑树维护链表结构的操作，红黑树还需要单独进行红黑树的移除或者其他操作。</p>
<p><img loading="lazy" src="02.png" alt=""  />
</p>
<p>9、源码中进行红黑树的查找时，会反复用到以下两条规则：1）如果目标节点的 hash 值小于 p 节点的 hash 值，则向 p 节点的左边遍历；否则向 p 节点的右边遍历。2）如果目标节点的 key 值小于 p 节点的 key 值，则向 p 节点的左边遍历；否则向 p 节点的右边遍历。这两条规则是利用了红黑树的特性（左节点 &lt; 根节点 &lt; 右节点）。</p>
<p>10、源码中进行红黑树的查找时，会用 dir（direction）来表示向左还是向右查找，dir 存储的值是目标节点的 hash/key 与 p 节点的 hash/key 的比较结果。</p>
<h1 id="构造函数">构造函数<a hidden class="anchor" aria-hidden="true" href="#构造函数">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// 默认构造函数。
</span></span><span style="display:flex;"><span>HashMap()
</span></span><span style="display:flex;"><span>// 指定“容量大小”的构造函数
</span></span><span style="display:flex;"><span>HashMap(int capacity)
</span></span><span style="display:flex;"><span>// 指定“容量大小”和“加载因子”的构造函数
</span></span><span style="display:flex;"><span>HashMap(int capacity, float loadFactor)
</span></span><span style="display:flex;"><span>// 包含“子Map”的构造函数
</span></span><span style="display:flex;"><span>HashMap(Map&lt;? extends K, ? extends V&gt; map)
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="api">API<a hidden class="anchor" aria-hidden="true" href="#api">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>void                 clear()
</span></span><span style="display:flex;"><span>Object               clone()
</span></span><span style="display:flex;"><span>boolean              containsKey(Object key)
</span></span><span style="display:flex;"><span>boolean              containsValue(Object value)
</span></span><span style="display:flex;"><span>Set&lt;Entry&lt;K, V&gt;&gt;     entrySet()
</span></span><span style="display:flex;"><span>V                    get(Object key)
</span></span><span style="display:flex;"><span>boolean              isEmpty()
</span></span><span style="display:flex;"><span>Set&lt;K&gt;               keySet()
</span></span><span style="display:flex;"><span>V                    put(K key, V value)
</span></span><span style="display:flex;"><span>void                 putAll(Map&lt;? extends K, ? extends V&gt; map)
</span></span><span style="display:flex;"><span>V                    remove(Object key)
</span></span><span style="display:flex;"><span>int                  size()
</span></span><span style="display:flex;"><span>Collection&lt;V&gt;        values()
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="数据结构">数据结构<a hidden class="anchor" aria-hidden="true" href="#数据结构">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>java.lang.Object
</span></span><span style="display:flex;"><span>   ↳     java.util.AbstractMap&lt;K, V&gt;
</span></span><span style="display:flex;"><span>         ↳     java.util.HashMap&lt;K, V&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>public class HashMap&lt;K,V&gt;
</span></span><span style="display:flex;"><span>    extends AbstractMap&lt;K,V&gt;
</span></span><span style="display:flex;"><span>    implements Map&lt;K,V&gt;, Cloneable, Serializable { }
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="1.jpg" alt=""  />

从图中可以看出：</p>
<ul>
<li>HashMap继承于AbstractMap类，实现了Map接口。Map是&quot;key-value键值对&quot;接口，AbstractMap实现了&quot;键值对&quot;的通用函数接口。</li>
<li>HashMap是通过&quot;拉链法&quot;实现的哈希表。它包括几个重要的成员变量：table, size, threshold, loadFactor, modCount。
table是一个Entry[]数组类型，而Entry实际上就是一个单向链表。哈希表的&quot;key-value键值对&quot;都是存储在Entry数组中的。
size是HashMap的大小，它是HashMap保存的键值对的数量。
threshold是HashMap的阈值，用于判断是否需要调整HashMap的容量。threshold的值=<code>容量*加载因子</code>，当HashMap中存储数据的数量达到threshold时，就需要将HashMap的容量加倍。
loadFactor就是加载因子。
modCount是用来实现fail-fast机制的。</li>
</ul>
<h1 id="hashmap构造函数">HashMap构造函数<a hidden class="anchor" aria-hidden="true" href="#hashmap构造函数">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 默认构造函数。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> HashMap() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 设置“加载因子”
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">loadFactor</span> = DEFAULT_LOAD_FACTOR;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 设置“HashMap阈值”，当HashMap中存储数据的数量达到threshold时，就需要将HashMap的容量加倍。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    threshold = (<span style="color:#fff;font-weight:bold">int</span>)(DEFAULT_INITIAL_CAPACITY * DEFAULT_LOAD_FACTOR);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建Entry数组，用来保存数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    table = <span style="color:#fff;font-weight:bold">new</span> Entry[DEFAULT_INITIAL_CAPACITY];
</span></span><span style="display:flex;"><span>    init();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 指定“容量大小”和“加载因子”的构造函数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> HashMap(<span style="color:#fff;font-weight:bold">int</span> initialCapacity, <span style="color:#fff;font-weight:bold">float</span> loadFactor) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (initialCapacity &lt; <span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalArgumentException(<span style="color:#0ff;font-weight:bold">&#34;Illegal initial capacity: &#34;</span> +
</span></span><span style="display:flex;"><span>                                           initialCapacity);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// HashMap的最大容量只能是MAXIMUM_CAPACITY
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)
</span></span><span style="display:flex;"><span>        initialCapacity = MAXIMUM_CAPACITY;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (loadFactor &lt;= <span style="color:#ff0;font-weight:bold">0</span> || Float.<span style="color:#007f7f">isNaN</span>(loadFactor))
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> IllegalArgumentException(<span style="color:#0ff;font-weight:bold">&#34;Illegal load factor: &#34;</span> +
</span></span><span style="display:flex;"><span>                                           loadFactor);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// Find a power of 2 &gt;= initialCapacity
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">int</span> capacity = <span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">while</span> (capacity &lt; initialCapacity)
</span></span><span style="display:flex;"><span>        capacity &lt;&lt;= <span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 设置“加载因子”
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">loadFactor</span> = loadFactor;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 设置“HashMap阈值”，当HashMap中存储数据的数量达到threshold时，就需要将HashMap的容量加倍。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    threshold = (<span style="color:#fff;font-weight:bold">int</span>)(capacity * loadFactor);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 创建Entry数组，用来保存数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    table = <span style="color:#fff;font-weight:bold">new</span> Entry[capacity];
</span></span><span style="display:flex;"><span>    init();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 指定“容量大小”的构造函数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> HashMap(<span style="color:#fff;font-weight:bold">int</span> initialCapacity) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 包含“子Map”的构造函数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> HashMap(Map&lt;? <span style="color:#fff;font-weight:bold">extends</span> K, ? <span style="color:#fff;font-weight:bold">extends</span> V&gt; m) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">this</span>(Math.<span style="color:#007f7f">max</span>((<span style="color:#fff;font-weight:bold">int</span>) (m.<span style="color:#007f7f">size</span>() / DEFAULT_LOAD_FACTOR) + <span style="color:#ff0;font-weight:bold">1</span>,
</span></span><span style="display:flex;"><span>                  DEFAULT_INITIAL_CAPACITY), DEFAULT_LOAD_FACTOR);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 将m中的全部元素逐个添加到HashMap中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    putAllForCreate(m);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="hashmap的基本属性">HashMap的基本属性<a hidden class="anchor" aria-hidden="true" href="#hashmap的基本属性">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 默认容量16，必须是2的幂
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> DEFAULT_INITIAL_CAPACITY = <span style="color:#ff0;font-weight:bold">1</span> &lt;&lt; <span style="color:#ff0;font-weight:bold">4</span>; 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 最大容量（必须是2的幂且小于2的30次方，传入容量过大将被这个值替换）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> MAXIMUM_CAPACITY = <span style="color:#ff0;font-weight:bold">1</span> &lt;&lt; <span style="color:#ff0;font-weight:bold">30</span>;    
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 默认负载因子0.75
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">float</span> DEFAULT_LOAD_FACTOR = <span style="color:#ff0;font-weight:bold">0.75f</span>; 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 链表节点转换红黑树节点的阈值, 9个节点转
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> TREEIFY_THRESHOLD = <span style="color:#ff0;font-weight:bold">8</span>; 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 红黑树节点转换链表节点的阈值, 6个节点转
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> UNTREEIFY_THRESHOLD = <span style="color:#ff0;font-weight:bold">6</span>;   
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 转红黑树时, table的最小长度
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> MIN_TREEIFY_CAPACITY = <span style="color:#ff0;font-weight:bold">64</span>; 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 链表节点, 继承自Entry
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">class</span> Node&lt;K,V&gt; <span style="color:#fff;font-weight:bold">implements</span> Map.<span style="color:#007f7f">Entry</span>&lt;K,V&gt; {  
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> hash;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">final</span> K key;
</span></span><span style="display:flex;"><span>    V value;
</span></span><span style="display:flex;"><span>    Node&lt;K,V&gt; next;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ... ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 红黑树节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> TreeNode&lt;K,V&gt; <span style="color:#fff;font-weight:bold">extends</span> LinkedHashMap.<span style="color:#007f7f">Entry</span>&lt;K,V&gt; {
</span></span><span style="display:flex;"><span>    TreeNode&lt;K,V&gt; parent;  <span style="color:#007f7f">// red-black tree links
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    TreeNode&lt;K,V&gt; left;
</span></span><span style="display:flex;"><span>    TreeNode&lt;K,V&gt; right;
</span></span><span style="display:flex;"><span>    TreeNode&lt;K,V&gt; prev;    <span style="color:#007f7f">// needed to unlink next upon deletion
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">boolean</span> red;
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="定位哈希桶数组索引位置">定位哈希桶数组索引位置<a hidden class="anchor" aria-hidden="true" href="#定位哈希桶数组索引位置">#</a></h1>
<p>不管增加、删除、查找键值对，定位到哈希桶数组的位置都是很关键的第一步。前面说过 HashMap 的数据结构是“数组+链表+红黑树”的结合，所以我们当然希望这个 HashMap 里面的元素位置尽量分布均匀些，尽量使得每个位置上的元素数量只有一个，那么当我们用 hash 算法求得这个位置的时候，马上就可以知道对应位置的元素就是我们要的，不用遍历链表/红黑树，大大优化了查询的效率。HashMap 定位数组索引位置，直接决定了 hash 方法的离散性能。下面是定位哈希桶数组的源码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 代码1
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> hash(Object key) { <span style="color:#007f7f">// 计算key的hash值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">int</span> h;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.先拿到key的hashCode值; 2.将hashCode的高16位参与运算
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> (key == <span style="color:#fff;font-weight:bold">null</span>) ? <span style="color:#ff0;font-weight:bold">0</span> : (h = key.<span style="color:#007f7f">hashCode</span>()) ^ (h &gt;&gt;&gt; <span style="color:#ff0;font-weight:bold">16</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 代码2
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">int</span> n = tab.<span style="color:#007f7f">length</span>;
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 将(tab.length - 1) 与 hash值进行&amp;运算
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">int</span> index = (n - <span style="color:#ff0;font-weight:bold">1</span>) &amp; hash;
</span></span></code></pre></td></tr></table>
</div>
</div><p>整个过程本质上就是三步：</p>
<ol>
<li>拿到 key 的 hashCode 值</li>
<li>将 hashCode 的高位参与运算，重新计算 hash 值</li>
<li>将计算出来的 hash 值与 (table.length - 1) 进行 &amp; 运算</li>
</ol>
<p>对于任意给定的对象，只要它的 hashCode() 返回值相同，那么计算得到的 hash 值总是相同的。我们首先想到的就是把 hash 值对 table 长度取模运算，这样一来，元素的分布相对来说是比较均匀的。</p>
<p>但是模运算消耗还是比较大的，我们知道计算机比较快的运算为位运算，因此 JDK 团队对取模运算进行了优化，使用上面代码2的位与运算来代替模运算。这个方法非常巧妙，它通过 “(table.length -1) &amp; h” 来得到该对象的索引位置，这个优化是基于以下公式：x mod 2^n = x &amp; (2^n - 1)。我们知道 HashMap 底层数组的长度总是 2 的 n 次方，并且取模运算为 “h mod table.length”，对应上面的公式，可以得到该运算等同于“h &amp; (table.length - 1)”。这是 HashMap 在速度上的优化，因为 &amp; 比 % 具有更高的效率。</p>
<p>在 JDK1.8 的实现中，还优化了高位运算的算法，将 hashCode 的高 16 位与 hashCode 进行异或运算，主要是为了在 table 的 length 较小的时候，让高位也参与运算，并且不会有太大的开销。</p>
<p>下图是一个简单的例子：</p>
<p>当 table 长度为 16 时，table.length - 1 = 15 ，用二进制来看，此时低 4 位全是 1，高 28 位全是 0，与 0 进行 &amp; 运算必然为 0，因此此时 hashCode 与 “table.length - 1” 的 &amp; 运算结果只取决于 hashCode 的低 4 位，在这种情况下，hashCode 的高 28 位就没有任何作用，并且由于 hash 结果只取决于 hashCode 的低 4 位，hash 冲突的概率也会增加。因此，在 JDK 1.8 中，将高位也参与计算，目的是为了降低 hash 冲突的概率。</p>
<p><img loading="lazy" src="2.png" alt=""  />
</p>
<h1 id="get-方法">get 方法<a hidden class="anchor" aria-hidden="true" href="#get-方法">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> V get(Object key) {
</span></span><span style="display:flex;"><span>    Node&lt;K,V&gt; e;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> (e = getNode(hash(key), key)) == <span style="color:#fff;font-weight:bold">null</span> ? <span style="color:#fff;font-weight:bold">null</span> : e.<span style="color:#007f7f">value</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> Node&lt;K,V&gt; getNode(<span style="color:#fff;font-weight:bold">int</span> hash, Object key) {
</span></span><span style="display:flex;"><span>    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span style="color:#fff;font-weight:bold">int</span> n; K k;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.对table进行校验：table不为空 &amp;&amp; table长度大于0 &amp;&amp; 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// table索引位置(使用table.length - 1和hash值进行位与运算)的节点不为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> ((tab = table) != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; (n = tab.<span style="color:#007f7f">length</span>) &gt; <span style="color:#ff0;font-weight:bold">0</span> &amp;&amp;
</span></span><span style="display:flex;"><span>        (first = tab[(n - <span style="color:#ff0;font-weight:bold">1</span>) &amp; hash]) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 2.检查first节点的hash值和key是否和入参的一样，如果一样则first即为目标节点，直接返回first节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (first.<span style="color:#007f7f">hash</span> == hash &amp;&amp; <span style="color:#007f7f">// always check first node
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ((k = first.<span style="color:#007f7f">key</span>) == key || (key != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; key.<span style="color:#007f7f">equals</span>(k))))
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> first;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 3.如果first不是目标节点，并且first的next节点不为空则继续遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((e = first.<span style="color:#007f7f">next</span>) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (first <span style="color:#fff;font-weight:bold">instanceof</span> TreeNode)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 4.如果是红黑树节点，则调用红黑树的查找目标节点方法getTreeNode
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">return</span> ((TreeNode&lt;K,V&gt;)first).<span style="color:#007f7f">getTreeNode</span>(hash, key);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">do</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 5.执行链表节点的查找，向下遍历链表, 直至找到节点的key和入参的key相等时,返回该节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> (e.<span style="color:#007f7f">hash</span> == hash &amp;&amp;
</span></span><span style="display:flex;"><span>                    ((k = e.<span style="color:#007f7f">key</span>) == key || (key != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; key.<span style="color:#007f7f">equals</span>(k))))
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> e;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">while</span> ((e = e.<span style="color:#007f7f">next</span>) != <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 6.找不到符合的返回空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果是红黑树节点，则调用红黑树的查找目标节点方法 getTreeNode，见代码块1详解</p>
<h2 id="代码块1gettreenode">代码块1：getTreeNode<a hidden class="anchor" aria-hidden="true" href="#代码块1gettreenode">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> TreeNode&lt;K,V&gt; getTreeNode(<span style="color:#fff;font-weight:bold">int</span> h, Object k) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.首先找到红黑树的根节点；2.使用根节点调用find方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> ((parent != <span style="color:#fff;font-weight:bold">null</span>) ? root() : <span style="color:#fff;font-weight:bold">this</span>).<span style="color:#007f7f">find</span>(h, k, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用根节点调用 find 方法，见代码块2详解</p>
<h2 id="代码块2find">代码块2：find<a hidden class="anchor" aria-hidden="true" href="#代码块2find">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 从调用此方法的节点开始查找, 通过hash值和key找到对应的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 此方法是红黑树节点的查找, 红黑树是特殊的自平衡二叉查找树
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 平衡二叉查找树的特点：左节点&lt;根节点&lt;右节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> TreeNode&lt;K,V&gt; find(<span style="color:#fff;font-weight:bold">int</span> h, Object k, Class&lt;?&gt; kc) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.将p节点赋值为调用此方法的节点，即为红黑树根节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    TreeNode&lt;K,V&gt; p = <span style="color:#fff;font-weight:bold">this</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 2.从p节点开始向下遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">do</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> ph, dir; K pk;
</span></span><span style="display:flex;"><span>        TreeNode&lt;K,V&gt; pl = p.<span style="color:#007f7f">left</span>, pr = p.<span style="color:#007f7f">right</span>, q;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 3.如果传入的hash值小于p节点的hash值，则往p节点的左边遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((ph = p.<span style="color:#007f7f">hash</span>) &gt; h)
</span></span><span style="display:flex;"><span>            p = pl;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (ph &lt; h) <span style="color:#007f7f">// 4.如果传入的hash值大于p节点的hash值，则往p节点的右边遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            p = pr;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 5.如果传入的hash值和key值等于p节点的hash值和key值,则p节点为目标节点,返回p节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> ((pk = p.<span style="color:#007f7f">key</span>) == k || (k != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; k.<span style="color:#007f7f">equals</span>(pk)))
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> p;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (pl == <span style="color:#fff;font-weight:bold">null</span>)    <span style="color:#007f7f">// 6.p节点的左节点为空则将向右遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            p = pr;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (pr == <span style="color:#fff;font-weight:bold">null</span>)    <span style="color:#007f7f">// 7.p节点的右节点为空则向左遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            p = pl;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 8.将p节点与k进行比较
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> ((kc != <span style="color:#fff;font-weight:bold">null</span> ||
</span></span><span style="display:flex;"><span>                  (kc = comparableClassFor(k)) != <span style="color:#fff;font-weight:bold">null</span>) &amp;&amp; <span style="color:#007f7f">// 8.1 kc不为空代表k实现了Comparable
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                 (dir = compareComparables(kc, k, pk)) != <span style="color:#ff0;font-weight:bold">0</span>)<span style="color:#007f7f">// 8.2 k&lt;pk则dir&lt;0, k&gt;pk则dir&gt;0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 8.3 k&lt;pk则向左遍历(p赋值为p的左节点), 否则向右遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            p = (dir &lt; <span style="color:#ff0;font-weight:bold">0</span>) ? pl : pr;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 9.代码走到此处, 代表key所属类没有实现Comparable, 直接指定向p的右边遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> ((q = pr.<span style="color:#007f7f">find</span>(h, k, kc)) != <span style="color:#fff;font-weight:bold">null</span>) 
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> q;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 10.代码走到此处代表“pr.find(h, k, kc)”为空, 因此直接向左遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            p = pl;
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">while</span> (p != <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>将 p 节点与 k 进行比较。如果传入的 key（即代码中的参数 k）所属的类实现了 Comparable 接口（kc 不为空，comparableClassFor 方法见代码块3详解），则将 k 跟 p 节点的 key 进行比较（kc 实现了 Comparable 接口，因此通过 kc 的比较方法进行比较），并将比较结果赋值给 dir，如果 dir&lt;0 则代表 k&lt;pk，则向 p 节点的左边遍历（pl）；否则，向 p 节点的右边遍历（pr）。</p>
<h2 id="代码块3comparableclassfor">代码块3：comparableClassFor<a hidden class="anchor" aria-hidden="true" href="#代码块3comparableclassfor">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">static</span> Class&lt;?&gt; comparableClassFor(Object x) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.判断x是否实现了Comparable接口
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (x <span style="color:#fff;font-weight:bold">instanceof</span> Comparable) {
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; c; Type[] ts, as; Type t; ParameterizedType p;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 2.校验x是否为String类型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((c = x.<span style="color:#007f7f">getClass</span>()) == String.<span style="color:#007f7f">class</span>) <span style="color:#007f7f">// bypass checks
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> c;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> ((ts = c.<span style="color:#007f7f">getGenericInterfaces</span>()) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 3.遍历x实现的所有接口
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; ts.<span style="color:#007f7f">length</span>; ++i) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 4.如果x实现了Comparable接口，则返回x的Class
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> (((t = ts[i]) <span style="color:#fff;font-weight:bold">instanceof</span> ParameterizedType) &amp;&amp;
</span></span><span style="display:flex;"><span>                    ((p = (ParameterizedType)t).<span style="color:#007f7f">getRawType</span>() ==
</span></span><span style="display:flex;"><span>                     Comparable.<span style="color:#007f7f">class</span>) &amp;&amp;
</span></span><span style="display:flex;"><span>                    (as = p.<span style="color:#007f7f">getActualTypeArguments</span>()) != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp;
</span></span><span style="display:flex;"><span>                    as.<span style="color:#007f7f">length</span> == <span style="color:#ff0;font-weight:bold">1</span> &amp;&amp; as[<span style="color:#ff0;font-weight:bold">0</span>] == c) <span style="color:#007f7f">// type arg is c
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#fff;font-weight:bold">return</span> c;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="put方法">put方法<a hidden class="anchor" aria-hidden="true" href="#put方法">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> V put(K key, V value) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> putVal(hash(key), key, value, <span style="color:#fff;font-weight:bold">false</span>, <span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> V putVal(<span style="color:#fff;font-weight:bold">int</span> hash, K key, V value, <span style="color:#fff;font-weight:bold">boolean</span> onlyIfAbsent,
</span></span><span style="display:flex;"><span>               <span style="color:#fff;font-weight:bold">boolean</span> evict) {
</span></span><span style="display:flex;"><span>    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span style="color:#fff;font-weight:bold">int</span> n, i;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.校验table是否为空或者length等于0，如果是则调用resize方法进行初始化
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> ((tab = table) == <span style="color:#fff;font-weight:bold">null</span> || (n = tab.<span style="color:#007f7f">length</span>) == <span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>        n = (tab = resize()).<span style="color:#007f7f">length</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 2.通过hash值计算索引位置，将该索引位置的头节点赋值给p，如果p为空则直接在该索引位置新增一个节点即可
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> ((p = tab[i = (n - <span style="color:#ff0;font-weight:bold">1</span>) &amp; hash]) == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>        tab[i] = newNode(hash, key, value, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// table表该索引位置不为空，则进行查找
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Node&lt;K,V&gt; e; K k;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 3.判断p节点的key和hash值是否跟传入的相等，如果相等, 则p节点即为要查找的目标节点，将p节点赋值给e节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (p.<span style="color:#007f7f">hash</span> == hash &amp;&amp;
</span></span><span style="display:flex;"><span>            ((k = p.<span style="color:#007f7f">key</span>) == key || (key != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; key.<span style="color:#007f7f">equals</span>(k))))
</span></span><span style="display:flex;"><span>            e = p;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 4.判断p节点是否为TreeNode, 如果是则调用红黑树的putTreeVal方法查找目标节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (p <span style="color:#fff;font-weight:bold">instanceof</span> TreeNode)
</span></span><span style="display:flex;"><span>            e = ((TreeNode&lt;K,V&gt;)p).<span style="color:#007f7f">putTreeVal</span>(<span style="color:#fff;font-weight:bold">this</span>, tab, hash, key, value);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 5.走到这代表p节点为普通链表节点，则调用普通的链表方法进行查找，使用binCount统计链表的节点数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> binCount = <span style="color:#ff0;font-weight:bold">0</span>; ; ++binCount) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 6.如果p的next节点为空时，则代表找不到目标节点，则新增一个节点并插入链表尾部
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> ((e = p.<span style="color:#007f7f">next</span>) == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                    p.<span style="color:#007f7f">next</span> = newNode(hash, key, value, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">// 7.校验节点数是否超过8个，如果超过则调用treeifyBin方法将链表节点转为红黑树节点，
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#007f7f">// 减一是因为循环是从p节点的下一个节点开始的
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#fff;font-weight:bold">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>                        treeifyBin(tab, hash);
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 8.如果e节点存在hash值和key值都与传入的相同，则e节点即为目标节点，跳出循环
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> (e.<span style="color:#007f7f">hash</span> == hash &amp;&amp;
</span></span><span style="display:flex;"><span>                    ((k = e.<span style="color:#007f7f">key</span>) == key || (key != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; key.<span style="color:#007f7f">equals</span>(k))))
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                p = e;  <span style="color:#007f7f">// 将p指向下一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 9.如果e节点不为空，则代表目标节点存在，使用传入的value覆盖该节点的value，并返回oldValue
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (e != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            V oldValue = e.<span style="color:#007f7f">value</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (!onlyIfAbsent || oldValue == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>                e.<span style="color:#007f7f">value</span> = value;
</span></span><span style="display:flex;"><span>            afterNodeAccess(e); <span style="color:#007f7f">// 用于LinkedHashMap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> oldValue;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ++modCount;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 10.如果插入节点后节点数超过阈值，则调用resize方法进行扩容
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (++size &gt; threshold)
</span></span><span style="display:flex;"><span>        resize();
</span></span><span style="display:flex;"><span>    afterNodeInsertion(evict);  <span style="color:#007f7f">// 用于LinkedHashMap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>校验 table 是否为空或者 length 等于0，如果是则调用 resize 方法进行初始化，<strong>见resize方法详解</strong></p>
</li>
<li>
<p>如果 p 节点不是目标节点，则判断 p 节点是否为 TreeNode，如果是则调用红黑树的 putTreeVal 方法查找目标节点，<strong>见代码块4详解</strong></p>
</li>
<li>
<p>校验节点数是否超过 8 个，如果超过则调用 treeifyBin方法 将链表节点转为红黑树节点，<strong>见代码块6详解</strong></p>
</li>
</ol>
<h2 id="代码块4puttreeval">代码块4：putTreeVal<a hidden class="anchor" aria-hidden="true" href="#代码块4puttreeval">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 红黑树的put操作，红黑树插入会同时维护原来的链表属性, 即原来的next属性
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> TreeNode&lt;K,V&gt; putTreeVal(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab,
</span></span><span style="display:flex;"><span>                               <span style="color:#fff;font-weight:bold">int</span> h, K k, V v) {
</span></span><span style="display:flex;"><span>    Class&lt;?&gt; kc = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">boolean</span> searched = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.查找根节点, 索引位置的头节点并不一定为红黑树的根节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    TreeNode&lt;K,V&gt; root = (parent != <span style="color:#fff;font-weight:bold">null</span>) ? root() : <span style="color:#fff;font-weight:bold">this</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 2.将根节点赋值给p节点，开始进行查找
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (TreeNode&lt;K,V&gt; p = root;;) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> dir, ph; K pk;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 3.如果传入的hash值小于p节点的hash值，将dir赋值为-1，代表向p的左边查找树
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((ph = p.<span style="color:#007f7f">hash</span>) &gt; h)
</span></span><span style="display:flex;"><span>            dir = -<span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 4.如果传入的hash值大于p节点的hash值， 将dir赋值为1，代表向p的右边查找树
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (ph &lt; h)
</span></span><span style="display:flex;"><span>            dir = <span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 5.如果传入的hash值和key值等于p节点的hash值和key值, 则p节点即为目标节点, 返回p节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> ((pk = p.<span style="color:#007f7f">key</span>) == k || (k != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; k.<span style="color:#007f7f">equals</span>(pk)))
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> p;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 6.如果k所属的类没有实现Comparable接口 或者 k和p节点的key相等
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> ((kc == <span style="color:#fff;font-weight:bold">null</span> &amp;&amp;
</span></span><span style="display:flex;"><span>                  (kc = comparableClassFor(k)) == <span style="color:#fff;font-weight:bold">null</span>) ||
</span></span><span style="display:flex;"><span>                 (dir = compareComparables(kc, k, pk)) == <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 6.1 第一次符合条件, 从p节点的左节点和右节点分别调用find方法进行查找, 如果查找到目标节点则返回
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (!searched) {
</span></span><span style="display:flex;"><span>                TreeNode&lt;K,V&gt; q, ch;
</span></span><span style="display:flex;"><span>                searched = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (((ch = p.<span style="color:#007f7f">left</span>) != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp;
</span></span><span style="display:flex;"><span>                     (q = ch.<span style="color:#007f7f">find</span>(h, k, kc)) != <span style="color:#fff;font-weight:bold">null</span>) ||
</span></span><span style="display:flex;"><span>                    ((ch = p.<span style="color:#007f7f">right</span>) != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp;
</span></span><span style="display:flex;"><span>                     (q = ch.<span style="color:#007f7f">find</span>(h, k, kc)) != <span style="color:#fff;font-weight:bold">null</span>))
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> q;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 6.2 否则使用定义的一套规则来比较k和p节点的key的大小, 用来决定向左还是向右查找
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            dir = tieBreakOrder(k, pk); <span style="color:#007f7f">// dir&lt;0则代表k&lt;pk，则向p左边查找；反之亦然
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        TreeNode&lt;K,V&gt; xp = p;   <span style="color:#007f7f">// xp赋值为x的父节点,中间变量,用于下面给x的父节点赋值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 7.dir&lt;=0则向p左边查找,否则向p右边查找,如果为null,则代表该位置即为x的目标位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((p = (dir &lt;= <span style="color:#ff0;font-weight:bold">0</span>) ? p.<span style="color:#007f7f">left</span> : p.<span style="color:#007f7f">right</span>) == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 走进来代表已经找到x的位置，只需将x放到该位置即可
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Node&lt;K,V&gt; xpn = xp.<span style="color:#007f7f">next</span>;    <span style="color:#007f7f">// xp的next节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 8.创建新的节点, 其中x的next节点为xpn, 即将x节点插入xp与xpn之间
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            TreeNode&lt;K,V&gt; x = map.<span style="color:#007f7f">newTreeNode</span>(h, k, v, xpn);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 9.调整x、xp、xpn之间的属性关系
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (dir &lt;= <span style="color:#ff0;font-weight:bold">0</span>)   <span style="color:#007f7f">// 如果时dir &lt;= 0, 则代表x节点为xp的左节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                xp.<span style="color:#007f7f">left</span> = x;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">else</span>        <span style="color:#007f7f">// 如果时dir&gt; 0, 则代表x节点为xp的右节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                xp.<span style="color:#007f7f">right</span> = x;
</span></span><span style="display:flex;"><span>            xp.<span style="color:#007f7f">next</span> = x;    <span style="color:#007f7f">// 将xp的next节点设置为x
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            x.<span style="color:#007f7f">parent</span> = x.<span style="color:#007f7f">prev</span> = xp; <span style="color:#007f7f">// 将x的parent和prev节点设置为xp
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 如果xpn不为空,则将xpn的prev节点设置为x节点,与上文的x节点的next节点对应
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (xpn != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>                ((TreeNode&lt;K,V&gt;)xpn).<span style="color:#007f7f">prev</span> = x;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 10.进行红黑树的插入平衡调整
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            moveRootToFront(tab, balanceInsertion(root, x));
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>第一次符合条件，从 p 节点的左节点和右节点分别调用 find 方法（<strong>见代码块2详解</strong>）进行查找，如果查找到目标节点则返回</li>
<li>否则使用定义的一套规则来比较 k 和 p 节点的 key 的大小，用来决定向左还是向右查找，<em><strong>*见代码块5详解*</strong></em>。</li>
<li>进行红黑树的插入平衡调整，见文末的****解释2****。</li>
</ol>
<h2 id="代码块5tiebreakorder">代码块5：tieBreakOrder<a hidden class="anchor" aria-hidden="true" href="#代码块5tiebreakorder">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 用于不可比较或者hashCode相同时进行比较的方法, 只是一个一致的插入规则，用来维护重定位的等价性。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">int</span> tieBreakOrder(Object a, Object b) {  
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> d;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (a == <span style="color:#fff;font-weight:bold">null</span> || b == <span style="color:#fff;font-weight:bold">null</span> ||
</span></span><span style="display:flex;"><span>        (d = a.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getName</span>().
</span></span><span style="display:flex;"><span>         compareTo(b.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getName</span>())) == <span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>        d = (System.<span style="color:#007f7f">identityHashCode</span>(a) &lt;= System.<span style="color:#007f7f">identityHashCode</span>(b) ?
</span></span><span style="display:flex;"><span>             -<span style="color:#ff0;font-weight:bold">1</span> : <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> d;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义一套规则用于极端情况下比较两个参数的大小。</p>
<h2 id="代码块6treeifybin">代码块6：treeifyBin<a hidden class="anchor" aria-hidden="true" href="#代码块6treeifybin">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 将链表节点转为红黑树节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">void</span> treeifyBin(Node&lt;K,V&gt;[] tab, <span style="color:#fff;font-weight:bold">int</span> hash) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> n, index; Node&lt;K,V&gt; e;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.如果table为空或者table的长度小于64, 调用resize方法进行扩容
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (tab == <span style="color:#fff;font-weight:bold">null</span> || (n = tab.<span style="color:#007f7f">length</span>) &lt; MIN_TREEIFY_CAPACITY)
</span></span><span style="display:flex;"><span>        resize();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 2.根据hash值计算索引值，将该索引位置的节点赋值给e，从e开始遍历该索引位置的链表
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> ((e = tab[index = (n - <span style="color:#ff0;font-weight:bold">1</span>) &amp; hash]) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        TreeNode&lt;K,V&gt; hd = <span style="color:#fff;font-weight:bold">null</span>, tl = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">do</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 3.将链表节点转红黑树节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            TreeNode&lt;K,V&gt; p = replacementTreeNode(e, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 4.如果是第一次遍历，将头节点赋值给hd
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (tl == <span style="color:#fff;font-weight:bold">null</span>)	<span style="color:#007f7f">// tl为空代表为第一次循环
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                hd = p;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 5.如果不是第一次遍历，则处理当前节点的prev属性和上一个节点的next属性
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                p.<span style="color:#007f7f">prev</span> = tl;    <span style="color:#007f7f">// 当前节点的prev属性设为上一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                tl.<span style="color:#007f7f">next</span> = p;    <span style="color:#007f7f">// 上一个节点的next属性设置为当前节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 6.将p节点赋值给tl，用于在下一次循环中作为上一个节点进行一些链表的关联操作（p.prev = tl 和 tl.next = p）
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            tl = p;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">while</span> ((e = e.<span style="color:#007f7f">next</span>) != <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 7.将table该索引位置赋值为新转的TreeNode的头节点，如果该节点不为空，则以以头节点(hd)为根节点, 构建红黑树
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((tab[index] = hd) != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            hd.<span style="color:#007f7f">treeify</span>(tab);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>将 table 该索引位置赋值为新转的 TreeNode 的头节点 hd，如果该节点不为空，则以 hd 为根节点，构建红黑树，<strong>见代码块7详解</strong>。</p>
<h2 id="代码块7treeify">代码块7：treeify<a hidden class="anchor" aria-hidden="true" href="#代码块7treeify">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 构建红黑树
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">void</span> treeify(Node&lt;K,V&gt;[] tab) {
</span></span><span style="display:flex;"><span>    TreeNode&lt;K,V&gt; root = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.将调用此方法的节点赋值给x，以x作为起点，开始进行遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (TreeNode&lt;K,V&gt; x = <span style="color:#fff;font-weight:bold">this</span>, next; x != <span style="color:#fff;font-weight:bold">null</span>; x = next) {
</span></span><span style="display:flex;"><span>        next = (TreeNode&lt;K,V&gt;)x.<span style="color:#007f7f">next</span>;   <span style="color:#007f7f">// next赋值为x的下个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        x.<span style="color:#007f7f">left</span> = x.<span style="color:#007f7f">right</span> = <span style="color:#fff;font-weight:bold">null</span>;    <span style="color:#007f7f">// 将x的左右节点设置为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 2.如果还没有根节点, 则将x设置为根节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (root == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            x.<span style="color:#007f7f">parent</span> = <span style="color:#fff;font-weight:bold">null</span>;    <span style="color:#007f7f">// 根节点没有父节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            x.<span style="color:#007f7f">red</span> = <span style="color:#fff;font-weight:bold">false</span>;  <span style="color:#007f7f">// 根节点必须为黑色
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            root = x;   <span style="color:#007f7f">// 将x设置为根节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            K k = x.<span style="color:#007f7f">key</span>;	<span style="color:#007f7f">// k赋值为x的key
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">int</span> h = x.<span style="color:#007f7f">hash</span>;	<span style="color:#007f7f">// h赋值为x的hash值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Class&lt;?&gt; kc = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 3.如果当前节点x不是根节点, 则从根节点开始查找属于该节点的位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">for</span> (TreeNode&lt;K,V&gt; p = root;;) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">int</span> dir, ph;
</span></span><span style="display:flex;"><span>                K pk = p.<span style="color:#007f7f">key</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 4.如果x节点的hash值小于p节点的hash值，则将dir赋值为-1, 代表向p的左边查找
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> ((ph = p.<span style="color:#007f7f">hash</span>) &gt; h)
</span></span><span style="display:flex;"><span>                    dir = -<span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 5.如果x节点的hash值大于p节点的hash值，则将dir赋值为1, 代表向p的右边查找
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (ph &lt; h)
</span></span><span style="display:flex;"><span>                    dir = <span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 6.走到这代表x的hash值和p的hash值相等，则比较key值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> ((kc == <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; <span style="color:#007f7f">// 6.1 如果k没有实现Comparable接口 或者 x节点的key和p节点的key相等
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                          (kc = comparableClassFor(k)) == <span style="color:#fff;font-weight:bold">null</span>) ||
</span></span><span style="display:flex;"><span>                         (dir = compareComparables(kc, k, pk)) == <span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">// 6.2 使用定义的一套规则来比较x节点和p节点的大小，用来决定向左还是向右查找
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    dir = tieBreakOrder(k, pk);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>                TreeNode&lt;K,V&gt; xp = p;   <span style="color:#007f7f">// xp赋值为x的父节点,中间变量用于下面给x的父节点赋值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#007f7f">// 7.dir&lt;=0则向p左边查找,否则向p右边查找,如果为null,则代表该位置即为x的目标位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> ((p = (dir &lt;= <span style="color:#ff0;font-weight:bold">0</span>) ? p.<span style="color:#007f7f">left</span> : p.<span style="color:#007f7f">right</span>) == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">// 8.x和xp节点的属性设置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    x.<span style="color:#007f7f">parent</span> = xp;  <span style="color:#007f7f">// x的父节点即为最后一次遍历的p节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#fff;font-weight:bold">if</span> (dir &lt;= <span style="color:#ff0;font-weight:bold">0</span>)   <span style="color:#007f7f">// 如果时dir &lt;= 0, 则代表x节点为父节点的左节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        xp.<span style="color:#007f7f">left</span> = x;
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">else</span>    <span style="color:#007f7f">// 如果时dir &gt; 0, 则代表x节点为父节点的右节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        xp.<span style="color:#007f7f">right</span> = x;
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">// 9.进行红黑树的插入平衡(通过左旋、右旋和改变节点颜色来保证当前树符合红黑树的要求)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    root = balanceInsertion(root, x);
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 10.如果root节点不在table索引位置的头节点, 则将其调整为头节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    moveRootToFront(tab, root);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果当前节点 x 不是根节点, 则从根节点开始查找属于该节点的位置，该段代码跟<strong>代码块2</strong>和<strong>代码块4</strong>的查找代码类似。
如果 root 节点不在 table 索引位置的头节点, 则将其调整为头节点，<strong>见代码块8详解</strong>。</p>
<h2 id="代码块8moveroottofront">代码块8：moveRootToFront<a hidden class="anchor" aria-hidden="true" href="#代码块8moveroottofront">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 将root放到头节点的位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 如果当前索引位置的头节点不是root节点, 则将root的上一个节点和下一个节点进行关联,
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 将root放到头节点的位置, 原头节点放在root的next节点上
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">static</span> &lt;K,V&gt; <span style="color:#fff;font-weight:bold">void</span> moveRootToFront(Node&lt;K,V&gt;[] tab, TreeNode&lt;K,V&gt; root) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> n;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.校验root是否为空、table是否为空、table的length是否大于0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (root != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; tab != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; (n = tab.<span style="color:#007f7f">length</span>) &gt; <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 2.计算root节点的索引位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">int</span> index = (n - <span style="color:#ff0;font-weight:bold">1</span>) &amp; root.<span style="color:#007f7f">hash</span>;
</span></span><span style="display:flex;"><span>        TreeNode&lt;K,V&gt; first = (TreeNode&lt;K,V&gt;)tab[index];
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 3.如果该索引位置的头节点不是root节点，则该索引位置的头节点替换为root节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (root != first) {
</span></span><span style="display:flex;"><span>            Node&lt;K,V&gt; rn;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 3.1 将该索引位置的头节点赋值为root节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            tab[index] = root;
</span></span><span style="display:flex;"><span>            TreeNode&lt;K,V&gt; rp = root.<span style="color:#007f7f">prev</span>;   <span style="color:#007f7f">// root节点的上一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 3.2 和 3.3 两个操作是移除root节点的过程
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 3.2 如果root节点的next节点不为空，则将root节点的next节点的prev属性设置为root节点的prev节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> ((rn = root.<span style="color:#007f7f">next</span>) != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>                ((TreeNode&lt;K,V&gt;)rn).<span style="color:#007f7f">prev</span> = rp;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 3.3 如果root节点的prev节点不为空，则将root节点的prev节点的next属性设置为root节点的next节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (rp != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>                rp.<span style="color:#007f7f">next</span> = rn;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 3.4 和 3.5 两个操作将first节点接到root节点后面
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 3.4 如果原头节点不为空, 则将原头节点的prev属性设置为root节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (first != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>                first.<span style="color:#007f7f">prev</span> = root;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 3.5 将root节点的next属性设置为原头节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            root.<span style="color:#007f7f">next</span> = first;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 3.6 root此时已经被放到该位置的头节点位置，因此将prev属性设为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            root.<span style="color:#007f7f">prev</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 4.检查树是否正常
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">assert</span> checkInvariants(root);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>检查树是否正常，<strong>见代码块9详解</strong>。</p>
<h2 id="代码块9checkinvariants">代码块9：checkInvariants<a hidden class="anchor" aria-hidden="true" href="#代码块9checkinvariants">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * Recursive invariant check
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">static</span> &lt;K,V&gt; <span style="color:#fff;font-weight:bold">boolean</span> checkInvariants(TreeNode&lt;K,V&gt; t) { <span style="color:#007f7f">// 一些基本的校验
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    TreeNode&lt;K,V&gt; tp = t.<span style="color:#007f7f">parent</span>, tl = t.<span style="color:#007f7f">left</span>, tr = t.<span style="color:#007f7f">right</span>,
</span></span><span style="display:flex;"><span>        tb = t.<span style="color:#007f7f">prev</span>, tn = (TreeNode&lt;K,V&gt;)t.<span style="color:#007f7f">next</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (tb != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; tb.<span style="color:#007f7f">next</span> != t)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (tn != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; tn.<span style="color:#007f7f">prev</span> != t)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (tp != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; t != tp.<span style="color:#007f7f">left</span> &amp;&amp; t != tp.<span style="color:#007f7f">right</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (tl != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; (tl.<span style="color:#007f7f">parent</span> != t || tl.<span style="color:#007f7f">hash</span> &gt; t.<span style="color:#007f7f">hash</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (tr != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; (tr.<span style="color:#007f7f">parent</span> != t || tr.<span style="color:#007f7f">hash</span> &lt; t.<span style="color:#007f7f">hash</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (t.<span style="color:#007f7f">red</span> &amp;&amp; tl != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; tl.<span style="color:#007f7f">red</span> &amp;&amp; tr != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; tr.<span style="color:#007f7f">red</span>)  <span style="color:#007f7f">// 如果当前节点为红色, 则该节点的左右节点不能同时为红色
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (tl != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; !checkInvariants(tl))
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (tr != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; !checkInvariants(tr))
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>将传入的节点作为根节点，遍历所有节点，校验节点的合法性，主要是保证该树符合红黑树的规则。</p>
<h1 id="resize-方法">resize 方法<a hidden class="anchor" aria-hidden="true" href="#resize-方法">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">92
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> Node&lt;K,V&gt;[] resize() {
</span></span><span style="display:flex;"><span>    Node&lt;K,V&gt;[] oldTab = table;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> oldCap = (oldTab == <span style="color:#fff;font-weight:bold">null</span>) ? <span style="color:#ff0;font-weight:bold">0</span> : oldTab.<span style="color:#007f7f">length</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> oldThr = threshold;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> newCap, newThr = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.老表的容量不为0，即老表不为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (oldCap &gt; <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 1.1 判断老表的容量是否超过最大容量值：如果超过则将阈值设置为Integer.MAX_VALUE，并直接返回老表,
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 此时oldCap * 2比Integer.MAX_VALUE大，因此无法进行重新分布，只是单纯的将阈值扩容到最大
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) {
</span></span><span style="display:flex;"><span>            threshold = Integer.<span style="color:#007f7f">MAX_VALUE</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> oldTab;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 1.2 将newCap赋值为oldCap的2倍，如果newCap&lt;最大容量并且oldCap&gt;=16, 则将新阈值设置为原来的两倍
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> ((newCap = oldCap &lt;&lt; <span style="color:#ff0;font-weight:bold">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;
</span></span><span style="display:flex;"><span>                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)
</span></span><span style="display:flex;"><span>            newThr = oldThr &lt;&lt; <span style="color:#ff0;font-weight:bold">1</span>; <span style="color:#007f7f">// double threshold
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 2.如果老表的容量为0, 老表的阈值大于0, 是因为初始容量被放入阈值，则将新表的容量设置为老表的阈值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (oldThr &gt; <span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>        newCap = oldThr;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 3.老表的容量为0, 老表的阈值为0，这种情况是没有传初始容量的new方法创建的空表，将阈值和容量设置为默认值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        newCap = DEFAULT_INITIAL_CAPACITY;
</span></span><span style="display:flex;"><span>        newThr = (<span style="color:#fff;font-weight:bold">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 4.如果新表的阈值为空, 则通过新的容量*负载因子获得阈值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (newThr == <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">float</span> ft = (<span style="color:#fff;font-weight:bold">float</span>)newCap * loadFactor;
</span></span><span style="display:flex;"><span>        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span style="color:#fff;font-weight:bold">float</span>)MAXIMUM_CAPACITY ?
</span></span><span style="display:flex;"><span>                  (<span style="color:#fff;font-weight:bold">int</span>)ft : Integer.<span style="color:#007f7f">MAX_VALUE</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 5.将当前阈值设置为刚计算出来的新的阈值，定义新表，容量为刚计算出来的新容量，将table设置为新定义的表。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    threshold = newThr;
</span></span><span style="display:flex;"><span>    @SuppressWarnings({<span style="color:#0ff;font-weight:bold">&#34;rawtypes&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;unchecked&#34;</span>})
</span></span><span style="display:flex;"><span>    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span style="color:#fff;font-weight:bold">new</span> Node[newCap];
</span></span><span style="display:flex;"><span>    table = newTab;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 6.如果老表不为空，则需遍历所有节点，将节点赋值给新表
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (oldTab != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> j = <span style="color:#ff0;font-weight:bold">0</span>; j &lt; oldCap; ++j) {
</span></span><span style="display:flex;"><span>            Node&lt;K,V&gt; e;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> ((e = oldTab[j]) != <span style="color:#fff;font-weight:bold">null</span>) {  <span style="color:#007f7f">// 将索引值为j的老表头节点赋值给e
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                oldTab[j] = <span style="color:#fff;font-weight:bold">null</span>; <span style="color:#007f7f">// 将老表的节点设置为空, 以便垃圾收集器回收空间
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#007f7f">// 7.如果e.next为空, 则代表老表的该位置只有1个节点，计算新表的索引位置, 直接将该节点放在该位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> (e.<span style="color:#007f7f">next</span> == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>                    newTab[e.<span style="color:#007f7f">hash</span> &amp; (newCap - <span style="color:#ff0;font-weight:bold">1</span>)] = e;
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 8.如果是红黑树节点，则进行红黑树的重hash分布(跟链表的hash分布基本相同)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (e <span style="color:#fff;font-weight:bold">instanceof</span> TreeNode)
</span></span><span style="display:flex;"><span>                    ((TreeNode&lt;K,V&gt;)e).<span style="color:#007f7f">split</span>(<span style="color:#fff;font-weight:bold">this</span>, newTab, j, oldCap);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">else</span> { <span style="color:#007f7f">// preserve order
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#007f7f">// 9.如果是普通的链表节点，则进行普通的重hash分布
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    Node&lt;K,V&gt; loHead = <span style="color:#fff;font-weight:bold">null</span>, loTail = <span style="color:#fff;font-weight:bold">null</span>; <span style="color:#007f7f">// 存储索引位置为:“原索引位置”的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    Node&lt;K,V&gt; hiHead = <span style="color:#fff;font-weight:bold">null</span>, hiTail = <span style="color:#fff;font-weight:bold">null</span>; <span style="color:#007f7f">// 存储索引位置为:“原索引位置+oldCap”的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    Node&lt;K,V&gt; next;
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">do</span> {
</span></span><span style="display:flex;"><span>                        next = e.<span style="color:#007f7f">next</span>;
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// 9.1 如果e的hash值与老表的容量进行与运算为0,则扩容后的索引位置跟老表的索引位置一样
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        <span style="color:#fff;font-weight:bold">if</span> ((e.<span style="color:#007f7f">hash</span> &amp; oldCap) == <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">if</span> (loTail == <span style="color:#fff;font-weight:bold">null</span>) <span style="color:#007f7f">// 如果loTail为空, 代表该节点为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                                loHead = e; <span style="color:#007f7f">// 则将loHead赋值为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>                                loTail.<span style="color:#007f7f">next</span> = e;    <span style="color:#007f7f">// 否则将节点添加在loTail后面
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            loTail = e; <span style="color:#007f7f">// 并将loTail赋值为新增的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        }
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// 9.2 如果e的hash值与老表的容量进行与运算为非0,则扩容后的索引位置为:老表的索引位置＋oldCap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">if</span> (hiTail == <span style="color:#fff;font-weight:bold">null</span>) <span style="color:#007f7f">// 如果hiTail为空, 代表该节点为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                                hiHead = e; <span style="color:#007f7f">// 则将hiHead赋值为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>                                hiTail.<span style="color:#007f7f">next</span> = e;    <span style="color:#007f7f">// 否则将节点添加在hiTail后面
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            hiTail = e; <span style="color:#007f7f">// 并将hiTail赋值为新增的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        }
</span></span><span style="display:flex;"><span>                    } <span style="color:#fff;font-weight:bold">while</span> ((e = next) != <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">// 10.如果loTail不为空（说明老表的数据有分布到新表上“原索引位置”的节点），则将最后一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#007f7f">// 的next设为空，并将新表上索引位置为“原索引位置”的节点设置为对应的头节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#fff;font-weight:bold">if</span> (loTail != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                        loTail.<span style="color:#007f7f">next</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>                        newTab[j] = loHead;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">// 11.如果hiTail不为空（说明老表的数据有分布到新表上“原索引+oldCap位置”的节点），则将最后
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#007f7f">// 一个节点的next设为空，并将新表上索引位置为“原索引+oldCap”的节点设置为对应的头节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#fff;font-weight:bold">if</span> (hiTail != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                        hiTail.<span style="color:#007f7f">next</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>                        newTab[j + oldCap] = hiHead;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 12.返回新表
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> newTab;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.老表的容量为 0，并且老表的阈值大于 0：这种情况是新建 HashMap 时传了初始容量，例如：new HashMap&lt;&gt;(32)，使用这种方式新建 HashMap 时，由于 HashMap 没有 capacity 属性，所以此时的 capacity 会被暂存在 threshold 属性。因此此时的 threshold 的值就是我们要新创建的 HashMap 的 capacity，所以将新表的容量设置为 threshold。</p>
<p>4.如果新表的阈值为空，则通过新的容量 * 负载因子获得阈值（这种情况是初始化的时候传了初始容量，跟第2点相同情况，或者初始容量设置的太小导致老表的容量没有超过 16 导致的）。</p>
<p>8.如果是红黑树节点，则进行红黑树的重 hash 分布，见代码块10详解。</p>
<p>9.1 如果 e 的 hash 值与老表的容量进行位与运算为 0，则说明 e 节点扩容后的索引位置跟老表的索引位置一样（见例子1详解），进行链表拼接操作：如果 loTail 为空，代表该节点为第一个节点，则将 loHead 赋值为该节点；否则将节点添加在 loTail 后面，并将 loTail 赋值为新增的节点。</p>
<p>9.2 如果 e 的 hash 值与老表的容量进行位与运算为 1，则说明 e 节点扩容后的索引位置为：老表的索引位置＋oldCap（见例子1详解），进行链表拼接操作：如果 hiTail 为空，代表该节点为第一个节点，则将 hiHead 赋值为该节点；否则将节点添加在 hiTail 后面，并将 hiTail 赋值为新增的节点。</p>
<h2 id="代码块10split">代码块10：split<a hidden class="anchor" aria-hidden="true" href="#代码块10split">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 扩容后，红黑树的hash分布，只可能存在于两个位置：原索引位置、原索引位置+oldCap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">void</span> split(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab, <span style="color:#fff;font-weight:bold">int</span> index, <span style="color:#fff;font-weight:bold">int</span> bit) {
</span></span><span style="display:flex;"><span>    TreeNode&lt;K,V&gt; b = <span style="color:#fff;font-weight:bold">this</span>;	<span style="color:#007f7f">// 拿到调用此方法的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    TreeNode&lt;K,V&gt; loHead = <span style="color:#fff;font-weight:bold">null</span>, loTail = <span style="color:#fff;font-weight:bold">null</span>; <span style="color:#007f7f">// 存储索引位置为:“原索引位置”的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    TreeNode&lt;K,V&gt; hiHead = <span style="color:#fff;font-weight:bold">null</span>, hiTail = <span style="color:#fff;font-weight:bold">null</span>; <span style="color:#007f7f">// 存储索引位置为:“原索引+oldCap”的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">int</span> lc = <span style="color:#ff0;font-weight:bold">0</span>, hc = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.以调用此方法的节点开始，遍历整个红黑树节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (TreeNode&lt;K,V&gt; e = b, next; e != <span style="color:#fff;font-weight:bold">null</span>; e = next) {	<span style="color:#007f7f">// 从b节点开始遍历
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        next = (TreeNode&lt;K,V&gt;)e.<span style="color:#007f7f">next</span>;   <span style="color:#007f7f">// next赋值为e的下个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        e.<span style="color:#007f7f">next</span> = <span style="color:#fff;font-weight:bold">null</span>;  <span style="color:#007f7f">// 同时将老表的节点设置为空，以便垃圾收集器回收
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 2.如果e的hash值与老表的容量进行与运算为0,则扩容后的索引位置跟老表的索引位置一样
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((e.<span style="color:#007f7f">hash</span> &amp; bit) == <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> ((e.<span style="color:#007f7f">prev</span> = loTail) == <span style="color:#fff;font-weight:bold">null</span>)  <span style="color:#007f7f">// 如果loTail为空, 代表该节点为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                loHead = e; <span style="color:#007f7f">// 则将loHead赋值为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>                loTail.<span style="color:#007f7f">next</span> = e;    <span style="color:#007f7f">// 否则将节点添加在loTail后面
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            loTail = e; <span style="color:#007f7f">// 并将loTail赋值为新增的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ++lc;   <span style="color:#007f7f">// 统计原索引位置的节点个数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 3.如果e的hash值与老表的容量进行与运算为非0,则扩容后的索引位置为:老表的索引位置＋oldCap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> ((e.<span style="color:#007f7f">prev</span> = hiTail) == <span style="color:#fff;font-weight:bold">null</span>)  <span style="color:#007f7f">// 如果hiHead为空, 代表该节点为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                hiHead = e; <span style="color:#007f7f">// 则将hiHead赋值为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>                hiTail.<span style="color:#007f7f">next</span> = e;    <span style="color:#007f7f">// 否则将节点添加在hiTail后面
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            hiTail = e; <span style="color:#007f7f">// 并将hiTail赋值为新增的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            ++hc;   <span style="color:#007f7f">// 统计索引位置为原索引+oldCap的节点个数
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 4.如果原索引位置的节点不为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (loHead != <span style="color:#fff;font-weight:bold">null</span>) {   <span style="color:#007f7f">// 原索引位置的节点不为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 4.1 如果节点个数&lt;=6个则将红黑树转为链表结构
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (lc &lt;= UNTREEIFY_THRESHOLD)
</span></span><span style="display:flex;"><span>            tab[index] = loHead.<span style="color:#007f7f">untreeify</span>(map);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 4.2 将原索引位置的节点设置为对应的头节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            tab[index] = loHead;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 4.3 如果hiHead不为空，则代表原来的红黑树(老表的红黑树由于节点被分到两个位置)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 已经被改变, 需要重新构建新的红黑树
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (hiHead != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 4.4 以loHead为根节点, 构建新的红黑树
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                loHead.<span style="color:#007f7f">treeify</span>(tab);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 5.如果索引位置为原索引+oldCap的节点不为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (hiHead != <span style="color:#fff;font-weight:bold">null</span>) {   <span style="color:#007f7f">// 索引位置为原索引+oldCap的节点不为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 5.1 如果节点个数&lt;=6个则将红黑树转为链表结构
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (hc &lt;= UNTREEIFY_THRESHOLD)
</span></span><span style="display:flex;"><span>            tab[index + bit] = hiHead.<span style="color:#007f7f">untreeify</span>(map);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 5.2 将索引位置为原索引+oldCap的节点设置为对应的头节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            tab[index + bit] = hiHead;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 5.3 loHead不为空则代表原来的红黑树(老表的红黑树由于节点被分到两个位置)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 已经被改变, 需要重新构建新的红黑树
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (loHead != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 5.4 以hiHead为根节点, 构建新的红黑树
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                hiHead.<span style="color:#007f7f">treeify</span>(tab);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.如果 e 的 hash 值与老表的容量进行位与运算为 0，则说明 e 节点扩容后的索引位置跟老表的索引位置一样（见例子1详解），进行链表拼接操作：如果 loTail 为空，代表该节点为第一个节点，则将 loHead 赋值为该节点；否则将节点添加在 loTail 后面，并将 loTail 赋值为新增的节点，并统计原索引位置的节点个数。</p>
<p>3.如果 e 的 hash 值与老表的容量进行位与运算为 1，则说明 e 节点扩容后的索引位置为：老表的索引位置＋oldCap（见例子1详解），进行链表拼接操作：如果 hiTail 为空，代表该节点为第一个节点，则将 hiHead 赋值为该节点；否则将节点添加在 hiTail 后面，并将 hiTail 赋值为新增的节点，并统计索引位置为原索引 + oldCap 的节点个数。</p>
<p>4.1 如果节点个数 &lt;= 6 个则将红黑树转为链表结构，见代码块11详解。</p>
<p>4.4 以 loHead 为根节点，构建新的红黑树，见代码块7详解。</p>
<h2 id="代码块11untreeify">代码块11：untreeify<a hidden class="anchor" aria-hidden="true" href="#代码块11untreeify">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 将红黑树节点转为链表节点, 当节点&lt;=6个时会被触发
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> Node&lt;K,V&gt; untreeify(HashMap&lt;K,V&gt; map) {
</span></span><span style="display:flex;"><span>    Node&lt;K,V&gt; hd = <span style="color:#fff;font-weight:bold">null</span>, tl = <span style="color:#fff;font-weight:bold">null</span>; <span style="color:#007f7f">// hd指向头节点, tl指向尾节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 1.从调用该方法的节点, 即链表的头节点开始遍历, 将所有节点全转为链表节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">for</span> (Node&lt;K,V&gt; q = <span style="color:#fff;font-weight:bold">this</span>; q != <span style="color:#fff;font-weight:bold">null</span>; q = q.<span style="color:#007f7f">next</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 2.调用replacementNode方法构建链表节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Node&lt;K,V&gt; p = map.<span style="color:#007f7f">replacementNode</span>(q, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 3.如果tl为null, 则代表当前节点为第一个节点, 将hd赋值为该节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (tl == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            hd = p;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 4.否则, 将尾节点的next属性设置为当前节点p
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            tl.<span style="color:#007f7f">next</span> = p;
</span></span><span style="display:flex;"><span>        tl = p; <span style="color:#007f7f">// 5.每次都将tl节点指向当前节点, 即尾节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 6.返回转换后的链表的头节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">return</span> hd;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="例子1扩容后节点重-hash-为什么只可能分布在-原索引位置-与-原索引--oldcap-位置-">例子1：扩容后，节点重 hash 为什么只可能分布在 “原索引位置” 与 “原索引 + oldCap 位置” ？<a hidden class="anchor" aria-hidden="true" href="#例子1扩容后节点重-hash-为什么只可能分布在-原索引位置-与-原索引--oldcap-位置-">#</a></h2>
<p>扩容代码中，使用 e 节点的 hash 值跟 oldCap 进行位与运算，以此决定将节点分布到 “原索引位置” 或者 “原索引 + oldCap 位置” 上，这是为什么了？</p>
<p>假设老表的容量为 16，即 oldCap = 16，则新表容量为 16 * 2 = 32，假设节点 1 的 hash 值为：0000 0000 0000 0000 0000 1111 0000 1010，节点 2 的 hash 值为：0000 0000 0000 0000 0000 1111 0001 1010，则节点 1 和节点 2 在老表的索引位置计算如下图计算1，由于老表的长度限制，节点 1 和节点 2 的索引位置只取决于节点 hash 值的最后 4 位。</p>
<p>再看计算2，计算2为新表的索引计算，可以知道如果两个节点在老表的索引位置相同，则新表的索引位置只取决于节点hash值倒数第5位的值，而此位置的值刚好为老表的容量值 16，此时节点在新表的索引位置只有两种情况：“原索引位置” 和 “原索引 + oldCap位置”，在此例中即为 10 和 10 + 16 = 26。</p>
<p>由于结果只取决于节点 hash 值的倒数第 5 位，而此位置的值刚好为老表的容量值 16，因此此时新表的索引位置的计算可以替换为计算3，直接使用节点的 hash 值与老表的容量 16 进行位于运算，如果结果为 0 则该节点在新表的索引位置为原索引位置，否则该节点在新表的索引位置为 “原索引 + oldCap 位置”。</p>
<p><img loading="lazy" src="3.png" alt=""  />
</p>
<h1 id="remove-方法">remove 方法<a hidden class="anchor" aria-hidden="true" href="#remove-方法">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 移除某个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> V remove(Object key) {
</span></span><span style="display:flex;"><span>    Node&lt;K,V&gt; e;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> (e = removeNode(hash(key), key, <span style="color:#fff;font-weight:bold">null</span>, <span style="color:#fff;font-weight:bold">false</span>, <span style="color:#fff;font-weight:bold">true</span>)) == <span style="color:#fff;font-weight:bold">null</span> ?
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">null</span> : e.<span style="color:#007f7f">value</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> Node&lt;K,V&gt; removeNode(<span style="color:#fff;font-weight:bold">int</span> hash, Object key, Object value,
</span></span><span style="display:flex;"><span>                           <span style="color:#fff;font-weight:bold">boolean</span> matchValue, <span style="color:#fff;font-weight:bold">boolean</span> movable) {
</span></span><span style="display:flex;"><span>    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span style="color:#fff;font-weight:bold">int</span> n, index;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.如果table不为空并且根据hash值计算出来的索引位置不为空, 将该位置的节点赋值给p
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> ((tab = table) != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; (n = tab.<span style="color:#007f7f">length</span>) &gt; <span style="color:#ff0;font-weight:bold">0</span> &amp;&amp;
</span></span><span style="display:flex;"><span>        (p = tab[index = (n - <span style="color:#ff0;font-weight:bold">1</span>) &amp; hash]) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        Node&lt;K,V&gt; node = <span style="color:#fff;font-weight:bold">null</span>, e; K k; V v;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 2.如果p的hash值和key都与入参的相同, 则p即为目标节点, 赋值给node
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (p.<span style="color:#007f7f">hash</span> == hash &amp;&amp;
</span></span><span style="display:flex;"><span>            ((k = p.<span style="color:#007f7f">key</span>) == key || (key != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; key.<span style="color:#007f7f">equals</span>(k))))
</span></span><span style="display:flex;"><span>            node = p;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> ((e = p.<span style="color:#007f7f">next</span>) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 3.否则将p.next赋值给e，向下遍历节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 3.1 如果p是TreeNode则调用红黑树的方法查找节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (p <span style="color:#fff;font-weight:bold">instanceof</span> TreeNode)
</span></span><span style="display:flex;"><span>                node = ((TreeNode&lt;K,V&gt;)p).<span style="color:#007f7f">getTreeNode</span>(hash, key);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 3.2 否则，进行普通链表节点的查找
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">do</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#007f7f">// 当节点的hash值和key与传入的相同,则该节点即为目标节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    <span style="color:#fff;font-weight:bold">if</span> (e.<span style="color:#007f7f">hash</span> == hash &amp;&amp;
</span></span><span style="display:flex;"><span>                        ((k = e.<span style="color:#007f7f">key</span>) == key ||
</span></span><span style="display:flex;"><span>                         (key != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; key.<span style="color:#007f7f">equals</span>(k)))) {
</span></span><span style="display:flex;"><span>                        node = e;	<span style="color:#007f7f">// 赋值给node, 并跳出循环
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        <span style="color:#fff;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    p = e;  <span style="color:#007f7f">// p节点赋值为本次结束的e，在下一次循环中，e为p的next节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                } <span style="color:#fff;font-weight:bold">while</span> ((e = e.<span style="color:#007f7f">next</span>) != <span style="color:#fff;font-weight:bold">null</span>); <span style="color:#007f7f">// e指向下一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 4.如果node不为空(即根据传入key和hash值查找到目标节点)，则进行移除操作
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (node != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; (!matchValue || (v = node.<span style="color:#007f7f">value</span>) == value ||
</span></span><span style="display:flex;"><span>                             (value != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; value.<span style="color:#007f7f">equals</span>(v)))) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 4.1 如果是TreeNode则调用红黑树的移除方法
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (node <span style="color:#fff;font-weight:bold">instanceof</span> TreeNode)
</span></span><span style="display:flex;"><span>                ((TreeNode&lt;K,V&gt;)node).<span style="color:#007f7f">removeTreeNode</span>(<span style="color:#fff;font-weight:bold">this</span>, tab, movable);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 4.2 如果node是该索引位置的头节点则直接将该索引位置的值赋值为node的next节点，
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// “node == p”只会出现在node是头节点的时候，如果node不是头节点，则node为p的next节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (node == p)
</span></span><span style="display:flex;"><span>                tab[index] = node.<span style="color:#007f7f">next</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 4.3 否则将node的上一个节点的next属性设置为node的next节点,
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 即将node节点移除, 将node的上下节点进行关联(链表的移除)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>                p.<span style="color:#007f7f">next</span> = node.<span style="color:#007f7f">next</span>;
</span></span><span style="display:flex;"><span>            ++modCount;
</span></span><span style="display:flex;"><span>            --size;
</span></span><span style="display:flex;"><span>            afterNodeRemoval(node); <span style="color:#007f7f">// 供LinkedHashMap使用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 5.返回被移除的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> node;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>3.1 如果 p 是 TreeNode 则调用红黑树的方法查找节点，<strong>见代码块1详解</strong>。</p>
<p>4.1 如果是 TreeNode 则调用红黑树的移除方法，<strong>见代码块12详解</strong>。</p>
<h2 id="代码块12removetreenode">代码块12：removeTreeNode<a hidden class="anchor" aria-hidden="true" href="#代码块12removetreenode">#</a></h2>
<p>这块代码比较长，目的就是移除调用此方法的节点，也就是该方法中的 this 节点。移除包括链表的处理和红黑树的处理。可以结合下文的图解理解。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">154
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 红黑树的节点移除
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">void</span> removeTreeNode(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab,
</span></span><span style="display:flex;"><span>                          <span style="color:#fff;font-weight:bold">boolean</span> movable) {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// --- 链表的处理start ---
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">int</span> n;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 1.table为空或者length为0直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (tab == <span style="color:#fff;font-weight:bold">null</span> || (n = tab.<span style="color:#007f7f">length</span>) == <span style="color:#ff0;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 2.根据hash计算出索引的位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">int</span> index = (n - <span style="color:#ff0;font-weight:bold">1</span>) &amp; hash;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 3.将索引位置的头节点赋值给first和root
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    TreeNode&lt;K,V&gt; first = (TreeNode&lt;K,V&gt;)tab[index], root = first, rl;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 4.该方法被将要被移除的node(TreeNode)调用, 因此此方法的this为要被移除node节点,
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 将node的next节点赋值给succ节点，prev节点赋值给pred节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    TreeNode&lt;K,V&gt; succ = (TreeNode&lt;K,V&gt;)next, pred = prev;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 5.如果pred节点为空，则代表要被移除的node节点为头节点，
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 则将table索引位置的值和first节点的值赋值为succ节点(node的next节点)即可
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (pred == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>        tab[index] = first = succ;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 6.否则将pred节点的next属性设置为succ节点(node的next节点)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        pred.<span style="color:#007f7f">next</span> = succ;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 7.如果succ节点不为空，则将succ的prev节点设置为pred, 与前面对应
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (succ != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>        succ.<span style="color:#007f7f">prev</span> = pred;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 8.如果进行到此first节点为空，则代表该索引位置已经没有节点则直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (first == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 9.如果root的父节点不为空, 则将root赋值为根节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (root.<span style="color:#007f7f">parent</span> != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>        root = root.<span style="color:#007f7f">root</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 10.通过root节点来判断此红黑树是否太小, 如果是则调用untreeify方法转为链表节点并返回
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// (转链表后就无需再进行下面的红黑树处理)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (root == <span style="color:#fff;font-weight:bold">null</span> || root.<span style="color:#007f7f">right</span> == <span style="color:#fff;font-weight:bold">null</span> ||
</span></span><span style="display:flex;"><span>        (rl = root.<span style="color:#007f7f">left</span>) == <span style="color:#fff;font-weight:bold">null</span> || rl.<span style="color:#007f7f">left</span> == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        tab[index] = first.<span style="color:#007f7f">untreeify</span>(map);  <span style="color:#007f7f">// too small
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// --- 链表的处理end ---
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span> 
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// --- 以下代码为红黑树的处理 ---
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 11.将p赋值为要被移除的node节点，pl赋值为p的左节点，pr赋值为p 的右节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    TreeNode&lt;K,V&gt; p = <span style="color:#fff;font-weight:bold">this</span>, pl = left, pr = right, replacement;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 12.如果p的左节点和右节点都不为空时
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (pl != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; pr != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 12.1 将s节点赋值为p的右节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        TreeNode&lt;K,V&gt; s = pr, sl;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 12.2 向左一直查找，跳出循环时,s为没有左节点的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">while</span> ((sl = s.<span style="color:#007f7f">left</span>) != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            s = sl;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 12.3 交换p节点和s节点的颜色
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">boolean</span> c = s.<span style="color:#007f7f">red</span>; s.<span style="color:#007f7f">red</span> = p.<span style="color:#007f7f">red</span>; p.<span style="color:#007f7f">red</span> = c;
</span></span><span style="display:flex;"><span>        TreeNode&lt;K,V&gt; sr = s.<span style="color:#007f7f">right</span>; <span style="color:#007f7f">// s的右节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        TreeNode&lt;K,V&gt; pp = p.<span style="color:#007f7f">parent</span>;    <span style="color:#007f7f">// p的父节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// --- 第一次调整和第二次调整：将p节点和s节点进行了位置调换 ---
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 12.4 第一次调整
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 如果p节点的右节点即为s节点，则将p的父节点赋值为s，将s的右节点赋值为p
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (s == pr) {
</span></span><span style="display:flex;"><span>            p.<span style="color:#007f7f">parent</span> = s;
</span></span><span style="display:flex;"><span>            s.<span style="color:#007f7f">right</span> = p;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 将sp赋值为s的父节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            TreeNode&lt;K,V&gt; sp = s.<span style="color:#007f7f">parent</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 将p的父节点赋值为sp
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> ((p.<span style="color:#007f7f">parent</span> = sp) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 如果s节点为sp的左节点，则将sp的左节点赋值为p节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> (s == sp.<span style="color:#007f7f">left</span>)
</span></span><span style="display:flex;"><span>                    sp.<span style="color:#007f7f">left</span> = p;
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 否则s节点为sp的右节点，则将sp的右节点赋值为p节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>                    sp.<span style="color:#007f7f">right</span> = p;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// s的右节点赋值为p节点的右节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> ((s.<span style="color:#007f7f">right</span> = pr) != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 如果pr不为空，则将pr的父节点赋值为s
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                pr.<span style="color:#007f7f">parent</span> = s;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 12.5 第二次调整
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 将p的左节点赋值为空，pl已经保存了该节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        p.<span style="color:#007f7f">left</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 将p节点的右节点赋值为sr，如果sr不为空，则将sr的父节点赋值为p节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((p.<span style="color:#007f7f">right</span> = sr) != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            sr.<span style="color:#007f7f">parent</span> = p;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 将s节点的左节点赋值为pl，如果pl不为空，则将pl的父节点赋值为s节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((s.<span style="color:#007f7f">left</span> = pl) != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            pl.<span style="color:#007f7f">parent</span> = s;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 将s的父节点赋值为p的父节点pp
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 如果pp为空，则p节点为root节点, 交换后s成为新的root节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((s.<span style="color:#007f7f">parent</span> = pp) == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            root = s;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 如果p不为root节点, 并且p是pp的左节点，则将pp的左节点赋值为s节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (p == pp.<span style="color:#007f7f">left</span>)
</span></span><span style="display:flex;"><span>            pp.<span style="color:#007f7f">left</span> = s;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 如果p不为root节点, 并且p是pp的右节点，则将pp的右节点赋值为s节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            pp.<span style="color:#007f7f">right</span> = s;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 12.6 寻找replacement节点，用来替换掉p节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 12.6.1 如果sr不为空，则replacement节点为sr，因为s没有左节点，所以使用s的右节点来替换p的位置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (sr != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            replacement = sr;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 12.6.1 如果sr为空，则s为叶子节点，replacement为p本身，只需要将p节点直接去除即可
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            replacement = p;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 13.承接12点的判断，如果p的左节点不为空，右节点为空，replacement节点为p的左节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (pl != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>        replacement = pl;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 14.如果p的右节点不为空,左节点为空，replacement节点为p的右节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (pr != <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>        replacement = pr;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 15.如果p的左右节点都为空, 即p为叶子节点, replacement节点为p节点本身
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        replacement = p;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 16.第三次调整：使用replacement节点替换掉p节点的位置，将p节点移除
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (replacement != p) { <span style="color:#007f7f">// 如果p节点不是叶子节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 16.1 将p节点的父节点赋值给replacement节点的父节点, 同时赋值给pp节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        TreeNode&lt;K,V&gt; pp = replacement.<span style="color:#007f7f">parent</span> = p.<span style="color:#007f7f">parent</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 16.2 如果p没有父节点, 即p为root节点，则将root节点赋值为replacement节点即可
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (pp == <span style="color:#fff;font-weight:bold">null</span>)
</span></span><span style="display:flex;"><span>            root = replacement;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 16.3 如果p不是root节点, 并且p为pp的左节点，则将pp的左节点赋值为替换节点replacement
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (p == pp.<span style="color:#007f7f">left</span>)
</span></span><span style="display:flex;"><span>            pp.<span style="color:#007f7f">left</span> = replacement;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 16.4 如果p不是root节点, 并且p为pp的右节点，则将pp的右节点赋值为替换节点replacement
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            pp.<span style="color:#007f7f">right</span> = replacement;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 16.5 p节点的位置已经被完整的替换为replacement, 将p节点清空, 以便垃圾收集器回收
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        p.<span style="color:#007f7f">left</span> = p.<span style="color:#007f7f">right</span> = p.<span style="color:#007f7f">parent</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 17.如果p节点不为红色则进行红黑树删除平衡调整
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// (如果删除的节点是红色则不会破坏红黑树的平衡无需调整)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    TreeNode&lt;K,V&gt; r = p.<span style="color:#007f7f">red</span> ? root : balanceDeletion(root, replacement);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 18.如果p节点为叶子节点, 则简单的将p节点去除即可
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (replacement == p) {
</span></span><span style="display:flex;"><span>        TreeNode&lt;K,V&gt; pp = p.<span style="color:#007f7f">parent</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 18.1 将p的parent属性设置为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        p.<span style="color:#007f7f">parent</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (pp != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 18.2 如果p节点为父节点的左节点，则将父节点的左节点赋值为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> (p == pp.<span style="color:#007f7f">left</span>)
</span></span><span style="display:flex;"><span>                pp.<span style="color:#007f7f">left</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 18.3 如果p节点为父节点的右节点， 则将父节点的右节点赋值为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (p == pp.<span style="color:#007f7f">right</span>)
</span></span><span style="display:flex;"><span>                pp.<span style="color:#007f7f">right</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (movable)
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 19.将root节点移到索引位置的头节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        moveRootToFront(tab, r);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>7.如果 succ 节点不为空，则将 succ 的 prev 节点设置为 pred，与前面对应（TreeNode 链表的移除，见开头第8点）。</p>
<p>12.6 寻找 replacement，用来替换掉 p 节点。为什么 sr 是 replacement 的首选，p 为备选？见解释1。</p>
<p>PS：代码中的第一次调整和第二次调整是将 p 节点和 s 节点进行了位置调换，然后找出要替换掉 p 节点的 replacement；第三次调整是将 replacement 节点覆盖掉 p 节点；这部分的代码逻辑非常复杂，建议自己动手画图模拟。（下文图解1即为这三次调整的例子）</p>
<p>解释1：为什么 sr 是 replacement 的首选，p 为备选？
解析：首先我们看 sr 是什么？从代码中可以看到 sr 第一次被赋值时，是在 s 节点进行了向左穷遍历结束后，因此此时 s 节点是没有左节点的，sr 即为 s 节点的右节点。而从上面的第一次调整和第二次调整我们知道，p 节点已经跟 s 节点进行了位置调换，所以此时 sr 其实是 p 节点的右节点，并且 p 节点没有左节点，因此要移除 p 节点，只需要将 p 节点的右节点 sr 覆盖掉 p 节点即可，因此 sr 是 replacement 的首选，而如果 sr 为空，则代表 p 节点为叶子节点，此时将 p 节点直接移除即可。</p>
<p>图解1：removeTreeNode 图解
本图解忽略红黑树的颜色，请注意。</p>
<p>下面的图解是代码中的最复杂的情况，即流程最长的那个，p 节点不为根节点，p 节点有左右节点，s 节点不为 pr 节点，s 节点有右节点。</p>
<p>另外，第一次调整和第二次调整的是本人根据代码而设定的，将第一次调整和第二次调整合起来看会更容易理解，如下：</p>
<ul>
<li>第一次调整 + 第二次调整：将 p 节点和 s 节点进行了位置调换，选出要替换掉 p 节点的 replacement</li>
<li>第三次调整：将 replacement 节点覆盖掉 p 节点</li>
</ul>
<p><img loading="lazy" src="4.png" alt=""  />
</p>
<h2 id="解释2关于红黑树的平衡调整">解释2：关于红黑树的平衡调整？<a hidden class="anchor" aria-hidden="true" href="#解释2关于红黑树的平衡调整">#</a></h2>
<p>答：红黑树的操作涉及的操作比较复杂，三言两语无法说清。有兴趣的可以去单独学习，本文由于篇幅关系暂不详细介绍红黑树的具体操作，在这简单的介绍：红黑树是一种自平衡二叉树，拥有优秀的查询和插入/删除性能，广泛应用于关联数组。</p>
<p>对比 AVL 树，AVL 要求每个节点的左右子树的高度之差的绝对值（平衡因子）最多为 1，而红黑树通过适当的放低该条件（红黑树限制从根到叶子的最长的可能路径不多于最短的可能路径的两倍长，结果是这个树大致上是平衡的），以此来减少插入/删除时的平衡调整耗时，从而获取更好的性能，而这虽然会导致红黑树的查询会比 AVL 稍慢，但相比插入/删除时获取的时间，这个付出在大多数情况下显然是值得的。</p>
<p>在 HashMap 中的应用：HashMap 在进行插入和删除时有可能会触发红黑树的插入平衡调整（balanceInsertion 方法）或删除平衡调整（balanceDeletion 方法），调整的方式主要有以下手段：左旋转（rotateLeft 方法）、右旋转（rotateRight 方法）、改变节点颜色（x.red = false、x.red = true），进行调整的原因是为了维持红黑树的数据结构。</p>
<h1 id="死循环问题">死循环问题<a hidden class="anchor" aria-hidden="true" href="#死循环问题">#</a></h1>
<p>在 JDK 1.8 以前，Java 语言在并发情况下使用 HashMap 造成 Race Condition，从而导致死循环。程序经常占了 100% 的 CPU，查看堆栈，你会发现程序都 Hang 在了 “HashMap.get()” 这个方法上了，重启程序后问题消失。具体分析可以查看这篇文章：<a href="https://coolshell.cn/articles/9606.html">疫苗：JAVA HASHMAP的死循环</a>，有人将这个问题当成一个 bug 提给了 Sun，但是 Sun 认为这并不是个 bug，因为HashMap 本来就不保证并发的线程安全性，在并发下，要用 ConcurrentHashMap 来代替。</p>
<p>我们知道，JDK 1.8 以前，导致死循环的主要原因是扩容后，节点的顺序会反掉，如下图：扩容前节点 A 在节点 C 前面，而扩容后节点 C 在节点 A 前面。</p>
<h1 id="jdk-18扩容过程">JDK 1.8扩容过程<a hidden class="anchor" aria-hidden="true" href="#jdk-18扩容过程">#</a></h1>
<p>JDK1.8 普通链表的扩容代码，如下所示，在上文已经分析过了：主要是在一个 do/while 中处理同一个位置的所有节点。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">else</span> { <span style="color:#007f7f">// preserve order
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 9.如果是普通的链表节点，则进行普通的重hash分布
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Node&lt;K,V&gt; loHead = <span style="color:#fff;font-weight:bold">null</span>, loTail = <span style="color:#fff;font-weight:bold">null</span>; <span style="color:#007f7f">// 存储索引位置为:“原索引位置”的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Node&lt;K,V&gt; hiHead = <span style="color:#fff;font-weight:bold">null</span>, hiTail = <span style="color:#fff;font-weight:bold">null</span>; <span style="color:#007f7f">// 存储索引位置为:“原索引位置+oldCap”的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    Node&lt;K,V&gt; next;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">do</span> {
</span></span><span style="display:flex;"><span>        next = e.<span style="color:#007f7f">next</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 9.1 如果e的hash值与老表的容量进行与运算为0,则扩容后的索引位置跟老表的索引位置一样
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((e.<span style="color:#007f7f">hash</span> &amp; oldCap) == <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (loTail == <span style="color:#fff;font-weight:bold">null</span>) <span style="color:#007f7f">// 如果loTail为空, 代表该节点为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                loHead = e; <span style="color:#007f7f">// 则将loHead赋值为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>                loTail.<span style="color:#007f7f">next</span> = e;    <span style="color:#007f7f">// 否则将节点添加在loTail后面
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            loTail = e; <span style="color:#007f7f">// 并将loTail赋值为新增的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 9.2 如果e的hash值与老表的容量进行与运算为非0,则扩容后的索引位置为:老表的索引位置＋oldCap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (hiTail == <span style="color:#fff;font-weight:bold">null</span>) <span style="color:#007f7f">// 如果hiTail为空, 代表该节点为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                hiHead = e; <span style="color:#007f7f">// 则将hiHead赋值为第一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>                hiTail.<span style="color:#007f7f">next</span> = e;    <span style="color:#007f7f">// 否则将节点添加在hiTail后面
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            hiTail = e; <span style="color:#007f7f">// 并将hiTail赋值为新增的节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">while</span> ((e = next) != <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 10.如果loTail不为空（说明老表的数据有分布到新表上“原索引位置”的节点），则将最后一个节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 的next设为空，并将新表上索引位置为“原索引位置”的节点设置为对应的头节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (loTail != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        loTail.<span style="color:#007f7f">next</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        newTab[j] = loHead;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 11.如果hiTail不为空（说明老表的数据有分布到新表上“原索引+oldCap位置”的节点），则将最后
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// 一个节点的next设为空，并将新表上索引位置为“原索引+oldCap”的节点设置为对应的头节点
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (hiTail != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        hiTail.<span style="color:#007f7f">next</span> = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        newTab[j + oldCap] = hiHead;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>前提</strong>：我们假设有3个节点，节点 A，节点 B，节点 C，并且假设他们的 hash 值等于 key 值，则按上图扩容的过程模拟如下。</p>
<p>先看下老表和新表计算索引位置的过程：（hash 计算省略前面 28 位 0，只看最后 4 位）</p>
<p><img loading="lazy" src="5.png" alt=""  />
</p>
<h2 id="具体扩容过程">具体扩容过程：<a hidden class="anchor" aria-hidden="true" href="#具体扩容过程">#</a></h2>
<p><img loading="lazy" src="6.png" alt=""  />
</p>
<p>****结果：****可以看出，扩容后，节点 A 和节点 C 的先后顺序跟扩容前是一样的。因此，即使此时有多个线程并发扩容，也不会出现死循环的情况。当然，这仍然改变不了 HashMap 仍是非并发安全，在并发下，还是要使用 ConcurrentHashMap 来代替。</p>
<h1 id="hashmap实现的cloneable接口">HashMap实现的Cloneable接口<a hidden class="anchor" aria-hidden="true" href="#hashmap实现的cloneable接口">#</a></h1>
<p>HashMap实现了Cloneable接口，即实现了clone()方法。
clone()方法的作用很简单，就是克隆一个HashMap对象并返回。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public Object clone() {
</span></span><span style="display:flex;"><span>        HashMap&lt;K,V&gt; result;
</span></span><span style="display:flex;"><span>        try {
</span></span><span style="display:flex;"><span>            result = (HashMap&lt;K,V&gt;)super.clone();
</span></span><span style="display:flex;"><span>        } catch (CloneNotSupportedException e) {
</span></span><span style="display:flex;"><span>            // this shouldn&#39;t happen, since we are Cloneable
</span></span><span style="display:flex;"><span>            throw new InternalError(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        result.reinitialize();
</span></span><span style="display:flex;"><span>        result.putMapEntries(this, false);
</span></span><span style="display:flex;"><span>        return result;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="hashmap遍历方式">HashMap遍历方式<a hidden class="anchor" aria-hidden="true" href="#hashmap遍历方式">#</a></h1>
<h2 id="遍历键值对">遍历键值对<a hidden class="anchor" aria-hidden="true" href="#遍历键值对">#</a></h2>
<ol>
<li>根据entrySet()获取HashMap的“键值对”的Set集合。</li>
<li>通过Iterator迭代器遍历“第一步”得到的集合。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 假设map是HashMap对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// map中的key是String类型，value是Integer类型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Integer integ = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>Iterator iter = map.<span style="color:#007f7f">entrySet</span>().<span style="color:#007f7f">iterator</span>();
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">while</span>(iter.<span style="color:#007f7f">hasNext</span>()) {
</span></span><span style="display:flex;"><span>    Map.<span style="color:#007f7f">Entry</span> entry = (Map.<span style="color:#007f7f">Entry</span>)iter.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 获取key
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    key = (String)entry.<span style="color:#007f7f">getKey</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 获取value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    integ = (Integer)entry.<span style="color:#007f7f">getValue</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="遍历键">遍历键<a hidden class="anchor" aria-hidden="true" href="#遍历键">#</a></h2>
<ol>
<li>根据keySet()获取HashMap的“键”的Set集合。</li>
<li>通过Iterator迭代器遍历“第一步”得到的集合。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 假设map是HashMap对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// map中的key是String类型，value是Integer类型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>String key = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>Integer integ = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>Iterator iter = map.<span style="color:#007f7f">keySet</span>().<span style="color:#007f7f">iterator</span>();
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">while</span> (iter.<span style="color:#007f7f">hasNext</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 获取key
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    key = (String)iter.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 根据key，获取value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    integ = (Integer)map.<span style="color:#007f7f">get</span>(key);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="遍历值">遍历值<a hidden class="anchor" aria-hidden="true" href="#遍历值">#</a></h2>
<ol>
<li>根据values()获取HashMap的“值”的集合。</li>
<li>过Iterator迭代器遍历“第一步”得到的集合。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 假设map是HashMap对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">// map中的key是String类型，value是Integer类型
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Integer value = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>Collection c = map.<span style="color:#007f7f">values</span>();
</span></span><span style="display:flex;"><span>Iterator iter= c.<span style="color:#007f7f">iterator</span>();
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">while</span> (iter.<span style="color:#007f7f">hasNext</span>()) {
</span></span><span style="display:flex;"><span>    value = (Integer)iter.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="jdk18">JDK1.8<a hidden class="anchor" aria-hidden="true" href="#jdk18">#</a></h2>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>map.forEach((k,v)-&gt;{
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="hashmap代码示例">HashMap代码示例<a hidden class="anchor" aria-hidden="true" href="#hashmap代码示例">#</a></h1>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Map;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Random;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Iterator;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.HashSet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Map.Entry;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Collection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HashMapTest {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        testHashMapAPIs();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> testHashMapAPIs() {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 初始化随机种子
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Random r = <span style="color:#fff;font-weight:bold">new</span> Random();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 新建HashMap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        HashMap map = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 添加操作
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;one&#34;</span>, r.<span style="color:#007f7f">nextInt</span>(<span style="color:#ff0;font-weight:bold">10</span>));
</span></span><span style="display:flex;"><span>        map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;two&#34;</span>, r.<span style="color:#007f7f">nextInt</span>(<span style="color:#ff0;font-weight:bold">10</span>));
</span></span><span style="display:flex;"><span>        map.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;three&#34;</span>, r.<span style="color:#007f7f">nextInt</span>(<span style="color:#ff0;font-weight:bold">10</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 打印出map
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;map:&#34;</span>+map );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 通过Iterator遍历key-value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Iterator iter = map.<span style="color:#007f7f">entrySet</span>().<span style="color:#007f7f">iterator</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span>(iter.<span style="color:#007f7f">hasNext</span>()) {
</span></span><span style="display:flex;"><span>            Map.<span style="color:#007f7f">Entry</span> entry = (Map.<span style="color:#007f7f">Entry</span>)iter.<span style="color:#007f7f">next</span>();
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;next : &#34;</span>+ entry.<span style="color:#007f7f">getKey</span>() +<span style="color:#0ff;font-weight:bold">&#34; - &#34;</span>+entry.<span style="color:#007f7f">getValue</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// HashMap的键值对个数        
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;size:&#34;</span>+map.<span style="color:#007f7f">size</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// containsKey(Object key) :是否包含键key
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;contains key two : &#34;</span>+map.<span style="color:#007f7f">containsKey</span>(<span style="color:#0ff;font-weight:bold">&#34;two&#34;</span>));
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;contains key five : &#34;</span>+map.<span style="color:#007f7f">containsKey</span>(<span style="color:#0ff;font-weight:bold">&#34;five&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// containsValue(Object value) :是否包含值value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;contains value 0 : &#34;</span>+map.<span style="color:#007f7f">containsValue</span>(<span style="color:#fff;font-weight:bold">new</span> Integer(<span style="color:#ff0;font-weight:bold">0</span>)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// remove(Object key) ： 删除键key对应的键值对
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        map.<span style="color:#007f7f">remove</span>(<span style="color:#0ff;font-weight:bold">&#34;three&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;map:&#34;</span>+map );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// clear() ： 清空HashMap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        map.<span style="color:#007f7f">clear</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// isEmpty() : HashMap是否为空
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>((map.<span style="color:#007f7f">isEmpty</span>()?<span style="color:#0ff;font-weight:bold">&#34;map is empty&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;map is not empty&#34;</span>) );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，HashMap内容总结完毕，有待完善，其中很多源码都是JDK1.6版本的，Java8的HashMap相比之前有较大的优化，
其中最重要的一个优化就是桶中的元素不再唯一按照链表组合，也可以使用红黑树进行存储，总之，目标只有一个，那就是在安全和功能性完备的情况下让其速度更快，提升性能。</p>
<h1 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h1>
<ul>
<li>HashMap 的底层是个 Node 数组（Node&lt;K,V&gt;[] table），在数组的具体索引位置，如果存在多个节点，则可能是以链表或红黑树的形式存在。</li>
<li>增加、删除、查找键值对时，定位到哈希桶数组的位置是很关键的一步，源码中是通过下面3个操作来完成这一步：1）拿到 key 的 hashCode 值；2）将 hashCode 的高位参与运算，重新计算 hash 值；3）将计算出来的 hash 值与 “table.length - 1” 进行 &amp; 运算。</li>
<li>HashMap 的默认初始容量（capacity）是 16，capacity 必须为 2 的幂次方；默认负载因子（load factor）是 0.75；实际能存放的节点个数（threshold，即触发扩容的阈值）= capacity * load factor。</li>
<li>HashMap 在触发扩容后，阈值会变为原来的 2 倍，并且会对所有节点进行重 hash 分布，重 hash 分布后节点的新分布位置只可能有两个：“原索引位置” 或 “原索引+oldCap位置”。例如 capacity 为16，索引位置 5 的节点扩容后，只可能分布在新表 “索引位置5” 和 “索引位置21（5+16）”。</li>
<li>导致 HashMap 扩容后，同一个索引位置的节点重 hash 最多分布在两个位置的根本原因是：1）table的长度始终为 2 的 n 次方；2）索引位置的计算方法为 “(table.length - 1) &amp; hash”。HashMap 扩容是一个比较耗时的操作，定义 HashMap 时尽量给个接近的初始容量值。</li>
<li>HashMap 有 threshold 属性和 loadFactor 属性，但是没有 capacity 属性。初始化时，如果传了初始化容量值，该值是存在 threshold 变量，并且 Node 数组是在第一次 put 时才会进行初始化，初始化时会将此时的 threshold 值作为新表的 capacity 值，然后用 capacity 和 loadFactor 计算新表的真正 threshold 值。</li>
<li>当同一个索引位置的节点在增加后达到 9 个时，并且此时数组的长度大于等于 64，则会触发链表节点（Node）转红黑树节点（TreeNode），转成红黑树节点后，其实链表的结构还存在，通过 next 属性维持。链表节点转红黑树节点的具体方法为源码中的 treeifyBin 方法。而如果数组长度小于64，则不会触发链表转红黑树，而是会进行扩容。</li>
<li>当同一个索引位置的节点在移除后达到 6 个时，并且该索引位置的节点为红黑树节点，会触发红黑树节点转链表节点。红黑树节点转链表节点的具体方法为源码中的 untreeify 方法。</li>
<li>HashMap 在 JDK 1.8 之后不再有死循环的问题，JDK 1.8 之前存在死循环的根本原因是在扩容后同一索引位置的节点顺序会反掉。</li>
<li>HashMap 是非线程安全的，在并发场景下使用 ConcurrentHashMap 来代替。</li>
</ul>
<p><a href="https://blog.csdn.net/v123411739/article/details/78996181/">参考</a></p>
<h1 id="concurrenthashmap">ConcurrentHashMap<a hidden class="anchor" aria-hidden="true" href="#concurrenthashmap">#</a></h1>
<h2 id="jdk17中的-concurrenthashmap">jdk1.7中的 ConcurrentHashMap<a hidden class="anchor" aria-hidden="true" href="#jdk17中的-concurrenthashmap">#</a></h2>
<p>针对<code>HashTable</code>会锁整个hash表的问题，ConcurrentHashMap提出了分段锁的解决方案。
分段锁的思想就是：锁的时候不锁整个hash表，而是只锁一部分。
如何实现呢？这就用到了ConcurrentHashMap中最关键的Segment。
ConcurrentHashMap中维护着一个Segment数组，每个Segment可以看做是一个HashMap。
而Segment本身继承了ReentrantLock，它本身就是一个锁。
在Segment中通过HashEntry数组来维护其内部的hash表。
每个HashEntry就代表了map中的一个K-V，用HashEntry可以组成一个链表结构，通过next字段引用到其下一个元素。
所以1.7中的ConcurrentHashMap定位一个元素的过程需要进行两次Hash操作。第一次Hash定位到Segment，第二次Hash定位到元素所在的链表的头部。</p>
<p>使用Segment的坏处：
Hash的过程要比普通的HashMap要长</p>
<p>好处：
可以只对元素所在的Segment进行加锁即可，不会影响到其他的Segment。
这样，在最理想的情况下，ConcurrentHashMap可以最高同时支持Segment数量大小的写操作。</p>
<h2 id="jdk18中的-concurrenthashmap">jdk1.8中的 ConcurrentHashMap<a hidden class="anchor" aria-hidden="true" href="#jdk18中的-concurrenthashmap">#</a></h2>
<p>JDK8中ConcurrentHashMap参考了JDK8 HashMap的实现，采用了数组+链表+红黑树的实现方式来设计，内部大量采用CAS操作，这里简要介绍下CAS。</p>
<p>CAS是compare and swap的缩写，即我们所说的比较交换。cas是一种基于锁的操作，而且是乐观锁。在java中锁分为乐观锁和悲观锁。悲观锁是将资源锁住，等一个之前获得锁的线程释放锁之后，下一个线程才可以访问。而乐观锁采取了一种宽泛的态度，通过某种方式不加锁来处理资源，比如通过给记录加version来获取数据，性能较悲观锁有很大的提高。</p>
<p>CAS 操作包含三个操作数 —— 内存位置（V）、预期原值（A）和新值(B)。如果内存地址里面的值和A的值是一样的，那么就将内存里面的值更新成B。CAS是通过无限循环来获取数据的，如果在第一轮循环中，a线程获取地址里面的值被b线程修改了，那么a线程需要自旋，到下次循环才有可能机会执行。
JDK8中彻底放弃了Segment转而采用的是Node，其设计思想也不再是JDK1.7中的分段锁思想。
Node：保存key，value及key的hash值的数据结构。其中value和next都用volatile修饰，保证并发的可见性。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>class Node&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; {
</span></span><span style="display:flex;"><span>    final int hash;
</span></span><span style="display:flex;"><span>    final K key;
</span></span><span style="display:flex;"><span>    volatile V val;
</span></span><span style="display:flex;"><span>    volatile Node&lt;K,V&gt; next;
</span></span><span style="display:flex;"><span>    //... 省略部分代码
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="题">题<a hidden class="anchor" aria-hidden="true" href="#题">#</a></h1>
<h2 id="hashmap-的底层数据结构">HashMap 的底层数据结构<a hidden class="anchor" aria-hidden="true" href="#hashmap-的底层数据结构">#</a></h2>
<p>JDK 1.8底层是由“数组+链表+红黑树”组成，而在 JDK 1.8 之前是由“数组+链表”组成。</p>
<h2 id="为什么要改成数组链表红黑树">为什么要改成“数组+链表+红黑树”？<a hidden class="anchor" aria-hidden="true" href="#为什么要改成数组链表红黑树">#</a></h2>
<p>主要是为了提升在 hash 冲突严重时（链表过长）的查找性能，使用链表的查找性能是 O(n)，而使用红黑树是 O(logn)。</p>
<h2 id="那在什么时候用链表什么时候用红黑树">那在什么时候用链表？什么时候用红黑树？<a hidden class="anchor" aria-hidden="true" href="#那在什么时候用链表什么时候用红黑树">#</a></h2>
<p>对于插入，默认情况下是使用链表节点。当同一个索引位置的节点在新增后达到9个（阈值8）：如果此时数组长度大于等于 64，则会触发链表节点转红黑树节点（treeifyBin）；而如果数组长度小于64，则不会触发链表转红黑树，而是会进行扩容，因为此时的数据量还比较小。</p>
<p>对于移除，当同一个索引位置的节点在移除后达到 6 个，并且该索引位置的节点为红黑树节点，会触发红黑树节点转链表节点（untreeify）。</p>
<h2 id="为什么链表转红黑树的阈值是8">为什么链表转红黑树的阈值是8？<a hidden class="anchor" aria-hidden="true" href="#为什么链表转红黑树的阈值是8">#</a></h2>
<p>我们平时在进行方案设计时，必须考虑的两个很重要的因素是：时间和空间。对于 HashMap 也是同样的道理，简单来说，阈值为8是在时间和空间上权衡的结果。红黑树节点大小约为链表节点的2倍，在节点太少时，红黑树的查找性能优势并不明显，付出2倍空间的代价作者觉得不值得。</p>
<p>理想情况下，使用随机的哈希码，节点分布在 hash 桶中的频率遵循泊松分布，按照泊松分布的公式计算，链表中节点个数为8时的概率为 0.00000006，这个概率足够低了，并且到8个节点时，红黑树的性能优势也会开始展现出来，因此8是一个较合理的数字。</p>
<h2 id="那为什么转回链表节点是用的6而不是复用8">那为什么转回链表节点是用的6而不是复用8？<a hidden class="anchor" aria-hidden="true" href="#那为什么转回链表节点是用的6而不是复用8">#</a></h2>
<p>如果我们设置节点多于8个转红黑树，少于8个就马上转链表，当节点个数在8徘徊时，就会频繁进行红黑树和链表的转换，造成性能的损耗。</p>
<h2 id="那-hashmap-有哪些重要属性分别用于做什么的">那 HashMap 有哪些重要属性？分别用于做什么的？<a hidden class="anchor" aria-hidden="true" href="#那-hashmap-有哪些重要属性分别用于做什么的">#</a></h2>
<p>除了用来存储我们的节点 table 数组外，HashMap 还有以下几个重要属性：</p>
<p>1）size：HashMap 已经存储的节点个数；
2）threshold：扩容阈值，当 HashMap 的个数达到该值，触发扩容。
3）loadFactor：负载因子，扩容阈值 = 容量 * 负载因子。</p>
<h2 id="threshold-除了用于存放扩容阈值还有其他作用吗">threshold 除了用于存放扩容阈值还有其他作用吗？<a hidden class="anchor" aria-hidden="true" href="#threshold-除了用于存放扩容阈值还有其他作用吗">#</a></h2>
<p>在我们新建 HashMap 对象时， threshold 还会被用来存初始化时的容量。HashMap 直到我们第一次插入节点时，才会对 table 进行初始化，避免不必要的空间浪费。</p>
<h2 id="hashmap-的默认初始容量是多少hashmap-的容量有什么限制吗">HashMap 的默认初始容量是多少？HashMap 的容量有什么限制吗？<a hidden class="anchor" aria-hidden="true" href="#hashmap-的默认初始容量是多少hashmap-的容量有什么限制吗">#</a></h2>
<p>默认初始容量是16。HashMap 的容量必须是2的N次方，HashMap 会根据我们传入的容量计算一个大于等于该容量的最小的2的N次方，例如传 9，容量为16。</p>
<h2 id="你说-hashmap-的容量必须是-2-的-n-次方这是为什么">你说 HashMap 的容量必须是 2 的 N 次方，这是为什么？<a hidden class="anchor" aria-hidden="true" href="#你说-hashmap-的容量必须是-2-的-n-次方这是为什么">#</a></h2>
<p>计算索引位置的公式为：(n - 1) &amp; hash，当 n 为 2 的 N 次方时，n - 1 为低位全是 1 的值，此时任何值跟 n - 1 进行 &amp; 运算的结果为该值的低 N 位，达到了和取模同样的效果，实现了均匀分布。实际上，这个设计就是基于公式：x mod 2^n = x &amp; (2^n - 1)，因为 &amp; 运算比 mod 具有更高的效率。</p>
<h2 id="hashmap-的默认初始容量是-16为什么是16而不是其他的">HashMap 的默认初始容量是 16，为什么是16而不是其他的？<a hidden class="anchor" aria-hidden="true" href="#hashmap-的默认初始容量是-16为什么是16而不是其他的">#</a></h2>
<p>16是2的N次方，并且是一个较合理的大小。如果用8或32，我觉得也是OK的。实际上，我们在新建 HashMap 时，最好是根据自己使用情况设置初始容量，这才是最合理的方案。</p>
<h2 id="hashmap-的负载因子默认初始值又是多少为什么是这个数">HashMap 的负载因子默认初始值又是多少？为什么是这个数？<a hidden class="anchor" aria-hidden="true" href="#hashmap-的负载因子默认初始值又是多少为什么是这个数">#</a></h2>
<p>负载因子默认值是0.75。这个也是在时间和空间上权衡的结果。如果值较高，例如1，此时会减少空间开销，但是 hash 冲突的概率会增大，增加查找成本；而如果值较低，例如 0.5 ，此时 hash 冲突会降低，但是有一半的空间会被浪费，所以折衷考虑 0.75 似乎是一个合理的值。</p>
<h2 id="hashmap-的插入流程是怎么样的">HashMap 的插入流程是怎么样的？<a hidden class="anchor" aria-hidden="true" href="#hashmap-的插入流程是怎么样的">#</a></h2>
<p><img loading="lazy" src="7.png" alt=""  />
</p>
<h2 id="介绍扩容resize的流程">介绍扩容（resize）的流程<a hidden class="anchor" aria-hidden="true" href="#介绍扩容resize的流程">#</a></h2>
<p><img loading="lazy" src="8.png" alt=""  />
</p>
<h2 id="hashmap-是线程安全的吗">HashMap 是线程安全的吗？<a hidden class="anchor" aria-hidden="true" href="#hashmap-是线程安全的吗">#</a></h2>
<p>不是。HashMap 在并发下存在数据覆盖、遍历的同时进行修改会抛出 ConcurrentModificationException 异常等问题，JDK 1.8 之前还存在死循环问题。</p>
<h2 id="介绍一下死循环问题">介绍一下死循环问题？<a hidden class="anchor" aria-hidden="true" href="#介绍一下死循环问题">#</a></h2>
<p>导致死循环的根本原因是 JDK 1.7 扩容采用的是“头插法”，会导致同一索引位置的节点在扩容后顺序反掉。而 JDK 1.8 之后采用的是“尾插法”，扩容后节点顺序不会反掉，不存在死循环问题。</p>
<h2 id="jdk-18-对-hashmap-主要进行了哪些优化">JDK 1.8 对 HashMap 主要进行了哪些优化？<a hidden class="anchor" aria-hidden="true" href="#jdk-18-对-hashmap-主要进行了哪些优化">#</a></h2>
<ul>
<li>底层数据结构从“数组+链表”改成“数组+链表+红黑树”，主要是优化了 hash 冲突较严重时，链表过长的查找性能：O(n) -&gt; O(logn)。</li>
<li>计算 table 初始容量的方式发生了改变，老的方式是从1开始不断向左进行移位运算，直到找到大于等于入参容量的值；新的方式则是通过“5个移位+或等于运算”来计算。</li>
<li>优化了 hash 值的计算方式，老的通过一顿瞎JB操作，新的只是简单的让高16位参与了运算。</li>
<li>扩容时插入方式从“头插法”改成“尾插法”，避免了并发下的死循环。</li>
<li>扩容时计算节点在新表的索引位置方式从“h &amp; (length-1)”改成“hash &amp; oldCap”，性能可能提升不大，但设计更巧妙、更优雅。</li>
</ul>
<h2 id="介绍下-concurrenhashmap要讲出-17-和-18-的区别">介绍下 ConcurrenHashMap，要讲出 1.7 和 1.8 的区别？<a hidden class="anchor" aria-hidden="true" href="#介绍下-concurrenhashmap要讲出-17-和-18-的区别">#</a></h2>
<p>ConcurrentHashMap 是 HashMap 的线程安全版本，和 HashMap 一样，在JDK 1.8 中进行了较大的优化。
JDK1.7：底层结构为：分段的数组+链表；实现线程安全的方式：分段锁（Segment，继承了ReentrantLock），如下图所示。
JDK1.8：底层结构为：数组+链表+红黑树；实现线程安全的方式：CAS + Synchronized</p>
<p>区别：</p>
<ul>
<li>JDK1.8 中降低锁的粒度。JDK1.7 版本锁的粒度是基于 Segment 的，包含多个节点（HashEntry），而 JDK1.8 锁的粒度就是单节点（Node）。</li>
<li>JDK1.8 版本的数据结构变得更加简单，使得操作也更加清晰流畅，因为已经使用 synchronized 来进行同步，所以不需要分段锁的概念，也就不需要 Segment 这种数据结构了，当前还保留仅为了兼容。</li>
<li>JDK1.8 使用红黑树来优化链表，跟 HashMap 一样，优化了极端情况下，链表过长带来的性能问题。</li>
<li>JDK1.8 使用内置锁 synchronized 来代替重入锁 ReentrantLock，synchronized 是官方一直在不断优化的，现在性能已经比较可观，也是官方推荐使用的加锁方式。</li>
</ul>
<h2 id="concurrenthashmap-的并发扩容">ConcurrentHashMap 的并发扩容<a hidden class="anchor" aria-hidden="true" href="#concurrenthashmap-的并发扩容">#</a></h2>
<p>ConcurrentHashMap 在扩容时会计算出一个步长（stride），最小值是16，然后给当前扩容线程分配“一个步长”的节点数，例如16个，让该线程去对这16个节点进行扩容操作（将节点从老表移动到新表）。</p>
<p>如果在扩容结束前又来一个线程，则也会给该线程分配一个步长的节点数让该线程去扩容。依次类推，以达到多线程并发扩容的效果。</p>
<p>例如：64要扩容到128，步长为16，则第一个线程会负责第113（索引112）~128（索引127）的节点，第二个线程会负责第97（索引96）~112（索引111）的节点，依次类推。</p>
<p>具体处理（该流程后续可能会替换成流程图）：</p>
<p>1）如果索引位置上为null，则直接使用 CAS 将索引位置赋值为 ForwardingNode（hash值为-1），表示已经处理过，这个也是触发并发扩容的关键点。</p>
<p>2）如果索引位置的节点 f 的 hash 值为 MOVED（-1），则代表节点 f 是 ForwardingNode 节点，只有 ForwardingNode 的 hash 值为 -1，意味着该节点已经处理过了，则跳过该节点继续往下处理。</p>
<p>3）.否则，对索引位置的节点 f 对象使用 synchronized 进行加锁，遍历链表或红黑树，如果找到 key 和入参相同的，则替换掉 value 值；如果没找到，则新增一个节点。如果是链表，同时判断是否需要转红黑树。处理完在索引位置的节点后，会将该索引位置赋值为 ForwardingNode，表示该位置已经处理过。</p>
<p>ForwardingNode：一个特殊的 Node 节点，hash 值为-1（源码中定义成 MOVED），其中存储 nextTable 的引用。 只有发生扩容的时候，ForwardingNode才会发挥作用，作为一个占位符放在 table 中表示当前节点已经被处理（或则为 null ）。</p>
<h2 id="hashset-是如何保证不重复的">HashSet 是如何保证不重复的？<a hidden class="anchor" aria-hidden="true" href="#hashset-是如何保证不重复的">#</a></h2>
<p>HashSet 底层使用 HashMap 来实现，见下面的源码，元素放在 HashMap 的 key 里，value 为固定的 Object 对象。当 add 时调用 HashMap 的 put 方法，如果元素不存在，则返回 null 表示 add 成功，否则 add 失败。
由于 HashMap 的 Key 值本身就不允许重复，HashSet 正好利用 HashMap 中 key 不重复的特性来校验重复元素。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">transient</span> HashMap&lt;E,Object&gt; map;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// Dummy value to associate with an Object in the backing Map
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> Object PRESENT = <span style="color:#fff;font-weight:bold">new</span> Object();
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">boolean</span> add(E e) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> map.<span style="color:#007f7f">put</span>(e, PRESENT)==<span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="arraylist-和-linkedlist-的区别">ArrayList 和 LinkedList 的区别？<a hidden class="anchor" aria-hidden="true" href="#arraylist-和-linkedlist-的区别">#</a></h2>
<ul>
<li>
<p>ArrayList 底层基于动态数组实现，LinkedList 底层基于双向链表实现。</p>
</li>
<li>
<p>对于随机访问（按 index 访问，get/set方法）：ArrayList 通过 index 直接定位到数组对应位置的节点，而 LinkedList需要从头结点或尾节点开始遍历，直到寻找到目标节点，因此在效率上 ArrayList 优于 LinkedList。</p>
</li>
<li>
<p>对于随机插入和删除：ArrayList 需要移动目标节点后面的节点（使用System.arraycopy 方法移动节点），而 LinkedList 只需修改目标节点前后节点的 next 或 prev 属性即可，因此在效率上 LinkedList 优于 ArrayList。</p>
</li>
<li>
<p>对于顺序插入和删除：由于 ArrayList 不需要移动节点，因此在效率上比 LinkedList 更好。这也是为什么在实际使用中 ArrayList 更多，因为大部分情况下我们的使用都是顺序插入。</p>
</li>
<li>
<p>两者都不是线程安全的。</p>
</li>
<li>
<p>内存空间占用： ArrayList 的空 间浪费主要体现在在 list 列表的结尾会预留一定的容量空间，而 LinkedList 的空间花费则体现在它的每一个元素都需要消耗比 ArrayList 更多的空间（因为要存放直接后继和直接前驱以及数据）。</p>
</li>
</ul>
<p><a href="https://blog.csdn.net/v123411739/article/details/106324537">题参考</a></p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/collection/">Collection</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
