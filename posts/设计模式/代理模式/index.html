<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ä»£ç†æ¨¡å¼ | Wjy&#39;s Blog</title>
<meta name="keywords" content="è®¾è®¡æ¨¡å¼">
<meta name="description" content="å¿«é€Ÿå­¦ä¹ 
ç±»å‹ï¼šç»“æ„å‹

ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚
">
<meta name="author" content="Wjy">
<link rel="canonical" href="https://funny-toffee-4aa7c3.netlify.app/posts/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://funny-toffee-4aa7c3.netlify.app/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://funny-toffee-4aa7c3.netlify.app/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://funny-toffee-4aa7c3.netlify.app/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://funny-toffee-4aa7c3.netlify.app/apple-touch-icon.png">
<link rel="mask-icon" href="https://funny-toffee-4aa7c3.netlify.app/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="ä»£ç†æ¨¡å¼" />
<meta property="og:description" content="å¿«é€Ÿå­¦ä¹ 
ç±»å‹ï¼šç»“æ„å‹

ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://funny-toffee-4aa7c3.netlify.app/posts/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-12-10T16:45:26+00:00" />
<meta property="article:modified_time" content="2018-12-10T16:45:26+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ä»£ç†æ¨¡å¼"/>
<meta name="twitter:description" content="å¿«é€Ÿå­¦ä¹ 
ç±»å‹ï¼šç»“æ„å‹

ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚
"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ä»£ç†æ¨¡å¼",
      "item": "https://funny-toffee-4aa7c3.netlify.app/posts/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ä»£ç†æ¨¡å¼",
  "name": "ä»£ç†æ¨¡å¼",
  "description": "å¿«é€Ÿå­¦ä¹  ç±»å‹ï¼šç»“æ„å‹\nä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚\n",
  "keywords": [
    "è®¾è®¡æ¨¡å¼"
  ],
  "articleBody": "å¿«é€Ÿå­¦ä¹  ç±»å‹ï¼šç»“æ„å‹\nä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚\nä»£ç†æ¨¡å¼ï¼Œå³Proxyï¼Œå®ƒå’ŒAdapteræ¨¡å¼å¾ˆç±»ä¼¼ã€‚æˆ‘ä»¬å…ˆå›é¡¾Adapteræ¨¡å¼ï¼Œå®ƒç”¨äºæŠŠAæ¥å£è½¬æ¢ä¸ºBæ¥å£ï¼š\n1 2 3 4 5 6 7 8 9 public class BAdapter implements B { private A a; public BAdapter(A a) { this.a = a; } public void b() { a.a(); } } è€ŒProxyæ¨¡å¼ä¸æ˜¯æŠŠAæ¥å£è½¬æ¢æˆBæ¥å£ï¼Œå®ƒè¿˜æ˜¯è½¬æ¢æˆAæ¥å£ï¼š\n1 2 3 4 5 6 7 8 9 public class AProxy implements A { private A a; public AProxy(A a) { this.a = a; } public void a() { this.a.a(); } } åˆç€Proxyå°±æ˜¯ä¸ºäº†ç»™Aæ¥å£å†åŒ…ä¸€å±‚ï¼Œè¿™ä¸æ˜¯è„±äº†è£¤å­æ”¾å±å—ï¼Ÿ\nå½“ç„¶ä¸æ˜¯ã€‚æˆ‘ä»¬è§‚å¯ŸProxyçš„å®ç°Aæ¥å£çš„æ–¹æ³•ï¼š\n1 2 3 public void a() { this.a.a(); } è¿™æ ·å†™å½“ç„¶æ²¡å•¥åµç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨è°ƒç”¨a.a()çš„å‰åï¼ŒåŠ ä¸€äº›é¢å¤–çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 public void a() { if (getCurrentUser().isRoot()) { this.a.a(); } else { throw new SecurityException(\"Forbidden\"); } } è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å®ç°äº†æƒé™æ£€æŸ¥ï¼Œåªæœ‰ç¬¦åˆè¦æ±‚çš„ç”¨æˆ·ï¼Œæ‰ä¼šçœŸæ­£è°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼Œå¦åˆ™ï¼Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚\næœ‰çš„ç«¥é‹ä¼šé—®ï¼Œä¸ºå•¥ä¸æŠŠæƒé™æ£€æŸ¥çš„åŠŸèƒ½ç›´æ¥å†™åˆ°ç›®æ ‡å®ä¾‹Açš„å†…éƒ¨ï¼Ÿ\nå› ä¸ºæˆ‘ä»¬ç¼–å†™ä»£ç çš„åŸåˆ™æœ‰ï¼š\nèŒè´£æ¸…æ™°ï¼šä¸€ä¸ªç±»åªè´Ÿè´£ä¸€ä»¶äº‹ï¼› æ˜“äºæµ‹è¯•ï¼šä¸€æ¬¡åªæµ‹ä¸€ä¸ªåŠŸèƒ½ã€‚ ç”¨Proxyå®ç°è¿™ä¸ªæƒé™æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—æ›´æ¸…æ™°ã€æ›´ç®€æ´çš„ä»£ç ï¼š\nAæ¥å£ï¼šåªå®šä¹‰æ¥å£ï¼› ABusinessç±»ï¼šåªå®ç°Aæ¥å£çš„ä¸šåŠ¡é€»è¾‘ï¼› APermissionProxyç±»ï¼šåªå®ç°Aæ¥å£çš„æƒé™æ£€æŸ¥ä»£ç†ã€‚ å¦‚æœæˆ‘ä»¬å¸Œæœ›ç¼–å†™å…¶ä»–ç±»å‹çš„ä»£ç†ï¼Œå¯ä»¥ç»§ç»­å¢åŠ ç±»ä¼¼ALogProxyï¼Œè€Œä¸å¿…å¯¹ç°æœ‰çš„Aæ¥å£ã€ABusinessç±»è¿›è¡Œä¿®æ”¹ã€‚\nå®é™…ä¸Šæƒé™æ£€æŸ¥åªæ˜¯ä»£ç†æ¨¡å¼çš„ä¸€ç§åº”ç”¨ã€‚Proxyè¿˜å¹¿æ³›åº”ç”¨åœ¨ï¼š\nè¿œç¨‹ä»£ç† è¿œç¨‹ä»£ç†å³Remote Proxyï¼Œæœ¬åœ°çš„è°ƒç”¨è€…æŒæœ‰çš„æ¥å£å®é™…ä¸Šæ˜¯ä¸€ä¸ªä»£ç†ï¼Œè¿™ä¸ªä»£ç†è´Ÿè´£æŠŠå¯¹æ¥å£çš„æ–¹æ³•è®¿é—®è½¬æ¢æˆè¿œç¨‹è°ƒç”¨ï¼Œç„¶åè¿”å›ç»“æœã€‚Javaå†…ç½®çš„RMIæœºåˆ¶å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¿œç¨‹ä»£ç†æ¨¡å¼ã€‚\nè™šä»£ç† è™šä»£ç†å³Virtual Proxyï¼Œå®ƒè®©è°ƒç”¨è€…å…ˆæŒæœ‰ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä½†çœŸæ­£çš„å¯¹è±¡å°šæœªåˆ›å»ºã€‚å¦‚æœæ²¡æœ‰å¿…è¦ï¼Œè¿™ä¸ªçœŸæ­£çš„å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆ›å»ºçš„ï¼Œç›´åˆ°å®¢æˆ·ç«¯éœ€è¦çœŸçš„å¿…é¡»è°ƒç”¨æ—¶ï¼Œæ‰åˆ›å»ºçœŸæ­£çš„å¯¹è±¡ã€‚JDBCçš„è¿æ¥æ± è¿”å›çš„JDBCè¿æ¥ï¼ˆConnectionå¯¹è±¡ï¼‰å°±å¯ä»¥æ˜¯ä¸€ä¸ªè™šä»£ç†ï¼Œå³è·å–è¿æ¥æ—¶æ ¹æœ¬æ²¡æœ‰ä»»ä½•å®é™…çš„æ•°æ®åº“è¿æ¥ï¼Œç›´åˆ°ç¬¬ä¸€æ¬¡æ‰§è¡ŒJDBCæŸ¥è¯¢æˆ–æ›´æ–°æ“ä½œæ—¶ï¼Œæ‰çœŸæ­£åˆ›å»ºå®é™…çš„JDBCè¿æ¥ã€‚\nä¿æŠ¤ä»£ç† ä¿æŠ¤ä»£ç†å³Protection Proxyï¼Œå®ƒç”¨ä»£ç†å¯¹è±¡æ§åˆ¶å¯¹åŸå§‹å¯¹è±¡çš„è®¿é—®ï¼Œå¸¸ç”¨äºé‰´æƒã€‚\næ™ºèƒ½å¼•ç”¨ æ™ºèƒ½å¼•ç”¨å³Smart Referenceï¼Œå®ƒä¹Ÿæ˜¯ä¸€ç§ä»£ç†å¯¹è±¡ï¼Œå¦‚æœæœ‰å¾ˆå¤šå®¢æˆ·ç«¯å¯¹å®ƒè¿›è¡Œè®¿é—®ï¼Œé€šè¿‡å†…éƒ¨çš„è®¡æ•°å™¨å¯ä»¥åœ¨å¤–éƒ¨è°ƒç”¨è€…éƒ½ä¸ä½¿ç”¨åè‡ªåŠ¨é‡Šæ”¾å®ƒã€‚\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•åº”ç”¨ä»£ç†æ¨¡å¼ç¼–å†™ä¸€ä¸ªJDBCè¿æ¥æ± ï¼ˆDataSourceï¼‰ã€‚æˆ‘ä»¬é¦–å…ˆæ¥ç¼–å†™ä¸€ä¸ªè™šä»£ç†ï¼Œå³å¦‚æœè°ƒç”¨è€…è·å–åˆ°Connectionåï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œä»»ä½•SQLæ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªConnection Proxyå®é™…ä¸Šå¹¶ä¸ä¼šçœŸæ­£æ‰“å¼€JDBCè¿æ¥ã€‚è°ƒç”¨è€…ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 DataSource lazyDataSource = new LazyDataSource(jdbcUrl, jdbcUsername, jdbcPassword); System.out.println(\"get lazy connection...\"); try (Connection conn1 = lazyDataSource.getConnection()) { // å¹¶æ²¡æœ‰å®é™…æ‰“å¼€çœŸæ­£çš„Connection } System.out.println(\"get lazy connection...\"); try (Connection conn2 = lazyDataSource.getConnection()) { try (PreparedStatement ps = conn2.prepareStatement(\"SELECT * FROM students\")) { // æ‰“å¼€äº†çœŸæ­£çš„Connection try (ResultSet rs = ps.executeQuery()) { while (rs.next()) { System.out.println(rs.getString(\"name\")); } } } } ç°åœ¨æˆ‘ä»¬æ¥æ€è€ƒå¦‚ä½•å®ç°è¿™ä¸ªLazyConnectionProxyã€‚ä¸ºäº†ç®€åŒ–ä»£ç ï¼Œæˆ‘ä»¬é¦–å…ˆé’ˆå¯¹Connectionæ¥å£åšä¸€ä¸ªæŠ½è±¡çš„ä»£ç†ç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public abstract class AbstractConnectionProxy implements Connection { // æŠ½è±¡æ–¹æ³•è·å–å®é™…çš„Connection: protected abstract Connection getRealConnection(); // å®ç°Connectionæ¥å£çš„æ¯ä¸€ä¸ªæ–¹æ³•: public Statement createStatement() throws SQLException { return getRealConnection().createStatement(); } public PreparedStatement prepareStatement(String sql) throws SQLException { return getRealConnection().prepareStatement(sql); } ...å…¶ä»–ä»£ç†æ–¹æ³•... } è¿™ä¸ªAbstractConnectionProxyä»£ç†ç±»çš„ä½œç”¨æ˜¯æŠŠConnectionæ¥å£å®šä¹‰çš„æ–¹æ³•å…¨éƒ¨å®ç°ä¸€éï¼Œå› ä¸ºConnectionæ¥å£å®šä¹‰çš„æ–¹æ³•å¤ªå¤šäº†ï¼Œåé¢æˆ‘ä»¬è¦ç¼–å†™çš„LazyConnectionProxyåªéœ€è¦ç»§æ‰¿AbstractConnectionProxyï¼Œå°±ä¸å¿…å†æŠŠConnectionæ¥å£æ–¹æ³•æŒ¨ä¸ªå®ç°ä¸€éã€‚\nLazyConnectionProxyå®ç°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public class LazyConnectionProxy extends AbstractConnectionProxy { private Supplier supplier; private Connection target = null; public LazyConnectionProxy(Supplier supplier) { this.supplier = supplier; } // è¦†å†™closeæ–¹æ³•ï¼šåªæœ‰targetä¸ä¸ºnullæ—¶æ‰éœ€è¦å…³é—­: public void close() throws SQLException { if (target != null) { System.out.println(\"Close connection: \" + target); super.close(); } } @Override protected Connection getRealConnection() { if (target == null) { target = supplier.get(); } return target; } } å¦‚æœè°ƒç”¨è€…æ²¡æœ‰æ‰§è¡Œä»»ä½•SQLè¯­å¥ï¼Œé‚£ä¹ˆtargetå­—æ®µå§‹ç»ˆä¸ºnullã€‚åªæœ‰ç¬¬ä¸€æ¬¡æ‰§è¡ŒSQLè¯­å¥æ—¶ï¼ˆå³è°ƒç”¨ä»»ä½•ç±»ä¼¼prepareStatement()æ–¹æ³•æ—¶ï¼Œè§¦å‘getRealConnection()è°ƒç”¨ï¼‰ï¼Œæ‰ä¼šçœŸæ­£æ‰“å¼€å®é™…çš„JDBC Connectionã€‚\næœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™ä¸€ä¸ªLazyDataSourceæ¥æ”¯æŒè¿™ä¸ªLazyConnectionProxyï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public class LazyDataSource implements DataSource { private String url; private String username; private String password; public LazyDataSource(String url, String username, String password) { this.url = url; this.username = username; this.password = password; } public Connection getConnection(String username, String password) throws SQLException { return new LazyConnectionProxy(() -\u003e { try { Connection conn = DriverManager.getConnection(url, username, password); System.out.println(\"Open connection: \" + conn); return conn; } catch (SQLException e) { throw new RuntimeException(e); } }); } ... } æˆ‘ä»¬æ‰§è¡Œä»£ç ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 get lazy connection... get lazy connection... Open connection: com.mysql.jdbc.JDBC4Connection@7a36aefa å°æ˜ å°çº¢ å°å†› å°ç™½ ... Close connection: com.mysql.jdbc.JDBC4Connection@7a36aefa å¯è§ç¬¬ä¸€ä¸ªgetConnection()è°ƒç”¨è·å–åˆ°çš„LazyConnectionProxyå¹¶æ²¡æœ‰å®é™…æ‰“å¼€çœŸæ­£çš„JDBC Connectionã€‚\nä½¿ç”¨è¿æ¥æ± çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›èƒ½é‡å¤ä½¿ç”¨è¿æ¥ã€‚å¦‚æœè°ƒç”¨æ–¹ç¼–å†™è¿™æ ·çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 DataSource pooledDataSource = new PooledDataSource(jdbcUrl, jdbcUsername, jdbcPassword); try (Connection conn = pooledDataSource.getConnection()) { } try (Connection conn = pooledDataSource.getConnection()) { // è·å–åˆ°çš„æ˜¯åŒä¸€ä¸ªConnection } try (Connection conn = pooledDataSource.getConnection()) { // è·å–åˆ°çš„æ˜¯åŒä¸€ä¸ªConnection } è°ƒç”¨æ–¹å¹¶ä¸å…³å¿ƒæ˜¯å¦å¤ç”¨äº†Connectionï¼Œä½†ä»PooledDataSourceè·å–çš„Connectionç¡®å®è‡ªå¸¦è¿™ä¸ªä¼˜åŒ–åŠŸèƒ½ã€‚å¦‚ä½•å®ç°å¯å¤ç”¨Connectionçš„è¿æ¥æ± ï¼Ÿç­”æ¡ˆä»ç„¶æ˜¯ä½¿ç”¨ä»£ç†æ¨¡å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public class PooledConnectionProxy extends AbstractConnectionProxy { // å®é™…çš„Connection: Connection target; // ç©ºé—²é˜Ÿåˆ—: Queue idleQueue; public PooledConnectionProxy(Queue idleQueue, Connection target) { this.idleQueue = idleQueue; this.target = target; } public void close() throws SQLException { System.out.println(\"Fake close and released to idle queue for future reuse: \" + target); // å¹¶æ²¡æœ‰è°ƒç”¨å®é™…Connectionçš„close()æ–¹æ³•, // è€Œæ˜¯æŠŠè‡ªå·±æ”¾å…¥ç©ºé—²é˜Ÿåˆ—: idleQueue.offer(this); } protected Connection getRealConnection() { return target; } } å¤ç”¨è¿æ¥çš„å…³é”®åœ¨äºè¦†å†™close()æ–¹æ³•ï¼Œå®ƒå¹¶æ²¡æœ‰çœŸæ­£å…³é—­åº•å±‚JDBCè¿æ¥ï¼Œè€Œæ˜¯æŠŠè‡ªå·±æ”¾å›ä¸€ä¸ªç©ºé—²é˜Ÿåˆ—ï¼Œä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨ã€‚\nç©ºé—²é˜Ÿåˆ—ç”±PooledDataSourceè´Ÿè´£ç»´æŠ¤ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 public class PooledDataSource implements DataSource { private String url; private String username; private String password; // ç»´æŠ¤ä¸€ä¸ªç©ºé—²é˜Ÿåˆ—: private Queue idleQueue = new ArrayBlockingQueue\u003c\u003e(100); public PooledDataSource(String url, String username, String password) { this.url = url; this.username = username; this.password = password; } public Connection getConnection(String username, String password) throws SQLException { // é¦–å…ˆè¯•å›¾è·å–ä¸€ä¸ªç©ºé—²è¿æ¥: PooledConnectionProxy conn = idleQueue.poll(); if (conn == null) { // æ²¡æœ‰ç©ºé—²è¿æ¥æ—¶ï¼Œæ‰“å¼€ä¸€ä¸ªæ–°è¿æ¥: conn = openNewConnection(); } else { System.out.println(\"Return pooled connection: \" + conn.target); } return conn; } private PooledConnectionProxy openNewConnection() throws SQLException { Connection conn = DriverManager.getConnection(url, username, password); System.out.println(\"Open new connection: \" + conn); return new PooledConnectionProxy(idleQueue, conn); } ... } æˆ‘ä»¬æ‰§è¡Œè°ƒç”¨æ–¹ä»£ç ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 Open new connection: com.mysql.jdbc.JDBC4Connection@61ca2dfa Fake close and released to idle queue for future reuse: com.mysql.jdbc.JDBC4Connection@61ca2dfa Return pooled connection: com.mysql.jdbc.JDBC4Connection@61ca2dfa Fake close and released to idle queue for future reuse: com.mysql.jdbc.JDBC4Connection@61ca2dfa Return pooled connection: com.mysql.jdbc.JDBC4Connection@61ca2dfa Fake close and released to idle queue for future reuse: com.mysql.jdbc.JDBC4Connection@61ca2dfa é™¤äº†ç¬¬ä¸€æ¬¡æ‰“å¼€äº†ä¸€ä¸ªçœŸæ­£çš„JDBC Connectionï¼Œåç»­è·å–çš„Connectionå®é™…ä¸Šæ˜¯åŒä¸€ä¸ªJDBC Connectionã€‚ä½†æ˜¯ï¼Œå¯¹äºè°ƒç”¨æ–¹æ¥è¯´ï¼Œå®Œå…¨ä¸éœ€è¦çŸ¥é“åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ã€‚\næˆ‘ä»¬å®é™…ä½¿ç”¨çš„DataSourceï¼Œä¾‹å¦‚HikariCPï¼Œéƒ½æ˜¯åŸºäºä»£ç†æ¨¡å¼å®ç°çš„ï¼ŒåŸç†åŒä¸Šï¼Œä½†å¢åŠ äº†æ›´å¤šçš„å¦‚åŠ¨æ€ä¼¸ç¼©çš„åŠŸèƒ½ï¼ˆä¸€ä¸ªè¿æ¥ç©ºé—²ä¸€æ®µæ—¶é—´åè‡ªåŠ¨å…³é—­ï¼‰ã€‚\næœ‰çš„ç«¥é‹ä¼šå‘ç°Proxyæ¨¡å¼å’ŒDecoratoræ¨¡å¼æœ‰äº›ç±»ä¼¼ã€‚ç¡®å®ï¼Œè¿™ä¸¤è€…çœ‹èµ·æ¥å¾ˆåƒï¼Œä½†åŒºåˆ«åœ¨äºï¼šDecoratoræ¨¡å¼è®©è°ƒç”¨è€…è‡ªå·±åˆ›å»ºæ ¸å¿ƒç±»ï¼Œç„¶åç»„åˆå„ç§åŠŸèƒ½ï¼Œè€ŒProxyæ¨¡å¼å†³ä¸èƒ½è®©è°ƒç”¨è€…è‡ªå·±åˆ›å»ºå†ç»„åˆï¼Œå¦åˆ™å°±å¤±å»äº†ä»£ç†çš„åŠŸèƒ½ã€‚Proxyæ¨¡å¼è®©è°ƒç”¨è€…è®¤ä¸ºè·å–åˆ°çš„æ˜¯æ ¸å¿ƒç±»æ¥å£ï¼Œä½†å®é™…ä¸Šæ˜¯ä»£ç†ç±»ã€‚\næ¦‚è¿° ä»£ç†æ¨¡å¼å¯ä»¥é€šè¿‡ä»£ç†å¯¹è±¡è®¿é—®ç›®æ ‡å¯¹è±¡ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šåœ¨å®ç°ç›®æ ‡å¯¹è±¡çš„åŸºç¡€ä¸Šï¼Œæ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚ä¸è¦éšæ„å»ä¿®æ”¹åˆ«äººå·²ç»å†™å¥½çš„ä»£ç æˆ–è€…æ–¹æ³•ï¼Œå¦‚æœéœ€æ”¹ä¿®æ”¹ï¼Œå¯ä»¥é€šè¿‡ä»£ç†çš„æ–¹å¼æ¥æ‰©å±•è¯¥æ–¹æ³•ã€‚\nä»£ç†å¯¹è±¡æ˜¯ç›®æ ‡å¯¹è±¡çš„æ‰©å±•ï¼Œå¹¶ä¼šè°ƒç”¨ç›®æ ‡å¯¹è±¡ã€‚\né™æ€ä»£ç† é™æ€ä»£ç†åœ¨ä½¿ç”¨æ—¶ï¼Œéœ€è¦å®šä¹‰æ¥å£æˆ–è€…çˆ¶ç±»ï¼Œè¢«ä»£ç†å¯¹è±¡ä¸ä»£ç†å¯¹è±¡ä¸€èµ·å®ç°ç›¸åŒçš„æ¥å£æˆ–è€…æ˜¯ç»§æ‰¿ç›¸åŒçˆ¶ç±»ã€‚\n1 2 3 4 //æ¥å£ public interface UserService { void save(); } 1 2 3 4 5 6 7 //æ¥å£å®ç°ï¼šç›®æ ‡å¯¹è±¡ public class UserServiceImpl implements UserService{ @Override public void save() { System.out.println(\"----å·²ç»ä¿å­˜æ•°æ®!----\"); } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /** * ä»£ç†å¯¹è±¡,é™æ€ä»£ç† */ public class UserProxy implements UserService{ //æ¥æ”¶ä¿å­˜ç›®æ ‡å¯¹è±¡ private UserService target; public UserProxy(UserService target){ this.target=target; } @Override public void save() { if (getCurrentUser().isRoot()) { //æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³• target.save(); } else { throw new SecurityException(\"Forbidden\"); } } } 1 2 3 4 5 6 7 8 9 10 11 12 13 /** * æµ‹è¯•ç±» */ public class Test { public static void main(String[] args) { //ç›®æ ‡å¯¹è±¡ UserService userService = new UserServiceImpl(); //ä»£ç†å¯¹è±¡,æŠŠç›®æ ‡å¯¹è±¡ä¼ ç»™ä»£ç†å¯¹è±¡,å»ºç«‹ä»£ç†å…³ç³» UserProxy userProxy = new UserProxy(userService); //æ‰§è¡Œçš„æ˜¯ä»£ç†çš„æ–¹æ³• userProxy.save(); } } æˆ‘ä»¬ç¼–å†™ä»£ç çš„åŸåˆ™æœ‰ï¼š\nèŒè´£æ¸…æ™°ï¼šä¸€ä¸ªç±»åªè´Ÿè´£ä¸€ä»¶äº‹ï¼› æ˜“äºæµ‹è¯•ï¼šä¸€æ¬¡åªæµ‹ä¸€ä¸ªåŠŸèƒ½ã€‚ ç”¨Proxyå®ç°è¿™ä¸ªæƒé™æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—æ›´æ¸…æ™°ã€æ›´ç®€æ´çš„ä»£ç ï¼š\nAæ¥å£ï¼šåªå®šä¹‰æ¥å£ï¼› ABusinessç±»ï¼šåªå®ç°Aæ¥å£çš„ä¸šåŠ¡é€»è¾‘ï¼› APermissionProxyç±»ï¼šåªå®ç°Aæ¥å£çš„æƒé™æ£€æŸ¥ä»£ç†ã€‚ å¦‚æœæˆ‘ä»¬å¸Œæœ›ç¼–å†™å…¶ä»–ç±»å‹çš„ä»£ç†ï¼Œå¯ä»¥ç»§ç»­å¢åŠ ç±»ä¼¼ALogProxyï¼Œè€Œä¸å¿…å¯¹ç°æœ‰çš„Aæ¥å£ã€ABusinessç±»è¿›è¡Œä¿®æ”¹ã€‚\né™æ€ä»£ç†æ€»ç»“ï¼š ä¼˜ç‚¹ï¼šå¯ä»¥åšåˆ°åœ¨ä¸ä¿®æ”¹ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½å‰æä¸‹ï¼Œå¯¹ç›®æ ‡åŠŸèƒ½æ‰©å±•ã€‚ ç¼ºç‚¹ï¼šå› ä¸ºä»£ç†å¯¹è±¡éœ€è¦ä¸ç›®æ ‡å¯¹è±¡å®ç°ä¸€æ ·çš„æ¥å£ï¼Œæ‰€ä»¥ä¼šæœ‰å¾ˆå¤šä»£ç†ç±»ï¼Œç±»å¤ªå¤šã€‚åŒæ—¶ï¼Œä¸€æ—¦æ¥å£å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡ä¸ä»£ç†å¯¹è±¡éƒ½è¦ç»´æŠ¤ã€‚ å¦‚ä½•è§£å†³é™æ€ä»£ç†ä¸­çš„ç¼ºç‚¹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥ä½¿ç”¨åŠ¨æ€ä»£ç†æ–¹å¼ã€‚\nåŠ¨æ€ä»£ç† ç‰¹ç‚¹ï¼š\nä»£ç†å¯¹è±¡ï¼Œä¸éœ€è¦å®ç°æ¥å£ ä»£ç†å¯¹è±¡çš„ç”Ÿæˆï¼Œæ˜¯åˆ©ç”¨JDKçš„APIï¼ŒåŠ¨æ€çš„åœ¨å†…å­˜ä¸­æ„å»ºä»£ç†å¯¹è±¡ï¼ˆéœ€è¦æˆ‘ä»¬æŒ‡å®šåˆ›å»ºä»£ç†å¯¹è±¡/ç›®æ ‡å¯¹è±¡å®ç°çš„æ¥å£çš„ç±»å‹ï¼‰ åŠ¨æ€ä»£ç†ä¹Ÿå«åšï¼šJDKä»£ç†ï¼Œæ¥å£ä»£ç† JDKä¸­ç”Ÿæˆä»£ç†å¯¹è±¡çš„API ä»£ç†ç±»æ‰€åœ¨åŒ…ï¼šjava.lang.reflect.Proxy JDKå®ç°ä»£ç†åªéœ€è¦ä½¿ç”¨newProxyInstanceæ–¹æ³•ï¼Œä½†æ˜¯è¯¥æ–¹æ³•éœ€è¦æ¥æ”¶ä¸‰ä¸ªå‚æ•°,å®Œæ•´çš„å†™æ³•æ˜¯ï¼š static Object newProxyInstance(ClassLoader loader, Class\u003c?\u003e[] interfaces,InvocationHandler h )\næ³¨æ„è¯¥æ–¹æ³•æ˜¯åœ¨Proxyç±»ä¸­æ˜¯é™æ€æ–¹æ³•ï¼Œä¸”æ¥æ”¶çš„ä¸‰ä¸ªå‚æ•°ä¾æ¬¡ä¸ºï¼š\nClassLoader loaderï¼šæŒ‡å®šå½“å‰ç›®æ ‡å¯¹è±¡ä½¿ç”¨ç±»åŠ è½½å™¨ï¼Œè·å–åŠ è½½å™¨çš„æ–¹æ³•æ˜¯å›ºå®šçš„ Class\u003c?\u003e[] interfacesï¼šç›®æ ‡å¯¹è±¡å®ç°çš„æ¥å£çš„ç±»å‹,ä½¿ç”¨æ³›å‹æ–¹å¼ç¡®è®¤ç±»å‹ äº‹ä»¶å¤„ç†ï¼Œæ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œä¼šè§¦å‘äº‹ä»¶å¤„ç†å™¨çš„æ–¹æ³•ï¼Œä¼šæŠŠå½“å‰æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ä½œä¸ºå‚æ•°ä¼ å…¥ æ¥å£ç±» UserServiceã€ç›®æ ‡å¯¹è±¡ UserServiceImpl æ— éœ€ä¿®æ”¹ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¢åŠ ä»£ç†å·¥å‚ç±»ï¼šProxyFactory\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 /** * åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡ * åŠ¨æ€ä»£ç†ä¸éœ€è¦å®ç°æ¥å£,ä½†æ˜¯éœ€è¦æŒ‡å®šæ¥å£ç±»å‹ */ public class ProxyFactory { //ç»´æŠ¤ä¸€ä¸ªç›®æ ‡å¯¹è±¡ private Object target; public ProxyFactory(Object target) { this.target = target; } //ç»™ç›®æ ‡å¯¹è±¡ç”Ÿæˆä»£ç†å¯¹è±¡ public Object getProxyInstance(){ InvocationHandler handler = (proxy, method, args) -\u003e { System.out.println(\"å¼€å§‹äº‹åŠ¡2\"); //æ‰§è¡Œç›®æ ‡å¯¹è±¡æ–¹æ³• Object returnValue = method.invoke(target, args); System.out.println(\"æäº¤äº‹åŠ¡2\"); return returnValue; }; Object proxyInstance = Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), handler); return proxyInstance; } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /** * æµ‹è¯•ç±» */ public class Test { public static void main(String[] args) { // ç›®æ ‡å¯¹è±¡ UserService userService = new UserServiceImpl(); // åŸå§‹ç±»å‹ class cn.wjy.UserServiceImpl System.out.println(userService.getClass()); // ç»™ç›®æ ‡å¯¹è±¡ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡ UserService proxy = (UserService) new ProxyFactory(userService).getProxyInstance(); // class $Proxy0 å†…å­˜ä¸­åŠ¨æ€ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ System.out.println(proxy.getClass()); // ä»£ç†å¯¹è±¡ï¼Œæ‰§è¡Œæ–¹æ³• proxy.save(); } } ä»£ç†å¯¹è±¡ä¸éœ€è¦å®ç°æ¥å£ï¼Œä½†æ˜¯ç›®æ ‡å¯¹è±¡ä¸€å®šè¦å®ç°æ¥å£ï¼Œå¦åˆ™ä¸èƒ½ç”¨åŠ¨æ€ä»£ç†ã€‚\nCglib ä»£ç† Cglibä»£ç†ï¼Œä¹Ÿå«ä½œå­ç±»ä»£ç†ï¼Œå®ƒæ˜¯åœ¨å†…å­˜ä¸­æ„å»ºä¸€ä¸ªå­ç±»å¯¹è±¡ä»è€Œå®ç°å¯¹ç›®æ ‡å¯¹è±¡åŠŸèƒ½çš„æ‰©å±•ã€‚ é™ã€åŠ¨æ€ä»£ç†éƒ½è¦æ±‚ç›®æ ‡å¯¹è±¡å®ç°æ¥å£ï¼Œä½†æœ‰æ—¶ç›®æ ‡å¯¹è±¡åªæ˜¯ä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ï¼Œæ²¡æœ‰å®ç°ä»»ä½•å£ï¼Œæ­¤æ—¶å¯ä½¿ç”¨Cglibä»£ç†ã€‚\nCglibæ˜¯ä¸€ä¸ªå¼ºå¤§çš„é«˜æ€§èƒ½çš„ä»£ç ç”ŸæˆåŒ…ï¼Œå®ƒå¯ä»¥åœ¨è¿è¡ŒæœŸæ‰©å±•javaç±»ä¸å®ç°javaæ¥å£ï¼Œå®ƒå¹¿æ³›çš„è¢«è®¸å¤šAOPçš„æ¡†æ¶ä½¿ç”¨ï¼Œä¾‹å¦‚Spring AOPå’Œsynaopï¼Œä¸ºä»–ä»¬æä¾›æ–¹æ³•çš„interception(æ‹¦æˆª)ã€‚ CglibåŒ…çš„åº•å±‚æ˜¯é€šè¿‡ä½¿ç”¨ä¸€ä¸ªå°è€Œå¿«çš„å­—èŠ‚ç å¤„ç†æ¡†æ¶ASMæ¥è½¬æ¢å­—èŠ‚ç å¹¶ç”Ÿæˆæ–°çš„ç±»ã€‚ä¸é¼“åŠ±ç›´æ¥ä½¿ç”¨ASMï¼Œå› ä¸ºå®ƒè¦æ±‚ä½ å¿…é¡»å¯¹JVMå†…éƒ¨ç»“æ„åŒ…æ‹¬classæ–‡ä»¶çš„æ ¼å¼å’ŒæŒ‡ä»¤é›†éƒ½å¾ˆç†Ÿæ‚‰ã€‚\nCglibå­ç±»ä»£ç†å®ç°æ–¹æ³•ï¼š\néœ€è¦å¼•å…¥cglibçš„jaræ–‡ä»¶ï¼Œä½†æ˜¯Springçš„æ ¸å¿ƒåŒ…ä¸­å·²ç»åŒ…æ‹¬äº†CglibåŠŸèƒ½ï¼Œæ‰€ä»¥ç›´æ¥å¼•å…¥spring-core-3.2.5.jarå³å¯ã€‚ å¼•å…¥åŠŸèƒ½åŒ…åï¼Œå°±å¯ä»¥åœ¨å†…å­˜ä¸­åŠ¨æ€æ„å»ºå­ç±»ã€‚ ä»£ç†çš„ç±»ä¸èƒ½ä¸ºfinalï¼Œå¦åˆ™æŠ¥é”™ã€‚ ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•å¦‚æœä¸ºfinal/staticï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¢«æ‹¦æˆªï¼Œå³ä¸ä¼šæ‰§è¡Œç›®æ ‡å¯¹è±¡é¢å¤–çš„ä¸šåŠ¡æ–¹æ³•ã€‚ ç›®æ ‡å¯¹è±¡ç±»ï¼šUserDao\n1 2 3 4 5 6 7 8 /** * ç›®æ ‡å¯¹è±¡ï¼Œæ²¡æœ‰å®ç°ä»»ä½•æ¥å£ */ public class User { public void save(){ System.out.println(\"----å·²ç»ä¿å­˜æ•°æ®!----\"); } } Cglibä»£ç†å·¥å‚ï¼šProxyFactory\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 /** * Cglibå­ç±»ä»£ç†å·¥å‚ * å¯¹Useråœ¨å†…å­˜ä¸­åŠ¨æ€æ„å»ºä¸€ä¸ªå­ç±»å¯¹è±¡ */ public class ProxyFactory implements MethodInterceptor { //ç»´æŠ¤ç›®æ ‡å¯¹è±¡ private Object target; public ProxyFactory(Object target) { this.target = target; } //ç»™ç›®æ ‡å¯¹è±¡åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ public Object getProxyInstance(){ //1.å·¥å…·ç±» Enhancer en = new Enhancer(); //2.è®¾ç½®çˆ¶ç±» en.setSuperclass(target.getClass()); //3.è®¾ç½®å›è°ƒå‡½æ•° en.setCallback(this); //4.åˆ›å»ºå­ç±»(ä»£ç†å¯¹è±¡) return en.create(); } public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable { System.out.println(\"å¼€å§‹äº‹åŠ¡...\"); //æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³• Object returnValue = method.invoke(target, objects); System.out.println(\"æäº¤äº‹åŠ¡...\"); return returnValue; } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /** * æµ‹è¯•ç±» */ public class Test { public static void main(String[] args) { //ç›®æ ‡å¯¹è±¡ User target = new User(); //ä»£ç†å¯¹è±¡ User proxy = (User)new ProxyFactory(target).getProxyInstance(); //æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹æ³• proxy.save(); } } åœ¨Springçš„AOPç¼–ç¨‹ä¸­ï¼š\nå¦‚æœåŠ å…¥å®¹å™¨çš„ç›®æ ‡å¯¹è±¡æœ‰å®ç°æ¥å£ï¼Œç”¨JDKä»£ç†ã€‚\nå¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰å®ç°æ¥å£ï¼Œç”¨Cglibä»£ç†ã€‚\nå‚è€ƒ\n",
  "wordCount" : "5602",
  "inLanguage": "en",
  "datePublished": "2018-12-10T16:45:26Z",
  "dateModified": "2018-12-10T16:45:26Z",
  "author":{
    "@type": "Person",
    "name": "Wjy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://funny-toffee-4aa7c3.netlify.app/posts/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wjy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://funny-toffee-4aa7c3.netlify.app/favicon.ico"
    }
  }
}
</script>

  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath:  [['\\(', '\\)'], ['$', '$']],  
    }
  };
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://funny-toffee-4aa7c3.netlify.app/" accesskey="h" title="Wjy&#39;s Blog (Alt + H)">Wjy&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://funny-toffee-4aa7c3.netlify.app/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://funny-toffee-4aa7c3.netlify.app/">Home</a>&nbsp;Â»&nbsp;<a href="https://funny-toffee-4aa7c3.netlify.app/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      ä»£ç†æ¨¡å¼
    </h1>
    <div class="post-meta"><span title='2018-12-10 16:45:26 +0000 UTC'>2018-12-10</span>&nbsp;Â·&nbsp;Wjy

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%bf%ab%e9%80%9f%e5%ad%a6%e4%b9%a0" aria-label="å¿«é€Ÿå­¦ä¹ ">å¿«é€Ÿå­¦ä¹ </a><ul>
                        
                <li>
                    <a href="#%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%90%86" aria-label="è¿œç¨‹ä»£ç†">è¿œç¨‹ä»£ç†</a></li>
                <li>
                    <a href="#%e8%99%9a%e4%bb%a3%e7%90%86" aria-label="è™šä»£ç†">è™šä»£ç†</a></li>
                <li>
                    <a href="#%e4%bf%9d%e6%8a%a4%e4%bb%a3%e7%90%86" aria-label="ä¿æŠ¤ä»£ç†">ä¿æŠ¤ä»£ç†</a></li>
                <li>
                    <a href="#%e6%99%ba%e8%83%bd%e5%bc%95%e7%94%a8" aria-label="æ™ºèƒ½å¼•ç”¨">æ™ºèƒ½å¼•ç”¨</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%a6%82%e8%bf%b0" aria-label="æ¦‚è¿°">æ¦‚è¿°</a></li>
                <li>
                    <a href="#%e9%9d%99%e6%80%81%e4%bb%a3%e7%90%86" aria-label="é™æ€ä»£ç†">é™æ€ä»£ç†</a></li>
                <li>
                    <a href="#%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86" aria-label="åŠ¨æ€ä»£ç†">åŠ¨æ€ä»£ç†</a><ul>
                        
                <li>
                    <a href="#jdk%e4%b8%ad%e7%94%9f%e6%88%90%e4%bb%a3%e7%90%86%e5%af%b9%e8%b1%a1%e7%9a%84api" aria-label="JDKä¸­ç”Ÿæˆä»£ç†å¯¹è±¡çš„API">JDKä¸­ç”Ÿæˆä»£ç†å¯¹è±¡çš„API</a></li></ul>
                </li>
                <li>
                    <a href="#cglib-%e4%bb%a3%e7%90%86" aria-label="Cglib ä»£ç†">Cglib ä»£ç†</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="å¿«é€Ÿå­¦ä¹ ">å¿«é€Ÿå­¦ä¹ <a hidden class="anchor" aria-hidden="true" href="#å¿«é€Ÿå­¦ä¹ ">#</a></h1>
<p>ç±»å‹ï¼šç»“æ„å‹</p>
<blockquote>
<p>ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚</p>
</blockquote>
<p>ä»£ç†æ¨¡å¼ï¼Œå³Proxyï¼Œå®ƒå’ŒAdapteræ¨¡å¼å¾ˆç±»ä¼¼ã€‚æˆ‘ä»¬å…ˆå›é¡¾Adapteræ¨¡å¼ï¼Œå®ƒç”¨äºæŠŠAæ¥å£è½¬æ¢ä¸ºBæ¥å£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public class BAdapter implements B {
</span></span><span style="display:flex;"><span>    private A a;
</span></span><span style="display:flex;"><span>    public BAdapter(A a) {
</span></span><span style="display:flex;"><span>        this.a = a;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    public void b() {
</span></span><span style="display:flex;"><span>        a.a();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è€ŒProxyæ¨¡å¼ä¸æ˜¯æŠŠAæ¥å£è½¬æ¢æˆBæ¥å£ï¼Œå®ƒè¿˜æ˜¯è½¬æ¢æˆAæ¥å£ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public class AProxy implements A {
</span></span><span style="display:flex;"><span>    private A a;
</span></span><span style="display:flex;"><span>    public AProxy(A a) {
</span></span><span style="display:flex;"><span>        this.a = a;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    public void a() {
</span></span><span style="display:flex;"><span>        this.a.a();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆç€Proxyå°±æ˜¯ä¸ºäº†ç»™Aæ¥å£å†åŒ…ä¸€å±‚ï¼Œè¿™ä¸æ˜¯è„±äº†è£¤å­æ”¾å±å—ï¼Ÿ</p>
<p>å½“ç„¶ä¸æ˜¯ã€‚æˆ‘ä»¬è§‚å¯ŸProxyçš„å®ç°Aæ¥å£çš„æ–¹æ³•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public void a() {
</span></span><span style="display:flex;"><span>    this.a.a();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·å†™å½“ç„¶æ²¡å•¥åµç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨è°ƒç”¨<code>a.a()</code>çš„å‰åï¼ŒåŠ ä¸€äº›é¢å¤–çš„ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public void a() {
</span></span><span style="display:flex;"><span>    if (getCurrentUser().isRoot()) {
</span></span><span style="display:flex;"><span>        this.a.a();
</span></span><span style="display:flex;"><span>    } else {
</span></span><span style="display:flex;"><span>        throw new SecurityException(&#34;Forbidden&#34;);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å®ç°äº†æƒé™æ£€æŸ¥ï¼Œåªæœ‰ç¬¦åˆè¦æ±‚çš„ç”¨æˆ·ï¼Œæ‰ä¼šçœŸæ­£è°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼Œå¦åˆ™ï¼Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>æœ‰çš„ç«¥é‹ä¼šé—®ï¼Œä¸ºå•¥ä¸æŠŠæƒé™æ£€æŸ¥çš„åŠŸèƒ½ç›´æ¥å†™åˆ°ç›®æ ‡å®ä¾‹Açš„å†…éƒ¨ï¼Ÿ</p>
<p>å› ä¸ºæˆ‘ä»¬ç¼–å†™ä»£ç çš„åŸåˆ™æœ‰ï¼š</p>
<ul>
<li>èŒè´£æ¸…æ™°ï¼šä¸€ä¸ªç±»åªè´Ÿè´£ä¸€ä»¶äº‹ï¼›</li>
<li>æ˜“äºæµ‹è¯•ï¼šä¸€æ¬¡åªæµ‹ä¸€ä¸ªåŠŸèƒ½ã€‚</li>
</ul>
<p>ç”¨Proxyå®ç°è¿™ä¸ªæƒé™æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—æ›´æ¸…æ™°ã€æ›´ç®€æ´çš„ä»£ç ï¼š</p>
<ul>
<li>Aæ¥å£ï¼šåªå®šä¹‰æ¥å£ï¼›</li>
<li>ABusinessç±»ï¼šåªå®ç°Aæ¥å£çš„ä¸šåŠ¡é€»è¾‘ï¼›</li>
<li>APermissionProxyç±»ï¼šåªå®ç°Aæ¥å£çš„æƒé™æ£€æŸ¥ä»£ç†ã€‚</li>
</ul>
<p>å¦‚æœæˆ‘ä»¬å¸Œæœ›ç¼–å†™å…¶ä»–ç±»å‹çš„ä»£ç†ï¼Œå¯ä»¥ç»§ç»­å¢åŠ ç±»ä¼¼ALogProxyï¼Œè€Œä¸å¿…å¯¹ç°æœ‰çš„Aæ¥å£ã€ABusinessç±»è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>å®é™…ä¸Šæƒé™æ£€æŸ¥åªæ˜¯ä»£ç†æ¨¡å¼çš„ä¸€ç§åº”ç”¨ã€‚Proxyè¿˜å¹¿æ³›åº”ç”¨åœ¨ï¼š</p>
<h2 id="è¿œç¨‹ä»£ç†">è¿œç¨‹ä»£ç†<a hidden class="anchor" aria-hidden="true" href="#è¿œç¨‹ä»£ç†">#</a></h2>
<p>è¿œç¨‹ä»£ç†å³Remote Proxyï¼Œæœ¬åœ°çš„è°ƒç”¨è€…æŒæœ‰çš„æ¥å£å®é™…ä¸Šæ˜¯ä¸€ä¸ªä»£ç†ï¼Œè¿™ä¸ªä»£ç†è´Ÿè´£æŠŠå¯¹æ¥å£çš„æ–¹æ³•è®¿é—®è½¬æ¢æˆè¿œç¨‹è°ƒç”¨ï¼Œç„¶åè¿”å›ç»“æœã€‚Javaå†…ç½®çš„RMIæœºåˆ¶å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¿œç¨‹ä»£ç†æ¨¡å¼ã€‚</p>
<h2 id="è™šä»£ç†">è™šä»£ç†<a hidden class="anchor" aria-hidden="true" href="#è™šä»£ç†">#</a></h2>
<p>è™šä»£ç†å³Virtual Proxyï¼Œå®ƒè®©è°ƒç”¨è€…å…ˆæŒæœ‰ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä½†çœŸæ­£çš„å¯¹è±¡å°šæœªåˆ›å»ºã€‚å¦‚æœæ²¡æœ‰å¿…è¦ï¼Œè¿™ä¸ªçœŸæ­£çš„å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆ›å»ºçš„ï¼Œç›´åˆ°å®¢æˆ·ç«¯éœ€è¦çœŸçš„å¿…é¡»è°ƒç”¨æ—¶ï¼Œæ‰åˆ›å»ºçœŸæ­£çš„å¯¹è±¡ã€‚JDBCçš„è¿æ¥æ± è¿”å›çš„JDBCè¿æ¥ï¼ˆConnectionå¯¹è±¡ï¼‰å°±å¯ä»¥æ˜¯ä¸€ä¸ªè™šä»£ç†ï¼Œå³è·å–è¿æ¥æ—¶æ ¹æœ¬æ²¡æœ‰ä»»ä½•å®é™…çš„æ•°æ®åº“è¿æ¥ï¼Œç›´åˆ°ç¬¬ä¸€æ¬¡æ‰§è¡ŒJDBCæŸ¥è¯¢æˆ–æ›´æ–°æ“ä½œæ—¶ï¼Œæ‰çœŸæ­£åˆ›å»ºå®é™…çš„JDBCè¿æ¥ã€‚</p>
<h2 id="ä¿æŠ¤ä»£ç†">ä¿æŠ¤ä»£ç†<a hidden class="anchor" aria-hidden="true" href="#ä¿æŠ¤ä»£ç†">#</a></h2>
<p>ä¿æŠ¤ä»£ç†å³Protection Proxyï¼Œå®ƒç”¨ä»£ç†å¯¹è±¡æ§åˆ¶å¯¹åŸå§‹å¯¹è±¡çš„è®¿é—®ï¼Œå¸¸ç”¨äºé‰´æƒã€‚</p>
<h2 id="æ™ºèƒ½å¼•ç”¨">æ™ºèƒ½å¼•ç”¨<a hidden class="anchor" aria-hidden="true" href="#æ™ºèƒ½å¼•ç”¨">#</a></h2>
<p>æ™ºèƒ½å¼•ç”¨å³Smart Referenceï¼Œå®ƒä¹Ÿæ˜¯ä¸€ç§ä»£ç†å¯¹è±¡ï¼Œå¦‚æœæœ‰å¾ˆå¤šå®¢æˆ·ç«¯å¯¹å®ƒè¿›è¡Œè®¿é—®ï¼Œé€šè¿‡å†…éƒ¨çš„è®¡æ•°å™¨å¯ä»¥åœ¨å¤–éƒ¨è°ƒç”¨è€…éƒ½ä¸ä½¿ç”¨åè‡ªåŠ¨é‡Šæ”¾å®ƒã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•åº”ç”¨ä»£ç†æ¨¡å¼ç¼–å†™ä¸€ä¸ªJDBCè¿æ¥æ± ï¼ˆ<code>DataSource</code>ï¼‰ã€‚æˆ‘ä»¬é¦–å…ˆæ¥ç¼–å†™ä¸€ä¸ªè™šä»£ç†ï¼Œå³å¦‚æœè°ƒç”¨è€…è·å–åˆ°<code>Connection</code>åï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œä»»ä½•SQLæ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªConnection Proxyå®é™…ä¸Šå¹¶ä¸ä¼šçœŸæ­£æ‰“å¼€JDBCè¿æ¥ã€‚è°ƒç”¨è€…ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DataSource lazyDataSource = new LazyDataSource(jdbcUrl, jdbcUsername, jdbcPassword);
</span></span><span style="display:flex;"><span>System.out.println(&#34;get lazy connection...&#34;);
</span></span><span style="display:flex;"><span>try (Connection conn1 = lazyDataSource.getConnection()) {
</span></span><span style="display:flex;"><span>    // å¹¶æ²¡æœ‰å®é™…æ‰“å¼€çœŸæ­£çš„Connection
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>System.out.println(&#34;get lazy connection...&#34;);
</span></span><span style="display:flex;"><span>try (Connection conn2 = lazyDataSource.getConnection()) {
</span></span><span style="display:flex;"><span>    try (PreparedStatement ps = conn2.prepareStatement(&#34;SELECT * FROM students&#34;)) { // æ‰“å¼€äº†çœŸæ­£çš„Connection
</span></span><span style="display:flex;"><span>        try (ResultSet rs = ps.executeQuery()) {
</span></span><span style="display:flex;"><span>            while (rs.next()) {
</span></span><span style="display:flex;"><span>                System.out.println(rs.getString(&#34;name&#34;));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨æˆ‘ä»¬æ¥æ€è€ƒå¦‚ä½•å®ç°è¿™ä¸ª<code>LazyConnectionProxy</code>ã€‚ä¸ºäº†ç®€åŒ–ä»£ç ï¼Œæˆ‘ä»¬é¦–å…ˆé’ˆå¯¹<code>Connection</code>æ¥å£åšä¸€ä¸ªæŠ½è±¡çš„ä»£ç†ç±»ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public abstract class AbstractConnectionProxy implements Connection {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // æŠ½è±¡æ–¹æ³•è·å–å®é™…çš„Connection:
</span></span><span style="display:flex;"><span>    protected abstract Connection getRealConnection();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // å®ç°Connectionæ¥å£çš„æ¯ä¸€ä¸ªæ–¹æ³•:
</span></span><span style="display:flex;"><span>    public Statement createStatement() throws SQLException {
</span></span><span style="display:flex;"><span>        return getRealConnection().createStatement();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public PreparedStatement prepareStatement(String sql) throws SQLException {
</span></span><span style="display:flex;"><span>        return getRealConnection().prepareStatement(sql);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ...å…¶ä»–ä»£ç†æ–¹æ³•...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ª<code>AbstractConnectionProxy</code>ä»£ç†ç±»çš„ä½œç”¨æ˜¯æŠŠ<code>Connection</code>æ¥å£å®šä¹‰çš„æ–¹æ³•å…¨éƒ¨å®ç°ä¸€éï¼Œå› ä¸º<code>Connection</code>æ¥å£å®šä¹‰çš„æ–¹æ³•å¤ªå¤šäº†ï¼Œåé¢æˆ‘ä»¬è¦ç¼–å†™çš„<code>LazyConnectionProxy</code>åªéœ€è¦ç»§æ‰¿<code>AbstractConnectionProxy</code>ï¼Œå°±ä¸å¿…å†æŠŠ<code>Connection</code>æ¥å£æ–¹æ³•æŒ¨ä¸ªå®ç°ä¸€éã€‚</p>
<p><code>LazyConnectionProxy</code>å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public class LazyConnectionProxy extends AbstractConnectionProxy {
</span></span><span style="display:flex;"><span>    private Supplier&lt;Connection&gt; supplier;
</span></span><span style="display:flex;"><span>    private Connection target = null;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public LazyConnectionProxy(Supplier&lt;Connection&gt; supplier) {
</span></span><span style="display:flex;"><span>        this.supplier = supplier;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // è¦†å†™closeæ–¹æ³•ï¼šåªæœ‰targetä¸ä¸ºnullæ—¶æ‰éœ€è¦å…³é—­:
</span></span><span style="display:flex;"><span>    public void close() throws SQLException {
</span></span><span style="display:flex;"><span>        if (target != null) {
</span></span><span style="display:flex;"><span>            System.out.println(&#34;Close connection: &#34; + target);
</span></span><span style="display:flex;"><span>            super.close();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    protected Connection getRealConnection() {
</span></span><span style="display:flex;"><span>        if (target == null) {
</span></span><span style="display:flex;"><span>            target = supplier.get();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        return target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœè°ƒç”¨è€…æ²¡æœ‰æ‰§è¡Œä»»ä½•SQLè¯­å¥ï¼Œé‚£ä¹ˆ<code>target</code>å­—æ®µå§‹ç»ˆä¸º<code>null</code>ã€‚åªæœ‰ç¬¬ä¸€æ¬¡æ‰§è¡ŒSQLè¯­å¥æ—¶ï¼ˆå³è°ƒç”¨ä»»ä½•ç±»ä¼¼<code>prepareStatement()</code>æ–¹æ³•æ—¶ï¼Œè§¦å‘<code>getRealConnection()</code>è°ƒç”¨ï¼‰ï¼Œæ‰ä¼šçœŸæ­£æ‰“å¼€å®é™…çš„JDBC Connectionã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™ä¸€ä¸ª<code>LazyDataSource</code>æ¥æ”¯æŒè¿™ä¸ª<code>LazyConnectionProxy</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public class LazyDataSource implements DataSource {
</span></span><span style="display:flex;"><span>    private String url;
</span></span><span style="display:flex;"><span>    private String username;
</span></span><span style="display:flex;"><span>    private String password;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public LazyDataSource(String url, String username, String password) {
</span></span><span style="display:flex;"><span>        this.url = url;
</span></span><span style="display:flex;"><span>        this.username = username;
</span></span><span style="display:flex;"><span>        this.password = password;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public Connection getConnection(String username, String password) throws SQLException {
</span></span><span style="display:flex;"><span>        return new LazyConnectionProxy(() -&gt; {
</span></span><span style="display:flex;"><span>            try {
</span></span><span style="display:flex;"><span>                Connection conn = DriverManager.getConnection(url, username, password);
</span></span><span style="display:flex;"><span>                System.out.println(&#34;Open connection: &#34; + conn);
</span></span><span style="display:flex;"><span>                return conn;
</span></span><span style="display:flex;"><span>            } catch (SQLException e) {
</span></span><span style="display:flex;"><span>                throw new RuntimeException(e);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬æ‰§è¡Œä»£ç ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>get lazy connection...
</span></span><span style="display:flex;"><span>get lazy connection...
</span></span><span style="display:flex;"><span>Open connection: com.mysql.jdbc.JDBC4Connection@7a36aefa
</span></span><span style="display:flex;"><span>å°æ˜
</span></span><span style="display:flex;"><span>å°çº¢
</span></span><span style="display:flex;"><span>å°å†›
</span></span><span style="display:flex;"><span>å°ç™½
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Close connection: com.mysql.jdbc.JDBC4Connection@7a36aefa
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯è§ç¬¬ä¸€ä¸ª<code>getConnection()</code>è°ƒç”¨è·å–åˆ°çš„<code>LazyConnectionProxy</code>å¹¶æ²¡æœ‰å®é™…æ‰“å¼€çœŸæ­£çš„JDBC Connectionã€‚</p>
<p>ä½¿ç”¨è¿æ¥æ± çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›èƒ½é‡å¤ä½¿ç”¨è¿æ¥ã€‚å¦‚æœè°ƒç”¨æ–¹ç¼–å†™è¿™æ ·çš„ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DataSource pooledDataSource = new PooledDataSource(jdbcUrl, jdbcUsername, jdbcPassword);
</span></span><span style="display:flex;"><span>try (Connection conn = pooledDataSource.getConnection()) {
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>try (Connection conn = pooledDataSource.getConnection()) {
</span></span><span style="display:flex;"><span>    // è·å–åˆ°çš„æ˜¯åŒä¸€ä¸ªConnection
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>try (Connection conn = pooledDataSource.getConnection()) {
</span></span><span style="display:flex;"><span>    // è·å–åˆ°çš„æ˜¯åŒä¸€ä¸ªConnection
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è°ƒç”¨æ–¹å¹¶ä¸å…³å¿ƒæ˜¯å¦å¤ç”¨äº†<code>Connection</code>ï¼Œä½†ä»<code>PooledDataSource</code>è·å–çš„<code>Connection</code>ç¡®å®è‡ªå¸¦è¿™ä¸ªä¼˜åŒ–åŠŸèƒ½ã€‚å¦‚ä½•å®ç°å¯å¤ç”¨<code>Connection</code>çš„è¿æ¥æ± ï¼Ÿç­”æ¡ˆä»ç„¶æ˜¯ä½¿ç”¨ä»£ç†æ¨¡å¼ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public class PooledConnectionProxy extends AbstractConnectionProxy {
</span></span><span style="display:flex;"><span>    // å®é™…çš„Connection:
</span></span><span style="display:flex;"><span>    Connection target;
</span></span><span style="display:flex;"><span>    // ç©ºé—²é˜Ÿåˆ—:
</span></span><span style="display:flex;"><span>    Queue&lt;PooledConnectionProxy&gt; idleQueue;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public PooledConnectionProxy(Queue&lt;PooledConnectionProxy&gt; idleQueue, Connection target) {
</span></span><span style="display:flex;"><span>        this.idleQueue = idleQueue;
</span></span><span style="display:flex;"><span>        this.target = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public void close() throws SQLException {
</span></span><span style="display:flex;"><span>        System.out.println(&#34;Fake close and released to idle queue for future reuse: &#34; + target);
</span></span><span style="display:flex;"><span>        // å¹¶æ²¡æœ‰è°ƒç”¨å®é™…Connectionçš„close()æ–¹æ³•,
</span></span><span style="display:flex;"><span>        // è€Œæ˜¯æŠŠè‡ªå·±æ”¾å…¥ç©ºé—²é˜Ÿåˆ—:
</span></span><span style="display:flex;"><span>        idleQueue.offer(this);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    protected Connection getRealConnection() {
</span></span><span style="display:flex;"><span>        return target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¤ç”¨è¿æ¥çš„å…³é”®åœ¨äºè¦†å†™<code>close()</code>æ–¹æ³•ï¼Œå®ƒå¹¶æ²¡æœ‰çœŸæ­£å…³é—­åº•å±‚JDBCè¿æ¥ï¼Œè€Œæ˜¯æŠŠè‡ªå·±æ”¾å›ä¸€ä¸ªç©ºé—²é˜Ÿåˆ—ï¼Œä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨ã€‚</p>
<p>ç©ºé—²é˜Ÿåˆ—ç”±<code>PooledDataSource</code>è´Ÿè´£ç»´æŠ¤ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public class PooledDataSource implements DataSource {
</span></span><span style="display:flex;"><span>    private String url;
</span></span><span style="display:flex;"><span>    private String username;
</span></span><span style="display:flex;"><span>    private String password;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // ç»´æŠ¤ä¸€ä¸ªç©ºé—²é˜Ÿåˆ—:
</span></span><span style="display:flex;"><span>    private Queue&lt;PooledConnectionProxy&gt; idleQueue = new ArrayBlockingQueue&lt;&gt;(100);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public PooledDataSource(String url, String username, String password) {
</span></span><span style="display:flex;"><span>        this.url = url;
</span></span><span style="display:flex;"><span>        this.username = username;
</span></span><span style="display:flex;"><span>        this.password = password;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public Connection getConnection(String username, String password) throws SQLException {
</span></span><span style="display:flex;"><span>        // é¦–å…ˆè¯•å›¾è·å–ä¸€ä¸ªç©ºé—²è¿æ¥:
</span></span><span style="display:flex;"><span>        PooledConnectionProxy conn = idleQueue.poll();
</span></span><span style="display:flex;"><span>        if (conn == null) {
</span></span><span style="display:flex;"><span>            // æ²¡æœ‰ç©ºé—²è¿æ¥æ—¶ï¼Œæ‰“å¼€ä¸€ä¸ªæ–°è¿æ¥:
</span></span><span style="display:flex;"><span>            conn = openNewConnection();
</span></span><span style="display:flex;"><span>        } else {
</span></span><span style="display:flex;"><span>            System.out.println(&#34;Return pooled connection: &#34; + conn.target);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        return conn;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    private PooledConnectionProxy openNewConnection() throws SQLException {
</span></span><span style="display:flex;"><span>        Connection conn = DriverManager.getConnection(url, username, password);
</span></span><span style="display:flex;"><span>        System.out.println(&#34;Open new connection: &#34; + conn);
</span></span><span style="display:flex;"><span>        return new PooledConnectionProxy(idleQueue, conn);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬æ‰§è¡Œè°ƒç”¨æ–¹ä»£ç ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Open new connection: com.mysql.jdbc.JDBC4Connection@61ca2dfa
</span></span><span style="display:flex;"><span>Fake close and released to idle queue for future reuse: com.mysql.jdbc.JDBC4Connection@61ca2dfa
</span></span><span style="display:flex;"><span>Return pooled connection: com.mysql.jdbc.JDBC4Connection@61ca2dfa
</span></span><span style="display:flex;"><span>Fake close and released to idle queue for future reuse: com.mysql.jdbc.JDBC4Connection@61ca2dfa
</span></span><span style="display:flex;"><span>Return pooled connection: com.mysql.jdbc.JDBC4Connection@61ca2dfa
</span></span><span style="display:flex;"><span>Fake close and released to idle queue for future reuse: com.mysql.jdbc.JDBC4Connection@61ca2dfa
</span></span></code></pre></td></tr></table>
</div>
</div><p>é™¤äº†ç¬¬ä¸€æ¬¡æ‰“å¼€äº†ä¸€ä¸ªçœŸæ­£çš„JDBC Connectionï¼Œåç»­è·å–çš„<code>Connection</code>å®é™…ä¸Šæ˜¯åŒä¸€ä¸ªJDBC Connectionã€‚ä½†æ˜¯ï¼Œå¯¹äºè°ƒç”¨æ–¹æ¥è¯´ï¼Œå®Œå…¨ä¸éœ€è¦çŸ¥é“åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ã€‚</p>
<p>æˆ‘ä»¬å®é™…ä½¿ç”¨çš„DataSourceï¼Œä¾‹å¦‚HikariCPï¼Œéƒ½æ˜¯åŸºäºä»£ç†æ¨¡å¼å®ç°çš„ï¼ŒåŸç†åŒä¸Šï¼Œä½†å¢åŠ äº†æ›´å¤šçš„å¦‚åŠ¨æ€ä¼¸ç¼©çš„åŠŸèƒ½ï¼ˆä¸€ä¸ªè¿æ¥ç©ºé—²ä¸€æ®µæ—¶é—´åè‡ªåŠ¨å…³é—­ï¼‰ã€‚</p>
<p>æœ‰çš„ç«¥é‹ä¼šå‘ç°Proxyæ¨¡å¼å’ŒDecoratoræ¨¡å¼æœ‰äº›ç±»ä¼¼ã€‚ç¡®å®ï¼Œè¿™ä¸¤è€…çœ‹èµ·æ¥å¾ˆåƒï¼Œä½†åŒºåˆ«åœ¨äºï¼šDecoratoræ¨¡å¼è®©è°ƒç”¨è€…è‡ªå·±åˆ›å»ºæ ¸å¿ƒç±»ï¼Œç„¶åç»„åˆå„ç§åŠŸèƒ½ï¼Œè€ŒProxyæ¨¡å¼å†³ä¸èƒ½è®©è°ƒç”¨è€…è‡ªå·±åˆ›å»ºå†ç»„åˆï¼Œå¦åˆ™å°±å¤±å»äº†ä»£ç†çš„åŠŸèƒ½ã€‚Proxyæ¨¡å¼è®©è°ƒç”¨è€…è®¤ä¸ºè·å–åˆ°çš„æ˜¯æ ¸å¿ƒç±»æ¥å£ï¼Œä½†å®é™…ä¸Šæ˜¯ä»£ç†ç±»ã€‚</p>
<h1 id="æ¦‚è¿°">æ¦‚è¿°<a hidden class="anchor" aria-hidden="true" href="#æ¦‚è¿°">#</a></h1>
<p>ä»£ç†æ¨¡å¼å¯ä»¥é€šè¿‡ä»£ç†å¯¹è±¡è®¿é—®ç›®æ ‡å¯¹è±¡ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šåœ¨å®ç°ç›®æ ‡å¯¹è±¡çš„åŸºç¡€ä¸Šï¼Œæ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚ä¸è¦éšæ„å»ä¿®æ”¹åˆ«äººå·²ç»å†™å¥½çš„ä»£ç æˆ–è€…æ–¹æ³•ï¼Œå¦‚æœéœ€æ”¹ä¿®æ”¹ï¼Œå¯ä»¥é€šè¿‡ä»£ç†çš„æ–¹å¼æ¥æ‰©å±•è¯¥æ–¹æ³•ã€‚</p>
<p><img loading="lazy" src="1.png" alt=""  />
</p>
<p>ä»£ç†å¯¹è±¡æ˜¯ç›®æ ‡å¯¹è±¡çš„æ‰©å±•ï¼Œå¹¶ä¼šè°ƒç”¨ç›®æ ‡å¯¹è±¡ã€‚</p>
<h1 id="é™æ€ä»£ç†">é™æ€ä»£ç†<a hidden class="anchor" aria-hidden="true" href="#é™æ€ä»£ç†">#</a></h1>
<p>é™æ€ä»£ç†åœ¨ä½¿ç”¨æ—¶ï¼Œéœ€è¦å®šä¹‰æ¥å£æˆ–è€…çˆ¶ç±»ï¼Œè¢«ä»£ç†å¯¹è±¡ä¸ä»£ç†å¯¹è±¡ä¸€èµ·å®ç°ç›¸åŒçš„æ¥å£æˆ–è€…æ˜¯ç»§æ‰¿ç›¸åŒçˆ¶ç±»ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> UserService {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">void</span> save();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//æ¥å£å®ç°ï¼šç›®æ ‡å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserServiceImpl <span style="color:#fff;font-weight:bold">implements</span> UserService{
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> save() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;----å·²ç»ä¿å­˜æ•°æ®!----&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ä»£ç†å¯¹è±¡,é™æ€ä»£ç†
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> UserProxy <span style="color:#fff;font-weight:bold">implements</span> UserService{
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//æ¥æ”¶ä¿å­˜ç›®æ ‡å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> UserService target;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> UserProxy(UserService target){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span>=target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> save() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (getCurrentUser().<span style="color:#007f7f">isRoot</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            target.<span style="color:#007f7f">save</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> SecurityException(<span style="color:#0ff;font-weight:bold">&#34;Forbidden&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * æµ‹è¯•ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Test {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç›®æ ‡å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        UserService userService = <span style="color:#fff;font-weight:bold">new</span> UserServiceImpl();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä»£ç†å¯¹è±¡,æŠŠç›®æ ‡å¯¹è±¡ä¼ ç»™ä»£ç†å¯¹è±¡,å»ºç«‹ä»£ç†å…³ç³»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        UserProxy userProxy = <span style="color:#fff;font-weight:bold">new</span> UserProxy(userService);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ‰§è¡Œçš„æ˜¯ä»£ç†çš„æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        userProxy.<span style="color:#007f7f">save</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ç¼–å†™ä»£ç çš„åŸåˆ™æœ‰ï¼š</p>
<ul>
<li>èŒè´£æ¸…æ™°ï¼šä¸€ä¸ªç±»åªè´Ÿè´£ä¸€ä»¶äº‹ï¼›</li>
<li>æ˜“äºæµ‹è¯•ï¼šä¸€æ¬¡åªæµ‹ä¸€ä¸ªåŠŸèƒ½ã€‚</li>
</ul>
<p>ç”¨Proxyå®ç°è¿™ä¸ªæƒé™æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—æ›´æ¸…æ™°ã€æ›´ç®€æ´çš„ä»£ç ï¼š</p>
<ul>
<li>Aæ¥å£ï¼šåªå®šä¹‰æ¥å£ï¼›</li>
<li>ABusinessç±»ï¼šåªå®ç°Aæ¥å£çš„ä¸šåŠ¡é€»è¾‘ï¼›</li>
<li>APermissionProxyç±»ï¼šåªå®ç°Aæ¥å£çš„æƒé™æ£€æŸ¥ä»£ç†ã€‚</li>
</ul>
<p>å¦‚æœæˆ‘ä»¬å¸Œæœ›ç¼–å†™å…¶ä»–ç±»å‹çš„ä»£ç†ï¼Œå¯ä»¥ç»§ç»­å¢åŠ ç±»ä¼¼ALogProxyï¼Œè€Œä¸å¿…å¯¹ç°æœ‰çš„Aæ¥å£ã€ABusinessç±»è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>é™æ€ä»£ç†æ€»ç»“ï¼š
ä¼˜ç‚¹ï¼šå¯ä»¥åšåˆ°åœ¨ä¸ä¿®æ”¹ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½å‰æä¸‹ï¼Œå¯¹ç›®æ ‡åŠŸèƒ½æ‰©å±•ã€‚
ç¼ºç‚¹ï¼šå› ä¸ºä»£ç†å¯¹è±¡éœ€è¦ä¸ç›®æ ‡å¯¹è±¡å®ç°ä¸€æ ·çš„æ¥å£ï¼Œæ‰€ä»¥ä¼šæœ‰å¾ˆå¤šä»£ç†ç±»ï¼Œç±»å¤ªå¤šã€‚åŒæ—¶ï¼Œä¸€æ—¦æ¥å£å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡ä¸ä»£ç†å¯¹è±¡éƒ½è¦ç»´æŠ¤ã€‚
å¦‚ä½•è§£å†³é™æ€ä»£ç†ä¸­çš„ç¼ºç‚¹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥ä½¿ç”¨åŠ¨æ€ä»£ç†æ–¹å¼ã€‚</p>
<h1 id="åŠ¨æ€ä»£ç†">åŠ¨æ€ä»£ç†<a hidden class="anchor" aria-hidden="true" href="#åŠ¨æ€ä»£ç†">#</a></h1>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ä»£ç†å¯¹è±¡ï¼Œä¸éœ€è¦å®ç°æ¥å£</li>
<li>ä»£ç†å¯¹è±¡çš„ç”Ÿæˆï¼Œæ˜¯åˆ©ç”¨JDKçš„APIï¼ŒåŠ¨æ€çš„åœ¨å†…å­˜ä¸­æ„å»ºä»£ç†å¯¹è±¡ï¼ˆéœ€è¦æˆ‘ä»¬æŒ‡å®šåˆ›å»ºä»£ç†å¯¹è±¡/ç›®æ ‡å¯¹è±¡å®ç°çš„æ¥å£çš„ç±»å‹ï¼‰</li>
<li>åŠ¨æ€ä»£ç†ä¹Ÿå«åšï¼šJDKä»£ç†ï¼Œæ¥å£ä»£ç†</li>
</ul>
<h2 id="jdkä¸­ç”Ÿæˆä»£ç†å¯¹è±¡çš„api">JDKä¸­ç”Ÿæˆä»£ç†å¯¹è±¡çš„API<a hidden class="anchor" aria-hidden="true" href="#jdkä¸­ç”Ÿæˆä»£ç†å¯¹è±¡çš„api">#</a></h2>
<p>ä»£ç†ç±»æ‰€åœ¨åŒ…ï¼š<code>java.lang.reflect.Proxy</code>
JDKå®ç°ä»£ç†åªéœ€è¦ä½¿ç”¨<code>newProxyInstance</code>æ–¹æ³•ï¼Œä½†æ˜¯è¯¥æ–¹æ³•éœ€è¦æ¥æ”¶ä¸‰ä¸ªå‚æ•°,å®Œæ•´çš„å†™æ³•æ˜¯ï¼š
<code>static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces,InvocationHandler h )</code></p>
<p>æ³¨æ„è¯¥æ–¹æ³•æ˜¯åœ¨Proxyç±»ä¸­æ˜¯é™æ€æ–¹æ³•ï¼Œä¸”æ¥æ”¶çš„ä¸‰ä¸ªå‚æ•°ä¾æ¬¡ä¸ºï¼š</p>
<ul>
<li><code>ClassLoader loader</code>ï¼šæŒ‡å®šå½“å‰ç›®æ ‡å¯¹è±¡ä½¿ç”¨ç±»åŠ è½½å™¨ï¼Œè·å–åŠ è½½å™¨çš„æ–¹æ³•æ˜¯å›ºå®šçš„</li>
<li><code>Class&lt;?&gt;[] interfaces</code>ï¼šç›®æ ‡å¯¹è±¡å®ç°çš„æ¥å£çš„ç±»å‹,ä½¿ç”¨æ³›å‹æ–¹å¼ç¡®è®¤ç±»å‹</li>
<li>äº‹ä»¶å¤„ç†ï¼Œæ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œä¼šè§¦å‘äº‹ä»¶å¤„ç†å™¨çš„æ–¹æ³•ï¼Œä¼šæŠŠå½“å‰æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ä½œä¸ºå‚æ•°ä¼ å…¥</li>
</ul>
<p>æ¥å£ç±» UserServiceã€ç›®æ ‡å¯¹è±¡ UserServiceImpl æ— éœ€ä¿®æ”¹ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¢åŠ ä»£ç†å·¥å‚ç±»ï¼šProxyFactory</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * åŠ¨æ€ä»£ç†ä¸éœ€è¦å®ç°æ¥å£,ä½†æ˜¯éœ€è¦æŒ‡å®šæ¥å£ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ProxyFactory {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç»´æŠ¤ä¸€ä¸ªç›®æ ‡å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> Object target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ProxyFactory(Object target) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç»™ç›®æ ‡å¯¹è±¡ç”Ÿæˆä»£ç†å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> Object getProxyInstance(){
</span></span><span style="display:flex;"><span>        InvocationHandler handler = (proxy, method, args) -&gt; {
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;å¼€å§‹äº‹åŠ¡2&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">//æ‰§è¡Œç›®æ ‡å¯¹è±¡æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Object returnValue = method.<span style="color:#007f7f">invoke</span>(target, args);
</span></span><span style="display:flex;"><span>            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;æäº¤äº‹åŠ¡2&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> returnValue;
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Object proxyInstance = Proxy.<span style="color:#007f7f">newProxyInstance</span>(
</span></span><span style="display:flex;"><span>                target.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getClassLoader</span>(),
</span></span><span style="display:flex;"><span>                target.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getInterfaces</span>(),
</span></span><span style="display:flex;"><span>                handler);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> proxyInstance;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * æµ‹è¯•ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Test {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç›®æ ‡å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        UserService userService = <span style="color:#fff;font-weight:bold">new</span> UserServiceImpl();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åŸå§‹ç±»å‹ class cn.wjy.UserServiceImpl
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(userService.<span style="color:#007f7f">getClass</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç»™ç›®æ ‡å¯¹è±¡ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        UserService proxy = (UserService) <span style="color:#fff;font-weight:bold">new</span> ProxyFactory(userService).<span style="color:#007f7f">getProxyInstance</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// class $Proxy0   å†…å­˜ä¸­åŠ¨æ€ç”Ÿæˆçš„ä»£ç†å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(proxy.<span style="color:#007f7f">getClass</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ä»£ç†å¯¹è±¡ï¼Œæ‰§è¡Œæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        proxy.<span style="color:#007f7f">save</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»£ç†å¯¹è±¡ä¸éœ€è¦å®ç°æ¥å£ï¼Œä½†æ˜¯ç›®æ ‡å¯¹è±¡ä¸€å®šè¦å®ç°æ¥å£ï¼Œå¦åˆ™ä¸èƒ½ç”¨åŠ¨æ€ä»£ç†ã€‚</p>
<h1 id="cglib-ä»£ç†">Cglib ä»£ç†<a hidden class="anchor" aria-hidden="true" href="#cglib-ä»£ç†">#</a></h1>
<p>Cglibä»£ç†ï¼Œä¹Ÿå«ä½œå­ç±»ä»£ç†ï¼Œå®ƒæ˜¯åœ¨å†…å­˜ä¸­æ„å»ºä¸€ä¸ªå­ç±»å¯¹è±¡ä»è€Œå®ç°å¯¹ç›®æ ‡å¯¹è±¡åŠŸèƒ½çš„æ‰©å±•ã€‚
é™ã€åŠ¨æ€ä»£ç†éƒ½è¦æ±‚ç›®æ ‡å¯¹è±¡å®ç°æ¥å£ï¼Œä½†æœ‰æ—¶ç›®æ ‡å¯¹è±¡åªæ˜¯ä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ï¼Œæ²¡æœ‰å®ç°ä»»ä½•å£ï¼Œæ­¤æ—¶å¯ä½¿ç”¨Cglibä»£ç†ã€‚</p>
<p><code>Cglib</code>æ˜¯ä¸€ä¸ªå¼ºå¤§çš„é«˜æ€§èƒ½çš„ä»£ç ç”ŸæˆåŒ…ï¼Œå®ƒå¯ä»¥åœ¨è¿è¡ŒæœŸæ‰©å±•javaç±»ä¸å®ç°javaæ¥å£ï¼Œå®ƒå¹¿æ³›çš„è¢«è®¸å¤šAOPçš„æ¡†æ¶ä½¿ç”¨ï¼Œä¾‹å¦‚Spring AOPå’Œsynaopï¼Œä¸ºä»–ä»¬æä¾›æ–¹æ³•çš„<code>interception(æ‹¦æˆª)</code>ã€‚
<code>Cglib</code>åŒ…çš„åº•å±‚æ˜¯é€šè¿‡ä½¿ç”¨ä¸€ä¸ªå°è€Œå¿«çš„å­—èŠ‚ç å¤„ç†æ¡†æ¶ASMæ¥è½¬æ¢å­—èŠ‚ç å¹¶ç”Ÿæˆæ–°çš„ç±»ã€‚ä¸é¼“åŠ±ç›´æ¥ä½¿ç”¨ASMï¼Œå› ä¸ºå®ƒè¦æ±‚ä½ å¿…é¡»å¯¹JVMå†…éƒ¨ç»“æ„åŒ…æ‹¬classæ–‡ä»¶çš„æ ¼å¼å’ŒæŒ‡ä»¤é›†éƒ½å¾ˆç†Ÿæ‚‰ã€‚</p>
<p>Cglibå­ç±»ä»£ç†å®ç°æ–¹æ³•ï¼š</p>
<ol>
<li>éœ€è¦å¼•å…¥cglibçš„jaræ–‡ä»¶ï¼Œä½†æ˜¯Springçš„æ ¸å¿ƒåŒ…ä¸­å·²ç»åŒ…æ‹¬äº†CglibåŠŸèƒ½ï¼Œæ‰€ä»¥ç›´æ¥å¼•å…¥spring-core-3.2.5.jarå³å¯ã€‚</li>
<li>å¼•å…¥åŠŸèƒ½åŒ…åï¼Œå°±å¯ä»¥åœ¨å†…å­˜ä¸­åŠ¨æ€æ„å»ºå­ç±»ã€‚</li>
<li>ä»£ç†çš„ç±»ä¸èƒ½ä¸ºfinalï¼Œå¦åˆ™æŠ¥é”™ã€‚</li>
<li>ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•å¦‚æœä¸º<code>final/static</code>ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¢«æ‹¦æˆªï¼Œå³ä¸ä¼šæ‰§è¡Œç›®æ ‡å¯¹è±¡é¢å¤–çš„ä¸šåŠ¡æ–¹æ³•ã€‚</li>
</ol>
<p>ç›®æ ‡å¯¹è±¡ç±»ï¼šUserDao</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * ç›®æ ‡å¯¹è±¡ï¼Œæ²¡æœ‰å®ç°ä»»ä½•æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> User {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> save(){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;----å·²ç»ä¿å­˜æ•°æ®!----&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Cglibä»£ç†å·¥å‚ï¼šProxyFactory</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * Cglibå­ç±»ä»£ç†å·¥å‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * å¯¹Useråœ¨å†…å­˜ä¸­åŠ¨æ€æ„å»ºä¸€ä¸ªå­ç±»å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ProxyFactory <span style="color:#fff;font-weight:bold">implements</span> MethodInterceptor {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç»´æŠ¤ç›®æ ‡å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">private</span> Object target;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ProxyFactory(Object target) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">target</span> = target;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ç»™ç›®æ ‡å¯¹è±¡åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">public</span> Object getProxyInstance(){
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//1.å·¥å…·ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Enhancer en = <span style="color:#fff;font-weight:bold">new</span> Enhancer();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//2.è®¾ç½®çˆ¶ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        en.<span style="color:#007f7f">setSuperclass</span>(target.<span style="color:#007f7f">getClass</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//3.è®¾ç½®å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        en.<span style="color:#007f7f">setCallback</span>(<span style="color:#fff;font-weight:bold">this</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//4.åˆ›å»ºå­ç±»(ä»£ç†å¯¹è±¡)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> en.<span style="color:#007f7f">create</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) <span style="color:#fff;font-weight:bold">throws</span> Throwable {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;å¼€å§‹äº‹åŠ¡...&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Object returnValue = method.<span style="color:#007f7f">invoke</span>(target, objects);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;æäº¤äº‹åŠ¡...&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> returnValue;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * æµ‹è¯•ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Test {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ç›®æ ‡å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        User target = <span style="color:#fff;font-weight:bold">new</span> User();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä»£ç†å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        User proxy = (User)<span style="color:#fff;font-weight:bold">new</span> ProxyFactory(target).<span style="color:#007f7f">getProxyInstance</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        proxy.<span style="color:#007f7f">save</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨Springçš„AOPç¼–ç¨‹ä¸­ï¼š</p>
<p>å¦‚æœåŠ å…¥å®¹å™¨çš„ç›®æ ‡å¯¹è±¡æœ‰å®ç°æ¥å£ï¼Œç”¨JDKä»£ç†ã€‚</p>
<p>å¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰å®ç°æ¥å£ï¼Œç”¨Cglibä»£ç†ã€‚</p>
<p><a href="https://www.cnblogs.com/cenyu/p/6289209.html">å‚è€ƒ</a></p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://funny-toffee-4aa7c3.netlify.app/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">è®¾è®¡æ¨¡å¼</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://funny-toffee-4aa7c3.netlify.app/">Wjy&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>